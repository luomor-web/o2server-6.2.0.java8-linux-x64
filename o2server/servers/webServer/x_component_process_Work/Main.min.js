MWF.xApplication=MWF.xApplication||{},MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Work=MWF.xApplication.process.Work||{},MWF.xApplication.process.Work.options=Object.clone(o2.xApplication.Common.options),MWF.xApplication.process.Work.options.multitask=!0,MWF.xApplication.process.Work.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"process.Work",icon:"icon.png",width:"1200",height:"800",title:"",workId:"",draftId:"",draft:null,workCompletedId:"",taskId:"",jobId:"",form:null,priorityWork:"",isControl:!1,taskObject:null,readonly:!1,worklogType:"record"},onQueryLoad:function(){this.options.title||this.setOptions({title:MWF.xApplication.process.Work.LP.title}),this.lp=MWF.xApplication.process.Work.LP,this.status&&(this.options.workId=this.status.workId,this.options.workCompletedId=this.status.workCompletedId,this.options.jobId=this.status.jobId,this.options.draftId=this.status.draftId,this.options.priorityWork=this.status.priorityWork,this.options.readonly="true"===this.status.readonly),this.action=MWF.Actions.get("x_processplatform_assemble_surface")},loadWorkApplication:function(t,o){var i="firefox"==Browser.name?"work_firefox":"desktop";o&&(this.mask=new MWF.widget.Mask({style:i,loading:o})),this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.node),this.options.isRefresh?(o&&this.mask.loadNode(this.content),this.loadWork()):this.maxSize(function(){o&&this.mask.loadNode(this.content),this.loadWork()}.bind(this)),t&&t()},loadApplication:function(t){this.node=new Element("div",{styles:this.css.content}).inject(this.content),layout.mobile?this.loadWorkApplication(t,!1):"Default"==layout.viewMode?MWF.require("MWF.widget.Mask",function(){this.loadWorkApplication(t,!0)}.bind(this)):this.loadWorkApplication(t,!1),this.addEvent("postClose",function(){}.bind(this)),this.addKeyboardEvents()},refreshTaskCenter:function(){this.desktop.apps&&this.desktop.apps.TaskCenter&&(this.desktop.apps.TaskCenter.content&&this.desktop.apps.TaskCenter.content.unmask(),this.desktop.apps.TaskCenter.refreshAll&&this.desktop.apps.TaskCenter.refreshAll())},addKeyboardEvents:function(){this.addEvent("keySave",function(t){this.keySave(t)}.bind(this))},keySave:function(t){this.appForm&&(this.options.readonly||(this.appForm.saveWork(),t.preventDefault()))},reload:function(t){this.appForm&&(this.formNode.empty(),MWF.release(this.appForm),this.appForm=null,this.form=null,this.$events={}),t?(this.parseData(t),this.openWork()):this.loadWork()},loadWork:function(){var t=this.options.workCompletedId||this.options.workId||this.options.workid||this.options.workcompletedid;if(t)this.loadWorkByWork(t);else if(this.options.draftId||this.options.draftid){var o=this.options.draftId||this.options.draftid;MWF.Actions.get("x_processplatform_assemble_surface").getDraft(o,function(t){this.loadWorkByDraft(t.data.work,t.data.data)}.bind(this))}else if(this.options.draft)this.loadWorkByDraft(this.options.draft);else if(this.options.jobId||this.options.jobid||this.options.job){var i=this.options.jobId||this.options.jobid||this.options.job;delete this.options.jobId,delete this.options.jobid,delete this.options.job,this.loadWorkByJob(i)}},loadWorkByWork:function(t){var o,i,s,e,n=!1,r=!1,a=!1,d=function(){r&&n&&a&&(o&&s&&e&&i?(this.parseData(o.data,s.data,e.data,i.data,o.data.recordList,o.data.attachmentList),this.mask&&this.mask.hide(),layout.session&&layout.session.user?(this.openWork(),this.unLoading()):layout.sessionPromise&&layout.sessionPromise.then(function(){this.openWork(),this.unLoading()}.bind(this),(function(){}))):this.options.jobId||this.options.jobid||this.options.job?(delete this.options.workCompletedId,delete this.options.workId,delete this.options.workid,delete this.options.workcompletedid,this.loadWork()):layout.sessionPromise.then(function(){this.close()}.bind(this),(function(){})))}.bind(this);this.options.form&&this.options.form.id||this.options.formid?o2.Actions.invokeAsync([{action:this.action,name:"loadWorkV2"},{action:this.action,name:"getWorkLog"},{action:this.action,name:"getWorkControl"},{action:this.action,name:layout.mobile?"getFormV2Mobile":"getFormV2"}],{success:function(t,a,h,l){o=t,i=a,s=h,e=l,r=!0,n=!0,d()}.bind(this),failure:function(){}.bind(this)},t,t,t,[this.options.formid||this.options.form.id,(new Date).getTime()]):(this.action[layout.mobile?"lookupFormWithWorkMobile":"lookupFormWithWork"](t,function(t){var o=t.data.id;if(t.data.form)e=t,n=!0,d();else{var i=t.data.cacheTag||"";this.action[layout.mobile?"getFormV2Mobile":"getFormV2"](o,i,(function(t){e=t,n=!0,d()}),(function(){n=!0,d()}))}}.bind(this),(function(){n=!0,d()})),o2.Actions.invokeAsync([{action:this.action,name:"loadWorkV2"},{action:this.action,name:"getWorkLog"},{action:this.action,name:"getWorkControl"}],{success:function(t,e,n){o=t,i=e,s=n,r=!0,d()}.bind(this),failure:function(){}.bind(this)},t));MWF.xDesktop.requireApp("process.Xform","$all",(function(){a=!0,d()}))},loadWorkByJob:function(t){MWF.Actions.get("x_processplatform_assemble_surface").listWorkByJob(t,function(t){var o=t.data.workCompletedList.length,i=t.data.workList.length+o;if(1===i)this.options.workId=t.data.workList.length?t.data.workList[0].id:t.data.workCompletedList[0].id,this.loadWork();else if(i>1){var s=this.filterId(t.data.workList,t.data.workCompletedList,this.options.priorityWork);if(s)this.options.workId=s,this.loadWork();else if(this.options.choice){var e=this.createWorksArea();t.data.workList.each(function(t){this.createWorkNode(t,e)}.bind(this)),t.data.workCompletedList.each(function(t){this.createWorkCompletedNode(t,e)}.bind(this)),this.mask&&this.mask.hide(),this.formNode.setStyles(this.css.formNode_bg)}else t.data.workList.length?this.options.workId=t.data.workList[0].id:this.options.workId=t.data.workCompletedList[0].id,this.loadWork()}else layout.sessionPromise.then(function(){this.close()}.bind(this),(function(){}))}.bind(this),function(){}.bind(this))},loadWorkByDraft:function(t,o){o2.Actions.invokeAsync([{action:this.action,name:layout.mobile?"getFormMobile":"getForm"}],{success:function(i){if(i){var s={activity:{},data:o||{},taskList:[],work:t};this.parseData(s,{allowVisit:!0,allowProcessing:!0,allowSave:!0,allowDelete:!0},i.data,[],[],[]),this.mask&&this.mask.hide(),layout.session&&layout.session.user?(this.openWork(),this.unLoading()):layout.sessionPromise&&layout.sessionPromise.then(function(){this.openWork(),this.unLoading()}.bind(this),(function(){}))}}.bind(this),failure:function(){}},[t.form,t.application])},createWorkNode:function(t,o,i){var s=o.getLast(),e=new Element("div",{styles:this.css.workItemNode}).inject(s);new Element("div",{styles:this.css.workItemTitleNode}).inject(e).set("text",t.title);var n=new Element("div",{styles:this.css.workItemInforNode}).inject(e);if(i)n.set("text",this.lp.completedWork);else{new Element("div",{styles:this.css.workItemInforTitleNode,text:this.lp.currentActivity}).inject(n),new Element("div",{styles:this.css.workItemInforContentNode,text:t.activityName}).inject(n),new Element("div",{styles:this.css.workItemInforTitleNode,text:this.lp.currentUsers}).inject(n);var r=[];MWF.Actions.get("x_processplatform_assemble_surface").listTaskByWork(t.id,function(t){t.data.each(function(t){r.push(MWF.name.cn(t.person))}.bind(this));new Element("div",{styles:this.css.workItemInforContentNode,text:r.join(", ")}).inject(n)}.bind(this))}var a=this;e.store("workId",t.id),e.addEvents({mouseover:function(){this.addClass("mainColor_border"),this.setStyles(a.css.workItemNode_over)},mouseout:function(){this.removeClass("mainColor_border"),this.setStyles(a.css.workItemNode)},click:function(){var t=this.retrieve("workId");t&&(a.options.workId=t,a.loadWork())}})},createWorksArea:function(){var t=new Element("div",{styles:this.css.workListArea}).inject(this.formNode);new Element("div",{styles:this.css.workListAreaTitle,text:this.lp.selectWork}).inject(t),new Element("div",{styles:this.css.workListContent}).inject(t);return t},filterId:function(t,o,i){if(!i)return"";if(!t.length&&!o.length)return"";if(t.length){var s=t.filter(function(t){return t.id==i}.bind(this));if(s.length)return s[0].id}return o.length&&(s=o.filter(function(t){return t.id==i}.bind(this))).length?s[0].id:""},parseData:function(t,o,i,s,e,n){var r=t.work.title;this.setTitle(r||this.options.title),this.activity=t.activity,this.data=t.data,this.taskList=t.taskList,this.currentTask=this.getCurrentTaskData(t),this.taskList=t.taskList,this.readList=t.readList,this.routeList=t.routeList,this.work=t.work,this.workCompleted=t.work.completedTime?t.work:null,this.workLogList=s,this.recordList=e,this.attachmentList=n,this.control=o,i&&(i.form?(this.formDataText=i.form.data?MWF.decodeJsonString(i.form.data):"",this.form=this.formDataText?JSON.decode(this.formDataText):null,this.relatedFormMap=i.relatedFormMap,this.relatedScriptMap=i.relatedScriptMap,this.relatedLanguage=i.relatedLanguage,delete i.form.data,this.formInfor=i.form):(this.formDataText=i.data?MWF.decodeJsonString(i.data):"",this.form=this.formDataText?JSON.decode(this.formDataText):null,delete i.data,this.formInfor=i))},loadMobileActions:function(){if(this.control.allowSave||this.control.allowProcessing){this.mobileActionBarNode=new Element("div",{styles:this.css.mobileActionBarNode}).inject(this.node,"after");var t=this.content.getSize().y-40;this.node.setStyles({height:t+"px","min-height":t+"px",overflow:"auto","padding-bottom":"40px"})}this.control.allowSave&&(this.mobileSaveActionNode=new Element("div",{styles:this.css.mobileSaveActionNode,text:this.lp.save}).inject(this.mobileActionBarNode),this.mobileSaveActionNode.addEvents({click:function(){this.appForm.saveWork()}.bind(this),touchstart:function(){this.setStyle("background-color","#EEEEEE")},touchcancel:function(){this.setStyle("background-color","#ffffff")},touchend:function(){this.setStyle("background-color","#ffffff")}}),this.control.allowProcessing&&this.mobileSaveActionNode.setStyles({width:"49%",float:"left"})),this.control.allowProcessing&&(this.mobileProcessActionNode=new Element("div",{styles:this.css.mobileSaveActionNode,text:this.lp.process}).inject(this.mobileActionBarNode),this.mobileProcessActionNode.addEvents({click:function(){this.appForm.processWork()}.bind(this),touchstart:function(){this.setStyle("background-color","#EEEEEE")},touchcancel:function(){this.setStyle("background-color","#ffffff")},touchend:function(){this.setStyle("background-color","#ffffff")}}),this.control.allowSave&&this.mobileProcessActionNode.setStyles({width:"49%",float:"right"}))},errorWork:function(){this.mask&&this.mask.hide(),this.node.set("text","openError")},getCurrentTaskData:function(t){return!t.currentTaskIndex&&0!==t.currentTaskIndex||-1==t.currentTaskIndex?null:(this.options.taskId=this.taskList[t.currentTaskIndex].id,this.taskList[t.currentTaskIndex])},openWork:function(){if(this.form){this.formNode.empty(),this.formNode.setStyles(this.css.formNode);window.location.href;MWF.xDesktop.requireApp("process.Xform","$all",function(){this.appForm=new MWF.APPForm(this.formNode,this.form,{}),this.appForm.businessData={data:this.data,originalData:Object.clone(this.data),taskList:this.taskList,readList:this.readList,work:this.work,workCompleted:this.workCompleted,control:this.control,activity:this.activity,task:this.currentTask,workLogList:this.workLogList,recordList:this.recordList,routeList:this.routeList,attachmentList:this.attachmentList,inheritedAttachmentList:this.inheritedAttachmentList,formInfor:this.formInfor,status:{readonly:this.readonly}},this.appForm.workAction=this.action,this.appForm.app=this,this.appForm.formDataText=this.formDataText,this.$events&&this.$events.queryLoadForm&&this.appForm.addEvent("queryLoad",function(){this.fireEvent("queryLoadForm")}.bind(this)),this.appForm.load(function(){this.mask&&this.mask.hide(),window.o2android&&window.o2android.appFormLoaded&&(layout.appForm=this.appForm,window.o2android.appFormLoaded(JSON.stringify(this.appForm.mobileTools))),window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.appFormLoaded&&(layout.appForm=this.appForm,window.webkit.messageHandlers.appFormLoaded.postMessage(JSON.stringify(this.appForm.mobileTools))),"processTask"==this.options.action&&(this.appForm.processWork(),this.options.action=""),this.fireEvent("postLoadForm")}.bind(this))}.bind(this))}},recordStatus:function(){return{workId:this.options.workId,workCompletedId:this.options.workCompletedId,jobId:this.options.jobId,draftId:this.options.draftId,priorityWork:this.options.priorityWork,readonly:this.readonly}},onPostClose:function(){this.appForm&&(this.appForm.modules.each((function(t){MWF.release(t)})),MWF.release(this.appForm))}});