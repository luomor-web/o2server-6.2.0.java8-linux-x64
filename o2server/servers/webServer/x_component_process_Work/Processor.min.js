MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Work=MWF.xApplication.process.Work||{},MWF.xDesktop.requireApp("process.Work","lp."+MWF.language,null,!1),MWF.xApplication.process.Work.Processor=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",mediaNode:null,opinion:"",tabletWidth:0,tabletHeight:0,orgHeight:276,maxOrgCountPerline:2,isManagerProcess:!1},initialize:function(t,e,s,i){this.setOptions(s),this.path="../x_component_process_Work/$Processor/",this.cssPath="../x_component_process_Work/$Processor/"+this.options.style+"/css.wcss",this._loadCss(),this.task=e,this.node=$(t),this.selectedRoute=null,this.form=i,this.load()},load:function(){layout.mobile?this.content=new Element("div").inject(this.node):this.content=this.node,!this.form&&this.options.isManagerProcess&&(this.managerProcessNoticeNode=new Element("div",{styles:this.css.managerProcessNoticeNode,html:MWF.xApplication.process.Work.LP.managerProcessNotice}).inject(this.content),this.managerLoginNode=new Element("div",{styles:this.css.managerLoginNode,text:MWF.xApplication.process.Work.LP.managerLogin}).inject(this.content),this.managerLoginNode.addEvent("click",function(t){this.managerLogin(t)}.bind(this))),this.routeOpinionTile=new Element("div",{styles:this.css.routeOpinionTile,text:MWF.xApplication.process.Work.LP.inputOpinion}).inject(this.content),this.routeOpinionArea=new Element("div",{styles:this.css.routeOpinionArea}).inject(this.content),this.setOpinion(),this.form&&(layout.mobile?(this.orgsArea=new Element("div",{styles:this.css.orgsArea}).inject(this.content),this.orgsTile=new Element("div",{styles:this.css.orgsTitle,text:MWF.xApplication.process.Work.LP.selectPerson}).inject(this.orgsArea),this.orgsArea.hide()):(this.orgsArea=new Element("div",{styles:this.css.orgsArea}).inject(this.content),this.orgsTile=new Element("div",{styles:this.css.orgsTitle,text:MWF.xApplication.process.Work.LP.selectPerson}).inject(this.orgsArea))),layout.mobile?this.buttonsArea=new Element("div",{styles:this.css.buttonsArea}).inject(this.node):this.buttonsArea=new Element("div",{styles:this.css.buttonsArea}).inject(this.content),this.setButtons(),this.form?layout.mobile?(this.getRouteGroupList(),this.hasDecisionOpinion?(this.routeContainer=new Element("div",{styles:this.css.routeContainer}).inject(this.routeOpinionTile,"before"),this.routeGroupTitle=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRouteGroup}).inject(this.routeContainer),this.routeGroupArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeContainer),this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeContainer),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeContainer),this.setRouteGroupList()):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList())):(this.getRouteGroupList(),this.hasDecisionOpinion?(this.routeContainer=new Element("div",{styles:this.css.routeContainer}).inject(this.routeOpinionTile,"before"),this.routeLeftWarper=new Element("div",{styles:this.getMaxOrgLength()>1?this.css.routeLeftWarper:this.css.routeLeftWarper_single}).inject(this.routeContainer),this.routeGroupTitle=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRouteGroup}).inject(this.routeLeftWarper),this.routeGroupArea=new Element("div",{styles:this.css.routeSelectorArea_hasGroup}).inject(this.routeLeftWarper),this.routeRightWarper=new Element("div",{styles:this.getMaxOrgLength()>1?this.css.routeRightWarper:this.css.routeRightWarper_single}).inject(this.routeContainer),this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeRightWarper),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea_hasGroup}).inject(this.routeRightWarper),this.setRouteGroupList()):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList())):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList_noform(),this.setSize_noform()),this.fireEvent("postLoad")},getRouteGroupList:function(){return this.routeGroupObject||(this.routeGroupObject={},this.routeGroupNameList=[],this.hasDecisionOpinion=!1,this.getRouteDataList().each(function(t,e){if(!(t.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString()))if(t.displayNameScriptText&&this.form&&this.form.Macro?t.displayName=this.form.Macro.exec(t.displayNameScriptText,this):t.displayName=t.name,t.decisionOpinion){this.hasDecisionOpinion=!0,t.decisionOpinion.split("#").each(function(e){this.routeGroupNameList.combine([e]);var s=this.splitByStartNumber(e);this.routeGroupObject[s.name]||(this.routeGroupObject[s.name]=[]),this.routeGroupObject[s.name].push(t)}.bind(this))}else{var s=MWF.xApplication.process.Work.LP.defaultDecisionOpinionName;this.routeGroupNameList.combine([s]),this.routeGroupObject[s]||(this.routeGroupObject[s]=[]),this.routeGroupObject[s].push(t)}}.bind(this))),this.routeGroupObject},splitByStartNumber:function(t){for(var e={name:"",order:""},s=0;s<t.length;s++){if("NaN"===parseInt(t.substr(s,1)).toString()){e.name=t.substr(s,t.length);break}e.order=e.order+t.substr(s,1)}return e},setRouteGroupList:function(){var t=this,e=this.routeGroupNameList;e.sort(function(t,e){return parseInt(this.splitByStartNumber(t).order||"9999999")-parseInt(this.splitByStartNumber(e).order||"9999999")}.bind(this));var s=[];e.each(function(t){s.push(this.splitByStartNumber(t).name)}.bind(this));var i=!1;s.each(function(s){var o=this.routeGroupObject[s],n=new Element("div",{styles:this.css.routeGroupNode,text:s}).inject(this.routeGroupArea);n.store("routeList",o),n.store("routeGroupName",s),n.addEvents({mouseover:function(e){t.overRouteGroup(this)},mouseout:function(e){t.outRouteGroup(this)},click:function(e){t.selectRouteGroup(this)}}),1===e.length?(this.selectRouteGroup(n),i=!1):i=!0}.bind(this)),i&&this.setSize(0)},overRouteGroup:function(t){this.selectedRouteGroup?this.selectedRouteGroup.get("text")!=t.get("text")&&t.setStyles(this.css.routeGroupNode_over):t.setStyles(this.css.routeGroupNode_over)},outRouteGroup:function(t){this.selectedRouteGroup?this.selectedRouteGroup.get("text")!=t.get("text")&&t.setStyles(this.css.routeGroupNode):t.setStyles(this.css.routeGroupNode)},selectRouteGroup:function(t){if(this.selectedRouteGroup){if(this.selectedRouteGroup.get("text")!=t.get("text")){this.selectedRouteGroup.setStyles(this.css.routeGroupNode),this.selectedRouteGroup=t,this.selectedRouteGroup.setStyles(this.css.routeGroupNode_selected);var e=this.selectedRouteGroup.retrieve("routeList");this.setRouteList(e)}}else{this.selectedRouteGroup=t,t.setStyles(this.css.routeGroupNode_selected);e=this.selectedRouteGroup.retrieve("routeList");this.setRouteList(e)}this.routeGroupArea.setStyle("background-color","#FFF")},setRouteList_noform:function(t){var e=this;this.routeSelectorArea.empty(),this.selectedRoute=null,t||(t=this.getRouteDataList()),t.each(function(s,i){var o=s.name,n=new Element("div",{styles:this.css.routeNode,text:o}).inject(this.routeSelectorArea);n.store("route",s.id),n.store("routeName",s.name),n.addEvents({mouseover:function(t){e.overRoute(this)},mouseout:function(t){e.outRoute(this)},click:function(t){e.selectRoute_noform(this)}}),(1==t.length||s.sole)&&this.selectRoute_noform(n)}.bind(this))},setRouteList:function(t){var e=this;this.routeSelectorArea.empty(),this.selectedRoute=null,t||(t=this.getRouteDataList());var s=!1;t.each(function(i,o){if(!(i.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(i.hiddenScriptText,this).toString())){var n=i.name;i.displayNameScriptText&&this.form&&this.form.Macro&&(n=this.form.Macro.exec(i.displayNameScriptText,this));var r=new Element("div",{styles:this.css.routeNode,text:n}).inject(this.routeSelectorArea);r.store("route",i.id),r.store("routeName",i.name),r.addEvents({mouseover:function(t){e.overRoute(this)},mouseout:function(t){e.outRoute(this)},click:function(t){e.selectRoute(this)}}),(1==t.length||i.sole)&&(this.selectRoute(r),s=!0)}}.bind(this)),s||(this.setSize(0),this.orgsArea&&this.orgsArea.hide())},overRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")&&(t.setStyles(this.css.routeNode_over),t.addClass("lightColor_bg")):(t.setStyles(this.css.routeNode_over),t.addClass("lightColor_bg"))},outRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")&&(t.setStyles(this.css.routeNode),t.removeClass("lightColor_bg")):(t.setStyles(this.css.routeNode),t.removeClass("lightColor_bg"))},selectRoute_noform:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")?(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")):(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.addClass("lightColor_bg"),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=null):(this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")),this.routeSelectorArea.setStyle("background-color","#FFF")},selectRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")?(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")):(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.addClass("lightColor_bg"),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=null):(this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")),this.routeSelectorArea.setStyle("background-color","#FFF"),layout.mobile?this.loadOrgs_mobile(this.selectedRoute?this.selectedRoute.retrieve("route"):""):this.loadOrgs(this.selectedRoute?this.selectedRoute.retrieve("route"):""),this.form.data.json.events&&this.form.data.json.events.afterSelectRoute&&this.form.Macro.exec(this.form.data.json.events.afterSelectRoute.code,t)},setOpinion:function(){this.selectIdeaNode=new Element("div",{styles:this.css.selectIdeaNode}).inject(this.routeOpinionArea),this.selectIdeaScrollNode=new Element("div",{styles:this.css.selectIdeaScrollNode}).inject(this.selectIdeaNode),this.selectIdeaAreaNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.selectIdeaScrollNode),this.inputOpinionNode=new Element("div",{styles:this.css.inputOpinionNode}).inject(this.routeOpinionArea),this.inputTextarea=new Element("textarea",{styles:this.css.inputTextarea,value:this.options.opinion||MWF.xApplication.process.Work.LP.inputText}).inject(this.inputOpinionNode),this.inputTextarea.addEvents({focus:function(){this.get("value")==MWF.xApplication.process.Work.LP.inputText&&this.set("value","")},blur:function(){this.get("value")||this.set("value",MWF.xApplication.process.Work.LP.inputText)},keydown:function(){this.inputTextarea.setStyles(this.inputTextareaStyle||this.css.inputTextarea)}.bind(this)}),this.mediaActionArea=new Element("div",{styles:this.css.inputOpinionMediaActionArea}).inject(this.inputOpinionNode),this.handwritingAction=new Element("div",{styles:this.css.inputOpinionHandwritingAction,text:MWF.xApplication.process.Work.LP.handwriting}).inject(this.mediaActionArea),this.handwritingAction.addEvent("click",function(){layout.mobile?window.setTimeout(function(){this.handwriting()}.bind(this),100):this.handwriting()}.bind(this)),layout.mobile&&this.selectIdeaNode.inject(this.routeOpinionArea,"after"),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.selectIdeaScrollNode,{style:"small",where:"before",distance:30,friction:4,indent:!1,axis:{x:!1,y:!0}})}.bind(this)),MWF.require("MWF.widget.UUID",function(){MWF.UD.getDataJson("idea",function(t){t?t.ideas&&this.setIdeaList(t.ideas):MWF.UD.getPublicData("idea",function(t){t&&t.ideas&&this.setIdeaList(t.ideas)}.bind(this))}.bind(this))}.bind(this))},audioRecord:function(){this.audioRecordNode||this.createAudioRecord(),this.audioRecordNode.show(),this.audioRecordNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"}),MWF.require("MWF.widget.AudioRecorder",function(){this.audioRecorder=new MWF.widget.AudioRecorder(this.audioRecordNode,{onSave:function(t){this.soundFile=t,this.audioRecordNode.hide()}.bind(this),onCancel:function(){this.soundFile=null,this.audioRecordNode.hide()}.bind(this)},null)}.bind(this))},createAudioRecord:function(){this.audioRecordNode=new Element("div",{styles:this.css.handwritingNode}).inject(this.node,"after");var t=(this.options.mediaNode||this.node).getSize(),e=this.node.getStyle("z-index");this.audioRecordNode.setStyles({height:t.y+"px",width:t.x+"px","z-index":e+1})},handwriting:function(){this.handwritingNode||this.createHandwriting(),this.handwritingNodeMask&&this.handwritingNodeMask.show(),this.handwritingNode.show(),layout.mobile?this.handwritingNode.setStyles({top:"0px",left:"0px"}):this.handwritingNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"})},createHandwriting:function(){this.handwritingNodeMask=new Element("div.handwritingMask",{styles:this.css.handwritingMask}).inject(this.node),this.handwritingNode=new Element("div.handwritingNode",{styles:this.css.handwritingNode}).inject(this.node,"after");var t=600,e=320;if(layout.mobile){var s=$(document.body).getSize();t=s.x,e=s.y,this.options.tabletWidth=0,this.options.tabletHeight=0}else t=Math.max(this.options.tabletWidth||t,500),e=Math.max(this.options.tabletHeight?parseInt(this.options.tabletHeight)+110:e,320);var i=this.node.getStyle("z-index");this.handwritingNode.setStyles({height:e+"px",width:t+"px","z-index":i+1}),layout.mobile?(this.handwritingNode.addEvent("touchmove",(function(t){t.preventDefault()})),this.handwritingNode.setStyles({top:"0px",left:"0px"})):this.handwritingNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"}),this.handwritingAreaNode=new Element("div",{styles:this.css.handwritingAreaNode}).inject(this.handwritingNode),this.handwritingActionNode=new Element("div",{styles:this.css.handwritingActionNode,text:MWF.xApplication.process.Work.LP.saveWrite}).inject(this.handwritingNode);var o=this.handwritingActionNode.getSize().y+this.handwritingActionNode.getStyle("margin-top").toInt()+this.handwritingActionNode.getStyle("margin-bottom").toInt();o=e-o,this.handwritingAreaNode.setStyle("height",o+"px"),MWF.require("MWF.widget.Tablet",function(){var t={style:"default",contentWidth:this.options.tabletWidth||0,contentHeight:this.options.tabletHeight||0,onSave:function(t,e,s){this.handwritingFile=s,this.handwritingNode.hide(),this.handwritingNodeMask.hide()}.bind(this),onCancel:function(){this.handwritingFile=null,this.handwritingNode.hide(),this.handwritingNodeMask.hide()}.bind(this)};layout.mobile&&(t.tools=["undo","redo","|","reset","|","size","cancel"]),this.tablet=new MWF.widget.Tablet(this.handwritingAreaNode,t,null),this.tablet.load()}.bind(this)),this.handwritingActionNode.addEvent("click",function(){this.tablet&&this.tablet.save()}.bind(this))},setIdeaList:function(t){var e=this;t.each(function(t){t&&new Element("div",{styles:this.css.selectIdeaItemNode,text:t,events:{click:function(){e.inputTextarea.get("value")==MWF.xApplication.process.Work.LP.inputText?e.inputTextarea.set("value",this.get("text")):e.inputTextarea.set("value",e.inputTextarea.get("value")+", "+this.get("text"))},dblclick:function(){e.inputTextarea.get("value")==MWF.xApplication.process.Work.LP.inputText?e.inputTextarea.set("value",this.get("text")):e.inputTextarea.set("value",e.inputTextarea.get("value")+", "+this.get("text"))},mouseover:function(){this.setStyles(e.css.selectIdeaItemNode_over)},mouseout:function(){this.setStyles(e.css.selectIdeaItemNode)}}}).inject(this.selectIdeaAreaNode)}.bind(this))},setButtons:function(){this.cancelButton=new Element("div",{styles:this.css.cancelButton}).inject(this.buttonsArea);new Element("div",{styles:this.css.cancelIconNode}).inject(this.cancelButton),new Element("div",{styles:this.css.cancelTextNode,text:MWF.xApplication.process.Work.LP.cancel}).inject(this.cancelButton);this.okButton=new Element("div",{styles:this.css.okButton}).inject(this.buttonsArea);new Element("div",{styles:this.css.okIconNode}).inject(this.okButton),new Element("div",{styles:this.css.okTextNode,text:MWF.xApplication.process.Work.LP.ok}).inject(this.okButton);this.cancelButton.addEvent("click",function(){this.destroy(),this.fireEvent("cancel")}.bind(this)),this.okButton.addEvent("click",function(t){layout.mobile?this.submit_mobile(t):this.submit_pc(t)}.bind(this))},submit_mobile:function(t){if(this.hasDecisionOpinion&&!this.selectedRouteGroup)return this.routeGroupArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRouteGroup,this.routeGroupArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;if(!this.selectedRoute)return this.routeSelectorArea.setStyle("background-color","#ffe9e9"),new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.routeSelectorArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.mustSelectRoute}),!1;var e=this.selectedRoute.retrieve("routeName")||this.selectedRoute.get("text"),s=this.inputTextarea.get("value");s===MWF.xApplication.process.Work.LP.inputText&&(s="");var i=[];this.handwritingFile&&i.push(this.handwritingFile),this.soundFile&&i.push(this.soundFile),this.videoFile&&i.push(this.videoFile);var o,n,r=this.selectedRoute.retrieve("route"),a=this.getRouteData(r);if(!s&&0===i.length&&1==a.opinionRequired)return this.inputTextarea.setStyle("background-color","#ffe9e9"),new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.inputTextarea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.opinionRequired}),!1;if(a.validationScriptText&&(!(h=this.form.Macro.exec(a.validationScriptText,this))||"true"!==h.toString()))return"string"===typeOf(h)?(new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.node,delayClose:6e3,content:h}),!1):(new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.node,delayClose:6e3,content:MWF.xApplication.process.Work.LP.routeValidFailure}),!1);if("appendTask"===a.type&&"select"===a.appendTaskIdentityType){if(!this.orgItems||0===this.orgItems.length)return new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.orgsArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig}),!1;o=this.orgItems[0]}if(!this.saveOrgs())return!1;if(!o||(n=o.getData())&&0!==n.length){var h;if(a.validationScriptText)if(!(h=this.form.Macro.exec(a.validationScriptText,this))||"true"!==h.toString())return"string"===typeOf(h)?(MWF.xDesktop.notice("error",{x:"center",y:"center"},h,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.routeValidFailure,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1);this.node.mask({inject:{where:"bottom",target:this.node},destroyOnHide:!0,style:{"background-color":"#999",opacity:.3,"z-index":600}});var c=[e,s,i,n,this.orgItems,function(){o&&o.setData([])}];this.fireEvent("submit",c)}else new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.orgsArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice})},submit_pc:function(t){if(this.hasDecisionOpinion&&!this.selectedRouteGroup)return this.routeGroupArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRouteGroup,this.routeGroupArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;if(!this.selectedRoute)return this.routeSelectorArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRoute,this.routeSelectorArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;var e=this.selectedRoute.retrieve("routeName")||this.selectedRoute.get("text"),s=this.inputTextarea.get("value");s===MWF.xApplication.process.Work.LP.inputText&&(s="");var i=[];this.handwritingFile&&i.push(this.handwritingFile),this.soundFile&&i.push(this.soundFile),this.videoFile&&i.push(this.videoFile);var o=this.selectedRoute.retrieve("route"),n=this.getRouteData(o);if(!s&&0===i.length&&1==n.opinionRequired)return this.inputTextarea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.opinionRequired,this.inputTextarea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;var r="";if("appendTask"===n.type&&"select"===n.appendTaskIdentityType){if(!this.orgItems||0===this.orgItems.length)return MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig,this.node,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;r=this.orgItems[0]}this.saveOrgsWithCheckEmpower(function(){var t;if(!r||(t=r.getData())&&0!==t.length){if(n.validationScriptText){var o=this.form.Macro.exec(n.validationScriptText,this);if(!o||"true"!==o.toString())return"string"===typeOf(o)?(MWF.xDesktop.notice("error",{x:"center",y:"center"},o,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.routeValidFailure,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1)}this.node.mask({inject:{where:"bottom",target:this.node},destroyOnHide:!0,style:{"background-color":"#999",opacity:.3,"z-index":600}});var a=[e,s,i,t,this.orgItems,function(){r&&r.setData([])}];this.fireEvent("submit",a)}else MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})}.bind(this))},destroy:function(){this.node.empty(),delete this.task,delete this.node,delete this.routeSelectorTile,delete this.routeSelectorArea,delete this.routeOpinionTile,delete this.routeOpinionArea,delete this.buttonsArea,delete this.inputOpinionNode,delete this.inputTextarea,delete this.cancelButton,delete this.okButton},getRouteDataList:function(){return this.routeDataList||(this.form&&this.form.businessData&&this.form.businessData.routeList&&(this.form.businessData.routeList.sort(function(t,e){return parseInt(t.orderNumber||"9999999")-parseInt(e.orderNumber||"9999999")}.bind(this)),this.form.businessData.routeList.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=this.form.businessData.routeList),this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.task.routeList},function(t){t.data.sort(function(t,e){return parseInt(t.orderNumber||"9999999")-parseInt(e.orderNumber||"9999999")}.bind(this)),t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1)),this.routeDataList},getRouteData:function(t){for(var e=this.getRouteDataList(),s=0;s<e.length;s++)if(e[s].id===t)return e[s]},getMaxOrgLength:function(){var t=this.getRouteDataList(),e=0;return t.each(function(t){t.hiddenScriptText&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString()||(e=Math.max(e,t.selectConfigList.length))}.bind(this)),e},getOrgData:function(t){for(var e=this.getRouteDataList(),s=0;s<e.length;s++)if(e[s].id===t)return e[s].selectConfigList},getVisableOrgData:function(t){var e=this.getOrgData(t),s=[];return(e||[]).each(function(t){this.isOrgHidden(t)||s.push(t)}.bind(this)),s},isOrgHidden:function(t){if(t.hiddenScript&&t.hiddenScript.code){var e=this.form.Macro.exec(t.hiddenScript.code,this);if(e&&"true"===e.toString())return!0}return!1},loadOrgs_mobile:function(t){if(!this.form||!t)return this.orgsArea.hide(),void this.setSize(0);this.orgsArea.show(),this.orgTableObject||(this.orgTableObject={}),this.orgItemsObject||(this.orgItemsObject={}),this.orgItemsMap||(this.orgItemsMap={});var e=!1;for(var s in this.orgTableObject)t===s?e=!0:this.orgTableObject[s].hide();e?this.showOrgs_mobile(t):this.createOrgs_mobile(t)},showOrgs_mobile:function(t){this.orgItemMap=this.orgItemsMap[t]||{};var e=this.getVisableOrgData(t);e.length?this.isSameArray(Object.keys(this.orgItemMap),e.map((function(t){return t.name})))?(this.orgTableObject[t].show(),this.orgItems=this.orgItemsObject[t]||[],this.setSize(e.length)):this.loadOrgTable_mobile(t):(this.orgsArea.hide(),this.orgItemMap={},this.orgItems=[],this.setSize(0))},createOrgs_mobile:function(t){var e=this.getVisableOrgData(t);e.length?this.loadOrgTable_mobile(t):(this.setSize(e.length),this.orgItemMap={},this.orgItems=[],this.orgsArea.hide())},loadOrgTable_mobile:function(t){var e=this.getVisableOrgData(t);this.setSize(e.length),this.orgsArea.show();var s=this.orgTableObject[t],i={};s&&s.getChildren("div").each((function(t){i[t.retrieve("orgName")]=t}));this.orgItemsObject[t];var o=this.orgItemsMap[t]||{};this.orgItemsObject[t]=[],this.orgItemsMap[t]={},this.orgItems=this.orgItemsObject[t],this.orgItemMap=this.orgItemsMap[t];var n=new Element("div",{styles:this.css.routeOrgTable}).inject(this.orgsArea);this.orgTableObject[t]=n;e.each(function(t,e){var s=new Element("div",{styles:this.css.routeOrgTr}).inject(n);if(s.store("orgName",t.name),o[t.name]){var r=o[t.name];this.orgItems.push(r),this.orgItemMap[t.name]=r,i[t.name].getChildren().inject(s)}else this.loadOrg_mobile(s,t,!1)}.bind(this)),s&&s.destroy()},loadOrg_mobile:function(t,e,s){var i=new Element("div.selectorTitle",{styles:this.css.selectorTitle}).inject(t),o=(new Element("div.selectorTitleText",{text:e.title,styles:this.css.selectorTitleText}).inject(i),new Element("div.selectorContent",{styles:this.css.selectorContent}).inject(t)),n=new Element("div.selectorErrorNode",{styles:this.css.selectorErrorNode}).inject(t),r=new MWF.xApplication.process.Work.Processor.Org(o,this.form,e,this,{onSelect:function(t,e){e&&e.length?o.setStyles(this.css.selectorContent):o.setStyles(this.css.selectorContent_noItem)}.bind(this)});r.ignoreOldData=s,r.errContainer=n,r.summitDlalog=this,this.orgItems.push(r),this.orgItemMap[e.name]=r,i.addEvent("click",function(){this.load()}.bind(r)),o.addEvent("click",function(){this.load()}.bind(r));var a=r.getValue();r.loadOrgWidget(a,o),a&&0!=a.length||o.setStyles(this.css.selectorContent_noItem)},isSameArray:function(t,e){if(t.length!==e.length)return!1;for(var s=0;s<t.length;s++)if(t[s]!==e[s])return!1;return!0},loadOrgs:function(t){if(!this.form||!t)return this.orgsArea.hide(),void this.setSize(0);this.orgsArea.show(),this.orgTableObject||(this.orgTableObject={}),this.orgItemsObject||(this.orgItemsObject={}),this.orgItemsMap||(this.orgItemsMap={});var e=!1;for(var s in this.orgTableObject)t===s?e=!0:this.orgTableObject[s].hide();e?this.showOrgs(t):this.createOrgs(t)},showOrgs:function(t){this.orgItemMap=this.orgItemsMap[t]||{};var e=this.getVisableOrgData(t);e.length?this.isSameArray(Object.keys(this.orgItemMap),e.map((function(t){return t.name})))?(this.orgTableObject[t].show(),this.orgItems=this.orgItemsObject[t]||[],this.setSize(e.length)):this.loadOrgTable(t):(this.orgsArea.hide(),this.orgItemMap={},this.orgItems=[],this.setSize(0))},createOrgs:function(t){var e=this.getVisableOrgData(t);e.length?this.loadOrgTable(t):(this.setSize(e.length),this.orgItemMap={},this.orgItems=[],this.orgsArea.hide())},loadOrgTable:function(t){this.getOrgData(t);var e=this.getVisableOrgData(t);this.setSize(e.length),this.orgsArea.show();var s=this.orgTableObject[t],i={};s&&s.getElements("td").each((function(t){i[t.retrieve("orgName")]=t}));this.orgItemsObject[t];var o=this.orgItemsMap[t]||{};this.orgItemsObject[t]=[],this.orgItemsMap[t]={},this.orgItems=this.orgItemsObject[t],this.orgItemMap=this.orgItemsMap[t];var n=e.length,r=new Element("table",{cellspacing:0,cellpadding:0,border:0,width:"100%",styles:this.css.routeOrgTable}).inject(this.orgsArea);this.orgTableObject[t]=r;for(var a=((n+1)/2).toInt(),h=0;h<a;h++){var c=new Element("tr").inject(r);new Element("td",{width:"50%",valign:"bottom",styles:this.css.routeOrgOddTd}).inject(c),new Element("td",{width:"50%",valign:"bottom",styles:this.css.routeOrgEvenTd}).inject(c)}var l=r.getElements("tr");e.each(function(t,e){var s;if(e+1==n&&n%2==1)if((s=l[l.length-1].getFirst("td")).set("colspan",2),l[l.length-1].getLast("td").destroy(),s.setStyle("border","0px"),s.set("width","100%"),s.store("orgName",t.name),o[t.name]){var r=o[t.name];this.orgItems.push(r),this.orgItemMap[t.name]=r,i[t.name].getChildren().inject(s)}else this.loadOrg(s,t,"all",!1);else{var a=((e+2)/2).toInt(),h=l[a-1];if((s=e%2==0?h.getFirst("td"):h.getLast("td")).store("orgName",t.name),o[t.name]){r=o[t.name];this.orgItems.push(r),this.orgItemMap[t.name]=r,i[t.name].getChildren().inject(s)}else this.loadOrg(s,t,e%2==0?"left":"right",!1)}}.bind(this)),s&&s.destroy()},loadOrg:function(t,e,s,i){var o=new Element("div.selectorTitle",{styles:this.css.selectorTitle}).inject(t),n=(new Element("div.selectorTitleText",{text:e.title,styles:this.css.selectorTitleText}).inject(o),new Element("div.selectorErrorNode",{styles:this.css.selectorErrorNode}).inject(o)),r=new Element("div.selectorContent",{styles:this.css.selectorContent}).inject(t),a=new MWF.xApplication.process.Work.Processor.Org(r,this.form,e,this);a.ignoreOldData=i,a.errContainer=n,a.summitDlalog=this,a.load(),this.orgItems.push(a),this.orgItemMap[e.name]=a},showOrgsByRoute:function(t){this.loadOrgs(t)},clearAllOrgs:function(){for(var t in this.orgItemsObject){(this.orgItemsObject[t]||[]).each((function(t){t.setDataToOriginal()}))}this.orgTableObject={},this.orgItemsObject={},this.orgItemsMap={},this.orgsArea.empty()},getCurrentRouteSelectorList:function(){var t=[],e=this.selectedRoute?this.selectedRoute.retrieve("route"):"",s=this.orgItemsObject[e];return s?(s.each(function(e){e.selector&&e.selector.selector&&t.push(e.selector.selector)}.bind(this)),t):[]},getCurrentRouteOrgList:function(){var t=this.selectedRoute?this.selectedRoute.retrieve("route"):"";return this.orgItemsObject[t]||[]},getSelectorSelectedData:function(t){for(var e=[],s=this.getCurrentRouteOrgList(),i=0;i<s.length;i++){var o=s[i];if(o.json.name===t)o.selector.selector.selectedItems.each((function(t){e.push(t.data)}))}return e},getOffsetY:function(t){return(t.getStyle("margin-top").toInt()||0)+(t.getStyle("margin-bottom").toInt()||0)+(t.getStyle("padding-top").toInt()||0)+(t.getStyle("padding-bottom").toInt()||0)+(t.getStyle("border-top-width").toInt()||0)+(t.getStyle("border-bottom-width").toInt()||0)},setSize_noform:function(){var t=0;this.managerProcessNoticeNode&&(t=t+this.getOffsetY(this.managerProcessNoticeNode)+this.managerProcessNoticeNode.getStyle("height").toInt()),this.managerLoginNode&&(t=t+this.getOffsetY(this.managerLoginNode)+this.managerLoginNode.getStyle("height").toInt()),this.routeSelectorTile&&(t=t+this.getOffsetY(this.routeSelectorTile)+this.routeSelectorTile.getStyle("height").toInt()),this.routeSelectorArea&&(t=t+this.getOffsetY(this.routeSelectorArea)+this.routeSelectorArea.getStyle("height").toInt()),this.routeOpinionTile&&(t=t+this.getOffsetY(this.routeOpinionTile)+this.routeOpinionTile.getStyle("height").toInt()),this.routeOpinionArea&&(t=t+this.getOffsetY(this.routeOpinionArea)+this.routeOpinionArea.getStyle("height").toInt()),this.node.setStyle("height",t),this.fireEvent("resize")},setSize:function(t,e){layout.mobile?this.setSize_mobile():this.setSize_pc(t,e),e||this.fireEvent("resize")},setSize_mobile:function(){if(this.buttonsArea){var t=$(document.body).getSize().y-this.getOffsetY(this.node);this.node.setStyles({"overflow-y":"hidden",height:t});var e=this.buttonsArea.getSize();this.content.setStyles({height:t-e.y-this.getOffsetY(this.buttonsArea)-this.getOffsetY(this.content),"overflow-y":"auto"})}},setSize_pc:function(t,e){var s=((t+1)/2).toInt(),i=0;this.routeSelectorTile&&(i=i+this.getOffsetY(this.routeSelectorTile)+this.routeSelectorTile.getStyle("height").toInt()),this.routeSelectorArea&&(i=i+this.getOffsetY(this.routeSelectorArea)+this.routeSelectorArea.getStyle("height").toInt()),this.routeOpinionTile&&(i=i+this.getOffsetY(this.routeOpinionTile)+this.routeOpinionTile.getStyle("height").toInt()),this.routeOpinionArea&&(i=i+this.getOffsetY(this.routeOpinionArea)+this.routeOpinionArea.getStyle("height").toInt()),s>0?(this.orgsArea&&this.orgsArea.show(),e?(this.orgsArea.getChildren().each(function(t){i+=t.getSize().y+this.getOffsetY(t)}.bind(this)),this.node.setStyle("height",i)):(this.orgsTile&&(i=i+this.getOffsetY(this.orgsTile)+this.orgsTile.getStyle("height").toInt()),i=i+s*this.options.orgHeight+this.getOffsetY(this.orgsArea),this.node.setStyle("height",i))):(this.orgsArea&&this.orgsArea.hide(),this.node.setStyle("height",i)),this.getMaxOrgLength()>1?(this.node.setStyles(this.css.node_wide),this.inputOpinionNode.setStyles(this.css.inputOpinionNode_wide),this.inputTextarea.setStyles(this.css.inputTextarea_wide),this.inputTextareaStyle=this.css.inputTextarea_wide,this.selectIdeaNode.setStyles(this.css.selectIdeaNode_wide)):(this.node.setStyles(this.css.node),this.inputOpinionNode.setStyles(this.css.inputOpinionNode),this.inputTextarea.setStyles(this.css.inputTextarea),this.inputTextareaStyle=this.css.inputTextarea,this.selectIdeaNode.setStyles(this.css.selectIdeaNode))},isErrorHeightOverflow:function(){var t=!1;return(this.orgItems||[]).each(function(e){e.errorHeightOverflow&&(t=!0)}.bind(this)),t},checkErrorHeightOverflow:function(t){(t||this.isErrorHeightOverflow())&&this.setSize(this.orgItems.length,!0)},errorHeightChange:function(){this.checkErrorHeightOverflow(!0)},validationOrgs:function(){if(!this.orgItems||!this.orgItems.length)return!0;var t=!0;return this.orgItems.each(function(e){e.validation()||(t=!1)}.bind(this)),this.checkErrorHeightOverflow(),t},isOrgsHasEmpower:function(){if(!this.orgItems||!this.orgItems.length)return!0;var t=!1;return this.needCheckEmpowerOrg=[],this.orgItems.each(function(e){e.hasEmpowerIdentity()&&(this.needCheckEmpowerOrg.push(e),t=!0)}.bind(this)),t},saveOrgs:function(t){if(!this.orgItems||!this.orgItems.length)return!0;var e=!0;return this.orgItems.each(function(s){s.save(!t)||(e=!1)}.bind(this)),e},saveOrgsWithCheckEmpower:function(t){var e=this.selectedRoute?this.selectedRoute.retrieve("route"):"",s=this.getVisableOrgData(e||this.selectedRouteId||"").length,i=0;return this.orgItems&&this.orgItems.length&&(i=this.orgItems.length),s!==i?(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.loadedOrgCountUnexpected,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):this.orgItems&&this.orgItems.length?!!this.validationOrgs()&&(layout.mobile?(t&&t(),!0):this.isOrgsHasEmpower()?void this.showEmpowerDlg(t):(t&&t(),!0)):(t&&t(),!0)},showEmpowerDlg:function(t){for(var e=new Element("div.empowerNode",{styles:this.css.empowerNode}),s=(new Element("div",{text:MWF.xApplication.process.Xform.LP.empowerDlgText,styles:this.css.empowerTitleNode}).inject(e),this.needCheckEmpowerOrg),i=s.length,o=((i+1)/2).toInt(),n=new Element("table",{cellspacing:0,cellpadding:0,border:0,width:"100%",styles:this.css.empowerTable}).inject(e),r=0;r<o;r++){var a=new Element("tr").inject(n);new Element("td",{width:"50%",styles:this.css.empowerOddTd}).inject(a),new Element("td",{width:"50%",styles:this.css.empowerEvenTd}).inject(a)}var h=n.getElements("tr");s.each(function(t,e){var s;if(e+1==i&&i%2==1)(s=h[h.length-1].getFirst("td")).set("colspan",2),h[h.length-1].getLast("td").destroy(),"50%";else{var o=((e+2)/2).toInt(),n=h[o-1];s=e%2==0?n.getFirst("td"):n.getLast("td")}var r=new Element("div.empowerAreaTitle",{styles:this.css.empowerAreaTitle}).inject(s),a=(new Element("div.empowerAreaTitleText",{text:t.json.title,styles:this.css.empowerAreaTitleText}).inject(r),new Element("div",{styles:{float:"right"}}).inject(r)),c=new Element("div.empowerAreaContent",{styles:this.css.empowerAreaContent}).inject(s);t.loadCheckEmpower(null,c,a)}.bind(this)),e.setStyle("height",o*this.options.orgHeight+20);e.setStyle("width","840px"),this.node.getParent().mask({style:this.css.mask}),this.empowerDlg=o2.DL.open({title:MWF.xApplication.process.Xform.LP.selectEmpower,style:this.form.json.dialogStyle||"user",isResize:!1,content:e,width:880,height:"auto",mark:!1,onPostLoad:function(){this.nodeWidth&&this.node.setStyle("width",this.nodeWidth+"px"),this.nodeHeight&&this.node.setStyle("height",this.nodeHeight+"px")},buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(e,i){s.each(function(e,i){e.saveCheckedEmpowerData(function(){i===s.length-1&&(t&&t(),this.node.getParent().unmask(),this.empowerDlg.close())}.bind(this))}.bind(this))}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){this.node.getParent().unmask(),this.empowerDlg.close()}.bind(this)}]})},managerLogin:function(t){var e=this,s=(this.task.identityDn||this.task.identity).split("@")[0],i=MWF.xApplication.process.Work.LP.managerLoginConfirmContent.replace("{user}",s);MWF.xDesktop.confirm("infor",t,MWF.xApplication.process.Work.LP.managerLoginConfirmTitle,i,450,120,(function(){o2.Actions.load("x_organization_assemble_authentication").AuthenticationAction.switchUser({credential:e.task.personDn||e.task.person},function(){var t=MWF.xApplication.process.Work.LP.managerLoginSuccess.replace("{user}",s);MWF.xDesktop.notice("success",{x:"right",y:"top"},t),window.open(o2.filterUrl("../x_desktop/work.html?workid="+e.task.work))}.bind(this)),this.close()}),(function(){this.close()}),null,null)}}),MWF.xApplication.process.Xform&&MWF.xApplication.process.Xform.Form&&(MWF.xDesktop.requireApp("process.Xform","Org",null,!1),MWF.xApplication.process.Work.Processor.Org=new Class({Implements:[Options,Events],options:{moduleEvents:["queryLoadSelector","postLoadSelector","postLoadContent","queryLoadCategory","postLoadCategory","selectCategory","unselectCategory","queryLoadItem","postLoadItem","selectItem","unselectItem","change"]},initialize:function(t,e,s,i,o){this.form=e,this.json=s,this.processor=i,this.container=$(t),this.orgAction=MWF.Actions.get("x_organization_assemble_control"),this.setOptions(o)},load:function(){if(layout.mobile)setTimeout(function(){var t=this.getOptions();t&&(this.selector=new MWF.O2Selector($(document.body),t))}.bind(this),100);else{var t=this.getOptions();t&&(this.selector=new MWF.O2Selector(this.container,t))}},_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.xApplication.process.Work.Processor.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.xApplication.process.Work.Processor.UnitOptions(this.form,this.json))},getOptions:function(){var t=this;if(this._getOrgOptions(),0===this.selectTypeList.length)return!1;var e,s,i,o=[];if(this.json.exclude){var n=this.form.Macro.exec(this.json.exclude.code,this);o="array"===typeOf(n)?n:[n]}this.identityOptions&&(e=this.identityOptions.getOptions(),"all"!==this.json.identityRange&&(e.noUnit||e.units&&e.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange,"error",this.node),e.disabled=!0)),!e.noUnit&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(e.dutys&&e.dutys.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange,"error",this.node),e.disabled=!0)),this.ignoreOldData?e.values=this._computeValue()||[]:e.values=this.getValue()||[],e.exclude=o),this.unitOptions&&(s=this.unitOptions.getOptions(),"all"!==this.json.unitRange&&(s.units&&s.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange,"error",this.node),s.disabled=!0)),this.ignoreOldData?s.values=this._computeValue()||[]:s.values=this.getValue()||[],s.exclude=o),i=layout.mobile?{style:"default",zIndex:3e3}:{style:"process",width:"auto",height:"240",embedded:!0,hasLetter:!1,hasTop:!0},this.json.events&&"object"===typeOf(this.json.events)&&Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.moduleEvents.indexOf(e)&&("postLoadSelector"===e?this.addEvent("loadSelector",function(e){return this.form.Macro.fire(t.code,e)}.bind(this)):"queryLoadSelector"===e?i.onQueryLoad=function(e){return this.form.Macro.fire(t.code,e)}.bind(this):i["on"+e.capitalize()]=function(e){return this.form.Macro.fire(t.code,e)}.bind(this))}.bind(this)),this.needValid()&&(i.onValid=function(t){this.validOnSelect()}.bind(this)),this.form.json.selectorStyle&&(i=Object.merge(Object.clone(this.form.json.selectorStyle),i),this.form.json.selectorStyle.style&&(i.style=this.form.json.selectorStyle.style));var r={onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onClose:this.selectOnClose.bind(this)};if(1===this.selectTypeList.length)return Object.merge(i,{type:this.selectTypeList[0],onLoad:function(){t.selectOnLoad(this,this.selector)}},layout.mobile?r:{},e||s);if(this.selectTypeList.length>1){var a={type:"",types:this.selectTypeList,onLoad:function(){t.selectOnLoad(this)}};return e&&(a.identityOptions=Object.merge(i,layout.mobile?r:{},e)),s&&(a.unitOptions=Object.merge(i,layout.mobile?r:{},s)),a}},selectOnComplete:function(t){var e=[];t.each(function(t){e.push(t.data)}.bind(this));var s="simple"===this.json.storeRange;this.checkEmpower(e,function(e){var i=[];e.each(function(t){i.push(MWF.org.parseOrgData(t,!0,s))}.bind(this)),this.setData(i),this.container.empty(),this.loadOrgWidget(i,this.container),this.selector=null,this.fireEvent("select",[t,i])}.bind(this))},selectOnCancel:function(){},selectOnLoad:function(t){this.fireEvent("loadSelector",[t])},selectOnClose:function(){this._getBusinessData()},loadOrgWidget:function(t,e){var s=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||s||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){"string"===typeOf(t)&&(t={distinguishedName:t,name:o2.name.cn(t)});var s,i=t.distinguishedName.substr(t.distinguishedName.length-1,1),o=Object.clone(t);if(this.json.displayTextScript&&this.json.displayTextScript.code){this.currentData=o;var n=this.form.Macro.exec(this.json.displayTextScript.code,this);n&&(o.displayName=n),this.currentData=null}switch(i.toLowerCase()){case"i":s=new MWF.widget.O2Identity(o,e,{style:"xform",lazy:!0});break;case"p":s=new MWF.widget.O2Person(o,e,{style:"xform",lazy:!0});break;case"u":s=new MWF.widget.O2Unit(o,e,{style:"xform",lazy:!0});break;case"g":s=new MWF.widget.O2Group(o,e,{style:"xform",lazy:!0});break;default:s=new MWF.widget.O2Other(o,e,{style:"xform",lazy:!0})}s.field=this,layout.mobile}.bind(this))},hasEmpowerIdentity:function(){var t=this.getData();return this.empowerChecker||(this.empowerChecker=new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form,this.json,this.processor)),this.empowerChecker.hasEmpowerIdentity(t)},checkEmpower:function(t,e,s,i){"array"===typeOf(t)&&this.identityOptions&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType?(this.empowerChecker||(this.empowerChecker=new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form,this.json,this.processor)),this.empowerChecker.selectAllNode=i,this.empowerChecker.load(t,e,s)):e&&e(t)},loadCheckEmpower:function(t,e,s){this.checkEmpower(this.getData(),t,e,s)},saveCheckedEmpowerData:function(t){var e=this.getData(),s="simple"===this.json.storeRange;this.empowerChecker.setIgnoreEmpowerFlag(e,function(e){var i=[];e.each(function(t){i.push(MWF.org.parseOrgData(t,!0,s))}.bind(this)),this.setData(i),t&&t(i)}.bind(this))},save:function(t){return t?!!this.validation()||(this.processor.checkErrorHeightOverflow(),!1):(this.setData(this.getData()),!0)},resetSelectorData:function(){this.selector&&this.selector.selector&&(this.selector.selector.emptySelectedItems(),this.selector.selector.options.values=this.getValue()||[],this.selector.selector.setSelectedItem())},setDataToOriginal:function(){var t=this._computeValue();this.setData(t||"")},resetData:function(){var t=this.getValue()||[];this.setData(t)},getData:function(){return this.selector&&!layout.mobile?this.getSelectedData():this.getValue()},getSelectedData:function(){if(layout.mobile)return this.getValue();var t="simple"===this.json.storeRange,e=[];return this.selector&&this.selector.selector&&this.selector.selector.selectedItems.each((function(s){e.push(MWF.org.parseOrgData(s.data,!0,t))})),e},getValue:function(){var t=this._getBusinessData();return t||(t=this._computeValue()),t||""},_computeValue:function(){var t=[];if(this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)})),this.json.dutyValue){var e,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){s.code&&(e=this.form.Macro.exec(s.code,this));var i='return this.org.getDuty("'+s.name+'", "'+e+'")',o=this.form.Macro.exec(i,this);"array"!==typeOf(o)&&(o=o?[o.toString()]:[]),o.each((function(e){e&&t.push(e)}))}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var i=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(i)&&(i=i?[i]:[]),i.each(function(e){var s;e&&("string"===typeOf(e)?(this.getOrgAction()[this.getValueMethod(e)](function(t){s=t.data}.bind(this),null,e,!1),t.push(s)):t.push(e))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},setData:function(t){if(!t)return!1;var e,s=this.getValue(),i=[],o="simple"===this.json.storeRange,n=typeOf(t);("array"===n&&t.each(function(t){var e=typeOf(t),s=null;"string"===e&&this.getOrgAction()[this.getValueMethod(t)](function(t){s=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),error,t,!1),"object"===e&&(s=MWF.org.parseOrgData(t,!0,o)).woPerson&&delete s.woPerson,s&&i.push(s)}.bind(this)),"string"===n)&&(this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),error,t,!1),e&&i.push(e));"object"===n&&((e=MWF.org.parseOrgData(t,!0,o)).woPerson&&delete e.woPerson,i.push(e));var r=!1;if(s.length&&i.length)if(s.length===i.length){for(var a=0;a<s.length;a++)if(s[a].distinguishedName!==i[a].distinguishedName||s[a].name!==i[a].name||s[a].unique!==i[a].unique){r=!0;break}}else r=!0;else(i.length||s.length)&&(r=!0);this._setBusinessData(i),r&&this.fireEvent("change")},getValueMethod:function(t){if(t)switch(t.substr(t.length-1,1).toLowerCase()){case"i":return"getIdentity";case"p":return"getPerson";case"u":return"getUnit";case"g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},_getBusinessData:function(){return"yes"==this.json.section?this._getBusinessSectionData():"Opinion"===this.json.type?this._getBusinessSectionDataByPerson():this.form.businessData.data[this.json.name]||""},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript.code);default:return this.form.businessData.data[this.json.name]||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.name]=layout.desktop.session.user.id;var t=this.form.businessData.data[this.json.name];return t&&t[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.task?this.form.businessData.task.unit:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.work?this.form.businessData.work.activity:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.work?this.form.businessData.work.splitValue:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataByScript:function(t){this.form.sectionListObj[this.json.name]="";var e=this.form.businessData.data[this.json.name];if(!e)return"";var s=this.form.Macro.exec(t,this);return s&&(this.form.sectionListObj[this.json.name]=s),s&&e[s]||""},loadPathData:function(t){var e=null;return this.form.workAction.getJobDataByPath(this.form.businessData.work.job,t,(function(t){e=t.data||null}),null,!1),e},_setBusinessData:function(t){"yes"==this.json.section?this._setBusinessSectionData(t):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(t):(this.form.businessData.data[this.json.name]?this.form.businessData.data[this.json.name]=t:(this.form.businessData.data[this.json.name]=t,this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=t))},_setBusinessSectionData:function(t){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(t);break;case"unit":this._setBusinessSectionDataByUnit(t);break;case"activity":this._setBusinessSectionDataByActivity(t);break;case"splitValue":this._setBusinessSectionDataBySplitValue(t);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,t);break;default:this.form.businessData.data[this.json.name]?this.form.businessData.data[this.json.name]=t:(this.form.businessData.data[this.json.name]=t,this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(t){var e=!1,s=layout.desktop.session.user.id;this.form.sectionListObj[this.json.name]=s;var i=this.form.businessData.data[this.json.name];i||(i={},this.form.businessData.data[this.json.name]=i,e=!0),i[s]||(e=!0),i[s]=t,e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(t){var e=!1,s=this.form.businessData.task?this.form.businessData.task.unit:"";if(s){this.form.sectionListObj[this.json.name]=s;var i=this.form.businessData.data[this.json.name];i||(i={},this.form.businessData.data[this.json.name]=i,e=!0),i[s]||(e=!0),i[s]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(t){var e=!1,s=this.form.businessData.work?this.form.businessData.work.activity:"";if(s){this.form.sectionListObj[this.json.name]=s;var i=this.form.businessData.data[this.json.name];i||(i={},this.form.businessData.data[this.json.name]=i,e=!0),i[s]||(e=!0),i[s]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(t){var e=!1,s=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(s){this.form.sectionListObj[this.json.name]=s;var i=this.form.businessData.data[this.json.name];i||(i={},this.form.businessData.data[this.json.name]=i,e=!0),i[s]||(e=!0),i[s]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(t,e){var s=!1,i=this.form.Macro.exec(t,this);if(i){this.form.sectionListObj[this.json.name]=i;var o=this.form.businessData.data[this.json.name];o||(o={},this.form.businessData.data[this.json.name]=o,s=!0),o[i]||(s=!0),o[i]=e}s&&this.form.Macro.environment.setData(this.form.businessData.data)},createErrorNode:function(t){var e,s=this;if(this.processor.css.errorContentNode){if(e=new Element("div",{styles:this.processor.css.errorContentNode,text:t}),this.processor.css.errorCloseNode)new Element("div",{styles:this.processor.css.errorCloseNode,events:{click:function(){this.destroy(),s.errorHeightOverflow&&(s.errorHeightOverflow=!1,s.processor.errorHeightChange())}.bind(e)}}).inject(e)}else{e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{height:"auto","min-height":"20px","line-height":"20px","margin-left":"20px",color:"red","word-break":"break-all"},text:t}).inject(e)}return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.errNode=this.createErrorNode(t),this.errContainer?(this.errContainer.empty(),this.errNode.inject(this.errContainer)):this.errNode.inject(this.container,"after");var e=this.errNode.getSize();!layout.mobile&&e.y>26&&(this.errorHeightOverflow=!0)}},needValid:function(){return this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())||this.json.validation&&this.json.validation.code},validOnSelect:function(){if(!this.errNode)return!0;var t=!0;if(this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())&&this.selector.selector.selectedItems.length<this.json.validationCount.toInt()&&(t=MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}",this.json.validationCount)),!0===t&&this.json.validation&&this.json.validation.code){var e=this.getData();this.setData(e),(t=this.form.Macro.exec(this.json.validation.code,this))||(t=MWF.xApplication.process.Xform.LP.notValidation)}return"true"!=t.toString()?(this.notValidationMode(t),this.processor.errorHeightChange(),!1):(this.errNode&&(this.errNode.destroy(),this.errNode=null,this.errorHeightOverflow&&(this.errorHeightOverflow=!1,this.processor.errorHeightChange())),!0)},validation:function(){var t=this.getData();this.setData(t);var e=!0;return this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())&&t.length<this.json.validationCount.toInt()&&(e=MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}",this.json.validationCount)),!0===e&&this.json.validation&&this.json.validation.code&&((e=this.form.Macro.exec(this.json.validation.code,this))||(e=MWF.xApplication.process.Xform.LP.notValidation)),"true"!=e.toString()?(this.notValidationMode(e),!1):(this.errNode&&(this.errNode.destroy(),this.errNode=null),!0)}}),MWF.xApplication.process.Work.Processor.EmpowerChecker=new Class({Extends:MWF.APPOrg.EmpowerChecker,initialize:function(t,e,s){this.form=t,this.json=e,this.processor=s,this.css=this.processor.css,this.checkedAllItems=!0},load:function(t,e,s){if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var i=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&i.push(t.distinguishedName))}.bind(this)),i.length>0?o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:i},function(i){var o=[];i.data.each((function(t){t.fromIdentity!==t.toIdentity&&o.push(t)})),o.length>0?layout.mobile?this.openSelectEmpowerDlg(o,t,e,s):this.openSelectEmpowerDlg_embedded(o,t,e,s):e&&e(t)}.bind(this),function(){e&&e(t)}.bind(this)):e&&e(t)}else e&&e(t)},hasEmpowerIdentity:function(t){var e=!1;if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var s=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&s.push(t.distinguishedName))}.bind(this)),s.length>0&&o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:s},function(t){var s=[];t.data.each((function(t){t.fromIdentity!==t.toIdentity&&s.push(t)})),s.length>0&&(e=!0)}.bind(this),null,!1)}return e},openSelectEmpowerDlg_embedded:function(t,e,s,i){var o=new Element("div",{styles:this.css.empowerAreaNode});o.set("html",'<div style="margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>');var n=o.getLast();if(this.getEmpowerItems(n,t),o.inject(i||this.form.app.content),this.selectAllNode){var r=this.createSelectAllEmpowerNode();r.inject(this.selectAllNode),this.checkedAllItems&&(r.store("isSelected",!0),r.setStyles(this.css.empowerSelectAllItemNode_selected))}},getSelectedData:function(t){var e={};this.empowerSelectNodes.each(function(t){if(t.retrieve("isSelected")){var s=t.retrieve("data");e[s.fromIdentity]=s}}.bind(this)),t&&t(e)}}),MWF.xApplication.process.Work.Processor.UnitOptions=new Class({Extends:MWF.APPOrg.UnitOptions}),MWF.xApplication.process.Work.Processor.IdentityOptions=new Class({Extends:MWF.APPOrg.IdentityOptions}));