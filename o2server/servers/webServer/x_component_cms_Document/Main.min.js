MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Document=MWF.xApplication.cms.Document||{},MWF.xApplication.cms.Document.options=MWF.xApplication.cms.Document.options||Object.clone(o2.xApplication.Common.options),MWF.xApplication.cms.Document.options.multitask=!0,MWF.xApplication.cms.Document.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Document",icon:"icon.png",width:"1200",height:"680",title:"",documentId:"",isControl:!1,readonly:!0,autoSave:!0,saveOnClose:!0,postPublish:null,postDelete:null,forceFormId:null,printFormId:null,readFormId:null,editFormId:null},onQueryLoad:function(){this.options.title||this.setOptions({title:MWF.xApplication.cms.Document.LP.title}),this.lp=MWF.xApplication.cms.Document.LP,this.status&&(this.options.documentId=this.status.documentId,this.options.readonly="true"===this.status.readonly||!0===this.status.readonly,this.options.autoSave="true"===this.status.autoSave||!0===this.status.autoSave,this.options.saveOnClose="true"===this.status.saveOnClose||!0===this.status.saveOnClose,this.options.formId=this.status.formId,this.options.formEditId=this.status.formEditId,this.options.printFormId=this.status.printFormId,this.options.forceFormId=this.status.forceFormId,this.options.readFormId=this.status.readFormId,this.options.editFormId=this.status.editFormId),this.options.formId&&!this.options.readFormId&&(this.options.readFormId=this.options.formId),this.options.formEditId&&!this.options.editFormId&&(this.options.editFormId=this.options.formEditId),"false"===this.options.readonly&&(this.options.readonly=!1),"true"===this.options.readonly&&(this.options.readonly=!0),this.options.documentId&&""!=this.options.documentId&&(this.options.appId="cms.Document"+this.options.documentId)},loadApplication:function(t){this.node=new Element("div",{styles:this.css.content}).inject(this.content),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop"}),this.formNode=new Element("div",{styles:{"min-height":"100%"}}).inject(this.node),this.action=MWF.Actions.get("x_cms_assemble_control"),this.options.isRefresh?(this.mask.loadNode(this.content),this.loadDocumentV2()):this.maxSize(function(){this.mask.loadNode(this.content),this.loadDocumentV2()}.bind(this)),t&&t()}.bind(this)),this.addEvent("queryClose",function(){this.refreshTaskCenter()}.bind(this)),this.addKeyboardEvents()},refreshTaskCenter:function(){this.desktop.apps&&this.desktop.apps["cms.Explorer"]&&(this.desktop.apps["cms.Explorer"].content&&this.desktop.apps["cms.Explorer"].content.unmask(),this.desktop.apps["cms.Explorer"]&&this.desktop.apps["cms.Explorer"].refreshAll())},addKeyboardEvents:function(){this.addEvent("keySave",function(t){this.keySave(t)}.bind(this))},keySave:function(t){this.appForm&&(this.readonly||(this.appForm.saveDocument(),t.preventDefault()))},reload:function(){this.formNode.empty(),this.appForm&&(MWF.release(this.appForm),this.appForm=null,this.form=null),this.loadDocumentV2()},loadDocumentV2:function(t){this.loadFormFlag=!1,this.loadDocumentFlag=!1,this.loadModuleFlag=!1,this.json_document=null,this.json_form=null;var o=!1!==this.options.readonly||this.options.anonymousAccess,s="";this.options.forceFormId?s=this.options.forceFormId:this.options.printFormId?s=this.options.printFormId:o&&this.options.readFormId&&(s=this.options.readFormId),s?(this.getFormV2(s),this.getDocumentV2()):(o&&this.lookupFormV2(!0),this.getDocumentV2());MWF.xDesktop.requireApp("cms.Xform","$all",function(){this.loadModuleFlag=!0,this.checkLoad()}.bind(this))},checkLoad:function(t){t&&(this.json_document?this.getFormV2(this.formId):this.needLoadForm=!0),this.needLoadForm&&!this.loadFormFlag&&this.json_document&&(this.needLoadForm=!1,this.getFormV2(this.formId)),this.loadFormFlag&&this.loadDocumentFlag&&this.loadModuleFlag&&(this.parseFormV2(this.json_form.data),layout.session&&layout.session.user?(this.openDocument(),this.mask&&this.mask.hide()):layout.sessionPromise&&layout.sessionPromise.then(function(){this.openDocument(),this.mask&&this.mask.hide()}.bind(this),(function(){})))},getDocumentV2:function(){var t,o=this.options.documentId||this.options.id,s=!1!==this.options.readonly;t=this.options.anonymousAccess?"getDocumentByAnonymous":s&&!this.options.printFormId?"viewDocument":"getDocument";var i=this.options.anonymousAccess?"listAttachmentByAnonymous":"listAttachment";o2.Actions.invokeAsync([{action:this.action,name:t},{action:this.action,name:i}],{success:function(t,o){if(t){o&&"array"===typeOf(o.data)?t.data.attachmentList=o.data:t.data.attachmentList=[],this.json_document=t,this.loadDocumentFlag=!0,this.parseDocumentV2(this.json_document.data);var s=!(!1!==this.options.readonly||this.options.anonymousAccess);this.checkLoad(s)}else this.errorLoadingV2()}.bind(this),failure:function(t){this.errorLoadingV2(t)}.bind(this)},o,o)},getFormV2:function(t,o,s){var i;i=this.options.anonymousAccess?layout.mobile?"getFormMobileAnonymousV2":"getFormAnonymousV2":layout.mobile?"getFormMobileV2":"getFormV2",this.action[i](t,o||"",function(t){this.json_form=t,this.loadFormFlag=!0,this.checkLoad()}.bind(this),function(t){!s&&this.document&&this.document.categoryId?this.action.getCategory(this.document.categoryId,function(t){var o=t.data;!0===this.readonly&&o.readFormId&&""!=o.readFormId?this.formId=o.readFormId:this.formId=o.formId||o.readFormId,this.getFormV2(this.formId,null,!0)}.bind(this)):this.errorLoadingV2(t,"form")}.bind(this))},lookupFormV2:function(t){var o,s=this.options.documentId||this.options.id;o=this.options.anonymousAccess?layout.mobile?"lookupFormWithDocMobileAnonymousV2":"lookupFormWithDocAnonymousV2":layout.mobile?"lookupFormWithDocMobileV2":"lookupFormWithDocV2",this.action[o](s,function(o){var s;if(s=t?o.data.readFormId||o.data.formId:o.data.formId||o.data.readFormId,o.data.form)this.json_form=o,this.loadFormFlag=!0,this.checkLoad();else{var i=o.data.cacheTag||"";this.getFormV2(s,i)}}.bind(this),function(){this.checkLoad(!0)}.bind(this))},parseFormV2:function(t){if(t.form)this.formDataText=t.form.data?MWF.decodeJsonString(t.form.data):"",this.form=this.formDataText?JSON.decode(this.formDataText):null,this.relatedFormMap=t.relatedFormMap,this.relatedScriptMap=t.relatedScriptMap,t.form.data&&delete t.form.data,this.formInfor=t.form;else{if(layout.mobile){var o=t.data.mobileData||t.data.data;this.formDataText=o?MWF.decodeJsonString(o):"",this.form=this.formDataText?JSON.decode(this.formDataText):null}else this.formDataText=t.data.data?MWF.decodeJsonString(t.data.data):"",this.form=this.formDataText?JSON.decode(this.formDataText):null;t.data.data&&delete t.data.data,t.data.mobileData&&delete t.data.mobileData,this.formInfor=t.form}},parseDocumentV2:function(t){var o;o=t.document.title,this.setTitle(o),t.document.subject=t.document.title,this.data=t.data,this.attachmentList=t.attachmentList||[],this.attachmentList.each((function(t){t.lastUpdateTime=t.updateTime,t.person=t.creatorUid})),this.data.isNew=!!this.isEmptyObject(this.data),this.document=t.document;var s;(MWF.AC.isCMSManager()||t.isAppAdmin||t.isCategoryAdmin||t.isManager)&&(this.options.isControl=!0,this.isAdmin=!0),(t.isCreator||this.desktop.session.user.distinguishedName==this.document.creatorPerson)&&(this.options.isControl=!0),t.isEditor&&(this.options.isControl=!0),this.options.readonly?this.readonly=!0:this.options.isControl&&"archived"!=this.document.docStatus?this.readonly=!1:this.readonly=!0,s=!0===this.readonly?this.options.forceFormId||this.options.printFormId||this.options.readFormId||this.document.readFormId||this.options.editFormId||this.document.form:this.options.forceFormId||this.options.printFormId||this.options.editFormId||this.document.form||this.options.readFormId||this.document.readFormId,this.formId=s,(this.readonly||"published"==this.document.docStatus)&&(this.options.autoSave=!1,this.options.saveOnClose=!1);var i=this.options.isControl;this.control=t.control||{allowRead:!0,allowPublishDocument:i&&"draft"==this.document.docStatus,allowSave:i&&"published"==this.document.docStatus,allowPopularDocument:MWF.AC.isHotPictureManager()&&"published"==this.document.docStatus,allowEditDocument:i&&!this.document.wf_workId,allowDeleteDocument:i&&!this.document.wf_workId}},errorLoadingV2:function(t,o){var s;s="form"===o?this.lp.formGettedError:this.lp.documentGettedError,t&&(s=s+":"+t.responseText),this.notice(s,"error"),layout.sessionPromise.then(function(){this.mask&&this.mask.hide(),this.close()}.bind(this),(function(){}))},isEmptyObject:function(t){var o;for(o in t)return!1;return!0},setPopularDocument:function(){MWF.xDesktop.requireApp("cms.Document","HotLinkForm",null,!1),new MWF.xApplication.cms.Document.HotLinkForm(this,this.document,{documentId:this.options.documentId,summary:this.data.explain||"",onPostOk:function(t){}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.action}).create()},openDocument:function(){this.form&&MWF.xDesktop.requireApp("cms.Xform","$all",function(){this.appForm=new MWF.CMSForm(this.formNode,this.form,{readonly:this.readonly,autoSave:this.options.autoSave,saveOnClose:this.options.saveOnClose,onPostPublish:this.options.postPublish,onAfterPublish:this.options.afterPublish,onPostDelete:this.options.postDelete}),this.appForm.businessData={data:this.data,document:this.document,control:this.control,attachmentList:this.attachmentList,formInfor:this.formInfor,status:{readonly:this.readonly}},this.appForm.formDataText=this.formDataText,this.appForm.documentAction=this.action,this.appForm.app=this,this.appForm.load()}.bind(this))},recordStatus:function(){var t={documentId:this.options.documentId,readonly:this.options.readonly,autoSave:this.options.autoSave,saveOnClose:this.options.saveOnClose};return this.options.readFormId&&(t.readFormId=this.options.readFormId),this.options.editFormId&&(t.editFormId=this.options.editFormId),this.options.printFormId&&(t.printFormId=this.options.printFormId),this.options.forceFormId&&(t.forceFormId=this.options.forceFormId),this.options.appId&&""!=this.options.appId&&(t.appId=this.options.appId),t},onPostClose:function(){this.appForm&&(this.appForm.modules.each((function(t){MWF.release(t)})),MWF.release(this.appForm))}});