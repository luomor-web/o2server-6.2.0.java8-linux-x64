MWF.xApplication.Homepage.CalendarContent=new Class({Extends:MWF.xApplication.Homepage.TaskContent,Implements:[Options,Events],options:{view:"calendarContent.html"},load:function(){this.tabs={},this.dayFlags=[],this.container.loadHtml(this.viewPath,{bind:{lp:this.app.lp},module:this},function(){this.initSize(),this.loadCalender(function(){this.fireEvent("load")}.bind(this))}.bind(this))},openCalender:function(e){layout.openApplication(e,"Calendar")},setContentSize:function(){var e=this.container.getSize().y,t=this.calenderArea.getSize().y+this.calenderArea.getEdgeHeight(),n=this.calenderTitleNode.getSize().y+this.calenderTitleNode.getEdgeHeight(),a=this.pageAreaNode.getSize().y+this.pageAreaNode.getEdgeHeight(),i=this.calenderInforArea.getSize().y+this.calenderInforArea.getEdgeHeight(),o=e-n-a-this.itemContentNode.getEdgeHeight()-i-t;if(this.itemContentNode.setStyle("height",o+"px"),this.contentHeight=o,this.noItemNode){var d=(this.contentHeight-this.noItemNode.getSize().y)/2;this.noItemNode.setStyle("margin-top",d+"px")}this.dayFlags&&this.dayFlags.length&&this.dayFlags.each((function(e){var t=e.retrieve("td");t&&e.position({relativeTo:t,position:"topRight",edge:"topRight"})}))},loadCalender:function(e){o2.require("o2.widget.CalendarPage",function(){this.calender=new o2.widget.CalendarPage(this.calenderArea,{style:"homepage",onQueryComplate:function(t){this.loadMyCalender(t,e)}.bind(this),onChangeViewToDay:function(){this.loadMonthCalender()}.bind(this),onChangeViewToMonth:function(){this.calenderFlagArea.empty(),this.dayFlags=[]}.bind(this),onChangeViewToYear:function(){this.calenderFlagArea.empty(),this.dayFlags=[]}.bind(this)}),this.calender.show(),this.calender._selectDate((new Date).toString());var t=this.calender.currentNode.getStyle("margin-right").toInt();t+=40,this.calender.currentNode.setStyle("margin-right",t+"px"),this.calender.todayNode=new Element("div.mainColor_color",{styles:this.calender.css.todayNode,text:this.app.lp.today}).inject(this.calender.currentNode,"before"),this.calender.todayNode.addEvent("click",function(){this.calender.changeViewToDay(),this.calender._selectDate((new Date).toString())}.bind(this))}.bind(this))},loadMonthCalender:function(){this.calenderFlagArea.empty(),this.dayFlags=[];var e=this.calender.contentTable.getElements("td"),t=new Date(e[0].retrieve("dateValue")).clearTime(),n=new Date(e[e.length-1].retrieve("dateValue")).clearTime();n.increment("day",1);var a={startTime:t.format("db"),endTime:n.format("db"),createPerson:layout.user.distinguishedName};o2.Actions.load("x_calendar_assemble_control").Calendar_EventAction.listWithFilter(a,function(a){a.data&&(a.data.wholeDayEvents&&a.data.wholeDayEvents.length&&a.data.wholeDayEvents.each(function(a){var i=(new Date).parse(a.startTime),o=(new Date).parse(a.endTime);if(t>i&&(i=t.clone()),!(o<t))for(;i<o&&i<=n;){var d=t.diff(i);this.setCalenderFlag(e[d]),i.increment("day",1)}}.bind(this)),a.data.inOneDayEvents&&a.data.inOneDayEvents.length&&a.data.inOneDayEvents.each(function(n){if(n.inOneDayEvents&&n.inOneDayEvents.length){var a=(new Date).parse(n.eventDate),i=t.diff(a);this.setCalenderFlag(e[i])}}.bind(this)))}.bind(this))},setCalenderFlag:function(e){var t=new Element("div.o2_homepage_calender_item_flag").inject(this.calenderFlagArea);t.position({relativeTo:e,position:"topRight",edge:"topRight"}),t.store("td",e),this.dayFlags.push(t)},loadMyCalender:function(e,t){this.isLoading||(this.calenderContentTab?this.calenderContentTab.reload(e):this.calenderContentTab=new MWF.xApplication.Homepage.CalendarContent.Calendar(this,this.calenderTab,e,{onLoad:function(){t&&t()}}),this.currentTab=this.calenderContentTab)}}),MWF.xApplication.Homepage.CalendarContent.Calendar=new Class({Extends:MWF.xApplication.Homepage.TaskContent.Task,Implements:[Options,Events],options:{itemHeight:80,type:"meetingInvited",month:1},initialize:function(e,t,n,a){this.setOptions(a),this.content=e,this.app=this.content.app,this.container=this.content.itemContentNode,this.tab=t,this.date=(new Date).parse(n).clearTime(),this.load()},reload:function(e){this.content.isLoading||(this.date=(new Date).parse(e).clearTime(),this.beginLoadContent(),this.showTab(),this.initItemCount(this.page),this.loadItemsRes())},loadItemsRes:function(){var e=this.date.clone().increment("day",1),t={startTime:this.date.format("db"),endTime:e.format("db"),createPerson:layout.user.distinguishedName};o2.Actions.load("x_calendar_assemble_control").Calendar_EventAction.listWithFilterSample(t,function(e){e.data&&e.data.length?(this.loadItems(e.data),this.loadCalenderInfor(e.data.length)):(this.emptyLoadContent(),this.loadCalenderInfor(0)),this.fireEvent("load")}.bind(this))},loadCalenderInfor:function(e){var t=e?this.app.lp.calenderInfor:this.app.lp.noCalenderInfor;t=t.replace("{name}",layout.user.name);var n=new Date,a=0===this.date.diff(n)?this.app.lp.today:this.date.format(this.app.lp.dateFormat);t=(t=t.replace("{date}",a)).replace("{count}",e),this.content.calenderInforArea.empty(),this.content.calenderInforArea.set("html",t)},emptyLoadContent:function(){this.container.empty(),this.container.removeClass("o2_homepage_area_content_loading").removeClass("icon_loading"),this.content.pageAreaNode.empty(),this.content.noItemNode=new Element("div.o2_homepage_calendar_area_content_empty_node",{text:this.app.lp.noCalendar}).inject(this.container);var e=(this.content.contentHeight-this.content.noItemNode.getSize().y)/2;this.content.noItemNode.setStyle("margin-top",e+"px"),this.content.isLoading=!1},loadItems:function(e){e.each(function(e,t){this.loadItem(e,t)}.bind(this)),this.endLoadContent()},loadItem:function(e,t){var n=this.loadItemRow(e,t);n.store("data",e),n.addEvent("click",(function(e){layout.openApplication(e,"Calendar")}))},getLightColor:function(e){var t=["#cae2ff","#d0f1b0","#fef4bb","#fdd9d9","#f4c5f7","#d6ccf9","#e7e7e7","#cae2ff"],n=["#428ffc","#5bcc61","#f9bf24","#f75f59","#f180f7","#9072f1","#909090","#1462be"].indexOf(e);return n>-1?t[n]:t[0]},loadItemRow:function(e){var t=new Element("div.o2_homepage_calender_item_node").inject(this.container);t.setStyle("background-color",this.getLightColor(e.color));new Element("div.o2_homepage_calender_item_location",{text:e.locationName||"",title:e.locationName||""}).inject(t);var n=new Element("div.o2_homepage_calender_item_infor").inject(t),a=new Element("div.o2_homepage_calender_item_title").inject(n),i=(new Element("div.o2_homepage_calender_item_title_icon").inject(a),new Element("div.o2_homepage_calender_item_title_text",{text:e.title,title:e.title}).inject(a),new Element("div.o2_homepage_calender_item_time").inject(n)),o="";if(e.isAllDayEvent)o=this.app.lp.allDay;else{var d=(new Date).parse(e.startTime),s=(new Date).parse(e.endTime);o=0===d.diff(s)?d.format("%Y-%m-%d %H:%M")+" - "+s.format("%H:%M"):d.format("%Y-%m-%d %H:%M")+" - "+s.format("%Y-%m-%d %H:%M")}return i.set("html",o),t}});