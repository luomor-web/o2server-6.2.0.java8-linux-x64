MWF.xApplication.AppMarketV2.Application.options.multitask=!0,MWF.require("MWF.widget.MaskNode",null,!1),MWF.xApplication.AppMarketV2.Application.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",mvcStyle:"style.css",view:"applicationView.html",name:"AppMarketV2.Application",icon:"icon.png",width:"1000",height:"700",isResize:!0,isMax:!0,title:MWF.xApplication.AppMarketV2.Application.LP.title,minHeight:700},onQueryLoad:function(){this.lp=MWF.xApplication.AppMarketV2.Application.LP,this.actions=MWF.Actions.load("x_program_center"),this.viewPath=this.path+this.options.style+"/"+this.options.view,this.iconPath=this.path+this.options.style+"/icon/",this.collectToken="",this.collectUrl="",this.status&&(this.options.appid=this.status.appid,this.options.appname=this.status.appname),this.appdata={}},mask:function(){this.maskNode||(this.introducenode.setStyle("overflow","hidden"),this.maskNode=new MWF.widget.MaskNode(this.introducenode,{style:"bam"}),this.maskNode.load())},unmask:function(){this.maskNode&&this.maskNode.hide(function(){MWF.release(this.maskNode),this.maskNode=null,this.introducenode.setStyle("overflow","auto")}.bind(this))},loadApplication:function(t){""!=this.collectToken&&""!=this.collectUrl||this.actions.CollectAction.login(function(i){i.type&&"success"==i.type&&(data=i.data,this.collectUrl=data.collectUrl,this.collectToken=data.collectToken,this.content.loadHtml(this.viewPath,{bind:{lp:this.lp},module:this},function(){this.options.isRefresh?this.loadIntroduce(t):this.maxSize(function(){this.loadIntroduce(t)}.bind(this))}.bind(this)))}.bind(this),null,!1)},initNodeSize:function(){this.resizeNodeSize(),this.addEvent("resize",this.resizeNodeSize.bind(this))},resizeNodeSize:function(){var t=this.content.getSize(),i=this.introducenode.getEdgeHeight(),a=t.y-i;a<this.options.minHeight&&(a=this.options.minHeight),this.introducenode.setStyle("height",a+"px")},loadIntroduce:function(t){this.initNodeSize(),this.options.appid&&(this.loadBbsInfo(this),this.actions.MarketAction.get(this.options.appid,function(t){if(t.data&&t.data.icon){this.appdata=t.data,this.setTitle(MWF.xApplication.AppMarketV2.Application.LP.title+"_"+this.appdata.name);var i=new Element("div",{class:"o2_appmarket_application_introduce_icon"}).inject(this.applicationintroduceiconcontain);i.setStyle("background-image","url(data:image/png;base64,"+this.appdata.icon+")"),this.applicationintroduceiconcontain.clientWidth<300&&(i.setStyle("width",this.applicationintroduceiconcontain.clientWidth),i.setStyle("height",450*this.applicationintroduceiconcontain.clientWidth/300)),this.loadCommentsGrade(this.appdata);var a=this.appdata.price>0?this.appdata.price+"":"Free";this.applicationintroducememofree.set("text",a),this.applicationintroducememoname.set("text",this.appdata.name);var e=0,n=0,o=0,s=this.gradeData.data,c=["0","0","0","0","0"];s.each(function(t){c[parseInt(t.grade)-1]=t.count,e+=parseInt(t.count)}.bind(this)),c.each((function(t,i){o+=parseInt(t)*(i+1)})),e>0&&(n=this.numberFix(o/e,1)),this.applicationintroducememoremarkgrade.set("text",n+"");for(var p=parseInt(n),l=n-p,r=0;r<p;r++)new Element("img",{src:this.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.applicationintroducememoremarkiconangular);l>=.5&&(new Element("img",{src:this.iconPath+"halffiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.applicationintroducememoremarkiconangular),p++);for(r=0;r<5-p;r++)new Element("img",{src:this.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.applicationintroducememoremarkiconangular);this.appdata.commentCount||(this.appdata.commentCount=0),this.applicationintroducememoremarkcommentcount.set("text",this.lp.commentCountText.replace("{n}",e)),this.applicationintroducememocategory.set("text",this.lp.category+":"+this.appdata.category),this.applicationintroducememocontent.set("text",this.appdata.describe),this.applicationintroducedownloadprice.set("text","");var d=this.lp.setup;this.appdata.installedVersion&&""!=this.appdata.installedVersion&&(d=this.appdata.installedVersion==this.appdata.version?this.lp.setupDone:this.lp.update),this.applicationintroducedownloadbtntext.set("text",d);var h=this;this.applicationintroducedownloadbtn.store("data",this.appdata),this.applicationintroducedownloadbtn.addEvents({click:function(t){var i=this.retrieve("data");i&&h.installapp(t,i)}}),this.applicationintroduceforumbtntext.set("text",this.lp.bbsname),this.applicationintroduceforumbtn.addEvents({click:function(t){window.open(h.lp.bbslink)}}),this.loadIntroduceInfo()}this.fireEvent("load")}.bind(this))),t&&t()},loadBbsInfo:function(t){var i=null,a=t.collectUrl+"/o2_collect_assemble/jaxrs/collect/config/key/(0)?time="+(new Date).getMilliseconds();new Request.JSON({url:a,headers:{"x-debugger":!0,Authorization:t.collectToken,"c-token":t.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,a){i=t,this.bbsUrlPath=i.data.bbsUrlPath,this.bbsUrl=i.data.bbsUrl}.bind(this),onFailure:function(t){o2.runCallback(callback,"requestFailure",[t])}.bind(this),onError:function(t,i){o2.runCallback(callback,"error",[t,i])}.bind(this)}).send()},loadCommentsGrade:function(t){var i=this.bbsUrlPath+"/x_bbs_assemble_control/jaxrs/subject/statgrade/sectionName/"+encodeURI(this.lp.title)+"/subjectType/"+encodeURI(t.name)+"?time="+(new Date).getMilliseconds();new Request.JSON({url:i,headers:{"x-debugger":!0,Authorization:this.collectToken,"c-token":this.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,i){this.gradeData=t}.bind(this)}).send()},tabover:function(t){t.currentTarget.addClass("o2_appmarket_appcategory_tab_over")},tabout:function(t){t.currentTarget.removeClass("o2_appmarket_appcategory_tab_over")},mouseover:function(){this.addClass("o2_appmarket_appcategory_tab_over")},mouseout:function(){this.removeClass("o2_appmarket_appcategory_tab_over")},installapp:function(t,i){var a=t.target.getPosition(),e={event:{x:a.x+40,y:a.y}},n=""==i.installedVersion?this.lp.confirmsetupTitle:this.lp.confirmupdateTitle,o=""==i.installedVersion?this.lp.confirmsetupContent:this.lp.confirmupdateContent,s=this;s.confirm("warn",e,n,o,300,120,(function(){s.mask(),s.actions.MarketAction.installOrUpdate(i.id,function(t){data=t.data,s.notice(i.name+" "+s.lp.setupSuccess,"success"),s.unmask()}.bind(s),function(t){data=t.data,s.unmask()}.bind(s),!0),this.close()}),(function(){this.close()}),null,null,"o2")},loadIntroduceInfo:function(t){this.applicationintroducesinfoTab.getParent().getElements(".o2_appmarket_application_introduce_tab_current").removeClass("mainColor_color").removeClass("o2_appmarket_application_introduce_tab_current").addClass("o2_appmarket_application_introduce_tab"),this.applicationintroducesinfoTab.removeClass("o2_appmarket_application_introduce_tab").addClass("mainColor_color").addClass("o2_appmarket_application_introduce_tab_current"),this.applicationintroducecontent.set("html",""),this.applicationintroducecontent.set("html",this.appdata.abort),this.applicationintroducepicslable.set("html",""),this.applicationintroducepics.set("html",""),this.applicationintroducepicslable.set("html",this.lp.screenshot),this.appdata.attList.each(function(t,i){"image"==t.type&&(picdiv=new Element("img",{class:"o2_appmarket_application_introduce_pic"}).inject(this.applicationintroducepics),picdiv.setProperty("src","data:image/png;base64,"+t.icon),picdiv.setProperty("data-original",this.collectUrl+"/o2_collect_assemble/jaxrs/attachment/download/"+t.id+"?c-token="+this.collectToken),picdiv.setProperty("alt",t.name))}.bind(this)),this.loadImgView(this.appdata.id)},loadImgView:function(t){this.viewer&&this.viewer.destroy(),this.applicationintroducepics.setProperty("id",t),o2.loadCss(this.path+this.options.style+"/viewer.css",this.content,function(){o2.load(this.path+this.options.style+"/viewer.js",function(){this.viewer=new Viewer(document.getElementById(t),{url:"data-original"})}.bind(this))}.bind(this))},loadIntroduceDemand:function(t){this.applicationintroducedemandTab.getParent().getElements(".o2_appmarket_application_introduce_tab_current").removeClass("mainColor_color").removeClass("o2_appmarket_application_introduce_tab_current").addClass("o2_appmarket_application_introduce_tab"),this.applicationintroducedemandTab.removeClass("o2_appmarket_application_introduce_tab").addClass("mainColor_color").addClass("o2_appmarket_application_introduce_tab_current"),this.applicationintroducecontent.set("html",""),this.applicationintroducepicslable.set("html",""),this.applicationintroducepics.set("html",""),this.applicationintroducecontent.set("html",this.appdata.installSteps)},loadIntroduceComment:function(t){this.applicationintroducecommentTab.getParent().getElements(".o2_appmarket_application_introduce_tab_current").removeClass("mainColor_color").removeClass("o2_appmarket_application_introduce_tab_current").addClass("o2_appmarket_application_introduce_tab"),this.applicationintroducecommentTab.removeClass("o2_appmarket_application_introduce_tab").addClass("mainColor_color").addClass("o2_appmarket_application_introduce_tab_current"),this.applicationintroducecontent.set("html",""),this.applicationintroducepicslable.set("html",""),this.applicationintroducepics.set("html",""),o2.requireApp("AppMarketV2.Application","Comment",function(){new MWF.xApplication.AppMarketV2.Application.Comment(this,this.applicationintroducecontent,{onLoad:function(){t&&t()}})}.bind(this))},recordStatus:function(){return{appid:this.options.appid,appname:this.options.appname}},numberFix:function(t,i){for(var a="",e=0;e<i;e++)a+="0";var n=1+a,o=Math.round(parseFloat(t)*n)/n,s=o.toString().split(".");return 1==s.length?o=o.toString():s.length>1?(s[1].length<i&&(o=o.toString()+"0"),o):void 0}});