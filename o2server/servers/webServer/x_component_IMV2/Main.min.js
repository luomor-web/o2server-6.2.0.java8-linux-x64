MWF.require("MWF.widget.UUID",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.IMV2.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"IMV2",mvcStyle:"style.css",icon:"icon.png",width:"1024",height:"768",isResize:!0,isMax:!0,title:MWF.xApplication.IMV2.LP.title,conversationId:""},onQueryLoad:function(){this.lp=MWF.xApplication.IMV2.LP,this.app=this,this.conversationNodeItemList=[],this.conversationId=this.options.conversationId||"",this.messageList=[],this.emojiList=[];for(var e=1;e<88;e++){var t={key:e>9?"["+e+"]":"[0"+e+"]",path:e>9?"/x_component_IMV2/$Main/emotions/im_emotion_"+e+".png":"/x_component_IMV2/$Main/emotions/im_emotion_0"+e+".png"};this.emojiList.push(t)}},onQueryClose:function(){this.closeListening()},loadComponentName:function(){o2.Actions.load("x_component_assemble_control").ComponentAction.get("IMV2",function(e){var t=e.data;t&&t.title&&this.setTitle(t.title)}.bind(this),(function(e){console.log(e)}))},loadApplication:function(e){var t=this.path+this.options.style+"/im.html";this.content.loadHtml(t,{bind:{lp:this.lp,data:{}},module:this},function(){this.app.content=this.o2ImMainNode,this.startListening(),this.conversationNodeItemList=[],o2.Actions.load("x_message_assemble_communicate").ImAction.myConversationList(function(e){e.data&&e.data instanceof Array&&this.loadConversationList(e.data)}.bind(this))}.bind(this)),this.loadComponentName()},startListening:function(){layout.desktop&&layout.desktop.message&&(this.messageNumber=layout.desktop.message.items.length,this.listener&&clearInterval(this.listener),this.listener=setInterval(function(){var e=layout.desktop.message.items.length;e>this.messageNumber&&(this.reciveNewMessage(),this.messageNumber=e)}.bind(this),1e3))},closeListening:function(){this.listener&&clearInterval(this.listener)},reciveNewMessage:function(){this._checkConversationMessage(),this._checkNewMessage()},loadConversationList:function(e){for(var t=0;t<e.length;t++){var i=e[t],n=this._createConvItemNode(i);this.conversationNodeItemList.push(n),this.conversationId&&this.conversationId==i.id&&this.tapConv(i)}},loadMsgListByConvId:function(e,t,i){var n={conversationId:i};o2.Actions.load("x_message_assemble_communicate").ImAction.msgListByPaging(e,t,n,function(e){for(var t=e.data,i=0;i<t.length;i++)this.messageList.push(t[i]),this._buildMsgNode(t[i],!0)}.bind(this),function(e){console.log(e)}.bind(this),!1)},tapConv:function(e){this._setCheckNode(e);var t=this.path+this.options.style+"/chat.html",i={convName:e.title,lp:this.lp};this.conversationId=e.id,this.chatNode.empty(),this.chatNode.loadHtml(t,{bind:i,module:this},function(){var t=layout.session.user.distinguishedName;"group"===e.type&&t===e.adminPerson?(this.chatTitleMoreBtnNode.setStyle("display","block"),this.chatTitleMoreBtnNode.addEvents({click:function(e){"none"===this.chatTitleMoreMenuNode.getStyle("display")?this.chatTitleMoreMenuNode.setStyle("display","block"):this.chatTitleMoreMenuNode.setStyle("display","none")}.bind(this)})):this.chatTitleMoreBtnNode.setStyle("display","none"),this.messageList=[],this.loadMsgListByConvId(1,20,e.id),new Fx.Scroll(this.chatContentNode).toBottom()}.bind(this))},tapUpdateConvTitle:function(){this.chatTitleMoreMenuNode.setStyle("display","none");for(var e="",t=0;t<this.conversationNodeItemList.length;t++){var i=this.conversationNodeItemList[t];this.conversationId==i.data.id&&(e=i.data.title)}new MWF.xApplication.IMV2.UpdateConvTitleForm(this,{},{defaultValue:e},{app:this.app}).create()},tapUpdateConvMembers:function(){this.chatTitleMoreMenuNode.setStyle("display","none");for(var e=[],t=0;t<this.conversationNodeItemList.length;t++){var i=this.conversationNodeItemList[t];this.conversationId==i.data.id&&(e=i.data.personList)}new MWF.xApplication.IMV2.CreateConversationForm(this,{},{title:this.lp.modifyMember,personCount:0,personSelected:e,isUpdateMember:!0},{app:this.app}).create()},sendMsg:function(){var e=this.chatBottomAreaTextareaNode.value;e?(this.chatBottomAreaTextareaNode.value="",this._newAndSendTextMsg(e,"text")):console.log(this.lp.noMessage)},showEmojiBox:function(){if(!this.emojiBoxNode){this.emojiBoxNode=new Element("div",{class:"chat-emoji-box"}).inject(this.chatNode);for(var e=this,t=0;t<this.emojiList.length;t++){var i=this.emojiList[t];new Element("img",{src:i.path,class:"chat-emoji-img"}).inject(this.emojiBoxNode).addEvents({mousedown:function(t){e.sendEmojiMsg(this.emoji),e.hideEmojiBox()}.bind({emoji:i})})}}this.emojiBoxNode.setStyle("display","block"),this.hideFun=this.hideEmojiBox.bind(this),document.body.addEvent("mousedown",this.hideFun)},showChooseFile:function(){this.uploadFileAreaNode||this.createUploadFileNode(),this.fileUploadNode.click()},createUploadFileNode:function(){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file" multiple/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var e=this.fileUploadNode.files;if(e.length){var t=e.item(0),i=new FormData;i.append("file",t),i.append("fileName",t.name);var n=t.name.substring(t.name.lastIndexOf(".")),s="file";s=".bmp"==n.toLowerCase()||".jpeg"==n.toLowerCase()||".png"==n.toLowerCase()||".jpg"==n.toLowerCase()?"image":"file",o2.Actions.load("x_message_assemble_communicate").ImAction.uploadFile(this.conversationId,s,i,"{}",function(e){if(e.data){var t=e.data.id,i=e.data.fileExtension,n=e.data.fileName;this._newImageOrFileMsgAndSend(s,t,n,i)}}.bind(this),function(e){console.log(e)}.bind(this))}}.bind(this))},hideEmojiBox:function(){this.emojiBoxNode.setStyle("display","none"),document.body.removeEvent("mousedown",this.hideFun)},sendEmojiMsg:function(e){this._newAndSendTextMsg(e.key,"emoji")},tapCreateSingleConv:function(){new MWF.xApplication.IMV2.CreateConversationForm(this,{},{title:this.lp.createSingle,personCount:1},{app:this.app}).create()},tapCreateGroupConv:function(){new MWF.xApplication.IMV2.CreateConversationForm(this,{},{title:this.lp.createDroup,personCount:0,personSelected:[]},{app:this.app}).create()},updateConversationTitle:function(e,t){var i={id:t,title:e},n=this;o2.Actions.load("x_message_assemble_communicate").ImAction.update(i,function(e){e.data;n.reciveNewMessage()}.bind(this),function(e){console.log(e)}.bind(this))},updateConversationMembers:function(e,t){var i={id:t,personList:e},n=this;o2.Actions.load("x_message_assemble_communicate").ImAction.update(i,function(e){e.data;n.reciveNewMessage()}.bind(this),function(e){console.log(e)}.bind(this))},newConversation:function(e,t){var i={type:t,personList:e},n=this;o2.Actions.load("x_message_assemble_communicate").ImAction.create(i,function(e){for(var t=e.data,i=!1,s=0;s<n.conversationNodeItemList.length;s++){var o=n.conversationNodeItemList[s];t.id==o.data.id&&(i=!0,n.tapConv(o))}if(!i){var a=n._createConvItemNode(t);n.conversationNodeItemList.push(a),n.tapConv(t)}}.bind(this),function(e){console.log(e)}.bind(this))},_createConvItemNode:function(e){return new MWF.xApplication.IMV2.ConversationItem(e,this)},_setCheckNode:function(e){for(var t=0;t<this.conversationNodeItemList.length;t++){var i=this.conversationNodeItemList[t];i.data.id==e.id?i.addCheckClass():i.removeCheckClass()}},_newImageOrFileMsgAndSend:function(e,t,i,n){var s=layout.session.user.distinguishedName,o=this._currentTime(),a={body:this.lp.file,type:e,fileId:t,fileExtension:n,fileName:i},l=JSON.stringify(a),c={id:(new MWF.widget.UUID).toString(),conversationId:this.conversationId,body:l,createPerson:s,createTime:o,sendStatus:1};o2.Actions.load("x_message_assemble_communicate").ImAction.msgCreate(c,function(e){console.log(this.lp.sendSuccess)}.bind(this),function(e){console.log(e)}.bind(this)),this.messageList.push(c),this._buildSender(a,s,!1),this._refreshConvMessage(c)},_newAndSendTextMsg:function(e,t){var i=layout.session.user.distinguishedName,n=this._currentTime(),s={body:e,type:t},o=JSON.stringify(s),a={id:(new MWF.widget.UUID).toString(),conversationId:this.conversationId,body:o,createPerson:i,createTime:n,sendStatus:1};o2.Actions.load("x_message_assemble_communicate").ImAction.msgCreate(a,function(e){console.log(this.lp.sendSuccess)}.bind(this),function(e){console.log(e)}.bind(this)),this.messageList.push(a),this._buildSender(s,i,!1),this._refreshConvMessage(a)},_refreshConvMessage:function(e){for(var t=0;t<this.conversationNodeItemList.length;t++){var i=this.conversationNodeItemList[t];i.data.id==this.conversationId&&i.refreshLastMsg(e)}},_checkConversationMessage:function(){o2.Actions.load("x_message_assemble_communicate").ImAction.myConversationList(function(e){if(e.data&&e.data instanceof Array)for(var t=e.data,i=0;i<t.length;i++){for(var n=t[i],s=!0,o=0;o<this.conversationNodeItemList.length;o++){var a=this.conversationNodeItemList[o];a.data.id==n.id&&(s=!1,a.refreshLastMsg(n.lastMessage),a.refreshData(n),this.conversationId===n.id&&this.tapConv(n))}if(s){var l=this._createConvItemNode(n);this.conversationNodeItemList.push(l)}}}.bind(this))},_checkNewMessage:function(){if(this.conversationId&&""!=this.conversationId){var e={conversationId:this.conversationId};o2.Actions.load("x_message_assemble_communicate").ImAction.msgListByPaging(1,10,e,function(e){var t=e.data;if(t&&t.length>0){var i=t[0];if(this.conversationId==i.conversationId)for(var n=0;n<t.length;n++){for(var s=!0,o=t[n],a=0;a<this.messageList.length;a++)this.messageList[a].id==o.id&&(s=!1);s&&(this.messageList.push(o),this._buildMsgNode(o,!1))}}}.bind(this),function(e){console.log(e)}.bind(this),!1)}},_buildMsgNode:function(e,t){var i=e.createPerson,n=e.body,s=JSON.parse(n);i!=layout.session.user.distinguishedName?this._buildReceiver(s,i,t):this._buildSender(s,i,t)},_buildSender:function(e,t,i){var n=new Element("div",{class:"chat-sender"}).inject(this.chatContentNode,i?"top":"bottom"),s=new Element("div").inject(n),o=this._getIcon(t),a=t;-1!=t.indexOf("@")&&(a=a.substring(0,t.indexOf("@")));new Element("img",{src:o}).inject(s),new Element("div",{text:a}).inject(n);var l=new Element("div").inject(n);new Element("div",{class:"chat-left_triangle"}).inject(l);if("emoji"==e.type){for(var c="",d=0;d<this.emojiList.length;d++)e.body==this.emojiList[d].key&&(c=this.emojiList[d].path);new Element("img",{src:c,class:"chat-content-emoji"}).inject(l)}else if("image"==e.type){var r=new Element("div",{class:"img-chat"}).inject(l),h=this._getFileUrlWithWH(e.fileId,144,192);new Element("img",{src:h}).inject(r),r.addEvents({click:function(t){var i=this._getFileDownloadUrl(e.fileId);window.open(i)}.bind(this)})}else if("audio"==e.type){h=this._getFileDownloadUrl(e.fileId);new Element("audio",{src:h,controls:"controls",preload:"preload"}).inject(l)}else if("location"==e.type){var m=new Element("span").inject(l);new Element("img",{src:"../x_component_IMV2/$Main/default/icons/location.png",width:24,height:24}).inject(m);h=this._getBaiduMapUrl(e.latitude,e.longitude,e.address,e.addressDetail);new Element("a",{href:h,target:"_blank",text:e.address}).inject(m)}else if("file"==e.type){m=new Element("span").inject(l);var p=this._getFileIcon(e.fileExtension);new Element("img",{src:"../x_component_IMV2/$Main/file_icons/"+p,width:48,height:48}).inject(m);var g=this._getFileDownloadUrl(e.fileId);new Element("a",{href:g,target:"_blank",text:e.fileName}).inject(m)}else new Element("span",{text:e.body}).inject(l);i||new Fx.Scroll(this.chatContentNode).toBottom()},_buildReceiver:function(e,t,i){var n=new Element("div",{class:"chat-receiver"}).inject(this.chatContentNode,i?"top":"bottom"),s=new Element("div").inject(n),o=this._getIcon(t),a=t;-1!=t.indexOf("@")&&(a=a.substring(0,t.indexOf("@")));new Element("img",{src:o}).inject(s),new Element("div",{text:a}).inject(n);var l=new Element("div").inject(n);new Element("div",{class:"chat-right_triangle"}).inject(l);if("emoji"==e.type){for(var c="",d=0;d<this.emojiList.length;d++)e.body==this.emojiList[d].key&&(c=this.emojiList[d].path);new Element("img",{src:c,class:"chat-content-emoji"}).inject(l)}else if("image"==e.type){var r=new Element("div",{class:"img-chat"}).inject(l),h=this._getFileUrlWithWH(e.fileId,144,192);new Element("img",{src:h}).inject(r),r.addEvents({click:function(t){var i=this._getFileDownloadUrl(e.fileId);window.open(i)}.bind(this)})}else if("audio"==e.type){h=this._getFileDownloadUrl(e.fileId);new Element("audio",{src:h,controls:"controls",preload:"preload"}).inject(l)}else if("location"==e.type){var m=new Element("span").inject(l);new Element("img",{src:"../x_component_IMV2/$Main/default/icons/location.png",width:24,height:24}).inject(m);h=this._getBaiduMapUrl(e.latitude,e.longitude,e.address,e.addressDetail);new Element("a",{href:h,target:"_blank",text:e.address}).inject(m)}else if("file"==e.type){m=new Element("span").inject(l);var p=this._getFileIcon(e.fileExtension);new Element("img",{src:"../x_component_IMV2/$Main/file_icons/"+p,width:48,height:48}).inject(m);var g=this._getFileDownloadUrl(e.fileId);new Element("a",{href:g,target:"_blank",text:e.fileName}).inject(m)}else new Element("span",{text:e.body}).inject(l);i||new Fx.Scroll(this.chatContentNode).toBottom()},_getFileUrlWithWH:function(e,t,i){var n=MWF.Actions.get("x_message_assemble_communicate").action,s=n.getAddress()+n.actions.imgFileDownloadWithWH.uri;return s=(s=(s=s.replace("{id}",encodeURIComponent(e))).replace("{width}",encodeURIComponent(t))).replace("{height}",encodeURIComponent(i))},_getFileDownloadUrl:function(e){var t=MWF.Actions.get("x_message_assemble_communicate").action,i=t.getAddress()+t.actions.imgFileDownload.uri;return i=i.replace("{id}",encodeURIComponent(e))},_getBaiduMapUrl:function(e,t,i,n){return"https://api.map.baidu.com/marker?location="+e+","+t+"&title="+i+"&content="+n+"&output=html&src=net.o2oa.map"},_getIcon:function(e){var t=MWF.Actions.get("x_organization_assemble_control");return(e?t.getPersonIcon(e):"../x_component_IMV2/$Main/default/icons/group.png")+"?"+(new Date).getTime()},_getFileIcon:function(e){return e?"jpg"===e||"jpeg"===e?"icon_file_jpeg.png":"gif"===e?"icon_file_gif.png":"png"===e?"icon_file_png.png":"tiff"===e?"icon_file_tiff.png":"bmp"===e||"webp"===e?"icon_file_img.png":"ogg"===e||"mp3"===e||"wav"===e||"wma"===e?"icon_file_mp3.png":"mp4"===e?"icon_file_mp4.png":"avi"===e?"icon_file_avi.png":"mov"===e||"rm"===e||"mkv"===e?"icon_file_rm.png":"doc"===e||"docx"===e?"icon_file_word.png":"xls"===e||"xlsx"===e?"icon_file_excel.png":"ppt"===e||"pptx"===e?"icon_file_ppt.png":"html"===e?"icon_file_html.png":"pdf"===e?"icon_file_pdf.png":"txt"===e||"json"===e?"icon_file_txt.png":"zip"===e?"icon_file_zip.png":"rar"===e?"icon_file_rar.png":"7z"===e?"icon_file_arch.png":"ai"===e?"icon_file_ai.png":"att"===e?"icon_file_att.png":"au"===e?"icon_file_au.png":"cad"===e?"icon_file_cad.png":"cdr"===e?"icon_file_cdr.png":"eps"===e?"icon_file_eps.png":"exe"===e?"icon_file_exe.png":"iso"===e?"icon_file_iso.png":"link"===e?"icon_file_link.png":"swf"===e?"icon_file_flash.png":"psd"===e?"icon_file_psd.png":"tmp"===e?"icon_file_tmp.png":"icon_file_unkown.png":"icon_file_unkown.png"},_friendlyTime:function(e){var t=e.getDate(),i=e.getMonth(),n=e.getFullYear(),s=e.getTime(),o=new Date,a=o.getDate(),l=o.getMonth(),c=o.getFullYear(),d=o.getTime(),r="";if(t===a&&i===l&&n===c){var h=0;return d>s&&(r=0==(h=parseInt((d-s)/36e5))?Math.max(parseInt((d-s)/6e4),1)+this.lp.minutesBefore:h+this.lp.hoursBefore),r}var m=parseInt(s/864e5),p=parseInt(d/864e5);if(p>m){var g=p-m;r=1==g?this.lp.yesterday:2==g?this.lp.beforeYesterday:g>2&&g<31?g+this.lp.daysBefore:g>=31&&g<=62?this.lp.monthAgo:g>62&&g<=93?this.lp.towMonthAgo:g>93&&g<=124?this.lp.threeMonthAgo:this._formatDate(e)}return r},_formatDate:function(e){var t=e.getMonth()+1,i=e.getDate();return t=1==t.toString().length?"0"+t:t,i=1==i.toString().length?"0"+i:i,e.getFullYear()+"-"+t+"-"+i},_currentTime:function(){var e=new Date,t=e.getFullYear(),i=e.getMonth(),n=e.getDate(),s=e.getHours(),o=e.getMinutes(),a=e.getSeconds();return(i+=1)<10&&(i="0"+i),n<10&&(n="0"+n),s<10&&(s="0"+s),o<10&&(o="0"+o),a<10&&(a="0"+a),t+"-"+i+"-"+n+" "+s+":"+o+":"+a}}),MWF.xApplication.IMV2.ConversationItem=new Class({initialize:function(e,t){this.data=e,this.main=t,this.container=this.main.chatItemListNode,this.load()},load:function(){var e=this.main._getIcon(),t={id:this.data.id,avatarUrl:e,title:this.data.title,time:"",lastMessage:"",lastMessageType:"text"},i=layout.session.user.distinguishedName;if(this.data.type&&"single"===this.data.type){var n="";if(this.data.personList&&this.data.personList instanceof Array)for(var s=0;s<this.data.personList.length;s++){var o=this.data.personList[s];o!==i&&(n=o)}t.avatarUrl=this.main._getIcon(n);var a=n;-1!=n.indexOf("@")&&(a=a.substring(0,n.indexOf("@"))),t.title=a}if(this.data.lastMessage){var l=JSON.parse(this.data.lastMessage.body);if(t.lastMessage=l.body,this.data.lastMessage.createTime){var c=this.main._friendlyTime(o2.common.toDate(this.data.lastMessage.createTime));t.time=c}l.type&&(t.lastMessageType=l.type)}this.node=new Element("div",{class:"item"}).inject(this.container),this.nodeBaseItem=new Element("div",{class:"base"}).inject(this.node);var d=new Element("div",{class:"avatar"}).inject(this.nodeBaseItem);new Element("img",{src:t.avatarUrl,class:"img"}).inject(d);var r=new Element("div",{class:"body"}).inject(this.nodeBaseItem),h=new Element("div",{class:"body_up"}).inject(r);if(this.titleNode=new Element("div",{class:"body_title",text:t.title}).inject(h),this.messageTimeNode=new Element("div",{class:"body_time",text:t.time}).inject(h),"emoji"==t.lastMessageType){this.lastMessageNode=new Element("div",{class:"body_down"}).inject(r);for(var m="",p=0;p<this.main.emojiList.length;p++){var g=this.main.emojiList[p];g.key==t.lastMessage&&(m=g.path)}new Element("img",{src:m,style:"width: 16px;height: 16px;"}).inject(this.lastMessageNode)}else this.lastMessageNode=new Element("div",{class:"body_down",text:t.lastMessage}).inject(r);var u=this;this.node.addEvents({click:function(){u.main.tapConv(u.data)}})},refreshLastMsg:function(e){if(e){var t=e.body,i=JSON.parse(t);if(this.lastMessageNode)if("emoji"==i.type){for(var n="",s=0;s<this.main.emojiList.length;s++){var o=this.main.emojiList[s];o.key==i.body&&(n=o.path)}this.lastMessageNode.empty(),new Element("img",{src:n,style:"width: 16px;height: 16px;"}).inject(this.lastMessageNode)}else this.lastMessageNode.empty(),this.lastMessageNode.set("text",i.body);var a=this.main._friendlyTime(o2.common.toDate(e.createTime));this.messageTimeNode&&this.messageTimeNode.set("text",a)}},refreshConvTitle:function(e){this.titleNode.set("text",e)},refreshData:function(e){this.data=e,this.titleNode.set("text",e.title)},addCheckClass:function(){this.nodeBaseItem&&(this.nodeBaseItem.hasClass("check")||this.nodeBaseItem.addClass("check"))},removeCheckClass:function(){this.nodeBaseItem&&this.nodeBaseItem.hasClass("check")&&this.nodeBaseItem.removeClass("check")}}),MWF.xApplication.IMV2.SingleForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"minder",width:700,height:"200",hasTop:!0,hasIcon:!1,draggable:!0,title:MWF.xApplication.IMV2.LP.createSingle},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top: 20px; '><tr><td styles='formTableTitle' lable='person' width='25%'></td>    <td styles='formTableValue14' item='person' colspan='3'></td></tr></table>");var e=layout.session.user.distinguishedName,t=[];e&&(t=[e]),this.form=new MForm(this.formTableArea,this.data||{},{isEdited:!0,style:"minder",hasColon:!0,itemTemplate:{person:{text:MWF.xApplication.IMV2.LP.selectPerson,type:"org",orgType:"person",count:0,notEmpty:!0,exclude:t}}},this.app),this.form.load()},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("button.inputOkButton",{styles:this.css.inputOkButton,text:MWF.xApplication.IMV2.LP.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(e){this.save(e)}.bind(this))),this.cancelActionNode=new Element("button.inputCancelButton",{styles:this.isEdited||this.isNew||this.getEditPermission()?this.css.inputCancelButton:this.css.inputCancelButton_long,text:MWF.xApplication.IMV2.LP.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(e){this.close(e)}.bind(this))},save:function(){var e=this.form.getResult(!0,null,!0,!1,!0);e&&(this.app.newConversation(e.person,"single"),this.close())}}),MWF.xApplication.IMV2.CreateConversationForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"minder",width:700,height:"200",hasTop:!0,hasIcon:!1,draggable:!0,title:MWF.xApplication.IMV2.LP.createSingle,personCount:1,personSelected:[],isUpdateMember:!1},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top: 20px; '><tr><td styles='formTableTitle' lable='person' width='25%'></td>    <td styles='formTableValue14' item='person' colspan='3'></td></tr></table>");var e=layout.session.user.distinguishedName,t=[];e&&(t=[e]),this.form=new MForm(this.formTableArea,this.data||{},{isEdited:!0,style:"minder",hasColon:!0,itemTemplate:{person:{text:MWF.xApplication.IMV2.LP.selectPerson,type:"org",orgType:"person",count:this.options.personCount,notEmpty:!0,exclude:t,value:this.options.personSelected}}},this.app),this.form.load()},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("button.inputOkButton",{styles:this.css.inputOkButton,text:MWF.xApplication.IMV2.LP.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(e){this.save(e)}.bind(this))),this.cancelActionNode=new Element("button.inputCancelButton",{styles:this.isEdited||this.isNew||this.getEditPermission()?this.css.inputCancelButton:this.css.inputCancelButton_long,text:MWF.xApplication.IMV2.LP.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(e){this.close(e)}.bind(this))},save:function(){var e=this.form.getResult(!0,null,!0,!1,!0);e&&(!0===this.options.isUpdateMember?this.app.updateConversationMembers(e.person,this.app.conversationId):this.app.newConversation(e.person,1===this.options.personCount?"single":"group"),this.close())}}),MWF.xApplication.IMV2.UpdateConvTitleForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"minder",width:500,height:"200",hasTop:!0,hasIcon:!1,draggable:!0,defaultValue:"",title:MWF.xApplication.IMV2.LP.modifyGroupName},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top: 20px; '><tr><td styles='formTableTitle' lable='title' width='25%'></td>    <td styles='formTableValue14' item='title' colspan='3'></td></tr></table>"),this.form=new MForm(this.formTableArea,this.data||{},{isEdited:!0,style:"minder",hasColon:!0,itemTemplate:{title:{text:MWF.xApplication.IMV2.LP.groupName,type:"text",notEmpty:!0,value:this.options.defaultValue}}},this.app),this.form.load()},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("button.inputOkButton",{styles:this.css.inputOkButton,text:MWF.xApplication.IMV2.LP.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(e){this.save(e)}.bind(this))),this.cancelActionNode=new Element("button.inputCancelButton",{styles:this.isEdited||this.isNew||this.getEditPermission()?this.css.inputCancelButton:this.css.inputCancelButton_long,text:MWF.xApplication.IMV2.LP.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(e){this.close(e)}.bind(this))},save:function(){var e=this.form.getResult(!0,null,!0,!1,!0);e&&(this.app.updateConversationTitle(e.title,this.app.conversationId),this.close())}});