MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Meeting","Common",null,!1),MWF.xApplication.Meeting.MeetingView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",months:1},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_Meeting/$MeetingView/",this.cssPath="../x_component_Meeting/$MeetingView/"+this.options.style+"/css.wcss",this._loadCss(),this.app=e,this.container=$(t),this.days=[],this.load()},recordStatus:function(){return{months:this.monthSelect.getValue()}},load:function(){this.userName=layout.desktop.session.user.distinguishedName,this.userId=layout.desktop.session.user.id,this.userIdentity=[],(layout.desktop.session.user.identityList||[]).each(function(t){this.userIdentity.push(t.distinguishedName)}.bind(this)),this.date=new Date,this.node=new Element("div#meetingNode",{styles:this.css.node}).inject(this.container),this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.node),this.todayNode=new Element("div",{styles:this.css.todayNode}).inject(this.titleNode);var t=this.date.format(this.app.lp.dateFormatMonthDay),e=this.app.lp.weeks.arr[this.date.getDay()];this.todayNode.set("text",t+","+e),this.scrollNode=new Element("div",{styles:this.app.inContainer?this.css.scrollNode_inContainer:this.css.scrollNode}).inject(this.node),this.contentWarpNode=new Element("div",{styles:this.css.contentWarpNode}).inject(this.scrollNode),this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode),this.dayContainerNode=new Element("div",{styles:this.css.dayContainerNode}).inject(this.contentNode),this.loadMonthSelect(),this.loadContent(),this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun)},loadMonthSelect:function(){this.monthSelectContainer=new Element("div",{styles:this.css.monthSelectContainer}).inject(this.titleNode),new Element("div",{styles:this.css.monthSelectTextNode,text:this.app.lp.monthSelectTextPrev}).inject(this.monthSelectContainer);var t=new Element("div",{styles:this.css.monthSelectTextNode}).inject(this.monthSelectContainer);this.monthSelect=new MDomItem(t,{name:"monthSelect",type:"select",style:this.css.monthSelect,defaultValue:this.options.months,selectValue:[1,2,3,4,5,6,7,8,9,10,11,12],event:{change:function(){this.reload()}.bind(this)}}),this.monthSelect.load(),new Element("div",{styles:this.css.monthSelectTextNode,text:this.app.lp.monthSelectTextAfter}).inject(this.monthSelectContainer)},resetNodeSize:function(){var t=this.container.getSize();if(!this.app.inContainer){var e=t.y-60;this.node.setStyle("height",e+"px"),this.node.setStyle("margin-top","60px")}var i=this.titleNode.getSize();e=t.y-i.y-60;this.dayNodeHeight=e-60,this.scrollNode.setStyle("height",e+"px");var s=this.app.sideBar?this.app.sideBar.getSize():{x:0,y:0};this.scrollNode.setStyle("width",t.x-s.x+"px");var n=330*this.days.length+30,o=t.x-s.x-50;this.contentWarpNode&&this.contentWarpNode.setStyles({width:Math.max(o,n)+"px"}),this.days.each((function(t){t.resetHeight()}))},hasSameItem:function(t,e){for(var i=0;i<e.length;i++)if(t.contains(e[i]))return!0;return!1},loadContent:function(){var t=0;this.daysData={};var e=this.monthSelect.getValue()||this.options.months;this.app.actions.listMeetingMonths(e,function(e){for(var i in e.data.each(function(e){if((e.invitePersonList.contains(this.userName)||e.invitePersonList.contains(this.userId)||e.applicant==this.userName||this.hasSameItem(e.invitePersonList,this.userIdentity))&&(!e.rejectPersonList.contains(this.userName)||!e.rejectPersonList.contains(this.userId)||!this.hasSameItem(e.rejectPersonList,this.userIdentity))){var i=Date.parse(e.startTime).clone().clearTime();this.daysData[i]||(this.daysData[i]=[]),this.daysData[i].push(e),t++}}.bind(this)),this.daysData){var s=new MWF.xApplication.Meeting.MeetingView.Day(this,this.dayContainerNode,i,this.daysData[i]);this.days.push(s)}0==t&&this.loadEmptyNode(),this.resetNodeSize()}.bind(this))},loadEmptyNode:function(){this.noMeetingNode=new Element("div",{styles:this.css.noMeetingNode,text:this.app.lp.noComingMeeting.replace("{month}",this.monthSelect.getValue()||this.options.months)}).inject(this.dayContainerNode)},hide:function(){new Fx.Morph(this.node,{duration:"300",transition:Fx.Transitions.Expo.easeOut}).start({opacity:0}).chain(function(){this.node.setStyle("display","none")}.bind(this))},show:function(){if(this.node.setStyles(this.css.node),this.app.inContainer)this.node.setStyles({opacity:1,position:"static",width:"auto"});else{var t=new Fx.Morph(this.node,{duration:"800",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize"),t.start({opacity:1,left:"0px"}).chain(function(){this.node.setStyles({position:"static",width:"auto"})}.bind(this))}},reload:function(){this.date=this.days.length>0?this.days[0].date.clone():this.date,this.days.each((function(t){t.destroy()})),this.dayContainerNode.empty(),this.days=[],this.loadContent()},destroy:function(){this.days.each((function(t){t.destroy()})),this.app.removeEvent("resize",this.resetNodeSizeFun),this.node.destroy()}}),MWF.xApplication.Meeting.MeetingView.Day=new Class({Implements:[Events],initialize:function(t,e,i,s){this.view=t,this.css=this.view.css,this.container=e,this.app=this.view.app,this.date=i?Date.parse(i).clone().clearTime():(new Date).clearTime(),this.today=(new Date).clearTime(),this.isToday=0==this.date.diff(this.today),this.times=[],this.meetings=[],this.data=s,this.load()},load:function(){this.node=new Element("div.dayNode",{styles:this.css.dayNode}).inject(this.container,this.position),this.node.setStyle("min-height",this.view.dayNodeHeight+"px"),this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.dayNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.dayNode)}.bind(this)}),this.titleNode=new Element("div.titleNode",{styles:this.css[this.isToday?"dayTitleNode_today":"dayTitleNode"]}).inject(this.node);var t=this.isToday?"dayTitleTextNode_today":"dayTitleTextNode";this.titleTextNode=new Element("div.dayTitleTextNode",{styles:this.css[t],text:this.date.format(this.app.lp.dateFormatDay)}).inject(this.titleNode),this.dayWeekNode=new Element("div.dayWeekNode",{styles:this.css[this.isToday?"dayWeekNode_today":"dayWeekNode"],text:this.getWeek()}).inject(this.titleNode),this.dayContentNode=new Element("div.dayContentNode",{styles:this.css.dayContentNode}).inject(this.node),this.loadMeetings()},resetHeight:function(){this.node.setStyle("min-height",this.view.dayNodeHeight+"px")},getWeek:function(){var t=this.app.lp.weeks.arr[this.date.getDay()];return 0==this.today.diff(this.date)?this.app.lp.today:t},destroy:function(){this.calendar&&this.calendar.container.destroy(),this.meetings.each((function(t){t.destroy()})),this.node.destroy(),MWF.release(this)},loadMeetings:function(){this.data.each(function(t,e){this.meetings.push(new MWF.xApplication.Meeting.MeetingView.Meeting(this.dayContentNode,this,t))}.bind(this))},reload:function(){this.view.reload()}}),MWF.xApplication.Meeting.MeetingView.Meeting=new Class({Extends:MWF.xApplication.Meeting.MeetingArea});