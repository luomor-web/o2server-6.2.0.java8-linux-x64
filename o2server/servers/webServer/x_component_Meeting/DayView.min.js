MWF.xApplication.Meeting.DayView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",date:null},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_Meeting/$DayView/",this.cssPath="../x_component_Meeting/$DayView/"+this.options.style+"/css.wcss",this._loadCss(),this.app=e,this.container=$(t);var s=this.options.date;this.date=s?"string"==typeOf(s)?new Date(s):s:new Date,this.load()},recordStatus:function(){return{date:this.days.length>0?this.days[0].date.clone():this.date}},load:function(){this.days=[],this.scrollNode=new Element("div",{styles:this.css.scrollNode}).inject(this.container),this.contentWarpNode=new Element("div",{styles:this.css.contentWarpNode}).inject(this.scrollNode),this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.node=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode),this.leftNode=new Element("div",{styles:this.css.leftNode}).inject(this.node),this.leftNode.addEvents({click:function(){this.decrementDay()}.bind(this),mouseover:function(){this.leftNode.setStyles(this.css.leftNode_over)}.bind(this),mouseout:function(){this.leftNode.setStyles(this.css.leftNode)}.bind(this)}),this.dayContainerNode=new Element("div",{styles:this.css.dayContainerNode}).inject(this.node),this.rightNode=new Element("div",{styles:this.css.rightNode}).inject(this.node),this.rightNode.addEvents({click:function(){this.incrementDay()}.bind(this),mouseover:function(){this.rightNode.setStyles(this.css.rightNode_over)}.bind(this),mouseout:function(){this.rightNode.setStyles(this.css.rightNode)}.bind(this)}),this.resetNodeSize(),this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun)},resetNodeSize:function(){var t=this.container.getSize(),e=this.leftNode?this.leftNode.getSize():{x:0,y:0},i=this.rightNode?this.rightNode.getSize():{x:0,y:0},s=this.app.sideBar?this.app.sideBar.getSize():{x:0,y:0},n=t.x-e.x-i.x-s.x;this.dayNodeHeight=t.y-110;var d=(this.dayNodeHeight-e.y)/2,a=(this.dayNodeHeight-i.y)/2;this.leftNode.setStyle("margin-top",d+"px"),this.rightNode.setStyle("margin-top",a+"px");var o=(n/330).toInt();if(this.scrollNode.setStyle("height",t.y-60+"px"),this.app.inContainer||this.scrollNode.setStyle("margin-top","60px"),this.scrollNode.setStyle("margin-right",s.x),this.contentWarpNode){var h=330*o+e.x+i.x+s.x,l=(t.x-h)/2-10;this.contentWarpNode.setStyles({width:h+"px","margin-left":l+"px"})}if(this.dayCount!=o)this.dayCount=o,this.adjustDay();else for(var y=0;y<this.days.length;y++)this.days[y].resetHeight()},toDay:function(t){this.date=t,this.dayContainerNode.empty(),this.days=[],this.adjustDay()},adjustDay:function(){if(this.dayCount<=this.days.length){this.date=this.days[this.dayCount].date.clone();for(var t=0;t<this.days.length;t++)t<this.dayCount?this.days[t].resetHeight():this.days[t]&&this.days[t].destroy();this.days.splice(this.dayCount,this.days.length-this.dayCount)}else{for(t=0;t<this.days.length;t++)this.days[t].resetHeight();this.days.length&&(this.date=this.days[this.days.length-1].date.clone().increment()),this.loadDay(this.dayCount-this.days.length,0==this.days.length)}},incrementDay:function(){if(this.days.length>1){var t=this.date=this.days[this.days.length-1].date.clone().increment(),e=this.days[this.days.length-1].node;this.days[0].destroy(),this.days.splice(0,1),this.days[0].setFrist();var i=new MWF.xApplication.Meeting.DayView.Day(this,e,"after",t,!1);this.days.push(i)}else if(1==this.days.length){t=this.date=this.days[this.days.length-1].date.clone().increment();this.days[0].destroy(),this.days.splice(0,1);i=new MWF.xApplication.Meeting.DayView.Day(this,this.dayContainerNode,null,t,!1);this.days.push(i)}},decrementDay:function(t){if(this.days.length>1){var e=this.days[0].date.clone().decrement();this.days[0].disposeFrist(),this.date=this.days[this.days.length-1].date.clone().decrement(),this.days[this.days.length-1].destroy(),this.days.splice(this.days.length-1,1);t=this.days[0].node;var i=new MWF.xApplication.Meeting.DayView.Day(this,t,"before",e,!0);this.days.unshift(i)}else if(1==this.days.length){e=this.days[0].date.clone().decrement();this.date=this.days[this.days.length-1].date.clone().decrement(),this.days[this.days.length-1].destroy(),this.days.splice(this.days.length-1,1);i=new MWF.xApplication.Meeting.DayView.Day(this,this.dayContainerNode,null,e,!0);this.days.unshift(i)}},loadDay:function(t,e){this.date||(this.date=new Date),t||(t=this.dayCount);for(var i=this.date,s=0;s<(t||this.dayCount);s++){var n=new MWF.xApplication.Meeting.DayView.Day(this,this.dayContainerNode,null,i,e&&0==s);this.days.push(n),i.increment()}},hide:function(){new Fx.Morph(this.scrollNode,{duration:"300",transition:Fx.Transitions.Expo.easeOut}).start({opacity:0}).chain(function(){this.scrollNode.setStyle("display","none")}.bind(this))},show:function(){if(this.scrollNode.setStyles(this.css.scrollNode),this.scrollNode.setStyles({display:""}),this.app.inContainer)this.node.setStyles({opacity:1,position:"static",width:"auto",display:""});else{var t=new Fx.Morph(this.scrollNode,{duration:"800",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize"),t.start({opacity:1,left:"0px"}).chain(function(){this.scrollNode.setStyles({position:"static",width:"auto",display:""})}.bind(this))}},reload:function(){this.date=this.days.length>0?this.days[0].date.clone():this.date,this.days.each((function(t){t.destroy()})),this.dayContainerNode.empty(),this.days=[],this.loadDay(null,!0)},destroy:function(){this.days.each((function(t){t.destroy()})),this.app.removeEvent("resize",this.resetNodeSizeFun),this.scrollNode.destroy()}}),MWF.xApplication.Meeting.DayView.Day=new Class({Implements:[Events],initialize:function(t,e,i,s,n){this.view=t,this.css=this.view.css,this.container=e,this.position=i||"bottom",this.app=this.view.app,this.date=s?s.clone().clearTime():(new Date).clearTime(),this.today=(new Date).clearTime(),this.isToday=0==this.date.diff(this.today),this.times=[],this.meetings=[],this.isFirst=n,this.load()},load:function(){var t;(this.node=new Element("div.dayNode",{styles:this.css.dayNode}).inject(this.container,this.position),this.node.setStyle("min-height",this.view.dayNodeHeight+"px"),this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.dayNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.dayNode)}.bind(this)}),this.titleNode=new Element("div.titleNode",{styles:this.css[this.isToday?"dayTitleNode_today":"dayTitleNode"]}).inject(this.node),this.today.diff(this.date)>=0)&&(t=this.isToday?"dayCreateIconNode_today":"dayCreateIconNode",this.dayCreateIconNode=new Element("div.dayCreateIconNode",{styles:this.css[t],events:{click:function(){this.app.addMeeting(this.date.clone().clearTime())}.bind(this)}}).inject(this.titleNode));t=this.isFirst?this.isToday?"dayTitleTextNode_today_first":"dayTitleTextNode_first":this.isToday?"dayTitleTextNode_today":"dayTitleTextNode",this.titleTextNode=new Element("div.dayTitleTextNode",{styles:this.css[t],text:this.date.format(this.app.lp.dateFormatDay)}).inject(this.titleNode),this.isFirst&&MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.titleTextNode,{style:"meeting_blue",target:this.node,baseDate:this.date,onQueryComplate:function(t,e,i){var s=new Date.parse(e);this.view.toDay(s)}.bind(this)})}.bind(this)),this.dayWeekNode=new Element("div.dayWeekNode",{styles:this.css[this.isToday?"dayWeekNode_today":"dayWeekNode"],text:this.getWeek()}).inject(this.titleNode),this.dayContentNode=new Element("div.dayContentNode",{styles:this.css.dayContentNode}).inject(this.node),this.loadMeetings()},resetHeight:function(){this.node.setStyle("min-height",this.view.dayNodeHeight+"px"),this.noMeetingNode&&(this.noMeetingNode.setStyle("min-height",this.view.dayNodeHeight-220+"px"),this.noMeetingNode.setStyle("line-height",this.view.dayNodeHeight-220+"px"))},getWeek:function(){var t=this.app.lp.weeks.arr[this.date.getDay()];return 0==this.today.diff(this.date)?this.app.lp.today:t},setFrist:function(){this.isFirst||(this.isFirst=!0,className=this.isToday?"dayTitleTextNode_today_first":"dayTitleTextNode_first",this.titleTextNode.setStyles(this.css[className]),MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.titleTextNode,{style:"meeting_blue",target:this.node,baseDate:this.date,onQueryComplate:function(t,e,i){var s=new Date.parse(e);this.view.toDay(s)}.bind(this)})}.bind(this)))},disposeFrist:function(){if(this.isFirst){this.isFirst=!1,this.titleTextNode.removeEvent("click"),this.titleTextNode.removeEvent("focus");var t=this.isToday?"dayTitleTextNode_today":"dayTitleTextNode";this.titleTextNode.setStyles(this.css[t]),this.calendar.container.destroy(),this.calendar=null}},destroy:function(){this.calendar&&this.calendar.container.destroy(),this.meetings.each((function(t){t.destroy()})),this.meetings=[],this.node.destroy()},loadMeetings:function(){this.app.isMeetingViewer(function(t){this._loadMeetings(t)}.bind(this))},_loadMeetings:function(t){var e=this.date.getFullYear(),i=this.date.getMonth()+1,s=this.date.getDate();this.app.actions[t?"listMeetingDayAll":"listMeetingDay"](e,i,s,function(t){var e=!0;t.data&&0!=t.data.length&&t.data.each(function(t,i){t.myReject||(e=!1,this.meetings.push(new MWF.xApplication.Meeting.DayView.Meeting(this.dayContentNode,this,t)))}.bind(this)),e&&(this.noMeetingNode=new Element("div.noMeetingNode",{styles:this.css.noMeetingNode,text:this.app.lp.noMeeting}).inject(this.dayContentNode),this.noMeetingNode.setStyle("min-height",this.view.dayNodeHeight-220+"px"),this.noMeetingNode.setStyle("line-height",this.view.dayNodeHeight-220+"px"))}.bind(this))},reload:function(){this.view.reload()}}),MWF.xApplication.Meeting.DayView.Meeting=new Class({Extends:MWF.xApplication.Meeting.MeetingArea});