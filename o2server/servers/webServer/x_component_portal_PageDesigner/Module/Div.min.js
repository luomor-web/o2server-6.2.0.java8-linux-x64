MWF.xApplication.portal.PageDesigner.Module.Div=MWF.PCDiv=new Class({Extends:MWF.FCDiv,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_portal_PageDesigner/Module/Div/div.html",actions:[{name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPPD.LP.formAction.move},{name:"copy",icon:"copy1.png",event:"mousedown",action:"copy",title:MWF.APPPD.LP.formAction.copy},{name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPPD.LP.formAction.delete},{name:"makeWidget",icon:"makeWidget1.png",event:"click",action:"makeWidget",title:MWF.APPPD.LP.formAction.makeWidget}]},initialize:function(e,t){this.setOptions(t),this.path="../x_component_portal_PageDesigner/Module/Div/",this.cssPath="../x_component_portal_PageDesigner/Module/Div/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="container",this.moduleName="div",this.Node=null,this.form=e,this.page=e},loadNewWidgetData:function(e,t){MWF.getJSON("../x_component_portal_PageDesigner/Module/Page/template/page.json",{onSuccess:function(i){i.pcData.id="",i.pcData.isNewPage=!0,i.pcData.json=i.pcData.json||{},i.pcData.json.name=e,i.pcData.json.application=this.page.designer.application.id,i.pcData.json.applicationName=this.page.designer.application.name,i.mobileData.id="",i.mobileData.isNewPage=!0,i.mobileData.json=i.mobileData.json||{},i.mobileData.json.application=this.page.designer.application.id,i.mobileData.json.applicationName=this.page.designer.application.name,t&&t(i)}.bind(this),onerror:function(e){this.notice(e,"error")}.bind(this),onRequestFailure:function(e){this.notice(e.responseText,"error")}.bind(this)})},_getWidgetData:function(e){this.page.fireEvent("queryGetPageData");var t=this.node.clone(!0,!0);t.clearStyles(!0),this.page.fireEvent("postGetPageData"),this.page._clearNoId(t);var i=t.outerHTML;return"Mobile"===this.page.options.mode?(e.mobileData.html='<div MWFType="form" id="">'+i+"</div>",e.mobileData.json.moduleList=this._getWidgetModules(t)):(e.pcData.html='<div MWFType="form" id="">'+i+"</div>",e.pcData.json.moduleList=this._getWidgetModules(t)),t.destroy(),e},_getWidgetModules:function(e){var t={},i=this.page.getDomjson(e);return t[i.id]=i,e.getElements("[MWFtype]").each(function(e){var i=this.page.getDomjson(e);t[i.id]=i}.bind(this)),t},_getWidgetFieldList:function(e){var t={string:["htmledit","radio","select","textarea","textfield"],person:["personfield","org"],date:["calender"],number:["number"],array:["checkbox"]};for(var i in fieldList=[],e){var o=e[i],n="";for(k in t)if(-1!=t[k].indexOf((o.moduleName||o.type||"").toLowerCase())){n=k;break}n&&fieldList.push({name:o.id,dataType:n})}return fieldList},makeWidget:function(){var e=this,t=this.path+"newWidget.html";MWF.require("MWF.widget.Dialog",function(){var i=$(document.body).getSize(),o=i.x/2-180,n=i.y/2-100,a=new MWF.DL({title:"create widget",style:"property",top:n,left:o-40,fromTop:i.y/2-65,fromLeft:i.x/2,width:360,height:200,url:t,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){var t=e.widgetNameInput.get("value");if(t){var i=!0;o2.Actions.get("x_portal_assemble_designer").listWidget(e.page.designer.application.id,function(o){for(var n=0;n<o.data.length;n++)if(o.data[n].name===t){e.page.designer.notice(e.page.designer.lp.notice.widgetNameConflict,"error"),i=!1;break}}.bind(this),null,!1),i&&(e._makeWidget(t),this.close())}else e.page.designer.notice(e.page.designer.lp.notice.widgetNameEmpty,"error")}},{text:MWF.APPFD.LP.button.cancel,action:function(){this.close()}}],onPostShow:function(){this.widgetNameInput=a.node.getElementById("MWFNewWidgetName")}.bind(this)});a.show()}.bind(this))},_makeWidget:function(e){this.loadNewWidgetData(e,function(e){var t,i,o,n=this._getWidgetData(e);"Mobile"===this.page.options.mode?(t=e.pcData,i=n.mobileData,o=this._getWidgetFieldList(i.json.moduleList)):(t=n.pcData,i=e.mobileData,o=this._getWidgetFieldList(t.json.moduleList)),this.page.designer.actions.saveWidget(t,i,o,function(e){this.page.designer.notice(MWF.APPPD.LP.notice.widget_save_success,"ok",null,{x:"left",y:"bottom"})}.bind(this),function(e,t,i){this.isSave=!1;var o=i+":"+t;e&&(o=e.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+o)}.bind(this))}.bind(this))}});