MWF.xApplication.portal.PageDesigner.Module.Widgetmodules=MWF.PCWidgetmodules=new Class({Extends:MWF.FC$Module,Implements:[Options,Events],options:{style:"default"},initialize:function(e,t){this.setOptions(t),this.path="../x_component_portal_PageDesigner/Module/Widgetmodules/",this.cssPath="../x_component_portal_PageDesigner/Module/Widgetmodules/"+this.options.style+"/css.wcss",this._loadCss(),this.form=e,this.page=e,this.container=null,this.containerNode=null},_createMoveNode:function(){this.moveNode=new Element("div",{styles:this.css.moduleNodeMove,events:{selectstart:function(){return!1}}}).inject(this.form.container)},_createNode:function(e,t){var i=this,o=this.path+"widgetSelect.html";MWF.require("MWF.widget.Dialog",function(){var n=$(document.body).getSize(),s=n.x/2-180,d=n.y/2-100,l=new MWF.DL({title:"Insert",style:"property",top:d,left:s-40,fromTop:n.y/2-65,fromLeft:n.x/2,width:360,height:200,url:o,lp:MWF.xApplication.process.FormDesigner.LP.propertyTemplate,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){var o=i.widgetSelect.options[i.widgetSelect.selectedIndex].value;if(o&&"none"!==o){var n="yes";l.node.getElements(".wrapDiv").each((function(e){e.get("checked")&&(n=e.get("value"))})),i.appendWidgetModules(o,e,t,n),this.close()}else i.page.designer.notice(i.page.designer.lp.notice.selectWidget,"error")}},{text:MWF.APPFD.LP.button.cancel,action:function(){i._clearDragComplete(),this.close()}}],onPostShow:function(){var e=l.node.getElementById("MWFWidgetSelectTd");this.form.designer.actions.listWidget(this.form.designer.application.id,function(t){var i=this.widgetSelect=new Element("select").inject(e);new Element("option",{text:"none"}).inject(i);t.data.each(function(e){new Element("option",{text:e.name,value:e.id}).inject(i)}.bind(this))}.bind(this))}.bind(this)});l.show()}.bind(this))},_dragComplete:function(e,t){this.node?this._clearDragComplete():this._createNode(e,t)},_clearDragComplete:function(){this.injectNoticeNode&&this.injectNoticeNode.destroy(),this.copyNode&&this.copyNode.destroy(),this.moveNode&&this.moveNode.destroy(),this.moveNode=null,this.copyNode=null,this.nextModule=null,this.form.moveModule=null},appendWidgetModules:function(e,t,i,o){MWF.Actions.get("x_portal_assemble_designer").getWidget(e,function(e){var n=this.parentContainer||this.inContainer||this.onDragModule;this.containerModule=this.page.createModuleImmediately("Div",n,t||this.copyNode,i||"before",!1,!1),this.node=this.containerModule.node;var s=this.getWidgetData(e.data),d=(this.page.json.moduleList,new Element("div").inject(this.page.container));d.set("html",s.html);var l=d.getFirst().get("html");d.destroy(),this.node.set("html",l),Object.each(s.json.moduleList,function(e){for(var t=e.id,i=e.id,o=1;this.page.json.moduleList[i];)i=t+"_"+o,o++;if(t!=i){e.id=i;var n=this.node.getElementById(t);n&&n.set("id",i)}this.page.json.moduleList[e.id]=e}.bind(this)),"no"===o?(this.node.getChildren().each(function(e){if(e.get("MWFType")&&e.get("id")){e.get("id");e.inject(t||this.copyNode,i||"before")}}.bind(this)),this.page.parseModules(n,n.node),this.page.selected(),this.containerModule.destroy()):this.page.parseModules(this.containerModule,this.node),this._clearDragComplete()}.bind(this),null,!1)},getWidgetData:function(e){var t=null,i=null;return(t="Mobile"!==this.page.options.mode?e.data:e.mobileData)&&((i=JSON.decode(MWF.decodeJsonString(t))).updateTime=e.updateTime),i}});