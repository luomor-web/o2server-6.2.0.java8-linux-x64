MWF.xApplication.portal.PageDesigner.Module=MWF.xApplication.portal.PageDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Element",null,!1),MWF.xApplication.portal.PageDesigner.Module.Subpage=MWF.PCSubpage=new Class({Extends:MWF.FC$Element,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_portal_PageDesigner/Module/Subpage/subpage.html",actions:[{name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPPD.LP.formAction.move},{name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPPD.LP.formAction.delete}]},initialize:function(e,t){this.setOptions(t),this.path="../x_component_portal_PageDesigner/Module/Subpage/",this.cssPath="../x_component_portal_PageDesigner/Module/Subpage/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="element",this.moduleName="subpage",this.page=e,this.form=e,this.container=null,this.containerNode=null},load:function(e,t,s){this.json=e,this.node=t,this.node.store("module",this),this.node.setStyles(this.css.moduleNode),this._initModule(),this.json.subpageSelected&&"none"!==this.json.subpageSelected&&"script"!==this.json.subpageType?this.redoSelectedSubpage(this.json.subpageSelected,null,""):(this.node.empty(),this.loadIcon()),this._loadTreeNode(s),this.setCustomStyles(),this.parentContainer=this.treeNode.parentNode.module,this._setEditStyle_custom("id"),this.parseModules(),this.json.moduleName=this.moduleName,this.node.addEvent("click",function(){this.refreshSubpage()}.bind(this)),this.node.addEvent("dblclick",function(e){this.openSubpage(e)}.bind(this))},_initModule:function(){this.json.isSaved||this.setStyleTemplate(),this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("inputStyles"),this.setPropertiesOrStyles("properties"),this._setNodeProperty(),this.page.isSubpage||this._createIconAction(),this._setNodeEvent(),this.json.isSaved=!0,this.queryGetPageDataFun=this.queryGetPageData.bind(this),this.postGetPageDataFun=this.postGetPageData.bind(this),this.page.addEvent("queryGetPageData",this.queryGetPageDataFun),this.page.addEvent("postGetPageData",this.postGetPageDataFun)},openSubpage:function(e){this.json.subpageSelected&&"none"!==this.json.subpageSelected&&"script"!==this.json.subpageType&&layout.desktop.openApplication(e,"portal.PageDesigner",{id:this.json.subpageSelected,appId:"PageDesigner"+this.json.subpageSelected})},_createMoveNode:function(){this.moveNode=new Element("div",{MWFType:"subpage",id:this.json.id,styles:this.css.moduleNodeMove,events:{selectstart:function(){return!1}}}).inject(this.page.container)},_createNode:function(){this.node=this.moveNode.clone(!0,!0),this.node.setStyles(this.css.moduleNode),this.node.set("id",this.json.id),this.node.addEvent("selectstart",(function(){return!1})),this.loadIcon(),this.node.addEvent("click",function(){this.refreshSubpage()}.bind(this))},postGetPageData:function(e){e&&!e.contains(this.node)||this.show()},queryGetPageData:function(e){e&&!e.contains(this.node)||this.hide()},hide:function(){this.node.empty()},show:function(){this.subpageData?(this.subpageModule=new MWF.PCSubpage.Page(this.page,this.node,{parentpageIdList:this.getParentpageIdList(),level:this.getLevel()}),this.subpageModule.subpageSelector=this.getSubpageSelector(),this.subpageModule.subpageSelectedValue=this.getSubpageSelectedValue(),this.subpageModule.level1Subpage=this.getLevel1Subpage(),this.subpageModule.load(this.subpageData)):(this.node.empty(),this.loadIcon())},delete:function(e){var t=this;this.page.designer.shortcut=!1,this.page.designer.confirm("warn",t.node,MWF.APPPD.LP.notice.deleteElementTitle,MWF.APPPD.LP.notice.deleteElement,300,120,(function(){this.queryGetPageDataFun&&t.page.removeEvent("queryGetPageData",this.queryGetPageDataFun),this.postGetPageDataFun&&t.page.removeEvent("postGetPageData",this.postGetPageDataFun),t.destroy(),t.page.selected(),t.page.designer.shortcut=!0,this.close()}),(function(){t.page.designer.shortcut=!0,this.close()}),null)},getLevel:function(){return(this.page.options.level1||0)+1},getLevel1Subpage:function(){return this.page.level1Subpage||this},getSubpageSelector:function(){return this.subpageSelector||this.page.subpageSelector},getSubpageSelectedValue:function(){return this.subpageSelectedValue||this.page.subpageSelectedValue},checkSubpageNested:function(e){return!this.page.options.parentpageIdList||!this.page.options.parentpageIdList.contains(e)},getParentpageIdList:function(){var e;return this.page.options.parentpageIdList?(e=Array.clone(this.page.options.parentpageIdList)).push(this.page.json.id):e=[this.page.json.id],e},refreshSubpage:function(){this.json.subpageSelected&&"none"!==this.json.subpageSelected&&"script"!==this.json.subpageType&&MWF.Actions.get("x_portal_assemble_designer").getPage(this.json.subpageSelected,function(e){if(this.subpageData.updateTime!==e.data.updateTime){var t=null;this.property&&(t=$(this.property.data.pid+"selectSubpage").getElement("select")),this.clearSubpageList(this.json.subpageSelected),this.reloadSubpage(e.data,t,"")}}.bind(this))},loadIcon:function(){this.iconNode=new Element("div",{styles:this.css.iconNode}).inject(this.node),new Element("div",{styles:this.css.iconNodeIcon}).inject(this.iconNode),new Element("div",{styles:this.css.iconNodeText,text:"Subpage"}).inject(this.iconNode)},_loadNodeStyles:function(){this.iconNode=this.node.getElement("div").setStyles(this.css.iconNode),this.iconNode.getFirst("div").setStyles(this.css.iconNodeIcon),this.iconNode.getLast("div").setStyles(this.css.iconNodeText)},_setEditStyle:function(e,t,s){"subpageSelected"===e&&this.json.subpageSelected!==s&&this.redoSelectedSubpage(e,t,s),"subpageType"===e&&this.json.subpageType!==s&&("script"!==this.json.subpageType&&this.redoSelectedSubpage(e,$(this.property.data.pid+"selectSubpage").getElement("select"),""),"script"===this.json.subpageType&&(this.subpageData=null,this.clearSubpageList(this.json.subpageSelected),this.node.empty(),this.loadIcon()))},redoSelectedSubpage:function(e,t,s){if("none"===this.json.subpageSelected&&(this.json.subpageSelected=""),this.json.subpageSelected&&"none"!==this.json.subpageSelected){t&&(this.subpageSelector=t),t||(t=this.getSubpageSelector()),s&&(this.subpageSelectedValue=s),s||(s=this.getSubpageSelectedValue()||"");var i=this.getLevel1Subpage();if(this.checkSubpageNested(this.json.subpageSelected))MWF.Actions.get("x_portal_assemble_designer").getPage(this.json.subpageSelected,function(e){this.reloadSubpage(e.data,t,s)}.bind(this));else{if(this.page.designer.notice(this.page.designer.lp.subpageNestedInfor,"error",i.node),i.json.subpageSelected=s,t)for(var a=0;a<t.options.length;a++)if(t.options[a].value===s||"none"===t.options[a].value&&!s){t.options[a].set("selected",!0);break}s?i.refreshSubpage():(i.node.empty(),i.loadIcon())}}else this.subpageData=null,this.clearSubpageList(s),this.node.empty(),this.loadIcon()},clearSubpageList:function(e){this.page.subpageList||(this.page.subpageList={}),e&&this.page.subpageList[e]&&delete this.page.subpageList[e]},addSubpageList:function(){this.page.subpageList||(this.page.subpageList={}),this.page.subpageList[this.json.subpageSelected]=Object.clone(this.subpageData.json)},getSubpageData:function(e){var t=null;t="Mobile"!==this.page.options.mode?e.data:e.mobileData,this.subpageData=null,t&&(this.subpageData=JSON.decode(MWF.decodeJsonString(t)),this.subpageData.updateTime=e.updateTime)},reloadSubpage:function(e,t,s){if(this.getSubpageData(e),this.subpageData){var i=this.page.subpageList&&s?this.page.subpageList[s]:null;if(this.clearSubpageList(s),this.checkSubpage(e,t))this.node.empty(),this.loadSubpage(),this.addSubpageList();else if(i?(this.page.subpageList||(this.page.subpageList={}),this.page.subpageList[s]=i):(this.clearSubpageList(s),this.node.empty(),this.loadIcon()),this.json.subpageSelected=s,s){if(t)for(var a=0;a<t.options.length;a++)if(t.options[a].value===s){t.options[a].set("selected",!0);break}}else t&&t.options[0].set("selected",!0)}else if(this.json.subpageSelected=s,t)if(s){for(a=0;a<t.options.length;a++)if(t.options[a].value===s){t.options[a].set("selected",!0);break}}else t.options[0].set("selected",!0)},regetSubpageData:function(){var e=!1;return this.json.subpageSelected&&"none"!==this.json.subpageSelected&&"script"!==this.json.subpageType&&MWF.Actions.get("x_portal_assemble_designer").getPage(this.json.subpageSelected,function(t){this.subpageData&&this.subpageData.updateTime===t.data.updateTime||(this.getSubpageData(t.data),e=!0)}.bind(this),null,!1),e},getConflictFields:function(){var e=[];return this.subpageData&&Object.each(this.subpageData.json.moduleList,function(t,s){var i=this.page.checkModuleId(s,t.type,this.subpageData.json.id);i.fieldConflict?e.push(s):i.elementConflict&&(t.changeId=this.json.id+"_"+s)}.bind(this)),e},checkSubpage:function(e,t){var s=this.getConflictFields();if(s.length){var i=this.page.designer.lp.subpageNameConflictInfor;return i=i.replace("{name}",s.join(", ")),this.page.designer.notice(i,"error",this.node),!1}return!0},loadSubpage:function(e){this.subpageData.json.style=this.page.json.style,this.subpageData.json.properties=this.page.json.properties,this.subpageData.json.jsheader={code:"",html:""},this.subpageData.json.events={},this.subpageData.json.pageStyleType=this.page.json.pageStyleType,this.subpageModule=new MWF.PCSubpage.Page(this.page,this.node,{parentpageIdList:this.getParentpageIdList(),level:this.getLevel()}),this.subpageModule.subpageSelector=this.getSubpageSelector(),this.subpageModule.subpageSelectedValue=this.getSubpageSelectedValue(),this.subpageModule.level1Subpage=this.getLevel1Subpage(),this.subpageModule.load(this.subpageData)},destroy:function(){this.page.moduleList.erase(this),this.page.moduleNodeList.erase(this.node),this.page.moduleElementNodeList.erase(this.node),this.clearSubpageList(this.json.subpageSelected),this.node.destroy(),this.actionArea.destroy(),delete this.page.json.moduleList[this.json.id],this.json=null,delete this.json,this.treeNode.destroy()}}),MWF.xApplication.portal.PageDesigner.Module.Subpage.Page=new Class({Extends:MWF.PCPage,initialize:function(e,t,s){this.setOptions(s),this.toppage=e.toppage||e,this.parentpage=e,this.parentform=e,this.css=this.parentpage.css,this.container=t,this.form=this,this.page=this,this.isSubpage=!0,this.isSubform=!0,this.moduleType="subpage",this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.designer=this.parentpage.designer,this.selectedModules=[]},load:function(e){this.data=e,this.json=e.json,this.html=e.html,this.json.mode=this.options.mode,this.container.set("html",this.html),this.loadDomModules(),"Mobile"===this.options.mode&&oldStyleValue&&this._setEditStyle("pageStyleType",null,oldStyleValue)},loadDomModules:function(){this.node=this.container.getFirst(),this.node.set("id",this.json.id),this.node.setStyles("Mobile"===this.options.mode?this.css.pageMobileNode:this.css.pageNode),this.node.store("module",this),this.loadDomTree()},loadDomTree:function(){this.createPageTreeNode(),this.parseModules(this,this.node)},createPageTreeNode:function(){this.treeNode={insertChild:function(){return this},appendChild:function(){return this},selectNode:function(){},node:null,parentNode:{}},this.treeNode.module=this}});