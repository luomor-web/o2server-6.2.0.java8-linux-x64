MWF.APPPD=MWF.xApplication.portal.PageDesigner,MWF.APPPD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("portal.PageDesigner","Module.Package",null,!1),MWF.xApplication.portal.PageDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",template:"template.json",templateId:"",name:"portal.PageDesigner",icon:"icon.png",title:MWF.APPPD.LP.title,appTitle:MWF.APPPD.LP.title,id:"",actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.APPPD.LP.newPage),this.actions=MWF.Actions.get("x_portal_assemble_designer"),this.lp=MWF.xApplication.portal.PageDesigner.LP},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openPage():this.maxSize(function(){this.openPage()}.bind(this)),this.addKeyboardEvents(),t&&t()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this)),this.addEvent("paste",function(){this.pasteModule()}.bind(this)),this.addEvent("cut",function(){this.cutModule()}.bind(this)),this.addEvent("keySave",function(t){this.keySave(t)}.bind(this)),this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){this.shortcut&&(this.page&&this.savePage(),t.preventDefault())},keyDelete:function(t){if(this.page&&this.shortcut&&this.page.currentSelectedModule){var e=this.page.currentSelectedModule;"page"!=e.moduleType&&-1==e.moduleName.indexOf("$")&&e.delete(e.node)}},copyModule:function(){if(this.shortcut&&this.page&&this.page.currentSelectedModule){var t=this.page.currentSelectedModule;if("page"!=t.moduleType&&-1==t.moduleName.indexOf("$")){this.page.fireEvent("queryGetPageData",[t.node]);var e=t.getHtml(),i=t.getJson();this.page.fireEvent("postGetPageData",[t.node]),MWF.clipboard.data={type:"page",data:{html:e,json:i}}}else MWF.clipboard.data=null}},cutModule:function(){if(this.shortcut&&this.page&&this.page.currentSelectedModule){var t=this.page.currentSelectedModule;if("page"!=t.moduleType&&-1==t.moduleName.indexOf("$")){this.copyModule();var e=t.form;t.destroy(),e.currentSelectedModule=null,e.selected(),e=null}}},pasteModule:function(){if(this.shortcut&&this.page&&MWF.clipboard.data&&"page"==MWF.clipboard.data.type){var t=MWF.clipboard.data.data.html,e=Object.clone(MWF.clipboard.data.data.json),i=new Element("div",{styles:{display:"none"},html:t}).inject(this.content);Object.each(e,function(t){for(var e=t.id,o=t.id,s=1;this.page.json.moduleList[o];)o=e+"_"+s,s++;if(e!=o){t.id=o;var n=i.getElementById(e);n&&n.set("id",o)}this.page.json.moduleList[t.id]=t}.bind(this)),delete e;var o=this.page.node,s="bottom",n=this.page;if(this.page.currentSelectedModule){var a=this.page.currentSelectedModule;o=a.node,n=a,"container"!=a.moduleType&&"page"!=a.moduleType&&(s="after",n=a.parentContainer)}for(var r=i.getFirst();r;){r.inject(o,s);var l=this.page.getDomjson(r);module=this.page.loadModule(l,r,n),module._setEditStyle_custom("id"),module.selected(),r=i.getFirst()}i.destroy(),delete i}},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},openPage:function(){this.initOptions(),this.loadNodes(),this.loadToolbar(),this.loadPageNode(),this.loadProperty(),this.loadTools(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadPage(),this.toolbarContentNode&&(this.setScrollBar(this.toolbarContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}}),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.propertyDomScrollArea,{style:"default",where:"before",distance:30,friction:4,indent:!1,axis:{x:!1,y:!0}})}.bind(this)))},initOptions:function(){this.toolsData=null,this.toolbarMode="all",this.tools=[],this.toolbarDecrease=0,this.designNode=null,this.page=null},loadNodes:function(){this.toolbarNode=new Element("div",{styles:this.css.toolbarNode,events:{selectstart:function(t){t.preventDefault()}}}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.pageNode=new Element("div",{styles:this.css.pageNode}).inject(this.node),"bottom"==this.options.style&&this.propertyNode.inject(this.pageNode,"after")},loadToolbar:function(){this.toolbarTitleNode=new Element("div",{styles:this.css.toolbarTitleNode,text:MWF.APPPD.LP.tools}).inject(this.toolbarNode),this.toolbarTitleActionNode=new Element("div",{styles:this.css.toolbarTitleActionNode,events:{click:function(t){this.switchToolbarMode()}.bind(this)}}).inject(this.toolbarNode),this.toolbarContentNode=new Element("div",{styles:this.css.toolbarContentNode,events:{selectstart:function(t){t.preventDefault(),t.stopPropagation()}}}).inject(this.toolbarNode)},switchToolbarMode:function(){if("all"==this.toolbarMode){var t=this.toolbarNode.getSize();this.toolbarDecrease=t.x.toFloat()-60,this.tools.each((function(t){t.getLast().setStyle("display","none")})),this.toolbarTitleNode.set("text",""),this.toolbarNode.setStyle("width","60px");var e=this.pageNode.getStyle("margin-left").toFloat();e-=this.toolbarDecrease,this.pageNode.setStyle("margin-left",e+"px"),this.toolbarTitleActionNode.setStyles(this.css.toolbarTitleActionNodeRight),this.toolbarMode="simple"}else{sizeX=60+this.toolbarDecrease;e=this.pageNode.getStyle("margin-left").toFloat();e+=this.toolbarDecrease,this.toolbarNode.setStyle("width",sizeX+"px"),this.pageNode.setStyle("margin-left",e+"px"),this.tools.each((function(t){t.getLast().setStyle("display","block")})),this.toolbarTitleNode.set("text",MWF.APPPD.LP.tools),this.toolbarTitleActionNode.setStyles(this.css.toolbarTitleActionNode),this.toolbarMode="all"}},loadPageNode:function(){this.pageToolbarNode=new Element("div",{styles:this.css.pageToolbarNode}).inject(this.pageNode),this.loadPageToolbar(),this.pageContentNode=new Element("div",{styles:this.css.pageContentNode}).inject(this.pageNode),this.loadPageContent(function(){this.designDcoument&&this.designDcoument.body.setStyles(this.css.designBody),this.designNode&&this.designNode.setStyles(this.css.designNode)}.bind(this))},loadDesignerActionNode:function(){this.pcDesignerActionNode=this.pageToolbarNode.getElement("#MWFPCDesignerAction"),this.mobileDesignerActionNode=this.pageToolbarNode.getElement("#MWFMobileDesignerAction"),this.currentDesignerMode="PC",this.pcDesignerActionNode.setStyles(this.css.designerActionNode_current),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode);new Element("div",{styles:this.css.designerActionPcIconNode}).inject(this.pcDesignerActionNode);new Element("div",{styles:this.css.designerActionMobileIconNode}).inject(this.mobileDesignerActionNode);new Element("div",{styles:this.css.designerActiontextNode,text:"PC"}).inject(this.pcDesignerActionNode);new Element("div",{styles:this.css.designerActiontextNode,text:"Mobile"}).inject(this.mobileDesignerActionNode),this.pcDesignerActionNode.addEvent("click",function(){"PC"!=this.currentDesignerMode&&this.changeDesignerModeToPC()}.bind(this)),this.mobileDesignerActionNode.addEvent("click",function(){"PC"==this.currentDesignerMode&&this.changeDesignerModeToMobile()}.bind(this))},changeDesignerModeToPC:function(){if(this.pcDesignerActionNode.setStyles(this.css.designerActionNode_current),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode),this.designMobileNode.setStyle("display","none"),this.designNode.setStyle("display","block"),this.page.currentSelectedModule){if(this.page.currentSelectedModule==this)return!0;this.page.currentSelectedModule.unSelected()}this.page.propertyMultiTd&&(this.page.propertyMultiTd.hide(),this.page.propertyMultiTd=null),this.page.unSelectedMulti(),this.page.designTabPageScriptAreaNode&&this.page.designTabPageScriptAreaNode.hide(),this.page=this.pcPage,(this.scriptPage&&this.scriptPage.isShow||this.scriptPanel)&&this.loadAllScript(),this.currentDesignerMode="PC"},changeDesignerModeToMobile:function(){if(this.pcDesignerActionNode.setStyles(this.css.designerActionNode),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode_current),this.designMobileNode.setStyle("display","block"),this.designNode.setStyle("display","none"),this.page.currentSelectedModule){if(this.page.currentSelectedModule==this)return!0;this.page.currentSelectedModule.unSelected()}this.page.propertyMultiTd&&(this.page.propertyMultiTd.hide(),this.page.propertyMultiTd=null),this.page.unSelectedMulti(),this.mobilePage||(this.designMobileNode.set("id","designMobileNode"),this.mobilePage=new MWF.PCPage(this,this.designMobileNode,{mode:"Mobile"}),Object.keys(this.pageMobileData.json.moduleList).length||(this.pageMobileData=Object.clone(this.pageData)),this.mobilePage.load(this.pageMobileData)),this.page.designTabPageScriptAreaNode&&this.page.designTabPageScriptAreaNode.hide(),this.page=this.mobilePage,(this.scriptPage&&this.scriptPage.isShow||this.scriptPanel)&&this.loadAllScript(),this.currentDesignerMode="Mobile"},loadPageToolbar:function(t){this.getToolbarHTML(function(e){e.getElements("span").each(function(t,e){var i=t.get("MWFButtonImage");i&&t.set("MWFButtonImage",this.path+""+this.options.style+"/pageToolbar/"+i)}.bind(this)),$(e).inject(this.pageToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.pageToolbar=new MWF.widget.Toolbar(e,{style:"ProcessCategory"},this),this.pageToolbar.load(),this.loadDesignerActionNode(),t&&t()}.bind(this))}.bind(this))},getToolbarHTML:function(t){var e=this.path+this.options.style+"/pageToolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,i,o,s){var n=e[0];t&&t(n)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},loadPageContent:function(t){MWF.require("MWF.widget.Tab",null,!1),this.designTabNode=new Element("div").inject(this.pageContentNode),this.designTab=new MWF.widget.Tab(this.designTabNode,{style:"design"}),this.designTab.load(),this.designTabPageAreaNode=Element("div"),this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.designTabPageAreaNode),this.designMobileNode=new Element("div",{styles:this.css.designMobileNode}).inject(this.designTabPageAreaNode),this.designTabScriptAreaNode=Element("div",{styles:this.css.designTabScriptAreaNode}),this.designPage=this.designTab.addTab(this.designTabPageAreaNode,this.lp.design),this.scriptPage=this.designTab.addTab(this.designTabScriptAreaNode,this.lp.script),this.setScriptPageEvent(),this.designPage.showTabIm(),this.scriptPage.addEvent("postShow",function(){this.checkLoadAllScript(),this.fireEvent("resize")}.bind(this)),this.designPage.addEvent("postShow",function(){this.fireEvent("resize")}.bind(this))},createScriptPanel:function(t,e){MWF.require("MWF.widget.Panel",function(){this.scriptPanel=new MWF.widget.Panel(this.designTabScriptAreaNode,{title:this.lp.script,minLeft:"500",minTop:"1",style:"page",target:this.content,limitMove:!1,isClose:!1,width:e.x,height:e.y,top:t.y,left:t.x,onPostLoad:function(){this.loadAllScript(),this.fireEvent("resize")}.bind(this),onResize:function(){this.fireEvent("resize")}.bind(this),onDrag:function(t,e){t.getStyle("top").toInt()<0&&t.setStyle("top","0px"),this.scriptPage.tab.tabNodeContainer.isOutside(e)?(this.scriptPage.tabNode.hide(),this.scriptPanel.container.setStyle("opacity","1")):(this.scriptPage.tabNode.show(),this.scriptPanel.container.setStyle("opacity","0.5"))}.bind(this),onCompleteMove:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)||(this.scriptPage.tabNode.show(),this.designTabScriptAreaNode.inject(this.designTab.contentNodeContainer.getLast()),this.fireEvent("resize"),this.scriptPage.showTabIm(),this.scriptPanel.closePanel(),this.scriptPanel=null)}.bind(this)}),this.scriptPanel.load()}.bind(this))},createScriptPageDragNode:function(t){var e=this.scriptPage.tab.contentNodeContainer.getSize(),i=this.scriptPage.tab.contentNodeContainer.getPosition(this.content);if(!this.scriptPageContentDrag){var o=new Element("div",{styles:this.css.scriptPageDragNode}).inject(this.content);this.scriptPageContentDrag=new Drag.Move(o,{droppables:[this.scriptPage.tab.tabNodeContainer],onEnter:function(e,i){this.scriptPage.tabNode.show(),this.designTabScriptAreaNode.show(),this.scriptPageContentDrag=null,o.destroy(),this.scriptPageDrag.start(t)}.bind(this),onComplete:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)&&(this.createScriptPanel(o.getPosition(this.content),o.getSize()),this.designPage.showTabIm()),this.scriptPageContentDrag=null,o&&o.destroy(),this.designTabScriptAreaNode.show()}.bind(this)})}var s=this.scriptPage.tabNode.getPosition(),n=t.page.x-s.x,a=t.page.y-s.y;this.scriptPage.tabNode.hide(),this.designTabScriptAreaNode.hide();var r=.7*e.x,l=.7*e.y,h=i.x+n,d=i.y+a-20;o.setStyles({width:r+"px",height:l+"px",top:d+"px",left:h+"px"}),this.scriptPageContentDrag.start(t)},setScriptPageEvent:function(){this.scriptPageDrag=new Drag(this.scriptPage.tabNode,{snap:20,onStart:function(t,e){t.setStyle("position","static")},onDrag:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)&&(this.scriptPageDrag.stop(),t.setStyle("left","auto"),this.createScriptPageDragNode(e))}.bind(this),onComplete:function(t){t.setStyle("left","auto")}.bind(this)})},checkLoadAllScript:function(){this.page||this.form?this.loadAllScript():this.designPage.showTabIm()},loadAllScript:function(){var t=this.page||this.form;t.designTabPageScriptAreaNode||(t.designTabPageScriptAreaNode=Element("div",{styles:this.css.designTabScriptPcAreaNode}).inject(this.designTabScriptAreaNode)),t.designTabPageScriptAreaNode.show(),t.scriptDesigner||MWF.xDesktop.requireApp("portal.PageDesigner","Script",function(){t.scriptDesigner=new MWF.xApplication.portal.PageDesigner.Script(this,t.designTabPageScriptAreaNode,t.json)}.bind(this))},loadAllPcScript:function(){this.pcScriptDesigner||MWF.xDesktop.requireApp("portal.PageDesigner","Script",function(){this.pcScriptDesigner=new MWF.xApplication.portal.PageDesigner.Script(this,this.designTabScriptPcAreaNode,this.pageData.json)}.bind(this))},loadAllMobileScript:function(){},reloadPropertyStyles:function(){this.css=null,this.cssPath="../x_component_"+this.options.name.replace(/\./g,"_")+"/$Main/"+this.options.style+"/css.wcss",this._loadCss(),"bottom"==this.options.style?(this.propertyNode.inject(this.pageNode,"after"),this.propertyTitleNode.setStyle("cursor","row-resize"),this.loadPropertyResizeBottom()):(this.propertyNode.inject(this.pageNode,"before"),this.propertyTitleNode.setStyle("cursor","default"),this.propertyResizeBottom&&this.propertyResizeBottom.detach()),this.pageNode.clearStyles(!1),this.pageNode.setStyles(this.css.pageNode),this.propertyNode.clearStyles(!1),this.propertyNode.setStyles(this.css.propertyNode),this.propertyTitleNode.clearStyles(!1),this.propertyTitleNode.setStyles(this.css.propertyTitleNode),this.propertyResizeBar.clearStyles(!1),this.propertyResizeBar.setStyles(this.css.propertyResizeBar),this.propertyContentNode.clearStyles(!1),this.propertyContentNode.setStyles(this.css.propertyContentNode),this.propertyDomContentArea.clearStyles(!1),this.propertyDomContentArea.setStyles(this.css.propertyDomContentArea),this.propertyDomScrollArea.clearStyles(!1),this.propertyDomScrollArea.setStyles(this.css.propertyDomScrollArea),this.propertyDomArea.clearStyles(!1),this.propertyDomArea.setStyles(this.css.propertyDomArea),this.propertyContentArea.clearStyles(!1),this.propertyContentArea.setStyles(this.css.propertyContentArea),this.propertyContentResizeNode.clearStyles(!1),this.propertyContentResizeNode.setStyles(this.css.propertyContentResizeNode),this.propertyTitleActionNode.clearStyles(!1),this.propertyTitleActionNode.setStyles(this.css.propertyTitleActionNode),this.resizeNode()},loadProperty:function(){this.propertyTitleActionNode=new Element("div",{styles:this.css.propertyTitleActionNode}).inject(this.propertyNode),this.propertyTitleActionNode.addEvent("click",function(){this.options.style="default"==this.options.style?"bottom":"default",MWF.UD.putData("pageDesignerStyle",{style:this.options.style}),this.reloadPropertyStyles()}.bind(this)),this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:MWF.APPPD.LP.property}).inject(this.propertyNode),"bottom"==this.options.style&&(this.propertyTitleNode.setStyle("cursor","row-resize"),this.loadPropertyResizeBottom()),this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyDomContentArea=new Element("div",{styles:this.css.propertyDomContentArea}).inject(this.propertyContentNode),this.propertyDomScrollArea=new Element("div",{styles:this.css.propertyDomScrollArea}).inject(this.propertyDomContentArea),this.propertyDomArea=new Element("div",{styles:this.css.propertyDomArea}).inject(this.propertyDomScrollArea),this.propertyDomPercent=.4,this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize()},loadPropertyResizeBottom:function(){this.propertyResizeBottom?this.propertyResizeBottom.attach():this.propertyResizeBottom=new Drag(this.propertyTitleNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyNode.getSize();t.store("initialWidth",s.x),t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientY:e.event.y,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialHeight").toFloat()+(s.y.toFloat()-i.toFloat());n>o.y/1.5&&(n=o.y/1.5),n<40&&(n=40);var a=1-n/o.y;this.resizeNode(a)}.bind(this)})},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialWidth").toFloat()+(s.x.toFloat()-i.toFloat());n>o.x/2&&(n=o.x/2),n<40&&(n=40),this.pageNode.setStyle("margin-right",n+1),this.propertyNode.setStyle("width",n)}.bind(this)})},propertyResizeDragTopBottom:function(t,e){var i=this.propertyContentNode.getSize(),o=e.event.y,s=t.retrieve("position"),n=o.toFloat()-s.y.toFloat(),a=t.retrieve("initialHeight").toFloat()+n;a<40&&(a=40),a>i.y-40&&(a=i.y-40),this.propertyDomPercent=a/i.y,this.setPropertyContentResize()},propertyResizeDragLeftRight:function(t,e){var i=this.propertyContentNode.getSize(),o="firefox"==Browser.name?e.event.clientX:e.event.x,s=t.retrieve("position"),n=o.toFloat()-s.x.toFloat(),a=t.retrieve("initialWidth").toFloat()+n;a<40&&(a=40),a>i.x-40&&(a=i.x-40),this.propertyDomPercent=a/i.x,this.setPropertyContentResizeBottom()},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyDomContentArea.getSize();t.store("initialHeight",s.y),t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){"bottom"==this.options.style?this.propertyResizeDragLeftRight(t,e):this.propertyResizeDragTopBottom(t,e)}.bind(this)})},setPropertyContentResizeBottom:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),i=t.x-e.x-6,o=this.propertyDomPercent*i,s=o+e.x+6;this.propertyDomContentArea.setStyle("width",o+"px"),this.propertyContentArea.setStyle("margin-left",s+"px")},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),i=t.y-e.y,o=this.propertyDomPercent*i,s=i-o;if(this.propertyDomContentArea.setStyle("height",o+"px"),this.propertyDomScrollArea.setStyle("height",o+"px"),this.propertyContentArea.setStyle("height",s+"px"),this.page&&this.page.currentSelectedModule&&this.page.currentSelectedModule.property){var n=this.page.currentSelectedModule.property.propertyTab;if(n){var a=n.tabNodeContainer.getSize();n.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),o=s-e-i-a.y.toFloat()-15;t.contentNodeArea.setStyle("height",o)}.bind(this))}}},loadTools:function(){var t=this;this.getTools(function(){Object.each(this.toolsData,function(e,i){var o=new Element("div",{styles:this.css.toolbarToolNode,title:e.text,events:{mouseover:function(e){try{this.setStyles(t.css.toolbarToolNodeOver)}catch(e){this.setStyles(t.css.toolbarToolNodeOverCSS2)}},mouseout:function(e){try{this.setStyles(t.css.toolbarToolNode)}catch(e){}},mousedown:function(e){try{this.setStyles(t.css.toolbarToolNodeDown)}catch(e){this.setStyles(t.css.toolbarToolNodeDownCSS2)}},mouseup:function(e){try{this.setStyles(t.css.toolbarToolNodeUp)}catch(e){this.setStyles(t.css.toolbarToolNodeUpCSS2)}}}}).inject(this.toolbarContentNode);o.store("toolClass",e.className),new Element("div",{styles:this.css.toolbarToolIconNode}).inject(o).setStyle("background-image","url("+this.path+this.options.style+"/icon/"+e.icon+")"),new Element("div",{styles:this.css.toolbarToolTextNode,text:e.text}).inject(o),o.addEvent("mousedown",(function(e){var i=this.retrieve("toolClass");t.page.createModule(i,e)})),this.tools.push(o)}.bind(this))}.bind(this))},getTools:function(t){if(this.toolsData)t&&t();else{var e=this.path+this.options.style+"/tools.json";new Request.JSON({url:e,secure:!1,async:!1,method:"get",noCache:!0,onSuccess:function(e,i){this.toolsData=e,t&&t()}.bind(this),onError:function(t,e){this.notice("request tools data error: "+e,"error")}.bind(this)}).send()}},resizeNodeLeftRight:function(){var t=this.node.getSize();this.toolbarNode.setStyle("height",t.y+"px"),this.pageNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var e=this.pageToolbarNode.getStyle("margin-top").toFloat(),i=this.pageToolbarNode.getStyle("margin-bottom").toFloat(),o=this.pageToolbarNode.getComputedSize(),s=t.y-o.totalHeight-e-i;this.pageContentNode.setStyle("height",s+"px");var n=this.designTab.tabNodeContainer.getComputedSize(),a=this.designTab.tabNodeContainer.getStyle("margin-top").toFloat(),r=this.designTab.tabNodeContainer.getStyle("margin-bottom").toFloat();(s=s-n.totalHeight-a-r,this.designTab.contentNodeContainer.setStyle("height",s+"px"),this.designNode)&&(s=s-this.designNode.getStyle("margin-top").toFloat()-this.designNode.getStyle("margin-bottom").toFloat(),this.designNode.setStyle("height",s+"px"));var l=this.toolbarTitleNode.getSize(),h=this.toolbarTitleNode.getStyle("margin-top").toFloat(),d=this.toolbarTitleNode.getStyle("margin-bottom").toFloat(),p=this.toolbarTitleNode.getStyle("padding-top").toFloat(),c=this.toolbarTitleNode.getStyle("padding-bottom").toFloat();s=l.y+h+d+p+c,s=t.y-s,this.toolbarContentNode.setStyle("height",s+"px"),l=this.propertyTitleNode.getSize(),h=this.propertyTitleNode.getStyle("margin-top").toFloat(),d=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),p=this.propertyTitleNode.getStyle("padding-top").toFloat(),c=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),s=l.y+h+d+p+c,s=t.y-s,this.propertyContentNode.setStyle("height",s+"px"),this.propertyResizeBar.setStyle("height",s+"px")},resizeNodeTopBottom:function(t){var e=this.node.getSize();this.toolbarNode.setStyle("height",e.y+"px");var i=t||.6,o=e.y*i,s=e.y-o;this.pageNode.setStyle("height",o+"px"),this.propertyNode.setStyle("height",s+"px");var n=this.pageToolbarNode.getStyle("margin-top").toFloat(),a=this.pageToolbarNode.getStyle("margin-bottom").toFloat(),r=o-this.pageToolbarNode.getComputedSize().totalHeight-n-a,l=this.designTab.tabNodeContainer.getComputedSize(),h=this.designTab.tabNodeContainer.getStyle("margin-top").toFloat(),d=this.designTab.tabNodeContainer.getStyle("margin-bottom").toFloat();if(r=r-l.totalHeight-h-d,this.designTab.contentNodeContainer.setStyle("height",r+"px"),this.designNode){var p=this.designNode.getStyle("margin-top").toFloat(),c=this.designNode.getStyle("margin-bottom").toFloat();r=r-p-c,this.designNode.setStyle("height",r+"px")}var g=this.toolbarTitleNode.getSize(),y=this.toolbarTitleNode.getStyle("margin-top").toFloat(),u=this.toolbarTitleNode.getStyle("margin-bottom").toFloat(),b=this.toolbarTitleNode.getStyle("padding-top").toFloat(),m=this.toolbarTitleNode.getStyle("padding-bottom").toFloat();if(r=g.y+y+u+b+m,r=e.y-r,this.toolbarContentNode.setStyle("height",r+"px"),g=this.propertyTitleNode.getSize(),y=this.propertyTitleNode.getStyle("margin-top").toFloat(),u=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),b=this.propertyTitleNode.getStyle("padding-top").toFloat(),m=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),r=s-(r=g.y+y+u+b+m),this.propertyContentNode.setStyle("height",r+"px"),this.propertyResizeBar.setStyle("height",r+"px"),this.propertyDomContentArea.setStyle("height",r+"px"),this.propertyDomScrollArea.setStyle("height",r+"px"),this.propertyContentResizeNode.setStyle("height",r+"px"),this.propertyContentArea.setStyle("height",r+"px"),this.page&&this.page.currentSelectedModule&&this.page.currentSelectedModule.property){var N=this.page.currentSelectedModule.property.propertyTab;if(N){var P=N.tabNodeContainer.getSize();N.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),o=r-e-i-P.y.toFloat()-15;t.contentNodeArea.setStyle("height",o)}.bind(this))}}},resizeNode:function(t){"bottom"==this.options.style?(this.resizeNodeTopBottom(t),this.setPropertyContentResizeBottom()):(this.resizeNodeLeftRight(t),this.setPropertyContentResize())},loadPage:function(){this.getPageData(function(){this.pcPage=new MWF.PCPage(this,this.designNode,{onPostLoad:function(){this.fireEvent("postPageLoad")}.bind(this)}),this.pcPage.load(this.pageData),this.page=this.pcPage}.bind(this))},getPageData:function(t){this.options.id?this.loadPageData(t):this.options.templateId?this.loadNewPageDataFromTemplate(t):this.loadNewPageData(t)},loadNewPageData:function(t){var e="../x_component_portal_PageDesigner/Module/Page/template/"+this.options.template;MWF.getJSON(e,{onSuccess:function(e){this.pageData=e.pcData,this.pageData.id="",this.pageData.isNewPage=!0,this.pageMobileData=e.mobileData,this.pageMobileData.id="",this.pageMobileData.isNewPage=!0,t&&t()}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},getPageTemplate:function(t,e){this.actions.getPageTemplate(t,function(t){e&&e(t)}.bind(this))},loadNewPageDataFromTemplate:function(t){this.getPageTemplate(this.options.templateId,function(e){e&&(this.pageData=JSON.decode(MWF.decodeJsonString(e.data.data)),this.pageData.isNewPage=!0,this.pageData.json.id="",e.data.mobileData?(this.pageMobileData=JSON.decode(MWF.decodeJsonString(e.data.mobileData)),this.pageMobileData.isNewPage=!0,this.pageMobileData.json.id=""):this.pageMobileData=Object.clone(this.pageData),t&&t())}.bind(this))},getPage:function(t,e){this.actions.getPage(t,function(t){e&&e(t)}.bind(this))},getApplication:function(t,e){this.actions.getApplication(t,function(t){e&&e(t)}.bind(this))},loadPageData:function(t){this.getPage(this.options.id,function(e){e&&(this.pageData=JSON.decode(MWF.decodeJsonString(e.data.data)),this.pageData.isNewPage=!1,this.pageData.json.id=e.data.id,e.data.mobileData?(this.pageMobileData=JSON.decode(MWF.decodeJsonString(e.data.mobileData)),this.pageMobileData.isNewPage=!1,this.pageMobileData.json.id=e.data.id):this.pageMobileData=Object.clone(this.pageData),this.setTitle(this.options.appTitle+"-"+this.pageData.json.name),this.taskitem&&this.taskitem.setText(this.options.appTitle+"-"+this.pageData.json.name),this.options.appTitle=this.options.appTitle+"-"+this.pageData.json.name,this.application?t&&t():this.getApplication(e.data.portal,function(e){this.application={name:e.data.name,id:e.data.id},t&&t()}.bind(this)))}.bind(this))},getFieldList:function(){return dataTypes={string:["htmledit","radio","select","textarea","textfield"],person:["personfield","org"],date:["calender"],number:["number"],array:["checkbox"]},fieldList=[],this.pcPage.moduleList.each(function(t){var e="";for(k in dataTypes)if(-1!=dataTypes[k].indexOf(t.moduleName.toLowerCase())){e=k;break}e&&fieldList.push({name:t.json.id,dataType:e})}.bind(this)),fieldList},getWidgetList:function(t){return widgetList=[],Object.each(t.moduleList,function(t){"widget"==t.type.toLowerCase()&&"select"==t.widgetType&&t.widgetSelected&&widgetList.push(t.widgetSelected)}.bind(this)),widgetList},saveForm:function(){this.savePage()},_savePage:function(t,e,i,o,s){this.actions.savePage(t,e,i,function(t){o(t)}.bind(this),function(t,e,i){s(t,e,i)}.bind(this))},savePage:function(){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.lp.isSave);else{var t,e;this.pcPage&&(this.pcPage._getPageData(),this.pcPage.json.widgetList=this.getWidgetList(this.pcPage.json),t=this.pcPage.data),this.mobilePage?(this.mobilePage._getPageData(),this.mobilePage.json.widgetList=this.getWidgetList(this.mobilePage.json),e=this.mobilePage.data):this.pageMobileData&&(e=this.pageMobileData),this.isSave=!0;var i=this.getFieldList();this._savePage(t,e,i,function(i){this.notice(MWF.APPPD.LP.notice.save_success,"ok",null,{x:"left",y:"bottom"}),this.pcPage.json.name||this.pcPage.treeNode.setText("<"+this.json.type+"> "+this.json.id),this.pcPage.treeNode.setTitle(this.pcPage.json.id),this.pcPage.node.set("id",this.pcPage.json.id),this.mobilePage&&(this.mobilePage.json.name||this.mobilePage.treeNode.setText("<"+this.mobilePage.json.type+"> "+this.mobilePage.json.id),this.mobilePage.treeNode.setTitle(this.mobilePage.json.id),this.mobilePage.node.set("id",this.mobilePage.json.id+"_"+this.options.mode));var o=this.pcPage.json.name;this.pcPage.data.isNewPage&&this.setTitle(this.options.appTitle+"-"+o),this.pcPage.data.isNewPage=!1,this.mobilePage&&(this.mobilePage.data.isNewPage=!1),this.options.desktopReload=!0,this.options.id=this.pcPage.json.id,t&&(t.isNewPage=!1),e&&(e.isNewPage=!1),this.isSave=!1}.bind(this),function(t,e,i){this.isSave=!1;var o=i+":"+e;t&&(o=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+o)}.bind(this))}},previewPage:function(){this.savePage(),this.page.preview()},printPage:function(){this.previewPage()},pageExplode:function(){this.page.explode()},pageImplode:function(){this.page.implode()},htmlImplode:function(){this.page.implodeHTML()},officeImplode:function(){this.page.implodeOffice()},pageHelp:function(){},recordStatus:function(){return{id:this.options.id}},onPostClose:function(){this.pcPage&&(MWF.release(this.pcPage.moduleList),MWF.release(this.pcPage.moduleNodeList),MWF.release(this.pcPage.moduleContainerNodeList),MWF.release(this.pcPage.moduleElementNodeList),MWF.release(this.pcPage.moduleComponentNodeList),MWF.release(this.pcPage)),this.mobilePage&&(MWF.release(this.mobilePage.moduleList),MWF.release(this.mobilePage.moduleNodeList),MWF.release(this.mobilePage.moduleContainerNodeList),MWF.release(this.mobilePage.moduleElementNodeList),MWF.release(this.mobilePage.moduleComponentNodeList),MWF.release(this.mobilePage))},setTemplatePageNode:function(t){var e='<table align="center" width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0"><tr><td colSpan="2" style="height: 50px; line-height: 60px; text-align: center; font-size: 24px; font-weight: bold">'+this.lp.saveTemplate+'</td></tr><tr><td style="height: 40px;" width="80px">'+this.lp.templateName+'</td><td><input value="'+this.pcPage.json.name+'" type="text" style="width: 98%; height: 22px; border: 1px solid #cccccc"/></td></tr><tr><td style="height: 40px;">'+this.lp.templateCategory+'</td><td><select style="width: 30%; height: 24px; border: 1px solid #cccccc"></select><input type="text" style="width: 68%; height: 22px; border: 1px solid #cccccc"/></td></tr><tr><td style="height: 40px;">'+this.lp.templateDescription+'</td><td><textarea type="text" style="width: 98%; height: 44px; border: 1px solid #cccccc">'+this.pcPage.json.description+'</textarea></td></tr><tr><td colSpan="2" id="page_templatePreview"><div style="position: relative; width: 180px; height: 180px; margin: 20px auto 0px auto;  overflow: hidden"></div></td></tr></table>';t.set("html",e);var i=t.getElements("td"),o=i[i.length-1].getFirst();return this.pcPage.node.clone().setStyles({"transform-origin":"0px 0px",transform:"scale(0.15,0.15)",position:"absolute",top:"0px",left:"0px"}).inject(o),o},setCategorySelect:function(t){t&&(new Element("option",{value:"$newCategory",text:this.lp.newCategory}).inject(t),this.actions.listPageTemplateCategory(function(e){e.data.each(function(e){new Element("option",{value:e.name,text:e.name}).inject(t)}.bind(this))}.bind(this)))},setTemplateActions:function(t,e,i,o,s,n,a,r){var l=new Element("div",{styles:this.css.templateActionNode}).inject(i);new Element("div",{styles:this.css.templateCancelActionNode,text:this.lp.cancel,events:{click:function(){t.destroy(),e.destroy()}}}).inject(l),new Element("div",{styles:this.css.templateSaveActionNode,text:this.lp.save,events:{click:function(){this.saveTemplate(t,e,o,s,n,a,r)}.bind(this)}}).inject(l)},addPageTemplate:function(t,e,i,o,s){this.actions.addPageTemplate(t,e,i,function(t){o&&o(t)}.bind(this),function(t,e,i){s&&s(t,e,i)}.bind(this))},saveTemplate:function(t,e,i,o,s,n,a){var r,l;this.pcPage&&(this.pcPage._getPageData(),r=this.pcPage.data),this.mobilePage&&(this.mobilePage._getPageData(),l=this.mobilePage.data);var h=o.get("value"),d="$newCategory"==s.options[s.selectedIndex].value?n.get("value"):s.options[s.selectedIndex].value,p=a.get("value");if(!h)return this.notice(MWF.APPPD.LP.notice.saveTemplate_inputName,"error",o,{x:"left",y:"top"}),!1;if("$newCategory"==s.options[s.selectedIndex].value&&!n.get("value"))return this.notice(MWF.APPPD.LP.notice.saveTemplate_inputCategory,"error",s,{x:"left",y:"top"}),!1;var c={name:h,category:d,description:p,outline:i.get("html")};this.addPageTemplate(r,l,c,function(){this.notice(MWF.APPPD.LP.notice.saveTemplate_success,"ok",null,{x:"left",y:"bottom"}),t.destroy(),e.destroy()}.bind(this),(function(t,e,i){var o=i+":"+e;t&&(o=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+o)}))},createTemplateSaveNode:function(){var t=new Element("div",{styles:this.css.templateMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.content),e=new Element("div",{styles:this.css.templateAreaNode}).inject(this.content),i=new Element("div",{styles:this.css.templateInfoNode}).inject(e),o=new Element("div",{styles:this.css.templatePageNode}).inject(i),s=this.setTemplatePageNode(o),n=o.getElements("input"),a=n[0],r=n[1],l=o.getElement("textarea"),h=o.getElement("select");this.setCategorySelect(h),this.setTemplateActions(t,e,o,s,a,h,r,l)},savePageAsTemplate:function(){this.isSave?MWF.xDesktop.notice("info",{x:"right",y:"top"},this.lp.isSave):this.createTemplateSaveNode()},styleBrush:function(t,e){if("on"===t){var i=this.page.currentSelectedModule;i&&"Form"!==i.json.type?(this.page.brushStyle=i.json.styles,this.brushCursor=new Element("div",{styles:{position:"absolute",width:"16px",height:"16px","z-index":2e4,background:"url("+this.path+this.options.style+"/pageToolbar/wand.png)"}}).inject(this.content),this.brushCursorMoveFun=this.brushCursorMove.bind(this),this.contentPosition=this.content.getPosition(),this.content.addEvent("mousemove",this.brushCursorMoveFun)):e.off()}else this.page.brushStyle=null,this.brushCursorMoveFun&&this.content.removeEvent("mousemove",this.brushCursorMoveFun),this.brushCursor&&(this.brushCursor.destroy(),this.brushCursor=null)},brushCursorMove:function(t){if(this.brushCursor){var e=t.page.x-this.contentPosition.x+10,i=t.page.y-this.contentPosition.y+10;this.brushCursor.setStyles({left:e+"px",top:i+"px"})}}});