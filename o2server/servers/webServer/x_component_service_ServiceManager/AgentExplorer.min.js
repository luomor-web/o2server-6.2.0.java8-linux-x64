MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,!1),MWF.xApplication.service.ServiceManager.AgentExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.service.ServiceManager.LP.agent.create,search:MWF.xApplication.service.ServiceManager.LP.agent.search,searchText:MWF.xApplication.service.ServiceManager.LP.agent.searchText,noElement:MWF.xApplication.service.ServiceManager.LP.agent.noAgentNoticeText}},openFindDesigner:function(){layout.openApplication(null,"FindDesigner",{filter:{moduleList:["service"]}})},createCreateElementNode:function(){MWF.AC.isServiceManager()&&(this.createElementNode=new Element("div",{styles:this.css.createElementNode,title:this.options.tooltip.create}).inject(this.toolbarNode),this.createElementNode.addEvent("click",function(e){this._createElement(e)}.bind(this)))},createTitleElementNode:function(){this.titleElementNode=new Element("div",{styles:this.css.titleElementNode,text:MWF.xApplication.service.ServiceManager.LP.agentConfig}).inject(this.toolbarNode)},_createElement:function(e){var t=this,i={onQueryLoad:function(){this.actions=t.app.restActions,this.application=t.app.options.application,this.explorer=t}};this.app.desktop.openApplication(e,"service.AgentDesigner",i)},loadElementList:function(){if(MWF.AC.isServiceManager())this._loadItemDataList(function(e){e.data.length?e.data.each(function(e){this._getItemObject(e).load()}.bind(this)):new Element("div.noElementNode",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode).addEvent("click",function(e){this._createElement(e)}.bind(this));this.isSetContentSize||(this.setContentSize(),this.isSetContentSize=!0)}.bind(this));else new Element("div.noElementNode",{styles:this.css.noElementNode,text:MWF.xApplication.service.ServiceManager.LP.agent.noPermission}).inject(this.elementContentListNode)},_loadItemDataList:function(e){this.app.restActions.listAgent(e)},_getItemObject:function(e){return new MWF.xApplication.service.ServiceManager.AgentExplorer.Agent(this,e)},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteAgent():e.deleteAgent(function(){}.bind(this))}},keyCopy:function(e){if(this.selectMarkItems.length){var t=[],i=0,n=function(e){if(i>=this.selectMarkItems.length&&t.length){var n=JSON.encode(t);e?e.clipboardData.setData("text/plain",n):window.clipboardData.setData("Text",n),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(s){this.app.restActions.getAgent(s.data.id,function(s){s.data.elementType="agent",t.push(s.data),i++,n(e)}.bind(this),null,!1)}.bind(this)),e&&e.preventDefault()}},keyPaste:function(e){var t="";t=e?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(t);this.pasteItem(i,0)},pasteItem:function(e,t){if(t<e.length){var i=e[t];"agent"===i.elementType?this.saveItemAs(i,function(){t++,this.pasteItem(e,t)}.bind(this),function(){t++,this.pasteItem(e,t)}.bind(this),function(){this.reload()}.bind(this)):(t++,this.pasteItem(e,t))}else this.reload()},saveItemAs:function(e,t,i,n){this.app.restActions.listAgent(function(s){var o=s.data.filter((function(t){return t.id===e.id}));if(o.length){var a=o[0],c=this.app.lp,r=this,l=(new Date).parse(e.lastUpdateTime),d=(new Date).parse(a.lastUpdateTime),p="<div>"+c.copyConfirmInfor+"</div>";p+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+c.copySource+" "+a.name+"</div>",p+="<div style='font-size:12px; color: #666666; float: left'>"+a.updateTime+"</div><div style='color: red; float: right;'>"+(l>=d?"":c.copynew)+"</div></div>",p+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+c.copyTarget+" "+e.name+"</div>",p+="<div style='font-size:12px; color: #666666; float: left;'>"+e.updateTime+"</div><div style='color: red; float: right;'>"+(l<=d?"":c.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:p},500,290,[{text:c.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(a,e,t,i),this.close()}},{text:c.copyConfirm_new,action:function(){r.saveItemAsNew(s,e,t,i),this.close()}},{text:c.copyConfirm_skip,action:function(){this.close(),t&&t()}},{text:c.copyConfirm_cancel,action:function(){this.close(),n&&n()}}])}else this.saveItemAsNew(s,e,t,i)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(e,t,i,n){t.id=e.id,t.name=e.name,t.alias=e.alias,this.app.restActions.updateAgent(e.id,t,function(){i&&i()}.bind(this),function(){n&&n()}.bind(this))},saveItemAsNew:function(e,t,i,n){for(var s=t.name,o=1;e.data.some((function(e){return e.name==t.name||e.alias==t.name}));)t.name=s+"_copy"+o,t.alias=s+"_copy"+o,o++;t.id="",this.app.restActions.createAgent(t,function(){i&&i()}.bind(this),function(){n&&n()}.bind(this))}}),MWF.xApplication.service.ServiceManager.AgentExplorer.Agent=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,createActionNode:function(){this.deleteActionNode=new Element("div",{styles:this.css.deleteActionNode}).inject(this.node),this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e)}.bind(this))},createTextNodes:function(){var e=new Element("div",{styles:this.css.itemTextTitleNode,text:(this.data.enable?"":"("+MWF.xApplication.service.ServiceManager.LP.disable+")")+this.data.name,title:this.data.name,events:{click:function(e){this._open(e)}.bind(this)}}).inject(this.node);this.data.enable||e.setStyle("color","#999"),new Element("div",{styles:this.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(this.node),new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(this.node)},_open:function(e){var t=this,i={appId:"service.AgentDesigner"+t.data.id,id:t.data.id,onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id}};this.explorer.app.desktop.openApplication(e,"service.AgentDesigner",i)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'service.AgentDesigner#{"id": "'+this.data.id+'"}'}},deleteAgent:function(e){this.explorer.actions.deleteAgent(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))}});