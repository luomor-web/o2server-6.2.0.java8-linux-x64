MWF.xDesktop.requireApp("query.QueryManager","StatExplorer",null,!1),MWF.xApplication.query.QueryManager.TableExplorer=new Class({Extends:MWF.xApplication.query.QueryManager.StatExplorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.query.QueryManager.LP.table.create,search:MWF.xApplication.query.QueryManager.LP.table.search,searchText:MWF.xApplication.query.QueryManager.LP.table.searchText,noElement:MWF.xApplication.query.QueryManager.LP.table.noStatNoticeText}},initialize:function(t,e,a){this.setOptions(a),this.setTooltip(),this.path="../x_component_query_QueryManager/$Explorer/",this.cssPath="../x_component_query_QueryManager/$Explorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=e,this.node=$(t),this.initData()},openFindDesigner:function(){this.app.options.application.moduleType="query";var t={filter:{moduleList:["query"],appList:[this.app.options.application]}};layout.openApplication(null,"FindDesigner",t)},keyCopy:function(t){if(this.selectMarkItems.length){var e=[],a=0,i=function(t){if(a>=this.selectMarkItems.length&&e.length){var i=JSON.encode(e);t?t.clipboardData.setData("text/plain",i):window.clipboardData.setData("Text",i),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getTable(n.data.id,function(n){n.data.elementType="table",e.push(n.data),a++,i(t)}.bind(this),null,!1)}.bind(this)),t&&t.preventDefault()}},keyPaste:function(t){var e="";e=t?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var a=JSON.decode(e);this.pasteItem(a,0)},pasteItem:function(t,e){if(e<t.length){var a=t[e];"table"===a.elementType?this.saveItemAs(a,function(){e++,this.pasteItem(t,e)}.bind(this),function(){e++,this.pasteItem(t,e)}.bind(this),function(){this.reload()}.bind(this)):(e++,this.pasteItem(t,e))}else this.reload()},saveItemAs:function(t,e,a,i){this.app.restActions.listTable(this.app.options.application.id,function(n){var o=n.data.filter((function(e){return e.name&&e.name===t.name||e.alias&&e.alias===t.alias}));if(o.length){var s=o[0],p=this.app.lp,r=this,l=(new Date).parse(t.lastUpdateTime||t.updateTime),d=(new Date).parse(s.lastUpdateTime||s.updateTime),c="<div>"+p.copyConfirmInfor+"</div>";c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+p.copySource+" "+s.name+"</div>",c+="<div style='font-size:12px; color: #666666; float: left'>"+(s.lastUpdateTime||s.updateTime)+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(s.lastUpdatePerson||"")+"</div><div style='color: red; float: right;'>"+(l>=d?"":p.copynew)+"</div></div>",c+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+p.copyTarget+" "+t.name+"</div>",c+="<div style='font-size:12px; color: #666666; float: left;'>"+(t.lastUpdateTime||t.updateTime)+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(t.lastUpdatePerson||"")+"</div><div style='color: red; float: right;'>"+(l<=d?"":p.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:c},500,290,[{text:p.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(s,t,e,a),this.close()}},{text:p.copyConfirm_new,action:function(){r.saveItemAsNew(n,t,e,a),this.close()}},{text:p.copyConfirm_skip,action:function(){this.close(),e&&e()}},{text:p.copyConfirm_cancel,action:function(){this.close(),i&&i()}}])}else this.saveItemAsNew(n,t,e,a)}.bind(this),function(){a&&a()}.bind(this))},saveItemAsUpdate:function(t,e,a,i){var n=this.app.options.application,o=n.id,s=n.name,p=e.draftData?JSON.decode(e.draftData):"";e.draftData=p,e.status="draft";var r=e.data?JSON.decode(e.data):"";e.data=r,e.data.id=t.id,e.data=JSON.encode(e.data),e.id=t.id,e.isNewTable=!1,e.application=o,e.applicationName=s,this.app.restActions.saveTable(e,function(){a&&a()}.bind(this),function(){i&&i()}.bind(this))},saveItemAsNew:function(t,e,a,i){for(var n=this.app.options.application,o=n.id,s=n.name,p=e.name,r=1;t.data.some((function(t){return t.name==e.name||t.alias==e.name}));)e.name=p+"_copy"+r,e.alias=p+"_copy"+r,r++;var l=e.draftData?JSON.decode(e.draftData):"";e.draftData=l;var d=e.data?JSON.decode(e.data):"";e.data=d,e.data.id="",e.data=JSON.encode(e.data),e.id="",e.isNewTable=!0,e.application=o,e.applicationName=s,this.app.restActions.saveTable(e,function(){a&&a()}.bind(this),function(){i&&i()}.bind(this))},_createElement:function(t){var e=this,a={onQueryLoad:function(){this.actions=e.app.restActions,this.application=e.app.options.application,this.explorer=e}};this.app.desktop.openApplication(t,"query.TableDesigner",a)},_loadItemDataList:function(t){this.app.restActions.listTable(this.app.options.application.id,t)},_getItemObject:function(t){return new MWF.xApplication.query.QueryManager.TableExplorer.Table(this,t)},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var t=this.deleteMarkItems.shift();this.deleteMarkItems.length?t.deleteTable():t.deleteTable(function(){}.bind(this))}}}),MWF.xApplication.query.QueryManager.TableExplorer.Table=new Class({Extends:MWF.xApplication.query.QueryManager.StatExplorer.Stat,_open:function(t){var e=this,a={appId:"query.TableDesigner"+e.data.id,id:e.data.id,application:e.explorer.app.options.application.id,onQueryLoad:function(){this.actions=e.explorer.actions,this.category=e,this.options.id=e.data.id,this.application=e.explorer.app.options.application}};this.explorer.app.desktop.openApplication(t,"query.TableDesigner",a)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/tableIcon/lnk.png",title:this.data.name,par:'query.TableDesigner#{"appId": "query.TableDesigner'+this.data.id+'", "id": "'+this.data.id+'", "applicationId": "'+this.data.query+'"}'}},deleteTable:function(t){this.explorer.actions.deleteTable(this.data.id,function(){this.node.destroy(),t&&t()}.bind(this))},saveas:function(){MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.explorer.app.content,{title:this.explorer.app.lp.copyto,type:"Query",values:[this.explorer.app.options.application],onComplete:function(t){t.each(function(t){this.saveItemAs(t.data)}.bind(this))}.bind(this)})}.bind(this))},saveItemAs:function(t){var e=t.id,a=t.name;this.explorer.app.restActions.getTable(this.data.id,function(t){var i=n.draftData?JSON.decode(n.draftData):"";n.draftData=i;var n=t.data,o=n.data?JSON.decode(n.data):"";n.data=o,n.status="draft",n.data.id="",n.data=JSON.encode(n.data);var s=n.name;this.explorer.app.restActions.listTable(e,function(t){for(var i=1;t.data.some((function(t){return t.name==n.name||t.alias==n.name}));)n.name=s+"_copy"+i,n.alias=s+"_copy"+i,i++;n.id="",n.isNewTable=!0,n.application=e,n.applicationName=a,this.explorer.app.restActions.saveTable(n,function(){e==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});