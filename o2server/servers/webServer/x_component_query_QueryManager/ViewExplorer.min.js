MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,!1),MWF.xApplication.query.QueryManager.ViewExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.query.QueryManager.LP.view.create,search:MWF.xApplication.query.QueryManager.LP.view.search,searchText:MWF.xApplication.query.QueryManager.LP.view.searchText,noElement:MWF.xApplication.query.QueryManager.LP.view.noViewNoticeText}},openFindDesigner:function(){this.app.options.application.moduleType="query";var e={filter:{moduleList:["query"],appList:[this.app.options.application]}};layout.openApplication(null,"FindDesigner",e)},keyCopy:function(e){if(this.selectMarkItems.length){var t=[],i=0,a=function(e){if(i>=this.selectMarkItems.length&&t.length){var a=JSON.encode(t);e?e.clipboardData.setData("text/plain",a):window.clipboardData.setData("Text",a),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getView(n.data.id,function(n){n.data.elementType="view",t.push(n.data),i++,a(e)}.bind(this),null,!1)}.bind(this)),e&&e.preventDefault()}},keyPaste:function(e){var t="";t=e?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(t);this.pasteItem(i,0)},pasteItem:function(e,t){if(t<e.length){var i=e[t];"view"===i.elementType?this.saveItemAs(i,function(){t++,this.pasteItem(e,t)}.bind(this),function(){t++,this.pasteItem(e,t)}.bind(this),function(){this.reload()}.bind(this)):(t++,this.pasteItem(e,t))}else this.reload()},saveItemAs:function(e,t,i,a){this.app.restActions.listView(this.app.options.application.id,function(n){var o=n.data.filter((function(t){return t.id===e.id}));if(o.length){var p=o[0],s=this.app.lp,r=this,l=(new Date).parse(e.lastUpdateTime||e.updateTime),c=(new Date).parse(p.lastUpdateTime||p.updateTime),d="<div>"+s.copyConfirmInfor+"</div>";d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+s.copySource+" "+p.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left'>"+(p.lastUpdateTime||p.updateTime)+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(p.lastUpdatePerson||"")+"</div><div style='color: red; float: right;'>"+(l>=c?"":s.copynew)+"</div></div>",d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+s.copyTarget+" "+e.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left;'>"+(e.lastUpdateTime||e.updateTime)+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(e.lastUpdatePerson||"")+"</div><div style='color: red; float: right;'>"+(l<=c?"":s.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:d},500,290,[{text:s.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(p,e,t,i),this.close()}},{text:s.copyConfirm_new,action:function(){r.saveItemAsNew(n,e,t,i),this.close()}},{text:s.copyConfirm_skip,action:function(){this.close(),t&&t()}},{text:s.copyConfirm_cancel,action:function(){this.close(),a&&a()}}])}else this.saveItemAsNew(n,e,t,i)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(e,t,i,a){var n=this.app.options.application,o=n.id,p=n.name,s=t.data?JSON.decode(t.data):"";t.data=s,t.data.id=e.id,t.id=e.id,t.isNewView=!1,t.application=o,t.applicationName=p,this.app.restActions.saveView(t,function(){i&&i()}.bind(this),function(){a&&a()}.bind(this))},saveItemAsNew:function(e,t,i,a){for(var n=this.app.options.application,o=n.id,p=n.name,s=t.name,r=1;e.data.some((function(e){return e.name==t.name||e.alias==t.name}));)t.name=s+"_copy"+r,t.alias=s+"_copy"+r,r++;var l=t.data?JSON.decode(t.data):"";t.data=l,t.data.id="",t.id="",t.isNewView=!0,t.application=o,t.applicationName=p,this.app.restActions.saveView(t,function(){i&&i()}.bind(this),function(){a&&a()}.bind(this))},_createElement:function(e){var t=this,i={onQueryLoad:function(){this.actions=t.app.restActions,this.application=t.app.options.application,this.explorer=t}};this.app.desktop.openApplication(e,"query.ViewDesigner",i)},_loadItemDataList:function(e){this.app.restActions.listView(this.app.options.application.id,e)},_getItemObject:function(e){return new MWF.xApplication.query.QueryManager.ViewExplorer.View(this,e)},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteView():e.deleteView(function(){}.bind(this))}}}),MWF.xApplication.query.QueryManager.ViewExplorer.View=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,_open:function(e){var t=this,i={appId:"query.ViewDesigner"+t.data.id,id:t.data.id,application:t.explorer.app.options.application.id,onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.application=t.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"query.ViewDesigner",i)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/viewIcon/lnk.png",title:this.data.name,par:'query.ViewDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.data.query+'"}'}},deleteView:function(e){this.explorer.actions.deleteView(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))},saveas:function(){MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.explorer.app.content,{title:this.explorer.app.lp.copyto,type:"Query",values:[this.explorer.app.options.application],onComplete:function(e){e.each(function(e){this.saveItemAs(e.data)}.bind(this))}.bind(this)})}.bind(this))},saveItemAs:function(e){var t=e.id,i=e.name;this.explorer.app.restActions.getView(this.data.id,function(e){var a=e.data,n=a.data?JSON.decode(a.data):"";a.data=n,a.data.id="";var o=a.name;this.explorer.app.restActions.listView(t,function(e){for(var n=1;e.data.some((function(e){return e.name==a.name||e.alias==a.name}));)a.name=o+"_copy"+n,a.alias=o+"_copy"+n,n++;a.id="",a.isNewView=!0,a.application=t,a.applicationName=i,this.explorer.app.restActions.saveView(a,function(){t==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});