MWF.xApplication.LogViewer.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"LogViewer",icon:"icon.png",width:"800",height:"600",title:MWF.xApplication.LogViewer.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.LogViewer.LP,this.tagId=o2.uuid()},onQueryClose:function(){$clear(this.timeDo)},loadApplication:function(t){this.options.isRefresh?this.doLog():this.maxSize(function(){this.doLog()}.bind(this)),t&&t()},doLog:function(){this.status="systemLog",this.actions=MWF.Actions.get("x_program_center"),this.node=new Element("div",{styles:this.css.contentNode}).inject(this.content),this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}).inject(this.node),this.screenNode=new Element("div",{styles:this.css.screenNode}).inject(this.node),this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.node),this.loadToolbar(),this.loadScreen(),this.loadBottom(),this.initLog(),this.loadLog()},initLog:function(t){t||this.screenInforAreaNode.empty(),this.date=this.dateSelect.options[this.dateSelect.selectedIndex],this.method="listPromptErrorLog",this.count=20,this.currentId="(0)"},loadBottom:function(){this.nodeSelect=new Element("select",{styles:this.css.toolbarNodeSelect}).inject(this.bottomNode),o2.Actions.load("x_program_center").CommandAction.getNodeInfoList(function(t){var e=t.data.nodeList;e.length>1&&new Element("option",{value:"*",text:"*"}).inject(this.nodeSelect),e.each(function(t){new Element("option",{value:t.node.nodeAgentPort,text:t.nodeAddress}).inject(this.nodeSelect)}.bind(this))}.bind(this),null,!1),this.commandNode=new Element("input",{styles:this.css.commandNode}).inject(this.bottomNode),this.commandBtnNode=new Element("button",{text:"submit",styles:this.css.commandBtnNode}).inject(this.bottomNode),this.commandNode.addEvent("keyup",function(t){"enter"===t.key&&this.executeCommand()}.bind(this)),this.commandBtnNode.addEvent("click",function(){this.executeCommand()}.bind(this))},executeCommand:function(){if(""!==this.commandNode.get("value")){var t={};t.ctl=this.commandNode.get("value"),t.nodeName=this.nodeSelect.getElement("option:selected").get("text"),t.nodePort=this.nodeSelect.getElement("option:selected").get("value"),o2.Actions.load("x_program_center").CommandAction.executeCommand(t,function(t){this.commandNode.set("value","")}.bind(this),null,!1)}},loadToolbar:function(){this.systemLogButton=this.createTopButton("SystemLog","systemLog.png","systemLog"),this.promptErrorButton=this.createTopButton("PromptError","prompt.png","prompt"),this.unexpectedErrorButton=this.createTopButton("UnexpectedError","unexpected.png","unexpected"),this.warnErrorButton=this.createTopButton("Warn","warn.png","warn"),this.dateSelect=new Element("select",{styles:this.css.toolbarDateSelect}).inject(this.toolbarNode),new Element("option",{value:"all",selected:!0,text:this.lp.current}).inject(this.dateSelect);var t=new Date,e=t.format("%Y-%m-%d");new Element("option",{value:e,text:e}).inject(this.dateSelect);for(var s=0;s<=7;s++)e=(t=t.decrement("day",1)).format("%Y-%m-%d"),new Element("option",{value:e,text:e}).inject(this.dateSelect);this.dateSelect.addEvent("change",function(){this.initLog(),this.loadLog()}.bind(this)),this.clearBtn=new Element("button",{text:"clear",style:"margin:10px;float:right"}).inject(this.toolbarNode),this.clearBtn.addEvent("click",function(){this.screenInforAreaNode.empty()}.bind(this)),this.stopBtn=new Element("button",{text:"stop",style:"margin:10px;float:right"}).inject(this.toolbarNode),this.startBtn=new Element("button",{text:"start",style:"margin:10px;display:none;;float:right"}).inject(this.toolbarNode),this.stopBtn.addEvent("click",function(){this.startBtn.show(),this.stopBtn.hide(),"listSystemLog"===this.method?($clear(this.timeDo),this.timeDo=null):(this.initLog(),this.loadLog())}.bind(this)),this.startBtn.addEvent("click",function(){this.startBtn.hide(),this.stopBtn.show(),this.initLog(!0),this.loadLog()}.bind(this))},showTypeLog:function(t){if($clear(this.timeDo),this.timeDo=null,this.status!==t){switch(this.status){case"prompt":this.promptErrorButton.setStyles(this.css.toolbarButton);break;case"unexpected":this.unexpectedErrorButton.setStyles(this.css.toolbarButton);break;case"warn":this.warnErrorButton.setStyles(this.css.toolbarButton);break;case"systemLog":this.systemLogButton.setStyles(this.css.toolbarButton)}switch(t){case"prompt":this.promptErrorButton.setStyles(this.css.toolbarButton_down),this.status="prompt";break;case"unexpected":this.unexpectedErrorButton.setStyles(this.css.toolbarButton_down),this.status="unexpected";break;case"warn":this.warnErrorButton.setStyles(this.css.toolbarButton_down),this.status="warn";break;case"systemLog":this.systemLogButton.setStyles(this.css.toolbarButton_down),this.status="systemLog";break;default:this.promptErrorButton.setStyles(this.css.toolbarButton_down),this.status="prompt"}this.initLog(),this.loadLog()}},createTopButton:function(t,e,s){var o=new Element("div",{styles:this.css.toolbarButton}).inject(this.toolbarNode),n=new Element("div",{styles:this.css.toolbarIconButton}).inject(o);new Element("div",{styles:this.css.toolbarTextButton,text:t}).inject(o);n.setStyle("background-image","url(../x_component_LogViewer/$Main/default/"+e+")"),s==this.status&&o.setStyles(this.css.toolbarButton_down);var i=this;return o.addEvents({mouseover:function(){i.status!=s&&this.setStyles(i.css.toolbarButton_over)},mousedown:function(){i.status!=s&&this.setStyles(i.css.toolbarButton_down)},mouseup:function(){i.status!=s&&this.setStyles(i.css.toolbarButton_over)},mouseout:function(){i.status!=s&&this.setStyles(i.css.toolbarButton)},click:function(){i.showTypeLog(s)}.bind(this)}),o},loadLog:function(){switch(this.date=this.dateSelect.options[this.dateSelect.selectedIndex].value,this.status){case"prompt":this.method="all"===this.date?"listPromptErrorLog":"listPromptErrorLogWithDate";break;case"unexpected":this.method="all"===this.date?"listUnexpectedErrorLog":"listUnexpectedErrorLogWithDate";break;case"warn":this.method="all"===this.date?"listWarnLog":"listWarnLogWithDate";break;case"systemLog":this.method="listSystemLog";break;default:this.method="listSystemLog"}if("listSystemLog"===this.method)this.actions[this.method](this.tagId,function(t){this.showSystemLog(t.data)}.bind(this)),this.timeDo=this.tiemShowSystemLog.periodical(1e3,this);else if("all"===this.date)this.actions[this.method](this.currentId,this.count,function(t){this.showLog(t.data)}.bind(this));else{var t=(new Date).parse(this.date).format("%Y-%m-%d");this.actions[this.method](this.currentId,this.count,t,function(t){this.showLog(t.data)}.bind(this))}},showSystemLog:function(t){this.logFinish=!0,t.each(function(t){var e=new Element("div",{styles:this.css.logItemNode}).inject(this.screenInforAreaNode);if(t.logLevel){var s=t.lineLog,o=t.logTime.split("#")[0];s=(s=s.replace(o,"")).replace(t.logLevel,"");var n=new Element("div",{html:t.logLevel,title:t.node,style:"float:left;margin:0 10px;width:50px;font-weight:500;"}).inject(e),i="#FF0000";switch(t.logLevel){case"INFO":i="#5a86ff";break;case"PRINT":i="#ffd192";break;case"DEBUG":i="#d7ff3d"}n.setStyle("color",i);new Element("div",{html:o,style:"float:left;margin:0 10px;width:180px;color:#6BC5FC"}).inject(e)}new Element("div",{text:t.lineLog,style:"margin-left:270px"}).inject(e)}.bind(this))},tiemShowSystemLog:function(){this.actions[this.method](this.tagId,function(t){this.showSystemLog(t.data),this.screenInforAreaNode.scrollTop=this.screenInforAreaNode.scrollHeight}.bind(this))},showLog:function(t){if(t.length){var e=t[t.length-1];this.currentId=e.id,t.each(function(t){new MWF.xApplication.LogViewer.Log(t,this)}.bind(this))}else this.logFinish=!0;this.checkLoadNext()},checkLoadNext:function(){if(!this.logFinish){var t=this.screenInforAreaNode.getScroll(),e=this.screenInforAreaNode.getScrollSize(),s=this.screenInforAreaNode.getSize();e.y-t.y-s.y<200&&this.loadLog()}},begin:function(){this.beginButton.setStyle("background-image","url(../x_component_Console/$Main/default/play_gray.png)"),this.stopButton.setStyle("background-image","url(../x_component_Console/$Main/default/stop.png)"),this.status="begin"},stop:function(){this.beginButton.setStyle("background-image","url(../x_component_Console/$Main/default/play.png)"),this.stopButton.setStyle("background-image","url(../x_component_Console/$Main/default/stop_gray.png)"),this.status="stop"},loadScreen:function(){this.screenInforAreaNode=new Element("div",{styles:this.css.screenInforAreaNode}).inject(this.screenNode),this.screenInforAreaNode.addEvent("scroll",function(){this.checkLoadNext()}.bind(this)),this.setScreenHeight(),this.addEvent("resize",this.setScreenHeight.bind(this))},setScreenHeight:function(){var t=this.node.getSize(),e=this.toolbarNode.getSize(),s=this.bottomNode.getSize(),o=t.y-e.y-s.y;this.screenNode.setStyle("height",o+"px")}}),MWF.xApplication.LogViewer.Log=new Class({initialize:function(t,e){this.log=t,this.app=e,this.css=this.app.css,this.lp=this.app.lp,this.load()},load:function(){if(this.node=new Element("div",{styles:this.css.logItemNode}).inject(this.app.screenInforAreaNode),this.log){var t=this.log.message.substr(0,this.log.message.indexOf("\n"))+(this.log.person?"&nbsp;("+this.log.person+")":""),e="<pre><span  class='MWFLogCheckbox' style='cursor: pointer;float: left; height: 20px; width: 30px; background: url(../x_component_LogViewer/$Main/default/check.png) no-repeat center center'></span><span style='float: left;font-size: 14px; font-weight: bold; width: 160px; text-align: right'>"+this.log.occurTime+"</span><span style='float:left'>\t</span><span style='font-size: 14px; font-weight: bold;'>"+o2.common.encodeHtml(t)+"</span><br/>";if(this.log.exceptionClass&&(e+="<span style='float: left; width: 190px; text-align: right; color: #6BC5FC;'>ExceptionClass: </span><span style='float:left'>\t</span><span>"+o2.common.encodeHtml(this.log.exceptionClass)+"</span><br/>"),this.log.loggerName&&(e+="<span style='float: left; width: 190px; text-align: right; color: #6BC5FC;'>LoggerName: </span><span style='float:left'>\t</span><span>"+o2.common.encodeHtml(this.log.loggerName)+"</span><br/>"),this.log.stackTrace){var s=this.log.stackTrace.split(/[\r\n\t]/g);e+="<span class='MWFLogStackTrace'><span style='float: left; width: 190px; text-align: right; color: #6BC5FC;'>StackTrace: </span><span style='float:left'>\t</span>",s.length>1&&(e+="<span  class='MWFLogStackTraceAction' style='float: left; cursor: pointer; height: 20px; width: 16px; background: url(../x_component_LogViewer/$Main/default/right.png) no-repeat left center'></span>"),e+="<span>"+o2.common.encodeHtml(s[0])+"</span></span><br/>"}if(this.log.requestUrl){var o=(this.log.requestMethod?this.log.requestMethod+"&nbsp;":"")+this.log.requestUrl+(this.log.requestRemoteAddr?"&nbsp; From &nbsp;"+this.log.requestRemoteAddr:"");e+="<span  class='MWFLogRequest'><span style='float: left; width: 190px; text-align: right; color: #6BC5FC;'>RequestInfor: </span><span style='float:left'>\t</span>",e+="<span  class='MWFLogRequestAction' style='float: left;cursor: pointer; height: 20px; width: 16px; background: url(../x_component_LogViewer/$Main/default/right.png) no-repeat left center'></span>",e+="<span>"+o2.common.encodeHtml(o)+"</span></span><br/>"}e+="</pre>",this.node.set("html",e),this.checkbox=this.node.getElement(".MWFLogCheckbox"),this.traceNode=this.node.getElement(".MWFLogStackTrace"),this.requestNode=this.node.getElement(".MWFLogRequest"),this.traceActionNode=this.node.getElement(".MWFLogStackTraceAction"),this.requestActionNode=this.node.getElement(".MWFLogRequestAction"),this.setEvent()}},setEvent:function(){this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.logItemNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.logItemNode)}.bind(this)}),this.checkbox&&this.checkbox.addEvent("click",function(t){this.checkSelected(),t.stopPropagation()}.bind(this)),this.traceActionNode&&this.traceActionNode.addEvent("click",function(t){this.expandOrCollapseTrace(),t.stopPropagation()}.bind(this)),this.requestActionNode&&this.requestActionNode.addEvent("click",function(t){this.expandOrCollapseRequest(),t.stopPropagation()}.bind(this))},checkSelected:function(){document.createRange().selectNode(this.node),window.getSelection().selectAllChildren(this.node)},expandOrCollapseTrace:function(){this.log.stackTrace&&(this.isTraceExpanded?this.collapseTrace():this.expandedTrace())},expandedTrace:function(){this.traceAllNode||this.createTraceAllNode(),this.traceAllNode.setStyle("display","inline"),this.traceActionNode.setStyle("background-image","url(../x_component_LogViewer/$Main/default/down.png)"),this.isTraceExpanded=!0},collapseTrace:function(){this.traceAllNode&&(this.traceAllNode.destroy(),this.traceAllNode=null),this.traceActionNode.setStyle("background-image","url(../x_component_LogViewer/$Main/default/right.png)"),this.isTraceExpanded=!1},createTraceAllNode:function(){var t=this.traceNode.getNext();this.traceAllNode=new Element("span").inject(t,"after");var e=this.log.stackTrace.split(/[\r\n\t]/g),s="";e.each(function(t,e){0!==e&&(s+="<span style='float: left; width: 190px;'>\t</span><span>\t</span><span>\t"+t+"</span><br/>")}.bind(this)),this.traceAllNode.set("html",s)},expandOrCollapseRequest:function(){this.log.requestUrl&&(this.isRequestExpanded?this.collapseRequest():this.expandedRequest())},expandedRequest:function(){this.requestAllNode||this.createRequestAllNode(),this.requestAllNode.setStyle("display","inline"),this.requestActionNode.setStyle("background-image","url(../x_component_LogViewer/$Main/default/down.png)"),this.isRequestExpanded=!0},collapseRequest:function(){this.requestAllNode&&(this.requestAllNode.destroy(),this.requestAllNode=null),this.requestActionNode.setStyle("background-image","url(../x_component_LogViewer/$Main/default/right.png)"),this.isRequestExpanded=!1},createRequestAllNode:function(){var t=this.requestNode.getNext();this.requestAllNode=new Element("span").inject(t,"after");var e="";(e+="<span style='float: left; width: 190px;'>\t</span><span style='float: left;'>\t</span><span style='color: #6BC5FC; width: 108px;'>requestRemoteAddr: </span><span>"+(this.log.requestRemoteAddr||"&nbsp;")+"</span>&nbsp;&nbsp;<span style='color: #6BC5FC; width: 108px;'>requestRemoteHost: </span><span>"+(this.log.requestRemoteHost||"&nbsp;")+"</span>&nbsp;&nbsp;<span style='color: #6BC5FC; width: 108px;'>requestBodyLength: </span><span>"+(this.log.requestBodyLength||"&nbsp;")+"</span><br/>",this.log.requestHead.split(/\n/g).each(function(t,s){e+=0===s?"<span style='float: left; width: 190px;'>\t</span><span style='float: left;'>\t</span><span style='float: left; color: #6BC5FC; width: 108px;'>requestHead: </span><span>"+t+"</span><br/>":"<span style='float: left; width: 190px;'>\t</span><span style='float: left;'>\t</span><span style='float: left; color: #6BC5FC; width: 108px;'>\t</span><span>"+t+"</span><br/>"}.bind(this)),this.log.requestBody)&&this.log.requestBody.split(/\n/g).each(function(t,s){e+=0===s?"<span style='float: left; width: 190px;'>\t</span><span style='float: left;'>\t</span><span style='float: left; color: #6BC5FC; width: 108px;'>requestBody: </span><span>"+t+"</span><br/>":"<span style='float: left; width: 190px;'>\t</span><span style='float: left;'>\t</span><span style='float: left; color: #6BC5FC; width: 108px;'>\t</span><span>"+t+"</span><br/>"}.bind(this));this.requestAllNode.set("html",e)}});