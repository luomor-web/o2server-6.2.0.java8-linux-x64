var _worker=self,_action={_checkRequest:function(e,t){this.request.readyState===XMLHttpRequest.DONE&&(200===this.request.status?this._doneRequest(e):this._errorRequest(t))},_createRequest:function(e,t){var r=new XMLHttpRequest;return r.addEventListener("readystatechange",(function(){if(this.readyState===XMLHttpRequest.DONE)if(200===this.status){var r=JSON.parse(this.responseText),i=this.getResponseHeader(_worker.findData.tokenName);i&&(r.xToken=i),e&&e(r)}else t&&t(this,this.responseText)})),r},sendRequest:function(e){return new Promise(function(t,r){var i=this._createRequest(t,r),s=e.method,n=!!e.noCache,o=!!e.loadAsync,a=!!e.credentials,d=e.address,p=e.body,u=e.debug,c=e.token;n&&(d=d+(-1!==d.indexOf("?")?"&":"?")+(new Date).getTime()),i.open(s,d,o),i.withCredentials=a,i.setRequestHeader("Content-Type","application/json; charset=utf-8"),i.setRequestHeader("Accept","text/html,application/json,*/*"),u&&i.setRequestHeader("x-debugger","true"),c&&(i.setRequestHeader(_worker.findData.tokenName,c),i.setRequestHeader("authorization",c)),i.send(p)}.bind(this))},_doneRequest:function(e){var t=JSON.parse(this.request.responseText),r=this.request.getResponseHeader(_worker.findData.tokenName);r&&(t.xToken=r),e&&e(t)},_errorRequest:function(e){s&&s(this.request,this.request.responseText)}};_worker.action=_action,_worker._receiveMessageReply=function(){_worker.postMessage({type:"receive"})},_worker._readyMessageReply=function(){_worker.postMessage({type:"ready",count:this.filterOptionList.length})},_worker._getRequestOption=function(e,t){return t&&Object.keys(t).forEach((function(r){e.url=e.url.replace("{"+r+"}",t[r])})),{method:e.method||"get",noCache:!1,loadAsync:!0,credentials:!0,address:e.url,body:e.body||"",debug:e.debug||_worker.findData.debug,token:e.token||_worker.findData.token}},_worker._createFilterOption=function(e,t,r,i){var s=JSON.parse(_worker.filterOptionTemplete);return s.moduleList.push({moduleType:e,moduleAppList:[{appId:t,designerList:[{desingerType:r,designerIdList:[i]}]}]}),this.filterOptionList.push(s),s},_worker._getDesingerModule=function(e,t,r,i,s){return _worker.action.sendRequest(_worker._getRequestOption({url:t,debug:_worker.findData.debug,token:_worker.findData.token},r)).then((function(t){list=t.data,list.forEach((function(t){_worker._createFilterOption(i,e,s,t.id)}))}),(function(){}))},_worker._getDesinger_processPlatform=function(e){var t=[];return-1!=_worker.findData.filterOption.designerTypes.indexOf("script")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listProcessScript,{applicationId:e},"processPlatform","script")),-1!=_worker.findData.filterOption.designerTypes.indexOf("form")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listProcessForm,{applicationId:e},"processPlatform","form")),-1!=_worker.findData.filterOption.designerTypes.indexOf("process")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listProcessProcess,{applicationId:e},"processPlatform","process")),t},_worker._getDesinger_cms=function(e){var t=[];return-1!=_worker.findData.filterOption.designerTypes.indexOf("script")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listCmsScript,{flag:e},"cms","script")),-1!=_worker.findData.filterOption.designerTypes.indexOf("form")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listCmsForm,{appId:e},"cms","form")),t},_worker._getDesinger_portal=function(e){var t=[];return-1!=_worker.findData.filterOption.designerTypes.indexOf("script")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listPortalScript,{portalId:e},"portal","script")),-1!=_worker.findData.filterOption.designerTypes.indexOf("page")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listPortalPage,{portalId:e},"portal","page")),-1!=_worker.findData.filterOption.designerTypes.indexOf("widget")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listPortalWidget,{portalId:e},"portal","widget")),t},_worker._getDesinger_query=function(e){var t=[];return-1!=_worker.findData.filterOption.designerTypes.indexOf("view")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listQueryView,{flag:e},"query","view")),-1!=_worker.findData.filterOption.designerTypes.indexOf("stat")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listQueryStat,{flag:e},"query","stat")),-1!=_worker.findData.filterOption.designerTypes.indexOf("statement")&&t.push(_worker._getDesingerModule(e,_worker.findData.actions.listQueryStatement,{flag:e},"query","statement")),t},_worker._getDesinger_service=function(e){var t=[];return-1!=_worker.findData.filterOption.designerTypes.indexOf("script")&&("invoke"==e?t.push(_worker._getDesingerModule(e,_worker.findData.actions.listInvoke,null,"service","script")):t.push(_worker._getDesingerModule(e,_worker.findData.actions.listAgent,null,"service","script"))),t},_worker._listApplication=function(e){switch(e){case"processPlatform":return this.action.sendRequest(_worker._getRequestOption({url:this.findData.actions.listProcess,debug:this.findData.debug,token:this.findData.token}));case"cms":return this.action.sendRequest(_worker._getRequestOption({url:this.findData.actions.listCms,debug:this.findData.debug,token:this.findData.token}));case"portal":return this.action.sendRequest(_worker._getRequestOption({url:this.findData.actions.listPortal,debug:this.findData.debug,token:this.findData.token}));case"query":return this.action.sendRequest(_worker._getRequestOption({url:this.findData.actions.listQuery,debug:this.findData.debug,token:this.findData.token}))}},_worker._parseFindModule=function(e){var t=[];return e.forEach(function(e){var r;if("service"===e.moduleType)e.flagList&&e.flagList.length?e.flagList.forEach((function(r){r.designerList&&r.designerList.length?r.designerList.forEach((function(i){var s=_worker._createFilterOption(e.moduleType,r.id,i.desingerType,i.id);t=t.concat(Promise.resolve(s))})):t=t.concat(_worker["_getDesinger_"+e.moduleType](r.id))})):((r=JSON.parse(_worker.filterOptionTemplete)).moduleList.push({moduleType:e.moduleType,moduleAppList:[{appId:"invoke"}]}),this.filterOptionList.push(r),(r=JSON.parse(_worker.filterOptionTemplete)).moduleList.push({moduleType:e.moduleType,moduleAppList:[{appId:"agent"}]}),this.filterOptionList.push(r),t=(t=t.concat(_worker["_getDesinger_"+e.moduleType]("invoke"))).concat(_worker["_getDesinger_"+e.moduleType]("agent")));else if(e.flagList&&e.flagList.length)e.flagList.forEach((function(r){r.designerList&&r.designerList.length?r.designerList.forEach((function(i){var s=_worker._createFilterOption(e.moduleType,r.id,i.desingerType,i.id);t=t.concat(Promise.resolve(s))})):t=t.concat(_worker["_getDesinger_"+e.moduleType](r.id))}));else{var i=_worker._listApplication(e.moduleType);t.push(i.then((function(t){var r=[];return t.data.forEach((function(t){r=r.concat(_worker["_getDesinger_"+e.moduleType](t.id))})),Promise.all(r)}),(function(){})))}}.bind(this)),t},_worker._findMessageReply=function(e,t){_worker.setTimeout((function(){_worker.postMessage(e)}),100)},_worker._findOptionReply=function(){_worker.postMessage({type:"done"})},_worker._createFindMessageReplyData=function(e,t,r,i){return{module:e,appId:t.appId,appName:t.appName,designerId:t.designerId,designerName:t.designerName,designerType:t.designerType,designerAliase:r,pattern:i}},_worker._setFilterOptionRegex=function(){var e=_worker.findData.option.keyword;if(_worker.findData.option.matchRegExp){var t=_worker.findData.option.caseSensitive?"g":"gi";this.keywordRegexp=new RegExp(e,t)}else{t=_worker.findData.option.caseSensitive?"g":"gi";e=_worker.findData.option.matchWholeWord?"\\b"+e+"\\b":e,this.keywordRegexp=new RegExp(e,t)}},_worker._findProcessPlatformParse_script=function(e){if(e.patternList&&e.patternList.length){var t=this.findData.actions.getProcessScript;_worker.action.sendRequest(_worker._getRequestOption({url:t},{id:e.designerId})).then((function(t){e.patternList.forEach((function(r){if("text"==r.property){var i=t.data.text.split(/\n/);r.lines.forEach((function(s){for(var n=i[s-1];null!==(arr=this.keywordRegexp.exec(n));){var o=arr.index,a=arr[0],d=arr.input;_worker._findMessageReply(_worker._createFindMessageReplyData("processPlatform",e,t.data.aliase,{property:r.property,value:d,line:s,column:o,key:a}))}}))}else _worker._findMessageReply(_worker._createFindMessageReplyData("processPlatform",e,t.data.aliase,{property:r.property,value:t.data[r.property]}))}))}),(function(){}))}},_worker._findProcessPlatformParse_form=function(e){},_worker._findProcessPlatformParse_process=function(e){},_worker._findProcessPlatformParse=function(e){e.forEach((function(e){switch(e.designerType){case"script":_worker._findProcessPlatformParse_script(e);break;case"form":_worker._findProcessPlatformParse_form(e);break;case"process":_worker._findProcessPlatformParse_process(e)}}))},_worker._doFindDesigner=function(e){var t=_worker._getRequestOption({method:"post",url:this.findData.actions.findAction,body:JSON.stringify(e),debug:this.findData.debug,token:this.findData.token});this.action.sendRequest(t).then((function(e){e.data.processPlatformList&&e.data.processPlatformList.length&&_worker._findProcessPlatformParse(e.data.processPlatformList),e.data.cmsList&&e.data.cmsList.length,e.data.portalList&&e.data.portalList.length,e.data.queryList&&e.data.queryList.length,e.data.serviceList&&e.data.serviceList.length,_worker._findOptionReply()}),(function(e){_worker._findOptionReply(null),_worker._findMessageReply(null)}))},_worker._doFindDesignerFromFilterOption=function(){this.filterOptionList.forEach((function(e){_worker._doFindDesigner(e)}))},onmessage=function(e){this.findData=e.data,_worker._setFilterOptionRegex(),_worker[e.data.parser](e.data.pattern)};