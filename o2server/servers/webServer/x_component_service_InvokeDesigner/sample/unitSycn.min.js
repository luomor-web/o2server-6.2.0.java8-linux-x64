print("运行组织同步接口");var File=Java.type("java.io.File"),Config={localPath:File.separator+"data"+File.separator+"OrganizationSyncRequest"+File.separator+"unit"+File.separator},applications=resources.getContext().applications(),Utils={getUnitFlag:function(t){return t.flag||t.unique||t.distinguishedName||t.id||t.name},getKeyEqualObjFromArray:function(t,e,r){for(var i=0;i<t.length;i++)if(t[i][e]===r)return t[i];return null},parseResp:function(t){return t&&null!==t?JSON.parse(t.toString()):{type:"error",message:"服务响应是null，需要管理员查看后台日志"}},getFailText:function(t){var e;return e=t.message?t.message+(t.prompt?"("+t.prompt+")":""):t.prompt?t.prompt:"未知异常",print(e),e},processError:function(t,e){t.printStackTrace();var r=e+" "+t.name+": "+t.message;return print(r),r},arrayIndexOf:function(t,e){for(var r=0;r<t.length;r++)if(t[r]==e)return r;return-1},objectClone:function(t){if(null==t||"object"!=typeof t)return t;if("number"==typeof t.length){for(var e=[],r=0,i=t.length;r<i;++r)e[r]=Utils.objectClone(t[r]);return e}e={};for(var s in t)e[s]=Utils.objectClone(t[s]);return e},saveToLocal:function(t){if(t.saveFlag&&"no"==t.saveFlag)print("不保存文件");else{print("保存文件开始"),null==File&&(File=Java.type("java.io.File"));var e=new File(Config.localPath);if(!e.exists()&&!e.mkdirs())return print("创建文件夹失败："+recordPath),null;var r=t.name?t.name:Utils.getUnitFlag(t),i=t.unique?t.unique:"",s=Config.localPath+r+"_"+i+".json";print("path="+s);var a=new File(s);if(a.exists()&&a.delete(),!a.createNewFile())return print("不能创建文件:"+s),null;var n=new java.io.PrintWriter(a,"GBK");n.write(JSON.stringify(t)),n.close(),print("保存文件结束 path="+s)}}},AttributeAction={add:function(t,e){e.unit=t,e.attributeList="string"==typeof e.value?[e.value]:e.value;try{var r=applications.postQuery("x_organization_assemble_control","unitattribute",JSON.stringify(e)),i=Utils.parseResp(r);return i.type&&"success"==i.type?"":Utils.getFailText(i)}catch(t){return Utils.processError(t,"新增组织属性AttributeAction.add() 出错: ")}},remove:function(t){try{var e=applications.deleteQuery("x_organization_assemble_control","unitattribute/"+t.id),r=Utils.parseResp(e);return r.type&&"success"==r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"删除组织属性AttributeAction.remove() 出错: ")}},update:function(t,e,r){for(var i in e)"distinguishedName"!=i&&(r[i]=e[i]);r.unit=t,r.attributeList="string"==typeof e.value?[e.value]:e.value;try{var s=applications.putQuery("x_organization_assemble_control","unitattribute/"+r.id,JSON.stringify(r)),a=Utils.parseResp(s);return a.type&&"success"==a.type?"":Utils.getFailText(a)}catch(t){return Utils.processError(t,"修改组织属性AttributeAction.update() 出错: ")}},compare:function(t){var e=t.attributeList,r="",i=Utils.getUnitFlag(t);if(i)try{var s,a=applications.getQuery("x_organization_assemble_control","unitattribute/list/unit/"+i),n=Utils.parseResp(a);s=n.type&&"success"==n.type?n.data:[];for(var o=0;o<s.length;o++){var l=Utils.getKeyEqualObjFromArray(e,"name",s[o].name);r=null==l?AttributeAction.remove(s[o]):AttributeAction.update(i,l,s[o])}for(o=0;o<e.length;o++){null==Utils.getKeyEqualObjFromArray(s,"name",e[o].name)&&(r=AttributeAction.add(i,e[o]))}return r}catch(t){return Utils.processError(t,"修改组织属性AttributeAction.compare() 出错: ")}}};function get(t){var e,r,i="",s=Utils.getUnitFlag(t);if(s){try{e=applications.getQuery("x_organization_assemble_control","unit/"+s);var a=Utils.parseResp(e);if(!a.type||"success"!=a.type)return Utils.getFailText(t);r=a.data}catch(t){return Utils.processError(t,"get() 出错: ")}return delete r.woSupDirectUnit,delete r.woSubDirectIdentityList,delete r.woUnitAttributeList,delete r.woUnitDutyList,r}return i="参数中没有组织标志：distinguishedName , unique, name 或 id, 不能获取用户",print(i),i}function add(t){print("添加组织");var e,r,i=Utils.objectClone(t);try{if(i.superior&&""!=i.superior)if("object"!=typeof get({flag:i.superior})){var s={name:i.superior,unique:i.superior};r=applications.postQuery("x_organization_assemble_control","unit",JSON.stringify(s))}var a,n=get(i);if("object"==typeof n){for(var o in print("组织已存在，强制保存"),i)"action"!==o&&"attributeList"!==o&&"dutyList"!==o&&("orderNumber"!=o||i[o]&&""!=i[o])&&("typeList"!=o||i[o]&&""!=i[o]&&0!=i[o].length)&&("id"==o||"unique"==o||"distinguishedName"==o||(n[o]=i[o]));n.controllerList&&null!=n.controllerList||(n.controllerList=[]),n.typeList?"string"==typeof n.typeList&&(n.typeList=[n.typeList]):n.typeList=[];var l=n.id;print("unitData="+JSON.stringify(n)),r=applications.putQuery("x_organization_assemble_control","unit/"+l,JSON.stringify(n))}else{i.controllerList?"string"==typeof i.controllerList&&(i.controllerList=[i.controllerList]):i.controllerList=[],i.typeList?"string"==typeof i.typeList&&(i.typeList=[i.typeList]):i.typeList=[];var u=Utils.objectClone(i);u.attributeList&&delete u.attributeList,u.dutyList&&delete u.dutyList,r=applications.postQuery("x_organization_assemble_control","unit",JSON.stringify(u))}if(r)(a=Utils.parseResp(r)).type&&"success"==a.type?i.attributeList&&(e=AttributeAction.compare(i)):e=Utils.getFailText(a)}catch(t){e=Utils.processError(t,"添加组织 add() 出错：")}finally{var p={result:e?"error":"success",description:e||""};return a&&a.data&&(p.id=a.data.id),p}}function update(t){print("修改组织");var e,r=Utils.objectClone(t);try{if(r.superior&&""!=r.superior)if("object"!=typeof get({flag:r.superior})){var i={name:r.superior,unique:r.superior};o=applications.postQuery("x_organization_assemble_control","unit",JSON.stringify(i))}var s=get(r);if("object"==typeof s){for(var a in r)"action"!==a&&"attributeList"!==a&&"dutyList"!==a&&("orderNumber"!=a||r[a]&&""!=r[a])&&("typeList"!=a||r[a]&&""!=r[a]&&0!=r[a].length)&&("id"==a||"unique"==a||"distinguishedName"==a||(s[a]=r[a]));s.controllerList&&null!=s.controllerList||(s.controllerList=[]),s.typeList?"string"==typeof s.typeList&&(s.typeList=[s.typeList]):s.typeList=[];var n,o=applications.putQuery("x_organization_assemble_control","unit/"+s.id,JSON.stringify(s));(n=Utils.parseResp(o)).type&&"success"==n.type?(r.attributeList||(r.attributeList=[]),e=AttributeAction.compare(r)):e=Utils.getFailText(n)}else e=s}catch(t){e=Utils.processError(t,"修改组织 update() 出错：")}finally{var l={result:e?"error":"success",description:e||""};return n&&n.data&&(l.id=n.data.id),l}}function remove(t){var e,r;print("删除组织");try{var i=get(t);if("object"==typeof i){var s=applications.deleteQuery("x_organization_assemble_control","unit/"+i.id);(r=Utils.parseResp(s)).type&&"success"==r.type||(e=Utils.getFailText(r))}else e=i}catch(t){e=Utils.processError(t,"删除组织 remove() 出错：")}finally{var a={result:e?"error":"success",description:e||""};return r&&r.data&&(a.id=r.data.id),a}}function init(){var t="";try{print("requestText="+requestText);var e=JSON.parse(requestText);print("type of requestJson = "+typeof e),"string"==typeof e&&(e=JSON.parse(e));var r=e.action;switch(print("action="+r),r){case"add":t=add(e);break;case"update":t=update(e);break;case"delete":t=remove(e);break;default:t={result:"error",description:"requestText未设置action，不执行操作"}}}catch(e){e.printStackTrace(),t={result:"error",description:e.name+": "+e.message}}finally{return print("responseText="+JSON.stringify(t)),t}}init();