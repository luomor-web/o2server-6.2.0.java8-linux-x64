MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,!1),MWF.xApplication.portal.PortalManager.SourceExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.portal.PortalManager.LP.source.create,search:MWF.xApplication.portal.PortalManager.LP.source.search,searchText:MWF.xApplication.portal.PortalManager.LP.source.searchText,noElement:MWF.xApplication.portal.PortalManager.LP.source.noNoticeText}},_createElement:function(e){this.pageTemplateList=null,this.defalutPageTemplateList=null;var t=this,s=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content),i=new Element("div",{styles:this.css.createFormTemplateAreaNode}).inject(this.app.content);i.fade("in");new Element("div",{styles:this.css.createTemplateFormTitleNode,text:this.app.lp.createSelectTemplate}).inject(i);var o=new Element("div",{styles:this.css.createTemplateFormCategoryNode}).inject(i),n=(new Element("div",{styles:this.css.createTemplateFormCategoryTitleNode,text:this.app.lp.templateCategory}).inject(o),new Element("div",{styles:this.css.createTemplateFormContentNode}).inject(i)),a=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:this.app.lp.all}).inject(o);a.addEvent("click",(function(){d()})),this.app.restActions.listPageTemplateCategory(function(e){e.data.each(function(e){new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:e.name+"("+e.count+")",value:e.name}).inject(o).addEvent("click",(function(){n.empty(),o.getElements("div").each((function(e,s){s>0&&e.setStyles(t.css.createTemplateFormCategoryItemNode)})),this.setStyles(t.css.createTemplateFormCategoryItemNode_current),m(this.get("value"))}))}.bind(this))}.bind(this));var l=function(){var e=this.app.content.getSize(),t=.1*e.y/2,s=.1*e.x/2;t<0&&(t=0),s<0&&(s=0),i.setStyles({top:t+"px",left:s+"px"}),t=.9*e.y-o.getSize().y-70,n.setStyle("height",t+"px")}.bind(this);l(),this.app.addEvent("resize",l);var r=function(e){if(this.defalutPageTemplateList)e&&e();else{MWF.getJSON("../x_component_portal_PageDesigner/Module/Page/template/templates.json",function(t){this.defalutPageTemplateList=t,e&&e()}.bind(this))}}.bind(this),c=function(){r(function(){this.defalutPageTemplateList.each(function(e){var o=new Element("div",{styles:this.css.formTemplateNode}).inject(n),a=new Element("div",{styles:this.css.formTemplateIconNode}).inject(o);new Element("div",{styles:this.css.formTemplateTitleNode,text:e.title}).inject(o);o.store("template",e.name),new Element("img",{styles:this.css.formTemplateIconImgNode}).inject(a).set("src","../x_component_portal_PageDesigner/Module/Page/template/"+e.icon),o.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over)},mouseout:function(){this.setStyles(t.css.formTemplateNode)},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){!function(e,s){layout.desktop.getPageDesignerStyle(function(){var i={style:layout.desktop.pageDesignerStyle,template:s,onQueryLoad:function(){this.actions=t.app.restActions,this.application=t.app.options.application}};layout.desktop.openApplication(e,"portal.SourceDesigner",i)}.bind(this))}(e,this.retrieve("template")),t.app.removeEvent("resize",l),i.destroy(),s.destroy()}})}.bind(this))}.bind(this))}.bind(this),p=function(e){this.pageTemplateList?e&&e():this.app.restActions.listPageTemplate(function(t){this.pageTemplateList=t.data,e&&e()}.bind(this))}.bind(this),m=function(e){p(function(){Object.each(this.pageTemplateList,function(o,a){(!e||a==e)&&o.each(function(e){var o=new Element("div",{styles:this.css.formTemplateNode}).inject(n),a=new Element("div",{styles:this.css.formTemplatePreviewNode}).inject(o);new Element("div",{styles:this.css.formTemplateTitleNode,text:e.name}).inject(o);o.store("template",e.id),a.set("html",e.outline);var r=new Element("img",{styles:this.css.formTemplateActionNode}).inject(a);r.addEvent("click",(function(e){var s=this.getParent().getParent(),i=s.retrieve("template");t.app.confirm("wram",e,t.app.lp.page.deletePageTemplateTitle,t.app.lp.page.deletePageTemplate,300,120,(function(){t.app.restActions.deletePageTemplate(i,function(e){s.destroy()}.bind(this)),this.close()}),(function(){this.close()})),e.stopPropagation()})),o.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over),r&&r.setStyle("display","block")},mouseout:function(){this.setStyles(t.css.formTemplateNode),r&&r.setStyle("display","none")},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){createForm(e,this.retrieve("template")),t.app.removeEvent("resize",l),i.destroy(),s.destroy()}})}.bind(this))}.bind(this))}.bind(this))}.bind(this),d=function(){n.empty(),o.getElements("div").each((function(e,s){s>0&&e.setStyles(t.css.createTemplateFormCategoryItemNode)})),a.setStyles(t.css.createTemplateFormCategoryItemNode_current),c(),m()};d(),s.addEvent("click",function(){this.app.removeEvent("resize",l),i.destroy(),s.destroy()}.bind(this))},_loadItemDataList:function(e){this.app.restActions.listSource(this.app.options.application.id,e)},_getItemObject:function(e){return new MWF.xApplication.portal.PortalManager.SourceExplorer.Source(this,e)},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteSource():e.deleteSource(function(){}.bind(this))}}}),MWF.xApplication.portal.PortalManager.SourceExplorer.Source=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,_open:function(e){var t=this,s={onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.application=t.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"portal.SourceDesigner",s)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'portal.SourceDesigner#{"id": "'+this.data.id+'"}'}},deleteSource:function(e){this.explorer.actions.deleteSource(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))}});