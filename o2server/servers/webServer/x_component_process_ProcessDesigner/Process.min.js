MWF.xApplication=MWF.xApplication||{},MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.ProcessDesigner=MWF.xApplication.process.ProcessDesigner||{},MWF.APPPD=MWF.xApplication.process.ProcessDesigner,MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("process.ProcessDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("process.ProcessDesigner","Property",null,!1),MWF.xDesktop.requireApp("process.ProcessDesigner","Activity",null,!1),MWF.xDesktop.requireApp("process.ProcessDesigner","Route",null,!1),MWF.xApplication.process.ProcessDesigner.Process=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isView:!1},initialize:function(t,e,i,s){this.setOptions(s),this.path="../x_component_process_ProcessDesigner/$Process/",this.cssPath="../x_component_process_ProcessDesigner/$Process/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=i,this.process=e,this.process.projectionData=e.project?JSON.parse(e.project):null,this.paper=t,this.designer.application&&(this.process.applicationName=this.designer.application.name),this.designer.application&&(this.process.application=this.designer.application.id),this.activityTemplates=null,this.routeTemplates=null,this.begin=null,this.ends={},this.cancels={},this.manuals={},this.conditions={},this.choices={},this.splits={},this.parallels={},this.merges={},this.embeds={},this.delays={},this.invokes={},this.services={},this.agents={},this.messages={},this.activitys=[],this.selectedActivitys=[],this.selectedActivityDatas=[],this.scripts={},this.routes={},this.routeDatas={},this.isGrid=!0,this.loadedBegin=!1,this.loadedEnds=!1,this.loadedCancels=!1,this.loadedConditions=!1,this.loadedChoices=!1,this.loadedManuals=!1,this.loadedSplits=!1,this.loadedParallels=!1,this.loadedMerges=!1,this.loadedEmbeds=!1,this.loadedDelays=!1,this.loadedInvokes=!1,this.loadedServices=!1,this.loadedAgents=!1,this.loadedMessages=!1,this.isCreateRoute=!1,this.currentCreateRoute=null,this.isCopyRoute=!1,this.currentCopyRoute=null,this.isBrokenLine=!1,this.isChangeRouteTo=!1,this.isChangeRouteFrom=!1,this.currentChangeRoute=null,this.unSelectedEvent=!0,this.panel=null,this.property=null,this.isNewProcess=!this.process.id},load:function(){this.createPropertyPanel(),this.loadProcessActivitys(function(){this.loadProcessRoutes(),this.loadActivityRoutes(),this.loadProcessScripts(),this.checkLoadRoutes(),this.isNewProcess&&this.checkUUID(),this.fireEvent("postLoad")}.bind(this)),this.setEvent(),this.setMenu(),this.showProperty(),this.showEditionInfor()},checkLoadRoutes:function(){Object.each(this.routes,(function(t){t.loaded||t.load()}))},checkUUID:function(){this.process.isNewProcess=!0;var t=this.process.begin?2:1;t+=this.process.endList?this.process.endList.length:0,t+=this.process.manualList?this.process.manualList.length:0,t+=this.process.conditionList?this.process.conditionList.length:0,t+=this.process.choiceList?this.process.choiceList.length:0,t+=this.process.parallelList?this.process.parallelList.length:0,t+=this.process.splitList?this.process.splitList.length:0,t+=this.process.mergeList?this.process.mergeList.length:0,t+=this.process.embedList?this.process.embedList.length:0,t+=this.process.invokeList?this.process.invokeList.length:0,t+=this.process.cancelList?this.process.cancelList.length:0,t+=this.process.delayList?this.process.delayList.length:0,t+=this.process.messageList?this.process.messageList.length:0,t+=this.process.serviceList?this.process.serviceList.length:0,t+=this.process.routeList?this.process.routeList.length:0,this.designer.actions.getId(t,function(t){this.checkUUIDs=t.data,this.process.id=this.checkUUIDs.pop().id,this.process.createTime=(new Date).format("db"),this.process.updateTime=(new Date).format("db");for(var e=0;e<this.activitys.length;e++)"begin"!=this.activitys[e].type&&delete this[this.activitys[e].type+"s"][this.activitys[e].data.id],this.activitys[e].data.id=this.checkUUIDs.pop().id,this.activitys[e].data.process=this.process.id,"begin"!=this.activitys[e].type&&(this[this.activitys[e].type+"s"][this.activitys[e].data.id]=this.activitys[e]);for(e=0;e<this.activitys.length;e++)this.activitys[e].checkUUID()}.bind(this))},loadProcessScripts:function(){this.process.scriptList&&this.process.scriptList.each(function(t){this.scripts[t.id]=t}.bind(this))},setStyle:function(t){this.options.style=t,this.reload(this.process)},reload:function(t){(this.panel.destroy(),this.paper.clear(),this.initialize(this.paper,t,this.designer,this.options),this.createPropertyPanel(),this.loadProcessActivitys(function(){this.loadProcessRoutes(),this.loadActivityRoutes(),this.checkLoadRoutes()}.bind(this)),this.showProperty(),this.showEditionInfor(),t&&this.designer.options.id!=t.id)&&(layout.desktop.apps["process.ProcessDesigner"+this.designer.options.id]&&(delete layout.desktop.apps["process.ProcessDesigner"+this.designer.options.id],this.designer.appId="process.ProcessDesigner"+t.id,layout.desktop.apps[this.designer.appId]=this.designer),this.designer.setOptions({id:t.id}))},setEvent:function(){this.paper.canvas.addEvent("selectstart",(function(t){t.preventDefault(),t.stopPropagation()})),this.options.isView||(this.paper.canvas.addEvent("click",function(t){this.unSelectedEvent?(this.currentSelected||this.selectedActivitys.length)&&this.unSelected(t):this.unSelectedEvent=!0}.bind(this)),this.paper.canvas.addEvent("mousedown",function(t){this.checkCreateRoute(t),this.checkSelectMulti(t)}.bind(this)))},checkSelectMulti:function(t){if(!t.rightClick){var e=t.event.offsetX,i=t.event.offsetY;this.paper.getElementsByPoint(e,i).length||this.isCreateRoute||this.isCopyRoute||(this.checkSelectMultiMouseMoveBind=function(t){this.checkSelectMultiMouseMove(t,{x:e,y:i})}.bind(this),this.checkSelectMultiMouseUpBind=function(t){this.checkSelectMultiStop(t,{x:e,y:i})}.bind(this),this.paper.canvas.addEvent("mousemove",this.checkSelectMultiMouseMoveBind),this.paper.canvas.addEvent("mouseup",this.checkSelectMultiMouseUpBind))}},unSelectedAll:function(){this.currentSelected&&this.currentSelected.unSelected(),this.property.hide(),this.selectedActivitys.each((function(t){t.unSelectedMulti()})),this.selectedActivitys=[],this.selectedActivityDatas=[]},checkSelectMultiMouseMove:function(t,e){var i={x:t.event.offsetX,y:t.event.offsetY};if(MWFRaphael.getPointDistance(e,i)>8&&(this.paper.canvas.removeEvent("mousemove",this.checkSelectMultiMouseMoveBind),!(this.isCreateRoute||this.isCopyRoute||this.isBrokenLine||this.isChangeRouteTo||this.isChangeRouteFrom))){var s=Math.min(e.x,i.x),o=Math.min(e.y,i.y),n=Math.abs(i.x-e.x),a=Math.abs(i.y-e.y),r=this.paper.rect(s,o,n,a,0).attr({fill:"#a8caec",stroke:"#3399ff","stroke-width":"0.8","fill-opacity":.5});this.beginSelectMultiMouseMoveBind=function(t){this.beginSelectMultiMouseMove(t,e,r)}.bind(this),this.endSelectMultiMouseMoveBind=function(t){return this.endSelectMulti(t,e,r)}.bind(this),this.unSelectedAll(),this.paper.canvas.addEvent("mousemove",this.beginSelectMultiMouseMoveBind),this.paper.canvas.addEvent("mouseup",this.endSelectMultiMouseMoveBind)}},checkSelectMultiStop:function(){this.paper.canvas.removeEvent("mousemove",this.checkSelectMultiMouseMoveBind)},beginSelectMultiMouseMove:function(t,e,i){var s={x:t.event.offsetX,y:t.event.offsetY},o=Math.min(e.x,s.x),n=Math.min(e.y,s.y),a=Math.abs(s.x-e.x),r=Math.abs(s.y-e.y);i.attr({x:o,y:n,width:a,height:r}),this.checkSelectActivity(t,e,i)},endSelectMulti:function(t,e,i){return i.remove(),this.selectedActivityDatas.length&&(this.panel.data=this.selectedActivityDatas),this.paper.canvas.removeEvent("mousemove",this.beginSelectMultiMouseMoveBind),this.paper.canvas.removeEvent("mouseup",this.endSelectMultiMouseMoveBind),this.selectedActivitys.length&&(this.unSelectedEvent=!1,window.setTimeout(function(){this.unSelectedEvent=!0}.bind(this),300)),!1},checkSelectActivity:function(t,e,i){var s={x:t.event.offsetX,y:t.event.offsetY},o=Math.min(e.x,s.x),n=Math.min(e.y,s.y),a=Math.max(e.x,s.x),r=Math.max(e.y,s.y);this.activitys.each(function(t){var e=t.center.x,i=t.center.y;e>o&&e<a&&i>n&&i<r?t.selectedMultiStatus||t.selectedMulti():(this.selectedActivitys.erase(t),this.selectedActivityDatas.erase(t.data),t.unSelectedMulti())}.bind(this)),this.selectedActivityDatas.length?(this.property&&this.property.showMultiActivity(this.selectedActivitys),this.panel.propertyTabPage.showTabIm(),this.panel.data=this.selectedActivityDatas):(this.unSelectedAll(),this.showProperty())},showProperty:function(){this.property?this.property.show():(this.property=new MWF.APPPD.Process.Property(this,{onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},showEditionInfor:function(){if(this.process.edition&&(this.designer.processEditionNode&&(this.designer.processEditionNode.removeEvents("click"),this.process.editionEnable?(this.designer.processEditionNode.set("text",this.designer.lp.enable),this.designer.processEditionNode.addClass("mainColor_bg")):(this.designer.processEditionNode.set("text",this.designer.lp.notEnable),this.designer.processEditionNode.removeClass("mainColor_bg"),this.designer.processEditionNode.addEvent("click",function(t){this.enableCurrentEdition(t)}.bind(this)))),this.designer.processEditionInforNode)){var t=this.designer.lp.currentEdition+": <span class='mainColor_color'>"+this.process.editionNumber+"</span> "+this.designer.lp.editionUpdate+": <span class='mainColor_color'>"+o2.name.cn(this.process.lastUpdatePerson)+" ("+this.process.updateTime+")</span>";this.designer.processEditionInforNode.set("html",t),this.designer.processEditionInforNode.addEvent("click",function(t){this.listEdition(t)}.bind(this))}},enableCurrentEdition:function(t){var e=this;this.designer.confirm("infor",t,this.designer.lp.edition_list.enabledProcessTitle,{html:this.designer.lp.edition_list.enabledProcessInfor},600,120,(function(){e.save(function(){var t=o2.Actions.load("x_processplatform_assemble_designer").ProcessAction;t.enableProcess(this.process.id,function(e){t.get(this.process.id,function(t){this.reload(t.data)}.bind(this))}.bind(this))}.bind(e)),this.close()}),(function(){this.close()}))},unSelected:function(t){this.paper.getElementsByPoint(t.event.offsetX,t.event.offsetY).length||(this.unSelectedAll(),this.showProperty())},setMenu:function(){MWF.require("MWF.widget.Menu",function(){this.menu=new MWF.widget.Menu(this.paper.canvas,{onQueryShow:function(t){var e=this.getPointElement(t.event.offsetX,t.event.offsetY);switch(e.type){case"activity":this.addActivityMenu(e.bind);break;case"route":this.addRouteMenu(e.bind);break;default:this.addProcessMenu()}}.bind(this)}),this.menu.load()}.bind(this))},addPublicMenu:function(t,e){var i=e;i||(i=this.createRoute.bind(this)),this.menu.addMenuItem(MWF.APPPD.LP.menu.newRoute,"click",i,this.designer.path+""+this.options.style+"/toolbarIcon/newRouter.gif"),this.newActivityMenu||(MWF.require("MWF.widget.Menu",null,!1),this.newActivityMenu=new MWF.widget.Menu(this.paper.canvas,{event:null}),this.newActivityMenu.load(),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.manual,"click",this.createManualActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/manual.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.condition,"click",this.createConditionActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/condition.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.auto,"click",this.createAutoActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/auto.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.split,"click",this.createSplitActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/split.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.merge,"click",this.createMergeActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/merge.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.embed,"click",this.createEmbedActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/embed.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.invoke,"click",this.createInvokesActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/invoke.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.begin,"click",this.createBeginActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/begin.gif"),this.newActivityMenu.addMenuItem(MWF.APPPD.LP.menu.newActivityType.end,"click",this.createEndActivity.bind(this),this.designer.path+""+this.designer.options.style+"/toolbarIcon/end.gif")),this.menu.addMenuMenu(MWF.APPPD.LP.menu.newActivity,this.designer.path+""+this.options.style+"/toolbarIcon/newActivity.gif",this.newActivityMenu)},addActivityMenu:function(t){this.menu.clearItems();this.addPublicMenu(t,(function(){t.quickCreateRoute()})),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.copyActivity,"click",function(e){this.copyActivity(t)}.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/copy.png"),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.deleteActivity,"click",function(e){this.deleteActivity(e,t)}.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/deleteActivity.gif")},addRouteMenu:function(t){this.menu.clearItems(),this.addPublicMenu(),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.deleteRoute,"click",function(e){this.deleteRoute(e,t)}.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/deleteRouter.gif")},addProcessMenu:function(){var t=this;this.menu.clearItems(),this.addPublicMenu(),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.saveProcess,"click",this.save.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/save.gif"),this.menu.addMenuItem(MWF.APPPD.LP.menu.saveProcessNew,"click",this.saveNew.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/saveNew.gif",!0),this.menu.addMenuLine(),this.isGrid?this.menu.addMenuItem(MWF.APPPD.LP.menu.hideGrid,"click",(function(){t.switchGrid(this)}),this.designer.path+""+this.options.style+"/toolbarIcon/gridding.gif"):this.menu.addMenuItem(MWF.APPPD.LP.menu.showGrid,"click",(function(){t.switchGrid(this)}),this.designer.path+""+this.options.style+"/toolbarIcon/gridding.gif"),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.checkProcess,"click",this.checkProcess.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/checkProcess.gif",!0),this.menu.addMenuItem(MWF.APPPD.LP.menu.exportProcess,"click",this.exportProcess.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/processExplode.gif",!0),this.menu.addMenuLine(),this.menu.addMenuItem(MWF.APPPD.LP.menu.printProcess,"click",this.printProcess.bind(this),this.designer.path+""+this.options.style+"/toolbarIcon/print.gif",!0)},saveNew:function(t){this.designer.alert("error",t,"",MWF.APPPD.LP.unrealized,220,100)},checkProcess:function(t){this.designer.alert("error",t,"",MWF.APPPD.LP.unrealized,220,100)},exportProcess:function(t){this.designer.alert("error",t,"",MWF.APPPD.LP.unrealized,220,100)},printProcess:function(t){this.designer.alert("error",t,"",MWF.APPPD.LP.unrealized,220,100)},saveNewEdition:function(t){if(this.process.isNewProcess)this.save();else{var e=new Element("div",{styles:this.designer.css.saveNewEditionNode}),i=(new Element("div",{html:this.designer.lp.upgradeInfor}).inject(e),new Element("div",{styles:this.designer.css.editionDescriptionNode}).inject(e)),s=(new Element("div",{styles:this.designer.css.descriptionTitleNode,text:this.designer.lp.editionDiscription}).inject(i),new Element("textarea",{styles:this.designer.css.descriptionTextAreaNode}).inject(i),this);o2.DL.open({content:e,title:this.designer.lp.upgradeConfirm,offset:{y:-100},height:340,width:580,buttonList:[{type:"ok",text:this.designer.lp.ok,action:function(){var t=this.content.getElement("textarea").get("value");if(t){var e=this.content.getElement("input"),o=!!e&&e.get("checked");s.doSaveNewEdition(o,t),this.close()}else s.designer.notice(s.designer.lp.inputDiscription,"error",i)}},{type:"cancel",text:this.designer.lp.cancel,action:function(){this.close()}}]})}},doSaveNewEdition:function(t,e){var i=Object.clone(this.process);i.editionDes=e;var s=[];s.push(i.id),i.begin&&s.push(i.begin.id),i.endList&&i.endList.each((function(t){s.push(t.id)})),i.agentList&&i.agentList.each((function(t){s.push(t.id)})),i.manualList&&i.manualList.each((function(t){s.push(t.id)})),i.conditionList&&i.conditionList.each((function(t){s.push(t.id)})),i.choiceList&&i.choiceList.each((function(t){s.push(t.id)})),i.parallelList&&i.parallelList.each((function(t){s.push(t.id)})),i.splitList&&i.splitList.each((function(t){s.push(t.id)})),i.mergeList&&i.mergeList.each((function(t){s.push(t.id)})),i.embedList&&i.embedList.each((function(t){s.push(t.id)})),i.invokeList&&i.invokeList.each((function(t){s.push(t.id)})),i.cancelList&&i.cancelList.each((function(t){s.push(t.id)})),i.delayList&&i.delayList.each((function(t){s.push(t.id)})),i.messageList&&i.messageList.each((function(t){s.push(t.id)})),i.serviceList&&i.serviceList.each((function(t){s.push(t.id)})),i.routeList&&i.routeList.each((function(t){s.push(t.id)}));var o=o2.Actions.load("x_processplatform_assemble_designer");this.designer.actions.getId(s.length,function(e){var n=e.data,a=JSON.encode(i);s.each(function(t,e){var i=new RegExp(t,"ig");a=a.replace(i,n[e].id)}.bind(this)),i=JSON.decode(a),o.ProcessAction.upgrade(this.process.id,i,function(e){var i=e.data.id;t?o.ProcessAction.enableProcess(i,function(t){o.ProcessAction.get(i,function(t){this.reload(t.data)}.bind(this))}.bind(this)):o.ProcessAction.get(i,function(t){this.reload(t.data)}.bind(this))}.bind(this))}.bind(this))},listEdition:function(){this.process.edition?this.editionListDlg?this.editionListDlg.show():MWF.xDesktop.requireApp("process.ProcessDesigner","widget.EditionList",function(){this.editionListDlg=new MWF.xApplication.process.ProcessDesigner.widget.EditionList(this.process.application,this.process.edition,this),this.editionListDlg.load()}.bind(this)):this.designer.notice("infor",this.designer.lp.save_process)},listEditionDlg:function(t){},switchGrid:function(t){this.isGrid?this.hideGrid():this.showGrid()},showGrid:function(){this.designer.paperNode.setStyle("background-image","url("+MWF.defaultPath+"/process/ProcessChart/$Process/"+this.options.style+"/griddingbg.gif)"),this.isGrid=!0},hideGrid:function(){this.designer.paperNode.setStyle("background-image",""),this.isGrid=!1},getPointElement:function(t,e){var i=this.paper.getElementsByPoint(t,e),s=null,o="none";if(i.length)for(var n=0;n<i.length;n++){var a=i[n].data("bind");if(a){if(instanceOf(a,MWF.APPPD.Activity)){s=a,o="activity";break}instanceOf(a,MWF.APPPD.Route)&&(s=a,o="route")}}return{bind:s,type:o}},loadActivityRoutes:function(){this.activitys.each((function(t){t.loadRoutes()}))},loadProcessRoutes:function(){this.process.routeList.each(function(t){this.routes[t.id]=new MWF.APPPD.Route(t,this),this.routeDatas[t.id]=t}.bind(this))},createPropertyPanel:function(){this.options.isView||(this.panel=new MWF.APPPD.Process.Panel(this),this.panel.load())},loadedActivitys:function(t){this.loadedBegin&&this.loadedEnds&&this.loadedCancels&&this.loadedConditions&&this.loadedChoices&&this.loadedSplits&&this.loadedParallels&&this.loadedMerges&&this.loadedManuals&&this.loadedEmbeds&&this.loadedDelays&&this.loadedInvokes&&this.loadedServices&&this.loadedAgents&&this.loadedMessages&&t&&t()},loadProcessActivitys:function(t){this.loadBegin(function(){this.loadedBegin=!0,this.loadedActivitys(t)}.bind(this)),this.loadEndList(function(){this.loadedEnds=!0,this.loadedActivitys(t)}.bind(this)),this.loadCancelList(function(){this.loadedCancels=!0,this.loadedActivitys(t)}.bind(this)),this.loadManualList(function(){this.loadedManuals=!0,this.loadedActivitys(t)}.bind(this)),this.loadConditionList(function(){this.loadedConditions=!0,this.loadedActivitys(t)}.bind(this)),this.loadChoiceList(function(){this.loadedChoices=!0,this.loadedActivitys(t)}.bind(this)),this.loadSplitList(function(){this.loadedSplits=!0,this.loadedActivitys(t)}.bind(this)),this.loadParallelList(function(){this.loadedParallels=!0,this.loadedActivitys(t)}.bind(this)),this.loadMergeList(function(){this.loadedMerges=!0,this.loadedActivitys(t)}.bind(this)),this.loadEmbedList(function(){this.loadedEmbeds=!0,this.loadedActivitys(t)}.bind(this)),this.loadDelayList(function(){this.loadedDelays=!0,this.loadedActivitys(t)}.bind(this)),this.loadInvokeList(function(){this.loadedInvokes=!0,this.loadedActivitys(t)}.bind(this)),this.loadServiceList(function(){this.loadedServices=!0,this.loadedActivitys(t)}.bind(this)),this.loadAgentList(function(){this.loadedAgents=!0,this.loadedActivitys(t)}.bind(this)),this.loadMessageList(function(){this.loadedMessages=!0,this.loadedActivitys(t)}.bind(this))},loadBegin:function(t){var e=this.process.begin;e?(this.begin=new MWF.APPPD.Activity.Begin(e,this),this.begin.load(t)):t&&t(),this.activitys.push(this.begin)},loadEndList:function(t){this.loadActivitys("End","endList",this.ends,t)},loadCancelList:function(t){this.loadActivitys("Cancel","cancelList",this.cancels,t)},loadManualList:function(t){this.loadActivitys("Manual","manualList",this.manuals,t)},loadConditionList:function(t){this.loadActivitys("Condition","conditionList",this.conditions,t)},loadChoiceList:function(t){this.loadActivitys("Choice","choiceList",this.choices,t)},loadSplitList:function(t){this.loadActivitys("Split","splitList",this.splits,t)},loadParallelList:function(t){this.loadActivitys("Parallel","parallelList",this.parallels,t)},loadMergeList:function(t){this.loadActivitys("Merge","mergeList",this.merges,t)},loadEmbedList:function(t){this.loadActivitys("Embed","embedList",this.embeds,t)},loadDelayList:function(t){this.loadActivitys("Delay","delayList",this.delays,t)},loadInvokeList:function(t){this.loadActivitys("Invoke","invokeList",this.invokes,t)},loadServiceList:function(t){this.loadActivitys("Service","serviceList",this.services,t)},loadAgentList:function(t){this.loadActivitys("Agent","agentList",this.agents,t)},loadMessageList:function(t){this.loadActivitys("Message","messageList",this.messages,t)},loadActivitys:function(t,e,i,s){var o=this.process[e];if(o){var n=o.length,a=0;n?o.each(function(e){this.loadActivity(t,e,i,function(){++a==n&&s&&s()}.bind(this))}.bind(this)):s&&s()}else s&&s()},loadActivity:function(t,e,i,s){activity=new MWF.APPPD.Activity[t](e,this),activity.load(s),"begin"===t?this.begin=activity:i[e.id]=activity,this.activitys.push(activity)},destroy:function(){this.paper.remove()},checkActivityEmptyRouteList:function(t){t&&t.length&&t.each((function(t){t.routeList&&(t.routeList=t.routeList.filter((function(t){return!!t})))}))},checkEmptyRouteList:function(){this.checkActivityEmptyRouteList(this.process.endList),this.checkActivityEmptyRouteList(this.process.cancelList),this.checkActivityEmptyRouteList(this.process.manualList),this.checkActivityEmptyRouteList(this.process.conditionList),this.checkActivityEmptyRouteList(this.process.choiceList),this.checkActivityEmptyRouteList(this.process.splitList),this.checkActivityEmptyRouteList(this.process.parallelList),this.checkActivityEmptyRouteList(this.process.mergeList),this.checkActivityEmptyRouteList(this.process.embedList),this.checkActivityEmptyRouteList(this.process.delayList),this.checkActivityEmptyRouteList(this.process.invokeList),this.checkActivityEmptyRouteList(this.process.serviceList),this.checkActivityEmptyRouteList(this.process.agentList),this.checkActivityEmptyRouteList(this.process.messageList)},save:function(t){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{this.isSave=!0,this.checkEmptyRouteList();var e=!!this.process.isNewProcess;this.designer.actions.saveProcess(this.process,function(i){this.isSave=!1,this.process.isNewProcess=!1,this.designer.notice(MWF.APPPD.LP.notice.save_success,"ok",null,{x:"left",y:"bottom"}),this.isNewProcess=!1,this.designer.options.id=i.data.id,e?this.designer.actions.getProcess(i.data.id,function(e){this.reload(e.data),t&&t()}.bind(this)):t&&t()}.bind(this),function(t,e,i){this.isSave=!1;var s=i+":"+e;t&&(s=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+s)}.bind(this))}},getActivityTemplate:function(t){if(this.activityTemplates)t&&t();else{var e=this.path+"activity.json";new Request.JSON({url:e,secure:!1,async:!1,method:"get",noCache:!0,onSuccess:function(e,i){this.activityTemplates=e,t&&t()}.bind(this),onError:function(t,e){alert(e)}}).send()}},getRouteTemplates:function(t){if(this.routeTemplates)t&&t();else{var e=this.path+"route.json";new Request.JSON({url:e,secure:!1,async:!1,method:"get",noCache:!0,onSuccess:function(e,i){this.routeTemplates=e,t&&t()}.bind(this),onError:function(t,e){alert(e)}}).send()}},createActivity:function(t,e,i){if("begin"==t&&this.begin)return this.designer.notice(MWF.APPPD.LP.notice.one_begin,"error",null,{x:"right",y:"top"}),!1;var s=null;return this.getActivityTemplate(function(){var o=Object.clone(this.activityTemplates[t]);this.designer.actions.getUUID((function(t){o.id=t})),o.process=this.process.id,o.createTime=(new Date).format("db"),o.updateTime=(new Date).format("db"),o.position=i.x+","+i.y,(s=new MWF.APPPD.Activity[e](o,this)).create(i),"begin"==t?(this.begin=s,this.process.begin=o):(this[t+"s"][o.id]=s,this.process[t+"List"]||(this.process[t+"List"]=[]),this.process[t+"List"].push(o)),this.activitys.push(s)}.bind(this)),s},createManualActivity:function(){this.createActivity("manual","Manual")},createConditionActivity:function(){this.createActivity("condition","Condition")},createAutoActivity:function(){this.createActivity("auto","Auto")},createSplitActivity:function(){this.createActivity("split","Split")},createMergeActivity:function(){this.createActivity("merge","Merge")},createEmbedActivity:function(){this.createActivity("embed","Embed")},createInvokesActivity:function(){this.createActivity("invoke","Invoke")},createBeginActivity:function(){this.createActivity("begin","Begin")},createEndActivity:function(){this.createActivity("end","End")},createRoute:function(){this.isCopyRoute||this.isCreateRoute||this.getRouteTemplates(function(){var t=Object.clone(this.routeTemplates.route);this.designer.actions.getUUID((function(e){t.id=e})),t.process=this.process.id,t.createTime=(new Date).format("db"),t.updateTime=(new Date).format("db");var e=new MWF.APPPD.Route(t,this);e.isBack=!0,e.load(),e.set.toBack(),this.beginRouteCreate(e)}.bind(this))},beginRouteCreate:function(t){this.isCreateRoute=!0,this.currentCreateRoute=t,this.designer.setToolBardisabled("createRoute"),this.routeCreateFromMouseMoveBind=function(t){this.routeCreateFromMouseMove(t)}.bind(this),this.paper.canvas.addEvent("mousemove",this.routeCreateFromMouseMoveBind)},routeCreateFromMouseMove:function(t){var e=t.event.offsetX.toFloat(),i=t.event.offsetY.toFloat(),s=e-this.currentCreateRoute.beginPoint.x-5,o=i-this.currentCreateRoute.beginPoint.y+5;this.currentCreateRoute.set.transform("t"+s+","+o)},routeCreateFromActivity:function(t){this.paper.canvas.removeEvent("mousemove",this.routeCreateFromMouseMoveBind);var e=this.currentCreateRoute;e.setActivity(null,t),e.reload(),this.routeCreateToMouseMoveBind=function(t){this.routeCreateToMouseMove(t)}.bind(this),this.paper.canvas.addEvent("mousemove",this.routeCreateToMouseMoveBind)},routeCreateToMouseMove:function(t){var e=t.event.offsetX.toFloat(),i=t.event.offsetY.toFloat(),s=this.currentCreateRoute;s.tmpEndPoint={x:e-3,y:i-3},s.reload()},routeCreateToActivity:function(t){this.paper.canvas.removeEvent("mousemove",this.routeCreateToMouseMoveBind);var e=this.currentCreateRoute;e.tmpEndPoint=null,e.tmpBeginPoint=null,e.setActivity(t,null),e.isBack=!1,e.reload(),t.shap.attr(t.style.shap),this.endRouteCreate()},endRouteCreate:function(){var t=this.currentCreateRoute;t.selected(),this.isCreateRoute=!1,this.currentCreateRoute=null,t.setListItemData(),this.designer.setToolBardisabled("decision"),this.setNewRouteProcessData(t)},setNewRouteProcessData:function(t){this.routes[t.data.id]=t,this.process.routeList.push(t.data),t.fromActivity.setRouteData(t.data.id),t.data.activity=t.toActivity.data.id,t.data.activityType=t.toActivity.type},routeCreateCancel:function(){var t=this.currentCreateRoute;t.fromActivity&&t.fromActivity.routes.erase(t),t.destroy(),delete t,this.isCreateRoute=!1,this.currentCreateRoute=null,this.routeCreateFromMouseMoveBind&&this.paper.canvas.removeEvent("mousemove",this.routeCreateFromMouseMoveBind),this.routeCreateToMouseMoveBind&&this.paper.canvas.removeEvent("mousemove",this.routeCreateToMouseMoveBind)},checkCreateRoute:function(t){(this.isCreateRoute||this.isCopyRoute)&&(t.rightClick&&(this.isCreateRoute&&this.routeCreateCancel(),this.isCopyRoute&&this.routeAddCancel()),this.menu&&this.menu.pause(1))},clearSelected:function(){for(a in this.begin.unSelectActivity(),this.ends)this.ends[a].unSelected();for(a in this.conditions)this.conditions[a].unSelected();for(a in this.autos)this.autos[a].unSelected();for(a in this.manuals)this.manuals[a].unSelected();for(a in this.embeds)this.embeds[a].unSelected();for(a in this.invokes)this.invokes[a].unSelected()},copyRoute:function(t){if(!this.isCopyRoute&&!this.isCreateRoute){var e=Object.clone(t.data);this.designer.actions.getUUID((function(t){e.id=t})),(t=new MWF.APPPD.Route(e,this)).load(),t.isBack=!0,this.isCopyRoute=!0,this.currentCopyRoute=t,this.beginRouteCopy(t)}},beginRouteCopy:function(t){this.routeCopyMouseMoveBind=function(e){this.copyRouteMouseMove(e,t)}.bind(this),this.paper.canvas.addEvent("mousemove",this.routeCopyMouseMoveBind)},copyRouteMouseMove:function(t,e){e.tmpBeginPoint={x:t.event.offsetX-5,y:t.event.offsetY-5},e.reload()},routeAddFromActivity:function(t){var e=this.currentCopyRoute;this.paper.canvas.removeEvent("mousemove",this.routeCopyMouseMoveBind),e.setActivity(null,t),e.isBack=!1,e.reload(),t.shap.attr(t.style.shap),this.endRouteCopy()},endRouteCopy:function(){var t=this.currentCopyRoute;t.selected(),this.isCopyRoute=!1,this.currentCopyRoute=null,t.setListItemData(),this.designer.setToolBardisabled("decision"),this.setCopyRouteProcessData(t)},routeAddCancel:function(){var t=this.currentCopyRoute;t.destroy(),delete t,this.isCopyRoute=!1,this.currentCopyRoute=null,this.routeAddMouseMoveBind&&this.paper.canvas.removeEvent("mousemove",this.routeAddMouseMoveBind)},setCopyRouteProcessData:function(t){this.process.routeList.push(t.data),t.fromActivity.setRouteData(t.data.id),this.routeDatas[t.data.id]=t.data},deleteRoute:function(t,e){var i=this;this.designer.shortcut=!1,this.designer.confirm("warn",t,MWF.APPPD.LP.notice.deleteRouteTitle,MWF.APPPD.LP.notice.deleteRoute,300,120,(function(){e.destroy(),delete e,i.designer.shortcut=!0,this.close()}),(function(){i.designer.shortcut=!0,this.close()}),null)},copyActivity:function(t){var e=Object.clone(t.data),i=t.type,s=i.capitalize();this.designer.actions.getUUID((function(t){e.id=t})),e.process=this.process.id,(t=new MWF.APPPD.Activity[s](e,this)).create(),t.selected(),"begin"==i?(this.begin=t,this.process.begin=e):(this[i+"s"][e.id]=t,this.process[i+"List"]||(this.process[i+"List"]=[]),this.process[i+"List"].push(e))},deleteActivity:function(t,e){var i=this;this.designer.shortcut=!1,this.designer.confirm("warn",t,MWF.APPPD.LP.notice.deleteActivityTitle,MWF.APPPD.LP.notice.deleteActivity,300,120,(function(){e.destroy(),delete e,i.designer.shortcut=!0,this.close()}),(function(){i.designer.shortcut=!0,this.close()}),null)},explode:function(){MWF.require("MWF.widget.Base64",null,!1);MWF.widget.Base64.encode(JSON.encode(this.process));MWF.require("MWF.widget.Panel",function(){var t=new Element("div"),e=this.designer.paperNode.getPosition(this.designer.paperNode.getOffsetParent());new Element("textarea",{styles:{border:"1px solid #999",width:"770px","margin-left":"14px","margin-top":"14px",height:"580px"},text:JSON.encode(this.process)}).inject(t);this.explodePanel=new MWF.widget.Panel(t,{style:"form",isResize:!1,isMax:!1,title:"",width:800,height:660,top:e.y,left:e.x+3,isExpand:!1,target:this.designer.node}),this.explodePanel.load()}.bind(this))}}),MWF.xApplication.process.ProcessDesigner.Process.Panel=new Class({initialize:function(t){this.process=t,this.width=370,this.top=0;var e=this.process.designer.paperNode.getSize();this.left=e.x.toFloat()-376,this.height=e.y.toFloat()-6,this.stopParseJson=!1},load:function(){this.panelNode=new Element("div"),this.createModuleListTab(),this.createPropertyTab(),this.createPanelResizeNode(),this.moduleTabContent.inject(this.panelNode),this.panelResizeNode.inject(this.panelNode),this.propertyTabContent.inject(this.panelNode),MWF.require("MWF.widget.Panel",function(){this.modulePanel=new MWF.widget.Panel(this.panelNode,{title:MWF.APPPD.LP.property,isClose:!1,target:this.process.designer.paperNode,height:this.height,width:this.width,left:this.left,top:this.top,transition:Fx.Transitions.linear.easeIn,transitionOut:Fx.Transitions.linear.easeOut,duration:100,onResize:function(){this.setPanelSize(this.panelModulePercent)}.bind(this)}),this.modulePanel.load(),this.setPanelSize(this.panelModulePercent)}.bind(this))},setPanelSize:function(t){var e=this.modulePanel.content.getSize(),i=this.panelResizeNode.getSize(),s=this.panelResizeNode.getStyle("margin-top"),o=this.panelResizeNode.getStyle("margin-bottom"),n=e.y.toFloat()-i.y.toFloat()-s.toFloat()-o.toFloat(),a=t;a||(a=.3);var r=n*a,c=n-r;this.moduleListContent.setStyle("height",r),this.propertyPanel||this.propertyListContent.setStyle("height",c);var h=this.moduleListTab.tabNodeContainer.getSize();if(this.moduleListTab.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),s=r-e-i-h.y.toFloat()-2;t.contentNodeArea.setStyle("height",s)}.bind(this)),!this.propertyPanel){var d=this.propertyListTab.tabNodeContainer.getSize();this.propertyListTab.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),s=c-e-i-d.y.toFloat()-2;t.contentNodeArea.setStyle("height",s)}.bind(this))}this.jsonStringConfirmNode&&this.setJsonStringConfirmNodePosition()},createPanelResizeNode:function(){this.panelResizeNode=new Element("div",{styles:this.process.css.panelResizeNode}),this.panelResizeNode.addEvent("mousedown",function(t){this.beginPanelResize(t)}.bind(this))},beginPanelResize:function(){this.panelResizeMouseMoveBind=function(t){this.panelResize(t)}.bind(this),this.panelResizeMouseUpBind=function(){$(document.body).removeEvent("selectstart",this.panelResizeSelecttBind),$(document.body).removeEvent("mousemove",this.panelResizeMouseMoveBind),$(document.body).removeEvent("mouseup",this.panelResizeMouseUpBind)}.bind(this),this.panelResizeSelecttBind=function(){return!1}.bind(this),$(document.body).addEvent("selectstart",this.panelResizeSelecttBind),$(document.body).addEvent("mousemove",this.panelResizeMouseMoveBind),$(document.body).addEvent("mouseup",this.panelResizeMouseUpBind)},panelResize:function(t){var e=t.event.pageY,i=this.moduleListContent.getPosition(),s=e.toFloat()-i.y.toFloat();s<40&&(s=40);var o=this.modulePanel.content.getSize(),n=this.panelResizeNode.getSize(),a=this.panelResizeNode.getStyle("margin-top"),r=this.panelResizeNode.getStyle("margin-bottom"),c=o.y.toFloat()-n.y.toFloat()-a.toFloat()-r.toFloat(),h=c-s;h<40&&(s=c-(h=40)),this.moduleListContent.setStyle("height",s),this.propertyListContent.setStyle("height",h);var d=this.moduleListTab.tabNodeContainer.getSize(),l=this.propertyListTab.tabNodeContainer.getSize();this.moduleListTab.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),o=s-e-i-d.y.toFloat()-2;t.contentNodeArea.setStyle("height",o)}.bind(this)),this.propertyListTab.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),i=t.contentNodeArea.getStyle("margin-bottom").toFloat(),s=h-e-i-l.y.toFloat()-2;t.contentNodeArea.setStyle("height",s)}.bind(this)),this.jsonStringConfirmNode&&this.setJsonStringConfirmNodePosition(),this.panelModulePercent=s.toFloat()/c.toFloat()},loadJson:function(t){MWF.require("MWF.widget.JsonParse",function(){this.jsonParse=new MWF.widget.JsonParse(t,this.jsonObjectNode,this.jsonStringNode),this.jsonParse.load()}.bind(this))},loadJsonString:function(t){this.jsonStringNode.set("text",JSON.stringify(t,null,2)),o2.require("o2.widget.ace",function(){MWF.widget.ace.load(function(){COMMON.AjaxModule.loadDom("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js",function(){ace.require("ace/ext/static_highlight")(this.jsonStringNode,{mode:"ace/mode/json",theme:"ace/theme/tomorrow",fontSize:16})}.bind(this))}.bind(this))}.bind(this))},clearJson:function(){this.json=null,this.jsonString="",this.jsonStringNode.set("text",""),this.jsonObjectNode.empty(),this.jsonParse&&(this.jsonParse=null)},createJsonStringNode:function(){return new Element("div",{styles:{width:"100%",height:"100%",overflow:"auto",border:"0px"}})},createJsonObjectNode:function(){return this.jsonObjectNode=new Element("div",{styles:{"margin-top":"0px",height:"auto"}}),this.jsonObjectNode},createJsonStringConfirmNode:function(){this.jsonStringConfirmNode=new Element("div",{styles:{width:"20px",height:"20px","background-color":"#EEE",background:"url("+MWF.defaultPath+"/process/ProcessChart/$Process/"+this.process.options.style+"/checkmark.png) no-repeat center center",position:"absolute",cursor:"pointer",display:"none"},events:{mouseover:function(){this.store("flag",!0)},mouseout:function(){this.store("flag",!1)},click:function(){this.checkJsonStringAndReload()}.bind(this)}}).inject(this.jsonStringNode,"after")},checkJsonStringAndReload:function(){if(!this.process.selectedActivitys.length)try{var t=JSON.decode(this.jsonStringNode.value);t&&(this.process.currentSelected?(Object.copy(t,this.process.currentSelected.data),this.process.currentSelected.redraw()):(t.id=this.process.process.id,t.processCategory=this.process.process.processCategory,this.process.reload(t)))}catch(t){this.designer.notice(t.message,"error",this.jsonStringNode.getParent(),{x:"left",y:"top"})}},setJsonStringConfirmNodePosition:function(){var t=this.jsonStringNode.getPosition(this.panelNode),e=this.panelNode.getSize();this.jsonStringConfirmNode.setStyles({display:"block",top:t.y+4,left:e.x-26})},createPropertyTab:function(){this.propertyTabContent=new Element("div"),this.propertyListContent=new Element("div",{styles:this.process.css.propertyListContent}).inject(this.propertyTabContent),this.propertyListNode=new Element("div",{styles:this.process.css.propertyListNode}),this.process.propertyListNode=this.propertyListNode,this.jsonObjectNode=this.createJsonObjectNode(),this.jsonStringNode=this.createJsonStringNode(),this.jsonStringNode.addEvents({focus:function(){this.process.selectedActivitys.length||(this.jsonStringConfirmNode||this.createJsonStringConfirmNode(),this.setJsonStringConfirmNodePosition())}.bind(this),blur:function(t){this.jsonStringConfirmNode&&(this.jsonStringConfirmNode.retrieve("flag")||this.jsonStringConfirmNode.setStyle("display","none"))}.bind(this)}),MWF.require("MWF.widget.Tab",function(){this.propertyListTab=new MWF.widget.Tab(this.propertyListContent,{style:"moduleList"}),this.propertyListTab.load(),this.propertyTabPage=this.propertyListTab.addTab(this.propertyListNode,MWF.APPPD.LP.property,!1),this.objectTabPage=this.propertyListTab.addTab(this.jsonObjectNode,"JSON",!1),this.stringTabPage=this.propertyListTab.addTab(this.jsonStringNode,"Text",!1);var t=new Element("div",{styles:{float:"right","margin-right":"10px"},html:"<span>"+MWF.APPPD.LP.showAdvanced+"</span>"}).inject(this.propertyListTab.tabNodeContainer);t.getElement("span").addEvents({mousedown:function(t){t.stopPropagation()},click:function(t){this.showAdvanced.click(),t.stopPropagation()}.bind(this)}),o2.UD.getDataJson("process-show-advanced",function(e){this.showAdvanced=new Element("input",{type:"checkbox",checked:!!e&&e.show,events:{mousedown:function(t){t.stopPropagation()},change:function(){var t;if(this.showAdvanced.checked){if((t=this.propertyListNode.querySelectorAll('*[data-o2-advanced="yes"]'))&&t.length)for(var e=0;e<t.length;e++)t[e].show()}else if((t=this.propertyListNode.querySelectorAll('*[data-o2-advanced="yes"]'))&&t.length)for(e=0;e<t.length;e++)t[e].hide();o2.UD.putData("process-show-advanced",{show:!!this.showAdvanced.checked})}.bind(this)}}).inject(t,"top")}.bind(this)),this.process.setScrollBar(this.propertyTabPage.contentNodeArea,"small",null,null),this.process.setScrollBar(this.objectTabPage.contentNodeArea,"small",null,null),this.process.setScrollBar(this.stringTabPage.contentNodeArea,"small",null,null),this.objectTabPage.setOptions({onShow:function(){this.loadJson(this.data)}.bind(this),onHide:function(){this.clearJson()}.bind(this)}),this.stringTabPage.setOptions({onShow:function(){this.loadJsonString(this.data)}.bind(this),onHide:function(){this.clearJson()}.bind(this)}),this.propertyTabPage.showTab(),this.propertyListTab.tabNodeContainer.addEvent("mousedown",function(t){this.propertyTabMove(t)}.bind(this))}.bind(this),!1)},propertyTabMove:function(t){var e=this.propertyListContent.getSize(),i=new Element("div",{styles:{opacity:.7,border:"1px dashed #CCC","z-index":this.modulePanel.container.getStyle("z-index").toInt()+1,width:e.x,height:e.y,"background-color":"#EEE",position:"absolute"}}).inject(this.process.designer.paperNode);i.position({relativeTo:this.propertyListContent,position:"upperLeft",edge:"upperLeft"}),new Drag.Move(i,{droppables:[this.process.designer.paperNode,this.panelNode],onEnter:function(t,e){this.propertyPanel?this.panelNode==e?t.tween("border","4px dashed #666"):t.tween("border","1px dashed #CCC"):this.panelNode==e?t.tween("border","1px dashed #CCC"):t.tween("border","4px dashed #666")}.bind(this),onLeave:function(t,e){t.tween("border","1px dashed #CCC")},onDrop:function(t,e){this.panelNode!=e?this.propertyOut(t):this.propertyIn(),t.destroy()}.bind(this),onCancel:function(t){t.destroy()}}).start(t)},propertyOut:function(t){if(!this.propertyPanel){var e=t.getCoordinates(),i=this.process.designer.paperNode.getPosition(),s=new Element("div");this.propertyListContent.inject(s),MWF.require("MWF.widget.Panel",function(){this.propertyPanel=new MWF.widget.Panel(s,{title:MWF.APPPD.LP.property,isClose:!1,target:this.process.designer.paperNode,height:e.height,width:e.width,left:e.left.toFloat()-i.x.toFloat(),top:e.top.toFloat()-i.y.toFloat(),onResize:function(){this.setPropertyPanelSize()}.bind(this)}),this.propertyPanel.load(),this.propertyOutSetHeight(),this.setPropertyPanelSize(this.panelModulePercent)}.bind(this))}},setPropertyPanelSize:function(){var t=this.propertyPanel.content.getSize().y;this.propertyListContent.setStyle("height",t);var e=this.propertyListTab.tabNodeContainer.getSize();this.propertyListTab.pages.each(function(i){var s=i.contentNodeArea.getStyle("margin-top").toFloat(),o=i.contentNodeArea.getStyle("margin-bottom").toFloat(),n=t-s-o-e.y.toFloat()-2;i.contentNodeArea.setStyle("height",n)}.bind(this))},propertyOutSetHeight:function(){this.panelResizeNode.setStyles(this.process.css.panelResizeNodeHide),this.panelModulePercent="1",this.setPanelSize(this.panelModulePercent)},propertyIn:function(){this.propertyListContent.inject(this.propertyTabContent),this.propertyPanel&&this.propertyPanel.closePanel(),this.propertyPanel=null,this.propertyInSetHeight()},propertyInSetHeight:function(){this.panelResizeNode.setStyles(this.process.css.panelResizeNode),this.panelModulePercent="0.3",this.setPanelSize(this.panelModulePercent)},createModuleListTab:function(){this.moduleTabContent=new Element("div"),this.moduleListContent=new Element("div",{styles:this.process.css.moduleListContent}).inject(this.moduleTabContent),this.activityListNode=new Element("div",{styles:this.process.css.activityListNode}),this.process.activityListNode=this.activityListNode,this.activityTable=new HtmlTable({properties:this.process.css.activityListTable}).inject(this.activityListNode),this.process.activityTable=this.activityTable,this.routeListNode=new Element("div",{styles:this.process.css.routeListNode}),this.process.routeListNode=this.routeListNode,this.routeTable=new HtmlTable({properties:this.process.css.routeListTable}).inject(this.routeListNode),this.process.routeTable=this.routeTable,MWF.require("MWF.widget.Tab",function(){this.moduleListTab=new MWF.widget.Tab(this.moduleListContent,{style:"moduleList"}),this.moduleListTab.load();var t=this.moduleListTab.addTab(this.activityListNode,MWF.APPPD.LP.activity,!1);this.process.setScrollBar(t.contentNodeArea,"small",null,null);var e=this.moduleListTab.addTab(this.routeListNode,MWF.APPPD.LP.route,!1);this.process.setScrollBar(e.contentNodeArea,"small",null,null),t.showTab()}.bind(this),!1)},destroy:function(){this.modulePanel&&this.modulePanel.destroy(),this.propertyPanel&&this.propertyPanel.destroy()}}),MWF.xApplication.process.ProcessDesigner.Process.Property=new Class({Implements:[Options,Events],Extends:MWF.APPPD.Property,initialize:function(t,e){this.setOptions(e),this.process=t,this.paper=this.process.paper,this.data=t.process,this.htmlPath="../x_component_process_ProcessDesigner/$Process/process.html"}}),MWF.xApplication.process.ProcessDesigner.Process.JsonParse=new Class({initialize:function(t,e,i){this.json=t,this.jsonObjectNode=e,this.jsonStringNode=i,this.stopParseJson=!1},load:function(){this.jsonString=JSON.encode(this.json),this.loadObjectTree()},loadObjectTree:function(){this.objectTree&&(this.objectTree.node.destroy(),this.objectTree=null),MWF.require("MWF.widget.Tree",function(){this.objectTree=new MWF.widget.Tree(this.jsonObjectNode,{style:"jsonview"}),this.objectTree.load();var t=this.parseJsonObject(0,this.objectTree,"","JSON",this.json,!0),e=t.substring(0,t.length-2);this.stopParseJson?this.stopParseJson=!1:this.jsonStringNode.set("text",e)}.bind(this))},parseJsonObject:function(t,e,i,s,o,n){if(this.stopParseJson)return!1;for(var a={expand:n,title:"",text:"",action:"",icon:""},r="",c=0;c<t;c++)r+="\t";i&&(i='"'+i+'": ');var h="",d=t+1;switch(typeOf(o)){case"object":a.text=s,a.icon="object.png";var l=e.appendChild(a),u=r+i+"{",p=r+"}";for(c in o)h+=this.parseJsonObject(d,l,c,c,o[c],!1);h=u+"\n"+h.substring(0,h.length-2)+"\n"+p+",\n";break;case"array":a.text=s,a.icon="array.png";l=e.appendChild(a),u=r+i+"[",p=r+"]";o.each(function(t,e){h+=this.parseJsonObject(d,l,"","["+e+"]",t,!1)}.bind(this)),h=u+"\n"+h.substring(0,h.length-2)+"\n"+p+",\n";break;case"string":case"date":h+=r+i+'"'+o+'",\n',a.text=s+' : "'+o+'"',a.icon="string.png",e.appendChild(a);break;default:h+=r+i+o+",\n",a.text=s+" : "+o,a.icon="string.png",e.appendChild(a)}return h}});