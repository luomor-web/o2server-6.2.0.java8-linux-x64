MWF.xApplication.process.ProcessDesigner.widget=MWF.xApplication.process.ProcessDesigner.widget||{},MWF.xApplication.process.ProcessDesigner.widget.ProjectionEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",maxTypeCount:{string:10,long:5,double:5,boolean:2,date:2,time:2,datetime:5}},initialize:function(t,e,s){this.setOptions(s),this.node=$(t),this.data=e?JSON.decode(e):[],this.name=t.get("name"),this.path="../x_component_process_ProcessDesigner/widget/$ProjectionEditor/",this.cssPath="../x_component_process_ProcessDesigner/widget/$ProjectionEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.selectedItems=[],this.items={}},getData:function(){return this.data},load:function(){this.titleNode=this.node.getFirst("div").setStyles(this.css.titleNode).set("text",MWF.xApplication.process.ProcessDesigner.LP.projectionTitle),this.tableArea=this.node.getLast("div"),this.actionNode=this.tableArea.getPrevious().setStyles(this.css.actionNode).set("text",MWF.xApplication.process.ProcessDesigner.LP.projectionActionNode_add);var t=this.node.getElements("input");this.nameInput=t[0],this.pathInput=t[1],this.typeSelect=this.node.getElement("select");var e="<table cellspacing='0' cellpadding='3px' width='100%' border='0'><tr><th>"+MWF.xApplication.process.ProcessDesigner.LP.projectionDataName+"</th><th>"+MWF.xApplication.process.ProcessDesigner.LP.projectionPath+"</th><th>"+MWF.xApplication.process.ProcessDesigner.LP.projectionType+"</th><th></th></tr></table>";this.tableArea.set("html",e),this.table=this.tableArea.getElement("table").setStyles(this.css.projectionTable),this.tableArea.getElements("th").setStyles(this.css.projectionTableTitle),this.runAction=new Element("div",{styles:this.css.actionNode,text:MWF.xApplication.process.ProcessDesigner.LP.projectionRunActionNode}).inject(this.node),this.loadProjectionList(),this.actionNode.addEvent("click",this.changeProjectionItem.bind(this)),this.runAction.addEvent("click",function(t){var e=this;MWF.xDesktop.confirm("infor",t,MWF.xApplication.process.ProcessDesigner.LP.projectionRunTitle,MWF.xApplication.process.ProcessDesigner.LP.projectionRunText,300,120,(function(){e.runProjection(),this.close()}),(function(){this.close()}),null,null,"o2")}.bind(this))},runProjection:function(){o2.Actions.get("x_processplatform_assemble_designer").executeProjection(this.options.process,null,(function(t){t.data.value?o2.xDesktop.notice("success",{x:"right",y:"top"},MWF.xApplication.process.ProcessDesigner.LP.projectionRunSuccess,this.node):o2.xDesktop.notice("error",{x:"right",y:"top"},MWF.xApplication.process.ProcessDesigner.LP.projectionRunError,this.node)}))},changeProjectionItem:function(){this.currentItem?this.modifyProjectionItem():this.addProjectionItem()},checkItemData:function(t,e,s){if(!t||!e)return o2.xDesktop.notice("error",{x:"right",y:"top"},MWF.xApplication.process.ProcessDesigner.LP.projectionInputError,this.node),!1;for(var i=0,o=0;o<this.data.length;o++){if(this.data[o].type===s&&i++,i>=this.options.maxTypeCount[s]){var n=MWF.xApplication.process.ProcessDesigner.LP.projectionTypeCountError;return n=(n=n.replace(/{type}/g,s)).replace(/{count}/g,this.options.maxTypeCount[s]),o2.xDesktop.notice("error",{x:"right",y:"top"},n,this.node),!1}if(this.data[o].name===t&&(!this.currentItem||this.data[o]!=this.currentItem.data))return o2.xDesktop.notice("error",{x:"right",y:"top"},MWF.xApplication.process.ProcessDesigner.LP.projectionSameNameError,this.node),!1}return!0},modifyProjectionItem:function(){var t=this.nameInput.get("value"),e=this.pathInput.get("value"),s=this.typeSelect.options[this.typeSelect.selectedIndex].value;this.checkItemData(t,e,s)&&(this.currentItem.data.name=t,this.currentItem.data.path=e,this.currentItem.data.type=s,this.currentItem.refresh(),this.currentItem.unSelected(),this.fireEvent("change"),this.fireEvent("modifyItem"))},addProjectionItem:function(){var t=this.nameInput.get("value"),e=this.pathInput.get("value"),s=this.typeSelect.options[this.typeSelect.selectedIndex].value;if(this.checkItemData(t,e,s)){var i={name:t,path:e,type:s};this.data.push(i),new MWF.xApplication.process.ProcessDesigner.widget.ProjectionEditor.Item(i,this),this.fireEvent("change"),this.fireEvent("addItem")}},loadProjectionList:function(){this.data.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.ProjectionEditor.Item(t,this)}.bind(this))}}),MWF.xApplication.process.ProcessDesigner.widget.ProjectionEditor.Item=new Class({initialize:function(t,e){this.editor=e,this.data=t,this.table=this.editor.table,this.css=this.editor.css,this.load()},load:function(){this.tr=new Element("tr").inject(this.table);var t=this.tr.insertCell().setStyles(this.css.projectionTableTd).set("text",this.data.name);this.tr.insertCell().setStyles(this.css.projectionTableTd).set("text",this.data.path),this.tr.insertCell().setStyles(this.css.projectionTableTd).set("text",this.data.type),t=this.tr.insertCell().setStyles(this.css.projectionTableTd),this.delAction=new Element("div",{styles:this.css.projectionItemAction}).inject(t),this.setEvent()},setEvent:function(){this.delAction.addEvent("click",function(t){var e=MWF.xApplication.process.ProcessDesigner.LP.projectionDeleteItem;e=(e=e.replace(/{name}/g,this.data.name)).replace(/{path}/g,this.data.path);var s=this;MWF.xDesktop.confirm("infor",t,MWF.xApplication.process.ProcessDesigner.LP.projectionDeleteItemTitle,e,300,120,(function(){s.destroy(),this.close()}),(function(){this.close()}),null,null,"o2")}.bind(this)),this.tr.addEvents({click:function(){this.editor.currentItem&&this.editor.currentItem.unSelected(),this.selected()}.bind(this)})},selected:function(){this.editor.currentItem=this,this.tr.setStyles(this.css.projectionTableTr_selected),this.editor.nameInput.set("value",this.data.name),this.editor.pathInput.set("value",this.data.path);for(var t=this.editor.typeSelect.options,e=0;e<t.length;e++)if(t[e].value===this.data.type){t[e].set("selected",!0);break}this.editor.actionNode.set("text",MWF.xApplication.process.ProcessDesigner.LP.projectionActionNode_modify)},unSelected:function(){this.editor.currentItem=null,this.tr.setStyles(this.css.projectionTableTr),this.editor.actionNode.set("text",MWF.xApplication.process.ProcessDesigner.LP.projectionActionNode_add)},refresh:function(){var t=this.tr.getElements("td");t[0].set("text",this.data.name),t[1].set("text",this.data.path),t[2].set("text",this.data.type)},destroy:function(){this.tr.destroy(),this.editor.data.erase(this.data),this.editor.fireEvent("change"),this.editor.fireEvent("deleteItem"),o2.release(this)}});