MWF.xApplication.process.ProcessDesigner.widget=MWF.xApplication.process.ProcessDesigner.widget||{},MWF.xDesktop.requireApp("process.ProcessDesigner","Property",null,!1),MWF.xApplication.process.ProcessDesigner.widget.OrgEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default"},initialize:function(t,e,s,i){this.setOptions(i),this.node=$(t),this.data=s?"string"===typeOf(s)?JSON.parse(s):s:[],this.route=e,this.process=e.process,this.path="../x_component_process_ProcessDesigner/widget/$OrgEditor/",this.cssPath="../x_component_process_ProcessDesigner/widget/$OrgEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.selectedItems=[],this.lp=MWF.xApplication.process.ProcessDesigner.LP},load:function(){this.scrollNode=this.process.panel.propertyTabPage.contentNodeArea,this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}).inject(this.node),this.copyNode=new Element("div",{styles:this.css.copyNode,title:this.lp.copy,events:{click:function(t){this.selectOtherConfig(t)}.bind(this)}}).inject(this.toolbarNode),this.selectedNode=new Element("div",{styles:this.css.selectedNode}).inject(this.node),this.upNode=new Element("div",{styles:this.css.upNode,text:this.lp.orgEditor.addOption}).inject(this.node),this.upNode.addEvent("click",function(t){if(this.currentItem){if(!this.currentItem.data.title||!this.currentItem.data.name)return void MWF.xDesktop.notice("error",{y:"top",x:"left"},this.lp.notice.saveRouteOrgNoName,t.target);var e=this.currentItem.getData;this.checkName(e.name,e.id)?(this.currentItem.save(),this.currentItem.unSelectItem(),this.defaultProperty?this.defaultProperty.show():this.loadDefaultProperty(),this.scrollNode.scrollTo(0,0),this.upNode.set("text","添加选择项")):MWF.xDesktop.notice("error",{y:"top",x:"right"},this.lp.orgEditor.conflictNotice+"："+e.name,t.target)}else if(this.defaultProperty){if(!this.defaultData.title||!this.defaultData.name)return void MWF.xDesktop.notice("error",{y:"top",x:"left"},this.lp.notice.saveRouteOrgNoName,t.target);e=this.defaultData;this.checkName(e.name,e.id)?(this.data.push(this.defaultData),this.createSelectedItem(this.defaultData),this.save(),this.defaultProperty.propertyContent.destroy(),this.loadDefaultProperty(),this.upNode.set("text",this.lp.orgEditor.addOption)):MWF.xDesktop.notice("error",{y:"top",x:"right"},this.lp.orgEditor.conflictNotice+"："+e.name,t.target)}}.bind(this)),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.getTemplate(function(){this.loadSelectedItems(),this.loadDefaultProperty()}.bind(this)),this.setUpNodeFixed()},setUpNodeFixed:function(){var t=this.scrollNode;t.getParent().setStyle("position","relative"),t.addEvent("scroll",function(e){null!==this.node.offsetParent&&(this.propertyNode.getPosition(t).y<30?this.upNode.setStyles({position:"absolute",top:1,left:0,border:"1px solid #ffa200","background-color":"#fff",width:"99%"}):this.upNode.setStyles({position:"static",border:"0px"}))}.bind(this))},loadSelectedItems:function(){this.data.each(function(t){this.selectedItems.push(new MWF.xApplication.process.ProcessDesigner.widget.OrgEditor.SelectedItem(this,t))}.bind(this)),this.fireEvent("change")},createSelectedItem:function(t){this.selectedItems.push(new MWF.xApplication.process.ProcessDesigner.widget.OrgEditor.SelectedItem(this,t)),this.fireEvent("change")},getTemplate:function(t){this.templateJson?t&&t():MWF.getJSON("../x_component_process_ProcessDesigner/widget/$OrgEditor/org.json",function(e){this.templateJson=e,t&&t()}.bind(this))},save:function(){this.route.data.selectConfig=JSON.stringify(this.getData())},getData:function(){var t=[];return this.selectedItems.each((function(e){t.push(e.getData())})),this.data=t,t},checkName:function(t,e){var s=!0;return this.selectedItems.each((function(i){var o=i.getData();o.name===t&&o.id!==e&&(s=!1)})),s},loadDefaultProperty:function(){this.defaultData=Object.clone(this.templateJson),this.defaultProperty=new MWF.APPPD.widget.OrgEditor.Property(this,this.defaultData,{onPostLoad:function(){this.defaultProperty.show()}.bind(this)}),this.defaultProperty.load()},selectOtherConfig:function(t){var e=[];this.process&&this.process.routes&&Object.each(this.process.routes,(function(t){if(t.data.selectConfig){var s=JSON.parse(t.data.selectConfig);if(s&&s.length){var i={name:t.data.name,id:t.data.id,subItemList:[]};s.each((function(t){i.subItemList.push({name:t.name+" - "+t.title,id:t.id,data:JSON.stringify(t)})})),e.push(i)}}})),o2.xDesktop.requireApp("Template","Selector.Custom",function(){var s={count:0,title:this.lp.orgEditor.copyConfig,selectableItems:e,expand:!0,category:!0,onComplete:function(e){if(e.length>0){var s=[],i=[];this.process.designer.actions.getId(e.length,function(t){s=t.data}.bind(this),null,!1),e.each(function(e,o){var n=JSON.parse(e.data.data);n.id=s[o].id,this.checkName(n.name,n.id)?this.selectedItems.push(new MWF.xApplication.process.ProcessDesigner.widget.OrgEditor.SelectedItem(this,n)):i.push(n.name),i.length>0&&MWF.xDesktop.notice("error",{y:"top",x:"right"},this.lp.orgEditor.conflictNotice+"："+i.join(","),t.target)}.bind(this)),this.save(),this.fireEvent("change")}}.bind(this)};new o2.xApplication.Template.Selector.Custom(this.process.designer.node,s).load()}.bind(this))}}),MWF.xApplication.process.ProcessDesigner.widget.OrgEditor.SelectedItem=new Class({initialize:function(t,e){this.editor=t,this.css=this.editor.css,this.data=e,this.data.events&&0!==Object.keys(this.data.events).length||(this.data.events=Object.clone(this.editor.templateJson.events)),this.tmpData=Object.clone(e),this.node=new Element("div",{styles:this.css.selectedItemNode}).inject(this.editor.selectedNode),this.load()},load:function(){this.textNode=new Element("div",{styles:this.css.selectedItemTextNode}).inject(this.node),this.textNode.set({text:this.data.name,title:this.data.description}),new Element("span",{styles:this.css.selectedItemTextNode,html:this.data.title?"(&nbsp;"+this.data.title+"&nbsp;)":""}).inject(this.textNode),this.selectTypeNode=new Element("div",{styles:this.css.selectedItemLabelNode,text:this.editor.lp.selectType+":"}).inject(this.node),new Element("span",{styles:this.css.selectedItemTextNode,text:"identity"===this.data.selectType?this.editor.lp.identity:this.editor.lp.unit}).inject(this.selectTypeNode),this.selectCountNode=new Element("div",{styles:this.css.selectedItemLabelNode,text:this.editor.lp.selectCount+":"}).inject(this.node),new Element("span",{styles:this.css.selectedItemTextNode,text:"identity"===this.data.selectType?this.data.identityCount:this.data.unitCount}).inject(this.selectCountNode),this.node.addEvents({mouseover:function(){this.editor.currentItem!=this&&this.node.setStyles(this.css.selectedItemNode_over)}.bind(this),mouseout:function(){this.editor.currentItem!=this&&this.node.setStyles(this.css.selectedItemNode)}.bind(this),click:function(){this.selectItem()}.bind(this)}),this.closeNode=new Element("div",{styles:this.css.selectedItemCloseNode,title:this.editor.lp.delete}).inject(this.node),this.closeNode.addEvent("click",function(t){this.deleteItem(t),t.stopPropagation()}.bind(this))},reload:function(){this.node.empty(),this.load()},save:function(){this.data=Object.clone(this.tmpData),this.editor.save(),this.reload()},getData:function(t){var e=this.tmpData||this.data;return t?Object.clone(e):e},loadProperty:function(){this.property=new MWF.APPPD.widget.OrgEditor.Property(this.editor,this.tmpData,{onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load()},deleteItem:function(t){var e=this;MWF.xDesktop.confirm("warn",t,this.editor.lp.deleteOrgConfirmTitle,this.editor.lp.deleteOrgConfirmContent,"300","100",(function(){e._deleteItem(),this.close()}),(function(){this.close()}))},_deleteItem:function(){this.node.destroy(),this.property&&this.property.propertyContent.destroy(),this.editor.selectedItems.erase(this),this.editor.save(),this.editor.currentItem===this&&(this.editor.currentItem=null),this.editor.fireEvent("change"),this.editor.currentItem||this.editor.defaultProperty&&(this.editor.defaultProperty.show(),this.editor.upNode.set("text",this.editor.lp.orgEditor.addOption)),MWF.release(this)},selectItem:function(){this.editor.upNode.set("text",this.editor.lp.orgEditor.modifyOption),this.editor.currentItem&&this.editor.currentItem.unSelectItem(),this.editor.defaultProperty&&this.editor.defaultProperty.hide(),this.property?this.property.show():this.loadProperty(),this.node.setStyles(this.css.selectedItemNode_check),this.editor.currentItem=this},unSelectItem:function(){this.node.setStyles(this.css.selectedItemNode),this.property&&this.property.hide(),this.editor.currentItem=null}}),MWF.xApplication.process.ProcessDesigner.widget.OrgEditor.Property=new Class({Implements:[Options,Events],Extends:MWF.APPPD.Property,initialize:function(t,e,s){this.setOptions(s),this.org=t,this.process=t.route.process,this.paper=this.process.paper,this.node=t.propertyNode,this.data=e,this.data.id||this.process.designer.actions.getId(1,function(t){this.data.id=t.data[0].id}.bind(this),null,!1),this.data.pid=this.data.id,this.htmlPath="../x_component_process_ProcessDesigner/widget/$OrgEditor/org.html"},show:function(){this.process.options.isView||(this.propertyContent?this.propertyContent.setStyle("display","block"):this.getHtmlString(function(){this.htmlString=o2.bindJson(this.htmlString,{lp:o2.APPPD.LP.propertyTemplate}),this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node),this.JsonTemplate=new MWF.widget.JsonTemplate(this.data,this.htmlString),this.propertyContent.set("html",this.JsonTemplate.load()),this.setEditNodeEvent(),this.setEditNodeStyles(this.propertyContent),this.loadPropertyTab(),this.loadFormFieldInput(),this.loadPersonInput(),this.loadScriptInput(),this.loadScriptText(),this.loadScriptArea(),this.loadUnitTypeSelector(),this.loadEventsEditor()}.bind(this)))},setEditNodeEvent:function(){var t=this;this.propertyContent.getElements("input").each(function(e){var s=e.get("name"),i=this.data.id;if(e.set("name",i+s),s)switch(e.get("type").toLowerCase()){case"radio":e.addEvent("change",(function(e){t.setRadioValue(s,this)})),e.addEvent("blur",(function(e){t.setRadioValue(s,this)})),e.addEvent("keydown",(function(t){t.stopPropagation()})),t.setRadioValue(s,e);break;case"checkbox":e.addEvent("keydown",(function(t){t.stopPropagation()}));break;default:e.addEvent("change",(function(e){t.setValue(s,this.value)})),e.addEvent("blur",(function(e){t.setValue(s,this.value)})),e.addEvent("keydown",(function(e){13===e.code&&t.setValue(s,this.value),e.stopPropagation()})),t.setValue(s,e.get("value"))}}.bind(this)),this.propertyContent.getElements("select").each((function(e){var s=e.get("name");s&&e.addEvent("change",(function(e){t.setSelectValue(s,this)}))})),this.propertyContent.getElements("textarea").each(function(e){var s=e.get("name");s&&(e.addEvent("change",(function(e){t.setValue(s,this.value)})),e.addEvent("blur",(function(e){t.setValue(s,this.value)})),e.addEvent("keydown",(function(t){t.stopPropagation()})))}.bind(this))},loadEventsEditor:function(){var t=this.propertyContent.getElement(".MWFEventsArea");if(t){var e=t.get("name"),s=this.data[e];MWF.xApplication.process.FormDesigner||(MWF.xApplication.process.FormDesigner={}),MWF.xApplication.process.FormDesigner.widget||(MWF.xApplication.process.FormDesigner.widget={}),MWF.xDesktop.requireApp("process.FormDesigner","widget.EventsEditor",function(){new MWF.xApplication.process.FormDesigner.widget.EventsEditor(t,this.process.designer,{maxObj:this.process.designer.content}).load(s,this.data,e)}.bind(this))}}});