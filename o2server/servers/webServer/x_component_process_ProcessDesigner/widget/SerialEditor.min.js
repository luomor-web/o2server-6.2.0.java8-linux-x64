MWF.xApplication.process.ProcessDesigner.widget=MWF.xApplication.process.ProcessDesigner.widget||{},MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ScriptText",null,!1),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default"},initialize:function(e,t,s){this.setOptions(s),this.node=$(e),this.data=t?JSON.decode(t):[],this.name=e.get("name"),this.path="../x_component_process_ProcessDesigner/widget/$SerialEditor/",this.cssPath="../x_component_process_ProcessDesigner/widget/$SerialEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.selectedItems=[],this.items={}},load:function(){this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.node),this.titleNode.set("text",MWF.xApplication.process.ProcessDesigner.LP.serialSelectTitle),this.selectNode=new Element("div",{styles:this.css.selectNode}).inject(this.node),this.downNode=new Element("div",{styles:this.css.downNode}).inject(this.node),this.previewNode=new Element("div",{styles:this.css.previewNode}).inject(this.node),this.showNode=new Element("div",{styles:this.css.showNode}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.loadSelectNode()},loadSelectNode:function(){this.getSerialRule(function(){this.loadSelectNodeItems(),this.loadSelectedNodeItems()}.bind(this))},loadSelectedNodeItems:function(){this.data.each(function(e){this.selectedItems.push(new(MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem[e.key.capitalize()])(this.items[e.key],e))}.bind(this)),this.fireEvent("change")},loadSelectNodeItems:function(){Object.each(this.serialRuleJson,function(e,t){this.loadSelectNodeItem(e,t)}.bind(this))},loadSelectNodeItem:function(e,t){this.items[t]=new MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.Item(e,t,this)},getSerialRule:function(e){if(this.serialRuleJson)e&&e();else{MWF.getJSON("../x_component_process_ProcessDesigner/$Process/serialRule.json",function(t){this.serialRuleJson=t,e&&e()}.bind(this))}},getData:function(){var e=[];return this.selectedItems.each((function(t){e.push(t.getData())})),this.data=e,e}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.Item=new Class({initialize:function(e,t,s){this.editor=s,this.json=e,this.key=t,this.css=this.editor.css,this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.editor.selectNode),this.iconNode=new Element("div",{styles:this.css.itemIconNode}).inject(this.node),this.textNode=new Element("div",{styles:this.css.itemTextNode}).inject(this.node),this.textNode.set({text:this.json.text,title:this.json.description}),this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.itemNode_over),this.iconNode.setStyles(this.css.itemIconNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.itemNode),this.iconNode.setStyles(this.css.itemIconNode)}.bind(this),click:function(){this.selectNumberItem()}.bind(this)})},selectNumberItem:function(){this.editor.selectedItems.push(new(MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem[this.key.capitalize()])(this)),this.editor.fireEvent("change")}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem=new Class({initialize:function(e,t){this.item=e,this.json=e.json,this.key=e.key,this.editor=e.editor,this.css=this.editor.css,this.data=t,this.load()},load:function(){this.node=new Element("div",{styles:this.css.selectedItemNode}).inject(this.editor.showNode),this.textNode=new Element("div",{styles:this.css.selectedItemTextNode}).inject(this.node),this.textNode.set({text:this.json.text,title:this.json.description}),this.node.addEvents({mouseover:function(){this.editor.currentItem!=this&&this.node.setStyles(this.css.selectedItemNode_over)}.bind(this),mouseout:function(){this.editor.currentItem!=this&&this.node.setStyles(this.css.selectedItemNode)}.bind(this),click:function(){this.selectItem()}.bind(this)}),this.closeNode=new Element("div",{styles:this.css.selectedItemCloseNode}).inject(this.node),this.closeNode.addEvent("click",function(){this.deleteItem()}.bind(this)),this.loadProperty(),this.selectItem()},loadProperty:function(){},deleteItem:function(){this.node.destroy(),this.propertyNode&&this.propertyNode.destroy(),this.editor.selectedItems.erase(this),this.editor.currentItem===this&&(this.editor.currentItem=null),this.editor.fireEvent("change"),MWF.release(this)},selectItem:function(){this.editor.currentItem&&this.editor.currentItem.unSelectItem(),this.propertyNode&&(this.propertyNode.setStyle("display","block"),"number"===this.key&&this.loadNumberBy()),this.node.setStyles(this.css.selectedItemNode_check),this.editor.currentItem=this},unSelectItem:function(){this.node.setStyles(this.css.selectedItemNode),this.propertyNode&&this.propertyNode.setStyle("display","none"),this.editor.currentItem=null}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Text=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,loadProperty:function(){this.propertyNode=new Element("div",{styles:this.css.itemPropertyNode}).inject(this.editor.propertyNode),this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode}).inject(this.propertyNode),this.propertyTitleNode.set("text",MWF.xApplication.process.ProcessDesigner.LP.serialTextTitle),this.propertyInputDivNode=new Element("div",{styles:this.css.propertyInputDivNode}).inject(this.propertyNode),this.propertyInputNode=new Element("input",{type:"text",value:this.data?this.data.value:"",styles:this.css.propertyInputNode}).inject(this.propertyInputDivNode),this.changeText(),this.propertyInputNode.addEvents({change:function(){this.changeText()}.bind(this),blur:function(){}})},changeText:function(){var e=this.propertyInputNode.get("value");e?this.textNode.set("text",'"'+e+'"'):this.textNode.set("text",this.json.text),this.editor.fireEvent("change")},getData:function(){var e=this.propertyInputNode.get("value");return{key:this.key,value:e,script:'return serial.text("'+e+'")'}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Year=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,loadProperty:function(){this.value="created";var e=Math.random();this.propertyNode=new Element("div",{styles:this.css.itemPropertyNode}).inject(this.editor.propertyNode),new Element("div",{styles:this.css.propertyTitleNode}).inject(this.propertyNode).set("text",MWF.xApplication.process.ProcessDesigner.LP.serialDateTitle);var t=new Element("div",{styles:this.css.propertyInputDivNode}).inject(this.propertyNode),s=this.data?this.data.value:"created";html='<input name="serialDateSelect'+e+'" '+("created"==s?"checked":"")+' type="radio" value="created"/>'+MWF.xApplication.process.ProcessDesigner.LP.serialCreatedDateTitle,html+='<input name="serialDateSelect'+e+'" '+("current"==s?"checked":"")+' type="radio" value="current"/>'+MWF.xApplication.process.ProcessDesigner.LP.serialCurrentDateTitle,t.set("html",html),this.changeText(this.data?this.data.value:"created"),t.getElements("input").addEvent("click",function(e){if(e.target.checked){var t=e.target.get("value");this.changeText(t)}}.bind(this))},changeText:function(e){var t=MWF.xApplication.process.ProcessDesigner.LP.serialCreated;"current"==e&&(t=MWF.xApplication.process.ProcessDesigner.LP.serialCurrent),this.value=e,this.textNode.set("text",this.json.text+"("+t+")"),this.editor.fireEvent("change")},getData:function(){var e=this.key,t="return serial."+("current"==this.value?"year":"createYear")+'("yyyy")';return{key:e,value:this.value,script:t}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Month=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Year,getData:function(){var e=this.key,t="return serial."+("current"==this.value?"month":"createMonth")+'("MM")';return{key:e,value:this.value,script:t}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Day=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Year,getData:function(){var e=this.key,t="return serial."+("current"==this.value?"day":"createDay")+'("dd")';return{key:e,value:this.value,script:t}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Company=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,getData:function(){return{key:this.key,value:"",script:"return serial.company()"}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Department=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,getData:function(){return{key:this.key,value:"",script:"return serial.department()"}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.CompanyAttribute=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,loadProperty:function(){this.propertyNode=new Element("div",{styles:this.css.itemPropertyNode}).inject(this.editor.propertyNode),this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode}).inject(this.propertyNode),this.propertyTitleNode.set("text",MWF.xApplication.process.ProcessDesigner.LP.serialAttributeTitle),this.propertyInputDivNode=new Element("div",{styles:this.css.propertyInputDivNode}).inject(this.propertyNode),this.propertyInputNode=new Element("input",{type:"text",value:this.data?this.data.value:"",styles:this.css.propertyInputNode}).inject(this.propertyInputDivNode),this.changeText(),this.propertyInputNode.addEvents({change:function(){this.changeText()}.bind(this),blur:function(){}})},changeText:function(){var e=this.propertyInputNode.get("value");e?this.textNode.set("text",this.json.text+"("+e+")"):this.textNode.set("text",this.json.text),this.editor.fireEvent("change")},getData:function(){var e=this.propertyInputNode.get("value");return{key:this.key,value:e,script:'return serial.companyAttribute("'+e+'")'}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.DepartmentAttribute=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.CompanyAttribute,getData:function(){var e=this.propertyInputNode.get("value");return{key:this.key,value:e,script:'return serial.departmentAttribute("'+e+'")'}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Number=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,loadProperty:function(){this.propertyNode=new Element("div",{styles:this.css.itemPropertyNode}).inject(this.editor.propertyNode);var e=new Element("div",{styles:this.css.lineNode}).inject(this.propertyNode),t=new Element("div",{styles:this.css.propertyTitleNode}).inject(e);t.set("text",MWF.xApplication.process.ProcessDesigner.LP.serialNumberByTitle),this.propertyNumberByDivNode=new Element("div",{styles:this.css.propertyInputDivNode}).inject(e),this.loadNumberBy(),e=new Element("div",{styles:this.css.lineNode}).inject(this.propertyNode),(t=new Element("div",{styles:this.css.propertyTitleNode}).inject(e)).set("text",MWF.xApplication.process.ProcessDesigner.LP.serialNumberLongTitle),this.propertyInputDivNode=new Element("div",{styles:this.css.propertyInputDivNode}).inject(e),this.propertyInputNode=new Element("select").inject(this.propertyInputDivNode);var s=(this.data?this.data.value:{}).lng||0,i="<option "+(0==s?"selected":"")+' value="0">auto</option>';i+="<option "+(2==s?"selected":"")+' value="2">2</option>',i+="<option "+(3==s?"selected":"")+' value="3">3</option>',i+="<option "+(4==s?"selected":"")+' value="4">4</option>',i+="<option "+(5==s?"selected":"")+' value="5">5</option>',i+="<option "+(6==s?"selected":"")+' value="6">6</option>',i+="<option "+(7==s?"selected":"")+' value="7">7</option>',i+="<option "+(8==s?"selected":"")+' value="8">8</option>',i+="<option "+(9==s?"selected":"")+' value="9">9</option>',this.propertyInputNode.set("html",i),this.propertyInputNode.addEvents({change:function(){this.editor.fireEvent("change")}.bind(this)})},loadNumberBy:function(){this.propertyNumberByDivNode.empty();var e=Math.random(),t=(this.data?this.data.value:{}).by||[],s="";this.editor.selectedItems.each((function(i,o){if("number"!=i.key){var r=-1==t.indexOf(o)?"":"checked";s+="<input "+r+' name="serialNumberBySelect'+e+'" type="checkbox" value="'+o+'"/>'+i.json.text}})),this.propertyNumberByDivNode.set("html",s),this.propertyNumberByDivNode.getElements("input").addEvent("click",function(e){this.editor.fireEvent("change")}.bind(this))},getData:function(){var e=this.propertyInputNode.options[this.propertyInputNode.selectedIndex].value,t=[];this.propertyNumberByDivNode.getElements("input").each(function(e){e.checked&&t.push(e.get("value").toInt())}.bind(this));var s={lng:e,by:t},i="return serial.nextSerialNumber("+JSON.encode(t)+", "+e+")";return{key:this.key,value:s,script:i}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Script=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,loadProperty:function(){this.code=this.data?this.data.value:"",this.propertyNode=new Element("div",{styles:this.css.itemPropertyNode}).inject(this.editor.propertyNode),this.scriptNode=new Element("div",{styles:this.css.scriptNode}).inject(this.propertyNode),this.scriptNode.set("title",MWF.xApplication.process.ProcessDesigner.LP.serialScriptTitle),this.scriptArea=new MWF.xApplication.process.ProcessDesigner.widget.ScriptText(this.scriptNode,this.data?this.data.value:"",this.editor.process.designer,{maskNode:this.editor.process.designer.content,maxObj:this.editor.process.designer.paperNode,onChange:function(e){this.code=e,this.editor.fireEvent("change")}.bind(this)})},getData:function(){var e=this.code;return{key:this.key,value:e,script:e}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Unit=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,getData:function(){return{key:this.key,value:"",script:"return serial.unit()"}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.Unit=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem,getData:function(){return{key:this.key,value:"",script:"return serial.unit()"}}}),MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.UnitAttribute=new Class({Extends:MWF.xApplication.process.ProcessDesigner.widget.SerialEditor.SelectedItem.CompanyAttribute,getData:function(){var e=this.propertyInputNode.get("value");return{key:this.key,value:e,script:'return serial.unitAttribute("'+e+'")'}}});