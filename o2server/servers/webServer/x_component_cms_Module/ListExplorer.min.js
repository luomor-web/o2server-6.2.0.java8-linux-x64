MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Module=MWF.xApplication.cms.Module||{},MWF.require("MWF.xAction.org.express.RestActions",null,!1),MWF.require("MWF.widget.Mask",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("cms.Module","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("cms.Module","package",null,!1),MWF.xApplication.cms.Module.ListExplorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",status:"published",isAdmin:!1,searchKey:"",tooltip:{}},initialize:function(t,e,i,s,o,n,r){this.setOptions(n),this.setTooltip(),this.path="../x_component_cms_Module/$ListExplorer/",this.cssPath="../x_component_cms_Module/$ListExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.categoryData=s,this.columnData=i,this.revealData=o,this.actions=e,this.node=$(t),this.searchNode=$(r),this.initData(),this.personActions||(this.personActions=MWF.Actions.get("x_organization_assemble_express"))},setTooltip:function(t){t&&(this.options.tooltip=Object.merge(this.options.tooltip,t))},initData:function(){this.toolItemNodes=[]},reload:function(){this.node.empty(),this.searchNode.empty(),this.load()},load:function(){this.loadSearchNode(),this.loadViewData(function(){this.loadContentNode(),this.loadView(),this.setNodeScroll()}.bind(this))},loadViewData:function(t){this.revealData.isAll||"defaultList"==this.revealData.id?t&&t():"list"==this.revealData.type&&this.app.restActions.getView(this.revealData.id,function(e){var i=this.viewData=e.data;i.content&&"string"==typeof i.content&&(i.content=JSON.parse(i.content)),t&&t()}.bind(this))},loadToolbar:function(){var t=this.path+"toolbar.json";MWF.getJSON(t,function(t){t.each(function(t){this.createToolbarItemNode(t)}.bind(this))}.bind(this))},createToolbarItemNode:function(t){var e=new Element("div",{styles:t.styles&&this.css[t.styles]?this.css[t.styles]:this.css.toolbarItemNode});e.store("toolData",t),new Element("div",{styles:this.css.toolbarItemIconNode}).inject(e).setStyle("background-image","url("+this.path+this.options.style+"/icon/"+t.icon+")"),new Element("div",{styles:this.css.toolbarItemTextNode,text:t.title}).inject(e),e.inject(this.toolbarNode),this.toolItemNodes.push(e),this.setToolbarItemEvent(e)},setToolbarItemEvent:function(t){var e=this;t.addEvents({click:function(){var t=this.retrieve("toolData");e[t.action]&&e[t.action].apply(e,[this])}})},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node),this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},loadView:function(){this.revealData.isAll?this.view=new MWF.xApplication.cms.Module.ListExplorer.ListForALL(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey):this.revealData.isDraft?this.view=new MWF.xApplication.cms.Module.ListExplorer.ListForDraft(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey):"defaultList"==this.revealData.id||this.options.searchKey&&""!=this.options.searchKey?this.view=new MWF.xApplication.cms.Module.ListExplorer.DefaultList(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey):this.view=new MWF.xApplication.cms.Module.ListExplorer.List(this.elementContentNode,this.app,this,this.viewData),this.selectEnable&&(this.view.selectEnable=this.selectEnable),this.view.load(function(){this.setContentSize()}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},e=this.app.titleBar?this.app.titleBar.getSize():{x:0,y:0},i=this.app.node.getSize(),s=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0},o=i.y-t.y-0-0-s.y-e.y;this.elementContentNode.setStyle("height",o+"px"),this.pageCount=(o/40).toInt()+5,this.view.items.length<this.pageCount&&("number"===typeOf(this.view.itemDataCount)?this.view.items.length<this.view.itemDataCount&&this.view.loadElementList(this.pageCount-this.view.items.length):this.view.loadElementList(this.pageCount-this.view.items.length))},setNodeScroll:function(){var t=this;MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(e){var i=t.elementContentNode.getScrollSize(),s=t.elementContentNode.getSize();e+200>i.y-s.y&&(t.view.isItemsLoaded||t.view.loadElementList())}})}.bind(this))},loadFileter:function(t){this._loadFileter(t)},_loadFileter:function(t){this.filter||(this.filter=new MWF.xApplication.cms.Module.Module.Filter(this.app,this,this.toolbarNode,t,this.filterConditionNode,this.actions,this.css)),this.filter.load()},loadSearchNode:function(){this.searchBarAreaNode=new Element("div",{styles:this.css.searchBarAreaNode}).inject(this.searchNode),this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.searchBarAreaNode),this.searchBarActionNode=new Element("div",{styles:this.css.searchBarActionNode}).inject(this.searchBarNode),this.searchBarResetActionNode=new Element("div",{styles:this.css.searchBarResetActionNode}).inject(this.searchBarNode),this.searchBarResetActionNode.setStyle("display","none"),this.searchBarInputBoxNode=new Element("div",{styles:this.css.searchBarInputBoxNode}).inject(this.searchBarNode),this.searchBarInputNode=new Element("input",{type:"text",value:""!=this.options.searchKey?this.options.searchKey:this.app.lp.searchKey,styles:this.css.searchBarInputNode}).inject(this.searchBarInputBoxNode);var t=this;this.searchBarActionNode.addEvent("click",function(){this.search()}.bind(this)),this.searchBarResetActionNode.addEvent("click",function(){this.reset()}.bind(this)),this.searchBarInputNode.addEvents({focus:function(){this.value==t.app.lp.searchKey&&this.set("value","")},blur:function(){this.value||this.set("value",t.app.lp.searchKey)},keydown:function(t){13==t.code&&(this.search(),t.preventDefault())}.bind(this),selectstart:function(t){t.preventDefault()}})},search:function(t){t||(t=this.searchBarInputNode.get("value")),t==this.app.lp.searchKey&&(t=""),""!=t&&(this.searchBarResetActionNode.setStyle("display","block"),this.searchBarActionNode.setStyle("display","none")),this.options.searchKey=t,this.clearContentNode(),this.loadView()},clearContentNode:function(){this.elementContentNode.empty()},reset:function(){this.searchBarInputNode.set("value",this.app.lp.searchKey),this.searchBarResetActionNode.setStyle("display","none"),this.searchBarActionNode.setStyle("display","block"),this.options.searchKey="",this.clearContentNode(),this.loadView()},selectMode:function(){this.selectEnable=!0,this.view.selectMode()},disableSelectMode:function(){this.selectEnable=!1,this.view.disableSelectMode()},getSelectedIds:function(){return this.view.getSelectedIds()}}),MWF.xApplication.cms.Module.ListExplorer.DefaultList=new Class({initialize:function(t,e,i,s,o){this.container=t,this.app=e,this.explorer=i,this.css=i.css,this.actions=i.actions,this.data=s,this.searchKey=o},initData:function(){this.items=[],this.documents={},this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadItemQueue=0},load:function(t){this.initData(),this.node=new Element("div",{styles:this.css.elementContentListNode}).inject(this.container),this.table=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",class:"editTable"}).inject(this.node),this.initSortData(),this.createListHead(),this.loadElementList(null,t)},initSortData:function(){},clear:function(){this.documents=null,MWF.release(this.items),this.items=[],this.documents={},this.container.empty(),this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadItemQueue=0},reload:function(){this.clear(),this.node=new Element("div",{styles:this.css.elementContentListNode}).inject(this.container),this.table=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",class:"editTable"}).inject(this.node),this.createListHead(),this.loadElementList()},resort:function(t){this.orderField=t.retrieve("field"),""==t.retrieve("orderType")?this.orderType="asc":"asc"==this.orderType?this.orderType="desc":(this.orderField="",this.orderType=""),this.reload()},createListHead:function(){var t=this,e=this.headNode=new Element("tr",{styles:this.css.listHeadNode}).inject(this.table);this.selectEnable&&this.createSelectTh();var i=this.explorer.path+"listItem.json";MWF.getJSON(i,function(i){this.listItemTemplate=i,i.each(function(i){var s=!0;if(i.access&&("admin"!=i.access||this.explorer.options.isAdmin||(s=!1)),s){var o=new Element("th",{styles:this.css[i.headStyles],width:i.width,text:i.title}).inject(e);"yes"==i.sortByClickTitle&&(o.store("field",i.item),this.orderField==i.item&&""!=this.orderType?(o.store("orderType",this.orderType),this.sortIconNode=new Element("div",{styles:"asc"==this.orderType?this.css.sortIconNode_asc:this.css.sortIconNode_desc}).inject(o,"bottom")):(o.store("orderType",""),this.sortIconNode=new Element("div",{styles:this.css.sortIconNode}).inject(o,"bottom")),o.setStyle("cursor","pointer"),o.addEvent("click",(function(){t.resort(this)})))}}.bind(this))}.bind(this),!1)},selectMode:function(){this.selectEnable=!0,this.createSelectTh(),this.items.each(function(t){t.createSelectTd()}.bind(this))},disableSelectMode:function(){this.selectEnable=!1,this.destroySelectTh(),this.items.each(function(t){t.destroySelectTd()}.bind(this))},destroySelectTh:function(){this.selectTh&&(this.selectTh.destroy(),this.selectTh=null)},createSelectTh:function(){this.selectTh=new Element("th",{styles:{width:"20px"}}).inject(this.headNode,"top"),this.checkboxElement=new Element("input",{type:"checkbox"}).inject(this.selectTh),this.checkboxElement.addEvent("click",function(){this.selectAll()}.bind(this))},selectAll:function(){var t=this.checkboxElement.get("checked");this.items.each(function(e){e.checkboxElement&&e.checkboxElement.set("checked",t)}.bind(this))},getSelectedIds:function(){var t=[];return this.items.each(function(e){e.checkboxElement.get("checked")&&t.push(e.data.id)}.bind(this)),t},getSelectedItems:function(){var t=[];return this.items.each(function(e){e.checkboxElement.get("checked")&&t.push(e)}.bind(this)),t},loadElementList:function(t,e){if(!this.isItemsLoaded)if(this.isItemLoadding)this.loadItemQueue++;else{if(this.isItemLoadding=!0,this.itemDataCount&&this.itemDataCount<=this.items.length)return void(this.isItemsLoaded=!0);this._getCurrentPageData(function(t){this.count=t.count,this.itemDataCount=t.count,t.count<=this.items.length&&(this.isItemsLoaded=!0),t.data.each(function(t){if(!this.documents[t.id]){var e=this._createItem(t);this.items.push(e),this.documents[t.id]=e}}.bind(this)),this.isItemLoadding=!1,this.loadItemQueue>0&&(this.loadItemQueue--,this.loadElementList()),e&&e()}.bind(this),t)}},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",s={categoryIdList:[this.explorer.categoryData.id],statusList:[this.explorer.options.status],orderField:this.orderField||"publishTime",orderType:this.orderType||"desc"};if(this.searchKey&&""!=this.searchKey&&(s.title=this.searchKey),this.filter&&this.filter.filter){var o=this.filter.getFilterResult();for(var n in o)s[n]=o[n];this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))}else this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))},removeDocument:function(t,e){var i=t.data.id;this.actions.removeDocument(i,function(t){this.items.erase(this.documents[i]),this.documents[i].destroy(),MWF.release(this.documents[i]),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createItem:function(t){return new MWF.xApplication.cms.Module.ListExplorer.DefaultDocument(this.table,t,this.explorer,this)}}),MWF.xApplication.cms.Module.ListExplorer.ListForALL=new Class({Extends:MWF.xApplication.cms.Module.ListExplorer.DefaultList,createListHead:function(){var t=this,e=this.headNode=new Element("tr",{styles:this.css.listHeadNode}).inject(this.table);this.selectEnable&&this.createSelectTh();var i=this.explorer.path+"listItemForAll.json";MWF.getJSON(i,function(i){this.listItemTemplate=i,i.each(function(i){var s=!0;if(i.access&&("admin"!=i.access||this.explorer.options.isAdmin||(s=!1)),s)var o=new Element("th",{styles:this.css[i.headStyles],width:i.width,text:i.title}).inject(e);"yes"==i.sortByClickTitle&&(o.store("field",i.item),this.orderField==i.item&&""!=this.orderType?(o.store("orderType",this.orderType),this.sortIconNode=new Element("div",{styles:"asc"==this.orderType?this.css.sortIconNode_asc:this.css.sortIconNode_desc}).inject(o,"bottom")):(o.store("orderType",""),this.sortIconNode=new Element("div",{styles:this.css.sortIconNode}).inject(o,"bottom")),o.setStyle("cursor","pointer"),o.addEvent("click",(function(){t.resort(this)})))}.bind(this))}.bind(this),!1)},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",s={appIdList:[this.explorer.columnData.id],statusList:[this.explorer.options.status],orderField:this.orderField||"publishTime",orderType:this.orderType||"desc"};if(this.searchKey&&""!=this.searchKey&&(s.title=this.searchKey),this.filter&&this.filter.filter){var o=this.filter.getFilterResult();for(var n in o)s[n]=o[n];this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))}else this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))}}),MWF.xApplication.cms.Module.ListExplorer.ListForDraft=new Class({Extends:MWF.xApplication.cms.Module.ListExplorer.DefaultList,createListHead:function(){var t=this,e=this.headNode=new Element("tr",{styles:this.css.listHeadNode}).inject(this.table);this.selectEnable&&this.createSelectTh();var i=this.explorer.path+"listItemForAll.json";MWF.getJSON(i,function(i){this.listItemTemplate=i,i.each(function(i){var s=!0;if(i.access&&("admin"!=i.access||this.explorer.options.isAdmin||(s=!1)),s)var o=new Element("th",{styles:this.css[i.headStyles],width:i.width,text:i.title}).inject(e);"yes"==i.sortByClickTitle&&(o.store("field",i.item),this.orderField==i.item&&""!=this.orderType?(o.store("orderType",this.orderType),this.sortIconNode=new Element("div",{styles:"asc"==this.orderType?this.css.sortIconNode_asc:this.css.sortIconNode_desc}).inject(o,"bottom")):(o.store("orderType",""),this.sortIconNode=new Element("div",{styles:this.css.sortIconNode}).inject(o,"bottom")),o.setStyle("cursor","pointer"),o.addEvent("click",(function(){t.resort(this)})))}.bind(this))}.bind(this),!1)},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",s={appIdList:[this.explorer.columnData.id],statusList:["draft"],orderField:this.orderField||null,orderType:this.orderType||null};if(this.searchKey&&""!=this.searchKey&&(s.title=this.searchKey),this.filter&&this.filter.filter){var o=this.filter.getFilterResult();for(var n in o)s[n]=o[n];this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))}else this.actions.listDocumentFilterNext(i,e||this.pageCount,s,(function(e){t&&t(e)}))}}),MWF.xApplication.cms.Module.ListExplorer.List=new Class({Extends:MWF.xApplication.cms.Module.ListExplorer.DefaultList,initSortData:function(){this.orderField=this.data.orderField?this.data.orderField:"",this.orderType=this.data.orderType?this.data.orderType:"",this.viewId=this.data.id,this.categoryId=this.explorer.categoryData.id,this.status=this.explorer.options.status},createListHead:function(){var t=this,e=this.headNode=new Element("tr",{styles:this.css.listHeadNode}).inject(this.table);this.selectEnable&&this.createSelectTh(),this.data.content.columns.each(function(i){var s="px"==i.widthType?i.width+"px":i.widthPer+"%",o=new Element("th",{styles:this.css.normalThNode,width:s,text:i.title?i.title:""}).inject(e);"yes"==i.sortByClickTitle&&(o.store("field",i.value),this.orderField==i.value&&""!=this.orderType?(o.store("orderType",this.orderType),this.sortIconNode=new Element("div",{styles:"asc"==this.orderType.toLowerCase()?this.css.sortIconNode_asc:this.css.sortIconNode_desc}).inject(o,"bottom")):(o.store("orderType",""),this.sortIconNode=new Element("div",{styles:this.css.sortIconNode}).inject(o,"bottom")),o.setStyle("cursor","pointer"),o.addEvent("click",(function(){t.resort(this)})))}.bind(this))},resort:function(t){this.orderField=t.retrieve("field"),this.orderType=(t.retrieve("orderType")||"").toLowerCase(),this.orderField===this.data.orderField?this.orderType="asc"===this.orderType?"desc":"asc":""==this.orderType?this.orderType="asc":"asc"==this.orderType?this.orderType="desc":(this.orderField=this.data.orderField?this.data.orderField:"",this.orderType=this.data.orderType?this.data.orderType:""),this.reload()},_getCurrentPageData:function(t,e){e||(e=20);var i=this.items.length?this.items[this.items.length-1].data.document.id:"(0)",s={orderField:this.orderField||"publishTime",orderType:this.orderType||"desc",categoryId:this.categoryId,viewId:this.viewId,searchDocStatus:this.status};this.actions.listViewDataNext(i,e,s,(function(e){e.data.each((function(t){t.id||(t.id=t.document.id),t.title||(t.title=t.document.title)})),t&&t(e)}))},_createItem:function(t){return new MWF.xApplication.cms.Module.ListExplorer.Document(this.table,t,this.explorer,this)}}),MWF.xApplication.cms.Module.ListExplorer.Filter=new Class({initialize:function(t,e,i,s,o,n,r){this.app=t,this.explorer=e,this.css=r,this.actions=n,this.filterNode=$(i),this.filterActionNode=$(s),this.filterConditionNode=o},load:function(){var t=this.explorer.path+"filterItem.json";MWF.getJSON(t,function(t){this.filterSetting=t,this.isFilterOpen?!this.filterAreaMorph&&this.filterAreaMorph.isRunning()||this.hideFilter():this.filterAreaMorph&&this.filterAreaMorph.isRunning()||this.showFilter()}.bind(this))},showFilter:function(){this.filterAreaNode||this.createFilterAreaNode(),this.filterAreaTipNode.setStyle("display","block"),this.filterAreaNode.setStyle("display","block"),this.resizeFilterAreaNode();this.isFilterOpen=!0,this.filterAreaMorph.start({width:"460px",height:"500px"}).chain(function(){this.createFilterAreaTitle(),this.createFilterAreaContent(),this.hideFilterFun=this.hideFilter.bind(this),$(document.body).addEvent("click",this.hideFilterFun)}.bind(this))},hideFilter:function(){if(this.filterAreaNode){this.filterAreaNode.empty(),this.isFilterOpen=!1,this.filterAreaMorph.start({width:"460px",height:"0px"}).chain(function(){this.filterAreaNode.eliminate("input"),this.filterAreaNode.setStyle("display","none"),this.filterAreaTipNode.setStyle("display","none"),$(document.body).removeEvent("click",this.hideFilterFun)}.bind(this)),$(document.body).removeEvent("click",this.hideFilterFun)}},createFilterAreaNode:function(){this.filterAreaNode=new Element("div",{styles:this.css.filterAreaNode}).inject(this.app.content),this.filterAreaNode.addEvent("click",(function(t){t.stopPropagation()})),this.filterAreaTipNode=new Element("div",{styles:this.css.filterAreaTipNode}).inject(this.app.content),this.filterAreaNode.setStyles({width:"460px",height:"0px"}),this.filterAreaNode.position({relativeTo:this.filterNode,position:"bottomRight",edge:"upperRight",offset:{x:-20,y:-1}}),this.filterAreaTipNode.position({relativeTo:this.filterNode,position:"bottomRight",edge:"bottomRight",offset:{x:-38,y:0}}),this.app.addEvent("resize",function(){this.resizeFilterAreaNode()}.bind(this)),this.filterAreaMorph=new Fx.Morph(this.filterAreaNode,{duration:"100",transition:Fx.Transitions.Sine.easeInOut})},resizeFilterAreaNode:function(){this.filterAreaNode&&(this.filterAreaNode.position({relativeTo:this.filterNode,position:"bottomRight",edge:"upperRight",offset:{x:-20,y:-1}}),this.filterAreaTipNode&&this.filterAreaTipNode.position({relativeTo:this.filterNode,position:"bottomRight",edge:"bottomRight",offset:{x:-38,y:0}}))},createFilterAreaTitle:function(){var t=new Element("div",{styles:this.css.filterAreaTitleNode}).inject(this.filterAreaNode),e=new Element("div",{styles:this.css.filterAreaTitleActionOkNode,text:this.app.lp.ok}).inject(t);new Element("div",{styles:this.css.filterAreaTitleActionClearNode,text:this.app.lp.clear}).inject(t).addEvent("click",function(){this.filterAreaNode.getElements(".filterItem").each(function(t){this.unSelectedFilterItem(t)}.bind(this)),this.filterAreaNode.retrieve("input").set("value",""),this.filter=null,this.hideFilter(),this.setFilterConditions(),this.explorer.reloadElementContent()}.bind(this)),e.addEvent("click",function(){var t=this.filterAreaNode.retrieve("input");this.filter||(this.filter={});var e=t.get("value");e&&e!=this.app.lp.searchKey?this.filter.key=e:(this.filter.key="",delete this.filter.key),this.hideFilter(),this.setFilterConditions(),this.explorer.reloadElementContent()}.bind(this));var i=new Element("div",{styles:this.css.filterAreaTitleSearchNode}).inject(t),s=(new Element("div",{styles:this.css.filterAreaTitleSearchIconNode}).inject(i),new Element("div",{styles:this.css.filterAreaTitleSearchInputAreaNode}).inject(i)),o=new Element("input",{styles:this.css.filterAreaTitleSearchInputNode,value:this.app.lp.searchKey}).inject(s);this.filter&&this.filter.key&&o.set("value",this.filter.key),this.filterAreaNode.store("input",o);var n=this.app.lp.searchKey;o.addEvents({blur:function(){this.get("value")||this.set("value",n)},focus:function(){this.get("value")==n&&this.set("value","")},keydown:function(t){if(13==t.code){var e=this.filterAreaNode.retrieve("input");this.filter||(this.filter={});var i=e.get("value");i&&i!=this.app.lp.searchKey?this.filter.key=i:(this.filter.key="",delete this.filter.key),this.hideFilter(),this.setFilterConditions(),this.explorer.reloadElementContent()}}.bind(this)})},createFilterAreaContent:function(){var t=new Element("div",{styles:this.css.applicationFilterAreaContentScrollNode}).inject(this.filterAreaNode),e=new Element("div",{styles:{overflow:"hidden"}}).inject(t);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(t,{style:"xApp_filter",where:"after",distance:30,friction:4,axis:{x:!1,y:!0}})}.bind(this));var i=this;this._getFilterCount(function(t){Object.each(t,function(t,s){new Element("div",{styles:this.css.applicationFilterCategoryNode}).inject(e).set("text",t.name);var o=new Element("div",{styles:this.css.applicationFilterItemAreaNode}).inject(e);t.data.each(function(t){var e=new Element("div",{styles:this.css.applicationFilterItemNode}).inject(o);e.set("text",t.name+"("+t.count+")"),e.store("value",t.value),e.store("textname",t.name),e.store("key",s),e.store("resultItemName",t.resultItemName),e.addEvent("click",(function(){this.hasClass("applicationFilterItemNode_over")?i.unSelectedFilterItem(this):i.selectedFilterItem(this)})),this.filter&&this.filter[s]&&t.value==this.filter[s][0].value&&this.selectedFilterItem(e)}.bind(this))}.bind(this))}.bind(this))},_getFilterCount:function(t){var e="listCategoryDraftFilterAttribute";"published"==this.explorer.options.status?e="listCategoryPublishFilterAttribute":"archived"==this.explorer.options.status&&(e="listCategoryArchiveFilterAttribute"),this.actions[e](this.explorer.categoryData.id,function(e){this.filterAttribute={},Object.each(e.data,function(t,e){var i=this.filterSetting[e];if(i){var s=this.filterAttribute[i.resultListKey]={name:i.categoryTitle,data:[]};t.each((function(t){s.data.push({name:t[i.itemNameKey],value:t[i.itemValueKey],count:t.count,resultItemName:i.resultItemName})}))}}.bind(this)),t&&t(this.filterAttribute)}.bind(this))},unSelectedFilterItem:function(t){if(t.hasClass("applicationFilterItemNode_over")){t.retrieve("value"),t.retrieve("textname");var e=t.retrieve("key");t.setStyles(this.css.applicationFilterItemNode),t.removeClass("applicationFilterItemNode_over"),t.addClass("applicationFilterItemNode"),this.filter||(this.filter={}),this.filter[e]=null,delete this.filter[e],t.getParent().eliminate("current")}},selectedFilterItem:function(t){if(!t.hasClass("applicationFilterItemNode_over")){var e=t.getParent().retrieve("current");e&&this.unSelectedFilterItem(e);var i=t.retrieve("value"),s=t.retrieve("key"),o=t.retrieve("textname"),n=t.retrieve("resultItemName");t.setStyles(this.css.applicationFilterItemNode_over),t.removeClass("applicationFilterItemNode"),t.addClass("applicationFilterItemNode_over"),this.filter||(this.filter={}),this.filter[s]=[{value:i,name:o,resultItemName:n}],t.getParent().store("current",t)}},searchElement:function(){this.filter||(this.filter={});var t=this.searchElementInputNode.get("value");t&&t!=this.app.lp.searchKey&&(this.filter.key=t,this.hideFilter(),this.setFilterConditions(),this.explorer.reloadElementContent())},setFilterConditions:function(){this.filterConditionNode.empty(),this.filter&&(Object.each(this.filter,function(t,e){"key"!=e&&this.createFilterItemNode(e,t[0])}.bind(this)),this.filter.key&&this.createFilterItemNode("key",{name:this.filter.key}))},createFilterItemNode:function(t,e){var i=this,s=new Element("div",{styles:this.css.filterListItemNode}).inject(this.filterConditionNode),o=new Element("div",{styles:this.css.filterListItemActionNode}).inject(s),n=new Element("div",{styles:this.css.filterListItemTextNode}).inject(s);"key"!=t?n.set("text",this.filterAttribute[t].name+": "+e.name):n.set("text",this.filterSetting.key.categoryTitle+": "+e.name),o.store("key",t),s.addEvents({mouseover:function(){this.setStyles(i.css.filterListItemNode_over),this.getLast().setStyles(i.css.filterListItemTextNode_over),this.getFirst().setStyles(i.css.filterListItemActionNode_over)},mouseout:function(){this.setStyles(i.css.filterListItemNode),this.getLast().setStyles(i.css.filterListItemTextNode),this.getFirst().setStyles(i.css.filterListItemActionNode)}}),o.addEvent("click",(function(){var t=this.retrieve("key");i.filter[t]&&(i.filter[t]=null),delete i.filter[t],this.destroy(),i.setFilterConditions(),i.explorer.reloadElementContent()}))},getFilterResult:function(){var t={};return Object.each(this.filter,function(e,i){"key"==i&&this.filterSetting.key?t[this.filterSetting.key.resultListKey]=[{name:this.filterSetting.key.resultItemName,value:e}]:t[i]=[{name:e[0].resultItemName,value:e[0].value}]}.bind(this)),t}}),MWF.xApplication.cms.Module.ListExplorer.DefaultDocument=new Class({initialize:function(t,e,i,s){this.explorer=i,this.app=i.app,this.data=e,this.container=t,this.view=s,this.css=this.explorer.css,this.load()},load:function(){this.node=new Element("tr",{styles:this.css.documentItemNode}),this.node.inject(this.container),this.view.selectEnable&&this.createSelectTd(),this.view.listItemTemplate.each(function(t){var e=!0;t.access&&("admin"!=t.access||this.explorer.options.isAdmin||(e=!1)),e&&(this[t.name]=new Element("td",{styles:this.css[t.contentStyles],text:this.data[t.item]?this.data[t.item]:""}).inject(this.node))}.bind(this)),this.setActions(),this.setEvents()},destroySelectTd:function(){this.selectTd&&(this.selectTd.destroy(),this.selectTd=null)},createSelectTd:function(){this.selectTd||(this.selectTd=new Element("td").inject(this.node,"top"),this.checkboxElement=new Element("input",{type:"checkbox",events:{click:function(t){t.stopPropagation()}}}).inject(this.selectTd),this.selectTd.addEvent("click",function(t){this.checkboxElement.set("checked",!this.checkboxElement.get("checked")),t.stopPropagation()}.bind(this)))},setEvents:function(){this.node.addEvents({mouseover:function(){this.readyRemove||this.node.setStyles(this.css.documentItemDocumentNode_over)}.bind(this),mouseout:function(){this.readyRemove||this.node.setStyles(this.css.documentItemDocumentNode)}.bind(this),click:function(t){this.openDocument(t)}.bind(this)}),this.setTopNode&&this.setTopNode.addEvents({mouseover:function(){this.setTopNode.setStyles(this.css.actionSetTopNode_over)}.bind(this),mouseout:function(){this.setTopNode.setStyles(this.css.actionSetTopNode)}.bind(this),mousedown:function(){this.setTopNode.setStyles(this.css.actionSetTopNode_down)}.bind(this),mouseup:function(){this.setTopNode.setStyles(this.css.actionSetTopNode_over)}.bind(this),click:function(t){this.setTop(t),t.stopPropagation()}.bind(this)}),this.shareNode&&this.shareNode.addEvents({mouseover:function(){this.shareNode.setStyles(this.css.actionShareNode_over)}.bind(this),mouseout:function(){this.shareNode.setStyles(this.css.actionShareNode)}.bind(this),mousedown:function(){this.shareNode.setStyles(this.css.actionShareNode_down)}.bind(this),mouseup:function(){this.shareNode.setStyles(this.css.actionShareNode_over)}.bind(this),click:function(t){this.share(t),t.stopPropagation()}.bind(this)}),this.openNode&&this.openNode.addEvents({mouseover:function(){this.openNode.setStyles(this.css.actionOpenNode_over)}.bind(this),mouseout:function(){this.openNode.setStyles(this.css.actionOpenNode)}.bind(this),mousedown:function(){this.openNode.setStyles(this.css.actionOpenNode_down)}.bind(this),mouseup:function(){this.openNode.setStyles(this.css.actionOpenNode_over)}.bind(this),click:function(t){this.openDocument(t),t.stopPropagation()}.bind(this)}),this.deleteNode&&this.deleteNode.addEvents({mouseover:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),mouseout:function(){this.deleteNode.setStyles(this.css.actionDeleteNode)}.bind(this),mousedown:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_down)}.bind(this),mouseup:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),click:function(t){this.remove(t),t.stopPropagation()}.bind(this)}),this.editNode&&this.editNode.addEvents({mouseover:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),mouseout:function(){this.editNode.setStyles(this.css.actionEditNode)}.bind(this),mousedown:function(){this.editNode.setStyles(this.css.actionEditNode_down)}.bind(this),mouseup:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),click:function(t){this.openDocument(t,!0),t.stopPropagation()}.bind(this)})},setActions:function(){this.actionAreaNode&&this.explorer.options.isAdmin&&(this.deleteNode=new Element("div",{styles:this.css.actionDeleteNode,title:this.explorer.app.lp.delete}).inject(this.actionAreaNode),this.editNode=new Element("div",{styles:this.css.actionEditNode,title:this.explorer.app.lp.edit}).inject(this.actionAreaNode))},openDocument:function(t,e){var i="cms.Document"+this.data.id;if(this.app.desktop.apps[i])this.app.desktop.apps[i].setCurrent();else{var s={documentId:this.data.id,appId:i,readonly:!e,postDelete:function(){this.view.reload()}.bind(this)};this.explorer.app.desktop.openApplication(t,"cms.Document",s)}},remove:function(t){var e,i=this.explorer.app.lp;e=this.data.title&&this.data.title!=i.untitled?'"'+this.data.title+'"':i.currentDocument;var s=i.deleteDocument.replace(/{title}/g,e),o=this;this.node.setStyles(this.css.documentItemDocumentNode_remove),this.readyRemove=!0,this.explorer.app.confirm("warn",t,i.deleteDocumentTitle,s,350,120,(function(){o.view.removeDocument(o,!1),this.close()}),(function(){o.node.setStyles(o.css.documentItemDocumentNode),o.readyRemove=!1,this.close()}))},destroy:function(){this.node.destroy()},setPersonData:function(){this.explorer.personActions,this.explorer.app.lp;new MWF.widget.O2Identity({name:this.data.creatorIdentity},this.personAreaNode,{style:"work"})}}),MWF.xApplication.cms.Module.ListExplorer.Document=new Class({Extends:MWF.xApplication.cms.Module.ListExplorer.DefaultDocument,load:function(){this.node=new Element("tr",{styles:this.css.documentItemNode}).inject(this.container),this.view.selectEnable&&this.createSelectTd(),this.view.data.content.columns.each(function(t){var e=t.value&&""!=t.value&&(this.data.document[t.value]||this.data.data[t.value])||"";if("array"==typeOf(e)){var i=[];e.each((function(t){"object"==typeOf(t)?t.name&&i.push(t.name):"string"==typeOf(t)?i.push(t):"array"==typeOf(t)?i.push(t.join(",")):i.push(t.toString())})),e=i.join(",")}var s=new Element("td",{styles:this.css.normalTdNode,text:e}).inject(this.node);t.align&&"center"!=t&&("left"==t.align?s.setStyle("text-align","left"):"right"==t.align&&s.setStyle("text-align","right")),t.operation&&(this.explorer.options.isAdmin&&(t.operation.deleteDocument&&(this.deleteNode=new Element("div",{styles:this.css.actionDeleteNode,title:this.explorer.app.lp.delete}).inject(s)),t.operation.editDocument&&(this.editNode=new Element("div",{styles:this.css.actionEditNode,title:this.explorer.app.lp.edit}).inject(s))),t.operation.share&&(this.shareNode=new Element("div",{styles:this.css.actionShareNode,title:this.explorer.app.lp.share}).inject(s)))}.bind(this)),this.setEvents()}});