MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Module=MWF.xApplication.cms.Module||{},MWF.require("MWF.xAction.org.express.RestActions",null,!1),MWF.xDesktop.requireApp("cms.Module","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("cms.Module","package",null,!1),MWF.xDesktop.requireApp("process.Application","Viewer",null,!1),MWF.xDesktop.requireApp("query.Query","Viewer",null,!1),MWF.xApplication.cms.Module.ViewExplorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isAdmin:!1,searchKey:""},initialize:function(e,t,i,s,n,o,l){this.setOptions(o),this.node=e,this.app=t,this.columnData=i,this.categoryData=s,this.revealData=n,this.searchNode=l,this.path="../x_component_cms_Module/$ViewExplorer/",this.cssPath="../x_component_cms_Module/$ViewExplorer/"+this.options.style+"/css.wcss",this._loadCss()},reload:function(){this.node.empty(),this.searchNode.empty(),this.load()},load:function(){this.loadContentNode(),this.loadQuryView()},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node),this.searchContainer=new Element("div",{styles:this.css.searchContainer}).inject(this.searchNode),this.resizeFun=function(){this.setContentSize()}.bind(this),this.app.addEvent("resize",this.resizeFun)},loadQuryView:function(){var e={application:this.revealData.appName,viewName:this.revealData.name,isTitle:"yes",select:"none",titleStyles:this.css.normalThNode,itemStyles:{},filter:[]};this.view=new MWF.xApplication.cms.Module.QueryViewer(this.elementContentNode,e,{hasAction:this.options.isAdmin,resizeNode:!0,selectEnable:this.selectEnable,onSelect:function(){this.fireEvent("select")}.bind(this)},this.app,this.searchContainer),this.setContentSize()},selectMode:function(){this.selectEnable=!0,this.view.selectMode()},disableSelectMode:function(){this.selectEnable=!1,this.view.disableSelectMode()},getSelectedIds:function(){return this.view.getSelectedIds()},setContentSize:function(){var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},t=this.app.node.getSize(),i=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0},s=t.y-e.y-0-0-i.y-0;this.elementContentNode.setStyle("height",s+"px"),this.view&&this.view.setContentHeight()}}),MWF.xApplication.cms.Module.QueryViewer=new Class({Implements:[Options,Events],Extends:MWF.QViewer,options:{style:"default",hasAction:!1,resizeNode:!0,paging:"scroll",perPageCount:50,selectEnable:!1},initialize:function(e,t,i,s,n){this.setOptions(i),this.app=s,this.searchContainer=n,this.path="../x_component_cms_Module/$ViewExplorer/",this.cssPath="../x_component_cms_Module/$ViewExplorer/"+this.options.style+"/viewer.wcss",this._loadCss(),this.lp=MWF.xApplication.query.Query.LP,this.container=$(e),this.json=t,this.viewJson=null,this.filterItems=[],this.searchStatus="none",this.originalJson=Object.clone(t),this.selectEnable=this.options.selectEnable,this.items=[],this.selectedItems=[],this.hideColumns=[],this.openColumns=[],this.gridJson=null,this.init(function(){this.load()}.bind(this))},selectMode:function(){this.selectEnable=!0,this.createSelectTh(),this.items.each(function(e){"category"==e.clazzType?e.items.each((function(e){e.createSelectTd()})):e.createSelectTd()}.bind(this))},disableSelectMode:function(){this.selectEnable=!1,this.destroySelectTh(),this.items.each(function(e){"category"==e.clazzType?e.items.each((function(e){e.destroySelectTd()})):e.destroySelectTd()}.bind(this))},destroySelectTh:function(){this.selectTh&&(this.selectTh.destroy(),this.selectTh=null)},createSelectTh:function(){var e=this.viewJson.viewStyles,t=e&&e.titleTd?e.titleTd:this.css.viewTitleCellNode;this.selectTh=new Element("td",{styles:t}).inject(this.viewTitleLine,"top"),this.selectTh.setStyles({width:"20px"}),this.checkboxElement=new Element("input",{type:"checkbox"}).inject(this.selectTh),this.checkboxElement.addEvent("click",function(){this.selectAll()}.bind(this))},selectAll:function(){var e=this.checkboxElement.get("checked");this.items.each(function(t){"category"==t.clazzType?(t.expand(),t.items.each((function(t){t.checkboxElement&&t.checkboxElement.set("checked",e)}))):t.checkboxElement&&t.checkboxElement.set("checked",e)}.bind(this))},getSelectedIds:function(){var e=[];return this.items.each(function(t){"category"==t.clazzType?t.items.each((function(t){t.checkboxElement.get("checked")&&e.push(t.data.bundle)})):t.checkboxElement.get("checked")&&e.push(t.data.bundle)}.bind(this)),e},getSelectedItems:function(){var e=[];return this.items.each(function(t){"category"==t.clazzType?t.items.each((function(t){t.checkboxElement.get("checked")&&e.push(t)})):t.checkboxElement.get("checked")&&e.push(t)}.bind(this)),e},createViewNode:function(e){this.viewAreaNode.empty();var t=this.viewJson.viewStyles;this.contentAreaNode=new Element("div",{styles:t&&t.container?t.container:this.css.contentAreaNode}).inject(this.viewAreaNode),this.viewTable=new Element("table.viewTable",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.contentAreaNode),t&&(t.tableProperties&&this.viewTable.set(t.tableProperties),t.table&&this.viewTable.setStyles(t.table)),this.createLoadding();var i=t&&t.titleTd?t.titleTd:this.css.viewTitleCellNode;if("no"!==this.json.isTitle){if(this.viewTitleLine=new Element("tr",{styles:t&&t.titleTr?t.titleTr:this.css.viewTitleLineNode}).inject(this.viewTable),this.selectEnable&&this.createSelectTh(),this.selectTitleCell=new Element("td",{styles:i}).inject(this.viewTitleLine),this.selectTitleCell.setStyle("width","10px"),this.viewJson.firstTdHidden=!0,this.json.defaultSelectedScript&&(this.json.defaultSelectedScript=""),this.viewJson.defaultSelectedScript&&(this.viewJson.defaultSelectedScript=""),this.json.selectedAbleScript&&(this.json.selectedAbleScript=""),this.viewJson.selectedAbleScript&&(this.viewJson.selectedAbleScript=""),this.isSelectTdHidden()&&this.selectTitleCell.hide(),"yes"===this.viewJson.isSequence&&(this.sequenceTitleCell=new Element("td",{styles:i}).inject(this.viewTitleLine),this.sequenceTitleCell.setStyle("width","10px")),this.entries={},this.viewJson.selectList.each(function(e){if(this.entries[e.column]=e,e.hideColumn)this.hideColumns.push(e.column);else{var t=new Element("td",{styles:i,text:e.displayName}).inject(this.viewTitleLine),s=MWF.getTextSize(e.displayName,i);t.setStyle("min-width",s.x+"px")}e.allowOpen&&this.openColumns.push(e.column)}.bind(this)),this.options.hasAction){var s=new Element("td",{styles:i,text:this.lp.action}).inject(this.viewTitleLine);s.setStyle("width","40px"),this.json.titleStyles&&s.setStyles(this.json.titleStyles)}this.lookup(e)}else this.entries={},this.viewJson.selectList.each(function(e){this.entries[e.column]=e,e.hideColumn&&this.hideColumns.push(e.column),e.allowOpen||this.openColumns.push(e.column)}.bind(this)),this.lookup(e)},loadLayout:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container),this.actionbarAreaNode=new Element("div.actionbarAreaNode",{styles:this.css.actionbarAreaNode}).inject(this.node),this.searchAreaNode=new Element("div",{styles:this.css.searchAreaNode}).inject(this.searchContainer||this.node),this.viewAreaNode=new Element("div.viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.node),this.viewPageAreaNode=new Element("div",{styles:this.css.viewPageAreaNode}).inject(this.node)},loadData:function(){this.checkboxElement&&this.checkboxElement.set("checked",!1),this.gridJson.length?this.options.paging?this.loadPaging():this.gridJson.each(function(e,t){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.Item(this,e,null,t))}.bind(this)):this.viewPageAreaNode&&this.viewPageAreaNode.empty()},loadPaging:function(){this.isItemsLoading=!1,this.pageNumber=0,this.isItemsLoaded=!1,this.isSetedScroll=!1,this.setScroll(),this.loadDataByPaging()},setScroll:function(){this.options.paging&&!this.isSetedScroll&&(this.contentAreaNode.setStyle("overflow","auto"),this.scrollContainerFun=function(){var e=this.contentAreaNode.getScrollSize(),t=this.contentAreaNode.getSize(),i=e.y-t.y;this.contentAreaNode.scrollTop+150>i&&(this.isItemsLoaded||this.loadDataByPaging())}.bind(this),this.isSetedScroll=!0,this.contentAreaNode.addEvent("scroll",this.scrollContainerFun))},loadDataByPaging:function(){if(!this.isItemsLoading&&!this.isItemsLoaded){var e=Math.min(this.pageNumber*this.options.perPageCount,this.gridJson.length),t=Math.min((this.pageNumber+1)*this.options.perPageCount+1,this.gridJson.length);this.isItemsLoading=!0;for(var i=e;i<t;i++)this.items.push(new MWF.xApplication.cms.Module.QueryViewer.Item(this,this.gridJson[i],null,i));this.isItemsLoading=!1,this.pageNumber++,t==this.gridJson.length&&(this.isItemsLoaded=!0)}},loadGroupData:function(){if(this.checkboxElement&&this.checkboxElement.set("checked",!1),this.selectTitleCell&&!this.selectTitleCell.retrieve("expandLoaded")&&(this.viewJson.viewStyles&&this.viewJson.viewStyles.groupCollapseNode?(this.expandAllNode=new Element("span",{styles:this.viewJson.viewStyles.groupCollapseNode}).inject(this.selectTitleCell),this.selectTitleCell.setStyle("cursor","pointer")):this.selectTitleCell.set("html","<span style='font-family: Webdings'><img src='../x_component_query_Query/$Viewer/"+this.options.style+"/icon/expand.png'/></span>"),this.selectTitleCell.setStyle("cursor","pointer"),this.selectTitleCell.addEvent("click",this.expandOrCollapseAll.bind(this)),this.selectTitleCell.store("expandLoaded",!0)),this.gridJson.length){var e=0;this.gridJson.each(function(t){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.ItemCategory(this,t,e)),e+=t.list.length}.bind(this)),"yes"==this.getExpandFlag()&&this.expandOrCollapseAll()}else this.viewPageAreaNode&&this.viewPageAreaNode.empty()},createSearchNode:function(){this.viewJson.customFilterList&&this.viewJson.customFilterList.length?(this.searchStatus="default",this.loadFilterSearch(),this.originalSearchContainerWidth=this.searchContainer.getSize().x,this.viewSearchCustomActionNode.addEvents({click:function(){var e=this.searchContainer.getParent();if(e){var t=e.getParent().getSize().x;this.searchContainer.setStyle("width",Math.min(800,t)+"px")}}.bind(this)})):(this.searchStatus="simple",this.loadSimpleSearch())},loadSimpleSearch:function(){return!1},setContentHeight:function(){if(this.viewSearchCustomCloseActionNode&&!this.setCustomSearchCloseEvent&&(this.viewSearchCustomCloseActionNode.addEvent("click",function(){this.searchContainer.setStyle("width",this.originalSearchContainerWidth+"px")}.bind(this)),this.setCustomSearchCloseEvent=!0),this.viewSearchInputAreaNode&&this.viewSearchInputAreaNode.setStyle("width","auto"),this.node&&this.searchContainer&&this.viewAreaNode){var e,t=this.node.getSize(),i=this.searchContainer.getParent();e=i?i.getParent().getSize():this.searchContainer.getSize();var s=t.y-e.y;if(this.actionbarAreaNode)s-=this.actionbarAreaNode.getComputedSize().totalHeight;s-=this.viewPageAreaNode.getComputedSize().totalHeight,this.viewAreaNode.setStyle("height",s+"px")}}}),MWF.xApplication.cms.Module.QueryViewer.Item=new Class({Extends:MWF.xApplication.query.Query.Viewer.Item,load:function(){this.view.fireEvent("queryLoadItemRow",[null,this]);var e=this,t=this.view.viewJson.viewStyles,i=t&&t.contentTd?t.contentTd:this.css.viewContentTdNode;if(this.node=new Element("tr",{styles:t&&t.contentTr?t.contentTr:this.css.viewContentTrNode}),this.prev?this.node.inject(this.prev.node,"after"):this.node.inject(this.view.viewTable),this.node.addEvents({mouseover:function(){this.setStyles(e.css.viewContentTrNode_over)},mouseout:function(){this.setStyles(e.css.viewContentTrNode)}}),this.view.selectEnable&&this.createSelectTd(),this.selectTd=new Element("td",{styles:i}).inject(this.node),this.selectTd.setStyles({cursor:"pointer"}),this.view.json.itemStyles&&this.selectTd.setStyles(this.view.json.itemStyles),this.view.isSelectTdHidden()&&this.selectTd.hide(),this.view.viewJson.selectList.each(function(e){var t=e.column,s=this.data.data[e.column];if(-1===this.view.hideColumns.indexOf(t)){var n=new Element("td",{styles:i}).inject(this.node);if(t!==this.view.viewJson.group.column){var o=s;e.isHtml?n.set("html",o):n.set("text",o)}-1!==this.view.openColumns.indexOf(t)&&this.setOpenWork(n,e),this.view.json.itemStyles&&n.setStyles(this.view.json.itemStyles)}}.bind(this)),this.view.options.hasAction){var s=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);this.loadActions(s),this.view.json.itemStyles&&s.setStyles(this.view.json.itemStyles)}this.setEvent(),this.view.fireEvent("postLoadItemRow",[null,this])},destroySelectTd:function(){this.checboxTd&&(this.checboxTd.destroy(),this.checboxTd=null)},createSelectTd:function(){if(!this.checboxTd){var e=this.view.viewJson.viewStyles,t=e&&e.contentTd?e.contentTd:this.css.viewContentTdNode;this.checboxTd=new Element("td",{styles:t}).inject(this.node,"top"),this.checkboxElement=new Element("input",{type:"checkbox",events:{click:function(e){e.stopPropagation()}}}).inject(this.checboxTd),this.checboxTd.addEvent("click",function(e){this.checkboxElement.set("checked",!this.checkboxElement.get("checked")),e.stopPropagation()}.bind(this))}},loadActions:function(e){this.deleteNode=new Element("div",{styles:this.css.actionDeleteNode,title:this.view.lp.delete}).inject(e),this.deleteNode.addEvents({mouseover:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),mouseout:function(){this.deleteNode.setStyles(this.css.actionDeleteNode)}.bind(this),mousedown:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_down)}.bind(this),mouseup:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),click:function(e){this.remove(e),e.stopPropagation()}.bind(this)}),this.editNode=new Element("div",{styles:this.css.actionEditNode,title:this.view.lp.edit}).inject(e),this.editNode.addEvents({mouseover:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),mouseout:function(){this.editNode.setStyles(this.css.actionEditNode)}.bind(this),mousedown:function(){this.editNode.setStyles(this.css.actionEditNode_down)}.bind(this),mouseup:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),click:function(e){this.editCMSDocument(),e.stopPropagation()}.bind(this)})},setOpenWork:function(e,t){e.setStyle("cursor","pointer"),t.clickCode?e.addEvent("click",function(e){var i=this.view.Macro.fire(t.clickCode,this,e);return e.stopPropagation(),i}.bind(this)):"cms"===this.view.json.type?e.addEvent("click",function(e){this.openCMSDocument(!1),e.stopPropagation()}.bind(this)):e.addEvent("click",function(e){this.openWorkAndCompleted(e),e.stopPropagation()}.bind(this))},openCMSDocument:function(e){var t="cms.Document"+this.data.bundle;if(layout.desktop.apps[t])layout.desktop.apps[t].window?layout.desktop.apps[t].setCurrent():(layout.desktop.apps[t]=null,layout.openApplication(null,layout.desktop.apps[t].options.name,layout.desktop.apps[t].options,layout.desktop.apps[t].options.app,!1,this,!1));else{var i={documentId:this.data.bundle,readonly:!e};layout.desktop.openApplication(null,"cms.Document",i)}},editCMSDocument:function(){this.openCMSDocument(!0)},remove:function(e){var t=this.view.lp.deleteConfirmContent,i=this;this.node.setStyles(this.css.viewContentTrNode_delete),this.readyRemove=!0,this.view.app.confirm("warn",e,this.view.lp.deleteConfirmTitle,t,350,120,(function(){i.removeCMSDocument(i,!1),this.close()}),(function(){i.node.setStyles(i.css.viewContentTrNode),i.readyRemove=!1,this.close()}))},removeCMSDocument:function(){var e=this.data.bundle;MWF.Actions.get("x_cms_assemble_control").removeDocument(e,function(e){this.readyRemove=!1,this.node.destroy(),this.view.app.notice(this.view.lp.deleteSuccessNotice,"success"),MWF.release(this)}.bind(this))}}),MWF.xApplication.cms.Module.QueryViewer.ItemCategory=new Class({Extends:MWF.xApplication.query.Query.Viewer.ItemCategory,load:function(){this.view.fireEvent("queryLoadCategoryRow",[null,this]);var e=this.view.viewJson.viewStyles,t=e&&e.contentGroupTd?e.contentGroupTd:this.css.viewContentCategoryTdNode;this.node=new Element("tr",{styles:e&&e.contentTr?e.contentTr:this.css.viewContentTrNode}).inject(this.view.viewTable),this.selectTd=new Element("td",{styles:t}).inject(this.node),this.view.json.itemStyles&&this.selectTd.setStyles(this.view.json.itemStyles);var i=this.view.viewJson.selectList.length+1;this.view.options.hasAction&&i++,this.categoryTd=new Element("td",{styles:t,colspan:i}).inject(this.node),this.groupColumn=null;for(var s=0;s<this.view.viewJson.selectList.length;s++)if(this.view.viewJson.selectList[s].column===this.view.viewJson.group.column){this.groupColumn=this.view.viewJson.selectList[s];break}if(this.groupColumn)var n=this.data.group;else n=this.data.group;e&&e.groupCollapseNode?(this.expandNode=new Element("span",{styles:e.groupCollapseNode}).inject(this.categoryTd),new Element("span",{text:n}).inject(this.categoryTd)):this.categoryTd.set("html","<span style='font-family: Webdings'><img src='../x_component_query_Query/$Viewer/"+this.view.options.style+"/icon/expand.png'/></span> "+n),this.expanded=!1,this.view.json.itemStyles&&this.categoryTd.setStyles(this.view.json.itemStyles),this.setEvent(),this.view.fireEvent("postLoadCategoryRow",[null,this])},expand:function(e){this.items.each(function(e){e.node.setStyle("display","table-row")}.bind(this)),this.expandNode?this.expandNode.setStyles(this.view.viewJson.viewStyles.groupExpandNode):this.node.getElement("span").set("html","<img src='../x_component_query_Query/$Viewer/"+this.view.options.style+"/icon/down.png'/>"),this.expanded=!0,this.loadChild||(this.data.list.each(function(e,t){var i=this.idx+t;this.lastItem=new MWF.xApplication.cms.Module.QueryViewer.Item(this.view,e,this.lastItem||this,i),this.items.push(this.lastItem)}.bind(this)),this.loadChild=!0),"view"!==e&&this.view.checkExpandAllStatus()}});