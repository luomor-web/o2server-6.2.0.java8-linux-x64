MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.Setting.UIModuleDocument=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_Setting/$SettingModuleUI/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.content=e,this.explorer=t,this.app=this.explorer.app,this.lp=this.app.lp.module,this.actions=MWF.Actions.get("x_component_assemble_control"),this.load()},destroy:function(){this.appDeploymentContent.destroy(),this.content.empty(),this.setContentHeightFun&&this.app.removeEvent("resize",this.setContentHeightFun),MWF.release(this)},load:function(){this.components=[],this.loadTitle(),this.appDeploymentContent=new Element("div",{styles:this.css.appDeploymentContent}).inject(this.content),this.componentsContent=new Element("div",{styles:this.css.componentsContent}).inject(this.appDeploymentContent),MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.content,{style:"processlayout"}),this.tab.load(),this.appPage=this.tab.addTab(this.appDeploymentContent,this.lp.moduleDeployed,!1),this.appPage.showIm(),this.setContentHeight(),this.setContentHeightFun=this.setContentHeight.bind(this),this.app.addEvent("resize",this.setContentHeightFun)}.bind(this)),this.loadApplicationContent()},loadTitle:function(){},loadApplicationContent:function(){this.loadApps(function(){MWF.AC.isAdministrator()&&this.loadNewApp()}.bind(this))},getComponentCatalogue:function(t){var e=MWF.defaultPath+"/xDesktop/$Layout/components.json";MWF.getJSON(e,function(e){t&&t(e)}.bind(this))},loadApps:function(t){this.getComponentCatalogue(function(e){e.each(function(t,e){this.components.push(new MWF.xApplication.Setting.UIModuleDocument.Component(t,this))}.bind(this)),this.actions.listComponent(function(e){e.data.each(function(t,e){this.components.push(new MWF.xApplication.Setting.UIModuleDocument.UserComponent(t,this))}.bind(this)),t&&t()}.bind(this))}.bind(this))},loadNewApp:function(){var t=new Element("div",{styles:this.css.componentItemNode}).inject(this.componentsContent);t.setStyles({"background-color":"#FFF"});var e=new Element("div",{styles:this.css.contentNode}).inject(t),i=new Element("div",{styles:this.css.titleNode}).inject(e),n=new Element("div",{styles:this.css.addIconNode}).inject(t);n.addEvents({mouseover:function(){n.setStyles(this.css.addIconNode_over),i.setStyle("color","#3498db")}.bind(this),mouseout:function(){n.setStyles(this.css.addIconNode),i.setStyle("color","#999")}.bind(this),click:function(t){this.createNewDeploy(t)}.bind(this)});new Element("div",{styles:this.css.actionAreaNode}).inject(t);i.set("text",this.lp.add),i.setStyle("color","#999")},createNewDeploy:function(){new MWF.xApplication.Setting.UIModuleDocument.Deploy(this)},deployApp:function(){var t=this.appContentNode.getElements("input"),e=t[0],i=t[1],n=t[2],s=e.get("value"),o=i.get("value");if(s&&o)if(n.files.length){var l=new FormData;l.append("file",n.files[0]),l.append("name",s),l.append("title",o),l.append("path","/res/mwf4/package/xApplication");var a=new COMMON.Browser.Request;a.open("POST","jaxrs/application",!1);var c=function(){if(4==a.readyState){var t=a.status;(t=1223==t?204:t)>=200&&t<300&&(this.app.notice(this.lp.deploySuccess,"success",this.appContentNode),this.appListNode.empty(),this.loadApps())}}.bind(this);a.onreadystatechange=c,a.send(l)}else this.app.notice(this.lp.uploadZipFileNotice,"error",this.appContentNode);else this.app.notice(this.lp.inputAppNameNotice,"error",this.appContentNode)},setContentHeight:function(t){var e=this.content.getSize(),i=this.tab.tabNodeContainer.getSize(),n=e.y-i.y;this.tab.pages.each((function(t){t.contentNodeArea.setStyles({height:n+"px",overflow:"auto"})}))}}),MWF.xApplication.Setting.UIModuleDocument.Component=new Class({initialize:function(t,e,i){this.data=t,this.deployment=e,this.css=this.deployment.css,this.content=this.deployment.componentsContent,this.load(i)},reload:function(t){this.data=t,this.node.empty(),this.load()},load:function(t){if(!this.node)if(this.node=new Element("div",{styles:this.css.componentItemNode}),t){var e=this.content.getLast("div");this.node.inject(e,"before")}else this.node.inject(this.content);var i;this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node),this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.contentNode),this.nameNode=new Element("div",{styles:this.css.nameNode}).inject(this.contentNode),this.iconNode=new Element("div",{styles:this.css.iconNode}).inject(this.node),this.actionAreaNode=new Element("div",{styles:this.css.actionAreaNode}).inject(this.node),i="@url"===this.data.path.substring(0,4)?this.data.iconPath?this.data.iconPath:"../x_component_Setting/$Main/default/icon/site.png":"../x_component_"+this.data.path.replace(/\./g,"_")+"/$Main/"+this.data.iconPath,this.iconNode.setStyle("background-image","url("+i+")"),this.titleNode.set("text",this.data.title),this.nameNode.set("text",this.data.name),this.addAction(),this.loadSystemFlag()},addAction:function(){if(this.data.visible){var t=layout.session.user,e=[t.name,t.distinguishedName,t.id,t.unique];t.roleList&&(e=e.concat(t.roleList)),t.groupList&&(e=e.concat(t.groupList));var i=!0;this.data.allowList&&(i=!this.data.allowList.length||this.data.allowList.isIntersect(e));var n=!1;this.data.denyList&&(n=!!this.data.denyList.length&&this.data.denyList.isIntersect(e)),(!n&&i||MWF.AC.isAdministrator())&&(this.openAction=new Element("div",{styles:this.css.actionNode,text:this.deployment.lp.open}).inject(this.actionAreaNode),this.openAction.addEvents({mouseover:function(){this.openAction.setStyles(this.css.actionNode_over)}.bind(this),mouseout:function(){this.openAction.setStyles(this.css.actionNode)}.bind(this),click:function(t){this.deployment.app.desktop.openApplication(t,this.data.path)}.bind(this)}))}},loadSystemFlag:function(){}}),MWF.xApplication.Setting.UIModuleDocument.UserComponent=new Class({Extends:MWF.xApplication.Setting.UIModuleDocument.Component,createOpenAction:function(t){this.openAction=new Element("div",{styles:this.css[t],text:this.deployment.lp.open}).inject(this.actionAreaNode),this.openAction.addEvents({mouseover:function(){this.openAction.setStyles(this.css.actionNode_over)}.bind(this),mouseout:function(){this.openAction.setStyles(this.css[t])}.bind(this),click:function(t){this.deployment.app.desktop.openApplication(t,this.data.path)}.bind(this)})},createEditAction:function(t){this.editAction=new Element("div",{styles:this.css[t],text:this.deployment.lp.edit}).inject(this.actionAreaNode),this.editAction.addEvents({mouseover:function(){this.editAction.setStyles(this.css.actionNode_over)}.bind(this),mouseout:function(){this.editAction.setStyles(this.css[t])}.bind(this),click:function(t){this.editComponent()}.bind(this)})},createRemoveAction:function(t){this.removeAction=new Element("div",{styles:this.css[t],text:this.deployment.lp.remove}).inject(this.actionAreaNode),this.removeAction.addEvents({mouseover:function(){this.removeAction.setStyles(this.css.actionNode_over)}.bind(this),mouseout:function(){this.removeAction.setStyles(this.css[t])}.bind(this),click:function(t){var e=this,i=this.deployment.lp.removeComponent.replace(/{name}/,this.data.title);this.deployment.app.confirm("warn",t,this.deployment.lp.removeComponentTitle,i,500,170,(function(){e.removeComponent(),this.close()}),(function(){this.close()}),null,this.deployment.content)}.bind(this)})},addAction:function(){this.node.setStyles(this.css.userComponentItemNode);var t=layout.session.user,e=[t.name,t.distinguishedName,t.id,t.unique];t.roleList&&(e=e.concat(t.roleList)),t.groupList&&(e=e.concat(t.groupList));var i=this.checkAdministrator();if(i&&this.data.visible)this.createOpenAction("action2Node"),this.createEditAction("action2Node"),this.createRemoveAction("action3Node");else if(!i&&this.data.visible){var n=!this.data.allowList.length||this.data.allowList.isIntersect(e);(!(!!this.data.denyList.length&&this.data.denyList.isIntersect(e))&&n||MWF.AC.isAdministrator())&&this.createOpenAction("actionNode")}else i&&!this.data.visible&&(this.createEditAction("action4Node"),this.createRemoveAction("action5Node"))},checkAdministrator:function(){if(MWF.AC.isAdministrator())return!0;var t=this.deployment.desktop.session.user,e=[t.name,t.distinguishedName,t.id,t.unique];return t.roleList&&(e=e.concat(t.roleList)),t.groupList&&(e=e.concat(t.groupList)),!!this.data.controllerList.isIntersect(e)},loadSystemFlag:function(){},editComponent:function(){new MWF.xApplication.Setting.UIModuleDocument.DeployEdit(this.data,this,this.deployment)},removeComponent:function(){this.deployment.actions.removeComponent(this.data.id,function(){this.deployment.app.notice(this.deployment.lp.removeComponentOk,"success"),this.deployment.components.erase(this),this.node.destroy(),MWF.release(this)}.bind(this))}}),MWF.xApplication.Setting.UIModuleDocument.Deploy=new Class({initialize:function(t){this.deployment=t,this.css=this.deployment.css,this.tab=this.deployment.tab,this.lp=this.deployment.lp,this.load(this.lp.add)},createLine:function(t){var e=new Element("div",{styles:this.css.deployLineNode}).inject(this.content),i=(new Element("div",{styles:this.css.deployTitleNode,text:t}).inject(e),new Element("div",{styles:this.css.deployvalueNode}).inject(e));return new Element("input",{styles:this.css.deployInputNode,type:"text"}).inject(i)},createLineSelect:function(t,e){var i=new Element("div",{styles:this.css.deployLineNode}).inject(this.content),n=(new Element("div",{styles:this.css.deployTitleNode,text:t}).inject(i),new Element("div",{styles:this.css.deployvalueNode}).inject(i)),s=new Element("select").inject(n);return new Element("option",{text:this.lp.yes,value:"yes"}).inject(s),new Element("option",{text:this.lp.no,value:"no",checked:"no"==e}).inject(s),s},load:function(t){this.node=new Element("div",{styles:this.css.newDeployNode}),this.content=new Element("div",{styles:this.css.deployContentNode}).inject(this.node),this.nameInputNode=this.createLine(this.lp.name),this.titleInputNode=this.createLine(this.lp.componentTitle),this.pathInputNode=this.createLine(this.lp.path),new Element("div",{text:this.lp.urlInfor,styles:this.css.deployLineNode}).inject(this.content),this.iconNode=new MWF.xApplication.Setting.UIModuleDocument.Deploy.Icon(this.deployment,this.content,this.lp.icon,this),this.pathInputNode.addEvent("change",function(){this.iconNode&&this.iconNode.checkIcon()}.bind(this)),this.visibleInputNode=this.createLineSelect(this.lp.isVisible),this.allowList=new MWF.xApplication.Setting.UIModuleDocument.Deploy.Select(this.deployment,this.content,this.lp.allowList),this.denyList=new MWF.xApplication.Setting.UIModuleDocument.Deploy.Select(this.deployment,this.content,this.lp.denyList),this.okAction=new Element("div",{styles:this.css.deployOkAction,text:this.lp.add}).inject(this.content),this.okAction.addEvent("click",function(){var t=this.getComponentData();if(!(t.name&&t.title&&t.path))return this.deployment.app.notice(this.lp.noInputInfor,"error"),!1;this.deployment.actions.createComponent(t,function(){this.deployment.app.notice(this.lp.deploySuccess,"success"),this.page.closeTab(),this.deployment.appPage.showTabIm(),this.deployment.components.push(new MWF.xApplication.Setting.UIModuleDocument.UserComponent(t,this.deployment,!0))}.bind(this))}.bind(this)),this.page=this.tab.addTab(this.node,t,!0),this.page.showTabIm()},getComponentData:function(){var t=this.visibleInputNode.options[this.visibleInputNode.selectedIndex].value,e=this.pathInputNode.get("value");return{name:this.nameInputNode.get("value"),title:this.titleInputNode.get("value"),path:e,visible:"yes"===t,iconPath:"@url"===e.substring(0,4)?"../x_component_Setting/$Main/default/icon/site.png":"appicon.png",widgetName:"",widgetTitle:"",widgetIconPath:"",widgetStart:!1,widgetVisible:!1,allowList:this.allowList.list,denyList:this.denyList.list,controllerList:[]}}}),MWF.xApplication.Setting.UIModuleDocument.DeployEdit=new Class({Extends:MWF.xApplication.Setting.UIModuleDocument.Deploy,initialize:function(t,e,i){this.deployment=i,this.component=e,this.css=this.deployment.css,this.tab=this.deployment.tab,this.lp=this.deployment.lp,this.data=t,this.load(this.lp.modify),this.setValues()},setValues:function(){this.nameInputNode.set("value",this.data.name),this.titleInputNode.set("value",this.data.title),this.pathInputNode.set("value",this.data.path),this.data.visible?this.visibleInputNode.getFirst("option").set("selected",!0):this.visibleInputNode.getLast("option").set("selected",!0),this.allowList.setList(this.data.allowList),this.denyList.setList(this.data.denyList),this.okAction.set("text",this.lp.modify),this.okAction.removeEvents("click"),this.okAction.addEvent("click",function(){var t=this.getComponentData();if(t.iconPath=this.data.iconPath,!(t.name&&t.title&&t.path))return this.deployment.app.notice(this.lp.noInputInfor,"error"),!1;this.deployment.actions.updateComponent(this.data.id,t,function(){this.deployment.app.notice(this.lp.modifySuccess,"success"),this.page.closeTab(),this.deployment.appPage.showTabIm(),t.id=this.data.id,this.component.reload(t)}.bind(this))}.bind(this))}}),MWF.xApplication.Setting.UIModuleDocument.Deploy.Select=new Class({initialize:function(t,e,i){this.deployment=t,this.css=this.deployment.css,this.list=[];var n=new Element("div",{styles:this.css.deployLineNode}).inject(e);n.setStyle("height","40px");new Element("div",{styles:this.css.deployTitleNode,text:i}).inject(n);var s=new Element("div",{styles:this.css.deployvalueNode}).inject(n);this.listNode=new Element("div",{styles:{float:"left"}}).inject(s);var o=new Element("div",{styles:this.css.actionNode,text:this.deployment.lp.selPerson}).inject(s);o.setStyles({"margin-top":"10px",float:"left"}),o.addEvent("click",function(){var t={type:"",types:["person","group","role"],values:this.list,count:0,onComplete:function(t){this.list=[],t.each(function(t){this.list.push(t.data.distinguishedName)}.bind(this)),this.listNode.empty(),this.list.each(function(t){if(t)switch(t.substr(t.length-1,1)){case"G":new MWF.widget.O2Group({name:t},this.listNode,{style:"application"});break;case"R":new MWF.widget.O2Role({name:t},this.listNode,{style:"application"});break;default:new MWF.widget.O2Person({name:t},this.listNode,{style:"application"})}}.bind(this))}.bind(this)};new MWF.O2Selector(this.deployment.app.content,t)}.bind(this))},setList:function(t){this.list=t,this.list.each(function(t){t&&o2.widget.O2Org(t,this.listNode,{style:"application"})}.bind(this))}}),MWF.xApplication.Setting.UIModuleDocument.Deploy.Icon=new Class({initialize:function(t,e,i,n){this.deployment=t,this.css=this.deployment.css,this.deploy=n,this.list=[];var s=new Element("div",{styles:this.css.deployLineNode}).inject(e);s.setStyle("height","64px");new Element("div",{styles:this.css.deployTitleNode,text:i}).inject(s);var o=new Element("div",{styles:this.css.deployvalueNode}).inject(s);this.iconNode=new Element("div",{styles:this.css.deployIconNode}).inject(o),this.actionNode=new Element("div",{styles:this.css.actionNode,text:this.deployment.lp.selIcon}).inject(o),this.actionNode.setStyles({"margin-top":"10px",float:"left"}),this.actionNode.addEvent("click",function(){this.uploadFileAreaNode||this.createUploadFileAreaNode(),this.fileUploadNode.set("multiple",!1);var t=this.uploadFileAreaNode.getFirst();t.set("accept",".png,.jpg,.bmp,.gif,.jpeg,.jpe"),t.click()}.bind(this)),this.checkIcon()},createUploadFileAreaNode:function(){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file" accept="images/*" />'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var t=this.fileUploadNode.files;if(t.length){t.length;for(var e=0;e<t.length;e++){var i=t.item(e),n=new FormData;n.append("file",i),MWF.xDesktop.uploadImage("component","component",n,i,function(t){var e=t.id;this.deploy.data.iconPath=MWF.xDesktop.getImageSrc(e),this.checkIcon()}.bind(this))}}}.bind(this))},checkIcon:function(){var t=this.deploy.pathInputNode.get("value")||(this.deploy.data?this.deploy.data.path:"");if("@url"===t.substring(0,4))this.deploy.data&&this.deploy.data.iconPath?this.iconNode.setStyle("background","url("+this.deploy.data.iconPath+") no-repeat center center"):this.iconNode.setStyle("background","url(../x_component_Setting/$Main/default/icon/site.png) no-repeat center center"),this.actionNode&&this.actionNode.show();else{if(t){var e=t.replace(".","_");this.iconNode.setStyle("background","url(../x_component_"+e+"/$Main/appicon.png) no-repeat center center")}this.actionNode&&this.actionNode.hide()}}});