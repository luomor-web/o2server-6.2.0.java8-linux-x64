MWF.xApplication.Selector=MWF.xApplication.Selector||{},MWF.xDesktop.requireApp("Selector","Identity",null,!1),MWF.xApplication.Selector.Unit=new Class({Extends:MWF.xApplication.Selector.Identity,options:{style:"default",count:0,units:[],values:[],zIndex:1e3,expand:!0,exclude:[],expandSubEnable:!0,selectAllEnable:!0,selectType:"unit"},setInitTitle:function(){this.setOptions({title:MWF.xApplication.Selector.LP.selectUnit})},_init:function(){this.selectType="unit",this.className="Unit"},loadSelectItems:function(t){if(this.options.disabled)this.afterLoadSelectItem();else{var e=this.afterLoadSelectItem.bind(this);if(this.options.units.length){for(var s=[],i=0;i<this.options.units.length;i++){var l=this.options.units[i];"string"===typeOf(l)?s.push(l):"object"===typeOf(l)&&s.push(l.id||l.distinguishedName||l.unique||l.levelName)}o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:s},function(t){t.data.length&&t.data.each(function(t){if(this.options.expandSubEnable){if(t.subDirectUnitCount){var e=this._newItemCategory("ItemCategory",t,this,this.itemAreaNode);this.subCategorys.push(e)}}else{var s=this._newItem(t,this,this.itemAreaNode);this.items.push(s),this.subItems.push(s)}}.bind(this)),e()}.bind(this),e)}else this.orgAction.listTopUnit(function(t){t.data.each(function(t){if(!this.isExcluded(t)){var e=this._newItem(t,this,this.itemAreaNode,1);this.items.push(e),this.subItems.push(e)}}.bind(this)),e()}.bind(this))}},_scrollEvent:function(t){return!0},_getChildrenItemIds:function(){return null},_newItemCategory:function(t,e,s,i,l,o,n){return new MWF.xApplication.Selector.Unit[t](e,s,i,l,o,n)},_listItemByKey:function(t,e,s){if(this.options.expandSubEnable){if(this.options.units.length){var i=[];this.options.units.each((function(t){"string"===typeOf(t)&&i.push(t),"object"===typeOf(t)&&i.push(t.distinguishedName)})),s={key:s,unitList:i}}this.orgAction.listUnitByKey(function(e){t&&t.apply(this,[e])}.bind(this),e,s)}else s?(this.initSearchArea(!0),this.searchInItems(s)):this.initSearchArea(!1)},_getItem:function(t,e,s,i){this.orgAction.getUnit(function(e){t&&t.apply(this,[e])}.bind(this),e,"string"===typeOf(s)?s:s.distinguishedName,i)},_newItemSelected:function(t,e,s,i){return new MWF.xApplication.Selector.Unit.ItemSelected(t,e,s,i)},_listItemByPinyin:function(t,e,s){if(this.options.units.length){var i=[];this.options.units.each((function(t){"string"===typeOf(t)&&i.push(t),"object"===typeOf(t)&&i.push(t.distinguishedName)})),s={key:s,unitList:i}}this.orgAction.listUnitByPinyininitial(function(e){t&&t.apply(this,[e])}.bind(this),e,s)},_newItem:function(t,e,s,i,l,o){return new MWF.xApplication.Selector.Unit.Item(t,e,s,i,l,o)},_newItemSearch:function(t,e,s,i){return new MWF.xApplication.Selector.Unit.SearchItem(t,e,s,i)}}),MWF.xApplication.Selector.Unit.Item=new Class({Extends:MWF.xApplication.Selector.Identity.Item,load:function(){this.selector.isFlatCategory?!this.justItem&&this.selector.options.expandSubEnable&&this.data.subDirectUnitCount?this.loadCategoryForFlatCategory():this.ignoreItem||this.loadForNormal(!0):this.loadForNormal()},loadForNormal:function(t,e){this.selector.fireEvent("queryLoadItem",[this]),this.node||(this.node=new Element("div",{styles:this.selector.css.selectorItem}).inject(e||this.container)),this.levelNode=new Element("div",{styles:this.selector.css.selectorItemLevelNode}).inject(this.node);var s=this.selector.options.level1Indent+(this.level-1)*this.selector.options.indent;this.levelNode.setStyle("width",s+"px"),this.iconNode=new Element("div",{styles:this.selector.css.selectorItemIconNode}).inject(this.node),this._setIcon(),this.actionNode=new Element("div",{styles:this.selector.css.selectorItemActionNode}).inject(this.node),(1===this.selector.options.count.toInt()||this.selector.options.noSelectedContainer)&&this.selector.css.selectorItemActionNode_single&&this.actionNode.setStyles(this.selector.css.selectorItemActionNode_single),this.textNode=new Element("div",{styles:this.selector.css.selectorItemTextNode,text:this._getShowName(),title:this._getTtiteText()}).inject(this.node),this.textNode.store("indent",s);var i=this.textNode.getStyle("margin-left").toFloat()+s;this.textNode.setStyle("margin-left",i+"px"),this.postLoad&&this.postLoad(),t||this.loadSubItem(),this.setEvent(),this.check(),this.afterLoad&&this.afterLoad(),this.selector.fireEvent("postLoadItem",[this])},_getShowName:function(){return this.isShowLevelName&&this.data.levelName?this.data.levelName:this.data.name},_getTtiteText:function(){return this.data.levelName||this.data.name},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/departmenticon.png)")},loadSubItem:function(){(this.selector.options.expandSubEnable||this.selector.options.forceShowSubEnable)&&(this.isExpand=this.selector.options.expand,(this._hasChild()||this.selector.options.expandEmptyCategory)&&(this.selector.options.expand?"number"===typeOf(this.selector.options.defaultExpandLevel)?this.level<=this.selector.options.defaultExpandLevel&&this._hasChild()?(this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_expand),this.loadSubItems()):(this.isExpand=!1,this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_collapse)):1===this.level&&this._hasChild()?(this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_expand),this.loadSubItems()):(this.isExpand=!1,this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_collapse)):this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_collapse),this.levelNode.addEvent("click",function(t){this.isExpand?(this.selector.fireEvent("collapse",[this]),this.children.setStyle("display","none"),this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_collapse),this.isExpand=!1):(this.selector.fireEvent("expand",[this]),this.loadSubItems(),this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_expand),this.isExpand=!0),t.stopPropagation()}.bind(this)),this.selector.css.selectorItemLevelNode_expand_over&&this.selector.css.selectorItemLevelNode_collapse_over&&this.levelNode.addEvents({mouseover:function(t){var e=this.isExpand?this.selector.css.selectorItemLevelNode_expand_over:this.selector.css.selectorItemLevelNode_collapse_over;this.levelNode.setStyles(e)}.bind(this),mouseout:function(t){var e=this.isExpand?this.selector.css.selectorItemLevelNode_expand:this.selector.css.selectorItemLevelNode_collapse;this.levelNode.setStyles(e)}.bind(this)}),this.selectAllNode||1===this.selector.options.count.toInt()||"blue_flat"===this.selector.options.style||"blue_flat_mobile"===this.selector.options.style||(this.selectAllNode=new Element("div",{styles:this.selector.css.selectorItemCategoryActionNode_selectAll,title:MWF.SelectorLP.selectChildren}).inject(this.textNode,"before"),this.selectAllNode.addEvent("click",function(t){if(this.isSelectedAll)"all"===this.selector.options.selectAllRange?this.unselectAllNested(t,null,!0):this.unselectAll(t,null,!0),this.selector.fireEvent("unselectCatgory",[this]),this.selector.fireEvent("unselectCategory",[this]);else{if("all"===this.selector.options.selectAllRange){var e=new Element("div.categorySelectedNode").inject(this.selector.selectedNode);this.selectAllNested(t,!0,e)}else this.selectAll(t,!0);this.selector.fireEvent("selectCatgory",[this]),this.selector.fireEvent("selectCategory",[this])}t.stopPropagation()}.bind(this)),this.selector.css.selectorItemCategoryActionNode_selectAll_over&&this.selectAllNode.addEvents({mouseover:function(t){this.isSelectedAll||this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll_over)}.bind(this),mouseout:function(t){this.isSelectedAll||this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll)}.bind(this)}))))},unselectAll:function(t,e,s){var i=e||[];e&&"array"!==typeOf(e)&&(i=[e]),(this.subItems||[]).each(function(t){t.isSelected&&!i.contains(t)&&t.unSelected(s)}.bind(this)),this.selectAllNode&&(this.selector.isFlatCategory?this.selectAllNode.setStyles(this.selector.css.flatCategory_selectAll):this.selector.css.selectorItemCategoryActionNode_selectAll&&this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll)),this.isSelectedAll=!1},unselectAllNested:function(t,e,s){this.unselectAll(t,e,s),this.subCategorys&&this.subCategorys.length&&this.subCategorys.each((function(i){i.unselectAllNested&&i.unselectAllNested(t,e,s)})),this.subItems&&this.subItems.length&&this.subItems.each((function(i){i.unselectAllNested&&i.unselectAllNested(t,e,s)}))},selectAllNested:function(t,e,s){var i;s&&(i=new Element("div.categorySelectedNode").inject(s)),this.selectAll(t,e,i,function(){this.subCategorys&&this.subCategorys.length&&this.subCategorys.each((function(i){if(s)var l=new Element("div.categorySelectedNode").inject(s);i.selectAllNested&&i.selectAllNested(t,e,l)})),this.subItems&&this.subItems.length&&this.subItems.each((function(i){if(s)var l=new Element("div.categorySelectedNode").inject(s);i.selectAllNested&&i.selectAllNested(t,e,l)}))}.bind(this))},selectAll:function(t,e,s,i){this.loaded||this.selector.isFlatCategory?(this._selectAll(t,e,s),i&&i()):(this.loadSubItems(function(){this._selectAll(t,e,s),i&&i()}.bind(this)),this.levelNode.setStyles(this.selector.css.selectorItemLevelNode_expand),this.isExpand=!0)},_selectAll:function(t,e,s){if(this.subItems&&this.subItems.length){var i=this.selector.options.maxCount||this.selector.options.count;i||(i=0);var l=0;if(this.subItems.each(function(t){t.isSelected&&l++}.bind(this)),0===i.toInt()||this.selector.selectedItems.length+(this.subItems.length-l)<=i){var o=function(){var t=0;this.subItems.each(function(i){i.isSelected||i.disabled||i.selected(!1,function(){t++,this.subItems.length===t&&e&&this.selector.fireEvent("valid",[this.selector,this])}.bind(this),s)}.bind(this)),this.selectAllNode&&(this.selector.isFlatCategory?this.selectAllNode.setStyles(this.selector.css.flatCategory_selectAll_selected):this.selector.css.selectorItemCategoryActionNode_selectAll_selected&&this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll_selected)),this.isSelectedAll=!0}.bind(this);this._beforeSelectAll?this._beforeSelectAll(o):o()}else MWF.xDesktop.notice("error",{x:"right",y:"top"},MWF.SelectorLP.selectItemMaxText.replace("{count}",i),this.node)}},checkSelectAll:function(){if(!this.isSelectedAll&&this.selectAllNode&&this.subItems){for(var t=!0,e=0;e<this.subItems.length;e++)if(!this.subItems[e].isSelected){t=!1;break}t&&(this.selector.isFlatCategory?this.selectAllNode.setStyles(this.selector.css.flatCategory_selectAll_selected):this.selector.css.selectorItemCategoryActionNode_selectAll_selected&&this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll_selected),this.isSelectedAll=!0)}},checkUnselectAll:function(){if(this.isSelectedAll&&this.selectAllNode&&this.subItems){for(var t=!1,e=0;e<this.subItems.length;e++)if(this.subItems[e].isSelected){t=!0;break}t||(this.selector.isFlatCategory?this.selectAllNode.setStyles(this.selector.css.flatCategory_selectAll):this.selector.css.selectorItemCategoryActionNode_selectAll&&this.selectAllNode.setStyles(this.selector.css.selectorItemCategoryActionNode_selectAll),this.isSelectedAll=!1)}},loadSubItems:function(t){this.loaded||this.loading?this.children.setStyle("display","block"):(this.loading=!0,this.children||(this.children=new Element("div",{styles:this.selector.css.selectorItemCategoryChildrenNode}).inject(this.node,"after")),this.children.setStyle("display","block"),this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this);this.selector.items.push(e),this.subItems||(this.subItems=[]),this.subItems.push(e)}}.bind(this)),this.loaded=!0,this.loading=!1,t&&t()}.bind(this),null,this.data.distinguishedName))},getData:function(t){t&&t()},postLoad:function(){if("blue_flat"===this.selector.options.style)if(1===this.level){var t=26;this.levelNode.setStyle("width",t+"px")}else{t=26+(this.level-1)*this.selector.options.indent;this.levelNode.setStyle("width",t+"px")}},loadCategoryForFlatCategory:function(){if(this.selector.fireEvent("queryLoadCategory",[this]),this.flatCategoryItemNode||(this.flatCategoryItemNode=new Element("div.flatCategoryItemNode",{styles:this.selector.css.flatCategoryItemNode,title:this._getTtiteText()}),this.flatCategoryItemNode.store("category",this),this.flatCategoryItemNode.store("dn",this.data.distinguishedName),this.flatCategoryItemTextNode=new Element("div",{styles:this.selector.css.flatCategoryItemTextNode,text:this._getShowName(),title:this._getTtiteText()}).inject(this.flatCategoryItemNode)),this.children=new Element("div",{styles:this.selector.css.selectorItemCategoryChildrenNode}).inject(this.selector.itemAreaNode),this.children.setStyle("display","none"),1===this.level&&this.loadForNormal(!0,this.children),!this.selectAllNode&&1!==this.selector.options.count.toInt()){var t=new Element("div",{styles:this.selector.css.flatCategory_selectAllWrap}).inject(this.children);this.selectAllNode=new Element("div",{styles:this.selector.css.flatCategory_selectAll,text:MWF.SelectorLP.selectAll}).inject(t),this.selectAllNode.addEvent("click",function(t){this.isSelectedAll?(this.unselectAll(t),this.selector.fireEvent("unselectCatgory",[this]),this.selector.fireEvent("unselectCategory",[this])):(this.selectAll(t),this.selector.fireEvent("selectCatgory",[this]),this.selector.fireEvent("selectCategory",[this])),t.stopPropagation()}.bind(this))}this.flatCategoryItemNode.addEvents({click:function(){this.selector.currentFlatCategory!==this&&(this.selector.currentFlatCategory&&this.selector.currentFlatCategory.clickFlatCategoryItem(null,!0),this.selector.currentFlatCategory=this,this.clickFlatCategoryItem())}.bind(this)});var e,s=!this.data.subDirectUnitCount||this.data.subDirectUnitCount;e=this.nodeContainer?this.nodeContainer:this.category&&this.category.subCategoryListNode?this.category.subCategoryListNode:null,this.subCategoryListNode=this.selector.addFlatCategoryItem(this.flatCategoryItemNode,this.data.subDirectUnitCount,e,s),this.loadCategoryChildren&&this.loadCategoryChildren(),this.selector.fireEvent("postLoadCategory",[this])},clickFlatCategoryItem:function(t,e){var s=!this.itemLoaded;this.loadItemChildren(function(){if(e)this.children.setStyles({display:"none"}),this.flatCategoryItemNode.setStyles(this.selector.css.flatCategoryItemNode),this.isExpand=!1;else if(s)this.children.setStyles({display:"block"}),this.flatCategoryItemNode.setStyles(this.selector.css.flatCategoryItemNode_selected),this.isExpand=!0;else{"none"===this.children.getStyle("display")?(this.children.setStyles({display:"block"}),this.flatCategoryItemNode.setStyles(this.selector.css.flatCategoryItemNode_selected),this.isExpand=!0):(this.children.setStyles({display:"none"}),this.flatCategoryItemNode.setStyles(this.selector.css.flatCategoryItemNode),this.isExpand=!1)}t&&t()}.bind(this))},loadCategoryChildren:function(t){this.categoryLoaded?t&&t():this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)&&t.subDirectUnitCount)this.selector._newItem(t,this.selector,this.children,this.level+1,this)}.bind(this)),this.categoryLoaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName)},loadItemChildren:function(t){this.itemLoaded?t&&t():this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this,!0);e.justItem=!0,e.load(),this.selector.items.push(e),this.subItems||(this.subItems=[]),this.subItems.push(e)}}.bind(this)),this.itemLoaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName)},_hasChild:function(){return this.data.subDirectUnitCount}}),MWF.xApplication.Selector.Unit.SearchItem=new Class({Extends:MWF.xApplication.Selector.Unit.Item,load:function(){this.loadForNormal()},_getShowName:function(){return this.data.levelName||this.data.name},loadSubItems:function(t){this.loaded||this.loading?this.children.setStyle("display","block"):(this.loading=!0,this.children||(this.children=new Element("div",{styles:this.selector.css.selectorItemCategoryChildrenNode}).inject(this.node,"after")),this.children.setStyle("display","block"),this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){var e;this.selector.isExcluded(t)||(this.selector.isFlatCategory?((e=this.selector._newItem(t,this.selector,this.children,this.level+1,this,!0)).isShowLevelName=!0,e.load()):e=this.selector._newItem(t,this.selector,this.children,this.level+1,this),this.selector.items.push(e),this.subItems||(this.subItems=[]),this.subItems.push(e))}.bind(this)),this.loaded=!0,this.loading=!1,t&&t()}.bind(this),null,this.data.distinguishedName))}}),MWF.xApplication.Selector.Unit.ItemSelected=new Class({Extends:MWF.xApplication.Selector.Identity.ItemSelected,getData:function(t){t&&t()},_getTtiteText:function(){return this.data.levelName||this.data.name},_getShowName:function(){return this.data.name+(this.data.levelName?"("+this.data.levelName+")":"")},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/departmenticon.png)")}}),MWF.xApplication.Selector.Unit.ItemCategory=new Class({Extends:MWF.xApplication.Selector.Identity.ItemCategory,loadSub:function(t){this.loaded?t&&t():this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this);e.isItem=!0,e.isCategory=!0,this.selector.items.push(e),this.subItems&&this.subItems.push(e),this.subCategorys.push(e)}}.bind(this)),this.loaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName)},_hasChild:function(){return this.data.subDirectUnitCount?this.data.subDirectUnitCount:0},_hasChildCategory:function(){return this.data.subDirectUnitCount?this.data.subDirectUnitCount:0},_hasChildItem:function(){return this.data.subDirectUnitCount?this.data.subDirectUnitCount:0},loadCategoryChildren:function(t){this.categoryLoaded?t&&t():this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this,!0);e.ignoreItem=!0,e.load(),this.subCategorys.push(e)}}.bind(this)),this.categoryLoaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName)},loadItemChildren:function(t){this.itemLoaded?t&&t():this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this,!0);e.justItem=!0,e.load(),this.selector.items.push(e),this.subItems&&this.subItems.push(e)}}.bind(this)),this.itemLoaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName)}}),MWF.xApplication.Selector.Unit.Filter=new Class({Implements:[Options,Events],options:{style:"default",units:[]},initialize:function(t,e){this.setOptions(e),this.value=t,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},filter:function(t,e){this.value=t;var s=this.value;if(this.options.units.length){var i=[];this.options.units.each((function(t){"string"===typeOf(t)&&i.push(t),"object"===typeOf(t)&&i.push(t.distinguishedName)})),s={key:s,unitList:i}}this.orgAction.listUnitByKey(function(t){data=t.data,e&&e(data)}.bind(this),null,s)}});