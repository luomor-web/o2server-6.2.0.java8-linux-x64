MWF.xApplication.Search.options.multitask=!1,MWF.xApplication.Search.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style1:"default",style:"default",name:"Search",icon:"icon.png",width:"1200",height:"700",isResize:!0,isMax:!0,pageCount:15,key:"",title:MWF.xApplication.Search.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Search.LP,this.status&&this.status.key&&(this.options.key=this.status.key)},initPage:function(){this.pageCount=this.options.pageCount,this.pages=1,this.currentPage=1},recordStatus:function(){return this.input?{key:this.input.getValue()}:{}},loadApplication:function(t){this.result=[],this.items=[],this.initPage(),this.createLayout(),t&&t()},createLayout:function(){this.searchArea=new Element("div",{styles:this.css.searchArea}).inject(this.content),this.resultArea=new Element("div",{styles:this.css.resultArea}).inject(this.content),this.setSearchAreaSize(),this.setSearchAreaSizeFun=this.setSearchAreaSize.bind(this),this.addEvent("resize",this.setSearchAreaSizeFun),this.createResultInfor(),this.createResultContent(),this.createResultPageArea(),this.createSearchBar()},setSearchAreaSize:function(){var t=this.searchArea.getSize(),e=this.content.getSize().y-t.y;this.resultArea.setStyle("height",e+"px")},createSearchBar:function(){this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.searchArea),this.logoNode=new Element("div",{styles:this.css.logoNode}).inject(this.searchBarNode),this.searchInputActionArea=new Element("div",{styles:this.css.searchInputActionArea}).inject(this.searchBarNode),MWF.require("MWF.widget.SearchInput",function(){this.input=new MWF.widget.SearchInput({onSearch:function(t){this.search(t)}.bind(this)}),this.input.inject(this.searchInputActionArea),this.options.key&&(this.input.setValue(this.options.key),this.input.doSearch())}.bind(this))},createResultInfor:function(){this.resultInfor=new Element("div",{styles:this.css.resultInfor,text:this.lp.infor}).inject(this.resultArea)},createResultContent:function(){this.resultContent=new Element("div",{styles:this.css.resultContent}).inject(this.resultArea)},createResultPageArea:function(){this.resultPageArea=new Element("div",{styles:this.css.resultPageArea}).inject(this.resultArea)},search:function(t){var e=new Date;MWF.Actions.get("x_query_assemble_surface").search(t,function(t){var s=(new Date).getTime()-e.getTime();s=(s/1e3*100).toInt()/100;var i=this.lp.searchInfor;i=(i=i.replace("{count}",t.data.count||0)).replace("{time}",s),this.resultInfor.set("text",i),this.resultInfor.setStyles(this.css.searchResultInfor),this.resultPageArea.empty(),this.resultContent.empty(),this.result=t.data.valueList,t.data.count&&(this.createPages(),this.showResult())}.bind(this))},createPages:function(){if(this.initPage(),this.resultPageArea.empty(),this.result.length){var t=this.result.length/this.pageCount;this.pages=t>t.toInt()?t.toInt()+1:t.toInt(),this.currentPage=1;for(var e=this,s=1;s<=this.pages;s++){new Element("div",{styles:this.css.pageItem,text:s}).inject(this.resultPageArea).addEvent("click",(function(){e.resultPageArea.getElement(":nth-child("+e.currentPage+")").setStyles(e.css.pageItem),e.gotoPage(this.get("text"))}))}}},gotoPage:function(t){this.currentPage=t,this.showResult(),this.resultArea.scrollTop=0},showResult:function(){var t=(this.currentPage-1)*this.pageCount,e=this.currentPage*this.pageCount-1;this.resultPageArea.getElement(":nth-child("+this.currentPage+")").setStyles(this.css.pageItem_current),this.resultContent.empty();var s=Math.min(this.result.length-1,e),i=this.result.slice(t,s+1);MWF.Actions.get("x_query_assemble_surface").listSearchEntry({entryList:i},function(t){t.data.each(function(t){new MWF.xApplication.Search.ResaultItem(this,t)}.bind(this))}.bind(this))}}),MWF.xApplication.Search.ResaultItem=new Class({initialize:function(t,e){this.app=t,this.content=this.app.resultContent,this.lp=this.app.lp,this.css=this.app.css,this.data=e,this.checkPermission(function(){this.load()}.bind(this))},checkPermission:function(t){this.data.permission?t&&t():("work"===this.data.type&&MWF.Actions.get("x_processplatform_assemble_surface").getWorkControl(this.data.reference,function(){this.data.permission="y",t&&t()}.bind(this),function(){this.data.permission="n",t&&t()}.bind(this)),"workCompleted"===this.data.type&&MWF.Actions.get("x_processplatform_assemble_surface").getWorkControl(this.data.reference,function(){this.data.permission="y",t&&t()}.bind(this),function(){this.data.permission="n",t&&t()}.bind(this)),"cms"===this.data.type&&MWF.Actions.get("x_cms_assemble_control").getDocumentControl(this.data.reference,function(e){e.data.control.allowVisit?this.data.permission="y":this.data.permission="n",t&&t()}.bind(this),function(){this.data.permission="n",t&&t()}.bind(this)))},load:function(){this.node=new Element("div",{styles:this.css.resaultItemNode}).inject(this.content),this.titleNode=new Element("div",{styles:this.css.resaultItemTitleNode}).inject(this.node),this.summaryNode=new Element("div",{styles:this.css.resaultItemSummaryNode}).inject(this.node),this.inforNode=new Element("div",{styles:this.css.resaultItemInforNode}).inject(this.node),this.loadTitle(),this.loadSummary(),this.loadInfor()},loadTitle:function(){"n"===this.data.permission?(this.titleNode.setStyles(this.css.resaultItemTitleNode_gray),this.titleNode.set("text",this.data.title?this.data.title+" ("+this.lp.refuse+")":this.lp.nonamed+" ("+this.lp.refuse+")")):(this.titleNode.set("text",this.data.title||this.lp.nonamed),this.titleNode.addEvents({mouseover:function(){this.setStyle("text-decoration","underline")},mouseout:function(){this.setStyle("text-decoration","none")},click:function(t){this.openItem(t)}.bind(this)}))},openItem:function(t){"work"===this.data.type&&layout.desktop.openApplication(t,"process.Work",{workId:this.data.reference,appId:this.data.reference,docTitle:this.data.title||this.lp.nonamed}),"workCompleted"===this.data.type&&layout.desktop.openApplication(t,"process.Work",{workCompletedId:this.data.reference,appId:this.data.reference,docTitle:this.data.title||this.lp.nonamed}),"cms"===this.data.type&&layout.desktop.openApplication(t,"cms.Document",{documentId:this.data.reference,appId:this.data.reference,docTitle:this.data.title||this.lp.nonamed})},loadSummary:function(){this.summaryNode.set("text",this.data.summary)},loadInfor:function(){var t="";this.data.applicationName&&(t+="<span style='color:#006d21'>"+this.lp.processApplication+"</span><span>"+this.data.applicationName+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.processName&&(t+="<span style='color:#006d21'>"+this.lp.process+"</span><span>"+this.data.processName+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.appName&&(t+="<span style='color:#006d21'>"+this.lp.cmsApplication+"</span><span>"+this.data.appName+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.categoryName&&(t+="<span style='color:#006d21'>"+this.lp.category+"</span><span>"+this.data.categoryName+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.creatorPerson&&(t+="<span style='color:#006d21'>"+this.lp.creatorPerson+"</span><span>"+MWF.name.cn(this.data.creatorPerson)+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.creatorUnit&&(t+="<span style='color:#006d21'>"+this.lp.unit+"</span><span>"+MWF.name.cn(this.data.creatorUnit)+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),"workCompleted"===this.data.type&&(t+="<span style='color: #f27b5f'>"+this.lp.completed+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.data.lastUpdateTime&&(t+="<span>"+this.data.lastUpdateTime+"</span><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"),this.inforNode.set("html",t)}});