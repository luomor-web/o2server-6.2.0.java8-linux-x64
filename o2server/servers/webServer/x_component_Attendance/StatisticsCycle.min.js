MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.Attendance.StatisticsCycle=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(t,e,i,s){this.setOptions(s),this.app=e,this.path="../x_component_Attendance/$StatisticsCycle/",this.cssPath="../x_component_Attendance/$StatisticsCycle/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.initData(),this.personActions||(this.personActions=new MWF.xAction.org.express.RestActions)},loadView:function(){this.view=new MWF.xApplication.Attendance.StatisticsCycle.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey),this.view.load(),this.setContentSize()},createDocument:function(){this.view&&this.view._createDocument()}}),MWF.xApplication.Attendance.StatisticsCycle.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(t){return new MWF.xApplication.Attendance.StatisticsCycle.Document(this.table,t,this.explorer,this)},_getCurrentPageData:function(t,e){this.actions.listCycle((function(e){t&&t(e)}))},_removeDocument:function(t,e){this.actions.deleteCycle(t.id,function(t){this.explorer.view.reload(),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createDocument:function(){new MWF.xApplication.Attendance.StatisticsCycle.Form(this.explorer).create()},_openDocument:function(t){new MWF.xApplication.Attendance.StatisticsCycle.Form(this.explorer,t).edit()}}),MWF.xApplication.Attendance.StatisticsCycle.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document}),MWF.xApplication.Attendance.StatisticsCycle.Form=new Class({Extends:MWF.xApplication.Attendance.Explorer.PopupForm,options:{width:600,height:600,hasTop:!0,hasBottom:!0,title:"",draggable:!0,closeAction:!0},_createTableContent:function(){var t=MWF.xApplication.Attendance.LP,e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td colspan='2' styles='formTableHead'>"+t.statisticsPeriodSetting+"</td></tr><tr><td styles='formTabelTitle' lable='topUnitName'></td>    <td styles='formTableValue'>       <div item='topUnitName'></div>       <div style='font-size: 12px;color: #999;'>"+t.selectCompanyNotice+"</div>   </td></tr><tr><td styles='formTabelTitle' lable='unitName'></td>    <td styles='formTableValue'>       <div item='unitName'></div>       <div style='font-size: 12px;color: #999;'>"+t.selectDepartmentNotice+"</div>   </td></tr><tr><td styles='formTabelTitle' lable='cycleYear'></td>    <td styles='formTableValue' item='cycleYear'></td></tr><tr><td styles='formTabelTitle' lable='cycleMonth'></td>    <td styles='formTableValue' item='cycleMonth'></td></tr><tr><td styles='formTabelTitle' lable='cycleStartDateString'></td>    <td styles='formTableValue' item='cycleStartDateString'></td></tr><tr><td styles='formTabelTitle' lable='cycleEndDateString'></td>    <td styles='formTableValue' item='cycleEndDateString'></td></tr><tr><td styles='formTabelTitle' lable='description'></td>    <td styles='formTableValue' item='description'></td></tr></table>";this.formTableArea.set("html",e),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{isEdited:this.isEdited||this.isNew,itemTemplate:{topUnitName:{text:t.statisticsCompany,type:"org",orgType:"unit"},unitName:{text:t.statisticsUnit,type:"org",orgType:"unit"},cycleYear:{text:t.cycleYear,type:"select",notEmpty:!0,defaultValue:(new Date).getFullYear(),selectValue:function(){for(var t=[],e=(new Date).getFullYear()+5,i=0;i<10;i++)t.push(e--);return t}},cycleMonth:{text:t.cycleMonth,type:"select",notEmpty:!0,selectValue:["01","02","03","04","05","06","07","08","09","10","11","12"]},cycleStartDateString:{text:t.startDate,tType:"date"},cycleEndDateString:{text:t.endData,tType:"date"},description:{text:t.description,type:"textarea"}}},this.app),this.form.load()}.bind(this),!0)},_ok:function(t,e){this.app.restActions.saveCycle(t,function(t){e&&e(t)}.bind(this))}}),MWF.xApplication.Attendance.StatisticsCycle.StatisticsCycle2=new Class({Extends:MWF.widget.Common,options:{width:"600",height:"600"},initialize:function(t,e){this.explorer=t,this.app=t.app,this.data=e||{},this.css=this.explorer.css,this.load()},load:function(){},open:function(t){this.isNew=!1,this.isEdited=!1},create:function(){this.isNew=!0,this._open()},edit:function(){this.isEdited=!0,this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content,"after"),this.createAreaNode=new Element("div",{styles:this.css.createAreaNode}),this.createNode(),this.createAreaNode.inject(this.createMarkNode,"after"),this.createAreaNode.fade("in"),this.setCreateNodeSize(),this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this),this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){var t=this,e=MWF.xApplication.Attendance.LP;this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode),this.createIconNode=new Element("div",{styles:this.isNew?this.css.createNewNode:this.css.createIconNode}).inject(this.createNode),this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createNode),this.createTableContainer=new Element("div",{styles:this.css.createTableContainer}).inject(this.createFormNode),this.createTableArea=new Element("div",{styles:this.css.createTableArea}).inject(this.createTableContainer);var i=new Element("table",{width:"100%",height:"250",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.createTableArea),s=this.data,n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableHead,colspan:"4",text:e.statisticsPeriodSetting}).inject(n);n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.topUnitName+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.isNew||this.isEdited?(this.topUnitName=new MDomItem(a,{name:"topUnitName",value:s.topUnitName,style:this.css.inputPersonStyle,event:{dblclick:function(e){t.selectPeople(this,"topUnit",e.get("value").split(","))}}},!0,this.app),this.topUnitName.load(),new Element("div",{text:e.selectCompanyNotice,styles:{color:"#ccc"}}).inject(a)):a.set("text",s.topUnitName);n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.unitName+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.isNew||this.isEdited?(this.unitName=new MDomItem(a,{name:"unitName",value:s.unitName,style:this.css.inputPersonStyle,event:{dblclick:function(e){t.selectPeople(this,"unit",e.get("value").split(","))}}},!0,this.app),this.unitName.load(),new Element("div",{text:e.selectDepartmentNotice,styles:{color:"#ccc"}}).inject(a)):a.set("text",s.unitName);n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.cycleYear+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.isNew||this.isEdited?(this.cycleYear=new MDomItem(a,{name:"cycleYear",type:"select",value:s.cycleYear||(new Date).getFullYear(),selectValue:function(){for(var t=[],e=(new Date).getFullYear()+5,i=0;i<10;i++)t.push(e--);return t}},!0,this.app),this.cycleYear.load()):a.set("text",s.cycleYear||"");n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.cycleMonth+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.isNew||this.isEdited?(this.cycleMonth=new MDomItem(a,{name:"cycleMonth",type:"select",value:s.cycleMonth,selectValue:["01","02","03","04","05","06","07","08","09","10","11","12"]},!0,this.app),this.cycleMonth.load()):a.set("text",s.cycleMonth||"");n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.startDate+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.cycleStartDateString=new MDomItem(a,{name:"cycleStartDateString",value:s.cycleStartDateString,style:this.css.inputTimeStyle,event:{click:function(e){var i=new Date(t.cycleYear.getValue()+"-"+t.cycleMonth.getValue()+"-01");t.selectDateTime(this,!1,!1,i.decrement("month",1))}}},!0,this.app),this.cycleStartDateString.load();n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.endData+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.cycleEndDateString=new MDomItem(a,{name:"cycleEndDateString",value:s.cycleEndDateString,style:this.css.inputTimeStyle,event:{click:function(e){var i=new Date(t.cycleYear.getValue()+"-"+t.cycleMonth.getValue()+"-01");t.selectDateTime(this,!1,!1,i)}}},!0,this.app),this.cycleEndDateString.load();n=new Element("tr").inject(i),a=new Element("td",{styles:this.css.editTableTitle,text:e.description+"："}).inject(n),a=new Element("td",{styles:this.css.editTableValue}).inject(n);this.description=new MDomItem(a,{type:"textarea",name:"description",value:s.description,style:this.css.inputTextAreaStyle},!0,this.app),this.description.load(),this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:e.cancel}).inject(this.createFormNode),this.cancelActionNode.addEvent("click",function(t){this.cancelCreate(t)}.bind(this)),(this.isNew||this.isEdited)&&(this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:e.ok}).inject(this.createFormNode),this.createOkActionNode.addEvent("click",function(t){this.okCreate(t)}.bind(this)))},setCreateNodeSize:function(t,e,i,s){t||(t=this.options&&this.options.width?this.options.width:"50%"),e||(e=this.options&&this.options.height?this.options.height:"50%"),i||(i=this.options&&this.options.top?this.options.top:0),s||(s=this.options&&this.options.left?this.options.left:0);var n=this.app.content.getSize(),a=n.x,c=n.y;"string"==typeof t&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(a*parseInt(t,10)/100,10)),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(c*parseInt(e,10)/100,10)),300>t&&(t=300),220>e&&(e=220),i=i||parseInt((c-e)/2,10),s=s||parseInt((a-t)/2,10),this.createAreaNode.setStyles({width:t+"px",height:e+"px",top:i+"px",left:s+"px"}),this.createNode.setStyles({width:t+"px",height:e+"px"});var l=this.createIconNode?this.createIconNode.getSize():{x:0,y:0},o=this.formTopNode?this.formTopNode.getSize():{x:0,y:0},r=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0},d=e-l.y-o.y-r.y;this.createFormNode.setStyles({height:d+"px"})},cancelCreate:function(t){this.createMarkNode.destroy(),this.createAreaNode.destroy()},okCreate:function(t){var e={topUnitName:""==this.topUnitName.get("value")?"*":this.topUnitName.get("value"),unitName:""==this.unitName.get("value")?"*":this.unitName.get("value"),cycleYear:this.cycleYear.get("value"),cycleMonth:this.cycleMonth.get("value"),cycleStartDateString:this.cycleStartDateString.get("value"),cycleEndDateString:this.cycleEndDateString.get("value"),description:this.description.get("value")};this.data.id&&(e.id=this.data.id),e.cycleStartDateString&&e.cycleEndDateString?this.app.restActions.saveCycle(e,function(t){"ERROR"==t.type?this.app.notice(t.message,"error"):(this.createMarkNode.destroy(),this.createAreaNode.destroy(),this.explorer.view&&this.explorer.view.reload(),this.app.notice(this.isNew?this.app.lp.createSuccess:this.app.lp.updateSuccess,"success"))}.bind(this)):this.app.notice(this.app.lp.selectStartEndEndDataNotice,"error")},selectDateTime:function(t,e,i,s){var n={style:"xform",timeOnly:e,isTime:i,target:this.app.content};s&&(n.baseDate=s),MWF.require("MWF.widget.Calendar",function(){new MWF.widget.Calendar(t,n).show()}.bind(this))},selectPeople:function(t,e,i){var s=MWF.xApplication.Attendance.LP,n={type:e,title:"unit"==e?s.selectDepartment:"topUnit"==e?s.selectCompany:s.selectPerson,count:"1",values:i||[],onComplete:function(e){var i=[];e.each(function(t){i.push(t.data.name)}.bind(this)),t.set("value",i.join(","))}.bind(this)};new MWF.O2Selector(this.app.content,n)}});