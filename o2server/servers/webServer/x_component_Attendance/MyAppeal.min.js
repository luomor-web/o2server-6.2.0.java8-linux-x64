MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xApplication.Attendance.MyAppeal=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(e,t,i,s){this.setOptions(s),this.app=t,this.path="../x_component_Attendance/$MyAppeal/",this.cssPath="../x_component_Attendance/$MyAppeal/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(e),this.initData(),this.personActions||(this.personActions=new MWF.xAction.org.express.RestActions)},load:function(){this.loadToolbar(),this.loadFilter(),this.loadContentNode();var e=((new Date).getMonth()+1).toString();1==e.length&&(e="0"+e);var t={status:"999",yearString:(new Date).getFullYear().toString(),monthString:e};this.loadView(t),this.setNodeScroll()},loadFilter:function(){var e=MWF.xApplication.Attendance.LP;this.fileterNode=new Element("div.fileterNode",{styles:this.css.fileterNode}).inject(this.node);this.fileterNode.set("html","<table bordr='0' cellpadding='5' cellspacing='0' style='font-size: 14px;color:#666'><tr>    <td styles='filterTableTitle' lable='yearString'></td>    <td styles='filterTableValue' item='yearString'></td>    <td styles='filterTableTitle' lable='monthString'></td>    <td styles='filterTableValue' item='monthString'></td>    <td styles='filterTableTitle' lable='status'></td>    <td styles='filterTableValue' item='status'></td>    <td styles='filterTableTitle' lable='appealReason'></td>    <td styles='filterTableValue' item='appealReason'></td>    <td styles='filterTableValue' item='action'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.fileterNode,{},{isEdited:!0,itemTemplate:{yearString:{text:e.annuaal,type:"select",selectValue:function(){for(var e=[],t=(new Date).getFullYear(),i=0;i<6;i++)e.push(t--);return e},event:{change:function(e,t){var i=this.getDateSelectValue();e.form.getItem("date").resetItemOptions(i,i)}.bind(this)}},monthString:{text:e.months,type:"select",defaultValue:function(){var e=((new Date).getMonth()+1).toString();return 1==e.length?"0"+e:e},selectValue:["","01","02","03","04","05","06","07","08","09","10","11","12"],event:{change:function(e,t){var i=this.getDateSelectValue();e.form.getItem("date").resetItemOptions(i,i)}.bind(this)}},status:{text:e.auditStatus,type:"select",value:"999",selectText:e.auditStatusSelectText,selectValue:["999","0","1","-1"]},appealReason:{text:e.appealReason,type:"select",selectText:e.appealReasonSelectText},action:{value:e.search,type:"button",className:"filterButton",event:{click:function(){var e=this.form.getResult(!0,",",!0,!0,!1);e&&this.loadView(e)}.bind(this)}}}},this.app,this.css),this.form.load()}.bind(this),!0)},setContentSize:function(){var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},t=this.app.titleBar?this.app.titleBar.getSize():{x:0,y:0},i=this.fileterNode?this.fileterNode.getSize():{x:0,y:0},s=this.node.getSize(),a=this.elementContentNode.getStyle("padding-top").toFloat(),n=this.elementContentNode.getStyle("padding-bottom").toFloat(),o=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0},l=s.y-e.y-a-n-o.y-t.y-i.y;this.elementContentNode.setStyle("height",l+"px"),this.pageCount=(l/30).toInt()+5,this.view&&this.view.items.length<this.pageCount&&this.view.loadElementList(this.pageCount-this.view.items.length)},loadView:function(e){this.elementContentNode.empty(),this.view=new MWF.xApplication.Attendance.MyAppeal.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey),this.view.filterData=e,this.view.load(),this.setContentSize()},createDocument:function(){this.view&&this.view._createDocument()}}),MWF.xApplication.Attendance.MyAppeal.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(e){return new MWF.xApplication.Attendance.MyAppeal.Document(this.table,e,this.explorer,this)},_getCurrentPageData:function(e,t){t||(t=20);var i=this.items.length?this.items[this.items.length-1].data.id:"(0)",s=this.filterData||{};s.empName=layout.desktop.session.user.distinguishedName,this.actions.listAppealFilterNext(i,t,s,(function(t){var i=t.data;i.sort((function(e,t){return parseInt(t.appealDateString.replace(/-/g,""))-parseInt(e.appealDateString.replace(/-/g,""))})),t.data=i,e&&e(t)}))},_removeDocument:function(e,t){},_createDocument:function(){},_openDocument:function(e){if(e.appealAuditInfo&&e.appealAuditInfo.workId){var t=e.appealAuditInfo.workId,i={workId:t,appId:"process.Work"+t};this.app.desktop.openApplication(null,"process.Work",i)}else{new MWF.xApplication.Attendance.MyAppeal.Appeal(this.explorer,e).open()}}}),MWF.xApplication.Attendance.MyAppeal.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document,agree:function(){},deny:function(){}}),MWF.xApplication.Attendance.MyAppeal.Appeal=new Class({Extends:MWF.widget.Common,initialize:function(e,t){this.explorer=e,this.app=e.app,this.data=t||{},this.css=this.explorer.css,this.load()},load:function(){this.app.restActions.getDetail(this.data.detailId,function(e){this.data.onDutyTime=e.data.onDutyTime,this.data.offDutyTime=e.data.offDutyTime}.bind(this),null,!1)},open:function(e){this.isNew=!1,this.isEdited=!1,this._open()},create:function(){this.isNew=!0,this._open()},edit:function(){this.isEdited=!0,this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(e){e.stopPropagation()},mouseout:function(e){e.stopPropagation()}}}).inject(this.app.content,"after"),this.createAreaNode=new Element("div",{styles:this.css.createAreaNode}),this.createNode(),this.createAreaNode.inject(this.createMarkNode,"after"),this.createAreaNode.fade("in"),this.setCreateNodeSize(),this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this),this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){var e=this,t=MWF.xApplication.Attendance.LP;this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode),this.createContainerNode=new Element("div",{styles:this.css.createContainerNode}).inject(this.createNode),this.setScrollBar(this.createContainerNode),this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createContainerNode),this.createTableContainer=new Element("div",{styles:this.css.createTableContainer}).inject(this.createFormNode),this.createTableArea=new Element("div",{styles:this.css.createTableArea}).inject(this.createTableContainer);var i=this.data,s=t.draft;0==i.status?s=t.todo:1==i.status?s=t.approve:-1==i.status&&(s=t.deny),this.data.appealStatusShow=s;var a="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td colspan='4' styles='formTableHead'>"+t.apealApplyForm+"</td></tr><tr><td styles='formTableTitle'>"+t.employeeName+"</td>    <td styles='formTableValue'>"+this.data.empName.split("@")[0]+"</td>    <td styles='formTableTitle' lable='recordDateString'></td>    <td styles='formTableValue' item='recordDateString'></td></tr><tr><td styles='formTableTitle' lable='onDutyTime'></td>    <td styles='formTableValue' item='onDutyTime'></td>    <td styles='formTableTitle' lable='offDutyTime'></td>    <td styles='formTableValue' item='offDutyTime'></td></tr><tr><td styles='formTableTitle' lable='appealStatusShow'></td>    <td styles='formTableValue' item='appealStatusShow'  colspan='3'></td></tr><tr><td styles='formTableTitle' lable='appealReason'></td>    <td styles='formTableValue' item='appealReason'></td>   <td styles='formTableTitle' lable='processPerson1Show'></td>    <td styles='formTableValue' item='processPerson1Show'></td></tr><tr contain='selfHolidayType'><td styles='formTableTitle' lable='selfHolidayType'></td>    <td styles='formTableValue' item='selfHolidayType' colspan='3'></td></tr><tr contain='address'><td styles='formTableTitle' lable='address'></td>    <td styles='formTableValue' item='address' colspan='3'></td></tr><tr contain='startTime'><td styles='formTableTitle' lable='startTime'></td>    <td styles='formTableValue' item='startTime' colspan='3'></td></tr><tr contain='endTime'><td styles='formTableTitle' lable='endTime'></td>    <td styles='formTableValue' item='endTime' colspan='3'></td></tr><tr contain='appealDescription'><td styles='formTableTitle' lable='appealDescription'></td>    <td styles='formTableValue' item='appealDescription' colspan='3'></td></tr></table>";this.createTableArea.set("html",a),this.document=new MForm(this.createTableArea,this.data,{style:"popup",isEdited:this.isEdited||this.isNew,itemTemplate:{recordDateString:{text:t.recordDate,type:"innertext"},onDutyTime:{text:t.onDutyTime,type:"innertext"},offDutyTime:{text:t.offDutyTime,type:"innertext"},statusShow:{text:t.attendanceStatus,type:"innertext"},appealStatusShow:{text:t.appealStatus,type:"innertext"},processPerson1Show:{text:t.auditor,type:"innertext",value:this.data.appealAuditInfo?this.data.appealAuditInfo.currentProcessor.split("@")[0]:""},appealReason:{notEmpty:!0,text:t.appealReason,type:"select",selectValue:t.appealReasonSelectText,event:{change:function(t){e.switchFieldByAppealReason(t.getValue())}}},address:{text:t.address},selfHolidayType:{text:t.leaveType,type:"select",selectValue:t.leaveTypeSelectText},startTime:{text:t.startTime,tType:"datetime"},endTime:{text:t.endTime,tType:"datetime"},appealDescription:{text:t.appealDescriptoin}}},this.app,this.css),this.document.load(),e.switchFieldByAppealReason(this.data.appealReason),this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:t.close}).inject(this.createFormNode),this.cancelActionNode.addEvent("click",function(e){this.cancelCreate(e)}.bind(this)),(this.isNew||this.isEdited)&&(this.denyActionNode=new Element("div",{styles:this.css.createDenyActionNode,text:t.disagree}).inject(this.createFormNode),this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:t.agree}).inject(this.createFormNode),this.denyActionNode.addEvent("click",function(e){this.deny(e)}.bind(this)),this.createOkActionNode.addEvent("click",function(e){this.okCreate(e)}.bind(this)))},switchFieldByAppealReason:function(e){var t=MWF.xApplication.Attendance.LP,i=[];e==t.temporaryLeave?i=["selfHolidayType","startTime","endTime"]:e==t.out?i=["address","startTime","endTime"]:e==t.businessTrip?i=["address","startTime","endTime","appealDescription"]:e==t.other&&(i=["appealDescription"]),["selfHolidayType","startTime","endTime","address","appealDescription"].each(function(e){this.createTableArea.getElement("[contain='"+e+"']").setStyle("display",i.contains(e)?"":"none"),(this.isNew||this.isEdited)&&(this.document.items[e].options.notEmpty=!!i.contains(e))}.bind(this))},setCreateNodeSize:function(){var e=this.app.node.getSize();this.app.content.getSize();this.createAreaNode.setStyles({width:e.x+"px",height:e.y+"px"});var t=(e.y-"560")/2;this.createNode.setStyles({height:"560px","margin-top":t+"px",width:"800px"}),this.createContainerNode.setStyles({height:"560px"});var i="560"-(this.createIconNode?this.createIconNode.getSize():{x:0,y:0}).y-60;this.createFormNode.setStyles({height:i+"px","margin-top":"60px"})},cancelCreate:function(e){this.createMarkNode.destroy(),this.createAreaNode.destroy()},deny:function(e){var t={ids:[this.data.id],status:"-1",opinion1:this.opinion1.getValue()};t.opinion1?this.process(t):this.app.notice(MWF.xApplication.Attendance.LP.inputIdeaNotice,"error")},okCreate:function(e){var t={ids:[this.data.id],status:"1",opinion1:this.opinion1.getValue()};this.process(t)},process:function(e){this.app.restActions.processAppeal(e,function(e){"ERROR"==e.type?this.app.notice(e.message,"error"):(this.createMarkNode.destroy(),this.createAreaNode.destroy(),this.explorer.view&&this.explorer.view.reload(),this.app.notice(MWF.xApplication.Attendance.LP.processSuccess,"success"))}.bind(this))}});