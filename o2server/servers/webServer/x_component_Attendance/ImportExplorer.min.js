MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MDomItem",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.Attendance.ImportExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(t,e,s,i){this.setOptions(i),this.app=e,this.path="../x_component_Attendance/$ImportExplorer/",this.cssPath="../x_component_Attendance/$ImportExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=s,this.node=$(t),this.initData(),this.personActions||(this.personActions=new MWF.xAction.org.express.RestActions)},loadView:function(){this.view=new MWF.xApplication.Attendance.ImportExplorer.View(this.elementContentNode,this.app,this,this.viewData,this.options.searchKey),this.view.load(),this.setContentSize()},createDocument:function(){this.view&&this.view._createDocument()},importExcel:function(){this.upload()},upload:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var e=t.files;if(e.length)for(var s=0;s<e.length;s++){var i=e.item(s),n=i.name.split(".");if(this.uploadFileName=i.name,"xls"!=n[n.length-1].toLowerCase()&&"xlsx"!=n[n.length-1].toLowerCase())return void this.app.notice(this.app.lp.importExcelNotice,"error");var a=new FormData;a.append("file",i),this.actions.uploadAttachment(function(t){var e=t.id;this.actions.getAttachmentInfo(e,function(t){new MWF.xApplication.Attendance.ImportExplorer.Progress(e,this.actions).load(function(){new MWF.xApplication.Attendance.ImportExplorer.Result(this,t.data,{id:e},{app:this.app,actions:this.app.restActions,css:{}}).open(),this.view.reload()}.bind(this))}.bind(this))}.bind(this),function(t,e,s){var i=s;t&&(i=t.responseText),this.app.notice(i,"error")}.bind(this),a,i)}}.bind(this))}var t=this.uploadFileAreaNode.getFirst();t.click()},checkData:function(){new MWF.xApplication.Attendance.ImportExplorer.YearMonthSelctor(this).edit()},analyseData:function(){this.actions.analyseDetail("0","0",function(){this.app.notice(this.app.lp.analyseDataSuccess,"success")}.bind(this))},staticData:function(){this.actions.staticAllDetail(function(){this.app.notice(this.app.lp.statDataSuccess,"success")}.bind(this))},downloadTemplate:function(){window.open(o2.filterUrl(this.path+encodeURIComponent("dataTemplate.xls"),"_blank"))},showDescription:function(t){if(this.descriptionNode)this.descriptionNode.setStyle("display","block"),this.descriptionNode.position({relativeTo:t,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}});else{this.descriptionNode=new Element("div",{styles:this.css.descriptionNode}).inject(this.node),this.descriptionNode.position({relativeTo:t,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}}),this.descriptionNode.addEvent("mousedown",(function(t){t.stopPropagation()})),document.body.addEvent("mousedown",function(){this.descriptionNode.setStyle("display","none")}.bind(this));var e=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.filterTable,class:"filterTable"}).inject(this.descriptionNode),s=new Element("tr").inject(e);new Element("td",{text:this.app.lp.importDataStep,styles:this.css.descriptionTdHead}).inject(s),Array.each(this.app.lp.importStepDescription,function(t){var s=new Element("tr").inject(e);new Element("td",{text:t,styles:this.css.descriptionTdValue}).inject(s)}.bind(this))}}}),MWF.xApplication.Attendance.ImportExplorer.View=new Class({Extends:MWF.xApplication.Attendance.Explorer.View,_createItem:function(t){return new MWF.xApplication.Attendance.ImportExplorer.Document(this.table,t,this.explorer,this)},_getCurrentPageData:function(t,e){this.actions.listAttachmentInfo((function(e){t&&t(e)}))},_removeDocument:function(t,e){this.actions.deleteAttachment(t.id,function(t){this.explorer.view.reload(),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_createDocument:function(){},_openDocument:function(t){this.actions.getAttachmentStream(t.id)}}),MWF.xApplication.Attendance.ImportExplorer.Document=new Class({Extends:MWF.xApplication.Attendance.Explorer.Document,openVaild:function(t){},openResult:function(){new MWF.xApplication.Attendance.ImportExplorer.Result(this,this.data,{id:this.data.id},{app:this.app,actions:this.app.restActions,css:{}}).open()}}),MWF.xApplication.Attendance.ImportExplorer.YearMonthSelctor=new Class({Extends:MPopupForm,options:{style:"attendance",width:500,height:300,hasTop:!0,hasBottom:!0,title:MWF.xApplication.Attendance.LP.selectCheckMonth,draggable:!0,closeAction:!0,false:!0},_createTableContent:function(){this.formTableContainer.setStyles({width:"300px"});this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTabelTitle' lable='cycleYear'></td>    <td styles='formTableValue' item='cycleYear'></td></tr><tr><td styles='formTabelTitle' lable='cycleMonth'></td>    <td styles='formTableValue' item='cycleMonth'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{},{isEdited:this.isEdited||this.isNew,itemTemplate:{cycleYear:{text:MWF.xApplication.Attendance.LP.annuaal,type:"select",selectValue:function(){var t=[];d=new Date;for(var e=0;e<5;e++)t.push(d.getFullYear()),d.setFullYear(d.getFullYear()-1);return t}},cycleMonth:{text:MWF.xApplication.Attendance.LP.months,type:"select",defaultValue:function(){return(new Date).getMonth()},selectValue:["1","2","3","4","5","6","7","8","9","10","11","12"]}}},this.app),this.form.load()}.bind(this),!0)},_ok:function(t,e){this.app.restActions.checkDetail(t.cycleYear,t.cycleMonth,function(t){this.app.notice(MWF.xApplication.Attendance.LP.checkDetailSuccess),this.close()}.bind(this))}}),MWF.xApplication.Attendance.ImportExplorer.Result=new Class({Extends:MPopupForm,options:{style:"attendance",width:800,height:600,hasTop:!0,hasBottom:!1,title:MWF.xApplication.Attendance.LP.importDataResult,draggable:!0,closeAction:!0,hasScroll:!0,closeByClickMask:!0,id:""},_createTableContent:function(){this.actions.getImportStatusDetail(this.options.id,function(t){this.checkData=t.data,this.createImportContent()}.bind(this))},createImportContent:function(){var t=MWF.xApplication.Attendance.LP;if(0==this.checkData.errorCount)var e=t.importDataResultSuccess.replace("{fileName}",this.data.fileName).replace("{count}",this.checkData.detailList.length);else e=t.importDataResultFail.replace("{fileName}",this.data.fileName).replace("{errorCount}",this.checkData.errorCount).replace("{count}",this.checkData.detailList.length);this.formDescriptionNode=new Element("div",{styles:this.css.formDescriptionNode,text:e}).inject(this.formTableArea);var s,i=new Element("table",{width:"100%",border:"",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.formTableArea),n=new Element("tr").inject(i);Array.each(t.importDataResultThList,function(t){s=new Element("td",{styles:this.css.editTableTitle,text:t}).inject(n)}.bind(this)),s.setStyle("width","300px"),this.checkData.detailList.each(function(e){var s=new Element("tr").inject(i);new Element("td",{styles:this.css.editTableValue,text:e.curRow}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.employeeNo}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.employeeName.split("@")[0]}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.recordDateString}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.onDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.morningOffDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.afternoonOnDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.offDutyTime}).inject(s),new Element("td",{styles:this.css.editTableValue,text:"error"==e.checkStatus?t.false:t.true}).inject(s),new Element("td",{styles:this.css.editTableValue,text:e.description}).inject(s)}.bind(this))}}),MWF.xApplication.Attendance.ImportExplorer.Progress=new Class({initialize:function(t,e){this.id=t,this.actions=e},load:function(t){var e=MWF.xApplication.Attendance.LP;this.currentDate=new Date,this.addFormDataMessage(),this.status="ready",this.intervalId=setInterval(function(){this.actions.getImportStatus(this.id,function(s){var i=s.data;i.processing&&"COMPLETE"!=i.currentProcessName?"VALIDATE"==i.currentProcessName?(this.status!=i.currentProcessName&&(this.setMessageTitle(e.checkDataTitle),this.setMessageText(e.checkDataContent.replace("{count}",i.process_validate_total)),this.status=i.currentProcessName),this.updateProgress(i.currentProcessName,i.process_validate_count,i.process_validate_total,i.errorCount)):"SAVEDATA"==i.currentProcessName&&(this.status!=i.currentProcessName&&(this.setMessageTitle(e.importDataTitle),this.setMessageText(e.importDataContent.replace("{count}",i.process_save_total)),this.status=i.currentProcessName),this.updateProgress(i.currentProcessName,i.process_save_count,i.process_save_total,i.errorCount)):(this.status=i.currentProcessName,clearInterval(this.intervalId),this.transferComplete(i),t&&t())}.bind(this),null)}.bind(this),500)},addFormDataMessage:function(t){var e=MWF.xApplication.Attendance.LP,s="";s=t?'<div style="height: 20px; line-height: 20px">'+e.readyToImportData1+"</div></div>":'<div style="overflow: hidden"><div style="height: 3px; border:1px solid #999; margin: 3px 0px"><div style="height: 3px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+e.readyToImportData1+"</div></div>";var i={subject:e.readyToImportData,content:s};this.messageItem=layout.desktop.message.addMessage(i),this.messageItem.status="ready",window.setTimeout(function(){layout.desktop.message.isShow||layout.desktop.message.show()}.bind(this),100)},updateProgress:function(t,e,s,i){var n=MWF.xApplication.Attendance.LP,a=this.messageItem,o=i?e+i:e,r=o/s*100,c=new Date,l=this.lastTime||this.currentDate,p=c.getTime()-l.getTime(),d=1e3*(o-(this.lastProcessed||0))/p;n.importSpeed;if(d=d.round(2),a.contentNode){var h=a.contentNode.getFirst("div").getFirst("div").getFirst("div"),u=a.contentNode.getFirst("div").getLast("div");if(h.setStyle("width",r+"%"),"VALIDATE"==t){var m=n.checkingDataContent.replace("{speed}",d).replace("{total}",s).replace("{remaining}",s-e);m+=i?n.checkingDataErrorContent.replace("{errorCount}",i):""}else{m=n.importingDataContent.replace("{speed}",d).replace("{total}",s).replace("{remaining}",s-e);m+=i?n.importingDataErrorContent.replace("{errorCount}",i):""}u.set("text",m)}this.lastProcessed=o,this.lastTime=new Date},transferComplete:function(t){var e=MWF.xApplication.Attendance.LP,s=t.errorCount,i=(this.messageItem,(new Date).getTime()-this.currentDate.getTime()),n="";if(i>36e5){var a=i%36e5,o=a/6e4,r=a%6e4/1e3;n=""+(i/36e5).toInt()+e.hour+o.toInt()+e.mintue+r.toInt()+e.second}else if(i>6e4){r=i%6e4/1e3;n=""+(o=i/6e4).toInt()+e.mintue+r.toInt()+e.second}else{n=""+(r=i/1e3).toInt()+e.second}if(0==s){var c=1e3*(p=t.process_save_total)/i;e.importSpeed;c=c.round(2),this.setMessageTitle(e.importSuccessTitle);var l=e.importSuccessContent.replace("{total}",p).replace("{speed}",c).replace("{timeStr}",n);this.setMessageText(l)}else{var p=t.process_validate_total;this.setMessageTitle(e.importFailTitle);l=e.importFailContent.replace("{total}",p).replace("{errorCount}",s).replace("{timeStr}",n);this.setMessageText(l)}this.clearMessageProgress()},setMessageText:function(t){this.getProgessNode().getFirst("div");this.getProgressInforNode().set("text",t),this.messageItem.dateNode.set("text",(new Date).format("db"))},setMessageTitle:function(t){this.messageItem.subjectNode.set("text",t)},clearMessageProgress:function(){this.getProgessNode().destroy()},getProgessNode:function(){return this.progressNode||(this.progressNode=this.messageItem.contentNode.getFirst("div").getFirst("div")),this.progressNode},getProgressInforNode:function(){return this.progressInforNode||(this.progressInforNode=this.messageItem.contentNode.getFirst("div").getLast("div")),this.progressInforNode}});