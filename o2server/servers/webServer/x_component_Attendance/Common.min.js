MWF.xApplication.Attendance=MWF.xApplication.Attendance||{},MWF.xDesktop.requireApp("Attendance","lp."+MWF.language,null,!1),MWF.xApplication.Attendance.Calendar=new Class({Implements:[Options,Events],options:{date:null},initialize:function(t,e,n,i){this.setOptions(i),this.app=e.app,this.explorer=e,this.actions=this.app.actions,this.node=t,this.css=e.css,this.holiday=n.holiday,this.eventData=n.eventData,this.detail=n.detail,this.statusColor=e.statusColor},reload:function(){this.node.empty(),this.load()},load:function(){this.loadResource(function(){this.loadCalendar()}.bind(this))},loadResource:function(t){var e=["../x_component_Attendance/$Common/fullcalendar/lib/moment.js","../x_component_Attendance/$Common/fullcalendar/lib/jquery.js"],n="../x_component_Attendance/$Common/fullcalendar/lang/"+MWF.language+".js";COMMON.AjaxModule.loadCss("../x_component_Attendance/$Common/fullcalendar/fullcalendar.css",function(){COMMON.AjaxModule.load(e,function(){jQuery.noConflict(),COMMON.AjaxModule.load("../x_component_Attendance/$Common/fullcalendar/fullcalendar.js",function(){COMMON.AjaxModule.load(n,function(){t&&t()}.bind(this))}.bind(this))}.bind(this))}.bind(this))},loadCalendar:function(){jQuery(this.node).fullCalendar({header:{left:"",center:"",right:""},contentHeight:350,defaultDate:this.options.date.format(this.app.lp.dateFormatDay),eventColor:"#fff",eventTextColor:"#fff",rendingNumberCellFun:function(t,e,n){return this.holiday&&this.holiday.holidays&&this.holiday.holidays.contains(e)?"<span style='float:right;padding-right:5px;color:red'>"+this.app.lp.offDutyAbbrev+"</span>":this.holiday&&this.holiday.workdays&&this.holiday.workdays.contains(e)?"<span style='float:right;padding-right:5px;'>"+this.app.lp.onDutyAbbrev+"</span>":void 0}.bind(this),eventMouseover:function(t,e,n){e.target.title=t.text},events:this.eventData})}}),MWF.xApplication.Attendance.Echarts=new Class({Implements:[Options,Events],options:{type:"pie",date:null},initialize:function(t,e,n,i){this.setOptions(i),this.app=e.app,this.lp=this.app.lp,this.actions=this.app.actions,this.node=t,this.css=e.css,this.data=n,this.statusColor=e.statusColor},load:function(){this.options.date||(this.options.date=new Date),this.year=this.options.date.getFullYear();var t=this.options.date.getMonth()+1;this.month=2==t.toString().length?t:"0"+t,this.loadResource(function(){"pie"==this.options.type?this.loadPieChart():this.loadLineChart()}.bind(this))},loadResource:function(t){COMMON.AjaxModule.load(["../x_component_Attendance/$Common/echarts/echarts.common.js"],function(){COMMON.AjaxModule.load("../x_component_Attendance/$Common/echarts/theme/shine.js",function(){t&&t()}.bind(this))}.bind(this))},loadPieChart:function(){this.chart=echarts.init(this.node,"shine"),this.chart.setOption({title:{text:this.lp.attendanceSummary},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:this.lp.attendanceStatus,type:"pie",radius:["55%","70%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"30",fontWeight:"bold"}}},labelLine:{normal:{show:!1}},data:this.getPieData()}]})},loadLineChart:function(){var t=this,e=this.options.cycleStart.getMonth()!=this.options.cycleEnd.getMonth(),n=this.getDateByMonth(),i=this.analyseLineData(),a={title:{text:this.lp.attendanceTrendChart},grid:{left:50,right:40},tooltip:{trigger:"axis",formatter:function(n){var i,a,o,s;return n[0].value&&"-"!=n[0].value?(s=1==(i=n[0].value.toString().split(".")).length?i[0]+":00":1==i[1].length?i[0]+":"+i[1]+"0":i.join(":"),a=n[0].seriesName+"  "+s):a="",n[1].value&&"-"!=n[1].value?(s=1==(i=n[1].value.toString().split(".")).length?i[0]+":00":1==i[1].length?i[0]+":"+i[1]+"0":i.join(":"),o=n[1].seriesName+"  "+s):o="",e?n[0].name+"<br />"+a+"<br />"+o:t.year+"-"+t.month+"-"+n[0].name+"<br />"+a+"<br />"+o}},legend:{data:this.lp.trendChartLegend}};a.yAxis={type:"value",min:0==i.yOffTime.length&&0==i.yOnTime.length?"5.00":"dataMin",max:0==i.yOffTime.length&&0==i.yOnTime.length?"23.00":"dataMax",axisLabel:{formatter:function(t){return vs=t.toString().split("."),1==vs.length?vs[0]+":00":1==vs[1].length?vs[0]+":"+vs[1]+"0":vs.join(":")}}},a.xAxis=[{type:"category",boundaryGap:!1,data:n,axisLabel:{}}],a.series=[{name:this.lp.trendChartLegend[0],type:"line",data:i.yOnTime.map((function(t){return!t||isNaN(parseFloat(t.replace(":",".")))?"-":parseFloat(t.replace(":","."))}))},{name:this.lp.trendChartLegend[1],type:"line",data:i.yOffTime.map((function(t){return!t||isNaN(parseFloat(t.replace(":",".")))?"-":parseFloat(t.replace(":","."))}))}],this.chart=echarts.init(this.node,"shine"),this.chart.setOption(a)},getPieData:function(){var t=[];for(var e in this.data)t.push({value:this.data[e],name:this.lp[e],itemStyle:{normal:{color:this.statusColor[e]}}});return t},getDateByMonth:function(){var t=[];if(this.options.cycleStart.getMonth()==this.options.cycleEnd.getMonth())for(var e=this.year||(new Date).getFullYear(),n=this.options.date.getMonth()||(new Date).getMonth(),i=new Date(e,n,1);i.getMonth()===n;)t.push(i.getDate()),i.setDate(i.getDate()+1);else for(var a=this.options.cycleStart.clone(),o=this.options.cycleEnd.clone();a<=o;)t.push(a.format("%Y-%m-%d")),a.setDate(a.getDate()+1);return this.allDates=t,t},analyseLineData:function(){var t=this.getDateByMonth(),e={};this.data.each((function(t,n){e[t.recordDateString]=t}));var n=[],i=[];if(this.options.cycleStart.getMonth()==this.options.cycleEnd.getMonth()){var a=this.year||(new Date).getFullYear().toString(),o=this.options.date.format("%m");t.each((function(t,s){var h=e[a+"-"+o+"-"+(t>9?t:"0"+t)];h?(n.push(""!=h.onDutyTime?h.onDutyTime:"-"),i.push(""!=h.offDutyTime?h.offDutyTime:"-")):(n.push("-"),i.push("-"))}))}else t.each((function(t,a){var o=e[t];o?(n.push(""!=o.onDutyTime?o.onDutyTime:"-"),i.push(""!=o.offDutyTime?o.offDutyTime:"-")):(n.push("-"),i.push("-"))}));return{yOnTime:n,yOffTime:i}},loadUnitPieChart:function(){this.loadResource(function(){this._loadUnitPieChart()}.bind(this))},_loadUnitPieChart:function(){var t=this.getUnitPieData();this.chart=echarts.init(this.node,"shine"),this.chart.setOption({title:{text:this.lp.attendanceSummary},tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:this.lp.attendanceStatus,type:"pie",radius:["55%","70%"],avoidLabelOverlap:!1,label:{normal:{show:!1,position:"center"},emphasis:{show:!0,textStyle:{fontSize:"30",fontWeight:"bold"}}},labelLine:{normal:{show:!1}},data:t.data}]})},getUnitPieData:function(){var t={name:[],data:[]};for(var e in this.data)t.name.push(this.lp[e]),t.data.push({value:this.data[e],name:this.lp[e],itemStyle:{normal:{color:this.statusColor[e]}}});return t},loadUnitBarChart:function(){this.loadResource(function(){this._loadUnitBarChart()}.bind(this))},_loadUnitBarChart:function(){var t=this.getUnitBarData(),e={title:{text:this.lp.attendanceTrend},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",data:t.name}],yAxis:[{type:"value"}],series:t.data};this.chart=echarts.init(this.node,"shine"),this.chart.setOption(e)},getUnitBarData:function(){var t={};this.data.each(function(e){for(var n in e.data)t[n]||(t[n]={month:[],name:this.lp[n],type:"bar",itemStyle:{normal:{color:this.statusColor[n]}},data:[]}),t[n].data.push(e.data[n]),t[n].month.push(e.year+"-"+e.month)}.bind(this));var e={data:[]};for(var n in t)e.name||(e.name=t[n].month),e.data.push(t[n]);return e}}),MWF.xApplication.Attendance.MonthSelector=new Class({Implements:[Events],initialize:function(t,e){this.explorer=e,this.css=this.explorer.css,this.app=this.explorer.app,this.date=t,this.year=this.date.get("year"),this.load()},load:function(){this.monthSelectNode=new Element("div",{styles:this.css.calendarMonthSelectNode}).inject(this.explorer.node),this.monthSelectNode.position({relativeTo:this.explorer.titleTextNode,position:"bottomCenter",edge:"upperCenter"}),this.monthSelectNode.addEvent("mousedown",(function(t){t.stopPropagation()})),this.monthSelectTitleNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNode}).inject(this.monthSelectNode),this.monthSelectPrevYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitlePrevYearNode}).inject(this.monthSelectTitleNode),this.monthSelectNextYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNextYearNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode=new Element("div",{styles:this.css.calendarMonthSelectTitleTextNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode.set("text",this.year);this.monthSelectTable=new Element("table",{styles:{"margin-top":"10px"},height:"200px",width:"90%",align:"center",border:"0",cellPadding:"0",cellSpacing:"5",html:"<tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr>"}).inject(this.monthSelectNode),this.monthSelectBottomNode=new Element("div",{styles:this.css.calendarMonthSelectBottomNode,text:this.app.lp.today}).inject(this.monthSelectNode),this.setEvent()},loadMonth:function(){this.monthSelectTextNode.set("text",this.year);var t=new Date,e=t.get("year"),n=t.get("month"),i=this.date.get("year"),a=this.date.get("month"),o=this;this.monthSelectTable.getElements("td").each(function(t,s){t.empty(),t.removeEvents("mouseover"),t.removeEvents("mouseout"),t.removeEvents("mousedown"),t.removeEvents("mouseup"),t.removeEvents("click");var h=s+1;t.store("month",h),t.setStyles(this.css.calendarMonthSelectTdNode),t.set("text",""+h),t.setStyle("background-color","#FFF"),this.year==i&&s==a&&t.setStyle("background-color","#EEE"),this.year==e&&s==n&&t.setStyle("background-color","#CCC"),t.addEvents({mouseover:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},mouseout:function(){this.setStyles(o.css.calendarMonthSelectTdNode)},mousedown:function(){this.setStyles(o.css.calendarMonthSelectTdNode_down)},mouseup:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},click:function(){o.selectedMonth(this)}})}.bind(this))},setEvent:function(){this.monthSelectPrevYearNode.addEvent("click",function(){this.prevYear()}.bind(this)),this.monthSelectNextYearNode.addEvent("click",function(){this.nextYear()}.bind(this)),this.monthSelectBottomNode.addEvent("click",function(){this.todayMonth()}.bind(this))},prevYear:function(){this.year--,this.year<1900&&(this.year=1900),this.monthSelectTextNode.set("text",this.year),this.loadMonth()},nextYear:function(){this.year++,this.monthSelectTextNode.set("text",this.year),this.loadMonth()},todayMonth:function(){var t=new Date;this.explorer.changeMonthTo(t),this.hide()},selectedMonth:function(t){var e=t.retrieve("month"),n=Date.parse(this.year+"/"+e+"/1");this.explorer.changeMonthTo(n),this.hide()},show:function(){this.date=this.explorer.date,this.year=this.date.get("year"),this.loadMonth(),this.monthSelectNode.setStyle("display","block"),this.hideFun=this.hide.bind(this),document.body.addEvent("mousedown",this.hideFun)},hide:function(){this.monthSelectNode.setStyle("display","none"),document.body.removeEvent("mousedown",this.hideFun)},destroy:function(){}});