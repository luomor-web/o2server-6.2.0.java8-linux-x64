MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Org","$Explorer",null,!1),MWF.xApplication.Org.UnitExplorer=new Class({Extends:MWF.xApplication.Org.$Explorer,Implements:[Options,Events],options:{style:"default",lp:{},creator:!1},_loadLp:function(){this.options.lp={search:this.app.lp.search,searchText:this.app.lp.searchText,elementSave:this.app.lp.organizationSave,deleteElements:this.app.lp.deleteOrganization,deleteElementsCancel:this.app.lp.deleteElementsCancel,deleteElementsTitle:this.app.lp.deleteOrganizationTitle,deleteElementsConfirm:this.app.lp.deleteOrganizationSubConfirm,noSignature:this.app.lp.noSignature,edit:this.app.lp.edit,cancel:this.app.lp.cancel,save:this.app.lp.save,add:this.app.lp.add}},loadElements:function(t){this.isElementLoaded||(this.loaddingElement?t&&this.loadElementQueue++:(this.loaddingElement=!0,this._listElementNext(function(t){t.data.length?this.loadListContent(t.data):this.elements.length||this.setNoGroupNoticeArea(),this.loadElementQueue=0,this.isElementLoaded=!0,this.loaddingElement=!1}.bind(this))))},loadListContent:function(t){t.each(function(t,e){var i=this._newElement(t,this,e);this.elements.push(i),i.load(),1===this.elements.length&&(i.selected(),i.isExpand||i.expand())}.bind(this))},_listElementNext:function(t){if(MWF.AC.isOrganizationManager())this.actions.listTopUnit(function(e){t&&t.apply(this,[e])}.bind(this));else if(layout.session.user.identityList.length){var e={data:[]},i=[];layout.session.user.identityList.each(function(t){var n=t.distinguishedName||t.id||t.unique||t.name;o2.Actions.get("x_organization_assemble_express").getUnitWithIdentityAndLevel({identity:n,level:1},function(t){t.data&&this.actions.getUnit(t.data.distinguishedName,function(t){-1==i.indexOf(t.data.distinguishedName)&&(i.push(t.data.distinguishedName),e.data.push(t.data))}.bind(this),null,!1)}.bind(this),null,!1)}.bind(this)),t&&t.apply(this,[e])}},_newElement:function(t,e){return new MWF.xApplication.Org.UnitExplorer.Unit(t,e,this.isEditor,0)},_listElementByKey:function(t,e,i){this.actions.listUnitByKey(function(e){t&&t.apply(this,[e])}.bind(this),e,i)},_getAddElementData:function(){return{name:"",unique:"",typeList:["company"],description:"",shortName:"",superior:"",orderNumber:"",controllerList:[],control:{allowEdit:!0,allowDelete:!0},woSubDirectIdentityList:[],woUnitAttributeList:[],woUnitDutyList:[]}},deleteSelectedElements:function(t){var e=this;this.app.confirm("infor",t,this.options.lp.deleteElementsTitle,{html:this.options.lp.deleteElementsConfirm},500,260,(function(){var t,i=[],n=0,s=e.deleteElements.length,o="";t=function(){n===s&&o&&e.app.notice(o,"error",e.propertyContentNode,{x:"left",y:"top"})},e.deleteElements.each((function(s){s.delete((function(){i.push(s),n++,e.deleteElements.length===n&&(e.deleteElements=e.deleteElements.filter((function(t){return!i.contains(t)})),e.checkDeleteElements()),t()}),(function(s){o=o?o+"<br/><br/>"+s:s,n++,e.deleteElements.length!==n||(e.deleteElements=e.deleteElements.filter((function(t){return!i.contains(t)})),e.checkDeleteElements()),t()}))})),this.close()}),(function(){this.close()}))}}),MWF.xApplication.Org.UnitExplorer.Unit=new Class({Extends:MWF.xApplication.Org.$Explorer.Item,initialize:function(t,e,i,n,s,o){this.i=n,this.level=n,this.parent=o,this.data=t,this.explorer=e,this.listNode=s||this.explorer.listNode,this.propertyContentNode=this.explorer.propertyContentNode,this.initStyle(),this.selectedAttributes=[],this.isEdit=!1,this.isEditor=i,this.deleteSelected=!1,this.subUnits=[]},refresh:function(){this._loadTextNode(),this.content&&(this.content.titleInfor&&this.content.titleInfor.refresh(),this.content.bottomInfor&&this.content.bottomInfor.refresh()),this.addActions()},initStyle:function(){var t=Object.clone(this.explorer.css.item);this.style=Object.merge(t,this.explorer.css.unitItem)},_loadTextNode:function(){this.textNode.set({text:this.data.name+(this.data.subDirectUnitCount?" ("+this.data.subDirectUnitCount+")":"")})},load:function(){this.node=new Element("div",{styles:this.style.node}).inject(this.listNode),this.contentNode=new Element("div",{styles:this.style.contentNode}).inject(this.node);var t=10*this.level;this.contentNode.setStyle("padding-left",t+"px"),this.level%2==1&&(this.node.setStyle("background-color","#ffffff"),this.contentNode.setStyle("background-color","#ffffff")),this.childNode=new Element("div",{styles:this.style.childNode}).inject(this.node),this.toggleIconNode=new Element("div",{styles:this.style.unitToggleIconNode}).inject(this.contentNode),this.setToggleIconNode(),this.setToggleAction(),this.iconNode=new Element("div",{styles:this.style.unitIconNode}).inject(this.contentNode);var e=this._getIcon();this.iconNode.setStyle("background-image","url("+e+")"),this.actionNode=new Element("div",{styles:this.style.actionNode}).inject(this.contentNode),this.textNode=new Element("div",{styles:this.style.unitTextNode}).inject(this.contentNode),this._loadTextNode(),this.setNewItem(),this.node.inject(this.listNode),this.addActions(),this.setEvent()},addActions:function(){this.data.id&&(this.data.control.allowDelete&&(this.deleteNode||(this.deleteNode=new Element("div",{styles:this.style.actionDeleteNode}).inject(this.actionNode),this.deleteNode.addEvent("click",function(t){this.notDelete||(this.deleteSelected?this.setUndelete():this.setDelete()),t.stopPropagation()}.bind(this)))),this.data.control.allowEdit&&(this.addNode||(this.addNode=new Element("div",{styles:this.style.actionAddNode}).inject(this.actionNode),this.addNode.addEvent("click",function(t){this.notDelete||this.addSubUnit(),t.stopPropagation()}.bind(this)))),this.explorer.currentItem===this&&(this.deleteNode&&this.deleteNode.setStyles(this.style.actionDeleteNode_selected),this.addNode&&this.addNode.setStyles(this.style.actionAddNode_selected)))},addSubUnit:function(){this.expand(function(){var t=!0;if(this.explorer.currentItem&&(t=this.explorer.currentItem.unSelected()),t){var e=this.explorer._getAddElementData();e.superior=this.data.id;var i=new MWF.xApplication.Org.UnitExplorer.Unit(e,this.explorer,this.isEditor,this.level+1,this.childNode,this);i.load(),i.selected(),i.editBaseInfor(),new Fx.Scroll(this.explorer.listScrollNode).toElementCenter(i.node)}else this.app.notice(this.explorer.options.lp.elementSave,"error",this.explorer.propertyContentNode)}.bind(this))},setDeleteFromP:function(){this.notDelete=!0,this.subUnits.each((function(t){t.setDeleteFromP()})),this.deleteNode.setStyles(this.style.actionDeleteNode_delete),this.contentNode.setStyles(this.style.contentNode_delete),this.textNode.setStyles(this.style.unitTextNode),this.deleteSelected=!0,this.explorer.checkDeleteElements(this)},setDelete:function(){this.subUnits.each((function(t){t.setDeleteFromP()})),this.deleteNode.setStyles(this.style.actionDeleteNode_delete),this.addNode&&this.addNode.setStyles(this.style.actionAddNode_delete),this.contentNode.setStyles(this.style.contentNode_delete),this.textNode.setStyles(this.style.unitTextNode),this.explorer.deleteElements.push(this),this.deleteSelected=!0,this.explorer.checkDeleteElements(this)},setUndelete:function(){this.notDelete=!1,this.subUnits.each((function(t){t.setUndelete()})),this.explorer.currentItem!==this?(this.deleteNode&&this.deleteNode.setStyles(this.style.actionDeleteNode),this.addNode&&this.addNode.setStyles(this.style.actionAddNode),this.contentNode.setStyles(this.style.contentNode),this.textNode.setStyles(this.style.unitTextNode)):(this.contentNode.setStyles(this.style.contentNode_selected),this.textNode.setStyles(this.style.textNode_selected),this.actionNode.setStyles(this.style.actionNode_selected),this.deleteNode&&this.deleteNode.setStyles(this.style.actionDeleteNode_selected),this.addNode&&this.addNode.setStyles(this.style.actionAddNode_selected),this.addNode&&this.addNode.setStyles(this.style.actionAddNode_selected)),this.explorer.deleteElements.erase(this),this.deleteSelected=!1,this.explorer.checkDeleteElements(this)},setToggleIconNode:function(){if(this.data.subDirectUnitCount>0){var t=this.explorer.currentItem===this?"toggle_current_on":"toggle_on",e=this.explorer.currentItem===this?"toggle_current_off":"toggle_off";this.isExpand?this.toggleIconNode.setStyle("background-image","url(../x_component_Org/$Explorer/"+this.explorer.app.options.style+"/icon/"+t+".png)"):this.toggleIconNode.setStyle("background-image","url(../x_component_Org/$Explorer/"+this.explorer.app.options.style+"/icon/"+e+".png)")}else this.toggleIconNode.setStyle("background-image","")},setToggleAction:function(){this.toggleIconNode.addEvent("click",function(t){this.expandOrCollapse(),t.stopPropagation()}.bind(this))},expandOrCollapse:function(){this.isExpand?this.collapse():this.expand()},listSubUnit:function(t){this.node.mask(),this.explorer.actions.listSubUnitDirect(function(e){e.data.length&&e.data.each(function(t){var e=new MWF.xApplication.Org.UnitExplorer.Unit(t,this.explorer,this.isEditor,this.level+1,this.childNode,this);this.explorer.elements.push(e),e.load(),this.subUnits.push(e)}.bind(this)),this.isLoadSub=!0,this.node.unmask(),t&&t()}.bind(this),null,this.data.id)},expand:function(t){this.childNode.setStyle("display","block"),this.isExpand=!0,this.setToggleIconNode(),this.isLoadSub?t&&t():this.listSubUnit(t)},collapse:function(){this.childNode.setStyle("display","none"),this.isExpand=!1,this.setToggleIconNode()},unSelected:function(){return"edit"!==this.content.baseInfor.mode&&(this.explorer.currentItem=null,this.contentNode.setStyles(this.style.contentNode),this.textNode.setStyles(this.style.unitTextNode),this.actionNode.setStyles(this.style.actionNode),this.deleteNode&&this.deleteNode.setStyles(this.style.actionDeleteNode),this.addNode&&this.addNode.setStyles(this.style.actionAddNode),this.iconNode.setStyle("background-image","url("+this._getIcon()+")"),this.setToggleIconNode(),this.clearItemProperty(),!0)},selected:function(){this.explorer.currentItem=this,this.contentNode.setStyles(this.style.contentNode_selected),this.textNode.setStyles(this.style.textNode_selected),this.actionNode.setStyles(this.style.actionNode_selected),this.deleteNode&&this.deleteNode.setStyles(this.style.actionDeleteNode_selected),this.addNode&&this.addNode.setStyles(this.style.actionAddNode_selected),this.iconNode.setStyle("background-image","url("+this._getIcon()+")"),this.setToggleIconNode(),this.showItemProperty()},showItemProperty:function(){this.content=new MWF.xApplication.Org.UnitExplorer.UnitContent(this)},delete:function(t,e){this.explorer.actions.deleteUnit(this.data.id,function(){this.destroy(),t&&t()}.bind(this),(function(t,i,n){var s=n;t&&(s=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+s),e&&e()}))},_getIcon:function(){return this.explorer.currentItem===this?"../x_component_Org/$Explorer/default/icon/unit_current.png":"../x_component_Org/$Explorer/default/icon/unit.png"},_isActionManager:function(){return MWF.AC.isOrganizationManager()||MWF.AC.isUnitManager()}}),MWF.xApplication.Org.UnitExplorer.UnitContent=new Class({Extends:MWF.xApplication.Org.$Explorer.ItemContent,_getData:function(t){this.item.data.id?this.explorer.actions.getUnit(function(e){this.data=e.data,this.item.data=e.data,t&&t()}.bind(this),null,this.item.data.id):(this.data=this.item.data,t&&t())},_showItemPropertyTitle:function(){this.titleInfor=new MWF.xApplication.Org.UnitExplorer.UnitContent.TitleInfor(this)},_showItemPropertyBottom:function(){this.bottomInfor=new MWF.xApplication.Org.UnitExplorer.UnitContent.BottomInfor(this)},loadItemPropertyTab:function(t){this.propertyTabContainerNode=new Element("div",{styles:this.item.style.tabTitleNode}).inject(this.propertyContentNode,"top"),MWF.require("MWF.widget.Tab",function(){this.propertyTab=new MWF.widget.Tab(this.propertyContentNode,{style:"unit"}),this.propertyTab.load(),this.propertyTab.tabNodeContainer.inject(this.propertyTabContainerNode),t&&t()}.bind(this))},_loadTabs:function(){this.baseContentNode=new Element("div",{styles:this.item.style.tabContentNode}),this.basePage=this.propertyTab.addTab(this.baseContentNode,this.explorer.app.lp.unitBaseText),this.personMemberContentNode=new Element("div",{styles:this.item.style.tabContentNode}),this.personMemberPage=this.propertyTab.addTab(this.personMemberContentNode,this.explorer.app.lp.unitPersonMembers),this.dutyContentNode=new Element("div",{styles:this.item.style.tabContentNode}),this.dutyPage=this.propertyTab.addTab(this.dutyContentNode,this.explorer.app.lp.unitDutys),this.data.control.allowEdit&&(this.attributeContentNode=new Element("div",{styles:this.item.style.tabContentNode}),this.attributePage=this.propertyTab.addTab(this.attributeContentNode,this.explorer.app.lp.unitAttribute))},_loadContent:function(){this._listBaseInfor(),this.loadListCount(),this._listIdentityMembers(),this._listDutys(),this.data.control.allowEdit&&this._listAttributes()},loadListCount:function(){var t=this.data.woSubDirectIdentityList.length;t?this.identityCountNode?this.identityCountNode.set("text",t):this.identityCountNode=new Element("div",{styles:this.item.style.tabCountNode,text:t}).inject(this.personMemberPage.tabNode):this.identityCountNode&&this.identityCountNode.destroy();var e=this.data.woUnitDutyList.length;if(e?this.dutyCountNode?this.dutyCountNode.set("text",e):this.dutyCountNode=new Element("div",{styles:this.item.style.tabCountNode,text:e}).inject(this.dutyPage.tabNode):this.dutyCountNode&&this.dutyCountNode.destroy(),this.data.control.allowEdit){var i=this.data.woUnitAttributeList.length;i?this.attributeCountNode?this.attributeCountNode.set("text",i):this.attributeCountNode=new Element("div",{styles:this.item.style.tabCountNode,text:i}).inject(this.attributePage.tabNode):this.attributeCountNode&&this.attributeCountNode.destroy()}},_listBaseInfor:function(){this.baseInfor=new MWF.xApplication.Org.UnitExplorer.UnitContent.BaseInfor(this)},_listDutys:function(){var t=this;this.dutyList=new MWF.xApplication.Org.List(this.dutyContentNode,this,{action:this.data.control.allowEdit,saveAction:"saveUnitduty",deleteAction:"deleteUnitduty",data:{description:"",name:"",unique:"",unit:this.data.id,orderNumber:"",identityList:[],woIdentityList:[]},attr:["name","description",{get:function(){return""},events:{init:function(){var e=this.td;if(this.item.list.options.action){var i=new Element("div",{styles:t.item.style.dutyIdentityAction}).inject(this.td);e=new Element("div",{styles:t.item.style.dutyIdentityContent}).inject(this.td),i.addEvent("click",function(){t.editDutyIdentity(this.data,e)}.bind(this))}var n=this.data;this.data.woIdentityList.each(function(i,s){new MWF.widget.O2Identity(i,e,{lazy:!0,canRemove:t.data.control.allowEdit,onRemove:function(e,i){t.deleteDutyIdentity(n,i,e)}})}.bind(this))},click:function(){}}}],onPostSave:function(t,e){t.data.id||(t.data.id=e,this.data.woUnitDutyList.push(t.data)),this.loadListCount()}.bind(this),onPostDelete:function(t){if(this.dutyCountNode){var e=this.dutyCountNode.get("text").toInt()-t;this.dutyCountNode.set("text",e)}}.bind(this)}),this.dutyList.load([{style:"width: 20%",text:this.explorer.app.lp.dutyName},{style:"",text:this.explorer.app.lp.description},{style:"width: 50%",text:this.explorer.app.lp.dutyMembers}]),this.data.woUnitDutyList.each(function(t){this.dutyList.push(t)}.bind(this))},editDutyIdentity:function(t,e){var i=this;MWF.xDesktop.requireApp("Selector","Identity",function(){new MWF.xApplication.Selector.Identity(this.explorer.app.content,{values:t.identityList,onComplete:function(n){var s=[],o=[];e.empty(),n.each(function(n,d){s.push(n.data),o.push(n.data.id),new MWF.widget.O2Identity(n.data,e,{canRemove:!0,onRemove:function(e,n){i.deleteDutyIdentity(t,n,e)}})}.bind(this)),t.identityList=o,t.woIdentityList=s,i.saveDuty(t)}.bind(this)}).load()}.bind(this))},deleteDutyIdentity:function(t,e,i){var n=this,s=this.explorer.app.lp.deleteDutyIdentity.replace(/{duty}/g,t.name);s=s.replace(/{identity}/g,i.data.name),this.explorer.app.confirm("warn",e,this.explorer.app.lp.deleteDutyIdentityTitle,s,"360","170",(function(){t.identityList.erase(i.data.id),t.woIdentityList=t.woIdentityList.filter((function(t){return i.data.id!==t.id})),n.saveDuty(t,(function(){i.destroy()})),this.close()}),(function(){this.close()}))},saveDuty:function(t,e){this.propertyContentScrollNode.mask({style:{opacity:.7,"background-color":"#999"}}),this.explorer.actions.saveUnitduty(t,function(){this.propertyContentScrollNode.unmask(),e&&e()}.bind(this),function(t,e,i){var n=i;t&&(n=t.responseText),this.explorer.app.notice("request json error: "+n,"error"),this.content.propertyContentScrollNode.unmask()}.bind(this))},_listAttributes:function(){this.attributeList=new MWF.xApplication.Org.List(this.attributeContentNode,this,{action:this.data.control.allowEdit,saveAction:"saveUnitattribute",deleteAction:"deleteUnitattribute",data:{description:"",name:"",unique:"",unit:this.data.id,orderNumber:"",attributeList:[]},attr:["name",{get:function(){return this.attributeList.join(",")},set:function(t){this.attributeList=t.split(/,\s*/g)}},"description"],onPostSave:function(t,e){t.data.id||(t.data.id=e,this.data.woUnitAttributeList.push(t.data)),this.loadListCount()}.bind(this),onPostDelete:function(t){if(this.attributeCountNode){var e=this.attributeCountNode.get("text").toInt()-t;this.attributeCountNode.set("text",e)}}.bind(this)}),this.attributeList.load([{style:"width: 20%",text:this.explorer.app.lp.attributeName},{style:"width: 45%",text:this.explorer.app.lp.attributeValue},{style:"",text:this.explorer.app.lp.description}]),this.data.woUnitAttributeList.each(function(t){this.attributeList.push(t)}.bind(this))},_listIdentityMembers:function(){var t=this;this.identityMemberList=new MWF.xApplication.Org.List(this.personMemberContentNode,this,{action:this.data.control.allowEdit,canEdit:!1,deleteAction:"deleteIdentity",deleteItemTitle:this.explorer.app.lp.deleteIdentityMemeberTitle,deleteItemText:this.explorer.app.lp.deleteIdentityMemeber,data:{},attr:[{getHtml:function(){return"<div style='width:24px; height:24px;''><img style='width:24px; height:24px; border-radius:12px; border: 0' src='"+t.explorer.actions.getPersonIcon(this.woPerson.id)+"'/></div>"},set:function(){}},{get:function(){return this.woPerson.name}},{get:function(){return this.woPerson.employee}},{get:function(){return this.woPerson.mobile}},{get:function(){return this.woPerson.mail}},{getHtml:function(){return"<div style='width:24px; height:24px; background:url(../x_component_Org/$Explorer/"+t.explorer.app.options.style+"/icon/open.png) center center no-repeat'></div>"},events:{click:function(){t.explorer.openPerson(this.data.woPerson,this.td)}}},{getHtml:function(){return"<div style='-webkit-user-select: none; -moz-user-select: none; width:24px; height:24px; cursor: move; background:url(../x_component_Org/$Explorer/"+t.explorer.app.options.style+"/icon/move.png) center center no-repeat'></div>"},events:{selectstart:function(t){return t.stopPropagation(),t.preventDefault(),!1},touchstart:function(e){t.startOrder(this.item,this.td,e)},mousedown:function(e){t.startOrder(this.item,this.td,e)}}}],onPostDelete:function(t){if(this.identityCountNode){var e=this.identityCountNode.get("text").toInt()-t;this.identityCountNode.set("text",e)}}.bind(this),onPostLoadAction:function(){this.sortAction=new Element("div",{styles:this.css.sortActionNode,text:t.explorer.app.lp.sortByPinYin}).inject(this.actionNode),this.sortAction.addEvent("click",(function(e){t.sortByPinYin(e)}))}}),this.identityMemberList.addItem=this.addPersonMember.bind(this),this.identityMemberList.load([{style:"width: 30px",text:""},{style:"width: 20%",text:this.explorer.app.lp.personName},{style:"",text:this.explorer.app.lp.personEmployee},{style:"",text:this.explorer.app.lp.personMobile},{style:"",text:this.explorer.app.lp.personMail},{style:"width: 10px",text:""},{style:"width: 10px",text:""}]),this.data.woSubDirectIdentityList.each(function(t){this.identityMemberList.push(t)}.bind(this))},sortByPinYin:function(t){var e=this;this.explorer.app.confirm("infor",t,this.explorer.app.lp.sortByPinYin,{html:this.explorer.app.lp.sortByPinYinConfirmContent},300,180,(function(){var t=e.data.woSubDirectIdentityList;t.sort((function(t,e){return t.name.localeCompare(e.name)}));for(var i=0;i<t.length;i++)e.explorer.actions.orderIdentity(t[i].id,"(0)",(function(){}),null,!1);e.identityMemberList.clear(),t.each(function(t){e.identityMemberList.push(t)}.bind(this)),this.close()}),(function(){this.close()}))},startOrder:function(t,e,i){var n=e.getParent("tr"),s=n.getParent("table"),o=e.getFirst("div"),d=n.getSize(),l=s.getElement("tr"),r=new Element("table",{styles:{opacity:.7,border:"1px dashed #999","z-index":1e4,width:d.x,height:d.y,"background-color":"#CCC",position:"absolute"}}).inject(this.explorer.app.content),a=n.clone().inject(r).getElements("td");l.getElements("th").each((function(t,e){a[e].setStyle("width",t.getSize().x+"px")})),r.position({relativeTo:n,position:"upperLeft",edge:"upperLeft"}),o.setStyle("display","none");var h={},p=n.getNext("tr");p&&(h=p.retrieve("data")),h||(h={});var c=new Drag.Move(r,{container:s,droppables:s.getElements("tr").erase(n),preventDefault:!0,stopPropagation:!0,onStart:function(){n.setStyles({display:"none","background-color":"#dff3fc"})}.bind(this),onEnter:function(t,e){n.inject(e,"after"),e.setStyles({background:"#fcf8f1"}),n.setStyles({display:"table-row"}),t.setStyles({display:"none"});var i=n.getNext("tr");(h=i?i.retrieve("data"):{})||(h={})},onLeave:function(t,e){e.setStyles({background:"transparent "}),n.setStyles({display:"none"}),t.setStyles({display:"block"})},onDrop:function(e,i,s){var d=n.getNext("tr");(h=d?d.retrieve("data"):{})||(h={}),r.destroy(),i.setStyles({background:"transparent "}),n.setStyles({background:"transparent "}),this.explorer.actions.orderIdentity(t.data.id,h.id||"(0)",(function(){})),o.setStyle("display","block")}.bind(this),onCancel:function(t){t.destroy(),c=null,o.setStyle("display","block")}});c.start(i)},addPersonMember:function(){this.checkSaveBaseInfor(function(){MWF.xDesktop.requireApp("Selector","Person",function(){new MWF.xApplication.Selector.Person(this.explorer.app.content,{values:[],onComplete:function(t){var e={description:"",name:"",unique:"",person:"",department:"",unit:this.data.id,orderNumber:""};t.each(function(t){var i=Object.clone(e);i.name=t.data.name,i.person=t.data.id,this.explorer.actions.saveIdentity(i,function(t){this.explorer.actions.getIdentity(function(t){this.data.woSubDirectIdentityList.push(t.data),this.identityMemberList.push(t.data),this.loadListCount()}.bind(this),null,t.data.id)}.bind(this))}.bind(this))}.bind(this)}).load()}.bind(this))}.bind(this))},checkSaveBaseInfor:function(t){this.data.id?t&&t():this.baseInfor&&"edit"===this.baseInfor.mode&&this.baseInfor.save(function(){t&&t()}.bind(this))}}),MWF.xApplication.Org.UnitExplorer.UnitContent.TitleInfor=new Class({Extends:MWF.xApplication.Org.$Explorer.ItemContent.TitleInfor,_getStyle:function(){var t=Object.clone(this.item.style.person);return Object.merge(t,this.item.style.role)},_getIcon:function(){return"../x_component_Org/$Explorer/default/icon/unit70.png"},setBackground:function(){this.titleBgNode.setStyle("background-image","url(../x_component_Org/$Explorer/"+this.explorer.app.options.style+"/icon/unit_bg_bg.png)"),this.titleNode.setStyle("background-image","url(../x_component_Org/$Explorer/"+this.explorer.app.options.style+"/icon/unit_bg.png)")},loadRightInfor:function(){var t=this.data.name;this.nameNode||(this.nameNode=new Element("div",{styles:this.style.titleInforNameNode}).inject(this.titleInforRightNode)),this.signatureNode||(this.signatureNode=new Element("div",{styles:this.style.titleInforSignatureNode}).inject(this.titleInforRightNode)),this.nameNode.set("text",t),this.signatureNode.set("text",this.data.levelName||"")}}),MWF.xApplication.Org.UnitExplorer.UnitContent.BottomInfor=new Class({Extends:MWF.xApplication.Org.$Explorer.ItemContent.BottomInfor,addInforList:function(){var t=this.explorer.app.lp.unitReadDn.replace(/{dn}/g,this.data.distinguishedName||" ");this.addInfor(t),t=(t=this.explorer.app.lp.unitReadLevel.replace(/{level}/g,this.data.level||" ")).replace(/{levelName}/g,this.data.levelName||" "),this.addInfor(t),t=(t=this.explorer.app.lp.unitReadCreate.replace(/{date}/g,this.data.createTime||" ")).replace(/{date2}/g,this.data.updateTime||" "),this.addInfor(t)}}),MWF.xApplication.Org.UnitExplorer.UnitContent.BaseInfor=new Class({initialize:function(t){this.content=t,this.item=t.item,this.data=this.item.data,this.explorer=this.item.explorer,this.contentNode=this.content.baseContentNode,this.style=this.item.style.person,this.attributes=[],this.mode="read",this.load()},load:function(){var t;this.node=new Element("div",{styles:this.style.baseContentNode}).inject(this.contentNode),this.editContentNode=new Element("div",{styles:this.style.baseEditNode}).inject(this.node),this.editContentNode.set("html",this.getContentHtml()),(t=this.editContentNode.getElement(".infor_name"))&&t.set("text",this.data.name||""),(t=this.editContentNode.getElement(".infor_unique"))&&t.set("text",this.data.unique||""),(t=this.editContentNode.getElement(".infor_type"))&&t.set("text",this.data.typeList.join(", ")||""),(t=this.editContentNode.getElement(".infor_shortName"))&&t.set("text",this.data.shortName||""),(t=this.editContentNode.getElement(".infor_description"))&&t.set("text",this.data.description||""),(t=this.editContentNode.getElement(".infor_orderNumber"))&&t.set("text",this.data.orderNumber||""),this.editContentNode.getElements("td.inforTitle").setStyles(this.style.baseInforTitleNode),this.editContentNode.getElements("td.inforContent").setStyles(this.style.baseInforContentNode),this.editContentNode.getElements("td.inforAction").setStyles(this.style.baseInforActionNode);var e=this.editContentNode.getElements("td.inforContent");this.data.control.allowEdit&&(this.data.controllerList&&this.data.controllerList.each(function(t){new MWF.widget.O2Person({name:t},e[5],{style:"xform"})}.bind(this)),this.data.superior&&new MWF.widget.O2Unit({name:this.data.superior},e[6],{style:"xform"})),this.loadAction()},getContentHtml:function(){var t="<table width='100%' cellpadding='3px' cellspacing='5px'>";return t+="<tr><td class='inforTitle'>"+this.explorer.app.lp.unitName+":</td><td class='inforContent infor_name'></td>",this.data.control.allowEdit&&(t+="<td class='inforTitle'>"+this.explorer.app.lp.unitUnique+":</td><td class='inforContent infor_unique'></td>"),t+="</tr><tr><td class='inforTitle'>"+this.explorer.app.lp.unitTypeList+":</td><td class='inforContent infor_type'></td><td class='inforTitle'>"+this.explorer.app.lp.unitShortName+":</td><td class='inforContent infor_shortName'></td></tr>",t+="<tr><td class='inforTitle'>"+this.explorer.app.lp.unitDescription+":</td><td colspan='3' class='inforContent infor_description'></td>",this.data.control.allowEdit&&(t+="<tr><td class='inforTitle'>"+this.explorer.app.lp.unitControllerList+":</td><td class='inforContent'></td><td class='inforTitle'>"+this.explorer.app.lp.unitSuperUnit+":</td><td class='inforContent'></td></tr>",t+="<tr><td class='inforTitle'>"+this.explorer.app.lp.orderNumber+":</td><td colspan='3' class='inforContent infor_orderNumber'></td></tr>"),t+="<tr><td colspan='4' class='inforAction'></td></tr>"},loadAction:function(){var t=this.editContentNode.getElements("td"),e=t[t.length-1];this.data.control.allowEdit&&(this.baseInforEditActionAreaNode=new Element("div",{styles:this.style.baseInforEditActionAreaNode}).inject(e),this.editNode=new Element("div",{styles:this.style.actionEditNode,text:this.explorer.app.lp.editUnit}).inject(this.baseInforEditActionAreaNode),this.saveNode=new Element("div",{styles:this.style.actionSaveNode,text:this.explorer.app.lp.saveUnit}).inject(this.baseInforEditActionAreaNode),this.cancelNode=new Element("div",{styles:this.style.actionCancelNode,text:this.explorer.app.lp.cancel}).inject(this.baseInforEditActionAreaNode),this.editNode.setStyle("display","block"),this.editNode.addEvent("click",this.edit.bind(this)),this.saveNode.addEvent("click",this.save.bind(this)),this.cancelNode.addEvent("click",this.cancel.bind(this)))},edit:function(){var t=this.editContentNode.getElements("td.inforContent");t[0].setStyles(this.style.baseInforContentNode_edit).empty(),this.nameInputNode=new Element("input",{styles:this.style.inputNode}).inject(t[0]),this.nameInputNode.set("value",this.data.name),t[1].setStyles(this.style.baseInforContentNode_edit).empty(),this.uniqueInputNode=new Element("input",{styles:this.style.inputNode}).inject(t[1]),this.uniqueInputNode.set("value",this.data.unique),t[2].setStyles(this.style.baseInforContentNode_edit).empty(),this.typeListInputNode=new Element("input",{styles:this.style.inputNode_type}).inject(t[2]),this.typeListInputNode.set("value",this.data.typeList.length?this.data.typeList.join(", "):""),this.loadUnitTypeSelect(),t[3].setStyles(this.style.baseInforContentNode_edit).empty(),this.shortNameInputNode=new Element("input",{styles:this.style.inputNode}).inject(t[3]),this.shortNameInputNode.set("value",this.data.shortName||""),t[4].setStyles(this.style.baseInforContentNode_edit).empty(),this.descriptionInputNode=new Element("input",{styles:this.style.inputNode}).inject(t[4]),this.descriptionInputNode.set("value",this.data.description||""),t[5].setStyles(this.style.baseInforContentNode_edit).empty(),this.controllerListInputNode=new Element("div",{styles:this.style.inputNode_person}).inject(t[5]),t[6].setStyles(this.style.baseInforContentNode_edit).empty(),this.superUnitInputNode=new Element("div",{styles:this.style.inputNode_person}).inject(t[6]),t[7].setStyles(this.style.baseInforContentNode_edit).empty(),this.orderNumberInputNode=new Element("input",{styles:this.style.inputNode,type:"number"}).inject(t[7]),this.orderNumberInputNode.set("value",this.data.orderNumber||""),this.data.superior&&new MWF.widget.O2Unit({name:this.data.superior},this.superUnitInputNode,{style:"xform"}),this.superUnitInputNode.addEvent("click",function(){MWF.xDesktop.requireApp("Selector","package",function(){var t={type:"unit",values:[this.data.superior]||[],count:1,onComplete:function(t){this.superUnitInputNode.empty(),this.data.oldSuperior=this.data.superior,t.length?(this.data.superior=t[0].data.id,new MWF.widget.O2Unit({name:this.data.superior},this.superUnitInputNode,{style:"xform"})):this.data.superior=""}.bind(this)};new MWF.O2Selector(this.explorer.app.content,t)}.bind(this))}.bind(this)),this.data.controllerList&&this.data.controllerList.each(function(t){new MWF.widget.O2Person({name:t},this.controllerListInputNode,{style:"xform"})}.bind(this)),this.controllerListInputNode.addEvent("click",function(){MWF.xDesktop.requireApp("Selector","package",function(){var t={type:"person",values:this.data.controllerList||[],count:0,onComplete:function(t){this.data.oldControllerList=this.data.controllerList;var e=[];this.controllerListInputNode.empty(),t.each(function(t){e.push(t.data.id),new MWF.widget.O2Person(t.data,this.controllerListInputNode,{style:"xform"})}.bind(this)),this.data.controllerList=e}.bind(this)};new MWF.O2Selector(this.explorer.app.content,t)}.bind(this))}.bind(this));var e=this;this.editContentNode.getElements("input").addEvents({focus:function(){"text"===this.get("type").toLowerCase()&&this.setStyles(e.style.inputNode_focus)},blur:function(){"text"===this.get("type").toLowerCase()&&this.setStyles(e.style.inputNode_blur)}}),this.mode="edit",this.editNode.setStyle("display","none"),this.saveNode.setStyle("display","block"),this.cancelNode.setStyle("display","block")},loadUnitTypeSelect:function(){this.typeListInputNode&&this.typeListInputNode.addEvents({blur:function(){this.hideTypeSelectNode()}.bind(this),click:function(){this.showTypeSelectNode()}.bind(this),focus:function(){this.showTypeSelectNode()}.bind(this)})},hideTypeSelectNode:function(){this.typeSelectNode&&this.typeSelectNode.destroy(),this.typeSelectNode=null},showTypeSelectNode:function(){if(!this.typeSelectNode){this.typeSelectNode=new Element("div",{styles:this.style.typeSelectNode}).inject(this.typeListInputNode,"after");var t=this.typeListInputNode.getSize().x-3;this.typeSelectNode.setStyle("width",t+"px"),this.typeSelectNode.position({relativeTo:this.typeListInputNode,position:"bottomLeft",edge:"upperLeft",offset:{x:1,y:-3}}),this.explorer.actions.listUnitType(function(t){var e=30*t.data.valueList.length;this.typeSelectNode.setStyle("height",e+"px"),t.data.valueList.each(function(t,e){this.createTypeSelectItem(t,e)}.bind(this))}.bind(this))}},createTypeSelectItem:function(t,e){var i=new Element("div",{styles:this.style.typeSelectItemNode}).inject(this.typeSelectNode);e%2==0&&i.setStyle("background","#f4f9ff");new Element("div",{styles:this.style.typeSelectItemIconNode}).inject(i);new Element("div",{styles:this.style.typeSelectItemTextNode}).inject(i).set("text",t);var n=this;i.addEvents({mouseover:function(){this.setStyle("background-color","#fef5e7")},mouseout:function(){this.setStyle("background","#ffffff"),e%2==0&&this.setStyle("background","#f4f9ff")},mousedown:function(){n.typeListInputNode.set("value",this.get("text"))}})},save:function(){this.editContentNode.getElements("td.inforContent");if(!this.nameInputNode.get("value"))return this.explorer.app.notice(this.explorer.app.lp.inputUnitInfor,"error",this.explorer.propertyContentNode),!1;this.content.propertyContentScrollNode.mask({style:{opacity:.7,"background-color":"#999"}}),this.saveUnit(function(){this.cancel(null,!0),this.content.propertyContentScrollNode.unmask()}.bind(this),function(t,e,i){var n=i;t&&(n=t.responseText),this.explorer.app.notice("request json error: "+n,"error"),this.content.propertyContentScrollNode.unmask()}.bind(this))},saveUnit:function(t,e){var i=Object.clone(this.data);i.name=this.nameInputNode.get("value"),i.unique=this.uniqueInputNode.get("value"),i.typeList=this.typeListInputNode.get("value")?this.typeListInputNode.get("value").split(/,\s*/g):[],i.shortName=this.shortNameInputNode.get("value"),i.description=this.descriptionInputNode.get("value"),i.orderNumber=this.orderNumberInputNode.get("value"),delete i.oldSuperior,delete i.oldControllerList,this.explorer.actions.saveUnit(i,function(e){Object.merge(this.data,i),this.data.id?(this.data.id=e.data.id,this.item.refresh(),t&&t()):this.explorer.actions.getUnit(function(e){this.data=Object.merge(this.data,e.data),this.item.data=this.data,this.item.refresh(),this.item.parent&&this.item.parent.subUnits.push(this.item),t&&t()}.bind(this),null,e.data.id)}.bind(this),function(t,i,n){e&&e(t,i,n)}.bind(this))},cancel:function(t,e){if(this.data.id){var i=this.editContentNode.getElements("td.inforContent");i[0].setStyles(this.style.baseInforContentNode).set("text",this.data.name||""),i[1].setStyles(this.style.baseInforContentNode).set("text",this.data.unique||""),i[2].setStyles(this.style.baseInforContentNode).set("text",this.data.typeList.length?this.data.typeList.join(", "):""),i[3].setStyles(this.style.baseInforContentNode).set("text",this.data.shortName||""),i[4].setStyles(this.style.baseInforContentNode).set("text",this.data.description||""),i[5].setStyles(this.style.baseInforContentNode).empty(),i[6].setStyles(this.style.baseInforContentNode).empty(),i[7].setStyles(this.style.baseInforContentNode).set("text",this.data.orderNumber||""),e||(this.data.oldSuperior&&(this.data.superior=this.data.oldSuperior),this.data.oldControllerList&&(this.data.controllerList=this.data.oldControllerList)),delete this.data.oldSuperior,delete this.data.oldControllerList,this.data.superior&&new MWF.widget.O2Unit({name:this.data.superior},i[6],{style:"xform"}),this.data.controllerList&&this.data.controllerList.each(function(t){new MWF.widget.O2Person({name:t},i[5],{style:"xform"})}.bind(this)),this.mode="read",this.editNode.setStyle("display","block"),this.saveNode.setStyle("display","none"),this.cancelNode.setStyle("display","none")}else this.item.destroy()},destroy:function(){this.node.empty(),this.node.destroy(),MWF.release(this)}});