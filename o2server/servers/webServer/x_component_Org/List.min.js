MWF.xApplication.Org.List=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",action:!1,canEdit:!0,data:{name:"",attributeList:[""]},attr:[],saveAction:"savePersonAttribute",deleteAction:"removePersonAttribute",deleteItemTitle:MWF.xApplication.Org.LP.deleteAttributeTitle,deleteItemText:MWF.xApplication.Org.LP.deleteAttribute},_loadPath:function(){this.path="../x_component_Org/$List/",this.cssPath="../x_component_Org/$List/"+this.options.style+"/css.wcss"},initialize:function(t,e,s){this.setOptions(s),this._loadPath(),this._loadCss(),this.content=e,this.contentNode=$(t),this.items=[],this.selectedItems=[]},load:function(t){this.headers=t;var e="<table cellspacing='0' cellpadding='5' border='0' width='80%' align='center' style='line-height:normal; clear: both;'>";e+="<tr><th style='width:20px'></th>",t.each(function(t){e+="<th style='"+t.style+"'>"+t.text+"</th>"}.bind(this)),e+="</table>",this.contentNode.set("html",e),this.loadAction(),this.table=new HtmlTable(this.contentNode.getFirst("table")),this.contentNode.getElements("th").setStyles(this.css.listTitle)},loadAction:function(){this.actionAreaNode=new Element("div",{styles:this.css.actionAreaNode}).inject(this.contentNode,"top"),this.options.action&&(this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.actionAreaNode),this.deleteAction=new Element("div",{styles:this.css.deleteActionNode_disabled,text:this.content.explorer.app.lp.delete}).inject(this.actionNode),this.addAction=new Element("div",{styles:this.css.addActionNode,text:this.content.explorer.app.lp.add}).inject(this.actionNode),this.addAction.addEvent("click",function(){this.addItem()}.bind(this)),this.deleteAction.addEvent("click",function(t){this.deleteItem(t)}.bind(this)),this.fireEvent("postLoadAction"))},addItem:function(){var t=Object.clone(this.options.data),e=new MWF.xApplication.Org.List.Item(t,this.options.attr,this);this.items.push(e),e.edit(e.tr.tds[1])},deleteItem:function(t){if(this.selectedItems.length){this.fireEvent("queryDelete");var e=this;this.content.explorer.app.confirm("infor",t,this.options.deleteItemTitle,this.options.deleteItemText,350,120,(function(){this.close();var t=0;e.selectedItems.each(function(s){s.delete((function(){t++,function(){if(t===e.selectedItems.length){for(e.fireEvent("delete",!0),1;e.selectedItems.length;){e.selectedItems[0].destroy()}e.fireEvent("postDelete",t)}}()}))}.bind(this))}),(function(){this.close()}))}},push:function(t){var e=this.items.push(new MWF.xApplication.Org.List.Item(t,this.options.attr,this));return this.items[e-1]},setAction:function(){this.selectedItems.length?this.deleteAction.setStyles(this.css.deleteActionNode):this.deleteAction.setStyles(this.css.deleteActionNode_disabled)},clear:function(){this.items=[],this.selectedItems=[];for(var t=this.contentNode.getFirst("table");t.rows.length>1;)t.rows[t.rows.length-1].destroy()}}),MWF.xApplication.Org.List.Item=new Class({initialize:function(t,e,s){this.data=t,this.attr=e,this.list=s,this.css=this.list.css,this.load()},reload:function(t){this.data=t,this.tr.tds.each(function(t,e){if(0===e&&(this.selectTd=t),e>0){var s=this.attr[e-1];if("object"===typeOf(s))s.get?t.set("text",s.get.apply(this.data)):t.set("text","");else if("string"===typeOf(s))if("icon"===s)t.set("html","<div></div>");else{var i=this.data[s];"array"===typeOf(i)&&(i=i.join(",")),t.set("text",i)}else t.set("text","");s.events&&s.events.init&&s.events.init.apply({item:this,data:this.data,td:t,item:this})}t.setStyles(this.css.contentTdNode),t.set("title",t.get("text"))}.bind(this))},load:function(){var t=[""];this.attr.each(function(e){if("object"===typeOf(e))if(e.get)s=(s=(s=e.get.apply(this.data)||"").replace(/\</g,"&lt;")).replace(/\</g,"&gt;"),t.push(s);else if(e.getHtml){var s=e.getHtml.apply(this.data);t.push(s)}else t.push("");else"string"===typeOf(e)?"icon"===e?t.push("<div>cc</div>"):t.push(this.data[e]):t.push("")}.bind(this)),this.tr=this.list.table.push(t,{styles:this.css.contentTrNode}),this.tr.tr.store("data",this.data);var e=this;this.tr.tds.each(function(t,s){if(t.setStyles(this.css.contentTdNode),t.set("title",t.get("text")),0===s&&(this.selectTd=t),s>0){(this.list.options.action||this.list.options.canEdit)&&(t.store("attr",this.attr[s-1]),this.list.options.canEdit&&t.addEvent("click",(function(){e.edit(this)})));var i=this.attr[s-1];i.events&&(t.removeEvents("click"),Object.each(i.events,function(e,s){"init"!==s.toLowerCase&&t.addEvent(s,e.bind({data:this.data,td:t,item:this}))}.bind(this)),i.events.init&&i.events.init.apply({item:this,data:this.data,td:t,item:this}))}}.bind(this)),this.list.options.action?(this.selectTd.setStyles(this.css.selectTdNode),this.selectTd.addEvent("click",function(){this.isSelected?this.unSelected():this.selected()}.bind(this))):this.selectTd.setStyles(this.css.blankTdNode)},edit:function(t){var e=t.retrieve("attr"),s=t.get("text");t.empty();var i=new Element("input",{styles:this.css.inputNode,value:s}).inject(t);t.removeEvents("click");var n=this;i.focus(),i.addEvents({blur:function(){var i=this.get("value");i&&("object"===typeOf(e)?e.set&&e.set.apply(n.data,[i]):"string"===typeOf(e)&&(n.data[e]=i)),n.editCompleted(t,i,s)}})},editCompleted:function(t,e,s){t.empty(),e||s?e?(t.set("text",e),e!==s&&this.save(t)):1===t.cellIndex?t.set("text",s):(t.set("text",e),e!==s&&this.save(t)):1===t.cellIndex&&this.destroy();var i=this;this.list.options.canEdit&&t.addEvent("click",(function(){i.edit(this)}))},delete:function(t){this.list.content.explorer.actions[this.list.options.deleteAction](this.data.id,function(){t&&t()}.bind(this))},destroy:function(){this.list.items.erase(this),this.isSelected&&this.unSelected(),this.list.setAction(),this.tr.tr.destroy(),MWF.release(this)},save:function(t){this.list.content.explorer.actions[this.list.options.saveAction](this.data,function(t){this.list.fireEvent("postSave",[this,t.data.id]),this.data.id=t.data.id}.bind(this),function(e,s,i){t.set("text",""),this.edit(t),this.list.content.explorer.app.notice(JSON.decode(e.responseText).message.trim()||"request json error","error")}.bind(this))},selected:function(){this.selectTd.setStyles(this.css.selectTdNode_selected),this.tr.tr.setStyles(this.css.contentTrNode_selected),this.list.selectedItems.push(this),this.isSelected=!0,this.list.setAction()},unSelected:function(){this.selectTd.setStyles(this.css.selectTdNode),this.tr.tr.setStyles(this.css.contentTrNode),this.list.selectedItems.erase(this),this.isSelected=!1,this.list.setAction()}});