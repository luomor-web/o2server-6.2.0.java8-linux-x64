MWF.xApplication=MWF.xApplication||{},MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.StatementDesigner=MWF.xApplication.query.StatementDesigner||{},MWF.APPDSMD=MWF.xApplication.query.StatementDesigner,MWF.xDesktop.requireApp("query.StatementDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("query.StatementDesigner","Property",null,!1),MWF.xDesktop.requireApp("query.ViewDesigner","View",null,!1),o2.require("o2.widget.JavascriptEditor",null,!1),o2.require("o2.widget.UUID",null,!1),MWF.xApplication.query.StatementDesigner.Statement=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_query_StatementDesigner/$Statement/statement.html"},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_query_StatementDesigner/$Statement/",this.cssPath="../x_component_query_StatementDesigner/$Statement/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=t,this.data=e,this.parseData(),this.node=this.designer.designNode,this.areaNode=new Element("div",{styles:{height:"100%",overflow:"auto"}}),this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewStatement=!this.data.id,this.view=this,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},parseData:function(){this.json=this.data,this.json.type||(this.json.type="select"),this.json.format||(this.json.format="jpql"),this.json.entityCategory||(this.json.entityCategory="official"),this.json.entityClassName||(this.json.entityClassName="")},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4)},getDefaultEditorData:function(){return{javascriptEditor:{monaco_theme:"vs",fontSize:"12px",editor:"monaco"}}},getEditorTheme:function(t){o2.editorData?t&&t():o2.UD.getData("editor",function(e){e.data?o2.editorData=JSON.decode(e.data):o2.editorData=this.getDefaultEditorData(),t&&t()}.bind(this))},load:function(){this.getEditorTheme(function(){this._load()}.bind(this))},_load:function(){this.areaNode.inject(this.node),this.designer.statementListAreaNode.getChildren().each(function(t){t.retrieve("statement").id==this.data.id&&(this.designer.currentListStatementItem&&this.designer.currentListStatementItem.setStyles(this.designer.css.listStatementItem),t.setStyles(this.designer.css.listStatementItem_current),this.designer.currentListStatementItem=t,this.lisNode=t)}.bind(this)),this.loadStatement(),this.selected()},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this)return!0;this.currentSelectedModule.unSelected()}this.view&&this.view.domListNode&&this.view.domListNode.hide(),this.currentSelectedModule=this,this.isSelected=!0,this.showProperty()},unSelected:function(){this.currentSelectedModule=null,this.isSelected=!1,this.hideProperty()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatementDesigner.Property(this,this.designer.designerContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},loadJpqlTab:function(t){MWF.require("MWF.widget.Tab",null,!1),this.jpqlTab=new MWF.widget.Tab(this.jpqlTabNode,{style:"script"}),this.jpqlTab.load(),this.tabJpqlNode=Element("div"),this.jpqlTabPageNode.inject(this.tabJpqlNode),this.tabCountJpqlNode=Element("div"),this.countJpqlTabPageNode.inject(this.tabCountJpqlNode),this.jpqlPage=this.jpqlTab.addTab(this.tabJpqlNode,this.designer.lp.queryStatement),this.countJpqlPage=this.jpqlTab.addTab(this.tabCountJpqlNode,this.designer.lp.countStatement),this.jpqlPage.showTabIm()},loadTab:function(t){MWF.require("MWF.widget.Tab",null,!1),this.tab=new MWF.widget.Tab(this.tabNode,{style:"script"}),this.tab.load(),this.tabRunNode=Element("div"),this.pageRunNode=new Element("div",{styles:{overflow:"auto","background-color":"#fff"}}).inject(this.tabRunNode),this.runArea.inject(this.pageRunNode),this.tabViewNode=Element("div",{styles:{height:"100%"}}),this.pageViewNode=new Element("div.pageViewNode").inject(this.tabViewNode),this.viewArea.inject(this.pageViewNode),this.runPage=this.tab.addTab(this.tabRunNode,this.designer.lp.runTest),this.viewPage=this.tab.addTab(this.tabViewNode,this.designer.lp.view),this.runPage.showTabIm(),this.viewPage.addEvent("postShow",function(){this.view&&(this.view.setContentHeight(),this.view.selected())}.bind(this)),this.runPage.addEvent("postShow",function(){this.selected()}.bind(this))},loadStatement:function(){this.loadStatementHtml(function(){this.designerArea=this.areaNode.getElement(".o2_statement_statementDesignerNode"),this.jpqlTabPageNode=this.areaNode.getElement(".o2_statement_statementJpqlTabPageNode"),this.jpqlArea=this.areaNode.getElement(".o2_statement_statementDesignerJpql"),this.scriptArea=this.areaNode.getElement(".o2_statement_statementDesignerScript"),this.formatTypeArea=this.areaNode.getElement(".o2_statement_statementDesignerFormatContent"),this.entityCategorySelect=this.areaNode.getElement(".o2_statement_statementDesignerCategoryContent").getElement("select"),this.dynamicTableArea=this.areaNode.getElement(".o2_statement_statementDesignerTableArea_dynamic"),this.officialTableArea=this.areaNode.getElement(".o2_statement_statementDesignerTableArea_official"),this.customTableArea=this.areaNode.getElement(".o2_statement_statementDesignerTableArea_custom"),this.dynamicTableSelect=this.areaNode.getElement(".o2_statement_statementDesignerSelectTable"),this.officialTableSelect=this.officialTableArea.getElement("select"),this.fieldSelect=this.areaNode.getElement(".o2_statement_statementDesignerTableArea_field").getElement("select"),this.loadFieldSelect(),this.dynamicTableContent=this.areaNode.getElement(".o2_statement_statementDesignerTableContent"),this.jpqlTabNode=this.areaNode.getElement(".o2_statement_statementJpqlTabNode"),this.jpqlTypeSelect=this.areaNode.getElement(".o2_statement_statementDesignerTypeContent").getElement("select"),this.loadJpqlTypeSelect(),this.jpqlEditorNode=this.areaNode.getElement(".o2_statement_statementDesignerJpqlLine"),this.countJpqlTabPageNode=this.areaNode.getElement(".o2_statement_statementCountJpqlTabPageNode"),this.countJpqlArea=this.areaNode.getElement(".o2_statement_statementDesignerCountJpql"),this.countScriptArea=this.areaNode.getElement(".o2_statement_statementDesignerCountScript"),this.countJpqlEditorNode=this.areaNode.getElement(".o2_statement_statementDesignerCountJpqlLine"),this.loadJpqlTab(),this.resizeNode=this.areaNode.getElement(".o2_statement_resizeNode"),this.tabNode=this.areaNode.getElement(".o2_statement_tabNode"),this.runArea=this.areaNode.getElement(".o2_statement_statementRunNode"),this.runContentNode=this.areaNode.getElement(".o2_statement_statementRunContentNode"),this.runJsonNode=this.runContentNode.getFirst(),this.runActionNode=this.runJsonNode.getNext(),this.runResultNode=this.runContentNode.getLast(),this.setRunnerSize(),this.designer.addEvent("resize",this.setRunnerSize.bind(this)),"script"==this.json.format?(this.loadStatementScriptEditor(),this.loadStatementCountScriptEditor()):(this.loadStatementEditor(),this.loadStatementCountEditor()),this.loadStatementRunner(),this.viewArea=this.areaNode.getElement(".o2_statement_viewNode"),this.loadView(),this.loadTab(),this.setEvent(),this.loadVerticalResize()}.bind(this))},loadJpqlTypeSelect:function(){this.jpqlTypeSelect.empty();var t=[{text:"SELECT",value:"select"}];("dynamic"===this.data.entityCategory||this.data.description&&this.data.description.indexOf("update")>-1)&&(t=t.concat([{text:"UPDATE",value:"update"},{text:"DELETE",value:"delete"}]));var e=!0;t.each(function(t){var i=new Element("option",{text:t.text,value:t.value}).inject(this.jpqlTypeSelect);this.json.type===t.value&&(e=!1,i.selected=!0)}.bind(this)),e&&(this.jpqlTypeSelect.options[0].selected=!0,this.json.type=this.jpqlTypeSelect.options[0].value,this.jpqlTypeSelect.fireEvent("change"))},loadFieldSelect:function(){this.fieldSelect.empty();var t=this.data,e="dynamic"===t.entityCategory?t.table:t.entityClassName;e&&o2.Actions.load("x_query_assemble_designer").QueryAction.getEntityProperties(e,t.entityCategory,function(i){var s=new Element("option",{text:this.designer.lp.fileldSelectNote,value:""}).inject(this.fieldSelect);s.store("type",t.entityCategory),s.store("tableName",e),(i.data||[]).each(function(i){var s=new Element("option",{text:i.name+(i.description?"-"+i.description:""),value:i.name}).inject(this.fieldSelect);s.store("field",i),s.store("type",t.entityCategory),s.store("tableName",e)}.bind(this))}.bind(this))},loadVerticalResize:function(){this.verticalResize=new Drag(this.resizeNode,{snap:10,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,s="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var n=this.designerArea.getSize();t.store("initialHeight",n.y);var o=this.areaNode.getSize();t.store("initialAllHeight",o.y)}.bind(this),onDrag:function(t,e){var i=t.retrieve("initialAllHeight").toFloat(),s="firefox"==Browser.name?e.event.clientY:e.event.y,n=t.retrieve("position"),o=s.toFloat()-n.y.toFloat(),a=t.retrieve("initialHeight").toFloat()+o;a<180&&(a=180),a>i-180&&(a=i-180),this.designerAreaPercent=a/i,this.setVerticalResize()}.bind(this)})},setVerticalResize:function(){var t=this.areaNode.getSize().y,e=this.designerAreaPercent*t-52;this.designerArea.setStyle("height",e+"px");var i=e-98;this.jpqlEditorNode&&this.jpqlEditorNode.setStyle("height",i+"px"),this.countJpqlEditorNode&&this.countJpqlEditorNode.setStyle("height",i+"px"),this.scriptArea&&this.scriptArea.setStyle("height",i+"px"),this.countScriptArea&&this.countScriptArea.setStyle("height",i+"px"),this.editor&&this.editor.resize(),this.countEditor&&this.countEditor.resize(),this.scriptEditor&&(this.scriptEditor.container.setStyle("height",i+"px"),this.scriptEditor.resizeContentNodeSize()),this.countScriptEditor&&(this.countScriptEditor.container.setStyle("height",i+"px"),this.countScriptEditor.resizeContentNodeSize()),this.setRunnerSize(),this.view&&(this.setViewSize(),this.view.setContentHeight())},loadStatementScriptEditor:function(){this.scriptEditor||o2.require("o2.widget.ScriptArea",function(){this.scriptEditor=new o2.widget.ScriptArea(this.scriptArea,{isbind:!1,maxObj:this.designer.designNode,title:this.designer.lp.scriptTitle,onChange:function(){this.json.scriptText=this.scriptEditor.toJson().code}.bind(this)}),this.scriptEditor.load({code:this.json.scriptText})}.bind(this),!1)},loadStatementCountScriptEditor:function(){this.countScriptEditor||o2.require("o2.widget.ScriptArea",function(){this.countScriptEditor=new o2.widget.ScriptArea(this.countScriptArea,{isbind:!1,maxObj:this.designer.designNode,title:this.designer.lp.scriptTitle,onChange:function(){this.json.countScriptText=this.countScriptEditor.toJson().code}.bind(this)}),this.countScriptEditor.load({code:this.json.countScriptText})}.bind(this),!1)},setRunnerSize:function(){var t=this.areaNode.getSize(),e=this.designerArea.getComputedSize(),i=this.resizeNode.getComputedSize(),s=t.y-e.totalHeight-i.totalHeight;s=s-this.runArea.getStyle("margin-top").toInt()-this.runArea.getStyle("margin-bottom").toInt()-this.runArea.getStyle("padding-top").toInt()-this.runArea.getStyle("padding-bottom").toInt()-5,s-=this.tabNode.getComputedSize().totalHeight,this.runArea.setStyle("height",s+"px"),this.runContentNode.setStyle("height",s+"px")},loadStatementEditor:function(){if(!this.editor){var t;if(!this.json.data){switch(this.json.type){case"update":t="UPDATE table o SET ";break;case"delete":t="DELETE table o WHERE ";break;default:t="SELECT o FROM table o"}this.json.data=t}if(null===this.jpqlEditorNode.offsetParent&&"monaco"===o2.editorData.javascriptEditor.editor){var e=function(){this._loadStatementEditor(),this.jpqlPage.removeEvent("postShow",e)}.bind(this);this.jpqlPage.addEvent("postShow",e)}else this._loadStatementEditor()}},_loadStatementEditor:function(){this.editor||o2.require("o2.widget.JavascriptEditor",function(){this.editor=new o2.widget.JavascriptEditor(this.jpqlEditorNode,{title:"JPQL",option:{mode:"sql"}}),this.editor.load(function(){this.editor.editor.setValue(this.json.data),this.editor.addEditorEvent("change",function(){this.data.data=this.editor.getValue(),this.checkJpqlType()}.bind(this))}.bind(this))}.bind(this),!1)},loadStatementCountEditor:function(){if(!this.countEditor)if(this.json.countData||(this.json.countData="SELECT count(o.id) FROM table o"),null===this.countJpqlEditorNode.offsetParent&&"monaco"===o2.editorData.javascriptEditor.editor){var t=function(){this._loadStatementCountEditor(),this.countJpqlPage.removeEvent("postShow",t)}.bind(this);this.countJpqlPage.addEvent("postShow",t)}else this._loadStatementCountEditor()},_loadStatementCountEditor:function(){o2.require("o2.widget.JavascriptEditor",function(){this.countEditor=new o2.widget.JavascriptEditor(this.countJpqlEditorNode,{title:"JPQL",option:{mode:"sql"}}),this.countEditor.load(function(){this.countEditor.editor.setValue(this.json.countData),this.countEditor.addEditorEvent("change",function(){this.data.countData=this.countEditor.getValue()}.bind(this))}.bind(this))}.bind(this),!1)},setSatementTable:function(){if(this.json.type||(this.json.type="select"),this.changeType(this.json.type,!0),this.editor&&this.editor.editor)if(this.json.data)this.editor.editor.setValue(this.json.data);else{var t=this.json.tableObj?this.json.tableObj.name:"table";switch(this.json.type){case"update":this.editor.editor.setValue("UPDATE "+t+" o SET ");break;case"delete":this.editor.editor.setValue("DELETE "+t+" o WHERE ");break;default:this.editor.editor.setValue("SELECT o FROM "+t+" o")}}},checkJpqlType:function(){var t=this.json.data;this.json.data=t;return/^select/i.test(t)?this.changeType("select"):/^update/i.test(t)?this.changeType("update"):/^delete/i.test(t)?this.changeType("delete"):void 0},changeType:function(t,e){if(this.json.type!=t&&(this.json.type=t),t!=this.jpqlTypeSelect.options[this.jpqlTypeSelect.selectedIndex].value||e)for(var i=0;i<this.jpqlTypeSelect.options.length;i++)if(this.jpqlTypeSelect.options[i].value==t){this.jpqlTypeSelect.options[i].set("selected",!0);break}},loadStatementHtml:function(t){this.areaNode.loadAll({css:this.path+this.options.style+"/statement.css",html:this.path+"statementDesigner.html"},{bind:{lp:this.designer.lp,data:this.data}},function(){t&&t()}.bind(this))},loadStatementRunner:function(){o2.require("o2.widget.JavascriptEditor",function(){this.jsonEditor=new o2.widget.JavascriptEditor(this.runJsonNode,{title:"JPQL",option:{mode:"json"}}),this.jsonEditor.load(function(){this.jsonEditor.editor.setValue(this.data.testParameters||"{}")}.bind(this))}.bind(this),!1)},setEvent:function(){this.designerArea.addEvent("click",function(t){this.selected(),t.stopPropagation()}.bind(this)),this.formatTypeArea.getElements("input").addEvent("click",function(t){if(t.target.checked){var e=t.target.get("value");"script"===e?(this.scriptArea.show(),this.jpqlArea.hide(),this.loadStatementScriptEditor(),this.countScriptArea.show(),this.countJpqlArea.hide(),this.loadStatementCountScriptEditor()):(this.scriptArea.hide(),this.jpqlArea.show(),this.loadStatementEditor(),this.countScriptArea.hide(),this.countJpqlArea.show(),this.loadStatementCountEditor()),this.json.format=e}}.bind(this)),this.entityCategorySelect.addEvent("change",function(t){var e=t.target.options[t.target.selectedIndex].value;switch(e){case"dynamic":this.officialTableArea.hide(),this.dynamicTableArea.show(),this.customTableArea.hide();break;case"custom":this.officialTableArea.hide(),this.dynamicTableArea.hide(),this.customTableArea.show();break;default:this.officialTableArea.show(),this.dynamicTableArea.hide(),this.customTableArea.hide()}this.json.entityCategory=e,this.loadJpqlTypeSelect(),this.loadFieldSelect(),this.view&&this.view.property&&this.view.property.viewFilter&&this.view.property.viewFilter.setPathInputSelectOptions()}.bind(this)),this.officialTableSelect.addEvent("change",function(t){var e=t.target.options[t.target.selectedIndex].value;this.json.entityClassName=e,e&&this.changeEditorEntityClassName(e.split(".").getLast()),this.loadFieldSelect(),this.json.table="",this.json.tableObj=null,this.view&&this.view.property&&this.view.property.viewFilter&&this.view.property.viewFilter.setPathInputSelectOptions()}.bind(this)),this.runActionNode.getFirst().addEvent("click",this.runStatement.bind(this)),this.dynamicTableSelect.addEvent("click",this.selectTable.bind(this)),this.jpqlTypeSelect.addEvent("change",function(){var t=this.jpqlTypeSelect.options[this.jpqlTypeSelect.selectedIndex].value;t!=this.json.type&&(this.json.type=t),"select"!=t?(this.jpqlPage.showTabIm(),this.countJpqlPage.disableTab(),this.runPage.showTabIm(),this.viewPage.disableTab()):(this.countJpqlPage.enableTab(!0),this.viewPage.enableTab(!0))}.bind(this)),this.fieldSelect.addEvent("change",function(t){var e=t.target.options[t.target.selectedIndex],i=(e.retrieve("type"),e.retrieve("field"));if(i){var s=i.name;this.countJpqlPage&&this.countJpqlPage.isShow&&!this.countJpqlPage.disabled?"script"===this.data.format&&this.countScriptEditor.jsEditor?this.countScriptEditor.jsEditor.insertValue(s):this.countEditor&&this.countEditor.insertValue(s):"script"===this.data.format&&this.scriptEditor.jsEditor?this.scriptEditor.jsEditor.insertValue(s):this.editor&&this.editor.insertValue(s)}}.bind(this))},changeEditorEntityClassName:function(t){if("jpql"==this.json.format){if(this.editor){var e=/(.*from\s*)/gi;"update"==this.json.type&&(e=/(.*update\s*)/gi);var i=this.json.data;if((o=e.exec(i))&&o[0]){var s=o[0],n=(i=i.substring(s.length,i.length)).substring(i.indexOf(" "),i.length);this.json.data=s+t+n,this.editor.editor.setValue(this.json.data)}}if(this.countEditor){var o;e=/(.*from\s*)/gi,i=this.json.countData;if((o=e.exec(i))&&o[0]){s=o[0],n=(i=i.substring(s.length,i.length)).substring(i.indexOf(" "),i.length);this.json.countData=s+t+n,this.countEditor.editor.setValue(this.json.countData)}}}},selectTable:function(){new MWF.O2Selector(this.designer.content,{type:"queryTable",count:1,values:this.json.table?[this.json.table]:[],title:this.designer.lp.selectTable,onComplete:function(t){if(t.length){t[0].data.id;var e=t[0].data.name;this.dynamicTableContent.set("text",e),this.json.table=e,this.json.tableObj=t[0].data,this.officialTableSelect.options[0].set("selected",!0),this.json.entityClassName="",this.changeEditorEntityClassName(e),this.loadFieldSelect(),this.view&&this.view.property&&this.view.property.viewFilter&&this.view.property.viewFilter.setPathInputSelectOptions()}else this.dynamicTableContent.set("text",""),this.json.table="",this.loadFieldSelect(),this.view&&this.view.property&&this.view.property.viewFilter&&this.view.property.viewFilter.setPathInputSelectOptions()}.bind(this)})},runStatement:function(){this.saveSilence(function(){this.execute(function(t){if(this.executeData=t,o2.require("o2.widget.JsonParse",function(){this.runResultNode.empty(),new o2.widget.JsonParse(t,this.runResultNode).load()}.bind(this)),this.view){var e=!0;"select"!==this.data.type&&(e=!1),"script"!==this.data.format||this.data.scriptText||(e=!1),"script"===this.data.format||this.data.data||(e=!1),e&&this.view.loadViewData()}this.setColumnDataPath(t)}.bind(this),function(){}.bind(this))}.bind(this))},setColumnDataPath:function(t){if("select"===this.data.type&&("script"!==this.data.format||this.data.scriptText)&&("script"===this.data.format||this.data.data)){this.columnDataPathList=[];for(var e=function(t,i){"array"===typeOf(t)?Array.each(t,function(t,s){var n=i||"number"===typeOf(i)?i+"."+s:s.toString();this.columnDataPathList.contains(n)||this.columnDataPathList.push(n),"array"!==typeOf(t)&&"object"!==typeOf(t)||e(t,n)}.bind(this)):"object"===typeOf(t)&&Object.each(t,function(t,s){var n=i||"number"===typeOf(i)?i+"."+s:s;this.columnDataPathList.contains(n)||this.columnDataPathList.push(n),"array"!==typeOf(t)&&"object"!==typeOf(t)||e(t,n),e(t,n)}.bind(this))}.bind(this),i=0;i<t.data.length&&i<10;i++){var s=t.data[i];e(s)}this.columnDataPathList.sort(),this.view&&this.view.items&&this.view.items.each((function(t){t.refreshColumnPathData()}))}},getColumnDataPath:function(){return this.columnDataPathList||[]},execute:function(t,e){var i=this.jsonEditor.editor.getValue(),s=JSON.parse(i),n="data";if("select"===this.data.type)if("script"===this.data.format)if(this.data.scriptText&&this.data.countScriptText)n="all";else if(this.data.scriptText&&!this.data.countScriptText)n="data";else{if(this.data.scriptText||!this.data.countScriptText)return this.designer.notice(this.designer.lp.inputStatementData,"error"),!1;n="count"}else if(this.data.data&&this.data.countData)n="all";else if(this.data.data&&!this.data.countData)n="data";else{if(this.data.data||!this.data.countData)return this.designer.notice(this.designer.lp.inputStatementData,"error"),!1;n="count"}o2.Actions.load("x_query_assemble_designer").StatementAction.executeV2(this.json.id,n,1,50,s,function(e){t&&t(e)}.bind(this),function(t,i,s){e&&e();var n=s;if(t){var o=JSON.decode(t.responseText);n=o?o.message.trim()||"request json error":"request json error: "+t.responseText}n=(n=n.replace(/\</g,"&lt;")).replace(/\</g,"&gt;"),MWF.xDesktop.notice("error",{x:"right",y:"top"},n)}.bind(this))},save:function(t){if(!this.data.name)return this.designer.notice(this.designer.lp.inputStatementName,"error"),!1;"object"===typeOf(this.viewJson)&&(this.viewJson.data&&!this.viewJson.data.group&&(this.viewJson.data.group={}),this.viewJson.pageSize||(this.viewJson.pageSize="20"),this.data.view=JSON.stringify(this.viewJson)),this.editor&&(this.data.data=this.editor.editor.getValue()),this.scriptEditor&&(this.data.scriptText=this.scriptEditor.toJson().code),this.jsonEditor&&(this.data.testParameters=this.jsonEditor.editor.getValue()),this.designer.actions.saveStatement(this.data,function(e){this.designer.notice(this.designer.lp.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),t&&t()}.bind(this))},_setEditStyle:function(){},saveSilence:function(t){if(!this.data.name)return this.designer.notice(this.designer.lp.inputStatementName,"error"),!1;"object"===typeOf(this.viewJson)&&(this.viewJson.data&&!this.viewJson.data.group&&(this.viewJson.data.group={}),this.viewJson.pageSize||(this.viewJson.pageSize="20"),this.data.view=JSON.stringify(this.viewJson)),this.editor&&(this.data.data=this.editor.editor.getValue()),this.scriptEditor&&(this.data.scriptText=this.scriptEditor.toJson().code),this.jsonEditor&&(this.data.testParameters=this.jsonEditor.editor.getValue()),this.designer.actions.saveStatement(this.data,function(e){this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),t&&t()}.bind(this))},loadView:function(t){this.setViewSize(),this.designer.addEvent("resize",this.setViewSize.bind(this)),this.data.view?this.viewJson=JSON.parse(this.data.view):this.viewJson={},this.view=new MWF.xApplication.query.StatementDesigner.View(this.designer,this,this.viewJson,{}),this.view.load(function(){this.view.setContentHeight()}.bind(this))},setViewSize:function(){var t=this.areaNode.getSize(),e=this.designerArea.getComputedSize(),i=this.resizeNode.getComputedSize(),s=t.y-e.totalHeight-i.totalHeight;s=s-this.viewArea.getStyle("margin-top").toInt()-this.viewArea.getStyle("margin-bottom").toInt()-this.viewArea.getStyle("padding-top").toInt()-this.viewArea.getStyle("padding-bottom").toInt()-1,s-=this.tabNode.getComputedSize().totalHeight,this.viewArea.setStyle("height",s+"px")},preview:function(){this.isNewStatement?this.designer.notice(this.designer.lp.saveStatementNotice,"error"):"select"===this.data.type?(this.data.view||this.designer.notice(this.designer.lp.noViewNotice,"error"),this.saveSilence(function(){var t="../x_desktop/app.html?app=query.Query&status=";t+=JSON.stringify({id:this.data.application,statementId:this.data.id}),window.open(o2.filterUrl(t),"_blank")}.bind(this))):this.designer.notice(this.designer.lp.previewNotSelectStatementNotice,"error")}}),MWF.xApplication.query.StatementDesigner.View=new Class({Extends:MWF.xApplication.query.ViewDesigner.View,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_query_StatementDesigner/$Statement/view.html"},initialize:function(t,e,i,s){this.setOptions(s),this.path="../x_component_query_ViewDesigner/$View/",this.cssPath="../x_component_query_ViewDesigner/$View/"+this.options.style+"/css.wcss",this._loadCss(),this.statement=e,this.designer=t,this.data=i,this.parseData(),this.node=this.statement.viewArea,this.areaNode=new Element("div",{styles:{height:"calc(100% - 2px)",overflow:"auto"}}),this.areaNode.setStyles(this.css.areaNode),this.items=[],this.view=this},load:function(t){this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.areaNode.inject(this.node),this.domListNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.designer.propertyDomArea),this.loadTemplateStyle(function(){this.loadActionbar(),this.loadView(),this.loadPaging(),this.setEvent(),this.setViewWidth(),this.designer.addEvent("resize",this.setViewWidth.bind(this)),t&&t()}.bind(this))},parseData:function(){if(this.json=this.data,this.json.id||(this.json.id=(new o2.widget.UUID).id),!this.json.data||!this.json.data.events){MWF.getJSON("../x_component_query_StatementDesigner/$Statement/view.json",{onSuccess:function(t){this.json.data||(this.json.data=t.data),this.json.data.events||(this.json.data.events=t.data.events)}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)},!1)}},setEvent:function(){this.areaNode.addEvents({click:function(t){this.selected(),t.stopPropagation()}.bind(this),mouseover:function(){this.isSelected||this.areaNode.setStyles(this.css.areaNode_over)}.bind(this),mouseout:function(){this.isSelected||this.areaNode.setStyles(this.css.areaNode)}.bind(this)}),this.refreshNode.addEvent("click",function(t){this.statement.runStatement(),t.stopPropagation()}.bind(this)),this.addColumnNode.addEvent("click",function(t){this.addColumn(),t.stopPropagation()}.bind(this))},selected:function(){if(this.statement.currentSelectedModule){if(this.statement.currentSelectedModule==this)return!0;this.statement.currentSelectedModule.unSelected()}this.areaNode.setStyles(this.css.areaNode_selected),this.statement.currentSelectedModule=this,this.domListNode.show(),this.isSelected=!0,this.showProperty()},unSelected:function(){this.statement.currentSelectedModule=null,this.isSelected=!1,this.areaNode.setStyles(this.css.areaNode),this.hideProperty()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatementDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},loadViewData:function(){if(this.data.id){this.viewContentBodyNode.empty(),this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode);var t={};if(this.json.data.selectList.each(function(e){t[e.column]=e}.bind(this)),this.statement.executeData&&this.statement.executeData.data&&this.statement.executeData.data.length)this.statement.executeData.data.each(function(e,i){var s=new Element("tr",{styles:this.json.data.viewStyles?this.json.data.viewStyles.contentTr:this.css.viewContentTrNode}).inject(this.viewContentTableNode);Object.each(t,function(t,i){var n=t.path,o=t.code,a=e;if(n)for(var h=n.split("."),r=0;r<h.length;r++){var d=h[r];if(/(^[1-9]\d*$)/.test(d)&&(d=d.toInt()),!a[d]){a="";break}a=a[d]}o&&o.trim()&&(a=MWF.Macro.exec(o,{target:{value:a,data:e,entry:t}}));var l,c=function(t){return"array"===typeOf(t)?Array.each(t,(function(e,i){t[i]=c(e)})):"object"===typeOf(t)?Object.each(t,(function(e,i){t[i]=c(e)})):"string"===typeOf(t)&&(t=o2.name.cn(t)),t};if(null!=a&&null!=a&&(l="array"===typeOf(a)?t.isName?JSON.stringify(c(Array.clone(a))):JSON.stringify(a):"object"===typeOf(a)?t.isName?JSON.stringify(c(Object.clone(a))):JSON.stringify(a):t.isName?o2.name.cn(a.toString()):a),null!=l&&null!=l){var p=new Element("td",{styles:this.json.data.viewStyles?this.json.data.viewStyles.contentTd:this.css.viewContentTdNode}).inject(s);t.isHtml?p.set("html",l):p.set("text",l)}}.bind(this))}.bind(this)),this.setContentColumnWidth(),this.setContentHeight();else if(this.json.data.noDataText){var e=this.css.noDataTextNode;this.json.data.viewStyles&&(this.json.data.viewStyles.noDataTextNode?e=this.json.data.viewStyles.noDataTextNode:this.json.data.viewStyles.noDataTextNode=this.css.noDataTextNode),this.noDataTextNode=new Element("div",{styles:e,text:this.json.data.noDataText}).inject(this.viewContentBodyNode)}}},addColumn:function(){MWF.require("MWF.widget.UUID",function(){var t=(new MWF.widget.UUID).id,e={id:t,column:t,displayName:this.designer.lp.unnamed,orderType:"original"};this.json.data.selectList||(this.json.data.selectList=[]),this.json.data.selectList.push(e);var i=new MWF.xApplication.query.StatementDesigner.View.Column(e,this);(this.items.push(i),i.selected(),this.viewContentTableNode)&&this.viewContentTableNode.getElements("tr").each(function(t){new Element("td",{styles:this.css.viewContentTdNode}).inject(t)}.bind(this));this.setViewWidth(),this.addColumnNode.scrollIntoView(!0)}.bind(this))},setContentHeight:function(){var t=this.areaNode.getSize(),e=this.viewTitleNode.getSize(),i=this.actionbarNode?this.actionbarNode.getSize():{x:0,y:0},s=this.pagingNode?this.pagingNode.getSize():{x:0,y:0},n=t.y-e.y-i.y-s.y-4;this.viewContentScrollNode.setStyle("height",n);var o=this.viewContentBodyNode.getSize();n<o.y&&(n=o.y+10),this.viewContentNode.setStyle("height",n),this.contentLeftNode.setStyle("height",n),this.contentRightNode.setStyle("height",n)},loadViewColumns:function(){this.json.data.selectList&&this.json.data.selectList.each(function(t){this.items.push(new MWF.xApplication.query.StatementDesigner.View.Column(t,this))}.bind(this))},showActionbar:function(t){this.actionbarNode.show(),this.json.data.actionbarList||(this.json.data.actionbarList=[]),this.actionbarList&&0!=this.actionbarList.length||(this.json.data.actionbarList.length?this.json.data.actionbarList.each(function(t){this.actionbarList.push(new MWF.xApplication.query.StatementDesigner.View.Actionbar(t,this.json.data.actionbarList,this))}.bind(this)):this.actionbarList.push(new MWF.xApplication.query.StatementDesigner.View.Actionbar(null,this.json.data.actionbarList,this))),t||this.setContentHeight()},loadPaging:function(t){this.pagingNode=new Element("div#pagingNode",{styles:this.css.pagingNode}).inject(this.areaNode),this.pagingList=[],this.json.data.pagingList||(this.json.data.pagingList=[]),this.pagingList&&0!=this.pagingList.length||(this.json.data.pagingList.length?this.json.data.pagingList.each(function(t){this.pagingList.push(new MWF.xApplication.query.StatementDesigner.View.Paging(t,this.json.data.pagingList,this))}.bind(this)):this.pagingList.push(new MWF.xApplication.query.StatementDesigner.View.Paging(null,this.json.data.pagingList,this)))},setViewWidth:function(){if(this.viewAreaNode){this.viewAreaNode.setStyle("width","auto"),this.viewTitleNode.setStyle("width","auto");var t=this.viewTitleTableNode.getSize(),e=this.refreshNode.getSize(),i=(this.addColumnNode.getSize(),t.x+e.x+e.x),s=this.areaNode.getSize();i>s.x?(this.viewTitleNode.setStyle("width",i-2+"px"),this.viewAreaNode.setStyle("width",i-2+"px")):(this.viewTitleNode.setStyle("width",s.x-2+"px"),this.viewAreaNode.setStyle("width",s.x-2+"px")),this.setContentColumnWidth(),this.setContentHeight()}},_setEditStyle:function(t,e,i){if("data.actionbarHidden"==t&&(this.json.data.actionbarHidden?this.hideActionbar():this.showActionbar()),"data.selectAllEnable"==t&&(this.json.data.selectAllEnable?(this.viewTitleTrNode.getElement(".viewTitleCheckboxTd").setStyle("display","table-cell"),this.viewContentTableNode.getElements(".viewContentCheckboxTd").setStyle("display","table-cell")):(this.viewTitleTrNode.getElement(".viewTitleCheckboxTd").setStyle("display","none"),this.viewContentTableNode.getElements(".viewContentCheckboxTd").setStyle("display","none"))),"data.viewStyleType"==t){var s=this.stylesList&&this.json.data.viewStyleType?this.stylesList[this.json.data.viewStyleType].file:null,n=this.stylesList&&this.json.data.viewStyleType?this.stylesList[this.json.data.viewStyleType].extendFile:null;this.loadTemplateStyles(s,n,function(t){var e,s;this.templateStyles=t,i&&this.stylesList[i]&&(e=this.stylesList[i].file,s=this.stylesList[i].extendFile),this.loadTemplateStyles(e,s,function(t){this.json.data.styleConfig=this.stylesList&&this.json.data.viewStyleType?this.stylesList[this.json.data.viewStyleType]:null,t.view&&this.clearTemplateStyles(t.view),this.templateStyles.view&&this.setTemplateStyles(this.templateStyles.view),this.setAllStyles(),this.actionbarList.each((function(e){t.actionbar&&e.clearTemplateStyles(t.actionbar),e.setStyleTemplate(),e.setAllStyles()})),this.pagingList.each((function(e){t.paging&&e.clearTemplateStyles(t.paging),e.setStyleTemplate(),e.setAllStyles()}))}.bind(this))}.bind(this))}"data.viewStyles"==t&&this.setCustomStyles()},loadTemplateStyle:function(t){this.loadStylesList(function(){this.json.data.viewStyleType&&this.stylesList[this.json.data.viewStyleType]||(this.json.data.viewStyleType="default"),this.loadTemplateStyles(this.stylesList[this.json.data.viewStyleType].file,this.stylesList[this.json.data.viewStyleType].extendFile,function(e){if(this.templateStyles=e,this.json.data.viewStyleType||(this.json.data.viewStyleType="default"),this.templateStyles&&this.templateStyles.view){var i=Object.clone(this.templateStyles.view);i.contentGroupTd&&delete i.contentGroupTd,i.groupCollapseNode&&delete i.groupCollapseNode,i.groupExpandNode&&delete i.groupExpandNode,this.json.data.viewStyles?this.setTemplateStyles(i):this.json.data.viewStyles=i}this.setCustomStyles(),t&&t()}.bind(this))}.bind(this))},clearTemplateStyles:function(t){t&&(t.container&&this.removeStyles(t.container,"container"),t.table&&this.removeStyles(t.table,"table"),t.titleTr&&this.removeStyles(t.titleTr,"titleTr"),t.titleTd&&this.removeStyles(t.titleTd,"titleTd"),t.contentTr&&this.removeStyles(t.contentTr,"contentTr"),t.contentSelectedTr&&this.removeStyles(t.contentSelectedTr,"contentSelectedTr"),t.contentTd&&this.removeStyles(t.contentTd,"contentTd"),t.checkboxNode&&this.removeStyles(t.checkboxNode,"checkboxNode"),t.checkedCheckboxNode&&this.removeStyles(t.checkedCheckboxNode,"checkedCheckboxNode"),t.radioNode&&this.removeStyles(t.radioNode,"radioNode"),t.checkedRadioNode&&this.removeStyles(t.checkedRadioNode,"checkedRadioNode"),t.tableProperties&&this.removeStyles(t.tableProperties,"tableProperties"))},setTemplateStyles:function(t){t.container&&this.copyStyles(t.container,"container"),t.table&&this.copyStyles(t.table,"table"),t.titleTr&&this.copyStyles(t.titleTr,"titleTr"),t.titleTd&&this.copyStyles(t.titleTd,"titleTd"),t.contentTr&&this.copyStyles(t.contentTr,"contentTr"),t.contentSelectedTr&&this.copyStyles(t.contentSelectedTr,"contentSelectedTr"),t.contentTd&&this.copyStyles(t.contentTd,"contentTd"),t.checkboxNode&&this.copyStyles(t.checkboxNode,"checkboxNode"),t.checkedCheckboxNode&&this.copyStyles(t.checkedCheckboxNode,"checkedCheckboxNode"),t.radioNode&&this.copyStyles(t.radioNode,"radioNode"),t.checkedRadioNode&&this.copyStyles(t.checkedRadioNode,"checkedRadioNode"),t.tableProperties&&this.copyStyles(t.tableProperties,"tableProperties")},removeStyles:function(t,e){this.json.data.viewStyles[e]&&Object.each(t,function(t,i){this.json.data.viewStyles[e][i]&&this.json.data.viewStyles[e][i]==t&&delete this.json.data.viewStyles[e][i]}.bind(this))},copyStyles:function(t,e){this.json.data.viewStyles[e]||(this.json.data.viewStyles[e]={}),Object.each(t,function(t,i){this.json.data.viewStyles[e][i]||(this.json.data.viewStyles[e][i]=t)}.bind(this))}}),MWF.xApplication.query.StatementDesigner.View.Column=new Class({Extends:MWF.xApplication.query.ViewDesigner.View.Column,initialize:function(t,e,i){this.propertyPath="../x_component_query_StatementDesigner/$Statement/column.html",this.view=e,this.json=t,this.next=i,this.css=this.view.css,this.content=this.view.viewTitleTrNode,this.domListNode=this.view.domListNode,this.load()},refreshColumnPathData:function(){this.property&&this.property.loadDataPathSelect()},getColumnDataPath:function(){return this.view.statement.getColumnDataPath()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatementDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show();var t=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedProcessArea"),e=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedCMSArea");"cms"==this.view.json.type?(t.setStyle("display","none"),e.setStyle("display","block")):(t.setStyle("display","block"),e.setStyle("display","none"))}.bind(this)}),this.property.load())},selected:function(){if(this.view.statement.currentSelectedModule){if(this.view.statement.currentSelectedModule==this)return!0;this.view.statement.currentSelectedModule.unSelected()}this.view.domListNode.show(),this.node.setStyles(this.css.viewTitleColumnNode_selected),this.listNode.setStyles(this.css.cloumnListNode_selected),new Fx.Scroll(this.view.areaNode,{wheelStops:!1,duration:100}).toElementEdge(this.node),new Fx.Scroll(this.view.designer.propertyDomArea,{wheelStops:!1,duration:100}).toElement(this.listNode),this.view.statement.currentSelectedModule=this,this.isSelected=!0,this._showActions(),this.showProperty()},unSelected:function(){this.view.statement.currentSelectedModule=null,this.isError?this.node.setStyles(this.css.viewTitleColumnNode_error):this.node.setStyles(this.css.viewTitleColumnNode),this.listNode.setStyles(this.css.cloumnListNode),this.isSelected=!1,this._hideActions(),this.hideProperty()}}),MWF.xApplication.query.StatementDesigner.View.Actionbar=new Class({Extends:MWF.xApplication.query.ViewDesigner.View.Actionbar,initialize:function(t,e,i,s){this.setOptions(s),this.propertyPath="../x_component_query_StatementDesigner/$Statement/actionbar.html",this.path="../x_component_query_ViewDesigner/$View/",this.imagePath_default="../x_component_query_ViewDesigner/$View/",this.imagePath_custom="../x_component_process_FormDesigner/Module/Actionbar/",this.cssPath="../x_component_query_ViewDesigner/$View/"+this.options.style+"/actionbar.wcss",this.view=i,this.json=t,this.jsonList=e,this.css=this.view.css,this.container=this.view.actionbarNode,this.moduleName="actionbar",this.load()},getJsonPath:function(){return"../x_component_query_StatementDesigner/$Statement/toolbars.json"},selected:function(){if(this.view.statement.currentSelectedModule){if(this.view.statement.currentSelectedModule==this)return!0;this.view.statement.currentSelectedModule.unSelected()}this.view.domListNode.show(),this.node.setStyles(this.css.toolbarWarpNode_selected),new Fx.Scroll(this.view.areaNode,{wheelStops:!1,duration:100}).toElementEdge(this.node),this.view.statement.currentSelectedModule=this,this.isSelected=!0,this.showProperty()},unSelected:function(){this.view.statement.currentSelectedModule=null,this.node.setStyles(this.css.toolbarWarpNode),this.isSelected=!1,this.hideProperty()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatementDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())}}),MWF.xApplication.query.StatementDesigner.View.Paging=new Class({Extends:MWF.xApplication.query.ViewDesigner.View.Paging,selected:function(){if(this.view.statement.currentSelectedModule){if(this.view.statement.currentSelectedModule==this)return!0;this.view.statement.currentSelectedModule.unSelected()}this.view.domListNode.show(),this.node.setStyles(this.css.pagingWarpNode_selected),new Fx.Scroll(this.view.areaNode,{wheelStops:!1,duration:100}).toElementEdge(this.node),this.view.statement.currentSelectedModule=this,this.isSelected=!0,this.showProperty()},unSelected:function(){this.view.statement.currentSelectedModule=null,this.node.setStyles(this.css.pagingWarpNode),this.isSelected=!1,this.hideProperty()}});