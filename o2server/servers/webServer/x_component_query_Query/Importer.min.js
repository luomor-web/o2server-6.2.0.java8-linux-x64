MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.Query=MWF.xApplication.query.Query||{},MWF.require("MWF.widget.Common",null,!1),MWF.require("MWF.xScript.Macro",null,!1),MWF.require("o2.widget.Dialog",null,!1),MWF.xDesktop.requireApp("query.Query","lp."+o2.language,null,!1),MWF.xApplication.query.Query.Importer=MWF.QImporter=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",moduleEvents:["queryLoad","beforeImport","afterImport","validImport","beforeCreateRowData","afterCreateRowData"]},initialize:function(t,e,i,s,r){this.setOptions(i),this.path="../x_component_query_Query/$Importer/",this.cssPath="../x_component_query_Query/$Importer/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=MWF.xApplication.query.Query.LP,this.app=s,this.json=e,this.container=t,this.parentMacro=r,this.lookupAction=MWF.Actions.get("x_query_assemble_surface")},load:function(){this.excelUtils=new MWF.xApplication.query.Query.Importer.ExcelUtils(this),this.getImporterJSON(function(){this.loadMacro(function(){this._loadModuleEvents(),this.fireEvent("queryLoad"),this.importFromExcel()}.bind(this))}.bind(this))},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro.ViewContext(this),t&&t()}.bind(this))},createLoadding:function(){this.loadingAreaNode=new Element("div",{styles:this.css.viewLoadingAreaNode}).inject(this.contentAreaNode),new Element("div",{styles:{height:"5px"}}).inject(this.loadingAreaNode);var t=new Element("div",{styles:this.css.viewLoadingNode}).inject(this.loadingAreaNode);new Element("div",{styles:this.css.viewLoadingIconNode}).inject(t),new Element("div",{styles:this.css.viewLoadingTextNode}).inject(t).set("text","loading...")},getImporterJSON:function(t){this.importerJson&&this.json?t&&t():this.json.name?this.lookupAction.getImportModel(this.json.name,this.json.application,function(e){this.importerId=e.data.id,this.importerJson=JSON.decode(e.data.data),e.data.data=this.importerJson,this.json=Object.merge(this.json,e.data),t&&t()}.bind(this)):this.lookupAction.getImportModelById(this.json.id,function(e){this.importerId=e.data.id,this.importerJson=JSON.decode(e.data.data),e.data.data=this.importerJson,this.json.application=e.data.query,this.json=Object.merge(this.json,e.data),t&&t()}.bind(this))},_loadModuleEvents:function(){Object.each(this.json.data.events,function(t,e){t.code&&-1!==this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e,i){return this.Macro.fire(t.code,i||this,e)}.bind(this))}.bind(this))},getDateColIndexArray:function(){var t=[];return this.json.data.columnList.each(function(e,i){"date"===("dynamicTable"===this.json.type?e.dataType_Querytable:e.dataType_CMSProcess)&&t.push(i)}.bind(this)),t},getOrgColIndexArray:function(){var t=[];return this.json.data.columnList.each(function(e,i){e.isName&&t.push(i)}.bind(this)),t},importFromExcel:function(){this.rowList=[],this.excelUtils.upload(this.getDateColIndexArray(),function(t){this.progressBar=new MWF.xApplication.query.Query.Importer.ProgressBar(this,{onPostShow:function(){this.progressBar.showCheckData(),this.importedData=t,this.importedData.length>0&&this.importedData.shift(),this.fireEvent("beforeImport",[this.importedData]),this.listAllOrgDataByImport(function(){this.importedData.each(function(t,e){this.rowList.push(new MWF.xApplication.query.Query.Importer.Row(this,t,e))}.bind(this)),(this.json.enableValid?this.checkImportedData():this.checkNecessaryImportedData())?this.doImportData():this.openImportedErrorDlg()}.bind(this))}.bind(this)}),this.progressBar.importerId=this.importerId}.bind(this))},getData:function(){return(this.rowList||[]).map((function(t){return t.getResult()}))},doImportData:function(){var t=!0;this.rowList.each(function(e,i){e.errorTextList.length&&(t=!1)}.bind(this));var e={validted:t,data:this.importedData,rowList:this.rowList};if(this.fireEvent("validImport",[e]),t=e.validted){var i=this.getData();this.lookupAction.getUUID(function(t){this.recordId=t.data,this.lookupAction.executImportModel(this.json.id,{recordId:this.recordId,data:i},function(){this.showImportingStatus()}.bind(this),function(t){var e=JSON.parse(t.responseText);this.app.notice(e.message,"error"),this.progressBar.close()}.bind(this))}.bind(this))}else this.openImportedErrorDlg()},objectToString:function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},openImportedErrorDlg:function(){this.progressBar&&this.progressBar.close();var t=this,e=new Element("div",{style:"padding:10px;"}),i=o2.DL.open({style:"user",title:this.lp.importFail,content:e,offset:{y:0},isMax:!0,width:1e3,height:700,buttonList:[{type:"exportWithError",text:this.lp.exportExcel,action:function(){t.exportWithImportDataToExcel()}},{type:"cancel",text:this.lp.cancel,action:function(){i.close()}}],onPostShow:function(){var t=["<table "+this.objectToString(this.css.properties)+" style='"+this.objectToString(this.css.tableStyles,"style")+"'>"],i=this.objectToString(this.css.titleStyles,"style");t.push("<tr>"),this.json.data.columnList.each((function(e,s){t.push("<th style='"+i+"'>"+e.displayName+"</th>")})),t.push("<th style='"+i+"'> "+this.lp.validationInfor+"</th>"),t.push("</tr>");var s=Object.clone(this.css.contentStyles);s["border-bottom"]||s.border||(s["border-bottom"]="1px solid #eee");var r=this.objectToString(Object.merge(s,{"text-align":"left"}),"style");this.rowList.each(function(e,i){var s=e.importedData;t.push("<tr>"),this.json.data.columnList.each((function(e,i){t.push("<td style='"+r+"'>"+(s[i]||"").replace(/&#10;/g,"<br/>")+"</td>")})),t.push("<td style='"+r+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),t.push("</tr>")}.bind(this)),t.push("</table>"),e.set("html",t.join(""))}.bind(this),onPostClose:function(){i=null}.bind(this)})},checkNecessaryImportedData:function(){var t=!0;this.rowList.each(function(e,i){e.checkNecessary()||(t=!1)}.bind(this));var e={validted:t,data:this.importedData,rowList:this.rowList};return this.fireEvent("validImport",[e]),e.validted},checkImportedData:function(){var t=!0;this.rowList.each(function(e,i){e.checkValid()||(t=!1)}.bind(this));var e={validted:t,data:this.importedData,rowList:this.rowList};return this.fireEvent("validImport",[e]),e.validted},getOrgData:function(t,e,i){var s;switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s=this.identityMapImported[t];break;case"@p":s=this.personMapImported[t];break;case"@u":s=this.unitMapImported[t];break;case"@g":s=this.groupMapImported[t];break;default:s=this.identityMapImported[t]||this.personMapImported[t]||this.unitMapImported[t]||this.groupMapImported[t]}return s?i?MWF.org.parseOrgData(s,!0,!0):s:e?null:{errorText:t+this.lp.notExistInSystem}},stringToArray:function(t){return t.replace(/[\n\r]/g,",").replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},listAllOrgDataByImport:function(t){var e=this.getOrgColIndexArray();if(0!==e.length){var i=[],s=[],r=[],o=[];if(e.length>0){var a,n,h,l;this.importedData.each(function(t,a){e.each(function(e,a){t[e]&&this.stringToArray(t[e]).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":i.push(t);break;case"@p":s.push(t);break;case"@u":r.push(t);break;case"@g":o.push(t);break;default:i.push(t),s.push(t),r.push(t),o.push(t)}}))}.bind(this))}.bind(this));var c=function(){a&&n&&h&&l&&t&&t()};this.identityMapImported={},i.length?(i=i.unique(),o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:i},function(t){t.data.each(function(t){this.identityMapImported[t.matchKey]=t}.bind(this)),a=!0,c()}.bind(this))):(a=!0,c()),this.personMapImported={},s.length?(s=s.unique(),o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:s},function(t){t.data.each(function(t){this.personMapImported[t.matchKey]=t}.bind(this)),n=!0,c()}.bind(this))):(n=!0,c()),this.unitMapImported={},r.length?(r=r.unique(),o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:r},function(t){t.data.each(function(t){this.unitMapImported[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this))):(h=!0,c()),this.groupMapImported={},o.length?(o=o.unique(),o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:o},function(t){t.data.each(function(t){this.groupMapImported[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this))):(l=!0,c())}}else t&&t()},showImportingStatus:function(){this.progressBar.showImporting(this.recordId,function(t){this.fireEvent("afterImport",t)}.bind(this))},exportWithImportDataToExcel:function(t){this.excelUtils||(this.excelUtils=new MWF.xApplication.query.Query.Importer.ExcelUtils(this));var e=function(){var e=[],i=this.getTitleArray();i.push(this.lp.validationInfor),e.push(i),t?t.each(function(t,i){var s=[];"array"===o2.typeOf(t)?t.each((function(t,e){s.push((t||"").replace(/&#10;/g,"\n"))})):"object"===o2.typeOf(t)&&(this.json.data.columnList.each(function(e,i){s.push(t[e.path]||"")}.bind(this)),t.o2ErrorText&&s.push(t.o2ErrorText)),e.push(s)}.bind(this)):this.rowList.each(function(t,i){var s=t.importedData,r=[];s.each((function(t,e){r.push((t||"").replace(/&#10;/g,"\n"))})),r.push(t.errorTextListExcel?t.errorTextListExcel.join("\n"):""),e.push(r)}.bind(this));var s=this.getColWidthArray();s.push(260);var r={data:e,colWidthArray:s,title:this.getFileName()};this.fireEvent("export",[r]),this.excelUtils.exportToExcel(r.data,r.title,r.colWidthArray,this.getDateIndexArray())}.bind(this);this.importerJson?e():this.getImporterJSON(function(){e()}.bind(this))},downloadTemplate:function(t,e){this.excelUtils||(this.excelUtils=new MWF.xApplication.query.Query.Importer.ExcelUtils(this)),this.importerJson||this.getImporterJSON(function(){var i={data:[this.getTitleArray()],colWidthArray:this.getColWidthArray(),title:this.getFileName(t)};e&&e(i),this.excelUtils.exportToExcel(i.data,i.title,i.colWidthArray,this.getDateIndexArray())}.bind(this))},getFileName:function(t){var e=t||this.json.name,i=e.split(".");return["xls","xlst"].contains(i[i.length-1].toLowerCase())&&i.splice(i.length-1),e=i.join(".")},getTitleArray:function(){var t=[];return this.json.data.columnList.each(function(e,i){t.push(e.displayName)}.bind(this)),t},getColWidthArray:function(){var t=[];return this.json.data.columnList.each(function(e,i){switch("dynamicTable"===this.json.type?e.dataType_Querytable:e.dataType_CMSProcess){case"string":case"stringList":e.isName?t.push(340):e.isSummary?t.push(260):t.push(150);break;case"number":case"integer":case"long":case"double":case"numberList":case"integerList":case"longList":case"doubleList":t.push(150);break;case"date":case"dateTime":case"dateList":case"dateTimeList":default:t.push(150)}}.bind(this)),t},getDateIndexArray:function(){var t=[];return this.json.data.columnList.each(function(e,i){switch("dynamicTable"===this.json.type?e.dataType_Querytable:e.dataType_CMSProcess){case"date":case"dateTime":case"dateList":case"dateTimeList":t.push(i)}}.bind(this)),t},confirm:function(t,e,i,s,r,o,a,n,h,l,c){this.app.confirm(t,e,i,s,r,o,a,n,h,l,c)},alert:function(t,e,i,s,r){this.app.alert(t,"center",e,i,s,r)},notice:function(t,e,i,s,r,o){this.app.notice(t,e,i,s,r,o)}}),MWF.xApplication.query.Query.Importer.Row=new Class({initialize:function(t,e,i){this.importer=t,this.importedData=e,this.clazzType="row",this.lp=this.importer.lp,this.data={},this.errorTextList=[],this.errorTextListExcel=[]},checkValid:function(){var t=this.lp,e=t.importValidationColumnText,i=t.importValidationColumnTextExcel,s=[],r=[];return this.importer.json.data.columnList.each(function(o,a){var n=e.replace("{n}",a+1),h=i.replace("{n}",this.importer.excelUtils.index2ColName(a)),l=this.importedData[a]||"",c="dynamicTable"===this.importer.json.type?o.dataType_Querytable:o.dataType_CMSProcess;if(o.allowEmpty||l||(s.push(n+t.canNotBeEmpty+t.fullstop),r.push(h+t.canNotBeEmpty+t.fullstop)),!1!==o.validFieldType&&l)switch(c){case"string":case"stringList":if(o.isName)this.stringToArray(l).each(function(e,i){var o=this.importer.getOrgData(e);o.errorText&&(s.push(n+o.errorText+t.fullstop),r.push(h+o.errorText+t.fullstop))}.bind(this));break;case"number":case"integer":case"long":case"double":l=l.replace(/&#10;/g,""),isNaN(l)&&(s.push(n+l+t.notValidNumber+t.fullstop),r.push(h+l+t.notValidNumber+t.fullstop));break;case"numberList":case"integerList":case"longList":case"doubleList":this.stringToArray(l).each(function(e,i){isNaN(e)&&(s.push(n+e+t.notValidNumber+t.fullstop),r.push(h+e+t.notValidNumber+t.fullstop))}.bind(this));break;case"date":case"dateTime":l=l.replace(/&#10;/g,""),new Date(l).isValid()||(s.push(n+l+t.notValidDate+t.fullstop),r.push(h+l+t.notValidDate+t.fullstop));break;case"dateList":case"dateTimeList":this.stringToArray(l).each(function(e,i){new Date(e).isValid()||(s.push(n+e+t.notValidDate+t.fullstop),r.push(h+e+t.notValidDate+t.fullstop))}.bind(this));break;case"boolean":l=l.replace(/&#10;/g,""),["true","false"].contains(l.trim().toLowerCase())||(s.push(n+l+t.notValidBoolean+t.fullstop),r.push(h+l+t.notValidBoolean+t.fullstop));break;case"booleanList":this.stringToArray(l).each(function(e,i){["true","false"].contains(e.trim().toLowerCase())||(s.push(n+e+t.notValidBoolean+t.fullstop),r.push(h+e+t.notValidBoolean+t.fullstop))}.bind(this));break;case"json":case"stringMap":l=l.replace(/&#10;/g,"");try{JSON.parse(l)}catch(e){s.push(n+l+t.notValidJson+t.fullstop),r.push(h+l+t.notValidJson+t.fullstop)}}}.bind(this)),this.errorTextList=this.errorTextList.concat(s),this.errorTextListExcel=this.errorTextListExcel.concat(r),!(this.errorTextList.length>0)&&(this.createData(),"cms"===this.importer.json.type?this.checkCMS(!0):"process"===this.importer.json.type&&this.checkProcess(!0),!(this.errorTextList.length>0))},checkNecessary:function(){var t=this.lp,e=t.importValidationColumnText,i=t.importValidationColumnTextExcel,s=[],r=[];return this.importer.json.data.columnList.each(function(o,a){var n=e.replace("{n}",a+1),h=i.replace("{n}",this.importer.excelUtils.index2ColName(a)),l=this.importedData[a]||"",c="dynamicTable"===this.importer.json.type?o.dataType_Querytable:o.dataType_CMSProcess;if(!1!==o.validFieldType&&l)switch(c){case"json":case"stringMap":l=l.replace(/&#10;/g,"");try{JSON.parse(l)}catch(e){s.push(n+l+t.notValidJson+t.fullstop),r.push(h+l+t.notValidJson+t.fullstop)}}}.bind(this)),this.errorTextList=this.errorTextList.concat(s),this.errorTextListExcel=this.errorTextListExcel.concat(r),!(this.errorTextList.length>0)&&(this.createData(),"cms"===this.importer.json.type?this.checkCMS():"process"===this.importer.json.type&&this.checkProcess(),!(this.errorTextList.length>0))},getCol:function(t,e){var i=this.lp;if(this.pathIndexMap&&"number"===typeOf(this.pathIndexMap[t])){var s=this.pathIndexMap[t];return e?i.importValidationColumnTextExcel.replace("{n}",this.importer.excelUtils.index2ColName(s)):i.importValidationColumnText.replace("{n}",s+1)}return""},checkCMS:function(t){var e,i=this.lp,s=[],r=[];return(e=this.document.identity)?"i"!==e.split("@").getLast().toLowerCase()&&(s.push(this.getCol("identity",!1)+'"'+e+'"'+i.drafterIsNotIdentity+i.fullstop),r.push(this.getCol("identity",!0)+'"'+e+'"'+i.drafterIsNotIdentity+i.fullstop)):(s.push(this.getCol("identity",!1)+i.noDrafter+i.fullstop),r.push(this.getCol("identity",!0)+i.noDrafter+i.fullstop)),(e=this.document.publishTime)?new Date(e).isValid()||(s.push(this.getCol("publishTime",!1)+'"'+e+'"'+i.publishTimeFormatError+i.fullstop),r.push(this.getCol("publishTime",!1)+'"'+e+'"'+i.publishTimeFormatError+i.fullstop)):(s.push(this.getCol("publishTime",!1)+i.noPublishTime+i.fullstop),r.push(this.getCol("publishTime",!1)+i.noPublishTime+i.fullstop)),(e=this.document.title)&&e.length>70&&(s.push(this.getCol("title",!1)+'"'+e+'"'+i.cmsTitleLengthInfor+i.fullstop),r.push(this.getCol("title",!1)+'"'+e+'"'+ +i.cmsTitleLengthInfor+i.fullstop)),(e=this.document.summary)&&e.length>70&&(s.push(this.getCol("summary",!1)+'"'+e+'"'+i.cmsSummaryLengthInfor+i.fullstop),r.push(this.getCol("summary",!1)+'"'+e+'"'+i.cmsSummaryLengthInfor+i.fullstop)),this.errorTextList=this.errorTextList.concat(s),this.errorTextListExcel=this.errorTextListExcel.concat(r),!(s.length>0)},checkProcess:function(t){var e,i=this.lp,s=this.importer.json,r=(i.importValidationColumnText,i.importValidationColumnTextExcel,[]),o=[];((e=this.work.identity)?"i"!==e.split("@").getLast().toLowerCase()&&(r.push(this.getCol("identity",!1)+'"'+e+'"'+i.drafterIsNotIdentity+i.fullstop),o.push(this.getCol("identity",!0)+'"'+e+'"'+i.drafterIsNotIdentity+i.fullstop)):(r.push(this.getCol("identity",!1)+i.noDrafter+i.fullstop),o.push(this.getCol("identity",!0)+i.noDrafter+i.fullstop)),"completed"===s.data.processStatus)&&(this.work.form||(r.push(i.noForm+i.fullstop),o.push(i.noForm+i.fullstop)),(e=this.work.startTime)?new Date(e).isValid()||(r.push(this.getCol("startTime",!1)+'"'+e+'"'+i.startTimeFormatError+i.fullstop),o.push(this.getCol("startTime",!1)+'"'+e+'"'+i.startTimeFormatError+i.fullstop)):(r.push(this.getCol("startTime",!1)+i.noStartTime+i.fullstop),o.push(this.getCol("startTime",!1)+i.noStartTime+i.fullstop)),(e=this.work.completeTime)?new Date(e).isValid()||(r.push(this.getCol("completeTime",!1)+'"'+e+'"'+i.endTimeFormatError+i.fullstop),o.push(this.getCol("completeTime",!1)+'"'+e+'"'+i.endTimeFormatError+i.fullstop)):(r.push(this.getCol("completeTime",!1)+i.noEndTime+i.fullstop),o.push(this.getCol("completeTime",!1)+i.noEndTime+i.fullstop)));return this.errorTextList=this.errorTextList.concat(r),this.errorTextListExcel=this.errorTextListExcel.concat(o),!(r.length>0)},createData:function(){var t,e=this.importer.json;"cms"===e.type?this.document={categoryId:e.data.category.id,readerList:[],authorList:[],docData:this.data}:"process"===e.type&&(this.work={processFlag:e.data.process.id,data:this.data}),this.importer.fireEvent("beforeCreateRowData",[this]),e.data.columnList.each(function(t,i){if(t.path){var s=this.importedData[i]||"";if(s){var r=this.parseData(s,"dynamicTable"===e.type?t.dataType_Querytable:t.dataType_CMSProcess,t);if(r&&("dynamicTable"===e.type?this.data[t.path]=r:this.setDataWithPath(this.data,t.path,r),"cms"===e.type&&t.isName)){if(t.isAuthor){var o=this.parseCMSReadAndAuthor(r,"作者");this.document.authorList=this.document.authorList.concat(o)}if(t.isReader){o=this.parseCMSReadAndAuthor(r,"阅读");this.document.readerList=this.document.readerList.concat(o)}}}}}.bind(this)),e.data.calculateFieldList.each(function(t,i){if(t.valueScript){var s=this.importer.Macro.exec(t.valueScript,this);if("null"===o2.typeOf(s))return;if(!t.path)return;if("dynamicTable"===e.type?this.data[t.path]=s:this.setDataWithPath(this.data,t.path,s),"cms"===e.type){if(t.isAuthor){var r=this.parseCMSReadAndAuthor(s,"作者");this.document.authorList=this.document.authorList.concat(r)}if(t.isReader){r=this.parseCMSReadAndAuthor(s,"阅读");this.document.readerList=this.document.readerList.concat(r)}}}}.bind(this)),"cms"===e.type?(this.document.docData=this.data,"importer"===e.data.documentPublisher?(t=layout.session.user.identityList)&&t.length&&(this.document.identity=t[0].distinguishedName):this.setDataWithField(this.document,"documentPublisherField","identity",!0),"importer"===e.data.documentPublishTime?this.document.publishTime=(new Date).format("db"):this.setDataWithField(this.document,"documentPublisherTimeField","publishTime",!1),this.setDataWithField(this.document,"documentTitleField","title",!1),this.document.title||(this.document.title="无标题"),this.setDataWithField(this.document,"documentSummaryField","summary",!1)):"process"===e.type&&(this.work.data=this.data,"importer"===e.data.processDrafter?(t=layout.session.user.identityList)&&t.length&&(this.work.identity=t[0].distinguishedName):this.setDataWithField(this.work,"processDrafterField","identity",!0),this.setDataWithField(this.work,"processTitleField","title",!1),this.work.title||(this.work.title="无标题"),"completed"===e.data.processStatus&&(this.work.form=e.data.processForm||"",this.setDataWithField(this.work,"processSerialField","serial",!1),this.setDataWithField(this.work,"processStartTimeField","startTime",!1),this.setDataWithField(this.work,"processCompleteTimeField","completeTime",!1))),this.importer.fireEvent("afterCreateRowData",[this])},parseData:function(t,e,i){var s,r=this.importer.json.type;switch(e){case"string":case"stringList":if(i.isName){var o=this.stringToArray(t);s="dynamicTable"===r?o:o.map(function(t,e){return this.importer.getOrgData(t,!0,!0)||t}.bind(this)).clean()}else if("string"===e){var a="dynamicTable"===r?i.lineBreak_Querytable:i.lineBreak_CMSProcess;s=t.replace(/&#10;/g,a||"")}else s=this.stringToArray(t);break;case"number":case"double":t=t.replace(/&#10;/g,""),s=parseFloat(t);break;case"integer":case"long":t=t.replace(/&#10;/g,""),s=parseInt(t);break;case"numberList":case"doubleList":s=this.stringToArray(t).map(function(t,e){return parseFloat(t)}.bind(this)).clean();break;case"integerList":case"longList":s=this.stringToArray(t).map(function(t,e){return parseInt(t)}.bind(this)).clean();break;case"date":t=t.replace(/&#10;/g,""),s=Date.parse(t).format("%Y-%m-%d");break;case"dateTime":t=t.replace(/&#10;/g,""),s=Date.parse(t).format("db");break;case"dateList":s=this.stringToArray(t).map(function(t,e){return Date.parse(t).format("%Y-%m-%d")}.bind(this)).clean();break;case"dateTimeList":s=this.stringToArray(t).map(function(t,e){return Date.parse(t).format("db")}.bind(this)).clean();break;case"boolean":s="false"!==(t=t.replace(/&#10;/g,"")).trim().toLowerCase();break;case"booleanList":s=this.stringToArray(t).map(function(e,i){return"false"!==t.trim().toLowerCase()}.bind(this)).clean();break;case"json":case"stringMap":t=t.replace(/&#10;/g,""),s=JSON.parse(t);break;default:s=t.replace(/&#10;/g,"")}return s},stringToArray:function(t){return t.replace(/[\n\r]/g,",").replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},setDataWithPath:function(t,e,i){var s=e.split("."),r=t;Array.each(s,function(t,e){if(e!==s.length-1)if(r[t])r=r[t];else{var i=this.isNumberString(s[e+1])?[]:{},o=this.isNumberString(t)?t.toInt():t;r[o]=i,r=r[o]}}.bind(this)),r[s[s.length-1]]=i},setDataWithField:function(t,e,i,s){if(this.pathIndexMap||(this.pathIndexMap={}),i){var r=this.importer.json;if(r.data[e]){var o=r.data[e];r.data.columnList.each(function(t,e){t.path===o&&(this.pathIndexMap[i]=e)}.bind(this));var a=this.data;if(Array.each(o.split("."),function(t){this.isNumberString(t)&&(t=t.toInt()),a&&(a=a[t])}.bind(this)),!a)return;var n="array"===typeOf(a)&&a.length?a[0]:a;n&&(t[i]=s?"object"===typeOf(n)?n.distinguishedName:n:a)}}},isNumberString:function(t){return t.toInt().toString()===t},parseCMSReadAndAuthor:function(t,e){var i=["组织","群组","人员","人员","角色"],s=["U","G","I","P","R"];return"array"!==typeOf(t)&&(t=[t]),t.map((function(t){var r,o="string"===typeOf(t)?t:t.distinguishedName;r="object"===typeOf(t)&&t.name?t.name:MWF.name&&MWF.name.cn?MWF.name.cn(o):o.split("@")[0];var a=s.indexOf(o.substr(o.length-1,1));if(a>-1)return{permission:e,permissionObjectType:i[a],permissionObjectName:r,permissionObjectCode:o}})).clean()},getSrcData:function(){var t={};return this.importer.json.data.columnList.each(function(e,i){e.path&&(t[e.path]=this.importedData[i]||"")}.bind(this)),t},getResult:function(){return"cms"===this.importer.json.type?(this.document.srcData=this.getSrcData(),this.document):"process"===this.importer.json.type?(this.work.srcData=this.getSrcData(),this.work):"dynamicTable"===this.importer.json.type?(this.data.srcData=this.getSrcData(),this.data):void 0}}),MWF.xApplication.query.Query.Importer.ExcelUtils=new Class({initialize:function(t){this.importer=t,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var r=new Uint8Array(s.result),o=r.byteLength,a=0;a<o;a++)e+=String.fromCharCode(r[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=r.files;if(t.length){var o=t.item(0);this.importFromExcel(o,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var r=s.getFirst();r.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var r=window.xlsxUtils.format2Sheet(t,0,0,null),o=window.xlsxUtils.format2WB(r,"sheet1",void 0),a=o.Sheets[o.SheetNames[0]],n=[];for(var h in t[0].each(function(t,e){i||n.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==h.substr(0,1)){var l=a[h];if(l.s||(l.s={}),l.s.alignment||(l.s.alignment={}),l.s.alignment.wrapText=!0,s&&s.length){var c=h.replace(/\d+/g,"");h.replace(c,"")>1&&s.contains(c)&&(l.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){n.push({wpx:t})})),a["!cols"]=n,this._openDownloadDialog(window.xlsxUtils.format2Blob(o),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,r,o=new FileReader;o.onload=function(t){r=t?t.target.result:o.content;var a=(s=window.XLSX.read(r,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var n=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var h;if(n["!range"])h=n["!range"].e.r;else{var l=n["!ref"].split(":");2===l.length&&(h=parseInt(l[1].replace(/[^0-9]/gi,"")))}if(h)for(var c=0;c<i.length;c++)for(var p=1;p<=h;p++){var d=n[i[c]+p];d&&(delete d.w,d.z="yyyy-mm-dd",window.XLSX.utils.format_cell(d))}}var u=window.XLSX.utils.sheet_to_json(n,{header:1});e&&e(u)}},o.readAsBinaryString(t)}))}}),MWF.xApplication.query.Query.Importer.ProgressBar=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{zindex:null,disableDetailButton:!1},initialize:function(t,e){this.setOptions(e),this.importer=t,this.actions=this.importer.lookupAction,this.lp=MWF.xApplication.query.Query.LP,this.css=t.css,this.openDlg(),this.status="ready"},openDlg:function(){var t=this;this.contentNode=new Element("div",{styles:this.css.processContentNode});var e={style:"user",title:this.lp.importRecordDetail,content:this.contentNode,offset:{y:0},isMax:!1,width:500,height:200,zindex:this.options.zindex,buttonList:[{type:"openImportRecordDetail",text:this.lp.openImportRecordDetail,action:function(){t.openImportRecordDetail()}},{type:"cancel",text:this.lp.close,action:function(){this.dlg.close()}.bind(this)}],onPostShow:function(){this.fireEvent("postShow")}.bind(this),onPostLoad:function(){this.titleAction.hide(),this.button.hide()},onPostClose:function(){this.dlg=null}.bind(this)};this.options.disableDetailButton&&e.buttonList.splice(0,1),this.dlg=o2.DL.open(e)},createNode:function(t){},setContentHtml:function(t){var e=this.lp,i="";t?(i="<div style=\"overflow: hidden\">   <div class='mwf_progressInforNode'>"+e.readyToImportData1+"</div></div>",this.contentNode.set("html",i),this.progressNode=null,this.progressPercentNode=null,this.progressInforNode=this.contentNode.getElement(".mwf_progressInforNode"),this.progressInforNode.setStyles(this.css.progressInforNode)):(i="<div style=\"overflow: hidden\">   <div class='mwf_progressNode'>       <div class='mwf_progressPercentNode'></div>   </div>   <div class='mwf_progressInforNode'>"+e.readyToImportData1+"</div></div>",this.contentNode.set("html",i),this.progressNode=this.contentNode.getElement(".mwf_progressNode"),this.progressNode.setStyles(this.css.progressNode),this.progressPercentNode=this.contentNode.getElement(".mwf_progressPercentNode"),this.progressPercentNode.setStyles(this.css.progressPercentNode),this.progressInforNode=this.contentNode.getElement(".mwf_progressInforNode"),this.progressInforNode.setStyles(this.css.progressInforNode))},showCheckData:function(){this.setContentHtml(!0),this.setMessageTitle(this.lp.checkDataTitle),this.setMessageText(this.lp.checkDataContent),this.status="check"},showImporting:function(t,e){this.setContentHtml(),this.recordId=t,this.currentDate=new Date,this.intervalId=window.setInterval(function(){this.actions.getImportModelRecordStatus(this.recordId,function(t){var i=t.data;this.status=i.status,"待导入"===i.status?(this.setMessageTitle(this.lp.importWaitingTitle),this.setMessageText(this.lp.importWaitingContent)):"导入中"===i.status?(this.setMessageTitle(this.lp.importDataTitle),this.setMessageText(this.lp.importDataContent.replace("{count}",i.executeCount)),this.updateProgress(i)):(this.intervalId&&window.clearInterval(this.intervalId),this.transferComplete(i),e&&e(i))}.bind(this),null)}.bind(this),500)},showCloseAction:function(){this.dlg.titleAction.show(),this.dlg.button.show()},close:function(){this.dlg.close()},updateProgress:function(t){var e=this.lp,i=t.count.toInt(),s=t.executeCount.toInt(),r=t.failCount.toInt(),o=s/i*100,a=new Date,n=this.lastTime||this.currentDate,h=a.getTime()-n.getTime(),l=1e3*(s-(this.lastProcessed||0))/h;e.importSpeed;l=l.round(2),this.progressPercentNode.setStyle("width",o+"%");var c=e.importingDataContent.replace("{speed}",l).replace("{total}",i).replace("{remaining}",i-s);c+=r?e.importingDataErrorContent.replace("{errorCount}",r):"",this.progressInforNode.set("text",c),this.lastProcessed=s,this.lastTime=new Date},transferComplete:function(t){var e=this.lp,i=(new Date).getTime()-this.currentDate.getTime();i<1e3&&(i=1e3);var s="";if(i>36e5){var r=i%36e5,o=r/6e4,a=r%6e4/1e3;s=""+(i/36e5).toInt()+e.hour+o.toInt()+e.mintue+a.toInt()+e.second}else if(i>6e4){a=i%6e4/1e3;s=""+(o=i/6e4).toInt()+e.mintue+a.toInt()+e.second}else{s=""+(a=i/1e3).toInt()+e.second}if("导入成功"===t.status){var n=1e3*(l=t.count)/i;e.importSpeed;n=n.round(2),this.setMessageTitle(e.importSuccessTitle);var h=e.importSuccessContent.replace("{total}",l).replace("{speed}",n).replace("{timeStr}",s);this.setMessageText(h)}else if("部分成功"===t.status){n=1e3*(l=t.count)/i,e.importSpeed;n=n.round(2),this.setMessageTitle(e.importPartSuccessTitle);h=e.importPartSuccessContent.replace("{total}",l).replace("{speed}",n).replace("{errorCount}",t.failCount).replace("{timeStr}",s);this.setMessageText(h)}else{var l=t.count;this.setMessageTitle(e.importFailTitle);h=e.importFailContent.replace("{errorInfo}",t.distribution||"").replace("{total}",l).replace("{timeStr}",s);this.setMessageText(h)}this.clearMessageProgress(),this.showCloseAction()},setMessageText:function(t){this.progressInforNode.set("text",t)},setMessageTitle:function(t){this.dlg.titleText.set("text",t)},clearMessageProgress:function(){this.progressNode.destroy()},openImportRecordDetail:function(){MWF.xDesktop.requireApp("query.Query","ImporterRecord",function(){new MWF.xApplication.query.Query.ImporterRecord.Detail(this.importer.container,this.importer.app,{importerId:this.importerId,recordId:this.recordId}).load(),this.dlg.close()}.bind(this),!1)}});