MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.Query=MWF.xApplication.query.Query||{},MWF.xDesktop.requireApp("query.Query","Viewer",null,!1),MWF.xApplication.query.Query.Statement=MWF.QStatement=new Class({Extends:MWF.QViewer,options:{},initialize:function(e,t,i,s,a){this.setOptions(i),this.path="../x_component_query_Query/$Viewer/",this.cssPath="../x_component_query_Query/$Viewer/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=MWF.xApplication.query.Query.LP,this.app=s,this.container=$(e),this.json=t||{},this.parentMacro=a,this.originalJson=Object.clone(t),this.viewJson=null,this.filterItems=[],this.searchStatus="none",this.items=[],this.selectedItems=[],this.hideColumns=[],this.openColumns=[],this.parameter={},this.gridJson=null,this.options.isload&&this.init(function(){this.load()}.bind(this))},init:function(e){this.json.view?(this.viewJson=JSON.decode(this.json.view),this.statementJson=this.json,this.statementJson.viewJson=this.viewJson,e&&e()):this.getView(e)},loadMacro:function(e){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro.ViewContext(this),e&&e()}.bind(this))},createActionbarNode:function(){if(this.actionbarAreaNode.empty(),("boolean"!==typeOf(this.json.showActionbar)||!0===this.json.showActionbar)&&"boolean"===typeOf(this.viewJson.actionbarHidden)){if(!0===this.viewJson.actionbarHidden||!this.viewJson.actionbarList||!this.viewJson.actionbarList.length)return;this.actionbar=new MWF.xApplication.query.Query.Statement.Actionbar(this.actionbarAreaNode,this.viewJson.actionbarList[0],this,{}),this.actionbar.load()}},_loadPageNode:function(){var e;(this.viewPageAreaNode.empty(),this.paging)?this.paging.reload():(e=this.viewJson.pagingList&&this.viewJson.pagingList.length?this.viewJson.pagingList[0]:{firstPageText:this.lp.firstPage,lastPageText:this.lp.lastPage},this.paging=new MWF.xApplication.query.Query.Statement.Paging(this.viewPageAreaNode,e,this,{}),this.paging.load())},lookup:function(e,t){if(!this.lookuping){this.lookuping=!0;var i=e||{};this.loadParameter(i),this.loadFilter(i),this.currentPage=this.options.defaultPage||1,this.options.defaultPage=null,this.noDataTextNode&&this.noDataTextNode.destroy(),this.loadCurrentPageData(function(e){if(this.count)this.fireEvent("postLoad"),this.lookuping=!1,t&&t(this);else{if(this.viewPageAreaNode.empty(),this.viewJson.noDataText){var i=this.css.noDataTextNode;this.viewJson.viewStyles&&this.viewJson.viewStyles.noDataTextNode&&(i=this.viewJson.viewStyles.noDataTextNode),this.noDataTextNode=new Element("div",{styles:i,text:this.viewJson.noDataText}).inject(this.contentAreaNode)}this.fireEvent("postLoad"),this.lookuping=!1,t&&t(this)}}.bind(this),!0,"all")}},loadFilter:function(e){this.filterList=[],(e.filterList||[]).each(function(e){var t=e.path.replace(/\./g,"_"),i=e.value;"like"===e.comparison||"notLike"===e.comparison?("%"!==i.substr(0,1)&&(i="%"+i),"%"!==i.substr(i.length-1,1)&&(i+="%"),this.parameter[t]=i):("dateTimeValue"===e.formatType||"datetimeValue"===e.formatType?i="{ts '"+i+"'}":"dateValue"===e.formatType?i="{d '"+i+"'}":"timeValue"===e.formatType&&(i="{t '"+i+"'}"),this.parameter[t]=i),e.value=t,this.filterList.push(e)}.bind(this))},loadParameter:function(){this.parameter={};var e=this.json.parameter?Object.clone(this.json.parameter):{};for(var t in(this.viewJson.parameterList||[]).each(function(t){var i=t.value;if(e&&e[t.parameter]&&(i=e[t.parameter],delete e[t.parameter]),"date"===typeOf(i)&&(i=i.format("db")),"script"===t.valueType)i=this.Macro.exec(t.valueScript?t.valueScript.code:"",this);else{var s=layout.user;switch(t.value){case"@person":i=s.distinguishedName;break;case"@identityList":i=s.identityList.map((function(e){return e.distinguishedName}));break;case"@unitList":o2.Actions.load("x_organization_assemble_express").UnitAction.listWithPerson({personList:[s.distinguishedName]},(function(e){i=e.unitList}),null,!1);break;case"@unitAllList":o2.Actions.load("x_organization_assemble_express").UnitAction.listWithIdentitySupNested({personList:[s.distinguishedName]},(function(e){i=e.unitList}),null,!1);break;case"@year":i=(new Date).getFullYear().toString();break;case"@season":var a=(new Date).format("%m");i=["01","02","03"].contains(a)?"1":["04","05","06"].contains(a)?"2":["07","08","09"].contains(a)?"3":"4";break;case"@month":i=(new Date).format("%Y-%m");break;case"@time":i=(new Date).format("db");break;case"@date":i=(new Date).format("%Y-%m-%d")}}"dateTimeValue"===t.formatType||"datetimeValue"===t.formatType?i="{ts '"+i+"'}":"dateValue"===t.formatType?i="{d '"+i+"'}":"timeValue"===t.formatType&&(i="{t '"+i+"'}"),this.parameter[t.parameter]=i}.bind(this)),e){var i=e[t];"date"===typeOf(i)&&(i="{ts '"+i.format("db")+"'}"),this.parameter[t]=i}},loadCurrentPageData:function(e,t,i){if(!this.pageloading){this.pageloading=!0,this.items=[];for(var s=this.currentPage,a={filterList:this.filterList,parameter:this.parameter};this.viewTable.rows.length>1;)this.viewTable.deleteRow(-1);this.loadViewRes=o2.Actions.load("x_query_assemble_surface").StatementAction.executeV2(this.options.statementId||this.options.statementName||this.json.statementId||this.json.statementName,i||"data",s,this.json.pageSize,a,function(t){if(("all"===i||"count"===i)&&"number"===typeOf(t.count)){this.count=t.count;var s=this.count/this.json.pageSize;this.pages=s.toInt()<s?s.toInt()+1:s}this.gridJson=t.data,this.setSelectedableFlag(),this.fireEvent("postLoadPageData"),this.loadData(),this.gridJson.length&&this._loadPageNode(),this.loadingAreaNode&&(this.loadingAreaNode.destroy(),this.loadingAreaNode=null),this.pageloading=!1,this.fireEvent("loadView"),this.fireEvent("postLoadPage"),e&&e(t)}.bind(this),null,!1!==t)}},getView:function(e){this.getViewRes=o2.Actions.load("x_query_assemble_surface").StatementAction.get(this.json.statementId||this.json.statementName,function(t){var i=JSON.decode(t.data.view);this.json.pageSize||(this.json.pageSize=i.pageSize||"20"),this.viewJson=i.data,this.json.application=t.data.query,this.statementJson=t.data,this.statementJson.viewJson=this.viewJson,e&&e()}.bind(this))},loadData:function(){"multi"===this.getSelectFlag()&&this.viewJson.allowSelectAll?this.selectTitleCell&&this.selectTitleCell.retrieve("selectAllLoaded")?this.setUnSelectAllStyle():this.createSelectAllNode():this.selectAllNode&&this.clearSelectAllStyle(),this.gridJson.length?this.gridJson.each(function(e,t){this.items.push(new MWF.xApplication.query.Query.Statement.Item(this,e,null,t))}.bind(this)):this.viewPageAreaNode&&this.viewPageAreaNode.empty()},loadDataByPaging:function(){if(!this.isItemsLoading&&!this.isItemsLoaded){var e=Math.min(this.pageNumber*this.options.perPageCount,this.gridJson.length),t=Math.min((this.pageNumber+1)*this.options.perPageCount+1,this.gridJson.length);this.isItemsLoading=!0;for(var i=e;i<t;i++)this.items.push(new MWF.xApplication.query.Query.Statement.Item(this,this.gridJson[i],null,i));this.isItemsLoading=!1,this.pageNumber++,t==this.gridJson.length&&(this.isItemsLoaded=!0)}},getFilter:function(){var e=[];if("custom"===this.searchStatus&&this.filterItems.length&&this.filterItems.each(function(t){e.push(t.data)}.bind(this)),"default"===this.searchStatus){var t=this.viewSearchInputNode.get("value");t&&t!==this.lp.searchKeywork&&this.viewJson.customFilterList.each(function(i){if("textValue"===i.formatType){var s={path:i.path,value:t,formatType:i.formatType,logic:"or",comparison:"like"};e.push(s)}if("numberValue"===i.formatType){var a=t.toFloat();if(!isNaN(a)){s={path:i.path,value:a,formatType:i.formatType,logic:"or",comparison:"like"};e.push(s)}}}.bind(this))}return e.length?e:null},viewSearchCustomAddToFilter:function(){var e=this.viewSearchCustomPathListNode.selectedIndex,t=this.viewSearchCustomComparisonListNode.selectedIndex;if(-1===e)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorTitle,this.viewSearchCustomPathListNode,{x:0,y:85}),!1;if(-1===t)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorComparison,this.viewSearchCustomComparisonListNode,{x:0,y:85}),!1;var i=this.viewSearchCustomPathListNode.options[e].retrieve("entry");if(i){var s=i.title,a=i.path,n=this.viewSearchCustomComparisonListNode.options[t].get("value"),o=this.viewSearchCustomComparisonListNode.options[t].get("text"),r="";if("script"===i.valueType&&i.valueScript&&i.valueScript.code){if(-1!==(l=this.viewSearchCustomValueNode.selectedIndex)){var h=this.viewSearchCustomValueNode.options[l].get("value");r="booleanValue"===i.formatType?"true"===h:h}}else switch(i.formatType){case"numberValue":case"dateTimeValue":r=this.viewSearchCustomValueNode.get("value");break;case"booleanValue":var l;if(-1!==(l=this.viewSearchCustomValueNode.selectedIndex))r="true"===(h=this.viewSearchCustomValueNode.options[l].get("value"));break;default:r=this.viewSearchCustomValueNode.get("value")}if(""===r)return MWF.xDesktop.notice("error",{x:"left",y:"top"},this.lp.filterErrorValue,this.viewSearchCustomValueContentNode,{x:0,y:85}),!1;this.filterItems.push(new MWF.xApplication.query.Query.Statement.Filter(this,{logic:"and",path:a,title:s,comparison:n,comparisonTitle:o,value:r,formatType:"datetimeValue"==i.formatType?"dateTimeValue":i.formatType},this.viewSearchCustomFilterContentNode)),this.searchCustomView()}},getStatementInfor:function(){return this.statementJson},getPageInfor:function(){return{pages:this.pages,perPageCount:this.json.pageSize,currentPageNumber:this.currentPage}},switchStatement:function(e){this.switchView(e)},setFilter:function(e,t,i){this.lookuping||this.pageloading||(e||(e=[]),t||(t={}),this.json.filter=e,this.json.parameter=t,this.viewAreaNode&&this.createViewNode({filterList:this.json.filter.clone()},i))}}),MWF.xApplication.query.Query.Statement.Item=new Class({Extends:MWF.xApplication.query.Query.Viewer.Item,initialize:function(e,t,i,s,a){this.view=e,this.data=t,this.dataString=JSON.stringify(t),this.css=this.view.css,this.isSelected=!1,this.category=a,this.prev=i,this.idx=s,this.clazzType="item",this.load()},load:function(){this.view.fireEvent("queryLoadItemRow",[null,this]);var e=(t=this.view.viewJson.viewStyles)&&t.contentTd?t.contentTd:this.css.viewContentTdNode;this.node=new Element("tr",{styles:t&&t.contentTr?t.contentTr:this.css.viewContentTrNode}),this.prev?this.node.inject(this.prev.node,"after"):this.node.inject(this.view.viewTable),this.selectTd=new Element("td",{styles:e}).inject(this.node),this.selectTd.setStyles({cursor:"pointer"}),this.view.json.itemStyles&&this.selectTd.setStyles(this.view.json.itemStyles);var t,i,s=this.view.getSelectFlag();if(this.data.$selectedEnable&&["multi","single"].contains(s)&&"always"===this.view.viewJson.selectBoxShow)if(t=this.view.viewJson.viewStyles)"single"===s?this.selectTd.setStyles(t.radioNode):this.selectTd.setStyles(t.checkboxNode);else{var a="checkbox";"single"===s&&(a="radiobox"),this.selectTd.setStyles({background:"url(../x_component_query_Query/$Viewer/default/icon/"+a+".png) center center no-repeat"})}if(this.view.isSelectTdHidden()&&this.selectTd.hide(),"yes"===this.view.viewJson.isSequence){this.sequenceTd=new Element("td",{styles:e}).inject(this.node),this.sequenceTd.setStyle("width","10px");var n=1+this.view.json.pageSize*(this.view.currentPage-1)+this.idx;this.sequenceTd.set("text",n)}Object.each(this.view.entries,function(t,i){if(-1===this.view.hideColumns.indexOf(i)){var s=new Element("td",{styles:e}).inject(this.node),a=this.getText(t,i,s);null==a&&(a="");var n=a;t.isHtml?s.set("html",n):s.set("text",n),"object"===typeOf(t.contentProperties)&&s.setProperties(t.contentProperties),this.view.json.itemStyles&&s.setStyles(this.view.json.itemStyles),"object"===typeOf(t.contentStyles)&&s.setStyles(t.contentStyles),-1!==this.view.openColumns.indexOf(i)&&this.setOpenWork(s,t),Object.each(t.events||{},function(e,i){e.code&&("loadContent"===i?this.view.Macro.fire(e.code,{node:s,json:t,data:n,view:this.view,row:this}):"loadTitle"!==i&&s.addEvent(i,function(i){return this.view.Macro.fire(e.code,{node:s,json:t,data:n,view:this.view,row:this},i)}.bind(this)))}.bind(this))}}.bind(this));var o=this.view.json.defaultSelectedScript||this.view.viewJson.defaultSelectedScript;if(!this.isSelected&&o&&(i=this.view.Macro.exec(o,{node:this.node,data:this.data,view:this.view,row:this})),!this.isSelected&&this.view.selectedItems.length)for(var r=0;r<this.view.selectedItems.length;r++)if(this.view.selectedItems[r].dataString===this.dataString){i="true";break}if(i)if("multi"===i||"single"===i)this.select(i);else if("true"===i.toString()){var h=this.view.json.select||this.view.viewJson.select||"none";"single"!==h&&"multi"!==h||this.select()}this.setEvent(),this.view.fireEvent("postLoadItemRow",[null,this])},selected:function(e){for(var t=0;t<this.view.selectedItems.length;t++){var i=this.view.selectedItems[t];if(i.dataString===this.dataString){this.view.selectedItems.erase(i);break}}this.view.selectedItems.push(this);var s=this.view.viewJson.viewStyles;s?(this.selectTd.setStyles(s.checkedCheckboxNode),this.node.setStyles(s.contentSelectedTr)):(this.selectTd.setStyles({background:"url(../x_component_query_Query/$Viewer/default/icon/checkbox_checked.png) center center no-repeat"}),this.node.setStyles(this.css.viewContentTrNode_selected)),this.isSelected=!0,"view"!==e&&"category"!==e&&this.view.viewJson.allowSelectAll&&(this.view.checkSelectAllStatus(),this.category&&this.category.checkSelectAllStatus()),this.view.fireEvent("selectRow",[this])},unSelected:function(e){for(var t=0;t<this.view.selectedItems.length;t++){var i=this.view.selectedItems[t];if(i.dataString===this.dataString){this.view.selectedItems.erase(i);break}}var s=this.view.viewJson.viewStyles;"always"!==this.view.viewJson.selectBoxShow?this.selectTd.setStyles({background:"transparent"}):s?this.selectTd.setStyles(s.checkboxNode):this.selectTd.setStyles({background:"url(../x_component_query_Query/$Viewer/default/icon/checkbox.png) center center no-repeat"}),s?this.node.setStyles(s.contentTr):this.node.setStyles(this.css.viewContentTrNode),this.isSelected=!1,"view"!==e&&"category"!==e&&this.view.viewJson.allowSelectAll&&(this.view.checkSelectAllStatus(),this.category&&this.category.checkSelectAllStatus()),this.view.fireEvent("unselectRow",[this])},getDataByPath:function(e,t){for(var i=t.split("."),s=0;s<i.length;s++){var a=i[s];if(/(^[1-9]\d*$)/.test(a)&&(a=a.toInt()),!e[a]){e="";break}e=e[a]}return e},getText:function(e,t,i){var s=e.path,a=e.code,n=this.data;if(!s)return"";"$all"===s||(n=this.getDataByPath(n,s)),a&&a.trim()&&(n=this.view.Macro.exec(a,{value:n,data:this.data,entry:e,node:i,json:e,row:this}));var o,r=function(e){return"array"===typeOf(e)?Array.each(e,(function(t,i){e[i]=r(t)})):"object"===typeOf(e)?Object.each(e,(function(t,i){e[i]=r(t)})):"string"===typeOf(e)&&(e=o2.name.cn(e)),e};return null!=n&&null!=n&&(o="array"===typeOf(n)?e.isName?JSON.stringify(r(Array.clone(n))):JSON.stringify(n):"object"===typeOf(n)?e.isName?JSON.stringify(r(Object.clone(n))):JSON.stringify(n):e.isName?o2.name.cn(n.toString()):n),o},setOpenWork:function(e,t){if(e.setStyle("cursor","pointer"),t.clickCode)this.view.Macro||MWF.require("MWF.xScript.Macro",function(){this.view.businessData={},this.view.Macro=new MWF.Macro.ViewContext(this.view)}.bind(this),!1),e.addEvent("click",function(e){var i=this.view.Macro.fire(t.clickCode,this,e);return e.stopPropagation(),i}.bind(this));else if("official"===this.view.statementJson.entityCategory&&t.idPath){var i=this.getDataByPath(this.data,t.idPath);i&&("com.x.cms.core.entity.Document"===this.view.statementJson.entityClassName?e.addEvent("click",function(e){this.openCms(e,i),e.stopPropagation()}.bind(this)):e.addEvent("click",function(e){this.openWork(e,i),e.stopPropagation()}.bind(this)))}},openCms:function(e,t){var i={documentId:t};this.view.fireEvent("openDocument",[i,this]),layout.desktop.openApplication(e,"cms.Document",i)},openWork:function(e,t){var i={workId:t};this.view.fireEvent("openDocument",[i,this]),layout.desktop.openApplication(e,"process.Work",i)}}),MWF.xApplication.query.Query.Statement.Filter=new Class({Extends:MWF.xApplication.query.Query.Viewer.Filter}),MWF.xApplication.query.Query.Statement.Actionbar=new Class({Extends:MWF.xApplication.query.Query.Viewer.Actionbar}),MWF.xApplication.query.Query.Statement.Paging=new Class({Extends:MWF.xApplication.query.Query.Viewer.Paging});