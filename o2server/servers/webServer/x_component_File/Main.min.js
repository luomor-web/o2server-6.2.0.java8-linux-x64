MWF.xDesktop.requireApp("File","AttachmentController",null,!1),MWF.require("MWF.widget.Tree",null,!1),MWF.xApplication.File.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"File",icon:"icon.png",width:"1000",height:"600",title:MWF.xApplication.File.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.File.LP,this.restActions=MWF.Actions.get("x_file_assemble_control")},loadApplication:function(e){this.history=[],this.currentHistory=1,this.currentFolder=null,MWF.getJSON("../x_component_File/$Main/icon.json",function(e){this.icons=e}.bind(this),!1,!1),this.createNode(),this.loadApplicationContent(),e&&e()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationContent:function(){this.loadTop(),this.fileContentNode=new Element("div",{styles:this.css.fileContentNode}).inject(this.node),this.folderContentNode=new Element("div",{styles:this.css.folderContentNode}).inject(this.fileContentNode),this.attachmentContentNode=new Element("div",{styles:this.css.attachmentContentNode}).inject(this.fileContentNode),this.resizeContentNode=new Element("div",{styles:this.css.resizeContentNode}).inject(this.folderContentNode),this.folderTreeAreaNode=new Element("div",{styles:this.css.folderTreeAreaNode}).inject(this.folderContentNode),this.folderTreeAreaScrollNode=new Element("div",{styles:this.css.folderTreeAreaScrollNode}).inject(this.folderContentNode),this.shareTreeAreaScrollNode=new Element("div",{styles:this.css.folderTreeAreaScrollNode}).inject(this.folderContentNode),this.editorTreeAreaScrollNode=new Element("div",{styles:this.css.folderTreeAreaScrollNode}).inject(this.folderContentNode),this.loadFileContentAreaNode(),this.loadFolderTreeNode(),this.loadShareTreeNode(),this.loadEditorTreeNode(),this.shareTree.loadCallback=function(){if(this.shareTab.isShow)if(this.status)if(this.status.node){for(var e=!1,t=0;t<this.shareTree.children.length;t++)if(this.shareTree.children[t].data.name==this.status.node){this.shareTree.children[t].clickNode(),e=!0;break}e||this.shareTree.firstChild.clickNode()}else this.shareTree.firstChild.clickNode();else this.shareTree.firstChild.clickNode()},this.editorTree.loadCallback=function(){if(this.editorTab.isShow)if(this.status)if(this.status.node){for(var e=!1,t=0;t<this.editorTree.children.length;t++)if(this.editorTree.children[t].data.name==this.status.node){this.editorTree.children[t].clickNode(),e=!0;break}e||this.editorTree.firstChild.clickNode()}else this.editorTree.firstChild.clickNode();else this.editorTree.firstChild.clickNode()},this.treeResize=new Drag(this.resizeContentNode,{snap:1,onStart:function(e,t){var i=t.event.clientX,s=t.event.clientY;e.store("position",{x:i,y:s});var n=this.folderContentNode.getSize();e.store("initialWidth",n.x)}.bind(this),onDrag:function(e,t){var i=t.event.clientX,s=this.content.getSize(),n=e.retrieve("position"),o=e.retrieve("initialWidth").toFloat()+(i.toFloat()-n.x.toFloat());o>s.x/2&&(o=s.x/2),o<200&&(o=200),this.attachmentContentNode.setStyle("margin-left",o),this.folderContentNode.setStyle("width",o)}.bind(this)}),MWF.require("MWF.widget.Tab",function(){this.treeTab=new MWF.widget.Tab(this.folderTreeAreaNode,{style:"processlayout"}),this.treeTab.load(),this.fileTabe=this.treeTab.addTab(this.folderTreeAreaScrollNode,this.lp.myFiles,!1),this.shareTab=this.treeTab.addTab(this.shareTreeAreaScrollNode,this.lp.shareFiles,!1),this.editorTab=this.treeTab.addTab(this.editorTreeAreaScrollNode,this.lp.editorFiles,!1),this.fileTabe.addEvent("show",function(){this.folderTree.currentNode?this.folderTree.currentNode.clickNode():this.folderTree.firstChild?this.folderTree.firstChild.clickNode():this.controller&&this.controller.clear(),this.checkControllerActionsFile()}.bind(this)),this.shareTab.addEvent("show",function(){this.shareTree.currentNode?this.shareTree.currentNode.clickNode():this.shareTree.firstChild?this.shareTree.firstChild.clickNode():this.controller&&this.controller.clear(),this.checkControllerActionsShare()}.bind(this)),this.editorTab.addEvent("show",function(){this.editorTree.currentNode?this.editorTree.currentNode.clickNode():this.editorTree.firstChild?this.editorTree.firstChild.clickNode():this.controller&&this.controller.clear(),this.checkControllerActionsEditor()}.bind(this));var e="file";this.status&&this.status.tab&&(e=this.status.tab),"file"==e&&this.fileTabe.showIm(),"share"==e&&this.shareTab.showIm(),"editor"==e&&this.editorTab.showIm(),this.setContentHeight(),this.addEvent("resize",function(){this.setContentHeight()}.bind(this))}.bind(this)),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.folderTreeAreaScrollNode,{style:"xApp_Organization_Explorer",where:"before",distance:100,friction:4,axis:{x:!1,y:!0}}),new MWF.widget.ScrollBar(this.shareTreeAreaScrollNode,{style:"xApp_Organization_Explorer",where:"before",distance:100,friction:4,axis:{x:!1,y:!0}}),new MWF.widget.ScrollBar(this.editorTreeAreaScrollNode,{style:"xApp_Organization_Explorer",where:"before",distance:100,friction:4,axis:{x:!1,y:!0}})}.bind(this))},checkControllerActionsFile:function(){this.controller.folderActionBoxNode.setStyle("display","block"),this.controller.uploadAction.setStyle("display","block"),this.controller.deleteAction.setStyle("display","block"),this.controller.replaceAction.setStyle("display","block"),this.controller.editActionSeparateNode.setStyle("display","block"),this.controller.shareActionBoxNode.setStyle("display","block")},checkControllerActionsShare:function(){this.controller.folderActionBoxNode.setStyle("display","none"),this.controller.uploadAction.setStyle("display","none"),this.controller.deleteAction.setStyle("display","none"),this.controller.replaceAction.setStyle("display","none"),this.controller.editActionSeparateNode.setStyle("display","none"),this.controller.shareActionBoxNode.setStyle("display","none")},checkControllerActionsEditor:function(){this.controller.folderActionBoxNode.setStyle("display","none"),this.controller.uploadAction.setStyle("display","none"),this.controller.deleteAction.setStyle("display","none"),this.controller.replaceAction.setStyle("display","block"),this.controller.editActionSeparateNode.setStyle("display","block"),this.controller.shareActionBoxNode.setStyle("display","none")},loadTop:function(){this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node),this.leftNode=new Element("div",{styles:this.css.leftNode}).inject(this.topNode),this.leftNode.addEvent("click",function(){this.leftPath()}.bind(this)),this.rightNode=new Element("div",{styles:this.css.rightNode}).inject(this.topNode),this.rightNode.addEvent("click",function(){this.rightPath()}.bind(this)),this.refreshNode=new Element("div",{styles:this.css.refreshNode}).inject(this.topNode),this.searchNode=new Element("div",{styles:this.css.searchNode}).inject(this.topNode),this.pathNode=new Element("div",{styles:this.css.pathNode}).inject(this.topNode)},openAttachment:function(e,t,i){this.restActions.getFileUrl(i[0].data.id,(function(e){window.open(o2.filterUrl(e))}))},downloadAttachment:function(e,t,i){i.each(function(e){this.restActions.getFileDownloadUrl(e.data.id,(function(e){window.open(o2.filterUrl(e))}))}.bind(this))},getAttachmentLinkUrl:function(e){return o2.Actions.get("x_file_assemble_control").action.actions.getAttachmentData.uri.replace("{id}",encodeURIComponent(e.data.id))},downloadCurrentFile:function(){this.selectedItem&&"file"==this.selectedItem.type&&this.selectedItem.open()},moveFileFolder:function(){},renameFileFolder:function(){this.content.mask({style:{opacity:.7,"background-color":"#999"}});var e=new Element("div",{styles:this.css.createFolderNode}).inject(this.content);e.position({relativeTo:this.node,position:"center"});var t=this.controller.selectedAttachments[0],i=t.treeNode,s=(new Element("div",{styles:this.css.createFolderTitleNode,text:this.lp.rename}).inject(e),new Element("div",{styles:this.css.createFolderInforNode,text:this.lp.inputName}).inject(e),new Element("div",{styles:this.css.createFolderInputAreaNode}).inject(e)),n=new Element("input",{type:"text",styles:this.css.createFolderInputNode,value:t.data.name}).inject(s),o=new Element("div",{styles:this.css.createFolderActionNode}).inject(e),l=new Element("button",{styles:this.css.createFolderCancelButton,text:this.lp.cancel}).inject(o),d=new Element("button",{styles:this.css.createFolderOkButton,text:this.lp.ok}).inject(o);l.addEvent("click",function(){this.content.unmask(),e.destroy()}.bind(this)),d.addEvent("click",function(){n.get("value")?(t.data.name=n.get("value"),"folder"==t.type?this.restActions.saveFolder(t.data,function(e){this.currentFolder?this.currentFolder.clickNode():this.topTreeNode.clickNode(),i.setText(n.get("value"))}.bind(this)):this.restActions.updateAttachment(this.controller.selectedAttachments[0].data.id,this.controller.selectedAttachments[0].data,function(e){this.currentFolder?this.currentFolder.clickNode():this.topTreeNode.clickNode()}.bind(this)),e.destroy(),this.content.unmask()):this.notice(this.lp.nameNotEmpty,"error",e)}.bind(this))},deleteAttachments:function(e,t,i){this.deleteFileFolder(e,i)},deleteFileFolder:function(e,t){if(t.length){var i=this,s=this.lp.deleteFolderFilesTitle,n=this.lp.deleteFolderFiles;if(1==t.length){s="folder"==t[0].type?this.lp.deleteFolderTitle:this.lp.deleteFileTitle;n=(n="folder"==t[0].type?this.lp.deleteFolder:this.lp.deleteFile)+"（"+t[0].data.name+"）"}var o=this.node.getSize(),l={event:{x:(o.x-300)/2,y:(o.y-120)/2}};this.confirm("infor",l,s,n,300,120,(function(){var e=t.length,s=0,n=function(){s==e&&(this.currentFolder?(this.currentFolder.loaded=!1,this.currentFolder.clickNode()):(this.topTreeNode.loaded=!1,this.topTreeNode.clickNode()))};t.each((function(e){"folder"==e.type?(e.treeNode.destroy(),i.restActions.deleteFolder(e.data.id,(function(){s++,n.apply(i)}))):i.restActions.deleteFile(e.data.id,(function(){s++,n.apply(i)}))})),this.close()}),(function(){this.close()}))}},shareAttachment:function(){this.shareFile()},shareFile:function(){this.content.mask({style:{opacity:.7,"background-color":"#999"}});var e=new Element("div",{styles:this.css.createFolderNode}).inject(this.content);e.position({relativeTo:this.node,position:"center"});new Element("div",{styles:this.css.createFolderTitleNode,text:this.lp.shareFile}).inject(e),new Element("div",{styles:this.css.createFolderInforNode,text:this.lp.selectShareUser}).inject(e);var t=new Element("div",{styles:this.css.createFolderInputAreaNode}).inject(e),i=new Element("div",{type:"text",readonly:!0,styles:this.css.shareFileInputNode}).inject(t);i.addEvent("click",function(){MWF.xDesktop.requireApp("Selector","Person",function(){new MWF.xApplication.Selector.Person(this.node,{onComplete:function(e){MWF.require("MWF.widget.O2Identity",function(){var t=[],s=[];i.empty(),e.each((function(e){t.push(e.data.distinguishedName),s.push(e.data.name),new MWF.widget.O2Person({name:e.data.distinguishedName},i,{style:"xform"})})),i.store("texts",s),i.set("value",t.join(", "))}.bind(this))}.bind(this)}).load()}.bind(this))}.bind(this));var s=new Element("div",{styles:this.css.createFolderActionNode}).inject(e),n=new Element("button",{styles:this.css.createFolderCancelButton,text:this.lp.cancel}).inject(s),o=new Element("button",{styles:this.css.createFolderOkButton,text:this.lp.ok}).inject(s);n.addEvent("click",function(){this.content.unmask(),e.destroy()}.bind(this)),o.addEvent("click",function(){var t=this.controller.selectedAttachments.length,s=0,n=function(){s===t&&(i.get("value")&&this.notice(this.lp.fileShareSuccess+i.retrieve("texts",[]).join(","),"success",this.content),e.destroy(),this.content.unmask())};this.controller.selectedAttachments.each(function(e){"folder"!=e.type?(e.data.shareList=i.get("value").split(/,\s*/g),this.restActions.updateAttachment(e.data.id,e.data,function(e){s++,n.apply(this)}.bind(this))):(s++,n.apply(this))}.bind(this))}.bind(this))},sendAttachment:function(){this.sendFile()},sendFile:function(){this.content.mask({style:{opacity:.7,"background-color":"#999"}});var e=new Element("div",{styles:this.css.createFolderNode}).inject(this.content);e.position({relativeTo:this.node,position:"center"});new Element("div",{styles:this.css.createFolderTitleNode,text:this.lp.sendFile}).inject(e),new Element("div",{styles:this.css.createFolderInforNode,text:this.lp.selectSendUser}).inject(e);var t=new Element("div",{styles:this.css.createFolderInputAreaNode}).inject(e),i=new Element("div",{type:"text",readonly:!0,styles:this.css.shareFileInputNode}).inject(t);i.addEvent("click",function(){MWF.xDesktop.requireApp("Selector","Person",function(){new MWF.xApplication.Selector.Person(this.node,{onComplete:function(e){MWF.require("MWF.widget.O2Identity",function(){var t=[],s=[];i.empty(),e.each((function(e){t.push(e.data.distinguishedName),s.push(e.data.name),new MWF.widget.O2Person({name:e.data.distinguishedName},i,{style:"xform"})})),i.store("texts",s),i.set("value",t.join(", "))}.bind(this))}.bind(this)}).load()}.bind(this))}.bind(this));var s=new Element("div",{styles:this.css.createFolderActionNode}).inject(e),n=new Element("button",{styles:this.css.createFolderCancelButton,text:this.lp.cancel}).inject(s),o=new Element("button",{styles:this.css.createFolderOkButton,text:this.lp.ok}).inject(s);n.addEvent("click",function(){this.content.unmask(),e.destroy()}.bind(this)),o.addEvent("click",function(){var t=this.controller.selectedAttachments.length,s=0,n=function(){s==t&&(i.get("value")&&this.notice(this.lp.fileSendSuccess+i.retrieve("texts",[]).join(","),"success",this.content),e.destroy(),this.content.unmask())};this.controller.selectedAttachments.each(function(e){"folder"!=e.type?(e.data.editorList=i.get("value").split(/,\s*/g),this.restActions.updateAttachment(e.data.id,e.data,function(e){s++,n.apply(this)}.bind(this))):(s++,n.apply(this))}.bind(this))}.bind(this))},uploadAttachment:function(e,t){folderId=this.currentFolder&&this.currentFolder.data?this.currentFolder.data.id:"",this.controller.doUploadAttachment(null,this.restActions.action,"addAttachment",{folder:folderId||"(0)"},function(){this.currentFolder?this.currentFolder.clickNode():this.topTreeNode.clickNode()}.bind(this))},replaceAttachment:function(e,t,i){var s=i.data.id;this.controller.doReplaceAttachment(null,this.restActions.action,"updateAttachmentData",{id:s},function(){this.currentFolder?this.currentFolder.clickNode():this.topTreeNode.clickNode()}.bind(this))},createFolder:function(){this.content.mask({style:{opacity:.7,"background-color":"#999"}});var e=new Element("div",{styles:this.css.createFolderNode}).inject(this.content);e.position({relativeTo:this.node,position:"center"});new Element("div",{styles:this.css.createFolderTitleNode,text:this.lp.createFolder}).inject(e),new Element("div",{styles:this.css.createFolderInforNode,text:this.lp.inputFolderName}).inject(e);var t=new Element("div",{styles:this.css.createFolderInputAreaNode}).inject(e),i=new Element("input",{type:"text",styles:this.css.createFolderInputNode}).inject(t),s=new Element("div",{styles:this.css.createFolderActionNode}).inject(e),n=new Element("button",{styles:this.css.createFolderCancelButton,text:this.lp.cancel}).inject(s),o=new Element("button",{styles:this.css.createFolderOkButton,text:this.lp.ok}).inject(s);n.addEvent("click",function(){this.content.unmask(),e.destroy()}.bind(this)),o.addEvent("click",function(){if(i.get("value")){var t={name:i.get("value"),superior:this.currentFolder&&this.currentFolder.data?this.currentFolder.data.id:""};this.restActions.saveFolder(t,function(e){t.id=e.data.id,this.restActions.getFolder(t.id,function(e){if(this.currentFolder){var t={data:[e.data]};this.createTreeNode(t,this.currentFolder),this.currentFolder.clickNode()}else this.topTreeNode.clickNode()}.bind(this))}.bind(this)),e.destroy(),this.content.unmask()}else this.notice(this.lp.folderNameNotEmpty,"error",e)}.bind(this))},getAttachmentUrl:function(e,t){this.restActions.getFileUrl(e.data.id,t)},loadFolderTreeNode:function(){this.folderTreeNode=new Element("div",{styles:this.css.folderTreeNode}).inject(this.folderTreeAreaScrollNode),this.folderTree=new MWF.widget.Tree(this.folderTreeNode,{style:"file"}),this.folderTree.load();var e={expand:!1,title:"root",text:"root",action:function(e){this.recordHistory(e),this.expand(e,function(){this.loadSub(e)}.bind(this))}.bind(this),icon:"folder.png"};this.topTreeNode=this.folderTree.appendChild(e)},createShareTreeNode:function(e){e.data.each(function(e){var t=e.name.substring(0,e.name.indexOf("@")),i={expand:!1,title:t+"("+e.count+")",text:t+"("+e.count+")",action:function(e){this.loadShareFile(e)}.bind(this),icon:"folder.png"};this.shareTree.appendChild(i).data=e}.bind(this))},loadShareTreeNode:function(){this.shareTreeNode=new Element("div",{styles:this.css.folderTreeNode}).inject(this.shareTreeAreaScrollNode),this.shareTree=new MWF.widget.Tree(this.shareTreeNode,{style:"file"}),this.shareTree.load(),this.restActions.listShare(function(e){this.createShareTreeNode(e),this.shareTree.loadCallback&&this.shareTree.loadCallback.apply(this)}.bind(this),null,!1)},loadShareFile:function(e){var t=e.data.name;this.restActions.listShareAttachment(t,function(e){this.controller.clear(),e.data.each(function(e){this.controller.addAttachment(e)}.bind(this))}.bind(this))},createEditorTreeNode:function(e){e.data.each(function(e){var t=MWF.name.cn(e.name),i={expand:!1,title:t+"("+e.count+")",text:t+"("+e.count+")",action:function(e){this.loadEditorFile(e)}.bind(this),icon:"folder.png"};this.editorTree.appendChild(i).data=e}.bind(this))},loadEditorTreeNode:function(){this.editorTreeNode=new Element("div",{styles:this.css.folderTreeNode}).inject(this.editorTreeAreaScrollNode),this.editorTree=new MWF.widget.Tree(this.editorTreeNode,{style:"file"}),this.editorTree.load(),this.restActions.listEditor(function(e){this.createEditorTreeNode(e),this.editorTree.loadCallback&&this.editorTree.loadCallback.apply(this)}.bind(this),null,!1)},loadEditorFile:function(e){var t=e.data.name;this.restActions.listEditorAttachment(t,function(e){this.controller.clear(),e.data.each(function(e){this.controller.addAttachment(e)}.bind(this))}.bind(this))},loadFileContentAreaNode:function(){this.controller=new MWF.xApplication.File.AttachmentController(this.attachmentContentNode,this,{resize:!1,isSizeChange:!1}),this.controller.load()},createTreeNode:function(e,t){e.data.each(function(e){var i={expand:!1,title:e.name,text:e.name,action:function(e){this.recordHistory(e),this.expand(e,function(){this.loadSub(e)}.bind(this))}.bind(this),icon:"folder.png"};t.appendChild(i).data=e}.bind(this))},loadFolderTree:function(e,t){e.loaded?t&&t():(e.loaded=!0,e.data?this.restActions.listFolder(e.data.id,function(i){this.createTreeNode(i,e),e.setOperateIcon(),t&&t()}.bind(this),null,!1):this.restActions.listTopFolder(function(i){this.createTreeNode(i,e),e.setOperateIcon(),t&&t()}.bind(this),null,!1))},setContentHeight:function(e){var t=this.node.getSize(),i=this.topNode.getSize(),s=this.topNode.getStyle("margin-top").toFloat(),n=this.topNode.getStyle("margin-bottom").toFloat(),o=this.fileContentNode.getStyle("margin-top").toFloat(),l=this.fileContentNode.getStyle("margin-bottom").toFloat(),d=t.y-i.y-s-n-o-l;this.fileContentNode.setStyle("height",d),this.attachmentContentNode.setStyle("height",d);var r=d-this.controller.topNode.getSize().y;this.controller.contentScrollNode.setStyle("height",r+"px");d-=this.treeTab.tabNodeContainer.getSize().y;this.folderTreeAreaScrollNode.setStyle("height",d),this.shareTreeAreaScrollNode.setStyle("height",d),this.editorTreeAreaScrollNode.setStyle("height",d)},expand:function(e,t){e.options.expand?t&&t():(this.loadFolderTree(e,function(){t&&t()}.bind(this)),this.folderTree.expand(e),e.options.expand=!0,e.setOperateIcon())},checkHistory:function(){this.history.length>1?(this.currentHistory>0?this.enabledLeftNode():this.disabledLeftNode(),this.currentHistory<this.history.length-1?this.enabledRightNode():this.disabledRightNode()):(this.disabledLeftNode(),this.disabledRightNode())},enabledLeftNode:function(){this.leftNode.setStyle("background-image","url(../x_component_File/$Main/default/icon/left_enabled.png)")},enabledRightNode:function(){this.rightNode.setStyle("background-image","url(../x_component_File/$Main/default/icon/right_enabled.png)")},disabledLeftNode:function(){this.leftNode.setStyle("background-image","url(../x_component_File/$Main/default/icon/left.png)")},disabledRightNode:function(){this.rightNode.setStyle("background-image","url(../x_component_File/$Main/default/icon/right.png)")},leftPath:function(){if(this.currentHistory>0){this.currentHistory--;var e=this.history[this.currentHistory];e&&(e.selectNode(),this.loadSub(e),this.checkHistory())}},rightPath:function(){if(this.currentHistory<this.history.length-1){this.currentHistory++;var e=this.history[this.currentHistory];e&&(e.selectNode(),this.loadSub(e),this.checkHistory())}},recordHistory:function(e){this.history.length&&this.history[this.history.length-1]==e||(this.history.push(e),this.currentHistory=this.history.length-1,this.checkHistory())},setPathNode:function(e){this.pathNode.empty();for(var t=[],i=e;i;)t.unshift(i),i=i.parentNode;var s=this;t.each(function(e,i){this.expand(e);new Element("div",{styles:this.css.pathItemNode,text:e.data?e.data.name:"root",events:{mouseover:function(){this.setStyles(s.css.pathItemNode_over)},mouseout:function(){this.setStyles(s.css.pathItemNode)},click:function(){e.clickNode()}}}).inject(this.pathNode);i<t.length-1&&new Element("div",{styles:this.css.pathItemIconNode}).inject(this.pathNode)}.bind(this))},loadSub:function(e){this.setPathNode(e),this.controller.clear(),e.children.each(function(e){this.controller.addAttachmentFolder(e.data).treeNode=e}.bind(this)),this.currentFolder=e,e.data?this.restActions.listAttachment(e.data.id,function(e){e.data.each(function(e){this.controller.addAttachment(e)}.bind(this))}.bind(this)):this.restActions.listAttachmentTop(function(e){e.data.each(function(e){this.controller.addAttachment(e)}.bind(this))}.bind(this))},uploadFiles:function(e){if(this.uploadFileList||(this.uploadFileList=[]),this.uploadFileTotalSize||(this.uploadFileTotalSize=0),e&&e.length){for(var t=0;t<e.length&&t<5;t++)this.uploadFileList.push(e[t]),this.uploadFileTotalSize+=e[t].size;this.uploadNext()}},uploadNext:function(){if(this.uploadFileList.length){var e=this.uploadFileList.shift();e&&(this.uploadFile(e),this.uploadNext())}},uploadFile:function(e){var t=new FormData;t.append("file",e),t.append("name",e.name),t.append("folder",this.currentFolder&&this.currentFolder.data?this.currentFolder.data.id:""),this.restActions.addAttachment(this.currentFolder&&this.currentFolder.data?this.currentFolder.data.id:"(0)",t,e,function(){this.uploadFileList.length||(this.currentFolder?this.currentFolder.clickNode():this.topTreeNode.clickNode())}.bind(this))},initDropUpLoad:function(){this.fileContentAreaNode.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),this.dropUploadInforNode&&(this.dropUploadInforNode.destroy(),this.dropUploadInforNode=null),e.dataTransfer.types.length<2&&this.uploadFiles(e.dataTransfer.files)}.bind(this),!1),this.fileContentAreaNode.addEventListener("dragover",function(e){e.dataTransfer.types.length<2&&(e.stopPropagation(),e.preventDefault(),this.dropUploadInforNode||(this.dropUploadInforNode=new Element("div",{styles:this.css.dropUploadInforNode,text:this.lp.dropUpload}).inject(this.node),this.dropUploadInforNode.position({relativeTo:this.fileContentAreaNode,position:"centerBottom",edge:"centerBottom",offset:{x:0,y:-100}}),this.dropUploadInforNode.fade(.7)))}.bind(this),!1),this.fileContentAreaNode.addEventListener("dragleave",function(e){e.stopPropagation(),e.preventDefault(),this.dropUploadInforNode&&window.setTimeout(function(){this.dropUploadInforNode&&(this.dropUploadInforNode.destroy(),this.dropUploadInforNode=null)}.bind(this),2e3)}.bind(this),!1)}}),MWF.xApplication.File.Attachment=new Class({initialize:function(e,t){this.data=e,this.file=t,this.type="file",this.extension=this.data.name.substr(this.data.name.lastIndexOf(".")+1,this.data.name.length),this.load()},getIcon:function(){return"../x_component_File/$Main/default/file/"+(this.file.icons[this.extension]||this.file.icons.unknow)},load:function(){this.node=new Element("div",{styles:this.file.css.attachmentNode}),this.iconNode=new Element("div",{styles:this.file.css.attachmentIconNode}).inject(this.node),this.imgNode=new Element("div",{styles:this.file.css.attachmentImgNode}).inject(this.iconNode),this.imgNode.setStyle("background-image","url("+this.getIcon()+")"),this.textNode=new Element("div",{styles:this.file.css.attachmentTextNode,text:this.data.name,title:this.data.name}).inject(this.node),this.data.shareList&&this.data.shareList.length&&(this.shareIconNode=new Element("div",{styles:this.file.css.shareIconNode}).inject(this.node)),this.node.inject(this.file.fileContentAreaNode),this.setEvents()},setEvents:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.file.css.attachmentNode_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.file.css.attachmentNode)}.bind(this),click:function(e){this.selected(),e.stop(),e.stopPropagation()}.bind(this),dblclick:function(){this.open()}.bind(this)}),this.node.makeLnk({par:{icon:this.getIcon(),title:this.data.name,par:'FileOpen#{"id": "'+this.data.id+'", "type": "file"}'}})},selected:function(){this.file.selectedItem&&this.file.selectedItem.unSelected(),this.isSelected=!0,this.node.setStyles(this.file.css.attachmentNode_select),this.file.selectedItem=this},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.file.css.attachmentNode),this.file.selectedItem=null},open:function(){this.file.restActions.getAttachment(this.data.id)}}),MWF.xApplication.File.Folder=new Class({initialize:function(e,t){this.data=e,this.file=t,this.type="folder",this.load()},getIcon:function(){return"../x_component_File/$Main/default/file/folder.png"},load:function(){this.node=new Element("div",{styles:this.file.css.attachmentNode}),this.iconNode=new Element("div",{styles:this.file.css.attachmentIconNode}).inject(this.node),this.imgNode=new Element("img",{styles:this.file.css.attachmentImgNode,src:this.getIcon(),border:"0"}).inject(this.iconNode),this.textNode=new Element("div",{styles:this.file.css.attachmentTextNode,text:this.data.name}).inject(this.node),this.node.inject(this.file.fileContentAreaNode),this.setEvents()},setEvents:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.file.css.attachmentNode_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.file.css.attachmentNode)}.bind(this),click:function(e){this.selected(),e.stop(),e.stopPropagation()}.bind(this),dblclick:function(){this.open()}.bind(this)})},selected:function(){this.file.selectedItem&&this.file.selectedItem.unSelected(),this.isSelected=!0,this.node.setStyles(this.file.css.attachmentNode_select),this.file.selectedItem=this},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.file.css.attachmentNode),this.file.selectedItem=null},open:function(){this.treeNode.clickNode()}}),MWF.xApplication.File.ShareAttachment=new Class({Extends:MWF.xApplication.File.Attachment,initialize:function(e,t){this.data=e,this.file=t,this.type="share",this.extension=this.data.name.substr(this.data.name.lastIndexOf(".")+1,this.data.name.length),this.load()}});