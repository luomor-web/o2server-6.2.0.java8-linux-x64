MWF.SRVAD=MWF.xApplication.service.AgentDesigner=MWF.xApplication.service.AgentDesigner||{},MWF.SRVAD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("service.AgentDesigner","Agent",null,!1),MWF.require("MWF.xDesktop.UserData",null,!1),MWF.xApplication.service.AgentDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"service.AgentDesigner",icon:"icon.png",title:MWF.SRVAD.LP.title,appTitle:MWF.SRVAD.LP.title,id:"",actions:null,category:null,serviceData:null},onQueryLoad:function(){this.status&&(this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.SRVAD.LP.newAgent),this.actions=MWF.Actions.get("x_program_center"),this.lp=MWF.xApplication.service.AgentDesigner.LP,this.addEvent("queryClose",function(t){this.explorer&&this.explorer.reload()}.bind(this))},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openAgent():this.maxSize(function(){this.openAgent()}.bind(this)),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},openAgent:function(){this.loadNodes(),this.loadAgentListNodes(),this.loadContentNode(function(){this.loadProperty(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadAgent(),this.toolbarContentNode&&(this.setScrollBar(this.toolbarContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}}),this.setScrollBar(this.propertyDomArea,null,{V:{x:0,y:0},H:{x:0,y:0}}))}.bind(this))},loadNodes:function(){this.agentListNode=new Element("div",{styles:this.css.agentListNode}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node)},loadAgentListNodes:function(){this.agentListTitleNode=new Element("div",{styles:this.css.agentListTitleNode,text:MWF.SRVAD.LP.agentLibrary}).inject(this.agentListNode),this.agentListResizeNode=new Element("div",{styles:this.css.agentListResizeNode}).inject(this.agentListNode),this.agentListAreaSccrollNode=new Element("div.agentListAreaSccrollNode",{styles:this.css.agentListAreaSccrollNode}).inject(this.agentListNode),this.agentListAreaNode=new Element("div",{styles:this.css.agentListAreaNode}).inject(this.agentListAreaSccrollNode),this.loadAgentListResize(),this.loadAgentList()},loadAgentListResize:function(){this.agentListResize=new Drag(this.agentListResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var o=this.agentListAreaSccrollNode.getSize();t.store("initialWidth",o.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n=this.content.getSize(),o=t.retrieve("position"),s=t.retrieve("initialWidth").toFloat()+(i.toFloat()-o.x.toFloat());s>n.x/2&&(s=n.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-left",s+1),this.agentListNode.setStyle("width",s)}.bind(this)})},loadAgentList:function(){this.actions.listAgent(function(t){t.data.each(function(t){this.createListAgentItem(t)}.bind(this))}.bind(this),null,!1)},createListAgentItem:function(t,e){var i=this,n=new Element("div",{styles:this.css.listAgentItem}).inject(this.agentListAreaNode,e?"top":"bottom");new Element("div",{styles:this.css.listAgentItemIcon}).inject(n),new Element("div",{styles:this.css.listAgentItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newAgent}).inject(n);n.store("agent",t),n.addEvents({dblclick:function(t){i.loadAgentByData(this,t)},mouseover:function(){i.currentListAgentItem!=this&&this.setStyles(i.css.listAgentItem_over)},mouseout:function(){i.currentListAgentItem!=this&&this.setStyles(i.css.listAgentItem)}}),this.listAgentItemMove(n)},createAgentListCopy:function(t){var e=t.clone().inject(this.node);e.position({relativeTo:t,position:"upperLeft",edge:"upperLeft"});var i=e.getSize();return e.setStyles({width:i.x+"px",height:i.y+"px","z-index":50001}),e},listDragEnter:function(t,e){var i=e.retrieve("markNode");if(!i){var n=e.getSize();(i=new Element("div",{styles:this.css.dragListItemMark}).inject(this.node)).setStyles({width:n.x+"px",height:n.y+"px",position:"absolute","background-color":"#666","z-index":5e4,opacity:.3}),i.position({relativeTo:e,position:"upperLeft",edge:"upperLeft"});var o=i.getStyle("top").toFloat()-1,s=i.getStyle("left").toFloat()-2;i.setStyles({left:s+"px",top:o+"px"}),e.store("markNode",i)}},listDragLeave:function(t,e){var i=e.retrieve("markNode");i&&i.destroy(),e.eliminate("markNode")},listAgentItemMove:function(t){t.getFirst().addEvent("mousedown",function(e){if(t.retrieve("agent").id!=this.agentTab.showPage.agent.data.id){var i=this.createAgentListCopy(t),n=[this.designNode,this.propertyDomArea];new Drag.Move(i,{droppables:n,onEnter:function(t,e){this.listDragEnter(t,e)}.bind(this),onLeave:function(t,e){this.listDragLeave(t,e)}.bind(this),onDrag:function(t){}.bind(this),onDrop:function(t,e){e?(this.listDragLeave(t,e),i.destroy()):i.destroy()}.bind(this),onCancel:function(t){i.destroy()}.bind(this)}).start(e)}}.bind(this))},addIncludeAgent:function(t){var e=this.agentTab.showPage.agent;-1==e.data.dependAgentList.indexOf(t.name)&&(e.data.dependAgentList.push(t.name),this.addIncludeToList(t.name))},addIncludeToList:function(t){this.actions.getAgentByName(t,function(t){var e=t.data,i=new Element("div",{styles:this.css.includeAgentItem}).inject(this.propertyIncludeListArea),n=new Element("div",{styles:this.css.includeAgentItemAction}).inject(i);new Element("div",{styles:this.css.includeAgentItemText}).inject(i).set("text",e.name+" ("+e.alias+")"),i.store("agent",e);var o=this;n.addEvent("click",(function(){var t=this.getParent(),e=t.retrieve("agent");e&&o.agentTab.showPage.agent.data.dependAgentList.erase(e.name),t.destroy()}))}.bind(this),function(){this.agentTab.showPage.agent.data.dependAgentList.erase(t)}.bind(this))},loadAgentByData:function(t,e){for(var i=t.retrieve("agent"),n=!0,o=0;o<this.agentTab.pages.length;o++)if(i.id==this.agentTab.pages[o].agent.data.id){this.agentTab.pages[o].showTabIm(),n=!1;break}n&&this.loadAgentData(i.id,function(t){new MWF.xApplication.service.AgentDesigner.Agent(this,t).load()}.bind(this),!0)},loadContentNode:function(t,e){this.contentToolbarNode=new Element("div#contentToolbarNode",{styles:this.css.contentToolbarNode}).inject(this.contentNode),this.loadContentToolbar(t),this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode),this.loadEditContent(function(){this.designNode&&this.designNode.setStyles(this.css.designNode),e&&e()}.bind(this))},loadContentToolbar:function(t){this.getFormToolbarHTML(function(e){e.getElements("span").each(function(t,e){var i=t.get("MWFButtonImage");i&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+i)}.bind(this)),$(e).inject(this.contentToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(e,{style:"ProcessCategory"},this),this.toolbar.load();var i=this;this.styleSelectNode=e.getElement("select[MWFnodetype='theme']"),this.styleSelectNode.addEvent("change",(function(){i.changeEditorStyle(this)})),this.fontsizeSelectNode=e.getElement("select[MWFnodetype='fontSize']"),this.fontsizeSelectNode.addEvent("change",(function(){i.changeFontSize(this)})),this.editorSelectNode=e.getElement("select[MWFnodetype='editor']"),this.editorSelectNode.addEvent("change",(function(){i.changeEditor(this)})),this.monacoStyleSelectNode=e.getElement("select[MWFnodetype='monaco-theme']"),this.monacoStyleSelectNode.addEvent("change",(function(){i.changeEditorStyle(this)})),t&&t()}.bind(this))}.bind(this))},changeEditor:function(t){var e=t.selectedIndex,i=t.options[e].value;MWF.editorData||(MWF.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),MWF.editorData.javascriptEditor.editor=i,MWF.UD.putData("editor",MWF.editorData),this.agentTab.pages.each(function(t){var e=t.agent.editor;e&&e.changeEditor(i)}.bind(this)),"ace"==i?(this.monacoStyleSelectNode.hide(),this.styleSelectNode.show()):(this.monacoStyleSelectNode.show(),this.styleSelectNode.hide())},changeFontSize:function(t){var e=t.selectedIndex,i=t.options[e].value;this.agentTab.pages.each(function(t){var e=t.agent.editor;e&&e.setFontSize(i)}.bind(this)),MWF.editorData||(MWF.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),MWF.editorData.javascriptEditor.fontSize=i,MWF.UD.putData("editor",MWF.editorData)},changeEditorStyle:function(t){var e=t.selectedIndex,i=t.options[e].value;this.agentTab.pages.each(function(t){var e=t.agent.editor;e&&e.setTheme(i)}.bind(this)),MWF.editorData||(MWF.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),"monaco"===MWF.editorData.javascriptEditor.editor?MWF.editorData.javascriptEditor.monaco_theme=i:MWF.editorData.javascriptEditor.theme=i,MWF.UD.putData("editor",MWF.editorData)},getFormToolbarHTML:function(t){var e=this.path+this.options.style+"/toolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,i,n,o){var s=e[0];t&&t(s)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},maxOrReturnEditor:function(){this.isMax?(this.isMax=!1,this.designNode.inject(this.editContentNode),this.designNode.setStyles(this.css.designNode),this.designNode.setStyles({position:"static"}),this.resizeNode(),this.agentTab.pages.each((function(t){t.agent.setAreaNodeSize()}))):(this.designNode.inject(this.node),this.designNode.setStyles({position:"absolute",width:"100%",height:"100%",top:"0px",margin:"0px",left:"0px"}),this.agentTab.pages.each((function(t){t.agent.setAreaNodeSize()})),this.isMax=!0)},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode),MWF.require("MWF.widget.Tab",function(){this.agentTab=new MWF.widget.Tab(this.designNode,{style:"script"}),this.agentTab.load()}.bind(this),!1)},loadProperty:function(){this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:MWF.SRVAD.LP.property}).inject(this.propertyNode),this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.setPropertyContent()},setIncludeNode:function(){this.includeTitleNode=new Element("div",{styles:this.css.includeTitleNode}).inject(this.propertyDomArea),this.includeTitleActionNode=new Element("div",{styles:this.css.includeTitleActionNode}).inject(this.includeTitleNode),this.includeTitleTextNode=new Element("div",{styles:this.css.includeTitleTextNode,text:this.lp.include}).inject(this.includeTitleNode),this.includeTitleActionNode.addEvent("click",function(){this.addInclude()}.bind(this)),this.propertyIncludeListArea=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyDomArea)},addInclude:function(){},setPropertyContent:function(){new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.id+":"}).inject(this.propertyContentArea);this.propertyIdNode=new Element("div",{styles:this.css.propertyTextNode,text:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.name+":"}).inject(this.propertyContentArea),this.propertyNameNode=new Element("input",{styles:this.css.propertyInputNode,value:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.alias+":"}).inject(this.propertyContentArea),this.propertyAliasNode=new Element("input",{styles:this.css.propertyInputNode,value:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.cron+":"}).inject(this.propertyContentArea),this.propertyCronNode=new Element("input",{styles:this.css.propertyInputNode,value:""}).inject(this.propertyContentArea),this.loadCronTooltip(),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.lastStartTime+":"}).inject(this.propertyContentArea),this.propertyLastStartTimeNode=new Element("div",{styles:this.css.propertyTextNode,value:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.lastEndTime+":"}).inject(this.propertyContentArea),this.propertyLastEndTimeNode=new Element("div",{styles:this.css.propertyTextNode,value:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.description+":"}).inject(this.propertyContentArea),this.propertyDescriptionNode=new Element("textarea",{styles:this.css.propertyInputAreaNode,value:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.isEnable+":"}).inject(this.propertyContentArea);var t=new Element("div",{styles:this.css.propertyTextNode,text:""}).inject(this.propertyContentArea);this.propertyEnableNode=new Element("div",{styles:{float:"left",color:"red"},text:""}).inject(t),this.propertyEnableButton=new Element("input",{type:"button",styles:this.css.propertyButton,value:this.lp.enable}).inject(t),this.propertyEnableButton.addEvent("click",function(){var t=this.propertyEnableButton.retrieve("id");t&&this.actions.enableAgent(t,function(){this.refresh()}.bind(this))}.bind(this)),this.propertyDisableButton=new Element("input",{type:"button",styles:this.css.propertyButton,value:this.lp.disable}).inject(t),this.propertyDisableButton.addEvent("click",function(){var t=this.propertyDisableButton.retrieve("id");t&&this.actions.disableAgent(t,function(){this.refresh()}.bind(this))}.bind(this))},loadCronTooltip:function(){MWF.xDesktop.requireApp("Template","widget.CronPicker",null,!1),this.cronPicker=new MWF.xApplication.Template.widget.CronPicker(this.content,this.propertyCronNode,this,{},{style:"design",position:{x:"right",y:"auto"},onSelect:function(t){this.propertyCronNode.set("value",t),this.cronValue=t}.bind(this),onQueryLoad:function(){this.cronValue&&(this.cronPicker.node?this.cronPicker.setCronValue(this.cronValue):this.cronPicker.options.value=this.cronValue)}.bind(this)})},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var o=this.propertyNode.getSize();t.store("initialWidth",o.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n=this.content.getSize(),o=t.retrieve("position"),s=t.retrieve("initialWidth").toFloat()+(o.x.toFloat()-i.toFloat());s>n.x/2&&(s=n.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-right",s+1),this.propertyNode.setStyle("width",s)}.bind(this)})},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var o=this.propertyDomArea.getSize();t.store("initialHeight",o.y)}.bind(this),onDrag:function(t,e){var i=this.propertyContentNode.getSize(),n="firefox"==Browser.name?e.event.clientY:e.event.y,o=t.retrieve("position"),s=n.toFloat()-o.y.toFloat(),a=t.retrieve("initialHeight").toFloat()+s;a<40&&(a=40),a>i.y-40&&(a=i.y-40),this.propertyDomPercent=a/i.y,this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize();this.propertyContentArea.setStyle("height",t.y+"px")},resizeNode:function(){if(!this.isMax){var t=this.node.getSize();this.contentNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var e=this.contentToolbarNode.getStyle("margin-top").toFloat(),i=this.contentToolbarNode.getStyle("margin-bottom").toFloat(),n=this.contentToolbarNode.getComputedSize(),o=t.y-n.totalHeight-e-i;if(this.editContentNode.setStyle("height",o+"px"),this.designNode){var s=this.designNode.getStyle("margin-top").toFloat(),a=this.designNode.getStyle("margin-bottom").toFloat();o=t.y-n.totalHeight-e-i-s-a,this.designNode.setStyle("height",o+"px")}titleSize=this.propertyTitleNode.getSize(),titleMarginTop=this.propertyTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.propertyTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),o=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom,o=t.y-o,this.propertyContentNode.setStyle("height",o+"px"),this.propertyResizeBar.setStyle("height",o+"px"),this.setPropertyContentResize(),titleSize=this.agentListTitleNode.getSize(),titleMarginTop=this.agentListTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.agentListTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.agentListTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.agentListTitleNode.getStyle("padding-bottom").toFloat(),nodeMarginTop=this.agentListAreaSccrollNode.getStyle("margin-top").toFloat(),nodeMarginBottom=this.agentListAreaSccrollNode.getStyle("margin-bottom").toFloat(),o=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom,o=t.y-o,this.agentListAreaSccrollNode.setStyle("height",o+"px"),this.agentListResizeNode.setStyle("height",o+"px")}},loadAgent:function(){this.getAgentData(this.options.id,function(t){this.agent=new MWF.xApplication.service.AgentDesigner.Agent(this,t),this.agent.load(),this.status&&this.status.openAgents&&this.status.openAgents.each(function(t){this.loadAgentData(t,function(t){var e=!0;this.status.currentId&&this.status.currentId!=t.id&&(e=!1),new MWF.xApplication.service.AgentDesigner.Agent(this,t,{showTab:e}).load()}.bind(this),!0)}.bind(this))}.bind(this))},getAgentData:function(t,e){t?this.loadAgentData(t,e):this.loadNewAgentData(e)},loadNewAgentData:function(t){MWF.Actions.get("x_cms_assemble_control").getUUID(function(e){var i={name:"",id:e,alias:"",description:"",isNewAgent:!0,text:"",enable:!0,cron:"",lastStartTime:"",lastEndTime:"",appointmentTime:""};this.createListAgentItem(i,!0),t&&t(i)}.bind(this))},loadAgentData:function(t,e,i){this.actions.getAgent(t,function(t){if(t){var n=t.data;i||(this.setTitle(this.options.appTitle+"-"+n.name),this.taskitem.setText(this.options.appTitle+"-"+n.name),this.options.appTitle=this.options.appTitle+"-"+n.name),e&&e(n)}}.bind(this))},saveAgent:function(){if(this.agentTab.showPage){var t=this.agentTab.showPage.agent;t.save(function(){if(t==this.agent){var e=t.data.name;this.setTitle(MWF.SRVAD.LP.title+"-"+e),this.options.desktopReload=!0,this.options.id=t.data.id}}.bind(this))}},saveDictionaryAs:function(){this.dictionary.saveAs()},dictionaryExplode:function(){this.dictionary.explode()},dictionaryImplode:function(){this.dictionary.implode()},recordStatus:function(){if(this.agentTab){var t=[];this.agentTab.pages.each(function(e){e.agent.data.id!=this.options.id&&t.push(e.agent.data.id)}.bind(this));var e=this.agentTab.showPage.agent.data.id;return{id:this.options.id,openAgents:t,currentId:e}}return{id:this.options.id}}});