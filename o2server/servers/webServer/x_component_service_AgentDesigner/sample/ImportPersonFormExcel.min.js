print("批量导入人员");var File=Java.type("java.io.File"),Config={interfaceUrl:"http://lyxx.zoneland.net:20030/x_program_center/jaxrs/invoke/personSync/execute",localPath:File.separator+"data"+File.separator+"ImportPersonFromExcel"+File.separator,recordLocalPath:File.separator+"data"+File.separator+"ImportPersonFromExcelRecord"+File.separator};!function(e){"use strict";var t=Java.type("java.util.Timer"),r=Java.type("java.util.concurrent.Phaser"),a=new t("jsEventLoop",!1),n=new r,i=0;function l(){i++}function o(){--i>0||(a.cancel(),n.forceTermination())}var s=function(){n.arriveAndDeregister()};e.setTimeout=function(t,r){var i=[].slice.call(arguments,2,arguments.length),c=(n.register(),!1);return a.schedule((function(){if(!c)try{t.apply(e,i)}catch(e){print(e)}finally{s(),o()}}),r),l(),function(){s(),c=!0,o()}},e.clearTimeout=function(e){e()},e.setInterval=function(t,r){var a=[].slice.call(arguments,2,arguments.length),n=null,i=function(){n=e.setTimeout(i,r),t.apply(e,a)};return n=e.setTimeout(i,r),function(){n()}},e.clearInterval=function(e){e()}}(this);var Utils={parseResp:function(e){return e&&null!==e?JSON.parse(e.toString()):{type:"error",message:"服务响应是null，需要管理员查看后台日志"}},getFailText:function(e){var t;return t=e.message?e.message+(e.prompt?"("+e.prompt+")":""):e.prompt?e.prompt:"未知异常",print(t),t}};function getFileList(){var e=Config.localPath,t=new File(e),r=new(Java.type("java.util.ArrayList"));if(t.exists()){for(var a=t.listFiles(),n=0;n<a.length;n++)if(a[n].isFile()){print(a[n].getName());var i=a[n].getName().split(".");i[i.length-1].equals("xls")&&r.add(a[n])}}else print("目录不存在:"+e);return r}function importExcel(e){var t=Java.type("java.io.FileInputStream"),r="",a=null;try{a=new t(e);var n=null;try{var i=e.getName();if(i.endsWith(".xls")){n=new(Java.type("org.apache.poi.hssf.usermodel.HSSFWorkbook"))(a)}else{if(!i.endsWith(".xlsx"))return r="不支持的文件类型！",print(r),!1;n=new(Java.type("org.apache.poi.hssf.usermodel.XSSFWorkbook"))(a)}}catch(e){return r="解析Excel文件出错！",print(r),e.printStackTrace(),!1}finally{a.close()}if(0===r.length){null!==n&&n.getNumberOfSheets();var l=n.getSheetAt(0),o=l.getPhysicalNumberOfRows();o>1?runImportRow(l,1,o):r="EXCEL没有数据，请确定。"}return r.length()>0?(print("错误消息："+r),!1):(print(e.getName()+"导入成功！"),!0)}catch(e){return e.printStackTrace(),!1}}var Cell=Java.type("org.apache.poi.ss.usermodel.Cell");function runImportRow(e,t,r){if(t<r){var a=e.getRow(t),n=a.getLastCellNum();if(n>0){print("正在执行导入第"+t+"行");importRow(a,n)}t+=1,setTimeout((function(){runImportRow(e,t,r)}),100)}}function importRow(e,t){var r={action:"add",forceFlag:"yes",attributeList:[]};print("cells = "+t);for(var a=0;a<t;a++){var n="",i=e.getCell(a);null!==i&&(i.getCellType()==Cell.CELL_TYPE_NUMERIC&&-1==java.lang.String.valueOf(i.getNumericCellValue()).indexOf("E")?n=java.lang.String.valueOf(i.getNumericCellValue()):(i.setCellType(Cell.CELL_TYPE_STRING),n=i.getStringCellValue().trim()));switch(a){case 0:r.employee=n;break;case 1:r.unique=n;break;case 2:r.mobile=n;break;case 3:r.mail=n;break;case 4:r.name=n;break;case 5:r.unitList=[{flag:n}]}0}return r.unique&&"0"!=r.unique?sendRequest(r):""}function sendRequest(e){var t="";try{"string"==typeof e&&(e=JSON.parse(bodyStr)),e.saveFlag="no";var r=com.x.base.core.project.connection.CipherConnectionAction.post(!1,Config.interfaceUrl,JSON.stringify(e)),a=Utils.parseResp(r);a.type&&"success"==a.type&&a.data&&a.data.value&&a.data.value.result&&"success"==a.data.value.result||(t=Utils.getFailText(a))}catch(e){t=e.printStackTrace()}finally{return print("resend person errorText="+t),t}}function init(){for(var e=getFileList(),t=0;t<e.size();t++)try{var r=e.get(t);if(importExcel(r)){print("正在修改文件目录："+r.getName());var a=Config.recordLocalPath+r.getName();r.renameTo(new File(a))?print("文件移动到了:"+a):print(r.getName()+" is failed to move!")}}catch(e){e.printStackTrace()}}init();