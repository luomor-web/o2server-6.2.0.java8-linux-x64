var _self=this,applications=resources.getContext().applications(),departmentLevel_1=3;function typeOf(e){if(null===e)return"null";if(!e)return typeof e;if(null!=e.$family)return e.$family();if(e.constructor==Array)return"array";if(e.nodeName){if(1==e.nodeType)return"element";if(3==e.nodeType)return/\S/.test(e.nodeValue)?"textnode":"whitespace"}else if("number"==typeof e.length&&e.callee)return"arguments";return typeof e}function objectClone(e){if(null==e||"object"!=typeof e)return e;if("number"==typeof e.length){for(var t=[],r=0,n=e.length;r<n;++r)t[r]=objectClone(e[r]);return t}t={};for(var a in e)t[a]=objectClone(e[a]);return t}function parseResp(e){return e&&null!==e?JSON.parse(e.toString()):{type:"error",message:"服务响应是null"}}function getPerson(e){var t={personList:"array"===typeOf(e)?e:[e]},r=parseResp(applications.postQuery("x_organization_assemble_express","person/list/object",JSON.stringify(t)));return r&&"error"!==r.type&&r.data&&r.data.length?r.data[0]:""}function getPhone(e){var t={personList:"array"===typeOf(e)?e:[e]},r=parseResp(applications.postQuery("x_organization_assemble_express","person/list/object",JSON.stringify(t))),n=[];if(r&&"error"!==r.type&&r.data&&r.data.length){for(var a=0;a<r.data.length;a++){var i=r.data[a];n.push(i.mobile)}return n}return""}function getPhoneByIdentityDn(e){var t={identityList:"array"===typeOf(e)?e:[e]},r=parseResp(applications.postQuery("x_organization_assemble_express","person/list/identity/object",JSON.stringify(t))),n=[];if(r&&"error"!==r.type&&r.data&&r.data.length){for(var a=0;a<r.data.length;a++){var i=r.data[a];n.push(i.mobile)}return n}return""}function getDepartmentLevel_1(e){var t={personList:"array"===typeOf(e)?e:[e]},r=parseResp(applications.postQuery("x_organization_assemble_express","unit/list/person/sup/nested/object",JSON.stringify(t)));if(!(r&&"error"!==r.type&&r.data&&r.data.length))return"";for(var n=0;n<r.data.length;n++){var a=r.data[n];if(3==a.level)return a.distinguishedName}}function getCompany(e){var t={personList:"array"===typeOf(e)?e:[e]},r=parseResp(applications.postQuery("x_organization_assemble_express","unit/list/person/sup/nested/object",JSON.stringify(t)));if(!(r&&"error"!==r.type&&r.data&&r.data.length))return"";for(var n=0;n<r.data.length;n++){var a=r.data[n];if(2==a.level)return a.distinguishedName}}function getActivityOwner(e,t,r){var n="o.companyDn='"+e+"' and o.processAlias='"+t+"' and o.activityAlias='"+r+"'";n=n.replace(/\s/g,"%20");var a=parseResp(applications.getQuery("x_query_assemble_surface","table/list/hrMarketSetting_ActivityOwner/row/select/where/"+n));return a&&"error"!==a.type&&a.data&&a.data.length?a.data[0].identityDn:null}function getHrManagerIdentityList(e){if(!e)return[];var t=parseResp(applications.postQuery("x_organization_assemble_express","unitduty/list/identity/unit/name",JSON.stringify({name:"人才市场人力管理员",unit:e})));return t&&"error"!==t.type&&t.data?t.data.identityList:[]}function getDepartmentManagerIdentityList(e){if(!e)return[];var t=parseResp(applications.postQuery("x_organization_assemble_express","unitduty/list/identity/unit/name",JSON.stringify({name:"人才市场部门管理员",unit:e})));return t&&"error"!==t.type&&t.data?t.data.identityList:[]}var CipherConnectionAction=Java.type("com.x.base.core.project.connection.CipherConnectionAction"),Config=Java.type("com.x.base.core.project.config.Config");function sendSMS(e){if(e&&e.receiveMobile&&e.content)for(var t="array"===typeOf(e.receiveMobile)?e.receiveMobile:[e.receiveMobile],r="array"===typeOf(e.receivePerson)?e.receivePerson:[e.receivePerson],n=0;n<t.length;n++){var a=objectClone(e);a.receiveMobile=t[n],a.receivePerson=r[n]?r[n]:"";CipherConnectionAction.post(!1,Config.x_program_centerUrlRoot()+"invoke/sendSMS/execute",JSON.stringify(a))}}function sendSMS_levelToLearn(){print("发离岗学习到期短信");var e="(o.sendedSMSDate is null) and o.status='离岗学习员工' and o.createTime<'"+function(){var e=Java.type("java.util.Calendar"),t=new java.text.SimpleDateFormat("yyyy-MM-dd"),r=e.getInstance();r.add(e.MONTH,-3),r.add(e.DAY_OF_YEAR,7);var n=r.getTime();return t.format(n)}()+"'";e=e.replace(/\s/g,"%20"),print(e);var t=parseResp(applications.getQuery("x_query_assemble_surface","table/list/hrMarketResourcePool/row/select/where/"+e));if(t&&"error"!==t.type&&t.data&&t.data.length)for(var r=0;r<t.data.length;r++){var n,a=t.data[r],i="员工"+(a.name||"").split("@")[0]+"的离岗学习期还有一周即将结束，请相关部门尽快完成考核。",o=getActivityOwner(a.company,"probationCheck","hrManager");if(o)print(o),(n=getPhoneByIdentityDn(o))&&sendSMS({employeeCode:a.employeeCode,person:a.name,typeName:"离岗学习员工",typeCode:"levelToLearn",receiveMobile:n,receivePerson:o,content:i});else(s=getHrManagerIdentityList(a.company)).length&&(n=getPhoneByIdentityDn(s))&&sendSMS({employeeCode:a.employeeCode,person:a.name,typeName:"离岗学习员工",typeCode:"levelToLearn",receiveMobile:n,receivePerson:s,content:i});var s,p=a.transferDepartment;if(p)(s=getDepartmentManagerIdentityList(p)).length&&(print(s),(n=getPhoneByIdentityDn(s))&&sendSMS({employeeCode:a.employeeCode,person:a.name,typeName:"离岗学习员工",typeCode:"levelToLearn",receiveMobile:n,receivePerson:s,content:i}));formatter=new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss"),a.sendedSMSDate=formatter.format(new java.util.Date),applications.putQuery("x_query_assemble_surface","table/hrMarketResourcePool/row/"+a.id,JSON.stringify(a))}}function sendSMS_internalChange(){print("发送内部转岗短信");var e="(o.sendedSMSDate is null) and o.status='内部转岗员工' and o.createTime<'"+function(){var e=Java.type("java.util.Calendar"),t=new java.text.SimpleDateFormat("yyyy-MM-dd"),r=e.getInstance();r.add(e.MONTH,-1),r.add(e.DAY_OF_YEAR,7);var n=r.getTime();return t.format(n)}()+"'";e=e.replace(/\s/g,"%20"),print(e);var t=parseResp(applications.getQuery("x_query_assemble_surface","table/list/hrMarketResourcePool/row/select/where/"+e));if(t&&"error"!==t.type&&t.data&&t.data.length)for(var r=0;r<t.data.length;r++){var n,a=t.data[r],i="员工"+(a.name||"").split("@")[0]+"的内部转岗期还有一周即将到期。",o=getActivityOwner(a.company,"internalWaiting","hrManager2");if(o)print(o),(n=getPhoneByIdentityDn(o))&&sendSMS({employeeCode:a.employeeCode,person:a.name,typeName:"内部转岗员工",typeCode:"internalChange",receiveMobile:n,receivePerson:o,content:i});else{var s=getHrManagerIdentityList(a.company);s.length&&(print(s),(n=getPhoneByIdentityDn(s))&&sendSMS({employeeCode:a.employeeCode,person:a.name,typeName:"内部转岗员工",typeCode:"internalChange",receiveMobile:n,receivePerson:s,content:i}))}formatter=new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss"),a.sendedSMSDate=formatter.format(new java.util.Date),applications.putQuery("x_query_assemble_surface","table/hrMarketResourcePool/row/"+a.id,JSON.stringify(a))}}function checkSended_contractNotice(e){var t="o.employeeCode='"+e+"' and o.typeCode='contractNotice'";t=t.replace(/\s/g,"%20"),print(t);var r=parseResp(applications.getQuery("x_query_assemble_surface","table/list/hrMarketSMSLog/row/select/where/"+t));return!!(r&&"error"!==r.type&&r.data&&r.data.length)}function sendSMS_contractNotice(){print("发送合同续签短信");var e="o.CONTRACT_END='"+function(){var e=Java.type("java.util.Calendar"),t=new java.text.SimpleDateFormat("yyyy-MM-dd"),r=e.getInstance();r.add(e.MONTH,-2);var n=r.getTime();return t.format(n)}()+"'";e=e.replace(/\s/g,"%20"),print(e);var t=parseResp(applications.getQuery("x_query_assemble_surface","table/list/hrSyncPersonalContract/row/select/where/"+e));if(t&&"error"!==t.type&&t.data&&t.data.length)for(var r=0;r<t.data.length;r++){var n=t.data[r];if(!checkSended_contractNotice(n.EMPLOYEE_NUMBER)){var a,i=getPerson(n.EMPLOYEE_NUMBER);if(!i)return;i.mobile&&(print(i.mobile),sendSMS({employeeCode:n.EMPLOYEE_NUMBER,person:i.distinguishedName,typeName:"合同到期员工",typeCode:"contractNotice",receiveMobile:i.mobile,receivePerson:i.distinguishedName,content:(i.name||"")+"您好，您的合同还有一周即将到期。"}));var o="员工"+(i.name||"").split("@")[0]+"的合同还有一周即将到期。",s=getDepartmentLevel_1(n.EMPLOYEE_NUMBER);if(s)(l=getDepartmentManagerIdentityList(s))&&l.length&&(print(l),(a=getPhoneByIdentityDn(l))&&sendSMS({employeeCode:n.EMPLOYEE_NUMBER,person:i.distinguishedName,typeName:"合同到期员工",typeCode:"contractNotice",receiveMobile:a,receivePerson:l,content:o}));var p=getCompany(n.EMPLOYEE_NUMBER);if(p){var l,c=getActivityOwner(p,"contractRenewal","hrManager");if(c)print(c),(a=getPhoneByIdentityDn(c))&&sendSMS({employeeCode:n.EMPLOYEE_NUMBER,person:i.distinguishedName,typeName:"合同到期员工",typeCode:"contractNotice",receiveMobile:a,receivePerson:c,content:o});else(l=getHrManagerIdentityList(p)).length&&(print(l),(a=getPhoneByIdentityDn(l))&&sendSMS({employeeCode:n.EMPLOYEE_NUMBER,person:i.distinguishedName,typeName:"合同到期员工",typeCode:"contractNotice",receiveMobile:a,receivePerson:l,content:o}))}}}}sendSMS_levelToLearn(),sendSMS_internalChange(),sendSMS_contractNotice();