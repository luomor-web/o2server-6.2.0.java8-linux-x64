load("nashorn:mozilla_compat.js"),print("----发送待办开始---------");var Todo_Service_URL="http://hostname/UnifiedWorkbench/ProcessTaskService",Read_Service_URL="http://hostname/UnifiedWorkbench/ProcessReadService",Project_Name="测试",Project_Password="password";function getServerHost(){return"http://zhtest.ah.unicom.local"}function getServerPort(){return":8080"}function init(){for(var e=resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/list/sync2todo/count/30").getData().toString(),r=JSON.parse(e),a=0;a<r.length;a++){var t=r[a];switch(t.type){case"task_create":var s=JSON.parse(t.body);send_task_create(t.id,s);break;case"taskCompleted_create":s=JSON.parse(t.body);send_taskCompleted_create(t.id,s);break;case"taskCompleted_delete":s=JSON.parse(t.body);send_task_delete(t.id,s);break;case"read_create":var o=JSON.parse(t.body);send_read_create(t.id,o);break;case"readCompleted_create":o=JSON.parse(t.body);send_readCompleted_create(t.id,o);break;case"task_delete":s=JSON.parse(t.body);send_task_delete(t.id,s);break;case"read_delete":o=JSON.parse(t.body);send_read_delete(t.id,o)}}}function getPersonFeature(e){return"wangyj733"}function getPersonAttribute(e,r){var a=resources.getOrganization().personAttribute().listAttributeWithPersonWithName(e,r);return 0===a.length?e:a[0]&&""!=a[0]?a[0]:e}function concatUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?workid="+e.work}function concatTaskUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?taskid="+e.id}function concatTaskCompletedUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?taskcompletedid="+e.id}function concatReadUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?readid="+e.id}function concatReadCompletedUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?readcompletedid="+e.id}function getXMLText(e,r){var a=e.getElementsByTagName(r);if(null==a)return null;var t=a.item(0);return null==t?null:t.getTextContent()}function updateConsume(e){try{resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/"+e+"/type/sync2todo")}catch(r){return print("更新消息,将消息标志为已处理出错，id="+e+"："),print(r.printStackTrace()),!1}}function isRespSuccess(e){try{var r=Java.type("javax.xml.parsers.DocumentBuilderFactory"),a=Java.type("java.io.StringReader"),t=Java.type("org.xml.sax.InputSource"),s=r.newInstance().newDocumentBuilder(),o=new t(new a(e)),n=s.parse(o).getDocumentElement(),g=getXMLText(n,"faultcode");getXMLText(n,"faultstring");return!g}catch(e){return print("解析返回结果报错："),print(e.printStackTrace()),!1}}function sendRequest_task(e){try{print("发起请求:"+e);var r=new(Java.type("java.util.ArrayList")),a=new(Java.type("com.x.base.core.project.bean.NameValuePair"))("Content-Type","text/xml; charset=utf-8");r.add(a);var t=Java.type("com.x.base.core.project.connection.HttpConnection").postAsString(Todo_Service_URL,r,e);return print("统一待办返回:"+t),isRespSuccess(t)}catch(e){print("发送请求出错："),print(e.printStackTrace())}}function get_task_create_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:update>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2>"+getPersonFeature(e.person)+"</arg2>",r+="<arg3></arg3>",r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>",r+="<arg5>"+e.opinion+"</arg5>",r+="<arg6>"+e.title+"</arg6>",r+="<arg7>"+e.work+"</arg7>",r+="<arg8>"+e.job+"</arg8>",r+="<arg9>"+e.id+"</arg9>",r+="<arg10>"+e.routeName+"</arg10>",r+="<arg11>"+e.startTime+"</arg11>",r+="<arg12>"+e.processName+"</arg12>",r+="<arg13>"+e.processName+"</arg13>",r+="<arg14>"+e.activityName+"</arg14>",r+="<arg15>false</arg15>",r+="<arg16>"+e.processName+"</arg16>",r+="<arg17></arg17>",r+="<arg18></arg18>",r+="<arg19>"+e.serial+"</arg19>",r+="<arg20>0</arg20>",r+="<arg21></arg21>",r+="<arg22>false</arg22>",r+="<arg23>0</arg23>",r+="<arg24></arg24>",r+="<arg25>false</arg25>",r+="<arg26>false</arg26>",r+="<arg27>"+concatTaskUrl(e)+"</arg27>",r+="<arg28></arg28>",r+="<arg29></arg29>",r+="<arg30></arg30>",r+="<arg31></arg31>",r+="<arg32></arg32>",r+="<arg33></arg33>",r+="<arg34></arg34>",r+="</proc:update>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_task_create(e,r){print("======send_task_create start=========, consume id  : "+e),sendRequest_task(get_task_create_xml(r))&&updateConsume(e),print("======send_task_create end=========, consume id : "+e)}function get_task_delete_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:removeTaskAsFeature>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2>"+e.id+"</arg2>",r+="</proc:removeTaskAsFeature>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_task_delete(e,r){print("--------send_task_delete start------------, consume id : "+e),sendRequest_task(get_task_delete_xml(r))&&updateConsume(e),print("--------send_task_delete end------------, consume id : "+e)}function get_taskCompleted_create_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:update>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2></arg2>",r+="<arg3>"+getPersonFeature(e.person)+"</arg3>",r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>",r+="<arg5>"+e.opinion+"</arg5>",r+="<arg6>"+e.title+"</arg6>",r+="<arg7>"+e.work+"</arg7>",r+="<arg8>"+e.job+"</arg8>",r+="<arg9>"+e.id+"</arg9>",r+="<arg10>"+e.routeName+"</arg10>",r+="<arg11>"+e.startTime+"</arg11>",r+="<arg12>"+e.processName+"</arg12>",r+="<arg13>"+e.processName+"</arg13>",r+="<arg14>"+e.activityName+"</arg14>",r+="<arg15>false</arg15>",r+="<arg16>"+e.processName+"</arg16>",r+="<arg17></arg17>",r+="<arg18></arg18>",r+="<arg19>"+e.serial+"</arg19>",r+="<arg20>0</arg20>",r+="<arg21></arg21>",r+="<arg22>false</arg22>",r+="<arg23>0</arg23>",r+="<arg24></arg24>",r+="<arg25>false</arg25>",r+="<arg26>false</arg26>",r+="<arg27>"+concatTaskCompletedUrl(e)+"</arg27>",r+="<arg28></arg28>",r+="<arg29></arg29>",r+="<arg30></arg30>",r+="<arg31></arg31>",r+="<arg32></arg32>",r+="<arg33></arg33>",r+="<arg34></arg34>",r+="</proc:update>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_taskCompleted_create(e,r){print("--------send_taskCompleted_create start------------, consume id : "+e),sendRequest_task(get_taskCompleted_create_xml(r))&&updateConsume(e),print("--------send_taskCompleted_create end------------, consume id  : "+e)}function sendRequest_read(e){try{print("发起请求:"+e);var r=new(Java.type("java.util.ArrayList")),a=new(Java.type("com.x.base.core.project.bean.NameValuePair"))("Content-Type","text/xml; charset=utf-8");r.add(a);var t=Java.type("com.x.base.core.project.connection.HttpConnection").postAsString(Read_Service_URL,r,e);return print("统一待办返回:"+t),isRespSuccess(t)}catch(e){print("发送请求出错："),print(e.printStackTrace())}}function get_read_create_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:update>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2>"+getPersonFeature(e.person)+"</arg2>",r+="<arg3></arg3>",r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>",r+="<arg5>"+e.title+"</arg5>",r+="<arg6>"+e.work+"</arg6>",r+="<arg7>"+e.job+"</arg7>",r+="<arg8>"+e.processName+"</arg8>",r+="<arg9>"+e.processName+"</arg9>",r+="<arg10>"+e.activityName+"</arg10>",r+="<arg11>"+e.processName+"</arg11>",r+="<arg12></arg12>",r+="<arg13></arg13>",r+="<arg14>"+e.serial+"</arg14>",r+="<arg15>"+e.id+"</arg15>",r+="<arg16></arg16>",r+="<arg17>false</arg17>",r+="<arg18>false</arg18>",r+="<arg19>"+e.startTime+"</arg19>",r+="<arg20></arg20>",r+="<arg21></arg21>",r+="<arg22>"+concatReadUrl(e)+"</arg22>",r+="<arg23></arg23>",r+="<arg24></arg24>",r+="<arg25></arg25>",r+="<arg26></arg26>",r+="<arg27></arg27>",r+="<arg28></arg28>",r+="<arg29></arg29>",r+="</proc:update>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_read_create(e,r){print("======send_read_create start=========, consume id   : "+e),sendRequest_read(get_read_create_xml(r))&&updateConsume(e),print("======send_read_create end=========, consume id : "+e)}function get_read_delete_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:removeReadAsFeature>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2>"+e.id+"</arg2>",r+="</proc:removeReadAsFeature>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_read_delete(e,r){print("--------send_read_delete start------------, consume id : "+e),sendRequest_read(get_read_delete_xml(r))&&updateConsume(e),print("--------send_read_delete end------------, consume id : "+e)}function get_read_create_xml(e){var r="";return r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">',r+="<soapenv:Header/>",r+="<soapenv:Body>",r+="<proc:update>",r+="<arg0>"+Project_Name+"</arg0>",r+="<arg1>"+Project_Password+"</arg1>",r+="<arg2></arg2>",r+="<arg3>"+getPersonFeature(e.person)+"</arg3>",r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>",r+="<arg5>"+e.title+"</arg5>",r+="<arg6>"+e.work+"</arg6>",r+="<arg7>"+e.job+"</arg7>",r+="<arg8>"+e.processName+"</arg8>",r+="<arg9>"+e.processName+"</arg9>",r+="<arg10>"+e.activityName+"</arg10>",r+="<arg11>"+e.processName+"</arg11>",r+="<arg12></arg12>",r+="<arg13></arg13>",r+="<arg14>"+e.serial+"</arg14>",r+="<arg15>"+e.id+"</arg15>",r+="<arg16></arg16>",r+="<arg17>false</arg17>",r+="<arg18>false</arg18>",r+="<arg19>"+e.startTime+"</arg19>",r+="<arg20></arg20>",r+="<arg21></arg21>",r+="<arg22>"+concatReadCompletedUrl(e)+"</arg22>",r+="<arg23></arg23>",r+="<arg24></arg24>",r+="<arg25></arg25>",r+="<arg26></arg26>",r+="<arg27></arg27>",r+="<arg28></arg28>",r+="<arg29></arg29>",r+="</proc:update>",r+="</soapenv:Body>",r+="</soapenv:Envelope>"}function send_readCompleted_create(e,r){print("--------send_readCompleted_create start------------, consume id : "+e),sendRequest_read(get_readCompleted_create_xml(r))&&updateConsume(e),print("--------send_readCompleted_create end------------, consume id  : "+e)}init(),print("----发送待办结束---------");