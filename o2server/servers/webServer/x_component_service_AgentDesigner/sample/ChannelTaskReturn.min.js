printLog("运行代理渠道任务完成情况反馈"),load("nashorn:mozilla_compat.js");var File=Java.type("java.io.File"),Root_Dir="D:"+File.separator+"FTPFile"+File.separator+"ChannelTask"+File.separator+"Result",Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator;function createRecordFloder(){var e=new(Java.type("java.util.Date")),r=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(e)+File.separator+new java.text.SimpleDateFormat("MM").format(e)+File.separator+new java.text.SimpleDateFormat("dd").format(e)+File.separator+"Return",t=new File(r);return t.exists()||t.mkdirs()?r:(print("创建记录文件夹失败："+r),null)}function getFileList(){var e=Root_Dir,r=new File(e),t=new(Java.type("java.util.ArrayList"));if(r.exists()){for(var a=r.listFiles(),i=0;i<a.length;i++)if(a[i].isFile()){var n=a[i].getName().split(".");n[n.length-1].toUpperCase().equals("REQ")&&t.add(a[i])}}else printLog("目录不存在:"+e);return t}function printLog(e){print(e)}function getPureText(e){return null===e||('"'===e.substr(0,1)&&(e=e.substr(1,e.length-1)),'"'===e.substr(e.length-1,1)&&(e=e.substr(0,e.length-1))),e}function getWorkCompltedId(e){var r={filterList:[{logic:"and",path:"branchWorkId",title:"branchWorkId",comparison:"equals",comparisonTitle:"等于",value:e,formatType:"textValue"}]},t=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify(r)).getAsJsonObject().get("grid");if(t){print("grid="+t);var a=t.getAsJsonArray();if(a.size()>0){var i=a.get(0);if(print("workData="+i),i&&null!=i){var n=i.get("data");if(n&&null!=n){var l=n.get("workCompletedId");if(l&&null!=l)return l=getPureText(l.toString())}}}}return null}function setWorkData(e,r,t,a){var i=!0,n=getWorkCompltedId(e);if(null===n)return print("根据branchWorkId'"+e+"'不能获取workCompletedId"),!1;print("根据branchWorkId'"+e+"'获取workCompletedId为"+n);try{var l,o=resources.getWebservicesClient(),s=o.jaxrsGet("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishedLog");if(print(s),null!=s&&""!==s){var p=s.toString();(l=JSON.parse(p)).push({dateStr:r,finishCount:a})}else l=[{dateStr:r,finishCount:a}];o.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishedLog",JSON.stringify(l)),o.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishCount",a),print("branchWorkId='"+e+"' workCompletedId='"+n+"'的工作保存完毕")}catch(e){i=!1,e.printStackTrace()}finally{return i}}function readFileByLines(e){var r=!0,t=Java.type("java.io.FileInputStream"),a=Java.type("java.io.InputStreamReader"),i=Java.type("java.io.BufferedReader"),n=null;try{n=new a(new t(e),"GBK")}catch(e){return e.printStackTrace(),r=!1}var l=null;try{print("正在读取文件"+e.getName()+"："),l=new i(n);for(var o=null,s=1;null!=(o=l.readLine());){print("line "+s+": "+o);var p=o.split("|");if(p.length>5){var u=p[2];print("branchWorkId="+u),setWorkData(u,p[0],p[3],p[4])||(r=!1)}s++}l.close()}catch(e){r=!1,e.printStackTrace()}finally{if(null!=l)try{l.close()}catch(e){return r}return r}}function init(){var e=getFileList(),r=null;e.size()>0&&(r=createRecordFloder());for(var t=0;t<e.size();t++)try{var a=e.get(t);if(readFileByLines(a)&&null!==r){print("正在修改文件目录："+a.getName());var i=r+File.separator+a.getName(),n=new File(i);n.exists()&&n.delete(),a.renameTo(n)?print("文件移动到了:"+i):print(a.getName()+" is failed to move!")}}catch(e){e.printStackTrace()}}init();