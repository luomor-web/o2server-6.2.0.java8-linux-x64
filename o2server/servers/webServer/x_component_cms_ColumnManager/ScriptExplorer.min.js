MWF.xDesktop.requireApp("cms.ColumnManager","DictionaryExplorer",null,!1),MWF.xApplication.cms.ColumnManager.ScriptExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.DictionaryExplorer,Implements:[Options,Events],options:{create:MWF.CMSCM.LP.dictionary.create,search:MWF.CMSCM.LP.dictionary.search,searchText:MWF.CMSCM.LP.dictionary.searchText,noElement:MWF.CMSCM.LP.dictionary.noDictionaryNoticeText},_createElement:function(t){var i=this,e={onQueryLoad:function(){this.actions=i.app.restActions,this.application=i.app.options.application||i.app.application||i.app.options.column||i.app.column,this.column=this.application,this.explorer=i},onPostSave:function(){i.reload()}};this.app.desktop.openApplication(t,"cms.ScriptDesigner",e)},_loadItemDataList:function(t){var i="";this.app.application&&(i=this.app.application.id),this.app.options.application&&(i=this.app.options.application.id),this.actions.listScript(i,t)},_getItemObject:function(t,i){return new MWF.xApplication.cms.ColumnManager.ScriptExplorer.Script(this,t,{index:i})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.script.create,search:MWF.CMSCM.LP.script.search,searchText:MWF.CMSCM.LP.script.searchText,noElement:MWF.CMSCM.LP.script.noScriptNoticeText}},deleteItems:function(){for(;this.deleteMarkItems.length;){var t=this.deleteMarkItems.shift();this.deleteMarkItems.length?t.deleteScript():t.deleteScript(function(){this.hideDeleteAction(),this.reload()}.bind(this))}},keyCopy:function(t){if(this.selectMarkItems.length){var i=[],e=0,a=function(t){if(e>=this.selectMarkItems.length&&i.length){var a=JSON.encode(i);t?t.clipboardData.setData("text/plain",a):window.clipboardData.setData("Text",a),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getScript(n.data.id,function(n){n.data.elementType="script",i.push(n.data),e++,a(t)}.bind(this),null,!1)}.bind(this))}},keyPaste:function(t){var i="";i=t?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var e=JSON.decode(i);this.pasteItem(e,0)},pasteItem:function(t,i){if(i<t.length){var e=t[i];"script"===e.elementType?this.saveItemAs(e,function(){i++,this.pasteItem(t,i)}.bind(this),function(){i++,this.pasteItem(t,i)}.bind(this),function(){this.reload()}.bind(this)):(i++,this.pasteItem(t,i))}else this.reload()},saveItemAs:function(t,i,e,a){this.app.restActions.listScript(this.app.options.application.id,function(n){n.data=n.data||[];var o=n.data.filter((function(i){return i.id===t.id}));if(o.length){var p=o[0],s=this.app.lp,r=this,c=(new Date).parse(t.lastUpdateTime),l=(new Date).parse(p.lastUpdateTime),d="<div>"+s.copyConfirmInfor+"</div>";d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+s.copySource+" "+p.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left'>"+p.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(p.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(c>=l?"":s.copynew)+"</div></div>",d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+s.copyTarget+" "+t.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left;'>"+t.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(t.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(c<=l?"":s.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:d},500,290,[{text:s.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(p,t,i,e),this.close()}},{text:s.copyConfirm_new,action:function(){r.saveItemAsNew(n,t,i,e),this.close()}},{text:s.copyConfirm_skip,action:function(){this.close(),i&&i()}},{text:s.copyConfirm_cancel,action:function(){this.close(),a&&a()}}])}else this.saveItemAsNew(n,t,i,e)}.bind(this),function(){e&&e()}.bind(this))},saveItemAsUpdate:function(t,i,e,a){i.id=t.id,i.name=t.name,i.alias=t.alias,i.isNewScript=!1,i.application=t.appId||t.application,i.applicationName=t.appName||t.applicationName,i.appId=i.application,i.appName=i.applicationName,this.app.restActions.saveScript(i,function(){e&&e()}.bind(this),function(){a&&a()}.bind(this))},saveItemAsNew:function(t,i,e,a){for(var n=this.app.options.application,o=n.id,p=n.name,s=i.name,r=1;t.data.some((function(t){return t.name==i.name||t.alias==i.name}));)i.name=s+"_copy"+r,i.alias=s+"_copy"+r,r++;i.id="",i.isNewScript=!0,i.application=o,i.applicationName=p,i.appId=o,i.appName=p,this.app.restActions.saveScript(i,function(){e&&e()}.bind(this),function(){a&&a()}.bind(this))}}),MWF.xApplication.cms.ColumnManager.ScriptExplorer.Script=new Class({Extends:MWF.xApplication.cms.ColumnManager.DictionaryExplorer.Dictionary,_customNodes:function(){this.data.validated||(new Element("div",{styles:this.explorer.css.itemErrorNode}).inject(this.node),this.node.setStyle("background-color","#f9e8e8"))},_open:function(t){var i=this,e={appId:"cms.ScriptDesigner"+i.data.id,id:i.data.id,application:(i.explorer.app.options.application||i.explorer.app.options.column).id,onQueryLoad:function(){this.actions=i.explorer.actions,this.category=i,this.options.id=i.data.id,this.application=i.explorer.app.options.application||i.explorer.app.options.column,this.column=i.explorer.app.options.application||i.explorer.app.options.column,this.explorer=i.explorer}};this.explorer.app.desktop.openApplication(t,"cms.ScriptDesigner",e)},_getIcon:function(){return"process_icon_"+(33*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/scriptIcon/lnk.png",title:this.data.name,par:'cms.ScriptDesigner#{"id": "'+this.data.id+'", "application": '+JSON.stringify(this.explorer.app.options.application||this.explorer.app.options.column)+"}"}},deleteScript:function(t){this.explorer.app.restActions.deleteScript(this.data.id,function(){this.node.destroy(),t&&t()}.bind(this))},saveItemAs:function(t){var i=t.id,e=t.name||t.appName;this.explorer.app.restActions.getScript(this.data.id,function(t){var a=t.data,n=a.name;this.explorer.app.restActions.listScript(i,function(t){t.data=t.data||[];for(var o=1;t.data.some((function(t){return t.name==a.name||t.alias==a.name}));)a.name=n+"_copy"+o,a.alias=n+"_copy"+o,o++;a.id="",a.isNewScript=!0,a.appId=i,a.appName=e,a.application=i,a.applicationName=e,this.explorer.app.restActions.saveScript(a,function(){i==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});