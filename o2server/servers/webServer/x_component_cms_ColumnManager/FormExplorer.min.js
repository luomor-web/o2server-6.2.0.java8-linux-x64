MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,!1),MWF.xApplication.cms.ColumnManager.FormExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{create:MWF.CMSCM.LP.form.create,search:MWF.CMSCM.LP.form.search,searchText:MWF.CMSCM.LP.form.searchText,noElement:MWF.CMSCM.LP.form.noFormNoticeText},_createElement:function(e){this.formTemplateList=null,this.defalutFormTemplateList=null;var t=this,i=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content),o=new Element("div",{styles:this.css.createFormTemplateAreaNode}).inject(this.app.content);o.fade("in");new Element("div",{styles:this.css.createTemplateFormTitleNode,text:this.app.lp.createSelectTemplate}).inject(o);var n=new Element("div",{styles:this.css.createTemplateFormCategoryNode}).inject(o),s=(new Element("div",{styles:this.css.createTemplateFormCategoryTitleNode,text:this.app.lp.templateCategory}).inject(n),new Element("div",{styles:this.css.createTemplateFormContentNode}).inject(o)),a=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:this.app.lp.all}).inject(n);a.addEvent("click",(function(){d()})),this.app.restActions.listFormTemplateCategory(function(e){e.data.each(function(e){new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:e.name+"("+e.count+")",value:e.name}).inject(n).addEvent("click",(function(){s.empty(),n.getElements("div").each((function(e,i){i>0&&e.setStyles(t.css.createTemplateFormCategoryItemNode)})),this.setStyles(t.css.createTemplateFormCategoryItemNode_current),m(this.get("value"))}))}.bind(this))}.bind(this));var p=function(){var e=this.app.content.getSize(),t=.1*e.y/2,i=.1*e.x/2;t<0&&(t=0),i<0&&(i=0),o.setStyles({top:t+"px",left:i+"px"}),t=.9*e.y-n.getSize().y-70,s.setStyle("height",t+"px")}.bind(this);p(),this.app.addEvent("resize",p);var r=function(e){if(this.defalutFormTemplateList)e&&e();else{MWF.getJSON("../x_component_cms_FormDesigner/Module/Form/template/templates.json",function(t){this.defalutFormTemplateList=t,e&&e()}.bind(this))}}.bind(this),l=function(){r(function(){this.defalutFormTemplateList.each(function(e){var n=new Element("div",{styles:this.css.formTemplateNode}).inject(s),a=new Element("div",{styles:this.css.formTemplateIconNode}).inject(n);new Element("div",{styles:this.css.formTemplateTitleNode,text:e.title}).inject(n);n.store("template",e.name),new Element("img",{styles:this.css.formTemplateIconImgNode}).inject(a).set("src","../x_component_cms_FormDesigner/Module/Form/template/"+e.icon),n.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over)},mouseout:function(){this.setStyles(t.css.formTemplateNode)},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){!function(e,i){layout.desktop.getFormDesignerStyle(function(){var o={style:layout.desktop.formDesignerStyle,template:i,onQueryLoad:function(){this.actions=t.app.restActions,this.application=t.app.options.application},onPostSave:function(){t.reload()}};layout.desktop.openApplication(e,"cms.FormDesigner",o)}.bind(this))}(e,this.retrieve("template")),t.app.removeEvent("resize",p),o.destroy(),i.destroy()}})}.bind(this))}.bind(this))}.bind(this),c=function(e){this.formTemplateList?e&&e():this.app.restActions.listFormTemplate(function(t){this.formTemplateList=t.data,e&&e()}.bind(this))}.bind(this),m=function(e){c(function(){Object.each(this.formTemplateList,function(n,a){(!e||a==e)&&n.each(function(e){var n=new Element("div",{styles:this.css.formTemplateNode}).inject(s),a=new Element("div",{styles:this.css.formTemplatePreviewNode}).inject(n);new Element("div",{styles:this.css.formTemplateTitleNode,text:e.name}).inject(n);n.store("template",e.id),a.set("html",e.outline);var r=new Element("img",{styles:this.css.formTemplateActionNode}).inject(a);r.addEvent("click",(function(e){var n=this.getParent().getParent().retrieve("template");t.app.confirm("wram",e,t.app.lp.form.deleteFormTemplateTitle,t.app.lp.form.deleteFormTemplate,300,120,(function(){t.app.restActions.deleteFormTemplate(n,function(n){t.app.removeEvent("resize",p),o.destroy(),i.destroy(),t._createElement(e)}.bind(this)),this.close()}),(function(){this.close()})),e.stopPropagation()})),n.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over),r&&r.setStyle("display","block")},mouseout:function(){this.setStyles(t.css.formTemplateNode),r&&r.setStyle("display","none")},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){!function(e,i){layout.desktop.getFormDesignerStyle(function(){var o={style:layout.desktop.formDesignerStyle,templateId:i,onQueryLoad:function(){this.actions=t.app.restActions,this.application=t.app.options.application},onPostSave:function(){t.reload()}};layout.desktop.openApplication(e,"cms.FormDesigner",o)}.bind(this))}(e,this.retrieve("template")),t.app.removeEvent("resize",p),o.destroy(),i.destroy()}})}.bind(this))}.bind(this))}.bind(this))}.bind(this),d=function(){s.empty(),n.getElements("div").each((function(e,i){i>0&&e.setStyles(t.css.createTemplateFormCategoryItemNode)})),a.setStyles(t.css.createTemplateFormCategoryItemNode_current),l(),m()};d(),i.addEvent("click",function(){this.app.removeEvent("resize",p),o.destroy(),i.destroy()}.bind(this))},showDeleteAction:function(){this.deleteItemsAction||(this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node),this.deleteItemsAction.fade("in"),this.deleteItemsAction.position({relativeTo:this.elementContentListNode}),this.deleteItemsAction.addEvent("click",function(){var e=this;this.app.confirm("warn",this.deleteItemsAction,MWF.CMSCM.LP.form.deleteFormTitle,MWF.CMSCM.LP.form.deleteForm,300,120,(function(){e.deleteItems(),this.close()}),(function(){this.close()}))}.bind(this)))},_loadItemDataList:function(e){this.app.restActions.listForm(this.app.options.column.id,e)},_getItemObject:function(e,t){return new MWF.xApplication.cms.ColumnManager.FormExplorer.Form(this,e,{index:t})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.form.create,search:MWF.CMSCM.LP.form.search,searchText:MWF.CMSCM.LP.form.searchText,noElement:MWF.CMSCM.LP.form.noFormNoticeText}},deleteItems:function(){for(;this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteForm():e.deleteForm(function(){this.hideDeleteAction(),this.reload()}.bind(this))}},keyCopy:function(e){if(this.selectMarkItems.length){var t=[],i=0,o=function(e){if(i>=this.selectMarkItems.length&&t.length){var o=JSON.encode(t);e?e.clipboardData.setData("text/plain",o):window.clipboardData.setData("Text",o),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getForm(n.data.id,function(n){n.data.elementType="form",t.push(n.data),i++,o(e)}.bind(this),null,!1)}.bind(this))}},keyPaste:function(e){var t="";t=e?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(t);this.pasteItem(i,0)},pasteItem:function(e,t){if(t<e.length){var i=e[t];"form"===i.elementType?this.saveItemAs(i,function(){t++,this.pasteItem(e,t)}.bind(this),function(){t++,this.pasteItem(e,t)}.bind(this),function(){this.reload()}.bind(this)):(t++,this.pasteItem(e,t))}else this.reload()},saveItemAs:function(e,t,i,o){this.app.restActions.listForm(this.app.options.application.id,function(n){n.data=n.data||[];var s=n.data.filter((function(t){return t.id===e.id}));if(s.length){var a=s[0],p=this.app.lp,r=this,l=(new Date).parse(e.updateTime),c=(new Date).parse(a.updateTime),m="<div>"+p.copyConfirmInfor+"</div>";m+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+p.copySource+" "+a.name+"</div>",m+="<div style='font-size:12px; color: #666666; float: left'>"+a.updateTime+"</div><div style='color: red; float: right;'>"+(l>=c?"":p.copynew)+"</div></div>",m+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+p.copyTarget+" "+e.name+"</div>",m+="<div style='font-size:12px; color: #666666; float: left;'>"+e.updateTime+"</div><div style='color: red; float: right;'>"+(l<=c?"":p.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:m},500,290,[{text:p.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(a,e,t,i),this.close()}},{text:p.copyConfirm_new,action:function(){r.saveItemAsNew(n,e,t,i),this.close()}},{text:p.copyConfirm_skip,action:function(){this.close(),t&&t()}},{text:p.copyConfirm_cancel,action:function(){this.close(),o&&o()}}])}else this.saveItemAsNew(n,e,t,i)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(e,t,i,o){var n=this.app.options.application,s=JSON.decode(MWF.decodeJsonString(t.data)),a=JSON.decode(MWF.decodeJsonString(t.mobileData));s.id=e.id,s.isNewForm=!1,s.json.id=e.id,s.json.application=n.id,s.json.applicationName=n.name,s.json.name=e.name,s.json.alias=e.alias,s.json.appId=n.id,s.json.appName=n.name,a.json.id=e.id,a.json.application=n.id,a.json.applicationName=n.name,a.applicationName=n.name,a.json.name=e.name,a.json.alias=e.alias,a.json.appId=n.id,a.json.appName=n.name,this.app.restActions.saveForm(s,a,t.fieldList,function(){i&&i()}.bind(this),function(){o&&o()}.bind(this))},saveItemAsNew:function(e,t,i,o){for(var n=this.app.options.application,s=n.id,a=n.name,p=JSON.decode(MWF.decodeJsonString(t.data)),r=JSON.decode(MWF.decodeJsonString(t.mobileData)),l=p.json.name,c=1;e.data.some((function(e){return e.name==p.json.name}));)p.json.name=l+"_copy"+c,r.json.name=l+"_copy"+c,c++;p.id="",p.isNewForm=!0,p.json.id="",p.json.application=s,p.json.applicationName=a,p.json.appId=s,p.json.appName=a,p.json.alias="",r.json.id="",r.json.application=s,r.json.applicationName=a,r.applicationName=a,r.json.appId=s,r.json.appName=a,r.json.alias="",this.app.restActions.saveForm(p,r,t.fieldList,function(){i&&i()}.bind(this),function(){o&&o()}.bind(this))}}),MWF.xApplication.cms.ColumnManager.FormExplorer.Form=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,_open:function(e){layout.desktop.getFormDesignerStyle(function(){var t=this,i={style:layout.desktop.formDesignerStyle,appId:"cms.FormDesigner"+t.data.id,id:t.data.id,application:t.explorer.app.options.column.id,onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.column=t.explorer.app.options.column,this.application=t.explorer.app.options.column}};this.explorer.app.desktop.openApplication(e,"cms.FormDesigner",i)}.bind(this))},_getIcon:function(){return"process_icon_"+(33*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/formIcon/lnk.png",title:this.data.name,par:'cms.FormDesigner#{"id": "'+this.data.id+'"}'}},deleteForm:function(e){this.explorer.app.restActions.removeForm(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))},saveItemAs:function(e){var t=e.id,i=e.name||e.appName;this.explorer.app.restActions.getForm(this.data.id,function(e){var o=JSON.decode(MWF.decodeJsonString(e.data.data)),n=JSON.decode(MWF.decodeJsonString(e.data.mobileData));o.json.alias="",n.json.alias="";var s=o.json.name;this.explorer.app.restActions.listForm(t,function(e){e.data=e.data||[];for(var a=1;e.data.some((function(e){return e.name==o.json.name}));)o.json.name=s+"_copy"+a,n.json.name=s+"_copy"+a,a++;o.id="",o.isNewForm=!0,o.json.id="",o.json.application=t,o.json.applicationName=i,o.json.appId=t,o.json.appName=i,n.json.id="",n.json.application=t,n.applicationName=i,n.json.applicationName=i,n.json.appId=t,n.json.appName=i;this.explorer.app.restActions.saveForm(o,n,[],function(){t==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});