MWF.xApplication.ForumDocument=MWF.xApplication.ForumDocument||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.require("MWF.widget.ImageClipper",null,!1),MWF.xApplication.ForumDocument.HotLinkForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"660",height:"520",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!0,hasBottom:!0,title:MWF.xApplication.Forum.LP.setHotPicture,draggable:!0,closeAction:!0,toMain:!0,documentId:""},_createTableContent:function(){this.actions=MWF.Actions.get("x_hotpic_assemble_control"),this.actions.getHotPic("BBS",this.options.documentId,function(t){t.data&&t.data.length>0?this.isNew=!1:this.isNew=!0,this.hotPicData=t.data&&t.data.length>0?t.data[0]:{};var i="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableValue' item='hotPictureArea'></td></tr><tr>   <td>"+this.lp.hotLinkDescription+"</td></tr></table>";this.formTableArea.set("html",i),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"cms",isEdited:!0,itemTemplate:{hotPicture:{text:this.lp.hotPicture}}},this.app,this.css),this.form.load(),this.createIconNode()}.bind(this),!0)}.bind(this),null,!1)},createIconNode:function(){var t=this.formTableArea.getElements("[item='hotPictureArea']")[0];MWF.require("MWF.widget.ImageClipper",function(){this.clipper=new MWF.widget.ImageClipper(t,{aspectRatio:2,fromFileEnable:!0,imageUrl:this.hotPicData.picId?MWF.xDesktop.getImageSrc(this.hotPicData.picId):"",reference:this.options.documentId,referenceType:"forumDocument"}),this.clipper.load()}.bind(this))},_createBottomContent:function(){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.setHotPicture}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this)),this.isNew||(this.cancelHotActionNode=new Element("div.formOkActionNode",{styles:this.css.cancelHotPicture,text:this.lp.cancelHotPicture}).inject(this.formBottomNode),this.cancelHotActionNode.addEvent("click",function(t){this.cancelHotPic(t)}.bind(this))),this.closeActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode),this.closeActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},cancelHotPic:function(t){var i=this;this.app.confirm("warn",t,this.lp.cancelHotPicComfirmTitle,this.lp.cancelHotPicComfirmContent,350,120,(function(){i._cancelHotPic(i.data,!1),this.close()}),(function(){this.close()}))},_cancelHotPic:function(){this.actions.removeHotPic(this.hotPicData.id,function(t){"error"==t.type?this.app.notice(t.message,"error"):(this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app.notice(this.lp.cancelHotLinkSuccess,"success"))}.bind(this))},ok:function(t){this.fireEvent("queryOk");var i=this.clipper.getBase64Image();i&&""!=i?(this.hotPicData.pictureBase64=i,this.clipper.uploadImage(function(t){this.hotPicData.infoId=this.options.documentId,this.hotPicData.url=MWF.xDesktop.getImageSrc(t.id),this.hotPicData.picId=t.id,this.hotPicData.title=this.data.title,this.hotPicData.application="BBS",this.hotPicData.creator=layout.desktop.session.user.distinguishedName,this.hotPicData.summary=this.options.summary,this._ok(this.hotPicData,function(t){"error"==t.type?this.app.notice(t.message,"error"):(this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app.notice(this.lp.setHotLinkSuccess,"success"),this.fireEvent("postOk",t.data.id))}.bind(this))}.bind(this))):this.app.notice(this.lp.unselectHotPic,"error")},_ok:function(t,i){this.actions.saveHotPic(t,function(t){i&&i(t)}.bind(this))},_close:function(){this.clipper.close()}});