MWF.xApplication.ForumDocument=MWF.xApplication.ForumDocument||{},MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.ForumDocument.Vote=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isNew:!1,isEdited:!0},initialize:function(t,e,i,o){this.setOptions(i),this.container=t,this.app=e,this.lp=e.lp,this.actions=e.restActions||e.action,this.data=o,this.userName=layout.user&&layout.user.distinguishedName?layout.user.distinguishedName:layout.desktop.session.user.distinguishedName,this.path="../x_component_ForumDocument/$Vote/",this.cssPath="../x_component_ForumDocument/$Vote/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.voted=this.data.voted||!1,!this.options.isNew&&this.data.voteOptionGroupList&&this.sortData(),this.options.isNew||this.options.isEdited?this.loadContent_edit():this.loadContent_read()},reload:function(){this.container.empty(),this.getData(function(){this.load(!0)}.bind(this))},getData:function(t){this.actions.getSubjectView(this.data.id,function(e){this.data=e.data.currentSubject,t&&t()}.bind(this))},sortData:function(){var t=this.data.voteOptionGroupList||[];t.sort((function(t,e){return t.orderNumber-e.orderNumber}));for(var e=0;e<t.length;e++){t[e].voteOptions.sort((function(t,e){return t.orderNumber-e.orderNumber}))}},loadContent_read:function(){var t=!1,e="";if(this.data.voteLimitTime&&""!=this.data.voteLimitTime){var i=new Date,o=new Date(this.data.voteLimitTime.replace(/-/g,"/"));i<o?e=this.lp.timeToEndText.replace("{time}",this.diffTime(i,o)):(t=!0,e=this.lp.voteCompleteText)}var n="";n=this.data.voteUserCount||this.data.voteCount?this.lp.votedPersonCountText.replace("{count}",this.data.voteUserCount||this.data.voteCount):this.lp.noPersonVoteText;var s=new Element("div",{styles:this.css.inforNode,text:this.lp.vote}).inject(this.container);if(new Element("span",{styles:this.css.infor2Node,text:n+e}).inject(s),this.data.votePersonVisible&&this.data.votePerson,this.groupContainer=new Element("div",{styles:this.css.groupContainer}).inject(this.container),this.data.voteOptionGroupList.each(function(e,i){this.voted||t?(this.data.voteResultVisible||this.data.creatorName==this.userName)&&this.createGroupVoted(e,i):this.createGroupVoting(e,i)}.bind(this)),(this.voted||t)&&(this.data.voteResultVisible||this.data.creatorName==this.userName||new Element("div",{styles:{"margin-bottom":"5px"},text:this.lp.privateVoteText}).inject(this.container)),this.voted)new Element("span",{text:this.lp.youAreVoted}).inject(this.container);else if(!t){var r=new Element("div").inject(this.container),a=new Element("input",{type:"button",styles:this.css.submitButton,value:this.lp.submit}).inject(r);a.addEvent("click",function(){this.submitVote()}.bind(this)),a.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.submitButton_over)}.bind({obj:this,node:a}),mouseout:function(){this.node.setStyles(this.obj.css.submitButton)}.bind({obj:this,node:a})}),this.data.votePersonVisible?new Element("span",{styles:{"margin-left":"10px"},text:this.lp.publicVoteText}).inject(r):new Element("span",{styles:{"margin-left":"10px"},text:this.lp.anonymousVoteText}).inject(r)}},createGroupVoted:function(t,e){var i=this,o=this.getRandomColor(),n=0,s=!1;if(t.voteOptions.each((function(t){n+=parseInt(t.chooseCount),t.optionContentType==i.lp.picture&&(s=!0)})),0!=n){var r=new Element("div",{styles:this.css.groupTitle}).inject(this.groupContainer),a=parseInt(t.voteChooseCount)>1?this.lp.multiSelectText.replace("{n}",t.voteChooseCount):this.lp.singleSelectText;new Element("span",{styles:this.css.groupSubject,text:a}).inject(r),new Element("span",{styles:this.css.groupSubject,text:t.groupName}).inject(r);var l,p,c=new Element("div",{styles:this.css.optionContainer}).inject(this.groupContainer);if(s)l=layout.mobile?new Element("div").inject(c):new Element("table",{cellSpacing:"0",border:"0"}).inject(c),t.voteOptions.each(function(t,e){var i;if(layout.mobile){i=new Element("div",{styles:this.css.optionsPictureDiv_mobile}).inject(l);var o=new Element("div",{styles:this.css.optionPictureArea_mobile}).inject(i);new Element("img",{src:MWF.xDesktop.getImageSrc(t.optionPictureId),styles:this.css.optionPicture_mobile}).inject(o)}else{e%3==0&&(p=new Element("tr").inject(l));var s=new Element("td").inject(p);i=new Element("div",{styles:this.css.optionsPictureDiv}).inject(s);o=new Element("div",{styles:this.css.optionPictureArea}).inject(i);new Element("img",{src:MWF.xDesktop.getImageSrc(t.optionPictureId),styles:this.css.optionPicture}).inject(o).addEvent("click",function(){window.open(o2.filterUrl(MWF.xDesktop.getImageSrc(this.id)),"_blank")}.bind({id:t.optionPictureId}))}var r=(t.chooseCount/n*100).toString().substr(0,5)+"%",a=new Element("div",{text:r,styles:this.css.presentDiv}).inject(i);new Element("span",{styles:{color:"#ccc"},text:"("+t.chooseCount+")"}).inject(a);new Element("div",{text:e+1+"."+t.optionTextContent}).inject(i)}.bind(this));t.voteOptions.each(function(t,e){new Element("div.optionText",{styles:{},text:e+1+".　"+t.optionTextContent}).inject(c);var i=new Element("div.resultContainer",{styles:this.css.optionItem}).inject(c),s=new Element("div",{styles:this.css.optionItemBack}).inject(i);s.setStyle("width",layout.mobile?"70%":"85%");var r=Math.floor(t.chooseCount/n*100),a=new Element("div.optionItemFront",{styles:this.css.optionItemFront,text:" "}).inject(s);a.setStyles({"background-color":o,width:r+"%"}),this.data.votePersonVisible&&!layout.mobile&&(a.setStyles({cursor:"pointer"}),a.addEvents({click:function(){this.obj.openLog(this.data)}.bind({obj:this,data:t}),mouseover:function(){this.node.setStyle("opacity","0.8")}.bind({node:a}),mouseout:function(){this.node.setStyle("opacity","1")}.bind({node:a})}));var l=(t.chooseCount/n*100).toString().substr(0,5)+"%",p=new Element("div",{text:l,styles:this.css.presentNode}).inject(i);new Element("span",{styles:{color:"#ccc"},text:"("+t.chooseCount+")"}).inject(p),t.voted&&new Element("div",{styles:this.css.checkedOption}).inject(i)}.bind(this))}},createGroupVoting:function(t,e){this.groupObject=this.groupObject||{},this.groupObject[e]={},this.groupObject[e].id=t.id,this.groupObject[e].inputs=[];var i=new Element("div",{styles:this.css.groupTitle}).inject(this.groupContainer),o=parseInt(t.voteChooseCount)>1?this.lp.multiSelectText.replace("{n}",t.voteChooseCount):this.lp.singleSelectText;new Element("span",{styles:this.css.groupSubject,text:o}).inject(i),new Element("span",{styles:this.css.groupSubject,text:t.groupName}).inject(i);for(var n=!1,s=0;s<t.voteOptions.length;s++)if(t.voteOptions[s].optionContentType===this.lp.picture){n=!0;break}var r,a,l=new Element("div",{styles:n?this.css.optionPictureContainer:this.css.optionContainer}).inject(this.groupContainer);n&&(r=layout.mobile?new Element("div").inject(l):new Element("table",{cellSpacing:"0",border:"0"}).inject(l)),t.voteOptions.each(function(i,o){var s;if(n)if(layout.mobile){s=new Element("div",{styles:this.css.optionsPictureDiv_mobile}).inject(r);var p=new Element("div",{styles:this.css.optionPictureArea_mobile}).inject(s);new Element("img",{src:MWF.xDesktop.getImageSrc(i.optionPictureId),styles:this.css.optionPicture_mobile}).inject(p)}else{o%3==0&&(a=new Element("tr").inject(r));var c=new Element("td").inject(a);s=new Element("div",{styles:this.css.optionsPictureDiv}).inject(c);p=new Element("div",{styles:this.css.optionPictureArea}).inject(s);new Element("img",{src:MWF.xDesktop.getImageSrc(i.optionPictureId),styles:this.css.optionPicture}).inject(p).addEvent("click",function(){window.open(o2.filterUrl(MWF.xDesktop.getImageSrc(this.id)),"_blank")}.bind({id:i.optionPictureId}))}else s=new Element("div",{styles:this.css.optionsDiv}).inject(l);var u=new Element("input",{type:1==t.voteChooseCount?"radio":"checkbox",name:"voteCheck_"+e,value:i.id,styles:n?this.css.optionsPictureInput:this.css.optionsInput}).inject(s),d=new Element("span",{text:o+1+"."+(n?"":"　")+i.optionTextContent}).inject(s);t.voteChooseCount>1?(u.addEvents({click:function(t){var e=this.obj.groupObject[this.groupIndex].inputs;this.obj.checkCountLimited(this.limit,e)}.bind({obj:this,groupIndex:e,optionIndex:o,limit:t.voteChooseCount})}),d.addEvents({click:function(t){this.input.get("checked")?this.input.set("checked",!1):this.input.get("disabled")||this.input.set("checked",!0);var e=this.obj.groupObject[this.groupIndex].inputs;this.obj.checkCountLimited(this.limit,e)}.bind({obj:this,groupIndex:e,optionIndex:o,limit:t.voteChooseCount,input:u})})):d.addEvents({click:function(t){this.input.get("checked")||(this.obj.groupObject[this.groupIndex].inputs.each((function(t){t.set("checked",!1)})),this.input.set("checked",!0))}.bind({obj:this,groupIndex:e,optionIndex:o,input:u})}),this.groupObject[e].inputs.push(u)}.bind(this))},checkCountLimited:function(t,e){var i=0;e.each((function(t){t.get("checked")&&i++})),i>=t?e.each((function(t){t.get("checked")||t.set("disabled",!0)})):e.each((function(t){t.get("checked")||t.set("disabled",!1)}))},loadContent_edit:function(){this.container.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' style='margin-top:15px;'><tr>   <td styles='formTableTitleRight'  lable='voteLimitTime' width='13%'></td>   <td styles='formTableValue' item='voteLimitTime' width='20%'></td>   <td styles='formTableTitleRight' lable='voteResultVisible' width='16%'></td>   <td styles='formTableValue' item='voteResultVisible' width='14%'></td>   <td styles='formTableTitleRight' lable='votePersonVisible' width='16%'></td>   <td styles='formTableValue' item='votePersonVisible' width='20%'></td></tr></table>"),this.voteTable=this.container.getElement("table"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form_vote=new MForm(this.container,this.data,{style:"forum",isEdited:!0,itemTemplate:{voteLimitTime:{text:this.lp.voteLimitTime,tType:"date"},voteResultVisible:{text:this.lp.voteResultVisible,type:"select",selectText:this.lp.yesOrNo.split(","),selectValue:["true","false"]},votePersonVisible:{text:this.lp.votePersonVisible,type:"select",selectText:this.lp.votePersonValue.split(","),selectValue:["true","false"]}}},this),this.form_vote.load()}.bind(this),!0),this.addVoteGroupTr=new Element("tr").inject(this.voteTable);var t=new Element("td",{colspan:6}).inject(this.addVoteGroupTr);new Element("input",{type:"button",styles:this.css.addVoteGroupNode,value:this.lp.addVoteGroup}).inject(t).addEvent("click",function(){this.createGroupEdited()}.bind(this)),this.options.isNew||!this.data.voteOptionGroupList?this.createGroupEdited():this.data.voteOptionGroupList.each(function(t,e){this.createGroupEdited(t,e)}.bind(this))},createGroupEdited:function(t,e){this.groupObject=this.groupObject||{},this.groupIndex=this.groupIndex||1;var i=t||{},o=!1;if(i.voteOptions)for(var n=0;n<i.voteOptions.length;n++)if(i.voteOptions[n].optionContentType===this.lp.picture){o=!0;break}var s=new Element("tr").inject(this.addVoteGroupTr,"before"),r=new Element("td",{colspan:6}).inject(s);MWF.xDesktop.requireApp("Template","MGrid",function(){var e=new MGrid(r,i.voteOptions,{style:"forum",isEdited:!0,hasOperation:!0,hasSequence:!1,minTrCount:2,tableAttributes:{width:"100%",border:"0",cellpadding:"5",cellspacing:"0"},itemTemplate:{optionTextContent:{text:this.lp.option,defaultValue:this.lp.option,notEmpty:!0,defaultValueAsEmpty:!0,event:{focus:function(t,e){t.getValue()==this.lp.option&&t.setValue("")}.bind(this),blur:function(t,e){""==t.getValue()&&t.setValue(this.lp.option)}.bind(this)}},optionPictureId:{type:"imageClipper",text:"图片",notEmpty:!0,disable:!o,style:{imageStyle:this.css.optionPicture,imageWrapStyle:this.css.optionPictureArea,actionStyle:this.css.uploadActionNode},aspectRatio:0,ratioAdjustedEnable:!0,reference:this.app.advanceId||this.app.data.id,referenceType:"forumDocument"}},onQueryCreateTr:function(){this.form&&("true"==this.form.getItem("voteContentType").getValue()?this.itemTemplate.optionPictureId.disable=!1:this.itemTemplate.optionPictureId.disable=!0)}},this.app);e.setThTemplate("<tr><th style='text-align: left;font-size:14px;font-weight: normal;'></th><th button_add></th></tr>"),e.setTrTemplate("<tr><td><div item='optionTextContent' style='padding-top:10px'></div><div item='optionPictureId' style='padding-top: 5px;'></div></td><td button_remove style='vertical-align: top;padding-top:15px;'></td></tr>"),e.load(),t||e.addTrs(3);var n=e.tableHead.getElement("th"),s="<div><span style='font-size:18px;margin-right:10px;' item='groupLabel' index='"+this.groupIndex+"'>"+this.lp.group+this.groupIndex+"：</span><span item='groupName' style='margin-right:15px;'></span><span lable='voteChooseCount' style='margin-right:5px;'></span><span item='voteChooseCount' style='margin-right:5px;'></span><span style='margin-right:10px;''>"+this.lp.opt+"</span><span item='voteContentType' style='margin-right:15px;'></span><span style='margin-right:15px;' item='removeVoteGroup'></span></div><div item='tipNode'></div>";n.set("html",s);var a=n.getElement("[item='groupLabel']"),l=n.getElement("[item='tipNode']"),p=new MForm(n,i,{style:"forum",verifyType:"batch",isEdited:!0,itemTemplate:{groupName:{text:this.lp.voteSubject,defaultValue:this.lp.voteSubject,className:"inputTextNoWidth",style:{width:"500px"},notEmpty:!0,defaultValueAsEmpty:!0,event:{focus:function(t,e){t.getValue()==this.lp.voteSubject&&t.setValue("")}.bind(this),blur:function(t,e){""==t.getValue()&&t.setValue(this.lp.voteSubject)}.bind(this)},onPostLoad:function(t){t.tipNode=l}},voteChooseCount:{text:this.lp.voteCountLimit,defaultValue:1,className:"inputTextNoWidth",tType:"number",style:{width:"30px"}},voteContentType:{type:"checkbox",defaultValue:o?"true":"",selectValue:["true"],selectText:[this.lp.uploadPicture],event:{change:function(t,e){this.obj.setPicture(t.getValue(),this.grid)}.bind({obj:this,grid:e})}},removeVoteGroup:{disable:1==this.groupIndex,type:"button",value:this.lp.removeVoteGroup,className:"removeVoteGroupNode",event:{click:function(t,e){var i=this;i.obj.app.confirm("warn",e,i.obj.lp.confirmRemoveVoteGroupTitle,i.obj.lp.confirmRemoveVoteGroupContent,350,120,(function(){i.obj.removeGroup(parseInt(i.node.get("index"))),this.close()}),(function(){this.close()}))}.bind({obj:this,node:a})}}}},this.app,this.css);p.load(),e.form=p,this.groupObject[this.groupIndex]={grid:e,form:p,groupNameNode:a},this.groupIndex++}.bind(this),!0)},removeGroup:function(t){this.groupObject[t].grid.container.destroy(),delete this.groupObject[t];for(var e=t;e<this.groupIndex-1;e++)this.groupObject[e]=this.groupObject[e+1],this.groupObject[e].groupNameNode.set("text",this.lp.group+e+"："),this.groupObject[e].groupNameNode.set("index",e);this.groupObject[this.groupIndex-1]=null,this.groupIndex--},getVoteInfor:function(){var t=!0,e=this.form_vote.getResult(!0,",",!0,!1,!0);for(var i in e||(t=!1),t&&(e.optionGroups=[]),this.groupObject){var o=this.groupObject[i];if(o){var n=o.form.getResult(!0,",",!0,!1,!0);n||(t=!1);var s=o.grid.getResult(!0,",",!0,!1,!0);if(s||(t=!1),t){for(var r=0;r<s.length;r++)s[r].optionContentType="true"===n.voteContentType?this.lp.picture:this.lp.word;n.voteOptions=s,e.optionGroups.push(n)}}}return t?e:null},getVoteResult:function(){var t=!0,e={};for(var i in e.id=this.data.id,e.optionGroups=[],this.groupObject){var o={selectedVoteOptionIds:[]},n=this.groupObject[i];o.id=n.id;for(var s=0;s<n.inputs.length;s++){var r=n.inputs[s];r.get("checked")&&o.selectedVoteOptionIds.push(r.get("value"))}0==o.selectedVoteOptionIds.length&&(t=!1),e.optionGroups.push(o)}return t?e:(this.data.voteOptionGroupList.length>=1?this.app.notice(this.lp.notSelectGroupNotice,"error"):this.app.notice(this.lp.notSelectItemNotice,"error"),null)},submitVote:function(){var t=this.getVoteResult();t&&this.actions.submitVote(t,function(){this.reload()}.bind(this))},setPicture:function(t,e){"true"==t?e.enableItem("optionPictureId"):e.disableItem("optionPictureId")},openLog:function(t){var e=new MWF.xApplication.ForumDocument.VoteLog(this,this.data,{onPostOk:function(t){}.bind(this)});e.optionData=t,e.edit()},diffTime:function(t,e){var i=e.getTime()-t.getTime(),o=Math.floor(i/864e5),n=i%864e5,s=Math.floor(n/36e5),r=n%36e5,a=Math.floor(r/6e4),l=r%6e4,p=Math.round(l/1e3)+this.lp.second;return a>0&&(p=a+this.lp.minute+p),s>0&&(p=s+this.lp.hour+p),o>0&&(p=o+this.lp.day+p),p},getRandomColor:function(){var t=!1;do{var e=("00000"+(16777216*Math.random()<<0).toString(16)).slice(-6),i=parseInt(e.substr(0,2),16),o=parseInt(e.substr(3,2),16),n=parseInt(e.substr(5,2),16);i>240&&o>240&&n>240&&(t=!0)}while(t);return"#"+e}}),MWF.xApplication.ForumDocument.VoteLog=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"750",height:"600",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!1,title:MWF.xApplication.Forum.LP.seeVotedPerson,draggable:!0,closeAction:!0,closeByClickMask:!0},_createTableContent:function(){this.formTableArea.set("html","<table width='95%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='group' width='15%'></td>    <td styles='formTableValue' item='group' width='85%'></td></tr><tr><td styles='formTableTitle' lable='option'></td>    <td styles='formTableValue' item='option'></td></tr><tr><td styles='formTableTitle'></td>   <td styles='formTableValue'><div item='logArea' styles='logArea'></div></td>   </tr></table>"),this.logArea=this.formTableArea.getElement("[item='logArea']");var t,e,i=[],o=[],n=[],s=[];this.data.voteOptionGroupList.each(function(r,a){var l=!1;i.push(MWF.xApplication.Forum.LP.group+(a+1)+"："+r.groupName),o.push(r.id),this.optionData?this.optionData.optionGroupId==r.id&&(l=!0):0==a&&(l=!0),l&&(t=r.id,r.voteOptions.each(function(t,i){n.push(t.optionTextContent),s.push(t.id),(this.optionData&&this.optionData.id==t.id||0==i)&&(e=t.id)}.bind(this)))}.bind(this)),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.formTableArea,this.data,{style:"forum",isEdited:!0,itemTemplate:{group:{type:"select",text:MWF.xApplication.Forum.LP.group1,selectText:i,selectValue:o,defaultValue:t,event:{change:function(t,i){var o=t.getValue(),n=[],s=[];this.data.voteOptionGroupList.each(function(t,i){o==t.id&&t.voteOptions.each((function(t,i){n.push(t.optionTextContent),s.push(t.id),0==i&&(e=t.id)}))}.bind(this)),t.form.getItem("option").resetItemOptions(s,n),this.showLog(e)}.bind(this)}},option:{type:"select",text:MWF.xApplication.Forum.LP.option1,selectText:n,selectValue:s,defaultValue:e,event:{change:function(t,e){this.showLog(t.getValue())}.bind(this)}}}},this,this.css).load()}.bind(this),!0),this.showLog(e)},showLog:function(t){this.logArea.empty(),this.recordView=new MWF.xApplication.ForumDocument.VoteRecordView(this.logArea,this.app,this,{templateUrl:this.explorer.path+"listItemVote.json",scrollEnable:!0}),this.recordView.filterData={subjectId:this.data.id,voteOptionId:t},this.recordView.load()}}),MWF.xApplication.ForumDocument.VoteRecordView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return t.index=e,new MWF.xApplication.ForumDocument.VoteRecordDocument(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=50),i||(i=1);var o=this.filterData||{};this.actions.listVoteRecord(i,e,o,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ForumDocument.VoteRecordDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){e.votorName&&new MWF.widget.O2Person({name:e.votorName},t,{style:"xform"})}});