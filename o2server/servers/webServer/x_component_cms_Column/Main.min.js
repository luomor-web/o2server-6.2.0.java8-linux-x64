MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xApplication.cms.Column.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Column",icon:"icon.png",width:"1000",height:"600",isResize:!0,isMax:!0,title:MWF.xApplication.cms.Column.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.cms.Column.LP,this.defaultColumnIcon="../x_component_cms_Column/$Main/"+this.options.style+"/icon/column.png",this.defaultCategoryIcon="../x_component_cms_Column/$Main/"+this.options.style+"/icon/category2.png"},loadApplication:function(t){this.isAdmin=MWF.AC.isCMSManager(),this.restActions||(this.restActions=MWF.Actions.get("x_cms_assemble_control")),this.columns=[],this.categorys=[],this.deleteElements=[],this.createNode(),this.loadApplicationContent(),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:this.css.container}).inject(this.content)},reload:function(t,e){this.reloadTop(t,e)},loadApplicationContent:function(){this.loadTopNode(),this.loadColumnContentArea(),this.setCurrentAppType("all",this.columnAllTypeNode),this.setContentSize(),this.addEvent("resize",function(){this.setContentSize()}.bind(this))},reloadTop:function(t,e,i){this.columnToolbarAreaNode.empty(),t||(t=this.currentAppType),this.currentAppType=null,this.currentAppTypeNode=null,this.loadTopNode(t,e,i)},loadTopNode:function(t,e,i){this.columnToolbarAreaNode||(this.columnToolbarAreaNode=new Element("div.columnToolbarAreaNode",{styles:this.css.columnToolbarAreaNode}).inject(this.node)),this.columnAllTypeNode=new Element("div.columnTop_All",{styles:this.css.columnTop_All,text:this.lp.allApp}).inject(this.columnToolbarAreaNode),this.columnAllTypeNode.addEvents({mouseover:function(){this.currentAppTypeNode!==this.columnAllTypeNode&&this.columnAllTypeNode.setStyles(this.css.columnTop_All_over)}.bind(this),mouseout:function(){this.currentAppTypeNode!==this.columnAllTypeNode&&this.columnAllTypeNode.setStyles(this.css.columnTop_All)}.bind(this),click:function(){this.setCurrentAppType("all",this.columnAllTypeNode)}.bind(this)}),t&&"all"===t&&this.setCurrentAppType("all",this.columnAllTypeNode,e,i),MWF.AC.isCMSManager()&&(this.createColumnNode=new Element("div.createColumnNode",{styles:this.css.createColumnNode,text:this.lp.column.create}).addClass("o2_cms_column_createColumnNode").inject(this.columnToolbarAreaNode),this.createColumnNode.addEvents({mouseover:function(){this.createColumnNode.setStyles(this.css.createColumnNode_over)}.bind(this),mouseout:function(){this.createColumnNode.setStyles(this.css.createColumnNode)}.bind(this),click:function(){this.createColumn()}.bind(this)}),this.findNode=new Element("div.createColumnNode",{styles:this.css.findNode,text:this.lp.column.findDesigner}).inject(this.columnToolbarAreaNode),this.findNode.addEvent("click",function(){layout.openApplication(null,"FindDesigner",{filter:{moduleList:["cms"]}})}.bind(this))),this.columnTypeListContaienr=new Element("div.columnTop_category",{styles:this.css.columnTop_category}).inject(this.columnToolbarAreaNode),this.loadAppType(t,e,i)},loadAppType:function(t,e,i){var n=this;this.restActions.listAllAppTypeByManager(function(o){(o.data||[]).each(function(o){var s=new Element("div.columnTop_category",{styles:this.css.columnTop_categoryItem,text:o.appType+"("+o.count+")",events:{mouseover:function(t){this.currentAppTypeNode!==t.target&&t.target.setStyles(this.css.columnTop_categoryItem_over)}.bind(this),mouseout:function(t){this.currentAppTypeNode!==t.target&&t.target.setStyles(this.css.columnTop_categoryItem)}.bind(this),click:function(t){n.setCurrentAppType(this,t.target)}.bind(o.appType)}}).inject(this.columnTypeListContaienr);t&&t===o.appType&&n.setCurrentAppType(this,s,e,i)}.bind(this)),this.columnTypeListContaienr.getScrollSize().y>this.columnTypeListContaienr.getSize().y&&this.createTypeExpandButton()}.bind(this))},createTypeExpandButton:function(){this.columnTypeExpandNode=new Element("div.columnTop_categoryExpandButton",{styles:this.css.columnTop_categoryExpandButton}).inject(this.columnTypeListContaienr,"before"),this.columnTypeExpandNode.addEvent("click",this.expandOrCollapseCategory.bind(this))},expandOrCollapseCategory:function(t){this.categoryMorph||(this.categoryMorph=new Fx.Morph(this.columnTypeListContaienr,{duration:100})),this.expand?(this.columnTypeListContaienr.setStyles(this.css.columnTop_category),this.categoryMorph.start({height:this.columnToolbarAreaNode.getSize().y+"px"}),this.expandOrCollapseCategoryFun&&this.content.removeEvent("click",this.expandOrCollapseCategoryFun),this.expand=!1):(this.columnTypeListContaienr.setStyles(this.css.columnTop_category_more),this.categoryMorph.start({height:this.columnTypeListContaienr.getScrollSize().y+"px"}),this.expandOrCollapseCategoryFun=this.expandOrCollapseCategory.bind(this),this.content.addEvent("click",this.expandOrCollapseCategoryFun),this.expand=!0),t.stopPropagation()},setCurrentAppType:function(t,e,i,n){this.currentAppType&&("all"===this.currentAppType?(this.currentAppTypeNode.setStyles(this.css.columnTop_All),this.currentAppTypeNode.removeClass("o2_cms_column_all_current")):(this.currentAppTypeNode.setStyles(this.css.columnTop_categoryItem),this.currentAppTypeNode.removeClass("o2_cms_column_categoryItem_current"))),"all"===t?(e.setStyles(this.css.columnTop_All_current),e.addClass("o2_cms_column_all_current")):(e.setStyles(this.css.columnTop_categoryItem_current),e.addClass("o2_cms_column_categoryItem_current")),this.currentAppType=t,this.currentAppTypeNode=e,n||this.createColumnNodes(i)},setContentSize:function(){var t=this.node.getSize(),e=this.columnToolbarAreaNode?this.columnToolbarAreaNode.getSize():{x:0,y:0};if(this.scrollNode.setStyle("height",t.y-e.y+"px"),this.contentWarpNode){var i=287*(t.x/287).toInt(),n=(t.x-i)/2-10;this.contentWarpNode.setStyles({width:i+"px","margin-left":n+"px"})}this.columnTypeListContaienr&&(this.columnTypeListContaienr.getScrollSize().y>Math.round(this.columnTypeListContaienr.getSize().y)?this.columnTypeExpandNode?this.columnTypeExpandNode.setStyle("display",""):this.createTypeExpandButton():this.columnTypeExpandNode&&this.columnTypeExpandNode.setStyle("display","none"))},loadColumnContentArea:function(){this.scrollNode=new Element("div",{styles:this.css.scrollNode}).inject(this.node),this.contentWarpNode=new Element("div",{styles:this.css.contentWarpNode}).inject(this.scrollNode),this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.columnContentAreaNode=new Element("div",{styles:this.css.columnContentAreaNode}).inject(this.contentContainerNode)},createColumnNodes:function(t){this.columnContentAreaNode.empty(),"all"===this.currentAppType?this.restActions.listAppByManager(function(e){this._createColumnNodes(e),t&&t()}.bind(this)):this.restActions.listWhatICanManageWithAppType(this.currentAppType,function(e){this._createColumnNodes(e),t&&t()}.bind(this))},_createColumnNodes:function(t){if(t&&t.data&&t.data.length){var e=t.data;e.sort((function(t,e){return parseFloat(t.appInfoSeq)-parseFloat(e.appInfoSeq)})),t.data=e,t.data.each(function(t,e){this.index=e,(t=new MWF.xApplication.cms.Column.Column(this,t,{index:e})).load(),this.columns.push(t)}.bind(this))}0==this.columns.length&&(this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:this.lp.column.noElement}).inject(this.columnContentAreaNode))},createColumn:function(){new MWF.xApplication.cms.Column.PopupForm(this,{},{title:this.lp.column.create},{app:this,container:this.content,lp:this.lp.column,css:{},actions:this.restActions}).create()}}),MWF.xApplication.cms.Column.Column=new Class({Implements:[Options,Events],options:{where:"bottom",index:1},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.container=this.app.columnContentAreaNode,this.data=e,this.isNew=!1,this.lp=this.app.lp.column},load:function(){this.data.name=this.data.appName;var t=this.data.appName,e=this.data.appAlias,i=this.data.description,n=(this.data.appInfoSeq,this.data.creatorUid),o=(this.data.createTime,this.node=new Element("div.columnItem",{styles:this.app.css.columnItemNode}).inject(this.container,this.options.where));o.store("columnName",t);var s=new Element("div",{styles:this.app.css.columnItemTopNode}).inject(o);this.data.iconColor&&s.setStyle("background-color","rgba("+this.data.iconColor+",1)");new Element("div",{styles:this.app.css.columnItemTitleNode,text:t,title:e?t+" ("+e+") ":t}).inject(s);var a=new Element("div",{styles:this.app.css.columnItemIconAreaNode}).inject(o);this.data.iconColor&&a.setStyle("border-color","rgba("+this.data.iconColor+",1)");this.iconNode=new Element("div",{styles:this.app.css.columnItemIconNode}).inject(o);this.data.appIcon?this.iconNode.setStyle("background-image","url(data:image/png;base64,"+this.data.appIcon+")"):this.iconNode.setStyle("background-image","url("+this.app.defaultColumnIcon+")"),this.iconNode.makeLnk({par:this._getLnkPar()});var l=new Element("div",{styles:this.app.css.columnItemMiddleNode}).inject(o),p=i&&""!=i?i:this.lp.noDescription,c=(new Element("div",{styles:this.app.css.columnItemDescriptionNode,text:p,title:p}).inject(l),this);o.addEvents({mouseover:function(){c.selected||(this.setStyles(c.app.css.columnItemNode_over),this.addClass("o2_cms_column_columnNode_over"))},mouseout:function(){c.selected||(this.setStyles(c.app.css.columnItemNode),this.removeClass("o2_cms_column_columnNode_over"))},click:function(t){c.clickColumnNode(c,this,t)}});var d=new Element("div",{styles:this.app.css.columnItemBottomNode}).inject(o),r=(new Element("div",{styles:this.app.css.columnItemCategoryTitleNode,text:this.lp.category}).inject(d),new Element("div",{styles:this.app.css.columnItemCategoryContentNode}).inject(d));this.app.restActions.listCategory(this.data.id,function(t){(t.data||[]).each(function(t){var e=new Element("div",{styles:this.app.css.columnItemBottomItemNode,text:t.name}).inject(r);e.addEvents({click:function(t){this.obj.clickColumnNode(this.obj,t.target,t,this.data.id),t.stopPropagation()}.bind({obj:this,data:t}),mouseover:function(){this.node.setStyles(this.obj.app.css.columnItemBottomItemNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.app.css.columnItemBottomItemNode)}.bind({obj:this,node:e})})}.bind(this))}.bind(this));new Element("div",{styles:this.app.css.columnItemFormTitleNode,text:this.lp.form}).inject(d);var h=new Element("div",{styles:this.app.css.columnItemFormContentNode}).inject(d);this.app.restActions.listForm(this.data.id,function(t){(t.data||[]).each(function(t){var e=new Element("div",{styles:this.app.css.columnItemBottomItemNode,text:t.name}).inject(h);e.addEvents({click:function(t){this.obj.openForm(this.data),t.stopPropagation()}.bind({obj:this,data:t}),mouseover:function(){this.node.setStyles(this.obj.app.css.columnItemBottomItemNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.app.css.columnItemBottomItemNode)}.bind({obj:this,node:e})})}.bind(this))}.bind(this)),(n==layout.desktop.session.user.distinguishedName||MWF.AC.isCMSManager())&&(this.delAdctionNode=new Element("div.delNode",{styles:this.app.css.columnItemDelActionNode,title:this.lp.delete}).inject(o),o.addEvents({mouseover:function(){this.delAdctionNode.setStyle("display","")}.bind(this),mouseout:function(){this.delAdctionNode.setStyle("display","none")}.bind(this)}),this.delAdctionNode.addEvent("click",function(t){this.deleteColumn(t),t.stopPropagation()}.bind(this))),(n==layout.desktop.session.user.distinguishedName||MWF.AC.isCMSManager())&&(this.editAdctionNode=new Element("div.editNode",{styles:this.app.css.columnItemEditActionNode,title:this.lp.edit}).inject(o),o.addEvents({mouseover:function(){this.editAdctionNode.setStyle("display","")}.bind(this),mouseout:function(){this.editAdctionNode.setStyle("display","none")}.bind(this)}),this.editAdctionNode.addEvent("click",function(t){this.edit(t),t.stopPropagation()}.bind(this)))},_getLnkPar:function(){var t=this.app.defaultColumnIcon;this.data.icon&&(t="data:image/png;base64,"+this.data.appIcon);var e="cms.ColumnManager"+this.data.id;return{icon:t,title:this.data.appName,par:'cms.ColumnManager#{"column": "'+this.data.id+'", "appId": "'+e+'"}'}},export:function(){MWF.xDesktop.requireApp("cms.Column","Exporter",function(){new MWF.xApplication.cms.Column.Exporter(this.app,this.data).load()}.bind(this))},edit:function(){new MWF.xApplication.cms.Column.PopupForm(this.app,this.data,{title:this.lp.edit},{app:this.app,container:this.app.content,lp:this.lp,css:{},actions:this.app.restActions}).edit()},openForm:function(t){layout.desktop.getFormDesignerStyle(function(){var e=this,i={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.category=e,this.options.id=t.id,this.column=e.data,this.application=e.data}};this.app.desktop.openApplication(null,"cms.FormDesigner",i)}.bind(this))},clickColumnNode:function(t,e,i,n){var o="cms.ColumnManager"+this.data.id;if(this.app.desktop.apps[o]){var s=this.app.desktop.apps[o];s&&s.setCurrent&&s.setCurrent(),n&&s&&s.setCategory&&s.setCategory(n)}else this.app.desktop.openApplication(i,"cms.ColumnManager",{currentCategoryId:n,column:this.data,appId:o,onQueryLoad:function(){this.status={navi:0}}})},checkDeleteColumn:function(){this.deleteElements.length?this.deleteElementsNode||(this.deleteElementsNode=new Element("div",{styles:this.app.css.deleteElementsNode,text:this.lp.deleteElements}).inject(this.node),this.deleteElementsNode.position({relativeTo:this.container,position:"centerTop",edge:"centerbottom"}),this.deleteElementsNode.addEvent("click",function(t){this.delete()}.bind(this))):this.deleteElementsNode&&(this.deleteElementsNode.destroy(),this.deleteElementsNode=null,delete this.deleteElementsNode)},deleteColumn:function(t){var e=this;this.app.confirm("warn",t,this.lp.delete_confirm_title,this.lp.delete_confirm_content,320,100,(function(){e._deleteElement(),this.close()}),(function(){this.close()}))},_deleteElement:function(t,e,i){this.app.restActions.removeColumn(t||this.data.id,function(){this.app.reloadTop(null,null,!0),this.destroy(),e&&e()}.bind(this),function(t){var e=JSON.parse(t.responseText);this.app.notice(e.message,"error"),i&&i()}.bind(this))},destroy:function(){this.node.destroy(),MWF.release(this)}}),MWF.xApplication.cms.Column.PopupForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"blue",width:"650",height:"500",hasTop:!0,hasIcon:!1,hasTopContent:!0,hasBottom:!0,draggable:!0,closeAction:!0},_createTableContent:function(){if(this.isNew)t="",e="",i="",n="",o="";else var t=this.data.appName,e=this.data.appAlias||"",i=this.data.description,n=this.data.appInfoSeq,o=(this.data.creatorUid,this.data.createTime,this.data.appType||"");var s='<table width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0"><tr><td style="font-size:16px; height: 40px; line-height: 40px; text-align: left; min-width: 60px; width:20%">'+this.lp.nameLabel+'：</td><td style="; text-align: right;"><input type="text" id="createColumnName" style="width: 95%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;" value="'+t+'"/></td></tr><tr><td style="font-size:16px; height: 40px; line-height: 40px;  text-align: left">'+this.lp.aliasLabel+'：</td><td style="; text-align: right;"><input type="text" id="createColumnAlias" style="width: 95%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;" value="'+e+'"/></td></tr><tr><td style="font-size:16px; height: 40px; line-height: 40px;  text-align: left">'+this.lp.descriptionLabel+'：</td><td style="; text-align: right;"><input type="text" id="createColumnDescription" style="width: 95%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;" value="'+i+'"/></td></tr><tr><td style="font-size:16px; height: 40px; line-height: 40px;  text-align: left">'+this.lp.sortLabel+'：</td><td style="; text-align: right;"><input type="text" id="createColumnSort" style="width: 95%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;" value="'+n+'"/></td></tr><tr><td style="font-size:16px; height: 40px; line-height: 40px;  text-align: left">'+this.lp.typeLabel+'：</td><td style="; text-align: right;"><input type="text" id="createColumnType" style="width: 95%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;" value="'+o+'"/></td></tr><tr><td style="font-size:16px; height: 40px; line-height: 40px;  text-align: left">'+this.lp.iconLabel+"：</td><td style=\"; text-align: right;\"><div id='formIconPreview'></div><div id='formChangeIconAction'></div></td></tr></table>";this.formTableArea.set("html",s),this.setContent(),this.setIconContent()},_setCustom:function(){this.formTableContainer.setStyles({"padding-top":"15px",width:"470px"}),this.formBottomNode.setStyles({"padding-right":"170px","padding-bottom":"50px"})},setContent:function(){this.nameInput=this.formTableArea.getElementById("createColumnName"),this.aliasInput=this.formTableArea.getElementById("createColumnAlias"),this.descriptionInput=this.formTableArea.getElementById("createColumnDescription"),this.sortInput=this.formTableArea.getElementById("createColumnSort"),this.typeInput=this.formTableArea.getElementById("createColumnType")},setIconContent:function(){this.iconPreviewNode=this.formTableArea.getElement("div#formIconPreview"),this.iconActionNode=this.formTableArea.getElement("div#formChangeIconAction"),this.iconPreviewNode.setStyles({"margin-left":"20px","margin-top":"10px",height:"72px",width:"72px",float:"left"}),!this.isNew&&this.data.appIcon?this.iconPreviewNode.setStyle("background","url(data:image/png;base64,"+this.data.appIcon+") center center no-repeat"):this.iconPreviewNode.setStyle("background","url(../x_component_cms_Column/$Main/default/icon/column.png) center center no-repeat"),new Element("div",{styles:{"margin-left":"20px",float:"left","background-color":"#FFF",padding:"4px 14px",border:"1px solid #999","border-radius":"3px","margin-top":"25px","font-size":"14px",color:"#666",cursor:"pointer"},text:this.lp.changeIcon}).inject(this.iconActionNode).addEvent("click",function(){this.changeIcon()}.bind(this))},cancel:function(t){this.fireEvent("queryCancel"),this.isNew?this.cancelNewColumn(t):this.close(),this.fireEvent("postCancel")},cancelNewColumn:function(t){var e=this;this.nameInput.get("value")||this.descriptionInput.get("value")?this.app.confirm("warn",t,this.lp.create_cancel_title,this.lp.create_cancel,320,100,(function(){e.close(),this.close()}),(function(){this.close()})):e.close()},ok:function(t){this.fireEvent("queryOk");var e={id:this.data&&this.data.id?this.data.id:this.app.restActions.getUUID(),isNewColumn:this.isNew,appName:this.nameInput.get("value"),appAlias:this.aliasInput.get("value"),alias:this.aliasInput.get("value"),description:this.descriptionInput.get("value"),appInfoSeq:this.sortInput.get("value"),appType:this.typeInput.get("value")};if(this.data&&this.data.appIcon&&(e.appIcon=this.data.appIcon),e.appName){var i=function(t){this.app.restActions.getColumn(t,function(t){if(this.isNew,this.app.noElementNode&&this.app.noElementNode.destroy(),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app&&this.app.notice(this.isNew?this.lp.createColumnSuccess:this.lp.updateColumnSuccess,"success"),this.isNew){var e=new MWF.xApplication.cms.Column.Column(this.app,t.data,{where:"top"});e.load(),this.app.columns.push(e),this.app.reloadTop(null,null,!0)}else this.app.reload();this.fireEvent("postOk")}.bind(this))}.bind(this);this.app.restActions.saveColumn(e,function(t){"error"==t.type?this.app.notice(t.message,"error"):this.formData?this.saveIcon(t.data.id,i):i(t.data.id)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.app.notice(e.message||json.userMessage,"error")}.bind(this))}else this.app.notice(this.lp.inputName)},changeIcon:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var e=t.files;if(e.length)for(var i=0;i<e.length;i++){var n=e.item(i);if(n.type.match("image.*")&&(this.file=n,this.formData=new FormData,this.formData.append("file",this.file),window.FileReader)){var o=new FileReader;o.onload=function(t){return function(t){this.iconPreviewNode.setStyle("background",""),this.iconPreviewNode.empty(),new Element("img",{styles:{height:"72px",width:"72px"},src:t.target.result}).inject(this.iconPreviewNode)}.bind(this)}.bind(this)(n),o.readAsDataURL(n)}}}.bind(this))}var t=this.uploadFileAreaNode.getFirst();t.click()},saveIcon:function(t,e){this.app.restActions.updataColumnIcon(t,function(){this.formData=null,e&&e(t)}.bind(this),null,this.formData,this.file)}});