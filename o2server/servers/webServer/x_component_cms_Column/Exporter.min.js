MWF.xApplication.cms.Column.Exporter=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.container=this.app.content,this.data=e,this.path="../x_component_cms_Column/$Exporter/",this.cssPath="../x_component_cms_Column/$Exporter/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.container.mask({destroyOnHide:!0,style:{"background-color":"#666",opacity:.6}}),this.node=new Element("div",{styles:this.css.content}),this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.app.lp.export}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node),this.buttonAreaNode=new Element("div",{styles:this.css.buttonAreaNode}).inject(this.node),this.cancelButton=new Element("div",{styles:this.css.button,text:this.app.lp.export_cancel}).inject(this.buttonAreaNode),this.okButton=new Element("div",{styles:this.css.okButton,text:this.app.lp.export_ok}).inject(this.buttonAreaNode),this.loadContent(),this.setEvent(),this.node.inject(this.container),this.node.position({relativeTo:this.container,position:"center",edge:"center"})},loadContent:function(){this.actions=this.app.restActions;var t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode);this.categorySelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.cate}).inject(t),this.categoryListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode),this.formSelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.form}).inject(t),this.formListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode),this.listSelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.list}).inject(t),this.listListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode),this.queryViewSelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.queryView}).inject(t),this.queryViewListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode),this.dictionarySelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.dictionary}).inject(t),this.dictionaryListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),t=new Element("div",{styles:this.css.listTitleNodeArea}).inject(this.contentNode),this.scriptSelectAction=new Element("div",{styles:this.css.listTitleActionNode,text:this.app.lp.inverse}).inject(t),new Element("div",{styles:this.css.listTitleNode,text:this.app.lp.script}).inject(t),this.scriptListNode=new Element("div",{styles:this.css.listNode}).inject(this.contentNode),this.listCategory(),this.listForm(),this.listList(),this.listQueryView(),this.listDictionary(),this.listScript(),this.categorySelectAction.addEvent("click",function(){this.inverse(this.categoryListNode)}.bind(this)),this.formSelectAction.addEvent("click",function(){this.inverse(this.formListNode)}.bind(this)),this.listSelectAction.addEvent("click",function(){this.inverse(this.listListNode)}.bind(this)),this.queryViewSelectAction.addEvent("click",function(){this.inverse(this.queryViewListNode)}.bind(this)),this.dictionarySelectAction.addEvent("click",function(){this.inverse(this.dictionaryListNode)}.bind(this)),this.scriptSelectAction.addEvent("click",function(){this.inverse(this.scriptListNode)}.bind(this))},listCategory:function(){this.actions.listCategory(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.categoryListNode)}.bind(this))}.bind(this))},listForm:function(){this.actions.listForm(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.formListNode)}.bind(this))}.bind(this))},listList:function(){this.actions.listView(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.listListNode)}.bind(this))}.bind(this))},listQueryView:function(){this.actions.listQueryView(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.queryViewListNode)}.bind(this))}.bind(this))},listDictionary:function(){this.actions.listDictionary(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.dictionaryListNode)}.bind(this))}.bind(this))},listScript:function(){this.actions.listScript(this.data.id,function(t){t.data&&t.data.each(function(t){this.createItem(t,this.scriptListNode)}.bind(this))}.bind(this))},inverse:function(t){t.getElements("input").each((function(t){t.checked?t.set("checked",!1):t.set("checked",!0)}))},createItem:function(t,e){var i=new Element("div",{styles:this.css.categoryItem}).inject(e);new Element("input",{styles:this.css.categoryItemCheckbox,type:"checkbox",checked:!0}).inject(i).store("itemData",t);new Element("div",{text:t.name,styles:this.css.categoryItemText}).inject(i)},setEvent:function(){this.cancelButton.addEvent("click",function(t){this.close()}.bind(this)),this.okButton.addEvent("click",function(t){this.exportApplication()}.bind(this))},close:function(){this.container.unmask(),this.node.destroy(),this.cancelButton=null,this.okButton=null,this.buttonAreaNode=null,this.contentNode=null,this.titleNode=null,this.node=null,this.categoryListNode=null,this.formListNode=null,this.listListNode=null,this.queryViewListNode=null,this.dictionaryListNode=null,this.scriptListNode=null,this.fireEvent("close")},exportApplication:function(){this.applicationJson={application:{},categoryList:[],formList:[],listList:[],queryViewList:[],dictionaryList:[],scriptList:[]},this.createProgressBar();var t=this.categoryListNode.getElements("input:checked"),e=this.formListNode.getElements("input:checked"),i=this.listListNode.getElements("input:checked"),s=this.queryViewListNode.getElements("input:checked"),n=this.dictionaryListNode.getElements("input:checked"),o=this.scriptListNode.getElements("input:checked");this.status={count:t.length+e.length+i.length+s.length+n.length+o.length+1,complete:0},this.exportProperty(),this.exportCategoryes(t),this.exportForms(e),this.exportLists(i),this.exportQueryViews(s),this.exportDictionarys(n),this.exportScripts(o)},exportProperty:function(){this.actions.getColumn(this.data.id,function(t){this.progressBarTextNode.set("text","load Application Property ..."),t.data&&(this.applicationJson.application=t.data),this.checkExport()}.bind(this))},exportCategoryes:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getCategory(e.id,function(t){this.progressBarTextNode.set("text",'load Category "'+e.name+'" ...'),t.data&&this.applicationJson.categoryList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},exportForms:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getForm(e.id,function(t){this.progressBarTextNode.set("text",'load Form "'+e.name+'" ...'),t.data&&this.applicationJson.formList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},exportLists:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getView(e.id,function(t){this.progressBarTextNode.set("text",'load Form "'+e.name+'" ...'),t.data&&this.applicationJson.listList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},exportQueryViews:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getQueryView(e.id,function(t){this.progressBarTextNode.set("text",'load Form "'+e.name+'" ...'),t.data&&this.applicationJson.queryViewList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},exportDictionarys:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getDictionary(e.id,function(t){this.progressBarTextNode.set("text",'load Dictionary "'+e.name+'" ...'),t.data&&this.applicationJson.dictionaryList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},exportScripts:function(t){t.each(function(t){var e=t.retrieve("itemData");this.actions.getScript(e.id,function(t){this.progressBarTextNode.set("text",'load Script "'+e.name+'" ...'),t.data&&this.applicationJson.scriptList.push(t.data),this.checkExport()}.bind(this))}.bind(this))},checkExport:function(){this.status.complete=this.status.complete+1;var t=this.status.complete/this.status.count*358;this.progressBarPercent.setStyle("width",t+"px"),this.status.complete==this.status.count&&this.saveApplicationToLocal()},saveApplicationToLocal:function(){window.hasOwnProperty("ActiveXObject")?window.open("","_blank").document.write(JSON.encode(this.applicationJson)):this.downloadFile(this.data.name+".xapp",JSON.encode(this.applicationJson));this.progressBarNode.destroy(),this.progressBarNode=null,this.progressBarTextNode=null,this.progressBar=null,this.progressBarPercent=null,this.close()},downloadFile:function(t,e){var i=new Element("a",{text:this.data.name}).inject(this.progressBarTextNode),s=new Blob([e]);i.download=t,i.href=URL.createObjectURL(s);var n=document.createEvent("HTMLEvents");n.initEvent("click",!1,!1),i.dispatchEvent(n),i.click()},createProgressBar:function(){this.node.hide(),this.progressBarNode=new Element("div",{styles:this.css.progressBarNode}),this.progressBarNode.inject(this.container),this.progressBarNode.position({relativeTo:this.container,position:"center",edge:"center"}),this.progressBarTextNode=new Element("div",{styles:this.css.progressBarTextNode}).inject(this.progressBarNode),this.progressBar=new Element("div",{styles:this.css.progressBar}).inject(this.progressBarNode),this.progressBarPercent=new Element("div",{styles:this.css.progressBarPercent}).inject(this.progressBar)}});