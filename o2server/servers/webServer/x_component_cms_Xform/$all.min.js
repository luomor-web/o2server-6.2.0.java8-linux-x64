o2.widget=o2.widget||{},o2.widget.UUID||o2.require("o2.widget.UUID",null,!1),o2.widget.AttachmentController=o2.widget.ATTER=new Class({Extends:o2.widget.Common,Implements:[Options,Events],options:{style:"default",listStyle:"icon",size:"max",resize:!0,attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,isPreviewAtt:!0,isSizeChange:!0,readonly:!1,availableListStyles:["list","seq","icon","preview"],toolbarGroupHidden:[],images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"],actionShowText:!1},initialize:function(t,e,i){this.setOptions(i),this.pages=[],this.path=o2.session.path+"/widget/$AttachmentController/",this.cssPath=o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/css.wcss",this._loadCss();var s=this.options.iconConfigUrl?this.options.iconConfigUrl:"../x_component_File/$Main/icon.json";o2.getJSON(s,function(t){this.icons=t}.bind(this),!1,!1),this.module=e,this.actions=[],this.attachments=[],this.selectedAttachments=[],this.container=$(t)},load:function(){"min"===this.options.size?this.loadMin():this.loadMax()},reloadAttachments:function(){if("min"===this.options.size){this.minContent.empty();var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(e.data,this))}}else{this.content.empty();t=this.attachments;for(this.attachments=[];t.length;){e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}}this.checkActions()},getAttachmentById:function(t){for(var e=0;e<this.attachments.length;e++)if(this.attachments[e].data.id===t)return this.attachments[e];return null},loadMax:function(){this.node||(this.node=new Element("div",{styles:this.css.container})),this.createTopNode(),this.contentScrollNode?(this.contentScrollNode.setStyle("display","block"),this.bottomNode&&this.bottomNode.setStyle("display","block"),this.titleNode&&this.titleNode.setStyle("display","block"),this.content.empty()):(this.createContentNode(),this.options.resize&&(this.createBottomNode(),this.createResizeNode()),this.node.inject(this.container),this.checkActions(),this.setEvent());var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}this.checkActions()},loadMin:function(){this.node||(this.node=new Element("div",{styles:this.css.container_min})),this.minActionAreaNode?(this.minActionAreaNode.setStyle("display",""),this.minActionAreaNode.empty(),this.loadMinActions(),this.setEvent()):(this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node),this.loadMinActions(),this.node.inject(this.container),this.setEvent());var t=this.options.toolbarGroupHidden;t.contains("edit")&&t.contains("read")&&t.contains("view")&&this.minActionAreaNode.setStyle("display","none"),this.minContent?(this.minContent.setStyle("display","block"),this.minContent.empty()):(this.minContent=new Element("div",{styles:layout.mobile?this.css.minContentNode_mobile:this.css.minContentNode}).inject(this.node),layout.mobile&&this.minContent.setStyle("clear","both"));var e=this.attachments;for(this.attachments=[];e.length;){var i=e.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(i.data,this))}this.checkActions()},loadMobile:function(){},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",o2.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},setEvent:function(){this.contentScrollNode&&this.contentScrollNode.addEvents({mousedown:this.unSelectedAttachments.bind(this)}),this.minContent&&this.minContent.addEvents({mousedown:this.unSelectedAttachments.bind(this)})},resetToolbarGroupHidden:function(t){this.options.toolbarGroupHidden=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},resetToolbarAvailableListStyle:function(t){this.options.availableListStyles=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},createContentNode:function(){this.contentScrollNode=new Element("div.contentScrollNode",{styles:this.css.contentScrollNode}).inject(this.node),this.content=new Element("div.content",{styles:this.css.contentNode}).inject(this.contentScrollNode),o2.require("o2.widget.ScrollBar",function(){new o2.widget.ScrollBar(this.contentScrollNode,{style:"attachment",where:"before",distance:30,friction:4,axis:{x:!1,y:!0}})}.bind(this))},createBottomNode:function(){this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.node)},createResizeNode:function(){this.resizeNode=new Element("div",{styles:this.css.resizeNode}).inject(this.bottomNode),this.resizeDrag=new Drag(this.resizeNode,{snap:"2",onStart:function(t,e){t.store("startY",e.event.y),t.store("nodeHeight",this.node.getSize().y);var i=this.node.getStyle("min-height");t.store("nodeMinHeight",i?i.toFloat():"");var s=this.contentScrollNode.getStyle("min-height");t.store("contentScrollNodeMinHeight",s?s.toFloat():""),this.nodeHeight||(this.nodeHeight=i.toFloat())}.bind(this),onDrag:function(t,e){var i=t.retrieve("startY"),s=t.retrieve("nodeHeight"),o=t.retrieve("nodeMinHeight"),n=t.retrieve("contentScrollNodeMinHeight"),a=e.event.y-i+s;if(!(o&&a<o&&e.event.y<i)){a<this.nodeHeight&&(a=this.nodeHeight);var r=a-81;n&&r<n&&e.event.y<i||(this.node.setStyle("height",a+"px"),this.contentScrollNode.setStyle("height",r+"px"))}}.bind(this)})},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;if(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view"))return this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),void(this.isHiddenTop=!0);t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),t.contains("view")||this.createViewGroupActions()},reloadTopNode:function(){this.createTopNode()},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createReadGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.downloadAction=this.createAction(this.editActionsGroupNode,"download",o2.LP.widget.download,function(){this.downloadAttachment()}.bind(this))},createListGroupActions:function(){var t=this.options.availableListStyles;t&&t.length>0&&(this.listActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.listActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.listActionBoxNode),t.contains("list")&&(this.listAction=this.createAction(this.listActionsGroupNode,"list",o2.LP.widget.list,function(){this.changeListStyle("list")}.bind(this))),t.contains("seq")&&(this.sequenceAction=this.createAction(this.listActionsGroupNode,"seq",o2.LP.widget.sequence,function(){this.changeListStyle("sequence")}.bind(this))),t.contains("icon")&&(this.iconAction=this.createAction(this.listActionsGroupNode,"icon",o2.LP.widget.icon,function(){this.changeListStyle("icon")}.bind(this))),t.contains("preview")&&(this.previewAction=this.createAction(this.listActionsGroupNode,"preview",o2.LP.widget.preview,function(){this.changeListStyle("preview")}.bind(this))))},createViewGroupActions:function(){this.options.isSizeChange&&(this.viewActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.viewActionBoxNode.setStyles({float:"right","margin-right":"7px"}),this.viewActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.viewActionBoxNode),this.sizeAction=this.createAction(this.viewActionsGroupNode,"min",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this)))},createSeparate:function(t){return new Element("div.separateNode",{styles:this.css.separateNode}).inject(t)},createAction:function(t,e,i,s){var o=new Element("div",{styles:this.css.actionNode,title:i}).inject(t);new Element("div",{styles:this.css.actionIconNode}).inject(o).setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/icon/"+e+".png)");var n=this;return o.addEvents({mouseover:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+n.options.style+"/overbg.png)")},mouseout:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","transparent")},click:function(t){this.retrieve("disabled")||n.doAction(t,this,s),t.stopPropagation()}}),this.actions.push(o),o},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkListStyleAction()},checkUploadAction:function(){if(this.options.readonly)return this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction),!1;this.options.isUpload?0!=this.options.attachmentCount&&this.attachments.length>=this.options.attachmentCount?(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction)):(this.setActionEnabled(this.uploadAction),this.setActionEnabled(this.min_uploadAction)):(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction))},checkDeleteAction:function(){if(this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1),!1;this.options.isDelete?(this.selectedAttachments.length?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)),this.setAttachmentsAction("delete",!0)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1))},isAttDeleteAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isDelete)},checkReplaceAction:function(){if(!this.options.isReplaceHidden)return this.options.readonly?(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1),!1):void(this.options.isReplace?(this.selectedAttachments.length&&1==this.selectedAttachments.length?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)),this.setAttachmentsAction("replace",!0)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1)))},isAttReplaceAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isReplace)},checkDownloadAction:function(){this.options.isDownload?(this.selectedAttachments.length?(this.setActionEnabled(this.downloadAction),this.setActionEnabled(this.min_downloadAction)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction)),this.setActionEnabled(this.downloadAllAction),this.setAttachmentsAction("download",!0)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction),this.setActionDisabled(this.downloadAllAction),this.setAttachmentsAction("download",!1))},isAttDownloadAvailable:function(t){return!this.options.toolbarGroupHidden.contains("read")&&this.options.isDownload},checkSizeAction:function(){this.sizeAction&&(this.options.isSizeChange?this.setActionEnabled(this.sizeAction):this.setActionDisabled(this.sizeAction))},checkListStyleAction:function(){switch(this.options.listStyle){case"list":this.setActionSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"icon":this.setActionUnSelcted(this.listAction),this.setActionSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"preview":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"sequence":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionSelcted(this.sequenceAction)}},setActionSelcted:function(t){t&&(t.retrieve("selected")||(t.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)"),t.store("selected",!0)))},setActionUnSelcted:function(t){t&&t.retrieve("selected")&&(t.setStyle("background",""),t.store("selected",!1))},setActionEnabled:function(t){if(t&&t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("_gray"))+"."+s,e.setStyle("background-image",i),t.store("disabled",!1)}},setActionDisabled:function(t){if(t&&!t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("."))+"_gray."+s,e.setStyle("background-image",i),t.store("disabled",!0)}},setReadonly:function(){this.actions.each(function(t){this.setActionDisabled(t),this.setAttachmentsAction("all",!1)}.bind(this))},setAttachmentsAction:function(t,e){this.attachments.each(function(i){this.setAttachmentAction(i,t,e)}.bind(this))},setAttachmentAction:function(t,e,i){var s;if("all"===e)(t.actions||[]).each((function(e){t[i?"setActionEnabled":"setActionDisabled"](e)}));else{switch(e){case"download":s=t.downloadAction;break;case"config":s=t.configAction;break;case"delete":s=t.deleteAction;break;case"replace":s=t.replaceAction}if(!s)return;if("config"===e){var o=i;if(o){var n=layout.session.user.distinguishedName;!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===n||(o=!1)}t[o?"setActionEnabled":"setActionDisabled"](s)}else t[i?"setActionEnabled":"setActionDisabled"](s)}},doAction:function(t,e,i){i&&i.apply(this,[t,e])},uploadAttachment:function(t,e){this.module&&this.module.uploadAttachment(t,e)},doUploadAttachment:function(t,e,i,s,o,n,a,r,l,d,c){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,a,r,l,d,c):this.doFormDataUploadAttachment(t,e,i,s,o,n,a,r,l,d,c)},addUploadMessage:function(t){var e;e='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px"><div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+o2.LP.desktop.action.uploadTitle+"</div></div><iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:o2.LP.desktop.action.uploadTitle,content:t+"<br/>"+e};if(layout.desktop.message){var s=layout.desktop.message.addMessage(i);s.close=function(t,e){s.completed&&s.closeItem(t,e)}}return window.setTimeout(function(){layout.desktop.message&&(layout.desktop.message.isShow||layout.desktop.message.show())}.bind(this),300),s},setMessageTitle:function(t,e){t&&t.subjectNode.set("text",e)},setMessageText:function(t,e){if(t){t.contentNode.getFirst("div").getFirst("div").getFirst("div");t.contentNode.getFirst("div").getLast("div").set("text",e),t.dateNode.set("text",(new Date).format("db"))}},doInputUploadAttachment:function(t,e,i,s,o,n,a,r,l,d){var c=e;"string"==typeOf(e)&&(c=o2.Actions.get(e).action),c.getActions(function(){var e=c.actions[i];e=c.address+e.uri,Object.each(s,(function(t,i){e=e.replace("{"+i+"}",t)}));var r=this.module.content;r||this.module.form&&(r=this.module.form.app.content),r||(r=this.node),r&&r.mask({style:{opacity:.7,"background-color":"#999"}}),this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container),this.inputUploadAreaNode.position({relativeTo:this.module.content,position:"center"});var l=null;document.O2UploadCallbackFun=function(t){var e=JSON.decode(t);l.completed=!0,"success"===e.type?(n&&n(e.data),this.setMessageTitle(l,o2.LP.desktop.action.uploadComplete),this.setMessageText(l,o2.LP.desktop.action.uploadComplete),o&&o()):(this.setMessageTitle(l,o2.LP.desktop.action.sendError),this.setMessageText(l,o2.LP.desktop.action.sendError+": "+e.message),o2.xDesktop.notice("error",{x:"right",y:"top"},e.message))}.bind(this);var d=new Element("form",{method:"POST",action:e+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode),h=(new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:o2.LP.widget.uploadTitle}).inject(d),new Element("div",{styles:this.css.inputUploadAreaInforNode,text:o2.LP.widget.uploadInfor}).inject(d),new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(d)),u=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(h),p=new Element("input",{type:"hidden",name:"fileName"}).inject(h);Object.each(t,(function(t,e){new Element("input",{type:"hidden",name:e,value:t}).inject(h)}));var m=new Element("div",{styles:this.css.inputUploadActionNode}).inject(d),f=new Element("button",{styles:this.css.inputUploadCancelButton,text:o2.LP.widget.cancel}).inject(m),g=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:o2.LP.widget.ok}).inject(m);u.addEvent("change",function(){var t=u.get("value");if(t){var e=t.replace(/\\/g,"/"),i=e.lastIndexOf("/"),s=-1===i?e:e.substr(i+1,e.length-i);p.set("value",s)}}.bind(this)),f.addEvent("click",function(){r&&r.unmask(),this.inputUploadAreaNode.destroy()}.bind(this)),g.addEvent("click",function(){d.mask({style:{opacity:.7,"background-color":"#999"}});var t=!0;a&&(t=a([p.get("value")])),t&&(l=this.addUploadMessage(p.get("value")),d.submit(),r&&r.unmask(),this.inputUploadAreaNode&&this.inputUploadAreaNode.destroy())}.bind(this))}.bind(this))},doFormDataUploadAttachment:function(t,e,i,s,o,n,a,r,l,d,c){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" multiple type="file" accept="*/*"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var r=this.fileUploadNode.files;if(r.length){var h=r.length,u=0,p=!1,m=e;"string"==typeOf(e)&&(m=o2.Actions.get(e).action);var f=function(){u==h&&o&&o(p)},g=!0;if(a&&(g=a(r)),g)for(var b=l?l.split(o2.splitStr):null,y=0;y<r.length;y++){var v=r.item(y),x=v.name.substr(v.name.lastIndexOf("."),v.name.length);if(x=x.toLowerCase(),b&&-1===b.indexOf(x)&&-1===b.indexOf("*")&&-1===b.indexOf("*/*")){var w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML.replace("{filename}",v.name)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);var A=o2.LP.widget.refuseUploadNotice.replace("{filename}",v.name);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},A,this.node)}else if(d&&v.size>1024*d*1024){w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML_size.replace("{filename}",v.name).replace("{size}",d)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);A=o2.LP.widget.refuseUploadNotice_size.replace("{filename}",v.name).replace("{size}",d);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},A,this.node)}else{var j=new FormData;Object.each(t,(function(t,e){j.append(e,t)})),j.append("file",v),s.fileMd5?o2.load("../o2_lib/CryptoJS/components/spark-md5-min.js",function(){var t=new FileReader,e=(document.getElementById("box"),File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice),o=Math.ceil(v.size/20971520),a=0,r=new SparkMD5;function l(){var i=20971520*a,s=i+20971520>=v.size?v.size:i+20971520;t.readAsBinaryString(e.call(v,i,s))}t.onload=function(t){if(console.log("read chunk nr",a+1,"of",o),r.appendBinary(t.target.result),++a<o)l();else{console.log("finished loading");var e=r.end();m.invoke({name:"checkFileExist",async:!0,parameter:{fileMd5:e},success:function(t){if(t.data.value){var o=new FormData;o.append("fileMd5",e),o.append("fileName",v.name),m.invoke({name:"addAttachmentMd5",async:!0,data:o,parameter:s,success:function(t){u++,n&&n(t,u,h),f()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,c&&c(t,u,h),f()}})}else m.invoke({name:i,async:!0,data:j,file:v,parameter:s,success:function(t){u++,n&&n(t,u,h),f()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,c&&c(t,u,h),f()}})}})}},l()}.bind(this),null,!1):(m.targetModule={module:this,file:v},m.invoke({name:i,async:!0,data:j,file:v,parameter:s,success:function(t){u++,n&&n(t,u,h),f()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,c&&c(t,u,h),f()}}))}}this.uploadFileAreaNode.destroy(),this.uploadFileAreaNode=null}}.bind(this))}this.fileUploadNode.set("accept",l||"*/*"),this.fileUploadNode.set("multiple",!1!==r),this.fileUploadNode.click()},addFormDataMessage:function(t){return this.addAttachmentMessage(t)},addAttachmentMessage:function(t){var e;return e="min"==this.options.size?new o2.widget.AttachmentController.AttachmentMessageMin(t,this):new o2.widget.AttachmentController.AttachmentMessage(t,this),this.messageItemList||(this.messageItemList={}),this.messageItemList[e.data.id]=e,e},openInOfficeControl:function(t,e){},deleteAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.deleteAttachments(t,e,this.selectedAttachments)},replaceAttachment:function(t,e){this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},doReplaceAttachment:function(t,e,i,s,o,n,a,a,r){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,a,a,r):this.doFormDataUploadAttachment(t,e,i,s,o,n,a,a,r)},previewAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.previewAttachment(this.selectedAttachments)},downloadAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.downloadAttachment(t,e,this.selectedAttachments)},openAttachment:function(t,e,i){this.options.isDownload&&i&&this.module&&this.module.openAttachment(t,e,i)},downloadAllAttachment:function(t,e){this.module&&this.module.downloadAttachment(t,e,this.attachments)},changeListStyle:function(t){this.options.listStyle=t,this.attachments.each(function(e){e.changeListStyle(t)}.bind(this)),this.checkListStyleAction()},changeControllerSize:function(t,e){"max"==this.options.size?this.changeControllerSizeToMin():this.changeControllerSizeToMax()},changeControllerSizeToMin:function(){"min"!=this.options.size&&(this.contentScrollNode&&this.contentScrollNode.setStyle("display","none"),this.bottomNode&&this.bottomNode.setStyle("display","none"),this.topNode&&this.topNode.setStyle("display","none"),this.titleNode&&this.titleNode.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container_min).chain(function(){this.options.size="min",this.loadMin()}.bind(this)))},changeControllerSizeToMax:function(){"max"!=this.options.size&&(this.minActionAreaNode&&this.minActionAreaNode.setStyle("display","none"),this.minContent&&this.minContent.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container).chain(function(){this.options.size="max",this.loadMax()}.bind(this)))},getAttachmentNames:function(){var t=[];return this.attachments.each((function(e){t.push(e.data.name)})),t},addAttachment:function(t,e,i){"min"==this.options.size?this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(t,this,e,i)):this.attachments.push(new o2.widget.AttachmentController.Attachment(t,this,e,i)),this.checkActions()},removeAttachment:function(t){this.attachments.erase(t),this.selectedAttachments.erase(t),t.node.destroy(),delete t},unSelectedAttachments:function(){for(;this.selectedAttachments.length;){this.selectedAttachments.shift().unSelected()}this.checkActions()},clear:function(){this.selectedAttachments=[],this.attachments.each((function(t){t.node.destroy(),o2.release(t)})),this.attachments=[];var t=this.minContent||this.content;t&&t.empty()}}),o2.widget.AttachmentController.Attachment=new Class({Implements:[Events],initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.isCheckPosition=s,this.actions=[],i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},_getLnkPar:function(t){return{icon:this.getIcon(),title:this.data.name,par:"@url#"+t}},isNumber:function(t){return"NaN"!==parseFloat(t).toString()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.controller.module.getAttachmentUrl(this,function(t){this.node.makeLnk({par:this._getLnkPar(t)})}.bind(this)),this.createInforNode(function(){Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"}))}.bind(this)),this.setEvent()},createInforNode:function(t){var e="",i=this.data.length/1024;if(i>1024){var s=i/1024;e=(s=Math.round(100*s)/100)+"M"}else e=(i=Math.round(100*i)/100)+"K";this.inforNode=new Element("div",{styles:this.css.attachmentInforNode});var o="<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.person||this.data.creatorUid)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName||o2.LP.widget.unknow)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+e+"</div></div>",this.inforNode.set("html",o),t&&t()},getIcon:function(){this.data.extension||(this.data.extension="unkonw");var t=this.controller.icons[this.data.extension.toLowerCase()]||this.controller.icons.unknow;return(this.controller.options.iconFolderUrl?this.controller.options.iconFolderUrl:"../x_component_File/$Main/default/file/")+t},loadList:function(){this.node.setStyles(this.css.attachmentNode_list),this.isSelected&&this.node.setStyles(this.css.attachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_list}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_List()},custom_List:function(){},loadSequence:function(){this.node.setStyles(this.css.attachmentNode_sequence),this.isSelected&&this.node.setStyles(this.css.attachmentNode_sequence_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_sequence}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_Sequence()},custom_Sequence:function(){},loadIcon:function(){this.node.setStyles(this.css.attachmentNode_icon),this.isSelected&&this.node.setStyles(this.css.attachmentNode_icon_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.custom_Icon()},custom_Icon:function(){},loadPreview:function(){this.node.setStyles(this.css.attachmentNode_preview),this.isSelected&&this.node.setStyles(this.css.attachmentNode_preview_selected),this.iconNode=new Element("div",{styles:this.css.attachmentPreviewIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);var t=this.getIcon();-1!==this.controller.options.images.indexOf(this.data.extension.toLowerCase())?(this.controller.module.getAttachmentUrl(this,function(e){t=e,this.getPreviewImgSize(t,function(e){this.iconImgNode.set({src:t,border:0}),this.iconImgAreaNode.setStyles({width:e.x+"px",height:e.y+"px"}),this.iconImgNode.setStyles({width:e.x+"px",height:e.y+"px","margin-top":e.top+"px"}),window.setTimeout(function(){this.getPreviewImgSize(t,function(t){this.iconImgAreaNode&&this.iconImgAreaNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.iconImgNode&&this.iconImgNode.setStyles({width:t.x+"px",height:t.y+"px","margin-top":t.top+"px"})}.bind(this))}.bind(this),100)}.bind(this))}.bind(this)),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)):-1!==this.controller.options.audios.indexOf(this.data.extension.toLowerCase())?(this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.controller.module.getAttachmentUrl(this,function(e){this.iconImgNode.set({src:t,border:0}),this.iconAudioNode=new Element("div",{styles:this.css.attachmentPreviewAudioNode,html:'<audio preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+e+'" type="audio/mpeg"></source></audio>'}).inject(this.textNode,"after"),this.iconAudioNode.addEvent("dblclick",(function(t){t.stopPropagation()}))}.bind(this))):-1!==this.controller.options.videos.indexOf(this.data.extension.toLowerCase())?this.controller.module.getAttachmentUrl(this,function(t){this.iconNode.empty(),this.iconVideoNode=new Element("div",{styles:this.css.attachmentPreviewVideoNode,html:'<video preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+t+'"></source></video>'}).inject(this.iconNode),this.iconVideoNode.addEvent("dblclick",(function(t){t.stopPropagation()})),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)}.bind(this)):(this.iconImgNode.set({src:t,border:0}),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)),this.custom_Preview()},custom_Preview:function(){},getPreviewImgSize:function(t,e){var i=this.iconNode.getSize(),s=new Element("img",{src:t}).inject($(document.body));s.set("src",t);var o,n=s.getSize();s.destroy();var a,r=i.x/n.x;(a=n.y*r)<=i.y?o=i.x:(r=i.y/n.y,o=n.x*r,a=i.y);n={x:o,y:a,top:(i.y-a)/2};e&&e(n)},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]),this.controller.selectedAttachments.erase(this)},changeListStyle:function(t){if(this.listStyle!=t){switch(this.node.empty(),t){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.listStyle=t}},reload:function(){var t=new Element("div").inject(this.node,"after");switch(this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},openAttachment:function(t){this.controller.options.isDownload&&this.controller.module&&this.controller.module.openAttachment(t,null,[this])},setActionEnabled:function(t){t&&(t.setStyle("display",""),t.store("disabled",!1))},setActionDisabled:function(t){t&&(t.setStyle("display","none"),t.store("disabled",!0))},createAction:function(t,e,i,s,o,n){var a;if(this.controller.options.actionShowText){a=new Element("div",{styles:this.controller.css.minActionNode,text:n||s,title:s}).inject(t);var r=this;a.addEvents({mouseover:function(t){!this.actionNode.retrieve("disabled")&&r.controller.css.minActionNode_over&&a.setStyles(r.controller.css.minActionNode_over)}.bind({actionNode:a}),mouseout:function(){!this.actionNode.retrieve("disabled")&&r.controller.css.minActionNode_over&&a.setStyles(r.controller.css.minActionNode)}.bind({actionNode:a}),click:function(t){this.retrieve("disabled")||(o.apply(r.controller,[t,this]),t.stopPropagation())}})}else{a=new Element("div",{styles:this.controller.css.minActionNode,title:s}).inject(t);var l=new Element("div",{styles:this.controller.css.minActionIconNode}).inject(a);l.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.controller.options.style+"/icon/"+e+".png)");r=this;a.addEvents({mouseover:function(t){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+r.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:a,actionIconNode:l,img:i}),mouseout:function(){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+r.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:a,actionIconNode:l,img:e}),click:function(t){this.retrieve("disabled")||(o.apply(r.controller,[t,this]),t.stopPropagation())}})}return this.actions||(this.actions=[]),this.actions.push(a),a}}),o2.widget.AttachmentController.AttachmentMin=new Class({Extends:o2.widget.AttachmentController.Attachment,initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.content=this.controller.minContent,this.isSelected=!1,this.isCheckPosition=s,this.seq=this.controller.attachments.length+1,i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||layout.mobile||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.iconImgNode,transition:"flyin"})),this.setEvent()},loadList:function(){this.node.setStyles(layout.mobile?this.css.minAttachmentNode_list_mobile:this.css.minAttachmentNode_list),layout.mobile||(this.sepNode=new Element("div",{styles:this.css.minAttachmentSepNode_list}).inject(this.node)),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",o2.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this),o2.LP.widget.configAttachmentText)),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）"),this.node.set("title",this.data.name+"（"+t+"）")},loadSequence:function(){this.node.setStyles(this.css.minAttachmentNode_sequence),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",MWF.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this))),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）")},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_over"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"]))}.bind(this),mouseout:function(){if(!this.isSelected)if("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_selected"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},reload:function(){var t=new Element("div").inject(this.node,"after");this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.loadList(),this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},unSelected:function(){if(this.isSelected=!1,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);this.controller.selectedAttachments.erase(this)}}),o2.widget.AttachmentController.AttachmentMessage=new Class({Extends:o2.widget.AttachmentController.Attachment,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}}),o2.widget.AttachmentController.AttachmentMessageMin=new Class({Extends:o2.widget.AttachmentController.AttachmentMin,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.minContent,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}}),MWF.xScript=MWF.xScript||{},MWF.xScript.CMSMacro=MWF.CMSMacro={swapSpace:{},expression:function(t,e){},runEvent:function(t,e,i){},exec:function(code,bind){var returnValue;if(bind||(bind=window),o2.session.isDebugger)try{var f=eval("(function(){return function(){\n"+code+"\n}})();");returnValue=f.apply(bind)}catch(e){if(console.log(o2.LP.script.error),code.length>500){var t=code.substr(0,500)+"\n...\n";console.log(t)}else console.log(code);console.log(e)}else try{var f=eval("(function(){return function(){\n"+code+"\n}})();");returnValue=f.apply(bind)}catch(e){if(console.log(o2.LP.script.error),code.length>500){var t=code.substr(0,500)+"\n...\n";console.log(t)}else console.log(code);console.log(e)}return returnValue}},MWF.CMSMacro.CMSFormContext=new Class({macroFunction:null,environment:{},initialize:function(t){this.form=t;var e={form:t,forms:t.forms,all:t.all,data:t.businessData.data,document:t.businessData.document,control:t.businessData.control,attachmentList:t.businessData.attachmentList,status:t.businessData.status,formInfor:t.businessData.formInfor,target:null,event:null};MWF.require("MWF.xScript.CMSEnvironment",null,!1),this.environment=new MWF.xScript.CMSEnvironment(e)},setTarget:function(t){this.environment.target=t||null},setEvent:function(t){this.environment.event=t||null},exec:function(t,e){return this.setTarget(e),MWF.CMSMacro.exec(t,this.environment)},fire:function(t,e,i){return this.setTarget(e),this.setEvent(i),MWF.CMSMacro.exec(t,this.environment)}}),MWF.CMSMacro.ViewContext||(MWF.CMSMacro.ViewContext=new Class({macroFunction:null,environment:{},initialize:function(t){this.form=t;var e={view:t,viewInfor:t.viewInfor,target:null,event:null};MWF.require("MWF.xScript.ViewEnvironment",null,!1),this.environment=new MWF.xScript.ViewEnvironment(e)},setTarget:function(t){this.environment.target=t||null},setEvent:function(t){this.environment.event=t||null},exec:function(t,e){return this.setTarget(e),MWF.CMSMacro.exec(t,this.environment)},fire:function(t,e,i){return this.setTarget(e),this.setEvent(i),MWF.CMSMacro.exec(t,this.environment)}})),JSONObject=function(t){},o2.widget=o2.widget||{},o2.widget.Tab=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default"},initialize:function(t,e){this.setOptions(e),this.pages=[],this.path=o2.session.path+"/widget/$Tab/",this.cssPath=o2.session.path+"/widget/$Tab/"+this.options.style+"/css.wcss",this._loadCss(),this.css=Object.clone(this.css),this.showPage=null,this.node=$(t)},load:function(){this.fireEvent("queryLoad")&&(this.tabNodeContainer||(this.tabNodeContainer=new Element("div")),this.tabNodeContainer.set("styles",this.css.tabNodeContainer),this.tabNodeContainer.inject(this.node),this.tabNodeContainerRight||(this.tabNodeContainerRight=new Element("div.tabNodeContainerRight")),this.tabNodeContainerRight.set("styles",this.css.tabNodeContainerRight),this.tabNodeContainerRight.inject(this.tabNodeContainer),this.tabNodeContainerLeft||(this.tabNodeContainerLeft=new Element("div.tabNodeContainerLeft")),this.tabNodeContainerLeft.set("styles",this.css.tabNodeContainerLeft),this.tabNodeContainerLeft.inject(this.tabNodeContainer),this.tabNodeContainerArea||(this.tabNodeContainerArea=new Element("div.tabNodeContainerArea")),this.tabNodeContainerArea.set("styles",this.css.tabNodeContainerArea),this.tabNodeContainerArea.inject(this.tabNodeContainerLeft),this.contentNodeContainer||(this.contentNodeContainer=new Element("div")),this.contentNodeContainer.set("name","MWFcontentNodeContainer"),this.contentNodeContainer.set("styles",this.css.contentNodeContainer),this.contentNodeContainer.inject(this.node),this.tabNodeContainerRight.addEvents({mouseover:function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight_over)}.bind(this),mouseout:function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight)}.bind(this)}),o2.require("o2.xDesktop.Menu",function(){this.tabMenu=new o2.xDesktop.Menu(this.tabNodeContainerRight,{style:"tab",event:"click",container:this.tabNodeContainerRight,where:{x:"right",y:"bottom"},onQueryShow:function(){this.loadOverMenu()}.bind(this)}),this.tabMenu.load()}.bind(this)),this.tabNodeContainerRight.hide(),this.fireEvent("postLoad"))},rebuildTab:function(t,e,i){var s=new o2.widget.TabPage(e,"",this,{isClose:!1});return s.contentNodeArea=t,s.tabNode=i,s.textNode=i.getFirst(),s.closeNode=s.textNode.getFirst(),s.options.title=s.textNode.get("text"),s.load(),this.pages.push(s),s},addTab:function(t,e,i,s){var o=new o2.widget.TabPage(t,e,this,{isClose:i,tabNode:s});return o.load(),this.pages.push(o),o},loadOverMenu:function(t){this.tabMenu.clearItems();for(var e=this,i=this.showTabIndex;i<this.pages.length;i++){var s=this.pages[i];this.tabMenu.addMenuItem(s.options.title||s.tabNode.get("text"),"click",(function(){e.showOverPage(this)})).tabPage=s}},showOverPage:function(t){var e=t.tabPage;e&&(this.pages.erase(e),this.pages.unshift(e),e.tabNode.inject(this.tabNodeContainerArea,"top"),e.showTabIm(),this.resize())},resize:function(){for(var t=this.tabNodeContainerLeft.getSize(),e=0,i=0;i<this.pages.length;i++){if((e+=this.pages[i].tabNode.getSize().x)>t.x)break}this.showTabIndex=i,e>t.x&&i<this.pages.length?this.tabNodeContainerRight.show():this.tabNodeContainerRight.hide()}}),o2.widget.TabPage=new Class({Implements:[Options,Events],options:{isClose:!0,tabNode:null,title:""},initialize:function(t,e,i,s){this.setOptions(s),this.options.title=e,this.tab=i,this.contentNode=$(t)},load:function(){this.contentNodeArea||(this.contentNodeArea=new Element("div")),this.contentNodeArea.set("styles",this.tab.css.contentNodeArea),this.tabNode||(this.tabNode=new Element("div")),this.tabNode.set("styles",this.tab.css.tabNode),this.tabNode.addEvent("mousedown",(function(t){t.stop()})),this.textNode||(this.textNode=new Element("div").inject(this.tabNode)),this.textNode.set({styles:this.tab.css.tabTextNode,text:this.options.title}),this.tabNode.addEvent("click",this._showTab.bind(this)),this.options.isClose&&(this.closeNode||(this.closeNode=new Element("div").inject(this.tabNode)),this.closeNode.set({styles:this.tab.css.tabCloseNode}),this.closeNode.addEvent("click",this.closeTab.bind(this))),this.contentNodeArea.inject(this.tab.contentNodeContainer),this.tabNode.inject(this.tab.tabNodeContainerArea),this.contentNode.inject(this.contentNodeArea),this.tab.resize()},_showTab:function(){this.showTabIm()},showTabIm:function(t){this.isShow||(this.tab.pages.each((function(t){t.isShow&&t.hideIm()})),this.showIm(t))},showTab:function(t){this.isShow||(this.tab.pages.each((function(t){t.isShow&&t.hide()})),this.show(t))},showIm:function(t){this.fireEvent("queryShow"),this.tabNode.setStyle("display",""),this.tabNode.set("styles",this.tab.css.tabNodeCurrent),this.textNode.set("styles",this.tab.css.tabTextNodeCurrent),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNodeCurrent),this.contentNodeArea.setStyle("display","block"),this.contentNodeArea.setStyle("opacity",1),this.isShow=!0,this.tab.showPage=this,t&&t(),this.fireEvent("show"),this.fireEvent("postShow")},show:function(t){this.fireEvent("queryShow"),this.tabNode.setStyle("display",""),this.tabNode.set("styles",this.tab.css.tabNodeCurrent),this.textNode.set("styles",this.tab.css.tabTextNodeCurrent),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNodeCurrent),this.contentNodeArea.setStyle("display","block"),this.contentNodeArea.setStyle("opacity",1),this.morph||(this.morph=new Fx.Morph(this.contentNodeArea,{duration:100})),this.morph.start({opacity:1}).chain(function(){this.isShow=!0,this.tab.showPage=this,t&&t(),this.fireEvent("postShow")}.bind(this)),this.fireEvent("show")},hideIm:function(){this.isShow&&(this.fireEvent("queryHide"),this.tabNode.set("styles",this.tab.css.tabNode),this.textNode.set("styles",this.tab.css.tabTextNode),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNode),this.contentNodeArea.setStyle("display","none"),this.contentNodeArea.setStyle("opacity",0),this.isShow=!1,this.fireEvent("hide"),this.fireEvent("postHide"))},hide:function(){this.isShow&&(this.fireEvent("queryHide"),this.tabNode.set("styles",this.tab.css.tabNode),this.textNode.set("styles",this.tab.css.tabTextNode),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNode),this.morph||(this.morph=new Fx.Morph(this.contentNodeArea,{duration:100})),this.morph.start({opacity:0}).chain(function(){this.contentNodeArea.setStyle("display","none"),this.isShow=!1,this.fireEvent("postHide")}.bind(this)),this.fireEvent("hide"))},enableTab:function(t){this.disabled=!1,t?this.tabNode.show():this.showTab()},disableTab:function(t){this.disabled=!0,this.hideTab(t)},hideTab:function(t){this.fireEvent("queryHide"),this.tabNode.hide(),this.contentNodeArea.hide();if(!t){var e=this.getPrevPage();if(e&&!e.disabled)e.showTab();else if(this.tab.pages.length)for(var i=0;i<this.tab.pages.length;i++){var s=this.tab.pages[i];if(!s.disabled){s.showTab();break}}}this.isShow=!1,this.fireEvent("hide")},closeTab:function(){this.fireEvent("queryClose");var t=this.getPrevPage();this.contentNodeArea.destroy(),this.tabNode.destroy();if(this.tab.pages=this.tab.pages.erase(this),t&&!t.disabled)t.showTab();else if(this.tab.pages.length)for(var e=0;e<this.tab.pages.length;e++){var i=this.tab.pages[e];if(!i.disabled){i.showTab();break}}this.fireEvent("close")},getPrevPage:function(){var t=this.tab.pages.indexOf(this)-1;return t<0?null:this.tab.pages[t]}}),o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.xDesktop.Common",null,!1),o2.require("o2.xDesktop.Actions.RestActions",null,!1),o2.widget.O2Identity=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",canRemove:!1,lazy:!1,disableInfor:!1},initialize:function(t,e,i){this.setOptions(i),this.loadedInfor=!1,this.path=o2.session.path+"/widget/$O2Identity/",this.cssPath=o2.session.path+"/widget/$O2Identity/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(e),this.data=t,this.style=this.css,this.action=new o2.xDesktop.Actions.RestActions("","x_organization_assemble_control","x_component_Org"),this.load()},setText:function(){var t;if(this.data.displayName)t=this.data.displayName;else{var e,i=this.data.name||o2.name.cn(this.data.distinguishedName);if(this.data.unitName)e=this.data.unitName;else if(this.data.unitLevelName){var s=this.data.unitLevelName.split("/");e=s[s.length-1]}t=i+(e?"("+e+")":"")}this.node.set("text",this.data.displayName||t)},load:function(){var t=layout.mobile&&this.style.identityNode_mobile?this.style.identityNode_mobile:this.style.identityNode;this.options.lazy||this.options.disableInfor||this.getPersonData(),this.node=new Element("div",{styles:t}).inject(this.container),this.setText(),this.options.canRemove&&(this.removeNode=new Element("div",{styles:this.style.identityRemoveNode}).inject(this.node),this.removeNode.addEvent("click",function(t){this.fireEvent("remove",[this,t]),t.stopPropagation()}.bind(this))),this.options.disableInfor||layout.mobile||(this.options.lazy?this.node.addEvents({mouseover:function(){this.loadedInfor||(this.getPersonData(),this.createInforNode(function(){this.fireEvent("loadedInfor",[this])}.bind(this)))}.bind(this)}):this.createInforNode(function(){this.fireEvent("loadedInfor",[this])}.bind(this))),this.setEvent(),layout.mobile||this.node.addEvents({mouseover:function(){this.node.setStyles(this.style.identityNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.style.identityNode)}.bind(this)})},setEvent:function(){this.open&&this.node.addEvents({click:function(t){this.open(t),t.stopPropagation()}.bind(this)})},getPersonData:function(){if(!this.data.dutys){var t=o2.Actions.get("x_organization_assemble_control"),e=this.data.distinguishedName||this.data.id||this.data.unique;e&&t.listUnitdutyByIdentity(e,function(t){this.data.dutys=t.data}.bind(this),null,!1)}return this.data.woPerson?this.data.woPerson:(this.action.actions={getPerson:{uri:"/jaxrs/person/{flag}"},getIdentity:{uri:"/jaxrs/identity/{id}"}},this.data.person?this.action.invoke({name:"getPerson",async:!1,parameter:{flag:this.data.person},success:function(t){this.data.woPerson=i,i=t.data}.bind(this)}):this.action.invoke({name:"getIdentity",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data,i=t.data.woPerson}.bind(this)}),i);var i},createInforNode:function(t){var e=this.getPersonData();if(e){this.inforNode=new Element("div",{styles:this.style.identityInforNode});var i=new Element("div",{styles:this.style.identityInforNameNode}).inject(this.inforNode),s="/jaxrs/person/{flag}/icon";s=s.replace("{flag}",e.id||e.unique||e.distinguishedName),this.action.getAddress(),s=this.action.address+s,s=o2.filterUrl(s),img="<img width='50' height='50' border='0' src='"+s+"' style='border-radius:25px'/>";new Element("div",{styles:this.style.identityInforPicNode,html:img}).inject(i);var o=new Element("div",{styles:this.style.identityInforRightTextNode}).inject(i),n=(new Element("div",{styles:this.style.identityInforNameTextNode,text:e.name}).inject(o),new Element("div",{styles:this.style.identityInforEmployeeTextNode,text:e.employee||""}).inject(o),[]);this.data.dutys&&this.data.dutys.length&&this.data.dutys.each((function(t){var e=t.name+"("+t.woUnit.levelName+")";n.push(e)}));new Element("div",{styles:this.style.identityInforPhoneNode,html:"<div style='width:30px; float:left'>"+o2.LP.desktop.person.duty+": </div><div style='width:160px; float:left; margin-left:10px'>"+n.join(",")+"</div>"}).inject(this.inforNode);this.loadedInfor=!0,this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}t&&t()},destroy:function(){this.tooltip&&this.tooltip.destroy(),this.node.destroy(),o2.release(this)}}),o2.widget.O2Person=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){return this.data.distinguishedName||(this.action.actions={getPerson:{uri:"/jaxrs/person/{id}"}},this.action.invoke({name:"getPerson",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data;var e=[];this.data.woIdentityList&&this.data.woIdentityList.length&&this.data.woIdentityList.each((function(t){t.woUnitDutyList&&t.woUnitDutyList.length&&(e=e.concat(t.woUnitDutyList))})),this.data.dutys=e}.bind(this)})),this.data},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Unit=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){this.data.distinguishedName&&this.data.levelName||(this.action.actions={getUnit:{uri:"/jaxrs/unit/{id}"}},this.action.invoke({name:"getUnit",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.levelName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Duty=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){return this.data},createInforNode:function(){return!1},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Group=new Class({Extends:o2.widget.O2Unit,getPersonData:function(){this.data.distinguishedName||(this.action.actions={getGroup:{uri:"/jaxrs/group/{id}"}},this.action.invoke({name:"getGroup",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},setText:function(){this.node.set("text",this.data.displayName||this.data.name)},createInforNode:function(){return!1}}),o2.widget.O2Application=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||(this.action=new o2.xDesktop.Actions.RestActions("","x_processplatform_assemble_surface",""),this.action.actions={getApplication:{uri:"/jaxrs/application/{id}"}},this.action.invoke({name:"getApplication",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))}}),o2.widget.O2CMSApplication=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||o2.Actions.get("x_cms_assemble_control").getApplication(this.data.id||this.data.name,function(t){this.data=t.data}.bind(this),null,!1)}}),o2.widget.O2Process=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||(this.action=new o2.xDesktop.Actions.RestActions("","x_processplatform_assemble_surface",""),this.action.actions={getProces:{uri:"/jaxrs/process/{id}/complex"}},this.action.invoke({name:"getProces",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.name||this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.application){var e="process.ProcessManager"+this.data.application;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={application:{id:this.data.application,name:this.data.applicationName||""}};layout.desktop.openApplication(t,"process.ProcessManager",i)}}}}),o2.widget.O2CMSCategory=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||o2.Actions.get("x_cms_assemble_control").getCategory(this.data.id||this.data.name,function(t){this.data=t.data}.bind(this),null,!1)},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId){var e={navi:"categoryConfig",column:{id:this.data.appId,appName:this.data.appName||""},currentCategoryId:this.data.id};layout.desktop.openApplication(t,"cms.ColumnManager",e)}}}),o2.widget.O2View=new Class({Extends:o2.widget.O2Group,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName||this.data.name}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}}),o2.widget.O2CMSView=new Class({Extends:o2.widget.O2View}),o2.widget.O2QueryView=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getViewById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.ViewDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.ViewDesigner",i)}}}}),o2.widget.O2QueryStatement=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.load("x_query_assemble_designer").StatementAction.get(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.StatementDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.StatementDesigner",i)}}}}),o2.widget.O2QueryStat=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.StatDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.StatDesigner",i)}}}}),o2.widget.O2QueryTable=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getTableById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.TableDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.TableDesigner",i)}}}}),o2.widget.O2QueryImportModel=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getImportModelById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.ImporterDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.ImporterDesigner",i)}}}}),o2.widget.O2FormField=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data}}),o2.widget.O2Role=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.distinguishedName||(this.action.actions={getRole:{uri:"/jaxrs/role/{id}"}},this.action.invoke({name:"getRole",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))}}),o2.widget.O2File=new Class({Extends:o2.widget.O2Group,createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});var t=this.data.fileName.substring(this.data.fileName.lastIndexOf(".")+1,this.data.fileName.length).toLowerCase();if(-1!==["png","jpg","bmp","gif","jpeg","jpe"].indexOf(t)){var e=this.data.portal?MWF.xDesktop.getPortalFileUr(this.data.id,this.data.portal):MWF.xDesktop.getProcessFileUr(this.data.id,this.data.application);new Element("img",{src:e,styles:{"max-width":"280px","max-height":"140px"}}).inject(this.inforNode)}else new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName||this.data.name}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},getPersonData:function(){return this.data}}),o2.widget.O2Script=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},createInforNode:function(){if(!this.data.appType)return!1;this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{text:o2.LP[this.data.appType+"Name"]}).inject(this.inforNode),new Element("div",{text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId&&this.data.appType){var e;"cms"===this.data.appType?e="cms.ScriptDesigner":"portal"===this.data.appType?e="portal.ScriptDesigner":"process"===this.data.appType&&(e="process.ScriptDesigner");var i=e+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2FormStyle=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},open:function(t){if("object"===typeOf(this.data)&&this.data.id&&this.data.appId&&"script"===this.data.type){var e,i=(e="cms"===this.data.appType?"cms.ScriptDesigner":"process.ScriptDesigner")+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2Dictionary=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},createInforNode:function(){if(!this.data.appType)return!1;this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{text:o2.LP[this.data.appType+"Name"]}).inject(this.inforNode),new Element("div",{text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId&&this.data.appType){var e;"cms"===this.data.appType?e="cms.DictionaryDesigner":"process"===this.data.appType&&(e="process.DictionaryDesigner");var i=e+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2Other=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data}}),o2.widget.O2Org=function(t,e,i){var s="string"===o2.typeOf(t)?{name:t}:t.distinguishedName,o=s.distinguishedName||s.name||"";if(o)switch(o.substr(o.length-1,1).toLowerCase()){case"i":return new o2.widget.O2Identity(s,e,i);case"p":return new o2.widget.O2Person(s,e,i);case"u":return new o2.widget.O2Unit(s,e,i);case"g":return new o2.widget.O2Group(s,e,i);case"r":return new o2.widget.O2Role(s,e,i);case"d":return new o2.widget.O2Duty(s,e,i);default:return new o2.widget.O2Other(s,e,i)}return null},MWF.require(["MWF.widget.Common","MWF.widget.O2Identity"],null,!1),MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{},MWF.xDesktop.requireApp("process.Xform","lp."+MWF.language,null,!1),MWF.xApplication.process.Xform.Form=MWF.APPForm=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",readonly:!1,cssPath:"",macro:"FormContext",parameters:null,moduleEvents:["queryLoad","beforeLoad","beforeModulesLoad","postLoad","afterModulesLoad","afterLoad","beforeSave","afterSave","beforeClose","beforeProcessWork","beforeProcess","afterProcess","beforeReset","afterReset","beforeRetract","afterRetract","beforeReroute","afterReroute","beforeDelete","afterDelete","resize","beforeReaded","afterReaded"]},initialize:function(t,e,i){this.setOptions(i),this.container=$(t),this.container.setStyle("-webkit-user-select","text"),Browser.firefox&&this.container.setStyle("opacity",0),this.data=e,this.json=e.json,this.html=e.html,this.path="../x_component_process_Xform/$Form/",this.cssPath=this.options.cssPath||"../x_component_process_Xform/$Form/"+this.options.style+"/css.wcss",this._loadCss(),this.sectionListObj={},this.modules=[],this.all={},this.allForName={},this.forms={}},parseCSS:function(t){for(var e,i=/(url\(.*\))/g;null!==(e=i.exec(t));){var s=e[0],o=s.length,n=s.substring(s.length-2,s.length-1),a="'"===n||'"'===n?5:4,r="'"===n||'"'===n?2:1;if(-1!=(s=s.substring(a,s.length-r)).indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var l=MWF.Actions.getHost("x_portal_assemble_surface");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",l+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",l+"/x_portal_assemble_surface")),s=o2.filterUrl(s)}var d=(s="url('"+s+"')").length;t=t.substring(0,e.index)+s+t.substring(i.lastIndex,t.length),i.lastIndex=i.lastIndex+(d-o)}return t},loadCss:function(){if(cssText=this.json.css?this.json.css.code:"",(r=$("style"+this.json.id))&&r.destroy(),cssText){cssText=this.parseCSS(cssText);for(var t,e=new RegExp("(.+)(?=\\{)","g"),i=this.json.id.replace(/\-/g,""),s=".css"+i+" ";null!==(t=e.exec(cssText));){var o=t[0];if(-1!=o.indexOf(",")){var n=o.split(/\s*,\s*/g),a=(n=n.map((function(t){return s+t}))).join(", ");cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+s.length*n.length}else{a=s+t[0];cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+s.length}}var r;if((r=document.createElement("style")).setAttribute("type","text/css"),r.id="style"+this.json.id,r.inject(this.container,"before"),r.styleSheet){var l=function(){r.styleSheet.cssText=cssText};r.styleSheet.disabled?setTimeout(l,10):l()}else{var d=document.createTextNode(cssText);r.appendChild(d)}return"css"+i}return""},keyLock:function(t){var e=this.businessData.work.id+"-"+this.businessData.work.activityToken;return o2.Actions.load("x_processplatform_assemble_surface").KeyLockAction.lock({key:e},function(e){flagData=e.data,t&&flagData.success&&(this.keyLockTimeoutId=window.setTimeout(function(){this.keyLock(!0)}.bind(this),9e4)),t&&!flagData.success&&this.app.reload()}.bind(this),null,!!t),flagData},checkLock:function(){if(this.businessData.control.allowProcessing&&"grab"==this.businessData.activity.manualMode){this.app.addEvent("queryClose",function(){this.keyLockTimeoutId&&window.clearTimeout(this.keyLockTimeoutId)}.bind(this));var t=this.keyLock();t.success?this.keyLock(!0):(this.businessData.control.allowProcessing=!1,this.businessData.control.allowSave=!1,this.businessData.control.allowReset=!1,this.businessData.control.allowReroute=!1,this.businessData.control.allowDelete=!1,this.businessData.control.allowAddSplit=!1,this.businessData.control.allowRetract=!1,this.businessData.control.allowRollback=!1,this.lockDataPerson=t.person)}},load:function(t){this.loadMacro(function(){this.loadLanguage(function(e){if(e&&this.formDataText){var i=o2.bindJson(this.formDataText,{lp:MWF.xApplication.process.Xform.LP.form});this.data=JSON.parse(i),this.json=this.data.json,this.html=this.data.html}this.checkLock(),this.loadExtendStyle(function(){this.app&&(this.app.formNode&&this.app.formNode.setStyles(this.json.styles),this.app.addEvent&&(this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this)),this.app.addEvent("queryClose",function(){this.beforeCloseWork()}.bind(this)))),this.businessData.control.allowSave||this.setOptions({readonly:!0});var e="";this.json.css&&this.json.css.code&&(e=this.loadCss()),this.container.set("html",this.html),this.node=this.container.getFirst(),e&&this.node.addClass(e),this._loadEvents(),this.loadRelatedScript(),this.fireEvent("queryLoad"),this.event_resolve?this.event_resolve(function(){this.loadForm(t)}.bind(this)):this.loadForm(t)}.bind(this))}.bind(this))}.bind(this))},loadLanguage:function(t){if("script"!==this.json.languageType&&"default"!==this.json.languageType)return t&&t(),!0;MWF.xApplication.process.Xform.LP.form;var e=null;if("script"==this.json.languageType)this.json.languageScript&&this.json.languageScript.code&&(e=this.Macro.exec(this.json.languageScript.code,this));else if("default"==this.json.languageType){var i="lp-"+o2.language;if("PageContext"===this.options.macro){var s=this.app.portal.id;e=this.workAction.getScriptByNameV2(s,i,function(t){return this.Macro.exec(t.data.text,this)}.bind(this),(function(){}))}else{var o=(this.businessData.work||this.businessData.workCompleted).application,n=this.workAction.getDictRoot(i,o,(function(t){return t.data}),(function(){})),a=new Promise(function(t,e){this.workAction.getScriptByNameV2(i,o,function(i){i.data.text?t(this.Macro.exec(i.data.text,this)):e("")}.bind(this),(function(){e("")}))}.bind(this));e=Promise.any([n,a])}}e?e.then&&"function"==o2.typeOf(e.then)?e.then((function(e){MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)}),(function(){t&&t(!0)})):(MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)):t&&t(!0)},loadRelatedScript:function(){if(this.json.includeScripts&&this.json.includeScripts.length){var t="",e=[];this.json.includeScripts.each(function(i){this.app.relatedScriptMap&&this.app.relatedScriptMap[i.id]&&(t+="\n"+this.app.relatedScriptMap[i.id].text,e.push(i.id))}.bind(this)),t&&this.Macro.exec(t,this)}},loadForm:function(t){if(this.lockDataPerson){var e=MWF.xApplication.process.Xform.LP.keyLockInfor;e=e.replace("{name}",o2.name.cn(this.lockDataPerson));var i=MWF.xApplication.process.Xform.LP.keyLockTitle;this.app.alert("info","center",i,e,400,160)}this.app&&this.app.fireEvent&&this.app.fireEvent("queryLoad"),this._loadBusinessData(),this.fireEvent("beforeLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeLoad"),this.loadContent(t)},loadExtendStyle:function(t){if(this.json.styleConfig&&this.json.styleConfig.extendFile)if("5.2"!=this.json.$version){var e="../x_component_process_FormDesigner/Module/Form/skin/"+this.json.styleConfig.extendFile;MWF.getJSON(e,{onSuccess:function(e){e&&e.form&&(this.json=Object.merge(this.json,e.form)),t&&t()}.bind(this),onRequestFailure:function(){t&&t()}.bind(this),onError:function(){t&&t()}.bind(this)})}else t&&t();else t&&t()},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro[this.options.macro||"FormContext"](this),t&&t()}.bind(this))},loadContent:function(t){if(this.subformCount=0,this.subformLoadedCount=0,this.subformLoaded=[this.json.id],this.subpageCount=0,this.subpageLoadedCount=0,this.subpageLoaded=[],this.widgetCount=0,this.widgetLoadedCount=0,this.widgetLoaded=[],this._loadHtml(),this._loadForm(),this.fireEvent("beforeModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeModulesLoad"),this._loadModules(this.node),Browser.firefox&&this.container.setStyle("opacity",1),"Mobile"===this.json.mode){var e=document.body.getElement(".o2_form_mobile_actions");e?(e.empty(),this._loadMobileActions(e,t)):t&&t()}else t&&t();this.fireEvent("postLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("postLoad"),this.checkSubformLoaded(!0)},checkSubformLoaded:function(t){t&&(this.isAllSubformLoaded=!0),this.isAllSubformLoaded&&(this.subformCount&&this.subformCount!==this.subformLoadedCount||this.subpageCount&&this.subpageCount!==this.subpageLoadedCount||this.widgetCount&&this.widgetCount!==this.widgetLoadedCount||(this.fireEvent("afterModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterModulesLoad"),this.fireEvent("afterLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterLoad"),this.isLoaded=!0))},_loadMobileDefaultTools:function(t){this.json.defaultTools?t&&t():this.json.defaultTools=o2.JSON.get("../x_component_process_FormDesigner/Module/Form/toolbars.json",function(e){this.json.defaultTools=e,t&&t()}.bind(this))},_loadMobileActions:function(t,e){var i=[];this._loadMobileDefaultTools(function(){if(this.json.defaultTools){var s=JSON.stringify(this.json.defaultTools);s=o2.bindJson(s,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.defaultTools=JSON.parse(s),this.json.defaultTools.each(function(t){this._checkDefaultMobileActionItem(t,this.options.readonly)&&i.push(t)}.bind(this))}if(this.json.tools){s=JSON.stringify(this.json.tools);s=o2.bindJson(s,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.tools=JSON.parse(s),this.json.tools.each(function(t){this._checkCustomMobileActionItem(t,this.options.readonly)&&i.push(t)}.bind(this))}this.mobileTools=i,window.o2android||window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.o2mLog?i.length&&t&&this._createMobileActions(t,i):i.length&&t&&this._createMobileActionsDingdingStyle(t,i),e&&e()}.bind(this))},_createMobileActionsDingdingStyle:function(t,e){t.show();var i=e.length;if(i<=2){var s=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-s.x*(i+1)-2*i)/i;e.each(function(e){var i=this.css.html5ActionButtonDingdingNormal;"继续流转"===e.text||"撤回"===e.text||"action_processWork"===e.id||"action_retract"===e.id?i=this.css.html5ActionButtonDingdingPrimary:"删除文件"!==e.text&&"action_delete"!==e.id||(i=this.css.html5ActionButtonDingdingDanger),i.width=o+"px";var s=new Element("div",{styles:i,text:e.text}).inject(t);s.store("tool",e),s.addEvent("click",function(t){var i=function(){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this);"继续流转"===e.text||"action_processWork"===e.id?window.setTimeout(i,100):i()}.bind(this)),new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}.bind(this))}else{s=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-4*s.x-6)/5;for(var n=0;n<3;n++){tool=e[n];var a,r=this.css.html5ActionButtonDingdingNormal;if("继续流转"===tool.text||"撤回"===tool.text?r=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(r=this.css.html5ActionButtonDingdingDanger),2==n)this.css.html5ActionButtonDingdingMore.width=o+"px",(a=new Element("div",{styles:this.css.html5ActionButtonDingdingMore,text:"…"}).inject(t)).addEvent("click",function(i){this._loadMoreMobileActionsDingdingStyle(e,2,t)}.bind(this));else r.width=2*o+"px",(a=new Element("div",{styles:r,text:tool.text}).inject(t)).store("tool",tool),a.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this));new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}}},_loadMoreMobileActionsDingdingStyle:function(t,e,i){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var s=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=s.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var l=this.css.html5ActionButtonDingdingNormal;"继续流转"===tool.text||"撤回"===tool.text?l=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(l=this.css.html5ActionButtonDingdingDanger),l.width="100%";var d=new Element("div",{styles:l,text:tool.text}).inject(this.actionMoreArea);d.store("tool",tool),d.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this))}}},_createMobileActions:function(t,e){t.show();var i=e.length;if(i<=2)this.css.html5ActionButton.width="100%",2==i&&(this.css.html5ActionButton.width="49%"),e.each(function(e){var i=new Element("div",{styles:this.css.html5ActionButton,text:e.text}).inject(t);i.store("tool",e),i.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(i)}.bind(this)),2==i&&new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before");else{this.css.html5ActionButton.width="38%";for(var s=0;s<2;s++){tool=e[s],(o=new Element("div",{styles:this.css.html5ActionButton,text:tool.text}).inject(t)).store("tool",tool),o.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(o)}var o;new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before"),new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t),this.css.html5ActionButton.width="23%",(o=new Element("div",{styles:this.css.html5ActionButton,text:"…"}).inject(t)).addEvent("click",function(i){this._loadMoreMobileActions(e,2,t)}.bind(this)),this._setMobileBottonStyle(o)}},_loadMoreMobileActions:function(t,e,i){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var s=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=s.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var l=new Element("div",{styles:this.css.html5ActionOtherButton,text:tool.text}).inject(this.actionMoreArea);l.store("tool",tool),l.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(l)}}},_setMobileBottonStyle:function(t){var e=this;t.addEvents({mouseover:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseout:function(t){this.setStyles(e.css.html5ActionButton_up)},mousedown:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseup:function(t){this.setStyles(e.css.html5ActionButton_up)},touchstart:function(t){this.setStyles(e.css.html5ActionButton_over)},touchcancel:function(t){this.setStyles(e.css.html5ActionButton_up)},touchend:function(t){this.setStyles(e.css.html5ActionButton_up)},touchmove:function(t){this.setStyles(e.css.html5ActionButton_over)}})},_runCustomAction:function(t){this.Macro.exec(t,this)},_checkCustomMobileActionItem:function(t,e){var i=!0;(i=e?t.readShow:t.editShow)&&(i=!0,t.control&&(i=this.form.businessData.control[t.control]),t.condition&&(i=!this.Macro.exec(t.condition,this)));return i},_checkDefaultMobileActionItem:function(t,e,i){var s=!0;if(t.control&&(s=this.businessData.control[t.control]),!i&&t.condition){var o=this.Macro.exec(t.condition,this);s=s&&!o}return"action_processWork"==t.id&&!this.businessData.task&&this.businessData.work.startTime&&(s=!1),"action_rollback"==t.id&&(t.read=!0),e&&(t.read||(s=!1)),s},_loadBusinessData:function(){this.businessData||(this.businessData={})},_loadHtml:function(){this.node.addEvent("selectstart",(function(t){var e="text";t.target.getStyle("-webkit-user-select")&&(e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()),"text"!==e&&"auto"!==e&&t.preventDefault()}))},_loadForm:function(){this._loadStyles(),this._loadCssLinks(),this._loadScriptSrc(),this._loadJsheader()},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(t,e){if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface"))}t=o2.filterUrl(t),this.node.setStyle(e,t)}.bind(this))},_loadCssLinks:function(){this.json.cssLinks.each((function(t){new Element("link",{rel:"stylesheet",type:"text/css",href:t}).inject($(document.head))}))},_loadScriptSrc:function(){this.json.scriptSrc.each((function(t){new Element("script",{src:t}).inject($(document.head))}))},_loadJsheader:function(){var t=this.json.jsheader?this.json.jsheader.code:"";t&&Browser.exec(t)},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)):"load"===e?this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this)):"submit"===e?this.addEvent("beforeProcess",function(){return this.Macro.fire(t.code,this)}.bind(this)):this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):"load"===t?this.addEvent("postLoad",function(t){return e?e(this,t):null}.bind(this)):"submit"===t?this.addEvent("beforeProcess",function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_getDomjson:function(t){switch(t.get("MWFtype")||t.get("mwftype")){case"form":return this.json;case"":return null;default:var e=t.get("id");return e||(e=t.get("MWFId")),e?this.json.moduleList[e]:null}},_getModuleNodes:function(t,e){for(var i=[],s=t.getFirst();s;){var o=s.get("MWFtype")||s.get("mwftype");if(o)-1!==o.indexOf("$")&&!0!==e||i.push(s),"datagrid"!==o&&"datatable"!==o&&"subSource"!==o&&"tab$Content"!==o&&"datatemplate"!==o&&(i=i.concat(this._getModuleNodes(s,e)));else i=i.concat(this._getModuleNodes(s,e));s=s.getNext()}return i},_loadModules:function(t){this._getModuleNodes(t).each(function(t){var e=this._getDomjson(t),i=this._loadModule(e,t);this.modules.push(i)}.bind(this))},_loadModule:function(t,e,i){"Subform"!==t.type&&"subform"!==t.moduleName||this.subformCount++,"Subpage"!==t.type&&"subpage"!==t.moduleName||this.subpageCount++,"Widget"!==t.type&&"widget"!==t.moduleName||this.widgetCount++,MWF["APP"+t.type]||MWF.xDesktop.requireApp("process.Xform",t.type,null,!1);var s=new MWF["APP"+t.type](e,t,this);if(i&&i.apply(s),this.all[t.id]||(this.all[t.id]=s),t.name)if(this.allForName[t.name]){var o=this.allForName[t.name];"array"===typeOf(o)?o.push(s):this.allForName[t.name]=[o,s]}else this.allForName[t.name]=s;return s.field&&(this.forms[t.id]||(this.forms[t.id]=s)),s.readonly=this.options.readonly,s.load(),s},saveOpinion:function(t){var e=t._getBusinessSectionDataByPerson();MWF.UD.getDataJson("userOpinion",function(t){t||(t=[]);var i=t.indexOf(e);-1==i?t.length>=50&&t.shift():t.splice(i,1),t.push(e),MWF.UD.putData("userOpinion",t)}.bind(this),!1)},loadPathData:function(t){var e=null;return this.workAction.getJobDataByPath(this.businessData.work.job,t,(function(t){e=t.data||null}),null,!1),e},getData:function(t){var e=this.businessData.data;return Object.each(this.forms,function(i,s){if(!(s.indexOf("..")>0))if("Opinion"===i.json.type)if(t){this.saveOpinion(i);var o=layout.desktop.session.user.id;"object"===typeOf(e[s])&&"string"===typeOf(e[s][o])?e[s][o]="":"string"===typeOf(e[s])&&(e[s]="")}else{var n=i.getData();e[s]=this.getSectionDataByPerson(n,e[s])}else if("yes"===i.json.section){n=this.getSectionData(i,e[s]);e[s]=n}else{n=i.getData();e[s]=n}}.bind(this)),this.businessData.data=e,this.Macro.environment.setData(this.businessData.data),e},getSectionData:function(t,e){var i=t.getData();switch(t.json.sectionBy){case"person":return this.getSectionDataByPerson(i,e);case"unit":return this.getSectionDataByUnit(i,e);case"activity":return this.getSectionDataByPActivity(i,e);case"splitValue":return this.getSectionDataBySplitValue(i,e);case"script":return this.getSectionDataByScript(t.json.sectionByScript.code,i,e);default:return i}},getSectionDataByPerson:function(t,e){var i=layout.desktop.session.user.id;return e&&"object"===typeOf(e)||(e={}),e[i]=t,e},getSectionDataByUnit:function(t,e){var i=this.businessData.task?this.businessData.task.unit:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataBySplitValue:function(t,e){var i=this.businessData.work?this.businessData.work.splitValue:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataByScript:function(t,e,i){var s=this.Macro.exec(t,this);return i&&"object"===typeOf(i)||(i={}),s&&(i[s]=e),i},setSection:function(t,e){var i=e[t.name];switch(t.sectionBy){case"person":return this.setSectionByPerson(i,t.name);case"unit":return this.setSectionByUnit(i,t.name);case"activity":return this.setSectionByPActivity(i,t.name);case"splitValue":return this.setSectionBySplitValue(i,t.name);case"script":return this.setSectionByScript(t.sectionByScript.code,i,t.name);default:return v}},setSectionByPerson:function(t,e){var i=layout.desktop.session.user.id;return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i,t},setSectionByUnit:function(t,e){var i=this.businessData.task?this.businessData.task.unit:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionBySplitValue:function(t,e){var i=this.businessData.work?this.businessData.work.splitValue:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionByScript:function(t,e,i){var s=this.Macro.exec(t,this);return e&&"object"===typeOf(e)||(e={}),this.sectionListObj[i]=s||"",e},saveWork:function(t,e){this.businessData.control.allowSave?(this.fireEvent("beforeSave"),this.fireEvent("beforeSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(i){this.app&&!e&&this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved,"success"),t&&"function"===typeOf(t)&&t(),this.fireEvent("afterSave"),this.fireEvent("afterSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave")}.bind(this))):MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied")},getSectionList:function(){return Object.keys(this.sectionListObj).map(function(t){var e={path:t};return this.sectionListObj[t]&&(e.key=this.sectionListObj[t]),e}.bind(this))},setModifedDataByPathList:function(t,e){for(var i=this.modifedData,s=0;s<e.length;s++)s===e.length-1?i[e[s]]=t:i="object"===typeOf(i[e[s]])||"array"===typeOf(i[e[s]])?i[e[s]]:"number"===typeOf(e[s])?i[e[s]]=[]:i[e[s]]={}},getOrigianlPathData:function(t){for(var e=this.businessData.originalData,i=0;i<t.length;i++)if(i===t.length-1)e=e[t[i]];else{if("object"!==typeOf(e[t[i]])&&"array"!==typeOf(e[t[i]]))return null;e=e[t[i]]}return e},setModifedData:function(t,e){if(e=e||[],"object"===typeOf(t))for(var i in t){var s=Array.clone(e);s.push(i),this.setModifedData(t[i],s)}else if("array"===typeOf(t)){var o=this.getOrigianlPathData(e);"array"===typeOf(o)&&o.length===t.length&&this.compareObjects(o,t)||this.setModifedDataByPathList(t,e)}else if("null"!==typeOf(t)){o=this.getOrigianlPathData(e);typeOf(t)===typeOf(o)&&t===o||this.setModifedDataByPathList(t,e)}},compareObjects:function(t,e,i){if(i||(i=0),i>15)return!1;var s=typeOf(t);if(s!==typeOf(e))return!1;if("object"===s){for(var o in t)null!==t[o]&&void 0!==t[o]||delete t[o];for(var o in e)null!==e[o]&&void 0!==e[o]||delete e[o]}switch(s){case"object":case"array":var n,a=Object.keys(t),r=Object.keys(e);if(a.length!==r.length)return!1;for(a.sort(),r.sort(),n=0;n<a.length;n++){var l=a[n];"array"===s&&(l=l.toInt());var d=t[l],c=e[l];if(!1===this.compareObjects(d,c,i++))return!1}break;case"function":break;default:if(t!==e)return!1}return!0},saveFormData:function(t,e,i,s,o,n){this.businessData.work.startTime?this.saveFormDataInstance(t,e,i,s,o):this.saveFormDataDraft(t,e,i,s,o,n)},saveFormDataInstance:function(t,e,i,s,o){this.officeList&&this.officeList.each((function(t){t.save(i)}));s=s||this.getData(o);if(this.modifedData={},this.setModifedData(s),this.toWordSaveList&&this.toWordSaveList.length){var n=[];this.toWordSaveList.each((function(t){t.docToWord&&n.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(n).then(function(){this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)}.bind(this))}else this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)},saveFormDataDraft:function(t,e,i,s,o,n){this.officeList&&this.officeList.each((function(t){t.save(i)}));var a={data:s=s||this.getData(o),work:this.businessData.work,identity:this.businessData.work.creatorIdentityDn};this.workAction.saveDraft(a,function(e){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),this.workAction.getDraft(e.data.id,function(e){this.businessData.work=e.data.work,this.app.options.draftId=e.data.work.id,layout.app&&layout.app.inBrowser?(layout.app&&(layout.app.$openWithSelf=!0),t&&t(),n||layout.desktop.openApplication(null,"process.Work",{draftId:this.app.options.draftId})):(this.app.options.desktopReload=!0,this.app.appId="process.Work"+e.data.work.id,layout.desktop.apps?delete layout.desktop.apps[this.app.options.appId]:layout.desktop.apps={},layout.desktop.apps[this.app.appId]=this.app,t&&t(),n||this.app.reload())}.bind(this))}.bind(this),e)},setProcessorSectionOrgList:function(t){this.routeDataList||this.getRouteDataList();for(var e=this.routeDataList,i=0;i<e.length;i++)(e[i].selectConfigList||[]).each(function(e,i){"yes"==e.section&&this.setSection(e,t)}.bind(this))},getRouteDataList:function(){return this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.businessData.task.routeList},function(t){t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1),this.routeDataList},beforeCloseWork:function(){if(this.fireEvent("beforeClose"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeClose"),this.options.readonly)this.app.refreshTaskCenter();else if(this.businessData.work&&this.businessData.work.id&&!this.isSendBeacon){if(this.app.inBrowser&&navigator.sendBeacon){var t=this.workAction.action.actions.checkDraft,e=this.workAction.action.address+t.uri;e=e.replace("{id}",this.businessData.work.id),navigator.sendBeacon(e)}else this.workAction.checkDraft(this.businessData.work.id,function(){layout.desktop.apps&&layout.desktop.apps.TaskCenter&&layout.desktop.apps.TaskCenter.window&&(layout.desktop.apps.TaskCenter.content.unmask(),layout.desktop.apps.TaskCenter.refreshAll())}.bind(this),null,!1);this.isSendBeacon=!0}},closeWork:function(){this.app.close()},getMessageContent:function(t,e,i){var s="";if(t.completed)s+=MWF.xApplication.process.Xform.LP.workCompleted;else if(t.occurSignalStack)if(t.signalStack&&t.signalStack.length){var o=[];t.signalStack.each(function(t){var e=[];t.splitExecute&&(e=t.splitExecute.splitValueList||[]),t.manualExecute&&(e=t.manualExecute.identities||[]);var i=0,s=[];e.each((function(t){var e=o2.name.cn(t);s.contains(e)||s.push(e)})),s.length>8&&(i=s.length,s=s.slice(0,8)),s=o2.name.cns(s);var n=MWF.xApplication.process.Xform.LP,a="<b>"+n.nextActivity+"</b><span style='color: #ea621f'>"+t.name+"</span>；<b>"+n.nextUser+"</b><span style='color: #ea621f'>"+s.join(",")+"</span> <b>"+(i?","+n.next_etc.replace("{count}",i):"")+"</b>";o.push(a)}.bind(this)),s+=o.join("<br>")}else s+=MWF.xApplication.process.Xform.LP.taskCompleted;else if(t.properties.nextManualList&&t.properties.nextManualList.length){o=[];t.properties.nextManualList.each((function(t){var e=[];t.taskIdentityList.each((function(t){var i=o2.name.cn(t);e.contains(i)||e.push(i)}));var i="<b>"+MWF.xApplication.process.Xform.LP.nextActivity+"</b><span style='color: #ea621f'>"+t.activityName+"</span>；<b>"+MWF.xApplication.process.Xform.LP.nextUser+"</b><span style='color: #ea621f'>"+e.join(",")+"</span>";o.push(i)})),s+=o.join("<br>")}else t.arrivedActivityName?s+=MWF.xApplication.process.Xform.LP.arrivedActivity+t.arrivedActivityName:s+=MWF.xApplication.process.Xform.LP.taskCompleted;var n=this.businessData.data.title||this.businessData.data.subject||this.businessData.work.title;return e&&n.length>e&&(n=n.substr(0,e)+"..."),"<div>"+(i||MWF.xApplication.process.Xform.LP.taskProcessedMessage)+"“"+n+"”</div>"+s},addMessage:function(t,e){if(layout.desktop.message){var i={subject:MWF.xApplication.process.Xform.LP.taskProcessed,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage)};return layout.desktop.message.addTooltip(i),layout.desktop.message.addMessage(i)}this.app.inBrowser&&!e&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage))},formValidation:function(t,e,i){if(this.options.readonly)return!0;this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=i;var s=!0;return Object.each(this.forms,function(o,n){o.validationMode(),o.validation(t,e,i)||(s=!1)}.bind(this)),s},validation:function(t,e,i,s){this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=s;var o=this.validationRoute(i),n=this.validationOpinion(i);return o&&n},validationRoute:function(t){if(!this.json.validationRoute)return!0;if(!this.json.validationRoute.code)return!0;var e=this.Macro.exec(this.json.validationRoute.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationRouteMode(e,t),!1)},validationOpinion:function(t){if(!this.json.validationOpinion)return!0;if(!this.json.validationOpinion.code)return!0;var e=this.Macro.exec(this.json.validationOpinion.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationOpinionMode(e,t),!1)},formCustomValidation:function(){if(!this.json.validationFormCustom)return!0;if(!this.json.validationFormCustom.code)return!0;var t=this.Macro.exec(this.json.validationFormCustom.code,this);return t||(t=MWF.xApplication.process.Xform.LP.notValidation),"true"==t.toString()||(this.notValidationOpinionMode(t),!1)},notValidationRouteMode:function(t,e){e&&e.routeSelectorArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},t,e?e.routeSelectorArea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},notValidationOpinionMode:function(t,e){e&&e.inputTextarea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",e?{x:"center",y:"top"}:{x:"right",y:"top"},t,e?e.inputTextarea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},getIgnoreImpowerIdentity:function(t){for(var e=[],i=function(t,i){var s=i?t.getValue():t.getData(),o=!1;"array"===typeOf(s)&&s.length&&s.each((function(t){t.ignoreEmpower&&(e.push(t.distinguishedName||t.unique||t.id),t.ignoredEmpower=!0,delete t.ignoreEmpower,o=!0)})),o&&t.setData(s)},s=this.modules,o=0;o<s.length;o++){var n=s[o],a=n.json.moduleName;a||(a="string"===typeOf(n.json.type)?n.json.type.toLowerCase():""),"org"===a&&i(n)}if(t&&t.length>0)for(o=0;o<t.length;o++)i(t[o],!0);return e},submitWork:function(t,e,i,s,o,n,a,r,l){if(!this.businessData.control.allowProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),this.app.content.unmask(),o&&o.node&&o.node.unmask(),!1;if(!this.formValidation(t,e,i))return this.app.content.unmask(),s&&s(),!1;if(!this.validation(t,e,o,i))return o&&o.node&&o.node.unmask(),!1;if(!e){var d=this.businessData.task.routeNameList.indexOf(t);this.businessData.task.routeOpinionList[d]&&(e=this.businessData.task.routeOpinionList[d])}this.fireEvent("beforeProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcess");var c=this.getIgnoreImpowerIdentity(r),h=this;MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),l&&l(),this.fireEvent("beforeSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(o){this.businessData.task.routeName=t,this.businessData.task.opinion=e||"";var n=[];if(i&&i.length&&i.each(function(t){var e=new FormData;e.append("file",t),e.append("site","$mediaOpinion"),this.workAction.uploadAttachment(this.businessData.work.id,e,t,function(t){n.push(t.data.id)}.bind(this),null,!1)}.bind(this)),n.length&&(this.businessData.task.mediaOpinion=n.join(",")),a&&a.length){var r=[];a.each(function(t){"object"===typeOf(t)?r.push(t.distinguishedName||t.unique||t.id):r.push(t)}.bind(this)),this.businessData.task.appendTaskIdentityList=r}this.businessData.task.ignoreEmpowerIdentityList=c,this.fireEvent("afterSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave"),this.workAction.processTask(function(t){if(s&&s(t),this.taskList=t.data,this.fireEvent("afterProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterProcess"),this.addMessage(t.data,!0),this.app.taskObject&&this.app.taskObject.destroy(),this.closeImmediatelyOnProcess)this.app.close();else if("function"===typeOf(this.showCustomSubmitedDialog))this.showCustomSubmitedDialog(t.data);else if(layout.mobile)h.finishOnMobile();else if(this.app.inBrowser)if(this.mask&&this.mask.hide(),!1!==this.json.isPrompt)this.showSubmitedDialog(t.data);else if("redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var e=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(e).go()}else this.app.close();else this.app.close()}.bind(this),null,this.businessData.task.id,this.businessData.task)}.bind(this),null,!0,n,!0)}.bind(this))},showSubmitedDialog:function(t){var e=this.getMessageContent(t,this.json.submitedDlgStyle?this.json.submitedDlgStyle.maxTitleLength:60),i=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden",width:"270px"}}).inject(this.app.content);i.set("html",e);var s=new Element("div",{styles:{"margin-top":"5px"}}).inject(i),o={content:i,isTitle:!1,width:350,height:180,buttonList:[{text:this.app.lp.closePage,action:function(){if(r.close(),"redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else this.app.close()}.bind(this)}]};this.json.submitedDlgStyle&&(o=Object.merge(o,this.json.submitedDlgStyle),this.json.submitedDlgStyle.contentStyle&&(i.setStyles(this.json.submitedDlgStyle.contentStyle),delete o.contentStyle));var n=this.app.content.getSize();switch(o.promptPosition||this.json.promptPosition||"righttop"){case"lefttop":o.top=10,o.left=10,o.fromTop=10,o.fromLeft=10;break;case"righttop":o.top=10,o.left=n.x-o.width-10,o.fromTop=10,o.fromLeft=n.x-10;break;case"leftbottom":o.top=n.y-o.height-10,o.left=10,o.fromTop=n.y-10,o.fromLeft=10;break;case"rightbottom":o.top=n.y-o.height-10,o.left=n.x-o.width-10,o.fromTop=n.y-10,o.fromLeft=n.x-10;break;default:delete o.top,delete o.left,delete o.fromTop,delete o.fromLeft}var a=this;o.onPostLoad=function(){this.node.setStyle("display","block");var t=i.getSize();if(this.content.setStyles({height:t.y}),this.setContentSize(),0!=(o.promptCloseTime||a.json.promptCloseTime)){var e=o.promptCloseTime||a.json.promptCloseTime||2;if(e=1e3*e.toInt(),o.isCountDown){s.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3;var n=function(){if(e>0)s.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3,window.setTimeout(n,1e3);else if(r.close(),"redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()};window.setTimeout(n,1e3)}else window.setTimeout((function(){if("redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()}),e)}};var r=o2.DL.open(o)},startDraftProcess:function(){return this.formCustomValidation("","")&&this.formValidation("","")?void this.saveFormData(function(){this.workAction.startDraft(this.businessData.work.id,function(t){if(this.app.options.workId=t.data[0].work,layout.mobile||!layout.desktop.message)layout.notice&&layout.notice(MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject));else if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.processStarted,content:"<div>"+MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject)+"”</div>"};layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}layout.app&&layout.app.inBrowser&&(layout.app&&(layout.app.$openWithSelf=!0),layout.desktop.openApplication(null,"process.Work",{workId:this.app.options.workId,action:"processTask"})),this.app.options.action="processTask",this.app.reload()}.bind(this))}.bind(this),null,!1,null,!1,!0):(this.app.content.unmask(),!1)},getCurrentTaskData:function(t){return!t.currentTaskIndex&&0!==t.currentTaskIndex||-1==t.currentTaskIndex?null:(this.app.options.taskId=this.businessData.taskList[t.currentTaskIndex].id,this.businessData.taskList[t.currentTaskIndex])},processWork:function(){this.businessData.work.startTime?"select"===this.json.submitFormType||"script"===this.json.submitFormType?this.processWork_custom():"Mobile"==this.json.mode?setTimeout(function(){this.processWork_mobile()}.bind(this),100):this.processWork_pc():this.startDraftProcess()},processWork_custom:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;if(this.submitFormModule)this.submitFormModule.show();else{MWF.APPSubmitform||MWF.xDesktop.requireApp("process.Xform","Subform",null,!1);var t=new Element("div").inject(layout.mobile?$(document.body):this.app.content);this.submitFormModule=new MWF.APPSubmitform(t,this.json,this),this.submitFormModule.addEvent("afterModulesLoad",function(){this.submitFormModule.show()}.bind(this)),this.submitFormModule.load()}},processWork_pc:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var t=function(t){if(this&&this.node){this.node.setStyle("display","block");var i=e.getSize();this.content.setStyles({height:i.y,width:i.x});this.setContentSize();t||this.reCenter()}},e=new Element("div",{styles:this.app.css.processNode_Area}).inject(this.node);this.setProcessNode(e,"process",function(i){this.processDlg=o2.DL.open({title:this.app.lp.process,style:this.json.dialogStyle||"user",isResize:!1,content:e,maskNode:this.app.content,positionHeight:800,maxHeight:800,maxHeightPercent:"98%",minTop:5,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.processor&&this.processor.okButton.click()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){this.processDlg.close(),this.processor&&this.processor.destroy()}.bind(this)}],onPostLoad:function(){i.options.mediaNode=this.content,t.call(this)}})}.bind(this),function(){this.processDlg&&t.call(this.processDlg,!0)}.bind(this))},processWork_mobile:function(){this.app.inBrowser&&this.app.content.setStyle("height",document.body.getSize().y),this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork");var t=this.app.content.getPosition(this.app.content.getOffsetParent());if("Mobile"!=this.json.mode&&this.app.content.mask({destroyOnHide:!0,style:this.app.css.maskNode,useIframeShim:!0,iframeShimOptions:{browsers:!0},onShow:function(){this.shim.shim.setStyles({opacity:0,top:t.y+"px",left:t.x+"px"})}}),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var e=this.createProcessNode();this.setProcessNode(e),this.showProcessNode(e),e.setStyle("overflow","auto")},createProcessNode:function(){var t=this.app.css.processNode_from,e=this.app.css.processNode;if(layout.mobile&&(t=this.app.css.processNodeMobile_from,e=this.app.css.processNodeMobile,t.width="100%",e.width="100%",t.height="100%",e.height="100%"),"Mobile"==this.json.mode)var i=new Element("div",{styles:t}).inject(document.body);else i=new Element("div",{styles:t}).inject(this.app.content);return i.position({relativeTo:this.app.content,position:"topcenter",edge:"topcenter"}),i},getOpinion:function(){var t="",e=[];return Object.each(this.forms,function(i,s){"Opinion"===i.json.type&&this.businessData.data[s]&&(t+=" "+i._getBusinessSectionDataByPerson()),i.handwritingFile&&i.handwritingFile[layout.session.user.distinguishedName]&&e.push(i.handwritingFile[layout.session.user.distinguishedName]),i.soundFile&&i.soundFile[layout.session.user.distinguishedName]&&e.push(i.soundFile[layout.session.user.distinguishedName]),i.videoFile&&i.videoFile[layout.session.user.distinguishedName]&&e.push(i.videoFile[layout.session.user.distinguishedName])}.bind(this)),{opinion:t.trim(),medias:e}},setProcessNode:function(t,e,i,s){var o=this;MWF.xDesktop.requireApp("process.Work","Processor",function(){var n,a=this.getOpinion(),r=a.medias;layout.mobile&&(n=new Element("div").inject(t)),this.processor=new MWF.xApplication.process.Work.Processor(n||t,this.businessData.task,{style:layout.mobile?"mobile":e||"default",opinion:a.opinion,tabletWidth:this.json.tabletWidth||0,tabletHeight:this.json.tabletHeight||0,onPostLoad:function(){i&&i(this)},onResize:function(){s&&s()},onCancel:function(){t.destroy(),o.app.content.unmask()},onSubmit:function(e,i,s,n,a,l){if(s=s&&s.length?s.concat(r):r,this.toWordSubmitList&&this.toWordSubmitList.length){var d=[];this.toWordSubmitList.each((function(t){t.docToWord&&d.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(d).then(function(){o.submitWork(e,i,s,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,l)}.bind(this))}else o.submitWork(e,i,s,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,l)}},this)}.bind(this))},showProcessNode:function(t){if(layout.mobile)t.setStyles(this.app.css.processNodeMobile);else{var e=this.app.content.getSize(),i=t.getSize(),s=e.y/2-i.y/2-20,o=e.x/2-i.x/2;s<0&&(s=0),this.app.css.processNode.top=s+"px",this.app.css.processNode.left=o+"px",new Fx.Morph(t,{duration:300,transition:Fx.Transitions.Expo.easeOut}).start(this.app.css.processNode)}},confirm:function(t,e,i,s,o,n,a,r,l,d,c){MWF.require("MWF.xDesktop.Dialog",function(){var l,h=this.container.getSize(),u=0,p=0;"element"===typeOf(e)?(u=(l=e.getPosition(this.app.content)).x,p=l.y):("firefox"==Browser.name?(u=parseFloat(e.event.clientX||e.event.x),p=parseFloat(e.event.clientY||e.event.y)):(u=parseFloat(e.event.x),p=parseFloat(e.event.y)),e.target&&(u=(l=e.target.getPosition(this.app.content)).x,p=l.y));u+parseFloat(o)>h.x&&(u-=parseFloat(o)),u<0&&(u=10),p+parseFloat(n)>h.y&&(p-=parseFloat(n)),p<0&&(p=10),u<0&&(u=20),layout.mobile||(u-=20);var m=new MWF.xDesktop.Dialog({title:i,style:c||"o2",top:p,left:u,fromTop:e.event.y,fromLeft:"firefox"===Browser.name?e.event.clientX-20:e.event.x-20,width:o,height:n,text:s,container:this.app.content,maskNode:d||this.app.content,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:a},{type:"cancel",text:MWF.LP.process.button.cancel,action:r}]});switch(t.toLowerCase()){case"success":this.json.confirmIcon&&this.json.confirmIcon.success?m.content.setStyle("background-image","url("+this.json.confirmIcon.success+")"):m.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB1hJREFUeNqsWGtsVEUUPnMf+y6rLcW2tDxUKARaikqgiWh8BlH8IwYkaozhh4nhB1FMTKkxQtQYQzRGE2JEfMRHYhQSVChgFYIGqLSUtoKUQmlp2b53u233de94zuzcZbfdbhdwkpPZmbl3zjffnHPuOcue/WgxZNnc3OT3cQ4rGIMlwNg8BjATGEwDDgHOeZdpQis3eKMR5Sd62kaO/PHp5QDub2ba9OtNTYnf2lQIcOO5igpr8eeT3kL9XneuCi6vAvYcFWxOBqrO6BlvZIx7w8PGwlG/uWZkwADNzo4//e7CfQMdYz/88t6F8/i+icB4Jl0sEzPIxEbsXiwotVd6C3TwTFezZRGCfQb4r0bhSnPo78io8dWP1ed24nRkPFNTMoMnnYNsbGYK2zR/pYsRGxJc1mDcuQqKHbwF2t3/Hh29a+3bC8oHOkM7UPk5UpGOpQQzFsINHyxahDaxdeYix/r8223AFLjpxpGL3rYIXDw5um+gc+ydwx9fqsPpKC0lP6eWr54hfjT+2gPP7Fg0R1HgreIyx/rpc2zxjfjNCzXXrSo4PMr8sWFecEuRo6mjMdBPdpQMJuWa6GoKF9jX55bo13UlE5jg8szobshyotG+RtT1OJrBAA43o/hRYhOYKVuVvxFtZPusCie7GUbQvcnmIBbh4noEoqR15zQV/N1GeXFZzvD5Y4P1ydclwJD7om1sn3uPs0S3x1++ESHlJgJB74FiXgkD4XZQLGr4NQtBh2DDvWa+3aOd7D4b7CGDFjcjr2dt3mxbpQNjB53sRsTA7YiN0IgBRWYlrJz2suhpTPO0bj1LegpKHWWFpZ6nUL0ngYOAUkBz34JAYjytEO1GJN5Pth4LmRAajkGxuQJWFb0CLpdL9DSmeVpPfp/0uXP1B2+b5y5A/cJbVLSVh9252uu5M/WM1BMYSLKBdFczS6mEx0peBbfbDU6nE1RVhdnOZdDj78AruyyvLP6+ZmMQDQMCYc3tp/xnKSAq9K2xuxmYBp8oeIJY2ITwSAxm8uWip7E43bj1ErYCHpsVB0KsOBwO0dOY5mdrlXhdSe+ikN6cPNtSeTsqgV2iOxRchFRBh4uGOSpCY8QTP5C/SfQ0pnkjmrq+es6WBBBN0wQrNpsNvF4vFBYWwgvL3ofFeY/EmZQ6SK/do5YiECeFGYW+vprGUu0AaY/iHYeDceqfmLtFKKGexjRP15K8ngxEUa6FbfpNwH5qfQua+w8lGCUhvbpDLZE2g8xgGkAhP4WRCJ3YhFk6KrozrignJ0f0NKb50LCRsp4OCJNu/X3LG3Cm92Dcm5LYJ71oO9MtMJrIRyguGzwRPelu5zoqYc28a4rodLqui2eexPk9/3DRTwXku6ZqaOo7KOw2bdqgMLf8EigaJUaxCHgT+yCY8hmPwrrFb4oNLbEUkGITj7iuoloozwTk28ZqONMzOZA4U3w07mLANMrQ0CO85GpWO+M7iKsMNlRsk2zxxP2TYo/HIwBZ43RAvmmohkZfzaRAqIlgGDH7rEChUaqIXrFQUVPfauiqEcifvWubUJAMiLwkLeUSyNenEMjVzECokTdGQman/FiaGuWs6DlrdNvENxs6DwCuw3PLtqcAygTkq5Nb4XT31EAEGIragVgrBTz6PmmUPBNdppH+hfrOGhEbnl8+OSALyJfHtwpGswFiXdNgV6jFAqPm3+7yOb36A5pdKaY906UF3f4LcNXfDhUlDyUUjwey+6+qOPAs0w8KH0NXI00nvu/aFQoaPnxtWKFyAhHui4Yw/0B20goyU3+5BnYfq0oASPYymqd1em7SPcYJ6fP7wn8OdYcp0RoRzFBiHPCFexRdqdR0VsRkzjpBiKGhC+BDhpbOfijBzOdHq+BU+4H4ic3sJIYRPtAbbWk+1Pv54JXQRdxmiExI+CTVNVROjI2YPGPeggrrLh2AXUeqBCvU09jk15f7kJ6+S6P7244PUT0VkDYTz/QoGf+ntr9h/srcIs2mLFVY5oyua7AVfIF2qGvbn5rFZSHESn9HaG/Nhxc/wxmylUErDxbMyBomQnVNcDC2Lyq9a1LB051o3T/hWzOV0L6D3eHalsN936K+PgkkYiWkyVWR+dsnl85RXRP0R3+OxbioEP4vof2GfOHac0f6v7h4cqhZghlNLldS6iZCiA/6qK7RnapLtSvlwCm43ES1QFdjco6s722q6d2NFcFp1NMjbSWWsdbGypIshj7POatfu+MlT55tnd2lljHOso1l18yIYYIeNFrIWGt3tv8o2SAZJu8h80iutRPMWE0aNFEXobqGygk0ar+iM5eqswIrqE0w3ASAeD8WjDX1d4ztIfet3+v7XRprL/0nQIxYtba8kan/hUDUikx8PJTFl96fdx/lrJQqUoZGiRHlI5QG0NeXPnr0raEQf7a2r04GtICU4FT/QmTDPJOGTqAcMnl2yrFNJkZWMIhJ7yAZk5E1JMfm+EI/naLraQRKlQBUKUoSGFNWh4YEZowv7jO1/wQYAIxJoZGb/Cz/AAAAAElFTkSuQmCC)");break;case"error":this.json.confirmIcon&&this.json.confirmIcon.error?m.content.setStyle("background-image","url("+this.json.confirmIcon.error+")"):m.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABsVJREFUeNqkWFtsFGUU/nZn2r21IqX3llp6AQmkWDVGAgIlGI0EeMAHffAFa998MCQaE8JDxZCgSHzQKIm3qPHFGC7GW0xqkIgIKhhEwFJaKSDQUtplu73s7vidmX/q32F2uw2TnOzMv2fO+f5z/8fci7yvWAZYRXo4CCwLAM1cq+HvXRYwQrrM/7rTwB+TwC/dwKG3uU75mVxCO7T7wExgKHiBATzJ2411wMoy3pSQ5gg6UiFpgpQgDZNukK6TLgBHuf7lAPD5q8DfXMpQl5U3mA4P4ztAO3+2tADLCQSV+VsR/5L+If0G/EqgH78EvKtwT1lqr0en6SfoLaCe1niB7nj+CQIuV+uZWYApV8RNPPAVcP/rQMtF4I03gbNcpjdvt5KxQXs4SKKflxBI54PAs20EElNvZTQJucjLFyUtpZwioJVurFtMD/4MXBXWDUqnL5jHHYt0PgQ8da/4UFMwThpTz0HF7wfEj0/kSKwVAwsZU5U1wKkTwOBBj7GD08xE17QSSJPanVCKlCSNkM5s2mT/JtV6epZ8InclsH4R9TjYRKWPZQixnch2POJsZNpOb5HOb9yIi5s3I5XJIHb2rL2LoBZL+fBZKhOZaS3LgPgh4HcnYZ34scFI+goQxsj8iA+QHipItrejrKwMiaVLMZJIIEpFAaUkH76AFrEVfLxEzzEej/0FXFOGc8CQ8bmFTOE6DciEUnCBCsapoLGxETU1NYhGo7i+YAHiSlFauWMmvqAGKOzcVzDlh2mdo2o/loCJkeEVRnldSMsGUdCrKaiqqkJxcTEikQgKCgpsRbJzk4oukm8iB1+CfEUKkLtZub/CZOsFvht0Qi1lrAfW0WwvN3gyI7J1K+7ZswfNzc0oLS1FKBRCMBiEaZoIh8OOovp6jI6NYXLLFjQ1NdlAxCKGYaCwsBAlJSWoJ08lwQZTKaSPHJmSL9YZZWZx438eZ8yLMwwWtWeYaqvv9oBJ8UWDyovWrUMgEPi/ZPPeBWT/rlhhx0h1dbUNRABPpSrvBVhixw4kd+26rRyMOq3jCl31kzya0vSiKgW91/DOnbZJ53V22iAsy5pSIopra2vtNflP3KIDcTcwuH074pQT8JEvelkMF4kjpBuY0n1Dbjj7XDcpSCCU+gCKxWK+77hABghkOAsQuUIOivmq3xrSm2qMLJZxrwEKlGJQ5QGUC8gVBSSYQ67hoCidAiPzSCCHZSxVlXopeHhiAk30v8RBtivFQO3etg1Du3fbbihQKe0L3MmqmGrYwaAMRuPKMl6aVCkeJ11jRvSuWYO+vj4kk0lf4bIu/wuf8MfV+5NZ5I87RhhVuAKmTGhsbHPCWSwiwoYoOMQ60tDQgPLycjvNfWOA6/J/Op3GefJzsMLcAwfs6PSz0JhTXAfcBDNlVCS0xaYHSEql3jCBRLSC5k3faV1XZZnwySWABmUqJKCo8oUOaNTZbL9SlzE4Niwh8lURLf/TyoQzAZFgdcmvDklhjKsKXKAqsF5rZEztAboOAz+KA4xHmeo0+tNFqky7VMkKfJ+nAnuV2rtn1pS0td32n16B67kpRjZuqQrs6pB5mW37s5OswoLNaOTUdRfQRjPWGhrqOF80aYVSTwXWgfQQSL8URiqa6wGkV+B+ZuAlTwUWF/VxyPoUeD/uTH5x4xhjiNapoHXWhj3l+ubhw0hTkbtz3SXdBNJHIJgFn+Vx0Tlg37eOi+RAkTTk+MDueY1WWc64qQ5oZpSXhpSiedrOz1HBBVWZZ8Pn0phzcjj9DfBBvz1r4aYkrz3PvEhZq9lIyfgY3RXwzrY3lKKytWtxhgp6fHaaL5+AoU8stulPvgB+UFZJuPOMPaF/D5wgoGq6q9XMosianER3FiD58iWcDNr/GvCegwtDbjeywShAGQ5Y3aYzZC00PELsDkxFmOGokosv6cy/XV8DHyr3XFfL1rSBnL/WNqKUcw3rQWWhD6A7oaSTPV1dwEecX07CmX1v6W3Re4iz5IAl5xqCiTIMW0zJ5DsAkXKOLxbHy/1iEQ3IiHdYmAbGdZccsBhDXXKcoMAyWqjCynJwywVCqjgbz2kJVokR5RoXyKRkctYTpQ5Iepica+Q4QesMU0GUoCozPjGS0QZ5t9uzJ51ioO6T9FVZc1XFiLgm5X6ROJjvJ5EOZ4iXwaeIs2Elz1WreExtlVFRJjQZjGQekTFAuq80PRazbp6JTtOyxy87FX9EkYCY8H6v6fDMNzNdagayQYXVZ5mIei7UmrHrnQlFSZXJY9qnECuXIjMPMJZ2lHIPj6aaGg0FNOD5CJHWjtl5f0n5T4ABAFHaXG6UVjGNAAAAAElFTkSuQmCC)");break;case"info":this.json.confirmIcon&&this.json.confirmIcon.info?m.content.setStyle("background-image","url("+this.json.confirmIcon.info+")"):m.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABvBJREFUeNqsWF1sFFUUPndm9n+3W5aWLi2VGgJtgy3UEn6MQGI0GgmC0UgfTEjEBxPDA29qYqLGGOODifGBGGOUYOKDPIg2QgykWgUtP1WgLT+lFKFCf9l2uz+z83c9Z3p3u1u6u4Pxpqczd+7MPd8999xzvrPskb2fgsMW4NzaBpxvBsbWMWCrgUEdAKsA4HHO+R2wrOucmxe5qZ9Jjt3ovtX1eRznt0pN2ndof+5eKYcAJ34YJPlFvH3OFV7+uOyPgOQLg+wJAXP5gMkueifM9XTYzMw2W+mZnWbqHjDF09Pc8WFneur2kaHOjwbxewuB8VK6WCnLoCVexcsrnmWNW1zhKMiBKqdWBDM5CfrMKKh3+8+bWurw1W/f/gwfawstVdYyuNIGtMYBxqT9/lVbmRyIZMFlUeKfCdyiPi0WN02ScPdkvGX2KxJa0IOiVETbU0O/Ptr00getamzkY1R+lbAuZiV52fpnC4FY5lqQpPe80bX7/A2bmIRbQcpzggAQLFhaGiw1aV+5nqEPEQcjWDnAJJLLC57q1Ux2+9tATzwUXN40PH3j7Nj4hWMW6cbr4mDmLIJAals63Esbsk8LhFsGAkjBY3UaPN8M8HKbBGsiHBRmwK1pEy0kC+Pkf4eK/EtA8gTX8Mxs1Lukti9+6+IUAco3ROE24dZ4apo6XEvq57dkQbPQKtsQ575NleB1z30erQbYsMoApScJ3bd1kMRWLWw0r9/Ud+Ci72H3AMoMinGfZchZ0Ufe961Yz/LNvFBoi/ZuDMKaukoIBAIQDofB7XaD1+MGl8Thl6EMWkYq+r3srQAzfrc1VN8yG7t26k/UpGfNJ+WOL54ab30746TQMkuIBVuaaiAUCoHf7wdFUewr9ek5jZf8HucnPe7Q0j3R9t0tqNdtn4AsGIoj7sjKLbI3ZDtiKSEnvTyqgSzLhScB+/ScxsvNQXq8NY0twdrGF/DTYBYH/QtQQJN9lbZzlhOa7MRADHRDnB4h1KfnNO5kHtLnCkSeCERXR4V1QK5e98yTij/ypquyrug+Fwhu7+BoGsbjGngVCaoq3NA7PAuHT4/BjxdjUMrf8oUpqN/IRNGO/TM3e69QQFQo1zB3wN7PMokht+802Q/nUij/5MVyNnesJTnrAmUb6UXfacPb71ESCiU9CkxQBsxcfFHB0tXFjz2CkRQP5iw/AlIcgSG9sjfYiLc+CjMKZV8mk4GM0mBw/MDTUdjc4ANVVUHXdftk5AIWnqozf6tw8FQc44yz/EV6ZZe3XvgM9ogGUFwoYxmav7IyAitXLgNN0yCRSNiAcgHN5YJdyyU42N2LSzYdopHId6rmwdh8BBz4DMA7Ry7D71fG4d2OFjvQFVqOg2EY837lsGGADIhMIFGojIOpoWUMB2LCsd4RSGdKbKmjeYSgXgSeEoZnCjE0y8iEMa06Wgk3DQxOJiZvdFhJWsTRnVuGIxjL0CazGVWxqaKeaba5iLMZcoGu2Dg4BYPUA0/niEiWlkKc1TLUnXYQcjKBZZQd55azhaFeMNLx6xTwiHApRJ65oTleTdn3rAewDOpVY3cGcmCIxQfrPD3I6DYRuS5vGbPsuBOfISqiJyb7Jge6zmE3TVslUTmBCDs5miy3qqJCJ6CMItPMnbxSQvoyM2OnM9N3iWglbcsQW6dyAq2yW5Hk9rncUiQ3oSKT9hnjCTkwRd15DKb93DRwkQwToVw8R5Hl0CoDscE/TmI3jqLSBttnk+oaKiesTJIT4V5MuGHY5Ht7cxWk00jGrcL8RH16TuM2STcMKDYX6UlN3Dw+PdQzKMBoOdpJDH1qoOuvSOPWWklxt9krWkg3cTVv7NkAr+3aaFNNsko+n6G+z+eDra0PQU2lD37rv7MonSBfUaduHx0+/skXODqGEsvyYNsyoobRqK4xUrFOCkZ2vMgThqYPBUMQDAbtYJcPJCv0nMbpPXp/4Rw0L/pI12T/yW9Q36QAomU5cEFFiQWW0vDU6xu9kRVvuXwVO+wE+n81pB2Z+HjX1JXuQ1NzJ2i0aHVADbeLU4FFdY3s9vkll6eVAWcLa6cHFeQ/XL03cnTi0k9fYUVwgVQJXzGKVpTCfywqsBB9F5UTyDmq8aTVsP8Cgk5ZJjGQHL32NfkIBrjhPCA6uUfRijIfEO0l1TWKJ3gWnXoG61w/U1zRnFPC/VVjlvFRM9REH4aM7yYunfhy7PzRn4WzThC9pOFsrZ0PpuSvEOhDkiA+QWLxS5u2byPOSlSRGBoRI+IjRAMo+1LSo1xDIZ4iqwhocSGJcr9COCGITJw6AuUVpY1P9N2CGDFhHkOcDk2E+KQIaNS3Ck24uKIHaQRKFgBkIVIeGFJoCjHE1XI6+b8CDABnZtjY0mkIGQAAAABJRU5ErkJggg==)");break;case"warn":this.json.confirmIcon&&this.json.confirmIcon.warn?m.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")"):m.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABgtJREFUeNqsWG2IlFUUft6vmdlZd539GFdTY5VMomy1oBJUSPLXkmQt5I8gCIMK+iH0K4ooEvtTRP7JX9JKWCC1mUUkIkQKSoaZH60t2pboOK37Mc6Ozsw779t57t5xx5ndnTvhC4d373nnnnPuOeee85y1Jr+G6dNcCrBB6AnbQo9tY4UFLLYstIYhMsK/IjRULOF0voATx87jp60fICPygzmFbpn+26pnzK0ilrk2+kTp5kgC6+w4YDfJxpiQJ+QAYUmoKHQLCG4K5YDsCI7fzOPgcBr7172BP0VUILrC/22MnHSbvF6KLcRap1WMmGfsRQRZ2Z8BJv7BybEs9t6/DbuFXaj2VKUx7ize6BZvbHcdvB67D5bdrD/ocwUiruiLZPFGSbziiHci4iVPpEn41MM9pPZWPBofwiOX9uDh05fwkSgf5Dln8lKNZwo+HnRsvBVbjK1eJ39RdWIxJCfhGB0HxjNTBtGQhHiuPQHEY9MG3X5EbXEESA3i4KmL2Ln5Xfwi3CINmjVM9IjnYGeTGOJ2zOx+SU5cE8Hp/DMIopvgxFejlDsFO38IC6ID6JIDRCMz7/WvA1cG8d2PJ/H2y5/gLA2a9ndVmBia2CIxpL3yJ1XG5MUzTh8S3e/B9Zo09x74xSeRS7vyfT+i3sx7KXfRCvSuz2NUltuFJmhj+btdmazMEa+NsZidfIYlsQXzE51oa2tDV1eXenNNPr/PtZ/ylybxwtEP8Ypw4pU22OXrq27NvZIh4dzCeI07lvQiHo8jFovBdV315pp8fp9rP+VTT/cCPL/jRawSTqScma4OT1+sA2vtqN4w552V03meMsKyprLblowlj2s/qC+DepJLsWpjD56T5aDOnRI908yC5jTVOVEl1THWhKhPwrVx/UNYqL0DmyU+0iyVNWooKKxjTGgmh/o6k+h5tRcbhBNTDla9JtKAV+6SZ5RBondZF9YwOkKOq5qeZ6CkUpmJMQYP9Xa0YqX8ySRxXdV9bXMBloShnLg134RvhQ3IEr2tTViqc8ZxNQwwFuCJANsqiOJ4jSHke40cTPQ2RdFZNsYmHrEaiHVEmqI/drTGO+paC5/fTWVRghTaZl1ibJvAqG6hqqygIsG+/iXCID8VFk1ck+9Z5rKoV8BYThc9yyVCE2A0nyDJKOmEoiP98GV7mNwKO7EOwfjPwL9fKL7q2CUzWTRGANiILgghjRkKfTwAyxw4cWt4pR+F4X72NAn2FIxQzg4aECMtcmISl3WzDFxi1sDH046hZ4JQ45kbgmeyFXhGUGB7i8YzhgcTvbg2jiHCKPrTJXgmE56ZgKIoH5XGn/YEz3QLnpm/GrcmTiE9dkiOOaBuU9QzN+bsMM7dNoYo/qk1OC597vEahDbDU5BtuVbBMysr8ExS45lBV74LnjHwMhFjahRndn2rUN9NhsrmOEEUX/LNbgB/F13yLBJtyTvwDNfkNyLnj8s4dv5vBbQmVdcmWuc4IYl0MjC44jz0guWb0NLSojAMoQTfXJPvGNQs6hGvnNt7GIeFkyGk4hcVGM41HCcEZIV1ix53jJ+QieDOWKi18CN2fWOo58QF/PD5ETVPZXTO3IZ8Aeea9Dj2FOt4R7WDq1L0SlVFT9bke3WMofzf/8I3fTvwlXAYomy5IChj9AxT4FyTmsBBPyyXoVpSRe9qP8LfXkNw7ZAaIfnmmnwbs++l3AspHPl4APuEw2I3pr0S1owqMsO4B97BYz3L8eaiFvR6uHsPceWFNI7s/h6f7TqgblBq1umgPCRwwOJcc3EEe3NsOXN4yYRUkRQ5vw5j4P19+FQbkha6Ud04aiZK8Y6lS2ALxwmi+GQcqxyGKDT3RCBSSkKpLM4xWXWOjGi6UXeirDKI1yXOcYIonuC5s1lQoTbKKlPZCdYUBZpSGZxhHeH11bdmVOdIrnLWNv4vhPzQ1sBnHlE8wTMxK6EiERqBEfEIYQC7L5seew1LPCurLmgZTdl6/4UwaWmWzq2IRvHNGrNGNLmYdpCvb0dBl/hJXdAKJrOF1eClsHX4XP12NM+qGFJKmnz9NgYV/wkwAMYATK0QLuhAAAAAAElFTkSuQmCC)");break;default:this.json.confirmIcon&&this.json.confirmIcon.warn&&m.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")")}m.show()}.bind(this))},alert:function(t,e,i,s,o){this.app.alert(t,"center",e,i,s,o)},notice:function(t,e,i,s,o,n){s||(s={x:"right",y:"top"}),e||(e="ok");var a=i||this.app.window.content,r=o;r||(r={x:10,y:(s.y.toString().toLowerCase(),10)});var l={type:e,position:s,move:!1,target:a,delayClose:"error"===e?1e4:5e3,offset:r,content:t};this.json.noticeStyle&&(l=Object.merge(l,this.json.noticeStyle)),this.json["notice"+e.capitalize()+"Style"]&&(l=Object.merge(l,this.json["notice"+e.capitalize()+"Style"])),n&&"object"===typeOf(n)&&(l=Object.merge(l,n)),new mBox.Notice(l)},addSplit:function(){if(!this.businessData.control.allowAddSplit)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,600,230),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.addSplit,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:600,height:230,url:this.app.path+"split.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){var o=i.content.getElement("input"),n=i.content.getElements(".o2_addSplit_radio"),a=o.get("value"),r=!0;n[1].checked&&(r=!1),e.doAddSplit(i,a,r)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){var t=i.content.getElement(".o2_addSplit_selector"),s=i.content.getElement("input");i.content.getElements(".o2_addSplit_radio");t.addEvent("click",function(){var t=s.get("value");MWF.xDesktop.requireApp("Selector","package",function(){new o2.O2Selector(e.app.content,{type:"",count:0,values:t?t.split(o2.splitStr):[],types:["unit","identity","group","role"],onComplete:function(t){var e=[];t.each((function(t){e.push(t.data.distinguishedName)})),s.set("value",e.join(", "))}})}.bind(this))}.bind(this))}});i.show()}.bind(this))},doAddSplit:function(t,e,i){if(!e)return this.app.notice(MWF.xApplication.process.Xform.LP.inputSplitValue,"error",t.node),!1;MWF.require("MWF.widget.Mask",function(){var s=e.split(o2.splitStr);this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeAddSplit"),this.addSplitWork(s,i,function(e){this.fireEvent("afterAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterAddSplit"),this.addAddSplitMessage(e.data),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},addSplitWork:function(t,e,i,s){var o={splitValueList:t,trimExist:e};this.options.readonly?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){i&&i(t)}.bind(this),(function(t,e,i){s&&s(t,e,i)})):this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){i&&i(t)}.bind(this),(function(t,e,i){s&&s(t,e,i)}))}.bind(this),(function(t,e,i){s&&s(t,e,i)}),!0,null,!0)},setRollBackChecked:function(t){t.store("isSelected",!0),t.setStyles(this.css.rollbackItemNode_current),t.getFirst().setStyles(this.css.rollbackItemIconNode_current);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode_current),e.getLast().setStyles(this.css.rollbackItemTimeNode_current),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode_current),e.getLast().setStyles(this.css.rollbackItemTaskNode_current);var i=t.getElements("input");i&&i.set("checked",!0)},setRollBackUnchecked:function(t){t.store("isSelected",!1),t.setStyles(this.css.rollbackItemNode),t.getFirst().setStyles(this.css.rollbackItemIconNode);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode),e.getLast().setStyles(this.css.rollbackItemTimeNode),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode),e.getLast().setStyles(this.css.rollbackItemTaskNode);var i=t.getElements("input");i&&i.set("checked",!1)},getRollbackLogs:function(t){var e=this;o2.Actions.load("x_processplatform_assemble_surface").WorkLogAction.listRollbackWithWorkOrWorkCompleted(this.businessData.work.id,function(i){i.data.each(function(i){if(!i.splitting&&i.connected){var s=new Element("div",{styles:this.css.rollbackItemNode}).inject(t);s.store("log",i);new Element("div",{styles:this.css.rollbackItemIconNode}).inject(s);var o=new Element("div",{styles:this.css.rollbackItemContentNode}).inject(s),n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemActivityNode,text:i.fromActivityName}).inject(n),new Element("div",{styles:this.css.rollbackItemTimeNode,text:i.arrivedTime}).inject(n);n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemTaskTitleNode,text:this.app.lp.taskCompletedPerson+": "}).inject(n);if(i.taskCompletedList.length)i.taskCompletedList.each(function(t){var e=o2.name.cn(t.person)+"("+t.completedTime+")";new Element("input",{value:t.identity,type:"checkbox",styles:this.css.rollbackItemTaskCheckNode}).inject(n).addEvent("click",(function(t){t.stopPropagation()}));new Element("div",{styles:this.css.rollbackItemTaskNode,text:e}).inject(n)}.bind(this));else{var a=this.app.lp.systemFlow;new Element("div",{styles:this.css.rollbackItemTaskNode,text:a}).inject(n)}s.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode)},click:function(){this.retrieve("isSelected")?e.setRollBackUnchecked(this):(t.getChildren().each((function(t){e.setRollBackUnchecked(t)})),e.setRollBackChecked(this))}})}}.bind(this))}.bind(this),null,!1)},rollback:function(){if(!this.businessData.control.allowRollback)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;var t=MWF.xApplication.process.Xform.LP,e=new Element("div",{styles:this.css.rollbackAreaNode}),i='<div style="line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:left;">'+t.selectRollbackActivity+"</div>";i+="<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:right;\"><input class='rollback_flowOption' checked type='checkbox' />"+t.tryToProcess+"</div>",i+='<div style="clear:both; max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',e.set("html",i);var s=e.getLast();this.getRollbackLogs(s),e.inject(this.app.content);var o=o2.DL.open({title:this.app.lp.rollback,style:this.json.dialogStyle||"user",isResize:!1,content:e,width:600,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,i){this.doRollback(e,i,o)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){o.close()}}]})},doRollback:function(t,e,i){for(var s=t.getLast().getChildren(),o=t.getElement(".rollback_flowOption").checked,n=this,a=0;a<s.length;a++)if(s[a].retrieve("isSelected")){var r=this.app.lp.rollbackConfirmContent,l=s[a].retrieve("log"),d=s[a].getElements("input:checked"),c=[];d.each((function(t){var e=t.get("value");-1==c.indexOf(e)&&c.push(e)})),r=r.replace("{log}",l.fromActivityName+"("+l.arrivedTime+")"),this.app.confirm("infor",e,this.app.lp.rollbackConfirmTitle,r,450,120,(function(){n.doRollbackAction(l.id,o,i,c),i.close(),this.close()}),(function(){this.close()}),null,null,this.json.confirmStyle);break}},doRollbackAction:function(t,e,i,s){MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeRollback"),this.doRollbackActionInvoke(t,e,s,function(t){if(t.data.properties)this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage(t.data);else{var e=t.data.id;this.workAction.listTaskByWork(function(t){this.fireEvent("afterRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage_old(t.data)}.bind(this),null,e)}this.app.inBrowser||this.app.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(t,e,i){var s=i+":"+e;t&&(s=t.responseText),this.app.notice("request json error: "+s,"error"),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},doRollbackActionInvoke:function(t,e,i,s,o){if(this.businessData.work.completedTime){o2.Actions.get("x_processplatform_assemble_surface").rollbackWorkcompleted(this.businessData.work.id,{workLog:t},function(t){s&&s(t)}.bind(this),function(t,e,i){o&&o(t,e,i)}.bind(this))}else{var n={workLog:t,taskCompletedIdentityList:i,processing:!!e};o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Rollback(this.businessData.work.id,n,function(t){s&&s(t)}.bind(this),function(t,e,i){o&&o(t,e,i)}.bind(this))}},inBrowserDkg:function(t){if(this.mask&&this.mask.hide(),this.json.submitedDlgUseNotice)if(MWF.xDesktop.notice("success",{x:"right",y:"top"},t),!1!==this.json.isPrompt){if(0!=this.json.promptCloseTime){a=1e3*(a=this.json.promptCloseTime||2).toInt();var e=this;window.setTimeout((function(){e.app.close()}),a)}}else this.app.close();else{var i=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden"}}).inject(this.app.content);if(i.set("html",t),!1!==this.json.isPrompt){var s={content:i,isTitle:!1,width:350,height:180,buttonList:[{text:MWF.xApplication.process.Xform.LP.ok,action:function(){n.close(),this.app.close()}.bind(this)}]},o=this.app.content.getSize();switch(this.json.promptPosition||"righttop"){case"lefttop":s.top=10,s.left=10,s.fromTop=10,s.fromLeft=10;break;case"righttop":s.top=10,s.left=o.x-360,s.fromTop=10,s.fromLeft=o.x-10;break;case"leftbottom":s.top=o.y-190,s.left=10,s.fromTop=o.y-10,s.fromLeft=10;break;case"rightbottom":s.top=o.y-190,s.left=o.x-360,s.fromTop=o.y-10,s.fromLeft=o.x-10;break;default:delete s.top,delete s.left,delete s.fromTop,delete s.fromLeft}var n=o2.DL.open(s);if(0!=this.json.promptCloseTime){var a;a=1e3*(a=this.json.promptCloseTime||2).toInt();e=this;window.setTimeout((function(){n.close(),e.app.close()}),a)}}else this.app.close()}},addRollbackMessage_old:function(t){var e=[];t.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t[0].activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";if(layout.desktop.message){var s={subject:MWF.xApplication.process.Xform.LP.workRollback,content:"<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};return layout.desktop.message.addTooltip(s),layout.desktop.message.addMessage(s)}this.app.inBrowser&&this.inBrowserDkg("<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+i)},addRollbackMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRollback,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor))},pressWork:function(t){t&&t.setDisable&&t.setDisable(!0),o2.Actions.get("x_processplatform_assemble_surface").press(this.businessData.work.id,function(e){var i=o2.name.cns(e.data.valueList).join(", ");this.app.notice(MWF.xApplication.process.Xform.LP.sendTaskNotice.replace("{users}",i),"success"),t&&t.setDisable&&t.setDisable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))},pauseTask:function(t){return this.businessData.control.allowPause?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").pauseTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.pauseWork,"success"),this.businessData.control.allowResume=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},resumeTask:function(t){return this.businessData.control.allowResume?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").resumeTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.resumeWork,"success"),this.businessData.control.allowPause=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},downloadAll:function(){var t="";o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.uploadWorkInfo(this.businessData.work.id,"pdf",{workHtml:this.app.content.get("html"),pageWidth:1e3},function(e){t=e.data.id}.bind(this),null,!1),t=t.replace("#","%23");var e="/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/work/"+this.businessData.work.id+"/site/(0)/stream";e=o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface")+e),window.open(o2.filterUrl(e+"?fileName=&flag="+t))},resetWork:function(){if(!this.businessData.control.allowReset)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.reset,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"reset.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doResetWork(i)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){$("resetWork_selPeopleButton").addEvent("click",function(){e.selectPeople(this)}.bind(this))}});i.show()}.bind(this))},selectPeople:function(t){var e=this.businessData.activity.resetRange||"department",i=this.businessData.activity.resetCount||0;switch(e){case"unit":this.selectPeopleUnit(t,this.businessData.task.unit,i);break;case"topUnit":MWF.require("MWF.xScript.Actions.UnitActions",function(){orgActions=new MWF.xScript.Actions.UnitActions;var e={unitList:[this.businessData.task.unit]};orgActions.listUnitSupNested(e,function(e){v=e.data[0],this.selectPeopleUnit(t,v,i)}.bind(this))}.bind(this));break;case"script":o2.Actions.load("x_processplatform_assemble_surface").ProcessAction.getActivity(this.businessData.work.activity,"manual",function(e){if(e.data.activity.resetRangeScriptText){var s=this.Macro.exec(e.data.activity.resetRangeScriptText,this);this.selectPeopleUnit(t,"",i,s)}}.bind(this));break;default:this.selectPeopleAll(t,i)}},selectPeopleUnit:function(t,e,i,s){var o=t.identityList||[],n=$("resetWork_selPeopleArea"),a={values:o,type:"identity",count:i,units:e?[e]:[],title:this.app.lp.reset,onComplete:function(e){n.empty();var i=[];e.each(function(t){new MWF.widget.O2Identity(t.data,n,{style:"reset"}),i.push(t.data.distinguishedName)}.bind(this)),t.identityList=i}.bind(this)};s&&(a.noUnit=!0,a.include="array"===typeOf(s)?s:[s]),MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,a)}.bind(this))},selectPeopleAll:function(t,e){var i=t.identityList||[],s=$("resetWork_selPeopleArea"),o={values:i,type:"identity",count:e,title:this.app.lp.reset,onComplete:function(e){s.empty();var i=[];e.each(function(t){new MWF.widget.O2Identity(t.data,s,{style:"reset"}),i.push(t.data.distinguishedName)}.bind(this)),t.identityList=i}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,o)}.bind(this))},doResetWork:function(t){var e=t.identityList||[];if(!e.length)return this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople,"error",t.node),!1;var i=$("resetWork_opinion").get("value"),s=t.content.getElement(".resetWork_keepOption").checked,o=[];e.each((function(t){o.push(MWF.name.cn(t))})),i||(i=MWF.xApplication.process.Xform.LP.resetTo+": "+o.join(", ")),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeReset"),this.resetWorkToPeson(e,i,s,function(e){this.fireEvent("afterReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReset"),this.addResetMessage(e.data),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},resetWorkToPeson:function(t,e,i,s,o){var n={opinion:e,routeName:MWF.xApplication.process.Xform.LP.reset,identityList:t,keep:!!i};this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(function(t){s&&s(t)}.bind(this),(function(t,e,i){o&&o(t,e,i)}),this.businessData.task.id,n)}.bind(this),(function(t,e,i){o&&o(t,e,i)}),!0,null,!0)},addAddSplitMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.addSplitWork,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor))},addResetMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReset,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor))},retractWork:function(t,e){var i=this;if("Mobile"==this.json.mode){var s=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+s.x+" , y:"+s.y);var o=s.x,n={event:{x:o=s.x<20?20:s.x,y:s.y-200,clientX:o,clientY:s.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){i.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){i.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),i.mask.loadNode(i.app.content),i.fireEvent("beforeRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("beforeRetract"),i.doRetractWork(function(){i.fireEvent("afterRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("afterRetract"),i.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),i.app.content.unmask(),i.mask&&(i.mask.hide(),i.mask=null),i.finishOnMobile()}.bind(this),(function(t,e,s){i.app.content.unmask();var o=s+":"+e;t&&(o=t.responseText),i.app.notice("request json error: "+o,"error"),i.mask&&(i.mask.hide(),i.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{n={event:{x:(s=MWF.getCenterPosition(this.app.content,300,150)).x,y:s.y-200,clientX:s.x,clientY:s.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){i.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){i.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),i.mask.loadNode(i.app.content),i.fireEvent("beforeRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("beforeRetract"),i.doRetractWork(function(t){i.fireEvent("afterRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("afterRetract"),i.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),i.app.content.unmask(),i.mask&&(i.mask.hide(),i.mask=null),i.app.reload(),this.close()}.bind(this),(function(t,e,s){i.app.content.unmask();var o=s+":"+e;t&&(o=t.responseText),i.app.notice("request json error: "+o,"error"),i.mask&&(i.mask.hide(),i.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}},doRetractWork:function(t,e){this.businessData.control.allowRetract?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Retract(this.businessData.work.id,null,function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)})):e&&e(null,"Permission Denied","")},addRetractMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRetract,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor))},rerouteWork:function(t,e){if(!this.businessData.control.allowReroute)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,560,260),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.reroute,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:560,height:260,url:this.app.path+"reroute.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){e.doRerouteWork(i)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){var t=$("rerouteWork_selectActivity");e.workAction.getRerouteTo(e.businessData.work.process,function(i){i.data.agentList.each(function(e){new Element("option",{value:e.id+"#agent",text:e.name}).inject(t)}.bind(e)),i.data.cancelList.each(function(e){new Element("option",{value:e.id+"#cancel",text:e.name}).inject(t)}.bind(e)),i.data.choiceList.each(function(e){new Element("option",{value:e.id+"#choice",text:e.name}).inject(t)}.bind(e)),i.data.delayList.each(function(e){new Element("option",{value:e.id+"#delay",text:e.name}).inject(t)}.bind(e)),i.data.embedList.each(function(e){new Element("option",{value:e.id+"#embed",text:e.name}).inject(t)}.bind(e)),i.data.endList.each(function(e){new Element("option",{value:e.id+"#end",text:e.name}).inject(t)}.bind(e)),i.data.invokeList.each(function(e){new Element("option",{value:e.id+"#invoke",text:e.name}).inject(t)}.bind(e)),i.data.manualList.each(function(e){new Element("option",{value:e.id+"#manual",text:e.name}).inject(t)}.bind(e)),i.data.mergeList.each(function(e){new Element("option",{value:e.id+"#merge",text:e.name}).inject(t)}.bind(e)),i.data.messageList.each(function(e){new Element("option",{value:e.id+"#message",text:e.name}).inject(t)}.bind(e)),i.data.parallelList.each(function(e){new Element("option",{value:e.id+"#parallel",text:e.name}).inject(t)}.bind(e)),i.data.serviceList.each(function(e){new Element("option",{value:e.id+"#service",text:e.name}).inject(t)}.bind(e)),i.data.splitList.each(function(e){new Element("option",{value:e.id+"#split",text:e.name}).inject(t)}.bind(e))}.bind(e)),this.content.getElement(".rerouteWork_selPeopleButton").addEvent("click",function(){e.selectReroutePeople(this)}.bind(this))}});i.show()}.bind(this))},selectReroutePeople:function(t){var e=t.identityList||[],i=t.content.getElement(".rerouteWork_selPeopleArea"),s={values:e,type:"identity",count:0,title:this.app.lp.reroute,onComplete:function(e){i.empty();var s=[];e.each(function(t){new MWF.widget.O2Identity(t.data,i,{style:"reset"}),s.push(t.data.distinguishedName)}.bind(this)),t.identityList=s}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,s)}.bind(this))},doRerouteWork:function(t){var e=$("rerouteWork_opinion").get("value"),i=$("rerouteWork_selectActivity"),s=i.options[i.selectedIndex].get("value"),o=i.options[i.selectedIndex].get("text"),n=s.split("#");s=n[0];var a=n[1],r=[];(t.identityList||[]).each((function(t){r.push(t)})),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRetract"),this.rerouteWorkToActivity(s,a,e,r,function(e){this.fireEvent("afterReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReroute"),this.addRerouteMessage(e.data),this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk+": "+o,"success"),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},rerouteWorkToActivity:function(t,e,i,s,o,n){var a={activity:t,activityType:e,mergeWork:!1,manualForceTaskIdentityList:s};this.businessData.task?this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,i){n&&n(t,e,i)}))}.bind(this),(function(t,e,i){n&&n(t,e,i)}),!0,null,!0):o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,i){n&&n(t,e,i)}))},addRerouteMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReroute,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor))},deleteDraftWork:function(){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var i=e.x,s={event:{x:i=e.x<20?20:e.x,y:e.y-200,clientX:i,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{s={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}},deleteWork:function(){if(this.businessData.work.startTime){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var i=e.x,s={event:{x:i=e.x<20?20:e.x,y:e.y-200,clientX:i,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}else{s={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}}else this.deleteDraftWork()},doDeleteDraftWork:function(t,e){this.workAction.deleteDraftWork(function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)}),this.businessData.work.id)},doDeleteWork:function(t,e){this.businessData.work.startTime?this.businessData.control.allowDelete?this.workAction.abandoned(function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)}),this.businessData.work.id):e&&e(null,"Permission Denied",""):this.doDeleteDraftWork(t,e)},printWork:function(t,e){var i=t||this.businessData.work?this.businessData.work.application:this.businessData.workCompleted.application;if((e=e)||(e=this.json.id,this.json.printForm&&(e=this.json.printForm)),this.businessData.workCompleted){i=t||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+e))}else{i=t||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+e))}},readedWork:function(t){if(!this.businessData.control.allowReadProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this.businessData.work.title,i=MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",e);MWF.xApplication.process.Xform.LP.form.setReadedConfirmInfo=i;var s=new MWF.xDesktop.Dialog({title:MWF.xApplication.process.Xform.LP.setReadedConfirmTitle,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"readed.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doReadedWork(s)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}]});s.show()}.bind(this))},doReadedWork:function(t){for(var e=t.content.getElement(".readedWork_opinion").get("value"),i=null,s=0;s<this.businessData.readList.length;s++)if(this.businessData.readList[s].person===layout.session.user.distinguishedName){i=this.businessData.readList[s];break}var o=this;i?MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),i.opinion=e,this.app.action.setReaded((function(){o.mask&&(o.mask.hide(),o.mask=null),o.fireEvent("afterReaded"),o.app.reload(),layout.mobile?o.finishOnMobile():t.close()}),null,i.id,i)}.bind(this)):(o.app.reload(),layout.mobile?o.finishOnMobile():t.close())},openWindow:function(t,e){if((t=t)||(t=this.json.id),this.businessData.workCompleted){var i=e||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+t))}else{i=e||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+t))}},uploadedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(e){var i=this.all[t];i&&(e.data&&i.attachmentController.addAttachment(e.data),i.attachmentController.checkActions(),i.fireEvent("upload",[e.data]))}.bind(this))},replacedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(i){var s=this.all[t];if(s){for(var o=s.attachmentController,n=null,a=0;a<o.attachments.length;a++)if(o.attachments[a].data.id===e){n=o.attachments[a];break}n.data=i.data,n.reload(),o.checkActions()}}.bind(this))},finishOnMobile:function(){var t=this;this.workAction.checkDraft(this.businessData.work.id,function(e){t.finishOnMobileReal()}.bind(this),(function(){t.finishOnMobileReal()}),!1)},finishOnMobileReal:function(){if(window.o2android&&window.o2android.closeWork)window.o2android.closeWork("");else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.closeWork)window.webkit.messageHandlers.closeWork.postMessage("");else if(window.wx&&"miniprogram"===window.__wxjs_environment)wx.miniProgram.navigateBack({delta:1});else if(window.uni&&window.uni.navigateBack)window.uni.navigateBack();else if("redirect"===this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else{if(window.history.length>1)history.back();else{var e=new URI(window.location.href).getData("redirectlink");e?(history.replaceState(null,"work",e),e.toURI().go()):(window.location=o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"),history.replaceState(null,"work",o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter")),o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go())}}},getModuleType:function(t){if("string"===typeOf(t)&&(t=this.all[t]),t){var e=t.json.moduleName||"";return e||(e="string"===typeOf(t.json.type)?t.json.type.toLowerCase():""),e.toLowerCase()}return""}});var PortalPage="";MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.process.Xform.$Module=MWF.APP$Module=new Class({Implements:[Events],options:{moduleEvents:["load","queryLoad","postLoad"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i},_getSource:function(){for(var t=this.node.getParent();t&&"source"!=t.get("MWFtype")&&"subSource"!=t.get("MWFtype")&&"subSourceItem"!=t.get("MWFtype");)t=t.getParent();return t?t.retrieve("module"):null},hide:function(){var t=this.node.getStyle("display");"none"!==t&&this.node.store("mwf_display",t),this.node.setStyle("display","none"),this.iconNode&&this.iconNode.setStyle("display","none")},show:function(){var t=this.node.retrieve("mwf_display",t);this.node.setStyle("display",t),this.iconNode&&this.iconNode.setStyle("display","block")},load:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._loadDomEvents(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(t,e){if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")||-1!=t.indexOf("x_cms_assemble_control")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface"),o=MWF.Actions.getHost("x_cms_assemble_control");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),-1!==t.indexOf("/x_cms_assemble_control")?t=t.replace("/x_cms_assemble_control",o+"/x_cms_assemble_control"):-1!==t.indexOf("x_cms_assemble_control")&&(t=t.replace("x_cms_assemble_control",o+"/x_cms_assemble_control")),t=o2.filterUrl(t)}this.node.setStyle(e,t)}.bind(this))},_loadModuleEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_getBusinessData:function(){var t;if("yes"==this.json.section)t=this._getBusinessSectionData();else{if("Opinion"!==this.json.type)return this.getBusinessDataById()||"";t=this._getBusinessSectionDataByPerson()}return t},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript?this.json.sectionByScript.code:"");default:return this.getBusinessDataById()||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.id]=layout.desktop.session.user.id;var t=this.getBusinessDataById();return t&&t[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.task?this.form.businessData.task.unit:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.work?this.form.businessData.work.activity:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.work?this.form.businessData.work.splitValue:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataByScript:function(t){this.form.sectionListObj[this.json.id]="";var e=this.getBusinessDataById();if(!e)return"";var i=this.form.Macro.exec(t,this);return i&&(this.form.sectionListObj[this.json.id]=i),i&&e[i]||""},_setBusinessData:function(t){"yes"==this.json.section?this._setBusinessSectionData(t):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(t):(this.form.businessData.data[this.json.id]?this.setBusinessDataById(t):(this.setBusinessDataById(t),this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=t))},_setBusinessSectionData:function(t){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(t);break;case"unit":this._setBusinessSectionDataByUnit(t);break;case"activity":this._setBusinessSectionDataByActivity(t);break;case"splitValue":this._setBusinessSectionDataBySplitValue(t);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,t);break;default:this.form.businessData.data[this.json.id]?this.setBusinessDataById(t):(this.setBusinessDataById(t),this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(t){var e=!1,i=layout.desktop.session.user.id,s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t,e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(t){var e=!1,i=this.form.businessData.task?this.form.businessData.task.unit:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.activity:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(t,e){var i=!1,s=this.form.Macro.exec(t,this);if(s){var o=this.getBusinessDataById();o||(o={},this.setBusinessDataById(o),i=!0),o[s]||(i=!0),o[s]=e}i&&this.form.Macro.environment.setData(this.form.businessData.data)},getBusinessDataById:function(){if(this.json.id.indexOf("..")<1)return this.form.businessData.data[this.json.id];var t=this.json.id.split("..");t=t.map((function(t){return t.test(/^\d+$/)?t.toInt():t}));for(var e=this.form.businessData.data,i=t.length-1,s=0;s<=i;s++){var o=t[s];if(!o&&0!==o)return null;if(!["object","array"].contains(o2.typeOf(e)))return null;if(s===i)return e[o];e=e[o]}},setBusinessDataById:function(t){if(this.json.id.indexOf("..")<1)this.form.businessData.data[this.json.id]=t;else{var e=this.json.id.split("..");e=e.map((function(t){return t.test(/^\d+$/)?t.toInt():t}));for(var i=this.form.businessData.data,s=e.length-1,o=0;o<=s;o++){var n=e[o];if(!n&&0!==n)return;if(o===s)i[n]=t;else{var a=e[o+1];if("number"===o2.typeOf(a)){if(i[n]||"array"===o2.typeOf(i[n])||(i[n]=[]),a>i[n].length)return}else i[n]&&"object"===o2.typeOf(i[n])||(i[n]={});i=i[n]}}}},_queryLoaded:function(){},_afterLoaded:function(){},setValue:function(){},focus:function(){this.node.focus()},_getModuleByPath:function(t){if(t){var e=this.json.id.split("..");if(t.contains("*")){for(var i=t.split("."),s=0;s<i.length;s++)if(i[s].contains("*")&&e[s]){var o=i[s].replace("*",e[s]);o=this.form.Macro.exec("return "+o,this),i[s]=(o||"").toString()}t=i.join("..")}else if(t.contains("./")){var n=t.substring(t.indexOf("./")+2,t.length),a=(t.substring(0,t.indexOf("./"))+".").split(".").length-1,r=Array.clone(e);if(r.length>2*a){for(s=0;s<a;s++)r.pop(),s>0&&r.pop();t=r.join("..")+".."+n}else r[r.length-1]=n,t=r.join("..")}return this.form.all[t]}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.$Input=MWF.APP$Input=new Class({Implements:[Events],Extends:MWF.APP$Module,iconStyle:"personfieldIcon",initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this._loadNode(),"show"===this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):(this.node.getFirst()||this.node).addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadNode:function(){this.readonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(e-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&(this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none"),this.clickSelect()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)}))},checkDescription:function(){this.node.getFirst().get("value")?this.descriptionNode&&this.descriptionNode.setStyle("display","none"):this.descriptionNode&&this.descriptionNode.setStyle("display","block")},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",border:"0px"},readonly:!0}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,readonly:!0,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:this.clickSelect.bind(this)}}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this))},_loadStyles:function(){if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},_computeValue:function(t){return this.json.defaultValue&&this.json.defaultValue.code?this.form.Macro.exec(this.json.defaultValue.code,this):t||""},getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();return t||(t=this._computeValue()),t||""},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",t||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,t},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(){},_afterLoaded:function(){this.readonly||this.json.isReadonly||this.loadDescription()},isReadonly:function(){return!(!this.readonly&&!this.json.isReadonly)},getTextData:function(){var t=this.node.getFirst()?this.node.getFirst().get("value"):this.node.get("text");return{value:[t||""],text:[(this.node.getFirst()?this.node.getFirst().get("text"):this.node.get("text"))||t||""]}},isEmpty:function(){var t=this.getData();return!t||!t.trim()},getData:function(t){return"save"==this.json.compute&&this._setValue(this._computeValue()),this.getInputData()},getInputData:function(){return this.node.getFirst()?this.node.getFirst().get("value"):this._getBusinessData()},resetData:function(){this.setData(this.getValue())},setData:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setData(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setData(t)},__setData:function(t){this._setBusinessData(t),this.node.getFirst()?(this.node.getFirst().set("value",t),this.checkDescription(),this.validationMode()):this.node.set("text",t),this.moduleValueAG=null},createErrorNode:function(t){var e;if(this.form.json.errorStyle){if("notice"===this.form.json.errorStyle.type)this.form.errorNoticing||(this.form.errorNoticing=!0,this.form.notice(t,"error",this.node,null,null,{onClose:function(){this.form.errorNoticing=!1}.bind(this)}));else if(e=new Element("div",{styles:this.form.json.errorStyle.node,text:t}),this.form.json.errorStyle.close)new Element("div",{styles:this.form.json.errorStyle.close,events:{click:function(){this.destroy()}.bind(e)}}).inject(e)}else{e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{height:"20px","line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e)}return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border-color","red"),this.errNode=this.createErrorNode(t),this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node);for(var e=this.node;null===e.offsetParent;)e=e.getParent();e.isIntoView()||e.scrollIntoView()}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==(e.get("MWFtype")||e.get("mwftype"))&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData(),s="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.readonly&&!this.json.isReadonly){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);if(this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"!=i.toString())return this.notValidationMode(i),!1}return!0}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Div=MWF.APPDiv=new Class({Extends:MWF.APP$Module}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridMobile=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","hidden"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.createMobileTable(),this.editable=!this.readonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._loadEditDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._loadReadDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},createMobileTable:function(){var t=new Element("table").inject(this.node);t.set(this.json.properties);var e=this.table.getElements("tr"),i=e[0].getElements("th"),s=e[1].getElements("td");i.each(function(e,i){var o=t.insertRow();new Element("th").inject(o).set({html:e.get("html"),id:e.get("id"),mwftype:e.get("mwftype")}),new Element("td").inject(o).set({html:s[i].get("html"),id:s[i].get("id"),mwftype:s[i].get("mwftype")});var n=this.form._getDomjson(e);n&&!1===n.isShow&&o.hide()}.bind(this)),this.table.destroy(),this.table=null,this.table=t},_loadStyles:function(){this.node.setStyles(this.json.styles),this.node.getElements("table").each(function(t){t.setStyles(this.json.tableStyles)}.bind(this))},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.isAG||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||[]},getValue:function(){return this._getValue()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var s=0;s<i.json.itemValues.length;s++){var o=i.json.itemValues[s].split(/\|/),n=o[0];if(e===(o.length>1?o[1]:o[0]))return n}break;case"Radio":var a=i.node.getElements("input");for(s=0;s<a.length;s++)if(a[s].value==e)return a[s].get("showText");break;case"Checkbox":a=i.node.getElements("input");var r=[];for(s=0;s<a.length;s++)-1!=e.indexOf(a[s].value)&&r.push(a[s].get("showText"));if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var l=[];return e.each(function(t){"object"===typeOf(t)?l.push(t.name+(t.unitName?"("+t.unitName+")":"")):l.push(t)}.bind(this)),l.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var d=new RegExp("\n","g"),c=new RegExp("<","g"),h=new RegExp(">","g");e=e.replace(c,"&lt").replace(h,"&gt").replace(d,"<br/>")}return e},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),(function(){}));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,s){var o=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?o.inject(this.totalDiv,"before"):o.inject(this.node),this._createItemTitleNode(o,s);var n=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(o),a=new Element("table").inject(n);a.set(this.json.properties),a.store("data",t),e.each(function(e,o){var n=a.insertRow(o),r=new Element("th").inject(n);r.set("text",e.get("text")),r.setStyle("width","30%");var l=n.insertCell(1);l.set("MWFId",i[o].get("id"));var d=t[e.get("id")];if("array"!==typeOf(d))if(d)for(key in d){var c=d[key],h=this.editModules[o];h&&"ImageClipper"==h.json.type?this._createImage(l,h,c):!h||"Attachment"!=h.json.type&&"AttachmentDg"!=h.json.type?(text=this._getValueText(o,c),h&&"Textarea"==h.json.type?l.set("html",text):l.set("text",text)):this._createAttachment(l,h,c);break}else l.setStyle("text-align","left"),l.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&n.hide()}.bind(this))}.bind(this)),t&&t()},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data.length?(this.addAction&&this.addAction.setStyle("display","none"),this.gridData.data.each(function(t,s){var o=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?o.inject(this.totalDiv,"before"):o.inject(this.node),this._createItemTitleNode(o,s);var n=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(o),a=new Element("table").inject(n);a.set(this.json.properties),a.store("data",t),e.each(function(e,o){var n=a.insertRow(o),r=new Element("th").inject(n);r.set("text",e.get("text")),r.setStyle("width","30%");var l=n.insertCell(1);l.set("MWFId",i[o].get("id"));var d=t[e.get("id")];if("array"!==typeOf(d))if(d)for(key in d){var c=d[key],h=this.editModules[o];h&&"ImageClipper"==h.json.type?this._createImage(l,h,c):!h||"Attachment"!=h.json.type&&"AttachmentDg"!=h.json.type?(text=this._getValueText(o,c),h&&"Textarea"==h.json.type?l.set("html",text):l.set("text",text)):this._createAttachment(l,h,c);break}else l.setStyle("text-align","left"),l.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&n.hide()}.bind(this));o.getSize()}.bind(this))):this.addAction?this.addable&&this.addAction.setStyle("display","block"):this.addable&&this._loadAddAction(),t&&t()},_loadActions:function(t){var e=new Element("div",{styles:this.form.css.mobileDatagridActionNode}).inject(t),i=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(e);this.deleteable||i.hide();var s=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit}).inject(e),o=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add}).inject(e);this.addable||o.hide();var n=new Element("div",{styles:this.form.css.mobileDatagridCancelActionNode,text:MWF.xApplication.process.Xform.LP.cancelEdit}).inject(e),a=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit}).inject(e),r=this;this.deleteable&&i.addEvent("click",(function(t){r._deleteLine(this.getParent().getParent().getParent(),t)})),s.addEvent("click",(function(t){r._editLine(this.getParent().getParent().getParent(),t)})),a.addEvent("click",(function(t){r._completeLineEdit()})),n.addEvent("click",(function(t){r._cancelLineEdit(t)})),this.addable&&o.addEvent("click",(function(t){r._addLine()}))},_createImage:function(t,e,i){(t.empty(),i)&&new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top").setStyles({"max-width":"90%"})},_createAttachment:function(t,e,i){t.empty();var s={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(s.readonly=!0),this.editable||this.addable||(s.readonly=!0);i.each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var o=new MWF.xApplication.process.Xform.AttachmentController(t,e,s);o.load(),i.each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;o.addAttachment(e)}.bind(this))},_createItemTitleNode:function(t,e){var i=e+1,s=new Element("div",{styles:this.json.itemTitleStyles}).inject(t);s.setStyle("overflow","hidden");new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item+i}).inject(s);0!=this.editable&&this._loadActions(s)},_createHelpNode:function(){this.helpNode=new Element("div",{styles:this.form.css.mobileGridHelpNode}).inject(this.node,"top"),this.helpContentNode=new Element("div",{styles:this.form.css.mobileGridHelpContentNode}).inject(this.helpNode),this.helpContentNode.set("html",MWF.xApplication.process.Xform.LP.mobileGridHelp),new mBox.Tooltip({content:this.helpContentNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.helpNode,transition:"flyin",position:{x:["right"],y:["center"]},event:"click"})},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.currentEditLine=t;var e=t.getElement("table");if(this.currentEditLine){this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.table.inject(e,"after"),e.setStyle("display","none");var i=this.currentEditLine.getFirst("div").getLast("div").getElements("div");i[0]&&i[0].setStyle("display","none"),i[1]&&i[1].setStyle("display","none"),i[2]&&i[2].setStyle("display","none"),i[3]&&i[3].setStyle("display","block"),i[4]&&i[4].setStyle("display","block");var s=this.currentEditLine.getElement("table").retrieve("data");this.table.getElements("th").each(function(t,e){var i=t.get("id"),o=this.editModules[e];o&&("sequence"==o.json.type?o.node.set("text",this.currentEditLine.getElement("table").getElements("tr")[e].getElement("td").get("text")):s[i]?o.setData(s[i][o.json.id]):o.setData(null))}.bind(this)),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},_loadAddAction:function(){this.addAction||(this.addAction=new Element("div",{styles:this.form.css.gridMobileActionNode}).inject(this.node,"top"),this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.addEvent("click",function(){this._addLine()}.bind(this)))},_addLine:function(){if(this.isEdit&&!this._completeLineEdit())return!1;this.addAction&&this.addAction.setStyle("display","none");var t,e=this.node.getElements("table"),i=new Element("div.datagridDataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?(t=e.length-2,i.inject(this.totalDiv,"before")):(t=e.length-1,i.inject(this.node)),this._createItemTitleNode(i,t);var s=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(i);this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.currentEditLine=null,this.table.inject(s),this.isEdit=!0;var o=i.getFirst("div").getLast("div").getElements("div");o[0]&&o[0].setStyle("display","none"),o[1]&&o[1].setStyle("display","none"),o[2]&&o[2].setStyle("display","none"),o[3]&&o[3].setStyle("display","block"),o[4]&&o[4].setStyle("display","block"),i.isIntoView()||i.scrollIntoView(!0),this.validationMode(),this.fireEvent("addLine",[this.table])},_cancelLineEdit:function(t){var e=this,i=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){if(e.isEdit=!1,e.currentEditLine){e.currentEditLine.getElement("table").setStyle("display","table");var s=e.currentEditLine.getFirst("div").getLast("div").getElements("div");s[0]&&this.deleteable&&s[0].setStyle("display","block"),s[1]&&s[1].setStyle("display","block"),s[2]&&this.addable&&s[2].setStyle("display","block"),s[3]&&s[3].setStyle("display","none"),s[4]&&s[4].setStyle("display","none"),e._editorTrGoBack()}else{var o=t.target.getParent(".datagridDataDiv");e._editorTrGoBack(),o&&o.destroy()}e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.currentEditLine=null,i.gridData.data.length||(i.addAction?i.addable&&i.addAction.setStyle("display","block"):i.addable&&i._loadAddAction()),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e,i=!1,s={},o=null;if(this.currentEditLine){o=this.currentEditLine,s=o.getElement("table").retrieve("data"),this.currentEditLine.getElement("table").setStyle("display","table"),e=o.getElement("table"),(n=this.currentEditLine.getFirst("div").getLast("div").getElements("div"))[0]&&this.deleteable&&n[0].setStyle("display","block"),n[1]&&n[1].setStyle("display","block"),n[2]&&this.addable&&n[2].setStyle("display","block"),n[3]&&n[3].setStyle("display","none"),n[4]&&n[4].setStyle("display","none")}else{var n,a=this.table.getParent(".datagridDataDiv");a&&a.removeClass("datagridDataDiv").addClass("dataDiv"),(n=this.table.getParent().getPrevious("div").getLast("div").getElements("div"))[0]&&this.deleteable&&n[0].setStyle("display","block"),n[1]&&n[1].setStyle("display","block"),n[2]&&this.addable&&n[2].setStyle("display","block"),n[3]&&n[3].setStyle("display","none"),n[4]&&n[4].setStyle("display","none"),(e=new Element("table",{styles:this.json.tableStyles}).inject(this.table,"before")).set(this.json.properties),s={}}var r=this.node.getElements("table"),l=this.table.getElements("th"),d=this.table.getElements("td"),c=e.getElements("tr");return l.each(function(t,o){var n=c[o],a=t.get("id"),l=this.editModules[o];if(l){var h,u;if("sequence"==l.json.type)this.currentEditLine?h=this.currentEditLine.getElement("table").getElements("tr")[o].getElement("td").get("text"):(h=r.length-1,this.totalTable&&(h=r.length-2)),p={value:[h],text:[h]};else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type){i=!0;var p=l.getTextData();s[a]||(s[a]={}),s[a][l.json.id]=p}else(p=l.getTextData()).value.length<2?(s[a]||(s[a]={}),s[a][l.json.id]=p.value[0]):(s[a]||(s[a]={}),s[a][l.json.id]=p.value);if(n)if(u=n.getElement("td"),"ImageClipper"==l.json.type)this._createImage(u,l,p.text);else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type)this._createAttachment(u,l,p);else{var m=this._getValueText(o,p.text.join(", "));l&&"Textarea"==l.json.type?u.set("html",m):u.set("text",m)}else{n=e.insertRow(o);var f=new Element("th").inject(n);f.set("text",t.get("text")),f.setStyle("width","30%"),(u=n.insertCell(1)).set("MWFId",d[o].get("id"));p[t.get("id")];if("ImageClipper"==l.json.type)this._createImage(u,l,p.text);else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type)this._createAttachment(u,l,p);else{m=this._getValueText(o,p.text.join(", "));l&&"Textarea"==l.json.type?u.set("html",m):u.set("text",m)}}}else if(!n){n=e.insertRow(o);var g=new Element("th").inject(n);g.set("text",t.get("text")),g.setStyle("width","30%"),u=n.insertCell(1)}var b=this.form._getDomjson(t);b&&!1===b.isShow&&n.hide(),l=null}.bind(this)),e.store("data",s),e.setStyle("display","table"),this.currentEditLine=null,this._editorTrGoBack(),this.getData(),this._loadDatagridStyle(),this.validationMode(),this.fireEvent("completeLineEdit",[e]),this.addAction&&(this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.removeEvents("click"),this.addAction.addEvent("click",function(){this._addLine()}.bind(this))),i&&this.form.saveFormData(),!0},_editorTrGoBack:function(){this.table.setStyle("display","none"),this.table.inject(this.node,"top")},_actionMousedown:function(t,e){t.retrieve("editStatus")||t.store("editStatus",new Date),this._checkMouseDown(t)},_checkMouseDown:function(t){var e=t.retrieve("editStatus");e&&((new Date).getTime()-e.getTime()>1e3?(this._editLine(t),t.eliminate("editStatus")):window.setTimeout(function(){this._checkMouseDown(t)}.bind(this),1e3))},_actionMouseup:function(t,e){t.eliminate("editStatus")},actionTouchstart:function(t,e){var i={x:e.touches[0].pageX,y:e.touches[0].pageY};t.retrieve("action")?t.store("touchStatus",{p:i,status:"hide",isHide:!1}):t.store("touchStatus",{p:i,status:"show"}),this._actionMousedown(t,e)},actionTouchmove:function(t,e){var i=t.retrieve("touchStatus"),s=i.p,o=i.status,n=e.touches[0].pageX,a=e.touches[0].pageY;(Math.abs(s.x-n)>10||Math.abs(s.y-a)>10)&&this._actionMouseup(t),"show"==o?s.x-n>20&&Math.abs(s.y-a)<40&&(this.showMoveAction(t,s.x-n),e.preventDefault()):n-s.x>20&&Math.abs(s.y-a)<40&&(i.isHide=!0,this.hideMoveAction(t,n-s.x),e.preventDefault())},actionTouchend:function(t,e){var i=t.retrieve("touchStatus");i.p;"show"==i.status?t.retrieve("action")&&this.showEndMoveAction(t):i.isHide&&this.hideEndMoveAction(t)},actionTouchcancel:function(t,e){this._actionMouseup(t)},showEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","60px"),new Fx.Tween(i,{duration:100}).start("margin-right","60px");var s=this;e.addEvent("click",(function(e){s._deleteLine(t,e)}))},_deleteLine:function(t,e){var i=!1,s=t.getElement("table");if(s){var o=this,n=this;this.form.confirm("warn",e,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){n.fireEvent("deleteLine",[s]);var e=s.retrieve("data");n.table.getElements("th").each((function(t,s){var o=t.get("id"),a=n.editModules[s];o&&a&&("Attachment"==a.json.type||"AttachmentDg"==a.json.type)&&(i=!0,e[o][a.json.id].each((function(t){n.form.workAction.deleteAttachment(t.id,n.form.businessData.work.id)})))})),t.destroy(),o._loadSequence(),o._loadTotal(),o.getData(),n.gridData.data.length||(n.addAction?n.addable&&n.addAction.setStyle("display","block"):n.addable&&n._loadAddAction()),this.close(),n.fireEvent("afterDeleteLine"),i&&n.form.saveFormData()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},hideEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","0px"),new Fx.Tween(i,{duration:100}).start("margin-right","0px").chain((function(){e.destroy(),t.eliminate("action")}))},showMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div");if(!i){var o=t.getSize();i=new Element("div",{styles:this.form.css.gridMobileDeleteActionAreaNode}).inject(t,"top");new Element("div",{styles:this.form.css.gridMobileDeleteActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(i);i.setStyle("height",o.y+"px"),i.setStyle("line-height",o.y+"px"),t.store("action",i)}e>60&&(e=60),i.setStyle("width",e+"px"),s.setStyle("margin-right",e+"px")},hideMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div"),o=60-e;o<0&&(o=0),i&&i.setStyle("width",o+"px"),s.setStyle("margin-right",o+"px")},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.table&&(this.json.editStyles&&this.table.getElements("td").setStyles(this.json.editStyles))},loadGridTitleStyle:function(){this.json.titleStyles&&this.node.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.node.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){(this.json.zebraColor||this.json.backgroundColor)&&this.node.getElements("table").each(function(t){this._loadTableZebraStyle(t)}.bind(this))},_loadTableZebraStyle:function(t){for(var e=t.getElements("tr"),i=0;i<e.length;i++)this.json.backgroundColor&&e[i].setStyle("background-color",this.json.backgroundColor),i%2==0&&this.json.zebraColor&&e[i].setStyle("background-color",this.json.zebraColor)},createTotalDiv:function(){this.totalDiv=new Element("div.totalDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node),new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv).set("text",MWF.xApplication.process.Xform.LP.amount);var t=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(this.totalDiv);this.totalTable=new Element("table",{styles:this.json.tableStyles}).inject(t),this.totalTable.set(this.json.properties)},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalDiv||this.createTotalDiv();for(var e=[],i=this.node.getElements("table"),s=1;s<i.length-1;s++){var o=i[s].getElements("td");this.totalModules.each(function(i,s){e[s]||e.push(0);var n=new Decimal(e[s]);if("number"==i.type){var a=o[i.index].get("text").toFloat();n=n.plus(a||0)}"count"==i.type&&(n=n.plus(1)),e[s]=n.toString(),t[i.module.json.id]=e[s]}.bind(this))}var n=this.totalTable.getElements("tr");if(this.totalModules.each(function(t,i){var s=n[i];if(s)s.getElement("td").set("text",e[i]||"");else{s=this.totalTable.insertRow(i);var o=new Element("th").inject(s);o.set("text",t.module.node.get("text")),o.setStyles(this.json.titleStyles),s.insertCell(1).setStyles(this.json.amountStyles).set("text",e[i]||"")}!1===t.isShow&&s.hide(),this.totalResaults[t.module.json.id]=e[i]}.bind(this)),this.totalTable)this.totalTable.getElements("th").setStyles(this.json.titleStyles)}return t},_loadSequence:function(){this.node.getElements("table").each(function(t,e){t.getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}.bind(this)),this.node.getElements(".sequenceDiv").each((function(t,e){t.set("text",MWF.xApplication.process.Xform.LP.item+(e+1))}))},_loadBorderStyle:function(){this.json.border&&this.node.getElements("table").each(function(t){this._loadTableBorderStyle(t)}.bind(this))},_loadTableBorderStyle:function(t){t.setStyles({"border-top":this.json.border,"border-left":this.json.border}),t.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),t.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),t.store("module",s),this.form.modules.push(s)}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none")}.bind(this)):(this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none"))},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit){if(this.isEdit=!1,this.currentEditLine)this._editorTrGoBack(),this.currentEditLine.destroy();else{var e=this.node.getElement(".datagridDataDiv");this._editorTrGoBack(),e&&e.destroy()}this.currentEditLine=null}if(this.gridData){for(var i=this.node.getElements(".dataDiv"),s=0;s<i.length;s++){for(var o=i[s].getElement("table"),n=o.getElements("td"),a=0;a<n.length;a++){var r=n[a].retrieve("module");r&&(this.form.modules.erase(r),r=null)}for(var l=o.getElements("th"),d=0;d<l.length;d++){var c=l[d].retrieve("module");c&&(this.form.modules.erase(c),c=null)}}for(s=0;s<i.length;s++)i[s].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.node.getElements("table"),i=1;i<(this.totalTable?e.length-1:e.length);i++){var s=e[i].retrieve("data");s&&t.push(s)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px","text-align":"left",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.DatagridMobile$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:this.node.getParent("tr").rowIndex,type:this.json.total,isShow:this.json.isShow})}}),MWF.xApplication.process.Xform.DatagridMobile$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}}),t.empty()}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t),i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),s.dataModule=this,this.dataGrid.editModules.push(s)}.bind(this))}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridPC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine","export","import","validImport"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.editable=!this.readonly&&!0!==this.json.isReadonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.importenable=this.editable&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable="impexp"===this.json.impexpType||"exp"===this.json.impexpType,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._addTitleActionColumn(),this._loadEditDatagrid(function(){this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._getDatagridEditorTr(),this._loadReadDatagrid(function(){this.editorTr&&this.editorTr.setStyle("display","none"),this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},_loadStyles:function(){this.table.setStyles(this.json.tableStyles),this.node.setStyles(this.json.styles)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||{}},getValue:function(){return this._getValue()},_getDatagridTr:function(){this._getDatagridTitleTr(),this._getDatagridEditorTr()},_getDatagridTitleTr:function(){return this.titleTr=this.table.getElement("tr"),this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");return this.editorTr=t[t.length-1],this.editorTr.addClass("datagridEditorTr"),this.editorTr},_addTitleActionColumn:function(){this.titleTr||this._getDatagridTitleTr(),this.editorTr||this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom"),this.addable&&this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e),this.deleteable&&this._createCancelAction(e),new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.titleTr.getElements("th"),i=this.editorTr.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,s){var o=$(this.table.insertRow(s+1));o.store("data",t),e.each(function(n,a){var r=t[n.get("id")],l="";if("array"!==typeOf(r))for(key in r){var d=r[key];l=this._getValueText(a-1,d);break}this._createNewEditTd(o,a,i[a].get("id"),l,e.length-1,s)}.bind(this))}.bind(this)),this.editorTr.setStyle("display","none"),t&&t()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var s=0;s<i.json.itemValues.length;s++){var o=i.json.itemValues[s].split(/\|/),n=o[0];if(e===(o.length>1?o[1]:o[0]))return n}break;case"Radio":var a=i.node.getElements("input");for(s=0;s<a.length;s++)if(a[s].value==e)return a[s].get("showText");break;case"Checkbox":a=i.node.getElements("input");var r=[];for(s=0;s<a.length;s++)-1!=e.indexOf(a[s].value)&&r.push(a[s].get("showText"));if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var l=[];return e.each(function(t){"object"===typeOf(t)?l.push(t.name+(t.unitName?"("+t.unitName+")":"")):l.push(t)}.bind(this)),l.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var d=new RegExp("\n","g"),c=new RegExp("<","g"),h=new RegExp(">","g");e=e.replace(c,"&lt").replace(h,"&gt").replace(d,"<br/>")}return e},_createNewEditTd:function(t,e,i,s,o,n){var a=$(t.insertCell(e));if(0==e)a.setStyles(this.form.css.gridLineActionCell),this.addable&&this._createAddLineAction(a),this.deleteable&&this._createDelLineAction(a);else if(e==o)a.setStyles(this.form.css.gridMoveActionCell),this._createMoveLineAction(a);else{a.set("MWFId",i),(l=this.editModules[e-1])&&"ImageClipper"==l.json.type?this._createImage(a,l,s):l&&"Image"==l.json.type?this._createImg(a,l,n):l&&"Button"==l.json.type?this._createButton(a,l,n):l&&"Label"==l.json.type?this._createLabel(a,l,n):!l||"Attachment"!=l.json.type&&"AttachmentDg"!=l.json.type?l&&"Textarea"==l.json.type?a.set("html",s):a.set("text",s):this._createAttachment(a,l,s),l&&["Button"].contains(l.json.type)||a.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var r=this.form._getDomjson(a);if(r){a.store("dataGrid",this);var l=this.form._loadModule(r,a);a.store("module",l),this.form.modules.push(l),!1===r.isShow&&a.hide()}},_createAddLineAction:function(t){new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}}).inject(t)},_createDelLineAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}}).inject(t)},_createCompleteAction:function(t){new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}}).inject(t)},_createCancelAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._cancelLineEdit(t)}.bind(this)}}).inject(t)},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;if(this.currentEditLine=t.getParent("tr"),this.currentEditLine){this.editorTr.setStyles({display:"table-row"}),this.editorTr.inject(this.currentEditLine,"before"),this.currentEditLine.setStyle("display","none");var e=this.currentEditLine.retrieve("data");this.titleTr.getElements("th").each(function(t,i){var s=t.get("id"),o=this.editModules[i-1];o&&("sequence"==o.json.type?o.node.set("text",o.node.getParent("tr").rowIndex):o.setData&&(e[s]?o.setData(e[s][o.json.id]):o.setData(null)))}.bind(this));var i=this.currentEditLine.getElements("td").indexOf(t),s=this.editModules[i-1];s&&s.focus(),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_cancelLineEdit:function(t){var e=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){e.currentEditLine&&e.currentEditLine.setStyle("display","table-row"),e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.isEdit=!1,e.currentEditLine=null,e._editorTrGoBack(),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e=!0,i=!1,s={},o=null;this.currentEditLine?(o=this.currentEditLine,s=this.currentEditLine.retrieve("data")):(o=new Element("tr").inject(this.editorTr,"before"),s={});var n=this.titleTr.getElements("th"),a=this.editorTr.getElements("td"),r=o.getElements("td");(n.each(function(t,l){var d=r[l],c=t.get("id"),h=this.editModules[l-1];if(h){if("sequence"==h.json.type){e=!1;var u=o.rowIndex,p={value:[u],text:[u]}}else if("Attachment"==h.json.type||"AttachmentDg"==h.json.type){i=!0,e=!1;p=h.getTextData();s[c]||(s[c]={}),s[c][h.json.id]=p}else if(h.getTextData){(p=h.getTextData()).value[0]&&(e=!1),p.value.length<2?(s[c]||(s[c]={}),s[c][h.json.id]=p.value[0]):(s[c]||(s[c]={}),s[c][h.json.id]=p.value)}if(p)if(d)if("ImageClipper"==h.json.type)this._createImage(d,h,p.text[0]);else if("Attachment"==h.json.type||"AttachmentDg"==h.json.type)this._createAttachment(d,h,p);else{var m=this._getValueText(l-1,p.text.join(", "));"Textarea"==h.json.type?d.set("html",m):d.set("text",p.text.join(", "))}else if("Attachment"==h.json.type||"AttachmentDg"==h.json.type)this._createNewEditTd(o,l,a[l].get("id"),p,n.length-1);else{m=this._getValueText(l-1,p.text.join(", "));this._createNewEditTd(o,l,a[l].get("id"),m,n.length-1)}else d||this._createNewEditTd(o,l,c,"",n.length-1)}else d||this._createNewEditTd(o,l,c,"",n.length-1);h=null}.bind(this)),o.store("data",s),o.setStyle("display","table-row"),e&&o.destroy(),this.currentEditLine=null,this._editorTrGoBack(),this.json.contentStyles)&&o.getElements("td").setStyles(this.json.contentStyles);return this.json.actionStyles&&o.getFirst().setStyles(this.json.actionStyles),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence(),this.getData(),this.validationMode(),this.fireEvent("completeLineEdit",[o]),i&&this.form.saveFormData(),!0},_createImg:function(t,e,i){this._cloneModule(t,e,i)},_createLabel:function(t,e,i){this._cloneModule(t,e,i)},_createButton:function(t,e,i){this._cloneModule(t,e,i)},_cloneModule:function(t,e,i){if(t.empty(),e.node&&e.json){var s=Object.clone(e.json);s.id=s.id+"_"+i;var o=e.node.clone();o.set("id",s.id),o.inject(t),this.form._loadModule(s,o)}},_createImage:function(t,e,i){if(t.empty(),i){var s=new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top");if("size"==e.json.clipperType){var o=e.json.imageWidth,n=e.json.imageHeight;o&&n&&s.setStyles({width:o+"px",height:n+"px"})}}},_createAttachment:function(t,e,i){t.empty();var s={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(s.readonly=!0),this.editable||this.addable||(s.readonly=!0);(i||[]).each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var o=new MWF.xApplication.process.Xform.AttachmentController(t,e,s);o.load(),(i||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;o.addAttachment(e)}.bind(this))},_editorTrGoBack:function(){if(this.editorTr.setStyle("display","none"),this.totalTr)this.editorTr.inject(this.totalTr,"before");else{var t=this.table.getElements("tr"),e=t[t.length-1];this.editorTr.inject(e,"after")}},_addLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.editorTr.setStyles({display:"table-row"}),this.currentEditLine=null;var e=t.getParent("tr");e&&this.editorTr.inject(e,"after"),this.isEdit=!0,this.validationMode(),this.fireEvent("addLine",[this.editorTr])},_deleteLine:function(t){var e=!1,i=t.target.getParent("tr");if(i){var s=i.getStyle("background");i.store("bgcolor",s),i.tween("background-color","#ffd4d4");var o=this,n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){n.fireEvent("deleteLine",[i]);var t=i.retrieve("data");n.titleTr.getElements("th").each((function(i,s){var o=i.get("id"),a=s>0?n.editModules[s-1]:null;o&&a&&("Attachment"==a.json.type||"AttachmentDg"==a.json.type)&&(t[o][a.json.id].each((function(t){n.form.workAction.deleteAttachment(t.id,n.form.businessData.work.id)})),e=!0)})),i.destroy(),o._loadZebraStyle(),o._loadSequence(),o._loadTotal(),o.getData(),this.close(),n.fireEvent("afterDeleteLine"),e&&n.form.saveFormData()}),(function(){var t=i.retrieve("bgcolor");i.tween("background",t),this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},_createMoveLineAction:function(t){new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}}).inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table").getParent("div"),i=e.getSize(),s=e.clone().setStyle("width",i.x).inject(document.body),o=s.getElement("table");o.empty();var n=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(o),a=t.getElements("td"),r=n.getElements("td");a.each((function(t,e){var i=t.getComputedSize();r[e].setStyle("width",i.width+1)}));var l=t.getCoordinates();return s.setStyles(this.form.css.gridMoveLineDragNode),s.setStyles(l),s},_moveLine:function(t){var e=this.table.getElements("tr"),i=t.target.getParent("tr"),s=this._getMoveDragNode(i);coordinates=s.getCoordinates();var o=s.getElement("tr"),n=s.getElement("table"),a=i.getStyle("background");i.store("bgcolor",a),i.tween("background-color","#e4f6e9"),new Drag.Move(s,{droppables:e.erase(i),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();var s=i.retrieve("bgcolor");s?i.tween("background",s):i.tween("background","transparent"),i.setStyle("display","table-row"),null!=e&&(i.inject(o,"after"),o.destroy(),this._loadDatagridStyle(),this.getData())}.bind(this),onEnter:function(t,e){s.setStyle("display","none"),o.inject(e,"after")},onLeave:function(t,e){o.inject(n),s.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move"),s.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=i.retrieve("bgcolor");e?i.tween("background",e):i.tween("background","transparent"),i.setStyle("display","table-row")}}).start(t),i.setStyle("display","none")},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){this.titleTr||this._getDatagridTitleTr();var e=this.titleTr.getElements("th"),i=this.table.getElements("tr");i[i.length-1];this.gridData.data&&this.gridData.data.each(function(t,i){var s=this.table.insertRow(i+1);s.store("data",t),e.each(function(e,o){var n=s.insertCell(o),a=t[e.get("id")],r=this.editModules[o];if("array"!==typeOf(a))if(a)for(key in a){var l=a[key];if(r&&"ImageClipper"==r.json.type)this._createImage(n,r,l);else if(!r||"Attachment"!=r.json.type&&"AttachmentDg"!=r.json.type){var d=this._getValueText(o,l);r&&"Textarea"==r.json.type?n.set("html",d):n.set("text",d)}else this._createAttachment(n,r,l);break}else r&&"Image"==r.json.type?this._createImg(n,r,i):r&&"Button"==r.json.type?this._createButton(n,r,i):r&&"Label"==r.json.type?this._createLabel(n,r,i):r&&"sequence"==r.json.type&&(n.setStyle("text-align","center"),n.set("text",s.rowIndex));var c=this.form._getDomjson(e);c&&!1===c.isShow&&n.hide()}.bind(this))}.bind(this)),this._loadTotal(),t&&t()},_loadImportExportAction:function(){if(this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.exportenable||this.importenable){var t,e=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom",i=new Element("div").inject(this.node,e);if(this.importExportAreaNode=new Element("div").inject(i),["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"left"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"right"}):this.importExportAreaNode.setStyles({margin:"0px auto"}),this.exportenable)this.exportActionNode=new Element("div",{text:this.json.exportActionText||MWF.xApplication.process.Xform.LP.datagridExport}).inject(this.importExportAreaNode),t=this.json.exportActionStyles?this.json.exportActionStyles:this.form.css.gridExportActionStyles,this.exportActionNode.setStyles(t),this.exportActionNode.addEvent("click",function(){this.exportToExcel()}.bind(this));if(this.importenable)this.importActionNode=new Element("div",{text:this.json.importActionText||MWF.xApplication.process.Xform.LP.datagridImport}).inject(this.importExportAreaNode),t=this.json.importActionStyles?this.json.importActionStyles:this.form.css.gridImportActionStyles,this.importActionNode.setStyles(t),this.importActionNode.addEvent("click",function(){this.importFromExcel()}.bind(this));if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var s=2;this.exportActionNode&&(s=s+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(s=s+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",s+"px")}}},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridActionStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.editorTr&&(this.json.editStyles&&this.editorTr.getElements("td").setStyles(this.json.editStyles))},loadGridActionStyle:function(){0!=this.editable&&(this.json.actionStyles&&this.table.getElements("tr").each(function(t,e){0!=e&&t.getFirst().setStyles(this.json.actionStyles)}.bind(this)))},loadGridTitleStyle:function(){this.json.titleStyles&&this.titleTr.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.table.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++)t[e].hasClass("datagridTotalTr")||(this.json.backgroundColor&&t[e].setStyle("background-color",this.json.backgroundColor),e%2==0&&this.json.zebraColor&&t[e].setStyle("background-color",this.json.zebraColor))},createTotalTr:function(){var t=this.node.getElements("tr"),e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after"),this.node.getElements("th").each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);this.json.amountStyles&&i.setStyles(this.json.amountStyles);var s=this.form._getDomjson(t);s&&!1===s.isShow&&i.hide()}.bind(this))},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalTr||this.createTotalTr();for(var e=[],i=this.table.getElements("tr"),s=this.totalTr.getElements("td"),o=1;o<i.length;o++)if(!i[o].hasClass("datagridTotalTr")&&!i[o].hasClass("datagridEditorTr")){var n=i[o].getElements("td");this.totalModules.each(function(i,s){e[s]||e.push(0);var o=new Decimal(e[s]);if("number"==i.type){var a=n[i.index].get("text").toFloat();o=o.plus(a||0)}"count"==i.type&&(o=o.plus(1)),e[s]=o.toString(),t[i.module.json.id]=e[s]}.bind(this))}this.totalModules.each(function(t,i){this.totalResaults[t.module.json.id]=e[i],s[t.index].set("text",isNaN(e[i])?"":e[i])}.bind(this))}return t},_loadSequence:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++){t[e].getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}},_loadBorderStyle:function(){this.json.border&&(this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.table.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.table.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}))},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i),!1===e.isShow&&t.hide()}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),t.store("module",s),this.form.modules.push(s),!1===e.isShow&&t.hide()}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle()}.bind(this)):this._loadDatagridStyle()},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit&&(this.currentEditLine&&this.currentEditLine.setStyle("display","table-row"),this.isEdit=!1,this.currentEditLine=null,this._editorTrGoBack()),this.gridData){for(var e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var s=e[i];if(!s.hasClass("datagridEditorTr"))for(var o=s.getElements("td"),n=0;n<o.length;n++){var a=o[n].retrieve("module");a&&(this.form.modules.erase(a),a=null)}}for(i=1;i<e.length-1;i++)e[i].hasClass("datagridTotalTr")||e[i].hasClass("datagridEditorTr")||e[i].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var s=e[i].retrieve("data");s&&t.push(s)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t},isAvaliableImpExpColumn:function(t,e,i){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.json.type&&"sequence"!=e.json.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.json.type)))},getExportColWidthArray:function(){var t=this.titleTr.getElements("th"),e=[];return t.each(function(i,s){if(!this.editable||0!==s&&s!==t.length-1){var o=this.form._getDomjson(i),n=this.editModules[this.editable?s-1:s];this.isAvaliableImpExpColumn(o,n)&&(n&&["Org","Reader","Author","Personfield","Orgfield"].contains(n.json.type)?e.push(340):n&&"Address"===n.json.type?e.push(170):n&&"Textarea"===n.json.type?e.push(260):n&&"Htmleditor"===n.json.type?e.push(500):(n&&n.json.type,e.push(150)))}}.bind(this)),e},getExportDateIndexArray:function(){var t=this.titleTr.getElements("th"),e=[],i=0;return t.each(function(s,o){if(!this.editable||0!==o&&o!==t.length-1){var n=this.form._getDomjson(s),a=this.editModules[this.editable?o-1:o];this.isAvaliableImpExpColumn(n,a)&&(a&&"Calendar"===a.json.type&&e.push(i),i++)}}.bind(this)),e},getExportTitleArray:function(t){var e=this.titleTr.getElements("th"),i=[];return e.each(function(s,o){if(!this.editable||0!==o&&o!==e.length-1){var n=this.form._getDomjson(s),a=this.editModules[this.editable?o-1:o];this.isAvaliableImpExpColumn(n,a,t)&&i.push(s.get("text"))}}.bind(this)),i},exportToExcel:function(){var t,e=this.titleTr.getElements("th"),i=[],s=this.getExportTitleArray(),o=this.getExportColWidthArray(),n=this.getExportDateIndexArray();i.push(s),this.gridData.data&&this.gridData.data.each(function(t,s){var o=[];e.each(function(i,s){if(!this.editable||0!==s&&s!==e.length-1){var n=this.editModules[this.editable?s-1:s],a=this.form._getDomjson(i);if(this.isAvaliableImpExpColumn(a,n)){var r=t[i.get("id")],l="";if(r){if("array"!==typeOf(r))for(key in r){var d=r[key];if(n&&["Org","Reader","Author","Personfield","Orgfield"].contains(n.json.type))if("array"===typeOf(d)){var c=[];d.each(function(t){"object"===typeOf(t)?c.push(t.distinguishedName):c.push(t)}.bind(this)),l=c.join(", \n")}else l="object"===typeOf(d)?d.distinguishedName:d;else l=n&&"Textarea"===n.json.type?d:this._getValueText(this.editable?s-1:s,d);break}}else n&&"Label"===n.json.type&&n.node&&(l=n.node.get("text"));l||"number"===typeOf(l)||(l=""),o.push(l)}}}.bind(this)),i.push(o)}.bind(this));var a=(t=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(a[a.length-1].toLowerCase())&&a.splice(a.length-1),t=a.join(".");var r={data:i,colWidthArray:o,title:t};this.fireEvent("export",[r]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,r.title||t,o,n)},importFromExcel:function(){var t=[],e=[],i=this.titleTr.getElements("th"),s=1,o=[];i.each(function(n,a){if(!this.editable||0!==a&&a!==i.length-1){var r=this.editModules[this.editable?a-1:a],l=this.form._getDomjson(n);this.isAvaliableImpExpColumn(l,r,"import")&&(t.push({text:n.get("text").trim(),index:s,thJson:l,module:r}),s++,r&&"Calendar"===r.json.type?e.push(s):r&&["Org","Reader","Author","Personfield","Orgfield"].contains(r.json.type)&&o.push(n.get("text")))}}.bind(this)),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).upload(e,function(e){var i=function(){this.checkImportedData(t,e)?this.setImportData(t,e):this.openImportedErrorDlg(t,e)}.bind(this);o.length>0?this.listImportAllOrgData(o,e,function(){i()}.bind(this)):i()}.bind(this))},parseImportedData:function(t,e){var i={data:[]};return e.each(function(e,s){var o={};t.each(function(t,i){t.index;var s,n=t.module,a=t.thJson,r=t.text,l=e[r]||"";switch(n.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if(l){var d=l.split(/\s*,\s*/g);s=[],d.each(function(t,e){var i=this.getImportOrgData(t);s.push(i)}.bind(this))}else s=[];break;case"Combox":case"Address":d=l.split(/\s*,\s*/g),s=d;break;case"Checkbox":d=l.split(/\s*,\s*/g);var c=n.getOptionsObj();d.each((function(t,e){var i=c.textList.indexOf(t);d[e]=i>-1?c.valueList[i]:""})),s=1===d.length?d[0]:d;break;case"Radio":case"Select":s=l.replace(/&#10;/g,"");var h=(c=n.getOptionsObj()).textList.indexOf(s);s=h>-1?c.valueList[h]:"";break;case"Textarea":s=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if(s=l.replace(/&#10;/g,""))u=n.json.format?n.json.format:"datetime"===n.json.selectType||"time"===n.json.selectType?"time"===n.json.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,s=Date.parse(s).format(u);break;default:s=l.replace(/&#10;/g,"")}o[a.id]={},o[a.id][n.json.id]=s}.bind(this)),i.data.push(o)}.bind(this)),i},setImportData:function(t,e){var i=this.parseImportedData(t,e);this.fireEvent("import",[i]),this.setData(i),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openImportedErrorDlg:function(t,e){var i=this,s=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},o=["<table "+s(this.json.properties)+" style='"+s(this.json.tableStyles,"style")+"'>"],n=s(this.json.titleStyles,"style");o.push("<tr>"),t.each((function(t,e){o.push("<th style='"+n+"'>"+t.text+"</th>")})),o.push("<th style='"+n+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),o.push("</tr>");var a=Object.clone(this.json.contentStyles);a["border-bottom"]||a.border||(a["border-bottom"]="1px solid #eee");var r=s(Object.merge(a,{"text-align":"left"}),"style");e.each(function(e,i){o.push("<tr>"),t.each((function(t,i){o.push("<td style='"+r+"'>"+(e[t.text]||"").replace(/&#10;/g,"<br/>")+"</td>")})),o.push("<td style='"+r+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),o.push("</tr>")}.bind(this)),o.push("</table>");var l=new Element("div",{style:"padding:10px;",html:o.join("")}),d=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:l,offset:{y:0},isMax:!0,width:1e3,height:700,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){i.exportWithImportDataToExcel(t,e)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}],onPostClose:function(){d=null}.bind(this)})},exportWithImportDataToExcel:function(t,e){this.titleTr.getElements("th");var i=[],s=this.getExportColWidthArray();s.push(220);var o,n=this.getExportDateIndexArray(),a=this.getExportTitleArray("import");a.push(MWF.xApplication.process.Xform.LP.validationInfor),i.push(a),e.each(function(e,s){var o=[];t.each((function(t,i){o.push((e[t.text]||"").replace(/&#10;/g,"\n"))})),o.push(e.errorTextListExcel?e.errorTextListExcel.join("\n"):""),i.push(o)}.bind(this));var r=(o=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(r[r.length-1].toLowerCase())&&r.splice(r.length-1),o=r.join(".");var l={data:i,colWidthArray:s,title:o,withError:!0};this.fireEvent("export",[l]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,l.title||o,s,n)},checkImportedData:function(t,e){var i=!0,s=this.parseImportedData(t,e),o=MWF.xApplication.process.Xform.LP,n=o.importValidationColumnText,a=o.importValidationColumnTextExcel,r=new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this);e.each(function(e,l){var d=s&&s.data?s.data[l]:{},c=[],h=[];t.each(function(t,i){var s=t.index,l=t.module,u=t.thJson,p=t.text,m=n.replace("{n}",s),f=a.replace("{n}",r.index2ColName(s-1)),g=e[p]||"",b="",y=d[u.id];if("object"===typeOf(y)&&(b=y[l.json.id]),g)switch(l.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":g.split(/\s*,\s*/g).each(function(t,e){var i=this.getImportOrgData(t);i.errorText&&(c.push(m+i.errorText+o.fullstop),h.push(f+i.errorText+o.fullstop))}.bind(this));break;case"Number":isNaN(g)&&(c.push(m+g+o.notValidNumber+o.fullstop),h.push(f+g+o.notValidNumber+o.fullstop));break;case"Calendar":isNaN(g)&&!isNaN(Date.parse(g))||(c.push(m+g+o.notValidDate+o.fullstop),h.push(f+g+o.notValidDate+o.fullstop))}if("sequence"!=l.json.type&&l.setData&&"Address"!==l.json.type){var v=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(l.json.type)&&"array"===o2.typeOf(b)&&b.length&&(v=b.some((function(t){return t.errorText}))),v||(l.setData(b),l.validationMode(),!l.validation()&&l.errNode&&(c.push(m+l.errNode.get("text")),h.push(f+l.errNode.get("text")),l.errNode.destroy()))}}.bind(this)),c.length>0&&(e.errorTextList=c,e.errorTextListExcel=h,i=!1)}.bind(this));var l={validted:i,data:e};return this.fireEvent("validImport",[l]),l.validted},getImportOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMapImported[t]||this.personMapImported[t]||this.unitMapImported[t]||this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listImportAllOrgData:function(t,e,i){var s=[],o=[],n=[],a=[];if(t.length>0){var r,l,d,c;e.each((function(e,i){t.each((function(t,i){e[t]&&e[t].split(/\s*,\s*/g).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s.push(t);break;case"@p":o.push(t);break;case"@u":n.push(t);break;case"@g":a.push(t);break;default:s.push(t),o.push(t),n.push(t),a.push(t)}}))}))}));var h=function(){r&&l&&d&&c&&i&&i()};this.identityMapImported={},s.length?o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:s},function(t){t.data.each(function(t){this.identityMapImported[t.matchKey]=t}.bind(this)),r=!0,h()}.bind(this)):(r=!0,h()),this.personMapImported={},o.length?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:o},function(t){t.data.each(function(t){this.personMapImported[t.matchKey]=t}.bind(this)),l=!0,h()}.bind(this)):(l=!0,h()),this.unitMapImported={},n.length?o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){t.data.each(function(t){this.unitMapImported[t.matchKey]=t}.bind(this)),d=!0,h()}.bind(this)):(d=!0,h()),this.groupMapImported={},a.length?o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMapImported[t.matchKey]=t}.bind(this)),c=!0,h()}.bind(this)):(c=!0,h())}}}),MWF.xApplication.process.Xform.DatagridPC$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:0!=this.dataGrid.editable?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}),MWF.xApplication.process.Xform.DatagridPC$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t);if(e){var i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),s.dataModule=this,this.dataGrid.editModules.push(s)}}.bind(this))}}}),MWF.xApplication.process.Xform.DatagridPC.ExcelUtils=new Class({initialize:function(t){this.datagrid=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var o=new Uint8Array(s.result),n=o.byteLength,a=0;a<n;a++)e+=String.fromCharCode(o[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=o.files;if(t.length){var n=t.item(0);if(n.name.indexOf(" ")>-1)return this.form.notice(MWF.xApplication.process.Xform.LP.uploadedFilesCannotHaveSpaces,"error"),!1;this.importFromExcel(n,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var o=s.getFirst();o.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var o=window.xlsxUtils.format2Sheet(t,0,0,null),n=window.xlsxUtils.format2WB(o,"sheet1",void 0),a=n.Sheets[n.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var d=a[l];if(d.s||(d.s={}),d.s.alignment||(d.s.alignment={}),d.s.alignment.wrapText=!0,s&&s.length){var c=l.replace(/\d+/g,"");l.replace(c,"")>1&&s.contains(c)&&(d.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(n),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,o,n=new FileReader;n.onload=function(t){o=t?t.target.result:n.content;var a=(s=window.XLSX.read(o,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var r=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var d=r["!ref"].split(":");2===d.length&&(l=parseInt(d[1].replace(/[^0-9]/gi,"")))}if(l)for(var c=0;c<i.length;c++)for(var h=1;h<=l;h++){var u=r[i[c]+h];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},n.readAsBinaryString(t)}))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Textfield=MWF.APPTextfield=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"textFieldIcon",_loadUserInterface:function(){this._loadNode(),"show"===this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(e-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus(),this.node.getFirst().fireEvent("click")}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",display:"block",border:"0px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle]}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){var t=this.getInputData("change");this._setBusinessData(t),this.validationMode(),this.validation()&&(this._setBusinessData(t),this.fireEvent("change"))}.bind(this)),this.json.ANNModel&&(this.node.getFirst().addEvent("focus",function(){o2.Actions.get("x_query_assemble_surface").calculateNeural(this.json.ANNModel,this.form.businessData.work.id,function(t){var e=t.data.filter(function(t){var e=this.node.getFirst().get("value");return t.score>.1&&-1===e.indexOf(t.value)}.bind(this));e.length&&(this.modelNode||this.createModelNode(),this.modelNode.getLast().empty(),this.modelNode.show(),this.modelNode.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft"}),e.each(function(t){new Element("div",{text:t.value,styles:this.form.css.modelItemNode}).inject(this.modelNode.getLast()).addEvents({mouseover:function(){this.setStyle("color","#0000ff")},mouseout:function(){this.setStyle("color","#a31515")},mousedown:function(t){var e=this.node.getFirst().get("value");this.node.getFirst().set("value",e?e+", "+t.target.get("text"):t.target.get("text")),this.modelNode.hide()}.bind(this)})}.bind(this)))}.bind(this))}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.modelNode&&this.modelNode.hide()}.bind(this))),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},createModelNode:function(){this.modelNode=new Element("div",{styles:this.form.css.modelNode}).inject(this.node,"after"),new Element("div",{styles:this.form.css.modelNodeTitle,text:MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode),new Element("div",{styles:this.form.css.modelNodeContent,text:MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode)},getInputData:function(){if(!this.node.getFirst())return this._getBusinessData();var t=this.node.getElement("input").get("value");if("number"==this.json.dataType){var e=t.toFloat();return isNaN(e)?0:e}return t}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Button=MWF.APPButton=new Class({Implements:[Events],Extends:MWF.APP$Module,iconStyle:"personfieldIcon",_loadUserInterface:function(){var t=this.node.getElement("button");t||(t=new Element("button")),t.inject(this.node,"after"),this.node.destroy(),this.node=t,this.node.set({id:this.json.id,text:this.json.name||this.json.id,MWFType:this.json.type}),this.json.preprocessing||this.node.setStyles(this.form.css.buttonStyles)}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.Xform.Org=MWF.APPOrg=new Class({Implements:[Events],Extends:MWF.APP$Input,options:{moduleEvents:["load","queryLoad","postLoad","change","select"],selectorEvents:["queryLoadSelector","postLoadSelector","queryLoadContent","postLoadContent","queryLoadCategory","postLoadCategory","selectCategory","unselectCategory","queryLoadItem","postLoadItem","selectItem","unselectItem","change","expand","collapse"],readonly:!0},iconStyle:"orgIcon",getTextData:function(){var t=this.getValue(),e=[];return"object"===typeOf(t)&&(t=[t]),"array"===typeOf(t)?(t.each(function(t){"string"===typeOf(t)?e.push(t):e.push(t.name+(t.unitName?"("+t.unitName+")":""))}.bind(this)),{value:t||"",text:[e.join(",")]}):{value:[""],text:[""]}},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadNode:function(){this.field=!0,this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.APPOrg.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.APPOrg.UnitOptions(this.form,this.json)),this.selectTypeList.contains("group")&&(this.groupOptions=new MWF.APPOrg.GroupOptions(this.form,this.json))},_valueMerge:function(t,e){return"function"==o2.typeOf(e)?e.then(function(e){this._valueMerge(t,e)}.bind(this),(function(){})):t.concat(e)},_computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){if(s.code&&(i=this.form.Macro.exec(s.code,this)),i){var o="array"==o2.typeOf(i)?i:[i],n=Promise.all(o).then(function(e){var i=e.distinguishedName||e;"array"==o2.typeOf(e)&&(i=e[0].distinguishedName||e[0]);var o='return this.org.getDuty("'+s.name+'", "'+i+'", true)',n=i?this.form.Macro.exec(o,this):"",a="array"==o2.typeOf(n)?"all":"resolve";return Promise[a](n).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this)).catch((function(){console.log("catch error : can not get duty : "+s.name,NaN+i)}))}.bind(this),(function(){}));e.push(n)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var o=this.form.Macro.exec(this.json.defaultValue.code,this);"array"==o2.typeOf(o)?o.each((function(t){e.push(t)})):e.push(o)}return e},__computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){if(s.code&&(i=this.form.Macro.exec(s.code,this)),i&&i.isAG){var o=o2.AG.all(i).then(function(e){var i="";e&&e.length&&(i=e[0].distinguishedName||e[0]);var o='return this.org.getDuty("'+s.name+'", "'+i+'", true)',n=this.form.Macro.exec(o,this);o2.AG.all(n).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this))}.bind(this));e.push(o)}else{var n='return this.org.getDuty("'+s.name+'", "'+i+'", true)',a=this.form.Macro.exec(n,this);o=o2.AG.all(a).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this));e.push(o)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var o=this.form.Macro.exec(this.json.defaultValue.code,this);o&&o.isAG?e.push(o):("array"!==typeOf(o)&&(o=o?[o]:[]),o.each(function(i){var s;i&&("string"===typeOf(i)?(this.getOrgAction()[this.getValueMethod(i)](function(e){s=MWF.org.parseOrgData(e.data,!0,t)}.bind(this),null,i,!1),e.push(s)):e.push(i))}.bind(this)))}return this.json.count>0?e.slice(0,this.json.count):e},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},getOptions:function(){var t=this;if(0===this.selectTypeList.length)return!1;var e,i,s,o=this.getInputData()||[],n=[];if(this.json.exclude){var a=this.form.Macro.exec(this.json.exclude.code,this);n="array"===typeOf(a)?a:[a]}this.identityOptions&&(e=this.identityOptions.getOptions(),"all"!==this.json.identityRange&&(e.noUnit||e.units&&e.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange,"error",this.node),e.disabled=!0)),!e.noUnit&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(e.dutys&&e.dutys.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange,"error",this.node),e.disabled=!0)),e.values=this.json.isInput?[]:o,e.exclude=n,this.form.json.selectorStyle&&(e=Object.merge(e,this.form.json.selectorStyle))),this.unitOptions&&(i=this.unitOptions.getOptions(),"all"!==this.json.unitRange&&(i.units&&i.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange,"error",this.node),i.disabled=!0)),i.values=this.json.isInput?[]:o,i.exclude=n,this.form.json.selectorStyle&&(i=Object.merge(i,this.form.json.selectorStyle))),this.groupOptions&&((s=this.groupOptions.getOptions()).values=this.json.isInput?[]:o,s.exclude=n,this.form.json.selectorStyle&&(s=Object.merge(s,this.form.json.selectorStyle)));var r={};if(this.json.events&&"object"===typeOf(this.json.events)&&Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.selectorEvents.indexOf(e)&&("postLoadSelector"===e?this.addEvent("loadSelector",function(e){return this.form.Macro.fire(t.code,e)}.bind(this)):"queryLoadSelector"===e?r.onQueryLoad=function(e){return this.form.Macro.fire(t.code,e)}.bind(this):r["on"+e.capitalize()]=function(e){return this.form.Macro.fire(t.code,e)}.bind(this))}.bind(this)),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0],onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this,this.selector)},onClose:this.selectOnClose.bind(this)},r,e||i||s);if(this.selectTypeList.length>1){var l={type:"",types:this.selectTypeList,onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this)},onClose:this.selectOnClose.bind(this)};return this.form.json.selectorStyle&&(l=Object.merge(l,this.form.json.selectorStyle)),e&&(l.identityOptions=Object.merge({},r,e)),i&&(l.unitOptions=Object.merge({},r,i)),s&&(l.groupOptions=Object.merge({},r,s)),l}},selectOnComplete:function(t){var e=[];t.each(function(t){e.push(t.data)}.bind(this));var i="simple"===this.json.storeRange;this.checkEmpower(e,function(t){var e=[];t.each(function(t){e.push(MWF.org.parseOrgData(t,!0,i))}.bind(this)),this.json.isInput?this.addData(e):this.setData(e),this.validationMode(),this.validation();var s=this.getValue();s.then?s.then(function(){this.fireEvent("select")}.bind(this),(function(){})):this.fireEvent("select")}.bind(this))},selectOnCancel:function(){this.validation()},selectOnLoad:function(t){this.descriptionNode&&this.descriptionNode.setStyle("display","none"),this.fireEvent("loadSelector",[t])},selectOnClose:function(){v=this._getBusinessData(),v&&v.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")},clickSelect:function(t){if(!this.readonly)if(layout.mobile)setTimeout(function(){var t=this.getOptions();t&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,t)))}.bind(this),100);else{var e=this.getOptions();e&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,e)))}},resetData:function(){var t=this.getValue();this.setData(t)},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this.node.retrieve("data")},_loadNodeRead:function(){this.node.empty();new Element("div").inject(this.node);this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div"),i="simple"===this.json.storeRange;if(t.data){var s=t.data;if(this.selectTypeList.contains("identity")&&"person"===this.json.identityResultType){var o=s.distinguishedName||s;"i"===o.substr(o.length-1,1).toLowerCase()&&MWF.Actions.get("x_organization_assemble_express").listPersonWithIdentity({identityList:[o]},function(e){e.data.length>0&&(s.person&&(e.data[0].id=s.person),t.data=MWF.org.parseOrgData(e.data[0],!0,i),t.value=this.getDataText(t.data),t.node&&t.node.set("text",t.value))}.bind(this),null,!1)}t.data&&(t.data.createTime||t.data.updateTime)&&(t.data=MWF.org.parseOrgData(t.data,!0,i));var n="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":n=t.data.name+"("+t.data.unitName+")";break;case"@p":n=t.data.name+(t.data.employee?"("+t.data.employee+")":"");break;case"@u":n=t.data.levelName;break;case"@g":n=t.data.name;break;default:n=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:n})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},getSearchOptions:function(){if(0===this.selectTypeList.length)return!1;var t,e,i;if(this.identityOptions&&(t=this.identityOptions.getSearchOptions()),this.unitOptions&&(e=this.unitOptions.getSearchOptions()),this.groupOptions&&(i=this.groupOptions.getOptions()),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0]},t||e||i);if(this.selectTypeList.length>1){var s={type:"",types:this.selectTypeList};return t&&(s.identityOptions=t),e&&(s.unitOptions=e),i&&(s.groupOptions=i),s}},_searchOptions:function(t,e){var i=this.getSearchOptions();this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){this.node.setStyle("overflow","visible");var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:function(t){this.clickSelect(t)}.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.node.getFirst().setStyle("height","auto"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},getDataText:function(t){if("string"==typeOf(t))return t;var e="";switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":e=t.name+"("+t.unitName+")";break;case"@p":e=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":e=t.name;break;default:e=t.name}return e},addData:function(t){if(!t)return!1;var e="simple"===this.json.storeRange;t.each(function(t){var i,s=typeOf(t);"string"===s&&(this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,t,!1),i&&this.combox.addNewValue(this.getDataText(i),i));if("object"===s){var o=MWF.org.parseOrgData(t,!0,e);this.combox.addNewValue(this.getDataText(o),o)}}.bind(this))},checkChange:function(t,e){var i=!1;if(e||(e=[]),t.length&&e&&e.length)if(t.length===e.length){for(var s=0;s<t.length;s++)if(t[s].distinguishedName!==e[s].distinguishedName||t[s].name!==e[s].name||t[s].unique!==e[s].unique){i=!0;break}}else i=!0;else(e.length||t.length)&&(i=!0);i&&this.fireEvent("change")},setData:function(t){if(!t)return!1;var e=this.getData();1!=t.length||t[0]||(t=[]),this._setValue(t).then(function(t){o2.promiseAll(t).then(function(t){this.checkChange(e,t)}.bind(this),(function(){}))}.bind(this),(function(){}))},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitShow||", ");var s=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),o="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":o=t.value.name+"("+t.value.unitName+")";break;case"@p":o=t.value.name+(t.value.employee?"("+t.value.employee+")":"");break;case"@u":o=t.value.levelName;break;case"@g":o=t.value.name;break;default:o=t.value.name}var n=new Element("div").set({styles:{"font-size":"14px",color:""},text:o});new mBox.Tooltip({content:n,setStyles:{content:{padding:15,lineHeight:20}},attach:s,transition:"flyin"})}return s},_setValue:function(t){var e=[],i=[],s="simple"===this.json.storeRange;"array"!==typeOf(t)&&(t=t?[t]:[]);var o=o2.promiseAll(t).then(function(t){return"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){if(t)if("string"===typeOf(t)){var o=this.getOrgAction()[this.getValueMethod(t)](function(t){return MWF.org.parseOrgData(t.data,!0,s)}.bind(this),null,t,!0).catch((function(t){console.log("error:"+t),console.log(t)}));i.push(o)}else e.push(t)}.bind(this))}.bind(this)),i.length?o2.promiseAll(i).then(function(t){return e=e.concat(t),!0,this.__setValue(e),e}.bind(this),(function(){})):(!0,this.__setValue(e),e)}.bind(this),(function(){}));return this.moduleValueAG=o,o&&o.then&&o.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this)),o},__setValue:function(t){this.moduleValueAG=null,1!=t.length||t[0]||(t=[]),this.json.count>0&&(t=t.slice(0,this.json.count));var e,i=[],s=[],o=typeOf(t),n="simple"===this.json.storeRange;if("array"===o&&t.each(function(t){var e=null,o=typeOf(t);if("string"===o){var a=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),a,t,!1)}if("object"===o&&(e=t),e){var r=MWF.org.parseOrgData(e,!0,n);i.push(r),s.push({text:this.getDataText(r),value:r})}}.bind(this)),"string"===o){var a,r=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){a=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),r,t,!1),a&&(i.push(a),s.push({text:this.getDataText(a),value:a}))}if("object"===o){var l=MWF.org.parseOrgData(t,!0,n);i.push(l),s.push({text:this.getDataText(l),value:l})}(this.node.store("data",i),this._setBusinessData(i),this.json.isInput)?this.combox?(this.combox.clear(),this.combox.addNewValues(s)):(e=this.node.getFirst())&&(e.empty(),s.each(function(t,i){this.creteShowNode(t,i===s.length-1).inject(e)}.bind(this))):this.node.getFirst()?((e=this.node.getFirst()).empty(),this.loadOrgWidget(i,e)):(this.node.empty(),this.loadOrgWidget(i,this.node))},getValueMethod:function(t){if(t)switch(t.substr(t.length-2,2).toLowerCase()){case"@i":return"getIdentity";case"@p":return"getPerson";case"@u":return"getUnit";case"@g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var s=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||s||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){var s,o=t.distinguishedName.substr(t.distinguishedName.length-2,2),n=Object.clone(t);if(this.json.displayTextScript&&this.json.displayTextScript.code){this.currentData=n;var a=this.form.Macro.exec(this.json.displayTextScript.code,this);a&&(n.displayName=a),this.currentData=null}switch(o.toLowerCase()){case"@i":s=new MWF.widget.O2Identity(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@p":s=new MWF.widget.O2Person(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@u":s=new MWF.widget.O2Unit(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@g":s=new MWF.widget.O2Group(n,e,{style:"xform",lazy:!0,disableInfor:i});break;default:s=new MWF.widget.O2Other(n,e,{style:"xform",lazy:!0,disableInfor:i})}s.field=this,layout.mobile&&s.node.setStyles({float:"none"})}.bind(this))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},checkEmpower:function(t,e){"array"===typeOf(t)&&this.identityOptions&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType?new MWF.APPOrg.EmpowerChecker(this.form,this.json).load(t,e):e&&e(t)}}),MWF.APPOrg.EmpowerChecker=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.css=this.form.css,this.checkedAllItems=!0},load:function(t,e,i){if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var s=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&s.push(t.distinguishedName))}.bind(this)),s.length>0?o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:s},function(s){var o=[];s.data.each((function(t){t.fromIdentity!==t.toIdentity&&o.push(t)})),o.length>0?this.openSelectEmpowerDlg(o,t,e,i):e&&e(t)}.bind(this),function(){e&&e(t)}.bind(this)):e&&e(t)}else e&&e(t)},getIgnoreEmpowerArray:function(t){var e=[];return this.empowerSelectNodes&&this.empowerSelectNodes.length&&this.empowerSelectNodes.each(function(t){if(!t.retrieve("isSelected")){var i=t.retrieve("data");e.push(i.fromIdentity)}}.bind(this)),t&&t(e),e},setIgnoreEmpowerFlag:function(t,e){for(var i=this.getIgnoreEmpowerArray(),s=0;s<t.length;s++){var o=t[s];i.indexOf(o.distinguishedName)>-1?o.ignoreEmpower=!0:o.ignoreEmpower&&delete o.ignoreEmpower}e&&e(t)},replaceEmpowerIdentity:function(t,e){var i={};if(this.empowerSelectNodes.each(function(t){if(t.retrieve("isSelected")){var e=t.retrieve("data");i[e.fromIdentity]=e}}.bind(this)),0===Object.keys(i).length)e(t);else{var s=[];for(var o in i)s.push(i[o].toIdentity);o2.Actions.get("x_organization_assemble_express").listIdentity({identityList:s},(function(s){var o=t.clone(),n={};s.data.each((function(t){n[t.distinguishedName]=t}));for(var a=0;a<o.length;a++){var r=o[a];r.distinguishedName&&i[r.distinguishedName]&&n[i[r.distinguishedName].toIdentity]&&(o[a]=n[i[r.distinguishedName].toIdentity])}e(o)}),(function(){e(t)}))}},openSelectEmpowerDlg:function(t,e,i,s){layout.mobile?this.openSelectEmpowerDlg_mobile(t,e,i,s):this.openSelectEmpowerDlg_pc(t,e,i,s)},openSelectEmpowerDlg_mobile:function(t,e,i,s){var o=[],n=[];if(t.each(function(t){o.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity}),n.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity})}.bind(this)),0!==o.length){var a=Array.clone(o);o2.xDesktop.requireApp("Template","Selector.Custom",function(){var t={count:0,title:MWF.xApplication.process.Xform.LP.selectEmpower,selectAllEnable:!0,selectableItems:o,expand:!1,category:!1,values:n,zIndex:3001,closeOnclickOk:!0,onComplete:function(t){var s=[];t.each(function(t){s.push(t.data.id)}.bind(this));var o=[];a.each((function(t){-1===s.indexOf(t.id)&&o.push(t.id.split("#")[0])}));for(var n=0;n<e.length;n++){var r=e[n];o.indexOf(r.distinguishedName)>-1?r.ignoreEmpower=!0:r.ignoreEmpower&&delete r.ignoreEmpower}i&&i(e)}.bind(this)};this.form.json.selectorStyle&&Object.merge(t,this.form.json.selectorStyle),t.flatCategory=!1,new o2.xApplication.Template.Selector.Custom($(document.body),t).load()}.bind(this))}else i()},openSelectEmpowerDlg_pc:function(t,e,i,s){var o=new Element("div",{styles:this.css.empowerAreaNode}),n='<div style="line-height: 20px; color: #333333; overflow: hidden">'+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";n+='<div style="margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',o.set("html",n);var a=o.getLast();this.getEmpowerItems(a,t),o.inject(s||this.form.app.content);var r=o2.DL.open({title:MWF.xApplication.process.Xform.LP.selectEmpower,style:this.form.json.dialogStyle||"user",isResize:!0,content:o,width:630,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){this.setIgnoreEmpowerFlag(e,i),r.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){r.close()}}],onPostShow:function(){if(this.createSelectAllEmpowerNode().inject(r.button),layout.mobile){r.node.inject($(document.body)),r.node.setStyles({width:"100%",height:"100%",top:"0px",left:"0px"});var t=r.node.getSize().y-190;a.setStyle("height",t+"px"),r.options.contentHeight=r.node.getSize().y-100,r.setContentSize()}else{r.content.setStyle("overflow","hidden");t=Math.min(300,a.getSize().y),a.getStyle("margin-top"),a.getStyle("margin-bottom");a.setStyle("height",t+"px"),r.options.contentHeight=t+30+20,r.setContentSize(),r.node.setStyles({height:r.options.height+"px"}),r.reCenter()}}.bind(this)})},getEmpowerItems:function(t,e){var i=this;this.empowerSelectNodes=[];var s,o=1;e.each(function(e){if(e.fromIdentity!=e.toIdentity){o%2==1?(s=new Element("div",{styles:this.css.empowerItemOddNode}).inject(t)).store("nodeType","Odd"):(s=new Element("div",{styles:this.css.empowerItemEvenNode}).inject(t)).store("nodeType","Even"),o++,this.empowerSelectNodes.push(s),s.store("data",e);var n=new Element("div.empowerItemIconNode",{styles:this.css.empowerItemIconNode}).inject(s);s.store("iconNode",n);var a=new Element("div.empowerItemContentNode",{styles:this.css.empowerItemContentNode}).inject(s);new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.fromIdentity.split("@")[0]}).inject(a),new Element("div.empowerItemTitleNode",{styles:this.css.empowerItemTitleNode,text:MWF.xApplication.process.Xform.LP.empowerTo}).inject(a),new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.toIdentity.split("@")[0]}).inject(a);s.addEvents({mouseover:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node_over"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode_over)}},mouseout:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode)}},click:function(){this.retrieve("isSelected")?i.unselectEmpowerItem(this):i.selectEmpowerItem(this)}}),this.checkedAllItems&&s.click()}}.bind(this))},unselectEmpowerItem:function(t){t.store("isSelected",!1),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))},selectEmpowerItem:function(t){t.store("isSelected",!0),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node_selected"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e+"_selected"]&&t.setStyles(this.css[e+"_selected"])}.bind(this))},createSelectAllEmpowerNode:function(){var t=this,e=new Element("div",{styles:this.css.empowerSelectAllItemNode,text:MWF.xApplication.process.Xform.LP.selectAll});return e.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode)},click:function(){this.retrieve("isSelected")?(this.store("isSelected",!1),this.setStyles(t.css.empowerSelectAllItemNode),t.empowerSelectNodes.each(function(e){t.unselectEmpowerItem(e)}.bind(this))):(this.store("isSelected",!0),this.setStyles(t.css.empowerSelectAllItemNode_selected),t.empowerSelectNodes.each(function(e){t.selectEmpowerItem(e)}.bind(this)))}}),this.checkedAllItems&&(e.store("isSelected",!0),e.setStyles(t.css.empowerSelectAllItemNode_selected)),e}}),MWF.APPOrg.GroupOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.groupCount?this.json.groupCount:0;return"group"===this.json.groupRange?{count:t,storeRange:this.json.storeRange,include:this.getSelectRange(!0)}:{count:t,storeRange:this.json.storeRange}},getSearchOptions:function(){return{}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){var t=[];if(this.json.groupRangeKey&&this.json.groupRangeKey.code){var e=this.form.Macro.exec(this.json.groupRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),t=e}return t}}),MWF.APPOrg.UnitOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){return{count:this.json.unitCount?this.json.unitCount:0,units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,storeRange:this.json.storeRange,expandSubEnable:"no"!=this.json.unitExpandSubEnable}},getSearchOptions:function(){return{units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){if("unit"===this.json.unitRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.unitRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.unitRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.unitRangeUnit&&this.json.unitRangeUnit.length&&this.json.unitRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.unitRangeField&&this.json.unitRangeField.length&&this.json.unitRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.unitRangeKey&&this.json.unitRangeKey.code){var e=this.form.Macro.exec(this.json.unitRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],s=[];return i.each(function(t){"direct"===this.json.unitRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&s.push(e.woUnit)):"level"===this.json.unitRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.unitRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)):"type"===this.json.unitRangeNext&&("all"===this.json.unitRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.unitRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)),e=null}.bind(this)),s}}),MWF.APPOrg.IdentityOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.identityCount?this.json.identityCount:0;return this.json.identityOnlyUseInclude?{noUnit:!0,count:t,resultType:this.json.identityResultType,storeRange:this.json.storeRange,include:this._getInclude()}:{count:t,units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),expandSubEnable:"no"!=this.json.identityExpandSubEnable,resultType:this.json.identityResultType,categoryType:this.json.categoryType||"unit",dutyUnitLevelBy:this.json.dutyUnitLevelBy||"duty",storeRange:this.json.storeRange,include:this._getInclude()}},getSearchOptions:function(){return{units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),resultType:this.json.identityResultType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getInclude:function(){var t=[];if(this.json.identityIncludeKey){var e=this.form.Macro.exec(this.json.identityIncludeKey.code,this);e&&(t="array"===typeOf(e)?e:[e])}return t},_getSelectRange:function(){if("unit"===this.json.identityRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.identityRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.identityRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.identityRangeUnit&&this.json.identityRangeUnit.length&&this.json.identityRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.identityRangeField&&this.json.identityRangeField.length&&this.json.identityRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.identityRangeKey&&this.json.identityRangeKey.code){var e=this.form.Macro.exec(this.json.identityRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],s=[];return i.each(function(t){"direct"===this.json.identityRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&s.push(e.woUnit)):"level"===this.json.identityRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.identityRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)):"type"===this.json.identityRangeNext&&("all"===this.json.identityRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.identityRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)),e=null}.bind(this)),s},getSelectRangeDuty:function(t){return this.selectRangeDuty&&!t||(this.selectRangeDuty=this._getSelectRangeDuty()),this.selectRangeDuty},_getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},getScriptSelectDuty:function(){var t=[];if(this.json.rangeDuty&&this.json.rangeDuty.length){var e=this.json.rangeDuty;"string"===typeOf(e)&&(e=JSON.parse(e)),"array"===typeOf(e)&&e.each(function(e){var i="string"===typeOf(e)?e:e.id||e.name;i&&t.push(i)}.bind(this))}if(this.json.rangeDutyField&&this.json.rangeDutyField.length&&this.json.rangeDutyField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.rangeDutyKey&&this.json.rangeDutyKey.code){var i=this.form.Macro.exec(this.json.rangeDutyKey.code,this);"array"!==typeOf(i)&&(i=i?[i.toString()]:[]),i.each(function(e){e&&t.push(e)}.bind(this))}return t}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Actionbar=MWF.APPActionbar=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","afterLoad"]},reload:function(){this._loadUserInterface()},_loadUserInterface:function(){this.toolbarNode=this.node.getFirst("div"),this.toolbarNode&&(this.toolbarNode.empty(),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.toolbarNode,{style:this.json.style,onPostLoad:function(){this.fireEvent("afterLoad")}.bind(this)},this),this.json.actionStyles&&(this.toolbarWidget.css=this.json.actionStyles),this.json.multiTools){var t=!this.json.hideSystemTools&&!this.json.hideReadedAction,e=JSON.stringify(this.json.multiTools);if(e=o2.bindJson(e,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.multiTools=JSON.parse(e),this.json.multiTools.each(function(e){e.system?this.json.hideSystemTools||("action_readed"===e.id&&(t=!1),this.setToolbars([e],this.toolbarNode,this.readonly)):this.setCustomToolbars([e],this.toolbarNode)}.bind(this)),t){var i=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(i,this.toolbarNode,this.readonly)}this.toolbarWidget.load()}else if(this.json.hideSystemTools)this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load();else if(this.json.defaultTools){i=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.json.hideReadedAction||this.setToolbars(i,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}else MWF.getJSON(this.form.path+"toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),null)}.bind(this)))},setCustomToolbars:function(t,e){var i="../x_component_process_FormDesigner/Module/Actionbar/",s="";this.json.customIconStyle&&(s=this.json.customIconStyle+"/"),t.each(function(t){var o=!0;if(o=this.readonly?t.readShow:t.editShow){if(o=!0,t.control&&(o=this.form.businessData.control[t.control]),t.condition)o=!this.form.Macro.exec(t.condition,this);if(o){var n=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:i+""+this.form.options.style+"/custom/"+s+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(e);if(this.json.customIconOverStyle&&n.set("MWFButtonImageOver",i+""+this.form.options.style+"/custom/"+this.json.customIconOverStyle+"/"+t.img),t.properties&&n.set(t.properties),t.actionScript&&n.store("script",t.actionScript),t.sub){var a=e.getLast();this.setCustomToolbars(t.sub,a)}}}}.bind(this))},setToolbarItem:function(t,e,i,s){var o="../x_component_process_FormDesigner/Module/Actionbar/",n=!0;if(t.control&&(n=this.form.businessData.control[t.control]),!s&&t.condition){var a=this.form.Macro.exec(t.condition,this);n=n&&!a}if("action_downloadAll"!=t.id&&"action_print"!=t.id||this.form.businessData.work.startTime||(n=!1),"action_delete"==t.id&&(this.form.businessData.work&&this.form.businessData.work.id||(n=!1)),"action_rollback"==t.id&&(t.read=!0),i&&(t.read||(n=!1)),n){var r=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:o+(this.options.style||"default")+"/tools/"+(this.json.style||"default")+"/"+t.img,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(e);if(this.json.iconOverStyle&&r.set("MWFButtonImageOver",o+""+(this.options.style||"default")+"/tools/"+(this.json.iconOverStyle||"default")+"/"+t.img),t.properties&&r.set(t.properties),t.sub){var l=e.getLast();this.setToolbars(t.sub,l,i,s)}}},getItem:function(t){if(this.toolbarWidget&&t)return this.toolbarWidget.items[t]},getAllItem:function(){return this.toolbarWidget?this.toolbarWidget.childrenButton:[]},setToolbars:function(t,e,i,s){t.each(function(t){this.setToolbarItem(t,e,i,s)}.bind(this))},runCustomAction:function(t){var e=t.node.retrieve("script");this.form.Macro.exec(e,this)},saveWork:function(){this.form.saveWork()},closeWork:function(){this.form.closeWork()},processWork:function(){this.form.processWork()},resetWork:function(){this.form.resetWork()},retractWork:function(t,e){this.form.retractWork(t,e)},rerouteWork:function(t,e){this.form.rerouteWork(t,e)},deleteWork:function(){this.form.deleteWork()},printWork:function(){this.form.printWork()},readedWork:function(t,e){this.form.readedWork(e)},addSplit:function(t){this.form.addSplit(t)},rollback:function(t){this.form.rollback(t)},downloadAll:function(t){this.form.downloadAll(t)},pressWork:function(t){this.form.pressWork(t)},pauseTask:function(t){var e=this.form.pauseTask(t);e&&e.then(function(){t.setText(MWF.xApplication.process.Xform.LP.resume),t.options.action="resumeTask";var e=t.picNode.getElement("img"),i=e.get("src");i=i.substr(0,i.lastIndexOf("/")),i+="/resume.png",e.set("src",i)}.bind(this),(function(){}))},resumeTask:function(t){var e=this.form.resumeTask(t);e&&e.then(function(){t.setText(MWF.xApplication.process.Xform.LP.pause),t.options.action="pauseTask";var e=t.picNode.getElement("img"),i=e.get("src");i=i.substr(0,i.lastIndexOf("/")),i+="/pause.png",e.set("src",i)}.bind(this),(function(){}))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.require("MWF.widget.AttachmentController",null,!1),MWF.xApplication.process.Xform.AttachmentController=new Class({Extends:MWF.widget.ATTER,options:{officeFiles:["doc","docx","dotx","dot","xls","xlsx","xlsm","xlt","xltx","pptx","ppt","pot","potx","potm","pdf"],allowPreviewExtension:["zip","pdf","ofd","png","jpg","bmp","jpeg","gif","js","css","java","json","xml","php","html","htm","xhtml","log","md","txt"],checkTextEnable:!0},checkAttachmentDeleteAction:function(){if(this.options.readonly)return this.setAttachmentsAction("delete",!1),!1;if("n"!==this.options.isDeleteOption){if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,s=this.attachments[e];!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),"o"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.activity===this.module.form.businessData.activity.id&&s.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):s.data.control.allowEdit||s.data.person===t||(i=!1),i?this.setAttachmentAction(s,"delete",!0):this.setAttachmentAction(s,"delete",!1)}}else this.setAttachmentsAction("delete",!1)},checkDeleteAction:function(){if(this.checkAttachmentDeleteAction(),this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),!1;if("n"!==this.options.isDeleteOption)if(this.selectedAttachments.length){var t=layout.session.user.distinguishedName,e=!0;if("o"===this.options.isDeleteOption)for(var i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else if("a"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.activity!==this.module.form.businessData.activity.id){e=!1;break}}else if("ao"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.activity!==this.module.form.businessData.activity.id||s.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else for(i=0;i<this.selectedAttachments.length;i++){var s;if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}}e?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction))}else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction);else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)},checkPreviewAttAction:function(){if(this.options.isPreviewAtt)if(this.selectedAttachments.length){for(var t=!1,e=0;e<this.selectedAttachments.length;e++){var i=this.selectedAttachments[e];if(this.options.allowPreviewExtension.contains(i.data.extension)){t=!0;break}}t&&this.setActionEnabled(this.previewAttAction)}else this.setActionDisabled(this.previewAttAction);else this.setActionDisabled(this.previewAttAction)},isAttDeleteAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isDeleteOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity===this.module.form.businessData.activity.id&&t.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):t.data.control.allowEdit||t.data.person===e||(i=!1),i},openInOfficeControl:function(t,e){e&&(e.openedAttachment&&e.openedAttachment.id===t.id||(e.save(),this.module.form.businessData.workCompleted?MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(t.id,this.module.form.businessData.workCompleted.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this)):MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.id,this.module.form.businessData.work.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this))))},checkReplaceAction:function(){if(!this.options.isReplaceHidden){if(this.options.readonly)return this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),!1;if("n"!==this.options.isReplaceOption)if(this.selectedAttachments.length&&1===this.selectedAttachments.length){var t=this.selectedAttachments[0];!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid);var e=layout.session.user.distinguishedName,i=!0;"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction))}else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction);else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)}},replaceAttachment:function(t,e){var i=this.selectedAttachments[0].data;if(this.module.json.isOpenInOffice&&this.module.json.officeControlName&&-1!==this.options.officeFiles.indexOf(i.extension)){var s=this.module.form.all[this.module.json.officeControlName];s?(this.min_closeOfficeAction&&this.setActionEnabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionEnabled(this.closeOfficeAction),this.openInOfficeControl(i,s)):this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])}else this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},isAttReplaceAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isReplaceOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i},checkOrderAction:function(){if(this.options.readonly)return this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction),!1;if(this.attachments.length&&this.attachments.length>1){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.attachments.length;i++){var s=this.attachments[i];if(!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowControl&&!s.data.control.allowEdit&&s.data.person!==e){t=!1;break}}t?(this.setActionEnabled(this.orderAction),this.setActionEnabled(this.min_orderAction)):(this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction))}else this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction)},isAttOrderAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl&&t.data.control.allowEdit||t.data.person===e||(i=!1),i},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;!(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view")&&t.contains("config"))||this.module.json.isOpenInOffice&&this.module.json.officeControlName||(this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),this.isHiddenTop=!0),t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&this.createOfficeGroupActions(),t.contains("config")||this.createConfigGroupActions(),t.contains("view")||this.createViewGroupActions(),this.checkActions()},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkPreviewAttAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkConfigAction(),this.checkOrderAction(),this.checkListStyleAction()},checkAttachmentConfigAction:function(){if(this.options.readonly)return this.setAttachmentsAction("config",!1),!1;if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,s=this.attachments[e];!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),s.data.control.allowControl||s.data.person===t||(i=!1),i?this.setAttachmentAction(s,"config",!0):this.setAttachmentAction(s,"config",!1)}},checkConfigAction:function(){if(this.checkAttachmentConfigAction(),this.options.readonly)return this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction),!1;if(this.selectedAttachments.length){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowControl&&s.data.person!==e){t=!1;break}}t?this.setActionEnabled(this.configAction):this.setActionDisabled(this.configAction)}else this.setActionDisabled(this.configAction);if(this.checkTextAction&&(this.setActionDisabled(this.checkTextAction),this.selectedAttachments.length&&1===this.selectedAttachments.length)){var s=this.selectedAttachments[0];-1!==this.options.images.indexOf(s.data.extension.toLowerCase())&&this.setActionEnabled(this.checkTextAction)}},isAttConfigAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===e||(i=!1),i},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.previewAttAction=this.createAction(this.editActionsGroupNode,"previewAtt",o2.LP.widget.previewAtt,function(t,e){this.previewAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createConfigGroupActions:function(){this.configActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.configActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.configActionBoxNode),this.configAction=this.createAction(this.configActionsGroupNode,"config",MWF.LP.widget.configAttachment,function(t,e){this.configAttachment(t,e)}.bind(this)),this.options.checkTextEnable&&(this.checkTextAction=this.createAction(this.configActionsGroupNode,"check",MWF.LP.widget.checkOcrText,function(t,e){this.checkImageTex(t,e)}.bind(this))),this.createSeparate(this.configActionsGroupNode),this.orderAction=this.createAction(this.configActionsGroupNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this)),this.configAction&&this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction)},createOfficeGroupActions:function(){this.officeActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.officeActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.officeActionBoxNode),this.closeOfficeAction=this.createAction(this.officeActionsGroupNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",MWF.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("config")||(this.min_orderAction=this.createAction(this.minActionAreaNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this))),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&(this.min_closeOfficeAction=this.createAction(this.minActionAreaNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.min_closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},closeAttachmentOffice:function(){var t=this.module.form.all[this.module.json.officeControlName];t&&(t.openFile(),this.min_closeOfficeAction&&this.setActionDisabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction))},configAttachment:function(){var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentPermissionNode}).inject(this.node),s=new Element("div",{styles:e.attachmentPermissionNamesNode}).inject(i),o=(new Element("div",{styles:e.attachmentPermissionNamesTitleNode,text:t.attachmentPermissionInfo}).inject(s),new Element("div",{styles:e.attachmentPermissionNamesAreaNode}).inject(s));this.selectedAttachments.length&&this.selectedAttachments.each(function(t){new Element("div",{styles:e.attachmentPermissionAttNode,text:t.data.name}).inject(o)}.bind(this));var n=new Element("div",{styles:e.attachmentPermissionEditAreaNode}).inject(i),a=(new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentRead}).inject(n),new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n));new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentEdit}).inject(n);var r=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n);new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentController}).inject(n);var l=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n),d=o2.DL.open(Object.merge({title:t.attachmentPermission,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentConfig(a,r,l),d.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}]},this.module.form.json.dialogOptions||{}));if(1===this.selectedAttachments.length){var c=this.selectedAttachments[0].data,h=c.readUnitList||[],u=c.readIdentityList||[],p=c.editUnitList||[],m=c.editIdentityList||[],f=c.controllerUnitList||[],g=c.controllerIdentityList||[];a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:h.concat(u).trim()})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:p.concat(m).trim()})),l.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:f.concat(g).trim()}))}else a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),l.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]}))},setAttachmentConfig:function(t,e,i){if(this.selectedAttachments.length){var s=t.retrieve("data-value"),o=e.retrieve("data-value"),n=i.retrieve("data-value"),a=[],r=[],l=[],d=[],c=[],h=[];s&&s.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&a.push(e),"I"===s&&r.push(e)})),o&&o.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&l.push(e),"I"===s&&d.push(e)})),n&&n.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&c.push(e),"I"===s&&h.push(e)}));var u=0;this.selectedAttachments.each(function(t){t.data.readUnitList=a,t.data.readIdentityList=r,t.data.editUnitList=l,t.data.editIdentityList=d,t.data.controllerUnitList=c,t.data.controllerIdentityList=h,o2.Actions.get("x_processplatform_assemble_surface").configAttachment(t.data.id,this.module.form.businessData.work.id,t.data,function(){o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(t.data.id,this.module.form.businessData.work.id,function(e){var i=this.getAttachmentById(t.data.id);i&&(i.data=e.data,i.deleteAction&&!this.isAttDeleteAvailable(i)&&i.deleteAction.setStyle("display","none"),i.configAction&&!this.isAttConfigAvailable(i)&&i.configAction.setStyle("display","none")),++u===this.selectedAttachments.length&&this.checkActions()}.bind(this))}.bind(this))}.bind(this))}},checkImageTex:function(){if(this.selectedAttachments.length&&1==this.selectedAttachments.length){var t=this.selectedAttachments[0],e=MWF.xApplication.process.Xform.LP,i=this.module.form.css,s=new Element("div",{styles:i.attachmentOCRNode}).inject(this.node),o=new Element("div",{styles:i.attachmentOCRImageAreaNode}).inject(s),n=new Element("img",{styles:i.attachmentOCRImageNode}).inject(o);o2.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.data.id,this.module.form.businessData.work.id,(function(t){n.set("src",o2.filterUrl(t))}));var a=new Element("div",{styles:i.attachmentOCRInputAreaNode}).inject(s),r=new Element("textarea",{styles:i.attachmentOCRInputNode}).inject(a),l=o2.DL.open({title:e.attachmentOCRTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:s,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentOCR(r,t),l.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){l.close()}}]});t.data.ocr?r.set("text",t.data.ocr.text||""):o2.Actions.get("x_processplatform_assemble_surface").getAttachmentOCR(t.data.id,this.module.form.businessData.work.id,function(e){t.data.ocr=e.data,r.set("text",e.data.text||"")}.bind(this))}},setAttachmentOCR:function(t,e){var i=t.get("text");e.data.ocr||(e.data.ocr={}),e.data.ocr.text=i,o2.Actions.get("x_processplatform_assemble_surface").setAttachmentOCR(e.data.id,this.module.form.businessData.work.id,{text:i},function(){this.module.form.app.notice("success",lp.attachmentOCR_saved,this.node)}.bind(this))},checkMoveAction:function(t){if(t){var e=t.getFirst().getNext(),i=e.getFirst().show(),s=e.getLast().show();tmp=t.getPrevious(),tmp||i.hide(),tmp=t.getNext(),tmp||s.hide()}},sortByNumber:function(t){return t.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this))},orderAttachment:function(){if(this.attachments.length){this.attachments=this.sortByNumber(this.attachments);var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentOrderNode}),s=(new Element("div",{styles:e.attachmentOrderInforNode,text:t.attachmentOrderInfo}).inject(i),new Element("div",{styles:e.attachmentOrderAreaNode}).inject(i)),o=null;o2.getJSON("../x_component_File/$Main/icon.json",function(t){o=t}.bind(this),!1,!1),this.attachments.each(function(n,a){var r="../x_component_File/$Main/default/file/"+(o[n.data.extension.toLowerCase()]||o.unknow),l=new Element("div",{styles:e.attachmentOrderItemNode}).inject(s);l.store("att",n);var d=new Element("div",{styles:e.attachmentOrderItemIconNode}).inject(l);d.setStyle("background-image","url('"+r+"')");var c=new Element("div",{styles:e.attachmentOrderItemActionNode}).inject(l),h=(new Element("div",{styles:e.attachmentOrderItemTextNode,text:n.data.name}).inject(l),new Element("div",{styles:e.attachmentOrderItemActionUpNode,text:t.attachmentOrderUp}).inject(c)),u=new Element("div",{styles:e.attachmentOrderItemActionDownNode,text:t.attachmentOrderDown}).inject(c);0==a&&h.hide(),a==this.attachments.length-1&&u.hide(),h.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getPrevious();i&&(e.inject(i,"before"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),u.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getNext();i&&(e.inject(i,"after"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),l.addEvents({mouseover:function(t){this.setStyle("background-color","#f1f6fa")},mouseout:function(t){this.setStyle("background-color","#ffffff")}}),new Drag(l,{handle:d,snap:5,stopPropagation:!0,preventDefault:!0,onStart:function(t,o){var n=t;n.setStyle("background-color","#f1f6fa");var a=n.clone(!0).setStyles(e.attachmentOrderItemNode).setStyles({"background-color":"#faf9f1",opacity:.8,border:"1px dotted #333333"}).inject(i);a.position({relativeTo:n,position:"upperLeft",edge:"upperLeft"}),a.owner=n,new Drag.Move(a,{container:i,droppables:s.getChildren(),onEnter:function(t,i){a.flagNode=new Element("div",{styles:e.attachmentOrderFlagNode}).inject(i,"before")},onLeave:function(t,e){a.flagNode&&a.flagNode.destroy()},onDrop:function(t,e){a.flagNode&&(a.owner.inject(a.flagNode,"after"),a.flagNode.destroy(),a.owner.highlight(),this.checkMoveAction(a.owner),this.checkMoveAction(e),this.checkMoveAction(s.getLast()),a.destroy())}.bind(this)}).start(o)}.bind(this),enter:function(t){t.removeClass("dragging")}})}.bind(this));var n=o2.DL.open(Object.merge({title:t.attachmentOrderTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.sortAttachment(s),n.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){n.close()}}],onPostLoad:function(){this.node.setStyle("display","block");var t={};e.attachmentOrderNode&&("NaN"!==parseFloat(e.attachmentOrderNode.width).toString()&&(t.x=parseInt(e.attachmentOrderNode.width)),"NaN"!==parseFloat(e.attachmentOrderNode.height).toString()&&(t.y=parseInt(e.attachmentOrderNode.height))),i.show();var s=i.getSize();this.content.setStyles({width:t.x||s.x,height:t.y||s.y}),this.setContentSize()}},this.module.form.json.dialogOptions||{}))}},sortAttachment:function(t){t.getChildren().each(function(t,e){var i=t.retrieve("att",null);i&&(i.data.orderNumber=e,o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.changeOrderNumber(i.data.id,this.module.form.businessData.work.id,e))}.bind(this)),this.attachments=this.attachments.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this)),this.reloadAttachments(),this.fireEvent("order")}}),MWF.xApplication.process.Xform.Attachment=MWF.APPAttachment=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["upload","delete","afterDelete","load","change","download","open","queryLoad","queryLoadController","loadController","postLoadController"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.node.empty(),this.form.businessData.work.startTime&&(this.fireEvent("queryLoad"),this.loadAttachmentController(),this.fireEvent("load"))},reload:function(){this.node.empty(),this.form.businessData.work.startTime&&this.loadAttachmentController()},loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isPreviewAtt:"y"===this.json.isPreviewAtt||"true"===this.json.isPreviewAtt,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return t.data.name}));this._setBusinessData(t)}else this._setBusinessData([])},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},isEmpty:function(){var t=this.getData();return"array"===typeOf(t)?0==t.length:!t},getData:function(){return this.attachmentController?this.attachmentController.getAttachmentNames():null},createUploadFileNode:function(){var t="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each(function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}}.bind(this)),t=accepts.join(", ")}var e=0;this.json.attachmentSize&&(e=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"uploadAttachment",{id:this.form.businessData.work.id},null,function(t){t.id&&this.form.workAction.getAttachment(t.id,this.form.businessData.work.id,function(e){e.data&&(e.data.control||(e.data.control={}),this.form.businessData.attachmentList.push(e.data),this.attachmentController.addAttachment(e.data,t.messageId)),this.attachmentController.checkActions(),this.setAttachmentBusinessData(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this)),this.attachmentController.checkActions()}.bind(this),function(t){if(t.length&&t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.process.Xform.LP.uploadMore;return e=e.replace("{n}",this.attachmentController.options.attachmentCount),this.form.notice(e,"error"),!1}return!0}.bind(this),!0,t,e,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},uploadAttachment:function(t,e){window.o2android&&window.o2android.uploadAttachment?window.o2android.uploadAttachment(this.json.site||this.json.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadAttachment?window.webkit.messageHandlers.uploadAttachment.postMessage({site:this.json.site||this.json.id}):this.createUploadFileNode()},deleteAttachments:function(t,e,i){var s=[];i.each(function(t){s.push(t.data.name)}.bind(this));var o=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteAttachmentTitle,MWF.xApplication.process.Xform.LP.deleteAttachment+"( "+s.join(", ")+" )",300,120,(function(){for(;i.length;){var t=i.shift();o.deleteAttachment(t)}this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},previewAttachment:function(t){var e=t[0];new MWF.xApplication.process.Xform.AttachmenPreview(e,this)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);var e=t.data.id;this.form.workAction.deleteAttachment(t.data.id,this.form.businessData.work.id,function(i){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions();for(var s=0;s<this.form.businessData.attachmentList.length;s++){var o=this.form.businessData.attachmentList[s];if(o.id===e){this.form.businessData.attachmentList.erase(o);break}}this.form.officeList&&this.form.officeList.each(function(t){t.openedAttachment&&t.openedAttachment.id==e&&t.loadOfficeEdit()}.bind(this)),this.setAttachmentBusinessData(),this.fireEvent("afterDelete",[t.data]),this.fireEvent("change")}.bind(this))},replaceAttachment:function(t,e,i){if(window.o2android&&window.o2android.replaceAttachment)window.o2android.replaceAttachment(i.data.id,this.json.site||this.json.id);else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.replaceAttachment)window.webkit.messageHandlers.replaceAttachment.postMessage({id:i.data.id,site:this.json.site||this.json.id});else{var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.replaceAttachmentTitle,MWF.xApplication.process.Xform.LP.replaceAttachment+"( "+i.data.name+" )",350,120,(function(){s.replaceAttachmentFile(i),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}},createReplaceFileNode:function(t){var e="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each((function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}})),e=accepts.join(", ")}var i=0;this.json.attachmentSize&&(i=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"replaceAttachment",{id:t.data.id,workid:this.form.businessData.work.id},null,function(e){this.form.workAction.getAttachment(t.data.id,this.form.businessData.work.id,function(i){if(t.data=i.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var s=this.attachmentController.messageItemList[e.messageId];s&&s.node&&s.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,!0,e,i,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},replaceAttachmentFile:function(t){this.createReplaceFileNode(t)},queryDownload:function(t){return!(this.json.events&&this.json.events.queryDownload&&this.json.events.queryDownload.code)||!1!==this.form.Macro.exec(this.json.events.queryDownload.code,t)},queryOpen:function(t){return!(this.json.events&&this.json.events.queryOpen&&this.json.events.queryOpen.code)||!1!==this.form.Macro.exec(this.json.events.queryOpen.code,t)},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],i=0;i<e.length;i++)if(t===e[i])return!0;return!1},downloadAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentStream(t.data.id,this.form.businessData.work.id),this.fireEvent("download",[t]))}.bind(this)):i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentStream(t.data.id,this.form.businessData.workCompleted.id),this.fireEvent("download",[t]))}.bind(this))},openAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentData(t.data.id,this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this)):i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentData(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this))},getAttachmentUrl:function(t,e){this.form.businessData.work&&!this.form.businessData.work.completedTime?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,e):this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,e)},getTextData:function(){var t=[];return this.attachmentController.attachments.each((function(e){var i={id:e.data.id,person:e.data.person,creatorUid:e.data.creatorUid,name:e.data.name,orderNumber:e.data.orderNumber,length:e.data.length,extension:e.data.extension,lastUpdateTime:e.data.lastUpdateTime,activityName:e.data.activityName,control:e.data.control};t.push(i)})),t},setData:function(t){this.attachmentController.clear(),(t||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;this.attachmentController.addAttachment(e)}.bind(this)),this.setAttachmentBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData()||[],s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.AttachmenPreview=new Class({Implements:[Options,Events],initialize:function(t,e){this.att=t,this.app=e,this.load()},load:function(){var t=this.att.data.extension;"ofd"===t&&"ie"!==Browser.name&&this.previewOfd(),"zip"===t&&this.previewZip(),"pdf"===t&&this.previewPdf(),["png","jpg","bmp","jpeg","gif"].contains(t)&&this.previewImage(),"js"===t&&this.previewAce("javascript"),"css"===t&&this.previewAce("css"),"java"===t&&this.previewAce("java"),"json"===t&&this.previewAce("json"),"xml"===t&&this.previewAce("xml"),"php"===t&&this.previewAce("php"),["html","htm","xhtml"].contains(t)&&this.previewAce("html"),["log","md","txt"].contains(t)&&this.previewAce("text")},previewZip:function(){var t=this,e=new Element("div",{text:"loadding..."});o2.load(["../o2_lib/jszip/jszip.min.js","../o2_lib/jszip/jszip-utils.min.js"],function(){this.app.getAttachmentUrl(this.att,function(i){o2.require("MWF.widget.Tree",function(){var i=o2.DL.open({title:t.att.data.name,width:"660px",height:"510px",mask:!0,content:e,container:null,positionNode:document.body,onQueryClose:function(){e.destroy()},buttonList:[{text:"关闭",action:function(){i.close()}}],onPostShow:function(){i.reCenter()},onPostLoad:function(){}})}.bind(this)),e.empty(),JSZipUtils.getBinaryContent(i,(function(i,s){JSZip.loadAsync(s).then((function(i){var s=[];i.forEach((function(t,e){s.push(e.name)}));var o=new MWF.widget.Tree(e,{style:"form"}),n=function(e){for(var i=[],s=0;s<e.length;s++)for(var o=e[s].split("/"),n=i,a=0;a<o.length&&""!==o[a];a++){for(var r=o[a],l=n,d=0;d<n.length;d++)if(n[d].name==r){n=n[d].sub;break}if(l==n){var c={key:e[s],name:r,title:r,text:r,sub:[]},h=n[d]=c;r.indexOf(".")>-1?(c.dir=!1,c.icon="file.png",delete c.sub):(c.dir=!0,c.expand=!1,n=h.sub)}else delete n.sub}var u=[],p={title:t.att.name,text:t.att.name,sub:[]};return i.each((function(t){p.sub.push(t)})),function t(e,i){var s=[];e.sub.each((function(t){t.dir&&s.push(t)})),e.sub.each((function(t){t.dir||s.push(t)})),s.each((function(e){var s={text:e.name,title:e.name,expand:!1};e.dir||(s.icon="file.png"),i.push(s),e.sub&&e.sub.length>0&&(s.sub=[],t(e,s.sub))}))}(p,u),u}(s);o.load(n)}))}))}.bind(this))}.bind(this))},previewPdf:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/pdfjs/web/viewer.html?file="+t)}))},previewOfd:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/ofdjs/index.html?file="+t)}))},previewImage:function(){this.app.getAttachmentUrl(this.att,function(t){var e=new Element("img",{src:t,alt:this.att.name}).inject(document.body).hide();o2.loadCss("../o2_lib/viewer/viewer.css",document.body,function(){o2.load("../o2_lib/viewer/viewer.js",function(){this.viewer=new Viewer(e,{navbar:!1,toolbar:!1,hidden:function(){e.destroy(),this.viewer.destroy()}.bind(this)}),this.viewer.show()}.bind(this))}.bind(this))}.bind(this))},previewAce:function(t){this.app.getAttachmentUrl(this.att,function(e){o2.require("o2.widget.ace",null,!1),new Request({url:e,method:"get",withCredentials:!0,onSuccess:function(e){var i=new Element("div",{style:"padding:10px"});i.set("text",e),o2.widget.ace.load(function(){o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js",function(){ace.require("ace/ext/static_highlight")(i,{mode:"ace/mode/"+t,theme:"ace/theme/tomorrow",fontSize:30,showLineNumbers:!0})}.bind(this))}.bind(this));var s=o2.DL.open({title:this.att.data.name,width:"960px",height:"610px",mask:!0,content:i,container:null,positionNode:document.body,onQueryClose:function(){i.destroy()}.bind(this),buttonList:[{text:"关闭",action:function(){s.close()}.bind(this)}],onPostShow:function(){s.reCenter()}.bind(this)})}.bind(this),onFailure:function(){console.log("text","Sorry, your request failed :(")}}).send()}.bind(this))}}),MWF.xApplication.process.Xform.AttachmentDg=MWF.APPAttachmentDg=new Class({Extends:MWF.APPAttachment,loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],ignoreSite:this.json.ignoreSite,onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.json.ignoreSite?(this._getBusinessData()||[]).each(function(t){this.form.businessData.attachmentList.some(function(e){return t.id===e.id}.bind(this))&&this.attachmentController.addAttachment(t)}.bind(this)):this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return{control:t.data.control,name:t.data.name,id:t.data.id,person:t.data.person,creatorUid:t.data.creatorUid,orderNumber:t.data.orderNumber,length:t.data.length,extension:t.data.extension,lastUpdateTime:t.data.lastUpdateTime,activityName:t.data.activityName}}));this._setBusinessData(t)}else this._setBusinessData([])}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Calendar=MWF.APPCalendar=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"calendarIcon",options:{moduleEvents:["queryLoad","postLoad","load","complete","clear","change","show","hide"]},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._loadNodeEdit(),this.node.getFirst().set("readonly",!0))},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none")}.bind(this)})},_getValueAg:function(t,e){if(t&&t.isAG)return t.then(function(t){this._getValueAg(t,e)}.bind(this),(function(){}));var i=t?Date.parse(t):"";return e?i||null:i?i.format(this.json.format):""},getValue:function(t){if(this.moduleValueAG)return this.moduleValueAG;var e=this._getBusinessData();if(e&&!t)return e;if(e||(e=this._computeValue()),e.then)return e;var i=e?Date.parse(e):"";return t?i||null:i?i.format(this.json.format):""},getValueStr:function(){var t=this._getBusinessData();return t||(t=this._computeValue()),t},__setValue:function(t){var e;return e="date"===typeOf(t)?t?Date.parse(t).format(this.json.format):"":t,this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",e||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",e),this.moduleValueAG=null,t},clickSelect:function(){var t=this;if(this.calendar){var e={};e.baseDate=this.getBaseDate(),this.calendar.setOptions(e),this.node.getFirst().focus()}else MWF.require("MWF.widget.Calendar",function(){var e="day";"month"===this.json.selectType&&(e="month"),"year"===this.json.selectType&&(e="year");var i={style:layout.mobile?"xform_mobile":"xform",secondEnable:this.json.isSelectSecond,isTime:"datetime"===this.json.selectType||"time"===this.json.selectType,timeOnly:"time"===this.json.selectType,monthOnly:"month"===this.json.selectType,yearOnly:"year"===this.json.selectType,defaultView:e,target:layout.mobile?$(document.body):this.form.app.content,format:this.json.format,onComplate:function(t,e){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("complete")}.bind(this),onChange:function(){this.fireEvent("change")}.bind(this),onClear:function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("clear"),this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this),onShow:function(){if(t.descriptionNode&&t.descriptionNode.setStyle("display","none"),layout.mobile)this.container.position({relativeTo:$(document.body),position:"leftCenter",edge:"leftCenter"});else for(var e=t.node.getParent();e;){var i=e.getStyle("overflow"),s=e.getStyle("overflow-y");"auto"===i||"scroll"===i||"auto"===s||"scroll"===s?(t.scrollFun=function(t){this.container.position&&this.container.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft",allowNegative:!0})}.bind(this),t.scrollParentNode=e,e.addEvent("scroll",t.scrollFun),e=null):e=e.getParent()}t.fireEvent("show")},onHide:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block"),t.scrollParentNode&&t.scrollFun&&t.scrollParentNode.removeEvent("scroll",t.scrollFun),t.fireEvent("hide")}.bind(this)};i.baseDate=this.getBaseDate(),this.calendar=new MWF.widget.Calendar(this.node.getFirst(),i),this.form.json&&this.form.json.canlendarStyle&&"null"!==typeOf(this.form.json.canlendarStyle.zIndex)&&"undefined"!==typeOf(this.form.json.canlendarStyle.zIndex)&&this.calendar.container.setStyle("z-index",this.form.json.canlendarStyle.zIndex),this.calendar.show()}.bind(this))},getBaseDate:function(){var t,e=this.getValue(!0);if(e&&e.getTime()>1e4)t=e;else{var i=Date.parse(this.unformatDate(this.getValueStr()));t=i&&i.getTime()>1e4?i:new Date}return t},unformatDate:function(t){for(var e=this.json.format,i=["%Y","%m","%d","%H","%M","%S","%z","%Z"],s=[4,2,2,2,2,2,5,3],o=[e.indexOf("%Y"),e.indexOf("%m"),e.indexOf("%d"),e.indexOf("%H"),e.indexOf("%M"),e.indexOf("%S"),e.indexOf("%z"),e.indexOf("%Z")],n=[null,null,null,null,null,null,null,null],a=0;a<i.length;a++)if(-1!==o[a]){var r=0,l=0;Array.each(o,(function(t,e){-1!==t&&o[a]>t&&(r+=s[e],l+=i[e].length)})),n[a]=t.substr(o[a]-l+r,s[a])}var d=new Date;for(a=0;a<n.length;a++)if(!n[a])switch(i[a]){case"%Y":case"%m":case"%d":n[a]=d.format(i[a]);break;case"%H":case"%M":case"%S":n[a]="00"}return n[0]+"-"+n[1]+"-"+n[2]+" "+n[3]+":"+n[4]+":"+n[5]}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.require("MWF.widget.UUID",null,!1),MWF.xApplication.process.Xform.Checkbox=MWF.APPCheckbox=new Class({Implements:[Events],Extends:MWF.APP$Input,loadDescription:function(){},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){var i=[];t.each((function(t){var s=t.split("|"),o=s[0],n=s[1]||o;-1!=e.indexOf(n)&&i.push(o)})),this.node.set("text",i.join(", "))}},_resetNodeEdit:function(){var t=new Element("div");t.set(this.json.properties),t.inject(this.node,"after"),this.node.destroy(),this.node=t},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.set({id:this.json.id,MWFType:this.json.type,styles:{display:"inline"}}),this.setOptions()},_loadDomEvents:function(){},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!=this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.getElements("input").each(function(i){i.addEvent(t,function(t){return e?e(this,t):null}.bind(this))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions()},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){if(this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)){var e=(new MWF.widget.UUID).toString();t.each(function(t){var i=t.split("|"),s=i[0],o=i[1]||s,n=new Element("input",{type:"checkbox",name:(this.json.properties?this.json.properties.name:null)||e+this.json.id,value:o,showText:s,styles:this.json.buttonStyles}).inject(this.node);new Element("span",{text:s,styles:{cursor:"default"}}).inject(this.node).addEvent("click",function(t){!0!==this.radio.get("disabled")&&"true"!==this.radio.get("disabled")&&(this.radio.checked=!this.radio.checked,this.radio.fireEvent("change"),this.radio.fireEvent("click"))}.bind({radio:n})),n.addEvent("click",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")||[]),this.fireEvent("change"))}.bind(this)),Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)||n.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))}.bind(this))}}.bind(this),(function(){}));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){this._setBusinessData(t);for(var e=this.node.getElements("input"),i=0;i<e.length;i++){var s=e[i];s.checked=-1!=t.indexOf(s.value)}},getTextData:function(){var t=this.node.getElements("input"),e=[],i=[];return t.length&&t.each((function(t){if(t.checked){var s=t.get("value"),o=t.get("showText");e.push(s||""),i.push(o||s||"")}})),e.length||(e=[""]),i.length||(i=[""]),{value:e,text:i}},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("input"),e=[];return t.length&&t.each((function(t){if(t.checked){var i=t.get("value");i&&e.push(i||"")}})),e.length?e:[]},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){this._setBusinessData(t);var e=this.node.getElements("input");e.length&&(e.each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("checked",!0):e.set("checked",!1):t==e.get("value")?e.set("checked",!0):e.set("checked",!1)})),this.validationMode()),this.fireEvent("setData")},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("background",this.node.getStyles("background")),this.node.setStyle("background","#ffdcdc"),this.errNode=this.createErrorNode(t),this.iconNode?this.errNode.inject(this.iconNode,"after"):this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("background")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData();"array"===typeOf(i)&&0===i.length&&(i="");var s="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","DatagridPC",null,!1),MWF.xDesktop.requireApp("process.Xform","DatagridMobile",null,!1),layout.mobile||COMMON.Browser.Platform.isMobile?(MWF.xApplication.process.Xform.Datagrid=MWF.APPDatagrid=MWF.xApplication.process.Xform.DatagridMobile,MWF.xApplication.process.Xform.Datagrid$Title=MWF.APPDatagrid$Title=MWF.xApplication.process.Xform.DatagridMobile$Title,MWF.xApplication.process.Xform.Datagrid$Data=MWF.APPDatagrid$Data=MWF.xApplication.process.Xform.DatagridMobile$Data):(MWF.xApplication.process.Xform.Datagrid=MWF.APPDatagrid=MWF.xApplication.process.Xform.DatagridPC,MWF.xApplication.process.Xform.Datagrid$Title=MWF.APPDatagrid$Title=MWF.xApplication.process.Xform.DatagridPC$Title,MWF.xApplication.process.Xform.Datagrid$Data=MWF.APPDatagrid$Data=MWF.xApplication.process.Xform.DatagridPC$Data),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Htmleditor=MWF.APPHtmleditor=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","postLoad","afterLoad"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},load:function(){this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){if(this.node.empty(),this.readonly)this.node.set("html",this._getBusinessData()),this.node.setStyles({"-webkit-user-select":"text","-moz-user-select":"text"}),layout.mobile&&this.node.getElements("img").each(function(t){t.setStyles({height:"auto","max-width":"100%"})}.bind(this));else{var t=Object.clone(this.json.editorProperties);if(this.json.config&&this.json.config.code){var e=this.form.Macro.exec(this.json.config.code,this);Object.each(e,(function(e,i){t[i]=e}))}this.loadCkeditor(t)}},loadCkeditor:function(t){COMMON.AjaxModule.loadDom("ckeditor",function(){CKEDITOR.disableAutoInline=!0;var e=new Element("div").inject(this.node),i=this._getBusinessData();i?e.set("html",i):this.json.templateCode&&e.set("html",this.json.templateCode);this.node.getSize().y;var s=t||{};if("Mobile"===this.form.json.mode&&(s.toolbar||s.toolbarGroups||(s.toolbar=[{name:"paragraph",items:["Bold","Italic","-","TextColor","BGColor","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","Undo","Redo"]},{name:"basicstyles",items:["Styles","FontSize"]},{name:"insert",items:["Image"]}])),s.base64Encode="y"===this.json.base64Encode,s.localImageMaxWidth=800,s.reference=this.form.businessData.work.job,s.referenceType="processPlatformJob",s&&s.extraPlugins){var o=s.extraPlugins;(o="array"===typeOf(o)?o:o.split(",")).push("pagebreak"),s.extraPlugins=o}else s.extraPlugins=["pagebreak"];this.editor=CKEDITOR.replace(e,s),this.editor.addCommand("ecnet",{exec:function(t){this.ecnet()}.bind(this)}),this.editor.ui.add("ecnet",CKEDITOR.UI_BUTTON,{label:MWF.xApplication.process.Xform.LP.intelligentCorrection,icon:"../x_component_process_Xform/$Form/default/icon/ecnet.png",command:"ecnet"}),this._loadEvents(),this.editor.on("change",function(){}.bind(this)),this.json.ecnet}.bind(this))},getEcnetString:function(t,e){for(var i=0;i<t.childNodes.length;i++)if(t.childNodes[i].nodeType===Node.TEXT_NODE){var s=this.ecnetString.length;this.ecnetString+=t.childNodes[i].nodeValue;var o=this.ecnetString.length;e.push({pnode:t,node:t.childNodes[i],start:s,end:o})}else this.getEcnetString(t.childNodes[i],e)},createEcnetNode:function(t){var e=t.node.ownerDocument.createElement("span"),i=0,s=t.node.nodeValue;t.ecnets.each(function(e){var o=e.begin+i-t.start,n=e.end+i-t.start;o<0&&(o=0),n>t.end+i&&(n=t.end+i);var a=s.length,r=s.substring(0,o),l=s.substring(o,n),d=s.substring(n,s.length);i+=(s=r+"<span class='o2_ecnet_item' style='color: red'><u>"+l+"</u></span>"+d).length-a}.bind(this)),e.innerHTML=s,t.pnode.replaceChild(e,t.node),t.pnode.textNode=t.node,t.pnode.ecnetNode=e;var o=this,n=this.editor.document.$.defaultView.frameElement,a=e.getElementsByTagName("span");if(a.length)for(var r=0;r<a.length;r++){var l=a[r];if("o2_ecnet_item"===l.className){var d=new Element("div",{styles:{border:"1px solid #999999","box-shadow":"0px 0px 5px #999999","background-color":"#ffffff",position:"fixed",display:"none"}}).inject(n,"after");new Element("div",{styles:{padding:"3px 10px","font-weight":"bold","font-size":"12px",cursor:"pointer"},text:t.ecnets[r].origin+"->"+t.ecnets[r].correct,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var t=this.getParent(),e=t.node,i=t.node.ecnets[t.idx],s=e.node.ownerDocument.createTextNode(i.correct);t.span.parentNode.replaceChild(s,t.span),t.destroy(),e.node.nodeValue=e.pnode.ecnetNode.innerText,e.ecnets.erase(i),e.ecnets.length||o.ecnetNodes.erase(e)}}}).inject(d),new Element("div",{styles:{padding:"3px 10px","font-size":"12px",cursor:"pointer"},text:MWF.xApplication.process.Xform.LP.ignore,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var t=this.getParent(),e=t.node,i=t.node.ecnets[t.idx],s=e.node.ownerDocument.createTextNode(t.span.innerText);t.span.parentNode.replaceChild(s,t.span),t.destroy(),e.node.nodeValue=e.pnode.ecnetNode.innerText,e.ecnets.erase(i),e.ecnets.length||o.ecnetNodes.erase(e)}}}).inject(d);d.node=t,d.idx=r,l.ecnetNode=d,d.span=l,l.addEventListener("click",(function(){var t=this.ecnetNode;t.show();var e=this.offsetTop,i=this.offsetLeft,s=this.offsetWidth,o=this.offsetHeight,a=n.getPosition(),r=t.getSize(),l=e+a.y+o+5,d=i+a.x-(r.x-s)/2;t.style.left=d+"px",t.style.top=l+"px";var c=this,h=function(){t.hide(),c.ownerDocument.removeEventListener("mousedown",h)};this.ownerDocument.addEventListener("mousedown",h)}))}}},clearEcnetNodes:function(){this.ecnetNodes&&this.ecnetNodes.length&&(this.ecnetNodes.each(function(t){t.pnode.ecnetNode&&(t.pnode.ecnetInforNode&&t.pnode.ecnetInforNode.destroy(),t.pnode.ecnetInforNode=null,t.pnode.replaceChild(t.pnode.textNode,t.pnode.ecnetNode))}.bind(this)),this.ecnetNodes=[])},ecnet:function(t){this.editor.document.$.defaultView.frameElement;var e=this.editor.document.$.body;this.ecnetNodes||(this.ecnetNodes=[]),this.ecnetNodes.length&&this.clearEcnetNodes();var i=[];this.ecnetString="",this.getEcnetString(e,i),MWF.Actions.get("x_general_assemble_control").ecnetCheck({value:this.ecnetString},function(t){t.data.itemList&&t.data.itemList.length?(i.each(function(e){var i=[];t.data.itemList.each(function(t){(e.end<=t.end&&e.end>t.begin||e.start>=t.begin&&e.start<t.end||e.start<=t.begin&&e.end>t.end)&&i.push(t)}.bind(this)),i.length&&(e.ecnets=i,this.ecnetNodes.push(e))}.bind(this)),this.ecnetNodes.each(function(t){this.createEcnetNode(t)}.bind(this))):(e=null,i=null)}.bind(this))},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&this.editor.on(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this),this)}.bind(this))},addModuleEvent:function(t,e){this.editor.on(t,function(t){return e?e(this,t):null}.bind(this),this)},_loadValue:function(){this._getBusinessData()},resetData:function(){this.setData(this._getBusinessData())},isEmpty:function(){return!this.getData().trim()},getData:function(){return this.clearEcnetNodes(),this.editor?this.editor.getData():""},setData:function(t){this._setBusinessData(t),this.editor&&this.editor.setData(t)},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Label=MWF.APPLabel=new Class({Implements:[Events],Extends:MWF.APP$Module,_loadUserInterface:function(){if("text"==this.json.valueType&&this.node.set("text",this.json.text||""),"script"==this.json.valueType){var t=this.json.script?this.json.script.code:"";if(t){var e=this.form.Macro.exec(t,this);this._setNodeText(e)}}if(this.json.prefixIcon||this.json.suffixIcon){var i=this.node.get("text");this.node.empty();var s=new Element("div",{styles:{"margin-left":this.json.prefixIcon?"20px":"0px","margin-right":this.json.suffixIcon?"20px":"0px",height:"100%"},text:i}).inject(this.node);if(this.json.prefixIcon)new Element("div",{styles:{float:"left",width:"20px",height:this.node.getSize().y+"px",background:"url("+this.json.prefixIcon+") center center no-repeat"}}).inject(s,"before");if(this.json.suffixIcon)new Element("div",{styles:{float:"right",width:"20px",height:this.node.getSize().y+"px",background:"url("+this.json.suffixIcon+") center center no-repeat"}}).inject(s,"before")}},_setNodeText:function(t){t&&t.isAG?t.addResolve(function(t){this._setNodeText(t)}.bind(this)):o2.promiseAll(t).then(function(t){this.node.set("text",t||"")}.bind(this),(function(){}))},setText:function(t){t?o2.promiseAll(t).then(function(t){this.node.set("text",t||"")}.bind(this),(function(){})):this.node.set("text",v||"")}}),MWF.xDesktop.requireApp("process.Xform","Textfield",null,!1),MWF.xApplication.process.Xform.Number=MWF.APPNumber=new Class({Implements:[Events],Extends:MWF.APPTextfield,iconStyle:"numberIcon",isEmpty:function(){return!this.getData()},getInputData:function(){if(this.node.getFirst()){var t=this.node.getElement("input").get("value"),e=t.toFloat();return isNaN(e)?0:e}return this._getBusinessData()},formatNumber:function(t){var e=t.toFloat();if(e&&this.json.decimals&&"*"!=this.json.decimals){var i=this.json.decimals.toInt(),s=Math.pow(10,i);if(t=(Math.round(e*s)/s).toString(),i>0){var o=t.indexOf(".");for(o<0&&(o=t.length,t+="."),decimalStr=t.substr(o+1,t.length);decimalStr.length<i;)t+="0",decimalStr+=0}}return t},validationFormat:function(){if(!this.node.getElement("input"))return!0;var t=this.node.getElement("input").get("value");return isNaN(t)?(this.notValidationMode(MWF.xApplication.process.Xform.LP.notValidation_number),!1):(this.node.getFirst().set("value",this.formatNumber(t)),!0)},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getInputData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s&&"0"!==s.toString())return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.readonly&&!this.json.isReadonly){if(!this.validationFormat())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);if(this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"!=i.toString())return this.notValidationMode(i),!1}return!0},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",border:"0px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle]}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},_computeValue:function(t){return this.json.defaultValue&&this.json.defaultValue.code?this.form.Macro.exec(this.json.defaultValue.code,this):t||"0"},getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();return t||(t=this._computeValue()),(t=this.formatNumber(t))||"0"},__setValue:function(t){return this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",t||"0"),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,t}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Common=MWF.APPCommon=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){if(this.json.innerHTML){for(var t=this.node.childNodes,e=0;e<t.length;e++)t[e].nodeType===Node.ELEMENT_NODE?t[e].get("MWFtype")||(t[e].destroy(),e--):(t[e].removeNode?t[e].removeNode():t[e].parentNode.removeChild(t[e]),e--);this.node.appendHTML(this.json.innerHTML)}this.node.setProperties(this.json.properties)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Image=MWF.APPImage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){if(this.json.properties&&this.json.properties.src){var t=this.json.properties.src;if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")||-1!=t.indexOf("x_cms_assemble_control")){var e=MWF.Actions.getHost("x_processplatform_assemble_surface"),i=MWF.Actions.getHost("x_portal_assemble_surface"),s=MWF.Actions.getHost("x_cms_assemble_control");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",i+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",i+"/x_portal_assemble_surface")),-1!==t.indexOf("/x_cms_assemble_control")?t=t.replace("/x_cms_assemble_control",s+"/x_cms_assemble_control"):-1!==t.indexOf("x_cms_assemble_control")&&(t=t.replace("x_cms_assemble_control",s+"/x_cms_assemble_control")),t=o2.filterUrl(t)}try{this.node.set("src",t)}catch(t){}}else if(this.json.srcfile&&"none"!=this.json.srcfile)if(t=this.json.srcfile,"object"===typeOf(t)){var o=t.portal?MWF.xDesktop.getPortalFileUr(t.id,t.portal):MWF.xDesktop.getProcessFileUr(t.id,t.application);o=o2.filterUrl(o),this.node.set("src",o)}else{var n=MWF.Actions.getHost("x_portal_assemble_surface"),a=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;t=n+"/x_portal_assemble_surface"+(a=(a=a.replace("{flag}",t)).replace("{applicationFlag}",this.form.json.application)),t=o2.filterUrl(t),this.node.set("src",t)}else if("object"==typeOf(this.json.src)){var r=MWF.xDesktop.getImageSrc(this.json.src.imageId);this.node.set("src",r)}},reset:function(){this._loadUserInterface()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.ImageClipper=MWF.APPImageClipper=new Class({Implements:[Events],Extends:MWF.APP$Module,initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.field=!0,this.node.empty();var t=this._getBusinessData();if(t){var e=new Element("img",{src:MWF.xDesktop.getImageSrc(t)});if(layout.mobile||COMMON.Browser.Platform.isMobile)e.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),s=this.json.imageHeight.toInt();i&&s&&e.setStyles({width:i+"px",height:s+"px"})}e.inject(this.node)}if(!this.readonly&&!this.json.isReadonly){var o=new Element("div").inject(this.node),n=new Element("button").inject(o);n.set({text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),n.addEvent("click",function(){this.validationMode();var t=this._getBusinessData();if(layout.mobile){o2.imageClipperCallback=function(t){var e=JSON.parse(t);this.setData(e?e.fileId:""),this.validation(),o2.imageClipperCallback=null}.bind(this);var e="processPlatformJob";this.form.businessData.work&&this.form.businessData.work.referencetype&&(e=this.form.businessData.work.referencetype);var i=JSON.stringify({mwfId:this.json.id,callback:"o2.imageClipperCallback",referencetype:e,reference:this.form.businessData.work.job});window.o2android&&window.o2android.uploadImage2FileStorage?window.o2android.uploadImage2FileStorage(i):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadImage2FileStorage?window.webkit.messageHandlers.uploadImage2FileStorage.postMessage(i):this.selectImage(t,function(t){this.setData(t?t.id:""),this.validation()}.bind(this))}else this.selectImage(t,function(t){this.setData(t?t.id:""),this.validation()}.bind(this))}.bind(this))}},getTextData:function(){var t=this._getBusinessData()||"";return{value:[t],text:[t]}},isEmpty:function(){return!this.getData()},getData:function(t){return this._getBusinessData()||""},setData:function(t){if(this._setBusinessData(t),(e=this.node.getElements("img"))&&e.length&&e.destroy(),t){var e=new Element("img",{src:MWF.xDesktop.getImageSrc(t)}).inject(this.node,"top");if(layout.mobile||COMMON.Browser.Platform.isMobile)e.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),s=this.json.imageHeight.toInt();i&&s&&e.setStyles({width:i+"px",height:s+"px"})}}},selectImage:function(t,e){var i=this.json.clipperType||"unrestricted",s=1,o="",n=800;if("unrestricted"==i)s=0;else if("size"==i){var a=this.json.imageWidth?this.json.imageWidth.toInt():600,r=this.json.imageHeight?this.json.imageHeight.toInt():500;s=a/r,n=Math.max(a,r),isNaN(a)||isNaN(r)||(o=MWF.LP.widget.pictureSize.replace(/{width}/g,a).replace(/{height}/g,r))}else"ratio"==i&&(s=this.json.imageRatio||1,o=MWF.LP.widget.pictureRatio.replace(/{ratio}/g,s));MWF.xDesktop.requireApp("process.Xform","widget.ImageClipper",function(){this.imageClipper=new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app,{style:"default",aspectRatio:s,description:o,imageUrl:t?MWF.xDesktop.getImageSrc(t):"",reference:this.form.businessData.work.job,referenceType:"processPlatformJob",resultMaxSize:n,onChange:function(){e({src:this.imageClipper.imageSrc,id:this.imageClipper.imageId})}.bind(this)}),this.imageClipper.load()}.bind(this))},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Html=MWF.APPHtml=new Class({Extends:MWF.APP$Module,load:function(){this.node.insertAdjacentHTML("beforebegin",this.json.text),this.node.destroy()}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.require("MWF.widget.UUID",null,!1),MWF.xApplication.process.Xform.Radio=MWF.APPRadio=new Class({Implements:[Events],Extends:MWF.APP$Input,loadDescription:function(){},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){for(var i="",s=0;s<t.length;s++){var o=t[s].split("|"),n=o[0];if(e==(o[1]||n)){i=n;break}}this.node.set("text",i)}},_resetNodeEdit:function(){var t=new Element("div");t.set(this.json.properties),t.inject(this.node,"after"),this.node.destroy(),this.node=t},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.set({id:this.json.id,MWFType:this.json.type,styles:{display:"inline"}}),this.setOptions()},_loadDomEvents:function(){},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!=this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.getElements("input").each(function(i){i.addEvent(t,function(t){return e?e(this,t):null}.bind(this))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions()},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript.code,this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){if(this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)){var e=(new MWF.widget.UUID).toString();t.each(function(t){var i=t.split("|"),s=i[0],o=i[1]||s,n=new Element("input",{type:"radio",name:this.json.properties&&this.json.properties.name?this.json.properties.name:e+this.json.id,value:o,showText:s,styles:this.json.buttonStyles}).inject(this.node);new Element("span",{text:s,styles:{cursor:"default"}}).inject(this.node).addEvent("click",function(t){!0!==this.radio.get("disabled")&&"true"!==this.radio.get("disabled")&&(this.radio.checked=!0,this.radio.fireEvent("change"),this.radio.fireEvent("click"))}.bind({radio:n})),n.addEvent("click",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this)),Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)||n.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))}.bind(this))}}.bind(this),function(){this.moduleSelectAG=null}.bind(this));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return"array"==o2.typeOf(t)&&(t=t[0]),this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){this._setBusinessData(t);for(var e=this.node.getElements("input"),i=0;i<e.length;i++){var s=e[i];if(s.value==t){s.checked=!0;break}}},getTextData:function(){var t=this.node.getElements("input"),e="",i="";if(t.length)for(var s=0;s<t.length;s++){var o=t[s];if(o.checked){e=o.get("value"),i=o.get("showText");break}}return{value:[e]||"",text:[i||e||""]}},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("input"),e="";if(t.length)for(var i=0;i<t.length;i++){var s=t[i];if(s.checked){e=s.get("value");break}}return e},resetData:function(){this.setData(this.getValue())},getSelectedInput:function(){var t=this.node.getElements("input");if(t.length)for(var e=0;e<t.length;e++)if(t[e].checked)return t[e];return null},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){this._setBusinessData(t);var e=this.node.getElements("input");if(e.length){for(var i=0;i<e.length;i++)t==e[i].get("value")?e[i].set("checked",!0):e[i].set("checked",!1);this.validationMode()}this.fireEvent("setData")},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("background",this.node.getStyles("background")),this.node.setStyle("background","#ffdcdc"),this.errNode=this.createErrorNode(t),this.iconNode?this.errNode.inject(this.iconNode,"after"):this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},validationMode:function(t,e){if(!this.validationConfig(t,e))return!1;this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("background")),this.errNode&&(this.errNode.destroy(),this.errNode=null))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Select=MWF.APPSelect=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"selectIcon",initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){"array"!==typeOf(e)&&(e=[e]);var i=[];t.each((function(t){var s=t.split("|"),o=s[0],n=s[1]||o;n&&-1!=e.indexOf(n)&&i.push(o)})),this.node.set("text",i.join(", "))}},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadStyles:function(){this.areaNode?(this.json.styles&&this.areaNode&&this.areaNode.setStyles(this.json.styles),this.json.inputStyles&&this.node.setStyles(this.json.inputStyles)):this.json.styles&&this.node.setStyles(this.json.styles)},_resetNodeEdit:function(){this.node.empty();var t=new Element("select");t.set(this.json.properties),t.inject(this.node)},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();this.areaNode=this.node,this.node=t,this.node.set({id:this.json.id,MWFType:this.json.type,styles:{"margin-right":"12px"}}),this.setOptions(),this.node.addEvent("change",function(){var t=this.getInputData("change");this._setBusinessData(t),this.validationMode(),this.validation()&&(this._setBusinessData(t),this.fireEvent("change"))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions(),this.fireEvent("resetOption")},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)&&(t.each(function(t){var e=t.split("|"),i=e[0],s=e[1]||i;new Element("option",{value:s,text:i}).inject(this.node)}.bind(this)),this.fireEvent("setOptions",[t]))}.bind(this),function(){this.moduleSelectAG=null}.bind(this));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},addOption:function(t,e){new Element("option",{value:e||t,text:t}).inject(this.node);this.fireEvent("addOption",[t,e])},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return"array"==o2.typeOf(t)&&(t=t[0]),this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){if(!this.readonly&&!this.json.isReadonly){this._setBusinessData(t);for(var e=this.node.getElements("option"),i=0;i<e.length;i++){var s=e[i];s.value==t?s.selected=!0:s.selected=!1}}this.moduleValueAG=null},getTextData:function(){var t=[],e=[];if(this.readonly||this.json.isReadonly){var i=this.getOptionsObj(),s=this._getBusinessData();("array"===typeOf(s)?s:[s]).each((function(s){var o=i.valueList.indexOf(s);t.push(s||""),e.push(o>-1?i.textList[o]:s||"")}))}else{(i=this.node.getElements("option")).each((function(i){if(i.selected){var s=i.get("value"),o=i.get("text");t.push(s||""),e.push(o||s||"")}}))}return t.length||(t=[""]),e.length||(e=[""]),{value:t,text:e}},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("option"),e=[];return t.each((function(t){if(t.selected){var i=t.get("value");i&&e.push(i)}})),e.length?1==e.length?e[0]:e:null},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){if(this._setBusinessData(t),this.readonly||this.json.isReadonly){var e="array"===typeOf(t)?t:[t],i=this.getOptionsObj(),s=[];e.each((function(t){var e=i.valueList.indexOf(t);s.push(e>-1?i.textList[e]:t)})),this.node.set("text",s.join(","))}else{(i=this.node.getElements("option")).each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("selected",!0):e.set("selected",!1):t==e.get("value")?e.set("selected",!0):e.set("selected",!1)})),this.validationMode()}this.fireEvent("setData",[t])}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.require("MWF.widget.Tab",null,!1),MWF.xApplication.process.Xform.Tab=MWF.APPTab=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.elements=[],this.containers=[];var t="form";layout.mobile&&(t="mobileForm"),this.tab=new MWF.widget.Tab(this.node,{style:t}),this._setTabWidgetStyles(),this.tab.tabNodeContainer=this.node.getFirst("div"),this.tab.contentNodeContainer=this.tab.tabNodeContainer.getNext("div");var e,i=this.tab.tabNodeContainer.getLast();if(i&&i.hasClass("tabNodeContainerLeft")){this.tab.tabNodeContainerRight=this.tab.tabNodeContainer.getFirst(),this.tab.tabNodeContainerLeft=i,this.tab.tabNodeContainerArea=i.getFirst();var s=this.node.getElement(".MWFMenu");s&&s.destroy(),this.tab.load(),e=this.tab.tabNodeContainerArea.getChildren("div")}else e=this.tab.tabNodeContainer.getChildren("div"),this.tab.load();var o=this.tab.contentNodeContainer.getChildren("div");e.each(function(t,e){this.tab.rebuildTab(o[e],o[e].getFirst(),t)}.bind(this)),this.tab.pages[0]._showTab(),this.loadSubModule()},loadSubModule:function(){this.tab.pages.each(function(t){var e=t.tabNode,i=this.form._getDomjson(e),s=this,o=this.form._loadModule(i,e,(function(){this.tab=s}));if(this.elements.push(o),this.form.modules.push(o),t.isShow)this.showContentModule.call(t,this);else if(this.json.isDelay){var n=this;t.showContentModuleFun=function(){n.showContentModule.call(t,n)},t.addEvent("show",t.showContentModuleFun)}else this.showContentModule.call(t,this)}.bind(this))},showContentModule:function(t){var e=this.contentNode;e.isLoadModule=!0,json=t.form._getDomjson(e),tab=t,module=t.form._loadModule(json,e,(function(){this.tab=tab})),t.containers.push(module),t.form.modules.push(module),this.showContentModuleFun&&this.removeEvent("show",this.showContentModuleFun)},_setTabWidgetStyles:function(){this.json.tabNodeContainer&&(this.tab.css.tabNodeContainer=Object.clone(this.json.tabNodeContainer)),this.json.contentNodeContainer&&(this.tab.css.contentNodeContainer=Object.clone(this.json.contentNodeContainer)),this.tab.css.tabNode=Object.clone(this.json.tabStyles),this.tab.css.tabTextNode=Object.clone(this.json.tabTextStyles),this.tab.css.tabNodeCurrent=Object.clone(this.json.tabCurrentStyles),this.tab.css.tabTextNodeCurrent=Object.clone(this.json.tabTextCurrentStyles)}}),MWF.xApplication.process.Xform.tab$Page=MWF.APPTab$Page=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.tab$Content=MWF.APPTab$Content=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.form._loadModules(this.node)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Table=MWF.APPTable=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.table||(this.table=this.node.getElement("table"));for(var t=this.table.rows,e=0;e<t.length;e++)for(var i=t[e],s=0;s<i.cells.length;s++){var o=i.cells[s],n=this.form._getDomjson(o);if(n)var a=this,r=this.form._loadModule(n,o,(function(){this.table=a}));this.form.modules.push(r)}},_loadBorderStyle:function(){this.json.styles&&this.json.styles.border&&(this.table||(this.table=this.node.getElement("table")),this.json.styles["table-layout"]&&this.table.setStyle("table-layout",this.json.styles["table-layout"]),this.table.set("cellspacing","0"),this.table.setStyles({"border-top":this.json.styles.border,"border-left":this.json.styles.border}),this.table.getElements("th").setStyles({"border-bottom":this.json.styles.border,"border-right":this.json.styles.border}),this.table.getElements("td").setStyles({"border-bottom":this.json.styles.border,"border-right":this.json.styles.border}))},_loadStyles:function(){Object.each(this.json.styles,function(t,e){e.test(/^border\w*/gi)||this.node.setStyle(e,t)}.bind(this)),"5.2"!==this.form.json.$version&&this._loadBorderStyle()}}),MWF.xApplication.process.Xform.Table$Td=MWF.APPTable$Td=new Class({Extends:MWF.APP$Module,_queryLoaded:function(){},_afterLoaded:function(){},_loadStyles:function(){var t={};"title"==this.json.cellType&&(t=this.table.json.titleTdStyles),"content"==this.json.cellType&&(t=this.table.json.contentTdStyles),"layout"==this.json.cellType&&(t=this.table.json.layoutTdStyles),Object.each(t,function(t,e){if(-1!==t.indexOf("x_processplatform_assemble_surface")||-1!==t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),t=o2.filterUrl(t),this.node.setStyle(e,t)}else this.json.preprocessing||this.node.setStyle(e,t)}.bind(this)),Object.each(this.json.styles,function(t,e){if(-1!==t.indexOf("x_processplatform_assemble_surface")||-1!==t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),t=o2.filterUrl(t)}this.node.setStyle(e,t)}.bind(this)),"content"==this.json.cellType&&this.form.addEvent("postLoad",function(){this.node.getElements("input").each(function(t){var e=t.get("type").toLowerCase();"radio"!=e&&"checkbox"!=e&&"submit"!=e&&"buttom"!=e&&"image"!=e&&t.setStyle("width","100%")}.bind(this)),this.node.getElements("textarea").each(function(t){t.setStyle("width","100%")}.bind(this))}.bind(this))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Textarea=MWF.APPTextarea=new Class({Implements:[Events],Extends:MWF.APP$Input,_loadUserInterface:function(){this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_setValue:function(t){t||(t="");var e=o2.promiseAll(t).then(function(e){if("array"==o2.typeOf(e)&&(e=e[0]),this._setBusinessData(e),this.node.getFirst()&&this.node.getFirst().set("value",e||""),this.readonly||this.json.isReadonly){var i=new RegExp("\n","g"),s=new RegExp("<","g"),o=new RegExp(">","g"),n=t.replace(s,"&lt").replace(o,"&gt").replace(i,"<br/>");this.node.set("html",n)}}.bind(this),(function(){}));return this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this)),t},_resetNodeEdit:function(){var t=new Element("textarea",{styles:{background:"transparent",width:"100%",border:"0px"}}),e=new Element("div",{styles:{ovwrflow:"hidden",position:"relative","padding-right":"2px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();t.set(this.json.properties),this.form.json.textareaDisableResize&&t.setStyle("resize","none"),this.node.set({id:this.json.id,MWFType:this.json.type}),this.node.addEvent("change",function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},_afterLoaded:function(){this.readonly||this.loadDescription()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||(e=t.x-23),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))}}),o2.widget.SimpleToolbar=new Class({Extends:o2.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(e),this.bindObject=i,this.items=[],this.children=[],this.childrenButton=[],this.childrenMenu=[],this.path=o2.session.path+"/widget/$SimpleToolbar/",this.cssPath=o2.session.path+"/widget/$SimpleToolbar/"+this.options.style+"/css.wcss",this._loadCss(),this.node=$(t),this.node.onselectstart=function(){return!1},this.node.oncontextmenu=function(){return!1}},load:function(){this.fireEvent("queryLoad")&&(this.node.set("styles",this.css.container),this._loadToolbarItemNode(),this._loadToolbarItems(),this.fireEvent("postLoad"))},_loadToolbarItemNode:function(){this.node.getChildren().each(function(t,e){var i=t.get("MWFnodetype");i&&("array"==typeOf(this[i])||(this[i]=[]),this[i].push(t))}.bind(this))},_loadToolbarItems:function(){this._loadToolBarButton(this.MWFToolBarButton)},_loadToolBarButton:function(t){t&&t.each(function(t,e){var i=new o2.widget.SimpleToolbarButton(t,this,this.options);i.load(),this.fireEvent("buttonLoad",[i]),i.buttonID&&(this.items[i.buttonID]=i),this.children.push(i),this.childrenButton.push(i)}.bind(this))}}),o2.widget.SimpleToolbarButton=new Class({Implements:[Options,Events],options:{text:"",title:"",pic:"",pic_over:"",action:"",actionScript:"",disable:!1},initialize:function(t,e,i){if(this.setOptions(i),this.node=$(t),this.toolbar=e,this.buttonID=this.node.MWFnodeid||this.node.id,this.node){var s=this.node.get("MWFButtonText");s&&(this.options.text=s);var o=this.node.get("title");o&&(this.options.title=o);var n=this.node.get("MWFButtonImage");n&&(this.options.pic=n);var a=this.node.get("MWFButtonImageOver");a&&(this.options.pic_over=a),this.node.get("MWFButtonDisable")&&(this.options.disable=!0);var r=this.node.get("MWFButtonAction");r&&(this.options.action=r)}else this.node=new Element("div").inject(this.toolbar.node);this.modifiyStyle=!0},load:function(){this._addButtonEvent(),this.node.title=this.options.title,this.node.set("styles",this.toolbar.css.button),this.options.pic&&(this.picNode=this._createImageNode(this.options.pic)),this.options.text&&(this.textNode=this._createTextNode(this.options.text)),this.setDisable(this.options.disable)},enable:function(){this.options.disable&&(this.setDisable(!1),this.options.disable=!1)},disable:function(){this.options.disable||(this.setDisable(!0),this.options.disable=!0)},setDisable:function(t){if(t){if(this.node.set("styles",this.toolbar.css.buttonDisable),this.picNode){this.picNode.set("styles",this.toolbar.css.buttonImgDivDisable);var e=(s=(i=this.picNode.getElement("img")).get("src")).substr(s.lastIndexOf("."),s.length);s=(s=s.substr(0,s.lastIndexOf(".")))+"_gray"+e,this.src_gray=s,i.set("src",s)}this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDivDisable)}else{var i,s;if(this.node.set("styles",this.toolbar.css.button),this.picNode)this.picNode.set("styles",this.toolbar.css.buttonImgDiv),s=(s=(i=this.picNode.getElement("img")).get("src")).replace("_gray",""),this.src_gray=s,i.set("src",s);this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDiv)}},_createImageNode:function(t){if(t){var e=new Element("span",{styles:this.toolbar.css.buttonImgDiv}).inject(this.node);this.img=new Element("img",{styles:this.toolbar.css.buttonImg,src:t}).inject(e);return e}return null},_createTextNode:function(t){return t?new Element("span",{styles:this.toolbar.css.buttonTextDiv,text:t}).inject(this.node):null},_addButtonEvent:function(){this.node.addEvent("mouseover",this._buttonMouseOver.bind(this)),this.node.addEvent("mouseout",this._buttonMouseOut.bind(this)),this.node.addEvent("mousedown",this._buttonMouseDown.bind(this)),this.node.addEvent("mouseup",this._buttonMouseUp.bind(this)),this.node.addEvent("click",this._buttonClick.bind(this))},_buttonMouseOver:function(){this.modifiyStyle&&(this.options.disable||(this.options.pic_over&&this.img.set("src",this.options.pic_over),this.node.set("styles",this.toolbar.css.buttonOver)))},_buttonMouseOut:function(){this.modifiyStyle&&(this.options.disable||(this.img.set("src",this.options.pic),this.node.set("styles",this.toolbar.css.buttonOut)))},_buttonMouseDown:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonDown))},_buttonMouseUp:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonUp))},_buttonClick:function(t){if(!this.options.disable&&this.options.action){var e=this.options.action.split(":"),i=e.shift(),s=this.toolbar.bindObject?this.toolbar.bindObject:window;s[i]?(e.push(this),e.push(t),s[i].apply(s,e)):window[i]&&window[i].apply(this,e)}}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.CMS$Input_Process||(MWF.CMS$Input_Process={validationConfigItem:MWF.xApplication.process.Xform.$Input.prototype.validationConfigItem.$origin,_loadStyles:MWF.xApplication.process.Xform.$Input.prototype._loadStyles.$origin},MWF.xApplication.process.Xform.$Input.implement({_loadStyles:function(){return this.form.app.options.name.toLowerCase().contains("cms")?this._loadStyles_CMS():this._loadStyles_Process()},_loadStyles_Process:MWF.CMS$Input_Process._loadStyles,_loadStyles_CMS:function(){if(this.json.styles&&this.node.setStyles(this.json.styles),this.readonly){var t=this.node.parentNode;if("td"==t.tagName.toLowerCase())t.getStyle("borderBottomWidth").toInt()>0&&this.node.setStyle("border","0px")}if(this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var e=this.node.getSize();this.iconNode.setStyle("height",e.y+"px")}},validationConfigItem:function(t,e){return this.form.app.options.name.toLowerCase().contains("cms")?this.validationConfigItem_CMS(t,e):this.validationConfigItem_Process(t,e)},validationConfigItem_Process:MWF.CMS$Input_Process.validationConfigItem,validationConfigItem_CMS:function(t,e){if("all"==e.status||"publish"==t){var i=this.getInputData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}})),MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Xform=MWF.xApplication.cms.Xform||{},MWF.xApplication.cms.Xform.ModuleImplements={},MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{},MWF.xApplication.cms.Xform=MWF.xApplication.cms.Xform||{},MWF.require("MWF.xScript.CMSMacro",null,!1),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("cms.Xform","ModuleImplements",null,!1),MWF.xDesktop.requireApp("process.Xform","Div",null,!1),MWF.xApplication.cms.Xform.Div=MWF.CMSDiv=new Class({Extends:MWF.APPDiv}),MWF.xDesktop.requireApp("process.Xform","Common",null,!1),MWF.xApplication.cms.Xform.Common=MWF.CMSCommon=new Class({Extends:MWF.APPCommon}),MWF.xDesktop.requireApp("process.Xform","Image",null,!1),MWF.xApplication.cms.Xform.Image=MWF.CMSImage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){if(this.json.properties&&this.json.properties.src){var t=this.json.properties.src;if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")||-1!=t.indexOf("x_cms_assemble_control")){var e=MWF.Actions.getHost("x_processplatform_assemble_surface"),i=MWF.Actions.getHost("x_portal_assemble_surface"),s=MWF.Actions.getHost("x_cms_assemble_control");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",i+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",i+"/x_portal_assemble_surface")),-1!==t.indexOf("/x_cms_assemble_control")?t=t.replace("/x_cms_assemble_control",s+"/x_cms_assemble_control"):-1!==t.indexOf("x_cms_assemble_control")&&(t=t.replace("x_cms_assemble_control",s+"/x_cms_assemble_control")),t=o2.filterUrl(t)}try{this.node.set("src",t)}catch(t){}}else if(this.json.srcfile&&"none"!=this.json.srcfile)if(t=this.json.srcfile,"object"===typeOf(t)){var o=t.portal?MWF.xDesktop.getPortalFileUr(t.id,t.portal):MWF.xDesktop.getProcessFileUr(t.id,t.application);o=o2.filterUrl(o),this.node.set("src",o)}else{var n=MWF.Actions.getHost("x_portal_assemble_surface"),a=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;t=n+"/x_portal_assemble_surface"+(a=(a=a.replace("{flag}",t)).replace("{applicationFlag}",this.form.json.application)),t=o2.filterUrl(t),this.node.set("src",t)}else if("object"==typeOf(this.json.src)){var r=MWF.xDesktop.getImageSrc(this.json.src.imageId);this.node.set("src",r)}}}),MWF.xDesktop.requireApp("process.Xform","Html",null,!1),MWF.xApplication.cms.Xform.Html=MWF.CMSHtml=new Class({Extends:MWF.APPHtml}),MWF.xApplication.cms.Xform.Package={},MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Xform=MWF.xApplication.cms.Xform||{},MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xDesktop.requireApp("process.Xform","Form",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("cms.Xform","Package",null,!1),MWF.xApplication.cms.Xform.Form=MWF.CMSForm=new Class({Implements:[Options,Events],Extends:MWF.APPForm,options:{style:"default",readonly:!1,cssPath:"",autoSave:!1,saveOnClose:!1,showAttachment:!0,moduleEvents:["queryLoad","beforeLoad","beforeModulesLoad","postLoad","afterModulesLoad","afterLoad","beforeSave","postSave","afterSave","beforeClose","beforePublish","postPublish","afterPublish","beforeDelete","afterDelete","resize"]},initialize:function(t,e,i){this.setOptions(i),this.container=$(t),this.container.setStyle("-webkit-user-select","text"),this.data=e,this.json=e.json,this.html=e.html,this.path="../x_component_cms_Xform/$Form/",this.cssPath=this.options.cssPath||"../x_component_cms_Xform/$Form/"+this.options.style+"/css.wcss",this._loadCss(),this.modules=[],this.all={},this.forms={}},load:function(t){this.app&&(this.app.formNode&&this.app.formNode.setStyles(this.json.styles),this.app.addEvent&&this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this))),this.Macro=new MWF.CMSMacro.CMSFormContext(this),this.loadLanguage(function(e){if(e&&this.formDataText){var i=o2.bindJson(this.formDataText,{lp:MWF.xApplication.cms.Xform.LP.form});this.data=JSON.parse(i),this.json=this.data.json,this.html=this.data.html}this.container.set("html",this.html),this.node=this.container.getFirst(),this._loadEvents(),this.loadRelatedScript(),this.fireEvent("queryLoad")&&(this._loadBusinessData(),this.fireEvent("beforeLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeLoad"),this.loadContent(t))}.bind(this))},loadLanguage:function(t){if(MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,!1),"script"!==this.json.languageType&&"default"!==this.json.languageType)return t&&t(),!0;MWF.xApplication.cms.Xform.LP.form;var e=null;if("script"==this.json.languageType)this.json.languageScript&&this.json.languageScript.code&&(e=this.Macro.exec(this.json.languageScript.code,this));else if("default"==this.json.languageType){var i="lp-"+o2.language,s=this.businessData.document.appId,o=this.documentAction.getDictRoot(i,s,(function(t){return t.data}),(function(){})),n=this.documentAction.getScriptByNameV2(i,s,function(t){return this.Macro.exec(t.data.text,this)}.bind(this),(function(){}));e=Promise.any([o,n])}e?e.then&&"function"==o2.typeOf(e.then)?e.then((function(e){MWF.xApplication.cms.Xform.LP.form=Object.merge(MWF.xApplication.cms.Xform.LP.form,e),t&&t(!0)}),(function(){t&&t(!0)})):(MWF.xApplication.cms.Xform.LP.form=Object.merge(MWF.xApplication.cms.Xform.LP.form,e),t&&t(!0)):t&&t(!0)},loadRelatedScript:function(){if(this.json.includeScripts&&this.json.includeScripts.length){var t="",e=[];this.json.includeScripts.each(function(i){this.app.relatedScriptMap&&this.app.relatedScriptMap[i.id]&&(t+="\n"+this.app.relatedScriptMap[i.id].text,e.push(i.id))}.bind(this)),t&&this.Macro.exec(t,this)}},loadContent:function(t){this.subformCount=0,this.subformLoadedCount=0,this.subformLoaded=[this.json.id],this._loadHtml(),this._loadForm(),this.fireEvent("beforeModulesLoad"),this._loadModules(this.node),this.options.readonly||(this.options.autoSave&&this.autoSave(),this.app.addEvent("queryClose",function(){this.options.saveOnClose&&"draft"==this.businessData.document.docStatus&&this.saveDocument(null,!0),Object.each(this.forms,(function(t,e){"Htmleditor"==t.json.type&&t.editor&&(CKEDITOR.remove(t.editor),delete t.editor)}))}.bind(this))),this.fireEvent("afterModulesLoad"),this.fireEvent("postLoad"),this.fireEvent("afterLoad"),this.app&&this.app.fireEvent&&(this.app.fireEvent("afterModulesLoad"),this.app.fireEvent("postLoad"),this.app.fireEvent("afterLoad")),this.app&&this.app.mobile&&t&&t()},autoSave:function(){},_loadBusinessData:function(){this.businessData||(this.businessData={data:{}})},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)):"load"==e?this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this)):"submit"==e?this.addEvent("beforePublish",function(){return this.Macro.fire(t.code,this)}.bind(this)):this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},_loadModules:function(t){this._getModuleNodes(t).each(function(t){var e=this._getDomjson(t);if((this.options.showAttachment||"Attachment"!=e.type)&&(!this.app.mobile||"Actionbar"!==e.type)){var i=this._loadModule(e,t);this.modules.push(i)}}.bind(this))},_loadModule:function(t,e,i){if(t){MWF["CMS"+t.type]||MWF.xDesktop.requireApp("cms.Xform",t.type,null,!1);var s=new MWF["CMS"+t.type](e,t,this);return i&&i.apply(s),this.all[t.id]||(this.all[t.id]=s),s.field&&(this.forms[t.id]||(this.forms[t.id]=s)),s.readonly=this.options.readonly,s.load(),s}},trim:function(t){var e=[];return t.each((function(t){t&&e.push(t)})),e},transportPermissionData:function(t,e){var i=[];return t.each((function(t){var s="string"===typeOf(t)?t:t.distinguishedName;if(s){var o,n;switch(s.substr(s.length-1,1).toLowerCase()){case"i":case"p":o="人员";break;case"u":o="组织";break;case"g":o="群组";break;case"r":o="角色";break;default:o=""}if(o)n="object"===typeOf(t)&&t.name?t.name:MWF.name&&MWF.name.cn?MWF.name.cn(s):s.split("@")[0],i.push({permission:"author"==e?"作者":"阅读",permissionObjectType:o,permissionObjectName:n,permissionObjectCode:s})}})),i.length>0?i:null},getSpecialData:function(){var t=this.businessData.data,e=[],i=[],s=[],o=[],n="";if(Object.each(this.forms,(function(a,r){if("Readerfield"!=a.json.type&&"Reader"!=a.json.type||(e="yes"==a.json.section?e.concat(this.getSectionData(a,t[r])):e.concat(a.getData())),"Authorfield"!=a.json.type&&"Author"!=a.json.type||(i="yes"==a.json.section?i.concat(this.getSectionData(a,t[r])):i.concat(a.getData())),"ImageClipper"==a.json.type){var l=a.getData();l&&s.push(l)}if("Htmleditor"==a.json.type){var d=a.getText();n=d.substr(0,80),o=o.concat(a.getImageIds())}})),t.processOwnerList&&"array"==typeOf(t.processOwnerList)){var a={personValue:[]};t.processOwnerList.each((function(t){a.personValue.push({name:t,type:"person"})})),e=e.concat(a)}return{readers:this.transportPermissionData(e,"reader"),authors:this.transportPermissionData(i,"author"),pictures:s,summary:n,cloudPictures:o}},getDocumentData:function(t){var e=Object.clone(this.businessData.document);return t.subject&&(e.title=t.subject,e.subject=t.subject,this.businessData.document.title=t.subject,this.businessData.document.subject=t.subject),e.isNewDocument=!1,e},saveDocument:function(t,e){if(this.fireEvent("beforeSave"),"published"==this.businessData.document.docStatus&&!this.formValidation("publish"))return this.app.content.unmask(),!1;if(!this.formSaveValidation())return this.app.content.unmask(),t&&t(),!1;var i=this.getData(),s=this.getSpecialData(),o=this.getDocumentData(i);o.readerList=s.readers,o.authorList=s.authors,o.pictureList=s.pictures,o.summary=s.summary,o.cloudPictures=s.cloudPictures,o.docData=i,delete o.attachmentList,this.fireEvent("postSave",[o]),this.officeList&&this.officeList.each((function(t){t.save()})),this.documentAction.saveDocument(o,function(){this.app.notice(MWF.xApplication.cms.Xform.LP.dataSaved,"success"),this.businessData.data.isNew=!1,this.fireEvent("afterSave"),t&&t()}.bind(this),null,!e)},closeDocument:function(){this.fireEvent("beforeClose"),this.app&&this.app.close()},printDocument:function(t){(t=t)||(t=this.json.id,this.json.printForm&&"none"!==this.json.printForm&&(t=this.json.printForm)),window.open(o2.filterUrl("../x_desktop/printcmsdoc.html?documentid="+this.businessData.document.id+"&form="+t))},formValidation:function(t){if(this.options.readonly)return!0;var e=!0;return Object.each(this.forms,function(i,s){i.validationMode(),i.validation(t)||(e=!1)}.bind(this)),e},formSaveValidation:function(){if(!this.json.validationSave)return!0;if(!this.json.validationSave.code)return!0;var t=this.Macro.exec(this.json.validationSave.code,this);if(t||(t=MWF.xApplication.cms.Xform.LP.notValidation),"string"===typeOf(t)){if("true"!==t)return this.app.notice(t,"error"),!1}else if("true"!=t.toString())return!1;return!0},formPublishValidation:function(){if(!this.json.validationPublish)return!0;if(!this.json.validationPublish.code)return!0;var t=this.Macro.exec(this.json.validationPublish.code,this);if(t||(t=MWF.xApplication.cms.Xform.LP.notValidation),"string"===typeOf(t)){if("true"!==t)return this.app.notice(t,"error"),!1}else if("true"!=t.toString())return!1;return!0},publishDocument:function(t){if(this.fireEvent("beforePublish"),this.app.content.mask({destroyOnHide:!0,style:this.app.css.maskNode}),!this.formValidation("publish"))return this.app.content.unmask(),!1;if(!this.formPublishValidation())return this.app.content.unmask(),t&&t(),!1;var e=this.getData(),i=this.getSpecialData(),s=this.getDocumentData(e);s.readerList=i.readers,s.authorList=i.authors,s.pictureList=i.pictures,s.summary=i.summary,s.cloudPictures=i.cloudPictures,s.docData=e,delete s.attachmentList,this.fireEvent("postPublish",[s]),this.app&&this.app.fireEvent&&this.app.fireEvent("postPublish",[s]),this.officeList&&this.officeList.each((function(t){t.save()})),this.documentAction.publishDocumentComplex(s,function(e){if(this.businessData.data.isNew=!1,this.fireEvent("afterPublish",[this,e.data]),this.app&&this.app.fireEvent&&this.app.fireEvent("afterPublish",[this,e.data]),t&&t(),this.app.mobile?this.app.content.unmask():(this.businessData.document.title?this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished+": “"+this.businessData.document.title+"”","success"):this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished,"success"),this.options.saveOnClose=!1),layout.inBrowser){try{window.opener&&window.opener.o2RefreshCMSView&&window.opener.o2RefreshCMSView()}catch(t){}window.setTimeout(function(){this.app.close()}.bind(this),1500)}else this.app.close()}.bind(this))},deleteDocumentForMobile:function(){this.app.mobile&&(this.app.content.mask({style:{"background-color":"#999",opacity:.6}}),this.fireEvent("beforeDelete"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeDelete"),this.documentAction.removeDocument(this.businessData.document.id,function(t){this.fireEvent("afterDelete"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterDelete"),this.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete+": “"+this.businessData.document.title+"”","success"),this.options.autoSave=!1,this.options.saveOnClose=!1,this.fireEvent("postDelete"),this.app.close()}.bind(this)))},deleteDocument:function(){var t=this,e=MWF.getCenterPosition(this.app.content,380,150),i={event:{x:e.x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.cms.Xform.LP.deleteDocumentTitle,MWF.xApplication.cms.Xform.LP.deleteDocumentText,380,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.documentAction.removeDocument(t.businessData.document.id,function(e){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete+": “"+t.businessData.document.title+"”","success"),t.options.autoSave=!1,t.options.saveOnClose=!1,t.fireEvent("postDelete"),t.app.close(),this.close()}.bind(this))}),(function(){this.close()}))},editDocument:function(){if(this.app.inBrowser)this.modules.each((function(t){MWF.release(t)})),this.app.node.destroy(),this.app.options.readonly=!1,this.app.loadApplication();else{var t={documentId:this.businessData.document.id,readonly:!1};this.app.options.postPublish&&(t.postPublish=this.app.options.postPublish),this.app.options.afterPublish&&(t.afterPublish=this.app.options.afterPublish),this.app.options.postDelete&&(t.postDelete=this.app.options.postDelete),this.app.options.formEditId&&(t.formEditId=this.app.options.formEditId),this.app.desktop.openApplication(null,"cms.Document",t),this.app.close()}},editDocumentForMobile:function(){this.app.mobile&&(this.app.options.readonly=!1,this.app.loadDocument(this.app.options))},setPopularDocument:function(){this.app.setPopularDocument()},printWork:function(t,e){t||this.businessData.work.application;(e=e)||(e=this.json.id,this.json.printForm&&(e=this.json.printForm)),window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+e))},openWindow:function(t,e){(t=t)||(t=this.json.id),this.businessData.document},uploadedAttachment:function(t,e){this.documentAction.getAttachment(e,this.businessData.document.id,function(e){var i=this.all[t];i&&(e.data&&i.attachmentController.addAttachment(e.data),i.attachmentController.checkActions(),i.fireEvent("upload",[e.data]))}.bind(this))},replacedAttachment:function(t,e){this.documentAction.getAttachment(e,this.businessData.document.id,function(i){var s=this.all[t];if(s){for(var o=s.attachmentController,n=null,a=0;a<o.attachments.length;a++)if(o.attachments[a].data.id===e){n=o.attachments[a];break}n.data=i.data,n.reload(),o.checkActions()}}.bind(this))}}),MWF.xApplication.cms.Xform.widget=MWF.xApplication.cms.Xform.widget||{},MWF.xApplication.cms.Xform.widget.Log=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",mode:"table",documentId:"",textStyle:""},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.node=e,this.path="../x_component_cms_Xform/widget/$Log/",this.cssPath="../x_component_cms_Xform/widget/$Log/"+this.options.style+"/css.wcss",this._loadCss(),MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,!1),this.lp=MWF.xApplication.cms.Xform.LP},load:function(){this.items=[],this.documents={},this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadItemQueue=0,this.count=0,this.lineHeight="text"!=this.options.mode?32:25,this.countPerPage=20,this.container=new Element("div",{styles:this.css.container}).inject(this.node),this.loadTitle(),this.loadContent(),this.loadElementList(),this.loadBottom()},loadTitle:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.lp.readedLogTitle}).inject(this.container)},loadTotal:function(){this.getAction(function(){this.options.documentId&&this.restAction.invoke({name:"getReadCount",async:!0,parameter:{docId:this.options.documentId},success:function(t){t&&t.data&&(this.titleCountNode=new Element("div",{styles:this.css.titleCountNode,text:this.lp.readedCountText.replace("{count}",t.data.count).replace("{person}",this.dataCount)}).inject(this.titleNode))}.bind(this)})}.bind(this))},loadContent:function(){this.contentScrollNode=new Element("div",{styles:this.css.contentScrollNode}).inject(this.container),this.contentScrollNode.setStyles({width:this.node.getSize().x-10,"margin-right":"10px"}),this.contentWrapNode=new Element("div",{styles:this.css.contentWrapNode}).inject(this.contentScrollNode),this.setScroll(),"table"==this.options.mode&&this.loadItemTitleTable()},loadBottom:function(){var t=new Element("div",{styles:this.css.bottomNode}).inject(this.container),e=new Element("div",{styles:this.css.bottomResizeNode,text:"◢"}).inject(t),i=this.contentScrollNode.getSize().x;this.contentScrollNode.makeResizable({handle:e,limit:{x:[i,i],y:[50,null]},onDrag:function(){var t=this.contentScrollNode.getSize().y;t>this.lineHeight*this.countPerPage-20&&(this.countPerPage=parseInt(t/this.lineHeight)+2),this.contentScrollNode.fireEvent("resize")}.bind(this),onComplete:function(){this.scrollBar.checkScroll(),this.loadElementList()}.bind(this)})},loadElementList:function(t){this.isItemsLoaded||(this.isItemLoadding?this.loadItemQueue++:(this.isItemLoadding=!0,this._getCurrentPageData(function(t){var e=this.dataCount=t.count;this.titleCountNode||this.loadTotal(),0==this.items.length&&this.setSize(),e<=this.items.length&&(this.isItemsLoaded=!0),t.data&&"array"==typeOf(t.data)&&t.data.each(function(t){var e=t.id;if(!this.documents[e]){var i=this._createDocument(t,this.items.length);this.items.push(i),this.documents[e]=i}}.bind(this)),this.isItemLoadding=!1,this.loadItemQueue>0&&(this.loadItemQueue--,this.loadElementList())}.bind(this),t)))},_getCurrentPageData:function(t){var e=this.items.length?this.items[this.items.length-1].data.id:"(0)";this.getAction(function(){this.options.documentId&&this.restAction.invoke({name:"listReadedLog",async:!0,parameter:{docId:this.options.documentId,id:e,count:this.countPerPage},success:function(e){t&&t(e)}.bind(this)})}.bind(this))},getAction:function(t){this.action?t&&t():MWF.require("MWF.xDesktop.Actions.RestActions",function(){this.restAction=new MWF.xDesktop.Actions.RestActions("","x_cms_assemble_control",""),this.restAction.getActions=function(t){this.actions={getReadCount:{uri:"/jaxrs/document/{docId}/view/count"},listReadedLog:{uri:"/jaxrs/viewrecord/document/{docId}/filter/list/{id}/next/{count}",method:"GET"}},t&&t()},t&&t()}.bind(this))},setSize:function(){var t=this.lineHeight,e="text"==this.options.mode?10:8;if(this.dataCount>e)var i=e*t-15;else if(this.dataCount<=1)i=1*t;else i=this.dataCount*t;"text"!=this.options.mode&&(i+=t),this.contentScrollNode.setStyle("height",i+"px")},setScroll:function(){MWF.require("MWF.widget.ScrollBar",function(){this.scrollBar=new MWF.widget.ScrollBar(this.contentScrollNode,{indent:!1,style:"default",where:"before",distance:60,friction:4,axis:{x:!1,y:!0},onScroll:function(t){var e=this.contentScrollNode.getScrollSize(),i=this.contentScrollNode.getSize();t+30>e.y-i.y&&(this.isItemsLoaded||this.loadElementList())}.bind(this)})}.bind(this))},_createDocument:function(t){return{node:"text"==this.options.mode?this.options.textStyle?this.loadItemNodeText(t):this.loadItemNodeDefault(t):this.loadItemNodeTable(t),data:t}},loadItemTitleTable:function(){var t=this.contentScrollNode.getSize().x;this.table=new Element("table",{styles:this.css.logTable,border:"0",cellSpacing:"0",cellpadding:"3px",width:t-10}).inject(this.contentWrapNode),this.tbody=new Element("tbody").inject(this.table),this.table.setStyles({"margin-left":"8px"});var e=new Element("tr").inject(this.tbody);e.setStyles(this.css.logTableTitleTr),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.person),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.department),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.firstDate),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.readDate),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.readCount)},loadItemNodeTable:function(t){var e=new Element("tr").inject(this.tbody);e.setStyles(this.css.logTableContentTr);var i=new Element("td",{styles:this.css.logTableContent}).inject(e);i.set("text",this.getShortName(t.viewerName)||""),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",this.getShortName(t.viewerUnitName)||""),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.createTime),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.lastViewTime),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.viewCount)},loadItemNodeText:function(t,e){var i=new Element("div",{styles:this.css.defaultItemNode}).inject(this.contentWrapNode),s=e||this.options.textStyle;return s=(s=(s=(s=(s=(s=s.replace(/\{person\}/g,this.getShortName(t.viewerName))).replace(/\{unitName\}/g,this.getShortName(t.viewerUnitName)||"")).replace(/\{topUnitName\}/g,this.getShortName(t.viewerTopUnitName)||"")).replace(/\{firstDate\}/g,t.createTime)).replace(/\{date\}/g,t.lastViewTime)).replace(/\{count\}/g,t.viewCount),i.set("html",s),i},loadItemNodeDefault:function(t){return this.loadItemNodeText(t,this.lp.defaultReadedLogText)},getShortName:function(t){return t&&t.contains("@")?t.split("@")[0]:t}}),MWF.xDesktop.requireApp("process.Xform","Org",null,!1),MWF.xApplication.cms.Xform.Org=MWF.CMSOrg=new Class({Extends:MWF.APPOrg,_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.CMSOrg.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.CMSOrg.UnitOptions(this.form,this.json)),this.selectTypeList.contains("group")&&(this.groupOptions=new MWF.APPOrg.GroupOptions(this.form,this.json))}}),MWF.CMSOrg.IdentityOptions=new Class({Extends:MWF.APPOrg.IdentityOptions,_getSelectRange:function(){if("unit"===this.json.identityRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.identityRange){var t=this.form.businessData.document.creatorIdentity;if(t)return this.getNextSelectUnit(t);if(layout.session.user.identityList&&layout.session.user.identityList.length){var e=[];return layout.session.user.identityList.each((function(t){e.push(t.id)})),this.getNextSelectUnit(e)}return[]}if("currentUnit"===this.json.identityRange){if(layout.session.user.identityList&&layout.session.user.identityList.length){e=[];return layout.session.user.identityList.each((function(t){e.push(t.id)})),this.getNextSelectUnit(e)}return[]}return[]}}),MWF.CMSOrg.UnitOptions=new Class({Extends:MWF.APPOrg.UnitOptions,_getSelectRange:function(){if("unit"===this.json.unitRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.unitRange){var t=this.form.businessData.document.creatorIdentity;if(t)return this.getNextSelectUnit(t);if(layout.session.user.identityList&&layout.session.user.identityList.length){var e=[];return layout.session.user.identityList.each((function(t){e.push(t.id)})),this.getNextSelectUnit(e)}return[]}if("currentUnit"===this.json.unitRange){if(layout.session.user.identityList&&layout.session.user.identityList.length){e=[];return layout.session.user.identityList.each((function(t){e.push(t.id)})),this.getNextSelectUnit(e)}return[]}return[]}}),MWF.xDesktop.requireApp("cms.Xform","Org",null,!1),MWF.xApplication.cms.Xform.Author=MWF.CMSAuthor=new Class({Extends:MWF.CMSOrg,iconStyle:"authorIcon"}),MWF.xDesktop.requireApp("cms.Xform","Org",null,!1),MWF.xApplication.cms.Xform.Reader=MWF.CMSReader=new Class({Extends:MWF.CMSOrg,iconStyle:"readerIcon"}),MWF.xDesktop.requireApp("process.Xform","Textfield",null,!1),MWF.xApplication.cms.Xform.Textfield=MWF.CMSTextfield=new Class({Extends:MWF.APPTextfield}),MWF.xDesktop.requireApp("process.Xform","Actionbar",null,!1),MWF.xApplication.cms.Xform.Actionbar=MWF.CMSActionbar=new Class({Extends:MWF.APPActionbar,reload:function(){this._loadUserInterface()},_loadUserInterface:function(){this.toolbarNode=this.node.getFirst("div"),this.toolbarNode||(this.toolbarNode=this.node),this.toolbarNode&&this.toolbarNode.empty(),MWF.require("MWF.widget.SimpleToolbar",function(){if(this.toolbarWidget=new MWF.widget.SimpleToolbar(this.toolbarNode,{style:this.json.style,onPostLoad:function(){this.fireEvent("afterLoad")}.bind(this)},this),this.json.actionStyles&&(this.toolbarWidget.css=this.json.actionStyles),this.json.multiTools){var t=JSON.stringify(this.json.multiTools);t=o2.bindJson(t,{lp:MWF.xApplication.cms.Xform.LP.form}),this.json.multiTools=JSON.parse(t),this.json.multiTools.each(function(t){t.system?this.json.hideSystemTools||this.setToolbars([t],this.toolbarNode,this.readonly):this.setCustomToolbars([t],this.toolbarNode)}.bind(this)),this.toolbarWidget.load()}else this.json.hideSystemTools?(this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):this.json.defaultTools?(this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):MWF.getJSON("../x_component_cms_Xform/$Form/toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),!1)}.bind(this))},setCustomToolbars:function(t,e){var i,s="../x_component_cms_FormDesigner/Module/Actionbar/";i=this.json.customIconStyle?this.json.customIconStyle:(this.json.style||"default").indexOf("red")>-1?"red":"blue";var o=this.json.customIconOverStyle||"white";t.each(function(t){var n=!0;if(n=this.readonly?t.readShow:t.editShow){if(n=!0,t.control&&(n=this.form.businessData.control[t.control]),t.condition)n=!this.form.Macro.exec(t.condition,this);if(n){var a=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:s+""+this.form.options.style+"/custom/"+i+"/"+t.img,MWFButtonImageOver:s+""+this.form.options.style+"/custom/"+o+"/"+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(e);if(t.properties&&a.set(t.properties),t.actionScript&&a.store("script",t.actionScript),t.sub){var r=e.getLast();this.setCustomToolbars(t.sub,r)}}}}.bind(this))},setToolbars:function(t,e,i,s){t.each(function(t){var o=!0;if(t.control&&(o=this.form.businessData.control[t.control]),!s&&t.condition){var n=this.form.Macro.exec(t.condition,this);o=o&&!n}if(i?t.read||(o=!1):t.edit||(o=!1),this.json.hideSetPopularDocumentTool&&"action_popular"==t.id&&(o=!1),o){new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:"../x_component_cms_FormDesigner/Module/Actionbar/"+(this.options.style||"default")+"/tools/"+(this.json.style||"default")+"/"+t.img,MWFButtonImageOver:"../x_component_cms_FormDesigner/Module/Actionbar/"+(this.options.style||"default")+"/tools/"+(this.json.style||"default")+"/"+t.img_over,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(e);if(t.sub){var a=e.getLast();this.setToolbars(t.sub,a)}}}.bind(this))},runCustomAction:function(t){var e=t.node.retrieve("script");this.form.Macro.exec(e,this)},saveDocument:function(){this.form.saveDocument()},saveDraftDocument:function(){this.form.saveDocument()},closeDocument:function(){this.form.closeDocument()},publishDocument:function(){this.form.publishDocument()},archiveDocument:function(){this.form.archiveDocument()},redraftDocument:function(){this.form.redraftDocument()},deleteDocument:function(){this.form.deleteDocument()},editDocument:function(){this.form.editDocument()},setPopularDocument:function(){this.form.setPopularDocument()},printDocument:function(){this.form.printDocument()}}),MWF.xDesktop.requireApp("process.Xform","Attachment",null,!1),MWF.xApplication.cms.Xform.AttachmentController=new Class({Extends:MWF.xApplication.process.Xform.AttachmentController,options:{checkTextEnable:!1},openInOfficeControl:function(t,e){e&&(e.openedAttachment&&e.openedAttachment.id===t.id||(e.save(),MWF.Actions.get("x_cms_assemble_control").getAttachmentUrl(t.id,this.module.form.businessData.document.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this))))},setAttachmentConfig:function(t,e,i){if(this.selectedAttachments.length){var s=t.retrieve("data-value"),o=e.retrieve("data-value"),n=i.retrieve("data-value"),a=[],r=[],l=[],d=[],c=[],h=[];s&&s.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&a.push(e),"I"===s&&r.push(e)})),o&&o.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&l.push(e),"I"===s&&d.push(e)})),n&&n.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&c.push(e),"I"===s&&h.push(e)})),this.selectedAttachments.each(function(t){t.data.readUnitList=a,t.data.readIdentityList=r,t.data.editUnitList=l,t.data.editIdentityList=d,t.data.controllerUnitList=c,t.data.controllerIdentityList=h,o2.Actions.get("x_cms_assemble_control").configAttachment(t.data.id,this.module.form.businessData.document.id,t.data)}.bind(this))}},sortByNumber:function(t){return t.sort(function(t,e){return e.data.seqNumber?t.data.seqNumber?t.data.seqNumber-e.data.seqNumber:-1:1}.bind(this))},sortAttachment:function(t){t.getChildren().each(function(t,e){var i=t.retrieve("att",null);i&&(i.data.seqNumber=e,o2.Actions.load("x_cms_assemble_control").FileInfoAction.changeSeqNumber(i.data.id,this.module.form.businessData.document.id,e))}.bind(this)),this.attachments=this.attachments.sort(function(t,e){return e.data.seqNumber?t.data.seqNumber?t.data.seqNumber-e.data.seqNumber:-1:1}.bind(this)),this.reloadAttachments(),this.fireEvent("order")}}),MWF.xApplication.cms.Xform.Attachment=MWF.CMSAttachment=new Class({Extends:MWF.APPAttachment,_loadUserInterface:function(){this.node.empty(),this.loadAttachmentController(),this.fireEvent("load")},loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.cms.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isPreviewAtt:"y"===this.json.isPreviewAtt||"true"===this.json.isPreviewAtt,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json&&this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.cms.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},loadAttachmentSelecter:function(t,e){MWF.require("MWF.widget.AttachmentSelector",function(){var i={title:MWF.xApplication.cms.Xform.LP.selectAttachment,listStyle:"icon",selectType:"all",size:"max",attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,toBase64:!0,base64MaxSize:800,readonly:!1};i=Object.merge(i,t),this.readonly&&(i.readonly=!0),this.attachmentController=new MWF.widget.AttachmentSelector(this.node,this,i),this.attachmentController.load(),this.postSelect=e,this.form.businessData.attachmentList.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},selectAttachment:function(t,e,i){if(i.length>0){var s=i[i.length-1].data;this.form.documentAction.getAttachmentUrl(s.id,this.form.businessData.document.id,function(t){this.attachmentController.options.toBase64?this.form.documentAction.getSubjectAttachmentBase64(s.id,this.attachmentController.options.base64MaxSize,function(e){var i=e.data?"data:image/png;base64,"+e.data.value:null;this.postSelect&&this.postSelect(t,s,i)}.bind(this)):this.postSelect&&this.postSelect(t,s)}.bind(this))}},createUploadFileNode:function(){var t="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each(function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}}.bind(this)),t=accepts.join(", ")}var e=0;this.json.attachmentSize&&(e=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.id},this.form.documentAction.action,"uploadAttachment",{id:this.form.businessData.document.id},null,function(t){t.id&&this.form.documentAction.getAttachment(t.id,this.form.businessData.document.id,function(e){e.data&&(e.data.control||(e.data.control={}),this.attachmentController.addAttachment(e.data,t.messageId),this.form.businessData.attachmentList.push(e.data)),this.attachmentController.checkActions(),this.setAttachmentBusinessData(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this)),this.attachmentController.checkActions()}.bind(this),function(t){if(t.length&&t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.cms.Xform.LP.uploadMore;return e=e.replace("{n}",this.attachmentController.options.attachmentCount),this.form.notice(e,"error"),!1}return!0}.bind(this),!0,t,e,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},deleteAttachments:function(t,e,i){var s=[];i.each(function(t){s.push(t.data.name)}.bind(this));var o=this;this.form.confirm("warn",t,MWF.xApplication.cms.Xform.LP.deleteAttachmentTitle,MWF.xApplication.cms.Xform.LP.deleteAttachment+"( "+s.join(", ")+" )",300,120,(function(){for(;i.length;){var t=i.shift();o.deleteAttachment(t)}this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);var e=t.data.id;this.form.documentAction.deleteAttachment(t.data.id,function(i){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions();for(var s=0;s<this.form.businessData.attachmentList.length;s++){var o=this.form.businessData.attachmentList[s];if(o.id===e){this.form.businessData.attachmentList.erase(o);break}}this.form.officeList&&this.form.officeList.each(function(t){t.openedAttachment&&t.openedAttachment.id==e&&t.loadOfficeEdit()}.bind(this)),this.setAttachmentBusinessData(),this.fireEvent("afterDelete",[t.data]),this.fireEvent("change")}.bind(this))},createReplaceFileNode:function(t){var e="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each((function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}})),e=accepts.join(", ")}var i=0;this.json.attachmentSize&&(i=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.documentAction.action,"replaceAttachment",{id:t.data.id,documentid:this.form.businessData.document.id},null,function(e){this.form.documentAction.getAttachment(t.data.id,this.form.businessData.document.id,function(i){if(i.data.control||(i.data.control={}),t.data=i.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var s=this.attachmentController.messageItemList[e.messageId];s&&s.node&&s.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,!0,e,i,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],i=0;i<e.length;i++)if(t===e[i])return!0;return!1},downloadAttachment:function(t,e,i){this.form.businessData.document&&i.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=cms&documentId="+this.form.businessData.document.id}):layout.mobile?this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.documentAction.getAttachmentStream(t.data.id,this.form.businessData.document.id),this.fireEvent("download",[t])}.bind(this))},openAttachment:function(t,e,i){this.form.businessData.document&&i.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=cms&documentId="+this.form.businessData.document.id}):layout.mobile?this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.documentAction.getAttachmentData(t.data.id,this.form.businessData.document.id),this.fireEvent("open",[t])}.bind(this))},getAttachmentUrl:function(t,e){this.form.businessData.document&&this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,e)},getTextData:function(){var t=[];return this.attachmentController.attachments.each((function(e){var i={id:e.data.id,person:e.data.person,creatorUid:e.data.creatorUid,name:e.data.name,seqNumber:e.data.seqNumber,length:e.data.length,extension:e.data.extension,lastUpdateTime:e.data.lastUpdateTime,activityName:e.data.activityName,control:e.data.control};t.push(i)})),t},validationConfigItem:function(t,e){if("all"==e.status||"publish"==t){var i=this.getData()||[],s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xApplication.cms.Xform.AttachmentDg=MWF.CMSAttachmentDg=new Class({Extends:MWF.CMSAttachment,loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],ignoreSite:this.json.ignoreSite,onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.json.ignoreSite?(this._getBusinessData()||[]).each(function(t){this.form.businessData.attachmentList.some(function(e){return t.id===e.id}.bind(this))&&this.attachmentController.addAttachment(t)}.bind(this)):this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return{control:t.data.control,name:t.data.name,id:t.data.id,person:t.data.person,creatorUid:t.data.creatorUid,seqNumber:t.data.seqNumber,length:t.data.length,extension:t.data.extension,lastUpdateTime:t.data.lastUpdateTime,activityName:t.data.activityName}}));this._setBusinessData(t)}else this._setBusinessData([])}}),MWF.xDesktop.requireApp("process.Xform","Button",null,!1),MWF.xApplication.cms.Xform.Button=MWF.CMSButton=new Class({Extends:MWF.APPButton}),MWF.xDesktop.requireApp("process.Xform","Calendar",null,!1),MWF.xApplication.cms.Xform.Calendar=MWF.CMSCalendar=new Class({Extends:MWF.APPCalendar}),MWF.xDesktop.requireApp("process.Xform","Checkbox",null,!1),MWF.xApplication.cms.Xform.Checkbox=MWF.CMSCheckbox=new Class({Extends:MWF.APPCheckbox}),MWF.xDesktop.requireApp("process.Xform","Datagrid",null,!1),MWF.xApplication.cms.Xform.Datagrid=MWF.CMSDatagrid=new Class({Extends:MWF.APPDatagrid,validationConfigItem:function(t,e){if("all"==e.status||("publ"==t||"publish"==t)){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xApplication.cms.Xform.Datagrid$Title=MWF.CMSDatagrid$Title=new Class({Extends:MWF.APPDatagrid$Title}),MWF.xApplication.cms.Xform.Datagrid$Data=MWF.CMSDatagrid$Data=new Class({Extends:MWF.APPDatagrid$Data}),MWF.xDesktop.requireApp("process.Xform","Htmleditor",null,!1),MWF.xApplication.cms.Xform.Htmleditor=MWF.CMSHtmleditor=new Class({Extends:MWF.APPHtmleditor,_loadUserInterface:function(){if(this.node.empty(),this.readonly)this.node.set("html",this._getBusinessData()),this.node.setStyles({"-webkit-user-select":"text","-moz-user-select":"text"}),layout.mobile&&this.node.getElements("img").each(function(t){t.setStyles({height:"auto","max-width":"100%"})}.bind(this));else{var t=Object.clone(this.json.editorProperties);if(this.json.config&&this.json.config.code){var e=MWF.CMSMacro.exec(this.json.config.code,this);Object.each(e,(function(e,i){t[i]=e}))}this.loadCkeditor(t)}},loadCkeditor:function(t){_self=this,COMMON.AjaxModule.loadDom("ckeditor",function(){CKEDITOR.disableAutoInline=!0;var e=new Element("div").inject(this.node),i=this._getBusinessData();i?e.set("html",i):this.json.templateCode&&e.set("html",this.json.templateCode);this.node.getSize().y;var s=t||{};"Mobile"==this.form.json.mode&&(s.toolbar||s.toolbarGroups||(s.toolbar=[{name:"paragraph",items:["Bold","Italic","-","TextColor","BGColor","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","Undo","Redo"]},{name:"basicstyles",items:["Styles","FontSize"]},{name:"insert",items:["Image"]}])),s.base64Encode="y"===this.json.base64Encode,s.localImageMaxWidth=800,s.reference=this.form.businessData.document.id,s.referenceType="cmsDocument",s.language||(s.language=MWF.language),s.skin&&(s.skin="moono-lisa"),this.editor=CKEDITOR.replace(e,s),this._loadEvents(),this.editor.on("change",function(){this._setBusinessData(this.getData())}.bind(this))}.bind(this))},getText:function(){return this.editor.document.getBody().getText()},getImages:function(){var t=[],e=this.editor.document.find("img");if(e)for(var i=0;i<e.$.length;i++)t.push(e.getItem(i).$);return t},getImageIds:function(){for(var t=[],e=this.getImages(),i=0;i<e.length;i++){var s=e[i];s.getAttribute("data-id")&&t.push(s.getAttribute("data-id"))}return t},_loadStyles:function(){this.json.styles&&this.node.setStyles(this.json.styles),this.node.setStyle("overflow","hidden")},validationConfigItem:function(t,e){if("all"==e.status||"publish"==t){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xDesktop.requireApp("process.Xform","ImageClipper",null,!1),MWF.xApplication.cms.Xform.ImageClipper=MWF.CMSImageClipper=new Class({Extends:MWF.APPImageClipper,selectImage:function(t,e){var i=this.json.clipperType||"unrestricted",s=1,o="";if("unrestricted"==i)s=0;else if("size"==i){var n=this.json.imageWidth.toInt(),a=this.json.imageHeight.toInt();s=n/a,isNaN(n)||isNaN(a)||(o=MWF.LP.widget.pictureSize.replace(/{width}/g,n).replace(/{height}/g,a))}else"ratio"==i&&(s=this.json.imageRatio||1,o=MWF.LP.widget.pictureRatio.replace(/{ratio}/g,s));MWF.xDesktop.requireApp("process.Xform","widget.ImageClipper",function(){this.imageClipper=new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app,{style:"default",aspectRatio:s,description:o,imageUrl:t?MWF.xDesktop.getImageSrc(t):"",reference:this.form.businessData.document.id,referenceType:"cmsDocument",resultMaxSize:500,onChange:function(){e({src:this.imageClipper.imageSrc,id:this.imageClipper.imageId})}.bind(this)}),this.imageClipper.load()}.bind(this))},validationConfigItem:function(t,e){if("all"==e.status||"publish"==t){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xDesktop.requireApp("process.Xform","Label",null,!1),MWF.xApplication.cms.Xform.Label=MWF.CMSLabel=new Class({Extends:MWF.APPLabel}),MWF.xDesktop.requireApp("process.Xform","Number",null,!1),MWF.xApplication.cms.Xform.Number=MWF.CMSNumber=new Class({Extends:MWF.APPNumber,validationConfigItem:function(t,e){if("all"==e.status||"publish"==t){var i=this.getInputData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.toString().indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.toString().indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xDesktop.requireApp("process.Xform","Radio",null,!1),MWF.xApplication.cms.Xform.Radio=MWF.CMSRadio=new Class({Extends:MWF.APPRadio}),MWF.xDesktop.requireApp("process.Xform","Select",null,!1),MWF.xApplication.cms.Xform.Select=MWF.CMSSelect=new Class({Extends:MWF.APPSelect}),MWF.xDesktop.requireApp("process.Xform","Tab",null,!1),MWF.xApplication.cms.Xform.Tab=MWF.CMSTab=new Class({Extends:MWF.APPTab}),MWF.xApplication.cms.Xform.tab$Page=MWF.CMSTab$Page=new Class({Extends:MWF.APPTab$Page}),MWF.xApplication.cms.Xform.tab$Content=MWF.CMSTab$Content=new Class({Extends:MWF.APPTab$Content}),MWF.xDesktop.requireApp("process.Xform","Table",null,!1),MWF.xApplication.cms.Xform.Table=MWF.CMSTable=new Class({Extends:MWF.APPTable}),MWF.xApplication.cms.Xform.Table$Td=MWF.CMSTable$Td=new Class({Extends:MWF.APPTable$Td}),MWF.xDesktop.requireApp("process.Xform","Textarea",null,!1),MWF.xApplication.cms.Xform.Textarea=MWF.CMSTextarea=new Class({Extends:MWF.APPTextarea});
//# sourceMappingURL=$all.min.js.map