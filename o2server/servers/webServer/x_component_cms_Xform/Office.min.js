MWF.xDesktop.requireApp("process.Xform","Office",null,!1),MWF.xApplication.cms.Xform.Office=MWF.CMSOffice=new Class({Extends:MWF.APPOffice,getFormId:function(){var t=this.form.businessData.document.id;return"form"+this.json.id+t},getFileName:function(){var t="docx";switch(this.json.officeType){case"word":t="docx";break;case"excel":t="xlsx";break;case"ppt":t="pptx"}var e=this.form.businessData.document.id;return"file"+this.json.id+e+"."+t},getOfficeObjectId:function(){var t=this.form.businessData.document.id;return"NTKOOCX"+this.json.id+t},getFileInputName:function(){var t=this.form.businessData.document.id;return"fileInput"+this.json.id+t},getFile:function(t){var e=null;atts=this.form.businessData.attachmentList||[];for(var i=0;i<atts.length;i++)if(atts[i].site===t){e=atts[i];break}return e},getTempleteUrl:function(){if(this.json.template){var t="",e=this.json.template.substr(0,1);if(t="/"===e?this.json.template.substr(1,this.json.template.indexOf("/",1)-1):this.json.template.substr(0,this.json.template.indexOf("/")),-1!==["x_cms_assemble_control"].indexOf(t.toLowerCase())){var i=MWF.Actions.getHost(t);return"/"===e?i+this.json.template:i+"/"+this.json.template}}return this.json.template},getOfficeFileUrl:function(){this.getFileName();this.readSite=this.json.id,this.json.fileSite&&this.json.fileSite.code&&(this.readSite=this.form.Macro.exec(this.json.fileSite.code,this));var t=this.getFile(this.readSite);if(t||this.readSite!==this.json.id&&(t=this.getFile(this.json.id)),t){this.file=t;var e="";return e=(e=this.form.documentAction.action.actions.getAttachmentData.uri).replace("{id}",encodeURIComponent(t.id)),this.form.documentAction.action.address+e.replace("{documentid}",encodeURIComponent(this.form.businessData.document.id))}return this.getTempleteUrl()},createMenuAction:function(t,e,i){e=e||MWF.xApplication.process.Xform.LP[t];return new Element("div",{MWFnodeid:t,MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:e,MWFButtonAction:"menuAction",MWFButtonText:e}).inject(this.menuNode)},createMenuActionMenu:function(t,e,i){e=e||MWF.xApplication.process.Xform.LP[t];return new Element("div",{MWFnodeid:t,MWFnodetype:"MWFToolBarMenu",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:e,MWFButtonAction:"menuAction",MWFButtonText:e}).inject(this.menuNode)},createMenuActionMenuItem:function(t,e,i,n){return new Element("div",{MWFnodeid:t,MWFnodetype:"MWFToolBarMenuItem",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:e,MWFButtonAction:n,MWFButtonText:e}).inject(this.menuNode)},openAttachment:function(t,e,i){this.openedAttachment&&this.openedAttachment.id===t||(this.save(),MWF.Actions.get("x_cms_assemble_control").getAttachmentUrl(t,this.form.businessData.document.id,function(n){this.openedAttachment={id:t,site:e,name:i},this.officeOCX.BeginOpenFromURL(n,!0,this.readonly)}.bind(this)))},openOfficeHistory:function(t,e){var i=t.target.getParent().get("value");url=this.form.documentAction.action.actions.getAttachmentData.uri,url=url.replace("{id}",encodeURIComponent(i)),url=this.form.documentAction.action.address+url.replace("{documentid}",encodeURIComponent(this.form.businessData.document.id)),e.close(),this.save(),this.officeOCX.BeginOpenFromURL(url,!0,!0),this.historyMode=!0,button&&button.setText(MWF.xApplication.process.Xform.LP.menu_hideHistory)},save:function(t){if(!this.readonly){if(this.historyMode)return!0;if(!this.officeForm)return!0;this.fireEvent("beforeSave");try{if(this.openedAttachment)this.officeForm.getElement("input").set("value",this.openedAttachment.site),e=(e=this.form.documentAction.action.actions.replaceAttachment.uri).replace("{id}",this.openedAttachment.id),e=this.form.documentAction.action.address+e.replace("{documentid}",this.form.businessData.document.id),this.officeOCX.SaveToURL(e,"file","",this.openedAttachment.name,this.getFormId());else{t&&this.json.isHistory&&this.saveHistory(),this.officeForm.getElement("input").set("value",this.json.id);var e="";this.file?(e=(e=this.form.documentAction.action.actions.replaceAttachment.uri).replace("{id}",this.file.id),e=this.form.documentAction.action.address+e.replace("{documentid}",this.form.businessData.document.id),this.officeOCX.SaveToURL(e,"file","",this.getFileName(),this.getFormId())):(e=this.form.documentAction.action.actions.uploadAttachment.uri,e=this.form.documentAction.action.address+e.replace("{id}",this.form.businessData.document.id),this.officeOCX.SaveToURL(e,"file","",this.getFileName(),this.getFormId()),this.form.documentAction.getDocument(this.form.businessData.document.id,function(t){this.form.businessData.attachmentList=t.data.attachmentList,this.getOfficeFileUrl()}.bind(this)))}}catch(t){}this.fireEvent("afterSave")}},getHistoryFileName:function(){var t="docx";switch(this.json.officeType){case"word":t="docx";break;case"excel":t="xlsx";break;case"ppt":t="pptx"}return"("+MWF.name.cn(layout.session.user.name)+")-"+Date.parse(new Date).format("%Y-%m-%d %H:%M")+"."+t},saveHistory:function(){var t=this.getHistoryFileName();this.officeForm.getElement("input").set("value",this.json.id+"history"),url=this.form.documentAction.action.actions.uploadAttachment.uri,url=this.form.documentAction.action.address+url.replace("{documentid}",this.form.businessData.document.id),this.officeOCX.SaveToURL(url,"file","",t,this.getFormId())},getHTMLFileName:function(){return this.form.businessData.document.id+this.json.id+".mht"},saveHTML:function(){this.officeForm.getElement("input").set("value",this.json.id+"$view");for(var t=null,e=0;e<this.form.businessData.attachmentList.length;e++){var i=this.form.businessData.attachmentList[e];i.site==this.json.id+"$view"&&(t=i)}var n=t?t.name:this.getHTMLFileName();this.officeForm.getElement("input").getNext().set("value",n),t?(url=this.form.documentAction.action.actions.replaceAttachment.uri,url=url.replace("{id}",t.id),url=this.form.documentAction.action.address+url.replace("{documentid}",this.form.businessData.document.id)):(url=this.form.documentAction.action.actions.uploadAttachment.uri,url=this.form.documentAction.action.address+url.replace("{id}",this.form.businessData.document.id)),this.officeOCX.SaveAsOtherFormatToURL(1,url,"file","",n,this.getFormId())},getHTMLFileUrl:function(t){var e=t||this.getHTMLFileName(),i=null;atts=this.form.businessData.attachmentList;for(var n=0;n<atts.length;n++)if(atts[n].name===e||atts[n].site===this.json.id+"$view"){i=atts[n];break}if(i){var o="";return o=(o=this.form.documentAction.action.actions.getAttachmentData.uri).replace("{id}",encodeURIComponent(i.id)),this.form.documentAction.action.address+o.replace("{documentid}",encodeURIComponent(this.form.businessData.document.id))}return this.getTempleteUrl()},validationMode:function(){},validation:function(){return!0},loadOfficeNotActive:function(){this.getFileName();for(var t=0;t<this.form.businessData.attachmentList.length;t++){var e=this.form.businessData.attachmentList[t];e.site==this.json.id+"$view"&&e.name}this.node.setStyles({overflow:"hidden","background-color":"#f3f3f3","min-height":"24px",padding:"18px"});var i=this.getData();(layout.mobile||COMMON.Browser.Platform.isMobile)&&i.length>300&&(i=i.substr(0,300)+"……");var n=new Element("div",{text:i}).inject(this.node);n=(n=MWF.xApplication.process.Xform.LP.openOfficeInfor).replace("{type}",this.json.officeType);var o=new Element("div",{styles:{width:"200px",height:"24px",margin:"auto","margin-top":"18px","padding-left":"30px","font-size":"16px","font-weight":"bold",color:"#2b5797","font-family":"Gadugi",cursor:"pointer",background:"url("+this.form.path+this.form.options.style+"/icon/"+this.json.officeType+".png) no-repeat left center"},text:n}).inject(this.node);this.getOfficeFileUrl()||this.node.setStyle("display","none"),o.addEvent("click",function(){var t=this.getOfficeFileUrl();t&&(window.o2android?window.o2android.openDocument(t):window.webkit?window.webkit.messageHandlers.openDocument.postMessage(t):window.open(o2.filterUrl(t)))}.bind(this))}});