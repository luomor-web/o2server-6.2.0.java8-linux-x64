MWF.xApplication.cms.Xform.widget=MWF.xApplication.cms.Xform.widget||{},MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1);var O2CMSComment=MWF.xApplication.cms.Xform.widget.Comment=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"simple",documentId:"",anonymousAccess:!1,countPerPage:10,isAllowPublish:!0},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.node=e,this.path="../x_component_cms_Xform/widget/$Comment/",this.cssPath="../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/css.wcss",this._loadCss(),MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,!1),this.lp=MWF.xApplication.cms.Xform.LP,this.actions=MWF.Actions.get("x_cms_assemble_control")},load:function(){this.items=[],this.documents={},this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadItemQueue=0,this.count=0,this.lineHeight="text"!=this.options.mode?32:25;var t=this.options.countPerPage;(!t||0==t||isNaN(t)||parseInt(t)<1)&&(this.options.countPerPage=10),this.container=new Element("div",{styles:this.css.container}).inject(this.node),this.loadTitle(),this.loadContent(),!1!==this.options.isAllowPublish&&this.loadEditor()},loadTitle:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.lp.commentTitle}).inject(this.container)},loadTotal:function(){this.titleCountNode=new Element("div",{styles:this.css.titleCountNode,text:this.lp.commentCountText.replace("{count}",this.dataCount)}).inject(this.titleNode)},loadContent:function(){this.contentConainer=new Element("div.contentConainer",{styles:this.css.contentConainer}).inject(this.container),this.createPagingBar(),this.viewConainer=new Element("div.viewConainer",{}).inject(this.contentConainer),this.createPagingBar(),this.createView()},createPagingBar:function(){var t=new Element("div",{styles:this.css.pagingArea}).inject(this.contentConainer);this.pagingBarTop?this.pagingBarBottom=t:this.pagingBarTop=t;var e=new Element("div").inject(t);this.pagingContainerTop?this.pagingContainerBottom=e:this.pagingContainerTop=e},getShortName:function(t){return t&&t.contains("@")?t.split("@")[0]:t},createView:function(){this.view=new O2CMSComment.View(this.viewConainer,null,this,{templateUrl:this.path+this.options.style+"/listItem.json",scrollEnable:!1,pagingEnable:!0,documentKeyWord:"orderNumber",pagingPar:{currentPage:1,currentItem:1,hasReturn:!1,countPerPage:this.options.countPerPage,onPostLoad:function(t){t.nextPageNode&&t.nextPageNode.inject(this.pagingBarBottom,"before")}.bind(this)},onGotoItem:function(t){}.bind(this),onPostCreateViewBody:function(){this.view.dataCount<=this.options.countPerPage?(this.pagingBarTop.hide(),this.pagingBarBottom.hide()):(this.pagingBarTop.show(),this.pagingBarBottom.show()),this.view.dataCount?this.view.node.show():this.view.node.hide()}.bind(this),onPostDeleteDocument:function(){this.view.reload()}.bind(this)},{app:this.app}),this.view.pagingContainerTop=this.pagingContainerTop,this.view.pagingContainerBottom=this.pagingContainerBottom,this.view.filterData={documentId:this.options.documentId,orderField:"createTime",orderType:"ASC"},this.view.load()},loadEditor:function(){this.editorArea=new Element("div.editorArea",{styles:this.css.commentArea}).inject(this.container),this.editor=new O2CMSComment.Editor(this.editorArea,this,{style:this.options.style,isNew:!0,onPostOk:function(t){this.postCreateComment(t)}.bind(this)}),this.editor.mainData=this.data,this.editor.load()},postCreateComment:function(){this.view.reload()},isAnonymous:function(){return this.options.anonymousAccess},getUserIcon:function(t){var e="";return this.getUserData(t,(function(t){e=t&&t.data&&t.data.icon?t.data.icon:"../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/icon/noavatar_big.png"})),e},getUserData:function(t,e){if(this.userCache&&this.userCache[t])e&&e(this.userCache[t]);else if(this.userCache||(this.userCache={}),this.isAnonymous()){var i=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);if(i){var n={data:{icon:i}};this.userCache[t]=n,e&&e(n)}else{n={data:{icon:"../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/icon/noavatar_big.png"}};this.userCache[t]=n,e&&e(n)}}else MWF.Actions.get("x_organization_assemble_control").getPerson(function(i){i.data||(i.data={});var n=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);n?i.data&&(i.data.icon=n,this.userCache[t]=i,e&&e(i)):i.data&&(i.data.icon="../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/icon/noavatar_big.png",this.userCache[t]=i,e&&e(i))}.bind(this),function(){var i={data:{icon:"../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/icon/noavatar_big.png"}};this.userCache[t]=i,e&&e(i)}.bind(this),t,!0)}});O2CMSComment.getDateDiff=function(t){if(!t)return"";var e=Date.parse(t.replace(/-/gi,"/")),i=864e5,n=(new Date).getTime()-e,o=(new Date).decrement("day",1),s=(new Date).decrement("day",2),a=n/31104e6,c=n/2592e6,m=n/(7*i),r=n/i,d=n/36e5,h=n/6e4;return o.getFullYear()==e.getFullYear()&&o.getMonth()==e.getMonth()&&o.getDate()==e.getDate()?result=MWF.xApplication.cms.Xform.LP.yesterday+" "+e.getHours()+":"+e.getMinutes():s.getFullYear()==e.getFullYear()&&s.getMonth()==e.getMonth()&&s.getDate()==e.getDate()?result=MWF.xApplication.cms.Xform.LP.theDayBeforeYesterday+" "+e.getHours()+":"+e.getMinutes():result=a>1||c>=1?e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate():m>=1?MWF.xApplication.cms.Xform.LP.severalWeekAgo.replace("{count}",parseInt(m)):r>=1?MWF.xApplication.cms.Xform.LP.severalDayAgo.replace("{count}",parseInt(r)):d>=1?MWF.xApplication.cms.Xform.LP.severalHourAgo.replace("{count}",parseInt(d)):h>=1?MWF.xApplication.cms.Xform.LP.severalMintuesAgo.replace("{count}",parseInt(h)):MWF.xApplication.cms.Xform.LP.justNow,result},O2CMSComment.Editor=new Class({Implements:[Options,Events],options:{style:"default",isNew:!0},initialize:function(t,e,i){this.setOptions(i),this.node=t,this.comment=e},load:function(){this.comment.actions.getUUID(function(t){this.advanceCommentId=t,this._load()}.bind(this))},_load:function(){this.node.set("html","<div styles='itemNode'> <div styles='itemLeftNode'>   <div styles='itemUserFace'>     <div styles='itemUserIcon' item='userIcon'>     </div>   </div>   <div styles='commentUserName' item='creatorName'>   </div> </div> <div styles='commentRightNode'>   <div styles='itemRightMidle'>     <div styles='itemBodyComment' item='content'></div>     <div styles='itemBodyComment' item='action'></div>   </div> </div></div>");var t=this.node.getElements("[item='action']")[0];this.saveCommentAction=new Element("div",{styles:this.comment.css.actionNode,text:this.comment.lp.saveComment}).inject(t),this.saveCommentAction.addEvent("click",function(){this.saveComment()}.bind(this));var e={resize_enabled:!1,isSetImageMaxWidth:!0,reference:this.advanceCommentId,referenceType:"forumReply",toolbar:[{name:"insert",items:["Image"]}]};this.comment.options.editorProperties&&(e=Object.merge(e,this.comment.options.editorProperties)),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.node,this.data||{},{style:"forum",isEdited:!0,itemTemplate:{userIcon:{className:"itemUserIcon2",type:"img",value:function(){return layout.session.user.icon?"data:image/png;base64,"+layout.session.user.icon:"../x_component_cms_Xform/widget/$Comment/"+this.options.style+"/icon/noavatar_big.png"}.bind(this)},creatorName:{type:"innerText",value:layout.session.user.name},content:{type:"rtf",RTFConfig:e}}},this,this.comment.css),this.form.load()}.bind(this),!0)},saveComment:function(){var t=this.form.getResult(!0,",",!0,!1,!0);t&&(t.documentId=this.comment.options.documentId,t.id=this.advanceCommentId,delete t.userIcon,this.comment.actions.saveComment(t,function(t){"error"==t.type?this.comment.app.notice(t.message,"error"):(this.comment.actions.getUUID(function(t){this.advanceCommentId=t}.bind(this)),this.comment.app.notice(this.comment.lp.saveCommentSuccess,"ok"),this.form.getItem("content").setValue(""),this.fireEvent("postOk",t.data.id))}.bind(this)))}}),O2CMSComment.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return t.index=e,new O2CMSComment.Document(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=10),i||(i=1);var n=this.filterData||{};this.actions.listCommentPageWithFilter(i,e,n,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteComment(t.id,function(){this.reload(),this.app.notice(this.lp.deleteCommentSuccess,"ok")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),O2CMSComment.Document=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(t,e){},mouseoutSubject:function(t,e){},getUserData:function(t,e){this.view.explorer.getUserData(t,e)},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElements("[item='userIcon']")[0];if(this.getUserData(e.creatorName,function(t){i.src=t.data.icon}.bind(this)),e.parentId&&""!=e.parentId){var n=t.getElements("[item='quoteContent']")[0];this.actions.getComment(e.parentId,function(t){var e=this.parentData=t.data,i=new Element("div",{styles:this.css.itemQuote}).inject(n),o=i.set("html",e.content).get("text");i.empty(),e.contentText=o,new Element("div",{styles:this.css.quoteLeftBig}).inject(i);var s=new Element("div",{styles:this.css.quoteAreaBig}).inject(i);new Element("div",{styles:this.css.quoteInforBig,text:e.orderNumber+this.lp.floor+"ï¼š"+e.creatorName.split("@")[0]+this.lp.publishAt+e.createTime}).inject(s).addEvent("click",function(){this.obj.app.gotoComment(this.index)}.bind({obj:this,index:e.orderNumber||e.index+2})),new Element("div",{styles:this.css.quoteTextBig,text:o.length>100?o.substr(0,100)+"...":o}).inject(s),new Element("div",{styles:this.css.quoteRightBig}).inject(i)}.bind(this),function(t){new Element("div",{styles:this.css.commentBeinngDelete,text:this.lp.quoteCommentBeingDeleted}).inject(n)}.bind(this))}},sendMessage:function(t,e){var i=this;if(layout.desktop.widgets.IMIMWidget){var n=layout.desktop.widgets.IMIMWidget;n.getOwner(function(){this.openChat(e,{from:i.data.creatorName})}.bind(n))}},createComment:function(t,e){if(this.app.access.isAnonymousDynamic())this.app.openLoginForm(function(){this.app.reload()}.bind(this));else{var i=new O2CMSComment.CommentForm(this,{},{toMain:!1,onPostOk:function(t){this.app.postCreateComment(t)}.bind(this)});this.data.contentText=this.node.getElements("[item='content']")[0].get("text"),i.mainData=this.app.data,i.parentData=this.data,i.create()}},editComment:function(t,e){new O2CMSComment.Form(this,this.data,{documentId:this.explorer.options.documentId,toMain:!this.data.parentId||""==this.data.parentId,onPostOk:function(t){MWF.Actions.get("x_cms_assemble_control").getComment(t,function(t){this.node.getElements("[item='content']")[0].set("html",t.data.content)}.bind(this))}.bind(this)}).edit()},deleteComment:function(t,e){var i=this;this.view.app.confirm("warn",e,this.lp.deleteCommentTitle,this.lp.deleteCommentText,350,120,(function(){i.actions.deleteComment(i.data.id,function(){i.destroy(),i.app.notice(i.lp.deleteCommentSuccess,"ok"),i.view.fireEvent("postDeleteDocument")}.bind(this)),this.close()}),(function(){this.close()}))}}),O2CMSComment.Form=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"cms_xform",width:"860",height:"400",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!0,draggable:!0,closeAction:!0,toMain:!0},_createTableContent:function(){this.lp=MWF.xApplication.cms.Xform.LP,this.formTopTextNode&&this.formTopTextNode.set("text",this.lp.commentFormTitle),this.isNew?MWF.Actions.get("x_cms_assemble_control").getUUID(function(t){this.advanceCommentId=t,this._createTableContent_()}.bind(this)):this._createTableContent_()},_createTableContent_:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableValue' item='content'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"cms",isEdited:!0,itemTemplate:{content:{type:"rtf",RTFConfig:{resize_enabled:!1,isSetImageMaxWidth:!0,reference:this.advanceCommentId||this.data.id,referenceType:"forumReply",toolbar:[{name:"insert",items:["Image"]}]}}}},this.app,this.css),this.form.load()}.bind(this),!0)},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this)),(this.isNew||this.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this)))},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,",",!0,!1,!0);e&&this._ok(e,function(t){"error"==t.type?this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app.notice(this.isNew?this.lp.createCommentSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk",t.data.id))}.bind(this))},_ok:function(t,e){t.documentId=this.options.documentId,this.advanceCommentId&&(t.id=this.advanceCommentId),delete t.userIcon,this.options.toMain||(t.parentId=this.parentData.id),MWF.Actions.get("x_cms_assemble_control").saveComment(t,function(t){e&&e(t)}.bind(this))}});