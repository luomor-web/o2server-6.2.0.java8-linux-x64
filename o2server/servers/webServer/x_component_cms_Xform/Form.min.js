MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Xform=MWF.xApplication.cms.Xform||{},MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xDesktop.requireApp("process.Xform","Form",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("cms.Xform","Package",null,!1),MWF.xApplication.cms.Xform.Form=MWF.CMSForm=new Class({Implements:[Options,Events],Extends:MWF.APPForm,options:{style:"default",readonly:!1,cssPath:"",autoSave:!1,saveOnClose:!1,showAttachment:!0,moduleEvents:["queryLoad","beforeLoad","beforeModulesLoad","postLoad","afterModulesLoad","afterLoad","beforeSave","postSave","afterSave","beforeClose","beforePublish","postPublish","afterPublish","beforeDelete","afterDelete","resize"]},initialize:function(t,e,i){this.setOptions(i),this.container=$(t),this.container.setStyle("-webkit-user-select","text"),this.data=e,this.json=e.json,this.html=e.html,this.path="../x_component_cms_Xform/$Form/",this.cssPath=this.options.cssPath||"../x_component_cms_Xform/$Form/"+this.options.style+"/css.wcss",this._loadCss(),this.modules=[],this.all={},this.forms={}},load:function(t){this.app&&(this.app.formNode&&this.app.formNode.setStyles(this.json.styles),this.app.addEvent&&this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this))),this.Macro=new MWF.CMSMacro.CMSFormContext(this),this.loadLanguage(function(e){if(e&&this.formDataText){var i=o2.bindJson(this.formDataText,{lp:MWF.xApplication.cms.Xform.LP.form});this.data=JSON.parse(i),this.json=this.data.json,this.html=this.data.html}this.container.set("html",this.html),this.node=this.container.getFirst(),this._loadEvents(),this.loadRelatedScript(),this.fireEvent("queryLoad")&&(this._loadBusinessData(),this.fireEvent("beforeLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeLoad"),this.loadContent(t))}.bind(this))},loadLanguage:function(t){if(MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,!1),"script"!==this.json.languageType&&"default"!==this.json.languageType)return t&&t(),!0;MWF.xApplication.cms.Xform.LP.form;var e=null;if("script"==this.json.languageType)this.json.languageScript&&this.json.languageScript.code&&(e=this.Macro.exec(this.json.languageScript.code,this));else if("default"==this.json.languageType){var i="lp-"+o2.language,s=this.businessData.document.appId,o=this.documentAction.getDictRoot(i,s,(function(t){return t.data}),(function(){})),n=this.documentAction.getScriptByNameV2(i,s,function(t){return this.Macro.exec(t.data.text,this)}.bind(this),(function(){}));e=Promise.any([o,n])}e?e.then&&"function"==o2.typeOf(e.then)?e.then((function(e){MWF.xApplication.cms.Xform.LP.form=Object.merge(MWF.xApplication.cms.Xform.LP.form,e),t&&t(!0)}),(function(){t&&t(!0)})):(MWF.xApplication.cms.Xform.LP.form=Object.merge(MWF.xApplication.cms.Xform.LP.form,e),t&&t(!0)):t&&t(!0)},loadRelatedScript:function(){if(this.json.includeScripts&&this.json.includeScripts.length){var t="",e=[];this.json.includeScripts.each(function(i){this.app.relatedScriptMap&&this.app.relatedScriptMap[i.id]&&(t+="\n"+this.app.relatedScriptMap[i.id].text,e.push(i.id))}.bind(this)),t&&this.Macro.exec(t,this)}},loadContent:function(t){this.subformCount=0,this.subformLoadedCount=0,this.subformLoaded=[this.json.id],this._loadHtml(),this._loadForm(),this.fireEvent("beforeModulesLoad"),this._loadModules(this.node),this.options.readonly||(this.options.autoSave&&this.autoSave(),this.app.addEvent("queryClose",function(){this.options.saveOnClose&&"draft"==this.businessData.document.docStatus&&this.saveDocument(null,!0),Object.each(this.forms,(function(t,e){"Htmleditor"==t.json.type&&t.editor&&(CKEDITOR.remove(t.editor),delete t.editor)}))}.bind(this))),this.fireEvent("afterModulesLoad"),this.fireEvent("postLoad"),this.fireEvent("afterLoad"),this.app&&this.app.fireEvent&&(this.app.fireEvent("afterModulesLoad"),this.app.fireEvent("postLoad"),this.app.fireEvent("afterLoad")),this.app&&this.app.mobile&&t&&t()},autoSave:function(){},_loadBusinessData:function(){this.businessData||(this.businessData={data:{}})},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)):"load"==e?this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this)):"submit"==e?this.addEvent("beforePublish",function(){return this.Macro.fire(t.code,this)}.bind(this)):this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},_loadModules:function(t){this._getModuleNodes(t).each(function(t){var e=this._getDomjson(t);if((this.options.showAttachment||"Attachment"!=e.type)&&(!this.app.mobile||"Actionbar"!==e.type)){var i=this._loadModule(e,t);this.modules.push(i)}}.bind(this))},_loadModule:function(t,e,i){if(t){MWF["CMS"+t.type]||MWF.xDesktop.requireApp("cms.Xform",t.type,null,!1);var s=new MWF["CMS"+t.type](e,t,this);return i&&i.apply(s),this.all[t.id]||(this.all[t.id]=s),s.field&&(this.forms[t.id]||(this.forms[t.id]=s)),s.readonly=this.options.readonly,s.load(),s}},trim:function(t){var e=[];return t.each((function(t){t&&e.push(t)})),e},transportPermissionData:function(t,e){var i=[];return t.each((function(t){var s="string"===typeOf(t)?t:t.distinguishedName;if(s){var o,n;switch(s.substr(s.length-1,1).toLowerCase()){case"i":case"p":o="人员";break;case"u":o="组织";break;case"g":o="群组";break;case"r":o="角色";break;default:o=""}if(o)n="object"===typeOf(t)&&t.name?t.name:MWF.name&&MWF.name.cn?MWF.name.cn(s):s.split("@")[0],i.push({permission:"author"==e?"作者":"阅读",permissionObjectType:o,permissionObjectName:n,permissionObjectCode:s})}})),i.length>0?i:null},getSpecialData:function(){var t=this.businessData.data,e=[],i=[],s=[],o=[],n="";if(Object.each(this.forms,(function(a,r){if("Readerfield"!=a.json.type&&"Reader"!=a.json.type||(e="yes"==a.json.section?e.concat(this.getSectionData(a,t[r])):e.concat(a.getData())),"Authorfield"!=a.json.type&&"Author"!=a.json.type||(i="yes"==a.json.section?i.concat(this.getSectionData(a,t[r])):i.concat(a.getData())),"ImageClipper"==a.json.type){var c=a.getData();c&&s.push(c)}if("Htmleditor"==a.json.type){var p=a.getText();n=p.substr(0,80),o=o.concat(a.getImageIds())}})),t.processOwnerList&&"array"==typeOf(t.processOwnerList)){var a={personValue:[]};t.processOwnerList.each((function(t){a.personValue.push({name:t,type:"person"})})),e=e.concat(a)}return{readers:this.transportPermissionData(e,"reader"),authors:this.transportPermissionData(i,"author"),pictures:s,summary:n,cloudPictures:o}},getDocumentData:function(t){var e=Object.clone(this.businessData.document);return t.subject&&(e.title=t.subject,e.subject=t.subject,this.businessData.document.title=t.subject,this.businessData.document.subject=t.subject),e.isNewDocument=!1,e},saveDocument:function(t,e){if(this.fireEvent("beforeSave"),"published"==this.businessData.document.docStatus&&!this.formValidation("publish"))return this.app.content.unmask(),!1;if(!this.formSaveValidation())return this.app.content.unmask(),t&&t(),!1;var i=this.getData(),s=this.getSpecialData(),o=this.getDocumentData(i);o.readerList=s.readers,o.authorList=s.authors,o.pictureList=s.pictures,o.summary=s.summary,o.cloudPictures=s.cloudPictures,o.docData=i,delete o.attachmentList,this.fireEvent("postSave",[o]),this.officeList&&this.officeList.each((function(t){t.save()})),this.documentAction.saveDocument(o,function(){this.app.notice(MWF.xApplication.cms.Xform.LP.dataSaved,"success"),this.businessData.data.isNew=!1,this.fireEvent("afterSave"),t&&t()}.bind(this),null,!e)},closeDocument:function(){this.fireEvent("beforeClose"),this.app&&this.app.close()},printDocument:function(t){(t=t)||(t=this.json.id,this.json.printForm&&"none"!==this.json.printForm&&(t=this.json.printForm)),window.open(o2.filterUrl("../x_desktop/printcmsdoc.html?documentid="+this.businessData.document.id+"&form="+t))},formValidation:function(t){if(this.options.readonly)return!0;var e=!0;return Object.each(this.forms,function(i,s){i.validationMode(),i.validation(t)||(e=!1)}.bind(this)),e},formSaveValidation:function(){if(!this.json.validationSave)return!0;if(!this.json.validationSave.code)return!0;var t=this.Macro.exec(this.json.validationSave.code,this);if(t||(t=MWF.xApplication.cms.Xform.LP.notValidation),"string"===typeOf(t)){if("true"!==t)return this.app.notice(t,"error"),!1}else if("true"!=t.toString())return!1;return!0},formPublishValidation:function(){if(!this.json.validationPublish)return!0;if(!this.json.validationPublish.code)return!0;var t=this.Macro.exec(this.json.validationPublish.code,this);if(t||(t=MWF.xApplication.cms.Xform.LP.notValidation),"string"===typeOf(t)){if("true"!==t)return this.app.notice(t,"error"),!1}else if("true"!=t.toString())return!1;return!0},publishDocument:function(t){if(this.fireEvent("beforePublish"),this.app.content.mask({destroyOnHide:!0,style:this.app.css.maskNode}),!this.formValidation("publish"))return this.app.content.unmask(),!1;if(!this.formPublishValidation())return this.app.content.unmask(),t&&t(),!1;var e=this.getData(),i=this.getSpecialData(),s=this.getDocumentData(e);s.readerList=i.readers,s.authorList=i.authors,s.pictureList=i.pictures,s.summary=i.summary,s.cloudPictures=i.cloudPictures,s.docData=e,delete s.attachmentList,this.fireEvent("postPublish",[s]),this.app&&this.app.fireEvent&&this.app.fireEvent("postPublish",[s]),this.officeList&&this.officeList.each((function(t){t.save()})),this.documentAction.publishDocumentComplex(s,function(e){if(this.businessData.data.isNew=!1,this.fireEvent("afterPublish",[this,e.data]),this.app&&this.app.fireEvent&&this.app.fireEvent("afterPublish",[this,e.data]),t&&t(),this.app.mobile?this.app.content.unmask():(this.businessData.document.title?this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished+": “"+this.businessData.document.title+"”","success"):this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished,"success"),this.options.saveOnClose=!1),layout.inBrowser){try{window.opener&&window.opener.o2RefreshCMSView&&window.opener.o2RefreshCMSView()}catch(t){}window.setTimeout(function(){this.app.close()}.bind(this),1500)}else this.app.close()}.bind(this))},deleteDocumentForMobile:function(){this.app.mobile&&(this.app.content.mask({style:{"background-color":"#999",opacity:.6}}),this.fireEvent("beforeDelete"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeDelete"),this.documentAction.removeDocument(this.businessData.document.id,function(t){this.fireEvent("afterDelete"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterDelete"),this.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete+": “"+this.businessData.document.title+"”","success"),this.options.autoSave=!1,this.options.saveOnClose=!1,this.fireEvent("postDelete"),this.app.close()}.bind(this)))},deleteDocument:function(){var t=this,e=MWF.getCenterPosition(this.app.content,380,150),i={event:{x:e.x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.cms.Xform.LP.deleteDocumentTitle,MWF.xApplication.cms.Xform.LP.deleteDocumentText,380,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.documentAction.removeDocument(t.businessData.document.id,function(e){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete+": “"+t.businessData.document.title+"”","success"),t.options.autoSave=!1,t.options.saveOnClose=!1,t.fireEvent("postDelete"),t.app.close(),this.close()}.bind(this))}),(function(){this.close()}))},editDocument:function(){if(this.app.inBrowser)this.modules.each((function(t){MWF.release(t)})),this.app.node.destroy(),this.app.options.readonly=!1,this.app.loadApplication();else{var t={documentId:this.businessData.document.id,readonly:!1};this.app.options.postPublish&&(t.postPublish=this.app.options.postPublish),this.app.options.afterPublish&&(t.afterPublish=this.app.options.afterPublish),this.app.options.postDelete&&(t.postDelete=this.app.options.postDelete),this.app.options.formEditId&&(t.formEditId=this.app.options.formEditId),this.app.desktop.openApplication(null,"cms.Document",t),this.app.close()}},editDocumentForMobile:function(){this.app.mobile&&(this.app.options.readonly=!1,this.app.loadDocument(this.app.options))},setPopularDocument:function(){this.app.setPopularDocument()},printWork:function(t,e){t||this.businessData.work.application;(e=e)||(e=this.json.id,this.json.printForm&&(e=this.json.printForm)),window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+e))},openWindow:function(t,e){(t=t)||(t=this.json.id),this.businessData.document},uploadedAttachment:function(t,e){this.documentAction.getAttachment(e,this.businessData.document.id,function(e){var i=this.all[t];i&&(e.data&&i.attachmentController.addAttachment(e.data),i.attachmentController.checkActions(),i.fireEvent("upload",[e.data]))}.bind(this))},replacedAttachment:function(t,e){this.documentAction.getAttachment(e,this.businessData.document.id,function(i){var s=this.all[t];if(s){for(var o=s.attachmentController,n=null,a=0;a<o.attachments.length;a++)if(o.attachments[a].data.id===e){n=o.attachments[a];break}n.data=i.data,n.reload(),o.checkActions()}}.bind(this))}});