MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.Xform.Personfield=MWF.APPPersonfield=new Class({Implements:[Events],Extends:MWF.APP$Input,options:{moduleEvents:["load","queryLoad","postLoad","change","select"],readonly:!0},iconStyle:"personfieldIcon",getTextData:function(){var t=this.getValue(),e=[];return"object"===typeOf(t)&&(t=[t]),"array"===typeOf(t)?(t.each(function(t){"string"===typeOf(t)?e.push(t):e.push(t.name+(t.unitName?"("+t.unitName+")":""))}.bind(this)),{value:t||"",text:[e.join(",")]}):{value:[""],text:[""]}},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){this.selectUnits=this.getSelectRange(),"identity"==this.json.selectType&&(this.selectDutys=this.getSelectRangeDuty())},getScriptSelectUnit:function(){var t=[];if(this.json.rangeUnit&&this.json.rangeUnit.length&&this.json.rangeUnit.each(function(e){var i=e.distinguishedName||e.id||e.unique||e.levelName;i&&t.push(i)}.bind(this)),this.json.rangeField&&this.json.rangeField.length&&this.json.rangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction().getUnit(function(t){i=t.data}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}.bind(this)),this.json.rangeKey&&this.json.rangeKey.code){var e=this.form.Macro.exec(this.json.rangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction().getUnit(function(t){i=t.data}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}return t},getScriptSelectDuty:function(){var t=[];if(this.json.rangeDuty&&this.json.rangeDuty.length&&this.json.rangeDuty.each(function(e){var i=e.id||e.name;i&&t.push(i)}.bind(this)),this.json.rangeDutyField&&this.json.rangeDutyField.length&&this.json.rangeDutyField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.rangeDutyKey&&this.json.rangeDutyKey.code){var e=this.form.Macro.exec(this.json.rangeDutyKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},_computeValue:function(){var t=[];this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)}));var e="simple"===this.json.storeRange;if(this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){s.code&&(i=this.form.Macro.exec(s.code,this));var n='return this.org.getDuty("'+s.name+'", "'+i+'")',o=this.form.Macro.exec(n,this);"array"!==typeOf(o)&&(o=o?[o.toString()]:[]),o.each((function(i){i&&t.push(MWF.org.parseOrgData(i,!0,e))}))}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var n=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(n)&&(n=n?[n]:[]),n.each(function(i){var s;i&&("string"===typeOf(i)?(this.getOrgAction()[this.getValueMethod(i)](function(t){s=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,i,!1),t.push(s)):t.push(i))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},getNextSelectUnit:function(t){var e;if("direct"===this.json.rangeNext){if("array"===typeOf(t)){var i=[];return t.each(function(t){this.getOrgAction().getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&i.push(e.woUnit),e=null}.bind(this)),i}return this.getOrgAction().getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e.woUnit?[e.woUnit]:[]}return"level"===this.json.rangeNext?(this.getOrgAction().getUnitWithIdentityWithLevel(t,this.json.rangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e?[e]:[]):"type"===this.json.rangeNext?("all"===this.json.rangeNextUnitType?this.getOrgAction().getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.getOrgAction().getUnitWithIdentityWithType(t,this.json.rangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e?[e]:[]):void 0},getSelectRange:function(){if("unit"===this.json.range)return this.getScriptSelectUnit();if("draftUnit"===this.json.range){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.range){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},getOptions:function(){var t=this.getInputData(),e=this.json.count?this.json.count:0;this.json.range;var i=this.getSelectRange();if("identity"==this.json.selectType)var s=this.getSelectRangeDuty();if("all"!==this.json.range&&!i.length)return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;if("identity"==this.json.selectType&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(!s||!s.length))return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;var n=[];if(this.json.exclude){var o=this.form.Macro.exec(this.json.exclude.code,this);n="array"===typeOf(o)?o:[o]}var a={type:this.json.selectType,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,values:this.json.isInput?[]:t,count:e,units:i,dutys:"identity"==this.json.selectType?s:[],exclude:n,expandSubEnable:"no"!=this.json.expandSubEnable,categoryType:this.json.categoryType||"unit",onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:this.selectOnLoad.bind(this),onClose:this.selectOnClose.bind(this)};return this.form.json.selectorStyle&&(a=Object.merge(a,this.form.json.selectorStyle)),a},selectOnComplete:function(t){var e="simple"===this.json.storeRange,i=[];t.each(function(t){i.push(MWF.org.parseOrgData(t.data,!0,e))}.bind(this)),this.json.isInput?this.addData(i):this.setData(i),this.validationMode(),this.validation(),this.fireEvent("select")},selectOnCancel:function(){this.validation()},selectOnLoad:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")},selectOnClose:function(){v=this._getBusinessData(),v&&v.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")},clickSelect:function(t){var e=this.getOptions();this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,e))},resetData:function(){var t=this.getValue();this.setData(t)},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this._getBusinessData()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});new Element("div").inject(this.node)},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div");if(t.data){var i="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":i=t.data.name+"("+t.data.unitName+")";break;case"@p":i=t.data.name+"("+t.data.employee+")";break;case"@u":i=t.data.levelName;break;case"@g":i=t.data.name;break;default:i=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:i})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},_searchOptions:function(t,e){var i={type:this.json.selectType,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,units:this.selectUnits,dutys:"identity"==this.json.selectType?this.selectDutys:[]};this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+"("+t.employee+")";break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:function(t){this.clickSelect(t)}.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon||(this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before")),this.node.getFirst().setStyle("height","auto"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},getDataText:function(t){if("string"==typeOf(t))return t;var e="";switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":e=t.name+"("+t.unitName+")";break;case"@p":e=t.name+"("+t.employee+")";break;case"@u":case"@g":e=t.name;break;default:e=t.name}return e},addData:function(t){if(!t)return!1;var e="simple"===this.json.storeRange;t.each(function(t){var i,s=typeOf(t);"string"===s&&(this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,t,!1),i&&this.combox.addNewValue(this.getDataText(i),i));"object"===s&&this.combox.addNewValue(this.getDataText(t),t)}.bind(this))},setData:function(t){if(!t)return!1;var e=this.getData(),i=[],s=[],n="simple"===this.json.storeRange,o=typeOf(t);if("array"===o&&t.each(function(t){var e=typeOf(t),o=null;if("string"===e){var a=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){o=MWF.org.parseOrgData(t.data,!1,n)}.bind(this),a,t,!1)}"object"===e&&(o=MWF.org.parseOrgData(t,!1,n)).woPerson&&delete o.woPerson,o&&(i.push(o),s.push({text:this.getDataText(o),value:o}))}.bind(this)),"string"===o){var a,h=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){a=MWF.org.parseOrgData(t.data,!1,n)}.bind(this),h,t,!1),a&&(i.push(a),s.push({text:this.getDataText(a),value:a}))}"object"===o&&((a=MWF.org.parseOrgData(t,!1,n)).woPerson&&delete a.woPerson,i.push(a),s.push({text:this.getDataText(t),value:a}));var r,c=!1;if(e.length&&i.length)if(e.length===i.length){for(var l=0;l<e.length;l++)if(e[l].distinguishedName!==i[l].distinguishedName||e[l].name!==i[l].name||e[l].unique!==i[l].unique){c=!0;break}}else c=!0;else(i.length||e.length)&&(c=!0);(this._setBusinessData(i),c&&this.fireEvent("change"),this.json.isInput)?this.combox?(this.combox.clear(),this.combox.addNewValues(s)):(r=this.node.getFirst())&&(r.empty(),s.each(function(t,e){this.creteShowNode(t,e===s.length-1).inject(r)}.bind(this))):this.node.getFirst()?((r=this.node.getFirst()).empty(),this.loadOrgWidget(i,r)):(this.node.empty(),this.loadOrgWidget(i,this.node))},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitShow||", ");var s=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),n="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":n=t.value.name+"("+t.value.unitName+")";break;case"@p":n=t.value.name+"("+t.value.employee+")";break;case"@u":n=t.value.levelName;break;case"@g":n=t.value.name;break;default:n=t.value.name}var o=new Element("div").set({styles:{"font-size":"14px",color:""},text:n});new mBox.Tooltip({content:o,setStyles:{content:{padding:15,lineHeight:20}},attach:s,transition:"flyin"})}return s},_setValue:function(t){1!=t.length||t[0]||(t=[]);var e=[],i=[],s=typeOf(t),n="simple"===this.json.storeRange;if("array"===s&&t.each(function(t){var s=null,o=typeOf(t);if("string"===o){var a=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){s=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),a,t,!1)}"object"===o&&(s=t),s&&(e.push(s),i.push({text:this.getDataText(s),value:s}))}.bind(this)),"string"===s){var o,a=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){o=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),a,t,!1),o&&(e.push(o),i.push({text:this.getDataText(o),value:o}))}if("object"===s&&(e.push(t),i.push({text:this.getDataText(t),value:t})),this._setBusinessData(e),this.json.isInput)this.combox?(this.combox.clear(),this.combox.addNewValues(i)):(h=this.node.getFirst())&&(h.empty(),i.each(function(t,e){this.creteShowNode(t,e===i.length-1).inject(h)}.bind(this)));else if(this.node.getFirst()){var h=this.node.getFirst();this.loadOrgWidget(e,h)}else this.loadOrgWidget(e,this.node)},getValueMethod:function(t){if(t)switch(t.substr(t.length-1,1).toLowerCase()){case"i":return"getIdentity";case"p":return"getPerson";case"u":return"getUnit";case"g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var s=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||s||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){var s=t.distinguishedName.substr(t.distinguishedName.length-2,2),n=Object.clone(t);switch(s.toLowerCase()){case"@i":new MWF.widget.O2Identity(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@p":new MWF.widget.O2Person(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@u":new MWF.widget.O2Unit(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@g":new MWF.widget.O2Group(n,e,{style:"xform",lazy:!0,disableInfor:i});break;default:new MWF.widget.O2Other(n,e,{style:"xform",lazy:!0,disableInfor:i})}}.bind(this))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}}});