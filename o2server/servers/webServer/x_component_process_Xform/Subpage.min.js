MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Subpage=MWF.APPSubpage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.modules=[],this.moduleList={},this.getSubpage(function(){this.loadSubpage()}.bind(this))},reload:function(){this.clean(),this.getSubpage(function(){this.loadSubpage()}.bind(this))},clean:function(){if((this.modules||[]).each(function(e){this.form.modules.erase(e)}.bind(this)),Object.each(this.moduleList||{},function(e,s){delete this.form.json.moduleList[s]}.bind(this)),this.subpageData&&this.subpageData.json.id){var e=this.subpageData.json.id;this.parentpageIdList&&this.parentpageIdList.length&&this.parentpageIdList.erase(e)}this.json.id&&this.form.subpageModules&&this.form.subpageModules[this.json.id]&&(this.form.subpageModules[this.json.id]={}),this.modules=[],this.moduleList={},this.node.empty()},loadCss:function(){if(this.subpageData.json.css&&this.subpageData.json.css.code){for(var e,s=this.form.parseCSS(this.subpageData.json.css.code),t=new RegExp("(.+)(?=\\{)","g"),i=this.form.json.id.replace(/\-/g,"");null!==(e=t.exec(s));){var a=".css"+i+" ",o=a+e[0];s=s.substring(0,e.index)+o+s.substring(t.lastIndex,s.length),t.lastIndex=t.lastIndex+a.length}var n;if(!(n=$("style"+this.form.json.id)))(n=document.createElement("style")).setAttribute("type","text/css"),n.id="style"+this.form.json.id,n.inject(this.form.container,"before");if(n.styleSheet){var r=function(){n.styleSheet.cssText+=s};n.styleSheet.disabled?setTimeout(r,10):r()}else{var h=document.createTextNode(s);n.appendChild(h)}}},checkSubpageNested:function(e){return this.parentpageIdList?!this.parentpageIdList.contains(e):![this.form.json.id].contains(e)},getParentpageIdList:function(){var e;return this.parentpageIdList?(e=Array.clone(this.parentpageIdList)).push(this.subpageData.json.id):e=[this.form.json.id,this.subpageData.json.id],e},loadSubpage:function(){if(this.subpageData)if(this.checkSubpageNested(this.subpageData.json.id)){this.loadCss(),this.form.subpageModules=this.form.subpageModules||{};var e=this.form.subpageModules[this.json.id]={},s=this.getPageParamenters();if("object"===typeOf(s)&&this.form.Macro&&this.form.Macro.environment){var t=this.form.Macro.environment;t.subpageParameters=t.subpageParameters||{},t.subpageParameters[this.json.id]=s}this.node.set("html",this.subpageData.html),Object.each(this.subpageData.json.moduleList,function(e,s){var t=s;if(this.form.json.moduleList[s]){t=this.json.id+"_"+s;var i=this.node.getElement("#"+s);i&&i.set("id",t),e.orgiginalId=s,e.id=t}this.form.json.moduleList[t]=e,this.moduleList[t]=e}.bind(this)),this.form._getModuleNodes(this.node).each(function(s){if("form"!==s.get("MWFtype")){var t=this,i=this.form._getDomjson(s),a=this.form._loadModule(i,s,(function(){this.subpage=t,this.parentpageIdList=t.getParentpageIdList()}));this.form.modules.push(a),this.modules.push(a),e[i.orgiginalId||i.id]=a}}.bind(this))}else this.form.notice(MWF.xApplication.process.Xform.LP.subpageNestedError,"error");this.form.subpageLoadedCount?this.form.subpageLoadedCount++:this.form.subpageLoadedCount=1,this.form.checkSubformLoaded()},getSubpage:function(e){var s="Mobile"===this.form.json.mode||layout.mobile?"getPageByNameMobile":"getPageByName";if("script"===this.json.subpageType){if(this.json.subpageScript&&this.json.subpageScript.code){var t=this.form.Macro.exec(this.json.subpageScript.code,this);if(t){var i=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[s](t,i,function(s){this.getSubpageData(s.data),e&&e()}.bind(this))}else e&&e()}}else if(this.json.subpageSelected&&"none"!==this.json.subpageSelected){i=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[s](this.json.subpageSelected,i,function(s){this.getSubpageData(s.data),e&&e()}.bind(this))}else e&&e()},getSubpageData:function(e){var s;if(s=e.data,this.subpageData=null,s){var t=o2.bindJson(MWF.decodeJsonString(s),{lp:MWF.xApplication.process.Xform.LP.form});this.subpageData=JSON.decode(t),this.subpageData.updateTime=e.updateTime}},getPageParamenters:function(){var e=null;if("map"===this.json.parameterType)e=this.json.parametersMapList;else if("script"===this.json.parameterType){var s=this.json.parametersScript?this.json.parametersScript.code:"";s&&(e=this.form.Macro.exec(s,this))}return e}});