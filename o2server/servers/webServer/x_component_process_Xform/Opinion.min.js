MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("process.Work","lp."+o2.language,null,!1),MWF.xApplication.process.Xform.Opinion=MWF.APPOpinion=new Class({Implements:[Events],Extends:MWF.APP$Input,_loadUserInterface:function(){this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type}),this.node.setStyle("display","none")},validationConfigItem:function(i,e){if("all"===e.status||i===e.decision){var t=this.getInputData(),n="value"===e.valueType?t:t.length;switch(e.operateor){case"isnull":if(!(n||this.handwritingFile&&this.handwritingFile[layout.session.user.distinguishedName]))return this.notValidationMode(e.prompt),!1;break;case"notnull":if(n)return this.notValidationMode(e.prompt),!1;break;case"gt":if(n>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(n<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(n==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(n!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=n.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==n.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},_resetNodeEdit:function(){var i=new Element("textarea",{styles:{background:"transparent",width:"100%",border:"0px"}});i.set(this.json.properties);var e=new Element("div",{styles:{ovwrflow:"hidden",position:"relative","padding-right":"2px"}}).inject(this.node,"after");i.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var i=this.node.getFirst();i.set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type}),this.input=i,this.mediaActionArea=new Element("div",{styles:this.form.css.inputOpinionMediaActionArea}).inject(this.node),"no"!==this.json.isHandwriting&&(this.handwritingAction=new Element("div",{styles:this.form.css.inputOpinionHandwritingAction,text:MWF.xApplication.process.Work.LP.handwriting}).inject(this.mediaActionArea),this.handwritingAction.addEvent("click",function(){this.handwriting()}.bind(this))),"no"!==this.json.isAudio&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)&&(this.audioRecordAction=new Element("div",{styles:this.form.css.inputOpinionAudioRecordAction,text:MWF.xApplication.process.Work.LP.audioRecord}).inject(this.mediaActionArea),this.audioRecordAction.addEvent("click",function(){this.audioRecord()}.bind(this))),this.node.addEvent("change",function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation(),this.hideSelectOpinionNode()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this)),this.node.getFirst().addEvent("keydown",function(i){if(this.selectOpinionNode&&"none"!=this.selectOpinionNode.getStyle("display")&&this.selectOpinionNode.getFirst()){var e;if(38==i.code)if(this.selectedOpinionNode)(e=this.selectedOpinionNode.getPrevious())||(e=this.selectOpinionNode.getLast()),this.unselectedOpinion(this.selectedOpinionNode),this.selectedOpinion(e);else e=this.selectOpinionNode.getLast(),this.selectedOpinion(e);if(40==i.code)if(this.selectedOpinionNode)(e=this.selectedOpinionNode.getNext())||(e=this.selectOpinionNode.getFirst()),this.unselectedOpinion(this.selectedOpinionNode),this.selectedOpinion(e);else e=this.selectOpinionNode.getFirst(),this.selectedOpinion(e);27==i.code&&(this.hideSelectOpinionNode(),i.preventDefault()),32!=i.code&&13!=i.code||this.selectedOpinionNode&&(this.setOpinion(this.selectedOpinionNode.get("text")),i.preventDefault())}}.bind(this)),this.form.json.notLoadUserOpinion||MWF.UD.getDataJson("userOpinion",function(i){this.userOpinions=i}.bind(this),!1),this.node.getFirst().addEvent("input",function(i){this.startSearchOpinion()}.bind(this)),this.node.getFirst().addEvent("focus",function(){this.startSearchOpinion()}.bind(this))},audioRecord:function(){this.audioRecordNode||this.createAudioRecordNode(),this.audioRecordNode.show(),this.audioRecordNode.position({relativeTo:this.node,position:"center",edge:"center"});var i=this.audioRecordNode.getPosition(this.form.app.content),e=i.y,t=i.x;i.y<0&&(e=10),i.x<0&&(t=10),this.audioRecordNode.setStyles({top:e+"px",left:t+"px"}),this.soundFile={},MWF.require("MWF.widget.AudioRecorder",function(){this.audioRecorder=new MWF.widget.AudioRecorder(this.audioRecordNode,{onSave:function(i){this.soundFile[layout.session.user.distinguishedName]=i,this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.previewNode=new Element("audio",{controls:!0,src:window.URL.createObjectURL(i)}).inject(this.node),this.audioRecordNode.hide()}.bind(this),onCancel:function(){this.soundFile[layout.session.user.distinguishedName]=null,delete this.soundFile[layout.session.user.distinguishedName],this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.audioRecordNode.hide()}.bind(this)},null)}.bind(this))},createAudioRecordNode:function(){this.audioRecordNode=new Element("div",{styles:this.form.css.handwritingNode}).inject(this.node,"after");var i=this.node.getSize(),e=(Math.max(i.y,320),Math.max(i.x,400));e=Math.min(e,600),e=500;var t=this.node.getStyle("z-index").toInt()||0;t=t<1e3?1e3:t,this.audioRecordNode.setStyles({height:"320px",width:e+"px","z-index":t+1})},handwriting:function(){this.handwritingNode||this.createHandwriting(),this.handwritingNode.show(),this.handwritingNode.position({relativeTo:this.node,position:"center",edge:"center"});var i=this.handwritingNode.getPosition(this.handwritingNode.getOffsetParent()),e=i.y,t=i.x;i.y<0&&(e=10),i.x<0&&(t=10),this.handwritingNode.setStyles({top:e+"px",left:t+"px"})},createHandwriting:function(){this.handwritingNode=new Element("div",{styles:this.form.css.handwritingNode}).inject(this.node,"after");var i=this.node.getSize(),e=Math.max(this.json.tabletWidth||i.x,500),t=Math.max(this.json.tabletHeight?parseInt(this.json.tabletHeight)+110:i.y,320),n=this.node.getStyle("z-index").toInt()||0;n=n<1e3?1e3:n,this.handwritingNode.setStyles({height:t+"px",width:e+"px","z-index":n+1}),this.handwritingNode.position({relativeTo:this.node,position:"center",edge:"center"}),this.handwritingAreaNode=new Element("div",{styles:this.form.css.handwritingAreaNode}).inject(this.handwritingNode),this.handwritingActionNode=new Element("div",{styles:this.form.css.handwritingActionNode,text:MWF.xApplication.process.Work.LP.saveWrite}).inject(this.handwritingNode);var s=this.handwritingActionNode.getSize().y+this.handwritingActionNode.getStyle("margin-top").toInt()+this.handwritingActionNode.getStyle("margin-bottom").toInt();s=t-s,this.handwritingAreaNode.setStyle("height",s+"px"),this.handwritingFile={},MWF.require("MWF.widget.Tablet",function(){this.tablet=new MWF.widget.Tablet(this.handwritingAreaNode,{style:"default",contentWidth:this.json.tabletWidth||0,contentHeight:this.json.tabletHeight||0,onSave:function(i,e,t){this.handwritingFile[layout.session.user.distinguishedName]=t,this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),"no"!==this.json.isHandwritingPreview&&(this.previewNode=new Element("img",{src:e}).inject(this.node)),this.handwritingNode.hide()}.bind(this),onCancel:function(){this.handwritingFile[layout.session.user.distinguishedName]=null,delete this.handwritingFile[layout.session.user.distinguishedName],this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.handwritingNode.hide()}.bind(this)},null),this.tablet.load()}.bind(this)),this.handwritingActionNode.addEvent("click",function(){this.tablet&&this.tablet.save()}.bind(this))},unselectedOpinion:function(i){i.setStyle("background-color","#ffffff"),this.selectedOpinionNode=null},selectedOpinion:function(i){i.setStyle("background-color","#d2ddf5"),this.selectedOpinionNode=i},startSearchOpinion:function(){var i=this.input.get("value"),e=i.split(/(,\s*){1}|(;\s*){1}|\s+/g);(i=e[e.length-1]).length?(this.clearSearcheOpinionId(),this.searcheOpinionId=window.setTimeout(function(){this.searchOpinions(i)}.bind(this),500)):this.clearSearcheOpinionId()},clearSearcheOpinionId:function(){this.searcheOpinionId&&(window.clearTimeout(this.searcheOpinionId),this.searcheOpinionId="")},searchOpinions:function(i){var e=this.input.get("value"),t=e.split(/[\n\r]/g);lines=t.length;var n=e=t[t.length-1];if(this.userOpinions){var s=this.userOpinions.filter(function(e,t){return e.contains(i)&&e!=i}.bind(this));s.length?this.showSelectOpinionNode(s,n,lines):this.hideSelectOpinionNode(s)}},hideSelectOpinionNode:function(){this.selectOpinionNode&&this.selectOpinionNode.setStyle("display","none")},showSelectOpinionNode:function(i,e,t){this.selectOpinionNode||this.createSelectOpinionNode(),this.selectOpinionNode.empty(),i.each(function(i){this.createSelectOpinionOption(i)}.bind(this));var n=this.input.getSize(),s=MWF.getTextSize(e,this.json.inputStyles),o=(s.y-3)*t+3;o>n.y&&(o=n.y),this.selectOpinionNode.setStyle("display","block"),this.selectOpinionNode.position({relativeTo:this.node,position:"leftTop",edge:"leftTop",offset:{x:s.x,y:o}})},createSelectOpinionNode:function(){this.selectOpinionNode=new Element("div",{styles:this.form.css.opinionSelectNode}).inject(this.node)},createSelectOpinionOption:function(i){var e=new Element("div",{styles:this.form.css.opinionSelectOption,text:i}).inject(this.selectOpinionNode);this.json.selectItemStyles&&e.setStyles(this.json.selectItemStyles),e.addEvents({mouseover:function(){this.setStyle("background-color","#d2ddf5")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){this.setOpinion(i)}.bind(this)})},setOpinion:function(i){var e=this.input.get("value"),n=e.split(/(,\s*){1}|(;\s*){1}|\s+/g);t=n[n.length-1];var s=e.substr(0,e.length-t.length);this.input.set("value",s+i),this.hideSelectOpinionNode(),this._setBusinessData(this.getInputData())},_afterLoaded:function(){this.readonly||this.loadDescription()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var i=this.node.getFirst().getSize(),e=i.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||(e=i.x-23),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:i.y+"px","line-height":i.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))}});