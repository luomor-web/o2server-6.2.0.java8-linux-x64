MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Office=MWF.APPOffice=new Class({Extends:MWF.APP$Module,isActive:!1,options:{ProductCaption:"O2",ProductKey:"EDCC626CB85C9A1D3E0D7BDDDC2637753C596725",makerCaption:"浙江兰德纵横网络技术股份有限公司",makerKey:"E138DABB4AC26C2D8E09FAE59AB3BDE87AFB9D7B",version:"5.0.4.0",clsid:"A64E3073-2016-4baf-A89D-FFE1FAA10EC0",codeBase:"../o2_lib/officecontrol/5040/OfficeControl.cab",clsid64:"A64E3073-2016-4baf-A89D-FFE1FAA10EE1",codeBase64:"../o2_lib/officecontrol/5040/ofctnewclsid.cab",pdfType:"PDF.NtkoDocument",pdfVersion:"4.0.0.3",pdfCodeBase:"../o2_lib/officecontrol/5040/ntkooledocall.cab",pdfCodeBase64:"../o2_lib/officecontrol/5040/ntkooledocall64.cab",files:["doc","docx","dotx","dot","xls","xlsx","xlsm","xlt","xltx","pptx","ppt","pot","potx","potm","pdf"],moduleEvents:["redFile","afterOpen","afterOpenOffice","afterCreate","seal","beforeSave","afterSave","afterCloseOffice","load"]},initialize:function(e,t,i,o){this.node=$(e),this.node.store("module",this),this.json=t,this.form=i,this.field=!0,this.openedAttachment=null},_loadUserInterface:function(){this.node.empty(),this.node.setStyles({"min-height":"100px"}),"ie"===Browser.name&&(this.isActive=!0,this.file=null,this.form.officeList||(this.form.officeList=[]),this.form.officeList.push(this))},_afterLoaded:function(){this.json.isNotLoadNow||this.loadOffice()},loadOffice:function(e){this.officeLoaded?this.officeOCX&&this.officeOCX.BeginOpenFromURL(e,!0,this.readonly):(this.isActive?(MWF.getJSON("../o2_lib/officecontrol/config.json",function(e){this.officeConfig=e}.bind(this),!1),this.loadOfficeContorl(e)):this.loadOfficeNotActive(),this.officeLoaded=!0)},getProgID:function(){switch(this.json.officeType){case"word":return"Word.Document";case"excel":return"Excel.Sheet";case"ppt":return"PowerPoint.Show"}return"Word.Document"},defaultParam:function(e){return{ProductCaption:this.json.productCaption||this.options.ProductCaption,ProductKey:this.json.productKey||this.options.ProductKey,MakerCaption:this.officeConfig.makerCaption||this.json.makerCaption||this.options.makerCaption,MakerKey:this.officeConfig.makerKey||this.options.makerKey||this.options.MakerKey,Titlebar:"0",Menubar:"0",ToolBars:e?"0":"1",Statusbar:"0",IsUseUTF8URL:"1",IsUseUTF8Data:"1",BorderStyle:"0",IsNoCopy:"0",IsResetToolbarsOnOpen:"1",FileNew:"0",FileOpen:"1",FileClose:"0",FileSave:"0",FileProperties:"0"}},loadOfficeContorl:function(e){if(this.node.getSize().y<800&&this.node.setStyle("height","800px"),layout.desktop.offices||(layout.desktop.offices={}),layout.desktop.offices[this.getOfficeObjectId()]=this,this.readonly)this.loadOfficeRead(e);else if(this.json.isReadonly)this.readonly=!0,this.loadOfficeRead(e);else{if(this.json.readScript&&this.json.readScript.code)this.form.Macro.exec(this.json.readScript.code,this)?(this.readonly=!0,this.loadOfficeRead(e)):this.loadOfficeEdit(e);else this.loadOfficeEdit(e)}},loadOfficeSpacer:function(){var e=this.node.getSize();this.officeNode=new Element("div#officeNode",{styles:this.form.css.officeAreaNode}).inject(this.node);var t=e.y-40;this.officeNode.setStyle("height",t+"px"),this.form.app.addEvent("uncurrent",function(){var e=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",e),this.officeNode.setStyle("display","none")}.bind(this)),this.form.app.addEvent("current",function(){var e=this.officeNode.retrieve("officeDisplay");e&&this.officeNode.setStyle("display",e),this.officeOCX&&this.officeOCX.Activate(!0)}.bind(this)),this.form.app.addEvent("queryClose",function(){this.fireEvent("queryClose");var e=this.getOfficeObjectId();layout.desktop.offices[e]=null,delete layout.desktop.offices[e]}.bind(this))},hide:function(){if("none"!=this.officeNode.getStyle("display")){var e=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",e),this.officeNode.setStyle("display","none")}},show:function(){if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===this.form.app.appId||this.form.app.inBrowser){var e=this.officeNode.retrieve("officeDisplay");e&&this.officeNode.setStyle("display",e),this.officeOCX&&this.officeOCX.Activate(!0)}},isCover:function(e){},getFormId:function(){var e=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"form"+this.json.id+e},getFileName:function(){var e="docx";switch(this.json.officeType){case"word":e="docx";break;case"excel":e="xlsx";break;case"ppt":e="pptx"}var t=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"file"+this.json.id+t+"."+e},getOfficeObjectId:function(){var e=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"NTKOOCX"+this.json.id+e},getFileInputName:function(){var e=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"fileInput"+this.json.id+e},getTempleteUrl:function(){if(this.json.template){var e="",t=this.json.template.substr(0,1);if(e="/"===t?this.json.template.substr(1,this.json.template.indexOf("/",1)-1):this.json.template.substr(0,this.json.template.indexOf("/")),-1!==["x_processplatform_assemble_surface","x_portal_assemble_surface"].indexOf(e.toLowerCase())){var i=MWF.Actions.getHost(e);return"/"===t?i+this.json.template:i+"/"+this.json.template}}return this.json.template},getFile:function(e){var t=null;atts=this.form.businessData.attachmentList;for(var i=0;i<atts.length;i++)if(atts[i].site===e){t=atts[i];break}return t},getOfficeFileUrl:function(){this.getFileName();this.readSite=this.json.id,this.json.fileSite&&this.json.fileSite.code&&(this.readSite=this.form.Macro.exec(this.json.fileSite.code,this));var e=this.getFile(this.readSite);if(e||this.readSite!==this.json.id&&(e=this.getFile(this.json.id)),e){this.file=e;var t="";return this.form.businessData.workCompleted?(t=(t=this.form.workAction.action.actions.getWorkcompletedAttachmentData.uri).replace("{id}",encodeURIComponent(e.id)),this.form.workAction.action.address+t.replace("{workCompletedId}",encodeURIComponent(this.form.businessData.workCompleted.id))):(t=(t=this.form.workAction.action.actions.getAttachmentData.uri).replace("{id}",encodeURIComponent(e.id)),this.form.workAction.action.address+t.replace("{workid}",encodeURIComponent(this.form.businessData.work.id)))}return this.getTempleteUrl()},editEnabled:function(){try{this.officeOCX.ActiveDocument.Unprotect()}catch(e){}},docReadonly:function(){this.protect(3)},protect:function(e){try{this.officeOCX.ActiveDocument.Protect(e)}catch(e){}},startRevisions:function(){!this.officeOCX||1!=this.officeOCX.DocType&&6!=this.officeOCX.DocType||(this.officeOCX.ActiveDocument.Application.UserName=layout.desktop.session.user.name,this.officeOCX.ActiveDocument.Application.UserInitials=layout.desktop.session.user.name,this.isNew?(this.officeOCX.ActiveDocument.TrackRevisions=!1,this.officeOCX.ActiveDocument.showRevisions=!1):(this.officeOCX.ActiveDocument.TrackRevisions=!0,this.officeOCX.ActiveDocument.showRevisions=!1),this.officeOCX.ActiveDocument.Application.UserName=layout.desktop.session.user.name,this.officeOCX.ActiveDocument&&this.officeOCX.ActiveDocument.Application&&15==this.officeOCX.getOfficeVer()&&(this.officeOCX.ActiveDocument.Application.Options.UseLocalUserInfo=!0,this.officeOCX.WebUserName=layout.desktop.session.user.name))},stopRevisions:function(e){this.officeOCX.ActiveDocument.TrackRevisions=!1,this.officeOCX.ActiveDocument.showRevisions=!1,e&&this.officeOCX.ActiveDocument.AcceptAllRevisions()},createMenuAction:function(e,t,i){t=t||MWF.xApplication.process.Xform.LP[e];return new Element("div",{MWFnodeid:e,MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:t,MWFButtonAction:"menuAction",MWFButtonText:t}).inject(this.menuNode)},createMenuActionMenu:function(e,t,i){t=t||MWF.xApplication.process.Xform.LP[e];return new Element("div",{MWFnodeid:e,MWFnodetype:"MWFToolBarMenu",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:t,MWFButtonAction:"menuAction",MWFButtonText:t}).inject(this.menuNode)},createMenuActionMenuItem:function(e,t,i,o){return new Element("div",{MWFnodeid:e,MWFnodetype:"MWFToolBarMenuItem",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:t,MWFButtonAction:o,MWFButtonText:t}).inject(this.menuNode)},menuAction:function(e){switch(e.buttonID){case"menu_new":this.officeOCX.CreateNew(this.getProgID());break;case"menu_openfile":this.officeOCX.ShowDialog(1);break;case"menu_savefile":this.officeOCX.ShowDialog(3);break;case"revisions":this.toggleRevisions(e);break;case"menu_fullscreen":this.officeOCX.FullScreenMode=!0;break;case"toolbar":var t=this.officeOCX.ToolBars?MWF.xApplication.process.Xform.LP.menu_toolbar_show:MWF.xApplication.process.Xform.LP.menu_toolbar_hide;e.setText(t),this.officeOCX.ToolBars=!this.officeOCX.ToolBars;break;case"menu_preview":this.officeOCX.PrintPreview();break;case"menu_showHistory":this.showHistory(e);break;case"menu_redfile":this.redFile();break;case"menu_seal":this.seal();break;case"menu_att":e.menu.clearItems(),e._loadMenuItem(this.createMenuActionMenuItem("",MWF.xApplication.process.Xform.LP.menu_file,"109.png","openFile")),e._loadMenuLine(),this.json.attachmentIds.split(/,\s*|;\s*|，\s*|；\s*/g).each(function(t){this.form.businessData.attachmentList.each(function(i){i.site===t&&i.control.allowEdit&&-1!==this.options.files.indexOf(i.extension.toLowerCase())&&e._loadMenuItem(this.createMenuActionMenuItem(i.id,i.name,"14.png","openAttachment:"+i.id+":"+t+":"+i.name))}.bind(this))}.bind(this))}},openFile:function(e,t,i){this.openedAttachment&&(this.save(),this.loadOfficeEdit())},openAttachment:function(e,t,i){this.openedAttachment&&this.openedAttachment.id===e||(this.save(),this.form.businessData.workCompleted?MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(e,this.form.businessData.workCompleted.id,function(o){this.openedAttachment={id:e,site:t,name:i},this.officeOCX.BeginOpenFromURL(o,!0,this.readonly||this.json.isAttReadonly)}.bind(this)):MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(e,this.form.businessData.work.id,function(o){this.openedAttachment={id:e,site:t,name:i},this.officeOCX.BeginOpenFromURL(o,!0,this.readonly||this.json.isAttReadonly)}.bind(this)))},loadMenu:function(){this.isMenuLoad||(this.json.menuEditButtons&&this.json.menuEditButtons.length&&(this.menuNode=new Element("div",{styles:this.form.css.officeMenuNode}).inject(this.node,"top"),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.menuNode,{style:"xform_blue_simple"},this),-1!==this.json.menuEditButtons.indexOf("new")&&(this.newItem=this.createMenuAction("menu_new","","99.png")),-1!==this.json.menuEditButtons.indexOf("open")&&(this.openItem=this.createMenuAction("menu_openfile","","77.png")),-1!==this.json.menuEditButtons.indexOf("save")&&(this.saveItem=this.createMenuAction("menu_savefile","","67.png")),-1!==this.json.menuEditButtons.indexOf("revisions")){var e=MWF.xApplication.process.Xform.LP.menu_revisions_show;try{0!==this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup&&(e=MWF.xApplication.process.Xform.LP.menu_revisions_hide)}catch(e){}this.revisionsItem=this.createMenuAction("revisions",e,"76.png")}if(-1!==this.json.menuEditButtons.indexOf("fullscreen")&&(this.fullscreenItem=this.createMenuAction("menu_fullscreen","","4.png")),-1!==this.json.menuEditButtons.indexOf("toolbar")&&!this.readonly){e=MWF.xApplication.process.Xform.LP.menu_toolbar_show;this.officeOCX.ToolBars&&(e=MWF.xApplication.process.Xform.LP.menu_toolbar_hide),this.toolbarItem=this.createMenuAction("toolbar",e,"91.png")}-1!==this.json.menuEditButtons.indexOf("preview")&&(this.fullscreenItem=this.createMenuAction("menu_preview","","21.png")),-1!==this.json.menuEditButtons.indexOf("showHistory")&&(atts=this.form.businessData.attachmentList,atts.some(function(e){return e.site==this.json.id+"history"}.bind(this))&&(this.historyItem=this.createMenuAction("menu_showHistory","","115.png"))),-1!==this.json.menuEditButtons.indexOf("redfile")&&(this.readonly||(this.redItem=this.createMenuAction("menu_redfile","","12.png"))),-1!==this.json.menuEditButtons.indexOf("seal")&&(this.readonly||(this.sealItem=this.createMenuAction("menu_seal","","84.png"))),this.json.isOpenAttachment&&this.json.attachmentIds&&(this.sealItem=this.createMenuActionMenu("menu_att","","14.png")),this.toolbarWidget.load()}.bind(this))),this.isMenuLoad=!0)},showHistory:function(e){if(this.historyItem.get("text")==MWF.xApplication.process.Xform.LP.menu_hideHistory){var t=this.getOfficeFileUrl();if(t){var i=this.getOfficeObjectId();this.addOfficeEvent(i,"OnDocumentOpened(url, doc)",'if (layout.desktop.offices["'+i+'"]) layout.desktop.offices["'+i+'"].OnDocumentOpened(url, doc);'),this.addOfficeEvent(i,"AfterOpenFromURL(doc, statusCode)",'if (layout.desktop.offices["'+i+'"]) layout.desktop.offices["'+i+'"].AfterOpenFromURL(doc, statusCode);'),e.setText(MWF.xApplication.process.Xform.LP.menu_showHistory),this.officeOCX.BeginOpenFromURL(t,!0,this.readonly),this.historyMode=!1}}else MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.form.app.content,680,500),i=new MWF.xDesktop.Dialog({title:MWF.xApplication.process.Xform.LP.menu_showHistory,style:this.form.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:500,html:"<div></div>",container:this.form.app.content,isClose:!0,buttonList:[{text:MWF.xApplication.process.Xform.LP.close,action:function(){this.close()}}],onPostShow:function(){this.showHistoryContent(i,e)}.bind(this)});i.show()}.bind(this))},showHistoryContent:function(e,t){e.content.setStyle("overflow","auto"),atts=this.form.businessData.attachmentList;for(var i=this.json.id+"history",o=0;o<atts.length;o++)if(atts[o].site===i){file=atts[o];var s=new Element("div",{styles:{margin:"20px auto 0px auto",height:"30px","line-height":"30px",width:"80%","font-size":"16px",color:"#666666","border-bottom":"1px solid #CCCCCC"},value:file.id}).inject(e.content);new Element("div",{styles:{float:"left"},text:file.name}).inject(s),new Element("input",{type:"button",styles:{float:"right"},value:MWF.xApplication.process.Xform.LP.seeVersion,events:{click:function(i){this.openOfficeHistory(i,e,t)}.bind(this)}}).inject(s)}},openOfficeHistory:function(e,t,i){var o=e.target.getParent().get("value");this.form.businessData.workCompleted?(url=this.form.workAction.action.actions.getWorkcompletedAttachmentData.uri,url=url.replace("{id}",encodeURIComponent(o)),url=this.form.workAction.action.address+url.replace("{workCompletedId}",encodeURIComponent(this.form.businessData.workCompleted.id))):(url=this.form.workAction.action.actions.getAttachmentData.uri,url=url.replace("{id}",encodeURIComponent(o)),url=this.form.workAction.action.address+url.replace("{workid}",encodeURIComponent(this.form.businessData.work.id))),t.close(),this.save(),this.officeOCX.BeginOpenFromURL(url,!0,!0),this.historyMode=!0,i&&i.setText(MWF.xApplication.process.Xform.LP.menu_hideHistory)},seal:function(){this.fireEvent("seal")},redFile:function(){this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter&&(this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup=0,this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.View=0),this.officeOCX.ActiveDocument.showRevisions=!1,this.stopRevisions(!0),this.fireEvent("redFile")},showRevisions:function(){try{this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter&&(this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup=2,this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.View=0),this.officeOCX.ActiveDocument.showRevisions=!0}catch(e){}},hideRevisions:function(){try{this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter&&(this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup=0,this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.View=0),this.officeOCX.ActiveDocument.showRevisions=!1}catch(e){}},toggleRevisions:function(e){if(this.revisionsItem.get("text")===MWF.xApplication.process.Xform.LP.menu_revisions_show){e.setText(MWF.xApplication.process.Xform.LP.menu_revisions_hide);try{this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup=2,this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.View=0}catch(e){}try{this.officeOCX.ActiveDocument.showRevisions=!0}catch(e){}}else{e.setText(MWF.xApplication.process.Xform.LP.menu_revisions_show);try{this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup=0,this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.View=0}catch(e){}try{this.officeOCX.ActiveDocument.showRevisions=!1}catch(e){}}},afterOpen:function(){this.readonly&&this.docReadonly(),"1"===this.json.trackRevisions&&this.startRevisions();var e=this.readonly?this.json.readScale:this.json.editScale;e&&(e=e.toInt()),e&&(this.officeOCX.ActiveDocument.ActiveWindow.ActivePane.View.Zoom.Percentage=e);var t=this.officeNode.getStyle("display");this.officeOCX.Activate(!1),this.officeNode.setStyle("display","none"),window.setTimeout(function(){this.officeNode.setStyle("display",t),this.officeOCX.Activate(!0)}.bind(this),10)},loadOfficeEditFirefox:function(e){if(!this.officeOCX){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var t=this.json.codeBase||this.options.codeBase,i=this.json.version||this.options.version,o=this.json.clsid||this.options.clsid,s="";s=navigator.userAgent.indexOf("Linux")>-1?"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id='"+this.getOfficeObjectId()+"' type='application/ntko-plug' height='99%' width='100%' style='HEIGHT: 99%; WIDTH: 100%' ":"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id='"+this.getOfficeObjectId()+"' type='application/ntko-plug' style='HEIGHT: 99%; WIDTH: 100%' height='99%' width='100%' codeBase='"+t+"#version="+i+"' clsid='{"+o+"}' ",s+="ForOnSaveToURL='OnComplete2' ",s+="ForOnBeginOpenFromURL='OnComplete' ",s+="ForOndocumentopened='OnComplete3' ",s+="ForOnpublishAshtmltourl='publishashtml' ";var n=this.defaultParam();n=Object.merge(n,this.json.ntkoEditProperties),n=Object.merge(n,this.json.editProperties),Object.each(n,(function(e,t){s+="_"+t+"='"+e+"'"})),s+=">",s+="<SPAN STYLE='color:red'>"+MWF.xApplication.process.Xform.LP.installNTKOWebChromePluginNotice_xpi+"</SPAN>",s+="</OBJECT><input type='hidden' value='"+this.json.id+"' name='site'><input style='display:none' name=\"file\" type=\"file\"/></form>",this.officeNode.appendHTML(s),this.officeForm=this.officeNode.getFirst(),this.officeOCX=this.officeNode.getFirst().getFirst(),"Win64"==window.navigator.platform&&this.officeOCX.AddDocTypePlugin(".pdf",pdfType,pdfVersion,pdfCodeBase64,51,!0),"Win32"==window.navigator.platform&&this.officeOCX.AddDocTypePlugin(".pdf",pdfType,pdfVersion,pdfCodeBase,51,!0),this.doOfficeOCXEvents()}var c=this.getOfficeFileUrl();c?this.officeOCX.BeginOpenFromURL(c,!0,this.readonly):(this.officeOCX.CreateNew(this.getProgID()),this.fireEvent("afterCreate"))},loadOfficeEditChrome:function(e){if(!this.officeOCX){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var t=this.officeConfig.codeBase||this.json.codeBase||this.options.codeBase,i=this.officeConfig.version||this.json.version||this.options.version,o=this.officeConfig.classid||this.json.clsid||this.options.clsid,s=(this.officeConfig.codeBase64||this.json.codeBase64||this.options.codeBase64,this.officeConfig.classid64||this.json.clsid64||this.options.clsid64,this.officeConfig.pdfType||this.json.pdfType||this.options.pdfType),n=this.officeConfig.pdfVersion||this.json.pdfVersion||this.options.pdfVersion,c=this.officeConfig.pdfCodeBase||this.json.pdfCodeBase||this.options.pdfCodeBase,a=this.officeConfig.pdfCodeBase64||this.json.pdfCodeBase64||this.options.pdfCodeBase64,r="";r="<form id='"+this.getFormId()+"' style='height:100%'><OBJECT type='application/ntko-plug' id='"+this.getOfficeObjectId()+"' height='99%' width='100%' style='HEIGHT: 99%; WIDTH: 100%' codeBase='"+t+"#version="+i+"' clsid='{"+o+"}'",r+="ForOnSaveToURL='OnComplete2' ",r+="ForOnBeginOpenFromURL='OnComplete' ",r+="ForOndocumentopened='OnComplete3' ",r+="ForOnpublishAshtmltourl='publishashtml' ";var f=this.defaultParam();f=Object.merge(f,this.json.ntkoEditProperties),f=Object.merge(f,this.json.editProperties),Object.each(f,(function(e,t){r+="_"+t+"='"+e+"'"})),r+=">",r+="<SPAN STYLE='color:red'>"+MWF.xApplication.process.Xform.LP.installNTKOWebChromePluginNotice_crx+"</SPAN>",r+="</OBJECT><input type='hidden' value='"+this.json.id+"' name='site'><input style='display:none' name=\"file\" type=\"file\"/></form>",this.officeNode.appendHTML(r),this.officeForm=this.officeNode.getFirst(),this.officeOCX=this.officeNode.getFirst().getFirst(),this.officeOCX&&("Win64"==window.navigator.platform&&this.officeOCX.AddDocTypePlugin(".pdf",s,n,a,51,!0),"Win32"==window.navigator.platform&&this.officeOCX.AddDocTypePlugin(".pdf",s,n,c,51,!0),this.doOfficeOCXEvents())}var h=this.getOfficeFileUrl();h?this.officeOCX.BeginOpenFromURL(h,!0,this.readonly):(window.setTimeout(function(){this.officeOCX.CreateNew("WPS.Document")}.bind(this),5e3),this.fireEvent("afterCreate"))},loadOfficeEdit:function(e){"chrome"===Browser.name?this.loadOfficeEditChrome(e):"firefox"===Browser.name?this.loadOfficeEditFirefox(e):this.loadOfficeEditIE(e),this.openedAttachment=null},getAutoSavedAttachments:function(){this.autoSavedAttachments=[],this.form.businessData.attachmentList.each(function(e){e.site===this.json.id+"autosave"&&this.autoSavedAttachments.push(e)}.bind(this))},loadOfficeEditIE:function(e){if(!this.officeOCX){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var t=this.officeConfig.codeBase||this.json.codeBase||this.options.codeBase,i=this.officeConfig.version||this.json.version||this.options.version,o=this.officeConfig.classid||this.json.clsid||this.options.clsid,s=this.officeConfig.codeBase64||this.json.codeBase64||this.options.codeBase64,n=this.officeConfig.classid64||this.json.clsid64||this.options.clsid64,c=this.officeConfig.pdfType||this.json.pdfType||this.options.pdfType,a=this.officeConfig.pdfVersion||this.json.pdfVersion||this.options.pdfVersion,r=this.officeConfig.pdfCodeBase||this.json.pdfCodeBase||this.options.pdfCodeBase,f=this.officeConfig.pdfCodeBase64||this.json.pdfCodeBase64||this.options.pdfCodeBase64,h="";h="Win64"==window.navigator.platform?"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+s+"#version="+i+'" classid="clsid:'+n+'">':"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+t+"#version="+i+'" classid="clsid:'+o+'">';var d=this.defaultParam();d=Object.merge(d,this.json.ntkoEditProperties),d=Object.merge(d,this.json.editProperties),Object.each(d,(function(e,t){h+='<PARAM NAME="'+t+'" value="'+e+'">'})),h+="</OBJECT><input type='hidden' value='"+this.json.id+"' name='site'><input type='hidden' value='' name='fileName'><input style='display:none' name=\"file\" type=\"file\"/></form>",this.officeNode.appendHTML(h),this.officeForm=this.officeNode.getFirst(),this.officeOCX=this.officeNode.getFirst().getFirst(),"Win64"==window.navigator.platform?this.officeOCX.AddDocTypePlugin(".pdf",c,a,f,51,!0):this.officeOCX.AddDocTypePlugin(".pdf",c,a,r,51,!0),this.doOfficeOCXEvents()}this.getAutoSavedAttachments(),this.autoSavedAttachments&&this.autoSavedAttachments.length?this.openRecoverAutoSaveDlg():this.openOfficeFile(e)},openOfficeFile:function(e){var t=e||this.getOfficeFileUrl();t?this.officeOCX.BeginOpenFromURL(t,!0,this.readonly):(this.isNew=!0,this.officeOCX.CreateNew(this.getProgID()),this.fireEvent("afterCreate")),this.json.isAutoSave&&(this.autoSaveTimerID||(this.autoSave(),this.form.app.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))))},clearAutoSaveAttachments:function(){this.form.businessData.attachmentList.each(function(e){e.site===this.json.id+"autosave"&&o2.Actions.get("x_processplatform_assemble_surface").deleteAttachment(e.id,this.form.businessData.work.id)}.bind(this)),this.autoSavedAttachments=[]},getRecoverItems:function(e){var t=this.form.css,i=this;this.autoSavedAttachments.each(function(o){var s=new Element("div",{styles:t.officeRecoverItemNode}).inject(e),n=new Element("div",{styles:t.officeRecoverItemActionNode}).inject(s);new Element("div",{styles:t.officeRecoverItemTitleNode,text:o.name}).inject(s);s.store("att",o),n.addEvent("click",(function(e){var t=this.getParent().retrieve("att");i.form.workAction.getAttachmentData(t.id,i.form.businessData.work.id),e.stopPropagation()})),s.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(t.officeRecoverItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(t.officeRecoverItemNode)},click:function(){this.retrieve("isSelected")?(this.setStyles(t.officeRecoverItemNode),this.getFirst().setStyles(t.officeRecoverItemActionNode),this.store("isSelected",!1)):(e.getChildren().each((function(e){e.setStyles(t.officeRecoverItemNode),e.getFirst().setStyles(t.officeRecoverItemActionNode),e.store("isSelected",!1)})),this.setStyles(t.officeRecoverItemNode_current),this.getFirst().setStyles(t.officeRecoverItemActionNode_current),this.store("isSelected",!0))}})}.bind(this))},openRecoverAutoSaveDlg:function(){var e=MWF.xApplication.process.Xform.LP,t=new Element("div",{styles:{overflow:"hidden",padding:"0 30px"}}),i='<div style="line-height: 30px; height: 30px; color: #333333; overflow: hidden">'+e.selectVersionToRestore+"</div>";i+='<div style="max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',t.set("html",i);var o=t.getLast();this.getRecoverItems(o),t.inject(this.form.app.content);var s=this,n=o2.DL.open({title:e.restoreFile,isResize:!1,content:t,width:600,onPostClose:function(){s.clearAutoSaveAttachments()},buttonList:[{text:MWF.xApplication.process.Xform.LP.recover,action:function(e,i){this.doRecoverFile(t,i,n)}.bind(this)},{text:MWF.xApplication.process.Xform.LP.notRecover,action:function(e,i){this.doNotRecoverFile(t,i,n)}.bind(this)}]})},doNotRecoverFile:function(e,t,i){var o=this;this.form.app.confirm("infor",t,this.form.app.lp.notRecoverFileConfirmTitle,this.form.app.lp.notRecoverFileConfirmContent,450,120,(function(){this.close(),i.close(),o.openOfficeFile()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},doRecoverFile:function(e,t,i){for(var o=e.getLast().getChildren(),s=this,n=0;n<o.length;n++)if(o[n].retrieve("isSelected")){var c=this.form.app.lp.recoverFileConfirmContent,a=o[n].retrieve("att");c=c.replace("{att}",a.name),this.form.app.confirm("infor",t,this.form.app.lp.recoverFileConfirmTitle,c,450,120,(function(){this.close(),i.close(),s.form.workAction.getAttachmentUrl(a.id,s.form.businessData.work.id,(function(e){s.openOfficeFile(e),i.close()}))}),(function(){this.close()}),null,null,this.form.json.confirmStyle);break}},checkAutoSaveNumber:function(e){if(this.autoSavedAttachments||(this.autoSavedAttachments=[]),this.json.autoSaveNumber||(this.json.autoSaveNumber=3),this.autoSavedAttachments.length>=this.json.autoSaveNumber.toInt()){var t=this.autoSavedAttachments.shift();o2.Actions.get("x_processplatform_assemble_surface").deleteAttachment(t.id,this.form.businessData.work.id,function(){this.checkAutoSaveNumber(e)}.bind(this))}else e&&e()},getAutoSaveFileName:function(){var e="docx";switch(this.json.officeType){case"word":e="docx";break;case"excel":e="xlsx";break;case"ppt":e="pptx"}var t=Date.parse(new Date).format("%Y-%m-%d %H:%M:%S");return MWF.xApplication.process.Xform.LP.autosave+"("+t+")."+e},autoSave:function(){var e=this.json.autoSaveTime?60*this.json.autoSaveTime.toInt()*1e3:3e5;this.autoSaveTimerID=window.setInterval(function(){this.openedAttachment||this.checkAutoSaveNumber(function(){try{var e=this.getAutoSaveFileName();this.officeForm.getElement("input").set("value",this.json.id+"autosave"),url=this.form.workAction.action.actions.uploadAttachment.uri,url=this.form.workAction.action.address+url.replace("{id}",this.form.businessData.work.id),this.officeOCX.SaveToURL(url,"file","",e,this.getFormId()),this.form.workAction.listAttachments(this.form.businessData.work.id,function(t){this.form.businessData.attachmentList=t.data;for(var i=0;i<t.data.length;i++){var o=t.data[i];if(o.name===e){this.autoSavedAttachments.push(o);break}}}.bind(this),null,!1)}catch(e){}}.bind(this))}.bind(this),e)},doOfficeOCXEvents:function(){var e=this.getOfficeObjectId();this.addOfficeEvent(e,"AfterOpenFromURL(doc, statusCode)",'if (layout.desktop.offices["'+e+'"]) layout.desktop.offices["'+e+'"].AfterOpenFromURL(doc, statusCode);'),this.addOfficeEvent(e,"OnDocumentOpened(url, doc)",'if (layout.desktop.offices["'+e+'"]) layout.desktop.offices["'+e+'"].OnDocumentOpened(url, doc);'),this.addOfficeEvent(e,"OnDocumentClosed()",'if (layout.desktop.offices["'+e+'"]) layout.desktop.offices["'+e+'"].OnDocumentClosed();')},OnDocumentClosed:function(){this.fireEvent("afterCloseOffice")},OnDocumentOpened:function(e,t){this.afterOpen(),this.loadMenu(),this.fireEvent("afterOpenOffice",{url:e,doc:t})},AfterOpenFromURL:function(e,t){this.fireEvent("afterOpen",[e,t])},addOfficeEvent:function(e,t,i){var o=document.createElement("script");o.setAttribute("for",e),o.setAttribute("event",t),o.innerText=i,this.officeForm.appendChild(o)},loadOfficeRead:function(e){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var t=this.officeConfig.codeBase||this.json.codeBase||this.options.codeBase,i=this.officeConfig.version||this.json.version||this.options.version,o=this.officeConfig.classid||this.json.clsid||this.options.clsid,s=this.officeConfig.codeBase64||this.json.codeBase64||this.options.codeBase64,n=this.officeConfig.classid64||this.json.clsid64||this.options.clsid64,c=this.officeConfig.pdfType||this.json.pdfType||this.options.pdfType,a=this.officeConfig.pdfVersion||this.json.pdfVersion||this.options.pdfVersion,r=this.officeConfig.pdfCodeBase||this.json.pdfCodeBase||this.options.pdfCodeBase,f=this.officeConfig.pdfCodeBase64||this.json.pdfCodeBase64||this.options.pdfCodeBase64,h="";h="Win64"==window.navigator.platform?"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+s+"#version="+i+'" classid="clsid:'+n+'">':"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+t+"#version="+i+'" classid="clsid:'+o+'">';var d=this.defaultParam(!0);d=Object.merge(d,this.json.ntkoReadProperties),d=Object.merge(d,this.json.readProperties),Object.each(d,(function(e,t){h+='<PARAM NAME="'+t+'" value="'+e+'">'})),h+="</object></form>",this.officeNode.set("html",h),this.officeForm=this.officeNode.getFirst(),this.officeOCX=this.officeNode.getFirst().getFirst(),"Win64"==window.navigator.platform?this.officeOCX.AddDocTypePlugin(".pdf",c,a,f,51,!0):this.officeOCX.AddDocTypePlugin(".pdf",c,a,r,51,!0);var l=e||this.getOfficeFileUrl();if(l){var p=this.getOfficeObjectId();this.addOfficeEvent(p,"OnDocumentOpened(url, doc)",'if (layout.desktop.offices["'+p+'"]) layout.desktop.offices["'+p+'"].OnDocumentOpened(url, doc);'),this.addOfficeEvent(p,"AfterOpenFromURL(doc, statusCode)",'if (layout.desktop.offices["'+p+'"]) layout.desktop.offices["'+p+'"].AfterOpenFromURL(doc, statusCode);'),this.officeOCX.BeginOpenFromURL(l,!0,this.readonly)}},createUploadFileNode:function(){this.uploadFileAreaNode=new Element("div",{styles:{display:"none"}});this.uploadFileAreaNode.set("html",'<input name="file" type="file"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.uploadFileAreaNode.inject(this.officeForm)},isEmpty:function(){return!this.getData().trim()},getData:function(){return!this.officeOCX||1!=this.officeOCX.DocType&&6!=this.officeOCX.DocType?this._getBusinessData():(this.officeOCX.ActiveDocument.Application.Selection.WholeStory(),this.officeOCX.ActiveDocument.Application.Selection.Text)},setData:function(){},save:function(e){if(!this.readonly){if(this.historyMode)return!0;if(!this.officeForm)return!0;this.fireEvent("beforeSave");try{if(this.openedAttachment)this.officeForm.getElement("input").set("value",this.openedAttachment.site),t=(t=this.form.workAction.action.actions.replaceAttachment.uri).replace("{id}",this.openedAttachment.id),t=this.form.workAction.action.address+t.replace("{workid}",this.form.businessData.work.id),this.officeOCX.SaveToURL(t,"file","",this.openedAttachment.name,this.getFormId());else{e&&this.json.isHistory&&this.saveHistory(),this.clearAutoSaveAttachments(),this.officeForm.getElement("input").set("value",this.json.id);var t="";this.file?(t=(t=this.form.workAction.action.actions.replaceAttachment.uri).replace("{id}",this.file.id),t=this.form.workAction.action.address+t.replace("{workid}",this.form.businessData.work.id),this.officeOCX.SaveToURL(t,"file","",this.getFileName(),this.getFormId())):(t=this.form.workAction.action.actions.uploadAttachment.uri,t=this.form.workAction.action.address+t.replace("{id}",this.form.businessData.work.id),this.officeOCX.SaveToURL(t,"file","",this.getFileName(),this.getFormId()),this.form.workAction.getWorkContent(this.form.businessData.work.id,function(e){this.form.businessData.attachmentList=e.data.attachmentList,this.getOfficeFileUrl()}.bind(this)))}}catch(e){}this.fireEvent("afterSave")}},getHistoryFileName:function(){var e="docx";switch(this.json.officeType){case"word":e="docx";break;case"excel":e="xlsx";break;case"ppt":e="pptx"}return(this.form.businessData.work?this.form.businessData.work.activityName:MWF.xApplication.process.Xform.LP.completed)+"("+MWF.name.cn(layout.session.user.name)+")-"+Date.parse(new Date).format("%Y-%m-%d %H:%M")+"."+e},saveHistory:function(){var e=this.getHistoryFileName();this.officeForm.getElement("input").set("value",this.json.id+"history"),url=this.form.workAction.action.actions.uploadAttachment.uri,url=this.form.workAction.action.address+url.replace("{id}",this.form.businessData.work.id),this.officeOCX.SaveToURL(url,"file","",e,this.getFormId())},getHTMLFileName:function(){return(this.form.businessData.workCompleted?this.form.businessData.workCompleted.workId:this.form.businessData.work.id)+this.json.id+".mht"},saveHTML:function(){this.officeForm.getElement("input").set("value",this.json.id+"$view");for(var e=null,t=0;t<this.form.businessData.attachmentList.length;t++){var i=this.form.businessData.attachmentList[t];i.site==this.json.id+"$view"&&(e=i)}var o=e?e.name:this.getHTMLFileName();this.officeForm.getElement("input").getNext().set("value",o),e?(url=this.form.workAction.action.actions.replaceAttachment.uri,url=url.replace("{id}",e.id),url=this.form.workAction.action.address+url.replace("{workid}",this.form.businessData.work.id)):(url=this.form.workAction.action.actions.uploadAttachment.uri,url=this.form.workAction.action.address+url.replace("{id}",this.form.businessData.work.id)),this.officeOCX.SaveAsOtherFormatToURL(1,url,"file","",o,this.getFormId())},getHTMLFileUrl:function(e){var t=e||this.getHTMLFileName(),i=null;atts=this.form.businessData.attachmentList;for(var o=0;o<atts.length;o++)if(atts[o].name===t||atts[o].site===this.json.id+"$view"){i=atts[o];break}if(i){var s="";return this.form.businessData.workCompleted?(s=(s=this.form.workAction.action.actions.getWorkcompletedAttachmentData.uri).replace("{id}",encodeURIComponent(i.id)),this.form.workAction.action.address+s.replace("{workCompletedId}",encodeURIComponent(this.form.businessData.workCompleted.id))):(s=(s=this.form.workAction.action.actions.getAttachmentData.uri).replace("{id}",encodeURIComponent(i.id)),this.form.workAction.action.address+s.replace("{workid}",encodeURIComponent(this.form.businessData.work.id)))}return this.getTempleteUrl()},validationMode:function(){},validation:function(){return!0},loadOfficeNotActive:function(){this.getFileName();for(var e=0;e<this.form.businessData.attachmentList.length;e++){var t=this.form.businessData.attachmentList[e];t.site==this.json.id+"$view"&&t.name}if(!1!==this.json.isShowSummary){this.node.setStyles({overflow:"hidden","background-color":"#f3f3f3","min-height":"24px",padding:"18px"});var i=this.getData();(layout.mobile||COMMON.Browser.Platform.isMobile)&&i.length>300&&(i=i.substr(0,300)+"……");var o=new Element("div",{text:i}).inject(this.node)}o=(o=MWF.xApplication.process.Xform.LP.openOfficeInfor).replace("{type}",this.json.officeType);var s=new Element("div",{styles:{width:"200px",height:"24px",margin:"auto","margin-top":"18px","padding-left":"30px","font-size":"16px","font-weight":"bold",color:"#2b5797","font-family":"Gadugi",cursor:"pointer",background:"url("+this.form.path+this.form.options.style+"/icon/"+this.json.officeType+".png) no-repeat left center"},text:o}).inject(this.node);this.getOfficeFileUrl()||this.node.setStyle("display","none"),s.addEvent("click",function(){var e=this.getOfficeFileUrl();e&&(window.o2android?window.o2android.openDocument(e):window.webkit?window.webkit.messageHandlers.openDocument.postMessage(e):window.open(o2.filterUrl(e)))}.bind(this))}});