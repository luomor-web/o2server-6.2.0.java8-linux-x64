MWF.xDesktop.requireApp("process.Xform","Div",null,!1),MWF.xApplication.process.Xform.Source=MWF.APPSource=new Class({Extends:MWF.APPDiv,options:{moduleEvents:["queryLoad","postLoad","load","postLoadData","loadData"]},_loadUserInterface:function(){this.data=null,this.json.path&&"o2"==this.json.sourceType&&this.json.path&&this._getO2Source()},_getO2Address:function(){try{this.json.service=JSON.parse(this.json.contextRoot)}catch(t){this.json.service={root:this.json.contextRoot,action:"",method:"",url:""}}var t=layout.serviceAddressList[this.json.service.root];if(t)this.address=layout.config.app_protocol+"//"+t.host+(80==t.port?"":":"+t.port)+t.context;else{var e=layout.desktop.centerServer.host||window.location.hostname,o=layout.desktop.centerServer.port;this.address=layout.config.app_protocol+"//"+e+("80"==o?"":":"+o)+"/x_program_center"}},_getO2Uri:function(){var t=this.json.path,e={};this.json.parameters&&Object.each(this.json.parameters,function(o,s){if(-1!=t.indexOf("{"+s+"}")){var i=new RegExp("{"+s+"}","g");t=t.replace(i,encodeURIComponent(o&&o.code?this.form.Macro.exec(o.code,this)||"":o))}else e[s]=o}.bind(this));var o=null;if(this.json.requestBody&&this.json.requestBody.code&&(o=this.form.Macro.exec(this.json.requestBody.code,this)),"GET"==this.json.httpMethod||"OPTIONS"==this.json.httpMethod||"HEAD"==this.json.httpMethod||"DELETE"==this.json.httpMethod){var s="?";-1!=t.indexOf("?")&&(s="&"),Object.each(e,function(e,o){var i=e&&e.code?this.form.Macro.exec(e.code,this)||"":e;t=t+s+o+"="+i}.bind(this))}else Object.each(e,function(t,e){o||(o={});var s=t&&t.code?this.form.Macro.exec(t.code,this)||"":t;o[e]=s}.bind(this));this.body=o,this.uri=this.address+t},_getO2Source:function(){this._getO2Address(),this._getO2Uri(),this._invoke(function(){this._loadSub(this.node),this.fireEvent("loadData")}.bind(this))},_invoke:function(t){MWF.restful(this.json.httpMethod,this.uri,JSON.encode(this.body),function(e){this.data=e,this.fireEvent("postLoadData"),t&&t()}.bind(this),!0,!0)},setBody:function(t){this.body=t},setParameters:function(t){this.json.parameters=t,this._getO2Address(),this._getO2Uri()},addParameters:function(t){this.json.parameters||(this.json.parameters={}),Object.each(t,function(t,e){this.json.parameters[e]=t}.bind(this)),this._getO2Address(),this._getO2Uri()},reload:function(t,e){this._getO2Uri(),this._invoke(function(){this._loadSub(this.node,t),this.fireEvent("loadData"),e&&e()}.bind(this))},_loadSub:function(t,e){for(var o=t.getFirst(),s=null;o;)s=null,(s=o.retrieve("module",null))?s._loadJsonData&&s._loadJsonData(e):this._loadSub(o),o=o.getNext()}});