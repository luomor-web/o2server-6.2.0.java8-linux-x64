MWF.require(["MWF.widget.Common","MWF.widget.O2Identity"],null,!1),MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{},MWF.xDesktop.requireApp("process.Xform","lp."+MWF.language,null,!1),MWF.xApplication.process.Xform.Form=MWF.APPForm=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",readonly:!1,cssPath:"",macro:"FormContext",parameters:null,moduleEvents:["queryLoad","beforeLoad","beforeModulesLoad","postLoad","afterModulesLoad","afterLoad","beforeSave","afterSave","beforeClose","beforeProcessWork","beforeProcess","afterProcess","beforeReset","afterReset","beforeRetract","afterRetract","beforeReroute","afterReroute","beforeDelete","afterDelete","resize","beforeReaded","afterReaded"]},initialize:function(t,e,s){this.setOptions(s),this.container=$(t),this.container.setStyle("-webkit-user-select","text"),Browser.firefox&&this.container.setStyle("opacity",0),this.data=e,this.json=e.json,this.html=e.html,this.path="../x_component_process_Xform/$Form/",this.cssPath=this.options.cssPath||"../x_component_process_Xform/$Form/"+this.options.style+"/css.wcss",this._loadCss(),this.sectionListObj={},this.modules=[],this.all={},this.allForName={},this.forms={}},parseCSS:function(t){for(var e,s=/(url\(.*\))/g;null!==(e=s.exec(t));){var i=e[0],o=i.length,n=i.substring(i.length-2,i.length-1),a="'"===n||'"'===n?5:4,r="'"===n||'"'===n?2:1;if(-1!=(i=i.substring(a,i.length-r)).indexOf("x_processplatform_assemble_surface")||-1!=i.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var c=MWF.Actions.getHost("x_portal_assemble_surface");-1!==i.indexOf("/x_processplatform_assemble_surface")?i=i.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==i.indexOf("x_processplatform_assemble_surface")&&(i=i.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==i.indexOf("/x_portal_assemble_surface")?i=i.replace("/x_portal_assemble_surface",c+"/x_portal_assemble_surface"):-1!==i.indexOf("x_portal_assemble_surface")&&(i=i.replace("x_portal_assemble_surface",c+"/x_portal_assemble_surface")),i=o2.filterUrl(i)}var l=(i="url('"+i+"')").length;t=t.substring(0,e.index)+i+t.substring(s.lastIndex,t.length),s.lastIndex=s.lastIndex+(l-o)}return t},loadCss:function(){if(cssText=this.json.css?this.json.css.code:"",(r=$("style"+this.json.id))&&r.destroy(),cssText){cssText=this.parseCSS(cssText);for(var t,e=new RegExp("(.+)(?=\\{)","g"),s=this.json.id.replace(/\-/g,""),i=".css"+s+" ";null!==(t=e.exec(cssText));){var o=t[0];if(-1!=o.indexOf(",")){var n=o.split(/\s*,\s*/g),a=(n=n.map((function(t){return i+t}))).join(", ");cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+i.length*n.length}else{a=i+t[0];cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+i.length}}var r;if((r=document.createElement("style")).setAttribute("type","text/css"),r.id="style"+this.json.id,r.inject(this.container,"before"),r.styleSheet){var c=function(){r.styleSheet.cssText=cssText};r.styleSheet.disabled?setTimeout(c,10):c()}else{var l=document.createTextNode(cssText);r.appendChild(l)}return"css"+s}return""},keyLock:function(t){var e=this.businessData.work.id+"-"+this.businessData.work.activityToken;return o2.Actions.load("x_processplatform_assemble_surface").KeyLockAction.lock({key:e},function(e){flagData=e.data,t&&flagData.success&&(this.keyLockTimeoutId=window.setTimeout(function(){this.keyLock(!0)}.bind(this),9e4)),t&&!flagData.success&&this.app.reload()}.bind(this),null,!!t),flagData},checkLock:function(){if(this.businessData.control.allowProcessing&&"grab"==this.businessData.activity.manualMode){this.app.addEvent("queryClose",function(){this.keyLockTimeoutId&&window.clearTimeout(this.keyLockTimeoutId)}.bind(this));var t=this.keyLock();t.success?this.keyLock(!0):(this.businessData.control.allowProcessing=!1,this.businessData.control.allowSave=!1,this.businessData.control.allowReset=!1,this.businessData.control.allowReroute=!1,this.businessData.control.allowDelete=!1,this.businessData.control.allowAddSplit=!1,this.businessData.control.allowRetract=!1,this.businessData.control.allowRollback=!1,this.lockDataPerson=t.person)}},load:function(t){this.loadMacro(function(){this.loadLanguage(function(e){if(e&&this.formDataText){var s=o2.bindJson(this.formDataText,{lp:MWF.xApplication.process.Xform.LP.form});this.data=JSON.parse(s),this.json=this.data.json,this.html=this.data.html}this.checkLock(),this.loadExtendStyle(function(){this.app&&(this.app.formNode&&this.app.formNode.setStyles(this.json.styles),this.app.addEvent&&(this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this)),this.app.addEvent("queryClose",function(){this.beforeCloseWork()}.bind(this)))),this.businessData.control.allowSave||this.setOptions({readonly:!0});var e="";this.json.css&&this.json.css.code&&(e=this.loadCss()),this.container.set("html",this.html),this.node=this.container.getFirst(),e&&this.node.addClass(e),this._loadEvents(),this.loadRelatedScript(),this.fireEvent("queryLoad"),this.event_resolve?this.event_resolve(function(){this.loadForm(t)}.bind(this)):this.loadForm(t)}.bind(this))}.bind(this))}.bind(this))},loadLanguage:function(t){if("script"!==this.json.languageType&&"default"!==this.json.languageType)return t&&t(),!0;MWF.xApplication.process.Xform.LP.form;var e=null;if("script"==this.json.languageType)this.json.languageScript&&this.json.languageScript.code&&(e=this.Macro.exec(this.json.languageScript.code,this));else if("default"==this.json.languageType){var s="lp-"+o2.language;if("PageContext"===this.options.macro){var i=this.app.portal.id;e=this.workAction.getScriptByNameV2(i,s,function(t){return this.Macro.exec(t.data.text,this)}.bind(this),(function(){}))}else{var o=(this.businessData.work||this.businessData.workCompleted).application,n=this.workAction.getDictRoot(s,o,(function(t){return t.data}),(function(){})),a=new Promise(function(t,e){this.workAction.getScriptByNameV2(s,o,function(s){s.data.text?t(this.Macro.exec(s.data.text,this)):e("")}.bind(this),(function(){e("")}))}.bind(this));e=Promise.any([n,a])}}e?e.then&&"function"==o2.typeOf(e.then)?e.then((function(e){MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)}),(function(){t&&t(!0)})):(MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)):t&&t(!0)},loadRelatedScript:function(){if(this.json.includeScripts&&this.json.includeScripts.length){var t="",e=[];this.json.includeScripts.each(function(s){this.app.relatedScriptMap&&this.app.relatedScriptMap[s.id]&&(t+="\n"+this.app.relatedScriptMap[s.id].text,e.push(s.id))}.bind(this)),t&&this.Macro.exec(t,this)}},loadForm:function(t){if(this.lockDataPerson){var e=MWF.xApplication.process.Xform.LP.keyLockInfor;e=e.replace("{name}",o2.name.cn(this.lockDataPerson));var s=MWF.xApplication.process.Xform.LP.keyLockTitle;this.app.alert("info","center",s,e,400,160)}this.app&&this.app.fireEvent&&this.app.fireEvent("queryLoad"),this._loadBusinessData(),this.fireEvent("beforeLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeLoad"),this.loadContent(t)},loadExtendStyle:function(t){if(this.json.styleConfig&&this.json.styleConfig.extendFile)if("5.2"!=this.json.$version){var e="../x_component_process_FormDesigner/Module/Form/skin/"+this.json.styleConfig.extendFile;MWF.getJSON(e,{onSuccess:function(e){e&&e.form&&(this.json=Object.merge(this.json,e.form)),t&&t()}.bind(this),onRequestFailure:function(){t&&t()}.bind(this),onError:function(){t&&t()}.bind(this)})}else t&&t();else t&&t()},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro[this.options.macro||"FormContext"](this),t&&t()}.bind(this))},loadContent:function(t){if(this.subformCount=0,this.subformLoadedCount=0,this.subformLoaded=[this.json.id],this.subpageCount=0,this.subpageLoadedCount=0,this.subpageLoaded=[],this.widgetCount=0,this.widgetLoadedCount=0,this.widgetLoaded=[],this._loadHtml(),this._loadForm(),this.fireEvent("beforeModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeModulesLoad"),this._loadModules(this.node),Browser.firefox&&this.container.setStyle("opacity",1),"Mobile"===this.json.mode){var e=document.body.getElement(".o2_form_mobile_actions");e?(e.empty(),this._loadMobileActions(e,t)):t&&t()}else t&&t();this.fireEvent("postLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("postLoad"),this.checkSubformLoaded(!0)},checkSubformLoaded:function(t){t&&(this.isAllSubformLoaded=!0),this.isAllSubformLoaded&&(this.subformCount&&this.subformCount!==this.subformLoadedCount||this.subpageCount&&this.subpageCount!==this.subpageLoadedCount||this.widgetCount&&this.widgetCount!==this.widgetLoadedCount||(this.fireEvent("afterModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterModulesLoad"),this.fireEvent("afterLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterLoad"),this.isLoaded=!0))},_loadMobileDefaultTools:function(t){this.json.defaultTools?t&&t():this.json.defaultTools=o2.JSON.get("../x_component_process_FormDesigner/Module/Form/toolbars.json",function(e){this.json.defaultTools=e,t&&t()}.bind(this))},_loadMobileActions:function(t,e){var s=[];this._loadMobileDefaultTools(function(){if(this.json.defaultTools){var i=JSON.stringify(this.json.defaultTools);i=o2.bindJson(i,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.defaultTools=JSON.parse(i),this.json.defaultTools.each(function(t){this._checkDefaultMobileActionItem(t,this.options.readonly)&&s.push(t)}.bind(this))}if(this.json.tools){i=JSON.stringify(this.json.tools);i=o2.bindJson(i,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.tools=JSON.parse(i),this.json.tools.each(function(t){this._checkCustomMobileActionItem(t,this.options.readonly)&&s.push(t)}.bind(this))}this.mobileTools=s,window.o2android||window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.o2mLog?s.length&&t&&this._createMobileActions(t,s):s.length&&t&&this._createMobileActionsDingdingStyle(t,s),e&&e()}.bind(this))},_createMobileActionsDingdingStyle:function(t,e){t.show();var s=e.length;if(s<=2){var i=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-i.x*(s+1)-2*s)/s;e.each(function(e){var s=this.css.html5ActionButtonDingdingNormal;"继续流转"===e.text||"撤回"===e.text||"action_processWork"===e.id||"action_retract"===e.id?s=this.css.html5ActionButtonDingdingPrimary:"删除文件"!==e.text&&"action_delete"!==e.id||(s=this.css.html5ActionButtonDingdingDanger),s.width=o+"px";var i=new Element("div",{styles:s,text:e.text}).inject(t);i.store("tool",e),i.addEvent("click",function(t){var s=function(){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this);"继续流转"===e.text||"action_processWork"===e.id?window.setTimeout(s,100):s()}.bind(this)),new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}.bind(this))}else{i=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-4*i.x-6)/5;for(var n=0;n<3;n++){tool=e[n];var a,r=this.css.html5ActionButtonDingdingNormal;if("继续流转"===tool.text||"撤回"===tool.text?r=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(r=this.css.html5ActionButtonDingdingDanger),2==n)this.css.html5ActionButtonDingdingMore.width=o+"px",(a=new Element("div",{styles:this.css.html5ActionButtonDingdingMore,text:"…"}).inject(t)).addEvent("click",function(s){this._loadMoreMobileActionsDingdingStyle(e,2,t)}.bind(this));else r.width=2*o+"px",(a=new Element("div",{styles:r,text:tool.text}).inject(t)).store("tool",tool),a.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this));new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}}},_loadMoreMobileActionsDingdingStyle:function(t,e,s){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var i=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=i.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var c=this.css.html5ActionButtonDingdingNormal;"继续流转"===tool.text||"撤回"===tool.text?c=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(c=this.css.html5ActionButtonDingdingDanger),c.width="100%";var l=new Element("div",{styles:c,text:tool.text}).inject(this.actionMoreArea);l.store("tool",tool),l.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this))}}},_createMobileActions:function(t,e){t.show();var s=e.length;if(s<=2)this.css.html5ActionButton.width="100%",2==s&&(this.css.html5ActionButton.width="49%"),e.each(function(e){var s=new Element("div",{styles:this.css.html5ActionButton,text:e.text}).inject(t);s.store("tool",e),s.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(s)}.bind(this)),2==s&&new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before");else{this.css.html5ActionButton.width="38%";for(var i=0;i<2;i++){tool=e[i],(o=new Element("div",{styles:this.css.html5ActionButton,text:tool.text}).inject(t)).store("tool",tool),o.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(o)}var o;new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before"),new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t),this.css.html5ActionButton.width="23%",(o=new Element("div",{styles:this.css.html5ActionButton,text:"…"}).inject(t)).addEvent("click",function(s){this._loadMoreMobileActions(e,2,t)}.bind(this)),this._setMobileBottonStyle(o)}},_loadMoreMobileActions:function(t,e,s){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var i=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=i.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var c=new Element("div",{styles:this.css.html5ActionOtherButton,text:tool.text}).inject(this.actionMoreArea);c.store("tool",tool),c.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(c)}}},_setMobileBottonStyle:function(t){var e=this;t.addEvents({mouseover:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseout:function(t){this.setStyles(e.css.html5ActionButton_up)},mousedown:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseup:function(t){this.setStyles(e.css.html5ActionButton_up)},touchstart:function(t){this.setStyles(e.css.html5ActionButton_over)},touchcancel:function(t){this.setStyles(e.css.html5ActionButton_up)},touchend:function(t){this.setStyles(e.css.html5ActionButton_up)},touchmove:function(t){this.setStyles(e.css.html5ActionButton_over)}})},_runCustomAction:function(t){this.Macro.exec(t,this)},_checkCustomMobileActionItem:function(t,e){var s=!0;(s=e?t.readShow:t.editShow)&&(s=!0,t.control&&(s=this.form.businessData.control[t.control]),t.condition&&(s=!this.Macro.exec(t.condition,this)));return s},_checkDefaultMobileActionItem:function(t,e,s){var i=!0;if(t.control&&(i=this.businessData.control[t.control]),!s&&t.condition){var o=this.Macro.exec(t.condition,this);i=i&&!o}return"action_processWork"==t.id&&!this.businessData.task&&this.businessData.work.startTime&&(i=!1),"action_rollback"==t.id&&(t.read=!0),e&&(t.read||(i=!1)),i},_loadBusinessData:function(){this.businessData||(this.businessData={})},_loadHtml:function(){this.node.addEvent("selectstart",(function(t){var e="text";t.target.getStyle("-webkit-user-select")&&(e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()),"text"!==e&&"auto"!==e&&t.preventDefault()}))},_loadForm:function(){this._loadStyles(),this._loadCssLinks(),this._loadScriptSrc(),this._loadJsheader()},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(t,e){if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")){var s=MWF.Actions.getHost("x_processplatform_assemble_surface"),i=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",i+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",i+"/x_portal_assemble_surface"))}t=o2.filterUrl(t),this.node.setStyle(e,t)}.bind(this))},_loadCssLinks:function(){this.json.cssLinks.each((function(t){new Element("link",{rel:"stylesheet",type:"text/css",href:t}).inject($(document.head))}))},_loadScriptSrc:function(){this.json.scriptSrc.each((function(t){new Element("script",{src:t}).inject($(document.head))}))},_loadJsheader:function(){var t=this.json.jsheader?this.json.jsheader.code:"";t&&Browser.exec(t)},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)):"load"===e?this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this)):"submit"===e?this.addEvent("beforeProcess",function(){return this.Macro.fire(t.code,this)}.bind(this)):this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):"load"===t?this.addEvent("postLoad",function(t){return e?e(this,t):null}.bind(this)):"submit"===t?this.addEvent("beforeProcess",function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_getDomjson:function(t){switch(t.get("MWFtype")||t.get("mwftype")){case"form":return this.json;case"":return null;default:var e=t.get("id");return e||(e=t.get("MWFId")),e?this.json.moduleList[e]:null}},_getModuleNodes:function(t,e){for(var s=[],i=t.getFirst();i;){var o=i.get("MWFtype")||i.get("mwftype");if(o)-1!==o.indexOf("$")&&!0!==e||s.push(i),"datagrid"!==o&&"datatable"!==o&&"subSource"!==o&&"tab$Content"!==o&&"datatemplate"!==o&&(s=s.concat(this._getModuleNodes(i,e)));else s=s.concat(this._getModuleNodes(i,e));i=i.getNext()}return s},_loadModules:function(t){this._getModuleNodes(t).each(function(t){var e=this._getDomjson(t),s=this._loadModule(e,t);this.modules.push(s)}.bind(this))},_loadModule:function(t,e,s){"Subform"!==t.type&&"subform"!==t.moduleName||this.subformCount++,"Subpage"!==t.type&&"subpage"!==t.moduleName||this.subpageCount++,"Widget"!==t.type&&"widget"!==t.moduleName||this.widgetCount++,MWF["APP"+t.type]||MWF.xDesktop.requireApp("process.Xform",t.type,null,!1);var i=new MWF["APP"+t.type](e,t,this);if(s&&s.apply(i),this.all[t.id]||(this.all[t.id]=i),t.name)if(this.allForName[t.name]){var o=this.allForName[t.name];"array"===typeOf(o)?o.push(i):this.allForName[t.name]=[o,i]}else this.allForName[t.name]=i;return i.field&&(this.forms[t.id]||(this.forms[t.id]=i)),i.readonly=this.options.readonly,i.load(),i},saveOpinion:function(t){var e=t._getBusinessSectionDataByPerson();MWF.UD.getDataJson("userOpinion",function(t){t||(t=[]);var s=t.indexOf(e);-1==s?t.length>=50&&t.shift():t.splice(s,1),t.push(e),MWF.UD.putData("userOpinion",t)}.bind(this),!1)},loadPathData:function(t){var e=null;return this.workAction.getJobDataByPath(this.businessData.work.job,t,(function(t){e=t.data||null}),null,!1),e},getData:function(t){var e=this.businessData.data;return Object.each(this.forms,function(s,i){if(!(i.indexOf("..")>0))if("Opinion"===s.json.type)if(t){this.saveOpinion(s);var o=layout.desktop.session.user.id;"object"===typeOf(e[i])&&"string"===typeOf(e[i][o])?e[i][o]="":"string"===typeOf(e[i])&&(e[i]="")}else{var n=s.getData();e[i]=this.getSectionDataByPerson(n,e[i])}else if("yes"===s.json.section){n=this.getSectionData(s,e[i]);e[i]=n}else{n=s.getData();e[i]=n}}.bind(this)),this.businessData.data=e,this.Macro.environment.setData(this.businessData.data),e},getSectionData:function(t,e){var s=t.getData();switch(t.json.sectionBy){case"person":return this.getSectionDataByPerson(s,e);case"unit":return this.getSectionDataByUnit(s,e);case"activity":return this.getSectionDataByPActivity(s,e);case"splitValue":return this.getSectionDataBySplitValue(s,e);case"script":return this.getSectionDataByScript(t.json.sectionByScript.code,s,e);default:return s}},getSectionDataByPerson:function(t,e){var s=layout.desktop.session.user.id;return e&&"object"===typeOf(e)||(e={}),e[s]=t,e},getSectionDataByUnit:function(t,e){var s=this.businessData.task?this.businessData.task.unit:"";return e&&"object"===typeOf(e)||(e={}),s&&(e[s]=t),e},getSectionDataByPActivity:function(t,e){var s=this.businessData.work?this.businessData.work.activity:"";return e&&"object"===typeOf(e)||(e={}),s&&(e[s]=t),e},getSectionDataBySplitValue:function(t,e){var s=this.businessData.work?this.businessData.work.splitValue:"";return e&&"object"===typeOf(e)||(e={}),s&&(e[s]=t),e},getSectionDataByScript:function(t,e,s){var i=this.Macro.exec(t,this);return s&&"object"===typeOf(s)||(s={}),i&&(s[i]=e),s},setSection:function(t,e){var s=e[t.name];switch(t.sectionBy){case"person":return this.setSectionByPerson(s,t.name);case"unit":return this.setSectionByUnit(s,t.name);case"activity":return this.setSectionByPActivity(s,t.name);case"splitValue":return this.setSectionBySplitValue(s,t.name);case"script":return this.setSectionByScript(t.sectionByScript.code,s,t.name);default:return v}},setSectionByPerson:function(t,e){var s=layout.desktop.session.user.id;return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=s,t},setSectionByUnit:function(t,e){var s=this.businessData.task?this.businessData.task.unit:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=s||"",t},setSectionByPActivity:function(t,e){var s=this.businessData.work?this.businessData.work.activity:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=s||"",t},setSectionBySplitValue:function(t,e){var s=this.businessData.work?this.businessData.work.splitValue:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=s||"",t},setSectionByScript:function(t,e,s){var i=this.Macro.exec(t,this);return e&&"object"===typeOf(e)||(e={}),this.sectionListObj[s]=i||"",e},saveWork:function(t,e){this.businessData.control.allowSave?(this.fireEvent("beforeSave"),this.fireEvent("beforeSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(s){this.app&&!e&&this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved,"success"),t&&"function"===typeOf(t)&&t(),this.fireEvent("afterSave"),this.fireEvent("afterSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave")}.bind(this))):MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied")},getSectionList:function(){return Object.keys(this.sectionListObj).map(function(t){var e={path:t};return this.sectionListObj[t]&&(e.key=this.sectionListObj[t]),e}.bind(this))},setModifedDataByPathList:function(t,e){for(var s=this.modifedData,i=0;i<e.length;i++)i===e.length-1?s[e[i]]=t:s="object"===typeOf(s[e[i]])||"array"===typeOf(s[e[i]])?s[e[i]]:"number"===typeOf(e[i])?s[e[i]]=[]:s[e[i]]={}},getOrigianlPathData:function(t){for(var e=this.businessData.originalData,s=0;s<t.length;s++)if(s===t.length-1)e=e[t[s]];else{if("object"!==typeOf(e[t[s]])&&"array"!==typeOf(e[t[s]]))return null;e=e[t[s]]}return e},setModifedData:function(t,e){if(e=e||[],"object"===typeOf(t))for(var s in t){var i=Array.clone(e);i.push(s),this.setModifedData(t[s],i)}else if("array"===typeOf(t)){var o=this.getOrigianlPathData(e);"array"===typeOf(o)&&o.length===t.length&&this.compareObjects(o,t)||this.setModifedDataByPathList(t,e)}else if("null"!==typeOf(t)){o=this.getOrigianlPathData(e);typeOf(t)===typeOf(o)&&t===o||this.setModifedDataByPathList(t,e)}},compareObjects:function(t,e,s){if(s||(s=0),s>15)return!1;var i=typeOf(t);if(i!==typeOf(e))return!1;if("object"===i){for(var o in t)null!==t[o]&&void 0!==t[o]||delete t[o];for(var o in e)null!==e[o]&&void 0!==e[o]||delete e[o]}switch(i){case"object":case"array":var n,a=Object.keys(t),r=Object.keys(e);if(a.length!==r.length)return!1;for(a.sort(),r.sort(),n=0;n<a.length;n++){var c=a[n];"array"===i&&(c=c.toInt());var l=t[c],p=e[c];if(!1===this.compareObjects(l,p,s++))return!1}break;case"function":break;default:if(t!==e)return!1}return!0},saveFormData:function(t,e,s,i,o,n){this.businessData.work.startTime?this.saveFormDataInstance(t,e,s,i,o):this.saveFormDataDraft(t,e,s,i,o,n)},saveFormDataInstance:function(t,e,s,i,o){this.officeList&&this.officeList.each((function(t){t.save(s)}));i=i||this.getData(o);if(this.modifedData={},this.setModifedData(i),this.toWordSaveList&&this.toWordSaveList.length){var n=[];this.toWordSaveList.each((function(t){t.docToWord&&n.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(n).then(function(){this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(i),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)}.bind(this))}else this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(i),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)},saveFormDataDraft:function(t,e,s,i,o,n){this.officeList&&this.officeList.each((function(t){t.save(s)}));var a={data:i=i||this.getData(o),work:this.businessData.work,identity:this.businessData.work.creatorIdentityDn};this.workAction.saveDraft(a,function(e){this.businessData.originalData=null,this.businessData.originalData=Object.clone(i),this.workAction.getDraft(e.data.id,function(e){this.businessData.work=e.data.work,this.app.options.draftId=e.data.work.id,layout.app&&layout.app.inBrowser?(layout.app&&(layout.app.$openWithSelf=!0),t&&t(),n||layout.desktop.openApplication(null,"process.Work",{draftId:this.app.options.draftId})):(this.app.options.desktopReload=!0,this.app.appId="process.Work"+e.data.work.id,layout.desktop.apps?delete layout.desktop.apps[this.app.options.appId]:layout.desktop.apps={},layout.desktop.apps[this.app.appId]=this.app,t&&t(),n||this.app.reload())}.bind(this))}.bind(this),e)},setProcessorSectionOrgList:function(t){this.routeDataList||this.getRouteDataList();for(var e=this.routeDataList,s=0;s<e.length;s++)(e[s].selectConfigList||[]).each(function(e,s){"yes"==e.section&&this.setSection(e,t)}.bind(this))},getRouteDataList:function(){return this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.businessData.task.routeList},function(t){t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1),this.routeDataList},beforeCloseWork:function(){if(this.fireEvent("beforeClose"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeClose"),this.options.readonly)this.app.refreshTaskCenter();else if(this.businessData.work&&this.businessData.work.id&&!this.isSendBeacon){if(this.app.inBrowser&&navigator.sendBeacon){var t=this.workAction.action.actions.checkDraft,e=this.workAction.action.address+t.uri;e=e.replace("{id}",this.businessData.work.id),navigator.sendBeacon(e)}else this.workAction.checkDraft(this.businessData.work.id,function(){layout.desktop.apps&&layout.desktop.apps.TaskCenter&&layout.desktop.apps.TaskCenter.window&&(layout.desktop.apps.TaskCenter.content.unmask(),layout.desktop.apps.TaskCenter.refreshAll())}.bind(this),null,!1);this.isSendBeacon=!0}},closeWork:function(){this.app.close()},getMessageContent:function(t,e,s){var i="";if(t.completed)i+=MWF.xApplication.process.Xform.LP.workCompleted;else if(t.occurSignalStack)if(t.signalStack&&t.signalStack.length){var o=[];t.signalStack.each(function(t){var e=[];t.splitExecute&&(e=t.splitExecute.splitValueList||[]),t.manualExecute&&(e=t.manualExecute.identities||[]);var s=0,i=[];e.each((function(t){var e=o2.name.cn(t);i.contains(e)||i.push(e)})),i.length>8&&(s=i.length,i=i.slice(0,8)),i=o2.name.cns(i);var n=MWF.xApplication.process.Xform.LP,a="<b>"+n.nextActivity+"</b><span style='color: #ea621f'>"+t.name+"</span>；<b>"+n.nextUser+"</b><span style='color: #ea621f'>"+i.join(",")+"</span> <b>"+(s?","+n.next_etc.replace("{count}",s):"")+"</b>";o.push(a)}.bind(this)),i+=o.join("<br>")}else i+=MWF.xApplication.process.Xform.LP.taskCompleted;else if(t.properties.nextManualList&&t.properties.nextManualList.length){o=[];t.properties.nextManualList.each((function(t){var e=[];t.taskIdentityList.each((function(t){var s=o2.name.cn(t);e.contains(s)||e.push(s)}));var s="<b>"+MWF.xApplication.process.Xform.LP.nextActivity+"</b><span style='color: #ea621f'>"+t.activityName+"</span>；<b>"+MWF.xApplication.process.Xform.LP.nextUser+"</b><span style='color: #ea621f'>"+e.join(",")+"</span>";o.push(s)})),i+=o.join("<br>")}else t.arrivedActivityName?i+=MWF.xApplication.process.Xform.LP.arrivedActivity+t.arrivedActivityName:i+=MWF.xApplication.process.Xform.LP.taskCompleted;var n=this.businessData.data.title||this.businessData.data.subject||this.businessData.work.title;return e&&n.length>e&&(n=n.substr(0,e)+"..."),"<div>"+(s||MWF.xApplication.process.Xform.LP.taskProcessedMessage)+"“"+n+"”</div>"+i},addMessage:function(t,e){if(layout.desktop.message){var s={subject:MWF.xApplication.process.Xform.LP.taskProcessed,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage)};return layout.desktop.message.addTooltip(s),layout.desktop.message.addMessage(s)}this.app.inBrowser&&!e&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage))},formValidation:function(t,e,s){if(this.options.readonly)return!0;this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=s;var i=!0;return Object.each(this.forms,function(o,n){o.validationMode(),o.validation(t,e,s)||(i=!1)}.bind(this)),i},validation:function(t,e,s,i){this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=i;var o=this.validationRoute(s),n=this.validationOpinion(s);return o&&n},validationRoute:function(t){if(!this.json.validationRoute)return!0;if(!this.json.validationRoute.code)return!0;var e=this.Macro.exec(this.json.validationRoute.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationRouteMode(e,t),!1)},validationOpinion:function(t){if(!this.json.validationOpinion)return!0;if(!this.json.validationOpinion.code)return!0;var e=this.Macro.exec(this.json.validationOpinion.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationOpinionMode(e,t),!1)},formCustomValidation:function(){if(!this.json.validationFormCustom)return!0;if(!this.json.validationFormCustom.code)return!0;var t=this.Macro.exec(this.json.validationFormCustom.code,this);return t||(t=MWF.xApplication.process.Xform.LP.notValidation),"true"==t.toString()||(this.notValidationOpinionMode(t),!1)},notValidationRouteMode:function(t,e){e&&e.routeSelectorArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},t,e?e.routeSelectorArea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},notValidationOpinionMode:function(t,e){e&&e.inputTextarea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",e?{x:"center",y:"top"}:{x:"right",y:"top"},t,e?e.inputTextarea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},getIgnoreImpowerIdentity:function(t){for(var e=[],s=function(t,s){var i=s?t.getValue():t.getData(),o=!1;"array"===typeOf(i)&&i.length&&i.each((function(t){t.ignoreEmpower&&(e.push(t.distinguishedName||t.unique||t.id),t.ignoredEmpower=!0,delete t.ignoreEmpower,o=!0)})),o&&t.setData(i)},i=this.modules,o=0;o<i.length;o++){var n=i[o],a=n.json.moduleName;a||(a="string"===typeOf(n.json.type)?n.json.type.toLowerCase():""),"org"===a&&s(n)}if(t&&t.length>0)for(o=0;o<t.length;o++)s(t[o],!0);return e},submitWork:function(t,e,s,i,o,n,a,r,c){if(!this.businessData.control.allowProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),this.app.content.unmask(),o&&o.node&&o.node.unmask(),!1;if(!this.formValidation(t,e,s))return this.app.content.unmask(),i&&i(),!1;if(!this.validation(t,e,o,s))return o&&o.node&&o.node.unmask(),!1;if(!e){var l=this.businessData.task.routeNameList.indexOf(t);this.businessData.task.routeOpinionList[l]&&(e=this.businessData.task.routeOpinionList[l])}this.fireEvent("beforeProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcess");var p=this.getIgnoreImpowerIdentity(r),h=this;MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),c&&c(),this.fireEvent("beforeSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(o){this.businessData.task.routeName=t,this.businessData.task.opinion=e||"";var n=[];if(s&&s.length&&s.each(function(t){var e=new FormData;e.append("file",t),e.append("site","$mediaOpinion"),this.workAction.uploadAttachment(this.businessData.work.id,e,t,function(t){n.push(t.data.id)}.bind(this),null,!1)}.bind(this)),n.length&&(this.businessData.task.mediaOpinion=n.join(",")),a&&a.length){var r=[];a.each(function(t){"object"===typeOf(t)?r.push(t.distinguishedName||t.unique||t.id):r.push(t)}.bind(this)),this.businessData.task.appendTaskIdentityList=r}this.businessData.task.ignoreEmpowerIdentityList=p,this.fireEvent("afterSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave"),this.workAction.processTask(function(t){if(i&&i(t),this.taskList=t.data,this.fireEvent("afterProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterProcess"),this.addMessage(t.data,!0),this.app.taskObject&&this.app.taskObject.destroy(),this.closeImmediatelyOnProcess)this.app.close();else if("function"===typeOf(this.showCustomSubmitedDialog))this.showCustomSubmitedDialog(t.data);else if(layout.mobile)h.finishOnMobile();else if(this.app.inBrowser)if(this.mask&&this.mask.hide(),!1!==this.json.isPrompt)this.showSubmitedDialog(t.data);else if("redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var e=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(e).go()}else this.app.close();else this.app.close()}.bind(this),null,this.businessData.task.id,this.businessData.task)}.bind(this),null,!0,n,!0)}.bind(this))},showSubmitedDialog:function(t){var e=this.getMessageContent(t,this.json.submitedDlgStyle?this.json.submitedDlgStyle.maxTitleLength:60),s=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden",width:"270px"}}).inject(this.app.content);s.set("html",e);var i=new Element("div",{styles:{"margin-top":"5px"}}).inject(s),o={content:s,isTitle:!1,width:350,height:180,buttonList:[{text:this.app.lp.closePage,action:function(){if(r.close(),"redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else this.app.close()}.bind(this)}]};this.json.submitedDlgStyle&&(o=Object.merge(o,this.json.submitedDlgStyle),this.json.submitedDlgStyle.contentStyle&&(s.setStyles(this.json.submitedDlgStyle.contentStyle),delete o.contentStyle));var n=this.app.content.getSize();switch(o.promptPosition||this.json.promptPosition||"righttop"){case"lefttop":o.top=10,o.left=10,o.fromTop=10,o.fromLeft=10;break;case"righttop":o.top=10,o.left=n.x-o.width-10,o.fromTop=10,o.fromLeft=n.x-10;break;case"leftbottom":o.top=n.y-o.height-10,o.left=10,o.fromTop=n.y-10,o.fromLeft=10;break;case"rightbottom":o.top=n.y-o.height-10,o.left=n.x-o.width-10,o.fromTop=n.y-10,o.fromLeft=n.x-10;break;default:delete o.top,delete o.left,delete o.fromTop,delete o.fromLeft}var a=this;o.onPostLoad=function(){this.node.setStyle("display","block");var t=s.getSize();if(this.content.setStyles({height:t.y}),this.setContentSize(),0!=(o.promptCloseTime||a.json.promptCloseTime)){var e=o.promptCloseTime||a.json.promptCloseTime||2;if(e=1e3*e.toInt(),o.isCountDown){i.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3;var n=function(){if(e>0)i.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3,window.setTimeout(n,1e3);else if(r.close(),"redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()};window.setTimeout(n,1e3)}else window.setTimeout((function(){if("redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()}),e)}};var r=o2.DL.open(o)},startDraftProcess:function(){return this.formCustomValidation("","")&&this.formValidation("","")?void this.saveFormData(function(){this.workAction.startDraft(this.businessData.work.id,function(t){if(this.app.options.workId=t.data[0].work,layout.mobile||!layout.desktop.message)layout.notice&&layout.notice(MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject));else if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.processStarted,content:"<div>"+MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject)+"”</div>"};layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}layout.app&&layout.app.inBrowser&&(layout.app&&(layout.app.$openWithSelf=!0),layout.desktop.openApplication(null,"process.Work",{workId:this.app.options.workId,action:"processTask"})),this.app.options.action="processTask",this.app.reload()}.bind(this))}.bind(this),null,!1,null,!1,!0):(this.app.content.unmask(),!1)},getCurrentTaskData:function(t){return!t.currentTaskIndex&&0!==t.currentTaskIndex||-1==t.currentTaskIndex?null:(this.app.options.taskId=this.businessData.taskList[t.currentTaskIndex].id,this.businessData.taskList[t.currentTaskIndex])},processWork:function(){this.businessData.work.startTime?"select"===this.json.submitFormType||"script"===this.json.submitFormType?this.processWork_custom():"Mobile"==this.json.mode?setTimeout(function(){this.processWork_mobile()}.bind(this),100):this.processWork_pc():this.startDraftProcess()},processWork_custom:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;if(this.submitFormModule)this.submitFormModule.show();else{MWF.APPSubmitform||MWF.xDesktop.requireApp("process.Xform","Subform",null,!1);var t=new Element("div").inject(layout.mobile?$(document.body):this.app.content);this.submitFormModule=new MWF.APPSubmitform(t,this.json,this),this.submitFormModule.addEvent("afterModulesLoad",function(){this.submitFormModule.show()}.bind(this)),this.submitFormModule.load()}},processWork_pc:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var t=function(t){if(this&&this.node){this.node.setStyle("display","block");var s=e.getSize();this.content.setStyles({height:s.y,width:s.x});this.setContentSize();t||this.reCenter()}},e=new Element("div",{styles:this.app.css.processNode_Area}).inject(this.node);this.setProcessNode(e,"process",function(s){this.processDlg=o2.DL.open({title:this.app.lp.process,style:this.json.dialogStyle||"user",isResize:!1,content:e,maskNode:this.app.content,positionHeight:800,maxHeight:800,maxHeightPercent:"98%",minTop:5,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.processor&&this.processor.okButton.click()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){this.processDlg.close(),this.processor&&this.processor.destroy()}.bind(this)}],onPostLoad:function(){s.options.mediaNode=this.content,t.call(this)}})}.bind(this),function(){this.processDlg&&t.call(this.processDlg,!0)}.bind(this))},processWork_mobile:function(){this.app.inBrowser&&this.app.content.setStyle("height",document.body.getSize().y),this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork");var t=this.app.content.getPosition(this.app.content.getOffsetParent());if("Mobile"!=this.json.mode&&this.app.content.mask({destroyOnHide:!0,style:this.app.css.maskNode,useIframeShim:!0,iframeShimOptions:{browsers:!0},onShow:function(){this.shim.shim.setStyles({opacity:0,top:t.y+"px",left:t.x+"px"})}}),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var e=this.createProcessNode();this.setProcessNode(e),this.showProcessNode(e),e.setStyle("overflow","auto")},createProcessNode:function(){var t=this.app.css.processNode_from,e=this.app.css.processNode;if(layout.mobile&&(t=this.app.css.processNodeMobile_from,e=this.app.css.processNodeMobile,t.width="100%",e.width="100%",t.height="100%",e.height="100%"),"Mobile"==this.json.mode)var s=new Element("div",{styles:t}).inject(document.body);else s=new Element("div",{styles:t}).inject(this.app.content);return s.position({relativeTo:this.app.content,position:"topcenter",edge:"topcenter"}),s},getOpinion:function(){var t="",e=[];return Object.each(this.forms,function(s,i){"Opinion"===s.json.type&&this.businessData.data[i]&&(t+=" "+s._getBusinessSectionDataByPerson()),s.handwritingFile&&s.handwritingFile[layout.session.user.distinguishedName]&&e.push(s.handwritingFile[layout.session.user.distinguishedName]),s.soundFile&&s.soundFile[layout.session.user.distinguishedName]&&e.push(s.soundFile[layout.session.user.distinguishedName]),s.videoFile&&s.videoFile[layout.session.user.distinguishedName]&&e.push(s.videoFile[layout.session.user.distinguishedName])}.bind(this)),{opinion:t.trim(),medias:e}},setProcessNode:function(t,e,s,i){var o=this;MWF.xDesktop.requireApp("process.Work","Processor",function(){var n,a=this.getOpinion(),r=a.medias;layout.mobile&&(n=new Element("div").inject(t)),this.processor=new MWF.xApplication.process.Work.Processor(n||t,this.businessData.task,{style:layout.mobile?"mobile":e||"default",opinion:a.opinion,tabletWidth:this.json.tabletWidth||0,tabletHeight:this.json.tabletHeight||0,onPostLoad:function(){s&&s(this)},onResize:function(){i&&i()},onCancel:function(){t.destroy(),o.app.content.unmask()},onSubmit:function(e,s,i,n,a,c){if(i=i&&i.length?i.concat(r):r,this.toWordSubmitList&&this.toWordSubmitList.length){var l=[];this.toWordSubmitList.each((function(t){t.docToWord&&l.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(l).then(function(){o.submitWork(e,s,i,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,c)}.bind(this))}else o.submitWork(e,s,i,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,c)}},this)}.bind(this))},showProcessNode:function(t){if(layout.mobile)t.setStyles(this.app.css.processNodeMobile);else{var e=this.app.content.getSize(),s=t.getSize(),i=e.y/2-s.y/2-20,o=e.x/2-s.x/2;i<0&&(i=0),this.app.css.processNode.top=i+"px",this.app.css.processNode.left=o+"px",new Fx.Morph(t,{duration:300,transition:Fx.Transitions.Expo.easeOut}).start(this.app.css.processNode)}},confirm:function(t,e,s,i,o,n,a,r,c,l,p){MWF.require("MWF.xDesktop.Dialog",function(){var c,h=this.container.getSize(),d=0,u=0;"element"===typeOf(e)?(d=(c=e.getPosition(this.app.content)).x,u=c.y):("firefox"==Browser.name?(d=parseFloat(e.event.clientX||e.event.x),u=parseFloat(e.event.clientY||e.event.y)):(d=parseFloat(e.event.x),u=parseFloat(e.event.y)),e.target&&(d=(c=e.target.getPosition(this.app.content)).x,u=c.y));d+parseFloat(o)>h.x&&(d-=parseFloat(o)),d<0&&(d=10),u+parseFloat(n)>h.y&&(u-=parseFloat(n)),u<0&&(u=10),d<0&&(d=20),layout.mobile||(d-=20);var f=new MWF.xDesktop.Dialog({title:s,style:p||"o2",top:u,left:d,fromTop:e.event.y,fromLeft:"firefox"===Browser.name?e.event.clientX-20:e.event.x-20,width:o,height:n,text:i,container:this.app.content,maskNode:l||this.app.content,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:a},{type:"cancel",text:MWF.LP.process.button.cancel,action:r}]});switch(t.toLowerCase()){case"success":this.json.confirmIcon&&this.json.confirmIcon.success?f.content.setStyle("background-image","url("+this.json.confirmIcon.success+")"):f.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"error":this.json.confirmIcon&&this.json.confirmIcon.error?f.content.setStyle("background-image","url("+this.json.confirmIcon.error+")"):f.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"info":this.json.confirmIcon&&this.json.confirmIcon.info?f.content.setStyle("background-image","url("+this.json.confirmIcon.info+")"):f.content.setStyle("background-image","url(data:image/png;base64,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)");break;case"warn":this.json.confirmIcon&&this.json.confirmIcon.warn?f.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")"):f.content.setStyle("background-image","url(data:image/png;base64,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)");break;default:this.json.confirmIcon&&this.json.confirmIcon.warn&&f.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")")}f.show()}.bind(this))},alert:function(t,e,s,i,o){this.app.alert(t,"center",e,s,i,o)},notice:function(t,e,s,i,o,n){i||(i={x:"right",y:"top"}),e||(e="ok");var a=s||this.app.window.content,r=o;r||(r={x:10,y:(i.y.toString().toLowerCase(),10)});var c={type:e,position:i,move:!1,target:a,delayClose:"error"===e?1e4:5e3,offset:r,content:t};this.json.noticeStyle&&(c=Object.merge(c,this.json.noticeStyle)),this.json["notice"+e.capitalize()+"Style"]&&(c=Object.merge(c,this.json["notice"+e.capitalize()+"Style"])),n&&"object"===typeOf(n)&&(c=Object.merge(c,n)),new mBox.Notice(c)},addSplit:function(){if(!this.businessData.control.allowAddSplit)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,600,230),e=this,s=new MWF.xDesktop.Dialog({title:this.app.lp.addSplit,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:600,height:230,url:this.app.path+"split.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,i){var o=s.content.getElement("input"),n=s.content.getElements(".o2_addSplit_radio"),a=o.get("value"),r=!0;n[1].checked&&(r=!1),e.doAddSplit(s,a,r)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}],onPostShow:function(){var t=s.content.getElement(".o2_addSplit_selector"),i=s.content.getElement("input");s.content.getElements(".o2_addSplit_radio");t.addEvent("click",function(){var t=i.get("value");MWF.xDesktop.requireApp("Selector","package",function(){new o2.O2Selector(e.app.content,{type:"",count:0,values:t?t.split(o2.splitStr):[],types:["unit","identity","group","role"],onComplete:function(t){var e=[];t.each((function(t){e.push(t.data.distinguishedName)})),i.set("value",e.join(", "))}})}.bind(this))}.bind(this))}});s.show()}.bind(this))},doAddSplit:function(t,e,s){if(!e)return this.app.notice(MWF.xApplication.process.Xform.LP.inputSplitValue,"error",t.node),!1;MWF.require("MWF.widget.Mask",function(){var i=e.split(o2.splitStr);this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeAddSplit"),this.addSplitWork(i,s,function(e){this.fireEvent("afterAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterAddSplit"),this.addAddSplitMessage(e.data),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},addSplitWork:function(t,e,s,i){var o={splitValueList:t,trimExist:e};this.options.readonly?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){s&&s(t)}.bind(this),(function(t,e,s){i&&i(t,e,s)})):this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){s&&s(t)}.bind(this),(function(t,e,s){i&&i(t,e,s)}))}.bind(this),(function(t,e,s){i&&i(t,e,s)}),!0,null,!0)},setRollBackChecked:function(t){t.store("isSelected",!0),t.setStyles(this.css.rollbackItemNode_current),t.getFirst().setStyles(this.css.rollbackItemIconNode_current);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode_current),e.getLast().setStyles(this.css.rollbackItemTimeNode_current),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode_current),e.getLast().setStyles(this.css.rollbackItemTaskNode_current);var s=t.getElements("input");s&&s.set("checked",!0)},setRollBackUnchecked:function(t){t.store("isSelected",!1),t.setStyles(this.css.rollbackItemNode),t.getFirst().setStyles(this.css.rollbackItemIconNode);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode),e.getLast().setStyles(this.css.rollbackItemTimeNode),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode),e.getLast().setStyles(this.css.rollbackItemTaskNode);var s=t.getElements("input");s&&s.set("checked",!1)},getRollbackLogs:function(t){var e=this;o2.Actions.load("x_processplatform_assemble_surface").WorkLogAction.listRollbackWithWorkOrWorkCompleted(this.businessData.work.id,function(s){s.data.each(function(s){if(!s.splitting&&s.connected){var i=new Element("div",{styles:this.css.rollbackItemNode}).inject(t);i.store("log",s);new Element("div",{styles:this.css.rollbackItemIconNode}).inject(i);var o=new Element("div",{styles:this.css.rollbackItemContentNode}).inject(i),n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemActivityNode,text:s.fromActivityName}).inject(n),new Element("div",{styles:this.css.rollbackItemTimeNode,text:s.arrivedTime}).inject(n);n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemTaskTitleNode,text:this.app.lp.taskCompletedPerson+": "}).inject(n);if(s.taskCompletedList.length)s.taskCompletedList.each(function(t){var e=o2.name.cn(t.person)+"("+t.completedTime+")";new Element("input",{value:t.identity,type:"checkbox",styles:this.css.rollbackItemTaskCheckNode}).inject(n).addEvent("click",(function(t){t.stopPropagation()}));new Element("div",{styles:this.css.rollbackItemTaskNode,text:e}).inject(n)}.bind(this));else{var a=this.app.lp.systemFlow;new Element("div",{styles:this.css.rollbackItemTaskNode,text:a}).inject(n)}i.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode)},click:function(){this.retrieve("isSelected")?e.setRollBackUnchecked(this):(t.getChildren().each((function(t){e.setRollBackUnchecked(t)})),e.setRollBackChecked(this))}})}}.bind(this))}.bind(this),null,!1)},rollback:function(){if(!this.businessData.control.allowRollback)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;var t=MWF.xApplication.process.Xform.LP,e=new Element("div",{styles:this.css.rollbackAreaNode}),s='<div style="line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:left;">'+t.selectRollbackActivity+"</div>";s+="<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:right;\"><input class='rollback_flowOption' checked type='checkbox' />"+t.tryToProcess+"</div>",s+='<div style="clear:both; max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',e.set("html",s);var i=e.getLast();this.getRollbackLogs(i),e.inject(this.app.content);var o=o2.DL.open({title:this.app.lp.rollback,style:this.json.dialogStyle||"user",isResize:!1,content:e,width:600,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){this.doRollback(e,s,o)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){o.close()}}]})},doRollback:function(t,e,s){for(var i=t.getLast().getChildren(),o=t.getElement(".rollback_flowOption").checked,n=this,a=0;a<i.length;a++)if(i[a].retrieve("isSelected")){var r=this.app.lp.rollbackConfirmContent,c=i[a].retrieve("log"),l=i[a].getElements("input:checked"),p=[];l.each((function(t){var e=t.get("value");-1==p.indexOf(e)&&p.push(e)})),r=r.replace("{log}",c.fromActivityName+"("+c.arrivedTime+")"),this.app.confirm("infor",e,this.app.lp.rollbackConfirmTitle,r,450,120,(function(){n.doRollbackAction(c.id,o,s,p),s.close(),this.close()}),(function(){this.close()}),null,null,this.json.confirmStyle);break}},doRollbackAction:function(t,e,s,i){MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeRollback"),this.doRollbackActionInvoke(t,e,i,function(t){if(t.data.properties)this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage(t.data);else{var e=t.data.id;this.workAction.listTaskByWork(function(t){this.fireEvent("afterRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage_old(t.data)}.bind(this),null,e)}this.app.inBrowser||this.app.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(t,e,s){var i=s+":"+e;t&&(i=t.responseText),this.app.notice("request json error: "+i,"error"),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},doRollbackActionInvoke:function(t,e,s,i,o){if(this.businessData.work.completedTime){o2.Actions.get("x_processplatform_assemble_surface").rollbackWorkcompleted(this.businessData.work.id,{workLog:t},function(t){i&&i(t)}.bind(this),function(t,e,s){o&&o(t,e,s)}.bind(this))}else{var n={workLog:t,taskCompletedIdentityList:s,processing:!!e};o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Rollback(this.businessData.work.id,n,function(t){i&&i(t)}.bind(this),function(t,e,s){o&&o(t,e,s)}.bind(this))}},inBrowserDkg:function(t){if(this.mask&&this.mask.hide(),this.json.submitedDlgUseNotice)if(MWF.xDesktop.notice("success",{x:"right",y:"top"},t),!1!==this.json.isPrompt){if(0!=this.json.promptCloseTime){a=1e3*(a=this.json.promptCloseTime||2).toInt();var e=this;window.setTimeout((function(){e.app.close()}),a)}}else this.app.close();else{var s=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden"}}).inject(this.app.content);if(s.set("html",t),!1!==this.json.isPrompt){var i={content:s,isTitle:!1,width:350,height:180,buttonList:[{text:MWF.xApplication.process.Xform.LP.ok,action:function(){n.close(),this.app.close()}.bind(this)}]},o=this.app.content.getSize();switch(this.json.promptPosition||"righttop"){case"lefttop":i.top=10,i.left=10,i.fromTop=10,i.fromLeft=10;break;case"righttop":i.top=10,i.left=o.x-360,i.fromTop=10,i.fromLeft=o.x-10;break;case"leftbottom":i.top=o.y-190,i.left=10,i.fromTop=o.y-10,i.fromLeft=10;break;case"rightbottom":i.top=o.y-190,i.left=o.x-360,i.fromTop=o.y-10,i.fromLeft=o.x-10;break;default:delete i.top,delete i.left,delete i.fromTop,delete i.fromLeft}var n=o2.DL.open(i);if(0!=this.json.promptCloseTime){var a;a=1e3*(a=this.json.promptCloseTime||2).toInt();e=this;window.setTimeout((function(){n.close(),e.app.close()}),a)}}else this.app.close()}},addRollbackMessage_old:function(t){var e=[];t.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var s="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t[0].activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";if(layout.desktop.message){var i={subject:MWF.xApplication.process.Xform.LP.workRollback,content:"<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+s};return layout.desktop.message.addTooltip(i),layout.desktop.message.addMessage(i)}this.app.inBrowser&&this.inBrowserDkg("<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+s)},addRollbackMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRollback,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor))},pressWork:function(t){t&&t.setDisable&&t.setDisable(!0),o2.Actions.get("x_processplatform_assemble_surface").press(this.businessData.work.id,function(e){var s=o2.name.cns(e.data.valueList).join(", ");this.app.notice(MWF.xApplication.process.Xform.LP.sendTaskNotice.replace("{users}",s),"success"),t&&t.setDisable&&t.setDisable(!1)}.bind(this),(function(t,e,s){if(0!=t.status){var i=s;if(t){var o=JSON.decode(t.responseText);i=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},i)}}))},pauseTask:function(t){return this.businessData.control.allowPause?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").pauseTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.pauseWork,"success"),this.businessData.control.allowResume=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,s){if(0!=t.status){var i=s;if(t){var o=JSON.decode(t.responseText);i=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},i)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},resumeTask:function(t){return this.businessData.control.allowResume?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").resumeTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.resumeWork,"success"),this.businessData.control.allowPause=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,s){if(0!=t.status){var i=s;if(t){var o=JSON.decode(t.responseText);i=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},i)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},downloadAll:function(){var t="";o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.uploadWorkInfo(this.businessData.work.id,"pdf",{workHtml:this.app.content.get("html"),pageWidth:1e3},function(e){t=e.data.id}.bind(this),null,!1),t=t.replace("#","%23");var e="/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/work/"+this.businessData.work.id+"/site/(0)/stream";e=o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface")+e),window.open(o2.filterUrl(e+"?fileName=&flag="+t))},resetWork:function(){if(!this.businessData.control.allowReset)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this,s=new MWF.xDesktop.Dialog({title:this.app.lp.reset,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"reset.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doResetWork(s)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}],onPostShow:function(){$("resetWork_selPeopleButton").addEvent("click",function(){e.selectPeople(this)}.bind(this))}});s.show()}.bind(this))},selectPeople:function(t){var e=this.businessData.activity.resetRange||"department",s=this.businessData.activity.resetCount||0;switch(e){case"unit":this.selectPeopleUnit(t,this.businessData.task.unit,s);break;case"topUnit":MWF.require("MWF.xScript.Actions.UnitActions",function(){orgActions=new MWF.xScript.Actions.UnitActions;var e={unitList:[this.businessData.task.unit]};orgActions.listUnitSupNested(e,function(e){v=e.data[0],this.selectPeopleUnit(t,v,s)}.bind(this))}.bind(this));break;case"script":o2.Actions.load("x_processplatform_assemble_surface").ProcessAction.getActivity(this.businessData.work.activity,"manual",function(e){if(e.data.activity.resetRangeScriptText){var i=this.Macro.exec(e.data.activity.resetRangeScriptText,this);this.selectPeopleUnit(t,"",s,i)}}.bind(this));break;default:this.selectPeopleAll(t,s)}},selectPeopleUnit:function(t,e,s,i){var o=t.identityList||[],n=$("resetWork_selPeopleArea"),a={values:o,type:"identity",count:s,units:e?[e]:[],title:this.app.lp.reset,onComplete:function(e){n.empty();var s=[];e.each(function(t){new MWF.widget.O2Identity(t.data,n,{style:"reset"}),s.push(t.data.distinguishedName)}.bind(this)),t.identityList=s}.bind(this)};i&&(a.noUnit=!0,a.include="array"===typeOf(i)?i:[i]),MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,a)}.bind(this))},selectPeopleAll:function(t,e){var s=t.identityList||[],i=$("resetWork_selPeopleArea"),o={values:s,type:"identity",count:e,title:this.app.lp.reset,onComplete:function(e){i.empty();var s=[];e.each(function(t){new MWF.widget.O2Identity(t.data,i,{style:"reset"}),s.push(t.data.distinguishedName)}.bind(this)),t.identityList=s}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,o)}.bind(this))},doResetWork:function(t){var e=t.identityList||[];if(!e.length)return this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople,"error",t.node),!1;var s=$("resetWork_opinion").get("value"),i=t.content.getElement(".resetWork_keepOption").checked,o=[];e.each((function(t){o.push(MWF.name.cn(t))})),s||(s=MWF.xApplication.process.Xform.LP.resetTo+": "+o.join(", ")),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeReset"),this.resetWorkToPeson(e,s,i,function(e){this.fireEvent("afterReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReset"),this.addResetMessage(e.data),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},resetWorkToPeson:function(t,e,s,i,o){var n={opinion:e,routeName:MWF.xApplication.process.Xform.LP.reset,identityList:t,keep:!!s};this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(function(t){i&&i(t)}.bind(this),(function(t,e,s){o&&o(t,e,s)}),this.businessData.task.id,n)}.bind(this),(function(t,e,s){o&&o(t,e,s)}),!0,null,!0)},addAddSplitMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.addSplitWork,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor))},addResetMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReset,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor))},retractWork:function(t,e){var s=this;if("Mobile"==this.json.mode){var i=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+i.x+" , y:"+i.y);var o=i.x,n={event:{x:o=i.x<20?20:i.x,y:i.y-200,clientX:o,clientY:i.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){s.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){s.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),s.mask.loadNode(s.app.content),s.fireEvent("beforeRetract"),s.app&&s.app.fireEvent&&s.app.fireEvent("beforeRetract"),s.doRetractWork(function(){s.fireEvent("afterRetract"),s.app&&s.app.fireEvent&&s.app.fireEvent("afterRetract"),s.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),s.app.content.unmask(),s.mask&&(s.mask.hide(),s.mask=null),s.finishOnMobile()}.bind(this),(function(t,e,i){s.app.content.unmask();var o=i+":"+e;t&&(o=t.responseText),s.app.notice("request json error: "+o,"error"),s.mask&&(s.mask.hide(),s.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{n={event:{x:(i=MWF.getCenterPosition(this.app.content,300,150)).x,y:i.y-200,clientX:i.x,clientY:i.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){s.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){s.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),s.mask.loadNode(s.app.content),s.fireEvent("beforeRetract"),s.app&&s.app.fireEvent&&s.app.fireEvent("beforeRetract"),s.doRetractWork(function(t){s.fireEvent("afterRetract"),s.app&&s.app.fireEvent&&s.app.fireEvent("afterRetract"),s.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),s.app.content.unmask(),s.mask&&(s.mask.hide(),s.mask=null),s.app.reload(),this.close()}.bind(this),(function(t,e,i){s.app.content.unmask();var o=i+":"+e;t&&(o=t.responseText),s.app.notice("request json error: "+o,"error"),s.mask&&(s.mask.hide(),s.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}},doRetractWork:function(t,e){this.businessData.control.allowRetract?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Retract(this.businessData.work.id,null,function(e){t&&t(e)}.bind(this),(function(t,s,i){e&&e(t,s,i)})):e&&e(null,"Permission Denied","")},addRetractMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRetract,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor))},rerouteWork:function(t,e){if(!this.businessData.control.allowReroute)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,560,260),e=this,s=new MWF.xDesktop.Dialog({title:this.app.lp.reroute,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:560,height:260,url:this.app.path+"reroute.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,i){e.doRerouteWork(s)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}],onPostShow:function(){var t=$("rerouteWork_selectActivity");e.workAction.getRerouteTo(e.businessData.work.process,function(s){s.data.agentList.each(function(e){new Element("option",{value:e.id+"#agent",text:e.name}).inject(t)}.bind(e)),s.data.cancelList.each(function(e){new Element("option",{value:e.id+"#cancel",text:e.name}).inject(t)}.bind(e)),s.data.choiceList.each(function(e){new Element("option",{value:e.id+"#choice",text:e.name}).inject(t)}.bind(e)),s.data.delayList.each(function(e){new Element("option",{value:e.id+"#delay",text:e.name}).inject(t)}.bind(e)),s.data.embedList.each(function(e){new Element("option",{value:e.id+"#embed",text:e.name}).inject(t)}.bind(e)),s.data.endList.each(function(e){new Element("option",{value:e.id+"#end",text:e.name}).inject(t)}.bind(e)),s.data.invokeList.each(function(e){new Element("option",{value:e.id+"#invoke",text:e.name}).inject(t)}.bind(e)),s.data.manualList.each(function(e){new Element("option",{value:e.id+"#manual",text:e.name}).inject(t)}.bind(e)),s.data.mergeList.each(function(e){new Element("option",{value:e.id+"#merge",text:e.name}).inject(t)}.bind(e)),s.data.messageList.each(function(e){new Element("option",{value:e.id+"#message",text:e.name}).inject(t)}.bind(e)),s.data.parallelList.each(function(e){new Element("option",{value:e.id+"#parallel",text:e.name}).inject(t)}.bind(e)),s.data.serviceList.each(function(e){new Element("option",{value:e.id+"#service",text:e.name}).inject(t)}.bind(e)),s.data.splitList.each(function(e){new Element("option",{value:e.id+"#split",text:e.name}).inject(t)}.bind(e))}.bind(e)),this.content.getElement(".rerouteWork_selPeopleButton").addEvent("click",function(){e.selectReroutePeople(this)}.bind(this))}});s.show()}.bind(this))},selectReroutePeople:function(t){var e=t.identityList||[],s=t.content.getElement(".rerouteWork_selPeopleArea"),i={values:e,type:"identity",count:0,title:this.app.lp.reroute,onComplete:function(e){s.empty();var i=[];e.each(function(t){new MWF.widget.O2Identity(t.data,s,{style:"reset"}),i.push(t.data.distinguishedName)}.bind(this)),t.identityList=i}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,i)}.bind(this))},doRerouteWork:function(t){var e=$("rerouteWork_opinion").get("value"),s=$("rerouteWork_selectActivity"),i=s.options[s.selectedIndex].get("value"),o=s.options[s.selectedIndex].get("text"),n=i.split("#");i=n[0];var a=n[1],r=[];(t.identityList||[]).each((function(t){r.push(t)})),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRetract"),this.rerouteWorkToActivity(i,a,e,r,function(e){this.fireEvent("afterReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReroute"),this.addRerouteMessage(e.data),this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk+": "+o,"success"),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},rerouteWorkToActivity:function(t,e,s,i,o,n){var a={activity:t,activityType:e,mergeWork:!1,manualForceTaskIdentityList:i};this.businessData.task?this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,s){n&&n(t,e,s)}))}.bind(this),(function(t,e,s){n&&n(t,e,s)}),!0,null,!0):o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,s){n&&n(t,e,s)}))},addRerouteMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReroute,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor))},deleteDraftWork:function(){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var s=e.x,i={event:{x:s=e.x<20?20:e.x,y:e.y-200,clientX:s,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{i={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}},deleteWork:function(){if(this.businessData.work.startTime){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var s=e.x,i={event:{x:s=e.x<20?20:e.x,y:e.y-200,clientX:s,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}else{i={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",i,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,s,i){var o=i+":"+s;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}}else this.deleteDraftWork()},doDeleteDraftWork:function(t,e){this.workAction.deleteDraftWork(function(e){t&&t(e)}.bind(this),(function(t,s,i){e&&e(t,s,i)}),this.businessData.work.id)},doDeleteWork:function(t,e){this.businessData.work.startTime?this.businessData.control.allowDelete?this.workAction.abandoned(function(e){t&&t(e)}.bind(this),(function(t,s,i){e&&e(t,s,i)}),this.businessData.work.id):e&&e(null,"Permission Denied",""):this.doDeleteDraftWork(t,e)},printWork:function(t,e){var s=t||this.businessData.work?this.businessData.work.application:this.businessData.workCompleted.application;if((e=e)||(e=this.json.id,this.json.printForm&&(e=this.json.printForm)),this.businessData.workCompleted){s=t||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+s+"&form="+e))}else{s=t||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+s+"&form="+e))}},readedWork:function(t){if(!this.businessData.control.allowReadProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this.businessData.work.title,s=MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",e);MWF.xApplication.process.Xform.LP.form.setReadedConfirmInfo=s;var i=new MWF.xDesktop.Dialog({title:MWF.xApplication.process.Xform.LP.setReadedConfirmTitle,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"readed.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doReadedWork(i)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}]});i.show()}.bind(this))},doReadedWork:function(t){for(var e=t.content.getElement(".readedWork_opinion").get("value"),s=null,i=0;i<this.businessData.readList.length;i++)if(this.businessData.readList[i].person===layout.session.user.distinguishedName){s=this.businessData.readList[i];break}var o=this;s?MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),s.opinion=e,this.app.action.setReaded((function(){o.mask&&(o.mask.hide(),o.mask=null),o.fireEvent("afterReaded"),o.app.reload(),layout.mobile?o.finishOnMobile():t.close()}),null,s.id,s)}.bind(this)):(o.app.reload(),layout.mobile?o.finishOnMobile():t.close())},openWindow:function(t,e){if((t=t)||(t=this.json.id),this.businessData.workCompleted){var s=e||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+s+"&form="+t))}else{s=e||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+s+"&form="+t))}},uploadedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(e){var s=this.all[t];s&&(e.data&&s.attachmentController.addAttachment(e.data),s.attachmentController.checkActions(),s.fireEvent("upload",[e.data]))}.bind(this))},replacedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(s){var i=this.all[t];if(i){for(var o=i.attachmentController,n=null,a=0;a<o.attachments.length;a++)if(o.attachments[a].data.id===e){n=o.attachments[a];break}n.data=s.data,n.reload(),o.checkActions()}}.bind(this))},finishOnMobile:function(){var t=this;this.workAction.checkDraft(this.businessData.work.id,function(e){t.finishOnMobileReal()}.bind(this),(function(){t.finishOnMobileReal()}),!1)},finishOnMobileReal:function(){if(window.o2android&&window.o2android.closeWork)window.o2android.closeWork("");else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.closeWork)window.webkit.messageHandlers.closeWork.postMessage("");else if(window.wx&&"miniprogram"===window.__wxjs_environment)wx.miniProgram.navigateBack({delta:1});else if(window.uni&&window.uni.navigateBack)window.uni.navigateBack();else if("redirect"===this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else{if(window.history.length>1)history.back();else{var e=new URI(window.location.href).getData("redirectlink");e?(history.replaceState(null,"work",e),e.toURI().go()):(window.location=o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"),history.replaceState(null,"work",o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter")),o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go())}}},getModuleType:function(t){if("string"===typeOf(t)&&(t=this.all[t]),t){var e=t.json.moduleName||"";return e||(e="string"===typeOf(t.json.type)?t.json.type.toLowerCase():""),e.toLowerCase()}return""}});var PortalPage="";