MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Calendar=MWF.APPCalendar=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"calendarIcon",options:{moduleEvents:["queryLoad","postLoad","load","complete","clear","change","show","hide"]},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._loadNodeEdit(),this.node.getFirst().set("readonly",!0))},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none")}.bind(this)})},_getValueAg:function(e,t){if(e&&e.isAG)return e.then(function(e){this._getValueAg(e,t)}.bind(this),(function(){}));var n=e?Date.parse(e):"";return t?n||null:n?n.format(this.json.format):""},getValue:function(e){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();if(t&&!e)return t;if(t||(t=this._computeValue()),t.then)return t;var n=t?Date.parse(t):"";return e?n||null:n?n.format(this.json.format):""},getValueStr:function(){var e=this._getBusinessData();return e||(e=this._computeValue()),e},__setValue:function(e){var t;return t="date"===typeOf(e)?e?Date.parse(e).format(this.json.format):"":e,this._setBusinessData(e),this.node.getFirst()&&this.node.getFirst().set("value",t||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,e},clickSelect:function(){var e=this;if(this.calendar){var t={};t.baseDate=this.getBaseDate(),this.calendar.setOptions(t),this.node.getFirst().focus()}else MWF.require("MWF.widget.Calendar",function(){var t="day";"month"===this.json.selectType&&(t="month"),"year"===this.json.selectType&&(t="year");var n={style:layout.mobile?"xform_mobile":"xform",secondEnable:this.json.isSelectSecond,isTime:"datetime"===this.json.selectType||"time"===this.json.selectType,timeOnly:"time"===this.json.selectType,monthOnly:"month"===this.json.selectType,yearOnly:"year"===this.json.selectType,defaultView:t,target:layout.mobile?$(document.body):this.form.app.content,format:this.json.format,onComplate:function(e,t){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("complete")}.bind(this),onChange:function(){this.fireEvent("change")}.bind(this),onClear:function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("clear"),this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this),onShow:function(){if(e.descriptionNode&&e.descriptionNode.setStyle("display","none"),layout.mobile)this.container.position({relativeTo:$(document.body),position:"leftCenter",edge:"leftCenter"});else for(var t=e.node.getParent();t;){var n=t.getStyle("overflow"),i=t.getStyle("overflow-y");"auto"===n||"scroll"===n||"auto"===i||"scroll"===i?(e.scrollFun=function(e){this.container.position&&this.container.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft",allowNegative:!0})}.bind(this),e.scrollParentNode=t,t.addEvent("scroll",e.scrollFun),t=null):t=t.getParent()}e.fireEvent("show")},onHide:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block"),e.scrollParentNode&&e.scrollFun&&e.scrollParentNode.removeEvent("scroll",e.scrollFun),e.fireEvent("hide")}.bind(this)};n.baseDate=this.getBaseDate(),this.calendar=new MWF.widget.Calendar(this.node.getFirst(),n),this.form.json&&this.form.json.canlendarStyle&&"null"!==typeOf(this.form.json.canlendarStyle.zIndex)&&"undefined"!==typeOf(this.form.json.canlendarStyle.zIndex)&&this.calendar.container.setStyle("z-index",this.form.json.canlendarStyle.zIndex),this.calendar.show()}.bind(this))},getBaseDate:function(){var e,t=this.getValue(!0);if(t&&t.getTime()>1e4)e=t;else{var n=Date.parse(this.unformatDate(this.getValueStr()));e=n&&n.getTime()>1e4?n:new Date}return e},unformatDate:function(e){for(var t=this.json.format,n=["%Y","%m","%d","%H","%M","%S","%z","%Z"],i=[4,2,2,2,2,2,5,3],s=[t.indexOf("%Y"),t.indexOf("%m"),t.indexOf("%d"),t.indexOf("%H"),t.indexOf("%M"),t.indexOf("%S"),t.indexOf("%z"),t.indexOf("%Z")],o=[null,null,null,null,null,null,null,null],a=0;a<n.length;a++)if(-1!==s[a]){var l=0,r=0;Array.each(s,(function(e,t){-1!==e&&s[a]>e&&(l+=i[t],r+=n[t].length)})),o[a]=e.substr(s[a]-r+l,i[a])}var d=new Date;for(a=0;a<o.length;a++)if(!o[a])switch(n[a]){case"%Y":case"%m":case"%d":o[a]=d.format(n[a]);break;case"%H":case"%M":case"%S":o[a]="00"}return o[0]+"-"+o[1]+"-"+o[2]+" "+o[3]+":"+o[4]+":"+o[5]}});