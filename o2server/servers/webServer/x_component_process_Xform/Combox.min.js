MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Combox=MWF.APPCombox=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"selectIcon",options:{moduleEvents:["load","queryLoad","postLoad","commitInput","change"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_loadNodeEdit:function(){this.node.empty(),MWF.require("MWF.widget.Combox",function(){this.combox=select=new MWF.widget.Combox({onlySelect:"y"===this.json.onlySelect,count:this.json.count.toInt()||0,splitStr:this.json.splitStr||",\\s*|;\\s*|，\\s*|；\\s*",splitShow:this.json.splitShow||", ",list:this.getOptions(),onCommitInput:function(t){this.fireEvent("commitInput")}.bind(this),onChange:function(){this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions()})}.bind(this),!1),select.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_searchOptions:function(){return"dynamic"===this.json.itemType?function(t,e){var i={value:t,callback:e};this.form.Macro.fire(this.json.itemDynamic?this.json.itemDynamic.code:"",this,i)}.bind(this):null},getOptions:function(){var t=[];if("values"===this.json.itemType?t=this.json.itemValues:"script"===this.json.itemType&&(t=this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)),t.length){var e=[];return t.each(function(t){if("object"===typeOf(t))e.push(t);else{t=t.toString(),arr=t.split("|");var i={text:"",keyword:"",value:""};switch(arr.length){case 0:break;case 1:i.text=arr[0],i.keyword=arr[0],i.value=arr[0];break;case 2:i.text=arr[0],i.keyword=arr[0],i.value=arr[1];break;case 3:i.text=arr[0],i.keyword=arr[1],i.value=arr[2];break;default:i.text=arr[0],i.keyword=arr[1],i.value=arr[2]}e.push(i)}}.bind(this)),e}return[]},setData:function(t){this._setBusinessData(t),this._setValue(t)},_setValue:function(t){if(t||(t=[]),1!=t.length||t[0]||(t=[]),"array"!==typeOf(t)&&(t=[t]),this.combox)this.combox.clear(),comboxValues=[],t.each(function(t){"object"===typeOf(t)?comboxValues.push({text:t.text||t.title||t.subject||t.name,value:t}):comboxValues.push(t.toString())}.bind(this)),this.combox.addNewValues(comboxValues);else{var e=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node);t.each(function(i,s){var o="";o="object"===typeOf(i)?i.text||i.title||i.subject||i.name:i.toString(),s<t.length-1&&(o+=this.json.splitShow),new Element("div",{styles:{float:"left","margin-right":"5px"},text:o}).inject(e)}.bind(this))}},resetOption:function(){if(this.combox){var t=this.getOptions();this.combox.setOptions({list:t})}},addOption:function(t,e){if(this.combox){var i=this.getOptions();i.push({text:t,value:e}),this.combox.setOptions({list:i})}},isEmpty:function(){var t=this.getData();return"array"===typeOf(t)?0===t.length:!t},getInputData:function(){return this.combox?this.combox.getData():this._getBusinessData()},getTextData:function(){var t=this.getData();return{value:t,text:t}},resetData:function(){this.setData(this.getValue())}});