MWF.xApplication.process.Xform.widget=MWF.xApplication.process.Xform.widget||{},MWF.xApplication.process.Xform.widget.DocumentHistory=new Class({Implements:[Options,Events],options:{speed:1,fxTime:500,inforTime:2e3},initialize:function(t,i){this.setOptions(i),this.documentEditor=t,this.css=this.documentEditor.css},is_iPad:function(){return"ipad"==navigator.userAgent.toLowerCase().match(/iPad/i)},load:function(t){this.getHistroyDocumentList(function(){this.historyDocumentList&&this.historyDocumentList.length?this.getHistoryDataList(function(){this.createHistoryToolbar(),layout.mobile&&!this.is_iPad()||this.createHistoryListNode(),this.documentEditor.options.pageShow="single",this.documentEditor.resetData(),this.beginDiffHistory(),this.loadHistoryToolbar(),layout.mobile||this.loadHistoryList(),t&&t()}.bind(this)):this.documentEditor.form.app.notice(MWF.xApplication.process.Xform.LP.documentHistory.nodiff,"info",this.documentEditor.node)}.bind(this))},createHistoryToolbar:function(){this.documentEditor.documentToolbarNode=this.documentEditor.toolbarNode,this.toolbarNode=this.documentEditor.toolbarNode.clone(!0),this.toolbarNode.inject(this.documentEditor.toolbarNode,"after"),this.documentEditor.toolbarNode=this.toolbarNode,this.documentEditor.documentToolbarNode.hide(),this.toolbarNode.empty(),this.documentEditor.sidebarNode&&this.documentEditor.sidebarNode.hide()},loadHistoryToolbar:function(){var t="";this.historyDataList&&this.historyDataList.length&&"6"!=this.historyDataList[0].json.v&&(t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/play.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.play+'" MWFButtonAction="play"></span>',t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/pause.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.pause+'" MWFButtonAction="pause"></span>',t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/stop.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.stop+'" MWFButtonAction="stopPlay"></span>',t+='<span MWFnodetype="MWFToolBarSeparator"></span>',t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/prev.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.prev+'" MWFButtonAction="prev"></span>',t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/next.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.next+'" MWFButtonAction="next"></span>',t+='<span MWFnodetype="MWFToolBarSeparator"></span>'),t+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/documenteditoricon/exit.png" title="'+MWF.xApplication.process.Xform.LP.documentHistory.exit+'" MWFButtonAction="exit" MWFButtonText="'+MWF.xApplication.process.Xform.LP.documentHistory.exit+'"></span>',t+='<span MWFnodetype="MWFToolBarSeparator"></span>';var i=MWF.xApplication.process.Xform.LP.documentHistory.diff_patch_count;t+="<span style='float: left; line-height: 24px; color: #666666; margin-left: 10px'>"+(i=i.replace(/{history}/,this.historyDataList.length).replace(/{diff}/,this.diffCount))+"</span>",this.toolbarNode.set("html",t),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:"documentEdit"},this),this.toolbar.load(),this.checkToolbar()}.bind(this)),this.toolbarNode.setStyle("overflow","visible"),this.historyListAreaNode&&this.historyListAreaNode.inject(this.toolbarNode)},checkToolbar:function(){this.historyDataList&&this.historyDataList.length&&"6"!=this.historyDataList[0].json.v&&this.toolbar&&(this.playing?(this.stop?(this.toolbar.childrenButton[0].enable(),this.toolbar.childrenButton[1].disable(),0==this.patchIndex&&0==this.diffIndex?(this.toolbar.childrenButton[3].disable(),this.diffPatch.length&&this.toolbar.childrenButton[4].enable()):this.patchIndex<this.diffPatch.length-1||this.patchIndex<this.diffPatch.length&&this.diffIndex<this.diffPatch[this.patchIndex].patch.diffs.length?(this.toolbar.childrenButton[3].enable(),this.toolbar.childrenButton[4].enable()):(this.diffPatch.length&&this.toolbar.childrenButton[3].enable(),this.toolbar.childrenButton[4].disable())):(this.toolbar.childrenButton[0].disable(),this.toolbar.childrenButton[1].enable(),this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable()),this.toolbar.childrenButton[2].enable()):(this.toolbar.childrenButton[0].enable(),this.toolbar.childrenButton[1].disable(),this.toolbar.childrenButton[2].disable(),0==this.patchIndex&&0==this.diffIndex?(this.toolbar.childrenButton[3].disable(),this.diffPatch.length&&this.toolbar.childrenButton[4].enable()):this.patchIndex<this.diffPatch.length-1||this.patchIndex<this.diffPatch.length&&this.diffIndex<this.diffPatch[this.patchIndex].patch.diffs.length?(this.toolbar.childrenButton[3].enable(),this.toolbar.childrenButton[4].enable()):(this.diffPatch.length&&this.toolbar.childrenButton[3].enable(),this.toolbar.childrenButton[4].disable())))},createHistoryListNode:function(){this.historyListAreaNode=new Element("div",{styles:this.css.historyListAreaNode}).inject(this.documentEditor.contentNode,"before"),this.documentEditor.contentNode.setStyle("width","auto"),this.documentEditor.zoom(1),this.documentEditor._checkScale();var t=this.documentEditor.form.app.content.getSize(),i=this.documentEditor.toolbarNode.getSize(),o=t.y-i.y;this.historyListAreaNode.setStyle("height",o+"px"),this.historyListTitleAreaNode=new Element("div",{styles:this.css.historyListTitleAreaNode}).inject(this.historyListAreaNode),this.historyListContentAreaNode=new Element("div",{styles:this.css.historyListContentAreaNode}).inject(this.historyListAreaNode),o=o-this.historyListContentAreaNode.getEdgeHeight()-this.historyListTitleAreaNode.getComputedSize().totalHeight,this.historyListContentAreaNode.setStyle("height",o+"px"),this.historyListTitleNode=new Element("div",{styles:this.css.historyListTitleNode}).inject(this.historyListTitleAreaNode),this.historyListTitleInsertNode=new Element("div",{styles:this.css.historyListTitleInsertNode}).inject(this.historyListTitleAreaNode),this.historyListTitleDeleteNode=new Element("div",{styles:this.css.historyListTitleDeleteNode}).inject(this.historyListTitleAreaNode)},loadHistoryList:function(){var t=MWF.xApplication.process.Xform.LP.documentHistory.diff_patch_count;t=t.replace(/{history}/,this.historyDataList.length).replace(/{diff}/,this.diffCount);var i=MWF.xApplication.process.Xform.LP.documentHistory.insertTimes,o=MWF.xApplication.process.Xform.LP.documentHistory.deleteTimes;i=i.replace(/{times}/,this.diffInsertCount),o=o.replace(/{times}/,this.diffDeleteCount),this.historyListTitleNode.set("text",t),this.historyListTitleInsertNode.set("text",i),this.historyListTitleDeleteNode.set("text",o),this.historyDataList.each(function(t){this.createHistoryListItem(t)}.bind(this))},createHistoryListItem:function(t){this.documentHistoryItems||(this.documentHistoryItems=[]),this.documentHistoryItems.push(new MWF.xApplication.process.Xform.widget.DocumentHistory.Item(this,t))},getHistoryDataList:function(t){for(var i=[],o=0,e=0,s=function(){o>=this.historyDocumentList.length&&this.getHistoryDataListFinish(i,t)}.bind(this),n=this.historyDocumentList.length-1;n>=0;n--)i.push(null),this.getHistroyDocumentData(this.historyDocumentList[n].id,function(){o++,s()}.bind(this),e,i),e++},getHistoryDataListFinish:function(t,i){this.historyDataList=t,this.originaHistoryData=t[0].json.data||null,this.documentEditor.allowEdit?o2.load("../o2_lib/diff-match-patch/diff_match_patch_uncompressed.js",function(){var t=this.documentEditor.form.businessData.originalData[this.documentEditor.json.id],o=this.documentEditor.data.filetext,e=t.filetext;if(o!=e){dataTxt=this.documentEditor.getFiletextText(o),earlyDataTxt=this.documentEditor.getFiletextText(e);var s=new diff_match_patch,n=s.diff_main(earlyDataTxt,dataTxt);s.diff_cleanupSemantic(n);var h=s.patch_make(earlyDataTxt,dataTxt,n);if(h.length){var r=s.patch_toText(h),a={data:JSON.stringify({patchs:r,v:"6"}),json:{patchs:r,data:o,current:!0},person:layout.session.user.distinguishedName,activityName:this.documentEditor.form.businessData.activity.name,createTime:(new Date).format("db")};this.historyDataList.push(a)}}i&&i()}.bind(this)):i&&i()},getHistroyDocumentData:function(t,i,o,e){o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.get(t,function(t){var s=JSON.parse(t.data.data);t.data.json=s,e&&(e[o]=t.data),i&&i(t.data)}.bind(this))},getHistroyDocumentList:function(t){var i=this.documentEditor.form.businessData.work.job;o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.listWithJobCategory(i,this.documentEditor.json.id,function(i){this.historyDocumentList=i.data,t&&t()}.bind(this))},beginDiffHistory:function(){this.initAnimation()},initAnimation:function(){this.diffPatch=this.diffHistroy(),this.diffCount=0,this.diffInsertCount=0,this.diffDeleteCount=0,this.diffPatch.each(function(t){t.patch.diffs.each(function(t){0!=t[0]&&this.diffCount++,-1==t[0]&&this.diffDeleteCount++,1==t[0]&&this.diffInsertCount++}.bind(this))}.bind(this)),this.initAnimationStatus()},initData:function(t,i){this.currentHistoryData=t||this.originaHistoryData,this.documentEditor.layout_filetext.set("html",this.currentHistoryData),this.patchIndex=0,this.diffIndex=0,this.documentHistoryItems&&this.documentHistoryItems.length&&this.documentHistoryItems.each((function(t){t.histroyObj&&t.histroyObj.hideCurrent()})),(i||this.originaDiff)&&(i||this.originaDiff).showCurrent()},initAnimationStatus:function(){this.patchIndex=0,this.diffIndex=0,this.currentDiffs=null,this.stop=!0,this.step=!1,this.playing=!1,this.reverse=!1,this.options.fxTime=500,this.options.inforTime=2e3,this.checkToolbar()},doAnimationAuto:function(){this.playing=!0,this.checkToolbar(),this.doPatchAnimation(function(){this.patchIndex=0,this.diffIndex=0,this.playing=!1,this.stop=!0,this.documentEditor.resetData(),this.checkToolbar()}.bind(this))},do:function(){this.nextPlayPrefixFunction?(this.nextPlayPrefixFunction(),this.nextPlayPrefixFunction=null):this.doAnimationAuto()},play:function(){this.playing||(this.initData(),this.initAnimationStatus()),this.reverse=!1,this.stop=!1,this.stopWhile="",this.options.fxTime=500,this.options.inforTime=2e3,this.toolbar.childrenButton[0].disable(),this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable(),this.do()},stopPlay:function(){this.playing&&(this.stop=!0,this.playing=!1,this.nextPlayPrefixFunction&&(this.nextPlayPrefixFunction(),this.nextPlayPrefixFunction=null),this.patchIndex=0,this.diffIndex=0,this.toolbar.childrenButton[1].disable(),this.toolbar.childrenButton[2].disable())},pause:function(){this.playing&&(this.stop=!0,this.toolbar.childrenButton[1].disable(),this.toolbar.childrenButton[2].disable())},next:function(){this.reverse=!1,this.options.fxTime=0,this.options.inforTime=0,this.stop=!0,this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable(),this.playing||this.initData(),this.do()},prev:function(){this.reverse=!0,this.options.fxTime=0,this.options.inforTime=0,this.stop=!0,this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable(),this.playing||this.initData(),this.do()},to:function(t){this.nextPlayPrefixFunction?(this.playing=!1,this.nextPlayPrefixFunction(function(){this.initData(),this.initAnimationStatus(),this.reverse=!1,this.options.fxTime=0,this.options.inforTime=0,this.stop=!1,this.stopWhile=t.id,this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable(),this.doAnimationAuto(t.id)}.bind(this))):(this.initData(),this.initAnimationStatus(),this.reverse=!1,this.options.fxTime=0,this.options.inforTime=0,this.stop=!1,this.stopWhile=t.id,this.toolbar.childrenButton[3].disable(),this.toolbar.childrenButton[4].disable(),this.doAnimationAuto(t.id))},origina:function(t,i){this.nextPlayPrefixFunction?(this.playing=!1,this.nextPlayPrefixFunction(function(){this.initData(t,i),this.initAnimationStatus()}.bind(this)),this.nextPlayPrefixFunction=null):(this.initData(t,i),this.initAnimationStatus())},exit:function(){this.initAnimationStatus(),this.options.fxTime=0,this.options.inforTime=0,this.nextPlayPrefixFunction?(this.nextPlayPrefixFunction(function(){this.documentEditor.toolbarNode=this.documentEditor.documentToolbarNode,this.documentEditor.toolbarNode.show(),this.documentEditor.sidebarNode&&this.documentEditor.sidebarNode.show(),this.documentEditor.resizeToolbar()}.bind(this)),this.nextPlayPrefixFunction=null):(this.documentEditor.toolbarNode=this.documentEditor.documentToolbarNode,this.documentEditor.toolbarNode.show(),this.documentEditor.sidebarNode&&this.documentEditor.sidebarNode.show(),this.documentEditor.resizeToolbar()),this.historyListAreaNode&&this.historyListAreaNode.destroy(),this.documentHistoryItems=[],this.historyListAreaNode=null,this.documentEditor.zoom(1),this.documentEditor._checkScale(),this.documentEditor.resetData(),this.toolbarNode.hide()},active:function(t){this.getHistroyDocumentList(function(){this.historyDocumentList&&this.historyDocumentList.length?this.getHistoryDataList(function(){this.documentEditor.options.pageShow="single",this.documentEditor.resetData(),this.beginDiffHistory(),this.documentEditor.resetData(),this.toolbarNode.show(),this.documentEditor.documentToolbarNode=this.documentEditor.toolbarNode,this.documentEditor.documentToolbarNode.hide(),this.documentEditor.sidebarNode&&this.documentEditor.sidebarNode.hide(),this.documentEditor.toolbarNode=this.toolbarNode,this.documentEditor.resizeToolbar();var i=MWF.xApplication.process.Xform.LP.documentHistory.diff_patch_count;i=i.replace(/{history}/,this.historyDataList.length).replace(/{diff}/,this.diffCount),this.toolbarNode.getLast().set("html",i),layout.mobile&&!this.is_iPad()||(this.createHistoryListNode(),this.toolbarNode&&(this.toolbarNode.setStyle("overflow","visible"),this.historyListAreaNode&&this.historyListAreaNode.inject(this.toolbarNode)),this.loadHistoryList()),this.documentEditor.options.pageShow="single",this.documentEditor.resetData(),t&&t()}.bind(this)):this.documentEditor.form.app.notice(MWF.xApplication.process.Xform.LP.documentHistory.nodiff,"info",this.documentEditor.node)}.bind(this))},diffHistroy:function(){for(var t=[],i=1;i<this.historyDataList.length;i++){var o=this.historyDataList[i],e=o.json;if(o.json=e,e.patchs){var s=(new diff_match_patch).patch_fromText(e.patchs);o.json.patchObj=s,s.each(function(i){t.push({patch:i,obj:o})}.bind(this))}}return t},doPatchAnimation:function(t){var i=this.diffPatch[this.patchIndex],o=i.patch,e=i.obj;this.currentDiffs=o.diffs,this.diffIndex=this.reverse?o.diffs.length-1:0;var s=this.reverse?o.start1+o.length2:o.start1;this.doDiffsAnimation(e,s,function(){this.reverse?(this.patchIndex--,this.patchIndex>=0?(this.currentHistoryData=this.documentEditor.layout_filetext.get("html"),this.doPatchAnimation(t)):t&&t()):(this.patchIndex++,this.patchIndex<this.diffPatch.length?(this.currentHistoryData=this.documentEditor.layout_filetext.get("html"),this.doPatchAnimation(t)):t&&t())}.bind(this))},doPatchAnimationStep:function(t){if(this.patchIndex>this.diffPatch.length||this.patchIndex<0)this.initAnimationStatus(),this.documentEditor.resetData(),this.checkToolbar();else{var i=this.diffPatch[this.patchIndex],o=i.patch,e=i.obj;this.currentDiffs=o.diffs,this.diffIndex=0,this.doDiffsAnimation(e,o.start1),this.patchIndex=this.patchIndex+t}},createDiifInforNode:function(t,i,o,e){this.historyInforDiv&&(this.historyInforDiv.dispose(),this.historyInforDiv=null);var s=layout.mobile?this.css.historyInforMobileNode:this.css.historyInforNode,n=new Element("div",{styles:s}).inject(this.documentEditor.node);return n.setStyle("background",o),e=e.replace(/{name}/,o2.name.cn(t.person)).replace(/{activity}/,t.activityName).replace(/{time}/,t.createTime),n.set("html",e),layout.mobile||n.position({relativeTo:i,position:"upperCenter",edge:"bottomCenter",offset:{x:0,y:-10}}),this.historyInforDiv=n,n},doDiffsAnimation:function(t,i,o){var e=this.currentDiffs[this.diffIndex],s=this.documentEditor.layout_filetext;switch(e[0]){case DIFF_INSERT:e.item&&e.item.showCurrent(!this.stopWhile||this.stopWhile==e.id),this.originaDiff&&this.originaDiff.hideCurrent();var n=e[1];if(this.reverse){i-=n.length;var h=this.currentHistoryData.substring(0,i),r=this.currentHistoryData.substring(i,i+e[1].length),a=this.currentHistoryData.substring(i+e[1].length);s.set("html",h+"<ins style='color:blue;'></ins>"+a)}else{h=this.currentHistoryData.substring(0,i),a=this.currentHistoryData.substring(i);s.set("html",h+"<ins style='color:blue;'></ins>"+a)}var d=s.getElement("ins");this.stopWhile&&this.stopWhile!=e.id||d.scrollIn(),this.doInsetAnimation(d,[1],function(h){var r=null;h||this.stopWhile&&this.stopWhile!=e.id||(r=this.createDiifInforNode(t,d,"#e2edfb",MWF.xApplication.process.Xform.LP.documentHistory.insertContent)),window.setTimeout(function(){var h=function(h){r&&r.fade("out"),new Fx.Tween(d,{property:"opacity",duration:this.options.speed*this.options.fxTime}).start(1.1).chain(function(){r&&r.destroy(),e.item&&e.item.hideCurrent(),this.reverse?(d.destroy(),this.currentHistoryData=s.get("html")):(data=s.get("html"),this.currentHistoryData=data.replace(/<ins[\s\S]*\/ins>/m,n),s.set("html",this.currentHistoryData)),this.playing?this.reverse?(this.diffIndex--,this.diffIndex>=0?window.setTimeout(function(){this.doDiffsAnimation(t,i,(function(){o&&o(),h&&h()}))}.bind(this),this.options.speed*this.options.fxTime):o&&o()):(i+=n.length,this.diffIndex++,this.diffIndex<this.currentDiffs.length?window.setTimeout(function(){this.doDiffsAnimation(t,i,(function(){o&&o(),h&&h()}))}.bind(this),this.options.speed*this.options.fxTime):o&&o()):(this.initAnimationStatus(),this.documentEditor.resetData(),h&&h())}.bind(this)),this.nextPlayPrefixFunction&&(this.nextPlayPrefixFunction=null)}.bind(this);this.stopWhile&&this.stopWhile==e.id&&(this.stop=!0),this.stop&&this.playing?(this.stopWhile&&(this.stopWhile=""),this.nextPlayPrefixFunction=h):h(),this.checkToolbar()}.bind(this),h?100:this.options.speed*this.options.inforTime)}.bind(this));break;case DIFF_DELETE:e.item&&e.item.showCurrent(!this.stopWhile||this.stopWhile==e.id),this.originaDiff&&this.originaDiff.hideCurrent();n=e[1];if(this.reverse){h=this.currentHistoryData.substring(0,i),a=this.currentHistoryData.substring(i);s.set("html",h+"<del style='color: red'>"+n+"</del>"+a),i-=n.length}else{h=this.currentHistoryData.substring(0,i),r=this.currentHistoryData.substring(i,i+e[1].length),a=this.currentHistoryData.substring(i+e[1].length);s.set("html",h+"<del style='color: red'>"+r+"</del>"+a)}var c=s.getElement("del");this.stopWhile&&this.stopWhile!=e.id||c.scrollIn(),this.doDeleteAnimation(c,e,t,function(h){var r=!h;window.setTimeout(function(){var r=function(r){h&&h.fade("out"),new Fx.Tween(c,{property:"opacity",duration:this.options.speed*this.options.fxTime}).start(.5,0).chain(function(){h&&h.destroy(),e.item&&e.item.hideCurrent(),this.reverse?(data=s.get("html"),this.currentHistoryData=data.replace(/<del[\s\S]*\/del>/m,n),s.set("html",this.currentHistoryData)):(c.destroy(),this.currentHistoryData=s.get("html")),this.playing?this.reverse?(this.diffIndex--,this.diffIndex>=0?window.setTimeout(function(){this.doDiffsAnimation(t,i,(function(){o&&o(),r&&r()}))}.bind(this),this.options.speed*this.options.fxTime):o&&o()):(this.diffIndex++,this.diffIndex<this.currentDiffs.length?window.setTimeout(function(){this.doDiffsAnimation(t,i,(function(){o&&o(),r&&r()}))}.bind(this),this.options.speed*this.options.fxTime):o&&o()):(this.initAnimationStatus(),this.documentEditor.resetData(),r&&r())}.bind(this)),this.nextPlayPrefixFunction&&(this.nextPlayPrefixFunction=null)}.bind(this);this.stopWhile&&this.stopWhile==e.id&&(this.stop=!0),this.stop&&this.playing?(this.stopWhile&&(this.stopWhile=""),this.nextPlayPrefixFunction=r):r(),this.checkToolbar()}.bind(this),r?100:this.options.speed*this.options.inforTime)}.bind(this));break;case DIFF_EQUAL:this.reverse?(i-=e[1].length,this.diffIndex--,this.diffIndex>=0?this.doDiffsAnimation(t,i,o):o&&o()):(i+=e[1].length,this.diffIndex++,this.diffIndex<this.currentDiffs.length?this.doDiffsAnimation(t,i,o):o&&o())}},doInsetAnimation:function(t,i,o){var e=new Element("div",{html:i});if(e.get("text").trim()){var s=e.childNodes;this.doInsetNodeAnimation(t,s,0,o)}else o&&o(!0)},doInsetNodeAnimation:function(t,i,o,e){var s=i[o];if(s.nodeType==Node.TEXT_NODE)this.doCharAnimation(t,s.nodeValue,0,function(){++o<i.length?this.doInsetNodeAnimation(t,i,o,e):e&&e()}.bind(this));else{var n=this.options.speed*this.options.fxTime/i.length;if(n){var h=new Element("span",{styles:{opacity:0}}).inject(t);h.appendChild(s),new Fx.Tween(h,{property:"opacity",duration:n}).start(0,1).chain(function(){++o<i.length?this.doInsetNodeAnimation(t,i,o,e):e&&e()}.bind(this))}else t.appendChild(s),++o<i.length?this.doInsetNodeAnimation(t,i,o,e):e&&e()}},doCharAnimation:function(t,i,o,e){var s=this.options.speed*this.options.fxTime/i.length;if(s){var n=i.charAt(o),h=new Element("span",{styles:{opacity:0},html:n}).inject(t);new Fx.Tween(h,{property:"opacity",duration:s}).start(0,1).chain(function(){++o<i.length?this.doCharAnimation(t,i,o,e):e&&e()}.bind(this))}else t.set("html",i),o=i.length,e&&e()},doDeleteAnimation:function(t,i,o,e){var s=i[1];if(new Element("div",{html:s}).get("text").trim()){var n=this.stopWhile&&this.stopWhile!=i.id?null:this.createDiifInforNode(o,t,"#fbe0e7",MWF.xApplication.process.Xform.LP.documentHistory.deleteContent);new Fx.Tween(t,{property:"opacity",duration:this.options.speed*this.options.fxTime}).start(1,.5).chain(function(){e&&e(n)}.bind(this))}else e&&e(null)}}),MWF.xApplication.process.Xform.widget.DocumentHistory.Item=new Class({initialize:function(t,i){this.history=t,this.documentEditor=this.history.documentEditor,this.css=this.history.css,this.historyData=i,this.load()},launch:function(){o2.load("../o2_lib/diff-match-patch/diff_match_patch_uncompressed.js",function(){var t=new diff_match_patch,i=this.documentEditor.getFiletextText(this.historyData.json.data),o=this.history.documentHistoryItems.indexOf(this)-1,e=this.documentEditor.getFiletextText(this.history.documentHistoryItems[o].historyData.json.data),s=t.diff_main(e,i);t.diff_cleanupSemantic(s);var n=t.diff_prettyHtml(s);n=n.replace(/(\n\t\t\t)+/g," | ").replace(/(\n\t\t)+/g,"\n").replace(/(\n\t)+/g,"\n").replace(/\n+/g,"<br>").replace(/\t+/g,""),this.documentEditor.layout_filetext.set("html",n)}.bind(this))},createTitleNode:function(){this.node=new Element("div",{styles:this.css.historyListItemNode}).inject(this.history.historyListContentAreaNode),this.historyData.json.v&&"6"==this.historyData.json.v&&this.history.documentHistoryItems&&this.history.documentHistoryItems.length&&(this.actionNode=new Element("div",{styles:this.css.historyListItemActionNode,text:MWF.xApplication.process.Xform.LP.documentHistory.diff,title:MWF.xApplication.process.Xform.LP.documentHistory.diffTitle}).inject(this.node),this.actionNode.addEvent("click",function(t){this.history.documentHistoryItems&&this.history.documentHistoryItems.length&&this.history.documentHistoryItems.each((function(t){t.histroyObj&&t.histroyObj.hideCurrent()})),this.histroyObj.showCurrent(),this.launch(),t.stopPropagation()}.bind(this)));var t=this.historyData,i="";if(this.historyData.json.data){var o=this.documentEditor.getFiletextText(this.historyData.json.data).length+" "+MWF.xApplication.process.Xform.LP.documentHistory.word;i="<div style='font-weight: bold; height: 30px; line-height: 30px'>"+o2.name.cn(t.person)+" ["+t.activityName+"] ("+o+")</div><div style='height: 20px; line-height: 20px; color:#666666'>"+t.createTime+"</div>"}else i="<div style='font-weight: bold; height: 30px; line-height: 30px'>"+o2.name.cn(t.person)+" ["+t.activityName+"]</div><div style='height: 20px; line-height: 20px; color:#666666'>"+t.createTime+"</div>";this.patchNode=new Element("div",{styles:this.css.historyListItemPatchNode,html:i}).inject(this.node),this.diffsNode=new Element("div",{styles:this.css.historyListItemDiffsNode}).inject(this.node)},createDataNode:function(){MWF.xApplication.process.Xform.LP.documentHistory.original;var t={node:this.node,showCurrent:function(){this.node.setStyles({"background-color":"#e2edfb"})},hideCurrent:function(){this.node.setStyles(i.css.historyListItemDiffNode)}},i=this;this.histroyObj=t,this.node.addEvents({click:function(){i.history.stop&&i.history.origina(i.historyData.json.data,t)}})},createPatchNode:function(t){var i=this;t.diffs.each(function(t){if(0!=t[0]){t.id=(new o2.widget.UUID).toString();var o=new Element("div",{html:t[1]}),e=(e=o.get("text")).length>50?e.substring(0,50)+"...":e;o.destroy(),e=-1==t[0]?MWF.xApplication.process.Xform.LP.documentHistory.delete+": <span style='color:red'><del>"+e+"</del></span>":MWF.xApplication.process.Xform.LP.documentHistory.insert+": <span style='color:blue'><ins>"+e+"</ins></span>",diffNode=new Element("div",{styles:this.css.historyListItemDiffNode,html:e}).inject(this.diffsNode),diffNode.store("diff",t),t.item={node:diffNode,showCurrent:function(t){var o=-1==this.node.retrieve("diff")[0]?"#fbe0e7":"#e2edfb";this.node.setStyles({"background-color":o});var e=i.history.historyListContentAreaNode.getScrollSize(),s=i.history.historyListContentAreaNode.getSize();e.y>s.y&&t&&this.node.scrollIn()},hideCurrent:function(){this.node.setStyles(i.css.historyListItemDiffNode)}}}}.bind(this))},load:function(){this.createTitleNode();var t=this.historyData.json.patchObj||null;if(this.historyData.json.v&&"6"==this.historyData.json.v)this.historyData.json.data&&this.createDataNode(),t&&t.each(function(t){this.createPatchNode(t)}.bind(this));else{var i=this;t?t.each(function(t){t.diffs.each(function(t){if(0!=t[0]){t.id=(new o2.widget.UUID).toString();var o=new Element("div",{html:t[1]}),e=(e=o.get("text")).length>50?e.substring(0,50)+"...":e;o.destroy(),e=-1==t[0]?MWF.xApplication.process.Xform.LP.documentHistory.delete+": <span style='color:red'><del>"+e+"</del></span>":MWF.xApplication.process.Xform.LP.documentHistory.insert+": <span style='color:blue'><ins>"+e+"</ins></span>",diffNode=new Element("div",{styles:this.css.historyListItemDiffNode,html:e}).inject(this.diffsNode),diffNode.store("diff",t),t.item={node:diffNode,showCurrent:function(t){var o=-1==this.node.retrieve("diff")[0]?"#fbe0e7":"#e2edfb";this.node.setStyles({"background-color":o});var e=i.history.historyListContentAreaNode.getScrollSize(),s=i.history.historyListContentAreaNode.getSize();e.y>s.y&&t&&this.node.scrollIn()},hideCurrent:function(){this.node.setStyles(i.css.historyListItemDiffNode)}},diffNode.addEvents({click:function(){if(i.history.stop){var t=this.retrieve("diff");i.history.to(t)}}})}}.bind(this))}.bind(this)):(infor=MWF.xApplication.process.Xform.LP.documentHistory.original,diffNode=new Element("div",{styles:this.css.historyListItemDiffNode,html:infor}).inject(this.diffsNode),this.history.originaDiff={node:diffNode,showCurrent:function(){this.node.setStyles({"background-color":"#e2edfb"})},hideCurrent:function(){this.node.setStyles(i.css.historyListItemDiffNode)}},diffNode.addEvents({click:function(){i.history.stop&&i.history.origina()}}))}}});