MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Sidebar=MWF.APPSidebar=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.setStyles(this.form.css.sidebar),this.toolbarNode=this.node.getFirst("div"),this.toolbarNode.empty(),this.form.businessData.task&&MWF.require("MWF.widget.Toolbar",function(){var t=[];if((this.getRouteNameList()||[]).each(function(o,e){this.json.defaultTools||(this.json.defaultTools=[]);var s={type:"MWFToolBarButton",img:"submit.png",title:o.displayName,action:"processWork:"+o.routeName,text:o.displayName,id:"action_processWork",control:"allowProcessing",condition:"",read:!1};t.push(s)}.bind(this)),this.json.defaultTools=t.concat(this.json.defaultTools),this.toolbarWidget=new MWF.widget.Toolbar(this.toolbarNode,{style:this.json.style},this),this.json.hideSystemTools?this.json.tools.length?(this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):this.toolbarNode.setStyle("display","none"):this.json.defaultTools.length||this.json.tools.length?this.json.defaultTools?(this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):MWF.getJSON(this.form.path+"toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),!1):this.toolbarNode.setStyle("display","none"),this.toolbarWidget.children.length){this.node.setStyle("display","none"),window.setTimeout(this.loadPosition.bind(this),500);var o=this;this.form.app.content.getFirst().addEvent("scroll",(function(t){o.loadPosition(this)})),this.form.app.addEvent("resize",(function(t){o.loadPosition(this)}))}else this.toolbarNode.setStyle("display","none")}.bind(this))},loadPosition:function(){this.node.setStyle("display","block");for(var t=this.node.getParent();t&&!t.get("MWFtype");)t=t.getParent();this.sideNode=t||this.form.node;var o=this.form.app.content.getSize(),e=this.sideNode.getSize(),s=this.sideNode.getPosition(this.sideNode.getOffsetParent()),i=this.node.getSize();if(e.y>o.y){var n=o.y/2-i.y/2;if(n<s.y)this.node.setStyle("top",s.y+"px");else if(n>s.y+e.y){var r=s.y+e.y-i.y;this.node.setStyle("top",r+"px")}else this.node.setStyle("top",n+"px")}else{var a=s.y+e.y/2-i.y/2;if(a>o.y)if(s.y+i.y>o.y)this.node.setStyle("top",s.y+"px");else{r=o.y-i.y;this.node.setStyle("top",r+"px")}else if(a<=0)if(s.y+e.y<i.y){r=s.y+e.y-i.y;this.node.setStyle("top",r+"px")}else this.node.setStyle("top","45px");else this.node.setStyle("top",a+"px")}var l=e.x+s.x+5;this.node.setStyle("left",l+"px"),this.node.setStyle("position","absolute"),this.node.setStyles({right:"auto",bottom:"auto"})},setCustomToolbars:function(t,o){t.each(function(t){var e=!0;if(e=this.readonly?t.readShow:t.editShow){if(e=!0,t.control&&(e=this.form.businessData.control[t.control]),t.condition)e=!this.form.Macro.exec(t.condition,this);if(e){var s=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:"../x_component_process_FormDesigner/Module/Actionbar/"+(this.form.options.style||"default")+"/custom/"+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(o);if(t.actionScript&&s.store("script",t.actionScript),t.sub){var i=o.getLast();this.setCustomToolbars(t.sub,i)}}}}.bind(this))},setToolbars:function(t,o,e,s){t.each(function(t){var i=!0;(t.control&&(i=this.form.businessData.control[t.control]),!s&&t.condition)&&(i=!this.form.Macro.exec(t.condition,this));if("action_processWork"==t.id&&(this.form.businessData.task||(i=!1)),e&&(t.read||(i=!1)),i){new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:"../x_component_process_FormDesigner/Module/Actionbar/"+(this.form.options.style||"default")+"/tools/default/"+t.img,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(o);if(t.sub){var n=o.getLast();this.setToolbars(t.sub,n,e,s)}}}.bind(this))},getRouteNameList:function(t){var o=[];return t||(t=this.getRouteDataList()),t.each(function(t,e){if(!(t.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString())){var s=t.name;t.displayNameScriptText&&this.form&&this.form.Macro&&(s=this.form.Macro.exec(t.displayNameScriptText,this)),o.push({routeId:t.id,displayName:s,routeName:t.name})}}.bind(this)),o},getRouteDataList:function(){return this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.form.businessData.task.routeList},function(t){t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1),this.routeDataList},getRouteData:function(t){for(var o=this.getRouteDataList(),e=0;e<o.length;e++)if(o[e].id===t)return o[e]},runCustomAction:function(t){var o=t.node.retrieve("script");this.form.Macro.exec(o,this)},saveWork:function(){this.form.saveWork()},closeWork:function(){this.form.closeWork()},processWork:function(t){if(opinion=this.form.getOpinion(),!this.form.formCustomValidation())return this.form.app.content.unmask(),!1;this.form.submitWork(t,opinion.opinion,opinion.medias)},resetWork:function(){this.form.resetWork()},retractWork:function(t,o){this.form.retractWork(t,o)},rerouteWork:function(t,o){this.form.rerouteWork(t,o)},deleteWork:function(){this.form.deleteWork()},printWork:function(){this.form.printWork()}});