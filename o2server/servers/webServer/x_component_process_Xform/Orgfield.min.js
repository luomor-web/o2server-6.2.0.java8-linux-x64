MWF.xDesktop.requireApp("process.Xform","Personfield",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.process.Xform.Orgfield=MWF.APPOrgfield=new Class({Extends:MWF.APPPersonfield,iconStyle:"orgfieldIcon",loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),s=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(s-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:s+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadUserInterface:function(){this.field=!0,this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){var t="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType];if(t.contains("unit")||t.contains("identity")){if(this.selectUnits=this.getSelectRange(),"all"!==this.json.range&&!this.selectUnits.length)return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1}else this.selectUnits=[]},_loadNodeRead:function(){this.node.empty(),this.node.setStyle("overflow","hidden"),this.node.set({nodeId:this.json.id,MWFType:this.json.type});new Element("div").inject(this.node)},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div");if(t.data){var s="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":s=t.data.name+"("+t.data.unitName+")";break;case"@p":s=t.data.name+(t.data.employee?"("+t.data.employee+")":"");break;case"@u":s=t.data.levelName;break;case"@g":s=t.data.name;break;default:s=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:s})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},_searchOptions:function(t,e){var s={type:"",types:"array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],units:this.selectUnits,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType};this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,s)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,readonly:!0}),this.readonly||(this.node.setStyle("cursor","pointer"),this.node.addEvents({click:function(t){this.clickSelect(t)}.bind(this)}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:{background:"url(../x_component_process_Xform/$Form/default/icon/selectorg.png) center center no-repeat",width:"18px",height:"18px",float:"right"}}).inject(this.node,"before"),this.iconNode&&(this.iconNode.setStyle("cursor","pointer"),this.iconNode.addEvents({click:function(t){this.clickSelect(t)}.bind(this)})))},getValue:function(){var t=this._getBusinessData();return"array"===typeOf(t)?0===t.length&&(t=this._computeValue()):t||(t=this._computeValue()),t||""},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getData:function(t){return"save"==this.json.compute&&this._setValue(this._computeValue()),this._getBusinessData()},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this._getBusinessData()},addData:function(t){if(!t)return!1;t.each(function(t){var e,s=typeOf(t);"string"===s&&(this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0)}.bind(this),null,t,!1),e&&this.combox.addNewValue(this.getDataText(e),e));"object"===s&&this.combox.addNewValue(this.getDataText(t),t)}.bind(this))},setData:function(t){this._setValue(t)},_computeValue:function(){var t=[];if(this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)})),this.json.defaultValue&&this.json.defaultValue.code){var e=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(e)&&(e=e?[e]:[]),e.each(function(e){var s;e&&("string"===typeOf(e)?(this.getOrgAction()[this.getValueMethod(e)](function(t){s=MWF.org.parseOrgData(t.data,!0)}.bind(this),null,e,!1),t.push(s)):t.push(e))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},_getBusinessData:function(){if("yes"==this.json.section)var t=this._getBusinessSectionData();else t=this.form.businessData.data[this.json.id]||"";return"array"!=typeOf(t)?t?[t]:[]:t},creteShowNode:function(t,e){var s=t.text?t.text:t;e||(s+=this.json.splitStr||", ");var i=new Element("div",{styles:{float:"left","margin-right":"5px"},text:s}),n="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":n=t.value.name+"("+t.value.unitName+")";break;case"@p":n=t.value.name+(t.value.employee?"("+t.value.employee+")":"");break;case"@u":n=t.value.levelName;break;case"@g":n=t.value.name;break;default:n=t.value.name}var o=new Element("div").set({styles:{"font-size":"14px",color:""},text:n});new mBox.Tooltip({content:o,setStyles:{content:{padding:15,lineHeight:20}},attach:i,transition:"flyin"})}return i},_setValue:function(t){1!=t.length||t[0]||(t=[]);var e=[],s=[],i=typeOf(t);if("array"===i&&t.each(function(t){var i=null,n=typeOf(t);if("string"===n){var o=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0)}.bind(this),o,t,!1)}"object"===n&&(i=t),i&&(e.push(i),s.push({text:this.getDataText(i),value:i}))}.bind(this)),"string"===i){var n,o=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){n=MWF.org.parseOrgData(t.data,!0)}.bind(this),o,t,!1),n&&(e.push(n),s.push({text:this.getDataText(n),value:n}))}if("object"===i&&(e.push(t),s.push({text:this.getDataText(t),value:t})),this._setBusinessData(t),this.json.isInput)if(this.combox)this.combox.clear(),this.combox.addNewValues(s);else{var a=this.node.getFirst();a&&(a.empty(),s.each(function(t,e){this.creteShowNode(t,e===s.length-1).inject(a)}.bind(this)))}else{var h=this.node.getFirst();h||(h=this.node),h.empty(),this.loadOrgWidget(e,h)}},loadOrgWidget:function(t,e){var s=!!layout.mobile;"no"===this.json.showCard&&(s=!0);var i={style:"xform",canRemove:!1,onRemove:this.removeItem,disableInfor:s};t.each(function(t){if(t.distinguishedName){switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":var s=new MWF.widget.O2Identity(t,e,i);break;case"@p":s=new MWF.widget.O2Person(t,e,i);break;case"@u":s=new MWF.widget.O2Unit(t,e,i);break;case"@g":s=new MWF.widget.O2Group(t,e,i);break;default:s=new MWF.widget.O2Other(t,e,i)}s.field=this,layout.mobile&&s.node.setStyles({float:"none"})}}.bind(this))},removeItem:function(t,e){var s,i=this.field,n=this.data.distinguishedName,o=i._getBusinessData();o.each((function(t,e){t.distinguishedName==n&&(s=e)})),o.splice(s,1),i._setBusinessData(o),this.node.destroy(),e.stopPropagation()},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(t){this.validationMode();var e=this.json.count?this.json.count:0,s="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],i=this.selectUnits;if(!s[0])return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectType,"error",this.node),!1;var n=[];if(this.json.exclude){var o=this.form.Macro.exec(this.json.exclude.code,this);n="array"===typeOf(o)?o:[o]}var a={type:"",types:s,values:this.json.isInput?[]:this._getBusinessData(),count:e,units:i,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,exclude:n,expandSubEnable:"no"!=this.json.expandSubEnable,onComplete:function(t,e){var s=[];t.each((function(t){s.push(MWF.org.parseOrgData(t.data))})),this.json.isInput?this.addData(s):this.setData(s),this.validation(),this.fireEvent("select")}.bind(this),onCancel:function(){this.validation()}.bind(this),onLoad:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),onClose:function(){var t=this.getInputData();t&&t.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)};this.form.json.selectorStyle&&(a=Object.merge(a,this.form.json.selectorStyle)),this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,a))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}}});