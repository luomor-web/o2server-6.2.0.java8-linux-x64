MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.ImageClipper=MWF.APPImageClipper=new Class({Implements:[Events],Extends:MWF.APP$Module,initialize:function(e,t,i,o){this.node=$(e),this.node.store("module",this),this.json=t,this.form=i,this.field=!0},_loadUserInterface:function(){this.field=!0,this.node.empty();var e=this._getBusinessData();if(e){var t=new Element("img",{src:MWF.xDesktop.getImageSrc(e)});if(layout.mobile||COMMON.Browser.Platform.isMobile)t.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),o=this.json.imageHeight.toInt();i&&o&&t.setStyles({width:i+"px",height:o+"px"})}t.inject(this.node)}if(!this.readonly&&!this.json.isReadonly){var s=new Element("div").inject(this.node),n=new Element("button").inject(s);n.set({text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),n.addEvent("click",function(){this.validationMode();var e=this._getBusinessData();if(layout.mobile){o2.imageClipperCallback=function(e){var t=JSON.parse(e);this.setData(t?t.fileId:""),this.validation(),o2.imageClipperCallback=null}.bind(this);var t="processPlatformJob";this.form.businessData.work&&this.form.businessData.work.referencetype&&(t=this.form.businessData.work.referencetype);var i=JSON.stringify({mwfId:this.json.id,callback:"o2.imageClipperCallback",referencetype:t,reference:this.form.businessData.work.job});window.o2android&&window.o2android.uploadImage2FileStorage?window.o2android.uploadImage2FileStorage(i):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadImage2FileStorage?window.webkit.messageHandlers.uploadImage2FileStorage.postMessage(i):this.selectImage(e,function(e){this.setData(e?e.id:""),this.validation()}.bind(this))}else this.selectImage(e,function(e){this.setData(e?e.id:""),this.validation()}.bind(this))}.bind(this))}},getTextData:function(){var e=this._getBusinessData()||"";return{value:[e],text:[e]}},isEmpty:function(){return!this.getData()},getData:function(e){return this._getBusinessData()||""},setData:function(e){if(this._setBusinessData(e),(t=this.node.getElements("img"))&&t.length&&t.destroy(),e){var t=new Element("img",{src:MWF.xDesktop.getImageSrc(e)}).inject(this.node,"top");if(layout.mobile||COMMON.Browser.Platform.isMobile)t.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),o=this.json.imageHeight.toInt();i&&o&&t.setStyles({width:i+"px",height:o+"px"})}}},selectImage:function(e,t){var i=this.json.clipperType||"unrestricted",o=1,s="",n=800;if("unrestricted"==i)o=0;else if("size"==i){var a=this.json.imageWidth?this.json.imageWidth.toInt():600,r=this.json.imageHeight?this.json.imageHeight.toInt():500;o=a/r,n=Math.max(a,r),isNaN(a)||isNaN(r)||(s=MWF.LP.widget.pictureSize.replace(/{width}/g,a).replace(/{height}/g,r))}else"ratio"==i&&(o=this.json.imageRatio||1,s=MWF.LP.widget.pictureRatio.replace(/{ratio}/g,o));MWF.xDesktop.requireApp("process.Xform","widget.ImageClipper",function(){this.imageClipper=new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app,{style:"default",aspectRatio:o,description:s,imageUrl:e?MWF.xDesktop.getImageSrc(e):"",reference:this.form.businessData.work.job,referenceType:"processPlatformJob",resultMaxSize:n,onChange:function(){t({src:this.imageClipper.imageSrc,id:this.imageClipper.imageId})}.bind(this)}),this.imageClipper.load()}.bind(this))},createErrorNode:function(e){var t=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(t),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:e}).inject(t);return t},notValidationMode:function(e){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(e).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(e){var t=e.getParent("div");if(t){if("tab$Content"==t.get("MWFtype")&&"none"==t.getParent("div").getStyle("display")){var i=t.getParent("div").getParent("div"),o=i.getPrevious("div"),s=i.getChildren().indexOf(t.getParent("div"));o.getLast().getFirst().getChildren()[s].click(),t=o.getParent("div")}this.showNotValidationMode(t)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(e,t){if("all"==t.status||e==t.decision){var i=this.getData(),o="value"==t.valueType?i:i.length;switch(t.operateor){case"isnull":if(!o)return this.notValidationMode(t.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(t.prompt),!1;break;case"gt":if(o>t.value)return this.notValidationMode(t.prompt),!1;break;case"lt":if(o<t.value)return this.notValidationMode(t.prompt),!1;break;case"equal":if(o==t.value)return this.notValidationMode(t.prompt),!1;break;case"neq":if(o!=t.value)return this.notValidationMode(t.prompt),!1;break;case"contain":if(-1!=o.indexOf(t.value))return this.notValidationMode(t.prompt),!1;break;case"notcontain":if(-1==o.indexOf(t.value))return this.notValidationMode(t.prompt),!1}}return!0},validationConfig:function(e,t){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var o=this.json.validationConfig[i];if(!this.validationConfigItem(e,o))return!1}return!0}return!0},validation:function(e,t){if(!this.validationConfig(e,t))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=e;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}});