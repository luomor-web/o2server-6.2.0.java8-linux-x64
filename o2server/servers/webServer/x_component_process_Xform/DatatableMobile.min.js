MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatatableMobile=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.DatatablePC,loadDatatable:function(){this._loadStyles(),this._loadTitleTr(),this._loadTemplate(),this._createTemplateTable(),this._loadTotalTr(),this.fireEvent("load"),this._loadDatatable(function(){this._loadImportExportAction(),this.fireEvent("postLoad")}.bind(this))},_loadTitleTr:function(){this.titleTr=this.table.getElement("tr");var t=this.titleTr.getElements("th");this.json.border&&t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.json.titleStyles&&t.setStyles(this.json.titleStyles),t.each(function(t,e){var i=this.form._getDomjson(t);t.addClass("mwf_origional"),i&&("number"!==i.total&&"count"!==i.total||(this.totalFlag=!0))}.bind(this))},_loadTemplate:function(){this.templateJson={};var t=this.table.getElements("tr");this.templateTr=t[t.length-1];var e=this.templateTr.getElements("td");this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),this.json.contentStyles&&e.setStyles(this.json.contentStyles);var i=0;e.each(function(t,e){var o=this.form._getDomjson(t);t.addClass("mwf_origional"),o&&("sequence"===o.cellType&&t.addClass("mwf_sequence"),!1===o.isShow?t.hide():(i%2==0&&this.json.zebraColor?t.setStyle("background-color",this.json.zebraColor):this.json.backgroundColor&&t.setStyle("background-color",this.json.backgroundColor),i++))}.bind(this)),this.templateTr.hide()},_createTemplateTable:function(){this.templateNode=new Element("div").inject(this.node);var t=new Element("div",{styles:this.json.itemTitleStyles}).inject(this.templateNode);t.setStyle("overflow","hidden"),new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item}).inject(t),new Element("div.mwf_sequence",{styles:{float:"left"}}).inject(t),new Element("div.mwf_editaction",{styles:this.form.css.mobileDatagridActionNode}).inject(t);var e=new Element("table").inject(this.templateNode);this.json.border&&e.setStyles({"border-top":this.json.border,"border-left":this.json.border}),e.setStyles(this.json.tableStyles),e.set(this.json.properties);var i=this.titleTr.getElements("th"),o=this.templateTr.getElements("td");i.each(function(t,i){var s=new Element("tr").inject(e),n=this.form._getDomjson(t),l=t.clone().inject(s);l.set("html",t.get("html")),l.set("MWFId",t.get("id")),!1===n.isShow&&s.hide();var a=o[i],d=a.clone().inject(s);d.set("html",a.get("html")),d.set("MWFId",a.get("id"))}.bind(this)),this.templateHtml=this.templateNode.get("html"),this.table.hide(),this.templateNode.hide()},_loadTotalTr:function(){if(this.totalFlag){this.totalDiv=new Element("div.mwf_totaltr",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node);var t=new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv);t.setStyle("overflow","hidden"),new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.amount}).inject(t),this.totalTable=new Element("table").inject(this.totalDiv),this.json.border&&this.totalTable.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.totalTable.setStyles(this.json.tableStyles),this.totalTable.set(this.json.properties);var e=this.titleTr.getElements("th"),i=0;e.each(function(t,o){var s=new Element("tr").inject(this.totalTable),n=this.form._getDomjson(t);if(n&&("number"===n.total||"count"===n.total)){var l=new Element("th").inject(s);l.set("text",t.get("text")),this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),l.setStyles(this.json.titleStyles);var a=new Element("td").inject(s);this.json.border&&a.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),a.setStyles(this.json.amountStyles),!1===n.isShow?s.hide():(i%2==0&&this.json.zebraColor?a.setStyle("background-color",this.json.zebraColor):this.json.backgroundColor&&a.setStyle("background-color",this.json.backgroundColor),i++),this.totalColumns.push({th:l,td:a,index:o,type:n.total})}}.bind(this)),this.templateTr.getElements("td").each(function(t,e){if(this.form._getDomjson(t)){var i=this.totalColumns.find((function(t){return t.index===e}));if(i){var o=this.form._getModuleNodes(t);o.length>0&&(i.moduleJson=this.form._getDomjson(o[0]),"number"===i.type&&this.totalNumberModuleIds.push(i.moduleJson.id))}}}.bind(this))}},_loadTotal:function(){var t={};if(!this.totalFlag)return t;this.totalDiv||this._loadTotalTr();var e=this.getValue();return this.totalColumns.each(function(i,o){var s=i.moduleJson;if(s){if("count"===i.type)n=e.data.length;else if("number"===i.type)for(var n=new Decimal(0),l=0;l<e.data.length;l++){var a=e.data[l];a[s.id]&&(n=n.plus(a[s.id].toFloat()||0))}t[s.id]=n.toString(),i.td.set("text",isNaN(n)?"":n)}}.bind(this)),e.total=t,t},_createLineNode:function(){return this.totalDiv?new Element("div").inject(this.totalDiv,"before"):new Element("div").inject(this.node)},_loadStyles:function(){},_loadLine:function(t,e,i,o,s){var n=new MWF.xApplication.process.Xform.DatatableMobile.Line(t,this,e,{index:i,indexText:(i+1).toString(),isNew:s,isEdited:"boolean"===typeOf(o)?o:this.editable,isEditable:this.editable,isDeleteable:this.deleteable,isAddable:this.addable});return this.fireEvent("beforeLoadLine",[n]),n.load(),this.fireEvent("afterLoadLine",[n]),n},_loadImportExportAction:function(){this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy()}}),MWF.xApplication.process.Xform.DatatableMobile$Title=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatableMobile$Data=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatableMobile.Line=new Class({Extends:MWF.xApplication.process.Xform.DatatablePC.Line,load:function(){!this.datatable.multiEditMode&&this.options.isEdited&&(this.datatable.currentEditedLine=this),this.node.addClass("mwf_datatable"),this.node.setStyles(Object.merge({overflow:"hidden","margin-bottom":"10px"},this.datatable.json.styles||{})),this.loadModules(),this.loadSequence(),this.createActions(),this.datatable.multiEditMode||(this.originalData=Object.clone(this.data))},createActions:function(){if(this.options.isEditable){var t=this.node.getElement(".mwf_editaction");this.datatable.multiEditMode?(this.options.isDeleteable&&this.createDelAction(t),this.options.isAddable&&this.createAddAction(t)):(this.options.isDeleteable&&this.createDelAction(t),this.options.isEditable&&this.createEditAction(t),this.options.isAddable&&this.createAddAction(t),this.createCancelEditAction(t),this.createCompleteAction(t),this.checkActionDisplay())}},checkActionDisplay:function(){this.options.isEdited?(this.addLineAction&&this.addLineAction.hide(),this.editLineAction&&this.editLineAction.hide(),this.delLineAction&&this.delLineAction.hide(),this.completeLineAction&&this.completeLineAction.show(),this.cancelLineEditAction&&this.cancelLineEditAction.show()):(this.addLineAction&&this.addLineAction.show(),this.editLineAction&&this.editLineAction.show(),this.delLineAction&&this.delLineAction.show(),this.completeLineAction&&this.completeLineAction.hide(),this.cancelLineEditAction&&this.cancelLineEditAction.hide())},createEditAction:function(t){this.editLineAction=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit,events:{click:function(t){this.options.isEdited||this.datatable._changeEditedLine(this),t.stopPropagation()}.bind(this)}}).inject(t)},createAddAction:function(t){this.addLineAction=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add,events:{click:function(t){this.datatable._insertLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createCompleteAction:function(t){this.completeLineAction=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit,events:{click:function(t){this.datatable._completeLineEdit(t),t.stopPropagation()}.bind(this)}}).inject(t)},createCancelEditAction:function(t){this.cancelLineEditAction=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.cancelEdit,events:{click:function(t){this.datatable._cancelLineEdit(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createDelAction:function(t){this.delLineAction=new Element("div",{styles:this.form.css.mobileDatagridCancelActionNode,text:MWF.xApplication.process.Xform.LP.delete,events:{click:function(t){this.datatable._deleteLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t),this.delLineAction.show()}});