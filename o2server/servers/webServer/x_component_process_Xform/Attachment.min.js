MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.require("MWF.widget.AttachmentController",null,!1),MWF.xApplication.process.Xform.AttachmentController=new Class({Extends:MWF.widget.ATTER,options:{officeFiles:["doc","docx","dotx","dot","xls","xlsx","xlsm","xlt","xltx","pptx","ppt","pot","potx","potm","pdf"],allowPreviewExtension:["zip","pdf","ofd","png","jpg","bmp","jpeg","gif","js","css","java","json","xml","php","html","htm","xhtml","log","md","txt"],checkTextEnable:!0},checkAttachmentDeleteAction:function(){if(this.options.readonly)return this.setAttachmentsAction("delete",!1),!1;if("n"!==this.options.isDeleteOption){if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,o=this.attachments[e];!o.data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),"o"===this.options.isDeleteOption?(o.data.control.allowEdit||o.data.person===t||(i=!1),o.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(o.data.control.allowEdit||o.data.person===t||(i=!1),o.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(o.data.control.allowEdit||o.data.person===t||(i=!1),o.data.activity===this.module.form.businessData.activity.id&&o.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):o.data.control.allowEdit||o.data.person===t||(i=!1),i?this.setAttachmentAction(o,"delete",!0):this.setAttachmentAction(o,"delete",!1)}}else this.setAttachmentsAction("delete",!1)},checkDeleteAction:function(){if(this.checkAttachmentDeleteAction(),this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),!1;if("n"!==this.options.isDeleteOption)if(this.selectedAttachments.length){var t=layout.session.user.distinguishedName,e=!0;if("o"===this.options.isDeleteOption)for(var i=0;i<this.selectedAttachments.length;i++){if(!(o=this.selectedAttachments[i]).data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowEdit&&o.data.person!==t){e=!1;break}if(o.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else if("a"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(o=this.selectedAttachments[i]).data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowEdit&&o.data.person!==t){e=!1;break}if(o.data.activity!==this.module.form.businessData.activity.id){e=!1;break}}else if("ao"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(o=this.selectedAttachments[i]).data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowEdit&&o.data.person!==t){e=!1;break}if(o.data.activity!==this.module.form.businessData.activity.id||o.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else for(i=0;i<this.selectedAttachments.length;i++){var o;if(!(o=this.selectedAttachments[i]).data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowEdit&&o.data.person!==t){e=!1;break}}e?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction))}else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction);else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)},checkPreviewAttAction:function(){if(this.options.isPreviewAtt)if(this.selectedAttachments.length){for(var t=!1,e=0;e<this.selectedAttachments.length;e++){var i=this.selectedAttachments[e];if(this.options.allowPreviewExtension.contains(i.data.extension)){t=!0;break}}t&&this.setActionEnabled(this.previewAttAction)}else this.setActionDisabled(this.previewAttAction);else this.setActionDisabled(this.previewAttAction)},isAttDeleteAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isDeleteOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity===this.module.form.businessData.activity.id&&t.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):t.data.control.allowEdit||t.data.person===e||(i=!1),i},openInOfficeControl:function(t,e){e&&(e.openedAttachment&&e.openedAttachment.id===t.id||(e.save(),this.module.form.businessData.workCompleted?MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(t.id,this.module.form.businessData.workCompleted.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this)):MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.id,this.module.form.businessData.work.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this))))},checkReplaceAction:function(){if(!this.options.isReplaceHidden){if(this.options.readonly)return this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),!1;if("n"!==this.options.isReplaceOption)if(this.selectedAttachments.length&&1===this.selectedAttachments.length){var t=this.selectedAttachments[0];!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid);var e=layout.session.user.distinguishedName,i=!0;"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction))}else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction);else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)}},replaceAttachment:function(t,e){var i=this.selectedAttachments[0].data;if(this.module.json.isOpenInOffice&&this.module.json.officeControlName&&-1!==this.options.officeFiles.indexOf(i.extension)){var o=this.module.form.all[this.module.json.officeControlName];o?(this.min_closeOfficeAction&&this.setActionEnabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionEnabled(this.closeOfficeAction),this.openInOfficeControl(i,o)):this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])}else this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},isAttReplaceAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isReplaceOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i},checkOrderAction:function(){if(this.options.readonly)return this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction),!1;if(this.attachments.length&&this.attachments.length>1){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.attachments.length;i++){var o=this.attachments[i];if(!o.data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowControl&&!o.data.control.allowEdit&&o.data.person!==e){t=!1;break}}t?(this.setActionEnabled(this.orderAction),this.setActionEnabled(this.min_orderAction)):(this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction))}else this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction)},isAttOrderAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl&&t.data.control.allowEdit||t.data.person===e||(i=!1),i},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;!(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view")&&t.contains("config"))||this.module.json.isOpenInOffice&&this.module.json.officeControlName||(this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),this.isHiddenTop=!0),t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&this.createOfficeGroupActions(),t.contains("config")||this.createConfigGroupActions(),t.contains("view")||this.createViewGroupActions(),this.checkActions()},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkPreviewAttAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkConfigAction(),this.checkOrderAction(),this.checkListStyleAction()},checkAttachmentConfigAction:function(){if(this.options.readonly)return this.setAttachmentsAction("config",!1),!1;if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,o=this.attachments[e];!o.data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),o.data.control.allowControl||o.data.person===t||(i=!1),i?this.setAttachmentAction(o,"config",!0):this.setAttachmentAction(o,"config",!1)}},checkConfigAction:function(){if(this.checkAttachmentConfigAction(),this.options.readonly)return this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction),!1;if(this.selectedAttachments.length){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.selectedAttachments.length;i++){if(!(o=this.selectedAttachments[i]).data.person&&o.data.creatorUid&&(o.data.person=o.data.creatorUid),!o.data.control.allowControl&&o.data.person!==e){t=!1;break}}t?this.setActionEnabled(this.configAction):this.setActionDisabled(this.configAction)}else this.setActionDisabled(this.configAction);if(this.checkTextAction&&(this.setActionDisabled(this.checkTextAction),this.selectedAttachments.length&&1===this.selectedAttachments.length)){var o=this.selectedAttachments[0];-1!==this.options.images.indexOf(o.data.extension.toLowerCase())&&this.setActionEnabled(this.checkTextAction)}},isAttConfigAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===e||(i=!1),i},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.previewAttAction=this.createAction(this.editActionsGroupNode,"previewAtt",o2.LP.widget.previewAtt,function(t,e){this.previewAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createConfigGroupActions:function(){this.configActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.configActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.configActionBoxNode),this.configAction=this.createAction(this.configActionsGroupNode,"config",MWF.LP.widget.configAttachment,function(t,e){this.configAttachment(t,e)}.bind(this)),this.options.checkTextEnable&&(this.checkTextAction=this.createAction(this.configActionsGroupNode,"check",MWF.LP.widget.checkOcrText,function(t,e){this.checkImageTex(t,e)}.bind(this))),this.createSeparate(this.configActionsGroupNode),this.orderAction=this.createAction(this.configActionsGroupNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this)),this.configAction&&this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction)},createOfficeGroupActions:function(){this.officeActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.officeActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.officeActionBoxNode),this.closeOfficeAction=this.createAction(this.officeActionsGroupNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",MWF.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("config")||(this.min_orderAction=this.createAction(this.minActionAreaNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this))),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&(this.min_closeOfficeAction=this.createAction(this.minActionAreaNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.min_closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},closeAttachmentOffice:function(){var t=this.module.form.all[this.module.json.officeControlName];t&&(t.openFile(),this.min_closeOfficeAction&&this.setActionDisabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction))},configAttachment:function(){var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentPermissionNode}).inject(this.node),o=new Element("div",{styles:e.attachmentPermissionNamesNode}).inject(i),n=(new Element("div",{styles:e.attachmentPermissionNamesTitleNode,text:t.attachmentPermissionInfo}).inject(o),new Element("div",{styles:e.attachmentPermissionNamesAreaNode}).inject(o));this.selectedAttachments.length&&this.selectedAttachments.each(function(t){new Element("div",{styles:e.attachmentPermissionAttNode,text:t.data.name}).inject(n)}.bind(this));var s=new Element("div",{styles:e.attachmentPermissionEditAreaNode}).inject(i),a=(new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentRead}).inject(s),new Element("div",{styles:e.attachmentPermissionInputNode}).inject(s));new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentEdit}).inject(s);var c=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(s);new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentController}).inject(s);var r=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(s),d=o2.DL.open(Object.merge({title:t.attachmentPermission,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentConfig(a,c,r),d.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}]},this.module.form.json.dialogOptions||{}));if(1===this.selectedAttachments.length){var h=this.selectedAttachments[0].data,l=h.readUnitList||[],m=h.readIdentityList||[],p=h.editUnitList||[],u=h.editIdentityList||[],f=h.controllerUnitList||[],A=h.controllerIdentityList||[];a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:l.concat(m).trim()})),c.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:p.concat(u).trim()})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:f.concat(A).trim()}))}else a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),c.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]}))},setAttachmentConfig:function(t,e,i){if(this.selectedAttachments.length){var o=t.retrieve("data-value"),n=e.retrieve("data-value"),s=i.retrieve("data-value"),a=[],c=[],r=[],d=[],h=[],l=[];o&&o.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,o=e.substring(i-1,i);"U"===o&&a.push(e),"I"===o&&c.push(e)})),n&&n.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,o=e.substring(i-1,i);"U"===o&&r.push(e),"I"===o&&d.push(e)})),s&&s.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,o=e.substring(i-1,i);"U"===o&&h.push(e),"I"===o&&l.push(e)}));var m=0;this.selectedAttachments.each(function(t){t.data.readUnitList=a,t.data.readIdentityList=c,t.data.editUnitList=r,t.data.editIdentityList=d,t.data.controllerUnitList=h,t.data.controllerIdentityList=l,o2.Actions.get("x_processplatform_assemble_surface").configAttachment(t.data.id,this.module.form.businessData.work.id,t.data,function(){o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(t.data.id,this.module.form.businessData.work.id,function(e){var i=this.getAttachmentById(t.data.id);i&&(i.data=e.data,i.deleteAction&&!this.isAttDeleteAvailable(i)&&i.deleteAction.setStyle("display","none"),i.configAction&&!this.isAttConfigAvailable(i)&&i.configAction.setStyle("display","none")),++m===this.selectedAttachments.length&&this.checkActions()}.bind(this))}.bind(this))}.bind(this))}},checkImageTex:function(){if(this.selectedAttachments.length&&1==this.selectedAttachments.length){var t=this.selectedAttachments[0],e=MWF.xApplication.process.Xform.LP,i=this.module.form.css,o=new Element("div",{styles:i.attachmentOCRNode}).inject(this.node),n=new Element("div",{styles:i.attachmentOCRImageAreaNode}).inject(o),s=new Element("img",{styles:i.attachmentOCRImageNode}).inject(n);o2.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.data.id,this.module.form.businessData.work.id,(function(t){s.set("src",o2.filterUrl(t))}));var a=new Element("div",{styles:i.attachmentOCRInputAreaNode}).inject(o),c=new Element("textarea",{styles:i.attachmentOCRInputNode}).inject(a),r=o2.DL.open({title:e.attachmentOCRTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:o,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentOCR(c,t),r.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){r.close()}}]});t.data.ocr?c.set("text",t.data.ocr.text||""):o2.Actions.get("x_processplatform_assemble_surface").getAttachmentOCR(t.data.id,this.module.form.businessData.work.id,function(e){t.data.ocr=e.data,c.set("text",e.data.text||"")}.bind(this))}},setAttachmentOCR:function(t,e){var i=t.get("text");e.data.ocr||(e.data.ocr={}),e.data.ocr.text=i,o2.Actions.get("x_processplatform_assemble_surface").setAttachmentOCR(e.data.id,this.module.form.businessData.work.id,{text:i},function(){this.module.form.app.notice("success",lp.attachmentOCR_saved,this.node)}.bind(this))},checkMoveAction:function(t){if(t){var e=t.getFirst().getNext(),i=e.getFirst().show(),o=e.getLast().show();tmp=t.getPrevious(),tmp||i.hide(),tmp=t.getNext(),tmp||o.hide()}},sortByNumber:function(t){return t.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this))},orderAttachment:function(){if(this.attachments.length){this.attachments=this.sortByNumber(this.attachments);var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentOrderNode}),o=(new Element("div",{styles:e.attachmentOrderInforNode,text:t.attachmentOrderInfo}).inject(i),new Element("div",{styles:e.attachmentOrderAreaNode}).inject(i)),n=null;o2.getJSON("../x_component_File/$Main/icon.json",function(t){n=t}.bind(this),!1,!1),this.attachments.each(function(s,a){var c="../x_component_File/$Main/default/file/"+(n[s.data.extension.toLowerCase()]||n.unknow),r=new Element("div",{styles:e.attachmentOrderItemNode}).inject(o);r.store("att",s);var d=new Element("div",{styles:e.attachmentOrderItemIconNode}).inject(r);d.setStyle("background-image","url('"+c+"')");var h=new Element("div",{styles:e.attachmentOrderItemActionNode}).inject(r),l=(new Element("div",{styles:e.attachmentOrderItemTextNode,text:s.data.name}).inject(r),new Element("div",{styles:e.attachmentOrderItemActionUpNode,text:t.attachmentOrderUp}).inject(h)),m=new Element("div",{styles:e.attachmentOrderItemActionDownNode,text:t.attachmentOrderDown}).inject(h);0==a&&l.hide(),a==this.attachments.length-1&&m.hide(),l.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getPrevious();i&&(e.inject(i,"before"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),m.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getNext();i&&(e.inject(i,"after"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),r.addEvents({mouseover:function(t){this.setStyle("background-color","#f1f6fa")},mouseout:function(t){this.setStyle("background-color","#ffffff")}}),new Drag(r,{handle:d,snap:5,stopPropagation:!0,preventDefault:!0,onStart:function(t,n){var s=t;s.setStyle("background-color","#f1f6fa");var a=s.clone(!0).setStyles(e.attachmentOrderItemNode).setStyles({"background-color":"#faf9f1",opacity:.8,border:"1px dotted #333333"}).inject(i);a.position({relativeTo:s,position:"upperLeft",edge:"upperLeft"}),a.owner=s,new Drag.Move(a,{container:i,droppables:o.getChildren(),onEnter:function(t,i){a.flagNode=new Element("div",{styles:e.attachmentOrderFlagNode}).inject(i,"before")},onLeave:function(t,e){a.flagNode&&a.flagNode.destroy()},onDrop:function(t,e){a.flagNode&&(a.owner.inject(a.flagNode,"after"),a.flagNode.destroy(),a.owner.highlight(),this.checkMoveAction(a.owner),this.checkMoveAction(e),this.checkMoveAction(o.getLast()),a.destroy())}.bind(this)}).start(n)}.bind(this),enter:function(t){t.removeClass("dragging")}})}.bind(this));var s=o2.DL.open(Object.merge({title:t.attachmentOrderTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.sortAttachment(o),s.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}],onPostLoad:function(){this.node.setStyle("display","block");var t={};e.attachmentOrderNode&&("NaN"!==parseFloat(e.attachmentOrderNode.width).toString()&&(t.x=parseInt(e.attachmentOrderNode.width)),"NaN"!==parseFloat(e.attachmentOrderNode.height).toString()&&(t.y=parseInt(e.attachmentOrderNode.height))),i.show();var o=i.getSize();this.content.setStyles({width:t.x||o.x,height:t.y||o.y}),this.setContentSize()}},this.module.form.json.dialogOptions||{}))}},sortAttachment:function(t){t.getChildren().each(function(t,e){var i=t.retrieve("att",null);i&&(i.data.orderNumber=e,o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.changeOrderNumber(i.data.id,this.module.form.businessData.work.id,e))}.bind(this)),this.attachments=this.attachments.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this)),this.reloadAttachments(),this.fireEvent("order")}}),MWF.xApplication.process.Xform.Attachment=MWF.APPAttachment=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["upload","delete","afterDelete","load","change","download","open","queryLoad","queryLoadController","loadController","postLoadController"]},initialize:function(t,e,i,o){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.node.empty(),this.form.businessData.work.startTime&&(this.fireEvent("queryLoad"),this.loadAttachmentController(),this.fireEvent("load"))},reload:function(){this.node.empty(),this.form.businessData.work.startTime&&this.loadAttachmentController()},loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isPreviewAtt:"y"===this.json.isPreviewAtt||"true"===this.json.isPreviewAtt,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return t.data.name}));this._setBusinessData(t)}else this._setBusinessData([])},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},isEmpty:function(){var t=this.getData();return"array"===typeOf(t)?0==t.length:!t},getData:function(){return this.attachmentController?this.attachmentController.getAttachmentNames():null},createUploadFileNode:function(){var t="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each(function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}}.bind(this)),t=accepts.join(", ")}var e=0;this.json.attachmentSize&&(e=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"uploadAttachment",{id:this.form.businessData.work.id},null,function(t){t.id&&this.form.workAction.getAttachment(t.id,this.form.businessData.work.id,function(e){e.data&&(e.data.control||(e.data.control={}),this.form.businessData.attachmentList.push(e.data),this.attachmentController.addAttachment(e.data,t.messageId)),this.attachmentController.checkActions(),this.setAttachmentBusinessData(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this)),this.attachmentController.checkActions()}.bind(this),function(t){if(t.length&&t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.process.Xform.LP.uploadMore;return e=e.replace("{n}",this.attachmentController.options.attachmentCount),this.form.notice(e,"error"),!1}return!0}.bind(this),!0,t,e,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},uploadAttachment:function(t,e){window.o2android&&window.o2android.uploadAttachment?window.o2android.uploadAttachment(this.json.site||this.json.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadAttachment?window.webkit.messageHandlers.uploadAttachment.postMessage({site:this.json.site||this.json.id}):this.createUploadFileNode()},deleteAttachments:function(t,e,i){var o=[];i.each(function(t){o.push(t.data.name)}.bind(this));var n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteAttachmentTitle,MWF.xApplication.process.Xform.LP.deleteAttachment+"( "+o.join(", ")+" )",300,120,(function(){for(;i.length;){var t=i.shift();n.deleteAttachment(t)}this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},previewAttachment:function(t){var e=t[0];new MWF.xApplication.process.Xform.AttachmenPreview(e,this)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);var e=t.data.id;this.form.workAction.deleteAttachment(t.data.id,this.form.businessData.work.id,function(i){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions();for(var o=0;o<this.form.businessData.attachmentList.length;o++){var n=this.form.businessData.attachmentList[o];if(n.id===e){this.form.businessData.attachmentList.erase(n);break}}this.form.officeList&&this.form.officeList.each(function(t){t.openedAttachment&&t.openedAttachment.id==e&&t.loadOfficeEdit()}.bind(this)),this.setAttachmentBusinessData(),this.fireEvent("afterDelete",[t.data]),this.fireEvent("change")}.bind(this))},replaceAttachment:function(t,e,i){if(window.o2android&&window.o2android.replaceAttachment)window.o2android.replaceAttachment(i.data.id,this.json.site||this.json.id);else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.replaceAttachment)window.webkit.messageHandlers.replaceAttachment.postMessage({id:i.data.id,site:this.json.site||this.json.id});else{var o=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.replaceAttachmentTitle,MWF.xApplication.process.Xform.LP.replaceAttachment+"( "+i.data.name+" )",350,120,(function(){o.replaceAttachmentFile(i),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}},createReplaceFileNode:function(t){var e="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each((function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}})),e=accepts.join(", ")}var i=0;this.json.attachmentSize&&(i=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"replaceAttachment",{id:t.data.id,workid:this.form.businessData.work.id},null,function(e){this.form.workAction.getAttachment(t.data.id,this.form.businessData.work.id,function(i){if(t.data=i.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var o=this.attachmentController.messageItemList[e.messageId];o&&o.node&&o.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,!0,e,i,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},replaceAttachmentFile:function(t){this.createReplaceFileNode(t)},queryDownload:function(t){return!(this.json.events&&this.json.events.queryDownload&&this.json.events.queryDownload.code)||!1!==this.form.Macro.exec(this.json.events.queryDownload.code,t)},queryOpen:function(t){return!(this.json.events&&this.json.events.queryOpen&&this.json.events.queryOpen.code)||!1!==this.form.Macro.exec(this.json.events.queryOpen.code,t)},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],i=0;i<e.length;i++)if(t===e[i])return!0;return!1},downloadAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentStream(t.data.id,this.form.businessData.work.id),this.fireEvent("download",[t]))}.bind(this)):i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentStream(t.data.id,this.form.businessData.workCompleted.id),this.fireEvent("download",[t]))}.bind(this))},openAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentData(t.data.id,this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this)):i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentData(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this))},getAttachmentUrl:function(t,e){this.form.businessData.work&&!this.form.businessData.work.completedTime?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,e):this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,e)},getTextData:function(){var t=[];return this.attachmentController.attachments.each((function(e){var i={id:e.data.id,person:e.data.person,creatorUid:e.data.creatorUid,name:e.data.name,orderNumber:e.data.orderNumber,length:e.data.length,extension:e.data.extension,lastUpdateTime:e.data.lastUpdateTime,activityName:e.data.activityName,control:e.data.control};t.push(i)})),t},setData:function(t){this.attachmentController.clear(),(t||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;this.attachmentController.addAttachment(e)}.bind(this)),this.setAttachmentBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),o=i.getPrevious("div"),n=i.getChildren().indexOf(e.getParent("div"));o.getLast().getFirst().getChildren()[n].click(),e=o.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData()||[],o="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!o)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(e.prompt),!1;break;case"gt":if(o>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(o<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(o==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(o!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=o.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==o.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var o=this.json.validationConfig[i];if(!this.validationConfigItem(t,o))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.AttachmenPreview=new Class({Implements:[Options,Events],initialize:function(t,e){this.att=t,this.app=e,this.load()},load:function(){var t=this.att.data.extension;"ofd"===t&&"ie"!==Browser.name&&this.previewOfd(),"zip"===t&&this.previewZip(),"pdf"===t&&this.previewPdf(),["png","jpg","bmp","jpeg","gif"].contains(t)&&this.previewImage(),"js"===t&&this.previewAce("javascript"),"css"===t&&this.previewAce("css"),"java"===t&&this.previewAce("java"),"json"===t&&this.previewAce("json"),"xml"===t&&this.previewAce("xml"),"php"===t&&this.previewAce("php"),["html","htm","xhtml"].contains(t)&&this.previewAce("html"),["log","md","txt"].contains(t)&&this.previewAce("text")},previewZip:function(){var t=this,e=new Element("div",{text:"loadding..."});o2.load(["../o2_lib/jszip/jszip.min.js","../o2_lib/jszip/jszip-utils.min.js"],function(){this.app.getAttachmentUrl(this.att,function(i){o2.require("MWF.widget.Tree",function(){var i=o2.DL.open({title:t.att.data.name,width:"660px",height:"510px",mask:!0,content:e,container:null,positionNode:document.body,onQueryClose:function(){e.destroy()},buttonList:[{text:"关闭",action:function(){i.close()}}],onPostShow:function(){i.reCenter()},onPostLoad:function(){}})}.bind(this)),e.empty(),JSZipUtils.getBinaryContent(i,(function(i,o){JSZip.loadAsync(o).then((function(i){var o=[];i.forEach((function(t,e){o.push(e.name)}));var n=new MWF.widget.Tree(e,{style:"form"}),s=function(e){for(var i=[],o=0;o<e.length;o++)for(var n=e[o].split("/"),s=i,a=0;a<n.length&&""!==n[a];a++){for(var c=n[a],r=s,d=0;d<s.length;d++)if(s[d].name==c){s=s[d].sub;break}if(r==s){var h={key:e[o],name:c,title:c,text:c,sub:[]},l=s[d]=h;c.indexOf(".")>-1?(h.dir=!1,h.icon="file.png",delete h.sub):(h.dir=!0,h.expand=!1,s=l.sub)}else delete s.sub}var m=[],p={title:t.att.name,text:t.att.name,sub:[]};return i.each((function(t){p.sub.push(t)})),function t(e,i){var o=[];e.sub.each((function(t){t.dir&&o.push(t)})),e.sub.each((function(t){t.dir||o.push(t)})),o.each((function(e){var o={text:e.name,title:e.name,expand:!1};e.dir||(o.icon="file.png"),i.push(o),e.sub&&e.sub.length>0&&(o.sub=[],t(e,o.sub))}))}(p,m),m}(o);n.load(s)}))}))}.bind(this))}.bind(this))},previewPdf:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/pdfjs/web/viewer.html?file="+t)}))},previewOfd:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/ofdjs/index.html?file="+t)}))},previewImage:function(){this.app.getAttachmentUrl(this.att,function(t){var e=new Element("img",{src:t,alt:this.att.name}).inject(document.body).hide();o2.loadCss("../o2_lib/viewer/viewer.css",document.body,function(){o2.load("../o2_lib/viewer/viewer.js",function(){this.viewer=new Viewer(e,{navbar:!1,toolbar:!1,hidden:function(){e.destroy(),this.viewer.destroy()}.bind(this)}),this.viewer.show()}.bind(this))}.bind(this))}.bind(this))},previewAce:function(t){this.app.getAttachmentUrl(this.att,function(e){o2.require("o2.widget.ace",null,!1),new Request({url:e,method:"get",withCredentials:!0,onSuccess:function(e){var i=new Element("div",{style:"padding:10px"});i.set("text",e),o2.widget.ace.load(function(){o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js",function(){ace.require("ace/ext/static_highlight")(i,{mode:"ace/mode/"+t,theme:"ace/theme/tomorrow",fontSize:30,showLineNumbers:!0})}.bind(this))}.bind(this));var o=o2.DL.open({title:this.att.data.name,width:"960px",height:"610px",mask:!0,content:i,container:null,positionNode:document.body,onQueryClose:function(){i.destroy()}.bind(this),buttonList:[{text:"关闭",action:function(){o.close()}.bind(this)}],onPostShow:function(){o.reCenter()}.bind(this)})}.bind(this),onFailure:function(){console.log("text","Sorry, your request failed :(")}}).send()}.bind(this))}}),MWF.xApplication.process.Xform.AttachmentDg=MWF.APPAttachmentDg=new Class({Extends:MWF.APPAttachment,loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],ignoreSite:this.json.ignoreSite,onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.json.ignoreSite?(this._getBusinessData()||[]).each(function(t){this.form.businessData.attachmentList.some(function(e){return t.id===e.id}.bind(this))&&this.attachmentController.addAttachment(t)}.bind(this)):this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return{control:t.data.control,name:t.data.name,id:t.data.id,person:t.data.person,creatorUid:t.data.creatorUid,orderNumber:t.data.orderNumber,length:t.data.length,extension:t.data.extension,lastUpdateTime:t.data.lastUpdateTime,activityName:t.data.activityName}}));this._setBusinessData(t)}else this._setBusinessData([])}});