o2.widget=o2.widget||{},o2.widget.UUID||o2.require("o2.widget.UUID",null,!1),o2.widget.AttachmentController=o2.widget.ATTER=new Class({Extends:o2.widget.Common,Implements:[Options,Events],options:{style:"default",listStyle:"icon",size:"max",resize:!0,attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,isPreviewAtt:!0,isSizeChange:!0,readonly:!1,availableListStyles:["list","seq","icon","preview"],toolbarGroupHidden:[],images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"],actionShowText:!1},initialize:function(t,e,i){this.setOptions(i),this.pages=[],this.path=o2.session.path+"/widget/$AttachmentController/",this.cssPath=o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/css.wcss",this._loadCss();var s=this.options.iconConfigUrl?this.options.iconConfigUrl:"../x_component_File/$Main/icon.json";o2.getJSON(s,function(t){this.icons=t}.bind(this),!1,!1),this.module=e,this.actions=[],this.attachments=[],this.selectedAttachments=[],this.container=$(t)},load:function(){"min"===this.options.size?this.loadMin():this.loadMax()},reloadAttachments:function(){if("min"===this.options.size){this.minContent.empty();var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(e.data,this))}}else{this.content.empty();t=this.attachments;for(this.attachments=[];t.length;){e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}}this.checkActions()},getAttachmentById:function(t){for(var e=0;e<this.attachments.length;e++)if(this.attachments[e].data.id===t)return this.attachments[e];return null},loadMax:function(){this.node||(this.node=new Element("div",{styles:this.css.container})),this.createTopNode(),this.contentScrollNode?(this.contentScrollNode.setStyle("display","block"),this.bottomNode&&this.bottomNode.setStyle("display","block"),this.titleNode&&this.titleNode.setStyle("display","block"),this.content.empty()):(this.createContentNode(),this.options.resize&&(this.createBottomNode(),this.createResizeNode()),this.node.inject(this.container),this.checkActions(),this.setEvent());var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}this.checkActions()},loadMin:function(){this.node||(this.node=new Element("div",{styles:this.css.container_min})),this.minActionAreaNode?(this.minActionAreaNode.setStyle("display",""),this.minActionAreaNode.empty(),this.loadMinActions(),this.setEvent()):(this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node),this.loadMinActions(),this.node.inject(this.container),this.setEvent());var t=this.options.toolbarGroupHidden;t.contains("edit")&&t.contains("read")&&t.contains("view")&&this.minActionAreaNode.setStyle("display","none"),this.minContent?(this.minContent.setStyle("display","block"),this.minContent.empty()):(this.minContent=new Element("div",{styles:layout.mobile?this.css.minContentNode_mobile:this.css.minContentNode}).inject(this.node),layout.mobile&&this.minContent.setStyle("clear","both"));var e=this.attachments;for(this.attachments=[];e.length;){var i=e.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(i.data,this))}this.checkActions()},loadMobile:function(){},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",o2.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},setEvent:function(){this.contentScrollNode&&this.contentScrollNode.addEvents({mousedown:this.unSelectedAttachments.bind(this)}),this.minContent&&this.minContent.addEvents({mousedown:this.unSelectedAttachments.bind(this)})},resetToolbarGroupHidden:function(t){this.options.toolbarGroupHidden=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},resetToolbarAvailableListStyle:function(t){this.options.availableListStyles=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},createContentNode:function(){this.contentScrollNode=new Element("div.contentScrollNode",{styles:this.css.contentScrollNode}).inject(this.node),this.content=new Element("div.content",{styles:this.css.contentNode}).inject(this.contentScrollNode),o2.require("o2.widget.ScrollBar",function(){new o2.widget.ScrollBar(this.contentScrollNode,{style:"attachment",where:"before",distance:30,friction:4,axis:{x:!1,y:!0}})}.bind(this))},createBottomNode:function(){this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.node)},createResizeNode:function(){this.resizeNode=new Element("div",{styles:this.css.resizeNode}).inject(this.bottomNode),this.resizeDrag=new Drag(this.resizeNode,{snap:"2",onStart:function(t,e){t.store("startY",e.event.y),t.store("nodeHeight",this.node.getSize().y);var i=this.node.getStyle("min-height");t.store("nodeMinHeight",i?i.toFloat():"");var s=this.contentScrollNode.getStyle("min-height");t.store("contentScrollNodeMinHeight",s?s.toFloat():""),this.nodeHeight||(this.nodeHeight=i.toFloat())}.bind(this),onDrag:function(t,e){var i=t.retrieve("startY"),s=t.retrieve("nodeHeight"),o=t.retrieve("nodeMinHeight"),n=t.retrieve("contentScrollNodeMinHeight"),a=e.event.y-i+s;if(!(o&&a<o&&e.event.y<i)){a<this.nodeHeight&&(a=this.nodeHeight);var r=a-81;n&&r<n&&e.event.y<i||(this.node.setStyle("height",a+"px"),this.contentScrollNode.setStyle("height",r+"px"))}}.bind(this)})},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;if(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view"))return this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),void(this.isHiddenTop=!0);t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),t.contains("view")||this.createViewGroupActions()},reloadTopNode:function(){this.createTopNode()},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createReadGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.downloadAction=this.createAction(this.editActionsGroupNode,"download",o2.LP.widget.download,function(){this.downloadAttachment()}.bind(this))},createListGroupActions:function(){var t=this.options.availableListStyles;t&&t.length>0&&(this.listActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.listActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.listActionBoxNode),t.contains("list")&&(this.listAction=this.createAction(this.listActionsGroupNode,"list",o2.LP.widget.list,function(){this.changeListStyle("list")}.bind(this))),t.contains("seq")&&(this.sequenceAction=this.createAction(this.listActionsGroupNode,"seq",o2.LP.widget.sequence,function(){this.changeListStyle("sequence")}.bind(this))),t.contains("icon")&&(this.iconAction=this.createAction(this.listActionsGroupNode,"icon",o2.LP.widget.icon,function(){this.changeListStyle("icon")}.bind(this))),t.contains("preview")&&(this.previewAction=this.createAction(this.listActionsGroupNode,"preview",o2.LP.widget.preview,function(){this.changeListStyle("preview")}.bind(this))))},createViewGroupActions:function(){this.options.isSizeChange&&(this.viewActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.viewActionBoxNode.setStyles({float:"right","margin-right":"7px"}),this.viewActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.viewActionBoxNode),this.sizeAction=this.createAction(this.viewActionsGroupNode,"min",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this)))},createSeparate:function(t){return new Element("div.separateNode",{styles:this.css.separateNode}).inject(t)},createAction:function(t,e,i,s){var o=new Element("div",{styles:this.css.actionNode,title:i}).inject(t);new Element("div",{styles:this.css.actionIconNode}).inject(o).setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/icon/"+e+".png)");var n=this;return o.addEvents({mouseover:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+n.options.style+"/overbg.png)")},mouseout:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","transparent")},click:function(t){this.retrieve("disabled")||n.doAction(t,this,s),t.stopPropagation()}}),this.actions.push(o),o},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkListStyleAction()},checkUploadAction:function(){if(this.options.readonly)return this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction),!1;this.options.isUpload?0!=this.options.attachmentCount&&this.attachments.length>=this.options.attachmentCount?(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction)):(this.setActionEnabled(this.uploadAction),this.setActionEnabled(this.min_uploadAction)):(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction))},checkDeleteAction:function(){if(this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1),!1;this.options.isDelete?(this.selectedAttachments.length?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)),this.setAttachmentsAction("delete",!0)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1))},isAttDeleteAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isDelete)},checkReplaceAction:function(){if(!this.options.isReplaceHidden)return this.options.readonly?(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1),!1):void(this.options.isReplace?(this.selectedAttachments.length&&1==this.selectedAttachments.length?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)),this.setAttachmentsAction("replace",!0)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1)))},isAttReplaceAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isReplace)},checkDownloadAction:function(){this.options.isDownload?(this.selectedAttachments.length?(this.setActionEnabled(this.downloadAction),this.setActionEnabled(this.min_downloadAction)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction)),this.setActionEnabled(this.downloadAllAction),this.setAttachmentsAction("download",!0)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction),this.setActionDisabled(this.downloadAllAction),this.setAttachmentsAction("download",!1))},isAttDownloadAvailable:function(t){return!this.options.toolbarGroupHidden.contains("read")&&this.options.isDownload},checkSizeAction:function(){this.sizeAction&&(this.options.isSizeChange?this.setActionEnabled(this.sizeAction):this.setActionDisabled(this.sizeAction))},checkListStyleAction:function(){switch(this.options.listStyle){case"list":this.setActionSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"icon":this.setActionUnSelcted(this.listAction),this.setActionSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"preview":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"sequence":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionSelcted(this.sequenceAction)}},setActionSelcted:function(t){t&&(t.retrieve("selected")||(t.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)"),t.store("selected",!0)))},setActionUnSelcted:function(t){t&&t.retrieve("selected")&&(t.setStyle("background",""),t.store("selected",!1))},setActionEnabled:function(t){if(t&&t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("_gray"))+"."+s,e.setStyle("background-image",i),t.store("disabled",!1)}},setActionDisabled:function(t){if(t&&!t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("."))+"_gray."+s,e.setStyle("background-image",i),t.store("disabled",!0)}},setReadonly:function(){this.actions.each(function(t){this.setActionDisabled(t),this.setAttachmentsAction("all",!1)}.bind(this))},setAttachmentsAction:function(t,e){this.attachments.each(function(i){this.setAttachmentAction(i,t,e)}.bind(this))},setAttachmentAction:function(t,e,i){var s;if("all"===e)(t.actions||[]).each((function(e){t[i?"setActionEnabled":"setActionDisabled"](e)}));else{switch(e){case"download":s=t.downloadAction;break;case"config":s=t.configAction;break;case"delete":s=t.deleteAction;break;case"replace":s=t.replaceAction}if(!s)return;if("config"===e){var o=i;if(o){var n=layout.session.user.distinguishedName;!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===n||(o=!1)}t[o?"setActionEnabled":"setActionDisabled"](s)}else t[i?"setActionEnabled":"setActionDisabled"](s)}},doAction:function(t,e,i){i&&i.apply(this,[t,e])},uploadAttachment:function(t,e){this.module&&this.module.uploadAttachment(t,e)},doUploadAttachment:function(t,e,i,s,o,n,a,r,l,h,d){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,a,r,l,h,d):this.doFormDataUploadAttachment(t,e,i,s,o,n,a,r,l,h,d)},addUploadMessage:function(t){var e;e='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px"><div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+o2.LP.desktop.action.uploadTitle+"</div></div><iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:o2.LP.desktop.action.uploadTitle,content:t+"<br/>"+e};if(layout.desktop.message){var s=layout.desktop.message.addMessage(i);s.close=function(t,e){s.completed&&s.closeItem(t,e)}}return window.setTimeout(function(){layout.desktop.message&&(layout.desktop.message.isShow||layout.desktop.message.show())}.bind(this),300),s},setMessageTitle:function(t,e){t&&t.subjectNode.set("text",e)},setMessageText:function(t,e){if(t){t.contentNode.getFirst("div").getFirst("div").getFirst("div");t.contentNode.getFirst("div").getLast("div").set("text",e),t.dateNode.set("text",(new Date).format("db"))}},doInputUploadAttachment:function(t,e,i,s,o,n,a,r,l,h){var d=e;"string"==typeOf(e)&&(d=o2.Actions.get(e).action),d.getActions(function(){var e=d.actions[i];e=d.address+e.uri,Object.each(s,(function(t,i){e=e.replace("{"+i+"}",t)}));var r=this.module.content;r||this.module.form&&(r=this.module.form.app.content),r||(r=this.node),r&&r.mask({style:{opacity:.7,"background-color":"#999"}}),this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container),this.inputUploadAreaNode.position({relativeTo:this.module.content,position:"center"});var l=null;document.O2UploadCallbackFun=function(t){var e=JSON.decode(t);l.completed=!0,"success"===e.type?(n&&n(e.data),this.setMessageTitle(l,o2.LP.desktop.action.uploadComplete),this.setMessageText(l,o2.LP.desktop.action.uploadComplete),o&&o()):(this.setMessageTitle(l,o2.LP.desktop.action.sendError),this.setMessageText(l,o2.LP.desktop.action.sendError+": "+e.message),o2.xDesktop.notice("error",{x:"right",y:"top"},e.message))}.bind(this);var h=new Element("form",{method:"POST",action:e+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode),c=(new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:o2.LP.widget.uploadTitle}).inject(h),new Element("div",{styles:this.css.inputUploadAreaInforNode,text:o2.LP.widget.uploadInfor}).inject(h),new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(h)),u=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(c),p=new Element("input",{type:"hidden",name:"fileName"}).inject(c);Object.each(t,(function(t,e){new Element("input",{type:"hidden",name:e,value:t}).inject(c)}));var f=new Element("div",{styles:this.css.inputUploadActionNode}).inject(h),m=new Element("button",{styles:this.css.inputUploadCancelButton,text:o2.LP.widget.cancel}).inject(f),g=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:o2.LP.widget.ok}).inject(f);u.addEvent("change",function(){var t=u.get("value");if(t){var e=t.replace(/\\/g,"/"),i=e.lastIndexOf("/"),s=-1===i?e:e.substr(i+1,e.length-i);p.set("value",s)}}.bind(this)),m.addEvent("click",function(){r&&r.unmask(),this.inputUploadAreaNode.destroy()}.bind(this)),g.addEvent("click",function(){h.mask({style:{opacity:.7,"background-color":"#999"}});var t=!0;a&&(t=a([p.get("value")])),t&&(l=this.addUploadMessage(p.get("value")),h.submit(),r&&r.unmask(),this.inputUploadAreaNode&&this.inputUploadAreaNode.destroy())}.bind(this))}.bind(this))},doFormDataUploadAttachment:function(t,e,i,s,o,n,a,r,l,h,d){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" multiple type="file" accept="*/*"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var r=this.fileUploadNode.files;if(r.length){var c=r.length,u=0,p=!1,f=e;"string"==typeOf(e)&&(f=o2.Actions.get(e).action);var m=function(){u==c&&o&&o(p)},g=!0;if(a&&(g=a(r)),g)for(var y=l?l.split(o2.splitStr):null,b=0;b<r.length;b++){var v=r.item(b),x=v.name.substr(v.name.lastIndexOf("."),v.name.length);if(x=x.toLowerCase(),y&&-1===y.indexOf(x)&&-1===y.indexOf("*")&&-1===y.indexOf("*/*")){var w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML.replace("{filename}",v.name)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);var A=o2.LP.widget.refuseUploadNotice.replace("{filename}",v.name);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},A,this.node)}else if(h&&v.size>1024*h*1024){w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML_size.replace("{filename}",v.name).replace("{size}",h)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);A=o2.LP.widget.refuseUploadNotice_size.replace("{filename}",v.name).replace("{size}",h);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},A,this.node)}else{var j=new FormData;Object.each(t,(function(t,e){j.append(e,t)})),j.append("file",v),s.fileMd5?o2.load("../o2_lib/CryptoJS/components/spark-md5-min.js",function(){var t=new FileReader,e=(document.getElementById("box"),File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice),o=Math.ceil(v.size/20971520),a=0,r=new SparkMD5;function l(){var i=20971520*a,s=i+20971520>=v.size?v.size:i+20971520;t.readAsBinaryString(e.call(v,i,s))}t.onload=function(t){if(console.log("read chunk nr",a+1,"of",o),r.appendBinary(t.target.result),++a<o)l();else{console.log("finished loading");var e=r.end();f.invoke({name:"checkFileExist",async:!0,parameter:{fileMd5:e},success:function(t){if(t.data.value){var o=new FormData;o.append("fileMd5",e),o.append("fileName",v.name),f.invoke({name:"addAttachmentMd5",async:!0,data:o,parameter:s,success:function(t){u++,n&&n(t,u,c),m()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,d&&d(t,u,c),m()}})}else f.invoke({name:i,async:!0,data:j,file:v,parameter:s,success:function(t){u++,n&&n(t,u,c),m()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,d&&d(t,u,c),m()}})}})}},l()}.bind(this),null,!1):(f.targetModule={module:this,file:v},f.invoke({name:i,async:!0,data:j,file:v,parameter:s,success:function(t){u++,n&&n(t,u,c),m()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),u++,p=!0,d&&d(t,u,c),m()}}))}}this.uploadFileAreaNode.destroy(),this.uploadFileAreaNode=null}}.bind(this))}this.fileUploadNode.set("accept",l||"*/*"),this.fileUploadNode.set("multiple",!1!==r),this.fileUploadNode.click()},addFormDataMessage:function(t){return this.addAttachmentMessage(t)},addAttachmentMessage:function(t){var e;return e="min"==this.options.size?new o2.widget.AttachmentController.AttachmentMessageMin(t,this):new o2.widget.AttachmentController.AttachmentMessage(t,this),this.messageItemList||(this.messageItemList={}),this.messageItemList[e.data.id]=e,e},openInOfficeControl:function(t,e){},deleteAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.deleteAttachments(t,e,this.selectedAttachments)},replaceAttachment:function(t,e){this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},doReplaceAttachment:function(t,e,i,s,o,n,a,a,r){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,a,a,r):this.doFormDataUploadAttachment(t,e,i,s,o,n,a,a,r)},previewAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.previewAttachment(this.selectedAttachments)},downloadAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.downloadAttachment(t,e,this.selectedAttachments)},openAttachment:function(t,e,i){this.options.isDownload&&i&&this.module&&this.module.openAttachment(t,e,i)},downloadAllAttachment:function(t,e){this.module&&this.module.downloadAttachment(t,e,this.attachments)},changeListStyle:function(t){this.options.listStyle=t,this.attachments.each(function(e){e.changeListStyle(t)}.bind(this)),this.checkListStyleAction()},changeControllerSize:function(t,e){"max"==this.options.size?this.changeControllerSizeToMin():this.changeControllerSizeToMax()},changeControllerSizeToMin:function(){"min"!=this.options.size&&(this.contentScrollNode&&this.contentScrollNode.setStyle("display","none"),this.bottomNode&&this.bottomNode.setStyle("display","none"),this.topNode&&this.topNode.setStyle("display","none"),this.titleNode&&this.titleNode.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container_min).chain(function(){this.options.size="min",this.loadMin()}.bind(this)))},changeControllerSizeToMax:function(){"max"!=this.options.size&&(this.minActionAreaNode&&this.minActionAreaNode.setStyle("display","none"),this.minContent&&this.minContent.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container).chain(function(){this.options.size="max",this.loadMax()}.bind(this)))},getAttachmentNames:function(){var t=[];return this.attachments.each((function(e){t.push(e.data.name)})),t},addAttachment:function(t,e,i){"min"==this.options.size?this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(t,this,e,i)):this.attachments.push(new o2.widget.AttachmentController.Attachment(t,this,e,i)),this.checkActions()},removeAttachment:function(t){this.attachments.erase(t),this.selectedAttachments.erase(t),t.node.destroy(),delete t},unSelectedAttachments:function(){for(;this.selectedAttachments.length;){this.selectedAttachments.shift().unSelected()}this.checkActions()},clear:function(){this.selectedAttachments=[],this.attachments.each((function(t){t.node.destroy(),o2.release(t)})),this.attachments=[];var t=this.minContent||this.content;t&&t.empty()}}),o2.widget.AttachmentController.Attachment=new Class({Implements:[Events],initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.isCheckPosition=s,this.actions=[],i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},_getLnkPar:function(t){return{icon:this.getIcon(),title:this.data.name,par:"@url#"+t}},isNumber:function(t){return"NaN"!==parseFloat(t).toString()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.controller.module.getAttachmentUrl(this,function(t){this.node.makeLnk({par:this._getLnkPar(t)})}.bind(this)),this.createInforNode(function(){Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"}))}.bind(this)),this.setEvent()},createInforNode:function(t){var e="",i=this.data.length/1024;if(i>1024){var s=i/1024;e=(s=Math.round(100*s)/100)+"M"}else e=(i=Math.round(100*i)/100)+"K";this.inforNode=new Element("div",{styles:this.css.attachmentInforNode});var o="<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.person||this.data.creatorUid)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName||o2.LP.widget.unknow)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+e+"</div></div>",this.inforNode.set("html",o),t&&t()},getIcon:function(){this.data.extension||(this.data.extension="unkonw");var t=this.controller.icons[this.data.extension.toLowerCase()]||this.controller.icons.unknow;return(this.controller.options.iconFolderUrl?this.controller.options.iconFolderUrl:"../x_component_File/$Main/default/file/")+t},loadList:function(){this.node.setStyles(this.css.attachmentNode_list),this.isSelected&&this.node.setStyles(this.css.attachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_list}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_List()},custom_List:function(){},loadSequence:function(){this.node.setStyles(this.css.attachmentNode_sequence),this.isSelected&&this.node.setStyles(this.css.attachmentNode_sequence_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_sequence}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_Sequence()},custom_Sequence:function(){},loadIcon:function(){this.node.setStyles(this.css.attachmentNode_icon),this.isSelected&&this.node.setStyles(this.css.attachmentNode_icon_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.custom_Icon()},custom_Icon:function(){},loadPreview:function(){this.node.setStyles(this.css.attachmentNode_preview),this.isSelected&&this.node.setStyles(this.css.attachmentNode_preview_selected),this.iconNode=new Element("div",{styles:this.css.attachmentPreviewIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);var t=this.getIcon();-1!==this.controller.options.images.indexOf(this.data.extension.toLowerCase())?(this.controller.module.getAttachmentUrl(this,function(e){t=e,this.getPreviewImgSize(t,function(e){this.iconImgNode.set({src:t,border:0}),this.iconImgAreaNode.setStyles({width:e.x+"px",height:e.y+"px"}),this.iconImgNode.setStyles({width:e.x+"px",height:e.y+"px","margin-top":e.top+"px"}),window.setTimeout(function(){this.getPreviewImgSize(t,function(t){this.iconImgAreaNode&&this.iconImgAreaNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.iconImgNode&&this.iconImgNode.setStyles({width:t.x+"px",height:t.y+"px","margin-top":t.top+"px"})}.bind(this))}.bind(this),100)}.bind(this))}.bind(this)),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)):-1!==this.controller.options.audios.indexOf(this.data.extension.toLowerCase())?(this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.controller.module.getAttachmentUrl(this,function(e){this.iconImgNode.set({src:t,border:0}),this.iconAudioNode=new Element("div",{styles:this.css.attachmentPreviewAudioNode,html:'<audio preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+e+'" type="audio/mpeg"></source></audio>'}).inject(this.textNode,"after"),this.iconAudioNode.addEvent("dblclick",(function(t){t.stopPropagation()}))}.bind(this))):-1!==this.controller.options.videos.indexOf(this.data.extension.toLowerCase())?this.controller.module.getAttachmentUrl(this,function(t){this.iconNode.empty(),this.iconVideoNode=new Element("div",{styles:this.css.attachmentPreviewVideoNode,html:'<video preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+t+'"></source></video>'}).inject(this.iconNode),this.iconVideoNode.addEvent("dblclick",(function(t){t.stopPropagation()})),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)}.bind(this)):(this.iconImgNode.set({src:t,border:0}),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)),this.custom_Preview()},custom_Preview:function(){},getPreviewImgSize:function(t,e){var i=this.iconNode.getSize(),s=new Element("img",{src:t}).inject($(document.body));s.set("src",t);var o,n=s.getSize();s.destroy();var a,r=i.x/n.x;(a=n.y*r)<=i.y?o=i.x:(r=i.y/n.y,o=n.x*r,a=i.y);n={x:o,y:a,top:(i.y-a)/2};e&&e(n)},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]),this.controller.selectedAttachments.erase(this)},changeListStyle:function(t){if(this.listStyle!=t){switch(this.node.empty(),t){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.listStyle=t}},reload:function(){var t=new Element("div").inject(this.node,"after");switch(this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},openAttachment:function(t){this.controller.options.isDownload&&this.controller.module&&this.controller.module.openAttachment(t,null,[this])},setActionEnabled:function(t){t&&(t.setStyle("display",""),t.store("disabled",!1))},setActionDisabled:function(t){t&&(t.setStyle("display","none"),t.store("disabled",!0))},createAction:function(t,e,i,s,o,n){var a;if(this.controller.options.actionShowText){a=new Element("div",{styles:this.controller.css.minActionNode,text:n||s,title:s}).inject(t);var r=this;a.addEvents({mouseover:function(t){!this.actionNode.retrieve("disabled")&&r.controller.css.minActionNode_over&&a.setStyles(r.controller.css.minActionNode_over)}.bind({actionNode:a}),mouseout:function(){!this.actionNode.retrieve("disabled")&&r.controller.css.minActionNode_over&&a.setStyles(r.controller.css.minActionNode)}.bind({actionNode:a}),click:function(t){this.retrieve("disabled")||(o.apply(r.controller,[t,this]),t.stopPropagation())}})}else{a=new Element("div",{styles:this.controller.css.minActionNode,title:s}).inject(t);var l=new Element("div",{styles:this.controller.css.minActionIconNode}).inject(a);l.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.controller.options.style+"/icon/"+e+".png)");r=this;a.addEvents({mouseover:function(t){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+r.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:a,actionIconNode:l,img:i}),mouseout:function(){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+r.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:a,actionIconNode:l,img:e}),click:function(t){this.retrieve("disabled")||(o.apply(r.controller,[t,this]),t.stopPropagation())}})}return this.actions||(this.actions=[]),this.actions.push(a),a}}),o2.widget.AttachmentController.AttachmentMin=new Class({Extends:o2.widget.AttachmentController.Attachment,initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.content=this.controller.minContent,this.isSelected=!1,this.isCheckPosition=s,this.seq=this.controller.attachments.length+1,i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||layout.mobile||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.iconImgNode,transition:"flyin"})),this.setEvent()},loadList:function(){this.node.setStyles(layout.mobile?this.css.minAttachmentNode_list_mobile:this.css.minAttachmentNode_list),layout.mobile||(this.sepNode=new Element("div",{styles:this.css.minAttachmentSepNode_list}).inject(this.node)),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",o2.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this),o2.LP.widget.configAttachmentText)),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）"),this.node.set("title",this.data.name+"（"+t+"）")},loadSequence:function(){this.node.setStyles(this.css.minAttachmentNode_sequence),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",MWF.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this))),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）")},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_over"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"]))}.bind(this),mouseout:function(){if(!this.isSelected)if("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_selected"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},reload:function(){var t=new Element("div").inject(this.node,"after");this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.loadList(),this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},unSelected:function(){if(this.isSelected=!1,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);this.controller.selectedAttachments.erase(this)}}),o2.widget.AttachmentController.AttachmentMessage=new Class({Extends:o2.widget.AttachmentController.Attachment,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}}),o2.widget.AttachmentController.AttachmentMessageMin=new Class({Extends:o2.widget.AttachmentController.AttachmentMin,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.minContent,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}}),MWF.xScript=MWF.xScript||{},MWF.xScript.Macro=MWF.Macro={swapSpace:{},scriptSpace:{},expression:function(t,e){},runEvent:function(t,e,i){},exec:function(t,e){var i;e||(e=window);for(var s=0,o="f_"+s;MWF.Macro.scriptSpace[o];)o="f_"+ ++s;if(o2.session.isDebugger){var n='MWF.Macro.scriptSpace["'+o+'"] = function(){\n'+t+"\n}";Browser.exec(n),i=o2.Macro.scriptSpace[o]?o2.Macro.scriptSpace[o].apply(e):null}else{n='MWF.Macro.scriptSpace["'+o+'"] = function(){try{\n'+t+"\n}catch(e){console.error(e)}}";Browser.exec(n),i=o2.Macro.scriptSpace[o]?o2.Macro.scriptSpace[o].apply(e):null}return o2.Macro.scriptSpace[o]=null,i}},MWF.Macro,MWF.Macro.FormContext=new Class({macroFunction:null,environment:{},initialize:function(t){this.form=t;var e={form:t,forms:t.forms,all:t.all,data:t.businessData.data,work:t.businessData.work,workCompleted:t.businessData.workCompleted,taskList:t.businessData.taskList,readList:t.businessData.readList,control:t.businessData.control,activity:t.businessData.activity,task:t.businessData.task,taskCompletedList:t.businessData.taskCompletedList,workLogList:t.businessData.workLogList,recordList:t.businessData.recordList,attachmentList:t.businessData.attachmentList,inheritedAttachmentList:t.businessData.inheritedAttachmentList,formInfor:t.businessData.formInfor,status:t.businessData.status,target:null,event:null};MWF.require("MWF.xScript.Environment",null,!1),this.environment=new MWF.xScript.Environment(e)},setTarget:function(t){this.environment.target=t||null},setEvent:function(t){this.environment.event=t||null},exec:function(t,e){return this.setTarget(e),MWF.Macro.exec(t,this.environment)},fire:function(t,e,i){return this.setTarget(e),this.setEvent(i),MWF.Macro.exec(t,this.environment)}}),MWF.Macro.PageContext=new Class({macroFunction:null,environment:{},initialize:function(t){this.form=t;var e={form:t,forms:t.forms,all:t.all,data:t.businessData.data,status:t.businessData.status,pageInfor:t.businessData.pageInfor,target:null,event:null};MWF.require("MWF.xScript.PageEnvironment",null,!1),this.environment=new MWF.xScript.PageEnvironment(e)},setTarget:function(t){this.environment.target=t||null},setEvent:function(t){this.environment.event=t||null},exec:function(t,e){return this.setTarget(e),MWF.Macro.exec(t,this.environment)},fire:function(t,e,i){return this.setTarget(e),this.setEvent(i),MWF.Macro.exec(t,this.environment)}}),MWF.Macro.ViewContext||(MWF.Macro.ViewContext=new Class({macroFunction:null,environment:{},initialize:function(t){this.form=t;var e={view:t,viewInfor:t.viewInfor,target:null,event:null};MWF.require("MWF.xScript.ViewEnvironment",null,!1),this.environment=new MWF.xScript.ViewEnvironment(e)},setTarget:function(t){this.environment.target=t||null},setEvent:function(t){this.environment.event=t||null},exec:function(t,e){return this.setTarget(e),MWF.Macro.exec(t,this.environment)},fire:function(t,e,i){return this.setTarget(e),this.setEvent(i),MWF.Macro.exec(t,this.environment)}})),JSONObject=function(t){},o2.widget=o2.widget||{},o2.widget.Tab=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default"},initialize:function(t,e){this.setOptions(e),this.pages=[],this.path=o2.session.path+"/widget/$Tab/",this.cssPath=o2.session.path+"/widget/$Tab/"+this.options.style+"/css.wcss",this._loadCss(),this.css=Object.clone(this.css),this.showPage=null,this.node=$(t)},load:function(){this.fireEvent("queryLoad")&&(this.tabNodeContainer||(this.tabNodeContainer=new Element("div")),this.tabNodeContainer.set("styles",this.css.tabNodeContainer),this.tabNodeContainer.inject(this.node),this.tabNodeContainerRight||(this.tabNodeContainerRight=new Element("div.tabNodeContainerRight")),this.tabNodeContainerRight.set("styles",this.css.tabNodeContainerRight),this.tabNodeContainerRight.inject(this.tabNodeContainer),this.tabNodeContainerLeft||(this.tabNodeContainerLeft=new Element("div.tabNodeContainerLeft")),this.tabNodeContainerLeft.set("styles",this.css.tabNodeContainerLeft),this.tabNodeContainerLeft.inject(this.tabNodeContainer),this.tabNodeContainerArea||(this.tabNodeContainerArea=new Element("div.tabNodeContainerArea")),this.tabNodeContainerArea.set("styles",this.css.tabNodeContainerArea),this.tabNodeContainerArea.inject(this.tabNodeContainerLeft),this.contentNodeContainer||(this.contentNodeContainer=new Element("div")),this.contentNodeContainer.set("name","MWFcontentNodeContainer"),this.contentNodeContainer.set("styles",this.css.contentNodeContainer),this.contentNodeContainer.inject(this.node),this.tabNodeContainerRight.addEvents({mouseover:function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight_over)}.bind(this),mouseout:function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight)}.bind(this)}),o2.require("o2.xDesktop.Menu",function(){this.tabMenu=new o2.xDesktop.Menu(this.tabNodeContainerRight,{style:"tab",event:"click",container:this.tabNodeContainerRight,where:{x:"right",y:"bottom"},onQueryShow:function(){this.loadOverMenu()}.bind(this)}),this.tabMenu.load()}.bind(this)),this.tabNodeContainerRight.hide(),this.fireEvent("postLoad"))},rebuildTab:function(t,e,i){var s=new o2.widget.TabPage(e,"",this,{isClose:!1});return s.contentNodeArea=t,s.tabNode=i,s.textNode=i.getFirst(),s.closeNode=s.textNode.getFirst(),s.options.title=s.textNode.get("text"),s.load(),this.pages.push(s),s},addTab:function(t,e,i,s){var o=new o2.widget.TabPage(t,e,this,{isClose:i,tabNode:s});return o.load(),this.pages.push(o),o},loadOverMenu:function(t){this.tabMenu.clearItems();for(var e=this,i=this.showTabIndex;i<this.pages.length;i++){var s=this.pages[i];this.tabMenu.addMenuItem(s.options.title||s.tabNode.get("text"),"click",(function(){e.showOverPage(this)})).tabPage=s}},showOverPage:function(t){var e=t.tabPage;e&&(this.pages.erase(e),this.pages.unshift(e),e.tabNode.inject(this.tabNodeContainerArea,"top"),e.showTabIm(),this.resize())},resize:function(){for(var t=this.tabNodeContainerLeft.getSize(),e=0,i=0;i<this.pages.length;i++){if((e+=this.pages[i].tabNode.getSize().x)>t.x)break}this.showTabIndex=i,e>t.x&&i<this.pages.length?this.tabNodeContainerRight.show():this.tabNodeContainerRight.hide()}}),o2.widget.TabPage=new Class({Implements:[Options,Events],options:{isClose:!0,tabNode:null,title:""},initialize:function(t,e,i,s){this.setOptions(s),this.options.title=e,this.tab=i,this.contentNode=$(t)},load:function(){this.contentNodeArea||(this.contentNodeArea=new Element("div")),this.contentNodeArea.set("styles",this.tab.css.contentNodeArea),this.tabNode||(this.tabNode=new Element("div")),this.tabNode.set("styles",this.tab.css.tabNode),this.tabNode.addEvent("mousedown",(function(t){t.stop()})),this.textNode||(this.textNode=new Element("div").inject(this.tabNode)),this.textNode.set({styles:this.tab.css.tabTextNode,text:this.options.title}),this.tabNode.addEvent("click",this._showTab.bind(this)),this.options.isClose&&(this.closeNode||(this.closeNode=new Element("div").inject(this.tabNode)),this.closeNode.set({styles:this.tab.css.tabCloseNode}),this.closeNode.addEvent("click",this.closeTab.bind(this))),this.contentNodeArea.inject(this.tab.contentNodeContainer),this.tabNode.inject(this.tab.tabNodeContainerArea),this.contentNode.inject(this.contentNodeArea),this.tab.resize()},_showTab:function(){this.showTabIm()},showTabIm:function(t){this.isShow||(this.tab.pages.each((function(t){t.isShow&&t.hideIm()})),this.showIm(t))},showTab:function(t){this.isShow||(this.tab.pages.each((function(t){t.isShow&&t.hide()})),this.show(t))},showIm:function(t){this.fireEvent("queryShow"),this.tabNode.setStyle("display",""),this.tabNode.set("styles",this.tab.css.tabNodeCurrent),this.textNode.set("styles",this.tab.css.tabTextNodeCurrent),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNodeCurrent),this.contentNodeArea.setStyle("display","block"),this.contentNodeArea.setStyle("opacity",1),this.isShow=!0,this.tab.showPage=this,t&&t(),this.fireEvent("show"),this.fireEvent("postShow")},show:function(t){this.fireEvent("queryShow"),this.tabNode.setStyle("display",""),this.tabNode.set("styles",this.tab.css.tabNodeCurrent),this.textNode.set("styles",this.tab.css.tabTextNodeCurrent),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNodeCurrent),this.contentNodeArea.setStyle("display","block"),this.contentNodeArea.setStyle("opacity",1),this.morph||(this.morph=new Fx.Morph(this.contentNodeArea,{duration:100})),this.morph.start({opacity:1}).chain(function(){this.isShow=!0,this.tab.showPage=this,t&&t(),this.fireEvent("postShow")}.bind(this)),this.fireEvent("show")},hideIm:function(){this.isShow&&(this.fireEvent("queryHide"),this.tabNode.set("styles",this.tab.css.tabNode),this.textNode.set("styles",this.tab.css.tabTextNode),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNode),this.contentNodeArea.setStyle("display","none"),this.contentNodeArea.setStyle("opacity",0),this.isShow=!1,this.fireEvent("hide"),this.fireEvent("postHide"))},hide:function(){this.isShow&&(this.fireEvent("queryHide"),this.tabNode.set("styles",this.tab.css.tabNode),this.textNode.set("styles",this.tab.css.tabTextNode),this.closeNode&&this.closeNode.set("styles",this.tab.css.tabCloseNode),this.morph||(this.morph=new Fx.Morph(this.contentNodeArea,{duration:100})),this.morph.start({opacity:0}).chain(function(){this.contentNodeArea.setStyle("display","none"),this.isShow=!1,this.fireEvent("postHide")}.bind(this)),this.fireEvent("hide"))},enableTab:function(t){this.disabled=!1,t?this.tabNode.show():this.showTab()},disableTab:function(t){this.disabled=!0,this.hideTab(t)},hideTab:function(t){this.fireEvent("queryHide"),this.tabNode.hide(),this.contentNodeArea.hide();if(!t){var e=this.getPrevPage();if(e&&!e.disabled)e.showTab();else if(this.tab.pages.length)for(var i=0;i<this.tab.pages.length;i++){var s=this.tab.pages[i];if(!s.disabled){s.showTab();break}}}this.isShow=!1,this.fireEvent("hide")},closeTab:function(){this.fireEvent("queryClose");var t=this.getPrevPage();this.contentNodeArea.destroy(),this.tabNode.destroy();if(this.tab.pages=this.tab.pages.erase(this),t&&!t.disabled)t.showTab();else if(this.tab.pages.length)for(var e=0;e<this.tab.pages.length;e++){var i=this.tab.pages[e];if(!i.disabled){i.showTab();break}}this.fireEvent("close")},getPrevPage:function(){var t=this.tab.pages.indexOf(this)-1;return t<0?null:this.tab.pages[t]}}),o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.xDesktop.Common",null,!1),o2.require("o2.xDesktop.Actions.RestActions",null,!1),o2.widget.O2Identity=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",canRemove:!1,lazy:!1,disableInfor:!1},initialize:function(t,e,i){this.setOptions(i),this.loadedInfor=!1,this.path=o2.session.path+"/widget/$O2Identity/",this.cssPath=o2.session.path+"/widget/$O2Identity/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(e),this.data=t,this.style=this.css,this.action=new o2.xDesktop.Actions.RestActions("","x_organization_assemble_control","x_component_Org"),this.load()},setText:function(){var t;if(this.data.displayName)t=this.data.displayName;else{var e,i=this.data.name||o2.name.cn(this.data.distinguishedName);if(this.data.unitName)e=this.data.unitName;else if(this.data.unitLevelName){var s=this.data.unitLevelName.split("/");e=s[s.length-1]}t=i+(e?"("+e+")":"")}this.node.set("text",this.data.displayName||t)},load:function(){var t=layout.mobile&&this.style.identityNode_mobile?this.style.identityNode_mobile:this.style.identityNode;this.options.lazy||this.options.disableInfor||this.getPersonData(),this.node=new Element("div",{styles:t}).inject(this.container),this.setText(),this.options.canRemove&&(this.removeNode=new Element("div",{styles:this.style.identityRemoveNode}).inject(this.node),this.removeNode.addEvent("click",function(t){this.fireEvent("remove",[this,t]),t.stopPropagation()}.bind(this))),this.options.disableInfor||layout.mobile||(this.options.lazy?this.node.addEvents({mouseover:function(){this.loadedInfor||(this.getPersonData(),this.createInforNode(function(){this.fireEvent("loadedInfor",[this])}.bind(this)))}.bind(this)}):this.createInforNode(function(){this.fireEvent("loadedInfor",[this])}.bind(this))),this.setEvent(),layout.mobile||this.node.addEvents({mouseover:function(){this.node.setStyles(this.style.identityNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.style.identityNode)}.bind(this)})},setEvent:function(){this.open&&this.node.addEvents({click:function(t){this.open(t),t.stopPropagation()}.bind(this)})},getPersonData:function(){if(!this.data.dutys){var t=o2.Actions.get("x_organization_assemble_control"),e=this.data.distinguishedName||this.data.id||this.data.unique;e&&t.listUnitdutyByIdentity(e,function(t){this.data.dutys=t.data}.bind(this),null,!1)}return this.data.woPerson?this.data.woPerson:(this.action.actions={getPerson:{uri:"/jaxrs/person/{flag}"},getIdentity:{uri:"/jaxrs/identity/{id}"}},this.data.person?this.action.invoke({name:"getPerson",async:!1,parameter:{flag:this.data.person},success:function(t){this.data.woPerson=i,i=t.data}.bind(this)}):this.action.invoke({name:"getIdentity",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data,i=t.data.woPerson}.bind(this)}),i);var i},createInforNode:function(t){var e=this.getPersonData();if(e){this.inforNode=new Element("div",{styles:this.style.identityInforNode});var i=new Element("div",{styles:this.style.identityInforNameNode}).inject(this.inforNode),s="/jaxrs/person/{flag}/icon";s=s.replace("{flag}",e.id||e.unique||e.distinguishedName),this.action.getAddress(),s=this.action.address+s,s=o2.filterUrl(s),img="<img width='50' height='50' border='0' src='"+s+"' style='border-radius:25px'/>";new Element("div",{styles:this.style.identityInforPicNode,html:img}).inject(i);var o=new Element("div",{styles:this.style.identityInforRightTextNode}).inject(i),n=(new Element("div",{styles:this.style.identityInforNameTextNode,text:e.name}).inject(o),new Element("div",{styles:this.style.identityInforEmployeeTextNode,text:e.employee||""}).inject(o),[]);this.data.dutys&&this.data.dutys.length&&this.data.dutys.each((function(t){var e=t.name+"("+t.woUnit.levelName+")";n.push(e)}));new Element("div",{styles:this.style.identityInforPhoneNode,html:"<div style='width:30px; float:left'>"+o2.LP.desktop.person.duty+": </div><div style='width:160px; float:left; margin-left:10px'>"+n.join(",")+"</div>"}).inject(this.inforNode);this.loadedInfor=!0,this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}t&&t()},destroy:function(){this.tooltip&&this.tooltip.destroy(),this.node.destroy(),o2.release(this)}}),o2.widget.O2Person=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){return this.data.distinguishedName||(this.action.actions={getPerson:{uri:"/jaxrs/person/{id}"}},this.action.invoke({name:"getPerson",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data;var e=[];this.data.woIdentityList&&this.data.woIdentityList.length&&this.data.woIdentityList.each((function(t){t.woUnitDutyList&&t.woUnitDutyList.length&&(e=e.concat(t.woUnitDutyList))})),this.data.dutys=e}.bind(this)})),this.data},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Unit=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){this.data.distinguishedName&&this.data.levelName||(this.action.actions={getUnit:{uri:"/jaxrs/unit/{id}"}},this.action.invoke({name:"getUnit",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.levelName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Duty=new Class({Extends:o2.widget.O2Identity,getPersonData:function(){return this.data},createInforNode:function(){return!1},setText:function(){this.node.set("text",this.data.displayName||this.data.name)}}),o2.widget.O2Group=new Class({Extends:o2.widget.O2Unit,getPersonData:function(){this.data.distinguishedName||(this.action.actions={getGroup:{uri:"/jaxrs/group/{id}"}},this.action.invoke({name:"getGroup",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},setText:function(){this.node.set("text",this.data.displayName||this.data.name)},createInforNode:function(){return!1}}),o2.widget.O2Application=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||(this.action=new o2.xDesktop.Actions.RestActions("","x_processplatform_assemble_surface",""),this.action.actions={getApplication:{uri:"/jaxrs/application/{id}"}},this.action.invoke({name:"getApplication",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))}}),o2.widget.O2CMSApplication=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||o2.Actions.get("x_cms_assemble_control").getApplication(this.data.id||this.data.name,function(t){this.data=t.data}.bind(this),null,!1)}}),o2.widget.O2Process=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||(this.action=new o2.xDesktop.Actions.RestActions("","x_processplatform_assemble_surface",""),this.action.actions={getProces:{uri:"/jaxrs/process/{id}/complex"}},this.action.invoke({name:"getProces",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.name||this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.application){var e="process.ProcessManager"+this.data.application;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={application:{id:this.data.application,name:this.data.applicationName||""}};layout.desktop.openApplication(t,"process.ProcessManager",i)}}}}),o2.widget.O2CMSCategory=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.name||o2.Actions.get("x_cms_assemble_control").getCategory(this.data.id||this.data.name,function(t){this.data=t.data}.bind(this),null,!1)},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId){var e={navi:"categoryConfig",column:{id:this.data.appId,appName:this.data.appName||""},currentCategoryId:this.data.id};layout.desktop.openApplication(t,"cms.ColumnManager",e)}}}),o2.widget.O2View=new Class({Extends:o2.widget.O2Group,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName||this.data.name}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})}}),o2.widget.O2CMSView=new Class({Extends:o2.widget.O2View}),o2.widget.O2QueryView=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getViewById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.ViewDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.ViewDesigner",i)}}}}),o2.widget.O2QueryStatement=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.load("x_query_assemble_designer").StatementAction.get(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.StatementDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.StatementDesigner",i)}}}}),o2.widget.O2QueryStat=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.StatDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.StatDesigner",i)}}}}),o2.widget.O2QueryTable=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getTableById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.TableDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.TableDesigner",i)}}}}),o2.widget.O2QueryImportModel=new Class({Extends:o2.widget.O2View,getPersonData:function(){if(!this.data.query&&this.data.id){var t=null;return o2.Actions.get("x_query_assemble_surface").getImportModelById(this.data.id,(function(e){t=e.data}),null,!1),this.data=t,t}return this.data},open:function(t){if(this.data.id&&this.data.query){var e="query.ImporterDesigner"+this.data.id;if(layout.desktop.apps[e])layout.desktop.apps[e].setCurrent();else{var i={id:this.data.id,application:this.data.query,appId:e};layout.desktop.openApplication(t,"query.ImporterDesigner",i)}}}}),o2.widget.O2FormField=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data}}),o2.widget.O2Role=new Class({Extends:o2.widget.O2Group,getPersonData:function(){this.data.distinguishedName||(this.action.actions={getRole:{uri:"/jaxrs/role/{id}"}},this.action.invoke({name:"getRole",async:!1,parameter:{id:this.data.id||this.data.name},success:function(t){this.data=t.data}.bind(this)}))}}),o2.widget.O2File=new Class({Extends:o2.widget.O2Group,createInforNode:function(){this.inforNode=new Element("div",{styles:this.style.identityInforNode});var t=this.data.fileName.substring(this.data.fileName.lastIndexOf(".")+1,this.data.fileName.length).toLowerCase();if(-1!==["png","jpg","bmp","gif","jpeg","jpe"].indexOf(t)){var e=this.data.portal?MWF.xDesktop.getPortalFileUr(this.data.id,this.data.portal):MWF.xDesktop.getProcessFileUr(this.data.id,this.data.application);new Element("img",{src:e,styles:{"max-width":"280px","max-height":"140px"}}).inject(this.inforNode)}else new Element("div",{styles:this.style.identityInforNameNode,text:this.data.applicationName||this.data.appName||this.data.name}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},getPersonData:function(){return this.data}}),o2.widget.O2Script=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},createInforNode:function(){if(!this.data.appType)return!1;this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{text:o2.LP[this.data.appType+"Name"]}).inject(this.inforNode),new Element("div",{text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId&&this.data.appType){var e;"cms"===this.data.appType?e="cms.ScriptDesigner":"portal"===this.data.appType?e="portal.ScriptDesigner":"process"===this.data.appType&&(e="process.ScriptDesigner");var i=e+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2FormStyle=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},open:function(t){if("object"===typeOf(this.data)&&this.data.id&&this.data.appId&&"script"===this.data.type){var e,i=(e="cms"===this.data.appType?"cms.ScriptDesigner":"process.ScriptDesigner")+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2Dictionary=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data},createInforNode:function(){if(!this.data.appType)return!1;this.inforNode=new Element("div",{styles:this.style.identityInforNode});new Element("div",{text:o2.LP[this.data.appType+"Name"]}).inject(this.inforNode),new Element("div",{text:this.data.applicationName||this.data.appName}).inject(this.inforNode);this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})},open:function(t){if(this.data.id&&this.data.appId&&this.data.appType){var e;"cms"===this.data.appType?e="cms.DictionaryDesigner":"process"===this.data.appType&&(e="process.DictionaryDesigner");var i=e+this.data.id;if(layout.desktop.apps[i])layout.desktop.apps[i].setCurrent();else{var s={id:this.data.id,appId:i,application:this.data.appId};layout.desktop.openApplication(t,e,s)}}}}),o2.widget.O2Other=new Class({Extends:o2.widget.O2Group,getPersonData:function(){return this.data}}),o2.widget.O2Org=function(t,e,i){var s="string"===o2.typeOf(t)?{name:t}:t.distinguishedName,o=s.distinguishedName||s.name||"";if(o)switch(o.substr(o.length-1,1).toLowerCase()){case"i":return new o2.widget.O2Identity(s,e,i);case"p":return new o2.widget.O2Person(s,e,i);case"u":return new o2.widget.O2Unit(s,e,i);case"g":return new o2.widget.O2Group(s,e,i);case"r":return new o2.widget.O2Role(s,e,i);case"d":return new o2.widget.O2Duty(s,e,i);default:return new o2.widget.O2Other(s,e,i)}return null},MWF.require(["MWF.widget.Common","MWF.widget.O2Identity"],null,!1),MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{},MWF.xDesktop.requireApp("process.Xform","lp."+MWF.language,null,!1),MWF.xApplication.process.Xform.Form=MWF.APPForm=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",readonly:!1,cssPath:"",macro:"FormContext",parameters:null,moduleEvents:["queryLoad","beforeLoad","beforeModulesLoad","postLoad","afterModulesLoad","afterLoad","beforeSave","afterSave","beforeClose","beforeProcessWork","beforeProcess","afterProcess","beforeReset","afterReset","beforeRetract","afterRetract","beforeReroute","afterReroute","beforeDelete","afterDelete","resize","beforeReaded","afterReaded"]},initialize:function(t,e,i){this.setOptions(i),this.container=$(t),this.container.setStyle("-webkit-user-select","text"),Browser.firefox&&this.container.setStyle("opacity",0),this.data=e,this.json=e.json,this.html=e.html,this.path="../x_component_process_Xform/$Form/",this.cssPath=this.options.cssPath||"../x_component_process_Xform/$Form/"+this.options.style+"/css.wcss",this._loadCss(),this.sectionListObj={},this.modules=[],this.all={},this.allForName={},this.forms={}},parseCSS:function(t){for(var e,i=/(url\(.*\))/g;null!==(e=i.exec(t));){var s=e[0],o=s.length,n=s.substring(s.length-2,s.length-1),a="'"===n||'"'===n?5:4,r="'"===n||'"'===n?2:1;if(-1!=(s=s.substring(a,s.length-r)).indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var l=MWF.Actions.getHost("x_portal_assemble_surface");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",l+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",l+"/x_portal_assemble_surface")),s=o2.filterUrl(s)}var h=(s="url('"+s+"')").length;t=t.substring(0,e.index)+s+t.substring(i.lastIndex,t.length),i.lastIndex=i.lastIndex+(h-o)}return t},loadCss:function(){if(cssText=this.json.css?this.json.css.code:"",(r=$("style"+this.json.id))&&r.destroy(),cssText){cssText=this.parseCSS(cssText);for(var t,e=new RegExp("(.+)(?=\\{)","g"),i=this.json.id.replace(/\-/g,""),s=".css"+i+" ";null!==(t=e.exec(cssText));){var o=t[0];if(-1!=o.indexOf(",")){var n=o.split(/\s*,\s*/g),a=(n=n.map((function(t){return s+t}))).join(", ");cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+s.length*n.length}else{a=s+t[0];cssText=cssText.substring(0,t.index)+a+cssText.substring(e.lastIndex,cssText.length),e.lastIndex=e.lastIndex+s.length}}var r;if((r=document.createElement("style")).setAttribute("type","text/css"),r.id="style"+this.json.id,r.inject(this.container,"before"),r.styleSheet){var l=function(){r.styleSheet.cssText=cssText};r.styleSheet.disabled?setTimeout(l,10):l()}else{var h=document.createTextNode(cssText);r.appendChild(h)}return"css"+i}return""},keyLock:function(t){var e=this.businessData.work.id+"-"+this.businessData.work.activityToken;return o2.Actions.load("x_processplatform_assemble_surface").KeyLockAction.lock({key:e},function(e){flagData=e.data,t&&flagData.success&&(this.keyLockTimeoutId=window.setTimeout(function(){this.keyLock(!0)}.bind(this),9e4)),t&&!flagData.success&&this.app.reload()}.bind(this),null,!!t),flagData},checkLock:function(){if(this.businessData.control.allowProcessing&&"grab"==this.businessData.activity.manualMode){this.app.addEvent("queryClose",function(){this.keyLockTimeoutId&&window.clearTimeout(this.keyLockTimeoutId)}.bind(this));var t=this.keyLock();t.success?this.keyLock(!0):(this.businessData.control.allowProcessing=!1,this.businessData.control.allowSave=!1,this.businessData.control.allowReset=!1,this.businessData.control.allowReroute=!1,this.businessData.control.allowDelete=!1,this.businessData.control.allowAddSplit=!1,this.businessData.control.allowRetract=!1,this.businessData.control.allowRollback=!1,this.lockDataPerson=t.person)}},load:function(t){this.loadMacro(function(){this.loadLanguage(function(e){if(e&&this.formDataText){var i=o2.bindJson(this.formDataText,{lp:MWF.xApplication.process.Xform.LP.form});this.data=JSON.parse(i),this.json=this.data.json,this.html=this.data.html}this.checkLock(),this.loadExtendStyle(function(){this.app&&(this.app.formNode&&this.app.formNode.setStyles(this.json.styles),this.app.addEvent&&(this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this)),this.app.addEvent("queryClose",function(){this.beforeCloseWork()}.bind(this)))),this.businessData.control.allowSave||this.setOptions({readonly:!0});var e="";this.json.css&&this.json.css.code&&(e=this.loadCss()),this.container.set("html",this.html),this.node=this.container.getFirst(),e&&this.node.addClass(e),this._loadEvents(),this.loadRelatedScript(),this.fireEvent("queryLoad"),this.event_resolve?this.event_resolve(function(){this.loadForm(t)}.bind(this)):this.loadForm(t)}.bind(this))}.bind(this))}.bind(this))},loadLanguage:function(t){if("script"!==this.json.languageType&&"default"!==this.json.languageType)return t&&t(),!0;MWF.xApplication.process.Xform.LP.form;var e=null;if("script"==this.json.languageType)this.json.languageScript&&this.json.languageScript.code&&(e=this.Macro.exec(this.json.languageScript.code,this));else if("default"==this.json.languageType){var i="lp-"+o2.language;if("PageContext"===this.options.macro){var s=this.app.portal.id;e=this.workAction.getScriptByNameV2(s,i,function(t){return this.Macro.exec(t.data.text,this)}.bind(this),(function(){}))}else{var o=(this.businessData.work||this.businessData.workCompleted).application,n=this.workAction.getDictRoot(i,o,(function(t){return t.data}),(function(){})),a=new Promise(function(t,e){this.workAction.getScriptByNameV2(i,o,function(i){i.data.text?t(this.Macro.exec(i.data.text,this)):e("")}.bind(this),(function(){e("")}))}.bind(this));e=Promise.any([n,a])}}e?e.then&&"function"==o2.typeOf(e.then)?e.then((function(e){MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)}),(function(){t&&t(!0)})):(MWF.xApplication.process.Xform.LP.form=Object.merge(MWF.xApplication.process.Xform.LP.form,e),t&&t(!0)):t&&t(!0)},loadRelatedScript:function(){if(this.json.includeScripts&&this.json.includeScripts.length){var t="",e=[];this.json.includeScripts.each(function(i){this.app.relatedScriptMap&&this.app.relatedScriptMap[i.id]&&(t+="\n"+this.app.relatedScriptMap[i.id].text,e.push(i.id))}.bind(this)),t&&this.Macro.exec(t,this)}},loadForm:function(t){if(this.lockDataPerson){var e=MWF.xApplication.process.Xform.LP.keyLockInfor;e=e.replace("{name}",o2.name.cn(this.lockDataPerson));var i=MWF.xApplication.process.Xform.LP.keyLockTitle;this.app.alert("info","center",i,e,400,160)}this.app&&this.app.fireEvent&&this.app.fireEvent("queryLoad"),this._loadBusinessData(),this.fireEvent("beforeLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeLoad"),this.loadContent(t)},loadExtendStyle:function(t){if(this.json.styleConfig&&this.json.styleConfig.extendFile)if("5.2"!=this.json.$version){var e="../x_component_process_FormDesigner/Module/Form/skin/"+this.json.styleConfig.extendFile;MWF.getJSON(e,{onSuccess:function(e){e&&e.form&&(this.json=Object.merge(this.json,e.form)),t&&t()}.bind(this),onRequestFailure:function(){t&&t()}.bind(this),onError:function(){t&&t()}.bind(this)})}else t&&t();else t&&t()},loadMacro:function(t){MWF.require("MWF.xScript.Macro",function(){this.Macro=new MWF.Macro[this.options.macro||"FormContext"](this),t&&t()}.bind(this))},loadContent:function(t){if(this.subformCount=0,this.subformLoadedCount=0,this.subformLoaded=[this.json.id],this.subpageCount=0,this.subpageLoadedCount=0,this.subpageLoaded=[],this.widgetCount=0,this.widgetLoadedCount=0,this.widgetLoaded=[],this._loadHtml(),this._loadForm(),this.fireEvent("beforeModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeModulesLoad"),this._loadModules(this.node),Browser.firefox&&this.container.setStyle("opacity",1),"Mobile"===this.json.mode){var e=document.body.getElement(".o2_form_mobile_actions");e?(e.empty(),this._loadMobileActions(e,t)):t&&t()}else t&&t();this.fireEvent("postLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("postLoad"),this.checkSubformLoaded(!0)},checkSubformLoaded:function(t){t&&(this.isAllSubformLoaded=!0),this.isAllSubformLoaded&&(this.subformCount&&this.subformCount!==this.subformLoadedCount||this.subpageCount&&this.subpageCount!==this.subpageLoadedCount||this.widgetCount&&this.widgetCount!==this.widgetLoadedCount||(this.fireEvent("afterModulesLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterModulesLoad"),this.fireEvent("afterLoad"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterLoad"),this.isLoaded=!0))},_loadMobileDefaultTools:function(t){this.json.defaultTools?t&&t():this.json.defaultTools=o2.JSON.get("../x_component_process_FormDesigner/Module/Form/toolbars.json",function(e){this.json.defaultTools=e,t&&t()}.bind(this))},_loadMobileActions:function(t,e){var i=[];this._loadMobileDefaultTools(function(){if(this.json.defaultTools){var s=JSON.stringify(this.json.defaultTools);s=o2.bindJson(s,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.defaultTools=JSON.parse(s),this.json.defaultTools.each(function(t){this._checkDefaultMobileActionItem(t,this.options.readonly)&&i.push(t)}.bind(this))}if(this.json.tools){s=JSON.stringify(this.json.tools);s=o2.bindJson(s,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.tools=JSON.parse(s),this.json.tools.each(function(t){this._checkCustomMobileActionItem(t,this.options.readonly)&&i.push(t)}.bind(this))}this.mobileTools=i,window.o2android||window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.o2mLog?i.length&&t&&this._createMobileActions(t,i):i.length&&t&&this._createMobileActionsDingdingStyle(t,i),e&&e()}.bind(this))},_createMobileActionsDingdingStyle:function(t,e){t.show();var i=e.length;if(i<=2){var s=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-s.x*(i+1)-2*i)/i;e.each(function(e){var i=this.css.html5ActionButtonDingdingNormal;"继续流转"===e.text||"撤回"===e.text||"action_processWork"===e.id||"action_retract"===e.id?i=this.css.html5ActionButtonDingdingPrimary:"删除文件"!==e.text&&"action_delete"!==e.id||(i=this.css.html5ActionButtonDingdingDanger),i.width=o+"px";var s=new Element("div",{styles:i,text:e.text}).inject(t);s.store("tool",e),s.addEvent("click",function(t){var i=function(){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this);"继续流转"===e.text||"action_processWork"===e.id?window.setTimeout(i,100):i()}.bind(this)),new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}.bind(this))}else{s=new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t).getSize(),o=(document.body.getSize().x-4*s.x-6)/5;for(var n=0;n<3;n++){tool=e[n];var a,r=this.css.html5ActionButtonDingdingNormal;if("继续流转"===tool.text||"撤回"===tool.text?r=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(r=this.css.html5ActionButtonDingdingDanger),2==n)this.css.html5ActionButtonDingdingMore.width=o+"px",(a=new Element("div",{styles:this.css.html5ActionButtonDingdingMore,text:"…"}).inject(t)).addEvent("click",function(i){this._loadMoreMobileActionsDingdingStyle(e,2,t)}.bind(this));else r.width=2*o+"px",(a=new Element("div",{styles:r,text:tool.text}).inject(t)).store("tool",tool),a.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this));new Element("div",{styles:this.css.html5ActionButtonDingdingSplit,text:" "}).inject(t)}}},_loadMoreMobileActionsDingdingStyle:function(t,e,i){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var s=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=s.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var l=this.css.html5ActionButtonDingdingNormal;"继续流转"===tool.text||"撤回"===tool.text?l=this.css.html5ActionButtonDingdingPrimary:"删除文件"===tool.text&&(l=this.css.html5ActionButtonDingdingDanger),l.width="100%";var h=new Element("div",{styles:l,text:tool.text}).inject(this.actionMoreArea);h.store("tool",tool),h.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this))}}},_createMobileActions:function(t,e){t.show();var i=e.length;if(i<=2)this.css.html5ActionButton.width="100%",2==i&&(this.css.html5ActionButton.width="49%"),e.each(function(e){var i=new Element("div",{styles:this.css.html5ActionButton,text:e.text}).inject(t);i.store("tool",e),i.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(i)}.bind(this)),2==i&&new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before");else{this.css.html5ActionButton.width="38%";for(var s=0;s<2;s++){tool=e[s],(o=new Element("div",{styles:this.css.html5ActionButton,text:tool.text}).inject(t)).store("tool",tool),o.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(o)}var o;new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t.getLast(),"before"),new Element("div",{styles:this.css.html5ActionButtonSplit}).inject(t),this.css.html5ActionButton.width="23%",(o=new Element("div",{styles:this.css.html5ActionButton,text:"…"}).inject(t)).addEvent("click",function(i){this._loadMoreMobileActions(e,2,t)}.bind(this)),this._setMobileBottonStyle(o)}},_loadMoreMobileActions:function(t,e,i){if(document.body.mask({style:{"background-color":"#cccccc",opacity:.6},hideOnClick:!0,onHide:function(){this.actionMoreArea.setStyle("display","none")}.bind(this)}),this.actionMoreArea)this.actionMoreArea.setStyle("display","block");else{var s=document.body.getSize();this.actionMoreArea=new Element("div",{styles:this.css.html5ActionOtherArea}).inject(document.body);var o=this.actionMoreArea.getStyle("padding-left").toInt(),n=this.actionMoreArea.getStyle("padding-right").toInt(),a=s.x-o-n;this.actionMoreArea.setStyle("width",a+"px");for(var r=e;r<t.length;r++){tool=t[r];var l=new Element("div",{styles:this.css.html5ActionOtherButton,text:tool.text}).inject(this.actionMoreArea);l.store("tool",tool),l.addEvent("click",function(t){var e=t.target.retrieve("tool");t.setDisable=function(){},e.actionScript?this._runCustomAction(e.actionScript):this[e.action]&&this[e.action](t)}.bind(this)),this._setMobileBottonStyle(l)}}},_setMobileBottonStyle:function(t){var e=this;t.addEvents({mouseover:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseout:function(t){this.setStyles(e.css.html5ActionButton_up)},mousedown:function(t){this.setStyles(e.css.html5ActionButton_over)},mouseup:function(t){this.setStyles(e.css.html5ActionButton_up)},touchstart:function(t){this.setStyles(e.css.html5ActionButton_over)},touchcancel:function(t){this.setStyles(e.css.html5ActionButton_up)},touchend:function(t){this.setStyles(e.css.html5ActionButton_up)},touchmove:function(t){this.setStyles(e.css.html5ActionButton_over)}})},_runCustomAction:function(t){this.Macro.exec(t,this)},_checkCustomMobileActionItem:function(t,e){var i=!0;(i=e?t.readShow:t.editShow)&&(i=!0,t.control&&(i=this.form.businessData.control[t.control]),t.condition&&(i=!this.Macro.exec(t.condition,this)));return i},_checkDefaultMobileActionItem:function(t,e,i){var s=!0;if(t.control&&(s=this.businessData.control[t.control]),!i&&t.condition){var o=this.Macro.exec(t.condition,this);s=s&&!o}return"action_processWork"==t.id&&!this.businessData.task&&this.businessData.work.startTime&&(s=!1),"action_rollback"==t.id&&(t.read=!0),e&&(t.read||(s=!1)),s},_loadBusinessData:function(){this.businessData||(this.businessData={})},_loadHtml:function(){this.node.addEvent("selectstart",(function(t){var e="text";t.target.getStyle("-webkit-user-select")&&(e=t.target.getStyle("-webkit-user-select").toString().toLowerCase()),"text"!==e&&"auto"!==e&&t.preventDefault()}))},_loadForm:function(){this._loadStyles(),this._loadCssLinks(),this._loadScriptSrc(),this._loadJsheader()},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(t,e){if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface"))}t=o2.filterUrl(t),this.node.setStyle(e,t)}.bind(this))},_loadCssLinks:function(){this.json.cssLinks.each((function(t){new Element("link",{rel:"stylesheet",type:"text/css",href:t}).inject($(document.head))}))},_loadScriptSrc:function(){this.json.scriptSrc.each((function(t){new Element("script",{src:t}).inject($(document.head))}))},_loadJsheader:function(){var t=this.json.jsheader?this.json.jsheader.code:"";t&&Browser.exec(t)},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)):"load"===e?this.addEvent("postLoad",function(){return this.Macro.fire(t.code,this)}.bind(this)):"submit"===e?this.addEvent("beforeProcess",function(){return this.Macro.fire(t.code,this)}.bind(this)):this.node.addEvent(e,function(e){return this.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):"load"===t?this.addEvent("postLoad",function(t){return e?e(this,t):null}.bind(this)):"submit"===t?this.addEvent("beforeProcess",function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_getDomjson:function(t){switch(t.get("MWFtype")||t.get("mwftype")){case"form":return this.json;case"":return null;default:var e=t.get("id");return e||(e=t.get("MWFId")),e?this.json.moduleList[e]:null}},_getModuleNodes:function(t,e){for(var i=[],s=t.getFirst();s;){var o=s.get("MWFtype")||s.get("mwftype");if(o)-1!==o.indexOf("$")&&!0!==e||i.push(s),"datagrid"!==o&&"datatable"!==o&&"subSource"!==o&&"tab$Content"!==o&&"datatemplate"!==o&&(i=i.concat(this._getModuleNodes(s,e)));else i=i.concat(this._getModuleNodes(s,e));s=s.getNext()}return i},_loadModules:function(t){this._getModuleNodes(t).each(function(t){var e=this._getDomjson(t),i=this._loadModule(e,t);this.modules.push(i)}.bind(this))},_loadModule:function(t,e,i){"Subform"!==t.type&&"subform"!==t.moduleName||this.subformCount++,"Subpage"!==t.type&&"subpage"!==t.moduleName||this.subpageCount++,"Widget"!==t.type&&"widget"!==t.moduleName||this.widgetCount++,MWF["APP"+t.type]||MWF.xDesktop.requireApp("process.Xform",t.type,null,!1);var s=new MWF["APP"+t.type](e,t,this);if(i&&i.apply(s),this.all[t.id]||(this.all[t.id]=s),t.name)if(this.allForName[t.name]){var o=this.allForName[t.name];"array"===typeOf(o)?o.push(s):this.allForName[t.name]=[o,s]}else this.allForName[t.name]=s;return s.field&&(this.forms[t.id]||(this.forms[t.id]=s)),s.readonly=this.options.readonly,s.load(),s},saveOpinion:function(t){var e=t._getBusinessSectionDataByPerson();MWF.UD.getDataJson("userOpinion",function(t){t||(t=[]);var i=t.indexOf(e);-1==i?t.length>=50&&t.shift():t.splice(i,1),t.push(e),MWF.UD.putData("userOpinion",t)}.bind(this),!1)},loadPathData:function(t){var e=null;return this.workAction.getJobDataByPath(this.businessData.work.job,t,(function(t){e=t.data||null}),null,!1),e},getData:function(t){var e=this.businessData.data;return Object.each(this.forms,function(i,s){if(!(s.indexOf("..")>0))if("Opinion"===i.json.type)if(t){this.saveOpinion(i);var o=layout.desktop.session.user.id;"object"===typeOf(e[s])&&"string"===typeOf(e[s][o])?e[s][o]="":"string"===typeOf(e[s])&&(e[s]="")}else{var n=i.getData();e[s]=this.getSectionDataByPerson(n,e[s])}else if("yes"===i.json.section){n=this.getSectionData(i,e[s]);e[s]=n}else{n=i.getData();e[s]=n}}.bind(this)),this.businessData.data=e,this.Macro.environment.setData(this.businessData.data),e},getSectionData:function(t,e){var i=t.getData();switch(t.json.sectionBy){case"person":return this.getSectionDataByPerson(i,e);case"unit":return this.getSectionDataByUnit(i,e);case"activity":return this.getSectionDataByPActivity(i,e);case"splitValue":return this.getSectionDataBySplitValue(i,e);case"script":return this.getSectionDataByScript(t.json.sectionByScript.code,i,e);default:return i}},getSectionDataByPerson:function(t,e){var i=layout.desktop.session.user.id;return e&&"object"===typeOf(e)||(e={}),e[i]=t,e},getSectionDataByUnit:function(t,e){var i=this.businessData.task?this.businessData.task.unit:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataBySplitValue:function(t,e){var i=this.businessData.work?this.businessData.work.splitValue:"";return e&&"object"===typeOf(e)||(e={}),i&&(e[i]=t),e},getSectionDataByScript:function(t,e,i){var s=this.Macro.exec(t,this);return i&&"object"===typeOf(i)||(i={}),s&&(i[s]=e),i},setSection:function(t,e){var i=e[t.name];switch(t.sectionBy){case"person":return this.setSectionByPerson(i,t.name);case"unit":return this.setSectionByUnit(i,t.name);case"activity":return this.setSectionByPActivity(i,t.name);case"splitValue":return this.setSectionBySplitValue(i,t.name);case"script":return this.setSectionByScript(t.sectionByScript.code,i,t.name);default:return v}},setSectionByPerson:function(t,e){var i=layout.desktop.session.user.id;return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i,t},setSectionByUnit:function(t,e){var i=this.businessData.task?this.businessData.task.unit:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionByPActivity:function(t,e){var i=this.businessData.work?this.businessData.work.activity:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionBySplitValue:function(t,e){var i=this.businessData.work?this.businessData.work.splitValue:"";return t&&"object"===typeOf(t)||(t={}),this.sectionListObj[e]=i||"",t},setSectionByScript:function(t,e,i){var s=this.Macro.exec(t,this);return e&&"object"===typeOf(e)||(e={}),this.sectionListObj[i]=s||"",e},saveWork:function(t,e){this.businessData.control.allowSave?(this.fireEvent("beforeSave"),this.fireEvent("beforeSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(i){this.app&&!e&&this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved,"success"),t&&"function"===typeOf(t)&&t(),this.fireEvent("afterSave"),this.fireEvent("afterSaveWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave")}.bind(this))):MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied")},getSectionList:function(){return Object.keys(this.sectionListObj).map(function(t){var e={path:t};return this.sectionListObj[t]&&(e.key=this.sectionListObj[t]),e}.bind(this))},setModifedDataByPathList:function(t,e){for(var i=this.modifedData,s=0;s<e.length;s++)s===e.length-1?i[e[s]]=t:i="object"===typeOf(i[e[s]])||"array"===typeOf(i[e[s]])?i[e[s]]:"number"===typeOf(e[s])?i[e[s]]=[]:i[e[s]]={}},getOrigianlPathData:function(t){for(var e=this.businessData.originalData,i=0;i<t.length;i++)if(i===t.length-1)e=e[t[i]];else{if("object"!==typeOf(e[t[i]])&&"array"!==typeOf(e[t[i]]))return null;e=e[t[i]]}return e},setModifedData:function(t,e){if(e=e||[],"object"===typeOf(t))for(var i in t){var s=Array.clone(e);s.push(i),this.setModifedData(t[i],s)}else if("array"===typeOf(t)){var o=this.getOrigianlPathData(e);"array"===typeOf(o)&&o.length===t.length&&this.compareObjects(o,t)||this.setModifedDataByPathList(t,e)}else if("null"!==typeOf(t)){o=this.getOrigianlPathData(e);typeOf(t)===typeOf(o)&&t===o||this.setModifedDataByPathList(t,e)}},compareObjects:function(t,e,i){if(i||(i=0),i>15)return!1;var s=typeOf(t);if(s!==typeOf(e))return!1;if("object"===s){for(var o in t)null!==t[o]&&void 0!==t[o]||delete t[o];for(var o in e)null!==e[o]&&void 0!==e[o]||delete e[o]}switch(s){case"object":case"array":var n,a=Object.keys(t),r=Object.keys(e);if(a.length!==r.length)return!1;for(a.sort(),r.sort(),n=0;n<a.length;n++){var l=a[n];"array"===s&&(l=l.toInt());var h=t[l],d=e[l];if(!1===this.compareObjects(h,d,i++))return!1}break;case"function":break;default:if(t!==e)return!1}return!0},saveFormData:function(t,e,i,s,o,n){this.businessData.work.startTime?this.saveFormDataInstance(t,e,i,s,o):this.saveFormDataDraft(t,e,i,s,o,n)},saveFormDataInstance:function(t,e,i,s,o){this.officeList&&this.officeList.each((function(t){t.save(i)}));s=s||this.getData(o);if(this.modifedData={},this.setModifedData(s),this.toWordSaveList&&this.toWordSaveList.length){var n=[];this.toWordSaveList.each((function(t){t.docToWord&&n.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(n).then(function(){this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)}.bind(this))}else this.workAction.saveData(function(){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),t&&t()}.bind(this),e,this.businessData.work.id,this.modifedData)},saveFormDataDraft:function(t,e,i,s,o,n){this.officeList&&this.officeList.each((function(t){t.save(i)}));var a={data:s=s||this.getData(o),work:this.businessData.work,identity:this.businessData.work.creatorIdentityDn};this.workAction.saveDraft(a,function(e){this.businessData.originalData=null,this.businessData.originalData=Object.clone(s),this.workAction.getDraft(e.data.id,function(e){this.businessData.work=e.data.work,this.app.options.draftId=e.data.work.id,layout.app&&layout.app.inBrowser?(layout.app&&(layout.app.$openWithSelf=!0),t&&t(),n||layout.desktop.openApplication(null,"process.Work",{draftId:this.app.options.draftId})):(this.app.options.desktopReload=!0,this.app.appId="process.Work"+e.data.work.id,layout.desktop.apps?delete layout.desktop.apps[this.app.options.appId]:layout.desktop.apps={},layout.desktop.apps[this.app.appId]=this.app,t&&t(),n||this.app.reload())}.bind(this))}.bind(this),e)},setProcessorSectionOrgList:function(t){this.routeDataList||this.getRouteDataList();for(var e=this.routeDataList,i=0;i<e.length;i++)(e[i].selectConfigList||[]).each(function(e,i){"yes"==e.section&&this.setSection(e,t)}.bind(this))},getRouteDataList:function(){return this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.businessData.task.routeList},function(t){t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1),this.routeDataList},beforeCloseWork:function(){if(this.fireEvent("beforeClose"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeClose"),this.options.readonly)this.app.refreshTaskCenter();else if(this.businessData.work&&this.businessData.work.id&&!this.isSendBeacon){if(this.app.inBrowser&&navigator.sendBeacon){var t=this.workAction.action.actions.checkDraft,e=this.workAction.action.address+t.uri;e=e.replace("{id}",this.businessData.work.id),navigator.sendBeacon(e)}else this.workAction.checkDraft(this.businessData.work.id,function(){layout.desktop.apps&&layout.desktop.apps.TaskCenter&&layout.desktop.apps.TaskCenter.window&&(layout.desktop.apps.TaskCenter.content.unmask(),layout.desktop.apps.TaskCenter.refreshAll())}.bind(this),null,!1);this.isSendBeacon=!0}},closeWork:function(){this.app.close()},getMessageContent:function(t,e,i){var s="";if(t.completed)s+=MWF.xApplication.process.Xform.LP.workCompleted;else if(t.occurSignalStack)if(t.signalStack&&t.signalStack.length){var o=[];t.signalStack.each(function(t){var e=[];t.splitExecute&&(e=t.splitExecute.splitValueList||[]),t.manualExecute&&(e=t.manualExecute.identities||[]);var i=0,s=[];e.each((function(t){var e=o2.name.cn(t);s.contains(e)||s.push(e)})),s.length>8&&(i=s.length,s=s.slice(0,8)),s=o2.name.cns(s);var n=MWF.xApplication.process.Xform.LP,a="<b>"+n.nextActivity+"</b><span style='color: #ea621f'>"+t.name+"</span>；<b>"+n.nextUser+"</b><span style='color: #ea621f'>"+s.join(",")+"</span> <b>"+(i?","+n.next_etc.replace("{count}",i):"")+"</b>";o.push(a)}.bind(this)),s+=o.join("<br>")}else s+=MWF.xApplication.process.Xform.LP.taskCompleted;else if(t.properties.nextManualList&&t.properties.nextManualList.length){o=[];t.properties.nextManualList.each((function(t){var e=[];t.taskIdentityList.each((function(t){var i=o2.name.cn(t);e.contains(i)||e.push(i)}));var i="<b>"+MWF.xApplication.process.Xform.LP.nextActivity+"</b><span style='color: #ea621f'>"+t.activityName+"</span>；<b>"+MWF.xApplication.process.Xform.LP.nextUser+"</b><span style='color: #ea621f'>"+e.join(",")+"</span>";o.push(i)})),s+=o.join("<br>")}else t.arrivedActivityName?s+=MWF.xApplication.process.Xform.LP.arrivedActivity+t.arrivedActivityName:s+=MWF.xApplication.process.Xform.LP.taskCompleted;var n=this.businessData.data.title||this.businessData.data.subject||this.businessData.work.title;return e&&n.length>e&&(n=n.substr(0,e)+"..."),"<div>"+(i||MWF.xApplication.process.Xform.LP.taskProcessedMessage)+"“"+n+"”</div>"+s},addMessage:function(t,e){if(layout.desktop.message){var i={subject:MWF.xApplication.process.Xform.LP.taskProcessed,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage)};return layout.desktop.message.addTooltip(i),layout.desktop.message.addMessage(i)}this.app.inBrowser&&!e&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.taskProcessedMessage))},formValidation:function(t,e,i){if(this.options.readonly)return!0;this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=i;var s=!0;return Object.each(this.forms,function(o,n){o.validationMode(),o.validation(t,e,i)||(s=!1)}.bind(this)),s},validation:function(t,e,i,s){this.Macro.environment.form.currentRouteName=t,this.Macro.environment.form.opinion=e,this.Macro.environment.form.medias=s;var o=this.validationRoute(i),n=this.validationOpinion(i);return o&&n},validationRoute:function(t){if(!this.json.validationRoute)return!0;if(!this.json.validationRoute.code)return!0;var e=this.Macro.exec(this.json.validationRoute.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationRouteMode(e,t),!1)},validationOpinion:function(t){if(!this.json.validationOpinion)return!0;if(!this.json.validationOpinion.code)return!0;var e=this.Macro.exec(this.json.validationOpinion.code,this);return e||(e=MWF.xApplication.process.Xform.LP.notValidation),"true"==e.toString()||(this.notValidationOpinionMode(e,t),!1)},formCustomValidation:function(){if(!this.json.validationFormCustom)return!0;if(!this.json.validationFormCustom.code)return!0;var t=this.Macro.exec(this.json.validationFormCustom.code,this);return t||(t=MWF.xApplication.process.Xform.LP.notValidation),"true"==t.toString()||(this.notValidationOpinionMode(t),!1)},notValidationRouteMode:function(t,e){e&&e.routeSelectorArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},t,e?e.routeSelectorArea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},notValidationOpinionMode:function(t,e){e&&e.inputTextarea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",e?{x:"center",y:"top"}:{x:"right",y:"top"},t,e?e.inputTextarea:this.app.content,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})},getIgnoreImpowerIdentity:function(t){for(var e=[],i=function(t,i){var s=i?t.getValue():t.getData(),o=!1;"array"===typeOf(s)&&s.length&&s.each((function(t){t.ignoreEmpower&&(e.push(t.distinguishedName||t.unique||t.id),t.ignoredEmpower=!0,delete t.ignoreEmpower,o=!0)})),o&&t.setData(s)},s=this.modules,o=0;o<s.length;o++){var n=s[o],a=n.json.moduleName;a||(a="string"===typeOf(n.json.type)?n.json.type.toLowerCase():""),"org"===a&&i(n)}if(t&&t.length>0)for(o=0;o<t.length;o++)i(t[o],!0);return e},submitWork:function(t,e,i,s,o,n,a,r,l){if(!this.businessData.control.allowProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),this.app.content.unmask(),o&&o.node&&o.node.unmask(),!1;if(!this.formValidation(t,e,i))return this.app.content.unmask(),s&&s(),!1;if(!this.validation(t,e,o,i))return o&&o.node&&o.node.unmask(),!1;if(!e){var h=this.businessData.task.routeNameList.indexOf(t);this.businessData.task.routeOpinionList[h]&&(e=this.businessData.task.routeOpinionList[h])}this.fireEvent("beforeProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcess");var d=this.getIgnoreImpowerIdentity(r),c=this;MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),l&&l(),this.fireEvent("beforeSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeSave"),this.saveFormData(function(o){this.businessData.task.routeName=t,this.businessData.task.opinion=e||"";var n=[];if(i&&i.length&&i.each(function(t){var e=new FormData;e.append("file",t),e.append("site","$mediaOpinion"),this.workAction.uploadAttachment(this.businessData.work.id,e,t,function(t){n.push(t.data.id)}.bind(this),null,!1)}.bind(this)),n.length&&(this.businessData.task.mediaOpinion=n.join(",")),a&&a.length){var r=[];a.each(function(t){"object"===typeOf(t)?r.push(t.distinguishedName||t.unique||t.id):r.push(t)}.bind(this)),this.businessData.task.appendTaskIdentityList=r}this.businessData.task.ignoreEmpowerIdentityList=d,this.fireEvent("afterSave"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterSave"),this.workAction.processTask(function(t){if(s&&s(t),this.taskList=t.data,this.fireEvent("afterProcess"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterProcess"),this.addMessage(t.data,!0),this.app.taskObject&&this.app.taskObject.destroy(),this.closeImmediatelyOnProcess)this.app.close();else if("function"===typeOf(this.showCustomSubmitedDialog))this.showCustomSubmitedDialog(t.data);else if(layout.mobile)c.finishOnMobile();else if(this.app.inBrowser)if(this.mask&&this.mask.hide(),!1!==this.json.isPrompt)this.showSubmitedDialog(t.data);else if("redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var e=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(e).go()}else this.app.close();else this.app.close()}.bind(this),null,this.businessData.task.id,this.businessData.task)}.bind(this),null,!0,n,!0)}.bind(this))},showSubmitedDialog:function(t){var e=this.getMessageContent(t,this.json.submitedDlgStyle?this.json.submitedDlgStyle.maxTitleLength:60),i=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden",width:"270px"}}).inject(this.app.content);i.set("html",e);var s=new Element("div",{styles:{"margin-top":"5px"}}).inject(i),o={content:i,isTitle:!1,width:350,height:180,buttonList:[{text:this.app.lp.closePage,action:function(){if(r.close(),"redirect"==this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else this.app.close()}.bind(this)}]};this.json.submitedDlgStyle&&(o=Object.merge(o,this.json.submitedDlgStyle),this.json.submitedDlgStyle.contentStyle&&(i.setStyles(this.json.submitedDlgStyle.contentStyle),delete o.contentStyle));var n=this.app.content.getSize();switch(o.promptPosition||this.json.promptPosition||"righttop"){case"lefttop":o.top=10,o.left=10,o.fromTop=10,o.fromLeft=10;break;case"righttop":o.top=10,o.left=n.x-o.width-10,o.fromTop=10,o.fromLeft=n.x-10;break;case"leftbottom":o.top=n.y-o.height-10,o.left=10,o.fromTop=n.y-10,o.fromLeft=10;break;case"rightbottom":o.top=n.y-o.height-10,o.left=n.x-o.width-10,o.fromTop=n.y-10,o.fromLeft=n.x-10;break;default:delete o.top,delete o.left,delete o.fromTop,delete o.fromLeft}var a=this;o.onPostLoad=function(){this.node.setStyle("display","block");var t=i.getSize();if(this.content.setStyles({height:t.y}),this.setContentSize(),0!=(o.promptCloseTime||a.json.promptCloseTime)){var e=o.promptCloseTime||a.json.promptCloseTime||2;if(e=1e3*e.toInt(),o.isCountDown){s.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3;var n=function(){if(e>0)s.set("text",a.app.lp.closePageCountDownText.replace("{second}",Math.ceil(e/1e3).toString())),e-=1e3,window.setTimeout(n,1e3);else if(r.close(),"redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()};window.setTimeout(n,1e3)}else window.setTimeout((function(){if("redirect"==a.json.afterProcessAction&&a.json.afterProcessRedirectScript&&a.json.afterProcessRedirectScript.code){var t=a.Macro.exec(a.json.afterProcessRedirectScript.code,a);new URI(t).go()}else a.app.close()}),e)}};var r=o2.DL.open(o)},startDraftProcess:function(){return this.formCustomValidation("","")&&this.formValidation("","")?void this.saveFormData(function(){this.workAction.startDraft(this.businessData.work.id,function(t){if(this.app.options.workId=t.data[0].work,layout.mobile||!layout.desktop.message)layout.notice&&layout.notice(MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject));else if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.processStarted,content:"<div>"+MWF.xApplication.process.Xform.LP.processStartedMessage+"“["+t.data[0].processName+"]"+(this.businessData.data.title||this.businessData.data.subject)+"”</div>"};layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}layout.app&&layout.app.inBrowser&&(layout.app&&(layout.app.$openWithSelf=!0),layout.desktop.openApplication(null,"process.Work",{workId:this.app.options.workId,action:"processTask"})),this.app.options.action="processTask",this.app.reload()}.bind(this))}.bind(this),null,!1,null,!1,!0):(this.app.content.unmask(),!1)},getCurrentTaskData:function(t){return!t.currentTaskIndex&&0!==t.currentTaskIndex||-1==t.currentTaskIndex?null:(this.app.options.taskId=this.businessData.taskList[t.currentTaskIndex].id,this.businessData.taskList[t.currentTaskIndex])},processWork:function(){this.businessData.work.startTime?"select"===this.json.submitFormType||"script"===this.json.submitFormType?this.processWork_custom():"Mobile"==this.json.mode?setTimeout(function(){this.processWork_mobile()}.bind(this),100):this.processWork_pc():this.startDraftProcess()},processWork_custom:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;if(this.submitFormModule)this.submitFormModule.show();else{MWF.APPSubmitform||MWF.xDesktop.requireApp("process.Xform","Subform",null,!1);var t=new Element("div").inject(layout.mobile?$(document.body):this.app.content);this.submitFormModule=new MWF.APPSubmitform(t,this.json,this),this.submitFormModule.addEvent("afterModulesLoad",function(){this.submitFormModule.show()}.bind(this)),this.submitFormModule.load()}},processWork_pc:function(){if(this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork"),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var t=function(t){if(this&&this.node){this.node.setStyle("display","block");var i=e.getSize();this.content.setStyles({height:i.y,width:i.x});this.setContentSize();t||this.reCenter()}},e=new Element("div",{styles:this.app.css.processNode_Area}).inject(this.node);this.setProcessNode(e,"process",function(i){this.processDlg=o2.DL.open({title:this.app.lp.process,style:this.json.dialogStyle||"user",isResize:!1,content:e,maskNode:this.app.content,positionHeight:800,maxHeight:800,maxHeightPercent:"98%",minTop:5,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.processor&&this.processor.okButton.click()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){this.processDlg.close(),this.processor&&this.processor.destroy()}.bind(this)}],onPostLoad:function(){i.options.mediaNode=this.content,t.call(this)}})}.bind(this),function(){this.processDlg&&t.call(this.processDlg,!0)}.bind(this))},processWork_mobile:function(){this.app.inBrowser&&this.app.content.setStyle("height",document.body.getSize().y),this.fireEvent("beforeProcessWork"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeProcessWork");var t=this.app.content.getPosition(this.app.content.getOffsetParent());if("Mobile"!=this.json.mode&&this.app.content.mask({destroyOnHide:!0,style:this.app.css.maskNode,useIframeShim:!0,iframeShimOptions:{browsers:!0},onShow:function(){this.shim.shim.setStyles({opacity:0,top:t.y+"px",left:t.x+"px"})}}),!this.formCustomValidation("",""))return this.app.content.unmask(),!1;if(!this.formValidation("",""))return this.app.content.unmask(),!1;var e=this.createProcessNode();this.setProcessNode(e),this.showProcessNode(e),e.setStyle("overflow","auto")},createProcessNode:function(){var t=this.app.css.processNode_from,e=this.app.css.processNode;if(layout.mobile&&(t=this.app.css.processNodeMobile_from,e=this.app.css.processNodeMobile,t.width="100%",e.width="100%",t.height="100%",e.height="100%"),"Mobile"==this.json.mode)var i=new Element("div",{styles:t}).inject(document.body);else i=new Element("div",{styles:t}).inject(this.app.content);return i.position({relativeTo:this.app.content,position:"topcenter",edge:"topcenter"}),i},getOpinion:function(){var t="",e=[];return Object.each(this.forms,function(i,s){"Opinion"===i.json.type&&this.businessData.data[s]&&(t+=" "+i._getBusinessSectionDataByPerson()),i.handwritingFile&&i.handwritingFile[layout.session.user.distinguishedName]&&e.push(i.handwritingFile[layout.session.user.distinguishedName]),i.soundFile&&i.soundFile[layout.session.user.distinguishedName]&&e.push(i.soundFile[layout.session.user.distinguishedName]),i.videoFile&&i.videoFile[layout.session.user.distinguishedName]&&e.push(i.videoFile[layout.session.user.distinguishedName])}.bind(this)),{opinion:t.trim(),medias:e}},setProcessNode:function(t,e,i,s){var o=this;MWF.xDesktop.requireApp("process.Work","Processor",function(){var n,a=this.getOpinion(),r=a.medias;layout.mobile&&(n=new Element("div").inject(t)),this.processor=new MWF.xApplication.process.Work.Processor(n||t,this.businessData.task,{style:layout.mobile?"mobile":e||"default",opinion:a.opinion,tabletWidth:this.json.tabletWidth||0,tabletHeight:this.json.tabletHeight||0,onPostLoad:function(){i&&i(this)},onResize:function(){s&&s()},onCancel:function(){t.destroy(),o.app.content.unmask()},onSubmit:function(e,i,s,n,a,l){if(s=s&&s.length?s.concat(r):r,this.toWordSubmitList&&this.toWordSubmitList.length){var h=[];this.toWordSubmitList.each((function(t){t.docToWord&&h.push(new Promise((function(e){t.docToWord(e)})))})),Promise.all(h).then(function(){o.submitWork(e,i,s,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,l)}.bind(this))}else o.submitWork(e,i,s,function(){this.destroy(),t.destroy(),o.processDlg&&o.processDlg.close()}.bind(this),this,null,n,a,l)}},this)}.bind(this))},showProcessNode:function(t){if(layout.mobile)t.setStyles(this.app.css.processNodeMobile);else{var e=this.app.content.getSize(),i=t.getSize(),s=e.y/2-i.y/2-20,o=e.x/2-i.x/2;s<0&&(s=0),this.app.css.processNode.top=s+"px",this.app.css.processNode.left=o+"px",new Fx.Morph(t,{duration:300,transition:Fx.Transitions.Expo.easeOut}).start(this.app.css.processNode)}},confirm:function(t,e,i,s,o,n,a,r,l,h,d){MWF.require("MWF.xDesktop.Dialog",function(){var l,c=this.container.getSize(),u=0,p=0;"element"===typeOf(e)?(u=(l=e.getPosition(this.app.content)).x,p=l.y):("firefox"==Browser.name?(u=parseFloat(e.event.clientX||e.event.x),p=parseFloat(e.event.clientY||e.event.y)):(u=parseFloat(e.event.x),p=parseFloat(e.event.y)),e.target&&(u=(l=e.target.getPosition(this.app.content)).x,p=l.y));u+parseFloat(o)>c.x&&(u-=parseFloat(o)),u<0&&(u=10),p+parseFloat(n)>c.y&&(p-=parseFloat(n)),p<0&&(p=10),u<0&&(u=20),layout.mobile||(u-=20);var f=new MWF.xDesktop.Dialog({title:i,style:d||"o2",top:p,left:u,fromTop:e.event.y,fromLeft:"firefox"===Browser.name?e.event.clientX-20:e.event.x-20,width:o,height:n,text:s,container:this.app.content,maskNode:h||this.app.content,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:a},{type:"cancel",text:MWF.LP.process.button.cancel,action:r}]});switch(t.toLowerCase()){case"success":this.json.confirmIcon&&this.json.confirmIcon.success?f.content.setStyle("background-image","url("+this.json.confirmIcon.success+")"):f.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB1hJREFUeNqsWGtsVEUUPnMf+y6rLcW2tDxUKARaikqgiWh8BlH8IwYkaozhh4nhB1FMTKkxQtQYQzRGE2JEfMRHYhQSVChgFYIGqLSUtoKUQmlp2b53u233de94zuzcZbfdbhdwkpPZmbl3zjffnHPuOcue/WgxZNnc3OT3cQ4rGIMlwNg8BjATGEwDDgHOeZdpQis3eKMR5Sd62kaO/PHp5QDub2ba9OtNTYnf2lQIcOO5igpr8eeT3kL9XneuCi6vAvYcFWxOBqrO6BlvZIx7w8PGwlG/uWZkwADNzo4//e7CfQMdYz/88t6F8/i+icB4Jl0sEzPIxEbsXiwotVd6C3TwTFezZRGCfQb4r0bhSnPo78io8dWP1ed24nRkPFNTMoMnnYNsbGYK2zR/pYsRGxJc1mDcuQqKHbwF2t3/Hh29a+3bC8oHOkM7UPk5UpGOpQQzFsINHyxahDaxdeYix/r8223AFLjpxpGL3rYIXDw5um+gc+ydwx9fqsPpKC0lP6eWr54hfjT+2gPP7Fg0R1HgreIyx/rpc2zxjfjNCzXXrSo4PMr8sWFecEuRo6mjMdBPdpQMJuWa6GoKF9jX55bo13UlE5jg8szobshyotG+RtT1OJrBAA43o/hRYhOYKVuVvxFtZPusCie7GUbQvcnmIBbh4noEoqR15zQV/N1GeXFZzvD5Y4P1ydclwJD7om1sn3uPs0S3x1++ESHlJgJB74FiXgkD4XZQLGr4NQtBh2DDvWa+3aOd7D4b7CGDFjcjr2dt3mxbpQNjB53sRsTA7YiN0IgBRWYlrJz2suhpTPO0bj1LegpKHWWFpZ6nUL0ngYOAUkBz34JAYjytEO1GJN5Pth4LmRAajkGxuQJWFb0CLpdL9DSmeVpPfp/0uXP1B2+b5y5A/cJbVLSVh9252uu5M/WM1BMYSLKBdFczS6mEx0peBbfbDU6nE1RVhdnOZdDj78AruyyvLP6+ZmMQDQMCYc3tp/xnKSAq9K2xuxmYBp8oeIJY2ITwSAxm8uWip7E43bj1ErYCHpsVB0KsOBwO0dOY5mdrlXhdSe+ikN6cPNtSeTsqgV2iOxRchFRBh4uGOSpCY8QTP5C/SfQ0pnkjmrq+es6WBBBN0wQrNpsNvF4vFBYWwgvL3ofFeY/EmZQ6SK/do5YiECeFGYW+vprGUu0AaY/iHYeDceqfmLtFKKGexjRP15K8ngxEUa6FbfpNwH5qfQua+w8lGCUhvbpDLZE2g8xgGkAhP4WRCJ3YhFk6KrozrignJ0f0NKb50LCRsp4OCJNu/X3LG3Cm92Dcm5LYJ71oO9MtMJrIRyguGzwRPelu5zoqYc28a4rodLqui2eexPk9/3DRTwXku6ZqaOo7KOw2bdqgMLf8EigaJUaxCHgT+yCY8hmPwrrFb4oNLbEUkGITj7iuoloozwTk28ZqONMzOZA4U3w07mLANMrQ0CO85GpWO+M7iKsMNlRsk2zxxP2TYo/HIwBZ43RAvmmohkZfzaRAqIlgGDH7rEChUaqIXrFQUVPfauiqEcifvWubUJAMiLwkLeUSyNenEMjVzECokTdGQman/FiaGuWs6DlrdNvENxs6DwCuw3PLtqcAygTkq5Nb4XT31EAEGIragVgrBTz6PmmUPBNdppH+hfrOGhEbnl8+OSALyJfHtwpGswFiXdNgV6jFAqPm3+7yOb36A5pdKaY906UF3f4LcNXfDhUlDyUUjwey+6+qOPAs0w8KH0NXI00nvu/aFQoaPnxtWKFyAhHui4Yw/0B20goyU3+5BnYfq0oASPYymqd1em7SPcYJ6fP7wn8OdYcp0RoRzFBiHPCFexRdqdR0VsRkzjpBiKGhC+BDhpbOfijBzOdHq+BU+4H4ic3sJIYRPtAbbWk+1Pv54JXQRdxmiExI+CTVNVROjI2YPGPeggrrLh2AXUeqBCvU09jk15f7kJ6+S6P7244PUT0VkDYTz/QoGf+ntr9h/srcIs2mLFVY5oyua7AVfIF2qGvbn5rFZSHESn9HaG/Nhxc/wxmylUErDxbMyBomQnVNcDC2Lyq9a1LB051o3T/hWzOV0L6D3eHalsN936K+PgkkYiWkyVWR+dsnl85RXRP0R3+OxbioEP4vof2GfOHac0f6v7h4cqhZghlNLldS6iZCiA/6qK7RnapLtSvlwCm43ES1QFdjco6s722q6d2NFcFp1NMjbSWWsdbGypIshj7POatfu+MlT55tnd2lljHOso1l18yIYYIeNFrIWGt3tv8o2SAZJu8h80iutRPMWE0aNFEXobqGygk0ar+iM5eqswIrqE0w3ASAeD8WjDX1d4ztIfet3+v7XRprL/0nQIxYtba8kan/hUDUikx8PJTFl96fdx/lrJQqUoZGiRHlI5QG0NeXPnr0raEQf7a2r04GtICU4FT/QmTDPJOGTqAcMnl2yrFNJkZWMIhJ7yAZk5E1JMfm+EI/naLraQRKlQBUKUoSGFNWh4YEZowv7jO1/wQYAIxJoZGb/Cz/AAAAAElFTkSuQmCC)");break;case"error":this.json.confirmIcon&&this.json.confirmIcon.error?f.content.setStyle("background-image","url("+this.json.confirmIcon.error+")"):f.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABsVJREFUeNqkWFtsFGUU/nZn2r21IqX3llp6AQmkWDVGAgIlGI0EeMAHffAFa998MCQaE8JDxZCgSHzQKIm3qPHFGC7GW0xqkIgIKhhEwFJaKSDQUtplu73s7vidmX/q32F2uw2TnOzMv2fO+f5z/8fci7yvWAZYRXo4CCwLAM1cq+HvXRYwQrrM/7rTwB+TwC/dwKG3uU75mVxCO7T7wExgKHiBATzJ2411wMoy3pSQ5gg6UiFpgpQgDZNukK6TLgBHuf7lAPD5q8DfXMpQl5U3mA4P4ztAO3+2tADLCQSV+VsR/5L+If0G/EqgH78EvKtwT1lqr0en6SfoLaCe1niB7nj+CQIuV+uZWYApV8RNPPAVcP/rQMtF4I03gbNcpjdvt5KxQXs4SKKflxBI54PAs20EElNvZTQJucjLFyUtpZwioJVurFtMD/4MXBXWDUqnL5jHHYt0PgQ8da/4UFMwThpTz0HF7wfEj0/kSKwVAwsZU5U1wKkTwOBBj7GD08xE17QSSJPanVCKlCSNkM5s2mT/JtV6epZ8InclsH4R9TjYRKWPZQixnch2POJsZNpOb5HOb9yIi5s3I5XJIHb2rL2LoBZL+fBZKhOZaS3LgPgh4HcnYZ34scFI+goQxsj8iA+QHipItrejrKwMiaVLMZJIIEpFAaUkH76AFrEVfLxEzzEej/0FXFOGc8CQ8bmFTOE6DciEUnCBCsapoLGxETU1NYhGo7i+YAHiSlFauWMmvqAGKOzcVzDlh2mdo2o/loCJkeEVRnldSMsGUdCrKaiqqkJxcTEikQgKCgpsRbJzk4oukm8iB1+CfEUKkLtZub/CZOsFvht0Qi1lrAfW0WwvN3gyI7J1K+7ZswfNzc0oLS1FKBRCMBiEaZoIh8OOovp6jI6NYXLLFjQ1NdlAxCKGYaCwsBAlJSWoJ08lwQZTKaSPHJmSL9YZZWZx438eZ8yLMwwWtWeYaqvv9oBJ8UWDyovWrUMgEPi/ZPPeBWT/rlhhx0h1dbUNRABPpSrvBVhixw4kd+26rRyMOq3jCl31kzya0vSiKgW91/DOnbZJ53V22iAsy5pSIopra2vtNflP3KIDcTcwuH074pQT8JEvelkMF4kjpBuY0n1Dbjj7XDcpSCCU+gCKxWK+77hABghkOAsQuUIOivmq3xrSm2qMLJZxrwEKlGJQ5QGUC8gVBSSYQ67hoCidAiPzSCCHZSxVlXopeHhiAk30v8RBtivFQO3etg1Du3fbbihQKe0L3MmqmGrYwaAMRuPKMl6aVCkeJ11jRvSuWYO+vj4kk0lf4bIu/wuf8MfV+5NZ5I87RhhVuAKmTGhsbHPCWSwiwoYoOMQ60tDQgPLycjvNfWOA6/J/Op3GefJzsMLcAwfs6PSz0JhTXAfcBDNlVCS0xaYHSEql3jCBRLSC5k3faV1XZZnwySWABmUqJKCo8oUOaNTZbL9SlzE4Niwh8lURLf/TyoQzAZFgdcmvDklhjKsKXKAqsF5rZEztAboOAz+KA4xHmeo0+tNFqky7VMkKfJ+nAnuV2rtn1pS0td32n16B67kpRjZuqQrs6pB5mW37s5OswoLNaOTUdRfQRjPWGhrqOF80aYVSTwXWgfQQSL8URiqa6wGkV+B+ZuAlTwUWF/VxyPoUeD/uTH5x4xhjiNapoHXWhj3l+ubhw0hTkbtz3SXdBNJHIJgFn+Vx0Tlg37eOi+RAkTTk+MDueY1WWc64qQ5oZpSXhpSiedrOz1HBBVWZZ8Pn0phzcjj9DfBBvz1r4aYkrz3PvEhZq9lIyfgY3RXwzrY3lKKytWtxhgp6fHaaL5+AoU8stulPvgB+UFZJuPOMPaF/D5wgoGq6q9XMosianER3FiD58iWcDNr/GvCegwtDbjeywShAGQ5Y3aYzZC00PELsDkxFmOGokosv6cy/XV8DHyr3XFfL1rSBnL/WNqKUcw3rQWWhD6A7oaSTPV1dwEecX07CmX1v6W3Re4iz5IAl5xqCiTIMW0zJ5DsAkXKOLxbHy/1iEQ3IiHdYmAbGdZccsBhDXXKcoMAyWqjCynJwywVCqjgbz2kJVokR5RoXyKRkctYTpQ5Iepica+Q4QesMU0GUoCozPjGS0QZ5t9uzJ51ioO6T9FVZc1XFiLgm5X6ROJjvJ5EOZ4iXwaeIs2Elz1WreExtlVFRJjQZjGQekTFAuq80PRazbp6JTtOyxy87FX9EkYCY8H6v6fDMNzNdagayQYXVZ5mIei7UmrHrnQlFSZXJY9qnECuXIjMPMJZ2lHIPj6aaGg0FNOD5CJHWjtl5f0n5T4ABAFHaXG6UVjGNAAAAAElFTkSuQmCC)");break;case"info":this.json.confirmIcon&&this.json.confirmIcon.info?f.content.setStyle("background-image","url("+this.json.confirmIcon.info+")"):f.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABvBJREFUeNqsWF1sFFUUPndm9n+3W5aWLi2VGgJtgy3UEn6MQGI0GgmC0UgfTEjEBxPDA29qYqLGGOODifGBGGOUYOKDPIg2QgykWgUtP1WgLT+lFKFCf9l2uz+z83c9Z3p3u1u6u4Pxpqczd+7MPd8999xzvrPskb2fgsMW4NzaBpxvBsbWMWCrgUEdAKsA4HHO+R2wrOucmxe5qZ9Jjt3ovtX1eRznt0pN2ndof+5eKYcAJ34YJPlFvH3OFV7+uOyPgOQLg+wJAXP5gMkueifM9XTYzMw2W+mZnWbqHjDF09Pc8WFneur2kaHOjwbxewuB8VK6WCnLoCVexcsrnmWNW1zhKMiBKqdWBDM5CfrMKKh3+8+bWurw1W/f/gwfawstVdYyuNIGtMYBxqT9/lVbmRyIZMFlUeKfCdyiPi0WN02ScPdkvGX2KxJa0IOiVETbU0O/Ptr00getamzkY1R+lbAuZiV52fpnC4FY5lqQpPe80bX7/A2bmIRbQcpzggAQLFhaGiw1aV+5nqEPEQcjWDnAJJLLC57q1Ux2+9tATzwUXN40PH3j7Nj4hWMW6cbr4mDmLIJAals63Esbsk8LhFsGAkjBY3UaPN8M8HKbBGsiHBRmwK1pEy0kC+Pkf4eK/EtA8gTX8Mxs1Lukti9+6+IUAco3ROE24dZ4apo6XEvq57dkQbPQKtsQ575NleB1z30erQbYsMoApScJ3bd1kMRWLWw0r9/Ud+Ci72H3AMoMinGfZchZ0Ufe961Yz/LNvFBoi/ZuDMKaukoIBAIQDofB7XaD1+MGl8Thl6EMWkYq+r3srQAzfrc1VN8yG7t26k/UpGfNJ+WOL54ab30746TQMkuIBVuaaiAUCoHf7wdFUewr9ek5jZf8HucnPe7Q0j3R9t0tqNdtn4AsGIoj7sjKLbI3ZDtiKSEnvTyqgSzLhScB+/ScxsvNQXq8NY0twdrGF/DTYBYH/QtQQJN9lbZzlhOa7MRADHRDnB4h1KfnNO5kHtLnCkSeCERXR4V1QK5e98yTij/ypquyrug+Fwhu7+BoGsbjGngVCaoq3NA7PAuHT4/BjxdjUMrf8oUpqN/IRNGO/TM3e69QQFQo1zB3wN7PMokht+802Q/nUij/5MVyNnesJTnrAmUb6UXfacPb71ESCiU9CkxQBsxcfFHB0tXFjz2CkRQP5iw/AlIcgSG9sjfYiLc+CjMKZV8mk4GM0mBw/MDTUdjc4ANVVUHXdftk5AIWnqozf6tw8FQc44yz/EV6ZZe3XvgM9ogGUFwoYxmav7IyAitXLgNN0yCRSNiAcgHN5YJdyyU42N2LSzYdopHId6rmwdh8BBz4DMA7Ry7D71fG4d2OFjvQFVqOg2EY837lsGGADIhMIFGojIOpoWUMB2LCsd4RSGdKbKmjeYSgXgSeEoZnCjE0y8iEMa06Wgk3DQxOJiZvdFhJWsTRnVuGIxjL0CazGVWxqaKeaba5iLMZcoGu2Dg4BYPUA0/niEiWlkKc1TLUnXYQcjKBZZQd55azhaFeMNLx6xTwiHApRJ65oTleTdn3rAewDOpVY3cGcmCIxQfrPD3I6DYRuS5vGbPsuBOfISqiJyb7Jge6zmE3TVslUTmBCDs5miy3qqJCJ6CMItPMnbxSQvoyM2OnM9N3iWglbcsQW6dyAq2yW5Hk9rncUiQ3oSKT9hnjCTkwRd15DKb93DRwkQwToVw8R5Hl0CoDscE/TmI3jqLSBttnk+oaKiesTJIT4V5MuGHY5Ht7cxWk00jGrcL8RH16TuM2STcMKDYX6UlN3Dw+PdQzKMBoOdpJDH1qoOuvSOPWWklxt9krWkg3cTVv7NkAr+3aaFNNsko+n6G+z+eDra0PQU2lD37rv7MonSBfUaduHx0+/skXODqGEsvyYNsyoobRqK4xUrFOCkZ2vMgThqYPBUMQDAbtYJcPJCv0nMbpPXp/4Rw0L/pI12T/yW9Q36QAomU5cEFFiQWW0vDU6xu9kRVvuXwVO+wE+n81pB2Z+HjX1JXuQ1NzJ2i0aHVADbeLU4FFdY3s9vkll6eVAWcLa6cHFeQ/XL03cnTi0k9fYUVwgVQJXzGKVpTCfywqsBB9F5UTyDmq8aTVsP8Cgk5ZJjGQHL32NfkIBrjhPCA6uUfRijIfEO0l1TWKJ3gWnXoG61w/U1zRnFPC/VVjlvFRM9REH4aM7yYunfhy7PzRn4WzThC9pOFsrZ0PpuSvEOhDkiA+QWLxS5u2byPOSlSRGBoRI+IjRAMo+1LSo1xDIZ4iqwhocSGJcr9COCGITJw6AuUVpY1P9N2CGDFhHkOcDk2E+KQIaNS3Ck24uKIHaQRKFgBkIVIeGFJoCjHE1XI6+b8CDABnZtjY0mkIGQAAAABJRU5ErkJggg==)");break;case"warn":this.json.confirmIcon&&this.json.confirmIcon.warn?f.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")"):f.content.setStyle("background-image","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABgtJREFUeNqsWG2IlFUUft6vmdlZd539GFdTY5VMomy1oBJUSPLXkmQt5I8gCIMK+iH0K4ooEvtTRP7JX9JKWCC1mUUkIkQKSoaZH60t2pboOK37Mc6Ozsw779t57t5xx5ndnTvhC4d373nnnnPuOeee85y1Jr+G6dNcCrBB6AnbQo9tY4UFLLYstIYhMsK/IjRULOF0voATx87jp60fICPygzmFbpn+26pnzK0ilrk2+kTp5kgC6+w4YDfJxpiQJ+QAYUmoKHQLCG4K5YDsCI7fzOPgcBr7172BP0VUILrC/22MnHSbvF6KLcRap1WMmGfsRQRZ2Z8BJv7BybEs9t6/DbuFXaj2VKUx7ize6BZvbHcdvB67D5bdrD/ocwUiruiLZPFGSbziiHci4iVPpEn41MM9pPZWPBofwiOX9uDh05fwkSgf5Dln8lKNZwo+HnRsvBVbjK1eJ39RdWIxJCfhGB0HxjNTBtGQhHiuPQHEY9MG3X5EbXEESA3i4KmL2Ln5Xfwi3CINmjVM9IjnYGeTGOJ2zOx+SU5cE8Hp/DMIopvgxFejlDsFO38IC6ID6JIDRCMz7/WvA1cG8d2PJ/H2y5/gLA2a9ndVmBia2CIxpL3yJ1XG5MUzTh8S3e/B9Zo09x74xSeRS7vyfT+i3sx7KXfRCvSuz2NUltuFJmhj+btdmazMEa+NsZidfIYlsQXzE51oa2tDV1eXenNNPr/PtZ/ylybxwtEP8Ypw4pU22OXrq27NvZIh4dzCeI07lvQiHo8jFovBdV315pp8fp9rP+VTT/cCPL/jRawSTqScma4OT1+sA2vtqN4w552V03meMsKyprLblowlj2s/qC+DepJLsWpjD56T5aDOnRI908yC5jTVOVEl1THWhKhPwrVx/UNYqL0DmyU+0iyVNWooKKxjTGgmh/o6k+h5tRcbhBNTDla9JtKAV+6SZ5RBondZF9YwOkKOq5qeZ6CkUpmJMQYP9Xa0YqX8ySRxXdV9bXMBloShnLg134RvhQ3IEr2tTViqc8ZxNQwwFuCJANsqiOJ4jSHke40cTPQ2RdFZNsYmHrEaiHVEmqI/drTGO+paC5/fTWVRghTaZl1ibJvAqG6hqqygIsG+/iXCID8VFk1ck+9Z5rKoV8BYThc9yyVCE2A0nyDJKOmEoiP98GV7mNwKO7EOwfjPwL9fKL7q2CUzWTRGANiILgghjRkKfTwAyxw4cWt4pR+F4X72NAn2FIxQzg4aECMtcmISl3WzDFxi1sDH046hZ4JQ45kbgmeyFXhGUGB7i8YzhgcTvbg2jiHCKPrTJXgmE56ZgKIoH5XGn/YEz3QLnpm/GrcmTiE9dkiOOaBuU9QzN+bsMM7dNoYo/qk1OC597vEahDbDU5BtuVbBMysr8ExS45lBV74LnjHwMhFjahRndn2rUN9NhsrmOEEUX/LNbgB/F13yLBJtyTvwDNfkNyLnj8s4dv5vBbQmVdcmWuc4IYl0MjC44jz0guWb0NLSojAMoQTfXJPvGNQs6hGvnNt7GIeFkyGk4hcVGM41HCcEZIV1ix53jJ+QieDOWKi18CN2fWOo58QF/PD5ETVPZXTO3IZ8Aeea9Dj2FOt4R7WDq1L0SlVFT9bke3WMofzf/8I3fTvwlXAYomy5IChj9AxT4FyTmsBBPyyXoVpSRe9qP8LfXkNw7ZAaIfnmmnwbs++l3AspHPl4APuEw2I3pr0S1owqMsO4B97BYz3L8eaiFvR6uHsPceWFNI7s/h6f7TqgblBq1umgPCRwwOJcc3EEe3NsOXN4yYRUkRQ5vw5j4P19+FQbkha6Ud04aiZK8Y6lS2ALxwmi+GQcqxyGKDT3RCBSSkKpLM4xWXWOjGi6UXeirDKI1yXOcYIonuC5s1lQoTbKKlPZCdYUBZpSGZxhHeH11bdmVOdIrnLWNv4vhPzQ1sBnHlE8wTMxK6EiERqBEfEIYQC7L5seew1LPCurLmgZTdl6/4UwaWmWzq2IRvHNGrNGNLmYdpCvb0dBl/hJXdAKJrOF1eClsHX4XP12NM+qGFJKmnz9NgYV/wkwAMYATK0QLuhAAAAAAElFTkSuQmCC)");break;default:this.json.confirmIcon&&this.json.confirmIcon.warn&&f.content.setStyle("background-image","url("+this.json.confirmIcon.warn+")")}f.show()}.bind(this))},alert:function(t,e,i,s,o){this.app.alert(t,"center",e,i,s,o)},notice:function(t,e,i,s,o,n){s||(s={x:"right",y:"top"}),e||(e="ok");var a=i||this.app.window.content,r=o;r||(r={x:10,y:(s.y.toString().toLowerCase(),10)});var l={type:e,position:s,move:!1,target:a,delayClose:"error"===e?1e4:5e3,offset:r,content:t};this.json.noticeStyle&&(l=Object.merge(l,this.json.noticeStyle)),this.json["notice"+e.capitalize()+"Style"]&&(l=Object.merge(l,this.json["notice"+e.capitalize()+"Style"])),n&&"object"===typeOf(n)&&(l=Object.merge(l,n)),new mBox.Notice(l)},addSplit:function(){if(!this.businessData.control.allowAddSplit)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,600,230),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.addSplit,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:600,height:230,url:this.app.path+"split.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){var o=i.content.getElement("input"),n=i.content.getElements(".o2_addSplit_radio"),a=o.get("value"),r=!0;n[1].checked&&(r=!1),e.doAddSplit(i,a,r)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){var t=i.content.getElement(".o2_addSplit_selector"),s=i.content.getElement("input");i.content.getElements(".o2_addSplit_radio");t.addEvent("click",function(){var t=s.get("value");MWF.xDesktop.requireApp("Selector","package",function(){new o2.O2Selector(e.app.content,{type:"",count:0,values:t?t.split(o2.splitStr):[],types:["unit","identity","group","role"],onComplete:function(t){var e=[];t.each((function(t){e.push(t.data.distinguishedName)})),s.set("value",e.join(", "))}})}.bind(this))}.bind(this))}});i.show()}.bind(this))},doAddSplit:function(t,e,i){if(!e)return this.app.notice(MWF.xApplication.process.Xform.LP.inputSplitValue,"error",t.node),!1;MWF.require("MWF.widget.Mask",function(){var s=e.split(o2.splitStr);this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeAddSplit"),this.addSplitWork(s,i,function(e){this.fireEvent("afterAddSplit"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterAddSplit"),this.addAddSplitMessage(e.data),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},addSplitWork:function(t,e,i,s){var o={splitValueList:t,trimExist:e};this.options.readonly?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){i&&i(t)}.bind(this),(function(t,e,i){s&&s(t,e,i)})):this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id,o,function(t){i&&i(t)}.bind(this),(function(t,e,i){s&&s(t,e,i)}))}.bind(this),(function(t,e,i){s&&s(t,e,i)}),!0,null,!0)},setRollBackChecked:function(t){t.store("isSelected",!0),t.setStyles(this.css.rollbackItemNode_current),t.getFirst().setStyles(this.css.rollbackItemIconNode_current);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode_current),e.getLast().setStyles(this.css.rollbackItemTimeNode_current),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode_current),e.getLast().setStyles(this.css.rollbackItemTaskNode_current);var i=t.getElements("input");i&&i.set("checked",!0)},setRollBackUnchecked:function(t){t.store("isSelected",!1),t.setStyles(this.css.rollbackItemNode),t.getFirst().setStyles(this.css.rollbackItemIconNode);var e=t.getLast().getFirst();e.getFirst().setStyles(this.css.rollbackItemActivityNode),e.getLast().setStyles(this.css.rollbackItemTimeNode),(e=t.getLast().getLast()).getFirst().setStyles(this.css.rollbackItemTaskTitleNode),e.getLast().setStyles(this.css.rollbackItemTaskNode);var i=t.getElements("input");i&&i.set("checked",!1)},getRollbackLogs:function(t){var e=this;o2.Actions.load("x_processplatform_assemble_surface").WorkLogAction.listRollbackWithWorkOrWorkCompleted(this.businessData.work.id,function(i){i.data.each(function(i){if(!i.splitting&&i.connected){var s=new Element("div",{styles:this.css.rollbackItemNode}).inject(t);s.store("log",i);new Element("div",{styles:this.css.rollbackItemIconNode}).inject(s);var o=new Element("div",{styles:this.css.rollbackItemContentNode}).inject(s),n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemActivityNode,text:i.fromActivityName}).inject(n),new Element("div",{styles:this.css.rollbackItemTimeNode,text:i.arrivedTime}).inject(n);n=new Element("div",{styles:{overflow:"hidden"}}).inject(o);new Element("div",{styles:this.css.rollbackItemTaskTitleNode,text:this.app.lp.taskCompletedPerson+": "}).inject(n);if(i.taskCompletedList.length)i.taskCompletedList.each(function(t){var e=o2.name.cn(t.person)+"("+t.completedTime+")";new Element("input",{value:t.identity,type:"checkbox",styles:this.css.rollbackItemTaskCheckNode}).inject(n).addEvent("click",(function(t){t.stopPropagation()}));new Element("div",{styles:this.css.rollbackItemTaskNode,text:e}).inject(n)}.bind(this));else{var a=this.app.lp.systemFlow;new Element("div",{styles:this.css.rollbackItemTaskNode,text:a}).inject(n)}s.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(e.css.rollbackItemNode)},click:function(){this.retrieve("isSelected")?e.setRollBackUnchecked(this):(t.getChildren().each((function(t){e.setRollBackUnchecked(t)})),e.setRollBackChecked(this))}})}}.bind(this))}.bind(this),null,!1)},rollback:function(){if(!this.businessData.control.allowRollback)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;var t=MWF.xApplication.process.Xform.LP,e=new Element("div",{styles:this.css.rollbackAreaNode}),i='<div style="line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:left;">'+t.selectRollbackActivity+"</div>";i+="<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:right;\"><input class='rollback_flowOption' checked type='checkbox' />"+t.tryToProcess+"</div>",i+='<div style="clear:both; max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',e.set("html",i);var s=e.getLast();this.getRollbackLogs(s),e.inject(this.app.content);var o=o2.DL.open({title:this.app.lp.rollback,style:this.json.dialogStyle||"user",isResize:!1,content:e,width:600,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,i){this.doRollback(e,i,o)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){o.close()}}]})},doRollback:function(t,e,i){for(var s=t.getLast().getChildren(),o=t.getElement(".rollback_flowOption").checked,n=this,a=0;a<s.length;a++)if(s[a].retrieve("isSelected")){var r=this.app.lp.rollbackConfirmContent,l=s[a].retrieve("log"),h=s[a].getElements("input:checked"),d=[];h.each((function(t){var e=t.get("value");-1==d.indexOf(e)&&d.push(e)})),r=r.replace("{log}",l.fromActivityName+"("+l.arrivedTime+")"),this.app.confirm("infor",e,this.app.lp.rollbackConfirmTitle,r,450,120,(function(){n.doRollbackAction(l.id,o,i,d),i.close(),this.close()}),(function(){this.close()}),null,null,this.json.confirmStyle);break}},doRollbackAction:function(t,e,i,s){MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeRollback"),this.doRollbackActionInvoke(t,e,s,function(t){if(t.data.properties)this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage(t.data);else{var e=t.data.id;this.workAction.listTaskByWork(function(t){this.fireEvent("afterRollback"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRollback"),this.addRollbackMessage_old(t.data)}.bind(this),null,e)}this.app.inBrowser||this.app.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(t,e,i){var s=i+":"+e;t&&(s=t.responseText),this.app.notice("request json error: "+s,"error"),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},doRollbackActionInvoke:function(t,e,i,s,o){if(this.businessData.work.completedTime){o2.Actions.get("x_processplatform_assemble_surface").rollbackWorkcompleted(this.businessData.work.id,{workLog:t},function(t){s&&s(t)}.bind(this),function(t,e,i){o&&o(t,e,i)}.bind(this))}else{var n={workLog:t,taskCompletedIdentityList:i,processing:!!e};o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Rollback(this.businessData.work.id,n,function(t){s&&s(t)}.bind(this),function(t,e,i){o&&o(t,e,i)}.bind(this))}},inBrowserDkg:function(t){if(this.mask&&this.mask.hide(),this.json.submitedDlgUseNotice)if(MWF.xDesktop.notice("success",{x:"right",y:"top"},t),!1!==this.json.isPrompt){if(0!=this.json.promptCloseTime){a=1e3*(a=this.json.promptCloseTime||2).toInt();var e=this;window.setTimeout((function(){e.app.close()}),a)}}else this.app.close();else{var i=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden"}}).inject(this.app.content);if(i.set("html",t),!1!==this.json.isPrompt){var s={content:i,isTitle:!1,width:350,height:180,buttonList:[{text:MWF.xApplication.process.Xform.LP.ok,action:function(){n.close(),this.app.close()}.bind(this)}]},o=this.app.content.getSize();switch(this.json.promptPosition||"righttop"){case"lefttop":s.top=10,s.left=10,s.fromTop=10,s.fromLeft=10;break;case"righttop":s.top=10,s.left=o.x-360,s.fromTop=10,s.fromLeft=o.x-10;break;case"leftbottom":s.top=o.y-190,s.left=10,s.fromTop=o.y-10,s.fromLeft=10;break;case"rightbottom":s.top=o.y-190,s.left=o.x-360,s.fromTop=o.y-10,s.fromLeft=o.x-10;break;default:delete s.top,delete s.left,delete s.fromTop,delete s.fromLeft}var n=o2.DL.open(s);if(0!=this.json.promptCloseTime){var a;a=1e3*(a=this.json.promptCloseTime||2).toInt();e=this;window.setTimeout((function(){n.close(),e.app.close()}),a)}}else this.app.close()}},addRollbackMessage_old:function(t){var e=[];t.each(function(t){e.push(MWF.name.cn(t.person)+"("+MWF.name.cn(t.unit)+")")}.bind(this));var i="<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+'<font style="color: #ea621f">'+t[0].activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+'<font style="color: #ea621f">'+e.join(", ")+"</font></b></div>";if(layout.desktop.message){var s={subject:MWF.xApplication.process.Xform.LP.workRollback,content:"<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+i};return layout.desktop.message.addTooltip(s),layout.desktop.message.addMessage(s)}this.app.inBrowser&&this.inBrowserDkg("<div>"+MWF.xApplication.process.Xform.LP.rollbackWorkInfor+"“"+this.businessData.work.title+"”</div>"+i)},addRollbackMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRollback,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rollbackWorkInfor))},pressWork:function(t){t&&t.setDisable&&t.setDisable(!0),o2.Actions.get("x_processplatform_assemble_surface").press(this.businessData.work.id,function(e){var i=o2.name.cns(e.data.valueList).join(", ");this.app.notice(MWF.xApplication.process.Xform.LP.sendTaskNotice.replace("{users}",i),"success"),t&&t.setDisable&&t.setDisable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))},pauseTask:function(t){return this.businessData.control.allowPause?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").pauseTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.pauseWork,"success"),this.businessData.control.allowResume=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},resumeTask:function(t){return this.businessData.control.allowResume?this.businessData.task?(t&&t.disable&&t.disable(!0),o2.Actions.get("x_processplatform_assemble_surface").resumeTask(this.businessData.task.id,function(e){this.app.notice(MWF.xApplication.process.Xform.LP.resumeWork,"success"),this.businessData.control.allowPause=!0,t&&t.enable&&t.enable(!1)}.bind(this),(function(t,e,i){if(0!=t.status){var s=i;if(t){var o=JSON.decode(t.responseText);s=o?o.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}))):void 0:(MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1)},downloadAll:function(){var t="";o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.uploadWorkInfo(this.businessData.work.id,"pdf",{workHtml:this.app.content.get("html"),pageWidth:1e3},function(e){t=e.data.id}.bind(this),null,!1),t=t.replace("#","%23");var e="/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/work/"+this.businessData.work.id+"/site/(0)/stream";e=o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface")+e),window.open(o2.filterUrl(e+"?fileName=&flag="+t))},resetWork:function(){if(!this.businessData.control.allowReset)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.reset,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"reset.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doResetWork(i)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){$("resetWork_selPeopleButton").addEvent("click",function(){e.selectPeople(this)}.bind(this))}});i.show()}.bind(this))},selectPeople:function(t){var e=this.businessData.activity.resetRange||"department",i=this.businessData.activity.resetCount||0;switch(e){case"unit":this.selectPeopleUnit(t,this.businessData.task.unit,i);break;case"topUnit":MWF.require("MWF.xScript.Actions.UnitActions",function(){orgActions=new MWF.xScript.Actions.UnitActions;var e={unitList:[this.businessData.task.unit]};orgActions.listUnitSupNested(e,function(e){v=e.data[0],this.selectPeopleUnit(t,v,i)}.bind(this))}.bind(this));break;case"script":o2.Actions.load("x_processplatform_assemble_surface").ProcessAction.getActivity(this.businessData.work.activity,"manual",function(e){if(e.data.activity.resetRangeScriptText){var s=this.Macro.exec(e.data.activity.resetRangeScriptText,this);this.selectPeopleUnit(t,"",i,s)}}.bind(this));break;default:this.selectPeopleAll(t,i)}},selectPeopleUnit:function(t,e,i,s){var o=t.identityList||[],n=$("resetWork_selPeopleArea"),a={values:o,type:"identity",count:i,units:e?[e]:[],title:this.app.lp.reset,onComplete:function(e){n.empty();var i=[];e.each(function(t){new MWF.widget.O2Identity(t.data,n,{style:"reset"}),i.push(t.data.distinguishedName)}.bind(this)),t.identityList=i}.bind(this)};s&&(a.noUnit=!0,a.include="array"===typeOf(s)?s:[s]),MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,a)}.bind(this))},selectPeopleAll:function(t,e){var i=t.identityList||[],s=$("resetWork_selPeopleArea"),o={values:i,type:"identity",count:e,title:this.app.lp.reset,onComplete:function(e){s.empty();var i=[];e.each(function(t){new MWF.widget.O2Identity(t.data,s,{style:"reset"}),i.push(t.data.distinguishedName)}.bind(this)),t.identityList=i}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,o)}.bind(this))},doResetWork:function(t){var e=t.identityList||[];if(!e.length)return this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople,"error",t.node),!1;var i=$("resetWork_opinion").get("value"),s=t.content.getElement(".resetWork_keepOption").checked,o=[];e.each((function(t){o.push(MWF.name.cn(t))})),i||(i=MWF.xApplication.process.Xform.LP.resetTo+": "+o.join(", ")),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("beforeReset"),this.resetWorkToPeson(e,i,s,function(e){this.fireEvent("afterReset"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReset"),this.addResetMessage(e.data),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},resetWorkToPeson:function(t,e,i,s,o){var n={opinion:e,routeName:MWF.xApplication.process.Xform.LP.reset,identityList:t,keep:!!i};this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(function(t){s&&s(t)}.bind(this),(function(t,e,i){o&&o(t,e,i)}),this.businessData.task.id,n)}.bind(this),(function(t,e,i){o&&o(t,e,i)}),!0,null,!0)},addAddSplitMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.addSplitWork,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.addSplitWorkInfor))},addResetMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReset,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.resetWorkInfor))},retractWork:function(t,e){var i=this;if("Mobile"==this.json.mode){var s=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+s.x+" , y:"+s.y);var o=s.x,n={event:{x:o=s.x<20?20:s.x,y:s.y-200,clientX:o,clientY:s.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){i.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){i.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),i.mask.loadNode(i.app.content),i.fireEvent("beforeRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("beforeRetract"),i.doRetractWork(function(){i.fireEvent("afterRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("afterRetract"),i.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),i.app.content.unmask(),i.mask&&(i.mask.hide(),i.mask=null),i.finishOnMobile()}.bind(this),(function(t,e,s){i.app.content.unmask();var o=s+":"+e;t&&(o=t.responseText),i.app.notice("request json error: "+o,"error"),i.mask&&(i.mask.hide(),i.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{n={event:{x:(s=MWF.getCenterPosition(this.app.content,300,150)).x,y:s.y-200,clientX:s.x,clientY:s.y-200}};this.app.confirm("infor",n,MWF.xApplication.process.Xform.LP.retractTitle,MWF.xApplication.process.Xform.LP.retractText,300,120,(function(){i.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){i.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),i.mask.loadNode(i.app.content),i.fireEvent("beforeRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("beforeRetract"),i.doRetractWork(function(t){i.fireEvent("afterRetract"),i.app&&i.app.fireEvent&&i.app.fireEvent("afterRetract"),i.app.notice(MWF.xApplication.process.Xform.LP.workRetract,"success"),i.app.content.unmask(),i.mask&&(i.mask.hide(),i.mask=null),i.app.reload(),this.close()}.bind(this),(function(t,e,s){i.app.content.unmask();var o=s+":"+e;t&&(o=t.responseText),i.app.notice("request json error: "+o,"error"),i.mask&&(i.mask.hide(),i.mask=null)}))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}},doRetractWork:function(t,e){this.businessData.control.allowRetract?o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Retract(this.businessData.work.id,null,function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)})):e&&e(null,"Permission Denied","")},addRetractMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workRetract,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.retractWorkInfor))},rerouteWork:function(t,e){if(!this.businessData.control.allowReroute)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,560,260),e=this,i=new MWF.xDesktop.Dialog({title:this.app.lp.reroute,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:560,height:260,url:this.app.path+"reroute.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){e.doRerouteWork(i)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){i.close()}}],onPostShow:function(){var t=$("rerouteWork_selectActivity");e.workAction.getRerouteTo(e.businessData.work.process,function(i){i.data.agentList.each(function(e){new Element("option",{value:e.id+"#agent",text:e.name}).inject(t)}.bind(e)),i.data.cancelList.each(function(e){new Element("option",{value:e.id+"#cancel",text:e.name}).inject(t)}.bind(e)),i.data.choiceList.each(function(e){new Element("option",{value:e.id+"#choice",text:e.name}).inject(t)}.bind(e)),i.data.delayList.each(function(e){new Element("option",{value:e.id+"#delay",text:e.name}).inject(t)}.bind(e)),i.data.embedList.each(function(e){new Element("option",{value:e.id+"#embed",text:e.name}).inject(t)}.bind(e)),i.data.endList.each(function(e){new Element("option",{value:e.id+"#end",text:e.name}).inject(t)}.bind(e)),i.data.invokeList.each(function(e){new Element("option",{value:e.id+"#invoke",text:e.name}).inject(t)}.bind(e)),i.data.manualList.each(function(e){new Element("option",{value:e.id+"#manual",text:e.name}).inject(t)}.bind(e)),i.data.mergeList.each(function(e){new Element("option",{value:e.id+"#merge",text:e.name}).inject(t)}.bind(e)),i.data.messageList.each(function(e){new Element("option",{value:e.id+"#message",text:e.name}).inject(t)}.bind(e)),i.data.parallelList.each(function(e){new Element("option",{value:e.id+"#parallel",text:e.name}).inject(t)}.bind(e)),i.data.serviceList.each(function(e){new Element("option",{value:e.id+"#service",text:e.name}).inject(t)}.bind(e)),i.data.splitList.each(function(e){new Element("option",{value:e.id+"#split",text:e.name}).inject(t)}.bind(e))}.bind(e)),this.content.getElement(".rerouteWork_selPeopleButton").addEvent("click",function(){e.selectReroutePeople(this)}.bind(this))}});i.show()}.bind(this))},selectReroutePeople:function(t){var e=t.identityList||[],i=t.content.getElement(".rerouteWork_selPeopleArea"),s={values:e,type:"identity",count:0,title:this.app.lp.reroute,onComplete:function(e){i.empty();var s=[];e.each(function(t){new MWF.widget.O2Identity(t.data,i,{style:"reset"}),s.push(t.data.distinguishedName)}.bind(this)),t.identityList=s}.bind(this)};MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,s)}.bind(this))},doRerouteWork:function(t){var e=$("rerouteWork_opinion").get("value"),i=$("rerouteWork_selectActivity"),s=i.options[i.selectedIndex].get("value"),o=i.options[i.selectedIndex].get("text"),n=s.split("#");s=n[0];var a=n[1],r=[];(t.identityList||[]).each((function(t){r.push(t)})),MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),this.fireEvent("beforeReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterRetract"),this.rerouteWorkToActivity(s,a,e,r,function(e){this.fireEvent("afterReroute"),this.app&&this.app.fireEvent&&this.app.fireEvent("afterReroute"),this.addRerouteMessage(e.data),this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk+": "+o,"success"),this.app.inBrowser||this.app.close(),t.close(),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),this.app.notice("request json error: "+o,"error",t.node),this.mask&&(this.mask.hide(),this.mask=null)}.bind(this))}.bind(this))},rerouteWorkToActivity:function(t,e,i,s,o,n){var a={activity:t,activityType:e,mergeWork:!1,manualForceTaskIdentityList:s};this.businessData.task?this.saveFormData(function(t){o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,i){n&&n(t,e,i)}))}.bind(this),(function(t,e,i){n&&n(t,e,i)}),!0,null,!0):o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id,a,function(t){o&&o(t)}.bind(this),(function(t,e,i){n&&n(t,e,i)}))},addRerouteMessage:function(t){if(layout.desktop.message){var e={subject:MWF.xApplication.process.Xform.LP.workReroute,content:this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor)};return layout.desktop.message.addTooltip(e),layout.desktop.message.addMessage(e)}this.app.inBrowser&&this.inBrowserDkg(this.getMessageContent(t,0,MWF.xApplication.process.Xform.LP.rerouteWorkInfor))},deleteDraftWork:function(){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var i=e.x,s={event:{x:i=e.x<20?20:e.x,y:e.y-200,clientX:i,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,null,this.json.confirmStyle)}else{s={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.doDeleteWork(function(){t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error"),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}},deleteWork:function(){if(this.businessData.work.startTime){var t=this;if("Mobile"===this.json.mode){var e=MWF.getCenterPosition(document.body,300,150);console.log("position x:"+e.x+" , y:"+e.y);var i=e.x,s={event:{x:i=e.x<20?20:e.x,y:e.y-200,clientX:i,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText.text,300,120,(function(){t.app.content.mask({style:{"background-color":"#999",opacity:.6}}),MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.mask&&(t.mask.hide(),t.mask=null),t.finishOnMobile()}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}else{s={event:{x:(e=MWF.getCenterPosition(this.app.content,380,150)).x,y:e.y-200,clientX:e.x,clientY:e.y-200}};this.app.confirm("infor",s,MWF.xApplication.process.Xform.LP.deleteWorkTitle,MWF.xApplication.process.Xform.LP.deleteWorkText,380,120,(function(){MWF.require("MWF.widget.Mask",function(){t.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),t.mask.loadNode(t.app.content),t.fireEvent("beforeDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("beforeDelete"),t.doDeleteWork(function(){t.fireEvent("afterDelete"),t.app&&t.app.fireEvent&&t.app.fireEvent("afterDelete"),t.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+t.businessData.work.title+"”","success"),t.app.close(),this.close(),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this),function(e,i,s){var o=s+":"+i;e&&(o=e.responseText),t.app.notice("request json error: "+o,"error",dlg.node),t.mask&&(t.mask.hide(),t.mask=null)}.bind(this))}.bind(this))}),(function(){this.close()}),null,this.app.content,this.json.confirmStyle)}}else this.deleteDraftWork()},doDeleteDraftWork:function(t,e){this.workAction.deleteDraftWork(function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)}),this.businessData.work.id)},doDeleteWork:function(t,e){this.businessData.work.startTime?this.businessData.control.allowDelete?this.workAction.abandoned(function(e){t&&t(e)}.bind(this),(function(t,i,s){e&&e(t,i,s)}),this.businessData.work.id):e&&e(null,"Permission Denied",""):this.doDeleteDraftWork(t,e)},printWork:function(t,e){var i=t||this.businessData.work?this.businessData.work.application:this.businessData.workCompleted.application;if((e=e)||(e=this.json.id,this.json.printForm&&(e=this.json.printForm)),this.businessData.workCompleted){i=t||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+e))}else{i=t||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+e))}},readedWork:function(t){if(!this.businessData.control.allowReadProcessing)return MWF.xDesktop.notice("error",{x:"right",y:"top"},"Permission Denied"),!1;MWF.require("MWF.xDesktop.Dialog",function(){var t=MWF.getCenterPosition(this.app.content,680,300),e=this.businessData.work.title,i=MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",e);MWF.xApplication.process.Xform.LP.form.setReadedConfirmInfo=i;var s=new MWF.xDesktop.Dialog({title:MWF.xApplication.process.Xform.LP.setReadedConfirmTitle,style:this.json.dialogStyle||"user",top:t.y-100,left:t.x,fromTop:t.y-100,fromLeft:t.x,width:680,height:300,url:this.app.path+"readed.html",lp:MWF.xApplication.process.Xform.LP.form,container:this.app.content,isClose:!0,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,e){this.doReadedWork(s)}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){s.close()}}]});s.show()}.bind(this))},doReadedWork:function(t){for(var e=t.content.getElement(".readedWork_opinion").get("value"),i=null,s=0;s<this.businessData.readList.length;s++)if(this.businessData.readList[s].person===layout.session.user.distinguishedName){i=this.businessData.readList[s];break}var o=this;i?MWF.require("MWF.widget.Mask",function(){this.mask=new MWF.widget.Mask({style:"desktop",zIndex:5e4}),this.mask.loadNode(this.app.content),i.opinion=e,this.app.action.setReaded((function(){o.mask&&(o.mask.hide(),o.mask=null),o.fireEvent("afterReaded"),o.app.reload(),layout.mobile?o.finishOnMobile():t.close()}),null,i.id,i)}.bind(this)):(o.app.reload(),layout.mobile?o.finishOnMobile():t.close())},openWindow:function(t,e){if((t=t)||(t=this.json.id),this.businessData.workCompleted){var i=e||this.businessData.workCompleted.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+i+"&form="+t))}else{i=e||this.businessData.work.application;window.open(o2.filterUrl("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+i+"&form="+t))}},uploadedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(e){var i=this.all[t];i&&(e.data&&i.attachmentController.addAttachment(e.data),i.attachmentController.checkActions(),i.fireEvent("upload",[e.data]))}.bind(this))},replacedAttachment:function(t,e){this.workAction.getAttachment(e,this.businessData.work.id,function(i){var s=this.all[t];if(s){for(var o=s.attachmentController,n=null,a=0;a<o.attachments.length;a++)if(o.attachments[a].data.id===e){n=o.attachments[a];break}n.data=i.data,n.reload(),o.checkActions()}}.bind(this))},finishOnMobile:function(){var t=this;this.workAction.checkDraft(this.businessData.work.id,function(e){t.finishOnMobileReal()}.bind(this),(function(){t.finishOnMobileReal()}),!1)},finishOnMobileReal:function(){if(window.o2android&&window.o2android.closeWork)window.o2android.closeWork("");else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.closeWork)window.webkit.messageHandlers.closeWork.postMessage("");else if(window.wx&&"miniprogram"===window.__wxjs_environment)wx.miniProgram.navigateBack({delta:1});else if(window.uni&&window.uni.navigateBack)window.uni.navigateBack();else if("redirect"===this.json.afterProcessAction&&this.json.afterProcessRedirectScript&&this.json.afterProcessRedirectScript.code){var t=this.Macro.exec(this.json.afterProcessRedirectScript.code,this);new URI(t).go()}else{if(window.history.length>1)history.back();else{var e=new URI(window.location.href).getData("redirectlink");e?(history.replaceState(null,"work",e),e.toURI().go()):(window.location=o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"),history.replaceState(null,"work",o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter")),o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go())}}},getModuleType:function(t){if("string"===typeOf(t)&&(t=this.all[t]),t){var e=t.json.moduleName||"";return e||(e="string"===typeOf(t.json.type)?t.json.type.toLowerCase():""),e.toLowerCase()}return""}});var PortalPage="";MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.process.Xform.$Module=MWF.APP$Module=new Class({Implements:[Events],options:{moduleEvents:["load","queryLoad","postLoad"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i},_getSource:function(){for(var t=this.node.getParent();t&&"source"!=t.get("MWFtype")&&"subSource"!=t.get("MWFtype")&&"subSourceItem"!=t.get("MWFtype");)t=t.getParent();return t?t.retrieve("module"):null},hide:function(){var t=this.node.getStyle("display");"none"!==t&&this.node.store("mwf_display",t),this.node.setStyle("display","none"),this.iconNode&&this.iconNode.setStyle("display","none")},show:function(){var t=this.node.retrieve("mwf_display",t);this.node.setStyle("display",t),this.iconNode&&this.iconNode.setStyle("display","block")},load:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._loadDomEvents(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(t,e){if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")||-1!=t.indexOf("x_cms_assemble_control")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface"),o=MWF.Actions.getHost("x_cms_assemble_control");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),-1!==t.indexOf("/x_cms_assemble_control")?t=t.replace("/x_cms_assemble_control",o+"/x_cms_assemble_control"):-1!==t.indexOf("x_cms_assemble_control")&&(t=t.replace("x_cms_assemble_control",o+"/x_cms_assemble_control")),t=o2.filterUrl(t)}this.node.setStyle(e,t)}.bind(this))},_loadModuleEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_getBusinessData:function(){var t;if("yes"==this.json.section)t=this._getBusinessSectionData();else{if("Opinion"!==this.json.type)return this.getBusinessDataById()||"";t=this._getBusinessSectionDataByPerson()}return t},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript?this.json.sectionByScript.code:"");default:return this.getBusinessDataById()||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.id]=layout.desktop.session.user.id;var t=this.getBusinessDataById();return t&&t[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.task?this.form.businessData.task.unit:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.work?this.form.businessData.work.activity:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.businessData.work?this.form.businessData.work.splitValue:"";return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_getBusinessSectionDataByScript:function(t){this.form.sectionListObj[this.json.id]="";var e=this.getBusinessDataById();if(!e)return"";var i=this.form.Macro.exec(t,this);return i&&(this.form.sectionListObj[this.json.id]=i),i&&e[i]||""},_setBusinessData:function(t){"yes"==this.json.section?this._setBusinessSectionData(t):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(t):(this.form.businessData.data[this.json.id]?this.setBusinessDataById(t):(this.setBusinessDataById(t),this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=t))},_setBusinessSectionData:function(t){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(t);break;case"unit":this._setBusinessSectionDataByUnit(t);break;case"activity":this._setBusinessSectionDataByActivity(t);break;case"splitValue":this._setBusinessSectionDataBySplitValue(t);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,t);break;default:this.form.businessData.data[this.json.id]?this.setBusinessDataById(t):(this.setBusinessDataById(t),this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(t){var e=!1,i=layout.desktop.session.user.id,s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t,e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(t){var e=!1,i=this.form.businessData.task?this.form.businessData.task.unit:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.activity:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(i){var s=this.getBusinessDataById();s||(s={},this.setBusinessDataById(s),e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(t,e){var i=!1,s=this.form.Macro.exec(t,this);if(s){var o=this.getBusinessDataById();o||(o={},this.setBusinessDataById(o),i=!0),o[s]||(i=!0),o[s]=e}i&&this.form.Macro.environment.setData(this.form.businessData.data)},getBusinessDataById:function(){if(this.json.id.indexOf("..")<1)return this.form.businessData.data[this.json.id];var t=this.json.id.split("..");t=t.map((function(t){return t.test(/^\d+$/)?t.toInt():t}));for(var e=this.form.businessData.data,i=t.length-1,s=0;s<=i;s++){var o=t[s];if(!o&&0!==o)return null;if(!["object","array"].contains(o2.typeOf(e)))return null;if(s===i)return e[o];e=e[o]}},setBusinessDataById:function(t){if(this.json.id.indexOf("..")<1)this.form.businessData.data[this.json.id]=t;else{var e=this.json.id.split("..");e=e.map((function(t){return t.test(/^\d+$/)?t.toInt():t}));for(var i=this.form.businessData.data,s=e.length-1,o=0;o<=s;o++){var n=e[o];if(!n&&0!==n)return;if(o===s)i[n]=t;else{var a=e[o+1];if("number"===o2.typeOf(a)){if(i[n]||"array"===o2.typeOf(i[n])||(i[n]=[]),a>i[n].length)return}else i[n]&&"object"===o2.typeOf(i[n])||(i[n]={});i=i[n]}}}},_queryLoaded:function(){},_afterLoaded:function(){},setValue:function(){},focus:function(){this.node.focus()},_getModuleByPath:function(t){if(t){var e=this.json.id.split("..");if(t.contains("*")){for(var i=t.split("."),s=0;s<i.length;s++)if(i[s].contains("*")&&e[s]){var o=i[s].replace("*",e[s]);o=this.form.Macro.exec("return "+o,this),i[s]=(o||"").toString()}t=i.join("..")}else if(t.contains("./")){var n=t.substring(t.indexOf("./")+2,t.length),a=(t.substring(0,t.indexOf("./"))+".").split(".").length-1,r=Array.clone(e);if(r.length>2*a){for(s=0;s<a;s++)r.pop(),s>0&&r.pop();t=r.join("..")+".."+n}else r[r.length-1]=n,t=r.join("..")}return this.form.all[t]}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.$Input=MWF.APP$Input=new Class({Implements:[Events],Extends:MWF.APP$Module,iconStyle:"personfieldIcon",initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this._loadNode(),"show"===this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):(this.node.getFirst()||this.node).addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadNode:function(){this.readonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(e-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&(this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none"),this.clickSelect()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)}))},checkDescription:function(){this.node.getFirst().get("value")?this.descriptionNode&&this.descriptionNode.setStyle("display","none"):this.descriptionNode&&this.descriptionNode.setStyle("display","block")},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",border:"0px"},readonly:!0}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,readonly:!0,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:this.clickSelect.bind(this)}}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this))},_loadStyles:function(){if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},_computeValue:function(t){return this.json.defaultValue&&this.json.defaultValue.code?this.form.Macro.exec(this.json.defaultValue.code,this):t||""},getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();return t||(t=this._computeValue()),t||""},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",t||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,t},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(){},_afterLoaded:function(){this.readonly||this.json.isReadonly||this.loadDescription()},isReadonly:function(){return!(!this.readonly&&!this.json.isReadonly)},getTextData:function(){var t=this.node.getFirst()?this.node.getFirst().get("value"):this.node.get("text");return{value:[t||""],text:[(this.node.getFirst()?this.node.getFirst().get("text"):this.node.get("text"))||t||""]}},isEmpty:function(){var t=this.getData();return!t||!t.trim()},getData:function(t){return"save"==this.json.compute&&this._setValue(this._computeValue()),this.getInputData()},getInputData:function(){return this.node.getFirst()?this.node.getFirst().get("value"):this._getBusinessData()},resetData:function(){this.setData(this.getValue())},setData:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setData(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setData(t)},__setData:function(t){this._setBusinessData(t),this.node.getFirst()?(this.node.getFirst().set("value",t),this.checkDescription(),this.validationMode()):this.node.set("text",t),this.moduleValueAG=null},createErrorNode:function(t){var e;if(this.form.json.errorStyle){if("notice"===this.form.json.errorStyle.type)this.form.errorNoticing||(this.form.errorNoticing=!0,this.form.notice(t,"error",this.node,null,null,{onClose:function(){this.form.errorNoticing=!1}.bind(this)}));else if(e=new Element("div",{styles:this.form.json.errorStyle.node,text:t}),this.form.json.errorStyle.close)new Element("div",{styles:this.form.json.errorStyle.close,events:{click:function(){this.destroy()}.bind(e)}}).inject(e)}else{e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{height:"20px","line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e)}return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border-color","red"),this.errNode=this.createErrorNode(t),this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node);for(var e=this.node;null===e.offsetParent;)e=e.getParent();e.isIntoView()||e.scrollIntoView()}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==(e.get("MWFtype")||e.get("mwftype"))&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData(),s="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.readonly&&!this.json.isReadonly){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);if(this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"!=i.toString())return this.notValidationMode(i),!1}return!0}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Div=MWF.APPDiv=new Class({Extends:MWF.APP$Module}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Combox=MWF.APPCombox=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"selectIcon",options:{moduleEvents:["load","queryLoad","postLoad","commitInput","change"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_loadNodeEdit:function(){this.node.empty(),MWF.require("MWF.widget.Combox",function(){this.combox=select=new MWF.widget.Combox({onlySelect:"y"===this.json.onlySelect,count:this.json.count.toInt()||0,splitStr:this.json.splitStr||",\\s*|;\\s*|，\\s*|；\\s*",splitShow:this.json.splitShow||", ",list:this.getOptions(),onCommitInput:function(t){this.fireEvent("commitInput")}.bind(this),onChange:function(){this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions()})}.bind(this),!1),select.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_searchOptions:function(){return"dynamic"===this.json.itemType?function(t,e){var i={value:t,callback:e};this.form.Macro.fire(this.json.itemDynamic?this.json.itemDynamic.code:"",this,i)}.bind(this):null},getOptions:function(){var t=[];if("values"===this.json.itemType?t=this.json.itemValues:"script"===this.json.itemType&&(t=this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)),t.length){var e=[];return t.each(function(t){if("object"===typeOf(t))e.push(t);else{t=t.toString(),arr=t.split("|");var i={text:"",keyword:"",value:""};switch(arr.length){case 0:break;case 1:i.text=arr[0],i.keyword=arr[0],i.value=arr[0];break;case 2:i.text=arr[0],i.keyword=arr[0],i.value=arr[1];break;case 3:i.text=arr[0],i.keyword=arr[1],i.value=arr[2];break;default:i.text=arr[0],i.keyword=arr[1],i.value=arr[2]}e.push(i)}}.bind(this)),e}return[]},setData:function(t){this._setBusinessData(t),this._setValue(t)},_setValue:function(t){if(t||(t=[]),1!=t.length||t[0]||(t=[]),"array"!==typeOf(t)&&(t=[t]),this.combox)this.combox.clear(),comboxValues=[],t.each(function(t){"object"===typeOf(t)?comboxValues.push({text:t.text||t.title||t.subject||t.name,value:t}):comboxValues.push(t.toString())}.bind(this)),this.combox.addNewValues(comboxValues);else{var e=new Element("div",{styles:{overflow:"hidden"}}).inject(this.node);t.each(function(i,s){var o="";o="object"===typeOf(i)?i.text||i.title||i.subject||i.name:i.toString(),s<t.length-1&&(o+=this.json.splitShow),new Element("div",{styles:{float:"left","margin-right":"5px"},text:o}).inject(e)}.bind(this))}},resetOption:function(){if(this.combox){var t=this.getOptions();this.combox.setOptions({list:t})}},addOption:function(t,e){if(this.combox){var i=this.getOptions();i.push({text:t,value:e}),this.combox.setOptions({list:i})}},isEmpty:function(){var t=this.getData();return"array"===typeOf(t)?0===t.length:!t},getInputData:function(){return this.combox?this.combox.getData():this._getBusinessData()},getTextData:function(){var t=this.getData();return{value:t,text:t}},resetData:function(){this.setData(this.getValue())}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridMobile=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","hidden"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.createMobileTable(),this.editable=!this.readonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._loadEditDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._loadReadDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},createMobileTable:function(){var t=new Element("table").inject(this.node);t.set(this.json.properties);var e=this.table.getElements("tr"),i=e[0].getElements("th"),s=e[1].getElements("td");i.each(function(e,i){var o=t.insertRow();new Element("th").inject(o).set({html:e.get("html"),id:e.get("id"),mwftype:e.get("mwftype")}),new Element("td").inject(o).set({html:s[i].get("html"),id:s[i].get("id"),mwftype:s[i].get("mwftype")});var n=this.form._getDomjson(e);n&&!1===n.isShow&&o.hide()}.bind(this)),this.table.destroy(),this.table=null,this.table=t},_loadStyles:function(){this.node.setStyles(this.json.styles),this.node.getElements("table").each(function(t){t.setStyles(this.json.tableStyles)}.bind(this))},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.isAG||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||[]},getValue:function(){return this._getValue()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var s=0;s<i.json.itemValues.length;s++){var o=i.json.itemValues[s].split(/\|/),n=o[0];if(e===(o.length>1?o[1]:o[0]))return n}break;case"Radio":var a=i.node.getElements("input");for(s=0;s<a.length;s++)if(a[s].value==e)return a[s].get("showText");break;case"Checkbox":a=i.node.getElements("input");var r=[];for(s=0;s<a.length;s++)-1!=e.indexOf(a[s].value)&&r.push(a[s].get("showText"));if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var l=[];return e.each(function(t){"object"===typeOf(t)?l.push(t.name+(t.unitName?"("+t.unitName+")":"")):l.push(t)}.bind(this)),l.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var h=new RegExp("\n","g"),d=new RegExp("<","g"),c=new RegExp(">","g");e=e.replace(d,"&lt").replace(c,"&gt").replace(h,"<br/>")}return e},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),(function(){}));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,s){var o=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?o.inject(this.totalDiv,"before"):o.inject(this.node),this._createItemTitleNode(o,s);var n=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(o),a=new Element("table").inject(n);a.set(this.json.properties),a.store("data",t),e.each(function(e,o){var n=a.insertRow(o),r=new Element("th").inject(n);r.set("text",e.get("text")),r.setStyle("width","30%");var l=n.insertCell(1);l.set("MWFId",i[o].get("id"));var h=t[e.get("id")];if("array"!==typeOf(h))if(h)for(key in h){var d=h[key],c=this.editModules[o];c&&"ImageClipper"==c.json.type?this._createImage(l,c,d):!c||"Attachment"!=c.json.type&&"AttachmentDg"!=c.json.type?(text=this._getValueText(o,d),c&&"Textarea"==c.json.type?l.set("html",text):l.set("text",text)):this._createAttachment(l,c,d);break}else l.setStyle("text-align","left"),l.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&n.hide()}.bind(this))}.bind(this)),t&&t()},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data.length?(this.addAction&&this.addAction.setStyle("display","none"),this.gridData.data.each(function(t,s){var o=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?o.inject(this.totalDiv,"before"):o.inject(this.node),this._createItemTitleNode(o,s);var n=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(o),a=new Element("table").inject(n);a.set(this.json.properties),a.store("data",t),e.each(function(e,o){var n=a.insertRow(o),r=new Element("th").inject(n);r.set("text",e.get("text")),r.setStyle("width","30%");var l=n.insertCell(1);l.set("MWFId",i[o].get("id"));var h=t[e.get("id")];if("array"!==typeOf(h))if(h)for(key in h){var d=h[key],c=this.editModules[o];c&&"ImageClipper"==c.json.type?this._createImage(l,c,d):!c||"Attachment"!=c.json.type&&"AttachmentDg"!=c.json.type?(text=this._getValueText(o,d),c&&"Textarea"==c.json.type?l.set("html",text):l.set("text",text)):this._createAttachment(l,c,d);break}else l.setStyle("text-align","left"),l.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&n.hide()}.bind(this));o.getSize()}.bind(this))):this.addAction?this.addable&&this.addAction.setStyle("display","block"):this.addable&&this._loadAddAction(),t&&t()},_loadActions:function(t){var e=new Element("div",{styles:this.form.css.mobileDatagridActionNode}).inject(t),i=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(e);this.deleteable||i.hide();var s=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit}).inject(e),o=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add}).inject(e);this.addable||o.hide();var n=new Element("div",{styles:this.form.css.mobileDatagridCancelActionNode,text:MWF.xApplication.process.Xform.LP.cancelEdit}).inject(e),a=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit}).inject(e),r=this;this.deleteable&&i.addEvent("click",(function(t){r._deleteLine(this.getParent().getParent().getParent(),t)})),s.addEvent("click",(function(t){r._editLine(this.getParent().getParent().getParent(),t)})),a.addEvent("click",(function(t){r._completeLineEdit()})),n.addEvent("click",(function(t){r._cancelLineEdit(t)})),this.addable&&o.addEvent("click",(function(t){r._addLine()}))},_createImage:function(t,e,i){(t.empty(),i)&&new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top").setStyles({"max-width":"90%"})},_createAttachment:function(t,e,i){t.empty();var s={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(s.readonly=!0),this.editable||this.addable||(s.readonly=!0);i.each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var o=new MWF.xApplication.process.Xform.AttachmentController(t,e,s);o.load(),i.each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;o.addAttachment(e)}.bind(this))},_createItemTitleNode:function(t,e){var i=e+1,s=new Element("div",{styles:this.json.itemTitleStyles}).inject(t);s.setStyle("overflow","hidden");new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item+i}).inject(s);0!=this.editable&&this._loadActions(s)},_createHelpNode:function(){this.helpNode=new Element("div",{styles:this.form.css.mobileGridHelpNode}).inject(this.node,"top"),this.helpContentNode=new Element("div",{styles:this.form.css.mobileGridHelpContentNode}).inject(this.helpNode),this.helpContentNode.set("html",MWF.xApplication.process.Xform.LP.mobileGridHelp),new mBox.Tooltip({content:this.helpContentNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.helpNode,transition:"flyin",position:{x:["right"],y:["center"]},event:"click"})},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.currentEditLine=t;var e=t.getElement("table");if(this.currentEditLine){this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.table.inject(e,"after"),e.setStyle("display","none");var i=this.currentEditLine.getFirst("div").getLast("div").getElements("div");i[0]&&i[0].setStyle("display","none"),i[1]&&i[1].setStyle("display","none"),i[2]&&i[2].setStyle("display","none"),i[3]&&i[3].setStyle("display","block"),i[4]&&i[4].setStyle("display","block");var s=this.currentEditLine.getElement("table").retrieve("data");this.table.getElements("th").each(function(t,e){var i=t.get("id"),o=this.editModules[e];o&&("sequence"==o.json.type?o.node.set("text",this.currentEditLine.getElement("table").getElements("tr")[e].getElement("td").get("text")):s[i]?o.setData(s[i][o.json.id]):o.setData(null))}.bind(this)),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},_loadAddAction:function(){this.addAction||(this.addAction=new Element("div",{styles:this.form.css.gridMobileActionNode}).inject(this.node,"top"),this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.addEvent("click",function(){this._addLine()}.bind(this)))},_addLine:function(){if(this.isEdit&&!this._completeLineEdit())return!1;this.addAction&&this.addAction.setStyle("display","none");var t,e=this.node.getElements("table"),i=new Element("div.datagridDataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?(t=e.length-2,i.inject(this.totalDiv,"before")):(t=e.length-1,i.inject(this.node)),this._createItemTitleNode(i,t);var s=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(i);this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.currentEditLine=null,this.table.inject(s),this.isEdit=!0;var o=i.getFirst("div").getLast("div").getElements("div");o[0]&&o[0].setStyle("display","none"),o[1]&&o[1].setStyle("display","none"),o[2]&&o[2].setStyle("display","none"),o[3]&&o[3].setStyle("display","block"),o[4]&&o[4].setStyle("display","block"),i.isIntoView()||i.scrollIntoView(!0),this.validationMode(),this.fireEvent("addLine",[this.table])},_cancelLineEdit:function(t){var e=this,i=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){if(e.isEdit=!1,e.currentEditLine){e.currentEditLine.getElement("table").setStyle("display","table");var s=e.currentEditLine.getFirst("div").getLast("div").getElements("div");s[0]&&this.deleteable&&s[0].setStyle("display","block"),s[1]&&s[1].setStyle("display","block"),s[2]&&this.addable&&s[2].setStyle("display","block"),s[3]&&s[3].setStyle("display","none"),s[4]&&s[4].setStyle("display","none"),e._editorTrGoBack()}else{var o=t.target.getParent(".datagridDataDiv");e._editorTrGoBack(),o&&o.destroy()}e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.currentEditLine=null,i.gridData.data.length||(i.addAction?i.addable&&i.addAction.setStyle("display","block"):i.addable&&i._loadAddAction()),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e,i=!1,s={},o=null;if(this.currentEditLine){o=this.currentEditLine,s=o.getElement("table").retrieve("data"),this.currentEditLine.getElement("table").setStyle("display","table"),e=o.getElement("table"),(n=this.currentEditLine.getFirst("div").getLast("div").getElements("div"))[0]&&this.deleteable&&n[0].setStyle("display","block"),n[1]&&n[1].setStyle("display","block"),n[2]&&this.addable&&n[2].setStyle("display","block"),n[3]&&n[3].setStyle("display","none"),n[4]&&n[4].setStyle("display","none")}else{var n,a=this.table.getParent(".datagridDataDiv");a&&a.removeClass("datagridDataDiv").addClass("dataDiv"),(n=this.table.getParent().getPrevious("div").getLast("div").getElements("div"))[0]&&this.deleteable&&n[0].setStyle("display","block"),n[1]&&n[1].setStyle("display","block"),n[2]&&this.addable&&n[2].setStyle("display","block"),n[3]&&n[3].setStyle("display","none"),n[4]&&n[4].setStyle("display","none"),(e=new Element("table",{styles:this.json.tableStyles}).inject(this.table,"before")).set(this.json.properties),s={}}var r=this.node.getElements("table"),l=this.table.getElements("th"),h=this.table.getElements("td"),d=e.getElements("tr");return l.each(function(t,o){var n=d[o],a=t.get("id"),l=this.editModules[o];if(l){var c,u;if("sequence"==l.json.type)this.currentEditLine?c=this.currentEditLine.getElement("table").getElements("tr")[o].getElement("td").get("text"):(c=r.length-1,this.totalTable&&(c=r.length-2)),p={value:[c],text:[c]};else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type){i=!0;var p=l.getTextData();s[a]||(s[a]={}),s[a][l.json.id]=p}else(p=l.getTextData()).value.length<2?(s[a]||(s[a]={}),s[a][l.json.id]=p.value[0]):(s[a]||(s[a]={}),s[a][l.json.id]=p.value);if(n)if(u=n.getElement("td"),"ImageClipper"==l.json.type)this._createImage(u,l,p.text);else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type)this._createAttachment(u,l,p);else{var f=this._getValueText(o,p.text.join(", "));l&&"Textarea"==l.json.type?u.set("html",f):u.set("text",f)}else{n=e.insertRow(o);var m=new Element("th").inject(n);m.set("text",t.get("text")),m.setStyle("width","30%"),(u=n.insertCell(1)).set("MWFId",h[o].get("id"));p[t.get("id")];if("ImageClipper"==l.json.type)this._createImage(u,l,p.text);else if("Attachment"==l.json.type||"AttachmentDg"==l.json.type)this._createAttachment(u,l,p);else{f=this._getValueText(o,p.text.join(", "));l&&"Textarea"==l.json.type?u.set("html",f):u.set("text",f)}}}else if(!n){n=e.insertRow(o);var g=new Element("th").inject(n);g.set("text",t.get("text")),g.setStyle("width","30%"),u=n.insertCell(1)}var y=this.form._getDomjson(t);y&&!1===y.isShow&&n.hide(),l=null}.bind(this)),e.store("data",s),e.setStyle("display","table"),this.currentEditLine=null,this._editorTrGoBack(),this.getData(),this._loadDatagridStyle(),this.validationMode(),this.fireEvent("completeLineEdit",[e]),this.addAction&&(this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.removeEvents("click"),this.addAction.addEvent("click",function(){this._addLine()}.bind(this))),i&&this.form.saveFormData(),!0},_editorTrGoBack:function(){this.table.setStyle("display","none"),this.table.inject(this.node,"top")},_actionMousedown:function(t,e){t.retrieve("editStatus")||t.store("editStatus",new Date),this._checkMouseDown(t)},_checkMouseDown:function(t){var e=t.retrieve("editStatus");e&&((new Date).getTime()-e.getTime()>1e3?(this._editLine(t),t.eliminate("editStatus")):window.setTimeout(function(){this._checkMouseDown(t)}.bind(this),1e3))},_actionMouseup:function(t,e){t.eliminate("editStatus")},actionTouchstart:function(t,e){var i={x:e.touches[0].pageX,y:e.touches[0].pageY};t.retrieve("action")?t.store("touchStatus",{p:i,status:"hide",isHide:!1}):t.store("touchStatus",{p:i,status:"show"}),this._actionMousedown(t,e)},actionTouchmove:function(t,e){var i=t.retrieve("touchStatus"),s=i.p,o=i.status,n=e.touches[0].pageX,a=e.touches[0].pageY;(Math.abs(s.x-n)>10||Math.abs(s.y-a)>10)&&this._actionMouseup(t),"show"==o?s.x-n>20&&Math.abs(s.y-a)<40&&(this.showMoveAction(t,s.x-n),e.preventDefault()):n-s.x>20&&Math.abs(s.y-a)<40&&(i.isHide=!0,this.hideMoveAction(t,n-s.x),e.preventDefault())},actionTouchend:function(t,e){var i=t.retrieve("touchStatus");i.p;"show"==i.status?t.retrieve("action")&&this.showEndMoveAction(t):i.isHide&&this.hideEndMoveAction(t)},actionTouchcancel:function(t,e){this._actionMouseup(t)},showEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","60px"),new Fx.Tween(i,{duration:100}).start("margin-right","60px");var s=this;e.addEvent("click",(function(e){s._deleteLine(t,e)}))},_deleteLine:function(t,e){var i=!1,s=t.getElement("table");if(s){var o=this,n=this;this.form.confirm("warn",e,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){n.fireEvent("deleteLine",[s]);var e=s.retrieve("data");n.table.getElements("th").each((function(t,s){var o=t.get("id"),a=n.editModules[s];o&&a&&("Attachment"==a.json.type||"AttachmentDg"==a.json.type)&&(i=!0,e[o][a.json.id].each((function(t){n.form.workAction.deleteAttachment(t.id,n.form.businessData.work.id)})))})),t.destroy(),o._loadSequence(),o._loadTotal(),o.getData(),n.gridData.data.length||(n.addAction?n.addable&&n.addAction.setStyle("display","block"):n.addable&&n._loadAddAction()),this.close(),n.fireEvent("afterDeleteLine"),i&&n.form.saveFormData()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},hideEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","0px"),new Fx.Tween(i,{duration:100}).start("margin-right","0px").chain((function(){e.destroy(),t.eliminate("action")}))},showMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div");if(!i){var o=t.getSize();i=new Element("div",{styles:this.form.css.gridMobileDeleteActionAreaNode}).inject(t,"top");new Element("div",{styles:this.form.css.gridMobileDeleteActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(i);i.setStyle("height",o.y+"px"),i.setStyle("line-height",o.y+"px"),t.store("action",i)}e>60&&(e=60),i.setStyle("width",e+"px"),s.setStyle("margin-right",e+"px")},hideMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div"),o=60-e;o<0&&(o=0),i&&i.setStyle("width",o+"px"),s.setStyle("margin-right",o+"px")},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.table&&(this.json.editStyles&&this.table.getElements("td").setStyles(this.json.editStyles))},loadGridTitleStyle:function(){this.json.titleStyles&&this.node.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.node.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){(this.json.zebraColor||this.json.backgroundColor)&&this.node.getElements("table").each(function(t){this._loadTableZebraStyle(t)}.bind(this))},_loadTableZebraStyle:function(t){for(var e=t.getElements("tr"),i=0;i<e.length;i++)this.json.backgroundColor&&e[i].setStyle("background-color",this.json.backgroundColor),i%2==0&&this.json.zebraColor&&e[i].setStyle("background-color",this.json.zebraColor)},createTotalDiv:function(){this.totalDiv=new Element("div.totalDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node),new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv).set("text",MWF.xApplication.process.Xform.LP.amount);var t=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(this.totalDiv);this.totalTable=new Element("table",{styles:this.json.tableStyles}).inject(t),this.totalTable.set(this.json.properties)},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalDiv||this.createTotalDiv();for(var e=[],i=this.node.getElements("table"),s=1;s<i.length-1;s++){var o=i[s].getElements("td");this.totalModules.each(function(i,s){e[s]||e.push(0);var n=new Decimal(e[s]);if("number"==i.type){var a=o[i.index].get("text").toFloat();n=n.plus(a||0)}"count"==i.type&&(n=n.plus(1)),e[s]=n.toString(),t[i.module.json.id]=e[s]}.bind(this))}var n=this.totalTable.getElements("tr");if(this.totalModules.each(function(t,i){var s=n[i];if(s)s.getElement("td").set("text",e[i]||"");else{s=this.totalTable.insertRow(i);var o=new Element("th").inject(s);o.set("text",t.module.node.get("text")),o.setStyles(this.json.titleStyles),s.insertCell(1).setStyles(this.json.amountStyles).set("text",e[i]||"")}!1===t.isShow&&s.hide(),this.totalResaults[t.module.json.id]=e[i]}.bind(this)),this.totalTable)this.totalTable.getElements("th").setStyles(this.json.titleStyles)}return t},_loadSequence:function(){this.node.getElements("table").each(function(t,e){t.getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}.bind(this)),this.node.getElements(".sequenceDiv").each((function(t,e){t.set("text",MWF.xApplication.process.Xform.LP.item+(e+1))}))},_loadBorderStyle:function(){this.json.border&&this.node.getElements("table").each(function(t){this._loadTableBorderStyle(t)}.bind(this))},_loadTableBorderStyle:function(t){t.setStyles({"border-top":this.json.border,"border-left":this.json.border}),t.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),t.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),t.store("module",s),this.form.modules.push(s)}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none")}.bind(this)):(this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none"))},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit){if(this.isEdit=!1,this.currentEditLine)this._editorTrGoBack(),this.currentEditLine.destroy();else{var e=this.node.getElement(".datagridDataDiv");this._editorTrGoBack(),e&&e.destroy()}this.currentEditLine=null}if(this.gridData){for(var i=this.node.getElements(".dataDiv"),s=0;s<i.length;s++){for(var o=i[s].getElement("table"),n=o.getElements("td"),a=0;a<n.length;a++){var r=n[a].retrieve("module");r&&(this.form.modules.erase(r),r=null)}for(var l=o.getElements("th"),h=0;h<l.length;h++){var d=l[h].retrieve("module");d&&(this.form.modules.erase(d),d=null)}}for(s=0;s<i.length;s++)i[s].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.node.getElements("table"),i=1;i<(this.totalTable?e.length-1:e.length);i++){var s=e[i].retrieve("data");s&&t.push(s)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px","text-align":"left",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.DatagridMobile$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:this.node.getParent("tr").rowIndex,type:this.json.total,isShow:this.json.isShow})}}),MWF.xApplication.process.Xform.DatagridMobile$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}}),t.empty()}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t),i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),s.dataModule=this,this.dataGrid.editModules.push(s)}.bind(this))}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridPC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine","export","import","validImport"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.editable=!this.readonly&&!0!==this.json.isReadonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.importenable=this.editable&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable="impexp"===this.json.impexpType||"exp"===this.json.impexpType,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._addTitleActionColumn(),this._loadEditDatagrid(function(){this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._getDatagridEditorTr(),this._loadReadDatagrid(function(){this.editorTr&&this.editorTr.setStyle("display","none"),this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},_loadStyles:function(){this.table.setStyles(this.json.tableStyles),this.node.setStyles(this.json.styles)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||{}},getValue:function(){return this._getValue()},_getDatagridTr:function(){this._getDatagridTitleTr(),this._getDatagridEditorTr()},_getDatagridTitleTr:function(){return this.titleTr=this.table.getElement("tr"),this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");return this.editorTr=t[t.length-1],this.editorTr.addClass("datagridEditorTr"),this.editorTr},_addTitleActionColumn:function(){this.titleTr||this._getDatagridTitleTr(),this.editorTr||this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom"),this.addable&&this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e),this.deleteable&&this._createCancelAction(e),new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.titleTr.getElements("th"),i=this.editorTr.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,s){var o=$(this.table.insertRow(s+1));o.store("data",t),e.each(function(n,a){var r=t[n.get("id")],l="";if("array"!==typeOf(r))for(key in r){var h=r[key];l=this._getValueText(a-1,h);break}this._createNewEditTd(o,a,i[a].get("id"),l,e.length-1,s)}.bind(this))}.bind(this)),this.editorTr.setStyle("display","none"),t&&t()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var s=0;s<i.json.itemValues.length;s++){var o=i.json.itemValues[s].split(/\|/),n=o[0];if(e===(o.length>1?o[1]:o[0]))return n}break;case"Radio":var a=i.node.getElements("input");for(s=0;s<a.length;s++)if(a[s].value==e)return a[s].get("showText");break;case"Checkbox":a=i.node.getElements("input");var r=[];for(s=0;s<a.length;s++)-1!=e.indexOf(a[s].value)&&r.push(a[s].get("showText"));if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var l=[];return e.each(function(t){"object"===typeOf(t)?l.push(t.name+(t.unitName?"("+t.unitName+")":"")):l.push(t)}.bind(this)),l.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var h=new RegExp("\n","g"),d=new RegExp("<","g"),c=new RegExp(">","g");e=e.replace(d,"&lt").replace(c,"&gt").replace(h,"<br/>")}return e},_createNewEditTd:function(t,e,i,s,o,n){var a=$(t.insertCell(e));if(0==e)a.setStyles(this.form.css.gridLineActionCell),this.addable&&this._createAddLineAction(a),this.deleteable&&this._createDelLineAction(a);else if(e==o)a.setStyles(this.form.css.gridMoveActionCell),this._createMoveLineAction(a);else{a.set("MWFId",i),(l=this.editModules[e-1])&&"ImageClipper"==l.json.type?this._createImage(a,l,s):l&&"Image"==l.json.type?this._createImg(a,l,n):l&&"Button"==l.json.type?this._createButton(a,l,n):l&&"Label"==l.json.type?this._createLabel(a,l,n):!l||"Attachment"!=l.json.type&&"AttachmentDg"!=l.json.type?l&&"Textarea"==l.json.type?a.set("html",s):a.set("text",s):this._createAttachment(a,l,s),l&&["Button"].contains(l.json.type)||a.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var r=this.form._getDomjson(a);if(r){a.store("dataGrid",this);var l=this.form._loadModule(r,a);a.store("module",l),this.form.modules.push(l),!1===r.isShow&&a.hide()}},_createAddLineAction:function(t){new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}}).inject(t)},_createDelLineAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}}).inject(t)},_createCompleteAction:function(t){new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}}).inject(t)},_createCancelAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._cancelLineEdit(t)}.bind(this)}}).inject(t)},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;if(this.currentEditLine=t.getParent("tr"),this.currentEditLine){this.editorTr.setStyles({display:"table-row"}),this.editorTr.inject(this.currentEditLine,"before"),this.currentEditLine.setStyle("display","none");var e=this.currentEditLine.retrieve("data");this.titleTr.getElements("th").each(function(t,i){var s=t.get("id"),o=this.editModules[i-1];o&&("sequence"==o.json.type?o.node.set("text",o.node.getParent("tr").rowIndex):o.setData&&(e[s]?o.setData(e[s][o.json.id]):o.setData(null)))}.bind(this));var i=this.currentEditLine.getElements("td").indexOf(t),s=this.editModules[i-1];s&&s.focus(),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_cancelLineEdit:function(t){var e=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){e.currentEditLine&&e.currentEditLine.setStyle("display","table-row"),e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.isEdit=!1,e.currentEditLine=null,e._editorTrGoBack(),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e=!0,i=!1,s={},o=null;this.currentEditLine?(o=this.currentEditLine,s=this.currentEditLine.retrieve("data")):(o=new Element("tr").inject(this.editorTr,"before"),s={});var n=this.titleTr.getElements("th"),a=this.editorTr.getElements("td"),r=o.getElements("td");(n.each(function(t,l){var h=r[l],d=t.get("id"),c=this.editModules[l-1];if(c){if("sequence"==c.json.type){e=!1;var u=o.rowIndex,p={value:[u],text:[u]}}else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type){i=!0,e=!1;p=c.getTextData();s[d]||(s[d]={}),s[d][c.json.id]=p}else if(c.getTextData){(p=c.getTextData()).value[0]&&(e=!1),p.value.length<2?(s[d]||(s[d]={}),s[d][c.json.id]=p.value[0]):(s[d]||(s[d]={}),s[d][c.json.id]=p.value)}if(p)if(h)if("ImageClipper"==c.json.type)this._createImage(h,c,p.text[0]);else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type)this._createAttachment(h,c,p);else{var f=this._getValueText(l-1,p.text.join(", "));"Textarea"==c.json.type?h.set("html",f):h.set("text",p.text.join(", "))}else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type)this._createNewEditTd(o,l,a[l].get("id"),p,n.length-1);else{f=this._getValueText(l-1,p.text.join(", "));this._createNewEditTd(o,l,a[l].get("id"),f,n.length-1)}else h||this._createNewEditTd(o,l,d,"",n.length-1)}else h||this._createNewEditTd(o,l,d,"",n.length-1);c=null}.bind(this)),o.store("data",s),o.setStyle("display","table-row"),e&&o.destroy(),this.currentEditLine=null,this._editorTrGoBack(),this.json.contentStyles)&&o.getElements("td").setStyles(this.json.contentStyles);return this.json.actionStyles&&o.getFirst().setStyles(this.json.actionStyles),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence(),this.getData(),this.validationMode(),this.fireEvent("completeLineEdit",[o]),i&&this.form.saveFormData(),!0},_createImg:function(t,e,i){this._cloneModule(t,e,i)},_createLabel:function(t,e,i){this._cloneModule(t,e,i)},_createButton:function(t,e,i){this._cloneModule(t,e,i)},_cloneModule:function(t,e,i){if(t.empty(),e.node&&e.json){var s=Object.clone(e.json);s.id=s.id+"_"+i;var o=e.node.clone();o.set("id",s.id),o.inject(t),this.form._loadModule(s,o)}},_createImage:function(t,e,i){if(t.empty(),i){var s=new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top");if("size"==e.json.clipperType){var o=e.json.imageWidth,n=e.json.imageHeight;o&&n&&s.setStyles({width:o+"px",height:n+"px"})}}},_createAttachment:function(t,e,i){t.empty();var s={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(s.readonly=!0),this.editable||this.addable||(s.readonly=!0);(i||[]).each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var o=new MWF.xApplication.process.Xform.AttachmentController(t,e,s);o.load(),(i||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;o.addAttachment(e)}.bind(this))},_editorTrGoBack:function(){if(this.editorTr.setStyle("display","none"),this.totalTr)this.editorTr.inject(this.totalTr,"before");else{var t=this.table.getElements("tr"),e=t[t.length-1];this.editorTr.inject(e,"after")}},_addLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.editorTr.setStyles({display:"table-row"}),this.currentEditLine=null;var e=t.getParent("tr");e&&this.editorTr.inject(e,"after"),this.isEdit=!0,this.validationMode(),this.fireEvent("addLine",[this.editorTr])},_deleteLine:function(t){var e=!1,i=t.target.getParent("tr");if(i){var s=i.getStyle("background");i.store("bgcolor",s),i.tween("background-color","#ffd4d4");var o=this,n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){n.fireEvent("deleteLine",[i]);var t=i.retrieve("data");n.titleTr.getElements("th").each((function(i,s){var o=i.get("id"),a=s>0?n.editModules[s-1]:null;o&&a&&("Attachment"==a.json.type||"AttachmentDg"==a.json.type)&&(t[o][a.json.id].each((function(t){n.form.workAction.deleteAttachment(t.id,n.form.businessData.work.id)})),e=!0)})),i.destroy(),o._loadZebraStyle(),o._loadSequence(),o._loadTotal(),o.getData(),this.close(),n.fireEvent("afterDeleteLine"),e&&n.form.saveFormData()}),(function(){var t=i.retrieve("bgcolor");i.tween("background",t),this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},_createMoveLineAction:function(t){new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}}).inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table").getParent("div"),i=e.getSize(),s=e.clone().setStyle("width",i.x).inject(document.body),o=s.getElement("table");o.empty();var n=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(o),a=t.getElements("td"),r=n.getElements("td");a.each((function(t,e){var i=t.getComputedSize();r[e].setStyle("width",i.width+1)}));var l=t.getCoordinates();return s.setStyles(this.form.css.gridMoveLineDragNode),s.setStyles(l),s},_moveLine:function(t){var e=this.table.getElements("tr"),i=t.target.getParent("tr"),s=this._getMoveDragNode(i);coordinates=s.getCoordinates();var o=s.getElement("tr"),n=s.getElement("table"),a=i.getStyle("background");i.store("bgcolor",a),i.tween("background-color","#e4f6e9"),new Drag.Move(s,{droppables:e.erase(i),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();var s=i.retrieve("bgcolor");s?i.tween("background",s):i.tween("background","transparent"),i.setStyle("display","table-row"),null!=e&&(i.inject(o,"after"),o.destroy(),this._loadDatagridStyle(),this.getData())}.bind(this),onEnter:function(t,e){s.setStyle("display","none"),o.inject(e,"after")},onLeave:function(t,e){o.inject(n),s.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move"),s.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=i.retrieve("bgcolor");e?i.tween("background",e):i.tween("background","transparent"),i.setStyle("display","table-row")}}).start(t),i.setStyle("display","none")},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){this.titleTr||this._getDatagridTitleTr();var e=this.titleTr.getElements("th"),i=this.table.getElements("tr");i[i.length-1];this.gridData.data&&this.gridData.data.each(function(t,i){var s=this.table.insertRow(i+1);s.store("data",t),e.each(function(e,o){var n=s.insertCell(o),a=t[e.get("id")],r=this.editModules[o];if("array"!==typeOf(a))if(a)for(key in a){var l=a[key];if(r&&"ImageClipper"==r.json.type)this._createImage(n,r,l);else if(!r||"Attachment"!=r.json.type&&"AttachmentDg"!=r.json.type){var h=this._getValueText(o,l);r&&"Textarea"==r.json.type?n.set("html",h):n.set("text",h)}else this._createAttachment(n,r,l);break}else r&&"Image"==r.json.type?this._createImg(n,r,i):r&&"Button"==r.json.type?this._createButton(n,r,i):r&&"Label"==r.json.type?this._createLabel(n,r,i):r&&"sequence"==r.json.type&&(n.setStyle("text-align","center"),n.set("text",s.rowIndex));var d=this.form._getDomjson(e);d&&!1===d.isShow&&n.hide()}.bind(this))}.bind(this)),this._loadTotal(),t&&t()},_loadImportExportAction:function(){if(this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.exportenable||this.importenable){var t,e=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom",i=new Element("div").inject(this.node,e);if(this.importExportAreaNode=new Element("div").inject(i),["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"left"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"right"}):this.importExportAreaNode.setStyles({margin:"0px auto"}),this.exportenable)this.exportActionNode=new Element("div",{text:this.json.exportActionText||MWF.xApplication.process.Xform.LP.datagridExport}).inject(this.importExportAreaNode),t=this.json.exportActionStyles?this.json.exportActionStyles:this.form.css.gridExportActionStyles,this.exportActionNode.setStyles(t),this.exportActionNode.addEvent("click",function(){this.exportToExcel()}.bind(this));if(this.importenable)this.importActionNode=new Element("div",{text:this.json.importActionText||MWF.xApplication.process.Xform.LP.datagridImport}).inject(this.importExportAreaNode),t=this.json.importActionStyles?this.json.importActionStyles:this.form.css.gridImportActionStyles,this.importActionNode.setStyles(t),this.importActionNode.addEvent("click",function(){this.importFromExcel()}.bind(this));if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var s=2;this.exportActionNode&&(s=s+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(s=s+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",s+"px")}}},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridActionStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.editorTr&&(this.json.editStyles&&this.editorTr.getElements("td").setStyles(this.json.editStyles))},loadGridActionStyle:function(){0!=this.editable&&(this.json.actionStyles&&this.table.getElements("tr").each(function(t,e){0!=e&&t.getFirst().setStyles(this.json.actionStyles)}.bind(this)))},loadGridTitleStyle:function(){this.json.titleStyles&&this.titleTr.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.table.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++)t[e].hasClass("datagridTotalTr")||(this.json.backgroundColor&&t[e].setStyle("background-color",this.json.backgroundColor),e%2==0&&this.json.zebraColor&&t[e].setStyle("background-color",this.json.zebraColor))},createTotalTr:function(){var t=this.node.getElements("tr"),e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after"),this.node.getElements("th").each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);this.json.amountStyles&&i.setStyles(this.json.amountStyles);var s=this.form._getDomjson(t);s&&!1===s.isShow&&i.hide()}.bind(this))},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalTr||this.createTotalTr();for(var e=[],i=this.table.getElements("tr"),s=this.totalTr.getElements("td"),o=1;o<i.length;o++)if(!i[o].hasClass("datagridTotalTr")&&!i[o].hasClass("datagridEditorTr")){var n=i[o].getElements("td");this.totalModules.each(function(i,s){e[s]||e.push(0);var o=new Decimal(e[s]);if("number"==i.type){var a=n[i.index].get("text").toFloat();o=o.plus(a||0)}"count"==i.type&&(o=o.plus(1)),e[s]=o.toString(),t[i.module.json.id]=e[s]}.bind(this))}this.totalModules.each(function(t,i){this.totalResaults[t.module.json.id]=e[i],s[t.index].set("text",isNaN(e[i])?"":e[i])}.bind(this))}return t},_loadSequence:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++){t[e].getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}},_loadBorderStyle:function(){this.json.border&&(this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.table.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.table.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}))},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i),!1===e.isShow&&t.hide()}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),t.store("module",s),this.form.modules.push(s),!1===e.isShow&&t.hide()}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle()}.bind(this)):this._loadDatagridStyle()},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit&&(this.currentEditLine&&this.currentEditLine.setStyle("display","table-row"),this.isEdit=!1,this.currentEditLine=null,this._editorTrGoBack()),this.gridData){for(var e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var s=e[i];if(!s.hasClass("datagridEditorTr"))for(var o=s.getElements("td"),n=0;n<o.length;n++){var a=o[n].retrieve("module");a&&(this.form.modules.erase(a),a=null)}}for(i=1;i<e.length-1;i++)e[i].hasClass("datagridTotalTr")||e[i].hasClass("datagridEditorTr")||e[i].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var s=e[i].retrieve("data");s&&t.push(s)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t},isAvaliableImpExpColumn:function(t,e,i){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.json.type&&"sequence"!=e.json.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.json.type)))},getExportColWidthArray:function(){var t=this.titleTr.getElements("th"),e=[];return t.each(function(i,s){if(!this.editable||0!==s&&s!==t.length-1){var o=this.form._getDomjson(i),n=this.editModules[this.editable?s-1:s];this.isAvaliableImpExpColumn(o,n)&&(n&&["Org","Reader","Author","Personfield","Orgfield"].contains(n.json.type)?e.push(340):n&&"Address"===n.json.type?e.push(170):n&&"Textarea"===n.json.type?e.push(260):n&&"Htmleditor"===n.json.type?e.push(500):(n&&n.json.type,e.push(150)))}}.bind(this)),e},getExportDateIndexArray:function(){var t=this.titleTr.getElements("th"),e=[],i=0;return t.each(function(s,o){if(!this.editable||0!==o&&o!==t.length-1){var n=this.form._getDomjson(s),a=this.editModules[this.editable?o-1:o];this.isAvaliableImpExpColumn(n,a)&&(a&&"Calendar"===a.json.type&&e.push(i),i++)}}.bind(this)),e},getExportTitleArray:function(t){var e=this.titleTr.getElements("th"),i=[];return e.each(function(s,o){if(!this.editable||0!==o&&o!==e.length-1){var n=this.form._getDomjson(s),a=this.editModules[this.editable?o-1:o];this.isAvaliableImpExpColumn(n,a,t)&&i.push(s.get("text"))}}.bind(this)),i},exportToExcel:function(){var t,e=this.titleTr.getElements("th"),i=[],s=this.getExportTitleArray(),o=this.getExportColWidthArray(),n=this.getExportDateIndexArray();i.push(s),this.gridData.data&&this.gridData.data.each(function(t,s){var o=[];e.each(function(i,s){if(!this.editable||0!==s&&s!==e.length-1){var n=this.editModules[this.editable?s-1:s],a=this.form._getDomjson(i);if(this.isAvaliableImpExpColumn(a,n)){var r=t[i.get("id")],l="";if(r){if("array"!==typeOf(r))for(key in r){var h=r[key];if(n&&["Org","Reader","Author","Personfield","Orgfield"].contains(n.json.type))if("array"===typeOf(h)){var d=[];h.each(function(t){"object"===typeOf(t)?d.push(t.distinguishedName):d.push(t)}.bind(this)),l=d.join(", \n")}else l="object"===typeOf(h)?h.distinguishedName:h;else l=n&&"Textarea"===n.json.type?h:this._getValueText(this.editable?s-1:s,h);break}}else n&&"Label"===n.json.type&&n.node&&(l=n.node.get("text"));l||"number"===typeOf(l)||(l=""),o.push(l)}}}.bind(this)),i.push(o)}.bind(this));var a=(t=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(a[a.length-1].toLowerCase())&&a.splice(a.length-1),t=a.join(".");var r={data:i,colWidthArray:o,title:t};this.fireEvent("export",[r]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,r.title||t,o,n)},importFromExcel:function(){var t=[],e=[],i=this.titleTr.getElements("th"),s=1,o=[];i.each(function(n,a){if(!this.editable||0!==a&&a!==i.length-1){var r=this.editModules[this.editable?a-1:a],l=this.form._getDomjson(n);this.isAvaliableImpExpColumn(l,r,"import")&&(t.push({text:n.get("text").trim(),index:s,thJson:l,module:r}),s++,r&&"Calendar"===r.json.type?e.push(s):r&&["Org","Reader","Author","Personfield","Orgfield"].contains(r.json.type)&&o.push(n.get("text")))}}.bind(this)),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).upload(e,function(e){var i=function(){this.checkImportedData(t,e)?this.setImportData(t,e):this.openImportedErrorDlg(t,e)}.bind(this);o.length>0?this.listImportAllOrgData(o,e,function(){i()}.bind(this)):i()}.bind(this))},parseImportedData:function(t,e){var i={data:[]};return e.each(function(e,s){var o={};t.each(function(t,i){t.index;var s,n=t.module,a=t.thJson,r=t.text,l=e[r]||"";switch(n.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if(l){var h=l.split(/\s*,\s*/g);s=[],h.each(function(t,e){var i=this.getImportOrgData(t);s.push(i)}.bind(this))}else s=[];break;case"Combox":case"Address":h=l.split(/\s*,\s*/g),s=h;break;case"Checkbox":h=l.split(/\s*,\s*/g);var d=n.getOptionsObj();h.each((function(t,e){var i=d.textList.indexOf(t);h[e]=i>-1?d.valueList[i]:""})),s=1===h.length?h[0]:h;break;case"Radio":case"Select":s=l.replace(/&#10;/g,"");var c=(d=n.getOptionsObj()).textList.indexOf(s);s=c>-1?d.valueList[c]:"";break;case"Textarea":s=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if(s=l.replace(/&#10;/g,""))u=n.json.format?n.json.format:"datetime"===n.json.selectType||"time"===n.json.selectType?"time"===n.json.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,s=Date.parse(s).format(u);break;default:s=l.replace(/&#10;/g,"")}o[a.id]={},o[a.id][n.json.id]=s}.bind(this)),i.data.push(o)}.bind(this)),i},setImportData:function(t,e){var i=this.parseImportedData(t,e);this.fireEvent("import",[i]),this.setData(i),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openImportedErrorDlg:function(t,e){var i=this,s=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},o=["<table "+s(this.json.properties)+" style='"+s(this.json.tableStyles,"style")+"'>"],n=s(this.json.titleStyles,"style");o.push("<tr>"),t.each((function(t,e){o.push("<th style='"+n+"'>"+t.text+"</th>")})),o.push("<th style='"+n+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),o.push("</tr>");var a=Object.clone(this.json.contentStyles);a["border-bottom"]||a.border||(a["border-bottom"]="1px solid #eee");var r=s(Object.merge(a,{"text-align":"left"}),"style");e.each(function(e,i){o.push("<tr>"),t.each((function(t,i){o.push("<td style='"+r+"'>"+(e[t.text]||"").replace(/&#10;/g,"<br/>")+"</td>")})),o.push("<td style='"+r+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),o.push("</tr>")}.bind(this)),o.push("</table>");var l=new Element("div",{style:"padding:10px;",html:o.join("")}),h=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:l,offset:{y:0},isMax:!0,width:1e3,height:700,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){i.exportWithImportDataToExcel(t,e)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){h.close()}}],onPostClose:function(){h=null}.bind(this)})},exportWithImportDataToExcel:function(t,e){this.titleTr.getElements("th");var i=[],s=this.getExportColWidthArray();s.push(220);var o,n=this.getExportDateIndexArray(),a=this.getExportTitleArray("import");a.push(MWF.xApplication.process.Xform.LP.validationInfor),i.push(a),e.each(function(e,s){var o=[];t.each((function(t,i){o.push((e[t.text]||"").replace(/&#10;/g,"\n"))})),o.push(e.errorTextListExcel?e.errorTextListExcel.join("\n"):""),i.push(o)}.bind(this));var r=(o=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(r[r.length-1].toLowerCase())&&r.splice(r.length-1),o=r.join(".");var l={data:i,colWidthArray:s,title:o,withError:!0};this.fireEvent("export",[l]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,l.title||o,s,n)},checkImportedData:function(t,e){var i=!0,s=this.parseImportedData(t,e),o=MWF.xApplication.process.Xform.LP,n=o.importValidationColumnText,a=o.importValidationColumnTextExcel,r=new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this);e.each(function(e,l){var h=s&&s.data?s.data[l]:{},d=[],c=[];t.each(function(t,i){var s=t.index,l=t.module,u=t.thJson,p=t.text,f=n.replace("{n}",s),m=a.replace("{n}",r.index2ColName(s-1)),g=e[p]||"",y="",b=h[u.id];if("object"===typeOf(b)&&(y=b[l.json.id]),g)switch(l.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":g.split(/\s*,\s*/g).each(function(t,e){var i=this.getImportOrgData(t);i.errorText&&(d.push(f+i.errorText+o.fullstop),c.push(m+i.errorText+o.fullstop))}.bind(this));break;case"Number":isNaN(g)&&(d.push(f+g+o.notValidNumber+o.fullstop),c.push(m+g+o.notValidNumber+o.fullstop));break;case"Calendar":isNaN(g)&&!isNaN(Date.parse(g))||(d.push(f+g+o.notValidDate+o.fullstop),c.push(m+g+o.notValidDate+o.fullstop))}if("sequence"!=l.json.type&&l.setData&&"Address"!==l.json.type){var v=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(l.json.type)&&"array"===o2.typeOf(y)&&y.length&&(v=y.some((function(t){return t.errorText}))),v||(l.setData(y),l.validationMode(),!l.validation()&&l.errNode&&(d.push(f+l.errNode.get("text")),c.push(m+l.errNode.get("text")),l.errNode.destroy()))}}.bind(this)),d.length>0&&(e.errorTextList=d,e.errorTextListExcel=c,i=!1)}.bind(this));var l={validted:i,data:e};return this.fireEvent("validImport",[l]),l.validted},getImportOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMapImported[t]||this.personMapImported[t]||this.unitMapImported[t]||this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listImportAllOrgData:function(t,e,i){var s=[],o=[],n=[],a=[];if(t.length>0){var r,l,h,d;e.each((function(e,i){t.each((function(t,i){e[t]&&e[t].split(/\s*,\s*/g).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s.push(t);break;case"@p":o.push(t);break;case"@u":n.push(t);break;case"@g":a.push(t);break;default:s.push(t),o.push(t),n.push(t),a.push(t)}}))}))}));var c=function(){r&&l&&h&&d&&i&&i()};this.identityMapImported={},s.length?o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:s},function(t){t.data.each(function(t){this.identityMapImported[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this)):(r=!0,c()),this.personMapImported={},o.length?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:o},function(t){t.data.each(function(t){this.personMapImported[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this)):(l=!0,c()),this.unitMapImported={},n.length?o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){t.data.each(function(t){this.unitMapImported[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this)):(h=!0,c()),this.groupMapImported={},a.length?o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMapImported[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this)):(d=!0,c())}}}),MWF.xApplication.process.Xform.DatagridPC$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:0!=this.dataGrid.editable?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}),MWF.xApplication.process.Xform.DatagridPC$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t);if(e){var i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),s.dataModule=this,this.dataGrid.editModules.push(s)}}.bind(this))}}}),MWF.xApplication.process.Xform.DatagridPC.ExcelUtils=new Class({initialize:function(t){this.datagrid=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var o=new Uint8Array(s.result),n=o.byteLength,a=0;a<n;a++)e+=String.fromCharCode(o[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=o.files;if(t.length){var n=t.item(0);if(n.name.indexOf(" ")>-1)return this.form.notice(MWF.xApplication.process.Xform.LP.uploadedFilesCannotHaveSpaces,"error"),!1;this.importFromExcel(n,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var o=s.getFirst();o.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var o=window.xlsxUtils.format2Sheet(t,0,0,null),n=window.xlsxUtils.format2WB(o,"sheet1",void 0),a=n.Sheets[n.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var h=a[l];if(h.s||(h.s={}),h.s.alignment||(h.s.alignment={}),h.s.alignment.wrapText=!0,s&&s.length){var d=l.replace(/\d+/g,"");l.replace(d,"")>1&&s.contains(d)&&(h.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(n),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,o,n=new FileReader;n.onload=function(t){o=t?t.target.result:n.content;var a=(s=window.XLSX.read(o,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var r=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var h=r["!ref"].split(":");2===h.length&&(l=parseInt(h[1].replace(/[^0-9]/gi,"")))}if(l)for(var d=0;d<i.length;d++)for(var c=1;c<=l;c++){var u=r[i[d]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},n.readAsBinaryString(t)}))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Textfield=MWF.APPTextfield=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"textFieldIcon",_loadUserInterface:function(){this._loadNode(),"show"===this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(e-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus(),this.node.getFirst().fireEvent("click")}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",display:"block",border:"0px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle]}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){var t=this.getInputData("change");this._setBusinessData(t),this.validationMode(),this.validation()&&(this._setBusinessData(t),this.fireEvent("change"))}.bind(this)),this.json.ANNModel&&(this.node.getFirst().addEvent("focus",function(){o2.Actions.get("x_query_assemble_surface").calculateNeural(this.json.ANNModel,this.form.businessData.work.id,function(t){var e=t.data.filter(function(t){var e=this.node.getFirst().get("value");return t.score>.1&&-1===e.indexOf(t.value)}.bind(this));e.length&&(this.modelNode||this.createModelNode(),this.modelNode.getLast().empty(),this.modelNode.show(),this.modelNode.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft"}),e.each(function(t){new Element("div",{text:t.value,styles:this.form.css.modelItemNode}).inject(this.modelNode.getLast()).addEvents({mouseover:function(){this.setStyle("color","#0000ff")},mouseout:function(){this.setStyle("color","#a31515")},mousedown:function(t){var e=this.node.getFirst().get("value");this.node.getFirst().set("value",e?e+", "+t.target.get("text"):t.target.get("text")),this.modelNode.hide()}.bind(this)})}.bind(this)))}.bind(this))}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.modelNode&&this.modelNode.hide()}.bind(this))),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},createModelNode:function(){this.modelNode=new Element("div",{styles:this.form.css.modelNode}).inject(this.node,"after"),new Element("div",{styles:this.form.css.modelNodeTitle,text:MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode),new Element("div",{styles:this.form.css.modelNodeContent,text:MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode)},getInputData:function(){if(!this.node.getFirst())return this._getBusinessData();var t=this.node.getElement("input").get("value");if("number"==this.json.dataType){var e=t.toFloat();return isNaN(e)?0:e}return t}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.Xform.Personfield=MWF.APPPersonfield=new Class({Implements:[Events],Extends:MWF.APP$Input,options:{moduleEvents:["load","queryLoad","postLoad","change","select"],readonly:!0},iconStyle:"personfieldIcon",getTextData:function(){var t=this.getValue(),e=[];return"object"===typeOf(t)&&(t=[t]),"array"===typeOf(t)?(t.each(function(t){"string"===typeOf(t)?e.push(t):e.push(t.name+(t.unitName?"("+t.unitName+")":""))}.bind(this)),{value:t||"",text:[e.join(",")]}):{value:[""],text:[""]}},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){this.selectUnits=this.getSelectRange(),"identity"==this.json.selectType&&(this.selectDutys=this.getSelectRangeDuty())},getScriptSelectUnit:function(){var t=[];if(this.json.rangeUnit&&this.json.rangeUnit.length&&this.json.rangeUnit.each(function(e){var i=e.distinguishedName||e.id||e.unique||e.levelName;i&&t.push(i)}.bind(this)),this.json.rangeField&&this.json.rangeField.length&&this.json.rangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction().getUnit(function(t){i=t.data}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}.bind(this)),this.json.rangeKey&&this.json.rangeKey.code){var e=this.form.Macro.exec(this.json.rangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction().getUnit(function(t){i=t.data}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}return t},getScriptSelectDuty:function(){var t=[];if(this.json.rangeDuty&&this.json.rangeDuty.length&&this.json.rangeDuty.each(function(e){var i=e.id||e.name;i&&t.push(i)}.bind(this)),this.json.rangeDutyField&&this.json.rangeDutyField.length&&this.json.rangeDutyField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.rangeDutyKey&&this.json.rangeDutyKey.code){var e=this.form.Macro.exec(this.json.rangeDutyKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},_computeValue:function(){var t=[];this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)}));var e="simple"===this.json.storeRange;if(this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){s.code&&(i=this.form.Macro.exec(s.code,this));var o='return this.org.getDuty("'+s.name+'", "'+i+'")',n=this.form.Macro.exec(o,this);"array"!==typeOf(n)&&(n=n?[n.toString()]:[]),n.each((function(i){i&&t.push(MWF.org.parseOrgData(i,!0,e))}))}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var o=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(o)&&(o=o?[o]:[]),o.each(function(i){var s;i&&("string"===typeOf(i)?(this.getOrgAction()[this.getValueMethod(i)](function(t){s=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,i,!1),t.push(s)):t.push(i))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},getNextSelectUnit:function(t){var e;if("direct"===this.json.rangeNext){if("array"===typeOf(t)){var i=[];return t.each(function(t){this.getOrgAction().getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&i.push(e.woUnit),e=null}.bind(this)),i}return this.getOrgAction().getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e.woUnit?[e.woUnit]:[]}return"level"===this.json.rangeNext?(this.getOrgAction().getUnitWithIdentityWithLevel(t,this.json.rangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e?[e]:[]):"type"===this.json.rangeNext?("all"===this.json.rangeNextUnitType?this.getOrgAction().getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.getOrgAction().getUnitWithIdentityWithType(t,this.json.rangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e?[e]:[]):void 0},getSelectRange:function(){if("unit"===this.json.range)return this.getScriptSelectUnit();if("draftUnit"===this.json.range){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.range){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},getOptions:function(){var t=this.getInputData(),e=this.json.count?this.json.count:0;this.json.range;var i=this.getSelectRange();if("identity"==this.json.selectType)var s=this.getSelectRangeDuty();if("all"!==this.json.range&&!i.length)return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;if("identity"==this.json.selectType&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(!s||!s.length))return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;var o=[];if(this.json.exclude){var n=this.form.Macro.exec(this.json.exclude.code,this);o="array"===typeOf(n)?n:[n]}var a={type:this.json.selectType,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,values:this.json.isInput?[]:t,count:e,units:i,dutys:"identity"==this.json.selectType?s:[],exclude:o,expandSubEnable:"no"!=this.json.expandSubEnable,categoryType:this.json.categoryType||"unit",onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:this.selectOnLoad.bind(this),onClose:this.selectOnClose.bind(this)};return this.form.json.selectorStyle&&(a=Object.merge(a,this.form.json.selectorStyle)),a},selectOnComplete:function(t){var e="simple"===this.json.storeRange,i=[];t.each(function(t){i.push(MWF.org.parseOrgData(t.data,!0,e))}.bind(this)),this.json.isInput?this.addData(i):this.setData(i),this.validationMode(),this.validation(),this.fireEvent("select")},selectOnCancel:function(){this.validation()},selectOnLoad:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")},selectOnClose:function(){v=this._getBusinessData(),v&&v.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")},clickSelect:function(t){var e=this.getOptions();this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,e))},resetData:function(){var t=this.getValue();this.setData(t)},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this._getBusinessData()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});new Element("div").inject(this.node)},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div");if(t.data){var i="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":i=t.data.name+"("+t.data.unitName+")";break;case"@p":i=t.data.name+"("+t.data.employee+")";break;case"@u":i=t.data.levelName;break;case"@g":i=t.data.name;break;default:i=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:i})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},_searchOptions:function(t,e){var i={type:this.json.selectType,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,units:this.selectUnits,dutys:"identity"==this.json.selectType?this.selectDutys:[]};this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+"("+t.employee+")";break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:function(t){this.clickSelect(t)}.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon||(this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before")),this.node.getFirst().setStyle("height","auto"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},getDataText:function(t){if("string"==typeOf(t))return t;var e="";switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":e=t.name+"("+t.unitName+")";break;case"@p":e=t.name+"("+t.employee+")";break;case"@u":case"@g":e=t.name;break;default:e=t.name}return e},addData:function(t){if(!t)return!1;var e="simple"===this.json.storeRange;t.each(function(t){var i,s=typeOf(t);"string"===s&&(this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,t,!1),i&&this.combox.addNewValue(this.getDataText(i),i));"object"===s&&this.combox.addNewValue(this.getDataText(t),t)}.bind(this))},setData:function(t){if(!t)return!1;var e=this.getData(),i=[],s=[],o="simple"===this.json.storeRange,n=typeOf(t);if("array"===n&&t.each(function(t){var e=typeOf(t),n=null;if("string"===e){var a=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){n=MWF.org.parseOrgData(t.data,!1,o)}.bind(this),a,t,!1)}"object"===e&&(n=MWF.org.parseOrgData(t,!1,o)).woPerson&&delete n.woPerson,n&&(i.push(n),s.push({text:this.getDataText(n),value:n}))}.bind(this)),"string"===n){var a,r=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){a=MWF.org.parseOrgData(t.data,!1,o)}.bind(this),r,t,!1),a&&(i.push(a),s.push({text:this.getDataText(a),value:a}))}"object"===n&&((a=MWF.org.parseOrgData(t,!1,o)).woPerson&&delete a.woPerson,i.push(a),s.push({text:this.getDataText(t),value:a}));var l,h=!1;if(e.length&&i.length)if(e.length===i.length){for(var d=0;d<e.length;d++)if(e[d].distinguishedName!==i[d].distinguishedName||e[d].name!==i[d].name||e[d].unique!==i[d].unique){h=!0;break}}else h=!0;else(i.length||e.length)&&(h=!0);(this._setBusinessData(i),h&&this.fireEvent("change"),this.json.isInput)?this.combox?(this.combox.clear(),this.combox.addNewValues(s)):(l=this.node.getFirst())&&(l.empty(),s.each(function(t,e){this.creteShowNode(t,e===s.length-1).inject(l)}.bind(this))):this.node.getFirst()?((l=this.node.getFirst()).empty(),this.loadOrgWidget(i,l)):(this.node.empty(),this.loadOrgWidget(i,this.node))},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitShow||", ");var s=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),o="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":o=t.value.name+"("+t.value.unitName+")";break;case"@p":o=t.value.name+"("+t.value.employee+")";break;case"@u":o=t.value.levelName;break;case"@g":o=t.value.name;break;default:o=t.value.name}var n=new Element("div").set({styles:{"font-size":"14px",color:""},text:o});new mBox.Tooltip({content:n,setStyles:{content:{padding:15,lineHeight:20}},attach:s,transition:"flyin"})}return s},_setValue:function(t){1!=t.length||t[0]||(t=[]);var e=[],i=[],s=typeOf(t),o="simple"===this.json.storeRange;if("array"===s&&t.each(function(t){var s=null,n=typeOf(t);if("string"===n){var a=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){s=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),a,t,!1)}"object"===n&&(s=t),s&&(e.push(s),i.push({text:this.getDataText(s),value:s}))}.bind(this)),"string"===s){var n,a=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){n=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),a,t,!1),n&&(e.push(n),i.push({text:this.getDataText(n),value:n}))}if("object"===s&&(e.push(t),i.push({text:this.getDataText(t),value:t})),this._setBusinessData(e),this.json.isInput)this.combox?(this.combox.clear(),this.combox.addNewValues(i)):(r=this.node.getFirst())&&(r.empty(),i.each(function(t,e){this.creteShowNode(t,e===i.length-1).inject(r)}.bind(this)));else if(this.node.getFirst()){var r=this.node.getFirst();this.loadOrgWidget(e,r)}else this.loadOrgWidget(e,this.node)},getValueMethod:function(t){if(t)switch(t.substr(t.length-1,1).toLowerCase()){case"i":return"getIdentity";case"p":return"getPerson";case"u":return"getUnit";case"g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var s=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||s||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){var s=t.distinguishedName.substr(t.distinguishedName.length-2,2),o=Object.clone(t);switch(s.toLowerCase()){case"@i":new MWF.widget.O2Identity(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@p":new MWF.widget.O2Person(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@u":new MWF.widget.O2Unit(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@g":new MWF.widget.O2Group(o,e,{style:"xform",lazy:!0,disableInfor:i});break;default:new MWF.widget.O2Other(o,e,{style:"xform",lazy:!0,disableInfor:i})}}.bind(this))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Button=MWF.APPButton=new Class({Implements:[Events],Extends:MWF.APP$Module,iconStyle:"personfieldIcon",_loadUserInterface:function(){var t=this.node.getElement("button");t||(t=new Element("button")),t.inject(this.node,"after"),this.node.destroy(),this.node=t,this.node.set({id:this.json.id,text:this.json.name||this.json.id,MWFType:this.json.type}),this.json.preprocessing||this.node.setStyles(this.form.css.buttonStyles)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","Button",null,!1),MWF.xApplication.process.Xform.ViewSelector=MWF.APPViewSelector=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.Button,_loadUserInterface:function(){var t=this.node.getElement("button");t||(t=new Element("button")),t.inject(this.node,"after"),this.node.destroy(),this.node=t,this.node.set({id:this.json.id,text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),this.node.addEvent("click",function(){this.selectedData=null,this.selectView(function(t){this.doResult(t)}.bind(this))}.bind(this))},doResult:function(t){if("script"===this.json.result)return this.selectedData=t,this.json.selectedScript.code?this.form.Macro.exec(this.json.selectedScript.code,this):"";Object.each(this.json.selectedSetValues,function(e,i){var s="";t.each(function(t,i){Object.each(t.data,function(t,i){i===e&&(s=s?s+", "+t:t)}.bind(this))}.bind(this));var o=this.form.all[i];o&&(o.setData(s),s?o.descriptionNode&&o.descriptionNode.setStyle("display","none"):o.descriptionNode&&o.descriptionNode.setStyle("display","block"))}.bind(this))},selectCMSView:function(t){var e=this.json.cmsViewName;if(e){var i=null;this.json.filterList&&this.json.filterList.length&&(i=[],this.json.filterList.each(function(t){t.value=this.form.Macro.exec(t.code.code,this),i.push(t)}.bind(this)));var s,o={application:e.appId,viewName:e.name,isTitle:this.json.isTitle||"yes",select:this.json.select||"single",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:i},n={},a=n.width||"800",r=n.height||"450";layout.mobile&&(s=document.body.getSize(),a=s.x,r=s.y,n.style="viewmobile"),a=a.toInt(),r=r.toInt();var l=((s=this.form.app.content.getSize()).x-a)/2,h=(s.y-r)/2;l<0&&(l=0),h<0&&(h=0),layout.mobile&&(l=20,h=0);var d=this;MWF.require("MWF.xDesktop.Dialog",function(){var e=new MWF.xDesktop.Dialog({title:this.json.title||"select view",style:n.style||"view",top:h,left:l-20,fromTop:h,fromLeft:l-20,width:a,height:r,html:"<div></div>",maskNode:this.form.app.content,container:this.form.app.content,buttonList:[{text:MWF.LP.process.button.ok,action:function(){t&&t(d.view.getData()),this.close()}},{text:MWF.LP.process.button.cancel,action:function(){this.close()}}]});if(e.show(),layout.mobile){var i=e.node.getElement(".MWF_dialod_Action_back"),s=e.node.getElement(".MWF_dialod_Action_ok");i&&i.addEvent("click",function(t){e.close()}.bind(this)),s&&s.addEvent("click",function(i){t&&t(this.view.getData()),e.close()}.bind(this))}MWF.xDesktop.requireApp("process.Application","Viewer",function(){this.view=new MWF.xApplication.process.Application.Viewer(e.content,o,{actions:{lookup:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}/execute",method:"PUT"},getView:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}"}},actionRoot:"x_cms_assemble_control"})}.bind(this))}.bind(this))}},selectProcessView:function(t){var e=this.json.processViewName;if(e){var i=null;this.json.filterList&&this.json.filterList.length&&(i=[],this.json.filterList.each(function(t){t.value=this.form.Macro.exec(t.code.code,this),i.push(t)}.bind(this)));var s,o={application:e.application,viewName:e.name,isTitle:this.json.isTitle||"yes",select:this.json.select||"single",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:i},n={},a=n.width||"800",r=n.height||"600";layout.mobile&&(s=document.body.getSize(),a=s.x,r=s.y,n.style="viewmobile"),a=a.toInt(),r=r.toInt();var l=((s=this.form.app.content.getSize()).x-a)/2,h=(s.y-r)/2;l<0&&(l=0),h<0&&(h=0),layout.mobile&&(l=20,h=0);var d=this;MWF.require("MWF.xDesktop.Dialog",function(){var e=new MWF.xDesktop.Dialog({title:this.json.title||"select view",style:n.style||"view",top:h,left:l-20,fromTop:h,fromLeft:l-20,width:a,height:r,html:"",maskNode:this.form.app.content,container:this.form.app.content,buttonList:[{text:MWF.LP.process.button.ok,action:function(){t&&t(d.view.getData()),this.close()}},{text:MWF.LP.process.button.cancel,action:function(){this.close()}}]});if(e.show(),layout.mobile){var i=e.node.getElement(".MWF_dialod_Action_back"),s=e.node.getElement(".MWF_dialod_Action_ok");i&&i.addEvent("click",function(t){e.close()}.bind(this)),s&&s.addEvent("click",function(i){t&&t(this.view.getData()),e.close()}.bind(this))}MWF.xDesktop.requireApp("process.Application","Viewer",function(){this.view=new MWF.xApplication.process.Application.Viewer(e.content,o)}.bind(this))}.bind(this))}},selectQueryView:function(t){var e=this.json.queryView;if(e){var i=null;this.json.filterList&&this.json.filterList.length&&(i=[],this.json.filterList.each(function(t){t.value=this.form.Macro.exec(t.code.code,this),i.push(t)}.bind(this)));var s={application:e.appName,viewName:e.name,viewId:e.id,isTitle:this.json.isTitle||"yes",select:this.json.select||"single",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:i,defaultSelectedScript:this.json.defaultSelectedScript?this.json.defaultSelectedScript.code:null,selectedAbleScript:this.json.selectedAbleScript?this.json.selectedAbleScript.code:null},o={},n=this.json.DialogWidth||"850",a=this.json.DialogHeight||"700";if(layout.mobile){var r=document.body.getSize();n=r.x,a=r.y,o.style="viewmobile"}n=n.toInt(),a=a.toInt();var l=((r=this.form.app.content.getSize()).x-n)/2,h=(r.y-a)/2;l<0&&(l=0),h<0&&(h=0),layout.mobile&&(l=20,h=0);var d=this;MWF.require("MWF.xDesktop.Dialog",function(){var e=new MWF.xDesktop.Dialog({title:this.json.title||"select view",style:o.style||"view",top:h,left:l-20,fromTop:h,fromLeft:l-20,width:n,height:a,html:"",maskNode:layout.mobile?$(document.body):this.form.app.content,container:layout.mobile?$(document.body):this.form.app.content,buttonList:[{text:MWF.LP.process.button.ok,action:function(){t&&t(d.view.getData()),this.close()}},{text:MWF.LP.process.button.cancel,action:function(){this.close()}}],onPostShow:function(){layout.mobile&&e.node.setStyle("z-index",200),MWF.xDesktop.requireApp("query.Query","Viewer",function(){this.view=new MWF.xApplication.query.Query.Viewer(e.content,s,{style:"select"},this.form.app,this.form.Macro)}.bind(this))}.bind(this)});if(e.show(),layout.mobile){var i=e.node.getElement(".MWF_dialod_Action_back"),r=e.node.getElement(".MWF_dialod_Action_ok");i&&i.addEvent("click",function(t){e.close()}.bind(this)),r&&r.addEvent("click",function(i){t&&t(this.view.getData()),e.close()}.bind(this))}}.bind(this))}},selectView:function(t){this.json.queryView?this.selectQueryView(t):"cms"===this.json.selectViewType?this.selectCMSView(t):this.selectProcessView(t)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Actionbar=MWF.APPActionbar=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","afterLoad"]},reload:function(){this._loadUserInterface()},_loadUserInterface:function(){this.toolbarNode=this.node.getFirst("div"),this.toolbarNode&&(this.toolbarNode.empty(),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.toolbarNode,{style:this.json.style,onPostLoad:function(){this.fireEvent("afterLoad")}.bind(this)},this),this.json.actionStyles&&(this.toolbarWidget.css=this.json.actionStyles),this.json.multiTools){var t=!this.json.hideSystemTools&&!this.json.hideReadedAction,e=JSON.stringify(this.json.multiTools);if(e=o2.bindJson(e,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.multiTools=JSON.parse(e),this.json.multiTools.each(function(e){e.system?this.json.hideSystemTools||("action_readed"===e.id&&(t=!1),this.setToolbars([e],this.toolbarNode,this.readonly)):this.setCustomToolbars([e],this.toolbarNode)}.bind(this)),t){var i=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(i,this.toolbarNode,this.readonly)}this.toolbarWidget.load()}else if(this.json.hideSystemTools)this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load();else if(this.json.defaultTools){i=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.json.hideReadedAction||this.setToolbars(i,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}else MWF.getJSON(this.form.path+"toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),null)}.bind(this)))},setCustomToolbars:function(t,e){var i="../x_component_process_FormDesigner/Module/Actionbar/",s="";this.json.customIconStyle&&(s=this.json.customIconStyle+"/"),t.each(function(t){var o=!0;if(o=this.readonly?t.readShow:t.editShow){if(o=!0,t.control&&(o=this.form.businessData.control[t.control]),t.condition)o=!this.form.Macro.exec(t.condition,this);if(o){var n=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:i+""+this.form.options.style+"/custom/"+s+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(e);if(this.json.customIconOverStyle&&n.set("MWFButtonImageOver",i+""+this.form.options.style+"/custom/"+this.json.customIconOverStyle+"/"+t.img),t.properties&&n.set(t.properties),t.actionScript&&n.store("script",t.actionScript),t.sub){var a=e.getLast();this.setCustomToolbars(t.sub,a)}}}}.bind(this))},setToolbarItem:function(t,e,i,s){var o="../x_component_process_FormDesigner/Module/Actionbar/",n=!0;if(t.control&&(n=this.form.businessData.control[t.control]),!s&&t.condition){var a=this.form.Macro.exec(t.condition,this);n=n&&!a}if("action_downloadAll"!=t.id&&"action_print"!=t.id||this.form.businessData.work.startTime||(n=!1),"action_delete"==t.id&&(this.form.businessData.work&&this.form.businessData.work.id||(n=!1)),"action_rollback"==t.id&&(t.read=!0),i&&(t.read||(n=!1)),n){var r=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:o+(this.options.style||"default")+"/tools/"+(this.json.style||"default")+"/"+t.img,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(e);if(this.json.iconOverStyle&&r.set("MWFButtonImageOver",o+""+(this.options.style||"default")+"/tools/"+(this.json.iconOverStyle||"default")+"/"+t.img),t.properties&&r.set(t.properties),t.sub){var l=e.getLast();this.setToolbars(t.sub,l,i,s)}}},getItem:function(t){if(this.toolbarWidget&&t)return this.toolbarWidget.items[t]},getAllItem:function(){return this.toolbarWidget?this.toolbarWidget.childrenButton:[]},setToolbars:function(t,e,i,s){t.each(function(t){this.setToolbarItem(t,e,i,s)}.bind(this))},runCustomAction:function(t){var e=t.node.retrieve("script");this.form.Macro.exec(e,this)},saveWork:function(){this.form.saveWork()},closeWork:function(){this.form.closeWork()},processWork:function(){this.form.processWork()},resetWork:function(){this.form.resetWork()},retractWork:function(t,e){this.form.retractWork(t,e)},rerouteWork:function(t,e){this.form.rerouteWork(t,e)},deleteWork:function(){this.form.deleteWork()},printWork:function(){this.form.printWork()},readedWork:function(t,e){this.form.readedWork(e)},addSplit:function(t){this.form.addSplit(t)},rollback:function(t){this.form.rollback(t)},downloadAll:function(t){this.form.downloadAll(t)},pressWork:function(t){this.form.pressWork(t)},pauseTask:function(t){var e=this.form.pauseTask(t);e&&e.then(function(){t.setText(MWF.xApplication.process.Xform.LP.resume),t.options.action="resumeTask";var e=t.picNode.getElement("img"),i=e.get("src");i=i.substr(0,i.lastIndexOf("/")),i+="/resume.png",e.set("src",i)}.bind(this),(function(){}))},resumeTask:function(t){var e=this.form.resumeTask(t);e&&e.then(function(){t.setText(MWF.xApplication.process.Xform.LP.pause),t.options.action="pauseTask";var e=t.picNode.getElement("img"),i=e.get("src");i=i.substr(0,i.lastIndexOf("/")),i+="/pause.png",e.set("src",i)}.bind(this),(function(){}))}}),MWF.xDesktop.requireApp("process.Xform","Combox",null,!1),MWF.xApplication.process.Xform.Address=MWF.APPAddress=new Class({Implements:[Events],Extends:MWF.APPCombox,options:{moduleEvents:["load","queryLoad","postLoad","commitInput","change"]},initialize:function(t,e,i){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_loadNodeEdit:function(){this.node.empty(),MWF.require(["MWF.widget.Combox","MWF.widget.PinYin"],function(){this.combox=new MWF.widget.Combox({style:"blue",onlySelect:!0,count:4,focusList:!0,onCommitInput:function(){this.fireEvent("commitInput")}.bind(this),onChange:function(t,e){var i=this.combox.values.map((function(t){return t.data||t.value}));if(e&&e.join()!==i.join()){for(;this.combox.values.length-1>t.index;)this.combox.deleteItem(this.combox.values[this.combox.values.length-1]);this.fireEvent("change")}}.bind(this),optionsMethod:this._searchOptions.bind(this)}),this.combox.intoEdit=function(t){if(this.options.count&&this.values.length>=this.options.count)return this.input&&this.input.node.hide(),!1;this.input||(this.input=new MWF.widget.Combox.Input(this,this,""),this.input.node.inject(this.node),this.input.node.setStyle("width","1px")),this.input.node.show(),this.input.setInputNodeStyles(),this.input.node.focus(),this.input.setInputPosition(),this.options.focusList&&this.input.searchItems()}}.bind(this),!1),this.combox.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_searchOptions:function(t,e){t=t.toLowerCase();var i=this.combox.editItem?this.combox.editItem.getItemPosition():this.combox.values.length;if("province"===this.json.selectRange){if(i>0)return void(e&&e([]))}else if("city"===this.json.selectRange&&i>1)return void(e&&e([]));switch(i){case 0:o2.Actions.get("x_general_assemble_control").listProvince(function(t){var i=[];t.data.each(function(t){var e=t.name;MWF.widget.PinYin.toPY(e).toLowerCase(),MWF.widget.PinYin.toPYFirst(e).toLowerCase();i.push({text:e,value:e})}.bind(this)),e&&e(i)}.bind(this));break;case 1:var s=this.combox.getFirst();o2.Actions.get("x_general_assemble_control").listCity(s.data||s.value,function(t){var i=[];t.data.each(function(t){var e=t.name;MWF.widget.PinYin.toPY(e).toLowerCase(),MWF.widget.PinYin.toPYFirst(e).toLowerCase();i.push({text:e,value:e})}.bind(this)),e&&e(i)}.bind(this));break;case 2:var o=this.combox.getFirst(),n=o.data||o.value;s=this.combox.getFirst().getNextItem();o2.Actions.get("x_general_assemble_control").listDistrict(n,s.data||s.value,function(t){var i=[];t.data.each(function(t){var e=t.name;MWF.widget.PinYin.toPY(e).toLowerCase(),MWF.widget.PinYin.toPYFirst(e).toLowerCase();i.push({text:e,value:e})}.bind(this)),i.length&&e&&e(i)}.bind(this));break;default:e&&e([])}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.require("MWF.widget.AttachmentController",null,!1),MWF.xApplication.process.Xform.AttachmentController=new Class({Extends:MWF.widget.ATTER,options:{officeFiles:["doc","docx","dotx","dot","xls","xlsx","xlsm","xlt","xltx","pptx","ppt","pot","potx","potm","pdf"],allowPreviewExtension:["zip","pdf","ofd","png","jpg","bmp","jpeg","gif","js","css","java","json","xml","php","html","htm","xhtml","log","md","txt"],checkTextEnable:!0},checkAttachmentDeleteAction:function(){if(this.options.readonly)return this.setAttachmentsAction("delete",!1),!1;if("n"!==this.options.isDeleteOption){if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,s=this.attachments[e];!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),"o"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(s.data.control.allowEdit||s.data.person===t||(i=!1),s.data.activity===this.module.form.businessData.activity.id&&s.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):s.data.control.allowEdit||s.data.person===t||(i=!1),i?this.setAttachmentAction(s,"delete",!0):this.setAttachmentAction(s,"delete",!1)}}else this.setAttachmentsAction("delete",!1)},checkDeleteAction:function(){if(this.checkAttachmentDeleteAction(),this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),!1;if("n"!==this.options.isDeleteOption)if(this.selectedAttachments.length){var t=layout.session.user.distinguishedName,e=!0;if("o"===this.options.isDeleteOption)for(var i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else if("a"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.activity!==this.module.form.businessData.activity.id){e=!1;break}}else if("ao"===this.options.isDeleteOption)for(i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}if(s.data.activity!==this.module.form.businessData.activity.id||s.data.person!==layout.desktop.session.user.distinguishedName){e=!1;break}}else for(i=0;i<this.selectedAttachments.length;i++){var s;if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowEdit&&s.data.person!==t){e=!1;break}}e?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction))}else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction);else this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)},checkPreviewAttAction:function(){if(this.options.isPreviewAtt)if(this.selectedAttachments.length){for(var t=!1,e=0;e<this.selectedAttachments.length;e++){var i=this.selectedAttachments[e];if(this.options.allowPreviewExtension.contains(i.data.extension)){t=!0;break}}t&&this.setActionEnabled(this.previewAttAction)}else this.setActionDisabled(this.previewAttAction);else this.setActionDisabled(this.previewAttAction)},isAttDeleteAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isDeleteOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.person!==layout.desktop.session.user.distinguishedName&&(i=!1)):"a"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity!==this.module.form.businessData.activity.id&&(i=!1)):"ao"===this.options.isDeleteOption?(t.data.control.allowEdit||t.data.person===e||(i=!1),t.data.activity===this.module.form.businessData.activity.id&&t.data.person===layout.desktop.session.user.distinguishedName||(i=!1)):t.data.control.allowEdit||t.data.person===e||(i=!1),i},openInOfficeControl:function(t,e){e&&(e.openedAttachment&&e.openedAttachment.id===t.id||(e.save(),this.module.form.businessData.workCompleted?MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(t.id,this.module.form.businessData.workCompleted.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this)):MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.id,this.module.form.businessData.work.id,function(i){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(i,!0,this.readonly)}.bind(this))))},checkReplaceAction:function(){if(!this.options.isReplaceHidden){if(this.options.readonly)return this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),!1;if("n"!==this.options.isReplaceOption)if(this.selectedAttachments.length&&1===this.selectedAttachments.length){var t=this.selectedAttachments[0];!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid);var e=layout.session.user.distinguishedName,i=!0;"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction))}else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction);else this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)}},replaceAttachment:function(t,e){var i=this.selectedAttachments[0].data;if(this.module.json.isOpenInOffice&&this.module.json.officeControlName&&-1!==this.options.officeFiles.indexOf(i.extension)){var s=this.module.form.all[this.module.json.officeControlName];s?(this.min_closeOfficeAction&&this.setActionEnabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionEnabled(this.closeOfficeAction),this.openInOfficeControl(i,s)):this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])}else this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},isAttReplaceAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("edit"))return!1;if("n"===this.options.isReplaceOption)return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),"o"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName),"a"===this.options.isReplaceOption&&(i=t.data.activity===this.module.form.businessData.activity.id),"ao"===this.options.isReplaceOption&&(i=t.data.person===layout.desktop.session.user.distinguishedName&&t.data.activity===this.module.form.businessData.activity.id),i&&!t.data.control.allowEdit&&t.data.person!==e&&(i=!1),i},checkOrderAction:function(){if(this.options.readonly)return this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction),!1;if(this.attachments.length&&this.attachments.length>1){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.attachments.length;i++){var s=this.attachments[i];if(!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowControl&&!s.data.control.allowEdit&&s.data.person!==e){t=!1;break}}t?(this.setActionEnabled(this.orderAction),this.setActionEnabled(this.min_orderAction)):(this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction))}else this.setActionDisabled(this.orderAction),this.setActionDisabled(this.min_orderAction)},isAttOrderAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl&&t.data.control.allowEdit||t.data.person===e||(i=!1),i},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;!(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view")&&t.contains("config"))||this.module.json.isOpenInOffice&&this.module.json.officeControlName||(this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),this.isHiddenTop=!0),t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&this.createOfficeGroupActions(),t.contains("config")||this.createConfigGroupActions(),t.contains("view")||this.createViewGroupActions(),this.checkActions()},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkPreviewAttAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkConfigAction(),this.checkOrderAction(),this.checkListStyleAction()},checkAttachmentConfigAction:function(){if(this.options.readonly)return this.setAttachmentsAction("config",!1),!1;if(this.attachments.length)for(var t=layout.session.user.distinguishedName,e=0;e<this.attachments.length;e++){var i=!0,s=this.attachments[e];!s.data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),s.data.control.allowControl||s.data.person===t||(i=!1),i?this.setAttachmentAction(s,"config",!0):this.setAttachmentAction(s,"config",!1)}},checkConfigAction:function(){if(this.checkAttachmentConfigAction(),this.options.readonly)return this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction),!1;if(this.selectedAttachments.length){for(var t=!0,e=layout.session.user.distinguishedName,i=0;i<this.selectedAttachments.length;i++){if(!(s=this.selectedAttachments[i]).data.person&&s.data.creatorUid&&(s.data.person=s.data.creatorUid),!s.data.control.allowControl&&s.data.person!==e){t=!1;break}}t?this.setActionEnabled(this.configAction):this.setActionDisabled(this.configAction)}else this.setActionDisabled(this.configAction);if(this.checkTextAction&&(this.setActionDisabled(this.checkTextAction),this.selectedAttachments.length&&1===this.selectedAttachments.length)){var s=this.selectedAttachments[0];-1!==this.options.images.indexOf(s.data.extension.toLowerCase())&&this.setActionEnabled(this.checkTextAction)}},isAttConfigAvailable:function(t){if(this.options.readonly)return!1;if(this.options.toolbarGroupHidden.contains("config"))return!1;var e=layout.session.user.distinguishedName,i=!0;return!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===e||(i=!1),i},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.previewAttAction=this.createAction(this.editActionsGroupNode,"previewAtt",o2.LP.widget.previewAtt,function(t,e){this.previewAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createConfigGroupActions:function(){this.configActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.configActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.configActionBoxNode),this.configAction=this.createAction(this.configActionsGroupNode,"config",MWF.LP.widget.configAttachment,function(t,e){this.configAttachment(t,e)}.bind(this)),this.options.checkTextEnable&&(this.checkTextAction=this.createAction(this.configActionsGroupNode,"check",MWF.LP.widget.checkOcrText,function(t,e){this.checkImageTex(t,e)}.bind(this))),this.createSeparate(this.configActionsGroupNode),this.orderAction=this.createAction(this.configActionsGroupNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this)),this.configAction&&this.setActionDisabled(this.configAction),this.checkTextAction&&this.setActionDisabled(this.checkTextAction)},createOfficeGroupActions:function(){this.officeActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.officeActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.officeActionBoxNode),this.closeOfficeAction=this.createAction(this.officeActionsGroupNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",MWF.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("config")||(this.min_orderAction=this.createAction(this.minActionAreaNode,"order",MWF.LP.widget.order,function(t,e){this.orderAttachment(t,e)}.bind(this))),this.module.json.isOpenInOffice&&this.module.json.officeControlName&&(this.min_closeOfficeAction=this.createAction(this.minActionAreaNode,"closeOffice",MWF.LP.widget.closeOffice,function(t,e){this.closeAttachmentOffice(t,e)}.bind(this)),this.min_closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction)),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},closeAttachmentOffice:function(){var t=this.module.form.all[this.module.json.officeControlName];t&&(t.openFile(),this.min_closeOfficeAction&&this.setActionDisabled(this.min_closeOfficeAction),this.closeOfficeAction&&this.setActionDisabled(this.closeOfficeAction))},configAttachment:function(){var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentPermissionNode}).inject(this.node),s=new Element("div",{styles:e.attachmentPermissionNamesNode}).inject(i),o=(new Element("div",{styles:e.attachmentPermissionNamesTitleNode,text:t.attachmentPermissionInfo}).inject(s),new Element("div",{styles:e.attachmentPermissionNamesAreaNode}).inject(s));this.selectedAttachments.length&&this.selectedAttachments.each(function(t){new Element("div",{styles:e.attachmentPermissionAttNode,text:t.data.name}).inject(o)}.bind(this));var n=new Element("div",{styles:e.attachmentPermissionEditAreaNode}).inject(i),a=(new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentRead}).inject(n),new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n));new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentEdit}).inject(n);var r=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n);new Element("div",{styles:e.attachmentPermissionTitleNode,text:t.attachmentController}).inject(n);var l=new Element("div",{styles:e.attachmentPermissionInputNode}).inject(n),h=o2.DL.open(Object.merge({title:t.attachmentPermission,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentConfig(a,r,l),h.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){h.close()}}]},this.module.form.json.dialogOptions||{}));if(1===this.selectedAttachments.length){var d=this.selectedAttachments[0].data,c=d.readUnitList||[],u=d.readIdentityList||[],p=d.editUnitList||[],f=d.editIdentityList||[],m=d.controllerUnitList||[],g=d.controllerIdentityList||[];a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:c.concat(u).trim()})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:p.concat(f).trim()})),l.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"],values:m.concat(g).trim()}))}else a.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),r.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]})),l.setSelectPerson(this.module.form.app.content,Object.merge(Object.clone(this.module.form.json.selectorStyle||{}),{types:["unit","identity"]}))},setAttachmentConfig:function(t,e,i){if(this.selectedAttachments.length){var s=t.retrieve("data-value"),o=e.retrieve("data-value"),n=i.retrieve("data-value"),a=[],r=[],l=[],h=[],d=[],c=[];s&&s.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&a.push(e),"I"===s&&r.push(e)})),o&&o.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&l.push(e),"I"===s&&h.push(e)})),n&&n.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,i=e.length,s=e.substring(i-1,i);"U"===s&&d.push(e),"I"===s&&c.push(e)}));var u=0;this.selectedAttachments.each(function(t){t.data.readUnitList=a,t.data.readIdentityList=r,t.data.editUnitList=l,t.data.editIdentityList=h,t.data.controllerUnitList=d,t.data.controllerIdentityList=c,o2.Actions.get("x_processplatform_assemble_surface").configAttachment(t.data.id,this.module.form.businessData.work.id,t.data,function(){o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(t.data.id,this.module.form.businessData.work.id,function(e){var i=this.getAttachmentById(t.data.id);i&&(i.data=e.data,i.deleteAction&&!this.isAttDeleteAvailable(i)&&i.deleteAction.setStyle("display","none"),i.configAction&&!this.isAttConfigAvailable(i)&&i.configAction.setStyle("display","none")),++u===this.selectedAttachments.length&&this.checkActions()}.bind(this))}.bind(this))}.bind(this))}},checkImageTex:function(){if(this.selectedAttachments.length&&1==this.selectedAttachments.length){var t=this.selectedAttachments[0],e=MWF.xApplication.process.Xform.LP,i=this.module.form.css,s=new Element("div",{styles:i.attachmentOCRNode}).inject(this.node),o=new Element("div",{styles:i.attachmentOCRImageAreaNode}).inject(s),n=new Element("img",{styles:i.attachmentOCRImageNode}).inject(o);o2.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(t.data.id,this.module.form.businessData.work.id,(function(t){n.set("src",o2.filterUrl(t))}));var a=new Element("div",{styles:i.attachmentOCRInputAreaNode}).inject(s),r=new Element("textarea",{styles:i.attachmentOCRInputNode}).inject(a),l=o2.DL.open({title:e.attachmentOCRTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:s,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.setAttachmentOCR(r,t),l.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){l.close()}}]});t.data.ocr?r.set("text",t.data.ocr.text||""):o2.Actions.get("x_processplatform_assemble_surface").getAttachmentOCR(t.data.id,this.module.form.businessData.work.id,function(e){t.data.ocr=e.data,r.set("text",e.data.text||"")}.bind(this))}},setAttachmentOCR:function(t,e){var i=t.get("text");e.data.ocr||(e.data.ocr={}),e.data.ocr.text=i,o2.Actions.get("x_processplatform_assemble_surface").setAttachmentOCR(e.data.id,this.module.form.businessData.work.id,{text:i},function(){this.module.form.app.notice("success",lp.attachmentOCR_saved,this.node)}.bind(this))},checkMoveAction:function(t){if(t){var e=t.getFirst().getNext(),i=e.getFirst().show(),s=e.getLast().show();tmp=t.getPrevious(),tmp||i.hide(),tmp=t.getNext(),tmp||s.hide()}},sortByNumber:function(t){return t.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this))},orderAttachment:function(){if(this.attachments.length){this.attachments=this.sortByNumber(this.attachments);var t=MWF.xApplication.process.Xform.LP,e=this.module.form.css,i=new Element("div",{styles:e.attachmentOrderNode}),s=(new Element("div",{styles:e.attachmentOrderInforNode,text:t.attachmentOrderInfo}).inject(i),new Element("div",{styles:e.attachmentOrderAreaNode}).inject(i)),o=null;o2.getJSON("../x_component_File/$Main/icon.json",function(t){o=t}.bind(this),!1,!1),this.attachments.each(function(n,a){var r="../x_component_File/$Main/default/file/"+(o[n.data.extension.toLowerCase()]||o.unknow),l=new Element("div",{styles:e.attachmentOrderItemNode}).inject(s);l.store("att",n);var h=new Element("div",{styles:e.attachmentOrderItemIconNode}).inject(l);h.setStyle("background-image","url('"+r+"')");var d=new Element("div",{styles:e.attachmentOrderItemActionNode}).inject(l),c=(new Element("div",{styles:e.attachmentOrderItemTextNode,text:n.data.name}).inject(l),new Element("div",{styles:e.attachmentOrderItemActionUpNode,text:t.attachmentOrderUp}).inject(d)),u=new Element("div",{styles:e.attachmentOrderItemActionDownNode,text:t.attachmentOrderDown}).inject(d);0==a&&c.hide(),a==this.attachments.length-1&&u.hide(),c.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getPrevious();i&&(e.inject(i,"before"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),u.addEvent("click",function(t){var e=t.target.getParent().getParent(),i=e.getNext();i&&(e.inject(i,"after"),this.checkMoveAction(i)),this.checkMoveAction(e),e.highlight()}.bind(this)),l.addEvents({mouseover:function(t){this.setStyle("background-color","#f1f6fa")},mouseout:function(t){this.setStyle("background-color","#ffffff")}}),new Drag(l,{handle:h,snap:5,stopPropagation:!0,preventDefault:!0,onStart:function(t,o){var n=t;n.setStyle("background-color","#f1f6fa");var a=n.clone(!0).setStyles(e.attachmentOrderItemNode).setStyles({"background-color":"#faf9f1",opacity:.8,border:"1px dotted #333333"}).inject(i);a.position({relativeTo:n,position:"upperLeft",edge:"upperLeft"}),a.owner=n,new Drag.Move(a,{container:i,droppables:s.getChildren(),onEnter:function(t,i){a.flagNode=new Element("div",{styles:e.attachmentOrderFlagNode}).inject(i,"before")},onLeave:function(t,e){a.flagNode&&a.flagNode.destroy()},onDrop:function(t,e){a.flagNode&&(a.owner.inject(a.flagNode,"after"),a.flagNode.destroy(),a.owner.highlight(),this.checkMoveAction(a.owner),this.checkMoveAction(e),this.checkMoveAction(s.getLast()),a.destroy())}.bind(this)}).start(o)}.bind(this),enter:function(t){t.removeClass("dragging")}})}.bind(this));var n=o2.DL.open(Object.merge({title:t.attachmentOrderTitle,style:this.module.form.json.dialogStyle||"user",isResize:!1,content:i,width:"auto",height:"auto",buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(){this.sortAttachment(s),n.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){n.close()}}],onPostLoad:function(){this.node.setStyle("display","block");var t={};e.attachmentOrderNode&&("NaN"!==parseFloat(e.attachmentOrderNode.width).toString()&&(t.x=parseInt(e.attachmentOrderNode.width)),"NaN"!==parseFloat(e.attachmentOrderNode.height).toString()&&(t.y=parseInt(e.attachmentOrderNode.height))),i.show();var s=i.getSize();this.content.setStyles({width:t.x||s.x,height:t.y||s.y}),this.setContentSize()}},this.module.form.json.dialogOptions||{}))}},sortAttachment:function(t){t.getChildren().each(function(t,e){var i=t.retrieve("att",null);i&&(i.data.orderNumber=e,o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.changeOrderNumber(i.data.id,this.module.form.businessData.work.id,e))}.bind(this)),this.attachments=this.attachments.sort(function(t,e){return e.data.orderNumber?t.data.orderNumber?t.data.orderNumber-e.data.orderNumber:-1:1}.bind(this)),this.reloadAttachments(),this.fireEvent("order")}}),MWF.xApplication.process.Xform.Attachment=MWF.APPAttachment=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["upload","delete","afterDelete","load","change","download","open","queryLoad","queryLoadController","loadController","postLoadController"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.node.empty(),this.form.businessData.work.startTime&&(this.fireEvent("queryLoad"),this.loadAttachmentController(),this.fireEvent("load"))},reload:function(){this.node.empty(),this.form.businessData.work.startTime&&this.loadAttachmentController()},loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isPreviewAtt:"y"===this.json.isPreviewAtt||"true"===this.json.isPreviewAtt,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return t.data.name}));this._setBusinessData(t)}else this._setBusinessData([])},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},isEmpty:function(){var t=this.getData();return"array"===typeOf(t)?0==t.length:!t},getData:function(){return this.attachmentController?this.attachmentController.getAttachmentNames():null},createUploadFileNode:function(){var t="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each(function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}}.bind(this)),t=accepts.join(", ")}var e=0;this.json.attachmentSize&&(e=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"uploadAttachment",{id:this.form.businessData.work.id},null,function(t){t.id&&this.form.workAction.getAttachment(t.id,this.form.businessData.work.id,function(e){e.data&&(e.data.control||(e.data.control={}),this.form.businessData.attachmentList.push(e.data),this.attachmentController.addAttachment(e.data,t.messageId)),this.attachmentController.checkActions(),this.setAttachmentBusinessData(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this)),this.attachmentController.checkActions()}.bind(this),function(t){if(t.length&&t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.process.Xform.LP.uploadMore;return e=e.replace("{n}",this.attachmentController.options.attachmentCount),this.form.notice(e,"error"),!1}return!0}.bind(this),!0,t,e,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},uploadAttachment:function(t,e){window.o2android&&window.o2android.uploadAttachment?window.o2android.uploadAttachment(this.json.site||this.json.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadAttachment?window.webkit.messageHandlers.uploadAttachment.postMessage({site:this.json.site||this.json.id}):this.createUploadFileNode()},deleteAttachments:function(t,e,i){var s=[];i.each(function(t){s.push(t.data.name)}.bind(this));var o=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteAttachmentTitle,MWF.xApplication.process.Xform.LP.deleteAttachment+"( "+s.join(", ")+" )",300,120,(function(){for(;i.length;){var t=i.shift();o.deleteAttachment(t)}this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},previewAttachment:function(t){var e=t[0];new MWF.xApplication.process.Xform.AttachmenPreview(e,this)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);var e=t.data.id;this.form.workAction.deleteAttachment(t.data.id,this.form.businessData.work.id,function(i){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions();for(var s=0;s<this.form.businessData.attachmentList.length;s++){var o=this.form.businessData.attachmentList[s];if(o.id===e){this.form.businessData.attachmentList.erase(o);break}}this.form.officeList&&this.form.officeList.each(function(t){t.openedAttachment&&t.openedAttachment.id==e&&t.loadOfficeEdit()}.bind(this)),this.setAttachmentBusinessData(),this.fireEvent("afterDelete",[t.data]),this.fireEvent("change")}.bind(this))},replaceAttachment:function(t,e,i){if(window.o2android&&window.o2android.replaceAttachment)window.o2android.replaceAttachment(i.data.id,this.json.site||this.json.id);else if(window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.replaceAttachment)window.webkit.messageHandlers.replaceAttachment.postMessage({id:i.data.id,site:this.json.site||this.json.id});else{var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.replaceAttachmentTitle,MWF.xApplication.process.Xform.LP.replaceAttachment+"( "+i.data.name+" )",350,120,(function(){s.replaceAttachmentFile(i),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}},createReplaceFileNode:function(t){var e="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each((function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}})),e=accepts.join(", ")}var i=0;this.json.attachmentSize&&(i=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.workAction.action,"replaceAttachment",{id:t.data.id,workid:this.form.businessData.work.id},null,function(e){this.form.workAction.getAttachment(t.data.id,this.form.businessData.work.id,function(i){if(t.data=i.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var s=this.attachmentController.messageItemList[e.messageId];s&&s.node&&s.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,!0,e,i,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},replaceAttachmentFile:function(t){this.createReplaceFileNode(t)},queryDownload:function(t){return!(this.json.events&&this.json.events.queryDownload&&this.json.events.queryDownload.code)||!1!==this.form.Macro.exec(this.json.events.queryDownload.code,t)},queryOpen:function(t){return!(this.json.events&&this.json.events.queryOpen&&this.json.events.queryOpen.code)||!1!==this.form.Macro.exec(this.json.events.queryOpen.code,t)},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],i=0;i<e.length;i++)if(t===e[i])return!0;return!1},downloadAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentStream(t.data.id,this.form.businessData.work.id),this.fireEvent("download",[t]))}.bind(this)):i.each(function(t){this.queryDownload(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentStream(t.data.id,this.form.businessData.workCompleted.id),this.fireEvent("download",[t]))}.bind(this))},openAttachment:function(t,e,i){this.form.businessData.work&&!this.form.businessData.work.completedTime?i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&work="+this.form.businessData.work.id}):layout.mobile?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getAttachmentData(t.data.id,this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this)):i.each(function(t){this.queryOpen(t)&&(window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.site||this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=work&workCompleted="+this.form.businessData.workCompleted.id}):layout.mobile?this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.workAction.getWorkcompletedAttachmentData(t.data.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id),this.fireEvent("open",[t]))}.bind(this))},getAttachmentUrl:function(t,e){this.form.businessData.work&&!this.form.businessData.work.completedTime?this.form.workAction.getAttachmentUrl(t.data.id,this.form.businessData.work.id,e):this.form.workAction.getAttachmentWorkcompletedUrl(t.data.id,this.form.businessData.workCompleted.id,e)},getTextData:function(){var t=[];return this.attachmentController.attachments.each((function(e){var i={id:e.data.id,person:e.data.person,creatorUid:e.data.creatorUid,name:e.data.name,orderNumber:e.data.orderNumber,length:e.data.length,extension:e.data.extension,lastUpdateTime:e.data.lastUpdateTime,activityName:e.data.activityName,control:e.data.control};t.push(i)})),t},setData:function(t){this.attachmentController.clear(),(t||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;this.attachmentController.addAttachment(e)}.bind(this)),this.setAttachmentBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData()||[],s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.AttachmenPreview=new Class({Implements:[Options,Events],initialize:function(t,e){this.att=t,this.app=e,this.load()},load:function(){var t=this.att.data.extension;"ofd"===t&&"ie"!==Browser.name&&this.previewOfd(),"zip"===t&&this.previewZip(),"pdf"===t&&this.previewPdf(),["png","jpg","bmp","jpeg","gif"].contains(t)&&this.previewImage(),"js"===t&&this.previewAce("javascript"),"css"===t&&this.previewAce("css"),"java"===t&&this.previewAce("java"),"json"===t&&this.previewAce("json"),"xml"===t&&this.previewAce("xml"),"php"===t&&this.previewAce("php"),["html","htm","xhtml"].contains(t)&&this.previewAce("html"),["log","md","txt"].contains(t)&&this.previewAce("text")},previewZip:function(){var t=this,e=new Element("div",{text:"loadding..."});o2.load(["../o2_lib/jszip/jszip.min.js","../o2_lib/jszip/jszip-utils.min.js"],function(){this.app.getAttachmentUrl(this.att,function(i){o2.require("MWF.widget.Tree",function(){var i=o2.DL.open({title:t.att.data.name,width:"660px",height:"510px",mask:!0,content:e,container:null,positionNode:document.body,onQueryClose:function(){e.destroy()},buttonList:[{text:"关闭",action:function(){i.close()}}],onPostShow:function(){i.reCenter()},onPostLoad:function(){}})}.bind(this)),e.empty(),JSZipUtils.getBinaryContent(i,(function(i,s){JSZip.loadAsync(s).then((function(i){var s=[];i.forEach((function(t,e){s.push(e.name)}));var o=new MWF.widget.Tree(e,{style:"form"}),n=function(e){for(var i=[],s=0;s<e.length;s++)for(var o=e[s].split("/"),n=i,a=0;a<o.length&&""!==o[a];a++){for(var r=o[a],l=n,h=0;h<n.length;h++)if(n[h].name==r){n=n[h].sub;break}if(l==n){var d={key:e[s],name:r,title:r,text:r,sub:[]},c=n[h]=d;r.indexOf(".")>-1?(d.dir=!1,d.icon="file.png",delete d.sub):(d.dir=!0,d.expand=!1,n=c.sub)}else delete n.sub}var u=[],p={title:t.att.name,text:t.att.name,sub:[]};return i.each((function(t){p.sub.push(t)})),function t(e,i){var s=[];e.sub.each((function(t){t.dir&&s.push(t)})),e.sub.each((function(t){t.dir||s.push(t)})),s.each((function(e){var s={text:e.name,title:e.name,expand:!1};e.dir||(s.icon="file.png"),i.push(s),e.sub&&e.sub.length>0&&(s.sub=[],t(e,s.sub))}))}(p,u),u}(s);o.load(n)}))}))}.bind(this))}.bind(this))},previewPdf:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/pdfjs/web/viewer.html?file="+t)}))},previewOfd:function(){this.app.getAttachmentUrl(this.att,(function(t){window.open("../o2_lib/ofdjs/index.html?file="+t)}))},previewImage:function(){this.app.getAttachmentUrl(this.att,function(t){var e=new Element("img",{src:t,alt:this.att.name}).inject(document.body).hide();o2.loadCss("../o2_lib/viewer/viewer.css",document.body,function(){o2.load("../o2_lib/viewer/viewer.js",function(){this.viewer=new Viewer(e,{navbar:!1,toolbar:!1,hidden:function(){e.destroy(),this.viewer.destroy()}.bind(this)}),this.viewer.show()}.bind(this))}.bind(this))}.bind(this))},previewAce:function(t){this.app.getAttachmentUrl(this.att,function(e){o2.require("o2.widget.ace",null,!1),new Request({url:e,method:"get",withCredentials:!0,onSuccess:function(e){var i=new Element("div",{style:"padding:10px"});i.set("text",e),o2.widget.ace.load(function(){o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js",function(){ace.require("ace/ext/static_highlight")(i,{mode:"ace/mode/"+t,theme:"ace/theme/tomorrow",fontSize:30,showLineNumbers:!0})}.bind(this))}.bind(this));var s=o2.DL.open({title:this.att.data.name,width:"960px",height:"610px",mask:!0,content:i,container:null,positionNode:document.body,onQueryClose:function(){i.destroy()}.bind(this),buttonList:[{text:"关闭",action:function(){s.close()}.bind(this)}],onPostShow:function(){s.reCenter()}.bind(this)})}.bind(this),onFailure:function(){console.log("text","Sorry, your request failed :(")}}).send()}.bind(this))}}),MWF.xApplication.process.Xform.AttachmentDg=MWF.APPAttachmentDg=new Class({Extends:MWF.APPAttachment,loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],ignoreSite:this.json.ignoreSite,onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.json.ignoreSite?(this._getBusinessData()||[]).each(function(t){this.form.businessData.attachmentList.some(function(e){return t.id===e.id}.bind(this))&&this.attachmentController.addAttachment(t)}.bind(this)):this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return{control:t.data.control,name:t.data.name,id:t.data.id,person:t.data.person,creatorUid:t.data.creatorUid,orderNumber:t.data.orderNumber,length:t.data.length,extension:t.data.extension,lastUpdateTime:t.data.lastUpdateTime,activityName:t.data.activityName}}));this._setBusinessData(t)}else this._setBusinessData([])}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Calendar=MWF.APPCalendar=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"calendarIcon",options:{moduleEvents:["queryLoad","postLoad","load","complete","clear","change","show","hide"]},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._loadNodeEdit(),this.node.getFirst().set("readonly",!0))},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none")}.bind(this)})},_getValueAg:function(t,e){if(t&&t.isAG)return t.then(function(t){this._getValueAg(t,e)}.bind(this),(function(){}));var i=t?Date.parse(t):"";return e?i||null:i?i.format(this.json.format):""},getValue:function(t){if(this.moduleValueAG)return this.moduleValueAG;var e=this._getBusinessData();if(e&&!t)return e;if(e||(e=this._computeValue()),e.then)return e;var i=e?Date.parse(e):"";return t?i||null:i?i.format(this.json.format):""},getValueStr:function(){var t=this._getBusinessData();return t||(t=this._computeValue()),t},__setValue:function(t){var e;return e="date"===typeOf(t)?t?Date.parse(t).format(this.json.format):"":t,this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",e||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",e),this.moduleValueAG=null,t},clickSelect:function(){var t=this;if(this.calendar){var e={};e.baseDate=this.getBaseDate(),this.calendar.setOptions(e),this.node.getFirst().focus()}else MWF.require("MWF.widget.Calendar",function(){var e="day";"month"===this.json.selectType&&(e="month"),"year"===this.json.selectType&&(e="year");var i={style:layout.mobile?"xform_mobile":"xform",secondEnable:this.json.isSelectSecond,isTime:"datetime"===this.json.selectType||"time"===this.json.selectType,timeOnly:"time"===this.json.selectType,monthOnly:"month"===this.json.selectType,yearOnly:"year"===this.json.selectType,defaultView:e,target:layout.mobile?$(document.body):this.form.app.content,format:this.json.format,onComplate:function(t,e){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("complete")}.bind(this),onChange:function(){this.fireEvent("change")}.bind(this),onClear:function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change")),this.fireEvent("clear"),this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this),onShow:function(){if(t.descriptionNode&&t.descriptionNode.setStyle("display","none"),layout.mobile)this.container.position({relativeTo:$(document.body),position:"leftCenter",edge:"leftCenter"});else for(var e=t.node.getParent();e;){var i=e.getStyle("overflow"),s=e.getStyle("overflow-y");"auto"===i||"scroll"===i||"auto"===s||"scroll"===s?(t.scrollFun=function(t){this.container.position&&this.container.position({relativeTo:this.node,position:"bottomLeft",edge:"upperLeft",allowNegative:!0})}.bind(this),t.scrollParentNode=e,e.addEvent("scroll",t.scrollFun),e=null):e=e.getParent()}t.fireEvent("show")},onHide:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block"),t.scrollParentNode&&t.scrollFun&&t.scrollParentNode.removeEvent("scroll",t.scrollFun),t.fireEvent("hide")}.bind(this)};i.baseDate=this.getBaseDate(),this.calendar=new MWF.widget.Calendar(this.node.getFirst(),i),this.form.json&&this.form.json.canlendarStyle&&"null"!==typeOf(this.form.json.canlendarStyle.zIndex)&&"undefined"!==typeOf(this.form.json.canlendarStyle.zIndex)&&this.calendar.container.setStyle("z-index",this.form.json.canlendarStyle.zIndex),this.calendar.show()}.bind(this))},getBaseDate:function(){var t,e=this.getValue(!0);if(e&&e.getTime()>1e4)t=e;else{var i=Date.parse(this.unformatDate(this.getValueStr()));t=i&&i.getTime()>1e4?i:new Date}return t},unformatDate:function(t){for(var e=this.json.format,i=["%Y","%m","%d","%H","%M","%S","%z","%Z"],s=[4,2,2,2,2,2,5,3],o=[e.indexOf("%Y"),e.indexOf("%m"),e.indexOf("%d"),e.indexOf("%H"),e.indexOf("%M"),e.indexOf("%S"),e.indexOf("%z"),e.indexOf("%Z")],n=[null,null,null,null,null,null,null,null],a=0;a<i.length;a++)if(-1!==o[a]){var r=0,l=0;Array.each(o,(function(t,e){-1!==t&&o[a]>t&&(r+=s[e],l+=i[e].length)})),n[a]=t.substr(o[a]-l+r,s[a])}var h=new Date;for(a=0;a<n.length;a++)if(!n[a])switch(i[a]){case"%Y":case"%m":case"%d":n[a]=h.format(i[a]);break;case"%H":case"%M":case"%S":n[a]="00"}return n[0]+"-"+n[1]+"-"+n[2]+" "+n[3]+":"+n[4]+":"+n[5]}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.require("MWF.widget.UUID",null,!1),MWF.xApplication.process.Xform.Checkbox=MWF.APPCheckbox=new Class({Implements:[Events],Extends:MWF.APP$Input,loadDescription:function(){},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){var i=[];t.each((function(t){var s=t.split("|"),o=s[0],n=s[1]||o;-1!=e.indexOf(n)&&i.push(o)})),this.node.set("text",i.join(", "))}},_resetNodeEdit:function(){var t=new Element("div");t.set(this.json.properties),t.inject(this.node,"after"),this.node.destroy(),this.node=t},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.set({id:this.json.id,MWFType:this.json.type,styles:{display:"inline"}}),this.setOptions()},_loadDomEvents:function(){},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!=this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.getElements("input").each(function(i){i.addEvent(t,function(t){return e?e(this,t):null}.bind(this))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions()},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){if(this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)){var e=(new MWF.widget.UUID).toString();t.each(function(t){var i=t.split("|"),s=i[0],o=i[1]||s,n=new Element("input",{type:"checkbox",name:(this.json.properties?this.json.properties.name:null)||e+this.json.id,value:o,showText:s,styles:this.json.buttonStyles}).inject(this.node);new Element("span",{text:s,styles:{cursor:"default"}}).inject(this.node).addEvent("click",function(t){!0!==this.radio.get("disabled")&&"true"!==this.radio.get("disabled")&&(this.radio.checked=!this.radio.checked,this.radio.fireEvent("change"),this.radio.fireEvent("click"))}.bind({radio:n})),n.addEvent("click",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")||[]),this.fireEvent("change"))}.bind(this)),Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)||n.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))}.bind(this))}}.bind(this),(function(){}));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){this._setBusinessData(t);for(var e=this.node.getElements("input"),i=0;i<e.length;i++){var s=e[i];s.checked=-1!=t.indexOf(s.value)}},getTextData:function(){var t=this.node.getElements("input"),e=[],i=[];return t.length&&t.each((function(t){if(t.checked){var s=t.get("value"),o=t.get("showText");e.push(s||""),i.push(o||s||"")}})),e.length||(e=[""]),i.length||(i=[""]),{value:e,text:i}},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("input"),e=[];return t.length&&t.each((function(t){if(t.checked){var i=t.get("value");i&&e.push(i||"")}})),e.length?e:[]},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){this._setBusinessData(t);var e=this.node.getElements("input");e.length&&(e.each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("checked",!0):e.set("checked",!1):t==e.get("value")?e.set("checked",!0):e.set("checked",!1)})),this.validationMode()),this.fireEvent("setData")},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("background",this.node.getStyles("background")),this.node.setStyle("background","#ffdcdc"),this.errNode=this.createErrorNode(t),this.iconNode?this.errNode.inject(this.iconNode,"after"):this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("background")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData();"array"===typeOf(i)&&0===i.length&&(i="");var s="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Common=MWF.APPCommon=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){if(this.json.innerHTML){for(var t=this.node.childNodes,e=0;e<t.length;e++)t[e].nodeType===Node.ELEMENT_NODE?t[e].get("MWFtype")||(t[e].destroy(),e--):(t[e].removeNode?t[e].removeNode():t[e].parentNode.removeChild(t[e]),e--);this.node.appendHTML(this.json.innerHTML)}this.node.setProperties(this.json.properties)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","DatagridPC",null,!1),MWF.xDesktop.requireApp("process.Xform","DatagridMobile",null,!1),layout.mobile||COMMON.Browser.Platform.isMobile?(MWF.xApplication.process.Xform.Datagrid=MWF.APPDatagrid=MWF.xApplication.process.Xform.DatagridMobile,MWF.xApplication.process.Xform.Datagrid$Title=MWF.APPDatagrid$Title=MWF.xApplication.process.Xform.DatagridMobile$Title,MWF.xApplication.process.Xform.Datagrid$Data=MWF.APPDatagrid$Data=MWF.xApplication.process.Xform.DatagridMobile$Data):(MWF.xApplication.process.Xform.Datagrid=MWF.APPDatagrid=MWF.xApplication.process.Xform.DatagridPC,MWF.xApplication.process.Xform.Datagrid$Title=MWF.APPDatagrid$Title=MWF.xApplication.process.Xform.DatagridPC$Title,MWF.xApplication.process.Xform.Datagrid$Data=MWF.APPDatagrid$Data=MWF.xApplication.process.Xform.DatagridPC$Data),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","DatatablePC",null,!1),MWF.xDesktop.requireApp("process.Xform","DatatableMobile",null,!1),layout.mobile||COMMON.Browser.Platform.isMobile?(MWF.xApplication.process.Xform.Datatable=MWF.APPDatatable=MWF.xApplication.process.Xform.DatatableMobile,MWF.xApplication.process.Xform.Datatable$Title=MWF.APPDatatable$Title=MWF.xApplication.process.Xform.DatatableMobile$Title,MWF.xApplication.process.Xform.Datatable$Data=MWF.APPDatatable$Data=MWF.xApplication.process.Xform.DatatableMobile$Data):(MWF.xApplication.process.Xform.Datatable=MWF.APPDatatable=MWF.xApplication.process.Xform.DatatablePC,MWF.xApplication.process.Xform.Datatable$Title=MWF.APPDatatable$Title=MWF.xApplication.process.Xform.DatatablePC$Title,MWF.xApplication.process.Xform.Datatable$Data=MWF.APPDatatable$Data=MWF.xApplication.process.Xform.DatatablePC$Data),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatatableMobile=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.DatatablePC,loadDatatable:function(){this._loadStyles(),this._loadTitleTr(),this._loadTemplate(),this._createTemplateTable(),this._loadTotalTr(),this.fireEvent("load"),this._loadDatatable(function(){this._loadImportExportAction(),this.fireEvent("postLoad")}.bind(this))},_loadTitleTr:function(){this.titleTr=this.table.getElement("tr");var t=this.titleTr.getElements("th");this.json.border&&t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.json.titleStyles&&t.setStyles(this.json.titleStyles),t.each(function(t,e){var i=this.form._getDomjson(t);t.addClass("mwf_origional"),i&&("number"!==i.total&&"count"!==i.total||(this.totalFlag=!0))}.bind(this))},_loadTemplate:function(){this.templateJson={};var t=this.table.getElements("tr");this.templateTr=t[t.length-1];var e=this.templateTr.getElements("td");this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),this.json.contentStyles&&e.setStyles(this.json.contentStyles);var i=0;e.each(function(t,e){var s=this.form._getDomjson(t);t.addClass("mwf_origional"),s&&("sequence"===s.cellType&&t.addClass("mwf_sequence"),!1===s.isShow?t.hide():(i%2==0&&this.json.zebraColor?t.setStyle("background-color",this.json.zebraColor):this.json.backgroundColor&&t.setStyle("background-color",this.json.backgroundColor),i++))}.bind(this)),this.templateTr.hide()},_createTemplateTable:function(){this.templateNode=new Element("div").inject(this.node);var t=new Element("div",{styles:this.json.itemTitleStyles}).inject(this.templateNode);t.setStyle("overflow","hidden"),new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item}).inject(t),new Element("div.mwf_sequence",{styles:{float:"left"}}).inject(t),new Element("div.mwf_editaction",{styles:this.form.css.mobileDatagridActionNode}).inject(t);var e=new Element("table").inject(this.templateNode);this.json.border&&e.setStyles({"border-top":this.json.border,"border-left":this.json.border}),e.setStyles(this.json.tableStyles),e.set(this.json.properties);var i=this.titleTr.getElements("th"),s=this.templateTr.getElements("td");i.each(function(t,i){var o=new Element("tr").inject(e),n=this.form._getDomjson(t),a=t.clone().inject(o);a.set("html",t.get("html")),a.set("MWFId",t.get("id")),!1===n.isShow&&o.hide();var r=s[i],l=r.clone().inject(o);l.set("html",r.get("html")),l.set("MWFId",r.get("id"))}.bind(this)),this.templateHtml=this.templateNode.get("html"),this.table.hide(),this.templateNode.hide()},_loadTotalTr:function(){if(this.totalFlag){this.totalDiv=new Element("div.mwf_totaltr",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node);var t=new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv);t.setStyle("overflow","hidden"),new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.amount}).inject(t),this.totalTable=new Element("table").inject(this.totalDiv),this.json.border&&this.totalTable.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.totalTable.setStyles(this.json.tableStyles),this.totalTable.set(this.json.properties);var e=this.titleTr.getElements("th"),i=0;e.each(function(t,s){var o=new Element("tr").inject(this.totalTable),n=this.form._getDomjson(t);if(n&&("number"===n.total||"count"===n.total)){var a=new Element("th").inject(o);a.set("text",t.get("text")),this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),a.setStyles(this.json.titleStyles);var r=new Element("td").inject(o);this.json.border&&r.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),r.setStyles(this.json.amountStyles),!1===n.isShow?o.hide():(i%2==0&&this.json.zebraColor?r.setStyle("background-color",this.json.zebraColor):this.json.backgroundColor&&r.setStyle("background-color",this.json.backgroundColor),i++),this.totalColumns.push({th:a,td:r,index:s,type:n.total})}}.bind(this)),this.templateTr.getElements("td").each(function(t,e){if(this.form._getDomjson(t)){var i=this.totalColumns.find((function(t){return t.index===e}));if(i){var s=this.form._getModuleNodes(t);s.length>0&&(i.moduleJson=this.form._getDomjson(s[0]),"number"===i.type&&this.totalNumberModuleIds.push(i.moduleJson.id))}}}.bind(this))}},_loadTotal:function(){var t={};if(!this.totalFlag)return t;this.totalDiv||this._loadTotalTr();var e=this.getValue();return this.totalColumns.each(function(i,s){var o=i.moduleJson;if(o){if("count"===i.type)n=e.data.length;else if("number"===i.type)for(var n=new Decimal(0),a=0;a<e.data.length;a++){var r=e.data[a];r[o.id]&&(n=n.plus(r[o.id].toFloat()||0))}t[o.id]=n.toString(),i.td.set("text",isNaN(n)?"":n)}}.bind(this)),e.total=t,t},_createLineNode:function(){return this.totalDiv?new Element("div").inject(this.totalDiv,"before"):new Element("div").inject(this.node)},_loadStyles:function(){},_loadLine:function(t,e,i,s,o){var n=new MWF.xApplication.process.Xform.DatatableMobile.Line(t,this,e,{index:i,indexText:(i+1).toString(),isNew:o,isEdited:"boolean"===typeOf(s)?s:this.editable,isEditable:this.editable,isDeleteable:this.deleteable,isAddable:this.addable});return this.fireEvent("beforeLoadLine",[n]),n.load(),this.fireEvent("afterLoadLine",[n]),n},_loadImportExportAction:function(){this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy()}}),MWF.xApplication.process.Xform.DatatableMobile$Title=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatableMobile$Data=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatableMobile.Line=new Class({Extends:MWF.xApplication.process.Xform.DatatablePC.Line,load:function(){!this.datatable.multiEditMode&&this.options.isEdited&&(this.datatable.currentEditedLine=this),this.node.addClass("mwf_datatable"),this.node.setStyles(Object.merge({overflow:"hidden","margin-bottom":"10px"},this.datatable.json.styles||{})),this.loadModules(),this.loadSequence(),this.createActions(),this.datatable.multiEditMode||(this.originalData=Object.clone(this.data))},createActions:function(){if(this.options.isEditable){var t=this.node.getElement(".mwf_editaction");this.datatable.multiEditMode?(this.options.isDeleteable&&this.createDelAction(t),this.options.isAddable&&this.createAddAction(t)):(this.options.isDeleteable&&this.createDelAction(t),this.options.isEditable&&this.createEditAction(t),this.options.isAddable&&this.createAddAction(t),this.createCancelEditAction(t),this.createCompleteAction(t),this.checkActionDisplay())}},checkActionDisplay:function(){this.options.isEdited?(this.addLineAction&&this.addLineAction.hide(),this.editLineAction&&this.editLineAction.hide(),this.delLineAction&&this.delLineAction.hide(),this.completeLineAction&&this.completeLineAction.show(),this.cancelLineEditAction&&this.cancelLineEditAction.show()):(this.addLineAction&&this.addLineAction.show(),this.editLineAction&&this.editLineAction.show(),this.delLineAction&&this.delLineAction.show(),this.completeLineAction&&this.completeLineAction.hide(),this.cancelLineEditAction&&this.cancelLineEditAction.hide())},createEditAction:function(t){this.editLineAction=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit,events:{click:function(t){this.options.isEdited||this.datatable._changeEditedLine(this),t.stopPropagation()}.bind(this)}}).inject(t)},createAddAction:function(t){this.addLineAction=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add,events:{click:function(t){this.datatable._insertLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createCompleteAction:function(t){this.completeLineAction=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit,events:{click:function(t){this.datatable._completeLineEdit(t),t.stopPropagation()}.bind(this)}}).inject(t)},createCancelEditAction:function(t){this.cancelLineEditAction=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.cancelEdit,events:{click:function(t){this.datatable._cancelLineEdit(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createDelAction:function(t){this.delLineAction=new Element("div",{styles:this.form.css.mobileDatagridCancelActionNode,text:MWF.xApplication.process.Xform.LP.delete,events:{click:function(t){this.datatable._deleteLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t),this.delLineAction.show()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatatablePC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","afterLoad","beforeLoadLine","afterLoadLine","addLine","deleteLine","afterDeleteLine","completeLineEdit","cancelLineEdit","export","import","validImport"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.tBody=this.table.getElement("tbody"),this.editable=!(this.readonly||!0===this.json.isReadonly),this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.importenable=this.editable&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable="impexp"===this.json.impexpType||"exp"===this.json.impexpType,this.multiEditMode="multi"===this.json.editMode,this.totalFlag=!1,this.totalColumns=[],this.totalNumberModuleIds=[],this.data=this.getValue(),this._getBusinessData()||(this.isNew=!0,this._setValue(this.data)),this.lineList=[],this.loadDatatable()},loadDatatable:function(){this._loadStyles(),this._loadTitleTr(),this._loadTemplate(),this._loadTotalTr(),this.fireEvent("load"),this._loadDatatable(function(){this._loadImportExportAction(),this.fireEvent("postLoad")}.bind(this))},_loadTitleTr:function(){this.titleTr=this.table.getElement("tr");var t=this.titleTr.getElements("th");if(this.json.border&&t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.json.titleStyles&&t.setStyles(this.json.titleStyles),t.each(function(t,e){var i=this.form._getDomjson(t);if(t.store("dataTable",this),t.addClass("mwf_origional"),i){var s=this.form._loadModule(i,t);this.form.modules.push(s),!1===i.isShow&&t.hide(),"number"!==i.total&&"count"!==i.total||(this.totalFlag=!0)}}.bind(this)),this.editable){var e=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");if(this.addable)new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target,!0)}.bind(this)}}).inject(e);var i=new Element("th").inject(this.titleTr,"bottom");this.json.border&&Array.each([e,i],function(t){t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border})}.bind(this)),this.json.titleStyles&&(e.setStyles(this.json.titleStyles),i.setStyles(this.json.titleStyles))}},_loadTemplate:function(){var t=this.table.getElements("tr");this.templateTr=t[t.length-1],this.templateNode=this.templateTr;var e=this.templateNode.getElements("td");if(this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),this.json.contentStyles&&e.setStyles(this.json.contentStyles),e.each(function(t,e){var i=this.form._getDomjson(t);t.store("dataTable",this),t.addClass("mwf_origional"),i&&("sequence"===i.cellType&&t.addClass("mwf_sequence"),!1===i.isShow&&t.hide())}.bind(this)),this.editable){var i=new Element("td.mwf_editaction",{styles:this.json.actionStyles||{}}).inject(this.templateNode,"top"),s=new Element("td.mwf_moveaction",{styles:this.form.css.gridMoveActionCell||{}}).inject(this.templateNode,"bottom");this.json.border&&Array.each([i,s],function(t){t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})}.bind(this)),this.json.contentStyles&&(i.setStyles(this.json.contentStyles),s.setStyles(this.json.contentStyles))}this.templateHtml=this.templateNode.get("html"),this.templateNode.hide()},_loadTotalTr:function(){this.totalFlag&&(this.totalTr=new Element("tr.mwf_totaltr",{styles:this.form.css.datagridTotalTr}).inject(this.tBody||this.table),this.titleTr.getElements("th").each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);this.json.amountStyles&&i.setStyles(this.json.amountStyles);var s=this.form._getDomjson(t);s&&(!1===s.isShow&&i.hide(),"number"!==s.total&&"count"!==s.total||this.totalColumns.push({th:t,td:i,index:e,type:s.total}))}.bind(this)),this.templateTr.getElements("td").each(function(t,e){if(this.form._getDomjson(t)){var i=this.totalColumns.find((function(t){return t.index===e}));if(i){var s=this.form._getModuleNodes(t);s.length>0&&(i.moduleJson=this.form._getDomjson(s[0]),"number"===i.type&&this.totalNumberModuleIds.push(i.moduleJson.id))}}}.bind(this)))},_loadTotal:function(){var t={};if(!this.totalFlag)return t;this.totalTr||this._loadTotalTr();var e=this.getValue();return this.totalColumns.each(function(i,s){var o=i.moduleJson;if(o){var n,a=0;if("count"===i.type)n=e.data.length;else if("number"===i.type){n=new Decimal(0);for(var r=0;r<e.data.length;r++){var l=e.data[r];if(l[o.id]){n=n.plus(l[o.id].toFloat()||0);var h=l[o.id].toString();h.indexOf(".")>-1&&(a=Math.max(a,h.split(".")[1].length))}}}if(isNaN(n))t[o.id]="",i.td.set("text","");else{if(a>0&&"0"!==n.toString()){var d=n.toString();if(d.indexOf(".")>-1){var c=d.split(".")[1].length;t[o.id]=c<a?d+"0".repeat(a-c):d}else t[o.id]=d+"."+"0".repeat(a)}else t[o.id]=n.toString();i.td.set("text",t[o.id])}}}.bind(this)),e.total=t,t},_createLineNode:function(){return this.totalTr?new Element("tr").inject(this.totalTr,"before"):new Element("tr").inject(this.tBody||this.table)},_loadStyles:function(){this.json.border&&this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.node.setStyles(this.json.styles),this.table.setStyles(this.json.tableStyles),this.table.set(this.json.properties)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();if(t||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"array"===o2.typeOf(t)&&(t={data:t||[],total:{}})),!t&&this.multiEditMode){t={data:[],total:{}};for(var e=this.json.defaultCount?this.json.defaultCount.toInt():0,i=0;i<e;i++)t.data.push({})}return t||{data:[],total:{}}},getValue:function(){return this._getValue()},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.moduleValueAG=null,t},_loadDatatable:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this._loadLineList(function(){this._loadTotal(),t&&t()}.bind(this)),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},_loadLineList:function(t){this.data.data.each(function(t,e){var i=this.isNew||"number"===o2.typeOf(this.newLineIndex)&&e===this.newLineIndex,s=this.multiEditMode||"number"!==o2.typeOf(this.newLineIndex)?this.multiEditMode:e===this.newLineIndex,o=this._createLineNode(),n=this._loadLine(o,t,e,s,i);this.lineList.push(n)}.bind(this)),this.isNew=!1,this.newLineIndex=null,t&&t()},isMax:function(){var t=this.json.maxCount?this.json.maxCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length>=t)},isMin:function(){var t=this.json.minCount?this.json.minCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length<=t)},_loadLine:function(t,e,i,s,o){var n=new MWF.xApplication.process.Xform.DatatablePC.Line(t,this,e,{index:i,indexText:(i+1).toString(),isNew:o,isEdited:"boolean"===typeOf(s)?s:this.editable,isEditable:this.editable,isDeleteable:this.deleteable,isAddable:this.addable});return this.fireEvent("beforeLoadLine",[n]),n.load(),this.fireEvent("afterLoadLine",[n]),n},_setLineData:function(t,e){var i=t.options.index,s=this.getData();s.data[i]=e,this.setData(s)},_addLine:function(t,e,i){if(this._completeLineEdit()){if(this.isMax()){var s=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(s,"info"),!1}var o=this.lineList.length,n=this.getData();n.data.push(i||{}),this.newLineIndex=o,this.setData(n);var a=this.getLine(o);return a.isNewAdd=!0,this.fireEvent("addLine",[{line:a,ev:t}]),a}},_insertLine:function(t,e){if(this._completeLineEdit()){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var s=e.options.index+1,o=this.getData();o.data.splice(s,0,{}),this.newLineIndex=s,this.setData(o);var n=this.getLine(s);return n.isNewAdd=!0,this.fireEvent("addLine",[{line:n,ev:t}]),n}},_insertLineByIndex:function(t,e,i){if(this._completeLineEdit()){if(this.isMax()){var s=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(s,"info"),!1}var o=this.getData();if(o.data.length<e)return null;o.data.splice(e,0,i||{}),this.setData(o);var n=this.getLine(e);return n.isNewAdd=!0,this.fireEvent("addLine",[{line:n,ev:t}]),n}},_deleteSelectedLine:function(t){var e=this.lineList.filter((function(t){return t.selected}));if(0===e.length)return this.form.notice(MWF.xApplication.process.Xform.LP.selectItemNotice,"info"),!1;var i=this.json.minCount?this.json.minCount.toInt():0;if(i>0&&this.lineList.length-e.length<i){var s=MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}",i);return this.form.notice(s,"info"),!1}var o=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice,300,120,(function(){o._delLines(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLines:function(t){var e=this,i=!1,s=e.getData();t.reverse().each((function(t){e.fireEvent("deleteLine",[t]),t.deleteAttachment()&&(i=!0),s.data.splice(t.options.index,1),this.currentEditedLine===t&&(this.currentEditedLine=null),e.fireEvent("afterDeleteLine")})),e.setData(s),i&&this.form.saveFormData()},_deleteLine:function(t,e){if(this.isMin()){var i=MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}",this.json.minCount);return this.form.notice(i,"info"),!1}var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){s._delLine(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLine:function(t){this.fireEvent("deleteLine",[t]);var e=t.deleteAttachment(),i=this.getData();i.data.splice(t.options.index,1),this.currentEditedLine===t&&(this.currentEditedLine=null),this.setData(i),this.fireEvent("afterDeleteLine"),e&&this.form.saveFormData()},_cancelLineEdit:function(){var t=this.currentEditedLine;return!t||(t.isNewAdd?(this._delLine(t),this.currentEditedLine=null):(t.resetDataWithOriginalData(),t.changeEditMode(!1),this._loadTotal(),t.attachmentChangeFlag&&(this.form.saveFormData(),t.attachmentChangeFlag=!1),this.currentEditedLine=null,this.fireEvent("cancelLineEdit",[t])),!0)},_completeLineEdit:function(){var t=this.currentEditedLine;return!t||!!t.validation()&&(t.isNewAdd=!1,t.originalData=Object.clone(t.data),t.changeEditMode(!1),this._loadTotal(),t.attachmentChangeFlag&&(this.form.saveFormData(),t.attachmentChangeFlag=!1),this.currentEditedLine=null,this.fireEvent("completeLineEdit",[t]),!0)},_moveUpLine:function(t,e){if(this.currentEditedLine&&!this._completeLineEdit())return!1;if(0!==e.options.index){var i=this.getData(),s=i.data[e.options.index-1],o=i.data[e.options.index];i.data[e.options.index]=s,i.data[e.options.index-1]=o,this.setData(i)}},_changeEditedLine:function(t){if(this.currentEditedLine){if(t===this.currentEditedLine)return;if(!this._completeLineEdit())return}t.changeEditMode(!0),this.currentEditedLine=t},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!==e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_afterLoaded:function(){},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){this._setBusinessData(t),this.data=t,this.data&&this.clearSubModules(),this.lineList=[],this._loadDatatable()},clearSubModules:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].clearSubModules()},isEmpty:function(){var t=this.getData();return!t||!t.data||"array"===o2.typeOf(t.data)&&0===t.data.length},getLine:function(t){return this.lineList[t]||null},addLine:function(t){return this._addLine(null,null,t)},insertLine:function(t,e){return this._insertLineByIndex(null,t,e)},deleteLine:function(t,e){var i=this.lineList[t];if(!i)return null;this._delLine(i)},getModule:function(t,e){var i=this.lineList[t];return i?i.getModule(e):null},getData:function(){return this.importer&&this.importer.destroySimulateModule(),this.editable,this._getBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();if("object"===o2.typeOf(i)){var s=[];Object.each(i,(function(t,e){"array"===o2.typeOf(t)&&(s=s.concat(t))})),i=s}var o="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!o)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(e.prompt),!1;break;case"gt":if(o>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(o<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(o==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(o!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=o.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==o.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"===i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t},_loadImportExportAction:function(){if(this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.exportenable||this.importenable){var t,e=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom",i=new Element("div").inject(this.node,e);if(this.importExportAreaNode=new Element("div").inject(i),["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"left"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"right"}):this.importExportAreaNode.setStyles({margin:"0px auto"}),this.exportenable)this.exportActionNode=new Element("div",{text:this.json.exportActionText||MWF.xApplication.process.Xform.LP.datagridExport}).inject(this.importExportAreaNode),t=this.json.exportActionStyles?this.json.exportActionStyles:this.form.css.gridExportActionStyles,this.exportActionNode.setStyles(t),this.exportActionNode.addEvent("click",function(){this.exportToExcel()}.bind(this));if(this.importenable)this.importActionNode=new Element("div",{text:this.json.importActionText||MWF.xApplication.process.Xform.LP.datagridImport}).inject(this.importExportAreaNode),t=this.json.importActionStyles?this.json.importActionStyles:this.form.css.gridImportActionStyles,this.importActionNode.setStyles(t),this.importActionNode.addEvent("click",function(){this.importFromExcel()}.bind(this));if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var s=2;this.exportActionNode&&(s=s+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(s=s+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",s+"px")}}},exportToExcel:function(){this.exporter=new MWF.xApplication.process.Xform.DatatablePC.Exporter(this),this.exporter.exportToExcel()},importFromExcel:function(){this.importer=new MWF.xApplication.process.Xform.DatatablePC.Importer(this),this.importer.importFromExcel()}}),MWF.xApplication.process.Xform.DatatablePC$Title=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatablePC$Data=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatablePC.Line=new Class({Implements:[Options,Events],options:{isNew:!1,isEdited:!0,isEditable:!0,isDeleteable:!0,isAddable:!0,index:0,indexText:"0"},initialize:function(t,e,i,s){this.setOptions(s),this.node=t,this.datatable=e,this.data=i,this.form=this.datatable.form,this.init()},init:function(){this.modules=[],this.all={},this.all_templateId={},this.fields=[],this.allField={},this.allField_templateId={},this.changedAttachmentMap={}},load:function(){!this.datatable.multiEditMode&&this.options.isEdited&&(this.datatable.currentEditedLine=this),this.loadModules(),this.loadSequence(),this.createActions(),this.loadZebraStyle(),this.loadEditedStyle(),this.addNodeEvent(),this.datatable.multiEditMode||(this.originalData=Object.clone(this.data))},loadModules:function(){this.node.set("html",this.datatable.templateHtml),this.form._getModuleNodes(this.node,!0).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t);if(i){var s=Object.clone(i);this.options.isEdited&&this.options.isEditable||(s.isReadonly=!0);var o=s.id,n=this.options.index,a=this.datatable.json.id+"..data.."+n+".."+s.id;s.id=a,t.set("id",a),"Attachment"!==s.type&&"AttachmentDg"!==s.type||(s.type="AttachmentDg",s.ignoreSite=!0,s.site=this.getAttachmentSite(s,o)),this.form.all[a]&&(this.form.all[a]=null),this.form.forms[a]&&(this.form.forms[a]=null);this.data.hasOwnProperty(o);var r=this.form._loadModule(s,t,(function(){}));"Attachment"!==s.type&&"AttachmentDg"!==s.type||r.addEvent("change",function(){this.datatable.multiEditMode?e.form.saveFormData():e.attachmentChangeFlag=!0}.bind(this)),this.form.modules.push(r),this.modules.push(r),this.all[a]=r,this.all_templateId[o]=r,r.field&&(this.options.isEdited&&"Attachment"!==s.type&&"AttachmentDg"!==s.type&&(this.data[o]=r.getData()),this.allField[a]=r,this.allField_templateId[o]=r,this.fields.push(r),this.datatable.multiEditMode&&this.datatable.totalNumberModuleIds.contains(o)&&r.addEvent("change",function(){this.datatable._loadTotal()}.bind(this)))}}}.bind(this))},getModule:function(t){return this.all_templateId[t]},getAttachmentSite:function(t,e){var i,s=64-(i="."+this.options.index+"."+(t.site||e)).length,o=this.datatable.json.id;return(o=o.length>s?o.substr(o.length-s,s):o)+i},deleteAttachment:function(){var t=!1;for(var e in this.allField){var i=this.allField[e];if("Attachment"===i.json.type||"AttachmentDg"===i.json.type)(i._getBusinessData()||[]).each(function(e){t=!0,this.form.workAction.deleteAttachment(e.id,this.form.businessData.work.id);for(var i=0;i<this.form.businessData.attachmentList.length;i++){var s=this.form.businessData.attachmentList[i];if(s.id===e.id){this.form.businessData.attachmentList.erase(s);break}}}.bind(this))}return t},loadSequence:function(){var t=this.node.getElements(".mwf_sequence");t&&t.set("text",this.options.indexText)},loadZebraStyle:function(){this.options.index%2==0&&this.datatable.json.zebraColor?this.node.setStyle("background-color",this.datatable.json.zebraColor):this.datatable.json.backgroundColor&&this.node.setStyle("background-color",this.datatable.json.backgroundColor)},loadEditedStyle:function(){!this.datatable.multiEditMode&&this.options.isEdited&&this.datatable.json.editStyles&&this.node.getElements("td").setStyles(this.datatable.json.editStyles)},addNodeEvent:function(){!this.datatable.multiEditMode&&this.options.isEditable&&(this.editFun=function(){this.options.isEdited||this.datatable._changeEditedLine(this)}.bind(this),this.node.addEvent("click",this.editFun))},createActions:function(){if(this.options.isEditable){var t=this.node.getElement(".mwf_editaction"),e=this.node.getElement(".mwf_moveaction");this.datatable.multiEditMode?(this.options.isAddable&&this.createAddAction(t),this.options.isDeleteable&&this.createDelAction(t)):(this.options.isAddable&&this.createAddAction(t),this.options.isDeleteable&&this.createDelAction(t),this.createCompleteAction(t),this.createCancelEditAction(t),this.checkActionDisplay()),this.createMoveAction(e)}},checkActionDisplay:function(){this.options.isEdited?(this.addLineAction&&this.addLineAction.hide(),this.delLineAction&&this.delLineAction.hide(),this.completeLineAction&&this.completeLineAction.show(),this.cancelLineEditAction&&this.cancelLineEditAction.show()):(this.addLineAction&&this.addLineAction.show(),this.delLineAction&&this.delLineAction.show(),this.completeLineAction&&this.completeLineAction.hide(),this.cancelLineEditAction&&this.cancelLineEditAction.hide())},createAddAction:function(t){this.addLineAction=new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this.datatable._insertLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createCompleteAction:function(t){this.completeLineAction=new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this.datatable._completeLineEdit(t),t.stopPropagation()}.bind(this)}}).inject(t)},createCancelEditAction:function(t){this.cancelLineEditAction=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this.datatable._cancelLineEdit(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createDelAction:function(t){this.delLineAction=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this.datatable._deleteLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createMoveAction:function(t){this.moveAction=new Element("div",{styles:this.form.css.datatableMoveLineAction,text:"↑",events:{click:function(t){this.datatable._moveUpLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},changeEditMode:function(t){t!==this.options.isEdited&&this.options.isEditable&&(this.options.isEdited=t,this.reload())},reload:function(){for(var t in this.all){var e=this.all[t];this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.empty(),this.editFun&&(this.node.removeEvent("click",this.editFun),this.editFun=null),this.init(),this.load()},clearSubModules:function(){for(var t in this.all){var e=this.all[t];e.clearSubModules&&e.clearSubModules(),this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.destroy(),this.init()},getData:function(){var t=this.data;for(var e in this.allField_templateId){var i=this.allField_templateId[e];"Attachment"===i.json.type||"AttachmentDg"===i.json.type?t[e]=i._getBusinessData():t[e]=i.getData()}return t},setData:function(t){this.datatable._setLineData(this,t)},validation:function(){if(!this.options.isEdited||!this.options.isEditable)return!0;var t=!0;return this.fields.each(function(e,i){"sequence"!=e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},resetDataWithOriginalData:function(){var t=this.originalData,e=this.form.businessData.attachmentList;for(var i in this.allField_templateId){var s=this.allField_templateId[i];"Attachment"!==s.json.type&&"AttachmentDg"!==s.json.type||(t[i]=(t[i]||[]).filter(function(t,i){for(var s=0;s<e.length;s++)if(e[s].id===t.id)return!0;return!1}.bind(this))),this.data[i]=t[i]}return t}}),MWF.xApplication.process.Xform.DatatablePC.Exporter=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.datatable=t,this.form=this.datatable.form,this.columnJsonList=[]},exportToExcel:function(){this.getColumnList();var t=[],e=this.getTitleArray();t.push(e),this.datatable.lineList.each(function(e,i){t.push(this.getLineExportData(e,i))}.bind(this));var i=this.getColWidthArray(),s=this.getExcelName(),o={data:t,colWidthArray:i,title:s};this.datatable.fireEvent("export",[o]),new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).exportToExcel(o.data||t,o.title||s,o.colWidthArray||i,this.getDateIndexArray())},getColumnList:function(){this.columnJsonList=[];var t=this.datatable.titleTr.getElements("th.mwf_origional"),e=this.datatable.templateTr.getElements("td.mwf_origional");t.each(function(t,i){var s,o=this.form._getDomjson(t);if(e[i]){var n=this.form._getModuleNodes(e[i]);n.length>0&&(s=this.form._getDomjson(n[0]))}o&&s&&this.isAvaliableColumn(o,s)&&this.columnJsonList.push({thJson:o,title:t.get("text"),mJson:s,available:!0})}.bind(this))},getLineExportData:function(t,e){var i=[];return this.columnJsonList.each(function(e){var s;if(e.mJson&&e.available&&(s=t.all_templateId[e.mJson.id]),s){var o="";if(r=s.getData())switch(e.mJson.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if("array"===o2.typeOf(r)){var n=[];r.each(function(t){"object"===o2.typeOf(t)?n.push(t.distinguishedName):n.push(t)}.bind(this)),o=n.join(", \n")}else o="object"===o2.typeOf(r)?r.distinguishedName:r;break;case"Combox":case"Address":o="array"===o2.typeOf(r)?r.join(", "):r;break;case"Checkbox":var a=s.getOptionsObj(),r="array"===o2.typeOf(r)?r:[r],l=[];r.each((function(t,e){var i=a.valueList.indexOf(t);l.push(i>-1?a.textList[i]:"")})),o=l.join(", ");break;case"Radio":case"Select":var h=(a=s.getOptionsObj()).textList.indexOf(r);o=h>-1?a.valueList[h]:"";break;case"Textarea":case"Calendar":default:o=r}else"Label"===e.mJson.type&&s.node&&(o=s.node.get("text"));o||"number"===o2.typeOf(o)||(o=""),i.push(o)}else i.push("")}.bind(this)),i},isAvaliableColumn:function(t,e){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.type&&"sequence"!=e.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.type)))},getColWidthArray:function(){var t=[];return this.columnJsonList.each(function(e,i){e.available&&(e.mJson&&["Org","Reader","Author","Personfield","Orgfield"].contains(e.mJson.type)?t.push(340):e.mJson&&"Address"===e.mJson.type?t.push(170):e.mJson&&"Textarea"===e.mJson.type?t.push(260):e.mJson&&"Htmleditor"===e.mJson.type?t.push(500):(e.mJson&&e.mJson.type,t.push(150)))}.bind(this)),t},getDateIndexArray:function(){var t=[],e=0;return this.columnJsonList.each(function(i){i.available&&i.mJson&&"Calendar"===i.mJson.type&&(t.push(e),e++)}.bind(this)),t},getTitleArray:function(){var t=[];return this.columnJsonList.each(function(e,i){e.available&&e.mJson&&t.push(e.title)}.bind(this)),t},getExcelName:function(){var t=(this.datatable.json.excelName&&this.datatable.json.excelName.code?this.form.Macro.exec(this.datatable.json.excelName.code,this):MWF.xApplication.process.Xform.LP.datatableExportDefaultName).split(".");return["xls","xlst"].contains(t[t.length-1].toLowerCase())&&t.splice(t.length-1),t.join(".")},exportWithImportDataToExcel:function(t){this.getColumnList();var e=[],i=this.getTitleArray("import");i.push(MWF.xApplication.process.Xform.LP.validationInfor),e.push(i),t.each(function(t,i){var s=[];this.columnJsonList.each((function(e,i){s.push((t[e.title]||"").replace(/&#10;/g,"\n"))})),s.push(t.errorTextListExcel?t.errorTextListExcel.join("\n"):""),e.push(s)}.bind(this));var s=this.getColWidthArray();s.push(300);var o=this.getExcelName(),n={data:e,colWidthArray:s,title:o,withError:!0};this.datatable.fireEvent("export",[n]),new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).exportToExcel(n.data||e,n.title||o,n.colWidthArray||s,this.getDateIndexArray())}}),MWF.xApplication.process.Xform.DatatablePC.Importer=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.datatable=t,this.form=this.datatable.form,this.columnJsonList=[]},isAvaliableColumn:function(t,e){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.type&&"sequence"!=e.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.type)))},importFromExcel:function(){this.getColumnList();var t=this.getDateIndexArray(),e=this.getOrgTitleArray();new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).upload(t,function(t){if(this.checkCount(t)){var i=function(){this.checkData(t)?this.importData(t):this.openErrorDlg(t),this.destroySimulateModule()}.bind(this);e.length>0?this.listAllOrgData(e,t,function(){i()}.bind(this)):i()}}.bind(this))},destroySimulateModule:function(){this.simelateModuleMap&&(Object.keys(this.simelateModuleMap).each(function(t,e){var i=this.simelateModuleMap[t];if(i){var s=i.json.id;this.form.businessData.data.hasOwnProperty(s)&&delete this.form.businessData.data[s],delete this.simelateModuleMap[t]}}.bind(this)),this.simelateModuleMap=null,this.simulateNode&&(this.simulateNode.destroy(),this.simulateNode=null))},loadSimulateModule:function(){this.simelateModuleMap&&this.destroySimulateModule(),this.simelateModuleMap={},this.simulateNode=new Element("div").inject(this.datatable.node),this.simulateNode.hide(),this.simulateNode.set("html",this.datatable.templateHtml),this.form._getModuleNodes(this.simulateNode).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);if(e&&this.isAvaliableColumn(null,e)){var i=Object.clone(e),s=i.id;i.id="dtSimulate_"+i.id,t.set("id",i.id),MWF["APP"+i.type]||MWF.xDesktop.requireApp("process.Xform",i.type,null,!1);var o=new MWF["APP"+i.type](t,i,this.form);this.simelateModuleMap[s]=o,o.load()}}}.bind(this))},getColumnList:function(){this.loadSimulateModule(),this.columnJsonList=[];var t=this.datatable.titleTr.getElements("th.mwf_origional"),e=this.datatable.templateTr.getElements("td.mwf_origional"),i=0;return t.each(function(t,s){var o,n=this.form._getDomjson(t);if(e[s]){var a=this.form._getModuleNodes(e[s]);a.length>0&&(o=this.form._getDomjson(a[0]))}n&&o&&this.isAvaliableColumn(n,o)&&(this.columnJsonList.push({thJson:n,title:t.get("text"),mJson:o,field:o.id,index:i,module:this.simelateModuleMap[o.id]}),i++)}.bind(this)),this.columnJsonList},getDateIndexArray:function(){var t=[],e=0;return this.columnJsonList.each(function(i){i.mJson&&"Calendar"===i.mJson.type&&(t.push(e),e++)}.bind(this)),t},getOrgTitleArray:function(){var t=[];return this.columnJsonList.each(function(e){e.mJson&&["Org","Reader","Author","Personfield","Orgfield"].contains(e.mJson.type)&&t.push(e.title)}.bind(this)),t},parseImportedData:function(t){var e=[];return t.each(function(t){var i={};this.columnJsonList.each(function(e,s){e.index;var o,n=e.module,a=e.mJson,r=e.title,l=t[r]||"";if(""===l||null==l)o="";else switch(a.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":var h=this.stringToArray(l);0===h.length?o=this.getOrgData(l):(o=[],h.each(function(t,e){var i=this.getOrgData(t);o.push(i)}.bind(this)));break;case"Combox":case"Address":h=this.stringToArray(l),o=0===h.length?h[0]:h;break;case"Checkbox":h=this.stringToArray(l);var d=n.getOptionsObj();h.each((function(t,e){var i=d.textList.indexOf(t);h[e]=i>-1?d.valueList[i]:t})),o=1===h.length?h[0]:h;break;case"Radio":case"Select":o=l.replace(/&#10;/g,"");var c=(d=n.getOptionsObj()).textList.indexOf(o);o=c>-1?d.valueList[c]:o;break;case"Textarea":o=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if((o=l.replace(/&#10;/g,""))&&new Date(o).isValid())u=a.format?a.format:"datetime"===a.selectType||"time"===a.selectType?"time"===a.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,o=Date.parse(o).format(u);break;default:o=l.replace(/&#10;/g,"")}i[a.id]=o}.bind(this)),e.push(i)}.bind(this)),e},stringToArray:function(t){return t.replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},importData:function(t){var e=this.parseImportedData(t);this.datatable.fireEvent("import",[e]),this.datatable.setData({data:e}),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openErrorDlg:function(t){var e=this,i=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},s=["<table "+i(this.datatable.json.impExpTableProperties)+" style='"+i(this.datatable.json.impExpTableStyles,"style")+"'>"],o=i(this.datatable.json.impExpTableTitleStyles,"style");s.push("<tr>"),this.columnJsonList.each((function(t,e){s.push("<th style='"+o+"'>"+t.title+"</th>")})),s.push("<th style='"+o+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),s.push("</tr>");var n=Object.clone(this.datatable.json.impExpTableContentStyles);n["border-bottom"]||n.border||(n["border-bottom"]="1px solid #eee");var a=i(Object.merge(n,{"text-align":"left"}),"style");t.each(function(t,e){s.push("<tr>"),this.columnJsonList.each((function(e,i){s.push("<td style='"+a+"'>"+(t[e.title]||"").replace(/&#10;/g,"<br/>")+"</td>")})),s.push("<td style='"+a+"'>"+(t.errorTextList?t.errorTextList.join("<br/>"):"")+"</td>"),s.push("</tr>")}.bind(this)),s.push("</table>");var r=this.datatable.json.impExpDlgWidth||1e3,l=this.datatable.json.impExpDlgHeight||700;r=r.toInt(),l=l.toInt();var h=new Element("div",{style:"padding:10px;",html:s.join("")}),d=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:h,offset:{y:0},isMax:!0,width:r,height:l,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){e.exportWithImportDataToExcel(t)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}],onPostClose:function(){d=null}.bind(this)})},checkCount:function(t){var e=MWF.xApplication.process.Xform.LP,i=!1,s=this.datatable.json.maxCount?this.datatable.json.maxCount.toInt():0;s>0&&t.length>s&&(i=!0);var o=!1,n=this.datatable.json.minCount?this.datatable.json.minCount.toInt():0;if(n>0&&t.length<n&&(o=!0),i){var a=e.importTooManyNotice.replace("{n1}",t.length).replace("{n2}",this.datatable.json.maxCount);return this.form.notice(a,"error"),!1}if(o){a=e.importTooFewNotice.replace("{n1}",t.length).replace("{n2}",this.datatable.json.minCount);return this.form.notice(a,"error"),!1}return!0},checkData:function(t){var e=!0,i=MWF.xApplication.process.Xform.LP,s=i.importValidationColumnText,o=i.importValidationColumnTextExcel,n=new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable),a=this.parseImportedData(t,!0);t.each(function(t,r){var l=[],h=[],d=a&&a[r]?a[r]:[];this.columnJsonList.each(function(e,a){var r=e.index,c=e.mJson,u=e.module,p=e.title,f=s.replace("{n}",r+1),m=o.replace("{n}",n.index2ColName(r)),g=t[p]||"",y=d[c.id]||"";if(g)switch(c&&c.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":this.stringToArray(g).each(function(t,e){var s=this.getOrgData(t);s.errorText&&(l.push(f+s.errorText+i.fullstop),h.push(m+s.errorText+i.fullstop))}.bind(this));break;case"Number":isNaN(g)&&(l.push(f+g+i.notValidNumber+i.fullstop),h.push(m+g+i.notValidNumber+i.fullstop));break;case"Calendar":isNaN(g)&&!isNaN(Date.parse(g))||(l.push(f+g+i.notValidDate+i.fullstop),h.push(m+g+i.notValidDate+i.fullstop))}if(u&&u.setData&&"Address"!==c.type){var b=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(c.type)&&"array"===o2.typeOf(y)&&y.length&&(b=y.some((function(t){return t.errorText}))),b||(u.setData(y),u.validationMode(),!u.validation()&&u.errNode&&(l.push(f+u.errNode.get("text")),h.push(m+u.errNode.get("text")),u.errNode.destroy()))}}.bind(this)),l.length>0&&(t.errorTextList=l,t.errorTextListExcel=h,e=!1)}.bind(this));var r={validted:e,data:t};return this.datatable.fireEvent("validImport",[r]),r.validted},exportWithImportDataToExcel:function(t){new MWF.xApplication.process.Xform.DatatablePC.Exporter(this.datatable).exportWithImportDataToExcel(t)},getOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMap[t]||this.personMap[t]||this.unitMap[t]||this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listAllOrgData:function(t,e,i){var s=[],o=[],n=[],a=[];if(t.length>0){var r,l,h,d;e.each(function(e,i){t.each(function(t,i){e[t]&&this.stringToArray(e[t]).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s.push(t);break;case"@p":o.push(t);break;case"@u":n.push(t);break;case"@g":a.push(t);break;default:s.push(t),o.push(t),n.push(t),a.push(t)}}))}.bind(this))}.bind(this));var c=function(){r&&l&&h&&d&&i&&i()};this.identityMap={},s.length?(s=s.unique(),o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:s},function(t){t.data.each(function(t){this.identityMap[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this))):(r=!0,c()),this.personMap={},o.length?(o=o.unique(),o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:o},function(t){t.data.each(function(t){this.personMap[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this))):(l=!0,c()),this.unitMap={},n.length?(n=n.unique(),o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){t.data.each(function(t){this.unitMap[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this))):(h=!0,c()),this.groupMap={},a.length?(a=a.unique(),o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMap[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this))):(d=!0,c())}}}),MWF.xApplication.process.Xform.DatatablePC.ExcelUtils=new Class({initialize:function(t){this.datatable=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var o=new Uint8Array(s.result),n=o.byteLength,a=0;a<n;a++)e+=String.fromCharCode(o[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=o.files;if(t.length){var n=t.item(0);this.importFromExcel(n,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var o=s.getFirst();o.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var o=window.xlsxUtils.format2Sheet(t,0,0,null),n=window.xlsxUtils.format2WB(o,"sheet1",void 0),a=n.Sheets[n.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var h=a[l];if(h.s||(h.s={}),h.s.alignment||(h.s.alignment={}),h.s.alignment.wrapText=!0,s&&s.length){var d=l.replace(/\d+/g,"");l.replace(d,"")>1&&s.contains(d)&&(h.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(n),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,o,n=new FileReader;n.onload=function(t){o=t?t.target.result:n.content;var a=(s=window.XLSX.read(o,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var r=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var h=r["!ref"].split(":");2===h.length&&(l=parseInt(h[1].replace(/[^0-9]/gi,"")))}if(l)for(var d=0;d<i.length;d++)for(var c=1;c<=l;c++){var u=r[i[d]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},n.readAsBinaryString(t)}))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Datatemplate=MWF.APPDatatemplate=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","afterLoad","beforeLoadLine","afterLoadLine","addLine","deleteLine","afterDeleteLine","export","import","validImport"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.editable=!(this.readonly||!0===this.json.isReadonly),this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.getRelativeId(),this.importenable=this.editable&&this.importActionIdList.length>0&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable=this.exportActionIdList.length>0&&("impexp"===this.json.impexpType||"exp"===this.json.impexpType),this.data=this._getValue(),this._getBusinessData()||(this.isNew=!0,this._setValue(this.data)),this.lineList=[],this._loadStyles(),this.getTemplate(),this.form.isLoaded||this.setOuterActionEvents(),this.node.getChildren().hide(),this.fireEvent("load"),this._loadDataTemplate(function(){this.fireEvent("postLoad")}.bind(this))},getRelativeId:function(){this.outerAddActionIdList=(this.json.outerAddActionId||"").split(","),this.outerDeleteActionIdList=(this.json.outerDeleteActionId||"").split(","),this.outerSelectAllIdList=(this.json.outerSelectAllId||"").split(","),this.addActionIdList=(this.json.addActionId||"").split(","),this.deleteActionIdList=(this.json.deleteActionId||"").split(","),this.sequenceIdList=(this.json.sequenceId||"").split(","),this.selectorId=this.json.selectorId,this.importActionIdList=(this.json.importActionId||"").split(","),this.exportActionIdList=(this.json.exportActionId||"").split(",")},getTemplate:function(){this.templateJson={},this.templateHtml=this.node.get("html"),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);this.templateJson[e.id]=e}}.bind(this))},_loadStyles:function(){this.node.setStyles(this.json.styles),this.node.set(this.json.properties)},_getOuterActionModules:function(t){var e=[];return t.each(function(t){var i=this._getModuleByPath(t),s=t.split("..").getLast();!this.templateJson.hasOwnProperty(s)&&i&&e.push(i)}.bind(this)),e},_setOuterActionEvents:function(){this.addActionList=this._getOuterActionModules([].concat(this.addActionIdList,this.outerAddActionIdList)),this.addActionList.each(function(t){t.node.addEvents({click:function(t){this._addLine(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.deleteActionList=this._getOuterActionModules([].concat(this.outerDeleteActionIdList)),this.deleteActionList.each(function(t){t.node.addEvents({click:function(t){this._deleteSelectedLine(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.selectAllList=this._getOuterActionModules(this.outerSelectAllIdList),this.selectAllList.each(function(t){t.node.addEvents({click:function(t){this._checkSelectAll(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.selectAllSelector=this.selectAllList[0],this.selectAllSelector&&this.unselectAll(),this.importActionList=this._getOuterActionModules(this.importActionIdList),this.importActionList.each(function(t){t.node.addEvents({click:function(t){this.importFromExcel()}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.exportActionList=this._getOuterActionModules(this.exportActionIdList),this.exportActionList.each(function(t){t.node.addEvents({click:function(t){this.exportToExcel()}.bind(this)})}.bind(this))},setOuterActionEvents:function(){this.bindEvent=function(){this._setOuterActionEvents(),this.fireEvent("afterLoad"),this.form.removeEvent("afterModulesLoad",this.bindEvent)}.bind(this),this.form.addEvent("afterModulesLoad",this.bindEvent)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();if(t||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"object"===o2.typeOf(t)&&(t=[t])),!t){t=[];for(var e=this.json.defaultCount?this.json.defaultCount.toInt():0,i=0;i<e;i++)t.push({})}return t},getValue:function(){return this._getValue()},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.moduleValueAG=null,t},_loadDataTemplate:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this._loadLineList(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},_loadLineList:function(t){this.data.each(function(t,e){var i=this.isNew||"number"===o2.typeOf(this.newLineIndex)&&e===this.newLineIndex,s=new Element("div").inject(this.node),o=this._loadLine(s,t,e,i);this.lineList.push(o)}.bind(this)),this.newLineIndex=null,this.isNew=!1,t&&t()},isMax:function(){var t=this.json.maxCount?this.json.maxCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length>=t)},isMin:function(){var t=this.json.minCount?this.json.minCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length<=t)},_loadLine:function(t,e,i,s){var o=new MWF.xApplication.process.Xform.Datatemplate.Line(t,this,e,{index:i,indexText:(i+1).toString(),isEdited:this.editable,isNew:s});return this.fireEvent("beforeLoadLine",[o]),o.load(),this.fireEvent("afterLoadLine",[o]),o},_setLineData:function(t,e){var i=t.options.index,s=this.getData();s[i]=e,this.setData(s)},_addLine:function(t,e){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var s,o=this.getData();o.push(e||{});var n=o.length-1;return this.newLineIndex=n,this.setData(o),s=this.getLine(n),this.fireEvent("addLine",[{line:s,ev:t}]),s},_insertLine:function(t,e){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var s,o,n=e.options.index+1;return(s=this.getData()).splice(n,0,{}),this.newLineIndex=n,this.setData(s),o=this.getLine(n),this.fireEvent("addLine",[{line:o,ev:t}]),o},_insertLineByIndex:function(t,e,i){if(this.isMax()){var s=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(s,"info"),!1}var o=this.getData();if(o.length<e)return null;o.splice(e,0,i||{}),this.newLineIndex=e,this.setData(o);var n=this.getLine(e);return this.fireEvent("addLine",[{line:n,ev:t}]),n},_deleteSelectedLine:function(t){var e=this.lineList.filter((function(t){return t.selected}));if(0===e.length)return this.form.notice(MWF.xApplication.process.Xform.LP.selectItemNotice,"info"),!1;var i=this.json.minCount?this.json.minCount.toInt():0;if(i>0&&this.lineList.length-e.length<i){var s=MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}",i);return this.form.notice(s,"info"),!1}var o=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice,300,120,(function(){o._delLines(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLines:function(t){var e=this,i=e.getData(),s=!1;t.reverse().each((function(t){e.fireEvent("deleteLine",[t]),t.deleteAttachment()&&(s=!0),i.splice(t.options.index,1),e.fireEvent("afterDeleteLine")})),e.setData(i),s&&this.form.saveFormData()},_deleteLine:function(t,e){if(this.isMin()){var i=MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}",this.json.minCount);return this.form.notice(i,"info"),!1}var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){s._delLine(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLine:function(t){this.fireEvent("deleteLine",[t]);var e=t.deleteAttachment(),i=this.getData();i.splice(t.options.index,1),this.setData(i),this.fireEvent("afterDeleteLine"),e&&this.form.saveFormData()},_checkSelectAll:function(){var t,e=this.selectAllSelector.getData();t="array"===o2.typeOf(e)?e.contains(this.json.outerSelectAllSelectedValue):e===this.json.outerSelectAllSelectedValue,this.selected=t,this.lineList.each(function(t){this.selected?t.select():t.unselect()}.bind(this))},selectAll:function(){this.selected=!0,this.selectAllSelector&&this.selectAllSelector.setData(this.json.outerSelectAllSelectedValue)},unselectAll:function(){if(this.selected=!1,this.selectAllSelector.getOptionsObj){for(var t="",e=this.selectAllSelector.getOptionsObj().valueList||[],i=0;i<e.length;i++){var s=e[i];if(s!==this.json.outerSelectAllSelectedValue){t=s;break}}this.selectAllSelector.setData(t)}else this.selectAllSelector.setData("")},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!==e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},exportToExcel:function(){this.exporter=new MWF.xApplication.process.Xform.Datatemplate.Exporter(this),this.exporter.exportToExcel()},importFromExcel:function(){this.importer=new MWF.xApplication.process.Xform.Datatemplate.Importer(this),this.importer.importFromExcel()},_afterLoaded:function(){},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){this._setBusinessData(t),this.data=t,this.data&&this.clearSubModules(),this.lineList=[],this._loadDataTemplate(function(){this._setSubDatatemplateOuterEvents()}.bind(this))},_setSubDatatemplateOuterEvents:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].setSubDatatemplateOuterActionEvents()},clearSubModules:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].clearSubModules()},isEmpty:function(){var t=this.getData();return!t||("array"===o2.typeOf(t)?0===t.length:"object"===o2.typeOf(t)&&0===Object.keys(t).length)},getLine:function(t){return this.lineList[t]||null},addLine:function(t){return this._addLine(null,t)},insertLine:function(t,e){return this._insertLineByIndex(null,t,e)},deleteLine:function(t,e){var i=this.lineList[t];if(!i)return null;this._delLine(i)},getModule:function(t,e){var i=this.lineList[t];return i?i.getModule(e):null},getData:function(){return this.importer&&this.importer.destroySimulateModule(),this.editable,this._getBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();if("object"===o2.typeOf(i)){var s=[];Object.each(i,(function(t,e){"array"===o2.typeOf(t)&&(s=s.concat(t))})),i=s}var o="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!o)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(e.prompt),!1;break;case"gt":if(o>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(o<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(o==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(o!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=o.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==o.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"===i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t}}),MWF.xApplication.process.Xform.Datatemplate.Line=new Class({Implements:[Options,Events],options:{isNew:!1,isEdited:!0,index:0,indexText:"0"},initialize:function(t,e,i,s){this.setOptions(s),this.node=t,this.template=e,this.data=i,this.form=this.template.form,this.modules=[],this.all={},this.all_templateId={},this.fields=[],this.allField={},this.allField_templateId={},this.addActionList=[],this.deleteActionList=[],this.sequenceNodeList=[],this.selector=null,this.importActionList=[],this.exportActionList=[],this.subDatatemplateModuleList=[]},load:function(){this.node.set("html",this.template.templateHtml),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t);if(i){var s=Object.clone(i);this.options.isEdited||(s.isReadonly=!0);var o=s.id,n=this.options.index,a=this.template.json.id+".."+n+".."+s.id;s.id=a,t.set("id",a),"Attachment"!==s.type&&"AttachmentDg"!==s.type||(s.type="AttachmentDg",s.ignoreSite=!0,s.site=this.getAttachmentSite(s,o)),this.form.all[a]&&(this.form.all[a]=null),this.form.forms[a]&&(this.form.forms[a]=null);var r=this.form._loadModule(s,t,(function(){}));"Attachment"===s.type||"AttachmentDg"===s.type?r.addEvent("change",function(){e.form.saveFormData()}.bind(this)):"Datatemplate"===s.type&&this.subDatatemplateModuleList.push(r),this.form.modules.push(r),this.modules.push(r),this.all[a]=r,this.all_templateId[o]=r,r.field&&(this.allField[a]=r,this.allField_templateId[o]=r,this.fields.push(r)),this.setEvents(r,o)}}}.bind(this)),this.options.isNew&&(this.data=this.getData(),this.options.isNew=!1)},setSubDatatemplateOuterActionEvents:function(){this.subDatatemplateModuleList.each((function(t){t._setOuterActionEvents(),t._setSubDatatemplateOuterEvents()}))},getModule:function(t){return this.all_templateId[t]},getAttachmentSite:function(t,e){var i,s=64-(i="."+this.options.index+"."+(t.site||e)).length,o=this.template.json.id;return(o=o.length>s?o.substr(o.length-s,s):o)+i},setEvents:function(t,e){if(this.template.addActionIdList.contains(e)&&(this.addActionList.push(t),t.node.addEvent("click",function(t){this.template._insertLine(t,this)}.bind(this)),this.template.editable||t.node.hide()),this.template.deleteActionIdList.contains(e)&&(this.deleteActionList.push(t),t.node.addEvent("click",function(t){this.template._deleteLine(t,this)}.bind(this)),this.template.editable||t.node.hide()),this.template.selectorId===e&&(this.selector=t,t.node.addEvent("click",function(t){this.checkSelect()}.bind(this)),this.template.editable||t.node.hide(),this.unselect()),this.template.sequenceIdList.contains(e)){this.sequenceNodeList.push(t);var i=this.options.indexText;"label"===this.form.getModuleType(t)?t.node.set("text",i):t.set(i)}},checkSelect:function(){var t,e=this.selector.getData();t="array"===o2.typeOf(e)?e.contains(this.template.json.selectorSelectedValue):e===this.template.json.selectorSelectedValue,this.selected=t},select:function(){this.selected=!0,this.selector&&this.selector.setData(this.template.json.selectorSelectedValue)},unselect:function(){if(this.selected=!1,this.selector.getOptionsObj){for(var t="",e=this.selector.getOptionsObj().valueList||[],i=0;i<e.length;i++){var s=e[i];if(s!==this.template.json.selectorSelectedValue){t=s;break}}this.selector.setData(t)}else this.selector.setData("")},reload:function(){for(var t in this.all){var e=this.all[t];this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.empty(),this.load()},clearSubModules:function(){for(var t in this.all){var e=this.all[t];e.clearSubModules&&e.clearSubModules(),this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.destroy()},getData:function(){var t=this.data;for(var e in this.allField){var i=this.allField[e],s=e.split("..").getLast();"Attachment"===i.json.type||"AttachmentDg"===i.json.type?t[s]=i._getBusinessData():t[s]=i.getData()}return t},setData:function(t){this.template._setLineData(this,t)},deleteAttachment:function(){var t=!1;for(var e in this.allField){var i=this.allField[e];if("Attachment"===i.json.type||"AttachmentDg"===i.json.type)(i._getBusinessData()||[]).each(function(e){t=!0,this.form.workAction.deleteAttachment(e.id,this.form.businessData.work.id)}.bind(this))}return t}}),MWF.xApplication.process.Xform.Datatemplate.Exporter=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.template=t,this.form=this.template.form},exportToExcel:function(){var t=[],e=this.template.json.excelFieldConfig.map((function(t){return t.title}));t.push(e),this.template.lineList.each(function(e,i){t.push(this.getLineExportData(e,i))}.bind(this));var i=this.getColWidthArray(),s=this.getExcelName(),o={data:t,colWidthArray:i,title:s};this.template.fireEvent("export",[o]),new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).exportToExcel(o.data||t,o.title||s,o.colWidthArray||i,this.getDateIndexArray())},getLineExportData:function(t,e){var i=[];return this.template.json.excelFieldConfig.each(function(e){var s=t.all_templateId[e.field],o=s?s.json:"";if(s&&o&&this.isAvaliableField(o)){var n="";if(l=s.getData())switch(s.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if("array"===o2.typeOf(l)){var a=[];l.each(function(t){"object"===o2.typeOf(t)?a.push(t.distinguishedName):a.push(t)}.bind(this)),n=a.join(", \n")}else n="object"===o2.typeOf(l)?l.distinguishedName:l;break;case"Combox":case"Address":n="array"===o2.typeOf(l)?l.join(", "):l;break;case"Checkbox":var r=s.getOptionsObj(),l="array"===o2.typeOf(l)?l:[l],h=[];l.each((function(t,e){var i=r.valueList.indexOf(t);h.push(i>-1?r.textList[i]:"")})),n=h.join(", ");break;case"Radio":case"Select":var d=(r=s.getOptionsObj()).textList.indexOf(l);n=d>-1?r.valueList[d]:"";break;case"Textarea":case"Calendar":default:n=l}else"Label"===o.type&&s.node&&(n=s.node.get("text"));n||"number"===o2.typeOf(n)||(n=""),i.push(n)}else i.push("")}.bind(this)),i},isAvaliableField:function(t){return!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(t.type)},getExcelName:function(){var t=(this.template.json.excelName&&this.template.json.excelName.code?this.form.Macro.exec(this.template.json.excelName.code,this):MWF.xApplication.process.Xform.LP.datatemplateExportDefaultName).split(".");return["xls","xlst"].contains(t[t.length-1].toLowerCase())&&t.splice(t.length-1),t.join(".")},getColWidthArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e){var i=this.form.json.moduleList[e.field];i?["Org","Reader","Author","Personfield","Orgfield"].contains(i.type)?t.push(340):"Address"===i.type?t.push(170):"Textarea"===i.type?t.push(260):"Htmleditor"===i.type?t.push(500):(i.type,t.push(150)):t.push(150)}.bind(this)),t},getDateIndexArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&"Calendar"===s.type&&t.push(i)}.bind(this)),t},exportWithImportDataToExcel:function(t,e){var i=[],s=this.template.json.excelFieldConfig.map((function(t){return t.title}));s.push(MWF.xApplication.process.Xform.LP.validationInfor),i.push(s),e.each(function(e,s){var o=[];t.each((function(t,i){o.push((e[t.text]||"").replace(/&#10;/g,"\n"))})),o.push(e.errorTextListExcel?e.errorTextListExcel.join("\n"):""),i.push(o)}.bind(this));var o=this.getColWidthArray();o.push(300);var n=this.getExcelName(),a={data:i,colWidthArray:o,title:n,withError:!0};this.template.fireEvent("export",[a]),new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).exportToExcel(a.data||i,a.title||n,a.colWidthArray||o,this.getDateIndexArray())}}),MWF.xApplication.process.Xform.Datatemplate.Importer=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.template=t,this.form=this.template.form},isAvaliableField:function(t,e,i){return!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(t.type)},importFromExcel:function(){var t=this.getFieldArray(),e=this.getDateIndexArray(),i=this.getOrgTitleArray();new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).upload(e,function(e){var s=function(){this.checkCount(e)&&(this.checkData(t,e)?this.importData(t,e):this.openErrorDlg(t,e),this.destroySimulateModule())}.bind(this);i.length>0?this.listAllOrgData(i,e,function(){s()}.bind(this)):s()}.bind(this))},destroySimulateModule:function(){this.simelateModuleMap&&(Object.keys(this.simelateModuleMap).each(function(t,e){var i=this.simelateModuleMap[t];if(i){var s=i.json.id;this.form.businessData.data.hasOwnProperty(s)&&delete this.form.businessData.data[s],delete this.simelateModuleMap[t]}}.bind(this)),this.simelateModuleMap=null,this.simulateNode&&(this.simulateNode.destroy(),this.simulateNode=null))},loadSimulateModule:function(){this.simelateModuleMap&&this.destroySimulateModule(),this.simelateModuleMap={},this.simulateNode=new Element("div").inject(this.template.node),this.simulateNode.hide(),this.simulateNode.set("html",this.template.templateHtml),this.form._getModuleNodes(this.simulateNode).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);if(e&&this.isAvaliableField(e)){var i=Object.clone(e),s=i.id;i.id="dtSimulate_"+i.id,t.set("id",i.id),MWF["APP"+i.type]||MWF.xDesktop.requireApp("process.Xform",i.type,null,!1);var o=new MWF["APP"+i.type](t,i,this.form);this.simelateModuleMap[s]=o,o.load()}}}.bind(this))},getFieldArray:function(){this.loadSimulateModule();var t=[];return this.template.json.excelFieldConfig.each(function(e,i){t.push({text:e.title,field:e.field,index:i,module:this.simelateModuleMap[e.field],json:this.form.json.moduleList[e.field]})}.bind(this)),t},getDateIndexArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&"Calendar"===s.type&&t.push(i)}.bind(this)),t},getOrgTitleArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&["Org","Reader","Author","Personfield","Orgfield"].contains(s.type)&&t.push(e.title)}.bind(this)),t},parseImportedData:function(t,e){var i=[];return e.each(function(e){var s={};t.each(function(t,i){t.index;var o,n=t.module,a=t.json,r=t.text,l=e[r]||"";if(""===l||null==l)o="";else switch(a.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":var h=this.stringToArray(l);0===h.length?o=this.getOrgData(l):(o=[],h.each(function(t,e){var i=this.getOrgData(t);o.push(i)}.bind(this)));break;case"Combox":case"Address":h=this.stringToArray(l),o=0===h.length?h[0]:h;break;case"Checkbox":h=this.stringToArray(l);var d=n.getOptionsObj();h.each((function(t,e){var i=d.textList.indexOf(t);h[e]=i>-1?d.valueList[i]:t})),o=1===h.length?h[0]:h;break;case"Radio":case"Select":o=l.replace(/&#10;/g,"");var c=(d=n.getOptionsObj()).textList.indexOf(o);o=c>-1?d.valueList[c]:o;break;case"Textarea":o=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if((o=l.replace(/&#10;/g,""))&&new Date(o).isValid())u=a.format?a.format:"datetime"===a.selectType||"time"===a.selectType?"time"===a.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,o=Date.parse(o).format(u);break;default:o=l.replace(/&#10;/g,"")}s[a.id]=o}.bind(this)),i.push(s)}.bind(this)),i},stringToArray:function(t){return t.replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},importData:function(t,e){var i=this.parseImportedData(t,e);this.template.fireEvent("import",[i]),this.template.setData(i),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openErrorDlg:function(t,e){var i=this,s=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},o=["<table "+s(this.template.json.impExpTableProperties)+" style='"+s(this.template.json.impExpTableStyles,"style")+"'>"],n=s(this.template.json.impExpTableTitleStyles,"style");o.push("<tr>"),t.each((function(t,e){o.push("<th style='"+n+"'>"+t.text+"</th>")})),o.push("<th style='"+n+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),o.push("</tr>");var a=Object.clone(this.template.json.impExpTableContentStyles);a["border-bottom"]||a.border||(a["border-bottom"]="1px solid #eee");var r=s(Object.merge(a,{"text-align":"left"}),"style");e.each(function(e,i){o.push("<tr>"),t.each((function(t,i){o.push("<td style='"+r+"'>"+(e[t.text]||"").replace(/&#10;/g,"<br/>")+"</td>")})),o.push("<td style='"+r+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),o.push("</tr>")}.bind(this)),o.push("</table>");var l=this.template.json.impExpDlgWidth||1e3,h=this.template.json.impExpDlgHeight||700;l=l.toInt(),h=h.toInt();var d=new Element("div",{style:"padding:10px;",html:o.join("")}),c=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:d,offset:{y:0},isMax:!0,width:l,height:h,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){i.exportWithImportDataToExcel(t,e)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){c.close()}}],onPostClose:function(){c=null}.bind(this)})},exportWithImportDataToExcel:function(t,e){new MWF.xApplication.process.Xform.Datatemplate.Exporter(this.template).exportWithImportDataToExcel(t,e)},checkCount:function(t){var e=MWF.xApplication.process.Xform.LP,i=!1,s=this.template.json.maxCount?this.template.json.maxCount.toInt():0;s>0&&t.length>s&&(i=!0);var o=!1,n=this.template.json.minCount?this.template.json.minCount.toInt():0;if(n>0&&t.length<n&&(o=!0),i){var a=e.importTooManyNotice.replace("{n1}",t.length).replace("{n2}",this.template.json.maxCount);return this.form.notice(a,"error"),!1}if(o){a=e.importTooFewNotice.replace("{n1}",t.length).replace("{n2}",this.template.json.minCount);return this.form.notice(a,"error"),!1}return!0},checkData:function(t,e){var i=!0,s=MWF.xApplication.process.Xform.LP,o=s.importValidationColumnText,n=s.importValidationColumnTextExcel,a=new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template),r=this.parseImportedData(t,e,!0);e.each(function(e,l){var h=[],d=[],c=r&&r[l]?r[l]:[];t.each(function(t,i){var r=t.index,l=t.json,u=t.module,p=t.text,f=o.replace("{n}",r+1),m=n.replace("{n}",a.index2ColName(r)),g=e[p]||"",y=c[l.id]||"";if(g)switch(l&&l.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":this.stringToArray(g).each(function(t,e){var i=this.getOrgData(t);i.errorText&&(h.push(f+i.errorText+s.fullstop),d.push(m+i.errorText+s.fullstop))}.bind(this));break;case"Number":isNaN(g)&&(h.push(f+g+s.notValidNumber+s.fullstop),d.push(m+g+s.notValidNumber+s.fullstop));break;case"Calendar":isNaN(g)&&!isNaN(Date.parse(g))||(h.push(f+g+s.notValidDate+s.fullstop),d.push(m+g+s.notValidDate+s.fullstop))}if(u&&u.setData&&"Address"!==l.type){var b=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(l.type)&&"array"===o2.typeOf(y)&&y.length&&(b=y.some((function(t){return t.errorText}))),b||(u.setData(y),u.validationMode(),!u.validation()&&u.errNode&&(h.push(f+u.errNode.get("text")),d.push(m+u.errNode.get("text")),u.errNode.destroy()))}}.bind(this)),h.length>0&&(e.errorTextList=h,e.errorTextListExcel=d,i=!1)}.bind(this));var l={validted:i,data:e};return this.template.fireEvent("validImport",[l]),l.validted},getOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMap[t]||this.personMap[t]||this.unitMap[t]||this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listAllOrgData:function(t,e,i){var s=[],o=[],n=[],a=[];if(t.length>0){var r,l,h,d;e.each(function(e,i){t.each(function(t,i){e[t]&&this.stringToArray(e[t]).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s.push(t);break;case"@p":o.push(t);break;case"@u":n.push(t);break;case"@g":a.push(t);break;default:s.push(t),o.push(t),n.push(t),a.push(t)}}))}.bind(this))}.bind(this));var c=function(){r&&l&&h&&d&&i&&i()};this.identityMap={},s.length?(s=s.unique(),o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:s},function(t){t.data.each(function(t){this.identityMap[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this))):(r=!0,c()),this.personMap={},o.length?(o=o.unique(),o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:o},function(t){t.data.each(function(t){this.personMap[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this))):(l=!0,c()),this.unitMap={},n.length?(n=n.unique(),o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){t.data.each(function(t){this.unitMap[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this))):(h=!0,c()),this.groupMap={},a.length?(a=a.unique(),o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMap[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this))):(d=!0,c())}}}),MWF.xApplication.process.Xform.Datatemplate.ExcelUtils=new Class({initialize:function(t){this.datatemplate=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var o=new Uint8Array(s.result),n=o.byteLength,a=0;a<n;a++)e+=String.fromCharCode(o[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=o.files;if(t.length){var n=t.item(0);this.importFromExcel(n,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var o=s.getFirst();o.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var o=window.xlsxUtils.format2Sheet(t,0,0,null),n=window.xlsxUtils.format2WB(o,"sheet1",void 0),a=n.Sheets[n.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var h=a[l];if(h.s||(h.s={}),h.s.alignment||(h.s.alignment={}),h.s.alignment.wrapText=!0,s&&s.length){var d=l.replace(/\d+/g,"");l.replace(d,"")>1&&s.contains(d)&&(h.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(n),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,o,n=new FileReader;n.onload=function(t){o=t?t.target.result:n.content;var a=(s=window.XLSX.read(o,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var r=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var h=r["!ref"].split(":");2===h.length&&(l=parseInt(h[1].replace(/[^0-9]/gi,"")))}if(l)for(var d=0;d<i.length;d++)for(var c=1;c<=l;c++){var u=r[i[d]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},n.readAsBinaryString(t)}))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Documenteditor=MWF.APPDocumenteditor=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","beforeLoad","postLoad","afterLoad","loadPage","fullScreen","returnScreen"],docPageHeight:850.4,docPageFullWidth:794,pageShow:"single"},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadCss:function(t){var e=encodeURIComponent(this.cssPath);!t&&o2.widget.css[e]?this.css=o2.widget.css[e]:(this.cssPath=-1!=this.cssPath.indexOf("?")?this.cssPath+"&v="+o2.version.v:this.cssPath+"?v="+o2.version.v,new Request.JSON({url:this.cssPath,secure:!1,async:!1,method:"get",noCache:!1,onSuccess:function(t,i){this.css=t,o2.widget.css[e]=t}.bind(this),onError:function(t,e){console.log(e+t)}}).send())},load:function(){this.json.isDelay||this.active()},active:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this.fireEvent("beforeLoad"),this.cssPath=this.form.path+this.form.options.style+"/doc.wcss",this._loadCss(),this._queryLoaded(),this._loadUserInterface(function(){this.fireEvent("postLoad"),this.fireEvent("afterLoad"),this.fireEvent("load"),this.form.app.addEvent("resize",function(){this._singlePage(),this._checkScale()}.bind(this)),o2.UD.getDataJson("documenteditorScale",function(t){t&&(this.scaleTo(t.scale),this.documenteditorScale=t.scale),this.addEvent("loadPage",function(){this.documenteditorScale&&this.scaleTo(this.documenteditorScale)}.bind(this))}.bind(this))}.bind(this)),this._loadStyles(),this._afterLoaded())},_createNewPage:function(){var t=new Element("div.doc_layout_page",{styles:this.css.doc_page}).inject(this.contentNode);new Element("div.doc_layout_page_content",{styles:this.css.doc_layout_page_content}).inject(t);return t.set("data-pagecount",this.pages.length+1),this.pages.push(t),t},_getShow:function(t,e,i){switch(this.json[e]){case"y":return!0;case"n":return!1;case"a":return!["copies","secret","priority","attachment","annotation","copyto","copyto2"].indexOf(-1!=t)||!!this.data[t]&&!!this.data[t].length;case"s":return!this.json[i]||!this.json[i].code||!!this.form.Macro.exec(this.json[i].code,this);default:return!0}},_createPage:function(t,e){var i=this._createNewPage().getFirst(),s=this.getShowControl();if(this.json.fileup=!!s.signer,this.json.css&&this.json.css.code&&!this.styleNode){var o=this.form.parseCSS(this.json.css.code);o=o.replace(/documenteditor_table/g,"documenteditor_table"+this.form.json.id+this.json.id);var n=document.createElement("style");if(n.setAttribute("type","text/css"),n.id="style"+this.json.id,n.inject(this.node,"top"),n.styleSheet){var a=function(){n.styleSheet.cssText=o};n.styleSheet.disabled?setTimeout(a,10):a()}else{var r=document.createTextNode(o);n.appendChild(r)}this.styleNode=n}"cus"==this.json.documentTempleteType?i.loadHtml(o2.filterUrl(this.json.documentTempleteUrl),function(){if("y"==this.json.toWordPageNumber&&this.doPageStyles(i),this.attachmentTemplete){var o=i.getElement(".doc_layout_attachment_content");o&&o.empty()}t&&t(s),this.fireEvent("loadPage"),e&&e(s)}.bind(this)):this.getTempleteJson(function(){var o=this.json.documentTempleteName||"standard";i.loadHtml(o2.filterUrl("../x_component_process_FormDesigner/Module/Documenteditor/templete/"+this.templeteJson[o].file),function(){if("y"==this.json.toWordPageNumber&&this.doPageStyles(i),this.attachmentTemplete){var o=i.getElement(".doc_layout_attachment_content");o&&o.empty()}t&&t(s),this.fireEvent("loadPage"),e&&e(s)}.bind(this))}.bind(this))},doPageStyles:function(t){var e=t.getLast("style");if(e){var i=window.location.origin,s=o2.filterUrl(i+"/x_component_process_FormDesigner/Module/Documenteditor/header.htm"),o=e.get("html"),n=/(?:@page\s*\{)([\s\S]*?)(?:\})/,a=o.match(n);if(a&&a.length){if(cssText=a[2],cssText)";"!==cssText.substr(cssText.length-1,1)&&(cssText+=";"),cssText+='mso-page-border-surround-header:no;\n        mso-page-border-surround-footer:no;\n        mso-footnote-separator:url("'+s+'") fs;\n        mso-footnote-continuation-separator:url("'+s+'") fcs;\n        mso-endnote-separator:url("'+s+'") es;\n        mso-endnote-continuation-separator:url("'+s+'") ecs;\n        mso-facing-pages:yes;',o=o.replace(a[0],a[1]+cssText+a[3])}else o+='@page\n    {mso-page-border-surround-header:no;\n        mso-page-border-surround-footer:no;\n        mso-footnote-separator:url("'+s+'") fs;\n        mso-footnote-continuation-separator:url("'+s+'") fcs;\n        mso-endnote-separator:url("'+s+'") es;\n        mso-endnote-continuation-separator:url("'+s+'") ecs;\n        mso-facing-pages:yes;}';if(n=/(@page\s*WordSection1\s*\{)([\s\S]*?)(\})/,(a=o.match(n))&&a.length){if(cssText=a[2],cssText)";"!==cssText.substr(cssText.length-1,1)&&(cssText+=";"),cssText+='mso-header-margin:42.55pt;\n        mso-footer-margin:70.9pt;\n        mso-even-footer:url("'+s+'") ef1;\n        mso-footer:url("'+s+'") f1;\n        mso-paper-source:0;',o=o.replace(a[0],a[1]+cssText+a[3])}else o+='@page WordSection1\n    {size:595.3pt 841.9pt;\n        margin:104.9pt 73.7pt 99.25pt 79.4pt;\n        layout-grid:15.6pt;\n        line-height:normal;\n        font-size:16.0pt;\n        font-family:仿宋;\n        letter-spacing:-0.4pt;\n        mso-header-margin:42.55pt;\n        mso-footer-margin:70.9pt;\n        mso-even-footer:url("'+s+'") ef1;\n        mso-footer:url("'+s+'") f1;\n        mso-paper-source:0;\n    }';e.set("html",o)}},getTempleteJson:function(t){this.templeteJson?t&&t():o2.getJSON(o2.filterUrl("../x_component_process_FormDesigner/Module/Documenteditor/templete/templete.json"),function(e){this.templeteJson=e,t&&t()}.bind(this))},getShowControl:function(){var t={};return t.copiesSecretPriority=this._getShow("copiesSecretPriority","copiesSecretPriorityShow","copiesSecretPriorityShowScript"),t.copies=this._getShow("copies","copiesShow","copiesShowScript"),t.secret=this._getShow("secret","secretShow","secretShowScript"),t.priority=this._getShow("priority","priorityShow","priorityShowScript"),t.redHeader=this._getShow("redHeader","redHeaderShow","redHeaderShowScript"),t.redLine=this._getShow("redLine","redLineShow","redLineShowScript"),t.signer=this._getShow("signer","signerShow","signerShowScript"),t.fileno=this._getShow("fileno","filenoShow","filenoShowScript"),t.subject=this._getShow("subject","subjectShow","subjectShowScript"),t.mainSend=this._getShow("mainSend","mainSendShow","mainSendShowScript"),t.attachment=this._getShow("attachment","attachmentShow","attachmentShowScript"),t.issuanceUnit=this._getShow("issuanceUnit","issuanceUnitShow","issuanceUnitShowScript"),t.issuanceDate=this._getShow("issuanceDate","issuanceDateShow","issuanceDateShowScript"),t.annotation=this._getShow("annotation","annotationShow","annotationShowScript"),t.copyto=this._getShow("copyto","copytoShow","copytoShowScript"),t.copyto2=this._getShow("copyto2","copyto2Show","copyto2ShowScript"),t.editionUnit=this._getShow("editionUnit","editionUnitShow","editionUnitShowScript"),t.editionDate=this._getShow("editionDate","editionDateShow","editionDateShowScript"),t.meetingAttend=this._getShow("meetingAttend","meetingAttendShow","meetingAttendShowScript"),t.meetingLeave=this._getShow("meetingLeave","meetingLeaveShow","meetingLeaveShowScript"),t.meetingSit=this._getShow("meetingSit","meetingSitShow","meetingSitShowScript"),t.meetingRecord=this._getShow("meetingRecord","meetingRecordShow","meetingRecordShowScript"),t},getEditControl:function(){var t={};return t.copies=this._getEdit("copies","copiesEdit","copiesEditScript"),t.secret=this._getEdit("secret","secretEdit","secretEditScript"),t.priority=this._getEdit("priority","priorityEdit","priorityEditScript"),t.redHeader=this._getEdit("redHeader","redHeaderEdit","redHeaderEditScript"),t.signer=this._getEdit("signer","signerEdit","signerEditScript"),t.fileno=this._getEdit("fileno","filenoEdit","filenoEditScript"),t.subject=this._getEdit("subject","subjectEdit","subjectEditScript"),t.mainSend=this._getEdit("mainSend","mainSendEdit","mainSendEditScript"),t.attachment=this._getEdit("attachment","attachmentEdit","attachmentEditScript"),t.issuanceUnit=this._getEdit("issuanceUnit","issuanceUnitEdit","issuanceUnitEditScript"),t.issuanceDate=this._getEdit("issuanceDate","issuanceDateEdit","issuanceDateEditScript"),t.annotation=this._getEdit("annotation","annotationEdit","annotationEditScript"),t.copyto=this._getEdit("copyto","copytoEdit","copytoEditScript"),t.copyto2=this._getEdit("copyto2","copyto2Edit","copyto2EditScript"),t.editionUnit=this._getEdit("editionUnit","editionUnitEdit","editionUnitEditScript"),t.editionDate=this._getEdit("editionDate","editionDateEdit","editionDateEditScript"),t.meetingAttend=this._getShow("meetingAttend","meetingAttendEdit","meetingAttendEditScript"),t.meetingLeave=this._getShow("meetingLeave","meetingLeaveEdit","meetingLeaveEditScript"),t.meetingSit=this._getShow("meetingSit","meetingSitEdit","meetingSitEditScript"),t.meetingRecord=this._getShow("meetingRecord","meetingRecordEdit","meetingRecordEditScript"),t},_loadCopiesSecretPriority:function(){this.layout_copiesSecretPriority=this.contentNode.getElement(".doc_layout_copiesSecretPriority"),this.layout_copiesSecretPriority&&this.layout_copiesSecretPriority.setStyles(this.css.doc_layout_copiesSecretPriority),this.layout_copies=this.contentNode.getElement(".doc_layout_copies"),this.layout_copies&&this.layout_copies.setStyles(this.css.doc_layout_copies),this.layout_secret=this.contentNode.getElement(".doc_layout_secret"),this.layout_secret&&this.layout_secret.setStyles(this.css.doc_layout_secret),this.layout_priority=this.contentNode.getElement(".doc_layout_priority"),this.layout_priority&&this.layout_priority.setStyles(this.css.doc_layout_priority),this.layout_copiesSecretPriority_blank=this.contentNode.getElement(".doc_layout_copiesSecretPriority_blank")},_loadRedHeader:function(){this.layout_redHeader=this.contentNode.getElement(".doc_layout_redHeader"),this.layout_redHeader&&this.layout_redHeader.setStyles(this.css.doc_layout_redHeader)},_loadFileNoUp:function(){this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_fileNoUpTable&&this.layout_fileNoUpTable.setStyles(this.css.doc_layout_filenoup);var t=this.contentNode.getElement(".doc_layout_filenoup_fileno_td");t&&t.setStyles(this.css.doc_layout_filenoup_fileno_td),this.layout_fileno=this.contentNode.getElement(".doc_layout_filenoup_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_filenoup_fileno),(t=this.contentNode.getElement(".doc_layout_filenoup_signer_td"))&&t.setStyles(this.css.doc_layout_filenoup_signer_td);var e=this.contentNode.getElement(".doc_layout_filenoup_signer_table");e&&e.setStyles(this.css.doc_layout_filenoup_signer_table),(e=this.contentNode.getElement(".doc_layout_filenoup_signerTitle_td"))&&e.setStyles(this.css.doc_layout_filenoup_signerTitle_td),this.layout_signerTitle=this.contentNode.getElement(".doc_layout_filenoup_signer"),this.layout_signerTitle&&this.layout_signerTitle.setStyles(this.css.doc_layout_filenoup_signer),(e=this.contentNode.getElement(".doc_layout_filenoup_signerContent_td"))&&e.setStyles(this.css.doc_layout_filenoup_signerContent_td),this.layout_signer=this.contentNode.getElement(".doc_layout_filenoup_signerContent"),this.layout_signer&&this.layout_signer.setStyles(this.css.doc_layout_filenoup_signerContent),this.layout_fileno||(this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileno=this.contentNode.getElement(".doc_layout_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_fileno))},_loadFileNo:function(){this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileno=this.contentNode.getElement(".doc_layout_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_fileno),(e=this.contentNode.getElement(".doc_layout_filenoup_signer_td"))&&e.setStyles(this.css.doc_layout_filenoup_signer_td);var t=this.contentNode.getElement(".doc_layout_filenoup_signer_table");if(t&&t.setStyles(this.css.doc_layout_filenoup_signer_table),(t=this.contentNode.getElement(".doc_layout_filenoup_signerTitle_td"))&&t.setStyles(this.css.doc_layout_filenoup_signerTitle_td),this.layout_signerTitle=this.contentNode.getElement(".doc_layout_filenoup_signer"),this.layout_signerTitle&&this.layout_signerTitle.setStyles(this.css.doc_layout_filenoup_signer),(t=this.contentNode.getElement(".doc_layout_filenoup_signerContent_td"))&&t.setStyles(this.css.doc_layout_filenoup_signerContent_td),this.layout_signer=this.contentNode.getElement(".doc_layout_filenoup_signerContent"),this.layout_signer&&this.layout_signer.setStyles(this.css.doc_layout_filenoup_signerContent),!this.layout_fileno){this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_fileNoUpTable&&this.layout_fileNoUpTable.setStyles(this.css.doc_layout_filenoup);var e=this.contentNode.getElement(".doc_layout_filenoup_fileno_td");e&&e.setStyles(this.css.doc_layout_filenoup_fileno_td),this.layout_fileno=this.contentNode.getElement(".doc_layout_filenoup_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_filenoup_fileno)}},_loadRedLine:function(){this.layout_redLine=this.contentNode.getElement(".doc_layout_redline"),this.layout_redLine&&this.layout_redLine.setStyles(this.css.doc_layout_redline)},_loadSubject:function(){this.layout_subject=this.contentNode.getElement(".doc_layout_subject"),this.layout_subject&&this.layout_subject.setStyles(this.css.doc_layout_subject)},_loadMainSend:function(){this.layout_mainSend=this.contentNode.getElement(".doc_layout_mainSend"),this.layout_mainSend&&this.layout_mainSend.setStyles(this.css.doc_layout_mainSend)},_loadFiletext:function(){this.layout_filetext=this.contentNode.getElement(".doc_layout_filetext"),this.layout_filetext.addClass("css"+this.form.json.id+this.json.id),this.layout_filetext.setStyles(this.css.doc_layout_filetext)},_loadAttachment:function(){this.layout_attachmentTable=this.contentNode.getElement(".doc_layout_attachment"),this.layout_attachmentTable&&this.layout_attachmentTable.setStyles(this.css.doc_layout_attachment);var t=this.contentNode.getElement(".doc_layout_attachment_title_td");t&&t.setStyles(this.css.doc_layout_attachment_title_td),this.layout_attachmentTitle=this.contentNode.getElement(".doc_layout_attachment_title"),t&&t.setStyles(this.css.doc_layout_attachment_title),(t=this.contentNode.getElement(".doc_layout_attachment_content_td"))&&t.setStyles(this.css.doc_layout_attachment_content_td),this.layout_attachment=this.contentNode.getElement(".doc_layout_attachment_content"),this.layout_attachment&&this.layout_attachment.setStyles(this.css.doc_layout_attachment_content)},_loadIssuance:function(){this.layout_issuanceTable=this.contentNode.getElement(".doc_layout_issuance"),this.layout_issuanceUnit=this.contentNode.getElement(".doc_layout_issuanceUnit"),this.layout_issuanceDate=this.contentNode.getElement(".doc_layout_issuanceDate"),this.layout_issuanceTable&&this.layout_issuanceTable.setStyles(this.css.doc_layout_issuance),this.layout_issuanceUnit&&this.layout_issuanceUnit.setStyles(this.css.doc_layout_issuanceUnit),this.layout_issuanceDate&&this.layout_issuanceDate.setStyles(this.css.doc_layout_issuanceDate)},_loadAnnotation:function(){this.layout_annotation=this.contentNode.getElement(".doc_layout_annotation"),this.layout_annotation&&this.layout_annotation.setStyles(this.css.doc_layout_annotation)},_loadEdition:function(){var t;this.layout_editionArea=this.contentNode.getElement(".doc_layout_editionArea"),this.layout_edition=this.contentNode.getElement(".doc_layout_edition"),this.layout_edition&&this.layout_edition.setStyles(this.css.doc_layout_edition),(t=this.contentNode.getElement(".doc_layout_edition_copyto"))&&t.setStyles(this.css.doc_layout_edition_copyto),(t=this.contentNode.getElement(".doc_layout_edition_copyto_table"))&&t.setStyles(this.css.doc_layout_edition_copyto_table),(t=this.contentNode.getElement(".doc_layout_edition_copyto2"))&&t.setStyles(this.css.doc_layout_edition_copyto),(t=this.contentNode.getElement(".doc_layout_edition_copyto2_table"))&&t.setStyles(this.css.doc_layout_edition_copyto_table),this.layout_copytoTitle=this.contentNode.getElement(".doc_layout_edition_copyto_title"),this.layout_copytoTitle&&this.layout_copytoTitle.setStyles(this.css.doc_layout_edition_copyto_title),this.layout_copytoContent=this.contentNode.getElement(".doc_layout_edition_copyto_content"),this.layout_copytoContent&&this.layout_copytoContent.setStyles(this.css.doc_layout_edition_copyto_content),this.layout_copyto2Title=this.contentNode.getElement(".doc_layout_edition_copyto2_title"),this.layout_copyto2Title&&this.layout_copyto2Title.setStyles(this.css.doc_layout_edition_copyto_title),this.layout_copyto2Content=this.contentNode.getElement(".doc_layout_edition_copyto2_content"),this.layout_copyto2Content&&this.layout_copyto2Content.setStyles(this.css.doc_layout_edition_copyto_content);var e=this.contentNode.getElement(".doc_layout_edition_issuance");e&&e.setStyles(this.css.doc_layout_edition_issuance);var i=this.contentNode.getElement(".doc_layout_edition_issuance_table");i&&i.setStyles(this.css.doc_layout_edition_issuance_table),this.layout_edition_issuance_unit=this.contentNode.getElement(".doc_layout_edition_issuance_unit"),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit.setStyles(this.css.doc_layout_edition_issuance_unit),this.layout_edition_issuance_date=this.contentNode.getElement(".doc_layout_edition_issuance_date"),this.layout_edition_issuance_date&&this.layout_edition_issuance_date.setStyles(this.css.doc_layout_edition_issuance_date)},_loadMeeting:function(){this.layout_meetingAttendArea=this.contentNode.getElement(".doc_layout_meeting_attend"),this.layout_meetingAttendTitle=this.contentNode.getElement(".doc_layout_meeting_attend_title"),this.layout_meetingAttendContent=this.contentNode.getElement(".doc_layout_meeting_attend_content"),this.layout_meetingLeaveArea=this.contentNode.getElement(".doc_layout_meeting_leave"),this.layout_meetingLeaveTitle=this.contentNode.getElement(".doc_layout_meeting_leave_title"),this.layout_meetingLeaveContent=this.contentNode.getElement(".doc_layout_meeting_leave_content"),this.layout_meetingSitArea=this.contentNode.getElement(".doc_layout_meeting_sit"),this.layout_meetingSitTitle=this.contentNode.getElement(".doc_layout_meeting_sit_title"),this.layout_meetingSitContent=this.contentNode.getElement(".doc_layout_meeting_sit_content"),this.layout_meetingRecordArea=this.contentNode.getElement(".doc_layout_meeting_record"),this.layout_meetingRecordTitle=this.contentNode.getElement(".doc_layout_meeting_record_title"),this.layout_meetingRecordContent=this.contentNode.getElement(".doc_layout_meeting_record_content")},_loadCustom:function(){this.contentNode.getElements(".doc_layout").each(function(t){var e=t.get("data-doc-layout");this.customLayouts||(this.customLayouts=[]),this.customLayouts.push({name:e,node:t}),this[e]=t}.bind(this))},_loadPageLayout:function(t){this._loadCopiesSecretPriority(),this._loadRedHeader(),this.json.fileup?this._loadFileNoUp():this._loadFileNo(),this.layout_fileno||this._loadFileNo(),this._loadRedLine(),this._loadSubject(),this._loadMainSend(),this._loadFiletext(),this._loadAttachment(),this._loadIssuance(),this._loadAnnotation(),this._loadEdition(),this._loadMeeting(),this._loadCustom(),this.reSetShow(t),this.reSetEdit()},reSetShow:function(t){t||(t=this.getShowControl());var e=function(e){return t[e]?"show":"hide"};this.layout_copiesSecretPriority&&this.layout_copiesSecretPriority[e("copiesSecretPriority")]();var i=0;if(t.copies||i++,t.secret||i++,t.priority||i++,this.layout_copiesSecretPriority_blank)for(;i>0;)this.layout_copiesSecretPriority_blank.empty(),this.layout_copiesSecretPriority_blank.appendHTML("<span style='font-size:16.0pt'>&nbsp;</span>"),i--;if(this.layout_copies&&this.layout_copies[e("copies")](),this.layout_secret&&this.layout_secret[e("secret")](),this.layout_priority&&this.layout_priority[e("priority")](),this.layout_redHeader&&this.layout_redHeader[e("redHeader")](),this.layout_redLine&&this.layout_redLine[e("redLine")](),this.layout_fileNoUpTable&&this.layout_fileNoUpTable[e("signer")](),this.layout_filenoArea&&this.layout_filenoArea[t.signer?"hide":"show"](),this.layout_signerTitle&&this.layout_signerTitle[e("signer")](),this.layout_signer&&this.layout_signer[e("signer")](),this.layout_fileno&&this.layout_fileno[e("fileno")](),this.layout_subject&&this.layout_subject[e("subject")](),this.layout_mainSend&&this.layout_mainSend[e("mainSend")](),this.layout_attachmentTable&&this.layout_attachmentTable[e("attachment")](),this.layout_issuanceUnit&&this.layout_issuanceUnit[e("issuanceUnit")](),this.layout_issuanceDate&&this.layout_issuanceDate[e("issuanceDate")](),this.layout_issuanceUnit&&this.layout_issuanceDate){var s=this.layout_issuanceUnit.getParent("table");if(s&&!s.hasClass("doc_layout_headIssuance")){var o=o2.getTextSize(this.layout_issuanceUnit.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x,n=o2.getTextSize(this.layout_issuanceDate.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x;if(o<n){if(a=this.layout_issuanceDate.getParent("td").getNext("td")){a.setStyle("width","64pt"),(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","64pt")}this.layout_issuanceUnit.getParent("td").setStyle("width",n),(r=this.layout_issuanceUnit.getParent("p"))&&r.setStyle("text-align","center")}else{var a,r;(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","32pt"),this.layout_issuanceUnit.getParent("td").setStyle("width","auto"),(a=this.layout_issuanceDate.getParent("td").getNext("td"))&&a.setStyle("width","64pt"),(r=this.layout_issuanceDate.getParent("p"))&&r.setStyle("text-align","right")}}}if(this.layout_annotation&&this.layout_annotation[e("annotation")](),t.copyto&&this.layout_copytoContent||t.copyto2&&this.layout_copyto2Content||t.editionUnit&&this.layout_edition_issuance_unit||t.editionDate&&this.layout_edition_issuance_date){if(t.copyto&&this.layout_copytoContent||t.copyto2&&this.layout_copyto2Content?t.copyto&&this.layout_copytoContent?t.copyto2&&this.layout_copyto2Content||this.layout_copyto2Content&&this.layout_copyto2Content.getParent("tr").destroy():this.layout_copytoContent&&this.layout_copytoContent.getParent("tr").destroy():this.layout_edition&&(this.layout_copytoContent&&this.layout_copytoContent.getParent("tr").destroy(),this.layout_copyto2Content&&this.layout_copyto2Content.getParent("tr").destroy()),!(t.editionUnit&&this.layout_edition_issuance_unit||t.editionDate&&this.layout_edition_issuance_date)&&this.layout_editionArea&&(this.contentNode.getElement(".doc_layout_edition_issuance_date")||this.contentNode.getElement(".doc_layout_edition_issuance_unit"))){var l=this.layout_editionArea.getElement("table").rows;l.item(l.length-1).destroy()}if(this.layout_editionArea&&(this.layout_edition_issuance_date||this.layout_edition_issuance_unit)){l=this.layout_editionArea.getElement("table").rows;for(var h=0;h<l.length;h++){var d=l.item(h).cells;for(i=0;i<d.length;i++){var c=d.item(i),u=c.get("class"),p=u?u.split(/\s+/g):[];-1!=p.indexOf("line_top_thin_bottom_thick")&&(p=p.erase("line_top_thin_bottom_thick")),-1!=p.indexOf("line_top_thick_bottom_thin")&&(p=p.erase("line_top_thick_bottom_thin")),-1!=p.indexOf("line_top_thick_bottom_thick")&&(p=p.erase("line_top_thick_bottom_thick")),-1==p.indexOf("line_top_thin_bottom_thin")&&p.unshift("line_top_thin_bottom_thin"),0==h&&h!=l.length-1?(-1!=p.indexOf("line_top_thin_bottom_thin")&&(p=p.erase("line_top_thin_bottom_thin")),p.unshift("line_top_thick_bottom_thin")):0==h&&h==l.length-1?(-1!=p.indexOf("line_top_thin_bottom_thin")&&(p=p.erase("line_top_thin_bottom_thin")),p.unshift("line_top_thick_bottom_thick")):0!=h&&h==l.length-1&&(-1!=p.indexOf("line_top_thin_bottom_thin")&&(p=p.erase("line_top_thin_bottom_thin")),p.unshift("line_top_thin_bottom_thick")),u=p.join(" "),c.set("class",u)}}}var f=this.layout_copytoTitle||this.layout_copyto2Title;if(f){var m=f.getParent("table");if(m&&"y"==m.get("data-compute-style")){var g=m.rows;for(h=0;h<g.length;h++){var y=g[h].cells[0],b=y.getElement(".doc_layout_edition_issuance_unit");if(b||(b=y.getElement(".doc_layout_edition_issuance_date")),!b){var v=y.get("text").trim(),x=14*v.length,w=19*v.length;y.setStyles({"max-width":x+"pt","min-width":x+"pt",width:w+"pt"})}}}}this.layout_editionArea&&this.layout_editionArea.show(),this.layout_copytoTitle&&this.layout_copytoTitle[e("copyto")](),this.layout_copytoContent&&this.layout_copytoContent[e("copyto")](),this.layout_copyto2Title&&this.layout_copyto2Title[e("copyto2")](),this.layout_copyto2Content&&this.layout_copyto2Content[e("copyto2")](),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit[e("editionUnit")](),this.layout_edition_issuance_date&&this.layout_edition_issuance_date[e("editionDate")]()}else this.layout_editionArea&&this.layout_editionArea.hide();this.layout_meetingAttendArea&&this.layout_meetingAttendArea[e("meetingAttend")](),this.layout_meetingLeaveArea&&this.layout_meetingLeaveArea[e("meetingLeave")](),this.layout_meetingSitArea&&this.layout_meetingSitArea[e("meetingSit")](),this.layout_meetingRecordArea&&this.layout_meetingRecordArea[e("meetingRecord")]()},reSetEdit:function(t){if(!t)t=this.getEditControl();this.layout_subject&&(this.json.subjectValueData||"data"!=this.json.subjectValueType||(this.layout_subject.set("contenteditable",t.subject),this.layout_subject.addEvent("blur",function(t){var e=this.layout_subject.get("text");e?(this.json.subjectEditBindFormData&&(this.form.Macro.environment.data[this.json.subjectEditBindFormData]=e),this.getData()):(this.layout_subject.set("html",this.data.subject),this.form.app.notice(MWF.xApplication.process.Xform.LP.subjectEmpty,"error",this.layout_subject,{x:"center",y:"top"},{x:0,y:60}),t.preventDefault(),t.stopPropagation())}.bind(this)))),this.layout_issuanceUnit&&(this.json.issuanceUnitValueData||"data"!=this.json.issuanceUnitValueType||(this.layout_issuanceUnit.set("contenteditable",t.issuanceUnit),this.layout_issuanceUnit.addEvent("blur",function(t){this.layout_issuanceUnit.get("text")?this.getData():(this.layout_issuanceUnit.set("html",this.data.issuanceUnit),this.form.app.notice(MWF.xApplication.process.Xform.LP.issuanceUnitEmpty,"error",this.layout_issuanceUnit,{x:"center",y:"top"},{x:0,y:60}),t.preventDefault(),t.stopPropagation())}.bind(this))))},_loadUserInterface:function(t){this.node.empty(),this.node.setStyles(this.form.css.documentEditorNode),this.pages=[],this.allowEdit=this._isAllowEdit(),this.allowPrint=this._isAllowPrint(),this.allowHistory=this._isAllowHistory(),this.toolNode=new Element("div",{styles:this.css.doc_toolbar}).inject(this.node),this.contentNode=new Element("div#doc_content",{styles:this.css.doc_content}).inject(this.node),this.form.isLoaded?this.loadDocumentEditor(t):this.form.addEvent("afterModulesLoad",function(){this.loadDocumentEditor(t)}.bind(this))},loadDocumentEditor:function(t){this._loadToolbars(),this._loadFiletextPage(function(){if("double"!==this.options.pageShow?this._singlePage():this._doublePage(),this.form.addEvent("beforeSave",function(){this.resetData(),this.checkSaveNewEdition()}.bind(this)),"y"==this.json.toWord&&("open"==this.json.toWordTrigger&&this.docToWord(),"save"==this.json.toWordTrigger&&(this.form.toWordSaveList||(this.form.toWordSaveList=[]),this.form.toWordSaveList.push(this)),"submit"==this.json.toWordTrigger&&(this.form.toWordSubmitList||(this.form.toWordSubmitList=[]),this.form.toWordSubmitList.push(this))),layout.mobile||this.loadSideToolbar(),o2.load("../o2_lib/diff-match-patch/diff_match_patch.js"),this.form.businessData.data.$work){var e=this.form.businessData.data.$work.job;o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.listWithJobCategory(e,this.json.id,function(t){this.historyDocumentList=t.data,this.historyDocumentList.length&&o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.get(this.historyDocumentList[this.historyDocumentList.length-1].id,function(t){var e=JSON.parse(t.data.data);this.originaHistoryData=e.data}.bind(this))}.bind(this))}t&&t()}.bind(this)),this.form.documenteditorList||(this.form.documenteditorList=[]),this.form.documenteditorList.push(this)},getFiletextText:function(t){var e=new Element("div",{html:t}),i=e.get("text");return e.destroy(),i},checkSaveNewEdition:function(t){if(!this.allowEdit||!this.data.filetext||this.data.filetext==this.json.defaultValue.filetext)return!1;if(this.form.businessData.work){var e=this.form.businessData.originalData[this.json.id],i={category:this.json.id};if(e&&e.filetext&&this.originaHistoryData){if(e.filetext==this.data.filetext)return!1;var s=this.getFiletextText(this.data.filetext),o=this.getFiletextText(e.filetext),n=new diff_match_patch,a=n.diff_main(o,s);n.diff_cleanupSemantic(a);var r=n.patch_make(o,s,a),l={patchs:n.patch_toText(r),data:this.data.filetext,v:"6"};i.data=JSON.stringify(l)}else this.originaHistoryData={data:this.data.filetext,v:"6"},i.data=JSON.stringify({data:this.data.filetext,v:"6"});o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.create(this.form.businessData.work.id,i,function(e){t&&t()}.bind(this))}},checkSaveNewHistroy:function(){var t=o2.Actions.load("x_processplatform_assemble_surface").DocumentRevisionAction.getLast(this.form.businessData.work.job,this.json.id);return t.then(function(t){if(!t.data||t.data.data!=this.data.filetext){var e={category:this.json.id,data:this.data.filetext};return o2.Actions.load("x_processplatform_assemble_surface").DocumentRevisionAction.create(this.form.businessData.work.id,e)}}.bind(this)),t},resizeToolbar:function(t){if(this.toolbarNode){var e=this.toolNode.getPosition(t||this.scrollNode),i=this.toolNode.getSize(),s=this.toolbarNode.getStyle("padding-left").toInt(),o=this.toolbarNode.getStyle("padding-right").toInt(),n=i.x-s-o,a=this.isFullScreen?0:(t||this.form.node).getStyle("padding-top");try{a=a.toInt()}catch(t){a=0}e.y<a&&this.toolNode.offsetParent?(this.toolbarNode.inject(t||this.scrollNode),this.toolbarNode.setStyles({position:"absolute",width:n+"px","z-index":200,top:a+"px",left:e.x+"px"})):(this.toolbarNode.inject(this.toolNode),this.toolbarNode.setStyles({position:"static",width:"auto"}))}},resizeSidebar:function(){if(this.sidebarNode){var t=this.contentNode.getElement("div.doc_layout_filetext");if(t){this.sidebarNode.position({relativeTo:t,position:"topLeft",edge:"topRight",offset:{x:-20,y:60}});var e=t.getPosition(this.form.app.content),i=t.getPosition(this.node);if(e.y<0){var s=i.y-e.y+200;this.sidebarNode.setStyle("top",s)}}}},loadSideToolbar:function(){this.allowEdit&&(this.pages.length&&this.pages[0].getElement("div.doc_layout_filetext")&&(this.sidebarNode=new Element("div",{styles:this.css.doc_sidebar}).inject(this.node),this.resizeSidebar(),this.scrollNode=this.sidebarNode.getParentSrcollNode(),this.scrollNode&&this.scrollNode.addEvent("scroll",function(){this.resizeSidebar()}.bind(this)),html='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/editdoc.png" title="'+MWF.xApplication.process.Xform.LP.editdoc+'" MWFButtonAction="_switchReadOrEditInline" MWFButtonText="'+MWF.xApplication.process.Xform.LP.editdoc+'"></span>',this.sidebarNode.set("html",html),MWF.require("MWF.widget.Toolbar",function(){this.sideToolbar=new MWF.widget.Toolbar(this.sidebarNode,{style:"documentEdit_side"},this),this.sideToolbar.load()}.bind(this))))},_returnScale:function(){this.isScale=!1,this.scale=0,this.contentNode.setStyles({transform:"scale(1)"}),this.pages.length&&this.pages.each((function(t){t.setStyles({transform:"scale(1)"})})),this.node.setStyles({height:"auto"})},_checkScale:function(t){if(0,this.pages.length){var e=this.options.docPageFullWidth,i=this.contentNode.getSize(),s=i.x-20;if(s<e){this.isScale=!0;var o=s/e;this.scale=o,this.zoom(),this.resetNodeSize()}}},zoom:function(t){if(t&&(this.scale=t),this.zoomSelectAction)for(var e=0;e<this.zoomSelectAction.options.length;e++){var i=this.zoomSelectAction.options[e];if(Math.abs(this.scale-i.value.toFloat())<.05){i.set("selected",!0);break}}var s=this.node.getSize().x;this.history&&this.history.historyListAreaNode&&(s=s-this.history.historyListAreaNode.getComputedSize().totalWidth-2),s/=this.scale,this.contentNode.setStyles({transform:"scale("+this.scale+")","transform-origin":"0px 0px",overflow:"auto",width:s+"px"}),this.filetextEditor&&this.filetextEditor.element&&this.filetextEditor.element.$.store("scale",this.scale)},_switchReadOrEdit:function(){if(this.editMode){if(this._readFiletext(),this.allowEdit)(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png");this.editMode=!1}else{var t;if(this._editFiletext(),this.allowEdit)(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png");this.editMode=!0}},_switchReadOrEditInline:function(){if(this.editMode){if(this._readFiletext(),this.allowEdit){if(!layout.mobile)(t=this.sideToolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png");(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png")}this.editMode=!1}else{if(this._editFiletext("inline"),this.allowEdit){var t;if(!layout.mobile)(t=this.sideToolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png");(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png")}this.editMode=!0}},_printDoc:function(){var t=this.scale;this.toWord(function(e,i){i?o2.saveAs(e,i):this.form.businessData.work&&!this.form.businessData.work.completedTime?this.form.workAction.getAttachmentStream(e.id,this.form.businessData.work.id):this.form.workAction.getWorkcompletedAttachmentStream(e.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id),this.scaleTo(t)}.bind(this),"",null,!0)},_historyDoc:function(){this.getHistory(function(){}.bind(this))},getHistory:function(t){this.history?this.history.active((function(){t&&t()})):MWF.xDesktop.requireApp("process.Xform","widget.DocumentHistory",function(){this.history=new MWF.xApplication.process.Xform.widget.DocumentHistory(this),this.history.load((function(){t&&t()}))}.bind(this))},htmlToText:function(t){var e=new Element("div",{html:t}),i=e.get("text");return e.destroy(),i},_readFiletext:function(){var t=this.scale;this.filetextEditor&&this.filetextEditor.destroy(),this.filetextScrollNode&&(this.reLocationFiletextToolbarFun&&(this.filetextScrollNode.removeEvent("scroll",this.reLocationFiletextToolbarFun),this.reLocationFiletextToolbarFun=null),this.filetextScrollNode=null),this.filetextToolbarNode&&(this.filetextToolbarNode=null),this.layout_filetext.setAttribute("contenteditable",!1),this.data=this.getData(),this.data.filetext||this.layout_filetext.set("html",this.json.defaultValue.filetext),this._repage(),this.scaleTo(t)},_editFiletext:function(t){this._returnScale(),this.zoom(1),this._singlePage(),this.pages=[],this.contentNode.empty(),this._createPage(function(e){this._loadPageLayout(e),this.data.filetext==this.json.defaultValue.filetext&&(this.data.filetext="　　"),this.setData(this.data),this._checkScale(),this.node.setStyles({height:"auto"}),this._createEditor(t)}.bind(this))},_createEditor:function(t){this.allowEdit&&this.loadCkeditorFiletext(function(t){var e;(t.editor.focus(),this.data.filetext.replace(/\u3000*/g,""))?t.editor.getSelection().scrollIntoView():((e=t.editor.createRange()).moveToElementEditEnd(t.editor.editable()),e.select(),e.scrollIntoView());this.data.filetext.replace(/\u3000*/g,"")?t.editor.getSelection().scrollIntoView():((e=t.editor.createRange()).moveToElementEditEnd(t.editor.editable()),e.select(),e.scrollIntoView());this.locationFiletextToolbar()}.bind(this),t)},getFiletextToolber:function(){if(this.filetextEditor&&!this.filetextToolbarNode){var t="cke_editor_"+this.filetextEditor.name,e=$$("."+t)[0];this.filetextToolbarNode=e}},reLocationFiletextToolbar:function(){if(this.getFiletextToolber(),this.filetextToolbarNode){if(!this.filetextScrollNode){for(var t=this.contentNode;t&&(t.getScrollSize().y<=t.getSize().y||"auto"!==t.getStyle("overflow")&&"auto"!==t.getStyle("4-y"));)t=t.getParent();this.filetextScrollNode=t}var e=this.filetextToolbarNode.getSize().y,i=this.layout_filetext.getPosition(),s=this.layout_filetext.getSize(),o=this.filetextScrollNode.getSize();if(layout.userLayout&&layout.userLayout.scale&&1!==layout.userLayout.scale){var n=this.filetextEditor.editable().$.getPosition().x;this.filetextToolbarNode.setStyle("left",n+"px")}if(this.filetextToolbarNode.setStyle("min-width","530px"),i.y<0&&s.y+i.y+e<o.y){var a=this.toolbar.node.getPosition(),r=this.toolbar.node.getSize().y;e=a.y+r;this.filetextToolbarNode.setStyle("top",e+"px")}else if(i.y-e<0){a=this.toolbar.node.getPosition(),r=this.toolbar.node.getSize().y,e=a.y+r;this.filetextToolbarNode.setStyle("top",e+"px")}else{var l=this.layout_filetext.getPosition().y-e;this.filetextToolbarNode.setStyle("top",l+"px")}}},locationFiletextToolbar:function(){if(this.reLocationFiletextToolbar(),this.filetextToolbarNode){for(var t=this.contentNode;t&&(t.getScrollSize().y<=t.getSize().y||"auto"!==t.getStyle("overflow")&&"auto"!==t.getStyle("overflow-y"));)t=t.getParent();t&&(this.filetextScrollNode=t,this.reLocationFiletextToolbarFun=this.reLocationFiletextToolbar.bind(this),this.filetextScrollNode.addEvent("scroll",this.reLocationFiletextToolbarFun))}},_isAllowEdit:function(){return!this.readonly&&("n"!=this.json.allowEdit&&("s"!=this.json.allowEdit||!this.json.allowEditScript||!this.json.allowEditScript.code||!!this.form.Macro.exec(this.json.allowEditScript.code,this)))},_isAllowPrint:function(){return"n"!=this.json.allowPrint&&("s"!=this.json.allowPrint||!this.json.allowPrintScript||!this.json.allowPrintScript.code||!!this.form.Macro.exec(this.json.allowPrintScript.code,this))},_isAllowHistory:function(){return"n"!=this.json.allowHistory&&("s"!=this.json.allowHistory||!this.json.allowHistoryScript||!this.json.allowHistoryScript.code||!!this.form.Macro.exec(this.json.allowHistoryScript.code,this))},_getEdit:function(t,e,i){switch(this.json[e]){case"y":return!0;case"n":return!1;case"s":return!this.json[i]||!this.json[i].code||!!this.form.Macro.exec(this.json[i].code,this)}},loadCkeditorStyle:function(t){t&&o2.load("ckeditor",function(){t.setAttribute("contenteditable",!0);CKEDITOR.inline(this.layout_filetext,this._getEditorConfig());this.filetextEditor.on("instanceReady",function(t){callback&&callback(t)}.bind(this))}.bind(this))},_loadToolbars:function(){var t,e,i,s="",o=MWF.xApplication.process.Xform.LP.fullScreen;layout.mobile?(t=MWF.xApplication.process.Xform.LP.editdoc_mobile,e=MWF.xApplication.process.Xform.LP.printdoc_mobile,i=MWF.xApplication.process.Xform.LP.history_mobile):(t=MWF.xApplication.process.Xform.LP.editdoc,e=MWF.xApplication.process.Xform.LP.printdoc,i=MWF.xApplication.process.Xform.LP.history),this.allowEdit&&(s+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/editdoc.png" title="'+t+'" MWFButtonAction="_switchReadOrEditInline" MWFButtonText="'+t+'"></span>'),this.allowPrint&&(s+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/print.png" title="'+e+'" MWFButtonAction="_printDoc" MWFButtonText="'+e+'"></span>'),this.allowHistory&&(s+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/versions.png" title="'+i+'" MWFButtonAction="_historyDoc" MWFButtonText="'+i+'"></span>'),"n"!==this.json.canFullScreen&&(s+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/fullscreen.png" title="'+o+'" MWFButtonAction="fullScreen" MWFButtonText="'+o+'"></span>'),this.toolbarNode=new Element("div",{styles:this.css.doc_toolbar_node}).inject(this.toolNode),this.toolbarNode.set("html",s),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:"documentEdit"},this),this.toolbar.load()}.bind(this)),layout.mobile||(this.scrollNode=this.toolbarNode.getParentSrcollNode(),this.scrollNode&&this.scrollNode.addEvent("scroll",function(){this.resizeToolbar()}.bind(this))),this.doublePageAction=new Element("div",{styles:this.css.doc_toolbar_doublePage,text:MWF.xApplication.process.Xform.LP.doublePage}).inject(this.toolbarNode),this.doublePageAction.addEvent("click",function(){"double"!==this.options.pageShow?this._doublePage():(this.options.pageShow="single",this.reload())}.bind(this)),("n"===this.json.canDoublePage||layout.mobile)&&this.doublePageAction.hide(),this.zoomActionArea=new Element("div",{styles:{float:"right","margin-right":"10px"}}).inject(this.toolbarNode),"y"!==this.json.isScale&&this.zoomActionArea.hide(),this.zoomAddAction=new Element("div",{styles:{float:"right","margin-top":"3px",height:"20px",width:"20px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"+"}).inject(this.zoomActionArea),this.zoomSelectAction=new Element("select",{styles:{float:"right","margin-top":"3px",height:"20px",width:"60px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"100%"}).inject(this.zoomActionArea),this.zoomSubAction=new Element("div",{styles:{float:"right","margin-top":"3px",height:"20px",width:"20px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"-"}).inject(this.zoomActionArea);this.zoomSelectAction.set("html","<option value='2'>200%</option> <option value='1.95'>195%</option><option value='1.9'>190%</option><option value='1.85'>185%</option><option value='1.8'>180%</option><option value='1.75'>175%</option><option value='1.7'>170%</option><option value='1.65'>165%</option><option value='1.6'>160%</option><option value='1.55'>155%</option><option value='1.5'>150%</option> <option value='1.45'>145%</option><option value='1.4'>140%</option><option value='1.35'>135%</option><option value='1.3'>130%</option><option value='1.25'>125%</option><option value='1.2'>120%</option><option value='1.15'>115%</option><option value='1.1'>110%</option><option value='1.05'>105%</option><option value='1' selected>100%</option><option value='0.95'>95%</option><option value='0.90'>90%</option><option value='0.85'>85%</option><option value='0.80'>80%</option><option value='0.75'>75%</option><option value='0.70'>70%</option><option value='0.65'>65%</option><option value='0.6'>60%</option><option value='0.55'>55%</option><option value='0.5'>50%</option>"),this.zoomSelectAction.addEvent("change",function(t){this.scaleTo(t.target.options[t.target.selectedIndex].value),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this)),this.zoomAddAction.addEvent("click",function(){var t=(this.scale/.05).toInt();.05*t<this.scale&&t++;var e=.05*t;(e+=.05)<.5&&(e=.5),e>2&&(e=2),this.scaleTo(e),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this)),this.zoomSubAction.addEvent("click",function(){var t=(this.scale/.05).toInt();.05*t<this.scale&&t++;var e=.05*t;(e-=.05)<.5&&(e=.5),e>2&&(e=2),this.scaleTo(e),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this))},fullScreen:function(t){var e=t.node.get("text");this.form.app.content;e===MWF.xApplication.process.Xform.LP.returnScreen?(this.form.node.getParent().show(),this.node.inject(this.positionNode,"before"),this.positionNode.destroy(),this.node.setStyle("min-height",""),this.fireEvent("returnScreen"),t.setText(MWF.xApplication.process.Xform.LP.fullScreen),this.isFullScreen=!1,this.resizeToolbar()):(this.positionNode=new Element("div").inject(this.node,"after"),this.node.inject(this.scrollNode,"top"),this.form.node.getParent().hide(),this.node.setStyle("min-height","100%"),this.fireEvent("fullScreen"),t.setText(MWF.xApplication.process.Xform.LP.returnScreen),this.isFullScreen=!0,this.resizeToolbar()),this.reload()},scaleTo:function(t){this._returnScale(),this.scale=t,this.zoom();var e=(this.contentNode.offsetWidth*this.scale-1*(this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth))/2;if(this.isScale&&(e="10"),this.scale&&(e/=this.scale),e<10){var i=10-e;e=10,this.contentNode.scrollTo(i,0)}this.pages.each((function(t,i){t.setStyles({float:"left","margin-left":e+"px"})})),this.resetNodeSize()},_repage:function(t){"double"!==this.options.pageShow?this._singlePage():this._doublePage(),t?this.form.isLoaded?this._checkScale():this.form.addEvent("afterLoad",this._checkScale.bind(this)):this._checkScale()},_singlePage:function(){var t=this.singlePageZoom||1;this.singlePageZoom&&1!=this.singlePageZoom.toInt()&&(this.isScale=!0,this.scale=this.singlePageZoom,this.singlePageZoom=null),this.zoom(t),this._checkScale();var e=(this.contentNode.getSize().x-1*(this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth))/2;this.isScale&&(e="10"),this.scale&&(e/=this.scale),this.pages.each((function(t,i){t.setStyles({float:"left","margin-left":e+"px"})})),this.resetNodeSize(),this.resizeSidebar(),this.options.pageShow="single",this.doublePageAction.set("text",MWF.xApplication.process.Xform.LP.doublePage)},resetNodeSize:function(){var t=this.contentNode.offsetHeight,e=this.toolNode.getSize(),i=(t*=this.scale||1)+e.y+20;this.node.setStyles({height:i+"px"}),this.resizeSidebar()},createWaitSplitPage:function(){this.node.mask({style:{"background-color":"#cccccc",opacity:.3}}),this.waitSplitPageNode=new Element("div",{styles:this.form.css.waitSplitPageNode,text:MWF.xApplication.process.Xform.LP.computePage}).inject(this.node),this.waitSplitPageNode.position({relativeTo:this.node,position:"topRight",edge:"topRight",offset:{x:-10,y:45}})},clearWaitSplitPage:function(){this.node.unmask(),this.waitSplitPageNode&&this.waitSplitPageNode.destroy(),this.waitSplitPageNode=null},_doublePage:function(){this.editMode&&this._switchReadOrEditInline(),this.zoomSelectAction&&(this.singlePageZoom=this.zoomSelectAction.options[this.zoomSelectAction.selectedIndex].value.toFloat()),this.zoom(1),this.createWaitSplitPage(),window.setTimeout(function(){this._checkSplitPage(this.pages[0]),this.zoom(1);var t=this.contentNode.getSize().x;scale=(t-100)/2/this.options.docPageFullWidth,scale<1&&this.zoom(scale);var e=this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth,i=((t=this.contentNode.getSize().x)/e).toInt(),s=this.contentNode.getElements(".doc_layout_page"),o=(t-(i=Math.min(s.length,i))*e)/(i+1);this.scale&&(o/=this.scale),this.pages.each((function(t,e){t.setStyles({float:"left","margin-left":o+"px"})})),this.resetNodeSize(),this.options.pageShow="double",this.doublePageAction.set("text",MWF.xApplication.process.Xform.LP.singlePage),this.resizeSidebar(),this.clearWaitSplitPage()}.bind(this),1e3)},_getDefaultData:function(){return Object.clone(this.json.defaultValue)},_loadFiletextPage:function(t){this.data=this._getBusinessData(),this.data||(this.data=this._getDefaultData()),this._computeData(!0),this._createPage(function(e){this._loadPageLayout(e),this.setData(this.data),this.readonly,t&&t()}.bind(this))},_getEditorConfig:function(){var t={qtRows:20,qtColumns:20,qtBorder:"1",qtWidth:"95%",qtStyle:{"border-collapse":"collapse"},qtClass:"documenteditor_table"+this.form.json.id+this.json.id,qtCellPadding:"0",qtCellSpacing:"0",qtPreviewBorder:"4px double black",qtPreviewSize:"4px",qtPreviewBackground:"#c8def4",language:o2.language,format_tags:"标题一;标题二;正文(标题三,四)","format_标题一":{name:"标题一(三号黑体)",element:"div",styles:{"font-family":"黑体","font-size":"16pt"}},"format_标题二":{name:"标题二(三号楷体)",element:"div",styles:{"font-family":"楷体","font-size":"16pt"}},"format_正文(标题三,四)":{name:"正文(标题三,四)",element:"div",styles:{"font-family":"仿宋","font-size":"16pt"}},toolbarGroups:[{name:"document",groups:["mode","document","doctools"]},{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection","spellchecker","editing"]},{name:"forms",groups:["forms"]},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi","paragraph"]},{name:"links",groups:["links"]},{name:"insert",groups:["insert"]},{name:"styles",groups:["styles"]},{name:"colors",groups:["colors"]},{name:"tools",groups:["tools"]},{name:"others",groups:["others"]},{name:"about",groups:["about"]}],extraPlugins:"quicktable,tableresize",removeButtons:"Source,Save,NewPage,Preview,Print,Templates,Paste,PasteFromWord,Scayt,Form,Checkbox,Radio,TextField,Textarea,Select,Button,ImageButton,HiddenField,Bold,Italic,Underline,Strike,Subscript,Superscript,CopyFormatting,RemoveFormat,Outdent,Indent,Blockquote,CreateDiv,BidiLtr,BidiRtl,Language,Link,Unlink,Anchor,Flash,HorizontalRule,Smiley,SpecialChar,PageBreak,Iframe,TextColor,BGColor,Maximize,ShowBlocks,About,Styles,Font,FontSize",pasteFromWordRemoveFontStyles:!1,pasteFromWordRemoveStyles:!1,removePlugins:["magicline"]};return t.enterMode=CKEDITOR.ENTER_DIV,t.pasteFilter="plain-text",t},_checkSplitPage:function(t){this.layout_edition&&this.layout_edition.setStyles({position:"static"}),t.getFirst().getSize().y>this.options.docPageHeight&&this._splitPage(t);var e=t.get("data-pagecount").toInt();e&&this.pages.length-1>=e&&this._checkSplitPage(this.pages[e]),this.layout_edition&&this.layout_edition.setStyles({position:"absolute",bottom:"0px"})},_splitFiletextNodeOneWord:function(t,e){var i=t.textContent,s=i.length,o=i.substring(0,s-1),n=i.substring(s-1,s);t.textContent=o,e.textContent=n+e.textContent},_splitFiletext:function(t,e,i,s){var o=s.getFirst(),n=t.lastChild;if(n){for(;o.getSize().y>this.options.docPageHeight&&n;){var a=n.previousSibling,r=n.nodeType;if(e||(e=i),r==Node.ELEMENT_NODE)if("table"==n.tagName)n.inject(e);else if("BR"==n.tagName)n.parentNode&&n.parentNode.removeChild(n);else{var l=n.get("data-pagePart");l||(l=(new o2.widget.UUID).toString(),n.set("data-pagePart",l));var h=e.getFirst();e=h&&h.get("data-pagePart")==l?h:n.clone(!1).inject(e,"top"),this._splitFiletext(n,e,i,s),n.firstChild||n.parentNode&&n.parentNode.removeChild(n),e=e.getParent()}else if(r==Node.TEXT_NODE){for(var d=e.insertBefore(document.createTextNode(""),e.firstChild);o.getSize().y>this.options.docPageHeight&&n.textContent;)this._splitFiletextNodeOneWord(n,d);n.textContent||n.parentNode&&n.parentNode.removeChild(n)}else n.parentNode&&n.parentNode.removeChild(n);n=a}t.lastChild||t.parentNode&&t.parentNode.removeChild(t)}else t.parentNode&&t.parentNode.removeChild(t)},_splitPage:function(t){var e=t.getFirst(),i=t.getElements(".doc_block");if(i.length){var s=i[i.length-1],o=this.pages.indexOf(t);this.pages.length<=o+1&&this._createNewPage();var n=this.pages[o+1];if(s.hasClass("doc_layout_filetext")){var a=n.getElement(".doc_layout_filetext");a||(a=new Element("div.doc_layout_filetext").inject(n.getFirst(),"top")),a.hasClass("doc_block")||a.addClass("doc_block");var r=s,l=a;this._splitFiletext(r,l,a,t)}else s.inject(n.getFirst(),"top"),e.getSize().y>this.options.docPageHeight&&this._splitPage(t)}},transWidth:function(t){if(!t)return"";for(;t;)3==t.nodeType?t.nodeValue=t.nodeValue.replace(/\x20/g,"　"):8==t.nodeType||this.transWidth(t.firstChild),t=t.nextSibling},insertFullWidth:function(t,e){if(!t)return"";for(;t;){if(3==t.nodeType)return t.nodeValue=e+t.nodeValue,!0;if(8==t.nodeType);else if(this.insertFullWidth(t.firstChild,e))return!0;t=t.nextSibling}},loadCkeditorFiletext:function(t,e){this.layout_filetext&&o2.load("../o2_lib/htmleditor/ckeditor4130/ckeditor.js",function(){CKEDITOR.disableAutoInline=!0,this.layout_filetext.setAttribute("contenteditable",!0),this.filetextEditor=e?CKEDITOR.inline(this.layout_filetext,this._getEditorConfig()):CKEDITOR.replace(this.layout_filetext,this._getEditorConfig()),this.filetextEditor.on("instanceReady",function(e){t&&t(e)}.bind(this)),this.filetextEditor.on("focus",function(t){window.setTimeout(this.reLocationFiletextToolbar.bind(this),10)}.bind(this)),this.filetextEditor.on("loaded",function(t){this.filetextEditor.element.$.store("module",this),this.filetextEditor.element.$.store("scale",this.scale)}.bind(this)),this.filetextEditor.on("afterPaste",function(t){}.bind(this)),this.filetextEditor.on("afterPasteFromWord",function(t){}.bind(this)),this.filetextEditor.on("paste",function(t){var e=t.data.dataValue;if(/\<br\>|\<br \/\>|\<br\/\>/g.test(e)&&!/\<p\>/g.test(e)){var i=e.split(/\<br\>|\<br \/\>|\<br\/\>/g);e="",i.each((function(t){e=e+"<p>"+t+"</p>"}))}var s=new Element("div");s.set("html",e),s.getElements("p").each(function(t,e){if("n"!==this.json.fullWidth&&this.transWidth(t),!t.getParent("table")){var i=t.get("text").match(/^\u3000*/),s=i[0]?Math.max(2-i[0].length,0):2;for(e=0;e<s;e++)t.appendText("　","top")}}.bind(this));var o=s.getElements("table");if(o&&o.length){var n=this.layout_filetext.offsetWidth.toFloat();o.each((function(t){var e=t.getStyle("width"),i=e&&e.toFloat()||0,s=t.get("width"),o=s&&s.toFloat()||0,a=Math.max(i,o);(0===a||a>n)&&t.setStyle("width",n+"px")})),o.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"})}s.getElements("td").each((function(t){var e=t.getStyle("border-top-width").toFloat()||0,i=t.getStyle("border-bottom-width").toFloat()||0,s=t.getStyle("border-left-width").toFloat()||0,o=t.getStyle("border-right-width").toFloat()||0;t.setStyles({"border-top-width":e/2+"px","border-bottom-width":i/2+"px","border-left-width":s/2+"px","border-right-width":o/2+"px"})})),t.data.dataValue=s.get("html"),s.destroy(),this.fireEvent("paste")}.bind(this)),this.filetextEditor.on("afterPaste",function(t){this.resetNodeSize(),this.fireEvent("afterPaste")}.bind(this)),this.filetextEditor.on("change",function(t){this.filetextEditor.on("change",function(t){for(var e=document.documentElement.scrollTop,i=this.contentNode;i&&(i.getScrollSize().y<=i.getSize().y||"auto"!==i.getStyle("overflow")&&"auto"!==i.getStyle("4-y"));)i=i.getParent();if(i){var s=i.scrollTop.toFloat();i.scrollTop=e+s}document.documentElement.scrollTop=0}.bind(this))}.bind(this)),this.filetextEditor.on("insertElement",function(t){"table"==t.data.$.tagName.toString().toLowerCase()&&t.data.$.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"});var e=t.data.$.getElement("tr");if(e){var i=e.getElements("td");if(i&&i.length){var s=100/i.length;i.setStyle("width",s+"%")}}}.bind(this)),"n"!==this.json.textIndent&&this.layout_filetext.addEvent("keyup",function(t){13==t.code&&this.filetextEditor.insertText("　　")}.bind(this)),"n"!==this.json.fullWidth&&(this.filetextEditor.addCommand("insertHalfSpace",{exec:function(t){t.insertText(" ")}}),this.filetextEditor.setKeystroke(CKEDITOR.SHIFT+32,"insertHalfSpace"),this.filetextEditor.on("key",function(t){"n"!==this.json.fullWidth&&32==t.data.keyCode&&(t.editor.insertText("　"),t.cancel())}.bind(this)))}.bind(this))},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&this.editor.on(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this),this)}.bind(this))},_bindFieldChange:function(t,e,i){var s=this.form.all[this.json[e]];if(s){var o=function(){this._computeItemFieldData(t,e),this[i]&&("layout_redHeader"==i||"layout_issuanceUnit"==i||"layout_meetingAttendContent"==i||"layout_meetingLeaveContent"==i||"layout_meetingSitContent"==i||"layout_meetingRecordContent"==i||"layout_subject"==i?this[i].set("html",this.data[t]||""):"layout_attachment"==i?this.setAttachmentData():this[i].set("text",this.data[t]||"")),this.reSetShow()}.bind(this);s.node.store(this.json.id+"bindFun",o),s.addModuleEvent("change",o)}},_computeItemFieldData:function(t,e,i){var s="",o=i?this.form.all[i]:this.form.all[this.json[e]];if(o&&o.getData&&(s=o.getData()),s||(s=i?this.form.businessData.data[i]:this.form.businessData.data[this.json[e]]),s)switch(o2.typeOf(s)){case"string":switch(t){case"issuanceDate":case"editionDate":var n=new Date(s);if(n.isValid()&&1970!=n.getFullYear()){var a=n.getFullYear(),r=n.getMonth(),l=n.getDate();r+=1;var h=MWF.xApplication.process.Xform.LP;this.data[t]=""+a+h.year+r+h.month+l+h.date}else this.data[t]=s;break;case"mainSend":this.data[t]=s+"：";break;default:"subject"===t&&(s=o2.txt(s)),this.data[t]=s}break;case"array":var d=[];switch(s.each((function(t){"object"==o2.typeOf(t)&&t.distinguishedName?d.push(t.name):d.push(t.toString())})),t){case"attachment":var c=d.map((function(t){return-1!=t.indexOf(".")?t.substring(0,t.lastIndexOf(".")):t}));this.data[t]=c;break;case"issuanceDate":case"editionDate":var u=d.map((function(t,e){var i=Date.parse(t);if(i.isValid()&&1970!=i.getFullYear()){var s=i.getFullYear(),o=i.getMonth(),n=i.getDate();o+=1;var a=MWF.xApplication.process.Xform.LP;return""+s+a.year+o+a.month+n+a.date}return t}));this.data[t]=u.join("，");break;case"mainSend":this.data[t]=d.join("，")+"：";break;default:this.data[t]=d.join("，")}break;default:this.data[t]=s.toString()}else this.data[t]=this.json.defaultValue[t]},computeData:function(){this._computeData(!1),this.setData(this.data)},_computeItemData:function(t,e,i,s,o,n){switch(this.json[e]){case"data":this.json[i]&&(o&&this._bindFieldChange(t,i,n),this._computeItemFieldData(t,i));break;case"script":if(this.json[s]&&this.json[s].code){var a=this.form.Macro.exec(this.json[s].code,this);if(this.data[t]=a,"attachment"==t&&(this.data[t]="array"==typeOf(a)?a:[a]),"issuanceDate"==t||"editionDate"==t){var r=Date.parse(a);if(r.isValid()&&1970!=r.getFullYear()){var l=r.getFullYear(),h=r.getMonth(),d=r.getDate();h+=1;var c=MWF.xApplication.process.Xform.LP;this.data[t]=""+l+c.year+h+c.month+d+c.date}else this.data[t]=a}}}},_computeCustomItemData:function(t,e,i){i&&this._bindCustomFieldChange(t,e,t),this._computeItemFieldData(t,null,e)},_bindCustomFieldChange:function(t,e,i){var s=this.form.all[e];if(s){var o=function(){this._computeItemFieldData(t,null,e),this[i]&&("layout_redHeader"==i||"layout_issuanceUnit"==i||"layout_subject"==i?this[i].set("html",this.data[t]||""):"layout_attachment"==i?this.setAttachmentData():this[i].set("text",this.data[t]||"")),this.reSetShow()}.bind(this);s.node.store(this.json.id+"bindFun",o),s.addModuleEvent("change",o)}},_computeData:function(t){this._computeItemData("copies","copiesValueType","copiesValueData","copiesValueScript",t,"layout_copies"),this._computeItemData("secret","secretValueType","secretValueData","secretValueScript",t,"layout_secret"),this._computeItemData("priority","priorityValueType","priorityValueData","priorityValueScript",t,"layout_priority"),this._computeItemData("redHeader","redHeaderValueType","redHeaderValueData","redHeaderValueScript",t,"layout_redHeader"),this._computeItemData("fileno","filenoValueType","filenoValueData","filenoValueScript",t,"layout_fileno"),this._computeItemData("signer","signerValueType","signerValueData","signerValueScript",t,"layout_signer"),this._computeItemData("subject","subjectValueType","subjectValueData","subjectValueScript",t,"layout_subject"),this._computeItemData("mainSend","mainSendValueType","mainSendValueData","mainSendValueScript",t,"layout_mainSend"),this._computeItemData("attachment","attachmentValueType","attachmentValueData","attachmentValueScript",t,"layout_attachment"),this._computeItemData("issuanceUnit","issuanceUnitValueType","issuanceUnitValueData","issuanceUnitValueScript",t,"layout_issuanceUnit"),this._computeItemData("issuanceDate","issuanceDateValueType","issuanceDateValueData","issuanceDateValueScript",t,"layout_issuanceDate"),this._computeItemData("annotation","annotationValueType","annotationValueData","annotationValueScript",t,"layout_annotation"),this._computeItemData("copyto","copytoValueType","copytoValueData","copytoValueScript",t,"layout_copytoContent"),this._computeItemData("copyto2","copyto2ValueType","copyto2ValueData","copyto2ValueScript",t,"layout_copyto2Content"),this._computeItemData("editionUnit","editionUnitValueType","editionUnitValueData","editionUnitValueScript",t,"layout_edition_issuance_unit"),this._computeItemData("editionDate","editionDateValueType","editionDateValueData","editionDateValueScript",t,"layout_edition_issuance_date"),this._computeItemData("meetingAttend","meetingAttendValueType","meetingAttendValueData","meetingAttendValueScript",t,"layout_meetingAttendContent"),this._computeItemData("meetingLeave","meetingLeaveValueType","meetingLeaveValueData","meetingLeaveValueScript",t,"layout_meetingLeaveContent"),this._computeItemData("meetingSit","meetingSitValueType","meetingSitValueData","meetingSitValueScript",t,"layout_meetingSitContent"),this._computeItemData("meetingRecord","meetingRecordValueType","meetingRecordValueData","meetingRecordValueScript",t,"layout_meetingRecordContent"),Object.each(this.json.customFields,function(e,i){this._computeCustomItemData(i,e,t)}.bind(this))},_loadValue:function(){this._getBusinessData()},reload:function(){this.resetData()},resetData:function(t){this.editMode&&this._switchReadOrEditInline(),this._computeData(!1),this.pages=[],this.contentNode.empty(),this.allowEdit&&this.toolbar.childrenButton[0].setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),this.editMode=!1,this._createPage(function(e){this._loadPageLayout(e),this.setData(this.data,t),this._repage()}.bind(this))},isEmpty:function(){var t=this.getData();return"object"!==typeOf(t)||(!t.filetext||t.filetext===this.json.defaultValue.filetext)},getData:function(){if(this.layout_copies&&(this.data.copies=this.layout_copies.get("text")),this.layout_secret&&(this.data.secret=this.layout_secret.get("text")),this.layout_priority&&(this.data.priority=this.layout_priority.get("text")),this.layout_redHeader&&(this.data.redHeader=this.layout_redHeader.get("html")),this.layout_fileno&&(this.data.fileno=this.layout_fileno.get("text")),this.layout_signerTitle&&(this.data.signerTitle=this.layout_signerTitle.get("text")),this.layout_signer&&(this.data.signer=this.layout_signer.get("text")),this.layout_subject&&(this.data.subject=this.layout_subject.get("html")),this.layout_mainSend&&(this.data.mainSend=this.layout_mainSend.get("text")),this.editMode&&this.layout_filetext){var t=this.layout_filetext.get("text");(t=t.replace(/\u3000*/g,""))&&t!==this.json.defaultValue.filetext?this.data.filetext=this.layout_filetext.get("html"):this.data.filetext=""}return this.layout_signer&&(this.data.signer=this.layout_signer.get("text")),this.layout_attachmentTitle&&(this.data.attachmentTitle=this.layout_attachmentTitle.get("text")),this.layout_attachment&&this._computeItemData("attachment","attachmentValueType","attachmentValueData","attachmentValueScript",!1,"layout_attachment"),this.layout_issuanceUnit&&(this.data.issuanceUnit=this.layout_issuanceUnit.get("html")),this.layout_issuanceDate&&(this.data.issuanceDate=this.layout_issuanceDate.get("text")),this.layout_annotation&&(this.data.annotation=this.layout_annotation.get("text")),this.layout_copytoTitle&&(this.data.copytoTitle=this.layout_copytoTitle.get("text")),this.layout_copytoContent&&(this.data.copyto=this.layout_copytoContent.get("text")),this.layout_copyto2Title&&(this.data.copyto2Title=this.layout_copyto2Title.get("text")),this.layout_copyto2Content&&(this.data.copyto2=this.layout_copyto2Content.get("text")),this.layout_edition_issuance_unit&&(this.data.editionUnit=this.layout_edition_issuance_unit.get("text")),this.layout_edition_issuance_date&&(this.data.editionDate=this.layout_edition_issuance_date.get("text")),this.layout_meetingAttendTitle&&(this.data.meetingAttendTitle=this.layout_meetingAttendTitle.get("text")),this.layout_meetingLeaveTitle&&(this.data.meetingLeaveTitle=this.layout_meetingLeaveTitle.get("text")),this.layout_meetingSitTitle&&(this.data.meetingSitTitle=this.layout_meetingSitTitle.get("text")),this.layout_meetingAttendContent&&(this.data.meetingAttend=this.layout_meetingAttendContent.get("html")),this.layout_meetingLeaveContent&&(this.data.meetingLeave=this.layout_meetingLeaveContent.get("html")),this.layout_meetingSitContent&&(this.data.meetingSit=this.layout_meetingSitContent.get("html")),this.layout_meetingRecordContent&&(this.data.meetingRecord=this.layout_meetingRecordContent.get("html")),this.customLayouts&&this.customLayouts.each(function(t){this.data[t.name]=t.node.get("html")}.bind(this)),this.data},setAttachmentData:function(){if(this.attachmentTemplete||(this.attachmentTemplete=this.layout_attachment.get("html")),this.layout_attachment.empty(),this.data.attachment&&this.data.attachment.length&&this.data.attachment.each){var t=new Element("div");this.data.attachment.each(function(e,i){t.set("html",this.attachmentTemplete);var s=t.getElement(".doc_layout_attachment_content_serial"),o=t.getElement(".doc_layout_attachment_content_name");s&&s.set("text",i+1),o&&o.set("text",e);var n=t.get("html");t.empty(),this.layout_attachment.appendHTML(n)}.bind(this)),t.destroy()}},setData:function(t,e){if(t){if(this.data=t,this._setBusinessData(t),this.layout_copies&&(t.copies?this.layout_copies.set("text",t.copies||" "):this.layout_copies.set("html","<span>&nbsp</span>")),this.layout_secret&&(t.secret?this.layout_secret.set("text",t.secret||" "):this.layout_secret.set("html","<span>&nbsp</span>")),this.layout_priority&&(t.priority?this.layout_priority.set("text",t.priority||" "):this.layout_priority.set("html","<span>&nbsp</span>")),this.layout_redHeader&&this.layout_redHeader.set("html",t.redHeader||""),this.layout_fileno&&this.layout_fileno.set("text",t.fileno||" "),this.layout_signerTitle&&this.layout_signerTitle.set("text",t.signerTitle||" "),this.layout_signer&&this.layout_signer.set("text",t.signer||" "),this.layout_subject&&this.layout_subject.set("html",t.subject||" "),this.layout_mainSend&&this.layout_mainSend.set("text",t.mainSend||" "),e)this.layout_filetext.set("html",e);else if(this.layout_filetext){this.layout_filetext.set("html",t.filetext||"　　");var i=this.layout_filetext.getElements("table");i&&i.length&&i.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"})}if(this.layout_signer&&this.layout_signer.set("text",t.signer||""),this.layout_attachmentTitle&&this.layout_attachmentTitle.set("text",t.attachmentTitle||" "),this.layout_attachment&&this.setAttachmentData(),this.layout_issuanceUnit&&this.layout_issuanceUnit.set("html",t.issuanceUnit||" "),this.layout_issuanceDate&&this.layout_issuanceDate.set("text",t.issuanceDate||" "),this.layout_annotation&&this.layout_annotation.set("text",t.annotation||" "),this.layout_copytoTitle&&this.layout_copytoTitle.set("text",t.copytoTitle||" "),this.layout_copytoContent&&this.layout_copytoContent.set("text",t.copyto||" "),this.layout_copyto2Title&&this.layout_copyto2Title.set("text",t.copyto2Title||" "),this.layout_copyto2Content&&this.layout_copyto2Content.set("text",t.copyto2||" "),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit.set("text",t.editionUnit||" "),this.layout_edition_issuance_date&&this.layout_edition_issuance_date.set("text",t.editionDate||" "),this.layout_meetingAttendTitle&&this.layout_meetingAttendTitle.set("text",t.meetingAttendTitle||this.json.defaultValue.meetingAttendTitle||" "),this.layout_meetingLeaveTitle&&this.layout_meetingLeaveTitle.set("text",t.meetingLeaveTitle||this.json.defaultValue.meetingLeaveTitle||" "),this.layout_meetingSitTitle&&this.layout_meetingSitTitle.set("text",t.meetingSitTitle||this.json.defaultValue.meetingSitTitle||" "),this.layout_meetingAttendContent&&this.layout_meetingAttendContent.set("html",t.meetingAttend||" "),this.layout_meetingLeaveContent&&this.layout_meetingLeaveContent.set("html",t.meetingLeave||" "),this.layout_meetingSitContent&&this.layout_meetingSitContent.set("html",t.meetingSit||" "),this.layout_meetingRecordContent&&this.layout_meetingRecordContent.set("html",t.meetingRecord||" "),this.customLayouts&&this.customLayouts.each(function(t){t.node.set("html",this.data[t.name]||"　")}.bind(this)),this.layout_issuanceUnit&&this.layout_issuanceDate){var s=this.layout_issuanceUnit.getParent("table");if(s&&!s.hasClass("doc_layout_headIssuance")){var o=o2.getTextSize(this.layout_issuanceUnit.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x,n=o2.getTextSize(this.layout_issuanceDate.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x;if(o<n){if(a=this.layout_issuanceDate.getParent("td").getNext("td")){a.setStyle("width","64pt"),(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","64pt")}this.layout_issuanceUnit.getParent("td").setStyle("width",n),(r=this.layout_issuanceUnit.getParent("p"))&&r.setStyle("text-align","center")}else{var a,r;(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","32pt"),this.layout_issuanceUnit.getParent("td").setStyle("width","auto"),(a=this.layout_issuanceDate.getParent("td").getNext("td"))&&a.setStyle("width","64pt"),(r=this.layout_issuanceDate.getParent("p"))&&r.setStyle("text-align","right")}}}var l=this.layout_copytoTitle||this.layout_copyto2Title;if(l){var h=l.getParent("table");if(h&&"y"==h.get("data-compute-style"))for(var d=h.rows,c=0;c<d.length;c++){var u=d[c].cells[0],p=u.getElement(".doc_layout_edition_issuance_unit");if(p||(p=u.getElement(".doc_layout_edition_issuance_date")),!p){var f=u.get("text").trim(),m=14*f.length,g=19*f.length;u.setStyles({"max-width":m+"pt !important","min-width":m+"pt !important",width:g+"pt"})}}}}},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)},removeDisplayNone:function(t){for(var e=t.getFirst();e;)if("none"==e.getStyle("display")){var i=e.getNext();e.destroy(),e=i}else e=(e=this.removeDisplayNone(e)).getNext();return t},getDocumentHtml:function(){(a=this.contentNode.getFirst().getFirst().getElement(".doc_layout_filetext").getElements("table")).each((function(t){var e=t.offsetWidth;t.set("data-o2-width",e),t.getElements("td").each((function(t){var e=t.offsetWidth;t.set("data-o2-width",e)}))}));var t=this.contentNode.getFirst().getFirst().clone(!0),e=t.getLast();e=this.removeDisplayNone(e);var i=t.querySelectorAll("[data-w-style]");if(i.length)for(var o=0;o<i.length;o++){var n=i.item(o);wStyle=n.dataset.wStyle,wStyle.split(/\s*\;\s*/g).each((function(t){if(t)try{s=t.split(/\s*\:\s*/g),n.setStyle(s[0],s[1])}catch(t){}}))}t.getElement(".doc_layout_filetext").getElements("td").setStyle("width","");var a=t.querySelectorAll("table[data-o2-width]");for(o=0;o<a.length;o++)a[o].setStyle("width",a[o].dataset.o2Width+"px");var r=t.querySelectorAll("td[data-o2-width]");for(o=0;o<r.length;o++)r[o].setStyle("width",r[o].dataset.o2Width+"px");var l=t.get("html");return t.destroy(),'<html xmlns:v="urn:schemas-microsoft-com:vml"><head><meta charset="UTF-8" /></head><body>'+l+"</body></html>"},toWord:function(t,e,i,s){var o=e||"";if(!o)try{o=this.json.toWordFilename||this.form.businessData.data.subject||this.form.businessData.data.$work.title}catch(t){}var n=!1;this.editMode&&(n=!0,this._readFiletext()),this.zoom(1),this.pages=[],this.contentNode.empty(),this._createPage(function(t){this._loadPageLayout(t),this.setData(this.data),this._checkScale(),this.node.setStyles({height:"auto"})}.bind(this),function(){var e=o||this.json.toWordFilename||"$doc",a=e.lastIndexOf(".");if("service"===this.json.wordConversionType){-1==a&&(e+=".doc");var r=encodeURIComponent(this.getDocumentHtml()),l={fileName:e,site:this.json.toWordSite||"$doc",content:r};o2.Actions.get("x_processplatform_assemble_surface").docToWord(this.form.businessData.work.id,l,function(e){this.form.businessData.workCompleted?o2.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompleted(e.data.id,this.form.businessData.workCompleted.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)):o2.Actions.get("x_processplatform_assemble_surface").getAttachment(e.data.id,this.form.businessData.work.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this))}.bind(this)),i&&i()}else{-1==a&&(e+=".docx");r=this.getDocumentHtml();o2.xDesktop.requireApp("process.Xform","widget.OOXML",function(){(new o2.OOXML.WML).load(r).then(function(o){if(s)t&&t(o,e),i&&i();else{o.name=e;var n=new FormData;n.append("site",this.json.toWordSite||"$doc"),n.append("fileName",e),n.append("file",o),o2.Actions.get("x_processplatform_assemble_surface").V2UploadWorkOrWorkCompleted(this.form.businessData.work.id,n,o,function(e){this.form.businessData.workCompleted?o2.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompleted(e.data.id,this.form.businessData.workCompleted.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)):o2.Actions.get("x_processplatform_assemble_surface").getAttachment(e.data.id,this.form.businessData.work.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)),i&&i()}.bind(this))}}.bind(this))}.bind(this))}n?this._createEditor("inline"):this._readFiletext()}.bind(this))},docToWord:function(t){try{var e=!0;this.json.toWordConditionScript&&this.json.toWordConditionScript.code&&(e=!!this.form.Macro.exec(this.json.toWordConditionScript.code,this)),e?this.toWord(null,"",t):t&&t()}catch(e){console.error(e),t&&t()}},showToWord:function(t){var e=this.json.toWordSite||"$doc",i=this.form.all[e];if(i){var s=[];i.attachmentController.attachments.each(function(e){e.data.name!==t.name&&s.push(e.data)}.bind(this)),i.attachmentController.clear(),s.each(function(e){e.site===i.json.id&&e.name!==t.name&&i.attachmentController.addAttachment(e)}.bind(this)),i.attachmentController.addAttachment(t)}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Html=MWF.APPHtml=new Class({Extends:MWF.APP$Module,load:function(){this.node.insertAdjacentHTML("beforebegin",this.json.text),this.node.destroy()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Htmleditor=MWF.APPHtmleditor=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","postLoad","afterLoad"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},load:function(){this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){if(this.node.empty(),this.readonly)this.node.set("html",this._getBusinessData()),this.node.setStyles({"-webkit-user-select":"text","-moz-user-select":"text"}),layout.mobile&&this.node.getElements("img").each(function(t){t.setStyles({height:"auto","max-width":"100%"})}.bind(this));else{var t=Object.clone(this.json.editorProperties);if(this.json.config&&this.json.config.code){var e=this.form.Macro.exec(this.json.config.code,this);Object.each(e,(function(e,i){t[i]=e}))}this.loadCkeditor(t)}},loadCkeditor:function(t){COMMON.AjaxModule.loadDom("ckeditor",function(){CKEDITOR.disableAutoInline=!0;var e=new Element("div").inject(this.node),i=this._getBusinessData();i?e.set("html",i):this.json.templateCode&&e.set("html",this.json.templateCode);this.node.getSize().y;var s=t||{};if("Mobile"===this.form.json.mode&&(s.toolbar||s.toolbarGroups||(s.toolbar=[{name:"paragraph",items:["Bold","Italic","-","TextColor","BGColor","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","Undo","Redo"]},{name:"basicstyles",items:["Styles","FontSize"]},{name:"insert",items:["Image"]}])),s.base64Encode="y"===this.json.base64Encode,s.localImageMaxWidth=800,s.reference=this.form.businessData.work.job,s.referenceType="processPlatformJob",s&&s.extraPlugins){var o=s.extraPlugins;(o="array"===typeOf(o)?o:o.split(",")).push("pagebreak"),s.extraPlugins=o}else s.extraPlugins=["pagebreak"];this.editor=CKEDITOR.replace(e,s),this.editor.addCommand("ecnet",{exec:function(t){this.ecnet()}.bind(this)}),this.editor.ui.add("ecnet",CKEDITOR.UI_BUTTON,{label:MWF.xApplication.process.Xform.LP.intelligentCorrection,icon:"../x_component_process_Xform/$Form/default/icon/ecnet.png",command:"ecnet"}),this._loadEvents(),this.editor.on("change",function(){}.bind(this)),this.json.ecnet}.bind(this))},getEcnetString:function(t,e){for(var i=0;i<t.childNodes.length;i++)if(t.childNodes[i].nodeType===Node.TEXT_NODE){var s=this.ecnetString.length;this.ecnetString+=t.childNodes[i].nodeValue;var o=this.ecnetString.length;e.push({pnode:t,node:t.childNodes[i],start:s,end:o})}else this.getEcnetString(t.childNodes[i],e)},createEcnetNode:function(t){var e=t.node.ownerDocument.createElement("span"),i=0,s=t.node.nodeValue;t.ecnets.each(function(e){var o=e.begin+i-t.start,n=e.end+i-t.start;o<0&&(o=0),n>t.end+i&&(n=t.end+i);var a=s.length,r=s.substring(0,o),l=s.substring(o,n),h=s.substring(n,s.length);i+=(s=r+"<span class='o2_ecnet_item' style='color: red'><u>"+l+"</u></span>"+h).length-a}.bind(this)),e.innerHTML=s,t.pnode.replaceChild(e,t.node),t.pnode.textNode=t.node,t.pnode.ecnetNode=e;var o=this,n=this.editor.document.$.defaultView.frameElement,a=e.getElementsByTagName("span");if(a.length)for(var r=0;r<a.length;r++){var l=a[r];if("o2_ecnet_item"===l.className){var h=new Element("div",{styles:{border:"1px solid #999999","box-shadow":"0px 0px 5px #999999","background-color":"#ffffff",position:"fixed",display:"none"}}).inject(n,"after");new Element("div",{styles:{padding:"3px 10px","font-weight":"bold","font-size":"12px",cursor:"pointer"},text:t.ecnets[r].origin+"->"+t.ecnets[r].correct,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var t=this.getParent(),e=t.node,i=t.node.ecnets[t.idx],s=e.node.ownerDocument.createTextNode(i.correct);t.span.parentNode.replaceChild(s,t.span),t.destroy(),e.node.nodeValue=e.pnode.ecnetNode.innerText,e.ecnets.erase(i),e.ecnets.length||o.ecnetNodes.erase(e)}}}).inject(h),new Element("div",{styles:{padding:"3px 10px","font-size":"12px",cursor:"pointer"},text:MWF.xApplication.process.Xform.LP.ignore,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var t=this.getParent(),e=t.node,i=t.node.ecnets[t.idx],s=e.node.ownerDocument.createTextNode(t.span.innerText);t.span.parentNode.replaceChild(s,t.span),t.destroy(),e.node.nodeValue=e.pnode.ecnetNode.innerText,e.ecnets.erase(i),e.ecnets.length||o.ecnetNodes.erase(e)}}}).inject(h);h.node=t,h.idx=r,l.ecnetNode=h,h.span=l,l.addEventListener("click",(function(){var t=this.ecnetNode;t.show();var e=this.offsetTop,i=this.offsetLeft,s=this.offsetWidth,o=this.offsetHeight,a=n.getPosition(),r=t.getSize(),l=e+a.y+o+5,h=i+a.x-(r.x-s)/2;t.style.left=h+"px",t.style.top=l+"px";var d=this,c=function(){t.hide(),d.ownerDocument.removeEventListener("mousedown",c)};this.ownerDocument.addEventListener("mousedown",c)}))}}},clearEcnetNodes:function(){this.ecnetNodes&&this.ecnetNodes.length&&(this.ecnetNodes.each(function(t){t.pnode.ecnetNode&&(t.pnode.ecnetInforNode&&t.pnode.ecnetInforNode.destroy(),t.pnode.ecnetInforNode=null,t.pnode.replaceChild(t.pnode.textNode,t.pnode.ecnetNode))}.bind(this)),this.ecnetNodes=[])},ecnet:function(t){this.editor.document.$.defaultView.frameElement;var e=this.editor.document.$.body;this.ecnetNodes||(this.ecnetNodes=[]),this.ecnetNodes.length&&this.clearEcnetNodes();var i=[];this.ecnetString="",this.getEcnetString(e,i),MWF.Actions.get("x_general_assemble_control").ecnetCheck({value:this.ecnetString},function(t){t.data.itemList&&t.data.itemList.length?(i.each(function(e){var i=[];t.data.itemList.each(function(t){(e.end<=t.end&&e.end>t.begin||e.start>=t.begin&&e.start<t.end||e.start<=t.begin&&e.end>t.end)&&i.push(t)}.bind(this)),i.length&&(e.ecnets=i,this.ecnetNodes.push(e))}.bind(this)),this.ecnetNodes.each(function(t){this.createEcnetNode(t)}.bind(this))):(e=null,i=null)}.bind(this))},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&this.editor.on(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this),this)}.bind(this))},addModuleEvent:function(t,e){this.editor.on(t,function(t){return e?e(this,t):null}.bind(this),this)},_loadValue:function(){this._getBusinessData()},resetData:function(){this.setData(this._getBusinessData())},isEmpty:function(){return!this.getData().trim()},getData:function(){return this.clearEcnetNodes(),this.editor?this.editor.getData():""},setData:function(t){this._setBusinessData(t),this.editor&&this.editor.setData(t)},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.IWebOffice=MWF.APPIWebOffice=new Class({Extends:MWF.APP$Module,options:{copyright:"金格科技iWebOffice2015智能文档中间件[演示版];V5.0S0xGAAEAAAAAAAAAEAAAAJ0BAACgAQAALAAAAFgHOIQT3Ejo2JZMmSVxBkTixI2YkNh+cy/HGFlQ3HNIRG8j2V9vAnBWM8B384zkV79hltghTpDkba9QJTjGCDkylzhl3rian7v/AFF5DXQ7HdoXpN2imHbGHf8ieQNf672v38ODXJum7VaWv4P3DXzlzdnmzoaTTukFl+3ntFH29dQSjC94c4v0npn9rnXK5OsjJGR5mVGJJd6GWjE9rP3fo+kWCBYzb+bhn2sL+SKoyFjUuSptNHsOn3nRKrXyqkRd+QaHR/MDuKd1kEbUpRqCz9CjgfZFX00Zaz2l6ChA6LmdMMjjECalHZQA9WuxAc7cynGbvNfEgi277ahRpSZHmjKY5s18dJM/t9gdatg5b/dCqnUEn0+HS511XaM3xvy4DCVnD1n8xC9I5w+16NGrtTMiMSZFpc3QJphdShC0j+1l/ZyVj33YM31JmuxkI5SDL2CAfMUNsioseUfpOKvpxdcA7nmwlKrpxNetm9Bq0kwJn/jUU2bQa2c+bPRX82JcmFUwAz0ctOQ+Tyi+MoRpATEYW35KZtWepeDTGHJRfaJR81x8dVU0Lp1TuxtQiw==",version:"12,7,0,828",clsid:"D89F482C-5045-4DB5-8C53-D2C9EE71D025",codeBase:"../o2_lib/iWebOffice/iWebOffice2015.cab",version64:"12,5,0,652",clsid64:"D89F482C-5045-4DB5-8C53-D2C9EE71D024",codeBase64:"../o2_lib/iWebOffice/iWebOffice2015.cab",moduleEvents:[,"afterOpen","afterCreate","beforeSave","afterSave"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0,this.openedAttachment=null},_loadUserInterface:function(){this.node.empty(),this.node.setStyles({"min-height":"100px"}),"ie"===Browser.name&&(this.file=null,this.form.officeList||(this.form.officeList=[]),this.form.officeList.push(this))},_afterLoaded:function(){if("ie"===Browser.name){if(!layout.serviceAddressList.x_jg_assemble_control)return this.node.set("html","<h3><font color=red>please install weboffice !!!</font></h3>"),!1;var t=layout.serviceAddressList.x_jg_assemble_control.host,e=layout.serviceAddressList.x_jg_assemble_control.port;this.webUrl=layout.protocol+"//"+t+":"+e+"/x_jg_assemble_control/IndexServlet",this.action=o2.Actions.load("x_jg_assemble_control"),this.json.isNotLoadNow||(this.data=this.getData(),""===this.data.documentId?this.createDocument(function(){this.loadOffice()}.bind(this)):(this.documentId=this.data.documentId,this.loadOffice())),this.json.isNotLoadNow||this.loadOffice()}else this.node.set("html","<h3><font color=red>只支持ie浏览器!</font></h3>")},createDocument:function(t){this.action.ManageJGAction.create({fileType:this.getFileType()},function(e){this.fireEvent("afterCreate"),this.documentId=e.data.message,this.setData(),t&&t()}.bind(this),null,!1)},createNew:function(){this.officeOCX.CreateFile()},getData:function(){var t={documentId:""};return this.form.businessData.data[this.json.id]&&(t.documentId=this.form.businessData.data[this.json.id].documentId),t},setData:function(){var t={documentId:this.documentId};this._setBusinessData(t)},loadOffice:function(){this.officeLoaded||(MWF.getJSON("../o2_lib/iWebOffice/config.json",function(t){this.officeConfig=t}.bind(this),!1),this.loadOfficeContorl(),this.officeLoaded=!0)},defaultParam:function(t){return{copyright:this.json.copyright||this.options.copyright}},loadOfficeContorl:function(t){if(this.node.getSize().y<800&&this.node.setStyle("height","800px"),layout.desktop.offices||(layout.desktop.offices={}),layout.desktop.offices[this.getOfficeObjectId()]=this,this.json.isReadonly)this.readonly=!0;else if(this.json.readScript&&this.json.readScript.code){this.form.Macro.exec(this.json.readScript.code,this)&&(this.readonly=!0)}this.loadOfficeEditor()},loadOfficeSpacer:function(){var t=this.node.getSize();this.officeNode=new Element("div#officeNode",{styles:this.form.css.officeAreaNode}).inject(this.node);var e=t.y-40;this.officeNode.setStyle("height",e+"px"),this.form.app.addEvent("uncurrent",function(){var t=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",t),this.officeNode.setStyle("display","none")}.bind(this)),this.form.app.addEvent("current",function(){var t=this.officeNode.retrieve("officeDisplay");t&&this.officeNode.setStyle("display",t),this.officeOCX&&this.officeOCX.Activate(!0)}.bind(this)),this.form.app.addEvent("queryClose",function(){this.fireEvent("queryClose");var t=this.getOfficeObjectId();layout.desktop.offices[t]=null,delete layout.desktop.offices[t]}.bind(this))},hide:function(){if("none"!=this.officeNode.getStyle("display")){var t=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",t),this.officeNode.setStyle("display","none")}},show:function(){if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===this.form.app.appId||this.form.app.inBrowser){var t=this.officeNode.retrieve("officeDisplay");t&&this.officeNode.setStyle("display",t),this.officeOCX&&this.officeOCX.Activate(!0)}},getFormId:function(){var t=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"form"+this.json.id+t},getFileType:function(){var t="docx";switch(this.json.officeType){case"word":t="docx";break;case"excel":t="xlsx";break;case"ppt":t="pptx"}return t},getOfficeObjectId:function(){var t=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"WebOffice"+this.json.id+t},loadOfficeEditor:function(){if(!this.officeOCX){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var t=this.officeConfig.codeBase||this.json.codeBase||this.options.codeBase,e=this.officeConfig.version||this.json.version||this.options.version,i=this.officeConfig.classid||this.json.clsid||this.options.clsid,s=this.officeConfig.codeBase64||this.json.codeBase64||this.options.codeBase64,o=this.officeConfig.classid64||this.json.clsid64||this.options.clsid64,n="";n="Win64"==window.navigator.platform?"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+s+"#version="+e+'" classid="clsid:'+o+'">':"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+t+"#version="+e+'" classid="clsid:'+i+'">';var a=this.defaultParam();a=Object.merge(a,this.json.ntkoEditProperties),a=Object.merge(a,this.json.editProperties),Object.each(a,(function(t,e){n+='<PARAM NAME="'+e+'" value="'+t+'">'})),n+="</OBJECT></form>",this.officeNode.appendHTML(n),this.officeForm=this.officeNode.getFirst()}setTimeout(function(){this.loadIwebOfficeEditor()}.bind(this),3e3)},loadIwebOfficeEditor:function(){this.officeOCX=document.getElementById(this.getOfficeObjectId()).FuncExtModule,this.officeOCX.WebUrl=this.webUrl,this.officeOCX.FileName="文件正文.docx",this.officeOCX.UserName=layout.desktop.session.user.name,this.officeOCX.RecordID=this.documentId,this.officeOCX.FileType="."+this.getFileType(),this.readonly&&(this.officeOCX.EditType="0,0"),this.officeOCX.ShowMenu=this.json.iWebOfficeEditProperties.Menubar,this.officeOCX.ShowToolBar=this.json.iWebOfficeEditProperties.ToolBars,this.officeOCX.ShowWindow=!1,this.officeOCX.MaxFileSize=32768,this.officeOCX.Print="1",this.officeOCX.WebOpen(),this.fireEvent("afterOpen"),this.loadMenu(),this.readonly?"1"===this.json.iWebOfficeReadProperties.IsNoCopy?this.unableCopy():this.enableCopy():("1"===this.json.iWebOfficeEditProperties.IsNoCopy?this.unableCopy():this.enableCopy(),"1"===this.json.trackRevisions?this.showRevision():this.hideRevision())},setBookMark:function(t,e){this.officeOCX.WebSetBookMarks(t,e)},getBookMark:function(t){return this.officeOCX.WebGetBookMarks(t)},openLocal:function(){try{this.officeOCX.WebOpenLocal()}catch(t){this.officeOCX.Alert(t.description)}},saveLocal:function(){try{this.officeOCX.WebSaveLocal(),this.officeOCX.Alert("success")}catch(t){this.officeOCX.Alert(t.description)}},savePdf:function(){try{this.officeOCX.WebSavePDF()?this.officeOCX.Alert("success"):this.officeOCX.Alert("error")}catch(t){alert(t.description)}},print:function(){try{this.officeOCX.WebOpenPrint()}catch(t){alert(t.description)}},protect:function(){try{this.officeOCX.WebSetProtect(!0,"")}catch(t){this.officeOCX.Alert(t.description)}},unProtect:function(){try{this.officeOCX.WebSetProtect(!1,"")}catch(t){this.officeOCX.Alert(t.description)}},enableCopy:function(){try{this.officeOCX.CopyType=!0}catch(t){this.officeOCX.Alert(t.description)}},unableCopy:function(){try{this.officeOCX.CopyType=!1}catch(t){this.officeOCX.Alert(t.description)}},showRevision:function(){this.officeOCX.WebShow(!0)},hideRevision:function(){this.officeOCX.WebShow(!1)},acceptAllRevisions:function(){return this.officeOCX.WebObject.Application.ActiveDocument.AcceptAllRevisions(),!(this.officeOCX.WebObject.Application.ActiveDocument.Revisions.Count>0)},isEmpty:function(){},save:function(){if(!this.readonly){this.fireEvent("beforeSave");this.officeOCX.WebSave();this.fireEvent("afterSave")}},loadMenu:function(){this.isMenuLoad||(this.json.menuEditButtons&&this.json.menuEditButtons.length&&(this.menuNode=new Element("div",{styles:this.form.css.officeMenuNode}).inject(this.node,"top"),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.menuNode,{style:"xform_blue_simple"},this),-1!==this.json.menuEditButtons.indexOf("new")&&(this.newItem=this.createMenuAction("menu_new","","99.png")),-1!==this.json.menuEditButtons.indexOf("open")&&(this.openItem=this.createMenuAction("menu_openfile","","77.png")),-1!==this.json.menuEditButtons.indexOf("save")&&(this.saveItem=this.createMenuAction("menu_savefile","","67.png")),-1!==this.json.menuEditButtons.indexOf("revisions")){var t=MWF.xApplication.process.Xform.LP.menu_revisions_show;try{0!==this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup&&(t=MWF.xApplication.process.Xform.LP.menu_revisions_hide)}catch(t){}this.revisionsItem=this.createMenuAction("revisions",t,"76.png")}if(-1!==this.json.menuEditButtons.indexOf("toolbar")&&!this.readonly){t=MWF.xApplication.process.Xform.LP.menu_toolbar_show;this.officeOCX.ToolBars&&(t=MWF.xApplication.process.Xform.LP.menu_toolbar_hide),this.toolbarItem=this.createMenuAction("toolbar",t,"91.png")}-1!==this.json.menuEditButtons.indexOf("preview")&&(this.fullscreenItem=this.createMenuAction("menu_preview","","21.png")),this.toolbarWidget.load()}.bind(this))),this.isMenuLoad=!0)},createMenuAction:function(t,e,i){e=e||MWF.xApplication.process.Xform.LP[t];return new Element("div",{MWFnodeid:t,MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+i,title:e,MWFButtonAction:"menuAction",MWFButtonText:e}).inject(this.menuNode)},menuAction:function(t){switch(t.buttonID){case"menu_new":this.createNew();break;case"menu_openfile":this.openLocal();break;case"menu_savefile":this.saveLocal();break;case"revisions":this.toggleRevisions(t);break;case"toolbar":break;case"menu_preview":this.print()}},toggleRevisions:function(t){this.revisionsItem.get("text")===MWF.xApplication.process.Xform.LP.menu_revisions_show?(t.setText(MWF.xApplication.process.Xform.LP.menu_revisions_hide),this.showRevision()):(t.setText(MWF.xApplication.process.Xform.LP.menu_revisions_show),this.hideRevision())},validationMode:function(){},validation:function(){return!0}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Iframe=MWF.APPIframe=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty();var t=this.json.src;"script"==this.json.valueType&&(t=this.form.Macro.exec(this.json.script?this.json.script.code:"",this)),this.iframe=new Element("iframe",{src:t}).inject(this.node,"after"),this.node.destroy(),this.node=this.iframe.setStyles({width:"100%",border:"0"})}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Image=MWF.APPImage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){if(this.json.properties&&this.json.properties.src){var t=this.json.properties.src;if(-1!=t.indexOf("x_processplatform_assemble_surface")||-1!=t.indexOf("x_portal_assemble_surface")||-1!=t.indexOf("x_cms_assemble_control")){var e=MWF.Actions.getHost("x_processplatform_assemble_surface"),i=MWF.Actions.getHost("x_portal_assemble_surface"),s=MWF.Actions.getHost("x_cms_assemble_control");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",i+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",i+"/x_portal_assemble_surface")),-1!==t.indexOf("/x_cms_assemble_control")?t=t.replace("/x_cms_assemble_control",s+"/x_cms_assemble_control"):-1!==t.indexOf("x_cms_assemble_control")&&(t=t.replace("x_cms_assemble_control",s+"/x_cms_assemble_control")),t=o2.filterUrl(t)}try{this.node.set("src",t)}catch(t){}}else if(this.json.srcfile&&"none"!=this.json.srcfile)if(t=this.json.srcfile,"object"===typeOf(t)){var o=t.portal?MWF.xDesktop.getPortalFileUr(t.id,t.portal):MWF.xDesktop.getProcessFileUr(t.id,t.application);o=o2.filterUrl(o),this.node.set("src",o)}else{var n=MWF.Actions.getHost("x_portal_assemble_surface"),a=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;t=n+"/x_portal_assemble_surface"+(a=(a=a.replace("{flag}",t)).replace("{applicationFlag}",this.form.json.application)),t=o2.filterUrl(t),this.node.set("src",t)}else if("object"==typeOf(this.json.src)){var r=MWF.xDesktop.getImageSrc(this.json.src.imageId);this.node.set("src",r)}},reset:function(){this._loadUserInterface()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.ImageClipper=MWF.APPImageClipper=new Class({Implements:[Events],Extends:MWF.APP$Module,initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.field=!0,this.node.empty();var t=this._getBusinessData();if(t){var e=new Element("img",{src:MWF.xDesktop.getImageSrc(t)});if(layout.mobile||COMMON.Browser.Platform.isMobile)e.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),s=this.json.imageHeight.toInt();i&&s&&e.setStyles({width:i+"px",height:s+"px"})}e.inject(this.node)}if(!this.readonly&&!this.json.isReadonly){var o=new Element("div").inject(this.node),n=new Element("button").inject(o);n.set({text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),n.addEvent("click",function(){this.validationMode();var t=this._getBusinessData();if(layout.mobile){o2.imageClipperCallback=function(t){var e=JSON.parse(t);this.setData(e?e.fileId:""),this.validation(),o2.imageClipperCallback=null}.bind(this);var e="processPlatformJob";this.form.businessData.work&&this.form.businessData.work.referencetype&&(e=this.form.businessData.work.referencetype);var i=JSON.stringify({mwfId:this.json.id,callback:"o2.imageClipperCallback",referencetype:e,reference:this.form.businessData.work.job});window.o2android&&window.o2android.uploadImage2FileStorage?window.o2android.uploadImage2FileStorage(i):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.uploadImage2FileStorage?window.webkit.messageHandlers.uploadImage2FileStorage.postMessage(i):this.selectImage(t,function(t){this.setData(t?t.id:""),this.validation()}.bind(this))}else this.selectImage(t,function(t){this.setData(t?t.id:""),this.validation()}.bind(this))}.bind(this))}},getTextData:function(){var t=this._getBusinessData()||"";return{value:[t],text:[t]}},isEmpty:function(){return!this.getData()},getData:function(t){return this._getBusinessData()||""},setData:function(t){if(this._setBusinessData(t),(e=this.node.getElements("img"))&&e.length&&e.destroy(),t){var e=new Element("img",{src:MWF.xDesktop.getImageSrc(t)}).inject(this.node,"top");if(layout.mobile||COMMON.Browser.Platform.isMobile)e.setStyles({"max-width":"90%"});else if("size"==this.json.clipperType){var i=this.json.imageWidth.toInt(),s=this.json.imageHeight.toInt();i&&s&&e.setStyles({width:i+"px",height:s+"px"})}}},selectImage:function(t,e){var i=this.json.clipperType||"unrestricted",s=1,o="",n=800;if("unrestricted"==i)s=0;else if("size"==i){var a=this.json.imageWidth?this.json.imageWidth.toInt():600,r=this.json.imageHeight?this.json.imageHeight.toInt():500;s=a/r,n=Math.max(a,r),isNaN(a)||isNaN(r)||(o=MWF.LP.widget.pictureSize.replace(/{width}/g,a).replace(/{height}/g,r))}else"ratio"==i&&(s=this.json.imageRatio||1,o=MWF.LP.widget.pictureRatio.replace(/{ratio}/g,s));MWF.xDesktop.requireApp("process.Xform","widget.ImageClipper",function(){this.imageClipper=new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app,{style:"default",aspectRatio:s,description:o,imageUrl:t?MWF.xDesktop.getImageSrc(t):"",reference:this.form.businessData.work.job,referenceType:"processPlatformJob",resultMaxSize:n,onChange:function(){e({src:this.imageClipper.imageSrc,id:this.imageClipper.imageId})}.bind(this)}),this.imageClipper.load()}.bind(this))},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[o].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","Button",null,!1),MWF.xApplication.process.Xform.Importer=MWF.APPImporter=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.Button,options:{moduleEvents:["queryLoad","postLoad","afterLoad","loadImporter","beforeImport","validImport","afterImport","beforeCreateRowData","afterCreateRowData"]},_loadUserInterface:function(){var t=this.node.getElement("button");t||(t=new Element("button")),t.inject(this.node,"after"),this.node.destroy(),this.node=t,this.node.set({id:this.json.id,text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),this.node.addEvent("click",function(){this.upload()}.bind(this)),this.json.allowDownloadTempalte&&this.json.downloadTempalteFieldId&&this.setDownloadEvent()},getImporter:function(t){var e;e=this.json.queryImportModel.id?{id:this.json.queryImportModel.id}:{application:this.json.queryImportModel.application||this.json.queryImportModel.appName,name:this.json.queryImportModel.alias||this.json.queryImportModel.name},MWF.xDesktop.requireApp("query.Query","Importer",function(){this.importer=new MWF.xApplication.query.Query.Importer(this.form.app.content,e,{onQueryLoad:function(){this.fireEvent("loadImporter")}.bind(this),onBeforeImport:function(t){this.fireEvent("beforeImport",t)}.bind(this),onValidImport:function(t){this.fireEvent("validImport",[t])}.bind(this),onAfterImport:function(t){this.fireEvent("afterImport",[t])}.bind(this),onBeforeCreateRowData:function(t){this.fireEvent("beforeCreateRowData",[t])}.bind(this),onAfterCreateRowData:function(t){this.fireEvent("afterCreateRowData",[t])}.bind(this)},this.form.app,this.form.Macro),t&&t()}.bind(this))},upload:function(){this.importer?this.importer.importFromExcel():this.getImporter(function(){this.importer.load()}.bind(this))},setDownloadEvent:function(){this.bindEvent=function(){var t=this._getModuleByPath(this.json.downloadTempalteFieldId);t&&t.node.addEvent("click",function(){this.downloadTemplate()}.bind(this)),this.fireEvent("afterLoad"),this.form.removeEvent("afterModulesLoad",this.bindEvent)}.bind(this),this.form.addEvent("afterModulesLoad",this.bindEvent)},downloadTemplate:function(){this.importer?this.importer.downloadTemplate(this.getExcelName()):this.getImporter(function(){this.importer.downloadTemplate(this.getExcelName())}.bind(this))},getExcelName:function(){var t;return this.json.excelName&&this.json.excelName.code&&(t=this.form.Macro.exec(this.json.excelName.code,this)),t||""}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Label=MWF.APPLabel=new Class({Implements:[Events],Extends:MWF.APP$Module,_loadUserInterface:function(){if("text"==this.json.valueType&&this.node.set("text",this.json.text||""),"script"==this.json.valueType){var t=this.json.script?this.json.script.code:"";if(t){var e=this.form.Macro.exec(t,this);this._setNodeText(e)}}if(this.json.prefixIcon||this.json.suffixIcon){var i=this.node.get("text");this.node.empty();var s=new Element("div",{styles:{"margin-left":this.json.prefixIcon?"20px":"0px","margin-right":this.json.suffixIcon?"20px":"0px",height:"100%"},text:i}).inject(this.node);if(this.json.prefixIcon)new Element("div",{styles:{float:"left",width:"20px",height:this.node.getSize().y+"px",background:"url("+this.json.prefixIcon+") center center no-repeat"}}).inject(s,"before");if(this.json.suffixIcon)new Element("div",{styles:{float:"right",width:"20px",height:this.node.getSize().y+"px",background:"url("+this.json.suffixIcon+") center center no-repeat"}}).inject(s,"before")}},_setNodeText:function(t){t&&t.isAG?t.addResolve(function(t){this._setNodeText(t)}.bind(this)):o2.promiseAll(t).then(function(t){this.node.set("text",t||"")}.bind(this),(function(){}))},setText:function(t){t?o2.promiseAll(t).then(function(t){this.node.set("text",t||"")}.bind(this),(function(){})):this.node.set("text",v||"")}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Log=MWF.APPLog=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","postLoadData","postLoadLine"]},_loadUserInterface:function(){this.node.empty(),this.node.setStyle("-webkit-user-select","text"),this.form.businessData&&("record"!==this.json.logType?this.form.businessData.workLogList&&(this.workLog=Array.clone(this.form.businessData.workLogList),this.fireEvent("postLoadData"),this.loadWorkLog()):this.form.businessData.recordList&&(this.workLog=Array.clone(this.form.businessData.recordList),this.fireEvent("postLoadData"),this.loadRecordLog()))},loadRecordLog:function(){if(this.json.category&&"none"!==this.json.category){if(this.loadCategoryList("_loadRecordCategoryList","_loadRecordCategoryList"),!this.categoryList.length)return;this.expandCount=0,this.json.expand&&"enable"===this.json.expand&&(this.expandCount=parseInt(this.json.expandCount)),this.table=new Element("table",this.json.tableProperties).inject(this.node),this.categoryList.each(function(t,e){var i=this.categoryJson[t];if(i&&i.length){var s=new Element("tr").inject(this.table);this.expandCount&&e+1>this.expandCount&&s.setStyle("display","none");var o=t;"unit"===this.json.category&&(o=t.split("@")[0]),new Element("td",{styles:this.json.titleTdStyles,text:o}).inject(s);var n=new Element("td",{styles:this.json.contentTdStyles}).inject(s),a=new Element("div",{styles:this.json.contentDivStyles||{}}).inject(n);"completedTimeAsc"!==this.json.sortTypeInCategory&&"completedTimeDesc"!==this.json.sortTypeInCategory||i.sort(function(t,e){return"completedTimeAsc"===this.json.sortTypeInCategory?Date.parse(t.recordTime)-Date.parse(e.recordTime):"completedTimeDesc"===this.json.sortTypeInCategory?Date.parse(e.recordTime)-Date.parse(t.recordTime):void 0}.bind(this)),"table"===this.json.mode?this.loadRecordLogTable(i,a):"text"===this.json.mode?this.loadRecordLogText(i,a):"media"===this.json.mode?this.loadRecordLogMedia(i,a):this.loadRecordLogDefault(i,a),this._loadTableStyles()}}.bind(this)),this.categoryList.length>this.expandCount&&this.loadExpandCollapseNode()}else"table"===this.json.mode?this.loadRecordLogTable():"text"===this.json.mode?this.loadRecordLogText():"media"===this.json.mode?this.loadRecordLogMedia():this.loadRecordLogDefault()},_loadRecordCategoryList:function(t){this.categoryList=[],this.categoryJson={},"fromOpinionGroup"===t&&this.workLog.sort(function(t,e){if(t.properties.fromOpinionGroup&&e.properties.fromOpinionGroup){for(var i=t.properties.fromOpinionGroup.split("#"),s=e.properties.fromOpinionGroup.split("#"),o=0;o<i.length;o++){var n=i[o],a=s[o];return this.isNumber(n)&&this.isNumber(a)?parseFloat(n)!==parseFloat(a)?parseFloat(n)-parseFloat(a):"none"===this.json.sortTypeInCategory?0:Date.parse(t.recordTime)-Date.parse(e.recordTime):this.isNumber(n)||this.isNumber(a)?this.isNumber(n)?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(t.recordTime)-Date.parse(e.recordTime)}return Date.parse(t.recordTime)-Date.parse(e.recordTime)}return t.properties.fromOpinionGroup||e.properties.fromOpinionGroup?t.properties.fromOpinionGroup?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(t.recordTime)-Date.parse(e.recordTime)}.bind(this)),this.workLog.each(function(e,i){var s;if("activityGroup"===this.json.category)if(e.properties.fromOpinionGroup){var o=e.properties.fromOpinionGroup.split("#");s=o[o.length-1]}else s=e.fromActivityName;else s=e[t];s&&this.checkRecordShow(e)&&(-1===this.categoryList.indexOf(s)&&this.categoryList.push(s),this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(e))}.bind(this))},loadRecordLogTable:function(t,e){var i=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(e||this.node),s=i.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine),o=s.insertCell(0).setStyles(this.form.css.logTableTaskTitle);o.set("text",MWF.xApplication.process.Xform.LP.person),(o=s.insertCell(1).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.activity),(o=s.insertCell(2).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.department),(o=s.insertCell(3).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.startTime),(o=s.insertCell(4).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.completedTime),(o=s.insertCell(5).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.route),(o=s.insertCell(6).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.opinion),(o=s.insertCell(7).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.arrivedActivitys),(o=s.insertCell(8).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.arrivedUsers),t?t.each(function(t,e){this.loadRecordLogLine_table(t,e,i)}.bind(this)):this.workLog.each(function(t,e){this.checkRecordShow(t)&&this.loadRecordLogLine_table(t,e,i)}.bind(this))},checkRecordShow:function(t){var e=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=t,this.form.Macro.environment.list=null,e=this.form.Macro.exec(this.json.filterScript.code,this);else{var i=function(t){return t&&"array"===o2.typeOf(t)&&t.length&&"yes"===t[0]};if(this.json.filterActivity&&this.json.filterActivity.length&&(filterActivitys=this.json.filterActivity,e=i(this.json.filterActivityExactMatch)?filterActivitys.split(/[;|,|\n]/gm).contains(t.fromActivityName):-1!==filterActivitys.indexOf(t.fromActivityName)),this.json.filterActivityAlias&&this.json.filterActivityAlias.length&&(filterActivityAlias=this.json.filterActivityAlias,t.fromActivityAlias&&(e=i(this.json.filterActivityAliasExactMatch)?filterActivityAlias.split(/[;|,|\n]/gm).contains(t.fromActivityAlias):-1!==filterActivityAlias.indexOf(t.fromActivityAlias))),this.json.filterPerson&&this.json.filterPerson.length)if(i(this.json.filterPersonExactMatch)){e=!1;for(var s=this.json.filterPerson.split(/[;|,|\n]/gm),o=t.person.split("@").concat([t.person]),n=0;n<s.length;n++)if(o.contains(s[n])){e=!0;break}}else(e=-1!==this.json.filterPerson.indexOf(t.person))||(e=-1!==this.json.filterPerson.indexOf(o2.name.cn(t.person)));this.json.filterRoute&&this.json.filterRoute.length&&(filterRoutes=this.json.filterRoute,e=i(this.json.filterRouteExactMatch)?filterRoutes.split(/[;|,|\n]/gm).contains(t.properties.routeName):-1!==filterRoutes.indexOf(t.properties.routeName))}return e},loadRecordLogLine_table:function(t,e,i){var s=e%2==0?"logTableTaskLine":"logTableTaskLine_even";"currentTask"===t.type?this.json.isTask&&this.loadRecordTaskLine_table(t,i,!0,s):this.loadRecordTaskLine_table(t,i,!1,s)},loadRecordTaskLine_table:function(t,e,i,s){css=i?Object.merge(this.form.css.logTableTaskLine_task,this.form.css[s]):this.form.css[s],i&&(s="logTableTaskLine_task");var o,n,a,r,l=e.insertRow(e.rows.length),h=l.insertCell(0).setStyles(css),d=t.person?t.person.substring(0,t.person.indexOf("@")):"";if(t.properties.empowerFromIdentity){var c=o2.name.cn(t.properties.empowerFromIdentity);d=d+" "+MWF.xApplication.process.Xform.LP.replace+" "+c}switch("empower"===t.type&&(t.properties.startTime=t.recordTime),h.set("text",d),(h=l.insertCell(1).setStyles(css)).set("text",t.fromActivityName||""),(h=l.insertCell(2).setStyles(css)).set("text",t.unit?t.unit.substring(0,t.unit.indexOf("@")):""),(h=l.insertCell(3).setStyles(css)).set("text",t.properties.startTime||""),(h=l.insertCell(4).setStyles(css)).set("text",t.recordTime||""),a=t.properties.nextManualList.map((function(t){return t.activityName})).join(","),r=t.properties.nextManualTaskIdentityList&&t.properties.nextManualTaskIdentityList.length?o2.name.cns(t.properties.nextManualTaskIdentityList).join(","):"",t.type){case"empower":o=MWF.xApplication.process.Xform.LP.empower;var u=t.properties.nextManualTaskIdentityList&&t.properties.nextManualTaskIdentityList.length?o2.name.cns(t.properties.nextManualTaskIdentityList).join(","):"";n=MWF.xApplication.process.Xform.LP.empowerTo+u,t.properties.startTime=t.recordTime;break;case"retract":o=MWF.xApplication.process.Xform.LP.retract,n=MWF.xApplication.process.Xform.LP.retract;break;case"reroute":o=t.properties.routeName||MWF.xApplication.process.Xform.LP.reroute,n=t.properties.opinion||MWF.xApplication.process.Xform.LP.rerouteTo+": "+a;break;case"rollback":o=t.properties.routeName||MWF.xApplication.process.Xform.LP.rollback,n=t.properties.opinion||MWF.xApplication.process.Xform.LP.rollbackTo+": "+t.arrivedActivityName;break;case"reset":var p=t.properties.nextManualTaskIdentityList.erase(t.identity);resetUserText=o2.name.cns(p).join(","),o=MWF.xApplication.process.Xform.LP.resetTo+":"+resetUserText,n=t.properties.opinion||"";break;case"appendTask":case"back":case"addSplit":case"urge":case"expire":case"read":default:o=t.properties.routeName||"",n=t.properties.opinion||""}(h=l.insertCell(5).setStyles(css)).set("text",o);var f=l.insertCell(6).setStyles(css);f.set("html","<div style='display: inline-block; float: left'>"+n+"</div>"),(h=l.insertCell(7).setStyles(css)).set("text",a),(h=l.insertCell(8).setStyles(css)).set("html",r);var m=[];if(t.properties.mediaOpinion){var g=t.properties.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==g.indexOf(t.id)&&m.push(t)}.bind(this)),m.length&&this.loadMediaOpinion(m,f.getFirst(),"table")}this.fireEvent("postLoadLine",[{data:t,node:l,atts:m,log:this,type:i?"task":"taskCompleted"}])},loadRecordLogDefault:function(t,e){var i=new Element("div",{styles:this.form.css.logActivityNode_record}).inject(e||this.node);t?t.each(function(t,e){this.loadRecordLogLine_default(t,e,i)}.bind(this)):this.workLog.each(function(t,e){this.checkRecordShow(t)&&this.loadRecordLogLine_default(t,e,i)}.bind(this))},loadRecordLogLine_default:function(t,e,i){var s=e%2==0?"logActivityChildRecordNode":"logActivityChildRecordNode_even",o=new Element("div",{styles:this.form.css[s]}).inject(i||this.node);"currentTask"===t.type?this.json.isTask&&this.loadRecordTaskLine_default(t,o,!0):this.loadRecordTaskLine_default(t,o,!1)},loadRecordTaskLine_default:function(t,e,i,s,o,n,a){var r="logTaskNode",l="logTaskFloatTextNode";n&&(r="logTaskTextNode",l="logTaskTextNode");var h,d=new Element("div",{styles:this.form.css[r]}).inject(e);a||(h=new Element("div",{styles:this.form.css.logTaskIconNode_record}).inject(d));var c=new Element("div",{styles:this.form.css[l]}).inject(d);o&&(d.setStyles(this.form.css[this.lineClass]),"logTaskNode"===this.lineClass?this.lineClass="logTaskNode_even":this.lineClass="logTaskNode");var u,p=0;h&&(s&&h.setStyle("margin-left",s),p=h.getStyle("margin-left").toInt(),p+=28),n||c.setStyle("margin-left",p+"px");var f="",m=[];if(i){A=t.person?t.person.substring(0,t.person.indexOf("@")):"";if(t.properties.empowerFromIdentity){j=o2.name.cn(t.properties.empowerFromIdentity);A=A+" "+MWF.xApplication.process.Xform.LP.replace+" "+j}u=A+"("+t.unit.substring(0,t.unit.indexOf("@"))+"), 【"+t.fromActivityName+"】"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+t.properties.startTime,c.set("html",u),h&&h.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}else{f=t.unitList?t.unitList[t.unitList.length-1]:"",u=this.json.textStyle;var g=MWF.xApplication.process.Xform.LP;"empower"==t.type&&(u="<font style='color:#ff5400;'>{person}</font>（{department}）"+g.in+"【{activity}】"+g.activity+"，"+g.empowerTo+"<font style='color:#ff5400;'>{empowerTo}</font>。（{time}）</font>");var y=t.properties.nextManualTaskIdentityList&&t.properties.nextManualTaskIdentityList.length?o2.name.cns(t.properties.nextManualTaskIdentityList).join(","):"";this.json.textStyleScript&&this.json.textStyleScript.code&&(this.form.Macro.environment.log=t,this.form.Macro.environment.list=null,u=this.form.Macro.exec(this.json.textStyleScript.code,this));var b,v,x,w,A=t.person?t.person.substring(0,t.person.indexOf("@")):"";if(t.properties.empowerFromIdentity){var j=o2.name.cn(t.properties.empowerFromIdentity);A=A+" "+MWF.xApplication.process.Xform.LP.replace+" "+j}switch(x=t.properties.nextManualList.map((function(t){return t.activityName})).join(","),w=t.properties.nextManualTaskIdentityList&&t.properties.nextManualTaskIdentityList.length?o2.name.cns(t.properties.nextManualTaskIdentityList).join(","):"",t.type){case"empower":b=MWF.xApplication.process.Xform.LP.empower;var _=t.properties.nextManualTaskIdentityList&&t.properties.nextManualTaskIdentityList.length?o2.name.cns(t.properties.nextManualTaskIdentityList).join(","):"";v=MWF.xApplication.process.Xform.LP.empowerTo+_,t.properties.startTime=t.recordTime;break;case"retract":b=MWF.xApplication.process.Xform.LP.retract,v=MWF.xApplication.process.Xform.LP.retract;break;case"reroute":b=t.properties.routeName||MWF.xApplication.process.Xform.LP.reroute,v=t.properties.opinion||MWF.xApplication.process.Xform.LP.rerouteTo+": "+x;break;case"rollback":b=t.properties.routeName||MWF.xApplication.process.Xform.LP.rollback,v=t.properties.opinion||MWF.xApplication.process.Xform.LP.rollbackTo+": "+t.arrivedActivityName;break;case"reset":var S=t.properties.nextManualTaskIdentityList.erase(t.identity);resetUserText=o2.name.cns(S).join(","),b=MWF.xApplication.process.Xform.LP.resetTo+":"+resetUserText,v=t.properties.opinion||"";break;case"appendTask":case"back":case"addSplit":case"urge":case"expire":case"read":case"task":case"empowerTask":default:b=t.properties.routeName||"",v=t.properties.opinion||""}u=(u=(u=(u=(u=(u=(u=(u=(u=(u=(u=(u=(u=(u=u.replace(/\{person\}/g,A)).replace(/\{department\}/g,t.unit?t.unit.substring(0,t.unit.indexOf("@")):"")).replace(/\{route\}/g,b)).replace(/\{time\}/g,t.recordTime)).replace(/\{date\}/g,(new Date).parse(t.recordTime).format("%Y-%m-%d"))).replace(/\{opinion\}/g,v)).replace(/\{company\}/g,f.substring(0,f.indexOf("@")))).replace(/\{startTime\}/g,t.properties.startTime)).replace(/\{startDate\}/g,(new Date).parse(t.properties.startTime).format("%Y-%m-%d"))).replace(/\{activity\}/g,t.fromActivityName)).replace(/\{arrivedActivity\}/g,x)).replace(/\{img\}/g,"<span class='mwf_log_img'></span>")).replace(/\{empowerTo\}/g,w)).replace(/\{next\}/g,y),c.set("html",u);var M=c.getElement(".mwf_log_img");if(t.properties.mediaOpinion){var N=t.properties.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==N.indexOf(t.id)&&m.push(t)}.bind(this)),m.length&&(M?this.loadMediaOpinion_show(m,t,M,!0):this.loadMediaOpinion(m,c,"default"))}}this.fireEvent("postLoadLine",[{data:t,atts:m,node:d,log:this,type:i?"task":"taskCompleted"}])},loadRecordLogText:function(t,e){this.lineClass="logTaskNode",t?t.each(function(t,i){this.loadRecordLogLine_text(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkRecordShow(t)&&this.loadRecordLogLine_text(t,i,e)}.bind(this))},loadRecordLogLine_text:function(t,e,i){"currentTask"===t.type?this.json.isTask&&this.loadRecordTaskLine_text(t,i||this.node,!0):this.loadRecordTaskLine_text(t,i||this.node,!1)},loadRecordTaskLine_text:function(t,e,i){this.loadRecordTaskLine_default(t,e,i,"0px",!1,!0,!0)},loadRecordLogMedia:function(t,e){t?t.each(function(t,i){this.loadRecordLogLine_media(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkRecordShow(t)&&this.loadRecordLogLine_media(t,i,e)}.bind(this))},loadRecordLogLine_media:function(t,e,i){this.loadRecordTaskLine_media(t,i)},loadRecordTaskLine_media:function(t,e){if(t.properties.mediaOpinion){var i=t.properties.mediaOpinion.split(","),s=[];this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==i.indexOf(t.id)&&s.push(t)}.bind(this));var o=!!t.recordTime;t.completedTime=t.recordTime;var n=new Element("div").inject(e||this.node);s.length&&this.loadMediaOpinion_show(s,t,n),this.fireEvent("postLoadLine",[{data:t,atts:s,node:n,log:this,type:o?"taskCompleted":"task"}])}},loadWorkLog:function(){if(this.json.category&&"none"!==this.json.category){if(this.loadCategoryList(),!this.categoryList.length)return;this.expandCount=0,this.json.expand&&"enable"===this.json.expand&&(this.expandCount=parseInt(this.json.expandCount||0)),this.table=new Element("table",this.json.tableProperties).inject(this.node),this.categoryList.each(function(t,e){var i=this.categoryJson[t];if(i&&i.length){var s=new Element("tr").inject(this.table);this.expandCount&&e+1>this.expandCount&&s.setStyle("display","none");var o=t;"unit"===this.json.category&&(o=t.split("@")[0]),new Element("td",{styles:this.json.titleTdStyles,text:o}).inject(s);var n=new Element("td",{styles:this.json.contentTdStyles}).inject(s),a=new Element("div",{styles:this.json.contentDivStyles||{}}).inject(n),r=i;"completedTimeAsc"!==this.json.sortTypeInCategory&&"completedTimeDesc"!==this.json.sortTypeInCategory||(r=[],i.each(function(t){t.taskCompletedList.length&&t.taskCompletedList.each(function(e){var i=Object.clone(t);i.readList=[],i.readCompletedList=[],i.taskList=[],i.taskCompletedList=[e],r.push(i)}.bind(this))}.bind(this)),r.sort(function(t,e){return"completedTimeAsc"===this.json.sortTypeInCategory?Date.parse(t.taskCompletedList[0].completedTime)-Date.parse(e.taskCompletedList[0].completedTime):"completedTimeDesc"===this.json.sortTypeInCategory?Date.parse(e.taskCompletedList[0].completedTime)-Date.parse(t.taskCompletedList[0].completedTime):void 0}.bind(this)),i.each((function(t){t.taskList.length&&t.taskList.each(function(e){var i=Object.clone(t);i.readList=[],i.readCompletedList=[],i.taskCompletedList=[],i.taskList=[e],r.push(i)}.bind(this))}))),"table"===this.json.mode?this.loadWorkLogTable(r,a):"text"===this.json.mode?this.loadWorkLogText(r,a):"media"===this.json.mode?this.loadWorkLogMedia(r,a):this.loadWorkLogDefault(r,a),this._loadTableStyles()}}.bind(this)),this.categoryList.length>this.expandCount&&this.loadExpandCollapseNode()}else"table"===this.json.mode?this.loadWorkLogTable():"text"===this.json.mode?this.loadWorkLogText():"media"===this.json.mode?this.loadWorkLogMedia():this.loadWorkLogDefault()},loadCategoryList:function(t,e){var i;"activity"===this.json.category?(i="fromActivityName",this[t||"_loadCategoryList"](i)):"unit"===this.json.category?(i="unit",this[e||"_loadCategoryLitBySubData"](i)):"activityGroup"===this.json.category?(i="fromOpinionGroup",this[t||"_loadCategoryList"](i)):(i=this.json.category,this[t||"_loadCategoryList"](i))},_loadCategoryList:function(t){this.categoryList=[],this.categoryJson={},"fromOpinionGroup"===t&&this.workLog.sort(function(t,e){if(t.fromOpinionGroup&&e.fromOpinionGroup){for(var i=t.fromOpinionGroup.split("#"),s=e.fromOpinionGroup.split("#"),o=0;o<i.length;o++){var n=i[o],a=s[o];return this.isNumber(n)&&this.isNumber(a)?parseFloat(n)!==parseFloat(a)?parseFloat(n)-parseFloat(a):"none"===this.json.sortTypeInCategory?0:Date.parse(t.fromTime)-Date.parse(e.fromTime):this.isNumber(n)||this.isNumber(a)?this.isNumber(n)?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(t.fromTime)-Date.parse(e.fromTime)}return Date.parse(t.fromTime)-Date.parse(e.fromTime)}return t.fromOpinionGroup||e.fromOpinionGroup?t.fromOpinionGroup?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(t.fromTime)-Date.parse(e.fromTime)}.bind(this)),this.workLog.each(function(e,i){var s;if("activityGroup"===this.json.category)if(e.fromOpinionGroup){var o=e.fromOpinionGroup.split("#");s=o[o.length-1]}else s=e.fromActivityName;else s=e[t];if(s&&this.checkShow(e)){for(var n=!1,a=0;a<e.taskCompletedList.length;a++){var r=e.taskCompletedList[a];if(n=this.checkListShow(e,r))break}if(!n&&this.json.isTask)for(a=0;a<this.json.isTask.length;a++){var l=e.taskList[a];if(n=this.checkListShow(e,l))break}n&&(-1===this.categoryList.indexOf(s)&&this.categoryList.push(s),this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(e))}}.bind(this))},_loadCategoryLitBySubData:function(t){this.categoryList=[],this.categoryJson={},this.workLog.each(function(e,i){var s=e[t];if(this.checkShow(e)){for(var o=!1,n=0;n<e.taskCompletedList.length;n++){var a=e.taskCompletedList[n];if(o=this.checkListShow(e,a))break}if(!o&&this.json.isTask)for(n=0;n<this.json.isTask.length;n++){var r=e.taskList[n];if(o=this.checkListShow(e,r))break}if(o){var l=Object.clone(e);l.taskCompletedList=[],l.taskList=[],l.readCompletedList=[],l.readList=[];var h=[],d={};for(n=0;n<e.taskCompletedList.length;n++){(s=(c=e.taskCompletedList[n])[t])&&(-1===h.indexOf(s)&&h.push(s),d[s]||(d[s]=Object.clone(l)),d[s].taskCompletedList.push(c))}for(n=0;n<e.taskList.length;n++){(s=(c=e.taskList[n])[t])&&(-1===h.indexOf(s)&&h.push(s),d[s]||(d[s]=Object.clone(l)),d[s].taskList.push(c))}for(n=0;n<e.readCompletedList.length;n++){(s=(c=e.readCompletedList[n])[t])&&(-1===h.indexOf(s)&&h.push(s),d[s]||(d[s]=Object.clone(l)),d[s].readCompletedList.push(c))}for(n=0;n<e.readList.length;n++){var c;(s=(c=e.readList[n])[t])&&(-1===h.indexOf(s)&&h.push(s),d[s]||(d[s]=Object.clone(l)),d[s].readList.push(c))}for(var s in h.each(function(t){-1===this.categoryList.indexOf(t)&&this.categoryList.push(t)}.bind(this)),d)this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(d[s])}}}.bind(this))},_loadTableBorderStyle:function(){if(this.json.tableStyles&&this.json.tableStyles.border){this.table.set("cellspacing","0"),this.table.setStyles({"border-top":this.json.tableStyles.border,"border-left":this.json.tableStyles.border});var t=this.table.getElements("th");t&&t.length&&t.setStyles({"border-bottom":this.json.tableStyles.border,"border-right":this.json.tableStyles.border});var e=this.table.getElements("td");e&&e.length&&e.setStyles({"border-bottom":this.json.tableStyles.border,"border-right":this.json.tableStyles.border})}},_loadTableStyles:function(){Object.each(this.json.tableStyles||{},function(t,e){e.test(/^border\w*/gi)||this.table.setStyle(e,t)}.bind(this)),this._loadTableBorderStyle()},loadExpandCollapseNode:function(){this.json.expand&&"enable"===this.json.expand&&(this.json.expandHTML&&(this.expandNode=new Element("div",{html:this.json.expandHTML}).inject(this.node,"bottom"),this.expandNode.addEvent("click",function(){this.json.category&&"none"!==this.json.category&&(this.table.getElements("tr").setStyle("display",""),this.expandNode.setStyle("display","none"),this.collapseNode.setStyle("display",""))}.bind(this))),this.json.collapseHTML&&(this.collapseNode=new Element("div",{html:this.json.collapseHTML,styles:{display:"none"}}).inject(this.node,"bottom"),this.collapseNode.addEvent("click",function(){if(this.json.category&&"none"!==this.json.category){for(var t=this.table.getElements("tr"),e=0;e<t.length;e++)e>=this.expandCount&&t[e].setStyle("display","none");this.expandNode.setStyle("display",""),this.collapseNode.setStyle("display","none")}else;}.bind(this))))},loadWorkLogMedia:function(t,e){t?t.each(function(t,i){this.loadWorkLogLine_media(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkShow(t)&&this.loadWorkLogLine_media(t,i,e)}.bind(this))},loadWorkLogLine_media:function(t,e,i){t.taskCompletedList.length&&t.taskCompletedList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_media(e,t,i)}.bind(this))},loadTaskLine_media:function(t,e,i){if(t.mediaOpinion){var s=t.mediaOpinion.split(","),o=[];this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==s.indexOf(t.id)&&o.push(t)}.bind(this));var n=new Element("div").inject(i||this.node);o.length&&this.loadMediaOpinion_show(o,t,n),this.fireEvent("postLoadLine",[{data:t,atts:o,node:n,log:this,type:t.completedTime?"taskCompleted":"task"}])}},loadMediaOpinion_show:function(t,e,i,s){t.each(function(t){t.type&&(-1!==t.type.indexOf("image")?this.loadMediaOpinion_image_show(t,e,i,s):-1!==t.type.indexOf("video")?this.loadMediaOpinion_video_show(t,e,i):(t.type.indexOf("audio"),this.loadMediaOpinion_voice_show(t,e,i)))}.bind(this))},loadMediaOpinion_image_show:function(t,e,i,s){var o=this.getMediaOpinionUrl(t),n=new Element("div",{styles:{overflow:"hidden"}}).inject(i||this.node);if(!s)new Element("div",{styles:{"line-height":"28px",height:"28px"},text:e.person.substring(0,e.person.indexOf("@"))+"("+e.completedTime+")"}).inject(n);var a,r=new Element("div").inject(n);if(layout.mobile)a=200;else{var l=n.getParent(),h=r.getPosition(l);a=l.getSize().x-h.x-42}var d=new Element("img",{src:o,styles:{width:a+"px"},events:{load:function(t){var e=t.target.naturalHeight,i=t.target.naturalWidth;if(layout.mobile||!this.isNumber(this.json.handwritingWidth)&&!this.isNumber(this.json.handwritingHeight)){var s=Math.min(i,a);d.setStyles({width:s+"px"}),r.setStyles({width:s+"px"})}else{var o=this.getImageSize(i,e);d.setStyles(o),r.setStyles(o)}}.bind(this)}}).inject(r)},isNumber:function(t){return"NaN"!==parseFloat(t).toString()},getImageSize:function(t,e){var i=this.json.handwritingWidth,s=this.json.handwritingHeight;return this.isNumber(i)&&!this.isNumber(s)?{width:Math.min(t,parseInt(i))+"px",height:"auto"}:!this.isNumber(i)&&this.isNumber(s)?{width:"auto",height:Math.min(e,parseInt(s))+"px"}:this.isNumber(i)&&this.isNumber(s)?t/parseInt(i)>e/parseInt(s)?{width:Math.min(t,parseInt(i))+"px",height:"auto"}:{width:"auto",height:Math.min(e,parseInt(s))+"px"}:void 0},loadMediaOpinion_video_show:function(t,e,i){},loadMediaOpinion_voice_show:function(t,e,i){var s=this.getMediaOpinionUrl(t),o=new Element("div",{styles:{overflow:"hidden"}}).inject(i||this.node);new Element("div",{styles:{"line-height":"28px",height:"28px"},text:e.person.substring(0,e.person.indexOf("@"))+"("+e.completedTime+")"}).inject(o);new Element("audio",{loop:!1,controls:!0}).inject(o).set("src",s)},loadWorkLogTable:function(t,e){t?t.each(function(t,i){this.loadWorkLogLine_table(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkShow(t)&&this.loadWorkLogLine_table(t,i,e)}.bind(this))},loadWorkLogLine_table:function(t,e,i){if(t.readList||(t.readList=[]),t.readCompletedList||(t.readCompletedList=[]),t.taskCompletedList.length||t.readList.length||t.readCompletedList.length||this.json.isTask&&t.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(i||this.node),o=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s),n=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s),a=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(o),r=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(o),l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(o),h=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(o),d=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(o);t.connected?a.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)"):a.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)"),r.set("html","<b>"+t.fromActivityName+"</b>"),t.arrivedActivityName?(l.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)"),h.set("html","<b>"+t.arrivedActivityName+"</b>"),d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+t.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+t.arrivedTime)):d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+t.fromTime),e%2==0&&(s.setStyles(this.form.css.logActivityNode_even),o.setStyles(this.form.css.logActivityTitleNode_even));var c=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(n),u=c.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine),p=u.insertCell(0).setStyles(this.form.css.logTableTaskTitle);if(p.set("text",MWF.xApplication.process.Xform.LP.person),(p=u.insertCell(1).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.department),(p=u.insertCell(2).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.startTime),(p=u.insertCell(3).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.completedTime),(p=u.insertCell(4).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.route),(p=u.insertCell(5).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.opinion),t.taskCompletedList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_table(e,c,t,!1)}.bind(this)),!1!==this.json.isShowRead){var f=[],m=[];t.readList&&t.readList.length&&t.readList.each((function(t){f.push(MWF.name.cn(t.person))})),t.readCompletedList&&t.readCompletedList.length&&t.readCompletedList.each((function(t){m.push(MWF.name.cn(t.person))})),this.loadReadLine_default(f,m,n)}this.json.isTask&&t.taskList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_table(e,c,t,!0)}.bind(this))}},loadTaskLine_table:function(t,e,i,s){var o="logTableTaskLine";s&&(o="logTableTaskLine_task");var n=e.insertRow(e.rows.length),a=n.insertCell(0).setStyles(this.form.css[o]);a.set("text",t.person.substring(0,t.person.indexOf("@"))||""),(a=n.insertCell(1).setStyles(this.form.css[o])).set("text",t.unit.substring(0,t.unit.indexOf("@"))||""),(a=n.insertCell(2).setStyles(this.form.css[o])).set("text",t.startTime||""),(a=n.insertCell(3).setStyles(this.form.css[o])).set("text",t.completedTime||""),(a=n.insertCell(4).setStyles(this.form.css[o])).set("text","empower"==t.processingType?MWF.xApplication.process.Xform.LP.empower:t.routeName||""),a=n.insertCell(5).setStyles(this.form.css[o]),opinion="empower"==t.processingType?MWF.xApplication.process.Xform.LP.empowerTo+o2.name.cn(t.empowerToIdentity||""):"<div style='line-height: 28px; float:left'>"+(t.opinion||"")+"</div>",a.set("html",opinion);var r=[];if(t.mediaOpinion){var l=t.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==l.indexOf(t.id)&&r.push(t)}.bind(this)),r.length&&this.loadMediaOpinion(r,a.getFirst(),"table")}this.fireEvent("postLoadLine",[{data:t,atts:r,node:n,log:this,type:s?"task":"taskCompleted"}])},loadWorkLogText:function(t,e){this.lineClass="logTaskNode",t?t.each(function(t,i){this.loadWorkLogLine_text(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkShow(t)&&this.loadWorkLogLine_text(t,i,e)}.bind(this))},loadWorkLogLine_text:function(t,e,i){t.taskCompletedList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_text(e,i||this.node,t,!1)}.bind(this)),this.json.isTask&&t.taskList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_text(e,i||this.node,t,!0)}.bind(this))},loadTaskLine_text:function(t,e,i,s){this.loadTaskLine_default(t,e,i,s,"0px",!1,!0,!0)},checkShow:function(t){var e=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=t,this.form.Macro.environment.list=null,e=this.form.Macro.exec(this.json.filterScript.code,this);else{var i=function(t){return t&&"array"===o2.typeOf(t)&&t.length&&"yes"===t[0]};if(this.json.filterActivity&&this.json.filterActivity.length&&(filterActivitys=this.json.filterActivity,e=i(this.json.filterActivityExactMatch)?filterActivitys.split(/[;|,|\n]/gm).contains(t.fromActivityName):-1!==filterActivitys.indexOf(t.fromActivityName)),this.json.filterActivityAlias&&this.json.filterActivityAlias.length&&(filterActivityAlias=this.json.filterActivityAlias,t.fromActivityAlias&&(e=i(this.json.filterActivityAliasExactMatch)?filterActivityAlias.split(/[;|,|\n]/gm).contains(t.fromActivityAlias):-1!==filterActivityAlias.indexOf(t.fromActivityAlias))),this.json.filterPerson&&this.json.filterPerson.length){e=!1,filterPersons=this.json.filterPerson;var s=[];if(i(this.json.filterPersonExactMatch)){var o=filterPersons.split(/[;|,|\n]/gm);t.taskCompletedList.each(function(t){for(var e=(t.person+"@"+t.identity).split("@").concat([t.person,t.identity]),i=0;i<o.length;i++)if(e.contains(o[i])){s.push(t);break}}.bind(this))}else t.taskCompletedList.each(function(t){-1===filterPersons.indexOf(t.person)&&-1===filterPersons.indexOf(t.identity)||s.push(t)}.bind(this));s.length&&(e=!0)}this.json.filterRoute&&this.json.filterRoute.length&&(filterRoutes=this.json.filterRoute,e=i(this.json.filterRouteExactMatch)?filterRoutes.split(/[;|,|\n]/gm).contains(t.routeName):-1!==filterRoutes.indexOf(t.routeName))}return e},checkListShow:function(t,e){var i,s=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=t,this.form.Macro.environment.list=e,s=this.form.Macro.exec(this.json.filterScript.code,this);else{if(this.json.filterPerson&&this.json.filterPerson.length){var o=this.json.filterPerson;if(s=!1,(i=this.json.filterPersonExactMatch)&&"array"===o2.typeOf(i)&&i.length&&"yes"===i[0]){for(var n=o.split(/[;|,|\n]/gm),a=(e.person+"@"+e.identity).split("@").concat([e.person,e.identity]),r=0;r<n.length;r++)if(a.contains(n[r])){s=!0;break}}else s=-1!==filterPersons.indexOf(e.person)||-1!==filterPersons.indexOf(e.identity)}}return s},loadWorkLogDefault:function(t,e){t?t.each(function(t,i){this.loadWorkLogLine_default(t,i,e)}.bind(this)):this.workLog.each(function(t,i){this.checkShow(t)&&this.loadWorkLogLine_default(t,i,e)}.bind(this))},loadWorkLogLine_default:function(t,e,i){if(t.readList||(t.readList=[]),t.readCompletedList||(t.readCompletedList=[]),t.taskCompletedList.length||t.readList.length||t.readCompletedList.length||this.json.isTask&&t.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(i||this.node),o=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s),n=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s),a=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(o),r=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(o),l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(o),h=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(o),d=(new Element("div",{styles:this.form.css.logActivityReadActionNode}).inject(o),new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(o));if(t.connected?a.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)"):a.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)"),r.set("html","<b>"+t.fromActivityName+"</b>"),t.arrivedActivityName?(l.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)"),h.set("html","<b>"+t.arrivedActivityName+"</b>"),d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+t.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+t.arrivedTime)):d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+t.fromTime),e%2==0&&(s.setStyles(this.form.css.logActivityNode_even),o.setStyles(this.form.css.logActivityTitleNode_even)),t.taskCompletedList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_default(e,n,t,!1)}.bind(this)),!1!==this.json.isShowRead){var c=[],u=[];t.readList&&t.readList.length&&t.readList.each((function(t){c.push(MWF.name.cn(t.person))})),t.readCompletedList&&t.readCompletedList.length&&t.readCompletedList.each((function(t){u.push(MWF.name.cn(t.person))})),this.loadReadLine_default(c,u,n)}this.json.isTask&&t.taskList.each(function(e){this.checkListShow(t,e)&&this.loadTaskLine_default(e,n,t,!0)}.bind(this))}},loadReadLine_default:function(t,e,i){var s="",o=new Element("div",{styles:this.form.css.logReadTextNode}).inject(i);if(t.length){var n=t.join(", "),a=t.length>20?t.slice(0,20).join(", ")+MWF.xApplication.process.Xform.LP.andSoForth:n;s="<span style='color: #0000ff'>"+(this.json.showReadTitle||MWF.xApplication.process.Xform.LP.showReadTitle)+": </span>"+a+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"}if(e.length){var r=e.join(", "),l=e.length>20?e.slice(0,20).join(", ")+MWF.xApplication.process.Xform.LP.andSoForth:r;s+="<span style='color: #0000ff'>"+(this.json.showReadCompletedTitle||MWF.xApplication.process.Xform.LP.showReadCompletedTitle)+": </span>"+l+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"}s&&o.set("html",s)},loadTaskLine_default:function(t,e,i,s,o,n,a,r){var l="logTaskNode",h="logTaskFloatTextNode";a&&(l="logTaskTextNode",h="logTaskTextNode");var d,c=new Element("div",{styles:this.form.css[l]}).inject(e);r||(d=new Element("div",{styles:this.form.css.logTaskIconNode}).inject(c));var u=new Element("div",{styles:this.form.css[h]}).inject(c);n&&(c.setStyles(this.form.css[this.lineClass]),"logTaskNode"===this.lineClass?this.lineClass="logTaskNode_even":this.lineClass="logTaskNode");var p=28;d&&(o&&d.setStyle("margin-left",o),p=d.getStyle("margin-left").toInt(),p+=28),a||u.setStyle("margin-left",p+"px");var f="",m=[];if(s)g=t.person.substring(0,t.person.indexOf("@"))+"("+t.unit.substring(0,t.unit.indexOf("@"))+")"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+t.startTime,u.set("html",g),d&&d.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");else{f=t.unitList?t.unitList[t.unitList.length-1]:"";var g=this.json.textStyle;"empower"==t.processingType&&(g=MWF.xApplication.process.Xform.LP.empowerToHtml);var y="";if("empower"==t.processingType){var b=[];if(t.nextTaskIdentityListText){var v=t.nextTaskIdentityListText.split(",");b=o2.name.cns(v)}else{var x=i.nextTaskIdentityList&&i.nextTaskIdentityList.length?o2.name.cns(i.nextTaskIdentityList).join(", "):"",w=i.nextTaskCompletedIdentityList&&i.nextTaskCompletedIdentityList.length?o2.name.cns(i.nextTaskCompletedIdentityList).join(", "):"";x&&b.push(x),w&&b.push(w)}y=b.join(", ")}else y=t.empowerToIdentity?o2.name.cn(t.empowerToIdentity):"";this.json.textStyleScript&&this.json.textStyleScript.code&&(this.form.Macro.environment.log=i,this.form.Macro.environment.list=null,g=this.form.Macro.exec(this.json.textStyleScript.code,this));var A=t.person.substring(0,t.person.indexOf("@"));"empower"!==t.processingType&&t.empowerFromIdentity&&(A=A+" 代 "+o2.name.cn(t.empowerFromIdentity||"")),g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=(g=g.replace(/\{person\}/g,A)).replace(/\{department\}/g,t.unit.substring(0,t.unit.indexOf("@")))).replace(/\{route\}/g,t.routeName)).replace(/\{time\}/g,t.completedTime)).replace(/\{date\}/g,(new Date).parse(t.completedTime).format("%Y-%m-%d"))).replace(/\{opinion\}/g,t.opinion||"")).replace(/\{company\}/g,f.substring(0,f.indexOf("@")))).replace(/\{startTime\}/g,t.startTime)).replace(/\{startDate\}/g,(new Date).parse(t.startTime).format("%Y-%m-%d"))).replace(/\{activity\}/g,i.fromActivityName)).replace(/\{arrivedActivity\}/g,i.arrivedActivityName)).replace(/\{img\}/g,"<span class='mwf_log_img'></span>")).replace(/\{empowerTo\}/g,t.empowerToIdentity?o2.name.cn(t.empowerToIdentity):"")).replace(/\{nextTask\}/g,x)).replace(/\{nextTaskCompleted\}/g,w)).replace(/\{next\}/g,y),u.set("html",g);var j=u.getElement(".mwf_log_img");if(t.mediaOpinion){var _=t.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(t){"$mediaOpinion"===t.site&&-1!==_.indexOf(t.id)&&m.push(t)}.bind(this)),m.length&&(j?this.loadMediaOpinion_show(m,t,j,!0):this.loadMediaOpinion(m,u,"default"))}}this.fireEvent("postLoadLine",[{data:t,node:c,atts:m,log:this,type:s?"task":"taskCompleted"}])},loadMediaOpinion:function(t,e,i){t.each(function(t){t.type||(t.type="image"),-1!==t.type.indexOf("image")?this.json.handwritingExpanded?this.loadMediaOpinion_image_show(t,null,e,!0):"table"!==i||layout.mobile?this.loadMediaOpinion_image(t,e):this.loadMediaOpinion_image_tooltip(t,e):-1!==t.type.indexOf("video")?this.loadMediaOpinion_video(t,e):-1!==t.type.indexOf("audio")?this.loadMediaOpinion_voice(t,e):this.json.handwritingExpanded?this.loadMediaOpinion_image_show(t,null,e,!0):"table"!==i||layout.mobile?this.loadMediaOpinion_image(t,e):this.loadMediaOpinion_image_tooltip(t,e)}.bind(this))},getMediaOpinionUrl:function(t){var e=MWF.Actions.get("x_processplatform_assemble_surface"),i=e.action.actions.getAttachmentStream.uri;return i=this.form.businessData.workCompleted?(i=(i=e.action.actions.getWorkcompletedAttachmentStream.uri).replace("{id}",t.id)).replace("{workCompletedId}",this.form.businessData.workCompleted.id):(i=i.replace("{id}",t.id)).replace("{workid}",this.form.businessData.work.id),i=e.action.address+i,o2.filterUrl(i)},loadMediaOpinion_image_tooltip:function(t,e){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(e.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/image.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_image),this.MTooltipsLoaded||o2.xDesktop.requireApp("Template","MTooltips",null,!1),this.MTooltipsLoaded=!0;var s=new MTooltips(this.form.app.content,i,this.form.app,null,{axis:"y",delay:350,nodeStyles:{"max-width":"800px"}});s.contentNode=new Element("div",{styles:{width:"100%",height:"100%"}});new Element("img",{src:this.getMediaOpinionUrl(t),events:{load:function(t){var e=t.target.naturalHeight,i=t.target.naturalWidth;if(this.isNumber(this.json.handwritingWidth)||this.isNumber(this.json.handwritingHeight)){var s=this.getImageSize(i,e);t.target.setStyles(s)}else{var o=Math.min(i,800);t.target.setStyles({width:o+"px"})}}.bind(this)}}).inject(s.contentNode)},loadMediaOpinion_image:function(t,e){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(e.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/image.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_image),i.addEvents({click:function(i){if(i.target.mediaOpinionContentNode)return"";var s=this.getMediaOpinionUrl(t),o=new Element("div",{styles:this.form.css.logMediaOpinionContent}).inject(e.getParent(),"after");layout.mobile||o.setStyle("margin-left","40px"),i.target.mediaOpinionContentNode=o,new Element("div",{styles:this.form.css.logMediaOpinionContentClose}).inject(o).addEvent("click",(function(){o.destroy(),i.target.mediaOpinionContentNode=""}));var n,a=new Element("div",{styles:this.form.css.logMediaOpinionContentArea}).inject(o);if(layout.mobile)n=e.getParent().getParent().getSize().x-2;else{var r=e.getParent().getParent(),l=o.getPosition(r);n=Math.min(r.getSize().x-l.x-42,800)}var h=new Element("img",{src:s,styles:{width:n+"px"},events:{load:function(t){var e=t.target.naturalHeight,i=t.target.naturalWidth;if(layout.mobile||!this.isNumber(this.json.handwritingWidth)&&!this.isNumber(this.json.handwritingHeight)){var s=Math.min(i,n);h.setStyles({width:s+"px"}),o.setStyles({width:s+"px"})}else{var a=this.getImageSize(i,e);h.setStyles(a),o.setStyles(a)}}.bind(this)}}).inject(a);i.stopPropagation()}.bind(this)})},hideMediaOpinionNode:function(){this.mediaOpinionContentNode&&(this.mediaOpinionContentNode.destroy(),this.mediaOpinionContentNode=null)},loadMediaOpinion_video:function(t,e){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(e.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/video.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_video)},loadMediaOpinion_voice:function(t,e){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(e.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/voice.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_voice),i.addEvents({click:function(e){var i=this.getMediaOpinionUrl(t);this.audioNode=new Element("audio",{loop:!1}),this.audioNode.set("src",i),this.audioNode.play(),e.stopPropagation()}.bind(this)})}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Monitor=MWF.APPMonitor=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),MWF.xDesktop.requireApp("process.Xform","widget.Monitor",function(){var t=this.form.businessData.work?this.form.businessData.work.process:this.form.businessData.workCompleted.process;this.monitor=new MWF.xApplication.process.Xform.widget.Monitor(this.node,this.form.businessData.workLogList,t,{onPostLoad:function(){this.fireEvent("postLoad")}.bind(this)})}.bind(this),!1)}}),MWF.xDesktop.requireApp("process.Xform","Textfield",null,!1),MWF.xApplication.process.Xform.Number=MWF.APPNumber=new Class({Implements:[Events],Extends:MWF.APPTextfield,iconStyle:"numberIcon",isEmpty:function(){return!this.getData()},getInputData:function(){if(this.node.getFirst()){var t=this.node.getElement("input").get("value"),e=t.toFloat();return isNaN(e)?0:e}return this._getBusinessData()},formatNumber:function(t){var e=t.toFloat();if(e&&this.json.decimals&&"*"!=this.json.decimals){var i=this.json.decimals.toInt(),s=Math.pow(10,i);if(t=(Math.round(e*s)/s).toString(),i>0){var o=t.indexOf(".");for(o<0&&(o=t.length,t+="."),decimalStr=t.substr(o+1,t.length);decimalStr.length<i;)t+="0",decimalStr+=0}}return t},validationFormat:function(){if(!this.node.getElement("input"))return!0;var t=this.node.getElement("input").get("value");return isNaN(t)?(this.notValidationMode(MWF.xApplication.process.Xform.LP.notValidation_number),!1):(this.node.getFirst().set("value",this.formatNumber(t)),!0)},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getInputData(),s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s&&"0"!==s.toString())return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(!this.readonly&&!this.json.isReadonly){if(!this.validationFormat())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);if(this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"!=i.toString())return this.notValidationMode(i),!1}return!0},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",border:"0px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle]}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},_computeValue:function(t){return this.json.defaultValue&&this.json.defaultValue.code?this.form.Macro.exec(this.json.defaultValue.code,this):t||"0"},getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();return t||(t=this._computeValue()),(t=this.formatNumber(t))||"0"},__setValue:function(t){return this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",t||"0"),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,t}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("process.Work","lp."+o2.language,null,!1),MWF.xApplication.process.Xform.Opinion=MWF.APPOpinion=new Class({Implements:[Events],Extends:MWF.APP$Input,_loadUserInterface:function(){this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type}),this.node.setStyle("display","none")},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData(),s="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!(s||this.handwritingFile&&this.handwritingFile[layout.session.user.distinguishedName]))return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},_resetNodeEdit:function(){var t=new Element("textarea",{styles:{background:"transparent",width:"100%",border:"0px"}});t.set(this.json.properties);var e=new Element("div",{styles:{ovwrflow:"hidden",position:"relative","padding-right":"2px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();t.set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type}),this.input=t,this.mediaActionArea=new Element("div",{styles:this.form.css.inputOpinionMediaActionArea}).inject(this.node),"no"!==this.json.isHandwriting&&(this.handwritingAction=new Element("div",{styles:this.form.css.inputOpinionHandwritingAction,text:MWF.xApplication.process.Work.LP.handwriting}).inject(this.mediaActionArea),this.handwritingAction.addEvent("click",function(){this.handwriting()}.bind(this))),"no"!==this.json.isAudio&&(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)&&(this.audioRecordAction=new Element("div",{styles:this.form.css.inputOpinionAudioRecordAction,text:MWF.xApplication.process.Work.LP.audioRecord}).inject(this.mediaActionArea),this.audioRecordAction.addEvent("click",function(){this.audioRecord()}.bind(this))),this.node.addEvent("change",function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation(),this.hideSelectOpinionNode()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this)),this.node.getFirst().addEvent("keydown",function(t){if(this.selectOpinionNode&&"none"!=this.selectOpinionNode.getStyle("display")&&this.selectOpinionNode.getFirst()){var e;if(38==t.code)if(this.selectedOpinionNode)(e=this.selectedOpinionNode.getPrevious())||(e=this.selectOpinionNode.getLast()),this.unselectedOpinion(this.selectedOpinionNode),this.selectedOpinion(e);else e=this.selectOpinionNode.getLast(),this.selectedOpinion(e);if(40==t.code)if(this.selectedOpinionNode)(e=this.selectedOpinionNode.getNext())||(e=this.selectOpinionNode.getFirst()),this.unselectedOpinion(this.selectedOpinionNode),this.selectedOpinion(e);else e=this.selectOpinionNode.getFirst(),this.selectedOpinion(e);27==t.code&&(this.hideSelectOpinionNode(),t.preventDefault()),32!=t.code&&13!=t.code||this.selectedOpinionNode&&(this.setOpinion(this.selectedOpinionNode.get("text")),t.preventDefault())}}.bind(this)),this.form.json.notLoadUserOpinion||MWF.UD.getDataJson("userOpinion",function(t){this.userOpinions=t}.bind(this),!1),this.node.getFirst().addEvent("input",function(t){this.startSearchOpinion()}.bind(this)),this.node.getFirst().addEvent("focus",function(){this.startSearchOpinion()}.bind(this))},audioRecord:function(){this.audioRecordNode||this.createAudioRecordNode(),this.audioRecordNode.show(),this.audioRecordNode.position({relativeTo:this.node,position:"center",edge:"center"});var t=this.audioRecordNode.getPosition(this.form.app.content),e=t.y,i=t.x;t.y<0&&(e=10),t.x<0&&(i=10),this.audioRecordNode.setStyles({top:e+"px",left:i+"px"}),this.soundFile={},MWF.require("MWF.widget.AudioRecorder",function(){this.audioRecorder=new MWF.widget.AudioRecorder(this.audioRecordNode,{onSave:function(t){this.soundFile[layout.session.user.distinguishedName]=t,this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.previewNode=new Element("audio",{controls:!0,src:window.URL.createObjectURL(t)}).inject(this.node),this.audioRecordNode.hide()}.bind(this),onCancel:function(){this.soundFile[layout.session.user.distinguishedName]=null,delete this.soundFile[layout.session.user.distinguishedName],this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.audioRecordNode.hide()}.bind(this)},null)}.bind(this))},createAudioRecordNode:function(){this.audioRecordNode=new Element("div",{styles:this.form.css.handwritingNode}).inject(this.node,"after");var t=this.node.getSize(),e=(Math.max(t.y,320),Math.max(t.x,400));e=Math.min(e,600),e=500;var i=this.node.getStyle("z-index").toInt()||0;i=i<1e3?1e3:i,this.audioRecordNode.setStyles({height:"320px",width:e+"px","z-index":i+1})},handwriting:function(){this.handwritingNode||this.createHandwriting(),this.handwritingNode.show(),this.handwritingNode.position({relativeTo:this.node,position:"center",edge:"center"});var t=this.handwritingNode.getPosition(this.handwritingNode.getOffsetParent()),e=t.y,i=t.x;t.y<0&&(e=10),t.x<0&&(i=10),this.handwritingNode.setStyles({top:e+"px",left:i+"px"})},createHandwriting:function(){this.handwritingNode=new Element("div",{styles:this.form.css.handwritingNode}).inject(this.node,"after");var t=this.node.getSize(),e=Math.max(this.json.tabletWidth||t.x,500),i=Math.max(this.json.tabletHeight?parseInt(this.json.tabletHeight)+110:t.y,320),s=this.node.getStyle("z-index").toInt()||0;s=s<1e3?1e3:s,this.handwritingNode.setStyles({height:i+"px",width:e+"px","z-index":s+1}),this.handwritingNode.position({relativeTo:this.node,position:"center",edge:"center"}),this.handwritingAreaNode=new Element("div",{styles:this.form.css.handwritingAreaNode}).inject(this.handwritingNode),this.handwritingActionNode=new Element("div",{styles:this.form.css.handwritingActionNode,text:MWF.xApplication.process.Work.LP.saveWrite}).inject(this.handwritingNode);var o=this.handwritingActionNode.getSize().y+this.handwritingActionNode.getStyle("margin-top").toInt()+this.handwritingActionNode.getStyle("margin-bottom").toInt();o=i-o,this.handwritingAreaNode.setStyle("height",o+"px"),this.handwritingFile={},MWF.require("MWF.widget.Tablet",function(){this.tablet=new MWF.widget.Tablet(this.handwritingAreaNode,{style:"default",contentWidth:this.json.tabletWidth||0,contentHeight:this.json.tabletHeight||0,onSave:function(t,e,i){this.handwritingFile[layout.session.user.distinguishedName]=i,this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),"no"!==this.json.isHandwritingPreview&&(this.previewNode=new Element("img",{src:e}).inject(this.node)),this.handwritingNode.hide()}.bind(this),onCancel:function(){this.handwritingFile[layout.session.user.distinguishedName]=null,delete this.handwritingFile[layout.session.user.distinguishedName],this.previewNode&&(this.previewNode.destroy(),this.previewNode=null),this.handwritingNode.hide()}.bind(this)},null),this.tablet.load()}.bind(this)),this.handwritingActionNode.addEvent("click",function(){this.tablet&&this.tablet.save()}.bind(this))},unselectedOpinion:function(t){t.setStyle("background-color","#ffffff"),this.selectedOpinionNode=null},selectedOpinion:function(t){t.setStyle("background-color","#d2ddf5"),this.selectedOpinionNode=t},startSearchOpinion:function(){var t=this.input.get("value"),e=t.split(/(,\s*){1}|(;\s*){1}|\s+/g);(t=e[e.length-1]).length?(this.clearSearcheOpinionId(),this.searcheOpinionId=window.setTimeout(function(){this.searchOpinions(t)}.bind(this),500)):this.clearSearcheOpinionId()},clearSearcheOpinionId:function(){this.searcheOpinionId&&(window.clearTimeout(this.searcheOpinionId),this.searcheOpinionId="")},searchOpinions:function(t){var e=this.input.get("value"),i=e.split(/[\n\r]/g);lines=i.length;var s=e=i[i.length-1];if(this.userOpinions){var o=this.userOpinions.filter(function(e,i){return e.contains(t)&&e!=t}.bind(this));o.length?this.showSelectOpinionNode(o,s,lines):this.hideSelectOpinionNode(o)}},hideSelectOpinionNode:function(){this.selectOpinionNode&&this.selectOpinionNode.setStyle("display","none")},showSelectOpinionNode:function(t,e,i){this.selectOpinionNode||this.createSelectOpinionNode(),this.selectOpinionNode.empty(),t.each(function(t){this.createSelectOpinionOption(t)}.bind(this));var s=this.input.getSize(),o=MWF.getTextSize(e,this.json.inputStyles),n=(o.y-3)*i+3;n>s.y&&(n=s.y),this.selectOpinionNode.setStyle("display","block"),this.selectOpinionNode.position({relativeTo:this.node,position:"leftTop",edge:"leftTop",offset:{x:o.x,y:n}})},createSelectOpinionNode:function(){this.selectOpinionNode=new Element("div",{styles:this.form.css.opinionSelectNode}).inject(this.node)},createSelectOpinionOption:function(t){var e=new Element("div",{styles:this.form.css.opinionSelectOption,text:t}).inject(this.selectOpinionNode);this.json.selectItemStyles&&e.setStyles(this.json.selectItemStyles),e.addEvents({mouseover:function(){this.setStyle("background-color","#d2ddf5")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){this.setOpinion(t)}.bind(this)})},setOpinion:function(e){var i=this.input.get("value"),s=i.split(/(,\s*){1}|(;\s*){1}|\s+/g);t=s[s.length-1];var o=i.substr(0,i.length-t.length);this.input.set("value",o+e),this.hideSelectOpinionNode(),this._setBusinessData(this.getInputData())},_afterLoaded:function(){this.readonly||this.loadDescription()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||(e=t.x-23),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.Xform.Org=MWF.APPOrg=new Class({Implements:[Events],Extends:MWF.APP$Input,options:{moduleEvents:["load","queryLoad","postLoad","change","select"],selectorEvents:["queryLoadSelector","postLoadSelector","queryLoadContent","postLoadContent","queryLoadCategory","postLoadCategory","selectCategory","unselectCategory","queryLoadItem","postLoadItem","selectItem","unselectItem","change","expand","collapse"],readonly:!0},iconStyle:"orgIcon",getTextData:function(){var t=this.getValue(),e=[];return"object"===typeOf(t)&&(t=[t]),"array"===typeOf(t)?(t.each(function(t){"string"===typeOf(t)?e.push(t):e.push(t.name+(t.unitName?"("+t.unitName+")":""))}.bind(this)),{value:t||"",text:[e.join(",")]}):{value:[""],text:[""]}},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadNode:function(){this.field=!0,this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.APPOrg.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.APPOrg.UnitOptions(this.form,this.json)),this.selectTypeList.contains("group")&&(this.groupOptions=new MWF.APPOrg.GroupOptions(this.form,this.json))},_valueMerge:function(t,e){return"function"==o2.typeOf(e)?e.then(function(e){this._valueMerge(t,e)}.bind(this),(function(){})):t.concat(e)},_computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){if(s.code&&(i=this.form.Macro.exec(s.code,this)),i){var o="array"==o2.typeOf(i)?i:[i],n=Promise.all(o).then(function(e){var i=e.distinguishedName||e;"array"==o2.typeOf(e)&&(i=e[0].distinguishedName||e[0]);var o='return this.org.getDuty("'+s.name+'", "'+i+'", true)',n=i?this.form.Macro.exec(o,this):"",a="array"==o2.typeOf(n)?"all":"resolve";return Promise[a](n).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this)).catch((function(){console.log("catch error : can not get duty : "+s.name,NaN+i)}))}.bind(this),(function(){}));e.push(n)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var o=this.form.Macro.exec(this.json.defaultValue.code,this);"array"==o2.typeOf(o)?o.each((function(t){e.push(t)})):e.push(o)}return e},__computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,s=JSON.decode(this.json.dutyValue);s.length&&s.each(function(s){if(s.code&&(i=this.form.Macro.exec(s.code,this)),i&&i.isAG){var o=o2.AG.all(i).then(function(e){var i="";e&&e.length&&(i=e[0].distinguishedName||e[0]);var o='return this.org.getDuty("'+s.name+'", "'+i+'", true)',n=this.form.Macro.exec(o,this);o2.AG.all(n).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this))}.bind(this));e.push(o)}else{var n='return this.org.getDuty("'+s.name+'", "'+i+'", true)',a=this.form.Macro.exec(n,this);o=o2.AG.all(a).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this));e.push(o)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var o=this.form.Macro.exec(this.json.defaultValue.code,this);o&&o.isAG?e.push(o):("array"!==typeOf(o)&&(o=o?[o]:[]),o.each(function(i){var s;i&&("string"===typeOf(i)?(this.getOrgAction()[this.getValueMethod(i)](function(e){s=MWF.org.parseOrgData(e.data,!0,t)}.bind(this),null,i,!1),e.push(s)):e.push(i))}.bind(this)))}return this.json.count>0?e.slice(0,this.json.count):e},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},getOptions:function(){var t=this;if(0===this.selectTypeList.length)return!1;var e,i,s,o=this.getInputData()||[],n=[];if(this.json.exclude){var a=this.form.Macro.exec(this.json.exclude.code,this);n="array"===typeOf(a)?a:[a]}this.identityOptions&&(e=this.identityOptions.getOptions(),"all"!==this.json.identityRange&&(e.noUnit||e.units&&e.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange,"error",this.node),e.disabled=!0)),!e.noUnit&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(e.dutys&&e.dutys.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange,"error",this.node),e.disabled=!0)),e.values=this.json.isInput?[]:o,e.exclude=n,this.form.json.selectorStyle&&(e=Object.merge(e,this.form.json.selectorStyle))),this.unitOptions&&(i=this.unitOptions.getOptions(),"all"!==this.json.unitRange&&(i.units&&i.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange,"error",this.node),i.disabled=!0)),i.values=this.json.isInput?[]:o,i.exclude=n,this.form.json.selectorStyle&&(i=Object.merge(i,this.form.json.selectorStyle))),this.groupOptions&&((s=this.groupOptions.getOptions()).values=this.json.isInput?[]:o,s.exclude=n,this.form.json.selectorStyle&&(s=Object.merge(s,this.form.json.selectorStyle)));var r={};if(this.json.events&&"object"===typeOf(this.json.events)&&Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.selectorEvents.indexOf(e)&&("postLoadSelector"===e?this.addEvent("loadSelector",function(e){return this.form.Macro.fire(t.code,e)}.bind(this)):"queryLoadSelector"===e?r.onQueryLoad=function(e){return this.form.Macro.fire(t.code,e)}.bind(this):r["on"+e.capitalize()]=function(e){return this.form.Macro.fire(t.code,e)}.bind(this))}.bind(this)),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0],onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this,this.selector)},onClose:this.selectOnClose.bind(this)},r,e||i||s);if(this.selectTypeList.length>1){var l={type:"",types:this.selectTypeList,onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this)},onClose:this.selectOnClose.bind(this)};return this.form.json.selectorStyle&&(l=Object.merge(l,this.form.json.selectorStyle)),e&&(l.identityOptions=Object.merge({},r,e)),i&&(l.unitOptions=Object.merge({},r,i)),s&&(l.groupOptions=Object.merge({},r,s)),l}},selectOnComplete:function(t){var e=[];t.each(function(t){e.push(t.data)}.bind(this));var i="simple"===this.json.storeRange;this.checkEmpower(e,function(t){var e=[];t.each(function(t){e.push(MWF.org.parseOrgData(t,!0,i))}.bind(this)),this.json.isInput?this.addData(e):this.setData(e),this.validationMode(),this.validation();var s=this.getValue();s.then?s.then(function(){this.fireEvent("select")}.bind(this),(function(){})):this.fireEvent("select")}.bind(this))},selectOnCancel:function(){this.validation()},selectOnLoad:function(t){this.descriptionNode&&this.descriptionNode.setStyle("display","none"),this.fireEvent("loadSelector",[t])},selectOnClose:function(){v=this._getBusinessData(),v&&v.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")},clickSelect:function(t){if(!this.readonly)if(layout.mobile)setTimeout(function(){var t=this.getOptions();t&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,t)))}.bind(this),100);else{var e=this.getOptions();e&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,e)))}},resetData:function(){var t=this.getValue();this.setData(t)},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this.node.retrieve("data")},_loadNodeRead:function(){this.node.empty();new Element("div").inject(this.node);this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div"),i="simple"===this.json.storeRange;if(t.data){var s=t.data;if(this.selectTypeList.contains("identity")&&"person"===this.json.identityResultType){var o=s.distinguishedName||s;"i"===o.substr(o.length-1,1).toLowerCase()&&MWF.Actions.get("x_organization_assemble_express").listPersonWithIdentity({identityList:[o]},function(e){e.data.length>0&&(s.person&&(e.data[0].id=s.person),t.data=MWF.org.parseOrgData(e.data[0],!0,i),t.value=this.getDataText(t.data),t.node&&t.node.set("text",t.value))}.bind(this),null,!1)}t.data&&(t.data.createTime||t.data.updateTime)&&(t.data=MWF.org.parseOrgData(t.data,!0,i));var n="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":n=t.data.name+"("+t.data.unitName+")";break;case"@p":n=t.data.name+(t.data.employee?"("+t.data.employee+")":"");break;case"@u":n=t.data.levelName;break;case"@g":n=t.data.name;break;default:n=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:n})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},getSearchOptions:function(){if(0===this.selectTypeList.length)return!1;var t,e,i;if(this.identityOptions&&(t=this.identityOptions.getSearchOptions()),this.unitOptions&&(e=this.unitOptions.getSearchOptions()),this.groupOptions&&(i=this.groupOptions.getOptions()),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0]},t||e||i);if(this.selectTypeList.length>1){var s={type:"",types:this.selectTypeList};return t&&(s.identityOptions=t),e&&(s.unitOptions=e),i&&(s.groupOptions=i),s}},_searchOptions:function(t,e){var i=this.getSearchOptions();this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){this.node.setStyle("overflow","visible");var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:function(t){this.clickSelect(t)}.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.node.getFirst().setStyle("height","auto"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},getDataText:function(t){if("string"==typeOf(t))return t;var e="";switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":e=t.name+"("+t.unitName+")";break;case"@p":e=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":e=t.name;break;default:e=t.name}return e},addData:function(t){if(!t)return!1;var e="simple"===this.json.storeRange;t.each(function(t){var i,s=typeOf(t);"string"===s&&(this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,t,!1),i&&this.combox.addNewValue(this.getDataText(i),i));if("object"===s){var o=MWF.org.parseOrgData(t,!0,e);this.combox.addNewValue(this.getDataText(o),o)}}.bind(this))},checkChange:function(t,e){var i=!1;if(e||(e=[]),t.length&&e&&e.length)if(t.length===e.length){for(var s=0;s<t.length;s++)if(t[s].distinguishedName!==e[s].distinguishedName||t[s].name!==e[s].name||t[s].unique!==e[s].unique){i=!0;break}}else i=!0;else(e.length||t.length)&&(i=!0);i&&this.fireEvent("change")},setData:function(t){if(!t)return!1;var e=this.getData();1!=t.length||t[0]||(t=[]),this._setValue(t).then(function(t){o2.promiseAll(t).then(function(t){this.checkChange(e,t)}.bind(this),(function(){}))}.bind(this),(function(){}))},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitShow||", ");var s=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),o="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":o=t.value.name+"("+t.value.unitName+")";break;case"@p":o=t.value.name+(t.value.employee?"("+t.value.employee+")":"");break;case"@u":o=t.value.levelName;break;case"@g":o=t.value.name;break;default:o=t.value.name}var n=new Element("div").set({styles:{"font-size":"14px",color:""},text:o});new mBox.Tooltip({content:n,setStyles:{content:{padding:15,lineHeight:20}},attach:s,transition:"flyin"})}return s},_setValue:function(t){var e=[],i=[],s="simple"===this.json.storeRange;"array"!==typeOf(t)&&(t=t?[t]:[]);var o=o2.promiseAll(t).then(function(t){return"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){if(t)if("string"===typeOf(t)){var o=this.getOrgAction()[this.getValueMethod(t)](function(t){return MWF.org.parseOrgData(t.data,!0,s)}.bind(this),null,t,!0).catch((function(t){console.log("error:"+t),console.log(t)}));i.push(o)}else e.push(t)}.bind(this))}.bind(this)),i.length?o2.promiseAll(i).then(function(t){return e=e.concat(t),!0,this.__setValue(e),e}.bind(this),(function(){})):(!0,this.__setValue(e),e)}.bind(this),(function(){}));return this.moduleValueAG=o,o&&o.then&&o.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this)),o},__setValue:function(t){this.moduleValueAG=null,1!=t.length||t[0]||(t=[]),this.json.count>0&&(t=t.slice(0,this.json.count));var e,i=[],s=[],o=typeOf(t),n="simple"===this.json.storeRange;if("array"===o&&t.each(function(t){var e=null,o=typeOf(t);if("string"===o){var a=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),a,t,!1)}if("object"===o&&(e=t),e){var r=MWF.org.parseOrgData(e,!0,n);i.push(r),s.push({text:this.getDataText(r),value:r})}}.bind(this)),"string"===o){var a,r=this.json.isInput?function(){s.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){a=MWF.org.parseOrgData(t.data,!0,n)}.bind(this),r,t,!1),a&&(i.push(a),s.push({text:this.getDataText(a),value:a}))}if("object"===o){var l=MWF.org.parseOrgData(t,!0,n);i.push(l),s.push({text:this.getDataText(l),value:l})}(this.node.store("data",i),this._setBusinessData(i),this.json.isInput)?this.combox?(this.combox.clear(),this.combox.addNewValues(s)):(e=this.node.getFirst())&&(e.empty(),s.each(function(t,i){this.creteShowNode(t,i===s.length-1).inject(e)}.bind(this))):this.node.getFirst()?((e=this.node.getFirst()).empty(),this.loadOrgWidget(i,e)):(this.node.empty(),this.loadOrgWidget(i,this.node))},getValueMethod:function(t){if(t)switch(t.substr(t.length-2,2).toLowerCase()){case"@i":return"getIdentity";case"@p":return"getPerson";case"@u":return"getUnit";case"@g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var s=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||s||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){var s,o=t.distinguishedName.substr(t.distinguishedName.length-2,2),n=Object.clone(t);if(this.json.displayTextScript&&this.json.displayTextScript.code){this.currentData=n;var a=this.form.Macro.exec(this.json.displayTextScript.code,this);a&&(n.displayName=a),this.currentData=null}switch(o.toLowerCase()){case"@i":s=new MWF.widget.O2Identity(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@p":s=new MWF.widget.O2Person(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@u":s=new MWF.widget.O2Unit(n,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@g":s=new MWF.widget.O2Group(n,e,{style:"xform",lazy:!0,disableInfor:i});break;default:s=new MWF.widget.O2Other(n,e,{style:"xform",lazy:!0,disableInfor:i})}s.field=this,layout.mobile&&s.node.setStyles({float:"none"})}.bind(this))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},checkEmpower:function(t,e){"array"===typeOf(t)&&this.identityOptions&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType?new MWF.APPOrg.EmpowerChecker(this.form,this.json).load(t,e):e&&e(t)}}),MWF.APPOrg.EmpowerChecker=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.css=this.form.css,this.checkedAllItems=!0},load:function(t,e,i){if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var s=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&s.push(t.distinguishedName))}.bind(this)),s.length>0?o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:s},function(s){var o=[];s.data.each((function(t){t.fromIdentity!==t.toIdentity&&o.push(t)})),o.length>0?this.openSelectEmpowerDlg(o,t,e,i):e&&e(t)}.bind(this),function(){e&&e(t)}.bind(this)):e&&e(t)}else e&&e(t)},getIgnoreEmpowerArray:function(t){var e=[];return this.empowerSelectNodes&&this.empowerSelectNodes.length&&this.empowerSelectNodes.each(function(t){if(!t.retrieve("isSelected")){var i=t.retrieve("data");e.push(i.fromIdentity)}}.bind(this)),t&&t(e),e},setIgnoreEmpowerFlag:function(t,e){for(var i=this.getIgnoreEmpowerArray(),s=0;s<t.length;s++){var o=t[s];i.indexOf(o.distinguishedName)>-1?o.ignoreEmpower=!0:o.ignoreEmpower&&delete o.ignoreEmpower}e&&e(t)},replaceEmpowerIdentity:function(t,e){var i={};if(this.empowerSelectNodes.each(function(t){if(t.retrieve("isSelected")){var e=t.retrieve("data");i[e.fromIdentity]=e}}.bind(this)),0===Object.keys(i).length)e(t);else{var s=[];for(var o in i)s.push(i[o].toIdentity);o2.Actions.get("x_organization_assemble_express").listIdentity({identityList:s},(function(s){var o=t.clone(),n={};s.data.each((function(t){n[t.distinguishedName]=t}));for(var a=0;a<o.length;a++){var r=o[a];r.distinguishedName&&i[r.distinguishedName]&&n[i[r.distinguishedName].toIdentity]&&(o[a]=n[i[r.distinguishedName].toIdentity])}e(o)}),(function(){e(t)}))}},openSelectEmpowerDlg:function(t,e,i,s){layout.mobile?this.openSelectEmpowerDlg_mobile(t,e,i,s):this.openSelectEmpowerDlg_pc(t,e,i,s)},openSelectEmpowerDlg_mobile:function(t,e,i,s){var o=[],n=[];if(t.each(function(t){o.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity}),n.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity})}.bind(this)),0!==o.length){var a=Array.clone(o);o2.xDesktop.requireApp("Template","Selector.Custom",function(){var t={count:0,title:MWF.xApplication.process.Xform.LP.selectEmpower,selectAllEnable:!0,selectableItems:o,expand:!1,category:!1,values:n,zIndex:3001,closeOnclickOk:!0,onComplete:function(t){var s=[];t.each(function(t){s.push(t.data.id)}.bind(this));var o=[];a.each((function(t){-1===s.indexOf(t.id)&&o.push(t.id.split("#")[0])}));for(var n=0;n<e.length;n++){var r=e[n];o.indexOf(r.distinguishedName)>-1?r.ignoreEmpower=!0:r.ignoreEmpower&&delete r.ignoreEmpower}i&&i(e)}.bind(this)};this.form.json.selectorStyle&&Object.merge(t,this.form.json.selectorStyle),t.flatCategory=!1,new o2.xApplication.Template.Selector.Custom($(document.body),t).load()}.bind(this))}else i()},openSelectEmpowerDlg_pc:function(t,e,i,s){var o=new Element("div",{styles:this.css.empowerAreaNode}),n='<div style="line-height: 20px; color: #333333; overflow: hidden">'+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";n+='<div style="margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',o.set("html",n);var a=o.getLast();this.getEmpowerItems(a,t),o.inject(s||this.form.app.content);var r=o2.DL.open({title:MWF.xApplication.process.Xform.LP.selectEmpower,style:this.form.json.dialogStyle||"user",isResize:!0,content:o,width:630,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,s){this.setIgnoreEmpowerFlag(e,i),r.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){r.close()}}],onPostShow:function(){if(this.createSelectAllEmpowerNode().inject(r.button),layout.mobile){r.node.inject($(document.body)),r.node.setStyles({width:"100%",height:"100%",top:"0px",left:"0px"});var t=r.node.getSize().y-190;a.setStyle("height",t+"px"),r.options.contentHeight=r.node.getSize().y-100,r.setContentSize()}else{r.content.setStyle("overflow","hidden");t=Math.min(300,a.getSize().y),a.getStyle("margin-top"),a.getStyle("margin-bottom");a.setStyle("height",t+"px"),r.options.contentHeight=t+30+20,r.setContentSize(),r.node.setStyles({height:r.options.height+"px"}),r.reCenter()}}.bind(this)})},getEmpowerItems:function(t,e){var i=this;this.empowerSelectNodes=[];var s,o=1;e.each(function(e){if(e.fromIdentity!=e.toIdentity){o%2==1?(s=new Element("div",{styles:this.css.empowerItemOddNode}).inject(t)).store("nodeType","Odd"):(s=new Element("div",{styles:this.css.empowerItemEvenNode}).inject(t)).store("nodeType","Even"),o++,this.empowerSelectNodes.push(s),s.store("data",e);var n=new Element("div.empowerItemIconNode",{styles:this.css.empowerItemIconNode}).inject(s);s.store("iconNode",n);var a=new Element("div.empowerItemContentNode",{styles:this.css.empowerItemContentNode}).inject(s);new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.fromIdentity.split("@")[0]}).inject(a),new Element("div.empowerItemTitleNode",{styles:this.css.empowerItemTitleNode,text:MWF.xApplication.process.Xform.LP.empowerTo}).inject(a),new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.toIdentity.split("@")[0]}).inject(a);s.addEvents({mouseover:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node_over"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode_over)}},mouseout:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode)}},click:function(){this.retrieve("isSelected")?i.unselectEmpowerItem(this):i.selectEmpowerItem(this)}}),this.checkedAllItems&&s.click()}}.bind(this))},unselectEmpowerItem:function(t){t.store("isSelected",!1),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))},selectEmpowerItem:function(t){t.store("isSelected",!0),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node_selected"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e+"_selected"]&&t.setStyles(this.css[e+"_selected"])}.bind(this))},createSelectAllEmpowerNode:function(){var t=this,e=new Element("div",{styles:this.css.empowerSelectAllItemNode,text:MWF.xApplication.process.Xform.LP.selectAll});return e.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode)},click:function(){this.retrieve("isSelected")?(this.store("isSelected",!1),this.setStyles(t.css.empowerSelectAllItemNode),t.empowerSelectNodes.each(function(e){t.unselectEmpowerItem(e)}.bind(this))):(this.store("isSelected",!0),this.setStyles(t.css.empowerSelectAllItemNode_selected),t.empowerSelectNodes.each(function(e){t.selectEmpowerItem(e)}.bind(this)))}}),this.checkedAllItems&&(e.store("isSelected",!0),e.setStyles(t.css.empowerSelectAllItemNode_selected)),e}}),MWF.APPOrg.GroupOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.groupCount?this.json.groupCount:0;return"group"===this.json.groupRange?{count:t,storeRange:this.json.storeRange,include:this.getSelectRange(!0)}:{count:t,storeRange:this.json.storeRange}},getSearchOptions:function(){return{}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){var t=[];if(this.json.groupRangeKey&&this.json.groupRangeKey.code){var e=this.form.Macro.exec(this.json.groupRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),t=e}return t}}),MWF.APPOrg.UnitOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){return{count:this.json.unitCount?this.json.unitCount:0,units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,storeRange:this.json.storeRange,expandSubEnable:"no"!=this.json.unitExpandSubEnable}},getSearchOptions:function(){return{units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){if("unit"===this.json.unitRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.unitRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.unitRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.unitRangeUnit&&this.json.unitRangeUnit.length&&this.json.unitRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.unitRangeField&&this.json.unitRangeField.length&&this.json.unitRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.unitRangeKey&&this.json.unitRangeKey.code){var e=this.form.Macro.exec(this.json.unitRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],s=[];return i.each(function(t){"direct"===this.json.unitRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&s.push(e.woUnit)):"level"===this.json.unitRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.unitRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)):"type"===this.json.unitRangeNext&&("all"===this.json.unitRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.unitRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)),e=null}.bind(this)),s}}),MWF.APPOrg.IdentityOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.identityCount?this.json.identityCount:0;return this.json.identityOnlyUseInclude?{noUnit:!0,count:t,resultType:this.json.identityResultType,storeRange:this.json.storeRange,include:this._getInclude()}:{count:t,units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),expandSubEnable:"no"!=this.json.identityExpandSubEnable,resultType:this.json.identityResultType,categoryType:this.json.categoryType||"unit",dutyUnitLevelBy:this.json.dutyUnitLevelBy||"duty",storeRange:this.json.storeRange,include:this._getInclude()}},getSearchOptions:function(){return{units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),resultType:this.json.identityResultType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getInclude:function(){var t=[];if(this.json.identityIncludeKey){var e=this.form.Macro.exec(this.json.identityIncludeKey.code,this);e&&(t="array"===typeOf(e)?e:[e])}return t},_getSelectRange:function(){if("unit"===this.json.identityRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.identityRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.identityRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.identityRangeUnit&&this.json.identityRangeUnit.length&&this.json.identityRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.identityRangeField&&this.json.identityRangeField.length&&this.json.identityRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.identityRangeKey&&this.json.identityRangeKey.code){var e=this.form.Macro.exec(this.json.identityRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],s=[];return i.each(function(t){"direct"===this.json.identityRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&s.push(e.woUnit)):"level"===this.json.identityRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.identityRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)):"type"===this.json.identityRangeNext&&("all"===this.json.identityRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.identityRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&s.push(e)),e=null}.bind(this)),s},getSelectRangeDuty:function(t){return this.selectRangeDuty&&!t||(this.selectRangeDuty=this._getSelectRangeDuty()),this.selectRangeDuty},_getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},getScriptSelectDuty:function(){var t=[];if(this.json.rangeDuty&&this.json.rangeDuty.length){var e=this.json.rangeDuty;"string"===typeOf(e)&&(e=JSON.parse(e)),"array"===typeOf(e)&&e.each(function(e){var i="string"===typeOf(e)?e:e.id||e.name;i&&t.push(i)}.bind(this))}if(this.json.rangeDutyField&&this.json.rangeDutyField.length&&this.json.rangeDutyField.each(function(e){var i="object"==typeOf(e)?e.name:e,s=this.form.businessData.data[i];"array"!==typeOf(s)&&(s=s?[s.toString()]:[]),s.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.rangeDutyKey&&this.json.rangeDutyKey.code){var i=this.form.Macro.exec(this.json.rangeDutyKey.code,this);"array"!==typeOf(i)&&(i=i?[i.toString()]:[]),i.each(function(e){e&&t.push(e)}.bind(this))}return t}}),MWF.xDesktop.requireApp("process.Xform","Personfield",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.xApplication.process.Xform.Orgfield=MWF.APPOrgfield=new Class({Extends:MWF.APPPersonfield,iconStyle:"orgfieldIcon",loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadUserInterface:function(){this.field=!0,this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){var t="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType];if(t.contains("unit")||t.contains("identity")){if(this.selectUnits=this.getSelectRange(),"all"!==this.json.range&&!this.selectUnits.length)return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1}else this.selectUnits=[]},_loadNodeRead:function(){this.node.empty(),this.node.setStyle("overflow","hidden"),this.node.set({nodeId:this.json.id,MWFType:this.json.type});new Element("div").inject(this.node)},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div");if(t.data){var i="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":i=t.data.name+"("+t.data.unitName+")";break;case"@p":i=t.data.name+(t.data.employee?"("+t.data.employee+")":"");break;case"@u":i=t.data.levelName;break;case"@g":i=t.data.name;break;default:i=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:i})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},_searchOptions:function(t,e){var i={type:"",types:"array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],units:this.selectUnits,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType};this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&this._setBusinessData(this.getInputData("change"))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,readonly:!0}),this.readonly||(this.node.setStyle("cursor","pointer"),this.node.addEvents({click:function(t){this.clickSelect(t)}.bind(this)}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:{background:"url(../x_component_process_Xform/$Form/default/icon/selectorg.png) center center no-repeat",width:"18px",height:"18px",float:"right"}}).inject(this.node,"before"),this.iconNode&&(this.iconNode.setStyle("cursor","pointer"),this.iconNode.addEvents({click:function(t){this.clickSelect(t)}.bind(this)})))},getValue:function(){var t=this._getBusinessData();return"array"===typeOf(t)?0===t.length&&(t=this._computeValue()):t||(t=this._computeValue()),t||""},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getData:function(t){return"save"==this.json.compute&&this._setValue(this._computeValue()),this._getBusinessData()},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this._getBusinessData()},addData:function(t){if(!t)return!1;t.each(function(t){var e,i=typeOf(t);"string"===i&&(this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0)}.bind(this),null,t,!1),e&&this.combox.addNewValue(this.getDataText(e),e));"object"===i&&this.combox.addNewValue(this.getDataText(t),t)}.bind(this))},setData:function(t){this._setValue(t)},_computeValue:function(){var t=[];if(this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)})),this.json.defaultValue&&this.json.defaultValue.code){var e=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(e)&&(e=e?[e]:[]),e.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction()[this.getValueMethod(e)](function(t){i=MWF.org.parseOrgData(t.data,!0)}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},_getBusinessData:function(){if("yes"==this.json.section)var t=this._getBusinessSectionData();else t=this.form.businessData.data[this.json.id]||"";return"array"!=typeOf(t)?t?[t]:[]:t},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitStr||", ");var s=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),o="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":o=t.value.name+"("+t.value.unitName+")";break;case"@p":o=t.value.name+(t.value.employee?"("+t.value.employee+")":"");break;case"@u":o=t.value.levelName;break;case"@g":o=t.value.name;break;default:o=t.value.name}var n=new Element("div").set({styles:{"font-size":"14px",color:""},text:o});new mBox.Tooltip({content:n,setStyles:{content:{padding:15,lineHeight:20}},attach:s,transition:"flyin"})}return s},_setValue:function(t){1!=t.length||t[0]||(t=[]);var e=[],i=[],s=typeOf(t);if("array"===s&&t.each(function(t){var s=null,o=typeOf(t);if("string"===o){var n=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){s=MWF.org.parseOrgData(t.data,!0)}.bind(this),n,t,!1)}"object"===o&&(s=t),s&&(e.push(s),i.push({text:this.getDataText(s),value:s}))}.bind(this)),"string"===s){var o,n=this.json.isInput?function(){i.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){o=MWF.org.parseOrgData(t.data,!0)}.bind(this),n,t,!1),o&&(e.push(o),i.push({text:this.getDataText(o),value:o}))}if("object"===s&&(e.push(t),i.push({text:this.getDataText(t),value:t})),this._setBusinessData(t),this.json.isInput)if(this.combox)this.combox.clear(),this.combox.addNewValues(i);else{var a=this.node.getFirst();a&&(a.empty(),i.each(function(t,e){this.creteShowNode(t,e===i.length-1).inject(a)}.bind(this)))}else{var r=this.node.getFirst();r||(r=this.node),r.empty(),this.loadOrgWidget(e,r)}},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var s={style:"xform",canRemove:!1,onRemove:this.removeItem,disableInfor:i};t.each(function(t){if(t.distinguishedName){switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":var i=new MWF.widget.O2Identity(t,e,s);break;case"@p":i=new MWF.widget.O2Person(t,e,s);break;case"@u":i=new MWF.widget.O2Unit(t,e,s);break;case"@g":i=new MWF.widget.O2Group(t,e,s);break;default:i=new MWF.widget.O2Other(t,e,s)}i.field=this,layout.mobile&&i.node.setStyles({float:"none"})}}.bind(this))},removeItem:function(t,e){var i,s=this.field,o=this.data.distinguishedName,n=s._getBusinessData();n.each((function(t,e){t.distinguishedName==o&&(i=e)})),n.splice(i,1),s._setBusinessData(n),this.node.destroy(),e.stopPropagation()},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(t){this.validationMode();var e=this.json.count?this.json.count:0,i="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],s=this.selectUnits;if(!i[0])return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectType,"error",this.node),!1;var o=[];if(this.json.exclude){var n=this.form.Macro.exec(this.json.exclude.code,this);o="array"===typeOf(n)?n:[n]}var a={type:"",types:i,values:this.json.isInput?[]:this._getBusinessData(),count:e,units:s,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,exclude:o,expandSubEnable:"no"!=this.json.expandSubEnable,onComplete:function(t,e){var i=[];t.each((function(t){i.push(MWF.org.parseOrgData(t.data))})),this.json.isInput?this.addData(i):this.setData(i),this.validation(),this.fireEvent("select")}.bind(this),onCancel:function(){this.validation()}.bind(this),onLoad:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),onClose:function(){var t=this.getInputData();t&&t.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)};this.form.json.selectorStyle&&(a=Object.merge(a,this.form.json.selectorStyle)),this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,a))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}}}),MWF.xApplication.process.Xform=MWF.xApplication.process.Xform||{},MWF.xApplication.process.Xform.Package=!0,MWF.require("MWF.xScript.Macro",null,!1),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.require=function(t){MWF.xDesktop.requireApp([["process.Xform","Label"],["process.Xform","Textfield"],["process.Xform","Number"],["process.Xform","Personfield"],["process.Xform","Orgfield"],["process.Xform","Org"],["process.Xform","Calendar"],["process.Xform","Textarea"],["process.Xform","Opinion"],["process.Xform","Select"],["process.Xform","Radio"],["process.Xform","Checkbox"],["process.Xform","Button"],["process.Xform","Combox"],["process.Xform","Address"],["process.Xform","Table"],["process.Xform","Datagrid"],["process.Xform","Datatable"],["process.Xform","Datatemplate"],["process.Xform","Tab"],["process.Xform","Tree"],["process.Xform","Iframe"],["process.Xform","Htmleditor"],["process.Xform","Office"],["process.Xform","IWebOffice"],["process.Xform","Attachment"],["process.Xform","Actionbar"],["process.Xform","Sidebar"],["process.Xform","Log"],["process.Xform","Monitor"],["process.Xform","View"],["process.Xform","ViewSelector"],["process.Xform","Stat"],["process.Xform","ImageClipper"],["process.Xform","Subform"],["process.Xform","Widget"],["process.Xform","Source"],["process.Xform","SourceText"],["process.Xform","SubSource"],["process.Xform","Div"],["process.Xform","Common"],["process.Xform","Image"],["process.Xform","Html"],["process.Xform","Statement"],["process.Xform","StatementSelector"],["process.Xform","Importer"],["process.Xform","ReadLog"]],null,(function(){t&&t()}))},MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.require("MWF.widget.UUID",null,!1),MWF.xApplication.process.Xform.Radio=MWF.APPRadio=new Class({Implements:[Events],Extends:MWF.APP$Input,loadDescription:function(){},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){for(var i="",s=0;s<t.length;s++){var o=t[s].split("|"),n=o[0];if(e==(o[1]||n)){i=n;break}}this.node.set("text",i)}},_resetNodeEdit:function(){var t=new Element("div");t.set(this.json.properties),t.inject(this.node,"after"),this.node.destroy(),this.node=t},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.set({id:this.json.id,MWFType:this.json.type,styles:{display:"inline"}}),this.setOptions()},_loadDomEvents:function(){},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!=this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.getElements("input").each(function(i){i.addEvent(t,function(t){return e?e(this,t):null}.bind(this))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions()},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript.code,this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){if(this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)){var e=(new MWF.widget.UUID).toString();t.each(function(t){var i=t.split("|"),s=i[0],o=i[1]||s,n=new Element("input",{type:"radio",name:this.json.properties&&this.json.properties.name?this.json.properties.name:e+this.json.id,value:o,showText:s,styles:this.json.buttonStyles}).inject(this.node);new Element("span",{text:s,styles:{cursor:"default"}}).inject(this.node).addEvent("click",function(t){!0!==this.radio.get("disabled")&&"true"!==this.radio.get("disabled")&&(this.radio.checked=!0,this.radio.fireEvent("change"),this.radio.fireEvent("click"))}.bind({radio:n})),n.addEvent("click",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this)),Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)||n.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))}.bind(this))}}.bind(this),function(){this.moduleSelectAG=null}.bind(this));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return"array"==o2.typeOf(t)&&(t=t[0]),this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){this._setBusinessData(t);for(var e=this.node.getElements("input"),i=0;i<e.length;i++){var s=e[i];if(s.value==t){s.checked=!0;break}}},getTextData:function(){var t=this.node.getElements("input"),e="",i="";if(t.length)for(var s=0;s<t.length;s++){var o=t[s];if(o.checked){e=o.get("value"),i=o.get("showText");break}}return{value:[e]||"",text:[i||e||""]}},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("input"),e="";if(t.length)for(var i=0;i<t.length;i++){var s=t[i];if(s.checked){e=s.get("value");break}}return e},resetData:function(){this.setData(this.getValue())},getSelectedInput:function(){var t=this.node.getElements("input");if(t.length)for(var e=0;e<t.length;e++)if(t[e].checked)return t[e];return null},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){this._setBusinessData(t);var e=this.node.getElements("input");if(e.length){for(var i=0;i<e.length;i++)t==e[i].get("value")?e[i].set("checked",!0):e[i].set("checked",!1);this.validationMode()}this.fireEvent("setData")},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("background",this.node.getStyles("background")),this.node.setStyle("background","#ffdcdc"),this.errNode=this.createErrorNode(t),this.iconNode?this.errNode.inject(this.iconNode,"after"):this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},validationMode:function(t,e){if(!this.validationConfig(t,e))return!1;this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("background")),this.errNode&&(this.errNode.destroy(),this.errNode=null))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.ReadLog=MWF.APPReadLog=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","postLoadData","postLoadLine"]},load:function(){this.node.empty(),this.json.isDelay||this.active()},active:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._loadDomEvents(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){this.node.setStyle("-webkit-user-select","text"),this.form.app.action.getReadRecord(this.form.businessData.work.id,function(t){this.readLog=t.data,this.fireEvent("postLoadData"),this.loadReadLog()}.bind(this))},loadReadLog:function(){switch(this.json.mode){case"notShow":return"";case"script":this.loadReadLogByScript();break;default:this.loadReadLogDefault()}},loadReadLogByScript:function(){if(this.json.displayScript&&this.json.displayScript.code){var t=this.json.displayScript.code;this.readLog.each(function(e){this.form.Macro.environment.log=e,this.form.Macro.environment.list=null;var i=this.form.Macro.exec(t,this),s=o2.typeOf(i);"string"===s?this.node.appendHTML(i):"element"===s&&this.node.appendChild(i)}.bind(this))}},loadReadLogDefault:function(){var t=this.json.textStyle;this.readLog.each(function(e){if("readCompleted"==e.type){var i=t.replace(/{person}/g,o2.name.cn(e.person)).replace(/{datetime}/g,e.completedTime).replace(/{date}/g,e.completedTime.substring(.1)).replace(/{startDatetime}/g,e.startTime).replace(/{startDate}/g,e.startTime.substring(.1)).replace(/{startDatetime}/g,e.startTime).replace(/{unit}/g,o2.name.cn(e.unit)).replace(/{identity}/g,o2.name.cn(e.identity)).replace(/{activity}/g,o2.name.cn(e.activityName)).replace(/{title}/g,e.title).replace(/{opinion}/g,e.opinion);this.node.appendHTML(i)}}.bind(this))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Select=MWF.APPSelect=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"selectIcon",initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){"array"!==typeOf(e)&&(e=[e]);var i=[];t.each((function(t){var s=t.split("|"),o=s[0],n=s[1]||o;n&&-1!=e.indexOf(n)&&i.push(o)})),this.node.set("text",i.join(", "))}},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadStyles:function(){this.areaNode?(this.json.styles&&this.areaNode&&this.areaNode.setStyles(this.json.styles),this.json.inputStyles&&this.node.setStyles(this.json.inputStyles)):this.json.styles&&this.node.setStyles(this.json.styles)},_resetNodeEdit:function(){this.node.empty();var t=new Element("select");t.set(this.json.properties),t.inject(this.node)},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();this.areaNode=this.node,this.node=t,this.node.set({id:this.json.id,MWFType:this.json.type,styles:{"margin-right":"12px"}}),this.setOptions(),this.node.addEvent("change",function(){var t=this.getInputData("change");this._setBusinessData(t),this.validationMode(),this.validation()&&(this._setBusinessData(t),this.fireEvent("change"))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions(),this.fireEvent("resetOption")},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)&&(t.each(function(t){var e=t.split("|"),i=e[0],s=e[1]||i;new Element("option",{value:s,text:i}).inject(this.node)}.bind(this)),this.fireEvent("setOptions",[t]))}.bind(this),function(){this.moduleSelectAG=null}.bind(this));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},addOption:function(t,e){new Element("option",{value:e||t,text:t}).inject(this.node);this.fireEvent("addOption",[t,e])},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return"array"==o2.typeOf(t)&&(t=t[0]),this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){if(!this.readonly&&!this.json.isReadonly){this._setBusinessData(t);for(var e=this.node.getElements("option"),i=0;i<e.length;i++){var s=e[i];s.value==t?s.selected=!0:s.selected=!1}}this.moduleValueAG=null},getTextData:function(){var t=[],e=[];if(this.readonly||this.json.isReadonly){var i=this.getOptionsObj(),s=this._getBusinessData();("array"===typeOf(s)?s:[s]).each((function(s){var o=i.valueList.indexOf(s);t.push(s||""),e.push(o>-1?i.textList[o]:s||"")}))}else{(i=this.node.getElements("option")).each((function(i){if(i.selected){var s=i.get("value"),o=i.get("text");t.push(s||""),e.push(o||s||"")}}))}return t.length||(t=[""]),e.length||(e=[""]),{value:t,text:e}},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("option"),e=[];return t.each((function(t){if(t.selected){var i=t.get("value");i&&e.push(i)}})),e.length?1==e.length?e[0]:e:null},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){if(this._setBusinessData(t),this.readonly||this.json.isReadonly){var e="array"===typeOf(t)?t:[t],i=this.getOptionsObj(),s=[];e.each((function(t){var e=i.valueList.indexOf(t);s.push(e>-1?i.textList[e]:t)})),this.node.set("text",s.join(","))}else{(i=this.node.getElements("option")).each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("selected",!0):e.set("selected",!1):t==e.get("value")?e.set("selected",!0):e.set("selected",!1)})),this.validationMode()}this.fireEvent("setData",[t])}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Sidebar=MWF.APPSidebar=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.setStyles(this.form.css.sidebar),this.toolbarNode=this.node.getFirst("div"),this.toolbarNode.empty(),this.form.businessData.task&&MWF.require("MWF.widget.Toolbar",function(){var t=[];if((this.getRouteNameList()||[]).each(function(e,i){this.json.defaultTools||(this.json.defaultTools=[]);var s={type:"MWFToolBarButton",img:"submit.png",title:e.displayName,action:"processWork:"+e.routeName,text:e.displayName,id:"action_processWork",control:"allowProcessing",condition:"",read:!1};t.push(s)}.bind(this)),this.json.defaultTools=t.concat(this.json.defaultTools),this.toolbarWidget=new MWF.widget.Toolbar(this.toolbarNode,{style:this.json.style},this),this.json.hideSystemTools?this.json.tools.length?(this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):this.toolbarNode.setStyle("display","none"):this.json.defaultTools.length||this.json.tools.length?this.json.defaultTools?(this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()):MWF.getJSON(this.form.path+"toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),!1):this.toolbarNode.setStyle("display","none"),this.toolbarWidget.children.length){this.node.setStyle("display","none"),window.setTimeout(this.loadPosition.bind(this),500);var e=this;this.form.app.content.getFirst().addEvent("scroll",(function(t){e.loadPosition(this)})),this.form.app.addEvent("resize",(function(t){e.loadPosition(this)}))}else this.toolbarNode.setStyle("display","none")}.bind(this))},loadPosition:function(){this.node.setStyle("display","block");for(var t=this.node.getParent();t&&!t.get("MWFtype");)t=t.getParent();this.sideNode=t||this.form.node;var e=this.form.app.content.getSize(),i=this.sideNode.getSize(),s=this.sideNode.getPosition(this.sideNode.getOffsetParent()),o=this.node.getSize();if(i.y>e.y){var n=e.y/2-o.y/2;if(n<s.y)this.node.setStyle("top",s.y+"px");else if(n>s.y+i.y){var a=s.y+i.y-o.y;this.node.setStyle("top",a+"px")}else this.node.setStyle("top",n+"px")}else{var r=s.y+i.y/2-o.y/2;if(r>e.y)if(s.y+o.y>e.y)this.node.setStyle("top",s.y+"px");else{a=e.y-o.y;this.node.setStyle("top",a+"px")}else if(r<=0)if(s.y+i.y<o.y){a=s.y+i.y-o.y;this.node.setStyle("top",a+"px")}else this.node.setStyle("top","45px");else this.node.setStyle("top",r+"px")}var l=i.x+s.x+5;this.node.setStyle("left",l+"px"),this.node.setStyle("position","absolute"),this.node.setStyles({right:"auto",bottom:"auto"})},setCustomToolbars:function(t,e){t.each(function(t){var i=!0;if(i=this.readonly?t.readShow:t.editShow){if(i=!0,t.control&&(i=this.form.businessData.control[t.control]),t.condition)i=!this.form.Macro.exec(t.condition,this);if(i){var s=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:"../x_component_process_FormDesigner/Module/Actionbar/"+(this.form.options.style||"default")+"/custom/"+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(e);if(t.actionScript&&s.store("script",t.actionScript),t.sub){var o=e.getLast();this.setCustomToolbars(t.sub,o)}}}}.bind(this))},setToolbars:function(t,e,i,s){t.each(function(t){var o=!0;(t.control&&(o=this.form.businessData.control[t.control]),!s&&t.condition)&&(o=!this.form.Macro.exec(t.condition,this));if("action_processWork"==t.id&&(this.form.businessData.task||(o=!1)),i&&(t.read||(o=!1)),o){new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:"../x_component_process_FormDesigner/Module/Actionbar/"+(this.form.options.style||"default")+"/tools/default/"+t.img,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(e);if(t.sub){var n=e.getLast();this.setToolbars(t.sub,n,i,s)}}}.bind(this))},getRouteNameList:function(t){var e=[];return t||(t=this.getRouteDataList()),t.each(function(t,i){if(!(t.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString())){var s=t.name;t.displayNameScriptText&&this.form&&this.form.Macro&&(s=this.form.Macro.exec(t.displayNameScriptText,this)),e.push({routeId:t.id,displayName:s,routeName:t.name})}}.bind(this)),e},getRouteDataList:function(){return this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.form.businessData.task.routeList},function(t){t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1),this.routeDataList},getRouteData:function(t){for(var e=this.getRouteDataList(),i=0;i<e.length;i++)if(e[i].id===t)return e[i]},runCustomAction:function(t){var e=t.node.retrieve("script");this.form.Macro.exec(e,this)},saveWork:function(){this.form.saveWork()},closeWork:function(){this.form.closeWork()},processWork:function(t){if(opinion=this.form.getOpinion(),!this.form.formCustomValidation())return this.form.app.content.unmask(),!1;this.form.submitWork(t,opinion.opinion,opinion.medias)},resetWork:function(){this.form.resetWork()},retractWork:function(t,e){this.form.retractWork(t,e)},rerouteWork:function(t,e){this.form.rerouteWork(t,e)},deleteWork:function(){this.form.deleteWork()},printWork:function(){this.form.printWork()}}),MWF.xDesktop.requireApp("process.Xform","Div",null,!1),MWF.xApplication.process.Xform.Source=MWF.APPSource=new Class({Extends:MWF.APPDiv,options:{moduleEvents:["queryLoad","postLoad","load","postLoadData","loadData"]},_loadUserInterface:function(){this.data=null,this.json.path&&"o2"==this.json.sourceType&&this.json.path&&this._getO2Source()},_getO2Address:function(){try{this.json.service=JSON.parse(this.json.contextRoot)}catch(t){this.json.service={root:this.json.contextRoot,action:"",method:"",url:""}}var t=layout.serviceAddressList[this.json.service.root];if(t)this.address=layout.config.app_protocol+"//"+t.host+(80==t.port?"":":"+t.port)+t.context;else{var e=layout.desktop.centerServer.host||window.location.hostname,i=layout.desktop.centerServer.port;this.address=layout.config.app_protocol+"//"+e+("80"==i?"":":"+i)+"/x_program_center"}},_getO2Uri:function(){var t=this.json.path,e={};this.json.parameters&&Object.each(this.json.parameters,function(i,s){if(-1!=t.indexOf("{"+s+"}")){var o=new RegExp("{"+s+"}","g");t=t.replace(o,encodeURIComponent(i&&i.code?this.form.Macro.exec(i.code,this)||"":i))}else e[s]=i}.bind(this));var i=null;if(this.json.requestBody&&this.json.requestBody.code&&(i=this.form.Macro.exec(this.json.requestBody.code,this)),"GET"==this.json.httpMethod||"OPTIONS"==this.json.httpMethod||"HEAD"==this.json.httpMethod||"DELETE"==this.json.httpMethod){var s="?";-1!=t.indexOf("?")&&(s="&"),Object.each(e,function(e,i){var o=e&&e.code?this.form.Macro.exec(e.code,this)||"":e;t=t+s+i+"="+o}.bind(this))}else Object.each(e,function(t,e){i||(i={});var s=t&&t.code?this.form.Macro.exec(t.code,this)||"":t;i[e]=s}.bind(this));this.body=i,this.uri=this.address+t},_getO2Source:function(){this._getO2Address(),this._getO2Uri(),this._invoke(function(){this._loadSub(this.node),this.fireEvent("loadData")}.bind(this))},_invoke:function(t){MWF.restful(this.json.httpMethod,this.uri,JSON.encode(this.body),function(e){this.data=e,this.fireEvent("postLoadData"),t&&t()}.bind(this),!0,!0)},setBody:function(t){this.body=t},setParameters:function(t){this.json.parameters=t,this._getO2Address(),this._getO2Uri()},addParameters:function(t){this.json.parameters||(this.json.parameters={}),Object.each(t,function(t,e){this.json.parameters[e]=t}.bind(this)),this._getO2Address(),this._getO2Uri()},reload:function(t,e){this._getO2Uri(),this._invoke(function(){this._loadSub(this.node,t),this.fireEvent("loadData"),e&&e()}.bind(this))},_loadSub:function(t,e){for(var i=t.getFirst(),s=null;i;)s=null,(s=i.retrieve("module",null))?s._loadJsonData&&s._loadJsonData(e):this._loadSub(i),i=i.getNext()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.SourceText=MWF.APPSourceText=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this._loadJsonData()},_getSource:function(){for(var t=this.node.getParent();t&&"source"!=t.get("MWFtype")&&"subSource"!=t.get("MWFtype")&&"subSourceItem"!=t.get("MWFtype");)t=t.getParent();return t?t.retrieve("module"):null},_loadJsonData:function(){this.node.set("text",""),this.source=this._getSource(),this.source&&this.source.data&&COMMON.AjaxModule.load("JSONTemplate",function(){this.template=new Template,this.text=this.template.substitute("{"+this.json.jsonPath+"}",this.source.data),this.json.jsonText&&this.json.jsonText.code?(this.text=this.form.Macro.exec(this.json.jsonText.code,this),"string"===typeOf(this.text)&&this.node.set("text",this.text)):this.node.set("text",this.text)}.bind(this))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Stat=MWF.APPStat=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","loadStat"]},_loadUserInterface:function(){this.node.empty()},_afterLoaded:function(){this.node.setStyle("min-height","100px"),this.loadStat()},active:function(){this.stat&&this.stat.loadStatData()},reload:function(){this.active()},loadStat:function(){if(this.json.queryStat){var t={application:this.json.queryStat.appName,statName:this.json.queryStat.name,isChart:"no"!=this.json.isChart,isLegend:"no"!=this.json.isLegend,isTable:"no"!=this.json.isTable};MWF.xDesktop.requireApp("query.Query","Statistician",function(){this.stat=new MWF.xApplication.query.Query.Statistician(this.form.app,this.node,t,{resizeNode:"auto"!==this.node.getStyle("height").toString().toLowerCase()&&this.node.getStyle("height").toInt()>0,onLoaded:function(){this.fireEvent("loadStat")}.bind(this)})}.bind(this))}},getData:function(){return this.stat&&this.stat.stat?this.stat.stat.data:null}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Statement=MWF.APPStatement=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","beforeLoadView","loadView","queryLoad","postLoad","select","openDocument"]},_loadUserInterface:function(){MWF.xDesktop.requireApp("query.Query","Statement",null,!1),this.node.empty()},_afterLoaded:function(){this.json.queryStatement&&this.loadView()},reload:function(){this.view&&(this.view.loadViewRes&&this.view.loadViewRes.res&&this.view.loadViewRes.res.isRunning()&&this.view.loadViewRes.res.cancel(),this.view.getViewRes&&this.view.getViewRes.res&&this.view.getViewRes.res.isRunning()&&this.view.getViewRes.res.cancel()),this.node.empty(),this.loadView()},active:function(){this.view?this.view.loadingAreaNode||this.view.loadView():this.loadView()},loadView:function(){if(!this.json.queryStatement)return"";var t=null;this.json.filterList&&this.json.filterList.length&&(t=[],this.json.filterList.each(function(e){e.value=this.form.Macro.exec(e.code.code,this),t.push(e)}.bind(this)));var e={application:this.json.queryStatement?this.json.queryStatement.appName:this.json.application,statementName:this.json.queryStatement?this.json.queryStatement.name:this.json.statementName,statementId:this.json.queryStatement?this.json.queryStatement.id:this.json.statementId,isTitle:this.json.isTitle||"yes",select:this.json.select||"none",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:t,defaultSelectedScript:this.json.defaultSelectedScript?this.json.defaultSelectedScript.code:null,selectedAbleScript:this.json.selectedAbleScript?this.json.selectedAbleScript.code:null};this.fireEvent("beforeLoadView",[e]),this.view=new MWF.xApplication.query.Query.Statement(this.node,e,{isload:"no"!==this.json.loadView,resizeNode:"auto"!==this.node.getStyle("height").toString().toLowerCase()&&this.node.getStyle("height").toInt()>0,onLoadView:function(){this.fireEvent("loadView")}.bind(this),onSelect:function(){this.fireEvent("select")}.bind(this),onOpenDocument:function(t,e){this.openOptions={options:t,item:e},this.fireEvent("openDocument"),this.openOptions=null}.bind(this)},this.form.app,this.form.Macro)},getData:function(){if(this.view.selectedItems.length){var t=[];return this.view.selectedItems.each((function(e){t.push(e.data)})),t}return[]}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","ViewSelector",null,!1),MWF.xApplication.process.Xform.StatementSelector=MWF.APPStatementSelector=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.ViewSelector,doResult:function(t){if("script"===this.json.result)return this.selectedData=t,this.json.selectedScript.code?this.form.Macro.exec(this.json.selectedScript.code,this):"";Object.each(this.json.selectedSetValues,function(e,i){var s="";t.each(function(t,i){for(var o=e.split("."),n=0;n<o.length;n++){var a=o[n];if(/(^[1-9]\d*$)/.test(a)&&(a=a.toInt()),!t[a]){t="";break}t=t[a]}"array"!==typeOf(t)&&"object"!==typeOf(t)||(t=JSON.stringify(t)),s=s?s+", "+t:t}.bind(this));var o=this.form.all[i];o&&(o.setData(s),s?o.descriptionNode&&o.descriptionNode.setStyle("display","none"):o.descriptionNode&&o.descriptionNode.setStyle("display","block"))}.bind(this))},selectView:function(t){var e=this.json.queryStatement;if(e){var i=null;this.json.filterList&&this.json.filterList.length&&(i=[],this.json.filterList.each(function(t){t.value=this.form.Macro.exec(t.code.code,this),i.push(t)}.bind(this)));var s={application:e.appName,statementName:e.name,statementId:e.id,isTitle:this.json.isTitle||"yes",select:this.json.select||"single",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:i,defaultSelectedScript:this.json.defaultSelectedScript?this.json.defaultSelectedScript.code:null,selectedAbleScript:this.json.selectedAbleScript?this.json.selectedAbleScript.code:null},o={},n=this.json.DialogWidth||"850",a=this.json.DialogHeight||"700";if(layout.mobile){var r=document.body.getSize();n=r.x,a=r.y,o.style="viewmobile"}n=n.toInt(),a=a.toInt();var l=((r=this.form.app.content.getSize()).x-n)/2,h=(r.y-a)/2;l<0&&(l=0),h<0&&(h=0),layout.mobile&&(l=20,h=0);var d=this;MWF.require("MWF.xDesktop.Dialog",function(){var e=new MWF.xDesktop.Dialog({title:this.json.title||"select view",style:o.style||"view",top:h,left:l-20,fromTop:h,fromLeft:l-20,width:n,height:a,html:"",maskNode:layout.mobile?$(document.body):this.form.app.content,container:layout.mobile?$(document.body):this.form.app.content,buttonList:[{text:MWF.LP.process.button.ok,action:function(){t&&t(d.view.getData()),this.close()}},{text:MWF.LP.process.button.cancel,action:function(){this.close()}}],onPostShow:function(){layout.mobile&&e.node.setStyle("z-index",200),MWF.xDesktop.requireApp("query.Query","Statement",function(){this.view=new MWF.xApplication.query.Query.Statement(e.content,s,{style:"select"},this.form.app,this.form.Macro)}.bind(this))}.bind(this)});if(e.show(),layout.mobile){var i=e.node.getElement(".MWF_dialod_Action_back"),r=e.node.getElement(".MWF_dialod_Action_ok");i&&i.addEvent("click",function(t){e.close()}.bind(this)),r&&r.addEvent("click",function(i){t&&t(this.view.getData()),e.close()}.bind(this))}}.bind(this))}}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.SubSource=MWF.APPSubSource=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["queryLoad","postLoad","load","postLoadData","loadData"]},load:function(){this._loadModuleEvents(),this._queryLoaded(),this._loadUserInterface(),this._loadDomEvents(),this._afterLoaded()},_loadUserInterface:function(){this.loopNodes=[],this.subSourceItems=[];var t=new Element("div").inject(this.node,"before");this.node.inject(t),this.loopNode=this.node.dispose(),this.node=t;var e=t.get("id");t.set("id",""),this.node.set({id:e,mwftype:t.get("mwftype")}),this.node.store("module",this),this._loadJsonData()},_getSource:function(){for(var t=this.node.getParent();t&&"source"!=t.get("MWFtype")&&"subSource"!=t.get("MWFtype")&&"subSourceItem"!=t.get("MWFtype");)t=t.getParent();return t?t.retrieve("module"):null},_getSourceData:function(t){var e=t;"."!=this.json.jsonPath&&this.json.jsonPath.split(".").each(function(t){e=e[t]}.bind(this));this.data=e},_loopSub:function(t,e){this.form._getModuleNodes(t).each(function(t){var i=this.form._getDomjson(t),s=Object.clone(i);s.id=s.id+"_"+e,t.set("id",s.id);this.form._loadModule(s,t)}.bind(this))},_loopData:function(){this.data.each(function(t,e){var i=this.loopNode.clone(!0,!0);i.inject(this.node);var s=Object.clone(this.json);s.id=s.id+"_"+e,s.type="SubSourceItem",i.set({id:s.id,mwftype:"subSourceItem"});var o=this.form._loadModule(s,i,(function(){this.data=t,this.position=e}));this.subSourceItems.push(o),this.loopNodes.push(i),this._loopSub(i,e)}.bind(this))},_initSubSource:function(){this.loopNode&&(this.form._getModuleNodes(this.node).each(function(t){var e=t.retrieve("module");e&&("SubSource"==e.json.type?e._initSubSource():MWF.release(e))}.bind(this)),this.node.empty());this.loopNodes=[],this.subSourceItems=[]},_loadJsonData:function(t){t||this._initSubSource(),this.source=this._getSource(),this.source&&this.source.data&&(this._getSourceData(this.source.data),this.fireEvent("postLoadData"),"array"!==typeOf(this.data)&&(this.data=[this.data]),"array"==typeOf(this.data)?(this._loopData(),this.fireEvent("loadData")):this.form._loadModules(this.node))}}),MWF.xApplication.process.Xform.SubSourceItem=MWF.APPSubSourceItem=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.loopNodes=[],this.subSourceItems=[]}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Subform=MWF.APPSubform=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.modules=[],this.moduleList={},this.json.isDelay?(this.form.subformLoadedCount?this.form.subformLoadedCount++:this.form.subformLoadedCount=1,this.form.checkSubformLoaded(),this.checked=!0):this.getSubform(function(){this.loadSubform()}.bind(this))},active:function(t){this.loaded?t&&t():this.reload(t)},reload:function(t){this.clean(),this.getSubform(function(){this.loadSubform(),t&&t()}.bind(this))},clean:function(){if((this.modules||[]).each(function(t){this.form.modules.erase(t)}.bind(this)),Object.each(this.moduleList||{},function(t,e){delete this.form.json.moduleList[e]}.bind(this)),this.subformData&&this.subformData.json.id){var t=this.subformData.json.id;this.form.subformLoaded&&this.form.subformLoaded.length&&this.form.subformLoaded.erase(t),this.parentformIdList&&this.parentformIdList.length&&this.parentformIdList.erase(t)}this.modules=[],this.moduleList={},this.node.empty()},loadCss:function(){if(this.subformData.json.css&&this.subformData.json.css.code){for(var t,e=this.form.parseCSS(this.subformData.json.css.code),i=new RegExp("(.+)(?=\\{)","g"),s=this.form.json.id.replace(/\-/g,"");null!==(t=i.exec(e));){var o=".css"+s+" ",n=o+t[0];e=e.substring(0,t.index)+n+e.substring(i.lastIndex,e.length),i.lastIndex=i.lastIndex+o.length}var a;if(!(a=$("style"+this.form.json.id)))(a=document.createElement("style")).setAttribute("type","text/css"),a.id="style"+this.form.json.id,a.inject(this.form.container,"before");if(a.styleSheet){var r=function(){a.styleSheet.cssText+=e};a.styleSheet.disabled?setTimeout(r,10):r()}else{var l=document.createTextNode(e);a.appendChild(l)}}},checkSubformNested:function(t){return!t||(this.parentformIdList?!this.parentformIdList.contains(t):![this.form.json.id].contains(t))},checkSubformUnique:function(t){return!t||(!this.form.subformLoaded||!this.form.subformLoaded.contains(t))},getParentformIdList:function(){var t;return this.parentformIdList?(t=Array.clone(this.parentformIdList)).push(this.subformData.json.id):t=[this.form.json.id,this.subformData.json.id],t},loadSubform:function(){if(this.subformData)if(this.checkSubformNested(this.subformData.json.id))if(this.checkSubformUnique(this.subformData.json.id)){this.loadCss(),this.modules=[],this.moduleList={},this.node.set("html",this.subformData.html),Object.each(this.subformData.json.moduleList,function(t,e){var i=e;if(this.form.json.moduleList[e]){i=this.json.id+"_"+e;var s=this.node.getElement("#"+e);s&&s.set("id",i),t.id=i}this.form.json.moduleList[i]=t,this.moduleList[i]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t),s=this.form._loadModule(i,t,(function(){this.parentformIdList=e.getParentformIdList()}));this.form.modules.push(s),this.modules.push(s)}}.bind(this)),this.form.subformLoaded.push(this.subformData.json.id)}else this.form.notice(MWF.xApplication.process.Xform.LP.subformUniqueError,"error");else this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError,"error");this.checked||(this.form.subformLoadedCount?this.form.subformLoadedCount++:this.form.subformLoadedCount=1,this.form.checkSubformLoaded()),this.loaded=!0,this.checked=!0},getSubform:function(t){var e="Mobile"===this.form.json.mode||layout.mobile?"getFormMobile":"getForm";if("script"===this.json.subformType){if(this.json.subformScript&&this.json.subformScript.code){var i,s=this.form.Macro.exec(this.json.subformScript.code,this);if(s)"string"===typeOf(s)?i=s:(s.application&&(o=s.application),s.subform&&(i=s.subform)),i?(o||(o=(this.form.businessData.work||this.form.businessData.workCompleted).application),MWF.Actions.get("x_processplatform_assemble_surface")[e](i,o,function(e){this.getSubformData(e.data),t&&t()}.bind(this))):t&&t();else t&&t()}}else if(this.json.subformSelected&&"none"!==this.json.subformSelected){var o,n=this.form.app.relatedFormMap?this.form.app.relatedFormMap[this.json.subformSelected]:null;if(n)this.getSubformData({data:n.data}),t&&t();else o=this.json.subformAppSelected?this.json.subformAppSelected:(this.form.businessData.work||this.form.businessData.workCompleted).application,MWF.Actions.get("x_processplatform_assemble_surface")[e](this.json.subformSelected,o,function(e){this.getSubformData(e.data),t&&t()}.bind(this))}else t&&t()},getSubformData:function(t){if(t&&"object"===typeOf(t)){var e;if(e=t.data,this.subformData=null,e){var i=o2.bindJson(MWF.decodeJsonString(e),{lp:MWF.xApplication.process.Xform.LP.form});this.subformData=JSON.decode(i),this.subformData.updateTime=t.updateTime}}}}),MWF.xApplication.process.Xform.SubmitForm=MWF.APPSubmitform=new Class({Extends:MWF.APPSubform,_loadUserInterface:function(){this.getSubform(function(){this.loadSubform()}.bind(this))},reload:function(){this.getSubform(function(){this.loadSubform()}.bind(this))},show:function(){this.json.submitScript&&this.json.submitScript.code&&this.form.Macro.exec(this.json.submitScript.code,this)},loadSubform:function(){if(this.subformData)if(this.checkSubformUnique(this.subformData.json.id))if(this.checkSubformNested(this.subformData.json.id)){this.loadCss(),this.node.set("html",this.subformData.html),Object.each(this.subformData.json.moduleList,function(t,e){var i=e;if(this.form.json.moduleList[e]){i=this.json.id+"_"+e;var s=this.node.getElement("#"+e);s&&s.set("id",i),t.id=i}this.form.json.moduleList[i]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t),s=this.form._loadModule(i,t,(function(){this.parentformIdList=e.getParentformIdList()}));this.form.modules.push(s)}}.bind(this)),this.form.subformLoaded.push(this.subformData.json.id),this.fireEvent("afterModulesLoad")}else this.form.notice(MWF.xApplication.process.Xform.LP.subformNestedError,"error");else this.isEmbedded=!0,this.fireEvent("afterModulesLoad")},getSubform:function(t){var e="Mobile"===this.form.json.mode||layout.mobile?"getFormMobile":"getForm";if("script"===this.json.submitFormType){if(this.json.submitFormScript&&this.json.submitFormScript.code){var i,s,o=this.form.Macro.exec(this.json.submitFormScript.code,this);if(o)"string"===typeOf(o)?i=o:(o.application&&(s=o.application),o.form&&(i=o.form)),i?(s||(s=(this.form.businessData.work||this.form.businessData.workCompleted).application),MWF.Actions.get("x_processplatform_assemble_surface")[e](i,s,function(e){this.getSubformData(e.data),t&&t()}.bind(this))):t&&t();else t&&t()}}else this.json.submitFormSelected&&"none"!==this.json.submitFormSelected?(s=this.json.submitFormAppSelected?this.json.submitFormAppSelected:(this.form.businessData.work||this.form.businessData.workCompleted).application,MWF.Actions.get("x_processplatform_assemble_surface")[e](this.json.submitFormSelected,s,function(e){this.getSubformData(e.data),t&&t()}.bind(this))):t&&t()}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Subpage=MWF.APPSubpage=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.modules=[],this.moduleList={},this.getSubpage(function(){this.loadSubpage()}.bind(this))},reload:function(){this.clean(),this.getSubpage(function(){this.loadSubpage()}.bind(this))},clean:function(){if((this.modules||[]).each(function(t){this.form.modules.erase(t)}.bind(this)),Object.each(this.moduleList||{},function(t,e){delete this.form.json.moduleList[e]}.bind(this)),this.subpageData&&this.subpageData.json.id){var t=this.subpageData.json.id;this.parentpageIdList&&this.parentpageIdList.length&&this.parentpageIdList.erase(t)}this.json.id&&this.form.subpageModules&&this.form.subpageModules[this.json.id]&&(this.form.subpageModules[this.json.id]={}),this.modules=[],this.moduleList={},this.node.empty()},loadCss:function(){if(this.subpageData.json.css&&this.subpageData.json.css.code){for(var t,e=this.form.parseCSS(this.subpageData.json.css.code),i=new RegExp("(.+)(?=\\{)","g"),s=this.form.json.id.replace(/\-/g,"");null!==(t=i.exec(e));){var o=".css"+s+" ",n=o+t[0];e=e.substring(0,t.index)+n+e.substring(i.lastIndex,e.length),i.lastIndex=i.lastIndex+o.length}var a;if(!(a=$("style"+this.form.json.id)))(a=document.createElement("style")).setAttribute("type","text/css"),a.id="style"+this.form.json.id,a.inject(this.form.container,"before");if(a.styleSheet){var r=function(){a.styleSheet.cssText+=e};a.styleSheet.disabled?setTimeout(r,10):r()}else{var l=document.createTextNode(e);a.appendChild(l)}}},checkSubpageNested:function(t){return this.parentpageIdList?!this.parentpageIdList.contains(t):![this.form.json.id].contains(t)},getParentpageIdList:function(){var t;return this.parentpageIdList?(t=Array.clone(this.parentpageIdList)).push(this.subpageData.json.id):t=[this.form.json.id,this.subpageData.json.id],t},loadSubpage:function(){if(this.subpageData)if(this.checkSubpageNested(this.subpageData.json.id)){this.loadCss(),this.form.subpageModules=this.form.subpageModules||{};var t=this.form.subpageModules[this.json.id]={},e=this.getPageParamenters();if("object"===typeOf(e)&&this.form.Macro&&this.form.Macro.environment){var i=this.form.Macro.environment;i.subpageParameters=i.subpageParameters||{},i.subpageParameters[this.json.id]=e}this.node.set("html",this.subpageData.html),Object.each(this.subpageData.json.moduleList,function(t,e){var i=e;if(this.form.json.moduleList[e]){i=this.json.id+"_"+e;var s=this.node.getElement("#"+e);s&&s.set("id",i),t.orgiginalId=e,t.id=i}this.form.json.moduleList[i]=t,this.moduleList[i]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(e){if("form"!==e.get("MWFtype")){var i=this,s=this.form._getDomjson(e),o=this.form._loadModule(s,e,(function(){this.subpage=i,this.parentpageIdList=i.getParentpageIdList()}));this.form.modules.push(o),this.modules.push(o),t[s.orgiginalId||s.id]=o}}.bind(this))}else this.form.notice(MWF.xApplication.process.Xform.LP.subpageNestedError,"error");this.form.subpageLoadedCount?this.form.subpageLoadedCount++:this.form.subpageLoadedCount=1,this.form.checkSubformLoaded()},getSubpage:function(t){var e="Mobile"===this.form.json.mode||layout.mobile?"getPageByNameMobile":"getPageByName";if("script"===this.json.subpageType){if(this.json.subpageScript&&this.json.subpageScript.code){var i=this.form.Macro.exec(this.json.subpageScript.code,this);if(i){var s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](i,s,function(e){this.getSubpageData(e.data),t&&t()}.bind(this))}else t&&t()}}else if(this.json.subpageSelected&&"none"!==this.json.subpageSelected){s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](this.json.subpageSelected,s,function(e){this.getSubpageData(e.data),t&&t()}.bind(this))}else t&&t()},getSubpageData:function(t){var e;if(e=t.data,this.subpageData=null,e){var i=o2.bindJson(MWF.decodeJsonString(e),{lp:MWF.xApplication.process.Xform.LP.form});this.subpageData=JSON.decode(i),this.subpageData.updateTime=t.updateTime}},getPageParamenters:function(){var t=null;if("map"===this.json.parameterType)t=this.json.parametersMapList;else if("script"===this.json.parameterType){var e=this.json.parametersScript?this.json.parametersScript.code:"";e&&(t=this.form.Macro.exec(e,this))}return t}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.require("MWF.widget.Tab",null,!1),MWF.xApplication.process.Xform.Tab=MWF.APPTab=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.elements=[],this.containers=[];var t="form";layout.mobile&&(t="mobileForm"),this.tab=new MWF.widget.Tab(this.node,{style:t}),this._setTabWidgetStyles(),this.tab.tabNodeContainer=this.node.getFirst("div"),this.tab.contentNodeContainer=this.tab.tabNodeContainer.getNext("div");var e,i=this.tab.tabNodeContainer.getLast();if(i&&i.hasClass("tabNodeContainerLeft")){this.tab.tabNodeContainerRight=this.tab.tabNodeContainer.getFirst(),this.tab.tabNodeContainerLeft=i,this.tab.tabNodeContainerArea=i.getFirst();var s=this.node.getElement(".MWFMenu");s&&s.destroy(),this.tab.load(),e=this.tab.tabNodeContainerArea.getChildren("div")}else e=this.tab.tabNodeContainer.getChildren("div"),this.tab.load();var o=this.tab.contentNodeContainer.getChildren("div");e.each(function(t,e){this.tab.rebuildTab(o[e],o[e].getFirst(),t)}.bind(this)),this.tab.pages[0]._showTab(),this.loadSubModule()},loadSubModule:function(){this.tab.pages.each(function(t){var e=t.tabNode,i=this.form._getDomjson(e),s=this,o=this.form._loadModule(i,e,(function(){this.tab=s}));if(this.elements.push(o),this.form.modules.push(o),t.isShow)this.showContentModule.call(t,this);else if(this.json.isDelay){var n=this;t.showContentModuleFun=function(){n.showContentModule.call(t,n)},t.addEvent("show",t.showContentModuleFun)}else this.showContentModule.call(t,this)}.bind(this))},showContentModule:function(t){var e=this.contentNode;e.isLoadModule=!0,json=t.form._getDomjson(e),tab=t,module=t.form._loadModule(json,e,(function(){this.tab=tab})),t.containers.push(module),t.form.modules.push(module),this.showContentModuleFun&&this.removeEvent("show",this.showContentModuleFun)},_setTabWidgetStyles:function(){this.json.tabNodeContainer&&(this.tab.css.tabNodeContainer=Object.clone(this.json.tabNodeContainer)),this.json.contentNodeContainer&&(this.tab.css.contentNodeContainer=Object.clone(this.json.contentNodeContainer)),this.tab.css.tabNode=Object.clone(this.json.tabStyles),this.tab.css.tabTextNode=Object.clone(this.json.tabTextStyles),this.tab.css.tabNodeCurrent=Object.clone(this.json.tabCurrentStyles),this.tab.css.tabTextNodeCurrent=Object.clone(this.json.tabTextCurrentStyles)}}),MWF.xApplication.process.Xform.tab$Page=MWF.APPTab$Page=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.tab$Content=MWF.APPTab$Content=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.form._loadModules(this.node)}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Table=MWF.APPTable=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.table||(this.table=this.node.getElement("table"));for(var t=this.table.rows,e=0;e<t.length;e++)for(var i=t[e],s=0;s<i.cells.length;s++){var o=i.cells[s],n=this.form._getDomjson(o);if(n)var a=this,r=this.form._loadModule(n,o,(function(){this.table=a}));this.form.modules.push(r)}},_loadBorderStyle:function(){this.json.styles&&this.json.styles.border&&(this.table||(this.table=this.node.getElement("table")),this.json.styles["table-layout"]&&this.table.setStyle("table-layout",this.json.styles["table-layout"]),this.table.set("cellspacing","0"),this.table.setStyles({"border-top":this.json.styles.border,"border-left":this.json.styles.border}),this.table.getElements("th").setStyles({"border-bottom":this.json.styles.border,"border-right":this.json.styles.border}),this.table.getElements("td").setStyles({"border-bottom":this.json.styles.border,"border-right":this.json.styles.border}))},_loadStyles:function(){Object.each(this.json.styles,function(t,e){e.test(/^border\w*/gi)||this.node.setStyle(e,t)}.bind(this)),"5.2"!==this.form.json.$version&&this._loadBorderStyle()}}),MWF.xApplication.process.Xform.Table$Td=MWF.APPTable$Td=new Class({Extends:MWF.APP$Module,_queryLoaded:function(){},_afterLoaded:function(){},_loadStyles:function(){var t={};"title"==this.json.cellType&&(t=this.table.json.titleTdStyles),"content"==this.json.cellType&&(t=this.table.json.contentTdStyles),"layout"==this.json.cellType&&(t=this.table.json.layoutTdStyles),Object.each(t,function(t,e){if(-1!==t.indexOf("x_processplatform_assemble_surface")||-1!==t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),t=o2.filterUrl(t),this.node.setStyle(e,t)}else this.json.preprocessing||this.node.setStyle(e,t)}.bind(this)),Object.each(this.json.styles,function(t,e){if(-1!==t.indexOf("x_processplatform_assemble_surface")||-1!==t.indexOf("x_portal_assemble_surface")){var i=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==t.indexOf("/x_processplatform_assemble_surface")?t=t.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==t.indexOf("x_processplatform_assemble_surface")&&(t=t.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==t.indexOf("/x_portal_assemble_surface")?t=t.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==t.indexOf("x_portal_assemble_surface")&&(t=t.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),t=o2.filterUrl(t)}this.node.setStyle(e,t)}.bind(this)),"content"==this.json.cellType&&this.form.addEvent("postLoad",function(){this.node.getElements("input").each(function(t){var e=t.get("type").toLowerCase();"radio"!=e&&"checkbox"!=e&&"submit"!=e&&"buttom"!=e&&"image"!=e&&t.setStyle("width","100%")}.bind(this)),this.node.getElements("textarea").each(function(t){t.setStyle("width","100%")}.bind(this))}.bind(this))}}),MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Textarea=MWF.APPTextarea=new Class({Implements:[Events],Extends:MWF.APP$Input,_loadUserInterface:function(){this._loadNode(),"show"==this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_setValue:function(t){t||(t="");var e=o2.promiseAll(t).then(function(e){if("array"==o2.typeOf(e)&&(e=e[0]),this._setBusinessData(e),this.node.getFirst()&&this.node.getFirst().set("value",e||""),this.readonly||this.json.isReadonly){var i=new RegExp("\n","g"),s=new RegExp("<","g"),o=new RegExp(">","g"),n=t.replace(s,"&lt").replace(o,"&gt").replace(i,"<br/>");this.node.set("html",n)}}.bind(this),(function(){}));return this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this)),t},_resetNodeEdit:function(){var t=new Element("textarea",{styles:{background:"transparent",width:"100%",border:"0px"}}),e=new Element("div",{styles:{ovwrflow:"hidden",position:"relative","padding-right":"2px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();t.set(this.json.properties),this.form.json.textareaDisableResize&&t.setStyle("resize","none"),this.node.set({id:this.json.id,MWFType:this.json.type}),this.node.addEvent("change",function(){this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this)),this.node.getFirst().addEvent("blur",function(){this.validation()}.bind(this)),this.node.getFirst().addEvent("keyup",function(){this.validationMode()}.bind(this))},_afterLoaded:function(){this.readonly||this.loadDescription()},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||(e=t.x-23),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&("ios"===COMMON.Browser.Platform.name||COMMON.Browser.Platform.name,this.descriptionNode.addEvents({click:function(){this.descriptionNode.setStyle("display","none"),this.node.getFirst().focus()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode.setStyle("display","block")}.bind(this)}))}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Tree=MWF.APPTree=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","beforeLoadTree","afterLoadTree","beforeLoadTreeNode","afterLoadTreeNode","expand","collapse","beforeSelect","afterSelect"]},_loadUserInterface:function(){this.node.empty(),MWF.require("MWF.widget.Tree",function(){var t={style:"form"};this.json.events&&"object"===typeOf(this.json.events)&&[{beforeLoadTree:"onQueryLoad"},{afterLoadTree:"onPostLoad"},{beforeLoadTreeNode:"onBeforeLoadTreeNode"},{afterLoadTreeNode:"onAfterLoadTreeNode"},{expand:"onPostExpand"},{collapse:"onPostCollapse"},{beforeSelect:"onBeforeSelect"},{afterSelect:"onAfterSelect"}].each(function(e){var i=Object.keys(e)[0],s=e[i];this.json.events[i]&&this.json.events[i].code&&(t[s]=function(t){return this.form.Macro.fire(this.json.events[i].code,t||this)}.bind(this))}.bind(this)),this.tree=new MWF.widget.Tree(this.node,t),this.tree.form=this.form,this._setTreeWidgetStyles();var e=this.json.data;"script"==this.json.dataType&&(e=this.form.Macro.exec(this.json.dataScript?this.json.dataScript.code:"",this)),this.tree.load(e)}.bind(this))},_setTreeWidgetStyles:function(){this.tree.css.areaNode=this.json.areaNodeStyle,this.tree.css.treeItemNode=this.json.treeItemNodeStyle,this.tree.css.textDivNode=this.json.textDivNodeStyle,this.tree.css.textDivNodeSelected=this.json.textDivNodeSelectedStyle}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.View=MWF.APPView=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","beforeLoadView","loadView","queryLoad","postLoad","select","openDocument"]},_loadUserInterface:function(){MWF.xDesktop.requireApp("query.Query","Viewer",null,!1),this.node.empty()},_afterLoaded:function(){this.json.queryView?this.loadView():"cms"===this.json.selectViewType?this.loadCMSView():"process"===this.json.selectViewType?this.loadPrcessView():this.loadView()},reload:function(){this.view&&(this.view.loadViewRes&&this.view.loadViewRes.res&&this.view.loadViewRes.res.isRunning()&&this.view.loadViewRes.res.cancel(),this.view.getViewRes&&this.view.getViewRes.res&&this.view.getViewRes.res.isRunning()&&this.view.getViewRes.res.cancel()),this.node.empty(),this.loadView()},active:function(){this.view?this.view.loadingAreaNode||this.view.loadView():this.loadView()},loadView:function(){if(!this.json.queryView||!this.json.queryView.name||!this.json.queryView.appName)return"";var t=null;this.json.filterList&&this.json.filterList.length&&(t=[],this.json.filterList.each(function(e){e.value=this.form.Macro.exec(e.code.code,this),t.push(e)}.bind(this)));var e={application:this.json.queryView?this.json.queryView.appName:this.json.application,viewName:this.json.queryView?this.json.queryView.name:this.json.viewName,isTitle:this.json.isTitle||"yes",select:this.json.select||"none",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:t,defaultSelectedScript:this.json.defaultSelectedScript?this.json.defaultSelectedScript.code:null,selectedAbleScript:this.json.selectedAbleScript?this.json.selectedAbleScript.code:null};this.fireEvent("beforeLoadView",[e]),this.view=new MWF.xApplication.query.Query.Viewer(this.node,e,{isload:"no"!==this.json.loadView,resizeNode:"auto"!==this.node.getStyle("height").toString().toLowerCase()&&this.node.getStyle("height").toInt()>0,onLoadView:function(){this.fireEvent("loadView")}.bind(this),onSelect:function(){this.fireEvent("select")}.bind(this),onOpenDocument:function(t,e){this.openOptions={options:t,item:e},this.fireEvent("openDocument"),this.openOptions=null}.bind(this)},this.form.app,this.form.Macro)},loadPrcessView:function(){var t=null;this.json.filterList&&this.json.filterList.length&&(t=[],this.json.filterList.each(function(e){e.value=this.form.Macro.exec(e.code.code,this),t.push(e)}.bind(this)));var e={application:this.json.processView.application,viewName:this.json.processView.name,isTitle:this.json.isTitle||"yes",select:this.json.select||"none",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:t};MWF.xDesktop.requireApp("process.Application","Viewer",function(){this.view=new MWF.xApplication.process.Application.Viewer(this.node,e,{resizeNode:"auto"!==this.node.getStyle("height").toString().toLowerCase()&&this.node.getStyle("height").toInt()>0,onSelect:function(){this.fireEvent("select")}.bind(this)})}.bind(this))},loadCMSView:function(){var t=null;this.json.filterList&&this.json.filterList.length&&(t=[],this.json.filterList.each(function(e){e.value=this.form.Macro.exec(e.code.code,this),t.push(e)}.bind(this)));var e={application:this.json.cmsView.appId,viewName:this.json.cmsView.name,isTitle:this.json.isTitle||"yes",select:this.json.select||"none",titleStyles:this.json.titleStyles,itemStyles:this.json.itemStyles,isExpand:this.json.isExpand||"no",showActionbar:"show"===this.json.actionbar,filter:t};MWF.xDesktop.requireApp("process.Application","Viewer",function(){this.view=new MWF.xApplication.process.Application.Viewer(this.node,e,{actions:{lookup:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}/execute",method:"PUT"},getView:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}"}},actionRoot:"x_cms_assemble_control",resizeNode:"auto"!==this.node.getStyle("height").toString().toLowerCase()&&this.node.getStyle("height").toInt()>0,onSelect:function(){this.fireEvent("select")}.bind(this)})}.bind(this))},getData:function(){if(this.view.selectedItems.length){var t=[];return this.view.selectedItems.each((function(e){t.push(e.data)})),t}return[]}}),MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Widget=MWF.APPWidget=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.modules=[],this.moduleList={},this.getWidget(function(){this.loadWidget()}.bind(this))},reload:function(){this.clean(),this.getWidget(function(){this.loadWidget()}.bind(this))},clean:function(){if((this.modules||[]).each(function(t){this.form.modules.erase(t)}.bind(this)),Object.each(this.moduleList||{},function(t,e){delete this.form.json.moduleList[e]}.bind(this)),this.widgetData&&this.widgetData.json.id){var t=this.widgetData.json.id;this.parentpageIdList&&this.parentpageIdList.length&&this.parentpageIdList.erase(t)}this.json&&this.json.id&&this.form.widgetModules&&this.form.widgetModules[this.json.id]&&(this.form.widgetModules[this.json.id]={}),this.modules=[],this.moduleList={},this.node.empty()},loadCss:function(){if(this.widgetData.json.css&&this.widgetData.json.css.code){for(var t,e=this.form.parseCSS(this.widgetData.json.css.code),i=new RegExp("(.+)(?=\\{)","g"),s=this.form.json.id.replace(/\-/g,"");null!==(t=i.exec(e));){var o=".css"+s+" ",n=o+t[0];e=e.substring(0,t.index)+n+e.substring(i.lastIndex,e.length),i.lastIndex=i.lastIndex+o.length}var a;if(!(a=$("style"+this.form.json.id)))(a=document.createElement("style")).setAttribute("type","text/css"),a.id="style"+this.form.json.id,a.inject(this.form.container,"before");if(a.styleSheet){var r=function(){a.styleSheet.cssText+=e};a.styleSheet.disabled?setTimeout(r,10):r()}else{var l=document.createTextNode(e);a.appendChild(l)}}},checkWidgetNested:function(t){return this.parentpageIdList?!this.parentpageIdList.contains(t):![this.form.json.id].contains(t)},getParentpageIdList:function(){var t;return this.parentpageIdList?(t=Array.clone(this.parentpageIdList)).push(this.widgetData.json.id):t=[this.form.json.id,this.widgetData.json.id],t},loadWidget:function(){if(this.widgetData)if(this.checkWidgetNested(this.widgetData.json.id)){this.loadCss(),this.modules=[],this.moduleList={},this.form.widgetModules=this.form.widgetModules||{};var t=this.form.widgetModules[this.json.id]={},e=this.getPageParamenters();if("object"===typeOf(e)&&this.form.Macro&&this.form.Macro.environment){var i=this.form.Macro.environment;i.widgetParameters=i.widgetParameters||{},i.widgetParameters[this.json.id]=e}this.node.set("html",this.widgetData.html),Object.each(this.widgetData.json.moduleList,function(t,e){var i=e;if(this.form.json.moduleList[e]){i=this.json.id+"_"+e;var s=this.node.getElement("#"+e);s&&s.set("id",i),t.orgiginalId=e,t.id=i}this.form.json.moduleList[i]=t,this.moduleList[i]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(e){if("form"!==e.get("MWFtype")){var i=this,s=this.form._getDomjson(e),o=this.form._loadModule(s,e,(function(){this.widget=i,this.parentpageIdList=i.getParentpageIdList()}));this.form.modules.push(o),this.modules.push(o),t[s.orgiginalId||s.id]=o}}.bind(this))}else this.form.notice(MWF.xApplication.process.Xform.LP.widgetNestedError,"error");this.form.widgetLoadedCount?this.form.widgetLoadedCount++:this.form.widgetLoadedCount=1,this.form.checkSubformLoaded()},getWidget:function(t){var e="Mobile"===this.form.options.mode||layout.mobile?"getWidgetByNameMobile":"getWidgetByName";if("script"===this.json.widgetType){if(this.json.widgetScript&&this.json.widgetScript.code){var i=this.form.Macro.exec(this.json.widgetScript.code,this);if(i){var s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](i,s,function(e){this.getWidgetData(e.data),t&&t()}.bind(this))}else t&&t()}}else if(this.json.widgetSelected&&"none"!==this.json.widgetSelected){var o=this.form.app.relatedFormMap?this.form.app.relatedFormMap[this.json.widgetSelected]:null;if(o)this.getWidgetData({data:o.data}),t&&t();else{s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](this.json.widgetSelected,s,function(e){this.getWidgetData(e.data),t&&t()}.bind(this))}}else t&&t()},getWidgetData:function(t){var e;if(e=t.data,this.widgetData=null,e){var i=o2.bindJson(MWF.decodeJsonString(e),{lp:MWF.xApplication.process.Xform.LP.form});this.widgetData=JSON.decode(i),this.widgetData.updateTime=t.updateTime}},getPageParamenters:function(){var t=null;if("map"===this.json.parameterType)t=this.json.parametersMapList;else if("script"===this.json.parameterType){var e=this.json.parametersScript?this.json.parametersScript.code:"";e&&(t=this.form.Macro.exec(e,this))}return t}}),MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.Work=MWF.xApplication.process.Work||{},MWF.xDesktop.requireApp("process.Work","lp."+MWF.language,null,!1),MWF.xApplication.process.Work.Processor=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",mediaNode:null,opinion:"",tabletWidth:0,tabletHeight:0,orgHeight:276,maxOrgCountPerline:2,isManagerProcess:!1},initialize:function(t,e,i,s){this.setOptions(i),this.path="../x_component_process_Work/$Processor/",this.cssPath="../x_component_process_Work/$Processor/"+this.options.style+"/css.wcss",this._loadCss(),this.task=e,this.node=$(t),this.selectedRoute=null,this.form=s,this.load()},load:function(){layout.mobile?this.content=new Element("div").inject(this.node):this.content=this.node,!this.form&&this.options.isManagerProcess&&(this.managerProcessNoticeNode=new Element("div",{styles:this.css.managerProcessNoticeNode,html:MWF.xApplication.process.Work.LP.managerProcessNotice}).inject(this.content),this.managerLoginNode=new Element("div",{styles:this.css.managerLoginNode,text:MWF.xApplication.process.Work.LP.managerLogin}).inject(this.content),this.managerLoginNode.addEvent("click",function(t){this.managerLogin(t)}.bind(this))),this.routeOpinionTile=new Element("div",{styles:this.css.routeOpinionTile,text:MWF.xApplication.process.Work.LP.inputOpinion}).inject(this.content),this.routeOpinionArea=new Element("div",{styles:this.css.routeOpinionArea}).inject(this.content),this.setOpinion(),this.form&&(layout.mobile?(this.orgsArea=new Element("div",{styles:this.css.orgsArea}).inject(this.content),this.orgsTile=new Element("div",{styles:this.css.orgsTitle,text:MWF.xApplication.process.Work.LP.selectPerson}).inject(this.orgsArea),this.orgsArea.hide()):(this.orgsArea=new Element("div",{styles:this.css.orgsArea}).inject(this.content),this.orgsTile=new Element("div",{styles:this.css.orgsTitle,text:MWF.xApplication.process.Work.LP.selectPerson}).inject(this.orgsArea))),layout.mobile?this.buttonsArea=new Element("div",{styles:this.css.buttonsArea}).inject(this.node):this.buttonsArea=new Element("div",{styles:this.css.buttonsArea}).inject(this.content),this.setButtons(),this.form?layout.mobile?(this.getRouteGroupList(),this.hasDecisionOpinion?(this.routeContainer=new Element("div",{styles:this.css.routeContainer}).inject(this.routeOpinionTile,"before"),this.routeGroupTitle=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRouteGroup}).inject(this.routeContainer),this.routeGroupArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeContainer),this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeContainer),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeContainer),this.setRouteGroupList()):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList())):(this.getRouteGroupList(),this.hasDecisionOpinion?(this.routeContainer=new Element("div",{styles:this.css.routeContainer}).inject(this.routeOpinionTile,"before"),this.routeLeftWarper=new Element("div",{styles:this.getMaxOrgLength()>1?this.css.routeLeftWarper:this.css.routeLeftWarper_single}).inject(this.routeContainer),this.routeGroupTitle=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRouteGroup}).inject(this.routeLeftWarper),this.routeGroupArea=new Element("div",{styles:this.css.routeSelectorArea_hasGroup}).inject(this.routeLeftWarper),this.routeRightWarper=new Element("div",{styles:this.getMaxOrgLength()>1?this.css.routeRightWarper:this.css.routeRightWarper_single}).inject(this.routeContainer),this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeRightWarper),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea_hasGroup}).inject(this.routeRightWarper),this.setRouteGroupList()):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList())):(this.routeSelectorTile=new Element("div",{styles:this.css.routeSelectorTile,text:MWF.xApplication.process.Work.LP.selectRoute}).inject(this.routeOpinionTile,"before"),this.routeSelectorArea=new Element("div",{styles:this.css.routeSelectorArea}).inject(this.routeSelectorTile,"after"),this.setRouteList_noform(),this.setSize_noform()),this.fireEvent("postLoad")},getRouteGroupList:function(){return this.routeGroupObject||(this.routeGroupObject={},this.routeGroupNameList=[],this.hasDecisionOpinion=!1,this.getRouteDataList().each(function(t,e){if(!(t.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString()))if(t.displayNameScriptText&&this.form&&this.form.Macro?t.displayName=this.form.Macro.exec(t.displayNameScriptText,this):t.displayName=t.name,t.decisionOpinion){this.hasDecisionOpinion=!0,t.decisionOpinion.split("#").each(function(e){this.routeGroupNameList.combine([e]);var i=this.splitByStartNumber(e);this.routeGroupObject[i.name]||(this.routeGroupObject[i.name]=[]),this.routeGroupObject[i.name].push(t)}.bind(this))}else{var i=MWF.xApplication.process.Work.LP.defaultDecisionOpinionName;this.routeGroupNameList.combine([i]),this.routeGroupObject[i]||(this.routeGroupObject[i]=[]),this.routeGroupObject[i].push(t)}}.bind(this))),this.routeGroupObject},splitByStartNumber:function(t){for(var e={name:"",order:""},i=0;i<t.length;i++){if("NaN"===parseInt(t.substr(i,1)).toString()){e.name=t.substr(i,t.length);break}e.order=e.order+t.substr(i,1)}return e},setRouteGroupList:function(){var t=this,e=this.routeGroupNameList;e.sort(function(t,e){return parseInt(this.splitByStartNumber(t).order||"9999999")-parseInt(this.splitByStartNumber(e).order||"9999999")}.bind(this));var i=[];e.each(function(t){i.push(this.splitByStartNumber(t).name)}.bind(this));var s=!1;i.each(function(i){var o=this.routeGroupObject[i],n=new Element("div",{styles:this.css.routeGroupNode,text:i}).inject(this.routeGroupArea);n.store("routeList",o),n.store("routeGroupName",i),n.addEvents({mouseover:function(e){t.overRouteGroup(this)},mouseout:function(e){t.outRouteGroup(this)},click:function(e){t.selectRouteGroup(this)}}),1===e.length?(this.selectRouteGroup(n),s=!1):s=!0}.bind(this)),s&&this.setSize(0)},overRouteGroup:function(t){this.selectedRouteGroup?this.selectedRouteGroup.get("text")!=t.get("text")&&t.setStyles(this.css.routeGroupNode_over):t.setStyles(this.css.routeGroupNode_over)},outRouteGroup:function(t){this.selectedRouteGroup?this.selectedRouteGroup.get("text")!=t.get("text")&&t.setStyles(this.css.routeGroupNode):t.setStyles(this.css.routeGroupNode)},selectRouteGroup:function(t){if(this.selectedRouteGroup){if(this.selectedRouteGroup.get("text")!=t.get("text")){this.selectedRouteGroup.setStyles(this.css.routeGroupNode),this.selectedRouteGroup=t,this.selectedRouteGroup.setStyles(this.css.routeGroupNode_selected);var e=this.selectedRouteGroup.retrieve("routeList");this.setRouteList(e)}}else{this.selectedRouteGroup=t,t.setStyles(this.css.routeGroupNode_selected);e=this.selectedRouteGroup.retrieve("routeList");this.setRouteList(e)}this.routeGroupArea.setStyle("background-color","#FFF")},setRouteList_noform:function(t){var e=this;this.routeSelectorArea.empty(),this.selectedRoute=null,t||(t=this.getRouteDataList()),t.each(function(i,s){var o=i.name,n=new Element("div",{styles:this.css.routeNode,text:o}).inject(this.routeSelectorArea);n.store("route",i.id),n.store("routeName",i.name),n.addEvents({mouseover:function(t){e.overRoute(this)},mouseout:function(t){e.outRoute(this)},click:function(t){e.selectRoute_noform(this)}}),(1==t.length||i.sole)&&this.selectRoute_noform(n)}.bind(this))},setRouteList:function(t){var e=this;this.routeSelectorArea.empty(),this.selectedRoute=null,t||(t=this.getRouteDataList());var i=!1;t.each(function(s,o){if(!(s.hiddenScriptText&&this.form&&this.form.Macro&&"true"===this.form.Macro.exec(s.hiddenScriptText,this).toString())){var n=s.name;s.displayNameScriptText&&this.form&&this.form.Macro&&(n=this.form.Macro.exec(s.displayNameScriptText,this));var a=new Element("div",{styles:this.css.routeNode,text:n}).inject(this.routeSelectorArea);a.store("route",s.id),a.store("routeName",s.name),a.addEvents({mouseover:function(t){e.overRoute(this)},mouseout:function(t){e.outRoute(this)},click:function(t){e.selectRoute(this)}}),(1==t.length||s.sole)&&(this.selectRoute(a),i=!0)}}.bind(this)),i||(this.setSize(0),this.orgsArea&&this.orgsArea.hide())},overRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")&&(t.setStyles(this.css.routeNode_over),t.addClass("lightColor_bg")):(t.setStyles(this.css.routeNode_over),t.addClass("lightColor_bg"))},outRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")&&(t.setStyles(this.css.routeNode),t.removeClass("lightColor_bg")):(t.setStyles(this.css.routeNode),t.removeClass("lightColor_bg"))},selectRoute_noform:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")?(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")):(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.addClass("lightColor_bg"),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=null):(this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")),this.routeSelectorArea.setStyle("background-color","#FFF")},selectRoute:function(t){this.selectedRoute?this.selectedRoute.get("text")!=t.get("text")?(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")):(this.selectedRoute.setStyles(this.css.routeNode),this.selectedRoute.addClass("lightColor_bg"),this.selectedRoute.removeClass("mainColor_bg"),this.selectedRoute=null):(this.selectedRoute=t,t.setStyles(this.css.routeNode_selected),t.addClass("mainColor_bg"),t.removeClass("lightColor_bg")),this.routeSelectorArea.setStyle("background-color","#FFF"),layout.mobile?this.loadOrgs_mobile(this.selectedRoute?this.selectedRoute.retrieve("route"):""):this.loadOrgs(this.selectedRoute?this.selectedRoute.retrieve("route"):""),this.form.data.json.events&&this.form.data.json.events.afterSelectRoute&&this.form.Macro.exec(this.form.data.json.events.afterSelectRoute.code,t)},setOpinion:function(){this.selectIdeaNode=new Element("div",{styles:this.css.selectIdeaNode}).inject(this.routeOpinionArea),this.selectIdeaScrollNode=new Element("div",{styles:this.css.selectIdeaScrollNode}).inject(this.selectIdeaNode),this.selectIdeaAreaNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.selectIdeaScrollNode),this.inputOpinionNode=new Element("div",{styles:this.css.inputOpinionNode}).inject(this.routeOpinionArea),this.inputTextarea=new Element("textarea",{styles:this.css.inputTextarea,value:this.options.opinion||MWF.xApplication.process.Work.LP.inputText}).inject(this.inputOpinionNode),this.inputTextarea.addEvents({focus:function(){this.get("value")==MWF.xApplication.process.Work.LP.inputText&&this.set("value","")},blur:function(){this.get("value")||this.set("value",MWF.xApplication.process.Work.LP.inputText)},keydown:function(){this.inputTextarea.setStyles(this.inputTextareaStyle||this.css.inputTextarea)}.bind(this)}),this.mediaActionArea=new Element("div",{styles:this.css.inputOpinionMediaActionArea}).inject(this.inputOpinionNode),this.handwritingAction=new Element("div",{styles:this.css.inputOpinionHandwritingAction,text:MWF.xApplication.process.Work.LP.handwriting}).inject(this.mediaActionArea),this.handwritingAction.addEvent("click",function(){layout.mobile?window.setTimeout(function(){this.handwriting()}.bind(this),100):this.handwriting()}.bind(this)),layout.mobile&&this.selectIdeaNode.inject(this.routeOpinionArea,"after"),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.selectIdeaScrollNode,{style:"small",where:"before",distance:30,friction:4,indent:!1,axis:{x:!1,y:!0}})}.bind(this)),MWF.require("MWF.widget.UUID",function(){MWF.UD.getDataJson("idea",function(t){t?t.ideas&&this.setIdeaList(t.ideas):MWF.UD.getPublicData("idea",function(t){t&&t.ideas&&this.setIdeaList(t.ideas)}.bind(this))}.bind(this))}.bind(this))},audioRecord:function(){this.audioRecordNode||this.createAudioRecord(),this.audioRecordNode.show(),this.audioRecordNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"}),MWF.require("MWF.widget.AudioRecorder",function(){this.audioRecorder=new MWF.widget.AudioRecorder(this.audioRecordNode,{onSave:function(t){this.soundFile=t,this.audioRecordNode.hide()}.bind(this),onCancel:function(){this.soundFile=null,this.audioRecordNode.hide()}.bind(this)},null)}.bind(this))},createAudioRecord:function(){this.audioRecordNode=new Element("div",{styles:this.css.handwritingNode}).inject(this.node,"after");var t=(this.options.mediaNode||this.node).getSize(),e=this.node.getStyle("z-index");this.audioRecordNode.setStyles({height:t.y+"px",width:t.x+"px","z-index":e+1})},handwriting:function(){this.handwritingNode||this.createHandwriting(),this.handwritingNodeMask&&this.handwritingNodeMask.show(),this.handwritingNode.show(),layout.mobile?this.handwritingNode.setStyles({top:"0px",left:"0px"}):this.handwritingNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"})},createHandwriting:function(){this.handwritingNodeMask=new Element("div.handwritingMask",{styles:this.css.handwritingMask}).inject(this.node),this.handwritingNode=new Element("div.handwritingNode",{styles:this.css.handwritingNode}).inject(this.node,"after");var t=600,e=320;if(layout.mobile){var i=$(document.body).getSize();t=i.x,e=i.y,this.options.tabletWidth=0,this.options.tabletHeight=0}else t=Math.max(this.options.tabletWidth||t,500),e=Math.max(this.options.tabletHeight?parseInt(this.options.tabletHeight)+110:e,320);var s=this.node.getStyle("z-index");this.handwritingNode.setStyles({height:e+"px",width:t+"px","z-index":s+1}),layout.mobile?(this.handwritingNode.addEvent("touchmove",(function(t){t.preventDefault()})),this.handwritingNode.setStyles({top:"0px",left:"0px"})):this.handwritingNode.position({relativeTo:this.options.mediaNode||this.node,position:"center",edge:"center"}),this.handwritingAreaNode=new Element("div",{styles:this.css.handwritingAreaNode}).inject(this.handwritingNode),this.handwritingActionNode=new Element("div",{styles:this.css.handwritingActionNode,text:MWF.xApplication.process.Work.LP.saveWrite}).inject(this.handwritingNode);var o=this.handwritingActionNode.getSize().y+this.handwritingActionNode.getStyle("margin-top").toInt()+this.handwritingActionNode.getStyle("margin-bottom").toInt();o=e-o,this.handwritingAreaNode.setStyle("height",o+"px"),MWF.require("MWF.widget.Tablet",function(){var t={style:"default",contentWidth:this.options.tabletWidth||0,contentHeight:this.options.tabletHeight||0,onSave:function(t,e,i){this.handwritingFile=i,this.handwritingNode.hide(),this.handwritingNodeMask.hide()}.bind(this),onCancel:function(){this.handwritingFile=null,this.handwritingNode.hide(),this.handwritingNodeMask.hide()}.bind(this)};layout.mobile&&(t.tools=["undo","redo","|","reset","|","size","cancel"]),this.tablet=new MWF.widget.Tablet(this.handwritingAreaNode,t,null),this.tablet.load()}.bind(this)),this.handwritingActionNode.addEvent("click",function(){this.tablet&&this.tablet.save()}.bind(this))},setIdeaList:function(t){var e=this;t.each(function(t){t&&new Element("div",{styles:this.css.selectIdeaItemNode,text:t,events:{click:function(){e.inputTextarea.get("value")==MWF.xApplication.process.Work.LP.inputText?e.inputTextarea.set("value",this.get("text")):e.inputTextarea.set("value",e.inputTextarea.get("value")+", "+this.get("text"))},dblclick:function(){e.inputTextarea.get("value")==MWF.xApplication.process.Work.LP.inputText?e.inputTextarea.set("value",this.get("text")):e.inputTextarea.set("value",e.inputTextarea.get("value")+", "+this.get("text"))},mouseover:function(){this.setStyles(e.css.selectIdeaItemNode_over)},mouseout:function(){this.setStyles(e.css.selectIdeaItemNode)}}}).inject(this.selectIdeaAreaNode)}.bind(this))},setButtons:function(){this.cancelButton=new Element("div",{styles:this.css.cancelButton}).inject(this.buttonsArea);new Element("div",{styles:this.css.cancelIconNode}).inject(this.cancelButton),new Element("div",{styles:this.css.cancelTextNode,text:MWF.xApplication.process.Work.LP.cancel}).inject(this.cancelButton);this.okButton=new Element("div",{styles:this.css.okButton}).inject(this.buttonsArea);new Element("div",{styles:this.css.okIconNode}).inject(this.okButton),new Element("div",{styles:this.css.okTextNode,text:MWF.xApplication.process.Work.LP.ok}).inject(this.okButton);this.cancelButton.addEvent("click",function(){this.destroy(),this.fireEvent("cancel")}.bind(this)),this.okButton.addEvent("click",function(t){layout.mobile?this.submit_mobile(t):this.submit_pc(t)}.bind(this))},submit_mobile:function(t){if(this.hasDecisionOpinion&&!this.selectedRouteGroup)return this.routeGroupArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRouteGroup,this.routeGroupArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;if(!this.selectedRoute)return this.routeSelectorArea.setStyle("background-color","#ffe9e9"),new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.routeSelectorArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.mustSelectRoute}),!1;var e=this.selectedRoute.retrieve("routeName")||this.selectedRoute.get("text"),i=this.inputTextarea.get("value");i===MWF.xApplication.process.Work.LP.inputText&&(i="");var s=[];this.handwritingFile&&s.push(this.handwritingFile),this.soundFile&&s.push(this.soundFile),this.videoFile&&s.push(this.videoFile);var o,n,a=this.selectedRoute.retrieve("route"),r=this.getRouteData(a);if(!i&&0===s.length&&1==r.opinionRequired)return this.inputTextarea.setStyle("background-color","#ffe9e9"),new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.inputTextarea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.opinionRequired}),!1;if(r.validationScriptText&&(!(l=this.form.Macro.exec(r.validationScriptText,this))||"true"!==l.toString()))return"string"===typeOf(l)?(new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.node,delayClose:6e3,content:l}),!1):(new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.node,delayClose:6e3,content:MWF.xApplication.process.Work.LP.routeValidFailure}),!1);if("appendTask"===r.type&&"select"===r.appendTaskIdentityType){if(!this.orgItems||0===this.orgItems.length)return new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.orgsArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig}),!1;o=this.orgItems[0]}if(!this.saveOrgs())return!1;if(!o||(n=o.getData())&&0!==n.length){var l;if(r.validationScriptText)if(!(l=this.form.Macro.exec(r.validationScriptText,this))||"true"!==l.toString())return"string"===typeOf(l)?(MWF.xDesktop.notice("error",{x:"center",y:"center"},l,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.routeValidFailure,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1);this.node.mask({inject:{where:"bottom",target:this.node},destroyOnHide:!0,style:{"background-color":"#999",opacity:.3,"z-index":600}});var h=[e,i,s,n,this.orgItems,function(){o&&o.setData([])}];this.fireEvent("submit",h)}else new mBox.Notice({type:"error",position:{x:"center",y:"top"},move:!1,target:this.orgsArea,delayClose:6e3,content:MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice})},submit_pc:function(t){if(this.hasDecisionOpinion&&!this.selectedRouteGroup)return this.routeGroupArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRouteGroup,this.routeGroupArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;if(!this.selectedRoute)return this.routeSelectorArea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.mustSelectRoute,this.routeSelectorArea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;var e=this.selectedRoute.retrieve("routeName")||this.selectedRoute.get("text"),i=this.inputTextarea.get("value");i===MWF.xApplication.process.Work.LP.inputText&&(i="");var s=[];this.handwritingFile&&s.push(this.handwritingFile),this.soundFile&&s.push(this.soundFile),this.videoFile&&s.push(this.videoFile);var o=this.selectedRoute.retrieve("route"),n=this.getRouteData(o);if(!i&&0===s.length&&1==n.opinionRequired)return this.inputTextarea.setStyle("background-color","#ffe9e9"),MWF.xDesktop.notice("error",{x:"center",y:"top"},MWF.xApplication.process.Work.LP.opinionRequired,this.inputTextarea,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;var a="";if("appendTask"===n.type&&"select"===n.appendTaskIdentityType){if(!this.orgItems||0===this.orgItems.length)return MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.noAppendTaskIdentityConfig,this.node,null,{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1;a=this.orgItems[0]}this.saveOrgsWithCheckEmpower(function(){var t;if(!a||(t=a.getData())&&0!==t.length){if(n.validationScriptText){var o=this.form.Macro.exec(n.validationScriptText,this);if(!o||"true"!==o.toString())return"string"===typeOf(o)?(MWF.xDesktop.notice("error",{x:"center",y:"center"},o,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.routeValidFailure,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1)}this.node.mask({inject:{where:"bottom",target:this.node},destroyOnHide:!0,style:{"background-color":"#999",opacity:.3,"z-index":600}});var r=[e,i,s,t,this.orgItems,function(){a&&a.setData([])}];this.fireEvent("submit",r)}else MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.selectAppendTaskIdentityNotice,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3})}.bind(this))},destroy:function(){this.node.empty(),delete this.task,delete this.node,delete this.routeSelectorTile,delete this.routeSelectorArea,delete this.routeOpinionTile,delete this.routeOpinionArea,delete this.buttonsArea,delete this.inputOpinionNode,delete this.inputTextarea,delete this.cancelButton,delete this.okButton},getRouteDataList:function(){return this.routeDataList||(this.form&&this.form.businessData&&this.form.businessData.routeList&&(this.form.businessData.routeList.sort(function(t,e){return parseInt(t.orderNumber||"9999999")-parseInt(e.orderNumber||"9999999")}.bind(this)),this.form.businessData.routeList.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=this.form.businessData.routeList),this.routeDataList||o2.Actions.get("x_processplatform_assemble_surface").listRoute({valueList:this.task.routeList},function(t){t.data.sort(function(t,e){return parseInt(t.orderNumber||"9999999")-parseInt(e.orderNumber||"9999999")}.bind(this)),t.data.each(function(t){t.selectConfigList=JSON.parse(t.selectConfig||"[]")}.bind(this)),this.routeDataList=t.data}.bind(this),null,!1)),this.routeDataList},getRouteData:function(t){for(var e=this.getRouteDataList(),i=0;i<e.length;i++)if(e[i].id===t)return e[i]},getMaxOrgLength:function(){var t=this.getRouteDataList(),e=0;return t.each(function(t){t.hiddenScriptText&&"true"===this.form.Macro.exec(t.hiddenScriptText,this).toString()||(e=Math.max(e,t.selectConfigList.length))}.bind(this)),e},getOrgData:function(t){for(var e=this.getRouteDataList(),i=0;i<e.length;i++)if(e[i].id===t)return e[i].selectConfigList},getVisableOrgData:function(t){var e=this.getOrgData(t),i=[];return(e||[]).each(function(t){this.isOrgHidden(t)||i.push(t)}.bind(this)),i},isOrgHidden:function(t){if(t.hiddenScript&&t.hiddenScript.code){var e=this.form.Macro.exec(t.hiddenScript.code,this);if(e&&"true"===e.toString())return!0}return!1},loadOrgs_mobile:function(t){if(!this.form||!t)return this.orgsArea.hide(),void this.setSize(0);this.orgsArea.show(),this.orgTableObject||(this.orgTableObject={}),this.orgItemsObject||(this.orgItemsObject={}),this.orgItemsMap||(this.orgItemsMap={});var e=!1;for(var i in this.orgTableObject)t===i?e=!0:this.orgTableObject[i].hide();e?this.showOrgs_mobile(t):this.createOrgs_mobile(t)},showOrgs_mobile:function(t){this.orgItemMap=this.orgItemsMap[t]||{};var e=this.getVisableOrgData(t);e.length?this.isSameArray(Object.keys(this.orgItemMap),e.map((function(t){return t.name})))?(this.orgTableObject[t].show(),this.orgItems=this.orgItemsObject[t]||[],this.setSize(e.length)):this.loadOrgTable_mobile(t):(this.orgsArea.hide(),this.orgItemMap={},this.orgItems=[],this.setSize(0))},createOrgs_mobile:function(t){var e=this.getVisableOrgData(t);e.length?this.loadOrgTable_mobile(t):(this.setSize(e.length),this.orgItemMap={},this.orgItems=[],this.orgsArea.hide())},loadOrgTable_mobile:function(t){var e=this.getVisableOrgData(t);this.setSize(e.length),this.orgsArea.show();var i=this.orgTableObject[t],s={};i&&i.getChildren("div").each((function(t){s[t.retrieve("orgName")]=t}));this.orgItemsObject[t];var o=this.orgItemsMap[t]||{};this.orgItemsObject[t]=[],this.orgItemsMap[t]={},this.orgItems=this.orgItemsObject[t],this.orgItemMap=this.orgItemsMap[t];var n=new Element("div",{styles:this.css.routeOrgTable}).inject(this.orgsArea);this.orgTableObject[t]=n;e.each(function(t,e){var i=new Element("div",{styles:this.css.routeOrgTr}).inject(n);if(i.store("orgName",t.name),o[t.name]){var a=o[t.name];this.orgItems.push(a),this.orgItemMap[t.name]=a,s[t.name].getChildren().inject(i)}else this.loadOrg_mobile(i,t,!1)}.bind(this)),i&&i.destroy()},loadOrg_mobile:function(t,e,i){var s=new Element("div.selectorTitle",{styles:this.css.selectorTitle}).inject(t),o=(new Element("div.selectorTitleText",{text:e.title,styles:this.css.selectorTitleText}).inject(s),new Element("div.selectorContent",{styles:this.css.selectorContent}).inject(t)),n=new Element("div.selectorErrorNode",{styles:this.css.selectorErrorNode}).inject(t),a=new MWF.xApplication.process.Work.Processor.Org(o,this.form,e,this,{onSelect:function(t,e){e&&e.length?o.setStyles(this.css.selectorContent):o.setStyles(this.css.selectorContent_noItem)}.bind(this)});a.ignoreOldData=i,a.errContainer=n,a.summitDlalog=this,this.orgItems.push(a),this.orgItemMap[e.name]=a,s.addEvent("click",function(){this.load()}.bind(a)),o.addEvent("click",function(){this.load()}.bind(a));var r=a.getValue();a.loadOrgWidget(r,o),r&&0!=r.length||o.setStyles(this.css.selectorContent_noItem)},isSameArray:function(t,e){if(t.length!==e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0},loadOrgs:function(t){if(!this.form||!t)return this.orgsArea.hide(),void this.setSize(0);this.orgsArea.show(),this.orgTableObject||(this.orgTableObject={}),this.orgItemsObject||(this.orgItemsObject={}),this.orgItemsMap||(this.orgItemsMap={});var e=!1;for(var i in this.orgTableObject)t===i?e=!0:this.orgTableObject[i].hide();e?this.showOrgs(t):this.createOrgs(t)},showOrgs:function(t){this.orgItemMap=this.orgItemsMap[t]||{};var e=this.getVisableOrgData(t);e.length?this.isSameArray(Object.keys(this.orgItemMap),e.map((function(t){return t.name})))?(this.orgTableObject[t].show(),this.orgItems=this.orgItemsObject[t]||[],this.setSize(e.length)):this.loadOrgTable(t):(this.orgsArea.hide(),this.orgItemMap={},this.orgItems=[],this.setSize(0))},createOrgs:function(t){var e=this.getVisableOrgData(t);e.length?this.loadOrgTable(t):(this.setSize(e.length),this.orgItemMap={},this.orgItems=[],this.orgsArea.hide())},loadOrgTable:function(t){this.getOrgData(t);var e=this.getVisableOrgData(t);this.setSize(e.length),this.orgsArea.show();var i=this.orgTableObject[t],s={};i&&i.getElements("td").each((function(t){s[t.retrieve("orgName")]=t}));this.orgItemsObject[t];var o=this.orgItemsMap[t]||{};this.orgItemsObject[t]=[],this.orgItemsMap[t]={},this.orgItems=this.orgItemsObject[t],this.orgItemMap=this.orgItemsMap[t];var n=e.length,a=new Element("table",{cellspacing:0,cellpadding:0,border:0,width:"100%",styles:this.css.routeOrgTable}).inject(this.orgsArea);this.orgTableObject[t]=a;for(var r=((n+1)/2).toInt(),l=0;l<r;l++){var h=new Element("tr").inject(a);new Element("td",{width:"50%",valign:"bottom",styles:this.css.routeOrgOddTd}).inject(h),new Element("td",{width:"50%",valign:"bottom",styles:this.css.routeOrgEvenTd}).inject(h)}var d=a.getElements("tr");e.each(function(t,e){var i;if(e+1==n&&n%2==1)if((i=d[d.length-1].getFirst("td")).set("colspan",2),d[d.length-1].getLast("td").destroy(),i.setStyle("border","0px"),i.set("width","100%"),i.store("orgName",t.name),o[t.name]){var a=o[t.name];this.orgItems.push(a),this.orgItemMap[t.name]=a,s[t.name].getChildren().inject(i)}else this.loadOrg(i,t,"all",!1);else{var r=((e+2)/2).toInt(),l=d[r-1];if((i=e%2==0?l.getFirst("td"):l.getLast("td")).store("orgName",t.name),o[t.name]){a=o[t.name];this.orgItems.push(a),this.orgItemMap[t.name]=a,s[t.name].getChildren().inject(i)}else this.loadOrg(i,t,e%2==0?"left":"right",!1)}}.bind(this)),i&&i.destroy()},loadOrg:function(t,e,i,s){var o=new Element("div.selectorTitle",{styles:this.css.selectorTitle}).inject(t),n=(new Element("div.selectorTitleText",{text:e.title,styles:this.css.selectorTitleText}).inject(o),new Element("div.selectorErrorNode",{styles:this.css.selectorErrorNode}).inject(o)),a=new Element("div.selectorContent",{styles:this.css.selectorContent}).inject(t),r=new MWF.xApplication.process.Work.Processor.Org(a,this.form,e,this);r.ignoreOldData=s,r.errContainer=n,r.summitDlalog=this,r.load(),this.orgItems.push(r),this.orgItemMap[e.name]=r},showOrgsByRoute:function(t){this.loadOrgs(t)},clearAllOrgs:function(){for(var t in this.orgItemsObject){(this.orgItemsObject[t]||[]).each((function(t){t.setDataToOriginal()}))}this.orgTableObject={},this.orgItemsObject={},this.orgItemsMap={},this.orgsArea.empty()},getCurrentRouteSelectorList:function(){var t=[],e=this.selectedRoute?this.selectedRoute.retrieve("route"):"",i=this.orgItemsObject[e];return i?(i.each(function(e){e.selector&&e.selector.selector&&t.push(e.selector.selector)}.bind(this)),t):[]},getCurrentRouteOrgList:function(){var t=this.selectedRoute?this.selectedRoute.retrieve("route"):"";return this.orgItemsObject[t]||[]},getSelectorSelectedData:function(t){for(var e=[],i=this.getCurrentRouteOrgList(),s=0;s<i.length;s++){var o=i[s];if(o.json.name===t)o.selector.selector.selectedItems.each((function(t){e.push(t.data)}))}return e},getOffsetY:function(t){return(t.getStyle("margin-top").toInt()||0)+(t.getStyle("margin-bottom").toInt()||0)+(t.getStyle("padding-top").toInt()||0)+(t.getStyle("padding-bottom").toInt()||0)+(t.getStyle("border-top-width").toInt()||0)+(t.getStyle("border-bottom-width").toInt()||0)},setSize_noform:function(){var t=0;this.managerProcessNoticeNode&&(t=t+this.getOffsetY(this.managerProcessNoticeNode)+this.managerProcessNoticeNode.getStyle("height").toInt()),this.managerLoginNode&&(t=t+this.getOffsetY(this.managerLoginNode)+this.managerLoginNode.getStyle("height").toInt()),this.routeSelectorTile&&(t=t+this.getOffsetY(this.routeSelectorTile)+this.routeSelectorTile.getStyle("height").toInt()),this.routeSelectorArea&&(t=t+this.getOffsetY(this.routeSelectorArea)+this.routeSelectorArea.getStyle("height").toInt()),this.routeOpinionTile&&(t=t+this.getOffsetY(this.routeOpinionTile)+this.routeOpinionTile.getStyle("height").toInt()),this.routeOpinionArea&&(t=t+this.getOffsetY(this.routeOpinionArea)+this.routeOpinionArea.getStyle("height").toInt()),this.node.setStyle("height",t),this.fireEvent("resize")},setSize:function(t,e){layout.mobile?this.setSize_mobile():this.setSize_pc(t,e),e||this.fireEvent("resize")},setSize_mobile:function(){if(this.buttonsArea){var t=$(document.body).getSize().y-this.getOffsetY(this.node);this.node.setStyles({"overflow-y":"hidden",height:t});var e=this.buttonsArea.getSize();this.content.setStyles({height:t-e.y-this.getOffsetY(this.buttonsArea)-this.getOffsetY(this.content),"overflow-y":"auto"})}},setSize_pc:function(t,e){var i=((t+1)/2).toInt(),s=0;this.routeSelectorTile&&(s=s+this.getOffsetY(this.routeSelectorTile)+this.routeSelectorTile.getStyle("height").toInt()),this.routeSelectorArea&&(s=s+this.getOffsetY(this.routeSelectorArea)+this.routeSelectorArea.getStyle("height").toInt()),this.routeOpinionTile&&(s=s+this.getOffsetY(this.routeOpinionTile)+this.routeOpinionTile.getStyle("height").toInt()),this.routeOpinionArea&&(s=s+this.getOffsetY(this.routeOpinionArea)+this.routeOpinionArea.getStyle("height").toInt()),i>0?(this.orgsArea&&this.orgsArea.show(),e?(this.orgsArea.getChildren().each(function(t){s+=t.getSize().y+this.getOffsetY(t)}.bind(this)),this.node.setStyle("height",s)):(this.orgsTile&&(s=s+this.getOffsetY(this.orgsTile)+this.orgsTile.getStyle("height").toInt()),s=s+i*this.options.orgHeight+this.getOffsetY(this.orgsArea),this.node.setStyle("height",s))):(this.orgsArea&&this.orgsArea.hide(),this.node.setStyle("height",s)),this.getMaxOrgLength()>1?(this.node.setStyles(this.css.node_wide),this.inputOpinionNode.setStyles(this.css.inputOpinionNode_wide),this.inputTextarea.setStyles(this.css.inputTextarea_wide),this.inputTextareaStyle=this.css.inputTextarea_wide,this.selectIdeaNode.setStyles(this.css.selectIdeaNode_wide)):(this.node.setStyles(this.css.node),this.inputOpinionNode.setStyles(this.css.inputOpinionNode),this.inputTextarea.setStyles(this.css.inputTextarea),this.inputTextareaStyle=this.css.inputTextarea,this.selectIdeaNode.setStyles(this.css.selectIdeaNode))},isErrorHeightOverflow:function(){var t=!1;return(this.orgItems||[]).each(function(e){e.errorHeightOverflow&&(t=!0)}.bind(this)),t},checkErrorHeightOverflow:function(t){(t||this.isErrorHeightOverflow())&&this.setSize(this.orgItems.length,!0)},errorHeightChange:function(){this.checkErrorHeightOverflow(!0)},validationOrgs:function(){if(!this.orgItems||!this.orgItems.length)return!0;var t=!0;return this.orgItems.each(function(e){e.validation()||(t=!1)}.bind(this)),this.checkErrorHeightOverflow(),t},isOrgsHasEmpower:function(){if(!this.orgItems||!this.orgItems.length)return!0;var t=!1;return this.needCheckEmpowerOrg=[],this.orgItems.each(function(e){e.hasEmpowerIdentity()&&(this.needCheckEmpowerOrg.push(e),t=!0)}.bind(this)),t},saveOrgs:function(t){if(!this.orgItems||!this.orgItems.length)return!0;var e=!0;return this.orgItems.each(function(i){i.save(!t)||(e=!1)}.bind(this)),e},saveOrgsWithCheckEmpower:function(t){var e=this.selectedRoute?this.selectedRoute.retrieve("route"):"",i=this.getVisableOrgData(e||this.selectedRouteId||"").length,s=0;return this.orgItems&&this.orgItems.length&&(s=this.orgItems.length),i!==s?(MWF.xDesktop.notice("error",{x:"center",y:"center"},MWF.xApplication.process.Work.LP.loadedOrgCountUnexpected,this.node,{x:0,y:30},{closeOnBoxClick:!0,closeOnBodyClick:!0,fixed:!0,delayClose:6e3}),!1):this.orgItems&&this.orgItems.length?!!this.validationOrgs()&&(layout.mobile?(t&&t(),!0):this.isOrgsHasEmpower()?void this.showEmpowerDlg(t):(t&&t(),!0)):(t&&t(),!0)},showEmpowerDlg:function(t){for(var e=new Element("div.empowerNode",{styles:this.css.empowerNode}),i=(new Element("div",{text:MWF.xApplication.process.Xform.LP.empowerDlgText,styles:this.css.empowerTitleNode}).inject(e),this.needCheckEmpowerOrg),s=i.length,o=((s+1)/2).toInt(),n=new Element("table",{cellspacing:0,cellpadding:0,border:0,width:"100%",styles:this.css.empowerTable}).inject(e),a=0;a<o;a++){var r=new Element("tr").inject(n);new Element("td",{width:"50%",styles:this.css.empowerOddTd}).inject(r),new Element("td",{width:"50%",styles:this.css.empowerEvenTd}).inject(r)}var l=n.getElements("tr");i.each(function(t,e){var i;if(e+1==s&&s%2==1)(i=l[l.length-1].getFirst("td")).set("colspan",2),l[l.length-1].getLast("td").destroy(),"50%";else{var o=((e+2)/2).toInt(),n=l[o-1];i=e%2==0?n.getFirst("td"):n.getLast("td")}var a=new Element("div.empowerAreaTitle",{styles:this.css.empowerAreaTitle}).inject(i),r=(new Element("div.empowerAreaTitleText",{text:t.json.title,styles:this.css.empowerAreaTitleText}).inject(a),new Element("div",{styles:{float:"right"}}).inject(a)),h=new Element("div.empowerAreaContent",{styles:this.css.empowerAreaContent}).inject(i);t.loadCheckEmpower(null,h,r)}.bind(this)),e.setStyle("height",o*this.options.orgHeight+20);e.setStyle("width","840px"),this.node.getParent().mask({style:this.css.mask}),this.empowerDlg=o2.DL.open({title:MWF.xApplication.process.Xform.LP.selectEmpower,style:this.form.json.dialogStyle||"user",isResize:!1,content:e,width:880,height:"auto",mark:!1,onPostLoad:function(){this.nodeWidth&&this.node.setStyle("width",this.nodeWidth+"px"),this.nodeHeight&&this.node.setStyle("height",this.nodeHeight+"px")},buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(e,s){i.each(function(e,s){e.saveCheckedEmpowerData(function(){s===i.length-1&&(t&&t(),this.node.getParent().unmask(),this.empowerDlg.close())}.bind(this))}.bind(this))}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){this.node.getParent().unmask(),this.empowerDlg.close()}.bind(this)}]})},managerLogin:function(t){var e=this,i=(this.task.identityDn||this.task.identity).split("@")[0],s=MWF.xApplication.process.Work.LP.managerLoginConfirmContent.replace("{user}",i);MWF.xDesktop.confirm("infor",t,MWF.xApplication.process.Work.LP.managerLoginConfirmTitle,s,450,120,(function(){o2.Actions.load("x_organization_assemble_authentication").AuthenticationAction.switchUser({credential:e.task.personDn||e.task.person},function(){var t=MWF.xApplication.process.Work.LP.managerLoginSuccess.replace("{user}",i);MWF.xDesktop.notice("success",{x:"right",y:"top"},t),window.open(o2.filterUrl("../x_desktop/work.html?workid="+e.task.work))}.bind(this)),this.close()}),(function(){this.close()}),null,null)}}),MWF.xApplication.process.Xform&&MWF.xApplication.process.Xform.Form&&(MWF.xDesktop.requireApp("process.Xform","Org",null,!1),MWF.xApplication.process.Work.Processor.Org=new Class({Implements:[Options,Events],options:{moduleEvents:["queryLoadSelector","postLoadSelector","postLoadContent","queryLoadCategory","postLoadCategory","selectCategory","unselectCategory","queryLoadItem","postLoadItem","selectItem","unselectItem","change"]},initialize:function(t,e,i,s,o){this.form=e,this.json=i,this.processor=s,this.container=$(t),this.orgAction=MWF.Actions.get("x_organization_assemble_control"),this.setOptions(o)},load:function(){if(layout.mobile)setTimeout(function(){var t=this.getOptions();t&&(this.selector=new MWF.O2Selector($(document.body),t))}.bind(this),100);else{var t=this.getOptions();t&&(this.selector=new MWF.O2Selector(this.container,t))}},_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.xApplication.process.Work.Processor.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.xApplication.process.Work.Processor.UnitOptions(this.form,this.json))},getOptions:function(){var t=this;if(this._getOrgOptions(),0===this.selectTypeList.length)return!1;var e,i,s,o=[];if(this.json.exclude){var n=this.form.Macro.exec(this.json.exclude.code,this);o="array"===typeOf(n)?n:[n]}this.identityOptions&&(e=this.identityOptions.getOptions(),"all"!==this.json.identityRange&&(e.noUnit||e.units&&e.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange,"error",this.node),e.disabled=!0)),!e.noUnit&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(e.dutys&&e.dutys.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange,"error",this.node),e.disabled=!0)),this.ignoreOldData?e.values=this._computeValue()||[]:e.values=this.getValue()||[],e.exclude=o),this.unitOptions&&(i=this.unitOptions.getOptions(),"all"!==this.json.unitRange&&(i.units&&i.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange,"error",this.node),i.disabled=!0)),this.ignoreOldData?i.values=this._computeValue()||[]:i.values=this.getValue()||[],i.exclude=o),s=layout.mobile?{style:"default",zIndex:3e3}:{style:"process",width:"auto",height:"240",embedded:!0,hasLetter:!1,hasTop:!0},this.json.events&&"object"===typeOf(this.json.events)&&Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.moduleEvents.indexOf(e)&&("postLoadSelector"===e?this.addEvent("loadSelector",function(e){return this.form.Macro.fire(t.code,e)}.bind(this)):"queryLoadSelector"===e?s.onQueryLoad=function(e){return this.form.Macro.fire(t.code,e)}.bind(this):s["on"+e.capitalize()]=function(e){return this.form.Macro.fire(t.code,e)}.bind(this))}.bind(this)),this.needValid()&&(s.onValid=function(t){this.validOnSelect()}.bind(this)),this.form.json.selectorStyle&&(s=Object.merge(Object.clone(this.form.json.selectorStyle),s),this.form.json.selectorStyle.style&&(s.style=this.form.json.selectorStyle.style));var a={onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onClose:this.selectOnClose.bind(this)};if(1===this.selectTypeList.length)return Object.merge(s,{type:this.selectTypeList[0],onLoad:function(){t.selectOnLoad(this,this.selector)}},layout.mobile?a:{},e||i);if(this.selectTypeList.length>1){var r={type:"",types:this.selectTypeList,onLoad:function(){t.selectOnLoad(this)}};return e&&(r.identityOptions=Object.merge(s,layout.mobile?a:{},e)),i&&(r.unitOptions=Object.merge(s,layout.mobile?a:{},i)),r}},selectOnComplete:function(t){var e=[];t.each(function(t){e.push(t.data)}.bind(this));var i="simple"===this.json.storeRange;this.checkEmpower(e,function(e){var s=[];e.each(function(t){s.push(MWF.org.parseOrgData(t,!0,i))}.bind(this)),this.setData(s),this.container.empty(),this.loadOrgWidget(s,this.container),this.selector=null,this.fireEvent("select",[t,s])}.bind(this))},selectOnCancel:function(){},selectOnLoad:function(t){this.fireEvent("loadSelector",[t])},selectOnClose:function(){this._getBusinessData()},loadOrgWidget:function(t,e){var i=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||i||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){"string"===typeOf(t)&&(t={distinguishedName:t,name:o2.name.cn(t)});var i,s=t.distinguishedName.substr(t.distinguishedName.length-1,1),o=Object.clone(t);if(this.json.displayTextScript&&this.json.displayTextScript.code){this.currentData=o;var n=this.form.Macro.exec(this.json.displayTextScript.code,this);n&&(o.displayName=n),this.currentData=null}switch(s.toLowerCase()){case"i":i=new MWF.widget.O2Identity(o,e,{style:"xform",lazy:!0});break;case"p":i=new MWF.widget.O2Person(o,e,{style:"xform",lazy:!0});break;case"u":i=new MWF.widget.O2Unit(o,e,{style:"xform",lazy:!0});break;case"g":i=new MWF.widget.O2Group(o,e,{style:"xform",lazy:!0});break;default:i=new MWF.widget.O2Other(o,e,{style:"xform",lazy:!0})}i.field=this,layout.mobile}.bind(this))},hasEmpowerIdentity:function(){var t=this.getData();return this.empowerChecker||(this.empowerChecker=new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form,this.json,this.processor)),this.empowerChecker.hasEmpowerIdentity(t)},checkEmpower:function(t,e,i,s){"array"===typeOf(t)&&this.identityOptions&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType?(this.empowerChecker||(this.empowerChecker=new MWF.xApplication.process.Work.Processor.EmpowerChecker(this.form,this.json,this.processor)),this.empowerChecker.selectAllNode=s,this.empowerChecker.load(t,e,i)):e&&e(t)},loadCheckEmpower:function(t,e,i){this.checkEmpower(this.getData(),t,e,i)},saveCheckedEmpowerData:function(t){var e=this.getData(),i="simple"===this.json.storeRange;this.empowerChecker.setIgnoreEmpowerFlag(e,function(e){var s=[];e.each(function(t){s.push(MWF.org.parseOrgData(t,!0,i))}.bind(this)),this.setData(s),t&&t(s)}.bind(this))},save:function(t){return t?!!this.validation()||(this.processor.checkErrorHeightOverflow(),!1):(this.setData(this.getData()),!0)},resetSelectorData:function(){this.selector&&this.selector.selector&&(this.selector.selector.emptySelectedItems(),this.selector.selector.options.values=this.getValue()||[],this.selector.selector.setSelectedItem())},setDataToOriginal:function(){var t=this._computeValue();this.setData(t||"")},resetData:function(){var t=this.getValue()||[];this.setData(t)},getData:function(){return this.selector&&!layout.mobile?this.getSelectedData():this.getValue()},getSelectedData:function(){if(layout.mobile)return this.getValue();var t="simple"===this.json.storeRange,e=[];return this.selector&&this.selector.selector&&this.selector.selector.selectedItems.each((function(i){e.push(MWF.org.parseOrgData(i.data,!0,t))})),e},getValue:function(){var t=this._getBusinessData();return t||(t=this._computeValue()),t||""},_computeValue:function(){var t=[];if(this.json.identityValue&&this.json.identityValue.each((function(e){e&&t.push(e)})),this.json.unitValue&&this.json.unitValue.each((function(e){e&&t.push(e)})),this.json.dutyValue){var e,i=JSON.decode(this.json.dutyValue);i.length&&i.each(function(i){i.code&&(e=this.form.Macro.exec(i.code,this));var s='return this.org.getDuty("'+i.name+'", "'+e+'")',o=this.form.Macro.exec(s,this);"array"!==typeOf(o)&&(o=o?[o.toString()]:[]),o.each((function(e){e&&t.push(e)}))}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var s=this.form.Macro.exec(this.json.defaultValue.code,this);"array"!==typeOf(s)&&(s=s?[s]:[]),s.each(function(e){var i;e&&("string"===typeOf(e)?(this.getOrgAction()[this.getValueMethod(e)](function(t){i=t.data}.bind(this),null,e,!1),t.push(i)):t.push(e))}.bind(this))}return this.json.count>0?t.slice(0,this.json.count):t},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},setData:function(t){if(!t)return!1;var e,i=this.getValue(),s=[],o="simple"===this.json.storeRange,n=typeOf(t);("array"===n&&t.each(function(t){var e=typeOf(t),i=null;"string"===e&&this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),error,t,!1),"object"===e&&(i=MWF.org.parseOrgData(t,!0,o)).woPerson&&delete i.woPerson,i&&s.push(i)}.bind(this)),"string"===n)&&(this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),error,t,!1),e&&s.push(e));"object"===n&&((e=MWF.org.parseOrgData(t,!0,o)).woPerson&&delete e.woPerson,s.push(e));var a=!1;if(i.length&&s.length)if(i.length===s.length){for(var r=0;r<i.length;r++)if(i[r].distinguishedName!==s[r].distinguishedName||i[r].name!==s[r].name||i[r].unique!==s[r].unique){a=!0;break}}else a=!0;else(s.length||i.length)&&(a=!0);this._setBusinessData(s),a&&this.fireEvent("change")},getValueMethod:function(t){if(t)switch(t.substr(t.length-1,1).toLowerCase()){case"i":return"getIdentity";case"p":return"getPerson";case"u":return"getUnit";case"g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},_getBusinessData:function(){return"yes"==this.json.section?this._getBusinessSectionData():"Opinion"===this.json.type?this._getBusinessSectionDataByPerson():this.form.businessData.data[this.json.name]||""},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript.code);default:return this.form.businessData.data[this.json.name]||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.name]=layout.desktop.session.user.id;var t=this.form.businessData.data[this.json.name];return t&&t[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.task?this.form.businessData.task.unit:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.work?this.form.businessData.work.activity:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.name]="";var t=this.form.businessData.work?this.form.businessData.work.splitValue:"";t&&(this.form.sectionListObj[this.json.name]=t);var e=this.form.businessData.data[this.json.name];return e&&t&&e[t]||""},_getBusinessSectionDataByScript:function(t){this.form.sectionListObj[this.json.name]="";var e=this.form.businessData.data[this.json.name];if(!e)return"";var i=this.form.Macro.exec(t,this);return i&&(this.form.sectionListObj[this.json.name]=i),i&&e[i]||""},loadPathData:function(t){var e=null;return this.form.workAction.getJobDataByPath(this.form.businessData.work.job,t,(function(t){e=t.data||null}),null,!1),e},_setBusinessData:function(t){"yes"==this.json.section?this._setBusinessSectionData(t):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(t):(this.form.businessData.data[this.json.name]?this.form.businessData.data[this.json.name]=t:(this.form.businessData.data[this.json.name]=t,this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=t))},_setBusinessSectionData:function(t){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(t);break;case"unit":this._setBusinessSectionDataByUnit(t);break;case"activity":this._setBusinessSectionDataByActivity(t);break;case"splitValue":this._setBusinessSectionDataBySplitValue(t);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,t);break;default:this.form.businessData.data[this.json.name]?this.form.businessData.data[this.json.name]=t:(this.form.businessData.data[this.json.name]=t,this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(t){var e=!1,i=layout.desktop.session.user.id;this.form.sectionListObj[this.json.name]=i;var s=this.form.businessData.data[this.json.name];s||(s={},this.form.businessData.data[this.json.name]=s,e=!0),s[i]||(e=!0),s[i]=t,e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(t){var e=!1,i=this.form.businessData.task?this.form.businessData.task.unit:"";if(i){this.form.sectionListObj[this.json.name]=i;var s=this.form.businessData.data[this.json.name];s||(s={},this.form.businessData.data[this.json.name]=s,e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.activity:"";if(i){this.form.sectionListObj[this.json.name]=i;var s=this.form.businessData.data[this.json.name];s||(s={},this.form.businessData.data[this.json.name]=s,e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(t){var e=!1,i=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(i){this.form.sectionListObj[this.json.name]=i;var s=this.form.businessData.data[this.json.name];s||(s={},this.form.businessData.data[this.json.name]=s,e=!0),s[i]||(e=!0),s[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(t,e){var i=!1,s=this.form.Macro.exec(t,this);if(s){this.form.sectionListObj[this.json.name]=s;var o=this.form.businessData.data[this.json.name];o||(o={},this.form.businessData.data[this.json.name]=o,i=!0),o[s]||(i=!0),o[s]=e}i&&this.form.Macro.environment.setData(this.form.businessData.data)},createErrorNode:function(t){var e,i=this;if(this.processor.css.errorContentNode){if(e=new Element("div",{styles:this.processor.css.errorContentNode,text:t}),this.processor.css.errorCloseNode)new Element("div",{styles:this.processor.css.errorCloseNode,events:{click:function(){this.destroy(),i.errorHeightOverflow&&(i.errorHeightOverflow=!1,i.processor.errorHeightChange())}.bind(e)}}).inject(e)}else{e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{height:"auto","min-height":"20px","line-height":"20px","margin-left":"20px",color:"red","word-break":"break-all"},text:t}).inject(e)}return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.errNode=this.createErrorNode(t),this.errContainer?(this.errContainer.empty(),this.errNode.inject(this.errContainer)):this.errNode.inject(this.container,"after");var e=this.errNode.getSize();!layout.mobile&&e.y>26&&(this.errorHeightOverflow=!0)}},needValid:function(){return this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())||this.json.validation&&this.json.validation.code},validOnSelect:function(){if(!this.errNode)return!0;var t=!0;if(this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())&&this.selector.selector.selectedItems.length<this.json.validationCount.toInt()&&(t=MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}",this.json.validationCount)),!0===t&&this.json.validation&&this.json.validation.code){var e=this.getData();this.setData(e),(t=this.form.Macro.exec(this.json.validation.code,this))||(t=MWF.xApplication.process.Xform.LP.notValidation)}return"true"!=t.toString()?(this.notValidationMode(t),this.processor.errorHeightChange(),!1):(this.errNode&&(this.errNode.destroy(),this.errNode=null,this.errorHeightOverflow&&(this.errorHeightOverflow=!1,this.processor.errorHeightChange())),!0)},validation:function(){var t=this.getData();this.setData(t);var e=!0;return this.json.validationCount&&"number"===typeOf(this.json.validationCount.toInt())&&t.length<this.json.validationCount.toInt()&&(e=MWF.xApplication.process.Xform.LP.selectItemCountNotice.replace("{count}",this.json.validationCount)),!0===e&&this.json.validation&&this.json.validation.code&&((e=this.form.Macro.exec(this.json.validation.code,this))||(e=MWF.xApplication.process.Xform.LP.notValidation)),"true"!=e.toString()?(this.notValidationMode(e),!1):(this.errNode&&(this.errNode.destroy(),this.errNode=null),!0)}}),MWF.xApplication.process.Work.Processor.EmpowerChecker=new Class({Extends:MWF.APPOrg.EmpowerChecker,initialize:function(t,e,i){this.form=t,this.json=e,this.processor=i,this.css=this.processor.css,this.checkedAllItems=!0},load:function(t,e,i){if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var s=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&s.push(t.distinguishedName))}.bind(this)),s.length>0?o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:s},function(s){var o=[];s.data.each((function(t){t.fromIdentity!==t.toIdentity&&o.push(t)})),o.length>0?layout.mobile?this.openSelectEmpowerDlg(o,t,e,i):this.openSelectEmpowerDlg_embedded(o,t,e,i):e&&e(t)}.bind(this),function(){e&&e(t)}.bind(this)):e&&e(t)}else e&&e(t)},hasEmpowerIdentity:function(t){var e=!1;if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var i=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&i.push(t.distinguishedName))}.bind(this)),i.length>0&&o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:i},function(t){var i=[];t.data.each((function(t){t.fromIdentity!==t.toIdentity&&i.push(t)})),i.length>0&&(e=!0)}.bind(this),null,!1)}return e},openSelectEmpowerDlg_embedded:function(t,e,i,s){var o=new Element("div",{styles:this.css.empowerAreaNode});o.set("html",'<div style="margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>');var n=o.getLast();if(this.getEmpowerItems(n,t),o.inject(s||this.form.app.content),this.selectAllNode){var a=this.createSelectAllEmpowerNode();a.inject(this.selectAllNode),this.checkedAllItems&&(a.store("isSelected",!0),a.setStyles(this.css.empowerSelectAllItemNode_selected))}},getSelectedData:function(t){var e={};this.empowerSelectNodes.each(function(t){if(t.retrieve("isSelected")){var i=t.retrieve("data");e[i.fromIdentity]=i}}.bind(this)),t&&t(e)}}),MWF.xApplication.process.Work.Processor.UnitOptions=new Class({Extends:MWF.APPOrg.UnitOptions}),MWF.xApplication.process.Work.Processor.IdentityOptions=new Class({Extends:MWF.APPOrg.IdentityOptions}));
//# sourceMappingURL=$all.min.js.map