MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.Xform.Org=MWF.APPOrg=new Class({Implements:[Events],Extends:MWF.APP$Input,options:{moduleEvents:["load","queryLoad","postLoad","change","select"],selectorEvents:["queryLoadSelector","postLoadSelector","queryLoadContent","postLoadContent","queryLoadCategory","postLoadCategory","selectCategory","unselectCategory","queryLoadItem","postLoadItem","selectItem","unselectItem","change","expand","collapse"],readonly:!0},iconStyle:"orgIcon",getTextData:function(){var t=this.getValue(),e=[];return"object"===typeOf(t)&&(t=[t]),"array"===typeOf(t)?(t.each(function(t){"string"===typeOf(t)?e.push(t):e.push(t.name+(t.unitName?"("+t.unitName+")":""))}.bind(this)),{value:t||"",text:[e.join(",")]}):{value:[""],text:[""]}},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly){var t=this._getBusinessData();if((!t||!t.length)&&this.json.description){var e=this.node.getFirst().getSize(),i=e.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(i-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:i+"px",height:e.y+"px","line-height":e.y+"px"}),this.setDescriptionEvent()}}},setDescriptionEvent:function(){this.descriptionNode&&this.descriptionNode.addEvents({mousedown:function(t){this.descriptionNode.setStyle("display","none"),this.clickSelect(t)}.bind(this)})},_loadNode:function(){this.field=!0,this.readonly||this.json.isReadonly?this._loadNodeRead():(this._getOrgOptions(),this.json.isInput?this._loadNodeInputEdit():this._loadNodeEdit())},_getOrgOptions:function(){this.selectTypeList="array"==typeOf(this.json.selectType)?this.json.selectType:[this.json.selectType],this.selectTypeList.contains("identity")&&(this.identityOptions=new MWF.APPOrg.IdentityOptions(this.form,this.json)),this.selectTypeList.contains("unit")&&(this.unitOptions=new MWF.APPOrg.UnitOptions(this.form,this.json)),this.selectTypeList.contains("group")&&(this.groupOptions=new MWF.APPOrg.GroupOptions(this.form,this.json))},_valueMerge:function(t,e){return"function"==o2.typeOf(e)?e.then(function(e){this._valueMerge(t,e)}.bind(this),(function(){})):t.concat(e)},_computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,n=JSON.decode(this.json.dutyValue);n.length&&n.each(function(n){if(n.code&&(i=this.form.Macro.exec(n.code,this)),i){var s="array"==o2.typeOf(i)?i:[i],o=Promise.all(s).then(function(e){var i=e.distinguishedName||e;"array"==o2.typeOf(e)&&(i=e[0].distinguishedName||e[0]);var s='return this.org.getDuty("'+n.name+'", "'+i+'", true)',o=i?this.form.Macro.exec(s,this):"",r="array"==o2.typeOf(o)?"all":"resolve";return Promise[r](o).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this)).catch((function(){console.log("catch error : can not get duty : "+n.name,NaN+i)}))}.bind(this),(function(){}));e.push(o)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var s=this.form.Macro.exec(this.json.defaultValue.code,this);"array"==o2.typeOf(s)?s.each((function(t){e.push(t)})):e.push(s)}return e},__computeValue:function(){var t="simple"===this.json.storeRange,e=[];if(this.json.identityValue&&this.json.identityValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.unitValue&&this.json.unitValue.each((function(i){i&&e.push(MWF.org.parseOrgData(i,!0,t))})),this.json.dutyValue){var i,n=JSON.decode(this.json.dutyValue);n.length&&n.each(function(n){if(n.code&&(i=this.form.Macro.exec(n.code,this)),i&&i.isAG){var s=o2.AG.all(i).then(function(e){var i="";e&&e.length&&(i=e[0].distinguishedName||e[0]);var s='return this.org.getDuty("'+n.name+'", "'+i+'", true)',o=this.form.Macro.exec(s,this);o2.AG.all(o).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this))}.bind(this));e.push(s)}else{var o='return this.org.getDuty("'+n.name+'", "'+i+'", true)',r=this.form.Macro.exec(o,this);s=o2.AG.all(r).then(function(e){"array"!==typeOf(e)&&(e=e?[e.toString()]:[]);var i=[];return e.each((function(e){e&&i.push(MWF.org.parseOrgData(e,!0,t))})),i}.bind(this));e.push(s)}}.bind(this))}if(this.json.defaultValue&&this.json.defaultValue.code){var s=this.form.Macro.exec(this.json.defaultValue.code,this);s&&s.isAG?e.push(s):("array"!==typeOf(s)&&(s=s?[s]:[]),s.each(function(i){var n;i&&("string"===typeOf(i)?(this.getOrgAction()[this.getValueMethod(i)](function(e){n=MWF.org.parseOrgData(e.data,!0,t)}.bind(this),null,i,!1),e.push(n)):e.push(i))}.bind(this)))}return this.json.count>0?e.slice(0,this.json.count):e},getOrgAction:function(){return this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),this.orgAction},getOptions:function(){var t=this;if(0===this.selectTypeList.length)return!1;var e,i,n,s=this.getInputData()||[],o=[];if(this.json.exclude){var r=this.form.Macro.exec(this.json.exclude.code,this);o="array"===typeOf(r)?r:[r]}this.identityOptions&&(e=this.identityOptions.getOptions(),"all"!==this.json.identityRange&&(e.noUnit||e.units&&e.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange,"error",this.node),e.disabled=!0)),!e.noUnit&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(e.dutys&&e.dutys.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange,"error",this.node),e.disabled=!0)),e.values=this.json.isInput?[]:s,e.exclude=o,this.form.json.selectorStyle&&(e=Object.merge(e,this.form.json.selectorStyle))),this.unitOptions&&(i=this.unitOptions.getOptions(),"all"!==this.json.unitRange&&(i.units&&i.units.length||(this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange,"error",this.node),i.disabled=!0)),i.values=this.json.isInput?[]:s,i.exclude=o,this.form.json.selectorStyle&&(i=Object.merge(i,this.form.json.selectorStyle))),this.groupOptions&&((n=this.groupOptions.getOptions()).values=this.json.isInput?[]:s,n.exclude=o,this.form.json.selectorStyle&&(n=Object.merge(n,this.form.json.selectorStyle)));var a={};if(this.json.events&&"object"===typeOf(this.json.events)&&Object.each(this.json.events,function(t,e){t.code&&-1!==this.options.selectorEvents.indexOf(e)&&("postLoadSelector"===e?this.addEvent("loadSelector",function(e){return this.form.Macro.fire(t.code,e)}.bind(this)):"queryLoadSelector"===e?a.onQueryLoad=function(e){return this.form.Macro.fire(t.code,e)}.bind(this):a["on"+e.capitalize()]=function(e){return this.form.Macro.fire(t.code,e)}.bind(this))}.bind(this)),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0],onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this,this.selector)},onClose:this.selectOnClose.bind(this)},a,e||i||n);if(this.selectTypeList.length>1){var h={type:"",types:this.selectTypeList,onComplete:function(t){this.selectOnComplete(t)}.bind(this),onCancel:this.selectOnCancel.bind(this),onLoad:function(){t.selectOnLoad(this)},onClose:this.selectOnClose.bind(this)};return this.form.json.selectorStyle&&(h=Object.merge(h,this.form.json.selectorStyle)),e&&(h.identityOptions=Object.merge({},a,e)),i&&(h.unitOptions=Object.merge({},a,i)),n&&(h.groupOptions=Object.merge({},a,n)),h}},selectOnComplete:function(t){var e=[];t.each(function(t){e.push(t.data)}.bind(this));var i="simple"===this.json.storeRange;this.checkEmpower(e,function(t){var e=[];t.each(function(t){e.push(MWF.org.parseOrgData(t,!0,i))}.bind(this)),this.json.isInput?this.addData(e):this.setData(e),this.validationMode(),this.validation();var n=this.getValue();n.then?n.then(function(){this.fireEvent("select")}.bind(this),(function(){})):this.fireEvent("select")}.bind(this))},selectOnCancel:function(){this.validation()},selectOnLoad:function(t){this.descriptionNode&&this.descriptionNode.setStyle("display","none"),this.fireEvent("loadSelector",[t])},selectOnClose:function(){v=this._getBusinessData(),v&&v.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")},clickSelect:function(t){if(!this.readonly)if(layout.mobile)setTimeout(function(){var t=this.getOptions();t&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,t)))}.bind(this),100);else{var e=this.getOptions();e&&(this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,e)))}},resetData:function(){var t=this.getValue();this.setData(t)},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){return this.json.isInput&&this.combox?this.combox.getData():this.node.retrieve("data")},_loadNodeRead:function(){this.node.empty();new Element("div").inject(this.node);this.node.set({nodeId:this.json.id,MWFType:this.json.type})},_searchConfirmPerson:function(t){var e=t.inforNode||new Element("div"),i="simple"===this.json.storeRange;if(t.data){var n=t.data;if(this.selectTypeList.contains("identity")&&"person"===this.json.identityResultType){var s=n.distinguishedName||n;"i"===s.substr(s.length-1,1).toLowerCase()&&MWF.Actions.get("x_organization_assemble_express").listPersonWithIdentity({identityList:[s]},function(e){e.data.length>0&&(n.person&&(e.data[0].id=n.person),t.data=MWF.org.parseOrgData(e.data[0],!0,i),t.value=this.getDataText(t.data),t.node&&t.node.set("text",t.value))}.bind(this),null,!1)}t.data&&(t.data.createTime||t.data.updateTime)&&(t.data=MWF.org.parseOrgData(t.data,!0,i));var o="";switch(t.data.distinguishedName.substr(t.data.distinguishedName.length-2,2).toLowerCase()){case"@i":o=t.data.name+"("+t.data.unitName+")";break;case"@p":o=t.data.name+(t.data.employee?"("+t.data.employee+")":"");break;case"@u":o=t.data.levelName;break;case"@g":o=t.data.name;break;default:o=t.data.name}e.set({styles:{"font-size":"14px",color:""},text:o})}else e.set({styles:{"font-size":"14px",color:"#bd0000"},text:MWF.xApplication.process.Xform.LP.noOrgObject});t.inforNode||(new mBox.Tooltip({content:e,setStyles:{content:{padding:15,lineHeight:20}},attach:t.node,transition:"flyin"}),t.inforNode=e)},getSearchOptions:function(){if(0===this.selectTypeList.length)return!1;var t,e,i;if(this.identityOptions&&(t=this.identityOptions.getSearchOptions()),this.unitOptions&&(e=this.unitOptions.getSearchOptions()),this.groupOptions&&(i=this.groupOptions.getOptions()),1===this.selectTypeList.length)return Object.merge({type:this.selectTypeList[0]},t||e||i);if(this.selectTypeList.length>1){var n={type:"",types:this.selectTypeList};return t&&(n.identityOptions=t),e&&(n.unitOptions=e),i&&(n.groupOptions=i),n}},_searchOptions:function(t,e){var i=this.getSearchOptions();this.comboxFilter||(this.comboxFilter=new MWF.O2SelectorFilter(t,i)),this.comboxFilter.filter(t,(function(t){t.map((function(t){var e=Object.clone(t);switch(t.value=e,t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":t.text=t.name+"("+t.unitName+")";break;case"@p":t.text=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":t.text=t.name;break;default:t.text=t.name}})),e&&e(t)}))},_resetNodeInputEdit:function(){var t=new Element("div",{styles:{overflow:"hidden","margin-right":"20px"}}).inject(this.node,"after");this.node.destroy(),this.node=t},_loadNodeInputEdit:function(){this.node.setStyle("overflow","visible");var t=null;MWF.require("MWF.widget.Combox",function(){this.combox=t=new MWF.widget.Combox({count:this.json.count||0,splitShow:this.json.splitShow||", ",onCommitInput:function(t){this._searchConfirmPerson(t)}.bind(this),onChange:function(){this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData()),this.fireEvent("change")}.bind(this),optionsMethod:this._searchOptions.bind(this)})}.bind(this),!1),t.setStyles({background:"transparent",border:"0px"}),t.set(this.json.properties),this.json.preprocessing||this._resetNodeInputEdit(),this.node.empty(),t.inject(this.node),this.node.set({id:this.json.id,MWFType:this.json.type}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.combox.addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},_resetNodeEdit:function(){var t=new Element("div",{styles:{background:"transparent",border:"0px","min-height":"24px"}}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","min-height":"24px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,events:{click:function(t){this.clickSelect(t)}.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:function(t){this.clickSelect(t)}.bind(this)}}).inject(this.node,"before"),this.node.getFirst().setStyle("height","auto"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this.node.store("data",this.getInputData()),this._setBusinessData(this.getInputData("change")))}.bind(this))},getDataText:function(t){if("string"==typeOf(t))return t;var e="";switch(t.distinguishedName.substr(t.distinguishedName.length-2,2).toLowerCase()){case"@i":e=t.name+"("+t.unitName+")";break;case"@p":e=t.name+(t.employee?"("+t.employee+")":"");break;case"@u":case"@g":e=t.name;break;default:e=t.name}return e},addData:function(t){if(!t)return!1;var e="simple"===this.json.storeRange;t.each(function(t){var i,n=typeOf(t);"string"===n&&(this.getOrgAction()[this.getValueMethod(t)](function(t){i=MWF.org.parseOrgData(t.data,!0,e)}.bind(this),null,t,!1),i&&this.combox.addNewValue(this.getDataText(i),i));if("object"===n){var s=MWF.org.parseOrgData(t,!0,e);this.combox.addNewValue(this.getDataText(s),s)}}.bind(this))},checkChange:function(t,e){var i=!1;if(e||(e=[]),t.length&&e&&e.length)if(t.length===e.length){for(var n=0;n<t.length;n++)if(t[n].distinguishedName!==e[n].distinguishedName||t[n].name!==e[n].name||t[n].unique!==e[n].unique){i=!0;break}}else i=!0;else(e.length||t.length)&&(i=!0);i&&this.fireEvent("change")},setData:function(t){if(!t)return!1;var e=this.getData();1!=t.length||t[0]||(t=[]),this._setValue(t).then(function(t){o2.promiseAll(t).then(function(t){this.checkChange(e,t)}.bind(this),(function(){}))}.bind(this),(function(){}))},creteShowNode:function(t,e){var i=t.text?t.text:t;e||(i+=this.json.splitShow||", ");var n=new Element("div",{styles:{float:"left","margin-right":"5px"},text:i}),s="";if(t.value){switch(t.value.distinguishedName.substr(t.value.distinguishedName.length-2,2).toLowerCase()){case"@i":s=t.value.name+"("+t.value.unitName+")";break;case"@p":s=t.value.name+(t.value.employee?"("+t.value.employee+")":"");break;case"@u":s=t.value.levelName;break;case"@g":s=t.value.name;break;default:s=t.value.name}var o=new Element("div").set({styles:{"font-size":"14px",color:""},text:s});new mBox.Tooltip({content:o,setStyles:{content:{padding:15,lineHeight:20}},attach:n,transition:"flyin"})}return n},_setValue:function(t){var e=[],i=[],n="simple"===this.json.storeRange;"array"!==typeOf(t)&&(t=t?[t]:[]);var s=o2.promiseAll(t).then(function(t){return"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){"array"!==typeOf(t)&&(t=t?[t]:[]),t.each(function(t){if(t)if("string"===typeOf(t)){var s=this.getOrgAction()[this.getValueMethod(t)](function(t){return MWF.org.parseOrgData(t.data,!0,n)}.bind(this),null,t,!0).catch((function(t){console.log("error:"+t),console.log(t)}));i.push(s)}else e.push(t)}.bind(this))}.bind(this)),i.length?o2.promiseAll(i).then(function(t){return e=e.concat(t),!0,this.__setValue(e),e}.bind(this),(function(){})):(!0,this.__setValue(e),e)}.bind(this),(function(){}));return this.moduleValueAG=s,s&&s.then&&s.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this)),s},__setValue:function(t){this.moduleValueAG=null,1!=t.length||t[0]||(t=[]),this.json.count>0&&(t=t.slice(0,this.json.count));var e,i=[],n=[],s=typeOf(t),o="simple"===this.json.storeRange;if("array"===s&&t.each(function(t){var e=null,s=typeOf(t);if("string"===s){var r=this.json.isInput?function(){n.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){e=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),r,t,!1)}if("object"===s&&(e=t),e){var a=MWF.org.parseOrgData(e,!0,o);i.push(a),n.push({text:this.getDataText(a),value:a})}}.bind(this)),"string"===s){var r,a=this.json.isInput?function(){n.push(t)}:null;this.getOrgAction()[this.getValueMethod(t)](function(t){r=MWF.org.parseOrgData(t.data,!0,o)}.bind(this),a,t,!1),r&&(i.push(r),n.push({text:this.getDataText(r),value:r}))}if("object"===s){var h=MWF.org.parseOrgData(t,!0,o);i.push(h),n.push({text:this.getDataText(h),value:h})}(this.node.store("data",i),this._setBusinessData(i),this.json.isInput)?this.combox?(this.combox.clear(),this.combox.addNewValues(n)):(e=this.node.getFirst())&&(e.empty(),n.each(function(t,i){this.creteShowNode(t,i===n.length-1).inject(e)}.bind(this))):this.node.getFirst()?((e=this.node.getFirst()).empty(),this.loadOrgWidget(i,e)):(this.node.empty(),this.loadOrgWidget(i,this.node))},getValueMethod:function(t){if(t)switch(t.substr(t.length-2,2).toLowerCase()){case"@i":return"getIdentity";case"@p":return"getPerson";case"@u":return"getUnit";case"@g":return"getGroup";default:return"unit"===this.json.selectType?"getUnit":"getIdentity"}return"unit"===this.json.selectType?"getUnit":"getIdentity"},loadOrgWidget:function(t,e){var i=!!layout.mobile;"no"===this.json.showCard&&(i=!0);var n=e.getStyle("height").toInt();"visible"!==e.getStyle("overflow")||n||e.setStyle("overflow","hidden"),t&&t.length&&t.each(function(t){var n,s=t.distinguishedName.substr(t.distinguishedName.length-2,2),o=Object.clone(t);if(this.json.displayTextScript&&this.json.displayTextScript.code){this.currentData=o;var r=this.form.Macro.exec(this.json.displayTextScript.code,this);r&&(o.displayName=r),this.currentData=null}switch(s.toLowerCase()){case"@i":n=new MWF.widget.O2Identity(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@p":n=new MWF.widget.O2Person(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@u":n=new MWF.widget.O2Unit(o,e,{style:"xform",lazy:!0,disableInfor:i});break;case"@g":n=new MWF.widget.O2Group(o,e,{style:"xform",lazy:!0,disableInfor:i});break;default:n=new MWF.widget.O2Other(o,e,{style:"xform",lazy:!0,disableInfor:i})}n.field=this,layout.mobile&&n.node.setStyles({float:"none"})}.bind(this))},_loadStyles:function(){if(this.readonly||this.json.isReadonly)this.json.styles&&this.node.setStyles(this.json.styles);else if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},checkEmpower:function(t,e){"array"===typeOf(t)&&this.identityOptions&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType?new MWF.APPOrg.EmpowerChecker(this.form,this.json).load(t,e):e&&e(t)}}),MWF.APPOrg.EmpowerChecker=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.css=this.form.css,this.checkedAllItems=!0},load:function(t,e,i){if("array"===typeOf(t)&&this.json.isCheckEmpower&&"identity"===this.json.identityResultType){var n=[];t.each(function(t){t.distinguishedName&&("i"===t.distinguishedName.substr(t.distinguishedName.length-1,1).toLowerCase()&&n.push(t.distinguishedName))}.bind(this)),n.length>0?o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({application:(this.form.businessData.work||this.form.businessData.workCompleted).application,process:(this.form.businessData.work||this.form.businessData.workCompleted).process,work:(this.form.businessData.work||this.form.businessData.workCompleted).id,identityList:n},function(n){var s=[];n.data.each((function(t){t.fromIdentity!==t.toIdentity&&s.push(t)})),s.length>0?this.openSelectEmpowerDlg(s,t,e,i):e&&e(t)}.bind(this),function(){e&&e(t)}.bind(this)):e&&e(t)}else e&&e(t)},getIgnoreEmpowerArray:function(t){var e=[];return this.empowerSelectNodes&&this.empowerSelectNodes.length&&this.empowerSelectNodes.each(function(t){if(!t.retrieve("isSelected")){var i=t.retrieve("data");e.push(i.fromIdentity)}}.bind(this)),t&&t(e),e},setIgnoreEmpowerFlag:function(t,e){for(var i=this.getIgnoreEmpowerArray(),n=0;n<t.length;n++){var s=t[n];i.indexOf(s.distinguishedName)>-1?s.ignoreEmpower=!0:s.ignoreEmpower&&delete s.ignoreEmpower}e&&e(t)},replaceEmpowerIdentity:function(t,e){var i={};if(this.empowerSelectNodes.each(function(t){if(t.retrieve("isSelected")){var e=t.retrieve("data");i[e.fromIdentity]=e}}.bind(this)),0===Object.keys(i).length)e(t);else{var n=[];for(var s in i)n.push(i[s].toIdentity);o2.Actions.get("x_organization_assemble_express").listIdentity({identityList:n},(function(n){var s=t.clone(),o={};n.data.each((function(t){o[t.distinguishedName]=t}));for(var r=0;r<s.length;r++){var a=s[r];a.distinguishedName&&i[a.distinguishedName]&&o[i[a.distinguishedName].toIdentity]&&(s[r]=o[i[a.distinguishedName].toIdentity])}e(s)}),(function(){e(t)}))}},openSelectEmpowerDlg:function(t,e,i,n){layout.mobile?this.openSelectEmpowerDlg_mobile(t,e,i,n):this.openSelectEmpowerDlg_pc(t,e,i,n)},openSelectEmpowerDlg_mobile:function(t,e,i,n){var s=[],o=[];if(t.each(function(t){s.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity}),o.push({name:t.fromIdentity.split("@")[0]+" "+MWF.xApplication.process.Xform.LP.empowerTo+" "+t.toIdentity.split("@")[0],id:t.fromIdentity+"#"+t.toIdentity})}.bind(this)),0!==s.length){var r=Array.clone(s);o2.xDesktop.requireApp("Template","Selector.Custom",function(){var t={count:0,title:MWF.xApplication.process.Xform.LP.selectEmpower,selectAllEnable:!0,selectableItems:s,expand:!1,category:!1,values:o,zIndex:3001,closeOnclickOk:!0,onComplete:function(t){var n=[];t.each(function(t){n.push(t.data.id)}.bind(this));var s=[];r.each((function(t){-1===n.indexOf(t.id)&&s.push(t.id.split("#")[0])}));for(var o=0;o<e.length;o++){var a=e[o];s.indexOf(a.distinguishedName)>-1?a.ignoreEmpower=!0:a.ignoreEmpower&&delete a.ignoreEmpower}i&&i(e)}.bind(this)};this.form.json.selectorStyle&&Object.merge(t,this.form.json.selectorStyle),t.flatCategory=!1,new o2.xApplication.Template.Selector.Custom($(document.body),t).load()}.bind(this))}else i()},openSelectEmpowerDlg_pc:function(t,e,i,n){var s=new Element("div",{styles:this.css.empowerAreaNode}),o='<div style="line-height: 20px; color: #333333; overflow: hidden">'+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";o+='<div style="margin-bottom:10px; margin-top:10px; overflow-y:auto;"></div>',s.set("html",o);var r=s.getLast();this.getEmpowerItems(r,t),s.inject(n||this.form.app.content);var a=o2.DL.open({title:MWF.xApplication.process.Xform.LP.selectEmpower,style:this.form.json.dialogStyle||"user",isResize:!0,content:s,width:630,buttonList:[{type:"ok",text:MWF.LP.process.button.ok,action:function(t,n){this.setIgnoreEmpowerFlag(e,i),a.close()}.bind(this)},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){a.close()}}],onPostShow:function(){if(this.createSelectAllEmpowerNode().inject(a.button),layout.mobile){a.node.inject($(document.body)),a.node.setStyles({width:"100%",height:"100%",top:"0px",left:"0px"});var t=a.node.getSize().y-190;r.setStyle("height",t+"px"),a.options.contentHeight=a.node.getSize().y-100,a.setContentSize()}else{a.content.setStyle("overflow","hidden");t=Math.min(300,r.getSize().y),r.getStyle("margin-top"),r.getStyle("margin-bottom");r.setStyle("height",t+"px"),a.options.contentHeight=t+30+20,a.setContentSize(),a.node.setStyles({height:a.options.height+"px"}),a.reCenter()}}.bind(this)})},getEmpowerItems:function(t,e){var i=this;this.empowerSelectNodes=[];var n,s=1;e.each(function(e){if(e.fromIdentity!=e.toIdentity){s%2==1?(n=new Element("div",{styles:this.css.empowerItemOddNode}).inject(t)).store("nodeType","Odd"):(n=new Element("div",{styles:this.css.empowerItemEvenNode}).inject(t)).store("nodeType","Even"),s++,this.empowerSelectNodes.push(n),n.store("data",e);var o=new Element("div.empowerItemIconNode",{styles:this.css.empowerItemIconNode}).inject(n);n.store("iconNode",o);var r=new Element("div.empowerItemContentNode",{styles:this.css.empowerItemContentNode}).inject(n);new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.fromIdentity.split("@")[0]}).inject(r),new Element("div.empowerItemTitleNode",{styles:this.css.empowerItemTitleNode,text:MWF.xApplication.process.Xform.LP.empowerTo}).inject(r),new Element("div.empowerItemPersonNode",{styles:this.css.empowerItemPersonNode,text:e.toIdentity.split("@")[0]}).inject(r);n.addEvents({mouseover:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node_over"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode_over)}},mouseout:function(){if(!this.retrieve("isSelected")&&(this.setStyles(i.css["empowerItem"+this.retrieve("nodeType")+"Node"]),i.css.empowerItemIconNode_over)){var t=this.retrieve("iconNode");t&&t.setStyles(i.css.empowerItemIconNode)}},click:function(){this.retrieve("isSelected")?i.unselectEmpowerItem(this):i.selectEmpowerItem(this)}}),this.checkedAllItems&&n.click()}}.bind(this))},unselectEmpowerItem:function(t){t.store("isSelected",!1),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))},selectEmpowerItem:function(t){t.store("isSelected",!0),t.setStyles(this.css["empowerItem"+t.retrieve("nodeType")+"Node_selected"]),t.getElements("div").each(function(t){var e=t.get("class");e&&this.css[e+"_selected"]&&t.setStyles(this.css[e+"_selected"])}.bind(this))},createSelectAllEmpowerNode:function(){var t=this,e=new Element("div",{styles:this.css.empowerSelectAllItemNode,text:MWF.xApplication.process.Xform.LP.selectAll});return e.addEvents({mouseover:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode_over)},mouseout:function(){this.retrieve("isSelected")||this.setStyles(t.css.empowerSelectAllItemNode)},click:function(){this.retrieve("isSelected")?(this.store("isSelected",!1),this.setStyles(t.css.empowerSelectAllItemNode),t.empowerSelectNodes.each(function(e){t.unselectEmpowerItem(e)}.bind(this))):(this.store("isSelected",!0),this.setStyles(t.css.empowerSelectAllItemNode_selected),t.empowerSelectNodes.each(function(e){t.selectEmpowerItem(e)}.bind(this)))}}),this.checkedAllItems&&(e.store("isSelected",!0),e.setStyles(t.css.empowerSelectAllItemNode_selected)),e}}),MWF.APPOrg.GroupOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.groupCount?this.json.groupCount:0;return"group"===this.json.groupRange?{count:t,storeRange:this.json.storeRange,include:this.getSelectRange(!0)}:{count:t,storeRange:this.json.storeRange}},getSearchOptions:function(){return{}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){var t=[];if(this.json.groupRangeKey&&this.json.groupRangeKey.code){var e=this.form.Macro.exec(this.json.groupRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),t=e}return t}}),MWF.APPOrg.UnitOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){return{count:this.json.unitCount?this.json.unitCount:0,units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,storeRange:this.json.storeRange,expandSubEnable:"no"!=this.json.unitExpandSubEnable}},getSearchOptions:function(){return{units:this.getSelectRange(!0),unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getSelectRange:function(){if("unit"===this.json.unitRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.unitRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.unitRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.unitRangeUnit&&this.json.unitRangeUnit.length&&this.json.unitRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.unitRangeField&&this.json.unitRangeField.length&&this.json.unitRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,n=this.form.businessData.data[i];"array"!==typeOf(n)&&(n=n?[n.toString()]:[]),n.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.unitRangeKey&&this.json.unitRangeKey.code){var e=this.form.Macro.exec(this.json.unitRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],n=[];return i.each(function(t){"direct"===this.json.unitRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&n.push(e.woUnit)):"level"===this.json.unitRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.unitRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&n.push(e)):"type"===this.json.unitRangeNext&&("all"===this.json.unitRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.unitRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&n.push(e)),e=null}.bind(this)),n}}),MWF.APPOrg.IdentityOptions=new Class({Implements:[Events],initialize:function(t,e){this.form=t,this.json=e,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},getOptions:function(){var t=this.json.identityCount?this.json.identityCount:0;return this.json.identityOnlyUseInclude?{noUnit:!0,count:t,resultType:this.json.identityResultType,storeRange:this.json.storeRange,include:this._getInclude()}:{count:t,units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),expandSubEnable:"no"!=this.json.identityExpandSubEnable,resultType:this.json.identityResultType,categoryType:this.json.categoryType||"unit",dutyUnitLevelBy:this.json.dutyUnitLevelBy||"duty",storeRange:this.json.storeRange,include:this._getInclude()}},getSearchOptions:function(){return{units:this.getSelectRange(!0),dutys:this.getSelectRangeDuty(!0),resultType:this.json.identityResultType}},getSelectRange:function(t){return this.selectRange&&!t||(this.selectRange=this._getSelectRange()),this.selectRange},_getInclude:function(){var t=[];if(this.json.identityIncludeKey){var e=this.form.Macro.exec(this.json.identityIncludeKey.code,this);e&&(t="array"===typeOf(e)?e:[e])}return t},_getSelectRange:function(){if("unit"===this.json.identityRange)return this.getScriptSelectUnit();if("draftUnit"===this.json.identityRange){if((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn)return this.getNextSelectUnit((this.form.businessData.work||this.form.businessData.workCompleted).creatorIdentityDn);if(layout.session.user.identityList&&layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}if("currentUnit"===this.json.identityRange){if(this.form.app.currentTask)return this.getNextSelectUnit(this.form.app.currentTask.identityDn);if(this.form.app.taskList&&this.form.app.taskList.length){t=[];return this.form.app.taskList.each((function(e){t.push(e.identity)})),this.getNextSelectUnit(t)}if(layout.session.user.identityList&&layout.session.user.identityList.length){t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getScriptSelectUnit:function(){var t=[];if(this.json.identityRangeUnit&&this.json.identityRangeUnit.length&&this.json.identityRangeUnit.each(function(e){t.push(e)}.bind(this)),this.json.identityRangeField&&this.json.identityRangeField.length&&this.json.identityRangeField.each(function(e){var i="object"==typeOf(e)?e.name:e,n=this.form.businessData.data[i];"array"!==typeOf(n)&&(n=n?[n.toString()]:[]),n.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.identityRangeKey&&this.json.identityRangeKey.code){var e=this.form.Macro.exec(this.json.identityRangeKey.code,this);"array"!==typeOf(e)&&(e=e?[e.toString()]:[]),e.each(function(e){e&&t.push(e)}.bind(this))}return t},getNextSelectUnit:function(t){var e,i="array"===typeOf(t)?t:[t],n=[];return i.each(function(t){"direct"===this.json.identityRangeNext?(this.orgAction.getIdentity(function(t){e=t.data}.bind(this),(function(){e={woUnit:null}}),t,!1),e&&e.woUnit&&n.push(e.woUnit)):"level"===this.json.identityRangeNext?(this.orgAction.getUnitWithIdentityWithLevel(t,this.json.identityRangeNextLevel,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&n.push(e)):"type"===this.json.identityRangeNext&&("all"===this.json.identityRangeNextUnitType?this.orgAction.getUnitWithIdentityWithLevel(t,1,function(t){e=t.data}.bind(this),(function(){e=null}),!1):this.orgAction.getUnitWithIdentityWithType(t,this.json.identityRangeNextUnitType,function(t){e=t.data}.bind(this),(function(){e=null}),!1),e&&n.push(e)),e=null}.bind(this)),n},getSelectRangeDuty:function(t){return this.selectRangeDuty&&!t||(this.selectRangeDuty=this._getSelectRangeDuty()),this.selectRangeDuty},_getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},getScriptSelectDuty:function(){var t=[];if(this.json.rangeDuty&&this.json.rangeDuty.length){var e=this.json.rangeDuty;"string"===typeOf(e)&&(e=JSON.parse(e)),"array"===typeOf(e)&&e.each(function(e){var i="string"===typeOf(e)?e:e.id||e.name;i&&t.push(i)}.bind(this))}if(this.json.rangeDutyField&&this.json.rangeDutyField.length&&this.json.rangeDutyField.each(function(e){var i="object"==typeOf(e)?e.name:e,n=this.form.businessData.data[i];"array"!==typeOf(n)&&(n=n?[n.toString()]:[]),n.each(function(e){e&&t.push(e)}.bind(this))}.bind(this)),this.json.rangeDutyKey&&this.json.rangeDutyKey.code){var i=this.form.Macro.exec(this.json.rangeDutyKey.code,this);"array"!==typeOf(i)&&(i=i?[i.toString()]:[]),i.each(function(e){e&&t.push(e)}.bind(this))}return t}});