MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Log=MWF.APPLog=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","postLoadData","postLoadLine"]},_loadUserInterface:function(){this.node.empty(),this.node.setStyle("-webkit-user-select","text"),this.form.businessData&&("record"!==this.json.logType?this.form.businessData.workLogList&&(this.workLog=Array.clone(this.form.businessData.workLogList),this.fireEvent("postLoadData"),this.loadWorkLog()):this.form.businessData.recordList&&(this.workLog=Array.clone(this.form.businessData.recordList),this.fireEvent("postLoadData"),this.loadRecordLog()))},loadRecordLog:function(){if(this.json.category&&"none"!==this.json.category){if(this.loadCategoryList("_loadRecordCategoryList","_loadRecordCategoryList"),!this.categoryList.length)return;this.expandCount=0,this.json.expand&&"enable"===this.json.expand&&(this.expandCount=parseInt(this.json.expandCount)),this.table=new Element("table",this.json.tableProperties).inject(this.node),this.categoryList.each(function(e,t){var i=this.categoryJson[e];if(i&&i.length){var s=new Element("tr").inject(this.table);this.expandCount&&t+1>this.expandCount&&s.setStyle("display","none");var o=e;"unit"===this.json.category&&(o=e.split("@")[0]),new Element("td",{styles:this.json.titleTdStyles,text:o}).inject(s);var n=new Element("td",{styles:this.json.contentTdStyles}).inject(s),r=new Element("div",{styles:this.json.contentDivStyles||{}}).inject(n);"completedTimeAsc"!==this.json.sortTypeInCategory&&"completedTimeDesc"!==this.json.sortTypeInCategory||i.sort(function(e,t){return"completedTimeAsc"===this.json.sortTypeInCategory?Date.parse(e.recordTime)-Date.parse(t.recordTime):"completedTimeDesc"===this.json.sortTypeInCategory?Date.parse(t.recordTime)-Date.parse(e.recordTime):void 0}.bind(this)),"table"===this.json.mode?this.loadRecordLogTable(i,r):"text"===this.json.mode?this.loadRecordLogText(i,r):"media"===this.json.mode?this.loadRecordLogMedia(i,r):this.loadRecordLogDefault(i,r),this._loadTableStyles()}}.bind(this)),this.categoryList.length>this.expandCount&&this.loadExpandCollapseNode()}else"table"===this.json.mode?this.loadRecordLogTable():"text"===this.json.mode?this.loadRecordLogText():"media"===this.json.mode?this.loadRecordLogMedia():this.loadRecordLogDefault()},_loadRecordCategoryList:function(e){this.categoryList=[],this.categoryJson={},"fromOpinionGroup"===e&&this.workLog.sort(function(e,t){if(e.properties.fromOpinionGroup&&t.properties.fromOpinionGroup){for(var i=e.properties.fromOpinionGroup.split("#"),s=t.properties.fromOpinionGroup.split("#"),o=0;o<i.length;o++){var n=i[o],r=s[o];return this.isNumber(n)&&this.isNumber(r)?parseFloat(n)!==parseFloat(r)?parseFloat(n)-parseFloat(r):"none"===this.json.sortTypeInCategory?0:Date.parse(e.recordTime)-Date.parse(t.recordTime):this.isNumber(n)||this.isNumber(r)?this.isNumber(n)?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(e.recordTime)-Date.parse(t.recordTime)}return Date.parse(e.recordTime)-Date.parse(t.recordTime)}return e.properties.fromOpinionGroup||t.properties.fromOpinionGroup?e.properties.fromOpinionGroup?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(e.recordTime)-Date.parse(t.recordTime)}.bind(this)),this.workLog.each(function(t,i){var s;if("activityGroup"===this.json.category)if(t.properties.fromOpinionGroup){var o=t.properties.fromOpinionGroup.split("#");s=o[o.length-1]}else s=t.fromActivityName;else s=t[e];s&&this.checkRecordShow(t)&&(-1===this.categoryList.indexOf(s)&&this.categoryList.push(s),this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(t))}.bind(this))},loadRecordLogTable:function(e,t){var i=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(t||this.node),s=i.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine),o=s.insertCell(0).setStyles(this.form.css.logTableTaskTitle);o.set("text",MWF.xApplication.process.Xform.LP.person),(o=s.insertCell(1).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.activity),(o=s.insertCell(2).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.department),(o=s.insertCell(3).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.startTime),(o=s.insertCell(4).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.completedTime),(o=s.insertCell(5).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.route),(o=s.insertCell(6).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.opinion),(o=s.insertCell(7).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.arrivedActivitys),(o=s.insertCell(8).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.arrivedUsers),e?e.each(function(e,t){this.loadRecordLogLine_table(e,t,i)}.bind(this)):this.workLog.each(function(e,t){this.checkRecordShow(e)&&this.loadRecordLogLine_table(e,t,i)}.bind(this))},checkRecordShow:function(e){var t=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=e,this.form.Macro.environment.list=null,t=this.form.Macro.exec(this.json.filterScript.code,this);else{var i=function(e){return e&&"array"===o2.typeOf(e)&&e.length&&"yes"===e[0]};if(this.json.filterActivity&&this.json.filterActivity.length&&(filterActivitys=this.json.filterActivity,t=i(this.json.filterActivityExactMatch)?filterActivitys.split(/[;|,|\n]/gm).contains(e.fromActivityName):-1!==filterActivitys.indexOf(e.fromActivityName)),this.json.filterActivityAlias&&this.json.filterActivityAlias.length&&(filterActivityAlias=this.json.filterActivityAlias,e.fromActivityAlias&&(t=i(this.json.filterActivityAliasExactMatch)?filterActivityAlias.split(/[;|,|\n]/gm).contains(e.fromActivityAlias):-1!==filterActivityAlias.indexOf(e.fromActivityAlias))),this.json.filterPerson&&this.json.filterPerson.length)if(i(this.json.filterPersonExactMatch)){t=!1;for(var s=this.json.filterPerson.split(/[;|,|\n]/gm),o=e.person.split("@").concat([e.person]),n=0;n<s.length;n++)if(o.contains(s[n])){t=!0;break}}else(t=-1!==this.json.filterPerson.indexOf(e.person))||(t=-1!==this.json.filterPerson.indexOf(o2.name.cn(e.person)));this.json.filterRoute&&this.json.filterRoute.length&&(filterRoutes=this.json.filterRoute,t=i(this.json.filterRouteExactMatch)?filterRoutes.split(/[;|,|\n]/gm).contains(e.properties.routeName):-1!==filterRoutes.indexOf(e.properties.routeName))}return t},loadRecordLogLine_table:function(e,t,i){var s=t%2==0?"logTableTaskLine":"logTableTaskLine_even";"currentTask"===e.type?this.json.isTask&&this.loadRecordTaskLine_table(e,i,!0,s):this.loadRecordTaskLine_table(e,i,!1,s)},loadRecordTaskLine_table:function(e,t,i,s){css=i?Object.merge(this.form.css.logTableTaskLine_task,this.form.css[s]):this.form.css[s],i&&(s="logTableTaskLine_task");var o,n,r,a,l=t.insertRow(t.rows.length),c=l.insertCell(0).setStyles(css),d=e.person?e.person.substring(0,e.person.indexOf("@")):"";if(e.properties.empowerFromIdentity){var p=o2.name.cn(e.properties.empowerFromIdentity);d=d+" "+MWF.xApplication.process.Xform.LP.replace+" "+p}switch("empower"===e.type&&(e.properties.startTime=e.recordTime),c.set("text",d),(c=l.insertCell(1).setStyles(css)).set("text",e.fromActivityName||""),(c=l.insertCell(2).setStyles(css)).set("text",e.unit?e.unit.substring(0,e.unit.indexOf("@")):""),(c=l.insertCell(3).setStyles(css)).set("text",e.properties.startTime||""),(c=l.insertCell(4).setStyles(css)).set("text",e.recordTime||""),r=e.properties.nextManualList.map((function(e){return e.activityName})).join(","),a=e.properties.nextManualTaskIdentityList&&e.properties.nextManualTaskIdentityList.length?o2.name.cns(e.properties.nextManualTaskIdentityList).join(","):"",e.type){case"empower":o=MWF.xApplication.process.Xform.LP.empower;var h=e.properties.nextManualTaskIdentityList&&e.properties.nextManualTaskIdentityList.length?o2.name.cns(e.properties.nextManualTaskIdentityList).join(","):"";n=MWF.xApplication.process.Xform.LP.empowerTo+h,e.properties.startTime=e.recordTime;break;case"retract":o=MWF.xApplication.process.Xform.LP.retract,n=MWF.xApplication.process.Xform.LP.retract;break;case"reroute":o=e.properties.routeName||MWF.xApplication.process.Xform.LP.reroute,n=e.properties.opinion||MWF.xApplication.process.Xform.LP.rerouteTo+": "+r;break;case"rollback":o=e.properties.routeName||MWF.xApplication.process.Xform.LP.rollback,n=e.properties.opinion||MWF.xApplication.process.Xform.LP.rollbackTo+": "+e.arrivedActivityName;break;case"reset":var m=e.properties.nextManualTaskIdentityList.erase(e.identity);resetUserText=o2.name.cns(m).join(","),o=MWF.xApplication.process.Xform.LP.resetTo+":"+resetUserText,n=e.properties.opinion||"";break;case"appendTask":case"back":case"addSplit":case"urge":case"expire":case"read":default:o=e.properties.routeName||"",n=e.properties.opinion||""}(c=l.insertCell(5).setStyles(css)).set("text",o);var f=l.insertCell(6).setStyles(css);f.set("html","<div style='display: inline-block; float: left'>"+n+"</div>"),(c=l.insertCell(7).setStyles(css)).set("text",r),(c=l.insertCell(8).setStyles(css)).set("html",a);var g=[];if(e.properties.mediaOpinion){var y=e.properties.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==y.indexOf(e.id)&&g.push(e)}.bind(this)),g.length&&this.loadMediaOpinion(g,f.getFirst(),"table")}this.fireEvent("postLoadLine",[{data:e,node:l,atts:g,log:this,type:i?"task":"taskCompleted"}])},loadRecordLogDefault:function(e,t){var i=new Element("div",{styles:this.form.css.logActivityNode_record}).inject(t||this.node);e?e.each(function(e,t){this.loadRecordLogLine_default(e,t,i)}.bind(this)):this.workLog.each(function(e,t){this.checkRecordShow(e)&&this.loadRecordLogLine_default(e,t,i)}.bind(this))},loadRecordLogLine_default:function(e,t,i){var s=t%2==0?"logActivityChildRecordNode":"logActivityChildRecordNode_even",o=new Element("div",{styles:this.form.css[s]}).inject(i||this.node);"currentTask"===e.type?this.json.isTask&&this.loadRecordTaskLine_default(e,o,!0):this.loadRecordTaskLine_default(e,o,!1)},loadRecordTaskLine_default:function(e,t,i,s,o,n,r){var a="logTaskNode",l="logTaskFloatTextNode";n&&(a="logTaskTextNode",l="logTaskTextNode");var c,d=new Element("div",{styles:this.form.css[a]}).inject(t);r||(c=new Element("div",{styles:this.form.css.logTaskIconNode_record}).inject(d));var p=new Element("div",{styles:this.form.css[l]}).inject(d);o&&(d.setStyles(this.form.css[this.lineClass]),"logTaskNode"===this.lineClass?this.lineClass="logTaskNode_even":this.lineClass="logTaskNode");var h,m=0;c&&(s&&c.setStyle("margin-left",s),m=c.getStyle("margin-left").toInt(),m+=28),n||p.setStyle("margin-left",m+"px");var f="",g=[];if(i){x=e.person?e.person.substring(0,e.person.indexOf("@")):"";if(e.properties.empowerFromIdentity){k=o2.name.cn(e.properties.empowerFromIdentity);x=x+" "+MWF.xApplication.process.Xform.LP.replace+" "+k}h=x+"("+e.unit.substring(0,e.unit.indexOf("@"))+"), 【"+e.fromActivityName+"】"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+e.properties.startTime,p.set("html",h),c&&c.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)")}else{f=e.unitList?e.unitList[e.unitList.length-1]:"",h=this.json.textStyle;var y=MWF.xApplication.process.Xform.LP;"empower"==e.type&&(h="<font style='color:#ff5400;'>{person}</font>（{department}）"+y.in+"【{activity}】"+y.activity+"，"+y.empowerTo+"<font style='color:#ff5400;'>{empowerTo}</font>。（{time}）</font>");var u=e.properties.nextManualTaskIdentityList&&e.properties.nextManualTaskIdentityList.length?o2.name.cns(e.properties.nextManualTaskIdentityList).join(","):"";this.json.textStyleScript&&this.json.textStyleScript.code&&(this.form.Macro.environment.log=e,this.form.Macro.environment.list=null,h=this.form.Macro.exec(this.json.textStyleScript.code,this));var L,v,T,b,x=e.person?e.person.substring(0,e.person.indexOf("@")):"";if(e.properties.empowerFromIdentity){var k=o2.name.cn(e.properties.empowerFromIdentity);x=x+" "+MWF.xApplication.process.Xform.LP.replace+" "+k}switch(T=e.properties.nextManualList.map((function(e){return e.activityName})).join(","),b=e.properties.nextManualTaskIdentityList&&e.properties.nextManualTaskIdentityList.length?o2.name.cns(e.properties.nextManualTaskIdentityList).join(","):"",e.type){case"empower":L=MWF.xApplication.process.Xform.LP.empower;var j=e.properties.nextManualTaskIdentityList&&e.properties.nextManualTaskIdentityList.length?o2.name.cns(e.properties.nextManualTaskIdentityList).join(","):"";v=MWF.xApplication.process.Xform.LP.empowerTo+j,e.properties.startTime=e.recordTime;break;case"retract":L=MWF.xApplication.process.Xform.LP.retract,v=MWF.xApplication.process.Xform.LP.retract;break;case"reroute":L=e.properties.routeName||MWF.xApplication.process.Xform.LP.reroute,v=e.properties.opinion||MWF.xApplication.process.Xform.LP.rerouteTo+": "+T;break;case"rollback":L=e.properties.routeName||MWF.xApplication.process.Xform.LP.rollback,v=e.properties.opinion||MWF.xApplication.process.Xform.LP.rollbackTo+": "+e.arrivedActivityName;break;case"reset":var w=e.properties.nextManualTaskIdentityList.erase(e.identity);resetUserText=o2.name.cns(w).join(","),L=MWF.xApplication.process.Xform.LP.resetTo+":"+resetUserText,v=e.properties.opinion||"";break;case"appendTask":case"back":case"addSplit":case"urge":case"expire":case"read":case"task":case"empowerTask":default:L=e.properties.routeName||"",v=e.properties.opinion||""}h=(h=(h=(h=(h=(h=(h=(h=(h=(h=(h=(h=(h=(h=h.replace(/\{person\}/g,x)).replace(/\{department\}/g,e.unit?e.unit.substring(0,e.unit.indexOf("@")):"")).replace(/\{route\}/g,L)).replace(/\{time\}/g,e.recordTime)).replace(/\{date\}/g,(new Date).parse(e.recordTime).format("%Y-%m-%d"))).replace(/\{opinion\}/g,v)).replace(/\{company\}/g,f.substring(0,f.indexOf("@")))).replace(/\{startTime\}/g,e.properties.startTime)).replace(/\{startDate\}/g,(new Date).parse(e.properties.startTime).format("%Y-%m-%d"))).replace(/\{activity\}/g,e.fromActivityName)).replace(/\{arrivedActivity\}/g,T)).replace(/\{img\}/g,"<span class='mwf_log_img'></span>")).replace(/\{empowerTo\}/g,b)).replace(/\{next\}/g,u),p.set("html",h);var A=p.getElement(".mwf_log_img");if(e.properties.mediaOpinion){var M=e.properties.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==M.indexOf(e.id)&&g.push(e)}.bind(this)),g.length&&(A?this.loadMediaOpinion_show(g,e,A,!0):this.loadMediaOpinion(g,p,"default"))}}this.fireEvent("postLoadLine",[{data:e,atts:g,node:d,log:this,type:i?"task":"taskCompleted"}])},loadRecordLogText:function(e,t){this.lineClass="logTaskNode",e?e.each(function(e,i){this.loadRecordLogLine_text(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkRecordShow(e)&&this.loadRecordLogLine_text(e,i,t)}.bind(this))},loadRecordLogLine_text:function(e,t,i){"currentTask"===e.type?this.json.isTask&&this.loadRecordTaskLine_text(e,i||this.node,!0):this.loadRecordTaskLine_text(e,i||this.node,!1)},loadRecordTaskLine_text:function(e,t,i){this.loadRecordTaskLine_default(e,t,i,"0px",!1,!0,!0)},loadRecordLogMedia:function(e,t){e?e.each(function(e,i){this.loadRecordLogLine_media(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkRecordShow(e)&&this.loadRecordLogLine_media(e,i,t)}.bind(this))},loadRecordLogLine_media:function(e,t,i){this.loadRecordTaskLine_media(e,i)},loadRecordTaskLine_media:function(e,t){if(e.properties.mediaOpinion){var i=e.properties.mediaOpinion.split(","),s=[];this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==i.indexOf(e.id)&&s.push(e)}.bind(this));var o=!!e.recordTime;e.completedTime=e.recordTime;var n=new Element("div").inject(t||this.node);s.length&&this.loadMediaOpinion_show(s,e,n),this.fireEvent("postLoadLine",[{data:e,atts:s,node:n,log:this,type:o?"taskCompleted":"task"}])}},loadWorkLog:function(){if(this.json.category&&"none"!==this.json.category){if(this.loadCategoryList(),!this.categoryList.length)return;this.expandCount=0,this.json.expand&&"enable"===this.json.expand&&(this.expandCount=parseInt(this.json.expandCount||0)),this.table=new Element("table",this.json.tableProperties).inject(this.node),this.categoryList.each(function(e,t){var i=this.categoryJson[e];if(i&&i.length){var s=new Element("tr").inject(this.table);this.expandCount&&t+1>this.expandCount&&s.setStyle("display","none");var o=e;"unit"===this.json.category&&(o=e.split("@")[0]),new Element("td",{styles:this.json.titleTdStyles,text:o}).inject(s);var n=new Element("td",{styles:this.json.contentTdStyles}).inject(s),r=new Element("div",{styles:this.json.contentDivStyles||{}}).inject(n),a=i;"completedTimeAsc"!==this.json.sortTypeInCategory&&"completedTimeDesc"!==this.json.sortTypeInCategory||(a=[],i.each(function(e){e.taskCompletedList.length&&e.taskCompletedList.each(function(t){var i=Object.clone(e);i.readList=[],i.readCompletedList=[],i.taskList=[],i.taskCompletedList=[t],a.push(i)}.bind(this))}.bind(this)),a.sort(function(e,t){return"completedTimeAsc"===this.json.sortTypeInCategory?Date.parse(e.taskCompletedList[0].completedTime)-Date.parse(t.taskCompletedList[0].completedTime):"completedTimeDesc"===this.json.sortTypeInCategory?Date.parse(t.taskCompletedList[0].completedTime)-Date.parse(e.taskCompletedList[0].completedTime):void 0}.bind(this)),i.each((function(e){e.taskList.length&&e.taskList.each(function(t){var i=Object.clone(e);i.readList=[],i.readCompletedList=[],i.taskCompletedList=[],i.taskList=[t],a.push(i)}.bind(this))}))),"table"===this.json.mode?this.loadWorkLogTable(a,r):"text"===this.json.mode?this.loadWorkLogText(a,r):"media"===this.json.mode?this.loadWorkLogMedia(a,r):this.loadWorkLogDefault(a,r),this._loadTableStyles()}}.bind(this)),this.categoryList.length>this.expandCount&&this.loadExpandCollapseNode()}else"table"===this.json.mode?this.loadWorkLogTable():"text"===this.json.mode?this.loadWorkLogText():"media"===this.json.mode?this.loadWorkLogMedia():this.loadWorkLogDefault()},loadCategoryList:function(e,t){var i;"activity"===this.json.category?(i="fromActivityName",this[e||"_loadCategoryList"](i)):"unit"===this.json.category?(i="unit",this[t||"_loadCategoryLitBySubData"](i)):"activityGroup"===this.json.category?(i="fromOpinionGroup",this[e||"_loadCategoryList"](i)):(i=this.json.category,this[e||"_loadCategoryList"](i))},_loadCategoryList:function(e){this.categoryList=[],this.categoryJson={},"fromOpinionGroup"===e&&this.workLog.sort(function(e,t){if(e.fromOpinionGroup&&t.fromOpinionGroup){for(var i=e.fromOpinionGroup.split("#"),s=t.fromOpinionGroup.split("#"),o=0;o<i.length;o++){var n=i[o],r=s[o];return this.isNumber(n)&&this.isNumber(r)?parseFloat(n)!==parseFloat(r)?parseFloat(n)-parseFloat(r):"none"===this.json.sortTypeInCategory?0:Date.parse(e.fromTime)-Date.parse(t.fromTime):this.isNumber(n)||this.isNumber(r)?this.isNumber(n)?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(e.fromTime)-Date.parse(t.fromTime)}return Date.parse(e.fromTime)-Date.parse(t.fromTime)}return e.fromOpinionGroup||t.fromOpinionGroup?e.fromOpinionGroup?-1:1:"none"===this.json.sortTypeInCategory?0:Date.parse(e.fromTime)-Date.parse(t.fromTime)}.bind(this)),this.workLog.each(function(t,i){var s;if("activityGroup"===this.json.category)if(t.fromOpinionGroup){var o=t.fromOpinionGroup.split("#");s=o[o.length-1]}else s=t.fromActivityName;else s=t[e];if(s&&this.checkShow(t)){for(var n=!1,r=0;r<t.taskCompletedList.length;r++){var a=t.taskCompletedList[r];if(n=this.checkListShow(t,a))break}if(!n&&this.json.isTask)for(r=0;r<this.json.isTask.length;r++){var l=t.taskList[r];if(n=this.checkListShow(t,l))break}n&&(-1===this.categoryList.indexOf(s)&&this.categoryList.push(s),this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(t))}}.bind(this))},_loadCategoryLitBySubData:function(e){this.categoryList=[],this.categoryJson={},this.workLog.each(function(t,i){var s=t[e];if(this.checkShow(t)){for(var o=!1,n=0;n<t.taskCompletedList.length;n++){var r=t.taskCompletedList[n];if(o=this.checkListShow(t,r))break}if(!o&&this.json.isTask)for(n=0;n<this.json.isTask.length;n++){var a=t.taskList[n];if(o=this.checkListShow(t,a))break}if(o){var l=Object.clone(t);l.taskCompletedList=[],l.taskList=[],l.readCompletedList=[],l.readList=[];var c=[],d={};for(n=0;n<t.taskCompletedList.length;n++){(s=(p=t.taskCompletedList[n])[e])&&(-1===c.indexOf(s)&&c.push(s),d[s]||(d[s]=Object.clone(l)),d[s].taskCompletedList.push(p))}for(n=0;n<t.taskList.length;n++){(s=(p=t.taskList[n])[e])&&(-1===c.indexOf(s)&&c.push(s),d[s]||(d[s]=Object.clone(l)),d[s].taskList.push(p))}for(n=0;n<t.readCompletedList.length;n++){(s=(p=t.readCompletedList[n])[e])&&(-1===c.indexOf(s)&&c.push(s),d[s]||(d[s]=Object.clone(l)),d[s].readCompletedList.push(p))}for(n=0;n<t.readList.length;n++){var p;(s=(p=t.readList[n])[e])&&(-1===c.indexOf(s)&&c.push(s),d[s]||(d[s]=Object.clone(l)),d[s].readList.push(p))}for(var s in c.each(function(e){-1===this.categoryList.indexOf(e)&&this.categoryList.push(e)}.bind(this)),d)this.categoryJson[s]||(this.categoryJson[s]=[]),this.categoryJson[s].push(d[s])}}}.bind(this))},_loadTableBorderStyle:function(){if(this.json.tableStyles&&this.json.tableStyles.border){this.table.set("cellspacing","0"),this.table.setStyles({"border-top":this.json.tableStyles.border,"border-left":this.json.tableStyles.border});var e=this.table.getElements("th");e&&e.length&&e.setStyles({"border-bottom":this.json.tableStyles.border,"border-right":this.json.tableStyles.border});var t=this.table.getElements("td");t&&t.length&&t.setStyles({"border-bottom":this.json.tableStyles.border,"border-right":this.json.tableStyles.border})}},_loadTableStyles:function(){Object.each(this.json.tableStyles||{},function(e,t){t.test(/^border\w*/gi)||this.table.setStyle(t,e)}.bind(this)),this._loadTableBorderStyle()},loadExpandCollapseNode:function(){this.json.expand&&"enable"===this.json.expand&&(this.json.expandHTML&&(this.expandNode=new Element("div",{html:this.json.expandHTML}).inject(this.node,"bottom"),this.expandNode.addEvent("click",function(){this.json.category&&"none"!==this.json.category&&(this.table.getElements("tr").setStyle("display",""),this.expandNode.setStyle("display","none"),this.collapseNode.setStyle("display",""))}.bind(this))),this.json.collapseHTML&&(this.collapseNode=new Element("div",{html:this.json.collapseHTML,styles:{display:"none"}}).inject(this.node,"bottom"),this.collapseNode.addEvent("click",function(){if(this.json.category&&"none"!==this.json.category){for(var e=this.table.getElements("tr"),t=0;t<e.length;t++)t>=this.expandCount&&e[t].setStyle("display","none");this.expandNode.setStyle("display",""),this.collapseNode.setStyle("display","none")}else;}.bind(this))))},loadWorkLogMedia:function(e,t){e?e.each(function(e,i){this.loadWorkLogLine_media(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkShow(e)&&this.loadWorkLogLine_media(e,i,t)}.bind(this))},loadWorkLogLine_media:function(e,t,i){e.taskCompletedList.length&&e.taskCompletedList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_media(t,e,i)}.bind(this))},loadTaskLine_media:function(e,t,i){if(e.mediaOpinion){var s=e.mediaOpinion.split(","),o=[];this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==s.indexOf(e.id)&&o.push(e)}.bind(this));var n=new Element("div").inject(i||this.node);o.length&&this.loadMediaOpinion_show(o,e,n),this.fireEvent("postLoadLine",[{data:e,atts:o,node:n,log:this,type:e.completedTime?"taskCompleted":"task"}])}},loadMediaOpinion_show:function(e,t,i,s){e.each(function(e){e.type&&(-1!==e.type.indexOf("image")?this.loadMediaOpinion_image_show(e,t,i,s):-1!==e.type.indexOf("video")?this.loadMediaOpinion_video_show(e,t,i):(e.type.indexOf("audio"),this.loadMediaOpinion_voice_show(e,t,i)))}.bind(this))},loadMediaOpinion_image_show:function(e,t,i,s){var o=this.getMediaOpinionUrl(e),n=new Element("div",{styles:{overflow:"hidden"}}).inject(i||this.node);if(!s)new Element("div",{styles:{"line-height":"28px",height:"28px"},text:t.person.substring(0,t.person.indexOf("@"))+"("+t.completedTime+")"}).inject(n);var r,a=new Element("div").inject(n);if(layout.mobile)r=200;else{var l=n.getParent(),c=a.getPosition(l);r=l.getSize().x-c.x-42}var d=new Element("img",{src:o,styles:{width:r+"px"},events:{load:function(e){var t=e.target.naturalHeight,i=e.target.naturalWidth;if(layout.mobile||!this.isNumber(this.json.handwritingWidth)&&!this.isNumber(this.json.handwritingHeight)){var s=Math.min(i,r);d.setStyles({width:s+"px"}),a.setStyles({width:s+"px"})}else{var o=this.getImageSize(i,t);d.setStyles(o),a.setStyles(o)}}.bind(this)}}).inject(a)},isNumber:function(e){return"NaN"!==parseFloat(e).toString()},getImageSize:function(e,t){var i=this.json.handwritingWidth,s=this.json.handwritingHeight;return this.isNumber(i)&&!this.isNumber(s)?{width:Math.min(e,parseInt(i))+"px",height:"auto"}:!this.isNumber(i)&&this.isNumber(s)?{width:"auto",height:Math.min(t,parseInt(s))+"px"}:this.isNumber(i)&&this.isNumber(s)?e/parseInt(i)>t/parseInt(s)?{width:Math.min(e,parseInt(i))+"px",height:"auto"}:{width:"auto",height:Math.min(t,parseInt(s))+"px"}:void 0},loadMediaOpinion_video_show:function(e,t,i){},loadMediaOpinion_voice_show:function(e,t,i){var s=this.getMediaOpinionUrl(e),o=new Element("div",{styles:{overflow:"hidden"}}).inject(i||this.node);new Element("div",{styles:{"line-height":"28px",height:"28px"},text:t.person.substring(0,t.person.indexOf("@"))+"("+t.completedTime+")"}).inject(o);new Element("audio",{loop:!1,controls:!0}).inject(o).set("src",s)},loadWorkLogTable:function(e,t){e?e.each(function(e,i){this.loadWorkLogLine_table(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkShow(e)&&this.loadWorkLogLine_table(e,i,t)}.bind(this))},loadWorkLogLine_table:function(e,t,i){if(e.readList||(e.readList=[]),e.readCompletedList||(e.readCompletedList=[]),e.taskCompletedList.length||e.readList.length||e.readCompletedList.length||this.json.isTask&&e.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(i||this.node),o=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s),n=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s),r=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(o),a=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(o),l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(o),c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(o),d=new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(o);e.connected?r.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)"):r.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)"),a.set("html","<b>"+e.fromActivityName+"</b>"),e.arrivedActivityName?(l.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)"),c.set("html","<b>"+e.arrivedActivityName+"</b>"),d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)):d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime),t%2==0&&(s.setStyles(this.form.css.logActivityNode_even),o.setStyles(this.form.css.logActivityTitleNode_even));var p=new Element("table",{styles:this.form.css.logTableTask,border:"0",cellSpacing:"0",cellpadding:"3px",width:"100%"}).inject(n),h=p.insertRow(0).setStyles(this.form.css.logTableTaskTitleLine),m=h.insertCell(0).setStyles(this.form.css.logTableTaskTitle);if(m.set("text",MWF.xApplication.process.Xform.LP.person),(m=h.insertCell(1).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.department),(m=h.insertCell(2).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.startTime),(m=h.insertCell(3).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.completedTime),(m=h.insertCell(4).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.route),(m=h.insertCell(5).setStyles(this.form.css.logTableTaskTitle)).set("text",MWF.xApplication.process.Xform.LP.opinion),e.taskCompletedList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_table(t,p,e,!1)}.bind(this)),!1!==this.json.isShowRead){var f=[],g=[];e.readList&&e.readList.length&&e.readList.each((function(e){f.push(MWF.name.cn(e.person))})),e.readCompletedList&&e.readCompletedList.length&&e.readCompletedList.each((function(e){g.push(MWF.name.cn(e.person))})),this.loadReadLine_default(f,g,n)}this.json.isTask&&e.taskList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_table(t,p,e,!0)}.bind(this))}},loadTaskLine_table:function(e,t,i,s){var o="logTableTaskLine";s&&(o="logTableTaskLine_task");var n=t.insertRow(t.rows.length),r=n.insertCell(0).setStyles(this.form.css[o]);r.set("text",e.person.substring(0,e.person.indexOf("@"))||""),(r=n.insertCell(1).setStyles(this.form.css[o])).set("text",e.unit.substring(0,e.unit.indexOf("@"))||""),(r=n.insertCell(2).setStyles(this.form.css[o])).set("text",e.startTime||""),(r=n.insertCell(3).setStyles(this.form.css[o])).set("text",e.completedTime||""),(r=n.insertCell(4).setStyles(this.form.css[o])).set("text","empower"==e.processingType?MWF.xApplication.process.Xform.LP.empower:e.routeName||""),r=n.insertCell(5).setStyles(this.form.css[o]),opinion="empower"==e.processingType?MWF.xApplication.process.Xform.LP.empowerTo+o2.name.cn(e.empowerToIdentity||""):"<div style='line-height: 28px; float:left'>"+(e.opinion||"")+"</div>",r.set("html",opinion);var a=[];if(e.mediaOpinion){var l=e.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==l.indexOf(e.id)&&a.push(e)}.bind(this)),a.length&&this.loadMediaOpinion(a,r.getFirst(),"table")}this.fireEvent("postLoadLine",[{data:e,atts:a,node:n,log:this,type:s?"task":"taskCompleted"}])},loadWorkLogText:function(e,t){this.lineClass="logTaskNode",e?e.each(function(e,i){this.loadWorkLogLine_text(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkShow(e)&&this.loadWorkLogLine_text(e,i,t)}.bind(this))},loadWorkLogLine_text:function(e,t,i){e.taskCompletedList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_text(t,i||this.node,e,!1)}.bind(this)),this.json.isTask&&e.taskList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_text(t,i||this.node,e,!0)}.bind(this))},loadTaskLine_text:function(e,t,i,s){this.loadTaskLine_default(e,t,i,s,"0px",!1,!0,!0)},checkShow:function(e){var t=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=e,this.form.Macro.environment.list=null,t=this.form.Macro.exec(this.json.filterScript.code,this);else{var i=function(e){return e&&"array"===o2.typeOf(e)&&e.length&&"yes"===e[0]};if(this.json.filterActivity&&this.json.filterActivity.length&&(filterActivitys=this.json.filterActivity,t=i(this.json.filterActivityExactMatch)?filterActivitys.split(/[;|,|\n]/gm).contains(e.fromActivityName):-1!==filterActivitys.indexOf(e.fromActivityName)),this.json.filterActivityAlias&&this.json.filterActivityAlias.length&&(filterActivityAlias=this.json.filterActivityAlias,e.fromActivityAlias&&(t=i(this.json.filterActivityAliasExactMatch)?filterActivityAlias.split(/[;|,|\n]/gm).contains(e.fromActivityAlias):-1!==filterActivityAlias.indexOf(e.fromActivityAlias))),this.json.filterPerson&&this.json.filterPerson.length){t=!1,filterPersons=this.json.filterPerson;var s=[];if(i(this.json.filterPersonExactMatch)){var o=filterPersons.split(/[;|,|\n]/gm);e.taskCompletedList.each(function(e){for(var t=(e.person+"@"+e.identity).split("@").concat([e.person,e.identity]),i=0;i<o.length;i++)if(t.contains(o[i])){s.push(e);break}}.bind(this))}else e.taskCompletedList.each(function(e){-1===filterPersons.indexOf(e.person)&&-1===filterPersons.indexOf(e.identity)||s.push(e)}.bind(this));s.length&&(t=!0)}this.json.filterRoute&&this.json.filterRoute.length&&(filterRoutes=this.json.filterRoute,t=i(this.json.filterRouteExactMatch)?filterRoutes.split(/[;|,|\n]/gm).contains(e.routeName):-1!==filterRoutes.indexOf(e.routeName))}return t},checkListShow:function(e,t){var i,s=!0;if(this.json.filterScript&&this.json.filterScript.code)this.form.Macro.environment.log=e,this.form.Macro.environment.list=t,s=this.form.Macro.exec(this.json.filterScript.code,this);else{if(this.json.filterPerson&&this.json.filterPerson.length){var o=this.json.filterPerson;if(s=!1,(i=this.json.filterPersonExactMatch)&&"array"===o2.typeOf(i)&&i.length&&"yes"===i[0]){for(var n=o.split(/[;|,|\n]/gm),r=(t.person+"@"+t.identity).split("@").concat([t.person,t.identity]),a=0;a<n.length;a++)if(r.contains(n[a])){s=!0;break}}else s=-1!==filterPersons.indexOf(t.person)||-1!==filterPersons.indexOf(t.identity)}}return s},loadWorkLogDefault:function(e,t){e?e.each(function(e,i){this.loadWorkLogLine_default(e,i,t)}.bind(this)):this.workLog.each(function(e,i){this.checkShow(e)&&this.loadWorkLogLine_default(e,i,t)}.bind(this))},loadWorkLogLine_default:function(e,t,i){if(e.readList||(e.readList=[]),e.readCompletedList||(e.readCompletedList=[]),e.taskCompletedList.length||e.readList.length||e.readCompletedList.length||this.json.isTask&&e.taskList.length){var s=new Element("div",{styles:this.form.css.logActivityNode}).inject(i||this.node),o=new Element("div",{styles:this.form.css.logActivityTitleNode}).inject(s),n=new Element("div",{styles:this.form.css.logActivityChildNode}).inject(s),r=new Element("div",{styles:this.form.css.logActivityIconNode}).inject(o),a=new Element("div",{styles:this.form.css.logActivityFromNode}).inject(o),l=new Element("div",{styles:this.form.css.logActivityArrowNode}).inject(o),c=new Element("div",{styles:this.form.css.logActivityArrivedNode}).inject(o),d=(new Element("div",{styles:this.form.css.logActivityReadActionNode}).inject(o),new Element("div",{styles:this.form.css.logActivityTimeNode}).inject(o));if(e.connected?r.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/ok14.png)"):r.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)"),a.set("html","<b>"+e.fromActivityName+"</b>"),e.arrivedActivityName?(l.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/right.png)"),c.set("html","<b>"+e.arrivedActivityName+"</b>"),d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime+"<br/><b>"+MWF.xApplication.process.Xform.LP.end+": </b>"+e.arrivedTime)):d.set("html","<b>"+MWF.xApplication.process.Xform.LP.begin+": </b>"+e.fromTime),t%2==0&&(s.setStyles(this.form.css.logActivityNode_even),o.setStyles(this.form.css.logActivityTitleNode_even)),e.taskCompletedList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_default(t,n,e,!1)}.bind(this)),!1!==this.json.isShowRead){var p=[],h=[];e.readList&&e.readList.length&&e.readList.each((function(e){p.push(MWF.name.cn(e.person))})),e.readCompletedList&&e.readCompletedList.length&&e.readCompletedList.each((function(e){h.push(MWF.name.cn(e.person))})),this.loadReadLine_default(p,h,n)}this.json.isTask&&e.taskList.each(function(t){this.checkListShow(e,t)&&this.loadTaskLine_default(t,n,e,!0)}.bind(this))}},loadReadLine_default:function(e,t,i){var s="",o=new Element("div",{styles:this.form.css.logReadTextNode}).inject(i);if(e.length){var n=e.join(", "),r=e.length>20?e.slice(0,20).join(", ")+MWF.xApplication.process.Xform.LP.andSoForth:n;s="<span style='color: #0000ff'>"+(this.json.showReadTitle||MWF.xApplication.process.Xform.LP.showReadTitle)+": </span>"+r+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"}if(t.length){var a=t.join(", "),l=t.length>20?t.slice(0,20).join(", ")+MWF.xApplication.process.Xform.LP.andSoForth:a;s+="<span style='color: #0000ff'>"+(this.json.showReadCompletedTitle||MWF.xApplication.process.Xform.LP.showReadCompletedTitle)+": </span>"+l+"<span>&nbsp;&nbsp;&nbsp;&nbsp;</span>"}s&&o.set("html",s)},loadTaskLine_default:function(e,t,i,s,o,n,r,a){var l="logTaskNode",c="logTaskFloatTextNode";r&&(l="logTaskTextNode",c="logTaskTextNode");var d,p=new Element("div",{styles:this.form.css[l]}).inject(t);a||(d=new Element("div",{styles:this.form.css.logTaskIconNode}).inject(p));var h=new Element("div",{styles:this.form.css[c]}).inject(p);n&&(p.setStyles(this.form.css[this.lineClass]),"logTaskNode"===this.lineClass?this.lineClass="logTaskNode_even":this.lineClass="logTaskNode");var m=28;d&&(o&&d.setStyle("margin-left",o),m=d.getStyle("margin-left").toInt(),m+=28),r||h.setStyle("margin-left",m+"px");var f="",g=[];if(s)y=e.person.substring(0,e.person.indexOf("@"))+"("+e.unit.substring(0,e.unit.indexOf("@"))+")"+MWF.xApplication.process.Xform.LP.processing+", "+MWF.xApplication.process.Xform.LP.comeTime+": "+e.startTime,h.set("html",y),d&&d.setStyle("background-image","url(../x_component_process_Xform/$Form/"+this.form.options.style+"/icon/rightRed.png)");else{f=e.unitList?e.unitList[e.unitList.length-1]:"";var y=this.json.textStyle;"empower"==e.processingType&&(y=MWF.xApplication.process.Xform.LP.empowerToHtml);var u="";if("empower"==e.processingType){var L=[];if(e.nextTaskIdentityListText){var v=e.nextTaskIdentityListText.split(",");L=o2.name.cns(v)}else{var T=i.nextTaskIdentityList&&i.nextTaskIdentityList.length?o2.name.cns(i.nextTaskIdentityList).join(", "):"",b=i.nextTaskCompletedIdentityList&&i.nextTaskCompletedIdentityList.length?o2.name.cns(i.nextTaskCompletedIdentityList).join(", "):"";T&&L.push(T),b&&L.push(b)}u=L.join(", ")}else u=e.empowerToIdentity?o2.name.cn(e.empowerToIdentity):"";this.json.textStyleScript&&this.json.textStyleScript.code&&(this.form.Macro.environment.log=i,this.form.Macro.environment.list=null,y=this.form.Macro.exec(this.json.textStyleScript.code,this));var x=e.person.substring(0,e.person.indexOf("@"));"empower"!==e.processingType&&e.empowerFromIdentity&&(x=x+" 代 "+o2.name.cn(e.empowerFromIdentity||"")),y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=(y=y.replace(/\{person\}/g,x)).replace(/\{department\}/g,e.unit.substring(0,e.unit.indexOf("@")))).replace(/\{route\}/g,e.routeName)).replace(/\{time\}/g,e.completedTime)).replace(/\{date\}/g,(new Date).parse(e.completedTime).format("%Y-%m-%d"))).replace(/\{opinion\}/g,e.opinion||"")).replace(/\{company\}/g,f.substring(0,f.indexOf("@")))).replace(/\{startTime\}/g,e.startTime)).replace(/\{startDate\}/g,(new Date).parse(e.startTime).format("%Y-%m-%d"))).replace(/\{activity\}/g,i.fromActivityName)).replace(/\{arrivedActivity\}/g,i.arrivedActivityName)).replace(/\{img\}/g,"<span class='mwf_log_img'></span>")).replace(/\{empowerTo\}/g,e.empowerToIdentity?o2.name.cn(e.empowerToIdentity):"")).replace(/\{nextTask\}/g,T)).replace(/\{nextTaskCompleted\}/g,b)).replace(/\{next\}/g,u),h.set("html",y);var k=h.getElement(".mwf_log_img");if(e.mediaOpinion){var j=e.mediaOpinion.split(",");this.form.businessData.attachmentList&&this.form.businessData.attachmentList.each(function(e){"$mediaOpinion"===e.site&&-1!==j.indexOf(e.id)&&g.push(e)}.bind(this)),g.length&&(k?this.loadMediaOpinion_show(g,e,k,!0):this.loadMediaOpinion(g,h,"default"))}}this.fireEvent("postLoadLine",[{data:e,node:p,atts:g,log:this,type:s?"task":"taskCompleted"}])},loadMediaOpinion:function(e,t,i){e.each(function(e){e.type||(e.type="image"),-1!==e.type.indexOf("image")?this.json.handwritingExpanded?this.loadMediaOpinion_image_show(e,null,t,!0):"table"!==i||layout.mobile?this.loadMediaOpinion_image(e,t):this.loadMediaOpinion_image_tooltip(e,t):-1!==e.type.indexOf("video")?this.loadMediaOpinion_video(e,t):-1!==e.type.indexOf("audio")?this.loadMediaOpinion_voice(e,t):this.json.handwritingExpanded?this.loadMediaOpinion_image_show(e,null,t,!0):"table"!==i||layout.mobile?this.loadMediaOpinion_image(e,t):this.loadMediaOpinion_image_tooltip(e,t)}.bind(this))},getMediaOpinionUrl:function(e){var t=MWF.Actions.get("x_processplatform_assemble_surface"),i=t.action.actions.getAttachmentStream.uri;return i=this.form.businessData.workCompleted?(i=(i=t.action.actions.getWorkcompletedAttachmentStream.uri).replace("{id}",e.id)).replace("{workCompletedId}",this.form.businessData.workCompleted.id):(i=i.replace("{id}",e.id)).replace("{workid}",this.form.businessData.work.id),i=t.action.address+i,o2.filterUrl(i)},loadMediaOpinion_image_tooltip:function(e,t){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(t.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/image.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_image),this.MTooltipsLoaded||o2.xDesktop.requireApp("Template","MTooltips",null,!1),this.MTooltipsLoaded=!0;var s=new MTooltips(this.form.app.content,i,this.form.app,null,{axis:"y",delay:350,nodeStyles:{"max-width":"800px"}});s.contentNode=new Element("div",{styles:{width:"100%",height:"100%"}});new Element("img",{src:this.getMediaOpinionUrl(e),events:{load:function(e){var t=e.target.naturalHeight,i=e.target.naturalWidth;if(this.isNumber(this.json.handwritingWidth)||this.isNumber(this.json.handwritingHeight)){var s=this.getImageSize(i,t);e.target.setStyles(s)}else{var o=Math.min(i,800);e.target.setStyles({width:o+"px"})}}.bind(this)}}).inject(s.contentNode)},loadMediaOpinion_image:function(e,t){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(t.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/image.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_image),i.addEvents({click:function(i){if(i.target.mediaOpinionContentNode)return"";var s=this.getMediaOpinionUrl(e),o=new Element("div",{styles:this.form.css.logMediaOpinionContent}).inject(t.getParent(),"after");layout.mobile||o.setStyle("margin-left","40px"),i.target.mediaOpinionContentNode=o,new Element("div",{styles:this.form.css.logMediaOpinionContentClose}).inject(o).addEvent("click",(function(){o.destroy(),i.target.mediaOpinionContentNode=""}));var n,r=new Element("div",{styles:this.form.css.logMediaOpinionContentArea}).inject(o);if(layout.mobile)n=t.getParent().getParent().getSize().x-2;else{var a=t.getParent().getParent(),l=o.getPosition(a);n=Math.min(a.getSize().x-l.x-42,800)}var c=new Element("img",{src:s,styles:{width:n+"px"},events:{load:function(e){var t=e.target.naturalHeight,i=e.target.naturalWidth;if(layout.mobile||!this.isNumber(this.json.handwritingWidth)&&!this.isNumber(this.json.handwritingHeight)){var s=Math.min(i,n);c.setStyles({width:s+"px"}),o.setStyles({width:s+"px"})}else{var r=this.getImageSize(i,t);c.setStyles(r),o.setStyles(r)}}.bind(this)}}).inject(r);i.stopPropagation()}.bind(this)})},hideMediaOpinionNode:function(){this.mediaOpinionContentNode&&(this.mediaOpinionContentNode.destroy(),this.mediaOpinionContentNode=null)},loadMediaOpinion_video:function(e,t){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(t.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/video.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_video)},loadMediaOpinion_voice:function(e,t){var i=new Element("div",{styles:this.form.css.logMediaIcon}).inject(t.getParent());i.setStyle("background-image","url('"+this.form.path+this.form.options.style+"/icon/voice.png')"),i.set("title",MWF.xApplication.process.Xform.LP.mediaOpinion_voice),i.addEvents({click:function(t){var i=this.getMediaOpinionUrl(e);this.audioNode=new Element("audio",{loop:!1}),this.audioNode.set("src",i),this.audioNode.play(),t.stopPropagation()}.bind(this)})}});