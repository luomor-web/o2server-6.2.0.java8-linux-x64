MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Htmleditor=MWF.APPHtmleditor=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","postLoad","afterLoad"]},initialize:function(e,t,n,o){this.node=$(e),this.node.store("module",this),this.json=t,this.form=n,this.field=!0},load:function(){this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){if(this.node.empty(),this.readonly)this.node.set("html",this._getBusinessData()),this.node.setStyles({"-webkit-user-select":"text","-moz-user-select":"text"}),layout.mobile&&this.node.getElements("img").each(function(e){e.setStyles({height:"auto","max-width":"100%"})}.bind(this));else{var e=Object.clone(this.json.editorProperties);if(this.json.config&&this.json.config.code){var t=this.form.Macro.exec(this.json.config.code,this);Object.each(t,(function(t,n){e[n]=t}))}this.loadCkeditor(e)}},loadCkeditor:function(e){COMMON.AjaxModule.loadDom("ckeditor",function(){CKEDITOR.disableAutoInline=!0;var t=new Element("div").inject(this.node),n=this._getBusinessData();n?t.set("html",n):this.json.templateCode&&t.set("html",this.json.templateCode);this.node.getSize().y;var o=e||{};if("Mobile"===this.form.json.mode&&(o.toolbar||o.toolbarGroups||(o.toolbar=[{name:"paragraph",items:["Bold","Italic","-","TextColor","BGColor","JustifyLeft","JustifyCenter","JustifyRight","JustifyBlock","-","Undo","Redo"]},{name:"basicstyles",items:["Styles","FontSize"]},{name:"insert",items:["Image"]}])),o.base64Encode="y"===this.json.base64Encode,o.localImageMaxWidth=800,o.reference=this.form.businessData.work.job,o.referenceType="processPlatformJob",o&&o.extraPlugins){var i=o.extraPlugins;(i="array"===typeOf(i)?i:i.split(",")).push("pagebreak"),o.extraPlugins=i}else o.extraPlugins=["pagebreak"];this.editor=CKEDITOR.replace(t,o),this.editor.addCommand("ecnet",{exec:function(e){this.ecnet()}.bind(this)}),this.editor.ui.add("ecnet",CKEDITOR.UI_BUTTON,{label:MWF.xApplication.process.Xform.LP.intelligentCorrection,icon:"../x_component_process_Xform/$Form/default/icon/ecnet.png",command:"ecnet"}),this._loadEvents(),this.editor.on("change",function(){}.bind(this)),this.json.ecnet}.bind(this))},getEcnetString:function(e,t){for(var n=0;n<e.childNodes.length;n++)if(e.childNodes[n].nodeType===Node.TEXT_NODE){var o=this.ecnetString.length;this.ecnetString+=e.childNodes[n].nodeValue;var i=this.ecnetString.length;t.push({pnode:e,node:e.childNodes[n],start:o,end:i})}else this.getEcnetString(e.childNodes[n],t)},createEcnetNode:function(e){var t=e.node.ownerDocument.createElement("span"),n=0,o=e.node.nodeValue;e.ecnets.each(function(t){var i=t.begin+n-e.start,s=t.end+n-e.start;i<0&&(i=0),s>e.end+n&&(s=e.end+n);var r=o.length,d=o.substring(0,i),a=o.substring(i,s),c=o.substring(s,o.length);n+=(o=d+"<span class='o2_ecnet_item' style='color: red'><u>"+a+"</u></span>"+c).length-r}.bind(this)),t.innerHTML=o,e.pnode.replaceChild(t,e.node),e.pnode.textNode=e.node,e.pnode.ecnetNode=t;var i=this,s=this.editor.document.$.defaultView.frameElement,r=t.getElementsByTagName("span");if(r.length)for(var d=0;d<r.length;d++){var a=r[d];if("o2_ecnet_item"===a.className){var c=new Element("div",{styles:{border:"1px solid #999999","box-shadow":"0px 0px 5px #999999","background-color":"#ffffff",position:"fixed",display:"none"}}).inject(s,"after");new Element("div",{styles:{padding:"3px 10px","font-weight":"bold","font-size":"12px",cursor:"pointer"},text:e.ecnets[d].origin+"->"+e.ecnets[d].correct,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var e=this.getParent(),t=e.node,n=e.node.ecnets[e.idx],o=t.node.ownerDocument.createTextNode(n.correct);e.span.parentNode.replaceChild(o,e.span),e.destroy(),t.node.nodeValue=t.pnode.ecnetNode.innerText,t.ecnets.erase(n),t.ecnets.length||i.ecnetNodes.erase(t)}}}).inject(c),new Element("div",{styles:{padding:"3px 10px","font-size":"12px",cursor:"pointer"},text:MWF.xApplication.process.Xform.LP.ignore,events:{mouseover:function(){this.setStyle("background-color","#dddddd")},mouseout:function(){this.setStyle("background-color","#ffffff")},mousedown:function(){var e=this.getParent(),t=e.node,n=e.node.ecnets[e.idx],o=t.node.ownerDocument.createTextNode(e.span.innerText);e.span.parentNode.replaceChild(o,e.span),e.destroy(),t.node.nodeValue=t.pnode.ecnetNode.innerText,t.ecnets.erase(n),t.ecnets.length||i.ecnetNodes.erase(t)}}}).inject(c);c.node=e,c.idx=d,a.ecnetNode=c,c.span=a,a.addEventListener("click",(function(){var e=this.ecnetNode;e.show();var t=this.offsetTop,n=this.offsetLeft,o=this.offsetWidth,i=this.offsetHeight,r=s.getPosition(),d=e.getSize(),a=t+r.y+i+5,c=n+r.x-(d.x-o)/2;e.style.left=c+"px",e.style.top=a+"px";var l=this,h=function(){e.hide(),l.ownerDocument.removeEventListener("mousedown",h)};this.ownerDocument.addEventListener("mousedown",h)}))}}},clearEcnetNodes:function(){this.ecnetNodes&&this.ecnetNodes.length&&(this.ecnetNodes.each(function(e){e.pnode.ecnetNode&&(e.pnode.ecnetInforNode&&e.pnode.ecnetInforNode.destroy(),e.pnode.ecnetInforNode=null,e.pnode.replaceChild(e.pnode.textNode,e.pnode.ecnetNode))}.bind(this)),this.ecnetNodes=[])},ecnet:function(e){this.editor.document.$.defaultView.frameElement;var t=this.editor.document.$.body;this.ecnetNodes||(this.ecnetNodes=[]),this.ecnetNodes.length&&this.clearEcnetNodes();var n=[];this.ecnetString="",this.getEcnetString(t,n),MWF.Actions.get("x_general_assemble_control").ecnetCheck({value:this.ecnetString},function(e){e.data.itemList&&e.data.itemList.length?(n.each(function(t){var n=[];e.data.itemList.each(function(e){(t.end<=e.end&&t.end>e.begin||t.start>=e.begin&&t.start<e.end||t.start<=e.begin&&t.end>e.end)&&n.push(e)}.bind(this)),n.length&&(t.ecnets=n,this.ecnetNodes.push(t))}.bind(this)),this.ecnetNodes.each(function(e){this.createEcnetNode(e)}.bind(this))):(t=null,n=null)}.bind(this))},_loadEvents:function(e){Object.each(this.json.events,function(e,t){e.code&&this.editor.on(t,function(t){return this.form.Macro.fire(e.code,this,t)}.bind(this),this)}.bind(this))},addModuleEvent:function(e,t){this.editor.on(e,function(e){return t?t(this,e):null}.bind(this),this)},_loadValue:function(){this._getBusinessData()},resetData:function(){this.setData(this._getBusinessData())},isEmpty:function(){return!this.getData().trim()},getData:function(){return this.clearEcnetNodes(),this.editor?this.editor.getData():""},setData:function(e){this._setBusinessData(e),this.editor&&this.editor.setData(e)},createErrorNode:function(e){var t=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(t),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:e}).inject(t);return t},notValidationMode:function(e){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(e).inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},showNotValidationMode:function(e){var t=e.getParent("div");if(t){if("tab$Content"==t.get("MWFtype")&&"none"==t.getParent("div").getStyle("display")){var n=t.getParent("div").getParent("div"),o=n.getPrevious("div"),i=n.getChildren().indexOf(t.getParent("div"));o.getLast().getFirst().getChildren()[i].click(),t=o.getParent("div")}this.showNotValidationMode(t)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(e,t){if("all"==t.status||e==t.decision){var n=this.getData(),o="value"==t.valueType?n:n.length;switch(t.operateor){case"isnull":if(!o)return this.notValidationMode(t.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(t.prompt),!1;break;case"gt":if(o>t.value)return this.notValidationMode(t.prompt),!1;break;case"lt":if(o<t.value)return this.notValidationMode(t.prompt),!1;break;case"equal":if(o==t.value)return this.notValidationMode(t.prompt),!1;break;case"neq":if(o!=t.value)return this.notValidationMode(t.prompt),!1;break;case"contain":if(-1!=o.indexOf(t.value))return this.notValidationMode(t.prompt),!1;break;case"notcontain":if(-1==o.indexOf(t.value))return this.notValidationMode(t.prompt),!1}}return!0},validationConfig:function(e,t){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var n=0;n<this.json.validationConfig.length;n++){var o=this.json.validationConfig[n];if(!this.validationConfigItem(e,o))return!1}return!0}return!0},validation:function(e,t){if(!this.validationConfig(e,t))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=e;var n=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",n||(n=MWF.xApplication.process.Xform.LP.notValidation),"true"==n.toString()||(this.notValidationMode(n),!1)}});