MWF.xApplication=MWF.xApplication||{},MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.ViewDesigner=MWF.xApplication.cms.ViewDesigner||{},MWF.CMSVD=MWF.xApplication.cms.ViewDesigner,MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("cms.ViewDesigner","lp."+MWF.language,null,!1),MWF.xApplication.cms.ViewDesigner.View=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",showTab:!0},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_cms_ViewDesigner/$View/",this.cssPath="../x_component_cms_ViewDesigner/$View/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=e,this.documentFields=e.documentFields,this.formFields=e.formFields,this.relativeForm=t.content.relativeForm,this.actions=e.actions,this.application=e.application,this.lp=this.designer.lp,this.node=this.designer.designNode,this.tab=this.designer.tab,this.areaNode=new Element("div.areaNode",{styles:{overflow:"hidden"}}),this.data=t.content,this.isNewView=this.data.isNew,this.columns=[],this.columnsRemoved=[],this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFViewAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4)},load:function(){this.setAreaNodeSize(),this.designer.addEvent("resize",function(){this.setAreaNodeSize(),this.setPropertyContentResize(),this.setViewNodeWidth()}.bind(this)),this.page=this.tab.addTab(this.areaNode,this.data.name||this.designer.lp.newView,!this.data.isNew&&this.data.id!=this.designer.options.id),this.page.view=this,this.page.addEvent("show",function(){this.designer.viewListAreaNode.getChildren().each(function(e){var t=e.retrieve("view");(t.id==this.data.id||t.content.isNew&&this.isNewView)&&(this.designer.currentListViewItem&&this.designer.currentListViewItem.setStyles(this.designer.css.listViewItem),e.setStyles(this.designer.css.listViewItem_current),this.designer.currentListViewItem=e,this.lisNode=e)}.bind(this)),this.propertyNode||this.loadProperty()}.bind(this)),this.page.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.saveSilence(),this.lisNode&&this.lisNode.setStyles(this.designer.css.listScriptItem)}.bind(this)),this.page.tabNode.addEvent("dblclick",this.designer.maxOrReturnEditor.bind(this.designer)),this.createViewNode(),this.options.showTab&&this.page.showTabIm(),this.setPropertyContentResize()},saveSilence:function(e){this._save(e)},save:function(e){this._save(e,!0)},_save:function(e,t){if(!this.data.name||""==this.data.name)return this.designer.notice(this.lp.notice.inputName,"error"),!1;var i={};i.isNew=this.isNewView,i.id=this.data.id,i.name=this.data.name,i.alias=this.data.alias,i.description=this.data.description,i.appId=this.data.application,i.formId=this.data.relativeForm.id,i.orderType=this.data.sortType,i.orderField=this.data.sortField,i.orderFieldType=this.data.sortFieldType,this.data.isNew=!1,this.data.columns=this.getColumnsData(),i.fields=this.getColumnsItemData(),i.content=JSON.stringify(this.data),this.designer.actions.saveView(i,function(i){this.data.id=i.data.id,t&&this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.lisNode&&(this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),this.isNewView&&(this.lisNode.eliminate("view"),this.lisNode.store("view",i.data))),this.data.isNew=!1,this.isNewView=!1,this.page.textNode.set("text",this.data.name),e&&e()}.bind(this))},saveAs:function(){new MWF.xApplication.cms.ViewDesigner.View.NewName(this,{name:this.data.name+"_"+this.designer.lp.copy},{onSave:function(e,t){this._saveAs(e.name,t)}.bind(this)},{app:this.designer}).edit()},clone:function(e){if(null==e||"object"!=typeof e)return e;if("number"==typeof e.length){for(var t=[],i=0,s=e.length;i<s;++i)t[i]=this.clone(e[i]);return t}t={};for(var n in e)t[n]=this.clone(e[n]);return t},_saveAs:function(e,t){var i=this.clone(this.data);i.name=e,i.alias="";var s={isNew:!0};s.id=this.designer.actions.getUUID(),s.name=e,s.alias="",s.description=i.description,s.appId=i.application,s.formId=i.relativeForm.id,s.orderType=i.sortType,s.orderField=i.sortField,s.orderFieldType=i.sortFieldType,i.isNew=!1;var n=this.clone(this.getColumnsData()),o=this.clone(this.getColumnsItemData());n.each(function(e,t){var i=o[t],n=this.designer.actions.getUUID();e.id=n,e.isNew=!1,e.viewId=s.id,i.id=n,i.isNew=!0,i.viewId=s.id}.bind(this)),i.columns=n,s.fields=o,s.content=JSON.stringify(i),this.designer.actions.saveView(s,function(e){this.designer.notice(this.designer.lp.notice.saveAs_success,"success",this.node,{x:"left",y:"bottom"}),t&&t()}.bind(this))},explode:function(){},implode:function(){},setAreaNodeSize:function(){var e=this.node.getSize(),t=this.tab.tabNodeContainer.getSize(),i=parseInt(e.y-t.y);this.areaNode.setStyle("height",i+"px")},setViewNodeWidth:function(){this.columnWidth=this.getColumnsWidth();var e=this.columnWidth+2*this.columns.length+300;this.node.getSize().x-10>e?this.viewNode.setStyle("width",this.node.getSize().x-10+"px"):this.viewNode.setStyle("width",e+"px")},createViewNode:function(){if(this.viewAreaNode=new Element("div.viewAreaNode",{styles:{"overflow-x":"scroll","overflow-y":"hidden"}}).inject(this.areaNode),this.viewAreaNode.addEvent("scroll",function(){this.currentColumn&&this.currentColumn._hideActions()}.bind(this)),this.setViewAreaNodeSize(),this.viewAreaNode.addEvent("click",function(){this.currentColumn&&(this.currentColumn.cancelCurrent(),this.currentColumn.hideProperty()),this.showPropertyContent()}.bind(this)),this.viewNode=new Element("div.viewNode",{styles:this.css.viewNode}).inject(this.viewAreaNode),this.headBar=new MWF.xApplication.cms.ViewDesigner.View.HeadBar(this),this.data.columns&&this.data.columns.length>0)for(var e=0;e<this.data.columns.length;e++){var t=this.data.columns[e];this.addColumn(e,t)}else this.addColumn(0);this.setViewNodeWidth()},setViewAreaNodeSize:function(){var e=this.node.getSize(),t=this.tab.tabNodeContainer.getSize(),i=parseInt((e.y-t.y)/3);this.viewAreaNode.setStyle("height",i+"px")},getTemplateData:function(e){if(this.dataTemplate)e&&e(this.dataTemplate);else{var t=this.path+this.options.style+"/columnTemplate.json";MWF.getJSON(t,function(t,i){this.dataTemplate=t,e&&e(t)}.bind(this),!1)}},addColumn:function(e,t){t||(this.getTemplateData(),(t=Object.clone(this.dataTemplate)).isNew=!0,t.id=this.actions.getUUID()),e=e||0,this.columns.length<=e&&(e=this.columns.length);var i=new MWF.xApplication.cms.ViewDesigner.View.Column(this,t,e);if(this.columns.length==e)this.columns.push(i);else{var s=this.columns.splice(e,this.columns.length-e,i);s.each((function(e){e.data.index=e.data.index+1,e.node.set("index",e.data.index)})),this.columns=this.columns.concat(s)}this.setEachColumnWidth(),this.setViewNodeWidth()},moveColumn:function(e,t){if(e!=t){for(var i=[],s=0;s<this.columns.length;s++)s!=e&&(s==t&&t!=this.columns.length&&i.push(this.columns[e]),i.push(this.columns[s]),s==this.columns.length-1&&t==this.columns.length&&i.push(this.columns[e]));this.columns=i;for(s=0;s<this.columns.length;s++)c=this.columns[s],c.data.index=s,c.node.set("index",s);this.setViewNodeWidth()}},removeColumn:function(e){if(this.columns.length<=1)this.designer.notice(this.designer.lp.notice.noRemoveOnlyColumn,"error");else{for(var t=e+1;t<this.columns.length;t++)c=this.columns[t],c.data.index=c.data.index-1,c.node.set("index",c.data.index);this.showPropertyContent();var i=this.columns.splice(e,1);i[0].data.isNew||this.columnsRemoved.push(i[0]),i[0].removeNode(),this.setEachColumnWidth(),this.setViewNodeWidth()}},getColumnNodes:function(){var e=[];return this.columns.each((function(t){e.push(t.node)})),e},getColumnsWidth:function(){var e=0;return this.columns.each((function(t){e+=t.data.width})),e},setEachColumnWidth:function(){var e=this.getColumnsWidth();this.columns.each((function(t){if(t.property){var i=Math.round(t.data.width/e*100);t.property.columnPercentageWidthNode.set("text",i),t.data.widthPer=i}}))},getColumnsData:function(){var e=[];return this.columns.each((function(t){e.push(t.data)})),e},getColumnsItemData:function(e){var t=[];return this.columns.each((function(i){t.push(i.getData()),e||(i.data.isNew=!1)})),t},loadProperty:function(){this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.areaNode),this.propertyContentNode=new Element("div.propertyContentNode",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.viewAreaPercent=.3,this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyTitleNode=new Element("div.propertyTitleNode",{styles:this.css.propertyTitleNode,text:this.lp.viewProperty}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div.propertyContentArea",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize(),this.setPropertyContent(),this.propertyNode.addEvent("keydown",(function(e){e.stopPropagation()}))},setPropertyContent:function(){this.propertyContentContainArea=new Element("div.propertyContentContainArea").inject(this.propertyContentArea),this.viewPropertyNode=new Element("div.viewPropertyNode",{styles:this.css.viewPropertyNode}),MWF.require("MWF.widget.Tab",function(){this.propertyTab=new MWF.widget.Tab(this.propertyContentContainArea,{style:"moduleList"}),this.propertyTab.load();var e=this.propertyTab.addTab(this.viewPropertyNode,this.lp.base,!1);e.contentNodeArea.set("class","viewContentNodeArea"),this.setScrollBar(e.contentNodeArea,"small",null,null),this.propertyTab.pages[0].showTab()}.bind(this));var e=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.viewPropertyNode),t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.id}).inject(t);i=this.propertyIdNode=new Element("td",{class:"editTableValue",styles:this.css.editTableValue,text:this.data.id?this.data.id:""}).inject(t),t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.relativeForm}).inject(t),i=new Element("td",{class:"editTableValue",styles:this.css.editTableValue,text:this.relativeForm.name}).inject(t),t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.name}).inject(t),i=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(t);this.propertyNameNode=new Element("input",{styles:this.css.editTableInput}).inject(i),this.propertyNameNode.addEvent("change",function(){this.data.name=this.propertyNameNode.get("value")}.bind(this));t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.alias}).inject(t),i=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(t);this.propertyAliasNode=new Element("input",{styles:this.css.editTableInput}).inject(i),this.propertyAliasNode.addEvent("change",function(){this.data.alias=this.propertyAliasNode.get("value")}.bind(this));t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.sortColumn}).inject(t),i=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(t);this.propertySortFieldNode=this.getFieldsSelectElement(),this.propertySortFieldNode.inject(i),this.propertySortFieldNode.addEvent("change",function(){this.data.sortField=this.getSelectText(this.propertySortFieldNode),this.data.sortFieldType=this.getSelectValue(this.propertySortFieldNode)}.bind(this)),this.propertySortTypeNode=this.getSortSelectElement(),this.propertySortTypeNode.inject(i),this.propertySortTypeNode.addEvent("change",function(){this.data.sortType=this.getSelectValue(this.propertySortTypeNode)}.bind(this));t=new Element("tr").inject(e),i=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.description}).inject(t),i=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(t);this.propertyDescriptionNode=new Element("textarea",{styles:this.css.editTableTextarea}).inject(i),this.propertyDescriptionNode.addEvent("change",function(){this.data.description=this.propertyDescriptionNode.get("text")}.bind(this)),this.setPropertyValue()},hidePropertyContent:function(){this.propertyContentContainArea.setStyle("display","none")},showPropertyContent:function(){this.currentColumn&&this.currentColumn.hideProperty(),this.propertyTitleNode.set("text",this.lp.viewProperty),this.propertyContentContainArea.setStyle("display","block")},getFormSelectElement:function(e,t){var i=new Element("select",{styles:this.css.propertyFormNode});return this.actions.listForm(this.application.id,function(e){e.data.each((function(e){var s=new Element("option",{value:e.id,text:e.name}).inject(i);t==e.id&&(s.selected=!0)}))}.bind(this),null,!1),i},getFieldsSelectElement:function(){var e=new Element("select");return new Element("option",{value:"",text:""}).inject(e),this.documentFields.concat(this.formFields).each(function(t){var i=new Element("option",{value:t.type,text:t.name}).inject(e);(this.data.sortField==t.name||"createTime"===t.name)&&(i.selected=!0)}.bind(this)),e},getSortSelectElement:function(){var e=new Element("select",{styles:{"margin-left":"5px"}}),t=new Element("option",{value:"ASC",text:this.lp.asc}).inject(e);"ASC"==this.data.sortType&&(t.selected=!0);t=new Element("option",{value:"DESC",text:this.lp.desc}).inject(e);return"DESC"==this.data.sortType&&(t.selected=!0),e},getSelectValue:function(e){var t;return e.getElements("option").each((function(e){e.selected&&(t=e.value)})),t},getSelectText:function(e){var t;return e.getElements("option").each((function(e){e.selected&&(t=e.text)})),t},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(e,t){var i="firefox"==Browser.name?t.event.clientX:t.event.x,s="firefox"==Browser.name?t.event.clientY:t.event.y;e.store("position",{x:i,y:s});var n=this.viewAreaNode.getSize();e.store("initialHeight",n.y)}.bind(this),onDrag:function(e,t){var i=this.areaNode.getSize(),s="firefox"==Browser.name?t.event.clientY:t.event.y,n=e.retrieve("position"),o=s.toFloat()-n.y.toFloat(),a=e.retrieve("initialHeight").toFloat()+o;a<60&&(a=60),a>i.y-60&&(a=i.y-60),this.viewAreaPercent=a/i.y,this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var e=this.areaNode.getSize(),t=this.propertyContentResizeNode.getSize(),i=e.y-t.y-27,s=this.viewAreaPercent*i,n=i-s;this.viewAreaNode.setStyle("height",s+"px"),this.propertyContentNode.setStyle("height",n+"px");var o=this.propertyTab.tabNodeContainer.getSize(),a=this.propertyTitleNode.getSize(),l=this.propertyPageHeight=n-o.y-a.y-20;this.propertyTab.pages.each((function(e){e.contentNodeArea.setStyle("height",l+"px")})),this.currentColumn&&this.currentColumn.property&&this.currentColumn.property.propertyTab.pages.each((function(e){e.contentNodeArea.setStyle("height",l+"px")}))},setPropertyValue:function(){this.propertyIdNode.set("text",this.data.id),this.propertyNameNode.set("value",this.data.name),this.propertyAliasNode.set("value",this.data.alias),this.propertyDescriptionNode.set("value",this.data.description)},loadEventsEditor:function(e,t){MWF.xDesktop.requireApp("cms.FormDesigner","widget.EventsEditor",function(){new MWF.xApplication.cms.FormDesigner.widget.EventsEditor(e,this.designer,{helpStyle:"cmsView",maxObj:this.node}).load(t)}.bind(this))},loadScriptEditor:function(e,t,i,s){var n=this.data[t];MWF.require("MWF.widget.ScriptArea",function(){var o=this.scriptArea=new MWF.widget.ScriptArea(e,{title:i,maxObj:this.node,onChange:function(){this.data[t]=o.toJson()}.bind(this),onSave:function(){this.save()}.bind(this),style:s||"default",helpStyle:"cmsView"});o.load(n)}.bind(this))},getViewEventsData:function(e){var t=this.path+this.options.style+"/viewEventsTemplate.json";MWF.getJSON(t,function(t,i){this.data.events=t,e&&e(t)}.bind(this),!1)},getOperationConfig:function(e){if(this.operationConfig)e&&e(this.operationConfig);else{var t=this.path+this.options.style+"/operation.json";MWF.getJSON(t,function(t,i){this.operationConfig=t,e&&e(t)}.bind(this),!1)}return this.operationConfig}}),MWF.xApplication.cms.ViewDesigner.View.Column=new Class({Implements:[Options,Events],options:{style:"default",actions:[{name:"insertColLeft",icon:"insertColLeft.png",event:"click",action:"insertColLeft",title:MWF.xApplication.cms.ViewDesigner.LP.insertColLeft},{name:"insertColRight",icon:"insertColRight.png",event:"click",action:"insertColRight",title:MWF.xApplication.cms.ViewDesigner.LP.insertColRight},{name:"deleteCol",icon:"deleteCol1.png",event:"click",action:"deleteCol",title:MWF.xApplication.cms.ViewDesigner.LP.deleteCol},{name:"moveCol",icon:"move1.png",event:"click",action:"moveCol",title:MWF.xApplication.cms.ViewDesigner.LP.moveCol}],actionNodeStyles:{width:"16px",height:"16px","margin-left":"2px","margin-right":"2px",float:"left",border:"1px solid #F1F1F1",cursor:"pointer"}},initialize:function(e,t,i){this.view=e,this.css=e.css,this.designer=e.designer,this.data=t,this.container=e.viewNode,this.data.index=i,this.isCurrent=!1,this.load()},load:function(){this.createNodes(),this.createIconAction(),this.setEvent()},createNodes:function(){this.node=new Element("div.column",{styles:this.view.css.columnNode,index:this.data.index}),this.node.store("column",this);var e=this.container.getFirst("div.column[index="+this.data.index+"]");if(e?this.node.inject(e,"before"):this.node.inject(this.container),this.contentNode=new Element("div",{styles:this.view.css.columnContentNode}).inject(this.node),this.contentTitleNode=new Element("div.columnContentTitleNode",{styles:this.view.css.columnContentTitleNode}).inject(this.contentNode),this.data.title?this.contentTitleNode.set("text",this.data.title):this.contentTitleNode.set("text",this.view.lp.noTitle),this.data.width?this.contentNode.setStyle("width",this.data.width):(this.contentNode.setStyle("width","150px"),this.data.width=150),this.data.align&&this.setAlignIcon(),this.resizeNode=new Element("div",{styles:this.view.css.columnResizeNode}).inject(this.node),this.loadResize(),this.data.operation)for(var t in this.data.operation)op=this.data.operation[t],this.setOperation(op.name,op.text,op.icon,op.iconOver,op.action);"yes"==this.data.sortByClickTitle&&this.setSortIcon()},setEvent:function(){this.node.addEvents({click:function(e){this.view.isOnDragging||this.setCurrent(),e.stopPropagation()}.bind(this),mouseover:function(e){this.isCurrent||this.contentNode.setStyles(this.view.css.columnContentNode_over)}.bind(this),mouseout:function(e){this.isCurrent||this.contentNode.setStyles(this.view.css.columnContentNode)}.bind(this)})},_showActions:function(){this.actionArea&&this.options.actions.length&&(this._setActionAreaPosition(),this.actionArea.setStyle("display","block"))},_hideActions:function(){this.actionArea&&this.actionArea.setStyle("display","none")},createIconAction:function(){this.actionNodes=this.actionNodes||{},this.actionArea||(this.actionArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999",opacity:1,"z-index":100}}).inject(this.container,"after"),this.options.actions.each(function(e){var t=this.actionNodes[e.name]=new Element("div",{styles:this.options.actionNodeStyles,title:e.title}).inject(this.actionArea);t.setStyle("background","url("+this.view.path+this.options.style+"/icon/"+e.icon+") no-repeat left center"),t.addEvent(e.event,function(t){this[e.action](t),t.stopPropagation()}.bind(this)),t.addEvents({mouseover:function(e){e.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(e){e.target.setStyle("border","1px solid #F1F1F1")}.bind(this)})}.bind(this)))},_setActionAreaPosition:function(){var e=this.node.getPosition(this.designer.designNode.getOffsetParent()),t=e.y-25,i=e.x;this.actionArea.setPosition({x:i,y:t})},insertColLeft:function(){var e=this.data.index;this.view.addColumn(e),this.view.columns[e].setCurrent()},insertColRight:function(){var e=this.data.index+1;this.view.addColumn(e),this.view.columns[e].setCurrent()},deleteCol:function(){var e=this;this.designer.confirm("warn",this.actionNodes.deleteCol,MWF.xApplication.cms.ViewDesigner.LP.deleteColConfirmTitle,MWF.xApplication.cms.ViewDesigner.LP.deleteColConfirm,300,120,(function(){e.view.removeColumn(e.data.index),this.close()}),(function(){this.close()}))},removeNode:function(){this.actionArea&&this.actionArea.destroy(),this.node.destroy()},cancelCurrent:function(){this.isCurrent=!1,this.contentNode.setStyles(this.view.css.columnContentNode),this._hideActions()},setCurrent:function(){this.view.currentColumn&&(this.view.currentColumn.currentTimeout&&clearTimeout(this.view.currentColumn.currentTimeout),this.view.currentColumn.cancelCurrent(),this.view.currentColumn.hideProperty()),this.contentNode.setStyles(this.view.css.columnContentNode_current),this.isCurrent=!0,this.setNodeScroll(),this.currentTimeout=setTimeout(function(){this._showActions(),this.showProperty(),this.view.propertyPageHeight&&this.property.propertyTab.pages.each(function(e){e.contentNodeArea.setStyle("height",this.view.propertyPageHeight+"px")}.bind(this)),this.view.currentColumn=this,this.currentTimeout=null}.bind(this),100)},setNodeScroll:function(){var e=this.view.viewAreaNode,t=this.view.viewNode,i=e.getCoordinates(),s=i.left,n=s+i.width,o=this.node.getCoordinates();if(n-o.left<100){var a=o.left+100-n;e.getScroll().x+a<t.getSize().x?e.scrollTo(e.getScroll().x+a,0):e.scrollTo(t.getSize().x,0)}else if(s>o.left){(a=e.getScroll().x-(s-o.left)-10)>0?e.scrollTo(a,0):e.scrollTo(0,0)}},loadResize:function(){this.resize=new Drag(this.resizeNode,{snap:1,onStart:function(e,t){var i="firefox"==Browser.name?t.event.clientX:t.event.x,s="firefox"==Browser.name?t.event.clientY:t.event.y;e.store("position",{x:i,y:s});var n=this.contentNode.getSize();e.store("initialWidth",n.x)}.bind(this),onDrag:function(e,t){var i="firefox"==Browser.name?t.event.clientX:t.event.x,s=this.view.viewNode.getSize(),n=e.retrieve("position"),o=e.retrieve("initialWidth").toFloat()-(n.x.toFloat()-i.toFloat());o>s.x/2&&(o=s.x/2),o<40&&(o=40),this.contentNode.setStyle("width",o),this.data.width=o+10,this.property&&this.property.columnWidthNode.set("value",Math.round(o)+10),this.view.setEachColumnWidth(),this.view.setViewNodeWidth()}.bind(this)})},moveCol:function(e){this._createMoveNode(),this._setNodeMove(e),this._hideActions()},_createMoveNode:function(){this.moveNode=new Element("div",{MWFType:"label",styles:this.view.css.moduleNodeMove,text:this.node.get("text"),events:{selectstart:function(){return!1}}}).inject(this.container)},_setNodeMove:function(e){this._setMoveNodePosition(e);var t=this.view.getColumnNodes();t.push(this.view.headBar.node),new Drag.Move(this.moveNode,{droppables:t,onEnter:function(e,t){var i=t.retrieve("column");i&&i._dragIn(this)}.bind(this),onLeave:function(e,t){var i=t.retrieve("column");i&&i._dragOut(this)}.bind(this),onDrag:function(e){this.view.isOnDragging=!0,this._setScroll()}.bind(this),onDrop:function(e,t,i){if(t){var s=t.retrieve("column");s?(s.isHeadBar?0==this.data.index?this._dragCancel(e):(this._dragComplete(s.node),this.view.moveColumn(this.data.index,0)):s.data.index+1==this.data.index||s.data.index==this.data.index?this._dragCancel(e):(this._dragComplete(s.node),this.view.moveColumn(this.data.index,s.data.index+1)),s._dragDrop(this)):this._dragCancel(e)}else this._dragCancel(e);this.dragColInterval&&(clearInterval(this.dragColInterval),this.dragColInterval=null),setTimeout(function(){this.view.isOnDragging=!1}.bind(this),100),i.stopPropagation()}.bind(this),onCancel:function(e){this.dragColInterval&&(clearInterval(this.dragColInterval),this.dragColInterval=null),setTimeout(function(){this.view.isOnDragging=!1}.bind(this),100)}.bind(this)}).start(e)},_setScroll:function(){var e=this.view.viewAreaNode,t=e.getCoordinates(),i=t.left,s=i+t.width,n=this.view.viewNode,o=this.moveNode.getCoordinates();o.left+o.width>s?this.dragColInterval||(this.dragColInterval=setInterval(function(){e.getScroll().x+15<n.getSize().x?e.scrollTo(e.getScroll().x+15,0):e.scrollTo(n.getSize().x,0)}.bind(this),100)):o.left<i?this.dragColInterval||(this.dragColInterval=setInterval(function(){e.getScroll().x-15>0?e.scrollTo(e.getScroll().x-15,0):e.scrollTo(0,0)}.bind(this),100)):this.dragColInterval&&(clearInterval(this.dragColInterval),this.dragColInterval=null)},_dragIn:function(){this.resizeNode.setStyles(this.view.css.columnResizeNode_dragIn)},_dragOut:function(){this.resizeNode.setStyles(this.view.css.columnResizeNode)},_dragDrop:function(){this.resizeNode.setStyles(this.view.css.columnResizeNode)},_dragComplete:function(e){this.node.inject(e,"after"),this.setCurrent(),this.moveNode&&this.moveNode.destroy(),this.moveNode=null},_dragCancel:function(){this.moveNode&&this.moveNode.destroy(),this.moveNode=null},_setMoveNodePosition:function(e){var t=e.page.x+2,i=e.page.y+2;this.moveNode.positionTo(t,i)},showProperty:function(){this.view.hidePropertyContent(),this.view.propertyTitleNode.set("text",this.view.lp.columnProperty),this.property?this.property.show():(this.property=new MWF.xApplication.cms.ViewDesigner.View.ColumnProperty(this,this.view.propertyContentArea,this.designer,{onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},setPropertiesOrStyles:function(e){"styles"==e&&this.setCustomStyles(),"properties"==e&&this.node.setProperties(this.data.properties)},setCustomStyles:function(){var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles(this.css.moduleNode),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",e),Object.each(this.data.styles,function(e,t){t.test(/^border\w*/gi)||this.node.setStyle(t,e)}.bind(this))},setSortIcon:function(){this.sortIconNode?this.sortIconNode.setStyle("display","inline"):this.sortIconNode=new Element("div",{styles:this.css.sortIconNode}).inject(this.contentTitleNode,"before")},cancelSortIcon:function(){this.sortIconNode.setStyle("display","none")},setAlignIcon:function(){this.alignIconNode&&this.alignIconNode.destroy(),"left"==this.data.align?this.alignIconNode=new Element("div",{styles:this.css.alignleftNode}).inject(this.contentTitleNode,"after"):"right"==this.data.align&&(this.alignIconNode=new Element("div",{styles:this.css.alignrightNode}).inject(this.contentTitleNode,"after"))},setOperation:function(e,t,i,s,n){this.optionNodes=this.optionNodes||{};var o=this.view.path+this.view.options.style+"/operationIcon/";this.optionNodes[e]||(this.contentTitleNode.get("text")==this.view.lp.noTitle&&this.contentTitleNode.set("text",""),(this.optionNodes[e]=new Element("div",{styles:this.view.css.operationNode,title:t}).inject(this.contentNode,"bottom")).setStyle("background-image","url("+o+i+")"))},deleteOperation:function(e){for(var t in this.optionNodes&&this.optionNodes[e]&&(this.optionNodes[e].destroy(),this.optionNodes[e]=null,delete this.optionNodes[e]),flag=!1,this.optionNodes)flag=!0;flag||""==this.contentTitleNode.get("text")&&this.contentTitleNode.set("text",this.view.lp.noTitle)},delete:function(e){!this.data.isNew&&this.data.id&&this.view.actions.deleteViewColumn(this.data.id,function(t){e&&e()}.bind(this))},getData:function(){var e={};return e.id=this.data.id,e.isNew=this.data.isNew,e.viewId=this.view.data.id,e.fieldTitle=this.data.title,e.fieldName=this.data.value,e.xshowSequence=this.view.data.relativeForm.id,e},save:function(e){var t=!0;if(this.data.value&&""!=this.data.value){var i={};i.id=this.data.id,i.isNew=this.data.isNew,i.viewId=this.view.data.id,i.fieldTitle=this.data.title,i.fieldName=this.data.value,i.xshowSequence=this.view.data.relativeForm.id,this.view.actions.saveViewColumn(i,function(t){this.data.isNew=!1,e&&e()}.bind(this),function(){t=!1}.bind(this),!1)}else this.data.isNew||(this.delete(e),this.data.isNew=!0);return t}}),MWF.xApplication.cms.ViewDesigner.View.HeadBar=new Class({initialize:function(e){this.view=e,this.designer=e.designer,this.container=e.viewNode,this.isHeadBar=!0,this.load()},load:function(){this.createNodes()},createNodes:function(){this.node=new Element("div.column",{styles:this.view.css.headBarNode}),this.node.store("column",this),this.node.inject(this.container),this.headBarContentNode=new Element("div",{styles:this.view.css.headBarContentNode}).inject(this.node),this.resizeNode=new Element("div",{styles:this.view.css.headBarResizeNode}).inject(this.node)},_dragIn:function(){this.resizeNode.setStyles(this.view.css.headBarResizeNode_dragIn)},_dragOut:function(){this.resizeNode.setStyles(this.view.css.headBarResizeNode)},_dragDrop:function(){this.resizeNode.setStyles(this.view.css.headBarResizeNode)}}),MWF.xApplication.cms.ViewDesigner.View.ColumnProperty=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(e,t,i,s){this.setOptions(s),this.column=e,this.data=e.data,this.css=e.css,this.lp=e.view.lp,this.designer=i,this.propertyNode=t},load:function(){this.fireEvent("queryLoad"),this.fireEvent("postLoad")},editProperty:function(e){},show:function(){this.propertyContent?this.propertyContent.setStyle("display","block"):this.createNode()},hide:function(){this.propertyContent&&this.propertyContent.setStyle("display","none")},createNode:function(){var e=this;this.propertyContent=new Element("div",{styles:this.css.columnPropertyContent}).inject(this.propertyNode),this.basePropertyNode=new Element("div"),MWF.require("MWF.widget.Tab",function(){this.propertyTab=new MWF.widget.Tab(this.propertyContent,{style:"moduleList"}),this.propertyTab.load();var e=this.propertyTab.addTab(this.basePropertyNode,this.lp.base,!1);this.setScrollBar(e.contentNodeArea,"small",null,null),this.propertyTab.pages[0].showTab()}.bind(this));var t=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.basePropertyNode),i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.columnTitle}).inject(i);s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.columnTitleNode=new Element("input",{type:"text",class:"editTableInput",styles:this.css.editTableInput,value:this.data.title}).inject(s),this.columnTitleNode.addEvents({change:function(){var e=this.columnTitleNode.get("value");this.data.title=e,this.column.contentTitleNode.set("text",e)}.bind(this)});i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle}).inject(i),s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.loadSort(s);i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.columnValue}).inject(i),s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.columnValueNode=this.getFieldSelectElement(),this.columnValueNode.inject(s),this.columnValueNode.addEvent("change",function(){this.data.value=this.column.view.getSelectValue(this.columnValueNode)}.bind(this));i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.columnWidth}).inject(i),s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.data.widthPer?this.columnPercentageWidthNode=new Element("span",{text:this.data.widthPer}).inject(s):this.columnPercentageWidthNode=new Element("span",{text:Math.round(this.data.width/this.column.view.getColumnsWidth()*100)}).inject(s),"px"==this.data.widthType&&this.columnPercentageWidthNode.setStyle("display","none"),this.columnWidthNode=new Element("input",{type:"text",class:"editTableInput",styles:this.css.editTableInputNoWidth,value:this.data.width}).inject(s),this.columnWidthNode.setStyles({width:"50px"}),"px"!=this.data.widthType&&this.columnWidthNode.setStyle("display","none"),this.columnWidthNode.addEvents({change:function(){var t=Math.round(this.value);isNaN(t)||t>10&&(e.column.node.setStyle("width",t),e.column.contentNode.setStyle("width",t-10),e.data.width=t,e.column.view.setViewNodeWidth())}}),this.columnWidthTypeNode=new Element("select").inject(s),new Element("option",{value:"percentage",text:this.lp.percentage}).inject(this.columnWidthTypeNode);var n=new Element("option",{value:"px",text:this.lp.px}).inject(this.columnWidthTypeNode);"px"==this.data.widthType&&(n.selected=!0),this.columnWidthTypeNode.addEvents({change:function(){for(var t=0;t<this.options.length;t++)if((n=this.options[t]).selected)if(e.data.widthType=n.value,"percentage"==n.value){e.widthType="percentage",e.columnWidthNode.setStyle("display","none"),e.columnPercentageWidthNode.setStyle("display","inline");var i=Math.round(e.column.node.getSize().x/e.column.view.getColumnsWidth()*100);e.columnPercentageWidthNode.set("text",i),e.data.widthPer=i,e.column.view.setViewNodeWidth()}else{e.widthType="px",e.columnWidthNode.setStyle("display","inline");var s=e.column.node.getSize().x;e.columnWidthNode.set("value",s),e.data.width=s,e.columnPercentageWidthNode.setStyle("display","none"),e.column.view.setViewNodeWidth()}}});i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.columnAlign}).inject(i),s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.columnAlignNode=this.loadAlign(s),this.columnAlignNode.addEvent("change",function(){this.data.align=this.column.view.getSelectValue(this.columnAlignNode),this.column.setAlignIcon()}.bind(this));i=new Element("tr").inject(t),s=new Element("td",{class:"editTableTitle",styles:this.css.editTableTitle,text:this.lp.action}).inject(i),s=new Element("td",{class:"editTableValue",styles:this.css.editTableValue}).inject(i);this.loadOperation(s)},loadSort:function(e){var t=this,i=new Element("span",{styles:this.css.propertyCheckBox}).inject(e),s=new Element("input",{type:"checkbox",value:"yes"}).inject(i);"yes"==this.data.sortByClickTitle&&(s.checked=!0),new Element("span",{text:this.lp.sortByClickTitle}).inject(i),s.addEvents({click:function(e){this.checked?(t.data.sortByClickTitle="yes",t.column.setSortIcon()):(t.data.sortByClickTitle="no",t.column.cancelSortIcon())}})},getFieldSelectElement:function(){var e=new Element("select");return new Element("option",{value:"",text:""}).inject(e),this.column.view.documentFields.concat(this.column.view.formFields).each(function(t){var i=new Element("option",{value:t.name,text:t.name}).inject(e);this.data.value==t.name&&(i.selected=!0)}.bind(this)),e},loadEventsEditor:function(e,t){MWF.xDesktop.requireApp("cms.FormDesigner","widget.EventsEditor",function(){new MWF.xApplication.cms.FormDesigner.widget.EventsEditor(e,this.designer,{helpStyle:"cmsViewColumn",maxObj:this.column.view.node}).load(t)}.bind(this))},loadAlign:function(e){var t=new Element("select").inject(e),i=this.lp.columnAlignValue.split(","),s=this.lp.columnAlignText.split(",");return i.each(function(e,i){var n=new Element("option",{value:e,text:s[i]}).inject(t);this.data.align==e&&(n.selected=!0)}.bind(this)),t},loadOperation:function(e){var t=this;this.data.operation=this.data.operation||{};var i=this.column.view.getOperationConfig();if(i.default)for(var s in i.default){var n=i.default[s];n.name=s,n.text=t.lp[n.title]?t.lp[n.title]:n.title;var o=new Element("span",{styles:this.css.propertyCheckBox}).inject(e),a=new Element("input",{type:"checkbox",value:n.name}).inject(o);this.data.operation[s]&&(a.checked=!0),new Element("span",{text:n.text}).inject(o),a.store("op",n),a.addEvents({click:function(e){var i=this.retrieve("op");this.checked?(t.data.operation[i.name]=i,t.column.setOperation(i.name,i.text,i.icon,i.iconOver,i.action)):(t.data.operation[i.name]&&delete t.data.operation[i.name],t.column.deleteOperation(i.name))}})}}}),MWF.xApplication.cms.ViewDesigner.View.NewName=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"blue",width:700,height:"220",hasTop:!0,hasIcon:!1,draggable:!0,title:MWF.xApplication.cms.ViewDesigner.LP.newListName},_createTableContent:function(){this.formTableArea.set("html","<table width='80%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin: 20px auto 0px auto; '><tr><td styles='formTableTitle' lable='name' width='25%'></td>    <td styles='formTableValue' item='name' colspan='3'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data||{},{isEdited:!0,style:"cms",hasColon:!0,itemTemplate:{name:{text:MWF.xApplication.cms.ViewDesigner.LP.name,notEmpty:!0}}},this.app),this.form.load()}.bind(this),null,!0)},ok:function(){var e=this.form.getResult(!0,null,!0,!1,!0);e&&this.fireEvent("save",[e,function(){this.close()}.bind(this)])}});