MWF.xDesktop=MWF.xDesktop||{},MWF.xApplication=MWF.xApplication||{},MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.require("MWF.xDesktop.UserData",null,!1),MWF.xDesktop.Authentication=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",width:"420",height:"640",popupStyle_password:"o2platformSignupFlat",popupStyle_signup:"o2platformSignup"},initialize:function(t,e,i){this.setOptions(t),this.node=i,this.path=MWF.defaultPath+"/xDesktop/$Authentication/";var s=null;MWF.UD.getPublicData("loginStyleList",function(t){t&&t.enabledId&&MWF.UD.getPublicData(t.enabledId,function(t){t&&t.data&&(s=t.data)}.bind(this),!1)}.bind(this),!1),s?this.css=s:(this.cssPath=MWF.defaultPath+"/xDesktop/$Authentication/"+this.options.style+"/css.wcss",this._loadCss()),this.lp=MWF.LP.authentication,this.app=e||{}},isAuthenticated:function(t,e){MWF.Actions.get("x_organization_assemble_authentication").getAuthentication(t,e)},loadLogin:function(t){t&&(this.loginNode=t),!t&&this.loginNode&&(t=this.loginNode),layout.config.loginPage&&layout.config.loginPage.enable&&layout.config.loginPage.portal?(MWF.xDesktop.loadPortal(layout.config.loginPage.portal,this.options.loginParameter),this.fireEvent("openLogin")):(this.popupOptions={draggable:!1,closeAction:!1,hasMask:!1,relativeToApp:!1},this.popupPara={container:t},this.postLogin=function(t){layout.desktop.session.user=t.data,layout.session.user=t.data,layout.session.token=layout.session.user.token;var e=layout.desktop.session.user;if(e.identityList||(e.identityList=[]),e.roleList){var i=[];e.roleList.each((function(t){i.push(t.substring(0,t.indexOf("@")))})),e.roleList=e.roleList.concat(i)}window.location.reload()}.bind(this),this.openLoginForm(this.popupOptions),this.fireEvent("openLogin"))},logout:function(t){MWF.Actions.get("x_organization_assemble_authentication").logout(function(){this.socket&&(this.socket.close(),this.socket=null),layout.session&&layout.session.user&&(layout.session.user.token=""),t?t():window.location.reload()}.bind(this))},openLoginForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){e&&e(t),this.postLogin&&this.postLogin(t),this.fireEvent("postOk",t)}.bind(this)});i.width=this.options.width,i.height=this.options.height,new MWF.xDesktop.Authentication.LoginForm(this,{},i,this.popupPara).create()},openSignUpForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){e&&e(t),this.fireEvent("postOk",t)}.bind(this)});delete i.width,delete i.height,this.options.popupStyle_signup&&(i.popupStyle=this.options.popupStyle_signup),new MWF.xDesktop.Authentication.SignUpForm(this,{},i,this.popupPara).create()},openResetPasswordForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){e&&e(t),this.fireEvent("postOk",t)}.bind(this)});this.options.popupStyle_password&&(i.popupStyle=this.options.popupStyle_password),new MWF.xDesktop.Authentication.ResetPasswordForm(this,{},i,this.popupPara).create()},openChangePasswordForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){e&&e(t),this.fireEvent("postOk",t)}.bind(this)});new MWF.xDesktop.Authentication.ChangePasswordForm(this,{},i,this.popupPara).create()}}),MWF.xDesktop.Authentication.LoginForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platform",width:"650",height:"480",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!1,hasScroll:!1,hasMark:!1,title:"",draggable:!0,closeAction:!0},load:function(){this.setOptions({title:layout.config&&(layout.config.systemTitle||layout.config.title)?layout.config.title||layout.config.systemTitle:MWF.LP.authentication.LoginFormTitle}),this._loadCss()},_createTopContent:function(){this.actions=MWF.Actions.get("x_organization_assemble_authentication"),this.faceLogin=!1,this.actions.getLoginMode(function(t){this.faceLogin=t.data.faceLogin}.bind(this),null,!1),this.faceLogin&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&COMMON.AjaxModule.loadDom("../o2_lib/adapter/adapter.js",function(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(this.cameraLoginIcon=new Element("div",{styles:this.explorer.css.cameraLoginIcon}).inject(this.formTopContentNode),this.cameraLoginIcon.addEvent("click",function(){this.isCameraLogin?(this.closeCamera(),this.isCameraLogin=!1):(this.cameraLogin(),this.isCameraLogin=!0)}.bind(this)))}.bind(this))},closeCamera:function(){this.cameraLoginVideoNode&&(this.video&&this.video.destroy(),this.canvas&&this.canvas.destroy(),this.cameraLoginVideoNode&&this.cameraLoginVideoNode.destroy(),this.video=null,this.canvas=null,this.cameraLoginVideoNode=null),this.cameraLoginIcon.setStyles(this.explorer.css.cameraLoginIcon)},cameraLoginInit:function(){this.cameraLoginConfig={maxStep:2,step:0,count:0,max:2,errorCount:0,errorMax:3,user:"",tokens:[]}},cameraLoginReset:function(t){this.cameraLoginConfig.count=0,this.cameraLoginConfig.user="",t&&(this.cameraLoginConfig.errorCount=0)},cameraLogin:function(){this.cameraLoginInit(),this.cameraLoginIcon.setStyles(this.explorer.css.closeCameraLoginIcon),this.createCameraLoginNode(),this.startCameraLogin()},createCameraLoginNode:function(){this.cameraLoginVideoNode=new Element("div",{styles:this.explorer.css.cameraLoginVideoNode}).inject(this.container);var t=this.formNode.getSize(),e=this.formTopNode.getSize(),i=t.y-e.y;this.cameraLoginVideoNode.setStyles({width:t.x+"px",height:i+"px"}),this.cameraLoginVideoNode.position({relativeTo:this.formContentNode,position:"upperLeft",edge:"upperLeft"})},startCameraLogin:function(){this.cameraLoginVideoAreaNode=new Element("div").inject(this.cameraLoginVideoNode),this.cameraLoginVideoInfoNode=new Element("div",{styles:this.explorer.css.cameraLoginVideoInfoNode}).inject(this.cameraLoginVideoNode),this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_logining);var t=this.cameraLoginVideoNode.getSize(),e=this.cameraLoginVideoInfoNode.getSize(),i=t.y-e.y;this.cameraLoginVideoAreaNode.setStyle("height",i+"px"),this.cameraLoginVideoAreaNode.set("html","<video autoplay></video>"),this.video=this.cameraLoginVideoAreaNode.getFirst().setStyles({"background-color":"#000000",width:t.x+"px",height:i+"px"}),this.videoStart()},videoStart:function(){this.video.addEventListener("canplay",function(){window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),500)}.bind(this)),navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then(function(t){this.video.srcObject=t}.bind(this)).catch(function(t){console.log("navigator.getUserMedia error: ",t),this.closeCamera()}.bind(this))},getFormData:function(){this.canvas||(this.canvas=new Element("canvas",{styles:{display:"none"}}).inject(this.cameraLoginVideoNode),this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight),this.canvas.getContext("2d").drawImage(this.video,0,0,this.canvas.width,this.canvas.height);var t=this.toBlob(this.canvas.toDataURL()),e=new FormData;return e.append("file",t),this.canvas.destroy(),{data:e,size:t.size}},checkUserFace:function(t){var e=window.location.host;e=e.replace(/\./g,"_"),this.faceAction.search(e,t.data,{name:"pic",size:t.size},function(t){if(t.data.results&&t.data.results.length){var e=t.data.thresholds["1e-5"];if(t.data.results[0].confidence>e){var i=t.data.faces[0].face_token,s=t.data.results[0].user_id;this.cameraLoginConfig.user&&this.cameraLoginConfig.user!==s?(this.cameraLoginReset(),this.cameraLoginConfig.errorCount++):(this.cameraLoginConfig.count++,this.cameraLoginConfig.user=s,this.cameraLoginConfig.tokens.push(i),this.cameraLoginConfig.step++,this.cameraLoginConfig.errorCount=0,this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login["camera_logining_"+this.cameraLoginConfig.step]))}else this.cameraLoginReset(),this.cameraLoginConfig.errorCount++}else this.cameraLoginReset(),this.cameraLoginConfig.errorCount++;this.checkCameraLogin()}.bind(this),function(){window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),500)}.bind(this))},checkUserAlive:function(t,e,i){this.faceAction.detectattr(e,t.data,{name:"pic",size:t.size},function(t){t.data.faces&&t.data.faces.length&&this[i](t.data.faces[0].attributes)?(this.cameraLoginConfig.step++,this.cameraLoginConfig.errorCount=0,this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login["camera_logining_"+this.cameraLoginConfig.step])):this.cameraLoginConfig.errorCount++,this.checkCameraLogin()}.bind(this),function(){this.cameraLoginConfig.errorCount++,this.checkCameraLogin()}.bind(this))},checkUserSmile:function(t){return t.smile.value>t.smile.threshold},checkUserPitch:function(t){return t.headpose.pitch_angle<-10},startCameraAuthentication:function(){if(this.video){var t=this.getFormData();this.faceAction||(this.faceAction=MWF.Actions.get("x_faceset_control")),0===this.cameraLoginConfig.step&&this.checkUserFace(t),1===this.cameraLoginConfig.step&&this.checkUserAlive(t,"smiling","checkUserSmile"),2===this.cameraLoginConfig.step&&this.checkUserAlive(t,"headpose","checkUserPitch")}},toBlob:function(t){var e;e="data:image"===t.substr(0,10)?window.atob(t.split(",")[1]):window.atob(t);for(var i=new ArrayBuffer(e.length),s=new Uint8Array(i),n=0;n<e.length;n++)s[n]=e.charCodeAt(n);return new Blob([i],{type:"image/png"})},getDIF:function(t){return Math.max.apply(this,t)-Math.min.apply(this,t)},checkCameraLogin:function(){if(this.cameraLoginConfig.errorCount>this.cameraLoginConfig.errorMax)this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_loginError);else if(this.cameraLoginConfig.step>=this.cameraLoginConfig.maxStep){var t=MWF.LP.desktop.login.camera_loginSuccess.replace("{name}",this.cameraLoginConfig.user);this.cameraLoginVideoInfoNode.set("text",t),this.cameraLoginSuccess()}else window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),100)},cameraLoginSuccess:function(){COMMON.AjaxModule.loadDom(["../o2_lib/CryptoJS/tripledes.js","../o2_lib/CryptoJS/mode-ecb.js"],function(){var t=layout.serviceAddressList.x_organization_assemble_authentication,e=layout.config.app_protocol+"//"+(t.host||window.location.hostname)+(80===t.port?"":":"+t.port)+t.context,i={client:"face",token:this.crypDES()};new Request.JSON({method:"POST",url:e+"/jaxrs/sso",data:JSON.stringify(i),secure:!1,emulation:!1,noCache:!0,withCredentials:!0,headers:{"Content-Type":"application/json; charset=utf-8"},onSuccess:function(t){this._close(),this.closeCamera(),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.lp.loginSuccess,"success"),this.fireEvent("postOk",t)}.bind(this),onError:function(){this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_loginError2)}.bind(this)}).send()}.bind(this))},crypDES:function(){var t=this.cameraLoginConfig.user,e=(new Date).getTime(),i=CryptoJS.enc.Utf8.parse("xplatform"),s=CryptoJS.DES.encrypt(t+"#"+e,i,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString(CryptoJS.enc.Base64);return s=(s=(s=s.replace(/=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")},_createTableContent:function(){this.loginType="captcha",this.codeLogin=!1,this.bindLogin=!1,this.captchaLogin=!0,this.actions.getLoginMode(function(t){this.codeLogin=t.data.codeLogin,this.bindLogin=t.data.bindLogin,this.captchaLogin=t.data.captchaLogin}.bind(this),null,!1),MWF.Actions.get("x_organization_assemble_personal").getRegisterMode(function(t){this.signUpMode=t.data.value}.bind(this),null,!1),this.bindLogin&&(this.bindLoginTipPic=new Element("div.bindLoginTipPic",{styles:this.css.bindLoginTipPic}).inject(this.formContentNode,"top"),this.bindLoginAction=new Element("div.bindLoginAction",{styles:this.css.bindLoginAction}).inject(this.formContentNode,"top"),this.bindLoginAction.addEvent("click",function(){this.showBindCodeLogin()}.bind(this)),this.backtoPasswordLoginTipPic=new Element("div.backtoPasswordLoginTipPic",{styles:this.css.backtoPasswordLoginTipPic}).inject(this.formContentNode,"top"),this.backtoPasswordLoginAction=new Element("div.backtoPasswordLoginAction",{styles:this.css.backtoPasswordLoginAction}).inject(this.formContentNode,"top"),this.backtoPasswordLoginAction.addEvent("click",function(){this.backtoPasswordLogin()}.bind(this)));var t="<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'><tr><div><div item='passwordAction'>";if(this.codeLogin&&(t+="</div><div styles='titleSep'></div><div item='codeAction'></div></tr>"),t+="</table>",t+="<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'><tr item='credentialTr'><td styles='formTableValueTop20' item='credential'></td></tr><tr item='passwordTr'><td styles='formTableValueTop20' item='password'></td></tr>",this.captchaLogin&&(t+="<tr item='captchaTr'><td styles='formTableValueTop20'><div item='captchaAnswer' style='float:left;'></div><div item='captchaPic' style='float:left;'></div><div item='changeCaptchaAction' style='float:left;'></div></td></tr>"),this.codeLogin&&(t+="<tr item='codeTr' style='display: none'><td styles='formTableValueTop20'>   <div item='codeAnswer' style='float:left;'></div>   <div item='verificationAction' style='float:left;'></div>   <div item='resendVerificationAction' style='float:left;display:none;'></div></td></tr>"),t+="<tr><td styles='formTableValueTop20' item='loginAction'></td></tr></table><table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'>",this.signUpMode&&"disable"!==this.signUpMode?t+="<tr><td><div item='signUpAction'></div><div item='forgetPassword'></div></td></tr>":t+="<tr><td><div styles='signUpAction'></div><div item='forgetPassword'></div></td></tr>",t+="<tr><td  styles='formTableValue' item='errorArea'></td></tr><tr><td  styles='formTableValue' item='oauthArea'></td></tr></table>",this.formTableArea.set("html",t),new Element("div",{styles:this.css.formFooter,text:layout.config.footer||layout.config.systemName}).inject(this.formTableArea,"after"),this.captchaLogin&&this.setCaptchaPic(),this.errorArea=this.formTableArea.getElement("[item=errorArea]"),this.oauthArea=this.formTableArea.getElement("[item=oauthArea]"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{credential:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourUserName,event:{focus:function(t){this.lp.userName===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){""===t.getValue()&&t.setValue(this.lp.userName),t.warningStatus||t.getElements()[0].setStyles(this.css.inputUser)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},password:{text:this.lp.password,type:"password",defaultValue:"password",className:"inputPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourPassword,event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},captchaAnswer:{tType:"number",text:this.lp.verificationCode,defaultValue:this.lp.verificationCode,className:"inputVerificationCode",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputPicVerificationCode,event:{focus:function(t){this.lp.verificationCode===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){""===t.getValue()&&t.setValue(this.lp.verificationCode),t.warningStatus||t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this)},changeCaptchaAction:{value:this.lp.changeVerification,type:"innerText",className:"verificationChange",event:{click:function(){this.setCaptchaPic()}.bind(this)}},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){this.lp.inputVerificationCode===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){""===t.getValue()&&t.setValue(this.lp.inputVerificationCode),t.warningStatus||t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},loginAction:{value:this.lp.loginAction,type:"button",className:"inputLogin",event:{click:function(){this.ok()}.bind(this)}},passwordAction:{value:this.lp.passwordLogin,type:"innerText",className:"titleNode_active",event:{click:function(){this.codeLogin&&this.showPasswordLogin()}.bind(this)}},codeAction:{value:this.lp.codeLogin,type:"innerText",className:"titleNode_normal",event:{click:function(){this.showCodeLogin()}.bind(this)}},signUpAction:{value:this.lp.signUp,type:"innerText",className:"signUpAction",event:{click:function(){this.gotoSignup()}.bind(this)}},forgetPassword:{value:this.lp.forgetPassword,type:"innerText",className:"forgetPassword",event:{click:function(){this.gotoResetPassword()}.bind(this)}}}},this.app,this.css),this.form.load()}.bind(this),!0),this.bindLogin){this.bindLoginContainer=new Element("div",{styles:this.css.bindLoginContainer}).inject(this.formContentNode);var e="<div item='bindLoginTitle' styles='bindTitleNode'></div><div styles='bindBodyArea'><div item='bindPicArea' styles='bindPicArea'></div><div styles='bindSepArea'></div><div styles='bindExampleArea'></div></div><div styles='bindTipArea'>   <div styles='bindTipIconArea'></div>   <div styles='bindTipTextArea'>       "+this.lp.userAppCameraHtml+"       <div>"+this.lp.loginToPage+"</div></div>";this.bindLoginContainer.set("html",e),this.isShowEnable=!0,this.bindBodyArea=this.bindLoginContainer.getElement("[styles='bindBodyArea']"),this.bindLoginContainer.addEvent("mousemove",function(t){this.bindBodyArea.isOutside(t)?this.hideExampleArea(t):this.showExampleArea(t)}.bind(this)),this.bindPicArea=this.bindLoginContainer.getElement("[item='bindPicArea']"),this.setBindPic(),this.bindExampleArea=this.bindLoginContainer.getElement("[styles='bindExampleArea']"),this.bindSepArea=this.bindLoginContainer.getElement("[styles='bindSepArea']"),this.bindLoginContainer.getElement("[styles='bindTipLinkArea']").addEvent("click",function(){layout.config.appUrl?window.open(layout.config.appUrl,"_blank"):window.open(this.lp.o2downloadLink,"_blank")}.bind(this)),MWF.xDesktop.requireApp("Template","MForm",function(){this.bindform=new MForm(this.bindLoginContainer,{},{style:"o2platform",verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{bindLoginTitle:{value:this.lp.bingLoginTitle,type:"innerText"}}},this.app,this.css),this.bindform.load()}.bind(this),!0)}this.loadOauthContent()},_beforeFormNodeSize:function(){!this.isPlusOauthSize&&this.oauthListNode&&(this.options.height=parseInt(this.options.height)+this.oauthArea.getSize().y,this.isPlusOauthSize=!0),(this.oauthListNode||!this.captchaLogin&&!this.bindLogin)&&(this.options.height=this.options.height-60),this.oauthListNode&&this.captchaLogin&&(this.options.height=this.options.height+60)},loadOauthContent:function(){this.actions.listOauthServer(function(t){this.oauthList=t.data||[],this.oauthList.length>0&&(this.oauthArea.getChildren().length||(this.oauthListNode=new Element("div",{styles:this.css.oauthListNode}).inject(this.oauthArea)),this.oauthList.each(function(t){"@O2企业微信"===t.displayName?t.qywx=!0:"@O2钉钉"===t.displayName&&(t.dingding=!0),this.loadOauthItem(t)}.bind(this)))}.bind(this),null,!1)},loadOauthItem:function(t){var e=0==t.icon.indexOf("http")?t.icon:"data:image/png;base64,"+t.icon,i=new Element("div",{styles:this.css.oauthItemNode,events:{click:function(){var t="../x_desktop/oauth.html?oauth="+encodeURIComponent(this.name);this.qywx&&(t+="&qywx="+this.qywx),this.dingding&&(t+="&dingding="+this.dingding),window.location=t}.bind(t)}}).inject(this.oauthListNode);new Element("img",{styles:this.css.oauthItemIconNode,src:e}).inject(i),new Element("div",{styles:this.css.oauthItemTextNode,text:t.name}).inject(i)},showExampleArea:function(){if(!this.isHiddingExample&&!this.isShowingExample&&this.isShowEnable){this.isShowingExample=!0;var t=this.bindBodyArea.getPosition(this.bindBodyArea.getParent()).x,e=(this.bindBodyArea.getParent().getSize().x-400)/2;this.intervalId=setInterval(function(){t>e?(this.bindBodyArea.setStyle("margin-left",t-5+"px"),t-=5):(clearInterval(this.intervalId),this.bindBodyArea.setStyle("width","400px"),this.bindSepArea.setStyle("display",""),this.bindExampleArea.setStyle("display",""),this.isHidEnable=!0,this.isShowEnable=!1,this.isShowingExample=!1)}.bind(this),10)}},hideExampleArea:function(){if(!this.isShowingExample&&!this.isHiddingExample&&this.isHidEnable){this.isHiddingExample=!0;var t=this.bindBodyArea.getPosition(this.bindBodyArea.getParent()).x;this.bindSepArea.setStyle("display","none"),this.bindExampleArea.setStyle("display","none");var e=(this.bindBodyArea.getParent().getSize().x-200)/2;this.intervalId2=setInterval(function(){t<e?(this.bindBodyArea.setStyle("margin-left",t+5+"px"),t+=5):(clearInterval(this.intervalId2),this.bindBodyArea.setStyle("width","204px"),this.isHidEnable=!1,this.isShowEnable=!0,this.isHiddingExample=!1)}.bind(this),10)}},showPasswordLogin:function(){this.errorArea.empty(),this.loginType="captcha",this.form.getItem("passwordAction").setStyles(this.css.titleNode_active),this.form.getItem("codeAction").setStyles(this.css.titleNode_normal),this.formTableArea.getElement("[item='passwordTr']").setStyle("display","");var t=this.formTableArea.getElement("[item='captchaTr']");t&&t.setStyle("display",""),this.formTableArea.getElement("[item='codeTr']").setStyle("display","none")},showCodeLogin:function(){this.errorArea.empty(),this.loginType="code",this.form.getItem("passwordAction").setStyles(this.css.titleNode_normal),this.form.getItem("codeAction").setStyles(this.css.titleNode_active),this.formTableArea.getElement("[item='passwordTr']").setStyle("display","none");var t=this.formTableArea.getElement("[item='captchaTr']");t&&t.setStyle("display","none"),this.formTableArea.getElement("[item='codeTr']").setStyle("display","")},showBindCodeLogin:function(){this.errorArea.empty(),this.formTableContainer.setStyle("display","none"),this.bindLoginContainer.setStyle("display",""),this.bindLoginTipPic.setStyle("display","none"),this.bindLoginAction.setStyle("display","none"),this.backtoPasswordLoginTipPic.setStyle("display",""),this.backtoPasswordLoginAction.setStyle("display",""),this.checkBindStatus()},backtoPasswordLogin:function(){this.errorArea.empty(),this.bindStatusInterval&&clearInterval(this.bindStatusInterval),this.formTableContainer.setStyle("display",""),this.bindLoginContainer.setStyle("display","none"),this.bindLoginTipPic.setStyle("display",""),this.bindLoginAction.setStyle("display",""),this.backtoPasswordLoginTipPic.setStyle("display","none"),this.backtoPasswordLoginAction.setStyle("display","none")},setBindPic:function(){this.bindPicArea.empty(),this.actions.getLoginBind(function(t){this.bindMeta=t.data.meta,new Element("img",{src:"data:image/png;base64,"+t.data.image}).inject(this.bindPicArea)}.bind(this))},setCaptchaPic:function(){if(this.captchaLogin){var t=this.formTableArea.getElement("[item='captchaPic']");t.empty(),this.actions.getLoginCaptcha(120,50,function(e){this.captcha=e.data.id,new Element("img",{src:"data:image/png;base64,"+e.data.image,styles:this.css.verificationImage}).inject(t)}.bind(this))}},sendVerificationAction:function(){var t=!0,e=this.form.getItem("credential"),i=e.getValue();i&&""!==i.trim()?(this.actions.checkCredential(i,function(i){i.data.value||(t=!1,e.setWarning(this.lp.userNotExist,"invalid"))}.bind(this),function(i){t=!1;var s=JSON.parse(i.responseText);e.setWarning(s.message,"invalid")}.bind(this),!1),t&&(e.clearWarning("invalid"),this.actions.createCredentialCode(i,(function(t){}),function(e){var i=JSON.parse(e.responseText);this.setWarning(i.message),t=!1}.bind(this)),t&&(this.errorArea.empty(),this.form.getItem("verificationAction").container.setStyle("display","none"),this.setResendVerification()))):e.setWarning(this.lp.inputYourUserName,"empty")},setResendVerification:function(){var t=this.form.getItem("resendVerificationAction");t.container.setStyle("display",""),this.resendElement=t.getElements()[0],this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){e>0?this.resendElement.set("text",this.lp.resendVerification+"("+--e+")"):(this.form.getItem("verificationAction").container.setStyle("display",""),t.container.setStyle("display","none"),clearInterval(this.timer))}.bind(this),1e3)},gotoSignup:function(){this.explorer.openSignUpForm(),this.close()},gotoResetPassword:function(){this.explorer.openResetPasswordForm(),this.close()},gotoChangePassword:function(t){this.explorer.openChangePasswordForm(t,function(){this.explorer.loadLogin()}.bind(this)),this.close()},checkBindStatus:function(){this.bindStatusInterval=setInterval(function(){this.actions.checkBindStatus(this.bindMeta,function(t){t.data&&t.data.name&&"anonymous"!==t.data.name&&(this.fireEvent("queryOk"),this._close(),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.lp.loginSuccess,"success"),this.fireEvent("postOk",t))}.bind(this),function(t){}.bind(this))}.bind(this),3e3)},_close:function(){this.bindStatusInterval&&clearInterval(this.bindStatusInterval),this.timer&&clearInterval(this.timer)},ok:function(){this.fireEvent("queryOk"),this.errorArea.empty();var t=null,e=null;"captcha"===this.loginType?(this.form.getItem("password").options.notEmpty=!0,this.captchaLogin&&(t=this.form.getItem("captchaAnswer"))&&(t.options.notEmpty=!0),(e=this.form.getItem("codeAnswer"))&&(e.options.notEmpty=!1)):"code"===this.loginType&&(this.form.getItem("password").options.notEmpty=!1,this.captchaLogin&&(t=this.form.getItem("captchaAnswer"))&&(t.options.notEmpty=!1),(e=this.form.getItem("codeAnswer"))&&(e.options.notEmpty=!0));var i=this.form.getResult(!0,",",!0,!1,!0);i&&this._ok(i,function(t){if("error"===t.type)this.app&&this.app.notice(t.message,"error");else if(t.data.passwordExpired){var e=t.data.distinguishedName;this.explorer.logout(function(){this.gotoChangePassword({userName:e})}.bind(this))}else this._close(),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.lp.loginSuccess,"success"),this.fireEvent("postOk",t)}.bind(this))},setWarning:function(t){this.errorArea.empty(),new Element("div",{text:t,styles:this.css.warningMessageNode}).inject(this.errorArea)},_ok:function(t,e){var i=null;"captcha"===this.loginType?(i={credential:t.credential,password:t.password},this.captchaLogin&&(i.captchaAnswer=t.captchaAnswer,i.captcha=this.captcha),this.actions.loginByCaptcha(i,function(t){e&&e(t)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.setWarning(e.message),this.setCaptchaPic(),this.form.getItem("captchaAnswer")&&this.form.getItem("captchaAnswer").setValue("")}.bind(this))):"code"===this.loginType&&(i={credential:t.credential,codeAnswer:t.codeAnswer},this.actions.loginByCode(i,function(t){e&&e(t)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.setWarning(e.message)}.bind(this)))}}),MWF.xDesktop.Authentication.SignUpForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platformSignup",width:"910",height:"740",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!1,title:"",draggable:!0,closeAction:!0},load:function(){this.options.title||this.setOptions({title:MWF.LP.authentication.SignUpFormTitle}),this._loadCss()},_createTableContent:function(){var t=this;this.actions=MWF.Actions.get("x_organization_assemble_personal");var e="code";this.actions.getRegisterMode(function(t){e=t.data.value}.bind(this),null,!1),this.formTopNode.setStyle("height","50px"),this.formTableContainer.setStyles({width:"890px","margin-top":"40px"});var i="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='name' width='200'></td>   <td styles='formTableValue' item='name' width='350'></td>   <td styles='formTableValue' item='nameTip'></td></tr><tr><td styles='formTableTitle' lable='password'></td>   <td styles='formTableValue' item='password'></td>   <td styles='formTableValue'><div item='passwordStrengthArea'></div></div><div item='passwordTip'></div></td></tr><tr><td styles='formTableTitle' lable='confirmPassword'></td>   <td styles='formTableValue' item='confirmPassword'></td>   <td styles='formTableValue' item='confirmPasswordTip'></td></tr><tr><td styles='formTableTitle' lable='genderType'></td>   <td styles='formTableValue' item='genderType'></td>   <td styles='formTableValue' item='genderTypeTip'></td></tr><tr><td styles='formTableTitle' lable='mail'></td>   <td styles='formTableValue' item='mail'></td>   <td styles='formTableValue' item='mailTip'></td></tr><tr><td styles='formTableTitle' lable='mobile'></td>   <td styles='formTableValue' item='mobile'></td>   <td styles='formTableValue' item='mobileTip'></td></tr>";i+="code"===e?"<tr><td styles='formTableTitle' lable='codeAnswer'></td>   <td styles='formTableValue'><div item='codeAnswer' style='float:left;'></div><div item='verificationAction' style='float:left;'></div><div item='resendVerificationAction' style='float:left;display:none;'></div></td>   <td styles='formTableValue' item='verificationCodeTip'></td></tr>":"<tr><td styles='formTableTitle' lable='captchaAnswer'></td>   <td styles='formTableValue'><div item='captchaAnswer' style='float:left;'></div><div item='captchaPic' style='float:left;'></div><div item='changeCaptchaAction' style='float:left;'></div></td>   <td styles='formTableValue' item='captchaAnswerTip'></td></tr>",i+="<tr><td styles='formTableTitle'></td>   <td styles='formTableValue' item='signUpAction'></td>   <td styles='formTableValue' item='signUpTip'></td></tr><tr><td></td>   <td><div item='hasAccountArea'></div><div item='gotoLoginAction'></div></td>   <td></td></tr></table>",this.formTableArea.set("html",i),"captcha"===e&&this.setCaptchaPic(),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:this.options.popupStyle,verifyType:"batchSingle",isEdited:this.isEdited||this.isNew,onPostLoad:function(){var t=this.form,e=this.formTableArea;t.getItem("name").tipNode=e.getElement("[item='nameTip']"),t.getItem("password").tipNode=e.getElement("[item='passwordTip']"),t.getItem("confirmPassword").tipNode=e.getElement("[item='confirmPasswordTip']"),t.getItem("mail").tipNode=e.getElement("[item='mailTip']"),t.getItem("genderType").tipNode=e.getElement("[item='genderTypeTip']"),t.getItem("mobile").tipNode=e.getElement("[item='mobileTip']"),this.tipNode=e.getElement("[item='signUpTip']"),t.getItem("captchaAnswer")&&(t.getItem("captchaAnswer").tipNode=e.getElement("[item='captchaAnswerTip']")),t.getItem("codeAnswer")&&(t.getItem("codeAnswer").tipNode=e.getElement("[item='verificationCodeTip']"))}.bind(this),itemTemplate:{name:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourUserName,validRule:{isInvalid:function(t,e){return this.checkUserName(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.userExist},event:{focus:function(t){this.lp.userName===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this),blur:function(t){t.verify(!0)&&(t.warningStatus||t.getElements()[0].setStyles(this.css.inputUser))}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},password:{text:this.lp.password,type:"password",className:"inputPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourPassword,validRule:{passwordIsWeak:function(t,e){return!this.getPasswordRule(e.getValue())}.bind(this)},validMessage:{passwordIsWeak:function(){return t.getPasswordRule(this.getValue())}},event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},confirmPassword:{text:this.lp.confirmPassword,type:"password",className:"inputComfirmPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputComfirmPassword,validRule:{passwordNotEqual:function(t,e){if(e.getValue()===this.form.getItem("password").getValue())return!0}.bind(this)},validMessage:{passwordNotEqual:this.lp.passwordNotEqual},event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this),blur:function(t){t.verify(!0)&&(t.warningStatus||t.getElements()[0].setStyles(this.css.inputComfirmPassword))}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this)},mail:{text:this.lp.mail,defaultValue:this.lp.inputYourMail,className:"inputMail",notEmpty:!1,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourMail,validRule:{isFormatInvalid:function(t,e){return!t||t===this.lp.inputYourMail||/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(t)?(e.tipNode.empty(),e.warningStatus=!1,!0):(e.warningStatus=!0,!1)}.bind(this)},validMessage:{isFormatInvalid:this.lp.mailFormatError},event:{focus:function(t){this.lp.inputYourMail===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0),t.warningStatus||t.getElements()[0].setStyles(this.css.inputMail)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){}.bind(this),onUnempty:function(t){}.bind(this)},genderType:{text:this.lp.genderType,className:"inputGenderType",type:"select",selectValue:this.lp.genderTypeValue.split(","),selectText:this.lp.genderTypeText.split(","),notEmpty:!0,emptyTip:this.lp.selectGenderType,event:{focus:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0),t.warningStatus||t.getElements()[0].setStyles(this.css.inputGenderType)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputGenderType)}.bind(this)},mobile:{text:this.lp.mobile,defaultValue:this.lp.inputYourMobile,className:"inputMobile",tType:"number",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourMobile,validRule:{isInvalid:function(t,e){return this.checkMobile(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.mobileIsRegisted},event:{focus:function(t){this.lp.inputYourMobile===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this),blur:function(t){t.verify(!0)&&(t.warningStatus||t.getElements()[0].setStyles(this.css.inputMobile))}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputMobile)}.bind(this)},captchaAnswer:{tType:"number",text:this.lp.verificationCode,defaultValue:this.lp.verificationCode,className:"inputVerificationCode",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputPicVerificationCode,event:{focus:function(t){this.lp.verificationCode===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0),t.warningStatus||t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this)},changeCaptchaAction:{value:this.lp.changeVerification,type:"innerText",className:"verificationChange",event:{click:function(){this.setCaptchaPic()}.bind(this)}},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){this.lp.inputVerificationCode===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0),t.warningStatus||t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},signUpAction:{value:this.lp.signUp,type:"button",className:"inputSignUp",event:{click:function(){this.ok()}.bind(this)}},hasAccountArea:{value:this.lp.hasAccount,type:"innerText",className:"hasCountArea"},gotoLoginAction:{value:this.lp.gotoLogin,type:"innerText",className:"gotoLoginAction",event:{click:function(){this.gotoLogin()}.bind(this)}}}},this.app,this.css),this.form.load()}.bind(this),!0)},checkMobile:function(t,e){var i=!0;return this.actions.checkRegisterMobile(t,function(){i=!0}.bind(this),function(t){if(404===t.status)e.options.validMessage.isInvalid=this.lp.pageNotFound,i=!1;else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message,i=!1}}.bind(this),!1),i},checkUserName:function(t,e){var i=!0;return this.actions.checkRegisterName(t,function(){i=!0}.bind(this),function(t){if(404===t.status)e.options.validMessage.isInvalid=this.lp.pageNotFound,i=!1;else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message,i=!1}}.bind(this),!1),i},setCaptchaPic:function(){var t=this.formTableArea.getElement("[item='captchaPic']");t.empty(),this.actions.getRegisterCaptcha(120,50,function(e){this.captcha=e.data.id,new Element("img",{src:"data:image/png;base64,"+e.data.image,styles:this.css.verificationImage}).inject(t)}.bind(this))},sendVerificationAction:function(){var t=!0,e=this.form.getItem("mobile");if(e.verify(!0)){if(e.clearWarning(),e.getElements()[0].setStyles(this.css.inputMobile),this.actions.createRegisterCode(e.getValue(),(function(t){}),function(e){var i=this.form.getItem("codeAnswer"),s=JSON.parse(e.responseText);404===e.status?(i.setWarning(s.message,this.lp.pageNotFound),t=!1):(i.setWarning(s.message,"invalid"),t=!1)}.bind(this),!1),!t)return!1;this.form.getItem("verificationAction").container.setStyle("display","none"),this.setResendVerification()}},setResendVerification:function(){var t=this.form.getItem("resendVerificationAction");t.container.setStyle("display",""),this.resendElement=t.getElements()[0],this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){e>0?this.resendElement.set("text",this.lp.resendVerification+"("+--e+")"):(this.form.getItem("verificationAction").container.setStyle("display",""),t.container.setStyle("display","none"),clearInterval(this.timer))}.bind(this),1e3)},getPasswordRule:function(t){var e="";return this.actions.checkRegisterPassword(t,function(t){e=t.data.value||""}.bind(this),null,!1),e},gotoLogin:function(){this.explorer.openLoginForm({},(function(){window.location.reload()})),this.close()},setWarning:function(t){this.tipNode.empty(),new Element("div",{text:t,styles:this.css.warningMessageNode}).inject(this.tipNode)},setNotice:function(t){this.tipNode.empty(),new Element("div",{text:t,styles:this.css.noticeMessageNode}).inject(this.tipNode)},ok:function(){this.tipNode.empty(),this.fireEvent("queryOk");var t=this.form.getResult(!0,",",!0,!1,!0);t&&this._ok(t,function(t){"error"===t.type?this.app&&this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.setNotice(this.lp.registeSuccess),this.app&&this.app.notice(this.lp.registeSuccess,"success"),this.fireEvent("postOk",t),this.gotoLogin())}.bind(this))},_ok:function(t,e){t.captcha=this.captcha,this.actions.register(t,function(t){e&&e(t)}.bind(this),function(t){if(404===t.status)this.setWarning(this.lp.pageNotFound);else{var e=JSON.parse(t.responseText);this.setWarning(e.message)}}.bind(this))}}),MWF.xDesktop.Authentication.ResetPasswordForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platformSignup",width:"710",height:"450",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!1,title:"",draggable:!0,closeAction:!0},load:function(){this.options.title||this.setOptions({title:MWF.LP.authentication.ResetPasswordFormTitle}),this._loadCss()},_createTopContent:function(){this.actions=MWF.Actions.get("x_organization_assemble_personal"),this.actions.getRegisterMode(function(t){this.signUpMode=t.data.value}.bind(this),null,!1),this.signUpMode&&"disable"!==this.signUpMode&&(this.gotoSignupNode=new Element("div",{styles:this.css.formTopContentCustomNode,text:this.lp.signUp}).inject(this.formTopContentNode),this.gotoSignupNode.addEvent("click",function(){this.gotoSignup()}.bind(this)),new Element("div",{styles:this.css.formTopContentSepNode}).inject(this.formTopContentNode)),this.gotoLoginNode=new Element("div",{styles:this.css.formTopContentCustomNode,text:this.lp.loginAction}).inject(this.formTopContentNode),this.gotoLoginNode.addEvent("click",function(){this.gotoLogin()}.bind(this))},_createTableContent:function(){this.formTableContainer.setStyles(this.css.formTableContainer2),this.loadSteps(),this.loadStepForm_1(),this.loadStepForm_2(),this.loadStepForm_3()},reset:function(){this.formTableArea.empty(),this._createTableContent()},loadSteps:function(){var t=new Element("div",{styles:this.css.stepsContainer}).inject(this.formTableArea);this.step_1=new Element("div",{styles:this.css.step_1_active,text:this.lp.shotMessageCheck}).inject(t),this.stepLink_1=new Element("div",{styles:this.css.stepLink_1}).inject(this.step_1),this.step_2=new Element("div",{styles:this.css.step_2,text:this.lp.setMewPassword}).inject(t),this.stepLink_2=new Element("div",{styles:this.css.stepLink_2}).inject(this.step_2),this.step_3=new Element("div",{styles:this.css.step_3,text:this.lp.completed}).inject(t)},loadStepForm_1:function(){this.stepNode_1=new Element("div",{html:"<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='name' width='80'></td>   <td styles='formTableValue' item='name' width='350'></td></tr><tr><td styles='formTableTitle' lable='codeAnswer'></td>   <td styles='formTableValue'>       <div item='codeAnswer' style='float:left;'></div>       <div item='verificationAction' style='float:left;'></div>       <div item='resendVerificationAction' style='float:left;display:none;'></div></td>   </tr><tr><td styles='formTableTitle'></td>   <td styles='formTableValue' item='nextStep'></td></tr></table>",styles:{display:""}}).inject(this.formTableArea),MWF.xDesktop.requireApp("Template","MForm",function(){this.stepForm_1=new MForm(this.stepNode_1,{},{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{name:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourUserName,validRule:{isInvalid:function(t,e){return this.checkUserName(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.userNotExist},event:{focus:function(t){this.lp.userName===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){""===t.getValue()&&t.setValue(this.lp.userName),t.warningStatus||t.getElements()[0].setStyles(this.css.inputUser)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.gotoStep(2)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){this.lp.inputVerificationCode===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){""===t.getValue()&&t.setValue(this.lp.inputVerificationCode),t.warningStatus||t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.gotoStep(2)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},nextStep:{value:this.lp.nextStep,type:"button",className:"inputSignUp",event:{click:function(){this.gotoStep(2)}.bind(this)}}}},this.app,this.css),this.stepForm_1.load()}.bind(this),!0)},loadStepForm_2:function(){var t=this;html="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='password' width='80'></td>   <td styles='formTableValue' item='password' width='350'></td>   <td styles='formTableValue'><div item='passwordStrengthArea'></div></td></tr><tr><td styles='formTableTitle' lable='confirmPassword'></td>   <td styles='formTableValue' item='confirmPassword'></td>   <td styles='formTableValue'></td></tr><tr><td styles='formTableTitle'></td>   <td styles='formTableValue' item='nextStep'></td>   <td styles='formTableValue'></td></tr></table>",this.stepNode_2=new Element("div",{html:html,styles:{display:"none"}}).inject(this.formTableArea),MWF.xDesktop.requireApp("Template","MForm",function(){this.stepForm_2=new MForm(this.stepNode_2,{},{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{password:{text:this.lp.setNewPassword,type:"password",className:"inputPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourPassword,attr:{placeholder:this.lp.inputYourPassword},validRule:{passwordIsWeak:function(t,e){return!this.getPasswordRule(e.getValue())}.bind(this)},validMessage:{passwordIsWeak:function(){return t.getPasswordRule(this.getValue())}},event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(!0)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},confirmPassword:{text:this.lp.confirmNewPassword,type:"password",className:"inputComfirmPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputComfirmPassword,attr:{placeholder:this.lp.inputComfirmPassword},validRule:{passwordNotEqual:function(t,e){if(e.getValue()===this.stepForm_2.getItem("password").getValue())return!0}.bind(this)},validMessage:{passwordNotEqual:this.lp.passwordNotEqual},event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.gotoStep(3)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this)},nextStep:{value:this.lp.nextStep,type:"button",className:"inputSignUp",event:{click:function(){this.gotoStep(3)}.bind(this)}}}},this.app,this.css),this.stepForm_2.load()}.bind(this),!0)},loadStepForm_3:function(){this.stepNode_3=new Element("div",{styles:this.css.stepFormResult}).inject(this.formTableArea)},createSetForm_3:function(t,e){var i=null;t?(this.stepNode_3.setStyles(this.css.stepFormResult),this.stepNode_3.setStyle("display",""),new Element("div",{styles:this.css.resetPasswordSuccess,text:this.lp.resetPasswordSuccess}).inject(this.stepNode_3),i=new Element("div",{styles:this.css.resetPasswordResultArea}).inject(this.stepNode_3),new Element("div",{styles:this.css.resetPasswordResultWord,text:this.lp.resetPasswordSuccessWord}).inject(i),new Element("div",{styles:this.css.resetPasswordResultAction,text:this.lp.gotoLogin}).inject(i).addEvent("click",function(){this.gotoLogin()}.bind(this))):(this.stepNode_3.setStyles(this.css.stepFormResult_fail),this.stepNode_3.setStyle("display",""),new Element("div",{styles:this.css.resetPasswordFail,text:e+this.lp.resetPasswordFail}).inject(this.stepNode_3),i=new Element("div",{styles:this.css.resetPasswordResultArea}).inject(this.stepNode_3),new Element("div",{styles:this.css.resetPasswordResultWord,text:this.lp.resetPasswordFailWord}).inject(i),new Element("div",{styles:this.css.resetPasswordResultAction,text:this.lp.backtoModify}).inject(i).addEvent("click",function(){this.reset()}.bind(this)))},gotoStep:function(t){var e=this["stepForm_"+(t-1)];if(e.clearWarning(),e.getResult(!0,",",!0,!1,!0)){var i;for(i=1;i<=t;i++)this["step_"+i].setStyles(this.css["step_"+i+"_active"]),i!==t&&this["stepLink_"+i]&&this["stepLink_"+i].setStyles(this.css["stepLink_"+i+"_active"]);for(i=t+1;i<=3;i++)this["step_"+i].setStyles(this.css["step_"+i]),3!==i&&this["stepLink_"+i].setStyles(this.css["stepLink_"+i]);for(i=1;i<=3;i++)i===t?this["stepNode_"+i].setStyle("display",""):this["stepNode_"+i].setStyle("display","none");if(3===t){var s={credential:this.stepForm_1.getItem("name").getValue(),codeAnswer:this.stepForm_1.getItem("codeAnswer").getValue(),password:this.stepForm_2.getItem("password").getValue()};this.actions.resetPassword(s,function(){this.createSetForm_3(!0)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.createSetForm_3(!1,e.message)}.bind(this),!1)}}},checkMobile:function(t){var e=!0;return this.actions.checkRegisterMobile(t,function(){e=!0}.bind(this),function(){e=!1}.bind(this),!1),e},checkUserName:function(t,e){var i=!1;return this.actions.checkCredentialOnResetPassword(t,function(t){t.data&&(i=t.data.value)}.bind(this),function(t){if(404===t.status)e.options.validMessage.isInvalid=this.lp.pageNotFound,i=!1;else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message,i=!1}}.bind(this),!1),i},sendVerificationAction:function(){var t=!0,e=this.stepForm_1.getItem("name");if(this.stepForm_1.clearWarning(),e.verify(!0)){if(this.actions.createCodeOnResetPassword(e.getValue(),(function(t){}),function(i){var s=JSON.parse(i.responseText);e.setWarning(s.message,"invalid"),t=!1}.bind(this),!1),!t)return!1;this.stepForm_1.getItem("verificationAction").container.setStyle("display","none"),this.setResendVerification()}},setResendVerification:function(){var t=this.stepForm_1.getItem("resendVerificationAction");t.container.setStyle("display",""),this.resendElement=t.getElements()[0],this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){e>0?this.resendElement.set("text",this.lp.resendVerification+"("+--e+")"):(this.stepForm_1.getItem("verificationAction").container.setStyle("display",""),t.container.setStyle("display","none"),clearInterval(this.timer))}.bind(this),1e3)},getPasswordRule:function(t){var e="";return this.actions.checkRegisterPassword(t,function(t){e=t.data.value||""}.bind(this),null,!1),e},gotoLogin:function(){this.explorer.openLoginForm({},(function(){window.location.reload()})),this.close()},gotoSignup:function(){this.explorer.openSignUpForm(),this.close()}}),MWF.xDesktop.Authentication.ChangePasswordForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platform",width:"650",height:"480",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!1,hasScroll:!1,hasMark:!1,title:"",draggable:!0,closeAction:!0,userName:""},load:function(){this.options.title||this.setOptions({title:MWF.LP.authentication.ChangePasswordFormTitle}),this._loadCss()},_createTableContent:function(){var t=this;this.actions=MWF.Actions.get("x_organization_assemble_personal");this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'><tr><td styles='formTableValueTop20' item='password'></td></tr><tr><td styles='formTableValueTop20' item='newPassword'></td><tr><td styles='formTableValue'><div item='passwordTip'></div></td></tr><tr><td styles='formTableValueTop20' item='confirmPassword'></td><tr><td styles='formTableValueTop20' item='submitAction'></td></tr><tr><td><div item='forgetPassword'></div><div item='gotoLoginAction'></div></td></tr><tr><td  styles='formTableValue' item='errorArea'></td></tr></table>"),this.errorArea=this.formTableArea.getElement("[item=errorArea]"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,onPostLoad:function(){var t=this.form;t.getItem("password").tipNode=this.errorArea,t.getItem("newPassword").tipNode=this.errorArea,t.getItem("confirmPassword").tipNode=this.errorArea}.bind(this),itemTemplate:{password:{text:this.lp.oldPassword,type:"password",className:"inputPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourOldPassword,attr:{placeholder:this.lp.oldPassword},event:{focus:function(t){"password"===t.getValue()&&t.setValue(""),t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},newPassword:{text:this.lp.newPassword,type:"password",className:"inputPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputYourNewPassword,attr:{placeholder:this.lp.newPassword},validRule:{passwordIsWeak:function(t,e){return!this.getPasswordRule(e.getValue())}.bind(this)},validMessage:{passwordIsWeak:function(){return t.getPasswordRule(this.getValue())}},event:{focus:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},confirmPassword:{text:this.lp.confirmNewPassword,type:"password",className:"inputComfirmPassword",notEmpty:!0,defaultValueAsEmpty:!0,emptyTip:this.lp.inputComfirmPassword,attr:{placeholder:this.lp.confirmPassword},validRule:{passwordNotEqual:function(t,e){if(e.getValue()===this.form.getItem("newPassword").getValue())return!0}.bind(this)},validMessage:{passwordNotEqual:this.lp.passwordNotEqual},event:{focus:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.warningStatus||t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this),keyup:function(t,e){13===e.event.keyCode&&this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this)},forgetPassword:{value:this.lp.forgetPassword,type:"innerText",className:"forgetPassword",event:{click:function(){this.gotoResetPassword()}.bind(this)}},gotoLoginAction:{value:this.lp.loginAction,type:"innerText",className:"signUpAction",event:{click:function(){this.gotoLogin()}.bind(this)}},passwordTip:{type:"innerText",className:"forgetPassword",defaultValue:layout.config.passwordRegexHint||""},submitAction:{value:this.lp.submitAction,type:"button",className:"inputLogin",event:{click:function(){this.ok()}.bind(this)}}}},this.app,this.css),this.form.load()}.bind(this),!0)},gotoLogin:function(){this.explorer.openLoginForm({},(function(){window.location.reload()})),this.close()},getPasswordRule:function(t){var e="";return this.actions.checkRegisterPassword(t,function(t){e=t.data.value||""}.bind(this),null,!1),e},gotoResetPassword:function(){this.explorer.openResetPasswordForm(),this.close()},ok:function(){this.fireEvent("queryOk"),this.errorArea.empty();var t=this.form.getResult(!0,",",!0,!1,!0);t&&this._ok(t,function(t){"error"===t.type?this.app&&this.app.notice(t.message,"error"):(this._close(),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice(this.lp.changePasswordSuccess,"success"),this.fireEvent("postOk",t))}.bind(this))},setWarning:function(t){this.errorArea.empty(),new Element("div",{text:t,styles:this.css.warningMessageNode}).inject(this.errorArea)},_ok:function(t,e){var i={userName:this.options.userName,oldPassword:t.password,newPassword:t.newPassword,confirmPassword:t.confirmPassword,isEncrypted:"n"};o2.Actions.load("x_organization_assemble_personal").ResetAction.setPasswordAnonymous(i,function(t){e&&e(t)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.setWarning(e.message)}.bind(this))}});