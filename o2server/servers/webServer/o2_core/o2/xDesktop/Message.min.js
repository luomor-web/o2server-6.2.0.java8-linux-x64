MWF.xDesktop.Message=new Class({Implements:[Options,Events],options:{style:"default"},initialize:function(e,t){this.setOptions(t),this.desktop=e,this.container=this.desktop.desktopNode,this.actionNode=this.desktop.top.messageActionNode,this.css=this.desktop.css,this.items=[],this.isShow=!1,this.isMorph=!1,this.unread=0},load:function(){this.maskNode=new Element("iframe",{styles:this.css.messageContainerMaskNode}),this.maskNode.setStyles({border:"0px",margin:"0px",padding:"0px"}),this.maskNode.inject(this.container),this.node=new Element("div",{styles:this.css.messageContainerNode}),this.node.inject(this.container),this.scrollNode=new Element("div",{styles:this.css.messageContainersScrollNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.messageContainerContentNode}).inject(this.scrollNode),this.operationNode=new Element("div",{styles:this.css.messageContainersOperationNode}).inject(this.node),this.clearAction=new Element("div",{styles:this.css.messageContainersClearActionNode,text:MWF.LP.desktop.clearMessage}).inject(this.operationNode),this.clearAction.addEvents({mouseover:function(){this.clearAction.setStyles(this.css.messageContainersClearActionNode_over)}.bind(this),mouseout:function(){this.clearAction.setStyles(this.css.messageContainersClearActionNode)}.bind(this),mousedown:function(){this.clearAction.setStyles(this.css.messageContainersClearActionNode_down)}.bind(this),mouseup:function(){this.clearAction.setStyles(this.css.messageContainersClearActionNode_over)}.bind(this),click:function(){this.clearMessage()}.bind(this)}),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.scrollNode,{style:"xDesktop_Message",where:"before",indent:!1,distance:100,friction:6,axis:{x:!1,y:!0}})}.bind(this)),this.node.addEvent("click",(function(e){e.stopPropagation(),e.preventDefault()})),this.setPosition(),this.hideMessage=function(){this.hide()}.bind(this)},clearMessage:function(){var e=[];for(this.items.each(function(t){"progress"!=t.status&&e.push(t)}.bind(this));e.length;)e[0].close(),e.erase(e[0])},setPosition:function(){var e=this.container.getSize();this.container.getPosition();this.maskNode.setStyle("height",e.y+"px"),this.node.setStyle("height",e.y+"px");var t=e.y-40;this.scrollNode.setStyle("height",t+"px"),this.maskNode.position({relativeTo:this.container,position:"rightTop",edge:this.isShow?"rightTop":"leftTop"}),this.node.position({relativeTo:this.container,position:"rightTop",edge:this.isShow?"rightTop":"leftTop"})},show:function(){var e=MWF.xDesktop.zIndexPool.zIndex;if(this.css.messageContainerMaskNode["z-index"]=e,this.css.messageContainerNode["z-index"]=e,!this.isMorph){this.isMorph=!0,this.setPosition(),this.morph||(this.maskMorph=new Fx.Morph(this.maskNode,{duration:"200",transition:Fx.Transitions.Sine.easeOut}),this.morph=new Fx.Morph(this.node,{duration:"200",transition:Fx.Transitions.Sine.easeOut})),this.maskNode.setStyle("display","block"),this.node.setStyle("display","block");var t=this.node.getPosition(),s=this.node.getSize(),i=t.x-s.x;this.maskMorph.start({left:i+"px","z-index":e}),this.morph.start({left:i+"px","z-index":e}).chain(function(){this.isShow=!0,this.isMorph=!1,this.desktop.node.addEvent("click",this.hideMessage)}.bind(this))}},hide:function(){if(!this.isMorph){this.isMorph=!0,this.morph||(this.maskMorph=new Fx.Morph(this.maskNode,{duration:"200",transition:Fx.Transitions.Sine.easeOut}),this.morph=new Fx.Morph(this.node,{duration:"200",transition:Fx.Transitions.Sine.easeOut}));var e=this.node.getPosition(),t=this.node.getSize(),s=e.x+t.x;this.maskMorph.start({left:s+"px"}).chain(function(){this.maskNode.setStyle("display","none")}.bind(this)),this.morph.start({left:s+"px"}).chain(function(){this.node.setStyle("display","none"),this.isShow=!1,this.isMorph=!1,this.desktop.node.removeEvent("click",this.hideMessage)}.bind(this))}},resize:function(){this.setPosition()},addMessage:function(e,t){var s=t?(new Date).parse(t):new Date,i=new MWF.xDesktop.Message.Item(this,e,s);return this.items.push(i),this.addUnread(),i},addTooltip:function(e,t){var s=t?(new Date).parse(t):new Date;return new MWF.xDesktop.Message.Tooltip(this,e,s)},getUnread:function(){return this.unread||0},setUnread:function(){this.unread>0?(this.unreadNode||(this.unreadNode=new Element("div",{styles:this.css.messageUnreadCountNode}).inject(this.actionNode)),this.unreadNode.set("text",this.unread)):this.unreadNode&&(this.unreadNode.destroy(),this.unreadNode=null,delete this.unreadNode)},addUnread:function(e){var t=e||1;this.unread=this.unread+t,this.setUnread()}}),MWF.xDesktop.Message.Item=new Class({Implements:[Events],initialize:function(e,t,s){this.message=e,this.container=this.message.contentNode,this.css=this.message.css,this.msg=t,this.showTime=s,this.load()},load:function(){this.node=new Element("div",{styles:this.css.messageItemNode}),this.topNode=new Element("div",{styles:this.css.messageItemTopNode}).inject(this.node),this.closeNode=new Element("div",{styles:this.css.messageItemCloseNode}).inject(this.topNode),this.subjectNode=new Element("div",{styles:this.css.messageItemSubjectNode}).inject(this.topNode),this.contentNode=new Element("div",{styles:this.css.messageItemContentNode}).inject(this.node),this.bottomNode=new Element("div",{styles:this.css.messageItemBottomNode}).inject(this.node),this.dateNode=new Element("div",{styles:this.css.messageItemDateNode}).inject(this.bottomNode),this.actionsNode=new Element("div",{styles:this.css.messageItemActionsNode}).inject(this.bottomNode),this.subjectNode.set({text:this.msg.subject,title:this.msg.subject}),this.contentNode.set({html:this.msg.content}),this.contentNode.set({title:this.contentNode.get("text")}),this.dateNode.set("text",this.showTime.format("db")),this.node.inject(this.container,"top"),this.setEvent()},setEvent:function(){this.closeNode.addEvents({click:function(e){this.close(null,e)}.bind(this)})},close:function(e,t){this.closeItem(e,t)},closeItem:function(e){var t=new Fx.Morph(this.node,{duration:"200"}),s=this.node.getSize();this.node.setStyle("height",s.y+"px"),this.message.items.erase(this),t.start({opacity:0,height:"0px"}).chain(function(){this.message.addUnread(-1),this.node.destroy(),e&&e()}.bind(this))}}),MWF.xDesktop.Message.Item.tooltips=[],MWF.xDesktop.Message.tooltipNode=null,MWF.xDesktop.Message.Tooltip=new Class({Extends:MWF.xDesktop.Message.Item,setEvent:function(){if(!MWF.xDesktop.Message.tooltipNode){MWF.xDesktop.Message.tooltipNode=new Element("div",{styles:this.css.messageTooltipAreaNode}).inject(this.message.container);var e=this.message.desktop.desktopNode;MWF.xDesktop.Message.tooltipNode.position({relativeTo:e,position:"rightTop",edge:"rightTop"})}this.node.inject(MWF.xDesktop.Message.tooltipNode),this.node.setStyles(this.css.messageTooltipNode),MWF.xDesktop.Message.Item.tooltips.push(this),window.setTimeout(function(){this.close(function(){MWF.xDesktop.Message.Item.tooltips.erase(this)}.bind(this))}.bind(this),1e4),this.closeNode.addEvents({click:function(){this.close(function(){MWF.xDesktop.Message.Item.tooltips.erase(this)}.bind(this))}.bind(this)})},closeItem:function(e){var t=new Fx.Morph(this.node,{duration:"200"}),s=this.node.getSize();this.node.setStyle("height",s.y+"px"),this.message.items.erase(this),t.start({opacity:0,height:"0px"}).chain(function(){this.node.destroy(),e&&e()}.bind(this))}});