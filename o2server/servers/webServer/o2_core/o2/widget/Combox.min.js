o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.Combox=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",list:[],optionsMethod:null,splitStr:/,\s*|;\s*|，\s*|；\s*/g,splitShow:", ",focusList:!1,noDataColor:!0,onlySelect:!1,count:0},initialize:function(t){this.setOptions(t),this.splitRegExp=new RegExp(this.options.splitStr),this.path=o2.session.path+"/widget/$Combox/",this.cssPath=o2.session.path+"/widget/$Combox/"+this.options.style+"/css.wcss",this._loadCss(),this.values=[],this.load()},getSelectList:function(t,i){var e=[];if(this.options.list.length)if(this.options.onlySelect)e=this.options.list;else{var o=this.options.list.filter((function(i,e){return-1!==((i.keyword||"")+i.text).indexOf(t)}));e=o}this.options.optionsMethod?this.options.optionsMethod(t,function(t){t.length&&(e=e.length?e.concat(t):t),i&&i(e)}.bind(this)):i&&i(e)},load:function(){this.fireEvent("queryLoad")&&(this.node=new Element("div",{styles:this.css.comboxNode}),this.copyPrototype(),this.setEvent(),this.fireEvent("postLoad"))},clear:function(){this.input&&o2.release(this.input),this.input=null,this.node.empty(),this.values=[]},getData:function(){for(var t=this.node.getFirst(),i=[];t;){var e=t.retrieve("item");e&&(e.data||e.value)&&i.push(e.data||e.value),t=t.getNext()}return i},copyPrototype:function(){this.inject=this.node.inject.bind(this.node),this.setStyle=this.node.setStyle.bind(this.node),this.setStyles=this.node.setStyles.bind(this.node),this.set=this.node.set.bind(this.node)},setEvent:function(){this.node.addEvents({focus:function(t){this.selectStatus||this.editItem||this.intoEdit(t)}.bind(this),mousedown:function(t){this.selectStatus||(this.editItem||this.intoEdit(t),t.stopPropagation(),t.preventDefault())}.bind(this)})},stopEdit:function(){this.editItem?this.editItem.input.confirmValue():this.input&&this.input.confirmValue(),this.input&&this.input.node.hide()},intoEdit:function(t){if(this.options.count&&this.values.length>=this.options.count)return this.input&&this.input.node.hide(),!1;if(this.input||(this.input=new o2.widget.Combox.Input(this,this,""),this.input.node.inject(this.node),this.input.node.setStyle("width","1px")),t)if("item"===t.type){var i=t.node;t.input&&(i=t.input.optionListNode||t.input.node),this.input.node.inject(i,"after")}else{this.input.node.get("value")&&this.commitInput();for(i=this.node.getFirst();i;){if(i.retrieve("item")){var e=i.getPosition(),o=i.getSize();if(e.x>t.page.x&&e.y-3<t.page.y&&e.y+o.y+3>t.page.y)break}i=i.getNext()}i?this.input.node.inject(i,"before"):this.input.node.inject(this.node)}this.input.node.show(),this.input.setInputNodeStyles(),this.input.node.focus(),this.input.setInputPosition(),this.options.focusList&&this.input.searchItems()},commitInput:function(t){var i=this.input.node.get("value");if(this.input.node.set("value",""),i){var e=i.split(this.splitRegExp);this.options.count&&(e=e.slice(0,this.options.count)),this.createItem(e,0,t,function(){this.input.node.set("value",""),this.input.searchItems(),this.input.setInputWidth(),window.setTimeout(function(){this.intoEdit()}.bind(this),10)}.bind(this))}},createItem:function(t,i,e,o){if(t[i]){var s=t[i],n=e,h=s;n||"object"===typeOf(s)&&(n=s.value,h=s.text);var d=new o2.widget.Combox.Value(this,h,n,{onLoad:function(){i++,t[i]?this.createItem(t,i,e,o):o&&o()}.bind(this)},!0);this.values.push(d),d.load()}},addNewValues:function(t,i){this.createItem(t,0,null,i)},addNewValue:function(t,i){t&&(this.values.push(new o2.widget.Combox.Value(this,t,i)),this.input&&(this.input.node.set("value",""),this.input.hideOptionList(),this.input.searchItems(),this.input.setInputWidth()))},getFirst:function(){var t=this.node.getFirst();if(t){for(;t&&!t.retrieve("item");)t=t.getNext();if(t)return t.retrieve("item")}return null},getLast:function(){var t=this.node.getLast();if(t){for(;t&&!t.retrieve("item");)t=t.getPrevious();if(t)return t.retrieve("item")}return null},getNextItem:function(){var t=this.input.node.getNext();return t?t.retrieve("item"):null},getPreviousItem:function(){for(var t=this.input.node.getPrevious();t&&!t.retrieve("item");)t=t.getPrevious();return t?t.retrieve("item"):null},deleteItem:function(t){this.values.erase(t),t.node.destroy(),t.input&&t.input.destroy(),o2.release(t)}}),o2.widget.Combox.Value=new Class({Implements:[Options,Events],initialize:function(t,i,e,o,s){this.setOptions(o),this.combox=t,this.css=this.combox.css,this.value=i,this.data=e||null,this.type="item",this.index=this.combox.values.length,s||this.load()},getItemPosition:function(){for(var t=0,i=this.getPreviousItem();i;)t++,i=i.getPreviousItem();return t},checkData:function(t){this.data?t&&t():this.combox.getSelectList(this.value,function(i){1==i.length&&(this.data=i[0].value,this.value=i[0].text),t&&t()}.bind(this))},load:function(){this.node=new Element("div",{styles:this.css.valueItemNode}),this.combox.input?this.node.inject(this.combox.input.node,"before"):this.node.inject(this.combox.node),this.getNextItem()?this.node.set("text",this.value+this.combox.options.splitShow):this.node.set("text",this.value);var t=this.getPreviousItem();t&&t.node.set("text",t.value+this.combox.options.splitShow),this.node.store("item",this),this.node.addEvents({click:function(t){this.edit(),t.stopPropagation()}.bind(this),mouseover:function(t){this.node.setStyles(this.css.valueItemNode_over)}.bind(this),mouseout:function(t){this.node.setStyles(this.css.valueItemNode)}.bind(this),mousedown:function(t){t.stopPropagation()}.bind(this),focus:function(t){t.stopPropagation()}}),this.checkData(function(){this.options.noDataColor&&(this.data||this.node.setStyle("color","#bd0000")),this.combox.fireEvent("commitInput",[this]),this.combox.fireEvent("change",[this]),this.fireEvent("load")}.bind(this))},edit:function(t){this.input||(this.input=new o2.widget.Combox.Input(this.combox,this,this.value),this.input.node.inject(this.node,"after"),this.input.hide()),this.input.node.show(),this.input.setInputNodeStyles(),this.node.hide(),this.input.setInputPosition(t),this.combox.editItem=this,this.combox.input&&this.combox.input.hide(),this.input.searchItems()},commitInput:function(t){var i=this.combox.values.map((function(t){return t.data||t.value})),e=this.input.node.get("value");if(e){if(e.split(this.combox.splitRegExp).length>1){this.input.node.set("value",""),this.combox.editItem=null;var o=this.combox;this.combox.deleteItem(this),o.input.node.set("value",e),o.commitInput()}else if(this.value==e?this.data=t||this.data:(this.value=e,this.data=t||null),this.data?this.node.setStyle("color",""):this.options.noDataColor&&this.node.setStyle("color","#bd0000"),this.value)this.getNextItem()?this.node.set("text",this.value+this.combox.options.splitShow):this.node.set("text",this.value),this.node.show(),this.input.hide(),this.combox.editItem=null,this.combox.fireEvent("commitInput",[this]),this.combox.fireEvent("change",[this,i]);else{this.combox.editItem=null;o=this.combox;this.input.hideOptionList(),this.combox.deleteItem(this),o.fireEvent("change",[this,i])}}else{this.combox.editItem=null;o=this.combox;this.input.hideOptionList(),this.combox.deleteItem(this),o.fireEvent("change",[this])}window.setTimeout(function(){this.combox.intoEdit(this)}.bind(this),10)},getNextItem:function(){for(var t=this.input?this.input.node.getNext():this.node.getNext();t&&!t.retrieve("item");)t=t.getNext();return t?t.retrieve("item"):null},getPreviousItem:function(){for(var t=this.node.getPrevious();t&&!t.retrieve("item");)t=t.getPrevious();return t?t.retrieve("item"):null}}),o2.widget.Combox.Input=new Class({initialize:function(t,i,e){this.combox=t,this.bind=i,this.css=this.combox.css,this.node=new Element("input",{styles:this.css.inputNode,type:"text",value:e}),this.combox.options.onlySelect&&this.node.set("readonly",!0),this.setInputNodeStyles(),this.setInputWidth(),this.setEvent(),this.hideOption=!1},hide:function(){this.node.hide(),this.hideOptionList()},setEvent:function(){this.node.addEvents({mousedown:function(t){t.stopPropagation()},input:function(t){this.setInputWidth(),this.searchItems();var i=this.node.get("value"),e=i.substr(i.length-1,1);"，"!=e&&"；"!=e||(this.node.set("value",i.substr(0,i.length-1)),this.optionListNode&&1===this.optionListNode.getChildren().length?this.confirmValue():this.bind.commitInput())}.bind(this),keydown:function(t){(186!==t.code&&188!==t.code&&13!==t.code||(13===t.code||this.optionListNode&&1===this.optionListNode.getChildren().length?this.confirmValue():this.bind.commitInput(),t.preventDefault(),t.stopPropagation()),37===t.code)&&(0==this.node.selectionStart&&0==this.node.selectionEnd&&((e=this.bind.getPreviousItem())&&(this.bind.commitInput(),e.edit()),t.preventDefault(),t.stopPropagation()));if(39===t.code){var i=this.node.get("value").length;if(this.node.selectionStart==i&&this.node.selectionEnd==i)(e=this.bind.getNextItem())&&(this.bind.commitInput(),e.edit("start")),t.preventDefault(),t.stopPropagation()}8===t.code&&(0==this.node.selectionStart&&0==this.node.selectionEnd&&((e=this.bind.getPreviousItem())&&(this.bind.commitInput(),e.edit(),e.input.setInputPosition()),t.preventDefault(),t.stopPropagation()));if(46===t.code){var e;i=this.node.get("value").length;if(this.node.selectionStart==i&&this.node.selectionEnd==i)(e=this.bind.getNextItem())&&(this.bind.commitInput(),e.edit(),e.input.setInputPosition("start")),t.preventDefault(),t.stopPropagation()}38===t.code&&this.selectPrevOption(),40===t.code&&this.selectNextOption()}.bind(this),blur:function(t){this.combox.editItem!=this.bind&&this.combox.editItem||this.bind.commitInput(),this.hideOptionList(),t.stopPropagation()}.bind(this)})},setSelectedOption:function(t){var i=t.getStyles("background-color","background","color");t.store("originalStyle",i),t.setStyles(this.css.optionNode_selected),this.selectedOption=t},selectPrevOption:function(){this.optionListNode&&(this.selectedOption&&this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle")),node=this.selectedOption&&this.selectedOption.getPrevious()||this.optionListNode.getLast(),node&&this.setSelectedOption(node),this.optionListNode.scrollToNode(node,"top"))},selectNextOption:function(){this.optionListNode&&(this.selectedOption&&this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle")),node=this.selectedOption&&this.selectedOption.getNext()||this.optionListNode.getFirst(),node&&this.setSelectedOption(node),this.optionListNode.scrollToNode(node,"bottom"))},selectOption:function(t){this.optionListNode&&(this.selectedOption&&this.selectedOption.setStyles(this.selectedOption.retrieve("originalStyle")),t&&this.setSelectedOption(t))},confirmValue:function(){if(this.optionListNode)if(this.selectedOption){var t=this.selectedOption.retrieve("data"),i=this.selectedOption.get("text");this.node.set("value",i),this.setInputWidth(),this.bind.commitInput(t),this.selectedOption=null}else this.bind.commitInput();else this.bind.commitInput()},setInputWidth:function(){if(this.node){var t=this.node.get("value");this.tmpDivNode||(this.tmpDivNode=new Element("div").set("style",this.node.get("style")).setStyles({display:"none",float:"left",width:"auto"}).inject(document.body)),this.tmpDivNode.empty(),t=t.replace(/\s/g,"&nbsp"),this.tmpDivNode.set("html",t);var i=this.tmpDivNode.getComputedSize(),e=i.width-i.computedLeft-i.computedRight+5,o=this.combox.node.getComputedSize();e<1&&(e=1),e>o.width&&(e=o.width),this.node.setStyle("width",e+"px"),this.node.focus()}},setInputPosition:function(t){if(this.node.focus(),"start"===t)this.node.setSelectionRange(0,0);else{var i=this.node.get("value").length;this.node.setSelectionRange(i,i)}},setInputNodeStyles:function(){if(this.node){var t=this.combox.node.getStyles("font-family","min-height","font-size","font-weight","font-variant","font-style","line-height","color","text-align");if(!this.inputHeight){var i=this.combox.node.getComputedSize();this.inputHeight=i.height+"px",t.height=i.height+"px"}this.node.setStyles(t)}},destroy:function(){this.node.destroy(),o2.release(this)},searchItems:function(){this.hideOption=!0;var t=this.node.get("value");t||this.combox.options.focusList?this.combox.getSelectList(t,function(t){this.hideOption&&(t.length?this.showOptionList(t):this.hideOptionList())}.bind(this)):this.hideOptionList()},createOptionListNode:function(){this.optionListNode=new Element("div",{styles:this.css.optionListNode}),this.optionListNode.inject(this.node,"after"),this.optionListNode.addEvents({mousedown:function(t){this.noBlur=!0,t.preventDefault(),t.stopPropagation()}.bind(this),mouseup:function(t){this.node.focus(),this.noBlur=!1}.bind(this)})},showOptionList:function(t){this.optionListNode||this.createOptionListNode(),this.optionListNode.setStyle("dispaly","block"),this.optionListNode.empty();var i=this,e=this.combox.node.getStyles("font-family","font-size","font-weight","font-variant","font-style","line-height","color","text-align");t.each(function(t){var o=new Element("div",{styles:this.css.optionNode,text:t.text}).inject(this.optionListNode);o.store("data",t.value),o.setStyles(e),o.addEvents({mousedown:function(){i.confirmValue()},mouseover:function(){i.selectOption(this)}})}.bind(this));var o=this.optionListNode.getFirst();if(o){e=o.getStyles("background-color","background","color");o.store("originalStyle",e),o.setStyles(this.css.optionNode_selected),this.selectedOption=o}this.optionListNode.position({relativeTo:this.node,position:"leftBottom",edge:"leftTop",offset:{y:3}});var s=this.optionListNode.getOffsetParent(),n=this.optionListNode.getPosition(s),h=this.optionListNode.getSize(),d=s.getSize();if(n.y+h.y>d.y&&this.optionListNode.position({relativeTo:this.node,position:"leftTop",edge:"leftBottom",offset:{y:3}}),(n=this.optionListNode.getPosition(s)).y<10){var u=this.optionListNode.getStyle("top").toInt();u=u-n.y+10,this.optionListNode.setStyle("top",u+"px")}layout.desktop.offices&&Object.each(layout.desktop.offices,function(t){this.optionListNode.isOverlap(t.officeNode)&&t.hide()}.bind(this))},hideOptionList:function(){this.optionListNode&&(this.optionListNode.destroy(),this.optionListNode=null),this.hideOption=!1,layout.desktop.offices&&Object.each(layout.desktop.offices,(function(t){if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===t.form.app.appId){var i=t.officeNode.retrieve("officeDisplay");i&&t.officeNode.setStyle("display",i)}}))}});