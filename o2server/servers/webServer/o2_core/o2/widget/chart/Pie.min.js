o2.widget=o2.widget||{},o2.widget.chart=o2.widget.chart||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.widget.chart.d3",null,!1),o2.widget.chart.Pie=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",margin:10,showText:!1,textType:"value",dataFormat:""},initialize:function(t,e,s){this.setOptions(s),this.node=$(t),this.data=e,this.path=o2.session.path+"/widget/chart/$Pie/",this.cssPath=o2.session.path+"/widget/chart/$Pie/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.svgNode=new Element("div",{styles:this.css.svgNode}).inject(this.node),this.fireEvent("queryLoad")&&(this.size=this.node.getSize(),o2.widget.chart.d3.load(function(){this.svg=d3.select(this.svgNode).append("svg"),this.setSvgSize(),this.loadPieData(),this.loadPieArc()}.bind(this)),this.fireEvent("postLoad"))},setSvgSize:function(){this.svg.attr("width",this.size.x).attr("height",this.size.y)},loadPieData:function(){if("percent"===this.options.textType){var t=d3.sum(this.data,(function(t){return t.value}));this.data.map((function(e){var s=(e.value/t*1e4).toInt()/100;return e.percent=s+"%",e}))}this.pie=d3.pie().value((function(t,e){return t.value})).sort((function(t,e){return!1})),this.pieData=this.pie(this.data)},loadPieArc:function(){var t=this.size.x>this.size.y?this.size.y:this.size.x;t=t/2-this.options.margin,this.arc=d3.arc().innerRadius(0).outerRadius(t),this.arcOver=d3.arc().innerRadius(0).outerRadius(t+5),this.colors=this.css.colors||d3.schemeCategory10;var e=this.svg.selectAll("g").data(this.pieData).enter().append("g").attr("transform","translate("+this.size.x/2+", "+this.size.y/2+")"),s=e.append("path").attr("d",function(t,e){var s={startAngle:t.startAngle,endAngle:t.startAngle};return this.arc(s)}.bind(this)).attr("fill",function(t,e){return this.colors[0+e]}.bind(this));Object.each(this.css.arcs,function(t,e){s.attr(e,(function(e){return"function"==typeOf(t)?t.apply(i,[e,this]):t}))}.bind(this)),this.setDefs("arcs_defs",s),this.transition();var i=this;e.on("mouseover",(function(t,e,n){i.highlight(this,t,e),i.fireEvent("mouseover",[s,t,e])})).on("mousemove",(function(t,e,n){i.options.showText||i.moveHint(this,t,e),i.fireEvent("mousemove",[s,t,e])})).on("mouseout",(function(t,e,n){i.normal(this,t,e),i.fireEvent("mouseout",[s,t,e])})).on("click",(function(t,e,n){i.fireEvent("click",[s,t,e])}))},highlight:function(t,e,s){var i=d3.select(t).select("path"),n=d3.select(t).select("text");i.attr("d",this.arcOver(e)),Object.each(this.css.arcs_over,function(t,e){i.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("arcs_over_defs",i),Object.each(this.css.text_over,function(t,e){n.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("text_over_defs",n),this.options.showText||this.showHint(t,e,s)},normal:function(t,e,s){var i=d3.select(t).select("path"),n=d3.select(t).select("text");i.attr("d",this.arc(e)),Object.each(this.css.arcs,function(t,e){i.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("arcs_defs",i),i.attr("fill",this.colors[0+s]),Object.each(this.css.text,function(t,e){n.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("text_defs",n),this.options.showText||this.hideHint(t,e,s)},createTextNode:function(t,e,s,i){var n=this.svg.append("g");i||(i=d3.mouse(this.svg.node()));var a=e.data.name+" ("+(this.options.dataFormat?d3.format(this.options.dataFormat)(e.data.value):e.data.text)+")";e.size||(e.size=o2.getTextSize(a));var r=e.size,o=i[0]-r.x/2,h=i[1]-r.y-5;o<0&&(o=0);var c=n.attr("transform","translate("+o+", "+h+")").append("rect").attr("height",r.y).attr("width",r.x),d=n.append("text").attr("transform","translate("+r.x/2+", "+(r.y/2+5)+")").text(a);return Object.each(this.css.hint_rect,function(t,e){c.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("hint_rect_defs",c),Object.each(this.css.hint_text,function(t,e){d.attr(e,(function(e){return"function"==typeOf(t)?t.apply(_self,[e,this]):t}))}.bind(this)),this.setDefs("hint_text_defs",d),n},showHint:function(t,e,s){var i=t.retrieve("hint");i||(i=this.createTextNode(t,e,s),t.store("hint",i))},moveHint:function(t,e,s){var i=t.retrieve("hint");if(i){var n=d3.mouse(this.svg.node());e.size||(e.size=o2.getTextSize(e.data.name));var a=e.size,r=n[0]-a.x/2,o=n[1]-a.y-5;r<0&&(r=0),i.attr("transform","translate(0,0)").attr("transform","translate("+r+", "+o+")")}},hideHint:function(t,e,s){var i=t.retrieve("hint");i&&(i.remove(),t.eliminate("hint"))},transition:function(t,e){var s=this;t||(t=this.svg.selectAll("path")),e||(e=this.svg.selectAll("g")),texts=this.svg.selectAll("text"),texts.remove();var i=d3.sum(this.data,(function(t,e){return t.value}));t.attr("d",function(t,e){var s={startAngle:t.startAngle,endAngle:t.startAngle};return this.arc(s)}.bind(this)),t.transition().delay(function(t,e){var s=d3.sum(this.data,(function(t,s){return s<e?t.value:0}));return e>0?s/i*300:0}.bind(this)).duration(function(t,e){return t.value/i*300}.bind(this)).ease(d3.easeLinear).attrTween("d",function(t,e){return function(e){var s=t.endAngle-t.startAngle,i={startAngle:t.startAngle,endAngle:t.startAngle+s*e};return this.arc(i)}.bind(this)}.bind(this)).on("end",function(t,i){var n=this.size.x>this.size.y?this.size.y:this.size.x;n=n/2-this.options.margin;var a=d3.arc().innerRadius(0).outerRadius(n+20).centroid(t),r=d3.select(e.nodes()[i]).append("text").attr("transform","translate("+a[0]+", "+a[1]+")").text(t.data.percent||d3.format(this.options.dataFormat)(t.data.value));Object.each(this.css.text,function(t,e){r.attr(e,(function(e){return"function"==typeOf(t)?t.apply(s,[e,this]):t}))}.bind(this)),this.setDefs("text_defs",r)}.bind(this))},setDefs:function(t,e){if(this.css[t]){var s=this.svg.append("defs");this.createDefs(s,this.css[t]),s.select((function(){return this.getFirst()})).attr("id",this.classId+"_"+t),e.attr(this.css[t].urlAttr,"url(#"+this.classId+"_"+t+")")}},hide:function(){this.svgNode.setStyle("display","none")},show:function(){this.svgNode.setStyle("display","block"),this.transition()},destroy:function(){this.svgNode.destroy(),o2.release(this)}});