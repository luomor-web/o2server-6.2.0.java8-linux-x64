o2.widget=o2.widget||{},o2.widget.chart=o2.widget.chart||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.widget.chart.d3",null,!1),o2.require("o2.widget.chart.Bar",null,!1),o2.widget.chart.Line=new Class({Implements:[Options,Events],Extends:o2.widget.chart.Bar,loadChart:function(){this.rectClass=Math.round(100*Math.random());this.xScale.bandwidth(),this.barsData.length;this.pointCluster=[],this.textCluster=[],this.lineCluster=[],this.lineGroup=this.group.append("g"),this.linePoint=[],this.barsData.each(function(t,i){var n=d3.line().x(function(t){return this.xScale(t.name)+this.xScale.bandwidth()/2}.bind(this)).y(function(t){return this.yScale(t.data)}.bind(this)).curve(d3.curveCardinal.tension(.25)),a=this.lineGroup.selectAll(".MWFLine_"+this.rectClass+"_"+i).data([t]).enter().append("path").attr("d",n(t)).attr("stroke",this.colors[i]).attr("fill","none");this.lineCluster.push(a);var e=this.group.selectAll(".MWFBar_"+this.rectClass+"_"+i).data(t).enter().append("circle").attr("r",5).attr("class",".MWFBar_"+this.rectClass+"_"+i).attr("cx",function(t){return this.xScale(t.name)+this.xScale.bandwidth()/2}.bind(this)).attr("cy",function(t){return this.yScale(t.data)}.bind(this)).attr("stroke",this.colors[i]).attr("fill","#ffffff");this.pointCluster.push(e);var r=this.group.selectAll(".MWFLineText_"+this.rectClass+"_"+i).data(t).enter().append("text").text(function(t){return this.options.dataFormat?d3.format(this.options.dataFormat)(t.data):t.text}.bind(this)).attr("x",function(t){var i=o2.getTextSize(this.options.dataFormat?d3.format(this.options.dataFormat)(t.data):t.text).x;return this.xScale(t.name)+this.xScale.bandwidth()/2-i/2}.bind(this)).attr("y",function(t){return this.yScale(t.data)-10}.bind(this));this.textCluster.push(r)}.bind(this))},loadScales:function(){this.xScale=d3.scaleBand().domain(this.data.map(function(t){return t[this.item]}.bind(this))).rangeRound(this.getXScaleRange()).paddingOuter(.3).paddingInner(.3),this.barsData=[],this.bars.each(function(t,i){this.barsData.push(this.data.map(function(n,a){return{name:n[this.item],data:"function"===typeOf(t.data)?t.data(n,i):n[t.data],text:"function"===typeOf(t.text)?t.text(n,i):n[t.text]}}.bind(this)))}.bind(this));var t=d3.max(this.barsData,(function(t){return d3.max(t,(function(t){return t.data}))})),i=d3.min(this.barsData,(function(t){return d3.min(t,(function(t){return t.data}))}));this.yScale=d3.scaleLinear().domain([.9*i,1.1*t]).range(this.getYScaleRange())},setEvents:function(){var t=this.group.selectAll("circle"),i=this.group.selectAll("text"),n=this;t.on("mouseover",function(a,e,r){n.highlight(t,i,a,e),this.fireEvent("mouseover",[t,i,a,e])}.bind(this)).on("mouseout",function(a,e,r){n.normal(t,i,a,e),this.fireEvent("mouseout",[t,i,a,e])}.bind(this)).on("click",function(n,a,e){this.fireEvent("click",[t,i,n,a])}.bind(this))},highlight:function(t,i,n,a){i.filter((function(t,i){return i==a})).attr("display","block");var e=t.filter((function(t,i){return i==a})),r=e.attr("fill");e.node().store("color",r),e.attr("r","6"),e.attr("stroke-width","3")},normal:function(t,i,n,a){i.filter((function(t,i){return i==a})).attr("display","none");var e=t.filter((function(t,i){return i==a})),r=e.node().retrieve("color");e.attr("fill",r),e.attr("r","6"),e.attr("stroke-width","1")},transition:function(t){t||(t=this.group.selectAll("path"));var i=this.xScale.bandwidth()/this.barsData.length,n=d3.line().x(function(t,n){return this.xScale(t.name)+n*i+this.xScale.bandwidth()/2}.bind(this)).y(function(t){return this.yScale(t.data)}.bind(this)).curve(d3.curveCardinal.tension(0));t.transition().delay(function(t,i){return i*this.options.delay}.bind(this)).duration(this.options.duration).ease(d3.easeExpOut).attr("d",function(t){return n(t)}.bind(this))}});