o2.widget=o2.widget||{},o2.require("o2.widget.JavascriptEditor",null,!1),o2.widget.ScriptArea=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{title:"ScriptArea",style:"default",helpStyle:"default",maxObj:document.body,isload:!1,isbind:!0,mode:"javascript",runtime:"all",key:"code",forceType:null},initialize:function(t,e){this.setOptions(e),this.node=$(t),this.container=new Element("div"),this.path=o2.session.path+"/widget/$ScriptArea/",this.cssPath=o2.session.path+"/widget/$ScriptArea/"+this.options.style+"/css.wcss",this._loadCss()},load:function(t){this.fireEvent("queryLoad")&&(this.container.set("styles",this.css.container),this.container.inject(this.node),this.createTitleNode(),this.createContent(t),this.fireEvent("postLoad"))},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,events:{dblclick:this.toggleSize.bind(this)}}).inject(this.container),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,events:{click:this.toggleSize.bind(this)}}).inject(this.titleNode),this.referenceNode=new Element("div",{styles:this.css.referenceNode}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode)},toggleSize:function(t){"max"==this.titleActionNode.retrieve("status","max")?this.maxSize():this.returnSize()},maxSize:function(){var t=this.options.maxObj,e=t.getCoordinates(t.getOffsetParent());this.container.store("size",{height:this.container.getStyle("height"),width:this.container.getStyle("width")}),this.jsEditor.showLineNumbers(),this.jsEditor.max(),this.container.inject(t),this.container.setStyles({position:"absolute",top:e.top+"px",left:e.left+"px",width:e.width,height:e.height-2,"z-index":20001}),this.resizeContentNodeSize(),this.titleActionNode.setStyle("background","url("+this.path+this.options.style+"/icon/return.png) center center no-repeat"),this.titleActionNode.store("status","return"),this.jsEditor.focus()},returnSize:function(){var t=this.container.retrieve("size");this.jsEditor.hideLineNumbers(),this.container.inject(this.node),this.container.setStyles({position:"static",top:0,left:0,width:"auto",height:t.height}),this.resizeContentNodeSize(),this.titleActionNode.setStyle("background","url("+this.path+this.options.style+"/icon/max.png) center center no-repeat"),this.titleActionNode.store("status","max"),this.jsEditor.focus()},resizeContentNodeSize:function(){var t=this.titleNode.getSize(),e=this.container.getSize(),i=this.container.getStyle("height").toInt(),s=this.titleNode.getStyle("height").toInt(),o=(e.y||i)-(t.y||s)-2-6;this.contentNode.setStyle("height",o+"px"),this.jsEditor&&this.jsEditor.resize()},toJson:function(){return this.editor?{code:this.editor.getValue(),html:this.editor.getValue()}:this.contentCode},createContent:function(t){if(this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container),this.resizeContentNodeSize(),t&&t.code||this.referenceNode.setStyle("background","url("+o2.session.path+"/widget/$ScriptArea/"+this.options.style+"/icon/reference_empty.png) center center no-repeat"),this.contentCode=t,this.options.isload)this.loadEditor(t);else{var e=new Element("div",{styles:this.css.inforNode,text:o2.LP.widget.scriptAreaEditNotice}).inject(this.contentNode),i=this;e.addEvent("click",(function(){this.destroy(),i.loadEditor(t)}))}},bind:function(t){this.value=t.code,this.html=t.code,t.editors?t.editors.push(this.jsEditor):(Object.defineProperty(t,"editors",{configurable:!1,enumerable:!1,writable:!0,value:[]}),t.editors.push(this.jsEditor),Object.defineProperty(t,this.options.key,{configurable:!0,enumerable:!0,get:function(){return this.value}.bind(this),set:function(e){t.editors.each((function(t){t.editor?e!==t.editor.getValue()&&t.editor.setValue(e,1):t.reload()})),this.value=e}.bind(this)}))},loadEditor:function(t){var e=t?t.code:"";e=e||"",this.jsEditor=new o2.widget.JavascriptEditor(this.contentNode,{runtime:this.options.runtime||"all",forceType:this.options.forceType,option:{value:e,lineNumbers:!1,mode:this.options.mode},onPostLoad:function(){this.editor=this.jsEditor.editor,this.jsEditor.addEditorEvent("change",function(){this.fireEvent("change")}.bind(this)),this.jsEditor.addEditorEvent("blur",function(){this.fireEvent("blur")}.bind(this)),this.jsEditor.resize(),this.fireEvent("postLoad")}.bind(this),onSave:function(){this.fireEvent("change"),this.fireEvent("save")}.bind(this)}),this.jsEditor.load(),this.options.isbind&&this.bind(t),this.referenceNode.setStyle("background","url("+o2.session.path+"/widget/$ScriptArea/"+this.options.style+"/icon/reference.png) center center no-repeat")},createScriptReferenceMenu:function(t){o2.require("o2.widget.ScriptHelp",function(){this.scriptReferenceMenu=new o2.widget.ScriptHelp(this.referenceNode,this.jsEditor.editor,{style:this.options.helpStyle,event:"click",onPostLoad:function(){t&&t()}.bind(this)}),this.scriptReferenceMenu.getEditor=function(){return this.jsEditor.editor}.bind(this)}.bind(this))},showReferenceMenu:function(){var t=this.jsEditor.getCursorPixelPosition(),e={page:{}};e.page.x=t.left,e.page.y=t.top,this.scriptReferenceMenu.menu.showIm(e)},focus:function(){this.jsEditor&&this.jsEditor.focus()}});