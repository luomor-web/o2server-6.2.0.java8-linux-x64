o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.Tree=new Class({Extends:o2.widget.Common,Implements:[Options,Events],children:[],options:{style:"default",expand:!1,text:"html"},jsonMapping:{expand:"expand",title:"title",text:"text",action:"action",icon:"icon",style:"",sub:"sub",default:"default"},initialize:function(t,e){this.setOptions(e),this.path=o2.session.path+"/widget/$Tree/",this.cssPath=o2.session.path+"/widget/$Tree/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(t),this.children=[],this.treeJson=null,this.treeXML=null},load:function(t){this.fireEvent("queryLoad")&&(t&&(this.treeJson=t),this.node=new Element("div",{styles:this.css.areaNode}),this.loadTree(),this.node.inject(this.container),this.fireEvent("postLoad"))},empty:function(){this.children.each(function(t){o2.release(t)}.bind(this)),this.node.empty()},reLoad:function(t){t&&(this.treeJson=t),this.children=[],this.node.empty(),this.loadTree()},loadTree:function(){this.treeJson?this.loadJsonTree(this.treeJson,this,this):this.treeXML&&this.loadXMLTree(),this.container&&this.node.inject(this.container)},mappingJson:function(t){t.expand&&(this.jsonMapping.expand=t.expand),t.title&&(this.jsonMapping.title=t.title),t.text&&(this.jsonMapping.text=t.text),t.action&&(this.jsonMapping.action=t.action),t.icon&&(this.jsonMapping.icon=t.icon),t.style&&(this.jsonMapping.style=t.style),t.sub&&(this.jsonMapping.sub=t.sub),t.default&&(this.jsonMapping.default=t.default)},loadJsonTree:function(t,e,i){t.each(function(t){var e={};null!=t[this.jsonMapping.expand]&&(e.expand=t[this.jsonMapping.expand]),t[this.jsonMapping.title]&&(e.title=t[this.jsonMapping.title]),t[this.jsonMapping.text]&&(e.text=t[this.jsonMapping.text]),t[this.jsonMapping.action]&&(e.action=t[this.jsonMapping.action]),t[this.jsonMapping.style]&&(e.style=t[this.jsonMapping.style]),t[this.jsonMapping.icon]&&(e.icon=t[this.jsonMapping.icon]),t[this.jsonMapping.default]&&(e.default=t[this.jsonMapping.default]);var s=i.appendChild(e);t[this.jsonMapping.sub]&&this.loadJsonTree(t[this.jsonMapping.sub],this,s)}.bind(e))},appendChild:function(t){var e=new this.$constructor.Node(this,t);return this.children.length?(e.previousSibling=this.children[this.children.length-1],e.previousSibling.nextSibling=e):this.firstChild=e,e.load(),e.node.inject(this.node),this.children.push(e),e},expandOrCollapseNode:function(t){t.options.expand?(this.collapse(t),t.options.expand=!1):(this.expand(t),t.options.expand=!0),t.setOperateIcon()},expand:function(t){this.fireEvent("queryExpand",[t])&&t.childrenNode.setStyle("display","block"),this.fireEvent("postExpand",[t])},collapse:function(t){this.fireEvent("queryCollapse",[t])&&t.childrenNode.setStyle("display","none"),this.fireEvent("postCollapse",[t])},toJson:function(t){var e=null,i=t.firstChild;for(e=[];i;)e.push(this.transObj(i.options)),e[e.length-1].sub=this.toJson(i),i=i.nextSibling;return e},transObj:function(t){var e={};return e[this.jsonMapping.expand]=t.expand,e[this.jsonMapping.title]=t.title,e[this.jsonMapping.text]=t.text,e[this.jsonMapping.action]=t.action,e[this.jsonMapping.style]=t.style,e[this.jsonMapping.default]=t.default,e[this.jsonMapping.icon]=t.icon?t.icon:"none",e}}),o2.widget.Tree.Node=new Class({Implements:[Options,Events],options:{expand:!0,title:"",text:"",action:"",style:"",default:!1,icon:"folder.png"},imgs:{expand:"expand.gif",collapse:"collapse.gif",blank:"blank.gif"},tree:null,level:0,levelNode:[],initialize:function(t,e){this.setOptions(e),"none"==e.icon&&(this.options.icon=""),this.tree=t,this.levelNode=[],this.children=[],this.parentNode=null,this.previousSibling=null,this.nextSibling=null,this.firstChild=null,this.node=new Element("div",{styles:this.tree.css.treeNode}),this.itemNode=new Element("div",{styles:this.tree.css.treeItemNode}).inject(this.node),this.childrenNode=new Element("div",{styles:this.tree.css.treeChildrenNode}).inject(this.node),this.options.style&&this.tree.css[this.options.style]&&(this.node.setStyles(this.tree.css[this.options.style].treeNode),this.itemNode.setStyles(this.tree.css[this.options.style].treeItemNode),this.childrenNode.setStyles(this.tree.css[this.options.style].treeChildrenNode)),this.options.expand||this.childrenNode.setStyle("display","none")},setText:function(t){var e=this.textNode.getElement("div");e&&e.set("text",t)},setTitle:function(t){var e=this.textNode.getElement("div");e&&e.set("title",t)},load:function(){this.tree.fireEvent("beforeLoadTreeNode",[this]),this.nodeTable=new Element("table",{border:"0",cellpadding:"0",cellspacing:"0",styles:{width:"fit-content","table-layout":"fixed"}}).inject(this.itemNode),this.nodeTable.setStyles(this.tree.css.nodeTable),this.options.style&&this.tree.css[this.options.style]&&this.nodeTable.setStyles(this.tree.css[this.options.style].nodeTable);var t=new Element("tbody").inject(this.nodeTable);this.nodeArea=new Element("tr").inject(t),this.createLevelNode(),this.createOperateNode(),this.createIconNode(),this.createTextNode(),this.tree.fireEvent("afterLoadTreeNode",[this])},createLevelNode:function(){for(var t=0;t<this.level;t++){var e=new Element("td",{styles:this.tree.css.blankLevelNode}).inject(this.nodeArea);this.options.style&&this.tree.css[this.options.style]&&e.setStyles(this.tree.css[this.options.style].blankLevelNode),this.levelNode.push(e)}},createOperateNode:function(){this.operateNode=new Element("td",{styles:this.tree.css.operateNode}).inject(this.nodeArea),this.options.style&&this.tree.css[this.options.style]&&this.operateNode.setStyles(this.tree.css[this.options.style].operateNode),this.operateNode.addEvent("click",function(){this.expandOrCollapse()}.bind(this)),this.operateNode.setStyle("background","url("+this.tree.path+this.tree.options.style+"/"+this.imgs.blank+") center center no-repeat")},createIconNode:function(){this.options.icon&&(this.iconNode=new Element("td",{styles:this.tree.css.iconNode}).inject(this.nodeArea),this.options.style&&this.tree.css[this.options.style]&&this.iconNode.setStyles(this.tree.css[this.options.style].iconNode),this.iconNode.setStyle("background","url("+this.tree.path+this.tree.options.style+"/"+this.options.icon+") center center no-repeat"))},createTextNode:function(){this.textNode=new Element("td",{styles:this.tree.css.textNode}).inject(this.nodeArea),this.options.style&&this.tree.css[this.options.style]&&this.textNode.setStyles(this.tree.css[this.options.style].textNode);var t=new Element("div",{styles:{display:"inline-block"},title:this.options.title});t.setStyles(this.tree.css.textDivNode),this.options.style&&this.tree.css[this.options.style]&&t.setStyles(this.tree.css[this.options.style].textDivNode),"html"==this.tree.options.text?t.set("html",this.options.text):t.set("text",this.options.text),t.addEvent("click",function(t){this.clickNode(t)}.bind(this)),t.inject(this.textNode),this.options.default&&t.click()},clickNode:function(t){this.selectNode(t),this.doAction(t)},selectNode:function(){var t;(this.tree.fireEvent("beforeSelect",[this]),this.tree.currentNode)&&(this.tree.currentNode.fireEvent("unselect"),(t=this.tree.currentNode.textNode.getElement("div")).setStyles(this.tree.css.textDivNode),this.tree.currentNode.options.style&&this.tree.css[this.tree.currentNode.options.style]&&t.setStyles(this.tree.css[this.tree.currentNode.options.style].textDivNode));(t=this.textNode.getElement("div")).setStyles(this.tree.css.textDivNodeSelected),this.options.style&&this.tree.css[this.options.style]&&t.setStyles(this.tree.css[this.options.style].textDivNodeSelected),this.tree.currentNode=this,this.tree.fireEvent("afterSelect",[this])},doAction:function(t){var e=typeOf(this.options.action);"string"==e?Browser.exec(this.options.action):"function"==e?this.options.action.apply(this,[this]):"object"==e&&this.tree.form&&this.tree.form.Macro.exec(this.options.action.code,this)},setOperateIcon:function(){var t=this.options.expand?this.imgs.expand:this.imgs.collapse;t=this.tree.path+this.tree.options.style+"/"+t,this.firstChild||(t=this.tree.path+this.tree.options.style+"/"+this.imgs.blank),this.operateNode.setStyle("background","url("+t+") center center no-repeat")},insertChild:function(t){var e=new this.tree.$constructor.Node(this.tree,t),i=this.previousSibling;return this.previousSibling=e,e.nextSibling=this,e.previousSibling=i,i?i.nextSibling=e:this.parentNode.firstChild=e,e.parentNode=this.parentNode,e.level=this.level,e.load(),e.node.inject(this.node,"before"),this.parentNode.children.push(e),e},appendChild:function(t){var e=new this.tree.$constructor.Node(this.tree,t);return this.children.length?(e.previousSibling=this.children[this.children.length-1],e.previousSibling.nextSibling=e):(this.firstChild=e,this.setOperateIcon()),e.level=this.level+1,e.parentNode=this,e.load(),e.node.inject(this.childrenNode),this.children.push(e),e},expandOrCollapse:function(){this.tree.expandOrCollapseNode(this)},destroy:function(){this.previousSibling&&(this.previousSibling.nextSibling=this.nextSibling),this.nextSibling&&(this.nextSibling.previousSibling=this.previousSibling),this.parentNode&&(this.parentNode.firstChild==this&&(this.parentNode.firstChild=this.nextSibling),this.parentNode.children.erase(this)),this.node.destroy()}});