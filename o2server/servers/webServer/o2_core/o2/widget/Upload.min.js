o2.widget=o2.widget||{},o2.widget.Upload=new Class({Extends:o2.widget.Common,Implements:[Options,Events],options:{data:null,parameter:null,action:null,method:"",accept:"*/*",style:"default",multiple:!0},initialize:function(t,e){this.setOptions(e),this.path=o2.session.path+"/widget/$Upload/",this.cssPath=o2.session.path+"/widget/$Upload/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(t),this.action="string"==typeOf(this.options.action)?o2.Actions.get(this.options.action).action:this.options.action},load:function(){FormData.expiredIE?this.doUpload_InputFile():this.doUpload_FormData()},upload:function(){FormData.expiredIE?this.doUpload_InputFile():(this.fileUploadNode||this.formData_CreateUploadArea(),this.fileUploadNode.click())},doUpload_FormData:function(){this.formData_CreateUploadArea(),this.fileUploadNode.click()},formData_CreateUploadArea:function(){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");var t='<input name="file" '+(this.options.multiple?"multiple":"")+' type="file" accept="'+this.options.accept+'"/>';this.uploadFileAreaNode.set("html",t),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",this.formData_Upload.bind(this))}},formData_Upload:function(){var t=this.fileUploadNode.files;if(t.length){var e=t.length,i=0;this.isContinue=!0,this.fireEvent("beforeUpload",[t,this]);var o=function(t){i==e&&this.fireEvent("completed",[t])}.bind(this);if(this.isContinue)for(var s=0;s<t.length;s++){var a=t.item(s);this.fireEvent("beforeUploadEntry",[a,this]);var n=new FormData;Object.each(this.options.data,(function(t,e){n.append(e,t)})),n.append("file",a),this.action.invoke({name:this.options.method,async:!0,data:n,file:a,parameter:this.options.parameter,success:function(t){i++,this.fireEvent("every",[t,i,e,a]),o(t)}.bind(this)})}this.uploadFileAreaNode.destroy(),this.uploadFileAreaNode=null}},inputFile_CreateMaskNode:function(){this.container.mask({style:{opacity:.7,"background-color":"#999"}})},addUploadMessage:function(t){var e;e='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px"><div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+o2.LP.desktop.action.uploadTitle+"</div></div><iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:o2.LP.desktop.action.uploadTitle,content:t+"<br/>"+e};if(layout.desktop.message){var o=layout.desktop.message.addMessage(i);o.close=function(t,e){o.completed&&o.closeItem(t,e)}}return window.setTimeout(function(){layout.desktop.message&&(layout.desktop.message.isShow||layout.desktop.message.show())}.bind(this),300),o},setMessageTitle:function(t,e){t&&t.subjectNode.set("text",e)},setMessageText:function(t,e){if(t){t.contentNode.getFirst("div").getFirst("div").getFirst("div");t.contentNode.getFirst("div").getLast("div").set("text",e),t.dateNode.set("text",(new Date).format("db"))}},inputFile_CreateInputNode:function(t){this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container),this.inputUploadAreaNode.position({relativeTo:this.container,position:"center"});var e=new Element("form",{method:"POST",action:t+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode),i=(new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:o2.LP.widget.uploadTitle}).inject(e),new Element("div",{styles:this.css.inputUploadAreaInforNode,text:o2.LP.widget.uploadInfor}).inject(e),new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(e)),o=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(i),s=new Element("input",{type:"hidden",name:"fileName"}).inject(i);Object.each(this.options.data,(function(t,e){new Element("input",{type:"hidden",name:e,value:t}).inject(i)}));var a=new Element("div",{styles:this.css.inputUploadActionNode}).inject(e),n=new Element("button",{styles:this.css.inputUploadCancelButton,text:o2.LP.widget.cancel}).inject(a),d=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:o2.LP.widget.ok}).inject(a);o.addEvent("change",function(){var t=o.get("value");if(t){var e=t.replace(/\\/g,"/"),i=e.lastIndexOf("/"),a=-1===i?e:e.substr(i+1,e.length-i);s.set("value",a)}}.bind(this)),n.addEvent("click",function(){this.container.unmask(),this.inputUploadAreaNode.destroy()}.bind(this)),d.addEvent("click",function(){e.mask({style:{opacity:.7,"background-color":"#999"}}),this.isContinue=!0,this.fireEvent("beforeUpload",[s.get("value")]),this.isContinue&&(this.messageItem=this.addUploadMessage(s.get("value")),e.submit(),this.container.unmask(),this.inputUploadAreaNode&&this.inputUploadAreaNode.destroy())}.bind(this))},inputFile_UploadCallback:function(t){var e=JSON.decode(t);this.messageItem.completed=!0,"success"===e.type?(this.setMessageTitle(this.messageItem,o2.LP.desktop.action.uploadComplete),this.setMessageText(this.messageItem,o2.LP.desktop.action.uploadComplete),this.fireEvent("every",[e]),this.fireEvent("completed",[e])):(this.setMessageTitle(this.messageItem,o2.LP.desktop.action.sendError),this.setMessageText(this.messageItem,o2.LP.desktop.action.sendError+": "+e.message),o2.xDesktop.notice("error",{x:"right",y:"top"},e.message))},doUpload_InputFile:function(){this.action.getActions(function(){var t=this.action.actions[this.options.method];t=this.action.address+t.uri,Object.each(this.options.parameter,(function(e,i){t=t.replace("{"+i+"}",e)})),this.messageItem=null,document.O2UploadCallbackFun=this.inputFile_UploadCallback.bind(this),this.inputFile_CreateInputNode(t)}.bind(this))}});