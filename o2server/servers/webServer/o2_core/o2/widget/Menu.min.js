o2.widget=o2.widget||{},o2.widget.Menu=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",event:"contextmenu",disable:!1,top:-1,left:-1,container:null},initialize:function(t,e){this.setOptions(e),this.items=[],this.path=o2.session.path+"/widget/$Menu/",this.cssPath=o2.session.path+"/widget/$Menu/"+this.options.style+"/css.wcss",this._loadCss(),this.target=$(t),this.target&&(this.target.onselectstart=function(){return!1}),this.target&&(this.target.oncontextmenu=function(){return!1}),this.pauseCount=0},pause:function(t){this.pauseCount=t},load:function(){this.fireEvent("queryLoad")&&(this.node=new Element("div.MWFMenu"),this.node.set("styles",this.css.container),this.options.event&&this.target&&this.target.addEvent(this.options.event,this.showIm.bind(this)),this.node.inject(this.options.container||this.target),this.hide=this.hideMenu.bind(this),this.fireEvent("postLoad"))},setItemWidth:function(){this.items.each(function(t){this.node.getStyle("padding-left").toInt(),this.node.getStyle("padding-right").toInt(),this.node.getStyle("border-left-width").toInt(),this.node.getStyle("border-right-width").toInt(),t.item.getStyle("border-left-width").toInt(),t.item.getStyle("border-right-width").toInt(),t.item.getStyle("margin-left").toInt()}.bind(this))},setPosition:function(t){var e,i;e=-1==this.options.top?t.page.y:this.options.top,i=-1==this.options.left?t.page.x:this.options.left;var s=this.node.getSize(),n=this.node.getOffsetParent(),o=n.getSize();i+s.x>o.x&&(i=i-s.x-5)<0&&(i=0);var h=n.getScroll().y.toFloat()||0;e+s.y>o.y+h&&(e=e-s.y-5)<0&&(e=0),this.node.setStyle("top",e),this.node.setStyle("left",i);var u=this.node.getSize();this.nodeFrame||this.createIframeNode(),this.nodeFrame.setStyles({top:e,left:i,width:u.x+"px",height:u.y+"px"})},showIm:function(t){this.options.disable||(this.hide=this.hideIm.bind(this),this.fireEvent("queryShow",[t])&&(this.tmpBodyOncontextmenu=document.body.oncontextmenu,document.body.oncontextmenu=function(){return!1},this.pauseCount<=0?(this.setItemWidth(),this.node.setStyles({display:"block",opacity:this.options.opacity||1}),this.nodeFrame||this.createIframeNode(),this.nodeFrame.setStyles({display:"block",opacity:0}),this.setPosition(t),$(document.body).removeEvent("mousedown",this.hide),$(document.body).addEvent("mousedown",this.hide),this.show=!0):this.pauseCount--,this.fireEvent("postShow",[t])))},hideIm:function(t){if(this.fireEvent("queryHide")){if($(document.body).removeEvent("mousedown",this.hide),this.node.set("styles",{display:"none",opacity:0}),this.nodeFrame&&this.nodeFrame.set("styles",{display:"none",opacity:0}),this.show=!1,document.body.oncontextmenu=this.tmpBodyOncontextmenu,this.tmpBodyOncontextmenu=null,t){for(var e=this;e.topMenu;)e=e.topMenu;e.hideIm()}else this.items.each((function(t){"menu"==t.type&&t.subMenu.hideIm()}));this.fireEvent("postHide")}},createIframeNode:function(){this.nodeFrame||(this.nodeFrame=new Element("iframe"),this.nodeFrame.setStyles({border:"0px","z-index":"998",margin:"0px",padding:"0px",position:"absolute",display:"none",opacity:0})),this.nodeFrame.inject(this.options.container||this.target)},showMenu:function(t){this.show||(this.pauseCount<=0?this.options.disable||(this.hide=this.hideMenu.bind(this),this.fireEvent("queryShow",[t])&&(this.tmpBodyOncontextmenu=document.body.oncontextmenu,document.body.oncontextmenu=function(){return!1},this.node.setStyle("display","block"),this.nodeFrame||this.createIframeNode(),this.nodeFrame.setStyle("display","block"),this.setItemWidth(),this.setPosition(t),this.morph||(this.morph=new Fx.Morph(this.node,{duration:100})),this.morph.start({opacity:this.options.opacity||1}).chain(function(){$(document).removeEvent("click",this.hide),$(document).addEvent("click",this.hide),$(document).removeEvent("mousedown",this.hide),$(document).addEvent("mousedown",this.hide),this.show=!0,this.fireEvent("postShow")}.bind(this)))):this.pauseCount--)},hideMenu:function(){$(document).removeEvent("click",this.hide),this.show&&(this.morph||(this.morph=new Fx.Morph(this.node,{duration:100})),this.fireEvent("queryHide")&&this.morph.start({opacity:0}).chain(function(){this.node.set("styles",{display:"none"}),this.nodeFrame.set("styles",{display:"none"}),this.show=!1,document.body.oncontextmenu=this.tmpBodyOncontextmenu,this.tmpBodyOncontextmenu=null,this.fireEvent("postHide")}.bind(this)))},clearItems:function(){this.items.each((function(t){t.remove()})),this.items=[]},addMenuItem:function(t,e,i,s,n){var o=new o2.widget.MenuItem(this,{text:t,event:e,action:i,img:s,disable:n});return o.load(),this.items.push(o),o},addMenuMenu:function(t,e,i,s){var n=new o2.widget.MenuMenu(this,i,{text:t,img:e,disable:s});return n.load(),this.items.push(n),n},addMenuLine:function(){var t=new o2.widget.MenuLine(this);t.load(),this.items.push(t)},_loadToolbarItemNode:function(){this.node.getChildren().each(function(t,e){var i=t.get("MWFnodetype");i&&("array"==typeOf(this[i])||(this[i]=[]),this[i].push(t))}.bind(this))},_loadMenuItems:function(){this._loadToolBarSeparator(this.MWFToolBarMenuItem),this._loadToolBarButton(this.MWFToolBarMenuLine),this._loadToolBarMenu(this.MWFToolBarMenuItem)},_loadToolBarSeparator:function(t){t&&t.each(function(t,e){t.set("styles",this.css.toolbarSeparator)}.bind(this))},_loadToolBarButton:function(t){t&&t.each(function(t,e){var i=new o2.widget.ToolbarButton(t,this);i.load(),i.buttonID&&(this.items[i.buttonID]=i),this.children.push(i),this.childrenButton.push(i)}.bind(this))},_loadToolBarMenu:function(t){t&&t.each(function(t,e){var i=new o2.widget.ToolbarMenu(t,this);i.load(),i.buttonID&&(this.items[i.buttonID]=i),this.children.push(i),this.childrenMenu.push(i)}.bind(this))}}),o2.widget.MenuItem=new Class({Implements:[Options],options:{text:"",event:"",action:null,img:"",disable:!1},initialize:function(t,e){this.setOptions(e),this.menu=t,this.type="item",this.createNode()},createNode:function(){this.item=new Element("div",{styles:this.menu.css.menuItem});var t=new Element("div",{styles:this.menu.css.menuItemImgDiv}).inject(this.item);this.options.img&&("url"==this.options.img.substr(0,3)?new Element("div",{styles:this.menu.css.menuItemImg}).inject(t).setStyles({"background-size":"cover","background-image":this.options.img}):new Element("img",{styles:this.menu.css.menuItemImg,src:this.options.img}).inject(t));new Element("div",{styles:this.menu.css.menuItemSeparator}).inject(this.item);this.text=new Element("div",{styles:this.menu.css.menuItemText,text:this.options.text}).inject(this.item),this.options.event&&this.item.addEvent(this.options.event,this.doAction.bind(this)),this.setDisable(this.options.disable)},setText:function(t){this.options.text=t;var e=this.item.getLast("div");e&&e.set("text",t)},load:function(){this.item.inject(this.menu.node),this._addButtonEvent()},setDisable:function(t){var e,i;if(this.options.disable!=t)if(this.options.disable=t,t){if(this.item.set("styles",this.menu.css.menuItemDisable),(e=this.item.getElement("img"))&&"data:"!=(i=e.get("src")).substr(0,5)){var s=i.lastIndexOf(".");srcLeft=i.substr(0,s),srcRight=i.substr(s,i.length-s),i=srcLeft+"_gray"+srcRight,e.set("src",i)}}else this.item.set("styles",this.menu.css.menuItem),(e=this.item.getElement("img"))&&"data:"!=(i=e.get("src")).substr(0,5)&&(i=i.replace("_gray",""),e.set("src",i))},_addButtonEvent:function(){this.item.addEvent("mouseover",this._menuItemMouseOver.bind(this)),this.item.addEvent("mouseout",this._menuItemMouseOut.bind(this)),this.item.addEvent("mousedown",this._menuItemMouseDown.bind(this)),this.item.addEvent("mouseup",this._menuItemMouseUp.bind(this))},_menuItemMouseOver:function(t){this.menu.items.each(function(e){e!=this&&"line"!=e.type&&(e.options.disable||e._menuItemMouseOut(t))}.bind(this)),this.options.disable||(this.item.set("styles",this.menu.css.menuOver),this.menu.current=this)},_menuItemMouseOut:function(t){this.options.disable||this.item.set("styles",this.menu.css.menuOut)},_menuItemMouseDown:function(t){this.options.disable||this.item.set("styles",this.menu.css.menuDown),t.stopPropagation()},_menuItemMouseUp:function(t){this.options.disable||this.item.set("styles",this.menu.css.menuUp)},doAction:function(t){this.options.disable||(this.options.action&&this.options.action.apply(this,[t]),this.menu.hideIm(!0))},remove:function(){this.item.destroy()}}),o2.widget.MenuLine=new Class({initialize:function(t,e){this.type="line",this.menu=t,this.createNode()},createNode:function(){this.item=new Element("div",{styles:this.menu.css.menuLine})},load:function(){this.item.inject(this.menu.node)},remove:function(){this.item.destroy()},setDisable:function(){}}),o2.widget.MenuMenu=new Class({Implements:[Options],Extends:o2.widget.MenuItem,initialize:function(t,e,i){this.subMenu=e,this.parent(t,i),this.subMenu.topMenu=this.menu,this.type="menu",this.createIcon(),this.subMenu.setPosition=function(){this.setPosition()}.bind(this)},createIcon:function(){new Element("div",{styles:this.menu.css.menuItemSubmenuIcon}).inject(this.text,"before"),this.text.setStyle("margin-right","16px")},_menuItemMouseOver:function(t){this.menu.items.each(function(e){e!=this&&"line"!=e.type&&(e.options.disable||e._menuItemMouseOut(t))}.bind(this)),this.options.disable||(this.item.set("styles",this.menu.css.menuOver),this.menu.current=this),this.subMenu.showIm()},_menuItemMouseOut:function(t){t.event.toElement==this.subMenu.node||this.subMenu.node.contains(t.event.toElement)||(this.options.disable||this.item.set("styles",this.menu.css.menuOut),this.subMenu.hideIm())},setPosition:function(t){var e,i,s=this.item.getPosition(),n=this.item.getSize();this.subMenu.node.setStyle("display","block");var o=this.subMenu.node.getSize(),h=this.subMenu.node.getOffsetParent(),u=h.getSize();e=s.y,(i=s.x.toFloat()+n.x.toFloat()-3).toFloat()+o.x.toFloat()>u.x&&(i=s.x.toFloat()-o.x.toFloat()+8);var d=h.getScroll().y.toFloat()||0;e+o.y>u.y+d&&(e=e-o.y+n.y+3)<0&&(e=0),this.subMenu.options.offsetX&&(i+=this.subMenu.options.offsetX),this.subMenu.options.offsetY&&(e+=this.subMenu.options.offsetY);var m=this.menu.node.getStyle("z-index");this.subMenu.node.setStyle("z-index",m+1),this.subMenu.node.setStyle("top",e),this.subMenu.node.setStyle("left",i)}});