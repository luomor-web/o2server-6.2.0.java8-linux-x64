o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.widget.Tree",null,!1),o2.widget.TreeEditor=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",count:0,height:500,width:500,top:-1,left:-1,maxObj:document.body},initialize:function(t,e){this.setOptions(e),this.node=$(t),this.path=o2.session.path+"/widget/$TreeEditor/",this.cssPath=o2.session.path+"/widget/$TreeEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.container=new Element("div")},load:function(t){this.fireEvent("queryLoad")&&(this.container.set("styles",this.css.container),this.container.inject(this.node),this.createTitleNode(),this.createContent(t),this.fireEvent("postLoad"))},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,events:{dblclick:this.toggleSize.bind(this)}}).inject(this.container),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,events:{click:this.addTreeNode.bind(this)}}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode)},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container),this.json=t,this.resizeContentNodeSize(),this.tree=new o2.widget.TreeEditor.Tree(this,this.contentNode,{style:"editor"}),this.tree.treeJson=this.json,this.tree.load()},resizeContentNodeSize:function(){var t=this.titleNode.getSize(),e=this.container.getSize().y-t.y-2-6;this.contentNode.setStyle("min-height",e+"px")},addTreeNode:function(){if(this.tree){var t=Object.clone(this.tree.nodejson);this.json.push(t);var e=this.tree.appendChild(t);e.selectNode();var i=e.textNode.getElement("div");e.editItem(i)}},toggleSize:function(t){"max"==this.titleActionNode.retrieve("status","max")?this.maxSize():this.returnSize()},toJson:function(){return this.tree?this.tree.toJson(this.tree):{}}}),o2.widget.TreeEditor.Tree=new Class({Extends:o2.widget.Tree,nodejson:{expand:!0,title:"",text:"[none]",action:"",icon:"none"},initialize:function(t,e,i){this.parent(e,i),this.editor=t},appendChild:function(t){var e=new o2.widget.TreeEditor.Tree.Node(this,t);return this.children.length?(e.previousSibling=this.children[this.children.length-1],e.previousSibling.nextSibling=e):this.firstChild=e,e.load(),e.node.inject(this.node),this.children.push(e),e},expandOrCollapseNode:function(t){t.options.expand?(this.collapse(t),t.options.expand=!1):(this.expand(t),t.options.expand=!0),t.setOperateIcon(),this.editor.fireEvent("change")}}),o2.widget.TreeEditor.Tree.Node=new Class({Extends:o2.widget.Tree.Node,srciptOption:{width:300,height:300,top:null,left:null},initialize:function(t,e){this.parent(t,e),this.itemNode.addEvents({mouseover:function(){this.isEditScript||this.itemNode.setStyles(this.tree.css.treeItemNodeOver),this.showItemAction()}.bind(this),mouseout:function(){this.isEditScript||this.itemNode.setStyles(this.tree.css.treeItemNode),this.hideItemAction()}.bind(this)})},appendChild:function(t){this.options.sub||(this.options.sub=[]),this.options.sub.push(t);var e=new o2.widget.TreeEditor.Tree.Node(this.tree,t);return this.children.length?(e.previousSibling=this.children[this.children.length-1],e.previousSibling.nextSibling=e):(this.firstChild=e,this.setOperateIcon()),e.level=this.level+1,e.parentNode=this,e.load(),e.node.inject(this.childrenNode),this.children.push(e),e},doAction:function(t){var e=t.target;this.editItem(e)},hideItemAction:function(){this.actionNode&&this.actionNode.setStyle("display","none")},setActionPosition:function(){this.actionNode&&this.actionNode.position({relativeTo:this.itemNode,position:"rightCenter",edge:"rightCenter"})},showItemAction:function(){this.actionNode||this.createItemActionNode(),this.setActionPosition(),this.actionNode.setStyle("display","block")},createItemActionNode:function(){this.actionNode=new Element("div",{styles:this.tree.css.itemActionNode}).inject(this.itemNode);new Element("div",{styles:this.tree.css.itemDeleteActionNode,title:o2.LP.process.formAction.delete,events:{click:function(t){this.deleteItem(t)}.bind(this)}}).inject(this.actionNode),new Element("div",{styles:this.tree.css.itemScriptActionNode,title:o2.LP.process.formAction.script,events:{click:function(t){this.editScriptItem(t)}.bind(this)}}).inject(this.actionNode),new Element("div",{styles:this.tree.css.itemAddActionNode,title:o2.LP.process.formAction.add,events:{click:this.addChild.bind(this)}}).inject(this.actionNode)},getScriptDefaultPosition:function(t,e){var i=this.node.getPosition(),s=this.tree.node.getPosition(),o=this.node.getSize(),n=document.body.getSize(),r=s.x-t-10;r+t>n.x&&(r=n.x-t),r<0&&(r=0);var d=i.y-e/2+o.y/2;return d+e>n.y&&(d=n.y-e),d<0&&(d=0),{x:r,y:d}},createScriptNode:function(){this.scriptNode=new Element("div",{styles:this.tree.css.scriptNode}),o2.require("o2.widget.ScriptEditor",null,!1),this.scriptEditor=new o2.widget.ScriptEditor(this.scriptNode,{style:"process"})},completeScriptItem:function(){this.itemNode.setStyles(this.tree.css.treeItemNode),this.isEditScript=!1,this.tree.currentEditNode=null,this.scriptArea&&(this.scriptArea.treeEditorMorph||(this.scriptArea.treeEditorMorph=new Fx.Morph(this.scriptArea.container,{duration:200})),this.scriptArea.treeEditorMorph.start({height:"0",overflow:"auto"}).chain(function(){this.scriptArea.container.setStyle("display","none")}.bind(this)))},editScriptItem:function(t){if(this.tree.currentEditNode!=this){if(this.tree.currentEditNode&&this.tree.currentEditNode.completeScriptItem(),this.itemNode.setStyle("background","#DDD"),!this.scriptArea){var e=new Element("div").inject(this.itemNode,"after");o2.require("o2.widget.ScriptArea",function(){this.scriptArea=new o2.widget.ScriptArea(e,{title:o2.LP.process.formAction.script,maxObj:this.tree.editor.options.maxObj,style:"treeEditor",onChange:function(){this.options.action=this.scriptArea.toJson(),this.tree.editor.fireEvent("change")}.bind(this)}),this.options.action||(this.options.action={}),this.scriptArea.load(this.options.action),this.scriptArea.container.setStyles({overflow:"hidden",height:"0px"})}.bind(this))}this.scriptArea.container.setStyle("display","block"),this.scriptArea.treeEditorMorph||(this.scriptArea.treeEditorMorph=new Fx.Morph(this.scriptArea.container,{duration:200})),this.scriptArea.treeEditorMorph.start({height:"200px",overflow:"auto"}).chain(function(){this.scriptArea.container.scrollIntoView(),this.scriptArea.focus(),this.setActionPosition()}.bind(this)),this.isEditScript=!0,this.tree.currentEditNode=this}else this.completeScriptItem()},addChild:function(){var t=Object.clone(this.tree.nodejson);this.options.sub||(this.options.sub=[]),this.options.sub.push(t);var e=this.appendChild(t);this.options.expand||this.tree.expandOrCollapseNode(this),e.selectNode();var i=e.textNode.getElement("div");e.editItem(i)},deleteItem:function(t){var e=this,i=t.target.getPosition(),s={event:{x:i.x+40,y:i.y}};MWF.xDesktop.confirm("warn",s,o2.LP.process.notice.deleteTreeNodeTitle,o2.LP.process.notice.deleteTreeNode,300,120,(function(){e.destroy(),e.tree.editor.fireEvent("change"),this.close()}),(function(){this.close()}),null,null,"o2")},editItem:function(t,e){var i=t.get("text");t.set("html","");var s=new Element("div",{styles:this.tree.css.editInputDiv}),o=new Element("input",{styles:this.tree.css.editInput,type:"text",value:i}).inject(s),n=o2.getTextSize(i+"a").x;o.setStyle("width",n),s.setStyle("width",n),s.inject(t),o.select(),o.addEvents({keydown:function(t){var e=o2.getTextSize(o.get("value")+"a").x;t.target.setStyle("width",e),t.target.getParent().setStyle("width",e),13==t.code&&(this.isEnterKey=!0,t.target.blur())}.bind(this),blur:function(i){var s=this.editItemComplate(t,i.target);e&&e(s)}.bind(this),click:function(t){t.stopPropagation()}.bind(this)})},editItemComplate:function(t,e){var i=e.get("value");i||(i="[none]"),this.options.text=i;return this.isEnterKey&&(this.isNewItem&&!0,this.editOkAddNewItem=!1),this.isNewItem=!1,t.set("html",i),this.tree.editor.fireEvent("change"),!0}});