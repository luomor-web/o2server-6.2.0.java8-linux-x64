o2.widget=o2.widget||{},o2.xDesktop.requireApp("Template","widget.ColorPicker",null,!1),o2.widget.Tablet=o2.Tablet=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",path:o2.session.path+"/widget/$Tablet/",contentWidth:0,contentHeight:0,lineWidth:1,color:"#000000",tools:["save","|","undo","redo","|","size","color","|","image","imageClipper","|","reset","cancel"],description:"",action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",resultMaxSize:0},initialize:function(t,e,i){this.node=t,this.app=i,this.reset(),this.setOptions(e),this.path=this.options.path||o2.session.path+"/widget/$Tablet/",this.cssPath=this.path+this.options.style+"/css.wcss",this.lp={save:o2.LP.widget.save,reset:o2.LP.widget.empty,undo:o2.LP.widget.undo,redo:o2.LP.widget.redo,size:o2.LP.widget.thickness,color:o2.LP.widget.color,image:o2.LP.widget.insertImage,imageClipper:o2.LP.widget.imageClipper,cancel:o2.LP.widget.cancel},this._loadCss(),this.fireEvent("init")},load:function(){this.preDrawAry=[],this.nextDrawAry=[],this.middleAry=[],this.container=new Element("div.container",{styles:this.css.container}).inject(this.node),this.loadToolBar(),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.container),this.contentNode.addEvent("selectstart",(function(t){t.preventDefault(),t.stopPropagation()})),this.loadDescription(),this.setContentSize(),this.checkBroswer()&&this.loadContent(),this.app&&(this.resizeFun=this.setContentSize.bind(this),this.app.addEvent("resize",this.resizeFun))},loadDescription:function(){this.options.description&&(this.descriptionNode=new Element("div",{styles:this.css.descriptionNode,text:this.options.description}).inject(this.container))},setContentSize:function(){var t=this.node.getSize();if(this.contentWidth=this.options.contentWidth||t.x,this.contentWidth<100&&(this.contentWidth=100),this.contentNode.setStyle("width",this.contentWidth),this.options.contentHeight)this.contentHeight=this.options.contentHeight;else{var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},i=this.descriptionNode?this.descriptionNode.getSize():{x:0,y:0},s=this.toolbarNode?this.toolbarNode.getStyles("margin-top","margin-bottom","padding-top","padding-bottom","bordrt-top-width","bordrt-bottom-width"):null,o=s?s["margin-top"].toInt()+s["margin-bottom"].toInt()+s["padding-bottom"].toInt()+s["padding-top"].toInt()+(s["bordrt-top-width"].toInt()||0)+(s["bordrt-bottom-width"].toInt()||0):0,n=this.descriptionNode?this.descriptionNode.getStyles("margin-top","margin-bottom","padding-top","padding-bottom","bordrt-top-width","bordrt-bottom-width"):null,a=n?n["margin-top"].toInt()+n["margin-bottom"].toInt()+n["padding-bottom"].toInt()+n["padding-top"].toInt()+(n["bordrt-top-width"].toInt()||0)+(n["bordrt-bottom-width"].toInt()||0):0,h=this.contentNode.getStyles("margin-top","margin-bottom","padding-top","padding-bottom","bordrt-top-width","bordrt-bottom-width"),r=h["margin-top"].toInt()+h["margin-bottom"].toInt()+h["padding-bottom"].toInt()+h["padding-top"].toInt()+(h["bordrt-top-width"].toInt()||0)+(h["bordrt-bottom-width"].toInt()||0);this.contentHeight=t.y-e.y-i.y-o-a-r}if(this.contentHeight<150&&(this.contentHeight=150),this.contentNode.setStyle("height",this.contentHeight),this.canvasWrap&&this.canvasWrap.setStyles({width:this.contentWidth+"px",height:this.contentHeight+"px"}),this.canvas){var d=this.ctx.getImageData(0,0,this.canvas.clientWidth,this.canvas.clientHeight);this.canvas.set("width",this.contentWidth),this.canvas.set("height",this.contentHeight),this.ctx.putImageData(d,0,0)}},loadToolBar:function(){this.toolbarNode=new Element("div.toolbar",{styles:this.css.toolbar}).inject(this.container),this.toolbar=new o2.widget.Tablet.Toolbar(this,this.toolbarNode),this.toolbar.load()},storeToPreArray:function(){var t=this.ctx.getImageData(0,0,this.contentWidth,this.contentHeight);this.preDrawAry.push(t)},storeToMiddleArray:function(){var t=this.ctx.getImageData(0,0,this.contentWidth,this.contentHeight);0==this.nextDrawAry.length?this.middleAry.push(t):(this.middleAry=[],this.middleAry=this.middleAry.concat(this.preDrawAry),this.middleAry.push(t),this.nextDrawAry=[],this.toolbar.enableItem("redo")),this.preDrawAry.length&&(this.toolbar.enableItem("undo"),this.toolbar.enableItem("reset"))},loadContent:function(){this.canvasWrap=new Element("div.canvasWrap",{styles:this.css.canvasWrap}).inject(this.contentNode),this.canvasWrap.setStyles({width:this.contentWidth+"px",height:this.contentHeight+"px"}),this.canvas=new Element("canvas",{width:this.contentWidth,height:this.contentHeight}).inject(this.canvasWrap),this.ctx=this.canvas.getContext("2d");var t=this.ctx.getImageData(0,0,this.contentWidth,this.contentHeight);this.middleAry.push(t),this.canvas.ontouchstart=this.canvas.onmousedown=function(t){t=t||event;var e=this.ctx,i=(this.canvas,this.contentNode,this.canvasWrap.getPosition()),s=$(document);this.options.color&&(e.strokeStyle=this.currentColor||this.options.color),this.options.lineWidth&&(e.lineWidth=this.currentWidth||this.options.lineWidth),e.beginPath(),e.moveTo(t.clientX-i.x,t.clientY-i.y),this.storeToPreArray();var o=function(t){e.lineTo(t.client.x-i.x,t.client.y-i.y),e.stroke()};s.addEvent("mousemove",o),s.addEvent("touchmove",o);var n=function(t){s.removeEvent("mousemove",o),s.removeEvent("mouseup",n),s.removeEvent("touchmove",o),s.removeEvent("touchend",n),this.storeToMiddleArray(),e.closePath()}.bind(this);s.addEvent("mouseup",n),s.addEvent("touchend",n)}.bind(this)},uploadImage:function(t,e){var i=this.getImage(null,!0);if(i)if(this.options.action)this.action="string"==typeOf(this.options.action)?o2.Actions.get(action).action:this.options.action,this.action.invoke({name:this.options.method,async:!0,data:this.getFormData(i),file:i,parameter:this.options.parameter,success:function(e){t(e)}.bind(this)});else if(this.options.reference&&this.options.referenceType){var s=this.options.resultMaxSize;o2.xDesktop.uploadImageByScale(this.options.reference,this.options.referenceType,s,this.getFormData(i),i,t,e)}},getFormData:function(t){t||(t=this.getImage());var e=new FormData;return e.append("file",t,this.fileName),this.options.data&&Object.each(this.options.data,(function(t,i){e.append(i,t)})),e},getImage:function(t,e){var i=t||this.getBase64Code(e);i=window.atob(i);for(var s=new Uint8Array(i.length),o=0;o<i.length;o++)s[o]=i.charCodeAt(o);return new Blob([s],{type:this.fileType})},getBase64Code:function(t){this.ctx;var e=this.canvas;if(!t&&this.options.resultMaxSize){var i,s,o;s=(i=Math.min(this.contentWidth,this.options.resultMaxSize))/this.contentWidth*this.contentHeight,o=(o=e.toDataURL(this.fileType)).split(",")[1],o="data:"+this.fileType+";base64,"+o;var n=new Element("img",{width:this.contentWidth,height:this.contentHeight,src:o}),a=new Element("canvas",{width:i,height:s}).inject(this.contentNode),h=a.getContext("2d");h.drawImage(n,0,0,this.contentWidth,this.contentHeight,0,0,i,s);var r=a.toDataURL(this.fileType);return r=r.split(",")[1],n.destroy(),a.destroy(),h=null,r||""}return(o=(o=e.toDataURL(this.fileType)).split(",")[1])||""},getBase64Image:function(t,e){return t||(t=this.getBase64Code(e)),t?"data:"+this.fileType+";base64,"+t:null},close:function(){this.container.destroy()},checkBroswer:function(){return window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob?(this.available=!0,!0):(this.available=!1,this.container.set("html","<p>"+o2.LP.widget.explorerNotSupportFeatures+"</p><ul><li>canvas</li><li>Blob</li><li>Uint8Array</li><li>FormData</li><li>atob</li></ul>"),!1)},save:function(){var t=this.getBase64Code(),e=this.getImage(t),i=this.getBase64Image(t);this.fireEvent("save",[t,i,e])},reset:function(t){if(this.fileName="untitled.png",this.fileType="image/png",this.ctx){var e=this.canvas;this.ctx.clearRect(0,0,e.clientWidth,e.clientHeight)}},undo:function(t){if(this.preDrawAry.length>0){var e=this.preDrawAry.pop(),i=this.middleAry[this.preDrawAry.length+1];this.nextDrawAry.push(i),this.ctx.putImageData(e,0,0)}this.toolbar.setAllItemsStatus()},redo:function(t){if(this.nextDrawAry.length){var e=this.nextDrawAry.pop(),i=this.middleAry[this.middleAry.length-this.nextDrawAry.length-2];this.preDrawAry.push(i),this.ctx.putImageData(e,0,0)}this.toolbar.setAllItemsStatus()},size:function(t){this.sizeSelector||(this.sizeSelector=new o2.widget.Tablet.SizePicker(this.container,t,null,{},{onSelect:function(t){this.currentWidth=t}.bind(this)}))},color:function(t){this.colorSelector||(this.colorSelector=new o2.xApplication.Template.widget.ColorPicker(this.container,t,null,{},{lineWidth:1,onSelect:function(t){this.currentColor=t}.bind(this)}))},getImageSize:function(t,e){var i=t/e,s=this.contentWidth,o=this.contentHeight;if(t/parseInt(s)>e/parseInt(o)){var n=Math.min(t,parseInt(s));return{width:n,height:n/i}}var a=Math.min(e,parseInt(o));return{width:a*i,height:a}},parseFileToImage:function(t,e){var i=new Element("img"),s=function(){var t=i.naturalHeight,e=i.naturalWidth;isNaN(t)||isNaN(e)||0==t||0==e?setTimeout(function(){s()}.bind(this),100):o()},o=function(){var t=i.naturalHeight,s=i.naturalWidth,o=this.getImageSize(s,t);i.setStyles({width:o.width,height:o.height});var n=new o2.widget.Tablet.ImageMover(this,i,this.canvasWrap,{onPostOk:function(){var t=n.getCoordinage();this.storeToPreArray(),this.ctx.drawImage(i,t.left,t.top,t.width,t.height),this.storeToMiddleArray()}.bind(this)});n.load(),e&&e()}.bind(this),n=new FileReader;n.onload=function(){i.src=n.result,n=null,s()}.bind(this),n.readAsDataURL(t)},image:function(t){var e=new Element("div");e.set("html",'<input name="file" type="file" />');var i=e.getFirst();i.addEvent("change",function(){var t=i.files[0];this.parseFileToImage(t,(function(){e.destroy()}))}.bind(this)),i.click()},imageClipper:function(t){new o2.widget.Tablet.ImageClipper(this.app,{style:"default",aspectRatio:0,onOk:function(t){this.parseFileToImage(t)}.bind(this)}).load()},clear:function(t){},cancel:function(){this.reset(),this.fireEvent("cancel")}}),o2.widget.Tablet.Toolbar=new Class({Implements:[Options,Events],initialize:function(t,e){this.tablet=t,this.container=e,this.css=t.css,this.lp=this.tablet.lp,this.imagePath=o2.session.path+"/widget/$Tablet/"+this.tablet.options.style+"/icon/",this.items={},this.itemsEnableFun={save:{enable:function(){return!0}},reset:{enable:function(){return this.tablet.preDrawAry.length>0}.bind(this)},undo:{enable:function(){return this.tablet.preDrawAry.length>0}.bind(this)},redo:{enable:function(){return this.tablet.nextDrawAry.length>0}.bind(this)},size:{enable:function(){return!0}},color:{enable:function(){return!0}},image:{enable:function(){return!0}},imageClipper:{enable:function(){return!0}}}},getHtml:function(){var t=this.tablet.options.tools,e="",i="toolItem";return(t||["save","|","reset","|","undo","|","redo","|","size","|","color","|","image","|","imageClipper"]).each(function(t){switch(t){case"|":e+="<div styles='separator'></div>";break;case"save":e+="<div item='save' styles='"+i+"'>"+this.lp.save+"</div>";break;case"reset":e+="<div item='reset' styles='"+i+"'>"+this.lp.reset+"</div>";break;case"undo":e+="<div item='undo' styles='"+i+"'>"+this.lp.undo+"</div>";break;case"redo":e+="<div item='redo' styles='"+i+"'>"+this.lp.redo+"</div>";break;case"size":e+="<div item='size' styles='"+i+"'>"+this.lp.size+"</div>";break;case"color":e+="<div item='color' styles='"+i+"'>"+this.lp.color+"</div>";break;case"image":e+="<div item='image' styles='"+i+"'>"+this.lp.image+"</div>";break;case"imageClipper":e+="<div item='imageClipper' styles='"+i+"'>"+this.lp.imageClipper+"</div>";break;case"clear":e+="<div item='clear' styles='"+i+"'>"+this.lp.clear+"</div>";break;case"cancel":e+="<div item='cancel' styles='toolRightItem'>"+this.lp.cancel+"</div>"}}.bind(this)),e},load:function(){var t=this,e=this.imagePath;this.items={};var i=this.getHtml();this.container.set("html",i),this.container.getElements("[styles]").each(function(i){i.setStyles(t.css[i.get("styles")]);var s=i.get("item");s&&(this.items[s]=i,i.setStyle("background-image","url("+e+s+"_normal.png)"),i.addEvents({mouseover:function(){t._setItemNodeActive(this.el)}.bind({item:s,el:i}),mouseout:function(){t._setItemNodeNormal(this.el)}.bind({item:s,el:i}),click:function(e){t.tablet[this.item]&&t.tablet[this.item](this.el)}.bind({item:s,el:i})}),"color"!=s&&"size"!=s||t.tablet[s]&&t.tablet[s](i))}.bind(this)),this.setAllItemsStatus()},setAllItemsStatus:function(){for(var t in this.items){this.items[t];this.itemsEnableFun[t]&&(this.itemsEnableFun[t].enable()?this.enableItem(t):this.disableItem(t))}},disableItem:function(t){var e=this.items[t];e.store("status","disable"),this._setItemNodeDisable(e)},enableItem:function(t){var e=this.items[t];e.store("status","enable"),this._setItemNodeNormal(e)},_setItemNodeDisable:function(t){var e=t.get("item");t.setStyles(this.css.toolItem_disable),t.setStyle("background-image","url("+this.imagePath+e+"_disable.png)")},_setItemNodeActive:function(t){if("disable"!=t.retrieve("status")){var e=t.get("item");t.setStyles(this.css.toolItem_over),t.setStyle("background-image","url("+this.imagePath+e+"_active.png)")}},_setItemNodeNormal:function(t){if("disable"!=t.retrieve("status")){var e=t.get("item"),i=t.get("styles");t.setStyles(this.css[i]),t.setStyle("background-image","url("+this.imagePath+e+"_normal.png)")}}}),o2.xDesktop.requireApp("Template","MTooltips",null,!1),o2.widget.Tablet.SizePicker=new Class({Implements:[Options,Events],Extends:MTooltips,options:{style:"default",axis:"y",position:{x:"auto",y:"auto"},nodeStyles:{"min-width":"260px"},lineWidth:1},initialize:function(t,e,i,s,o,n){o&&this.setOptions(o),this.container=t,this.target=e,this.targetCoordinates=n,this.app=i,i&&(this.lp=i.lp),this.data=s,this.target&&this.setTargetEvents()},_customNode:function(t){o2.UD.getDataJson("sizePicker",function(t){this.rulerContainer=new Element("div",{styles:{"margin-left":" 23px","margin-right":" 1px",width:"228px"}}).inject(this.node),this.ruleList=["0.1","0.5","1","5","10","15","20"],this.rulerTitleContainer=new Element("div",{styles:{overflow:"hidden"}}).inject(this.rulerContainer),this.ruleList.each(function(t){new Element("div",{text:t,styles:{width:"32px",float:"left","text-align":"center"}}).inject(this.rulerTitleContainer)}.bind(this)),this.rulerContentContainer=new Element("div",{styles:{overflow:"hidden"}}).inject(this.rulerContainer),new Element("div",{styles:{width:"14px",height:"10px","text-align":"center",float:"left","border-right":"1px solid #aaa"}}).inject(this.rulerContentContainer),this.ruleList.each(function(t,e){e!=this.ruleList.length-1&&new Element("div",{styles:{width:"32px",height:"10px","text-align":"center",float:"left","border-right":"1px solid #aaa"}}).inject(this.rulerContentContainer)}.bind(this)),this.silderContainer=new Element("div",{height:"25px","line-height":"25px","margin-top":"4px"}).inject(this.node),this.sliderArea=new Element("div",{styles:{"margin-top":"2px","margin-bottom":"10px",height:"10px",overflow:" hidden","margin-left":" 37px","margin-right":" 15px","border-top":"1px solid #999","border-left":"1px solid #999","border-bottom":"1px solid #E1E1E1","border-right":"1px solid #E1E1E1","background-color":"#EEE",width:"200px"}}).inject(this.silderContainer),this.sliderKnob=new Element("div",{styles:{height:"8px",width:" 8px","background-color":"#999","z-index":" 99","border-top":"1px solid #DDD","border-left":"1px solid #DDD","border-bottom":"1px solid #777","border-right":"1px solid #777",cursor:"pointer"}}).inject(this.sliderArea),this.slider=new Slider(this.sliderArea,this.sliderKnob,{range:[1,30],initialStep:10,onChange:function(t){this.lineWidth=t<10?t/10:t-9,this.drawPreview(this.lineWidth),this.fireEvent("select",this.lineWidth)}.bind(this)});new Element("div").inject(this.node);new Element("div",{text:o2.LP.widget.preview,styles:{float:"left","margin-top":"5px",width:"30px"}}).inject(this.silderContainer),this.previewNode=new Element("div",{styles:{margin:"0px 0px 0px 37px",width:"200px"}}).inject(this.node),this.canvas=new Element("canvas",{width:200,height:30}).inject(this.previewNode),this.ctx=this.canvas.getContext("2d"),this.drawPreview(),new Element("button",{text:o2.LP.widget.reset,type:"button",styles:{"margin-left":"40px","font-size":"12px","border-radius":"3px",cursor:"pointer",border:"1px solid #ccc",padding:"5px 10px","background-color":"#f7f7f7"},events:{click:function(){var t;this.lineWidth=this.options.lineWidth||1,t=this.lineWidth<1?10*this.lineWidth:this.lineWidth+9,this.slider.set(parseInt(t)),this.drawPreview(this.lineWidth),this.fireEvent("select",this.lineWidth)}.bind(this)}}).inject(this.node)}.bind(this))},drawPreview:function(t){t||(t=this.options.lineWidth||1);var e=this.canvas,i=this.ctx;i.clearRect(0,0,e.clientWidth,e.clientHeight);this.previewNode.getCoordinates(),$(document);i.strokeStyle="#000000",i.lineWidth=t,i.beginPath(),i.moveTo(1,15),i.lineTo(200,15),i.stroke()}}),MWF.require("MWF.widget.ImageClipper",null,!1),o2.widget.Tablet.ImageClipper=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{imageUrl:"",resultMaxSize:800,description:"",title:o2.LP.widget.imageClipper,style:"default",aspectRatio:0},initialize:function(t,e){this.setOptions(e),this.app=t,this.path="../x_component_process_Xform/widget/$ImageClipper/",this.cssPath="../x_component_process_Xform/widget/$ImageClipper/"+this.options.style+"/css.wcss",this._loadCss()},load:function(t){this.data=t;var e={},i="700",s="510";i=i.toInt(),s=s.toInt();var o=(this.app&&this.app.content||$(document.body)).getSize(),n=(o.x-i)/2,a=(o.y-s)/2;n<0&&(n=0),a<0&&(a=0),layout.mobile&&(n=20,a=0);var h=this;MWF.require("MWF.xDesktop.Dialog",function(){var t=new MWF.xDesktop.Dialog({title:this.options.title||"Select Image",style:e.style||"user",top:a,left:n-20,fromTop:a,fromLeft:n-20,width:i,height:s,html:"<div></div>",maskNode:this.app?this.app.content:$(document.body),container:this.app?this.app.content:$(document.body),buttonList:[{text:MWF.LP.process.button.ok,action:function(){var t=h.image.getResizedImage();h.fireEvent("ok",[t]),this.close()}},{text:MWF.LP.process.button.cancel,action:function(){this.close()}}],onPostShow:function(){this.node.setStyle("z-index",1003),this.content.setStyle("margin-left","20px")}});t.show(),this.image=new MWF.widget.ImageClipper(t.content.getFirst(),{description:this.options.description,resetEnable:!0}),this.image.load(this.data)}.bind(this))}}),o2.widget.Tablet.ImageMover=new Class({Implements:[Options,Events],options:{imageMinSize:100},initialize:function(t,e,i,s){this.setOptions(s),this.tablet=t,this.imageNode=e,this.relativeNode=i,this.path=this.tablet.path+this.tablet.options.style+"/"},load:function(){this.maskNode=new Element("div.maskNode",{styles:{width:"100%",height:"100%",opacity:.6,position:"absolute","background-color":"#CCC",top:"0px",left:"0px","z-index":1002,"-webkit-user-select":"none","-moz-user-select":"none","user-select":"none"}}).inject($(document.body));var t=this.relativeNode.getCoordinates();this.node=new Element("div",{styles:{width:t.width,height:t.height,position:"absolute",top:t.top,left:t.left,background:"rgba(255,255,255,0.5)","z-index":1003,"-webkit-user-select":"none","-moz-user-select":"none","user-select":"none"}}).inject($(document.body)),this.dragNode=new Element("div",{styles:{cursor:"move"}}).inject(this.node),this.imageNode.inject(this.dragNode),this.originalImageSize=this.imageNode.getSize(),this.dragNode.setStyles({width:this.originalImageSize.x,height:this.originalImageSize.y}),this.okNode=new Element("div",{styles:{background:"url("+this.path+"icon/ok.png) no-repeat",width:"16px",height:"16px",right:"-20px",top:"5px",position:"absolute",cursor:"pointer"},events:{click:function(){this.ok(),this.close()}.bind(this)}}).inject(this.dragNode),this.cancelNode=new Element("div",{styles:{background:"url("+this.path+"icon/cancel.png) no-repeat",width:"16px",height:"16px",right:"-20px",top:"30px",position:"absolute",cursor:"pointer"},events:{click:function(){this.close()}.bind(this)}}).inject(this.dragNode),this.drag=this.dragNode.makeDraggable({container:this.node,handle:this.dragNode}),this.reizeNode=new Element("div.reizeNode",{styles:{cursor:"nw-resize",position:"absolute",bottom:"0px",right:"0px",border:"2px solid #52a3f5",width:"8px",height:"8px"}}).inject(this.dragNode),this.docBody=window.document.body,this.reizeNode.addEvents({touchstart:function(t){this.drag.detach(),this.dragNode.setStyle("cursor","nw-resize"),this.docBody.setStyle("cursor","nw-resize"),this.resizeMode=!0,this.getOffset(t),t.stopPropagation()}.bind(this),mousedown:function(t){this.drag.detach(),this.dragNode.setStyle("cursor","nw-resize"),this.docBody.setStyle("cursor","nw-resize"),this.resizeMode=!0,this.getOffset(t),t.stopPropagation()}.bind(this),touchmove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeDragNode(e),t.stopPropagation()}}.bind(this),mousemove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeDragNode(e),t.stopPropagation()}}.bind(this),touchend:function(t){this.drag.attach(),this.dragNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1,this.lastPoint=null,t.stopPropagation()}.bind(this),mouseup:function(t){this.drag.attach(),this.dragNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1,this.lastPoint=null,t.stopPropagation()}.bind(this)}),this.bodyMouseMoveFun=this.bodyMouseMove.bind(this),this.docBody.addEvent("touchmove",this.bodyMouseMoveFun),this.docBody.addEvent("mousemove",this.bodyMouseMoveFun),this.bodyMouseEndFun=this.bodyMouseEnd.bind(this),this.docBody.addEvent("touchend",this.bodyMouseEndFun),this.docBody.addEvent("mouseup",this.bodyMouseEndFun)},bodyMouseMove:function(t){if(this.lastPoint&&this.resizeMode){var e=this.getOffset(t);this.resizeDragNode(e)}},bodyMouseEnd:function(t){this.lastPoint=null,this.resizeMode&&(this.drag.attach(),this.dragNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1)},resizeDragNode:function(t){var e=t.x;if(0!=e){var i=t.y;if(0!=i){var s,o,n=this.dragNode.getCoordinates(this.node),a=this.node.getSize(),h=n.top,r=n.left,d=a.x,l=a.y,c=this.originalImageSize.x/this.originalImageSize.y;if(Math.abs(e)/Math.abs(i)>c){if(e+n.width+r>d)return;if((o=(s=e+n.width)/c)+h>l)return}else{if(i+n.height+h>l)return;if((s=(o=i+n.height)*c)+r>d)return}var p=this.options.imageMinSize,g=this.options.imageMinSize;s=s<p?p:s,o=o<g?g:o,this.dragNode.setStyles({width:s+"px",height:o+"px"}),this.imageNode.setStyles({width:s+"px",height:o+"px"})}}},getOffset:function(t){var e,i;if((t=t.event).touches){var s=t.touches[0];e=s.clientX,i=s.clientY}else e=t.clientX,i=t.clientY;this.lastPoint||(this.lastPoint={x:e,y:i});var o={x:e-this.lastPoint.x,y:i-this.lastPoint.y};return this.lastPoint={x:e,y:i},o},getCoordinage:function(){return this.imageNode.getCoordinates(this.node)},ok:function(){this.fireEvent("postOk")},close:function(){this.docBody.removeEvent("touchmove",this.bodyMouseMoveFun),this.docBody.removeEvent("mousemove",this.bodyMouseMoveFun),this.docBody.removeEvent("touchend",this.bodyMouseEndFun),this.docBody.removeEvent("mouseup",this.bodyMouseEndFun),this.maskNode.destroy(),this.node.destroy()}});