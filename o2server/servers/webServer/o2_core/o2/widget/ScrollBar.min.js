o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.ScrollBar=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{distance:50,style:"default",isShow:!1,where:"before",indent:!0,offset:{V:{x:0,y:0},H:{x:0,y:0}}},scrollEvent:function(t){var o=t.scrollTop.toFloat(),e=t.scrollLeft.toFloat();this.fireEvent("scroll",[o,e])},initialize:function(t,o){if(COMMON.Browser.Platform.isMobile)return t.setStyle("overflow","auto"),t.addEvent("scroll",function(){this.scrollEvent(t)}.bind(this)),!0;this.node=$(t),this.setOptions(o),this.path=o2.session.path+"/widget/$ScrollBar/",this.cssPath=o2.session.path+"/widget/$ScrollBar/"+this.options.style+"/css.wcss",this._loadCss(),this.checkScrollFun=function(t){this.checkScroll()}.bind(this),this.checkScrollStopFun=function(t){this.checkScroll(),t.stopPropagation()}.bind(this),layout.desktop&&layout.desktop.addEvent&&layout.desktop.addEvent("resize",this.checkScrollFun),this.node.addEvent("mouseover",this.checkScrollStopFun),this.node.addEvent("mouseout",this.checkScrollStopFun),this.checkScrollShow(),this.checkScrollShowFun=function(t){this.checkScrollShow(t)}.bind(this),document.body.addEvent("mousemove",this.checkScrollShowFun)},checkScrollShow:function(t){if(!this.node.isPointIn)return!1;if(this.scrollVAreaNode&&(0==this.scrollVAreaNode.getStyle("opacity")&&!this.scrollAreaOverLock&&!this.scrollAreaOutLock)){this.scrollAreaOverLock=!0;var o=this.node.getStyle("margin-right").toFloat();if(this.options.indent)new Fx.Tween(this.node,{property:"margin-right",duration:"100"}).start(o+this.scrollVWidth).chain(function(){this.scrollVAreaNode.setStyle("display","block"),new Fx.Tween(this.scrollVAreaNode,{property:"opacity",duration:"100"}).start(0,1).chain(function(){this.scrollAreaOverLock=!1}.bind(this))}.bind(this));else this.scrollVAreaNode.setStyle("display","block"),new Fx.Tween(this.scrollVAreaNode,{property:"opacity",duration:"100"}).start(0,1).chain(function(){this.scrollAreaOverLock=!1}.bind(this))}},setScrollNodePosition:function(){if(this.node.scrollTo(0,0),this.scrollVNode&&(this.scrollVNode.setStyle("margin-top","0px"),this.setScrollVNodeMoveLimit()),this.scrollHNode){var t=this.scrollHNode.getSize().y;t=0-t+this.options.offset.H.y;var o=0+this.options.offset.H.x;this.scrollHNode.setStyle("margin-left",o+"px"),this.scrollHNode.setStyle("margin-top",t+"px")}},setScrollVNodeMove:function(){this.scrollVAreaNode.addEvent("click",(function(t){t.stopPropagation()})),this.scrollVNodeMove=new Drag(this.scrollVNode,{onStart:function(t,o){this.fireEvent("scrollStart");var e=o.event.clientX,s=o.event.clientY;t.store("position",{x:e,y:s}),t.store("margin",t.getStyle("margin-top")),this.showScrollBar=!0}.bind(this),onComplete:function(t){this.showScrollBar=!1,this.fireEvent("scrollComplete")}.bind(this),onDrag:function(t,o){var e=t.retrieve("position"),s=t.retrieve("margin").toFloat()+(o.event.clientY.toFloat()-e.y.toFloat()),i=(this.node.getScrollSize(),this.node.getSize()),l=this.scrollVNode.getSize(),r=i.y.toFloat()-l.y.toFloat();s<0&&(s=0),s>r&&(s=r),this.scrollVNode.setStyle("margin-top",s+"px"),this.scroll(null,s)}.bind(this)})},setScrollVNodeMoveLimit:function(){var t=this.nodePosition.x.toFloat()+this.clientSize.x.toFloat(),o=this.nodePosition.y.toFloat(),e=o+this.clientSize.y.toFloat()-this.scrollVNodeSize.y.toFloat();this.scrollVNodeMove.detach(),this.scrollVNodeMove.setOptions({limit:{x:[t,t],y:[o,e]}}),this.scrollVNodeMove.attach()},scroll:function(t,o){var e=this.node.getScrollSize(),s=this.node.getSize(),i=this.scrollVNode.getSize(),l=e.y-s.y,r=s.y.toFloat()-i.y.toFloat();if(t){var n=this.node.getScroll().y.toFloat()+t.toFloat();n<0&&(n=0),n>l&&(n=l),this.fireEvent("scroll",[n]),this.node.tweenScroll(n,1),(h=n/l.toFloat()*r.toFloat())<0&&(h=0),h>r&&(h=r),this.scrollVNode.setStyle("margin-top",h+"px")}if(o){o>r&&(o=r);var h=o/r*l;this.node.getScroll();this.node.tweenScroll(h,1),this.fireEvent("scroll",[h])}},checkScroll:function(){var t=this.node.getScrollSize(),o=this.node.getSize();this.node.getPosition(this.node.getOffsetParent());if(this.mousewheel||(this.mousewheel=function(t){var e=1-t.event.wheelDelta,s=this.options.distance.toFloat()/100*o.y.toFloat();e=e/o.y.toFloat()*s,this.scroll(e,null),t.stopPropagation()}.bind(this)),this.domMousewheel||(this.domMousewheel=function(t){var e=t.detail;e=e/6*(this.options.distance.toFloat()/100*o.y.toFloat()),this.scroll(e,null),t.stopPropagation()}.bind(this)),this.touchmove||(this.touchmove=function(t){var e=t.event.detail,s=this.options.distance.toFloat()/100*o.y.toFloat();e=e/o.y.toFloat()*s,this.scroll(e,null),t.preventDefault(),t.stopPropagation()}.bind(this)),t.y>o.y){if(!this.scrollVNode){this.scrollVAreaNode=new Element("div",{styles:this.css.scrollVAreaNode}).inject(this.node,this.options.where),this.scrollVNode=new Element("div",{styles:this.css.scrollVNode}).inject(this.scrollVAreaNode);var e=this.node.getStyle("margin-right").toFloat(),s=this.node.getStyle("margin-top").toFloat();this.node.getStyle("margin-bottom").toFloat(),this.scrollVAreaNode.getSize();this.options.indent&&this.scrollVAreaNode.setStyle("margin-right",e),this.scrollVAreaNode.setStyle("margin-top",s),this.scrollVAreaNode.setStyle("display","none"),this.scrollVWidth=this.scrollVAreaNode.getStyle("width").toFloat(),this.setScrollVNodeMove(),this.isAddEvent||(this.node.addEvent("mousewheel",this.mousewheel),this.node.addEvent("touchmove",this.touchmove),"firefox"==Browser.name&&this.node.addEventListener("DOMMouseScroll",this.domMousewheel,!1),this.isAddEvent=!0)}"absolute"==this.scrollVAreaNode.getStyle("position")&&this.scrollVAreaNode.position({relativeTo:this.node,position:"topright",edge:"topleft"}),this.scrollVAreaNode.setStyle("height",o.y)}else{if(this.scrollVNode)if(!this.scrollAreaOutLock&&!this.scrollAreaOverLock)if(!this.showScrollBar)this.scrollAreaOutLock=!0,new Fx.Tween(this.scrollVAreaNode,{property:"opacity",duration:"100"}).start(0).chain(function(){var t=this.node.getStyle("margin-right").toFloat();(this.scrollVAreaNode.setStyle("display","none"),this.options.indent)?new Fx.Tween(this.node,{property:"margin-right",duration:"100"}).start(t-this.scrollVWidth).chain(function(){this.scrollAreaOutLock=!1,this.scrollVAreaNode.destroy(),this.scrollVNode=null,this.scrollVAreaNode=null}.bind(this)):(this.scrollAreaOutLock=!1,this.scrollVAreaNode.destroy(),this.scrollVNode=null,this.scrollVAreaNode=null)}.bind(this));this.node.removeEvent("touchmove",this.touchmove),"firefox"==Browser.name&&this.node.removeEventListener("DOMMouseScroll",this.domMousewheel,!1)}},destroy:function(){this.checkScrollFun&&layout.desktop.removeEvent("resize",this.checkScrollFun),this.checkScrollStopFun&&this.node.removeEvent("mouseover",this.checkScrollStopFun),this.checkScrollStopFun&&this.node.removeEvent("mouseout",this.checkScrollStopFun),this.checkScrollShowFun&&document.body.removeEvent("mousemove",this.checkScrollShowFun),this.mousewheel&&this.node.removeEvent("mousewheel",this.mousewheel),this.touchmove&&this.node.removeEvent("touchmove",this.touchmove),"firefox"==Browser.name&&this.domMousewheel&&this.node.removeEventListener("DOMMouseScroll",this.domMousewheel,!1),this.scrollVAreaNode&&this.scrollVAreaNode.destroy(),this.scrollVNode&&this.scrollVNode.destroy(),o2.release(this)}});