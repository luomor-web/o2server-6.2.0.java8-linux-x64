o2.widget=o2.widget||{},o2.widget.AttachmentSelector=o2.widget.ATTSER=new Class({Extends:o2.widget.AttachmentController,Implements:[Options,Events],options:{style:"default",listStyle:"icon",selectType:"all",size:"max",resize:!1,attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,isSizeChange:!1,readonly:!1,images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"]},initialize:function(t,e,i){this.setOptions(i),this.pages=[],this.path=o2.session.path+"/widget/$AttachmentSelector/",this.cssPath=o2.session.path+"/widget/$AttachmentSelector/"+this.options.style+"/css.wcss",this._loadCss(),o2.getJSON("../x_component_File/$Main/icon.json",function(t){this.icons=t}.bind(this),!1,!1),this.module=e,this.actions=[],this.attachments=[],this.selectedAttachments=[],this.container=$(t)},load:function(){this.markNode=new Element("div",{styles:this.css.markNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.container),this.node=new Element("div",{styles:this.css.container}),this.fiterByExtension(this.attachments),"min"==this.options.size?this.loadMin():this.loadMax(),this.node.inject(this.markNode,"after"),this.node.fade("in"),this.setNodeSize();var t=this.container.getSize(),e=this.node.getSize();this.node.makeDraggable({handle:this.titleNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})},close:function(){this.node.destroy(),this.markNode.destroy()},fiterByExtension:function(t){var e=this.options[this.options.selectType];if(e){for(var i=[];t.length;){var s=t.shift();e.contains(s.extension)&&i.push(s)}t=i}return t},loadMax:function(){this.node||(this.node=new Element("div",{styles:this.css.container})),this.topNode?(this.contentScrollNode.setStyle("display","block"),this.bottomNode&&this.bottomNode.setStyle("display","block"),this.titleNode&&this.titleNode.setStyle("display","block"),this.topNode.setStyle("display","block"),this.content.empty()):(this.createTopNode(),this.createContentNode(),this.createBottomToolbarNode(),this.options.resize&&(this.createBottomNode(),this.createResizeNode()),this.node.inject(this.container),this.checkActions(),this.setEvent());for(var t=[];this.attachments.length;){var e=this.attachments.shift();t.push(new o2.widget.AttachmentSelector.Attachment(e.data,this))}this.attachments=t},loadMin:function(){this.node||(this.node=new Element("div",{styles:this.css.container_min})),this.minActionAreaNode?(this.minActionAreaNode.setStyle("display","block"),this.minContent.setStyle("display","block"),this.minContent.empty()):(this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node),this.minContent=new Element("div",{styles:this.css.minContentNode}).inject(this.node),this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)),this.createSeparate(this.minActionAreaNode),this.sizeAction=this.createAction(this.minActionAreaNode,"max",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this)),this.node.inject(this.container),this.checkActions(),this.setEvent());for(var t=[];this.attachments.length;){var e=this.attachments.shift();t.push(new o2.widget.AttachmentSelector.AttachmentMin(e.data,this))}this.attachments=t},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode),this.titleActionNode.addEvent("click",function(){this.close()}.bind(this)))),this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node),this.createEditGroupActions(),this.createReadGroupActions(),this.createListGroupActions(),this.createViewGroupActions()},addAttachment:function(t){this.fiterByExtension([t]).length>0&&("min"==this.options.size?this.attachments.push(new o2.widget.AttachmentSelector.AttachmentMin(t,this)):this.attachments.push(new o2.widget.AttachmentSelector.Attachment(t,this)))},selectAttachment:function(t,e,i){i&&this.module&&this.module.selectAttachment(t,e,i),this.close()},createBottomToolbarNode:function(){this.bottomToolbarNode=new Element("div",{styles:this.css.bottomToolbarNode}).inject(this.node),this.cancelButton=new Element("div",{styles:this.css.cancelButton,text:o2.LP.widget.cancel}).inject(this.bottomToolbarNode),this.cancelButton.addEvent("click",function(){this.close()}.bind(this)),this.okButton=new Element("div",{styles:this.css.okButton,text:o2.LP.widget.ok}).inject(this.bottomToolbarNode),this.okButton.addEvent("click",function(){this.selectedAttachments.length&&this.selectAttachment(null,null,this.selectedAttachments),this.close()}.bind(this))},setNodeSize:function(t,e){e=e||"50%","string"==typeof(t=t||"50%")&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(window.screen.width*parseInt(t,10)/100,10)),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(window.screen.height*parseInt(e,10)/100,10)),700>t&&(t=700),420>e&&(e=420);var i=parseInt((window.screen.height-e)/2,10),s=parseInt((window.screen.width-t)/2,10);this.node.setStyles({width:t+"px",height:e+"px",top:i+"px",left:s+"px"});var n=e-(this.titleNode?this.titleNode.getSize().y:0)-(this.topNode?this.topNode.getSize().y:0)-(this.bottomToolbarNode?this.bottomToolbarNode.getSize().y:0)-(this.bottomNode?this.bottomNode.getSize().y:0);this.contentScrollNode.setStyles({height:n+"px"})}}),o2.widget.AttachmentSelector.Attachment=new Class({Extends:o2.widget.AttachmentController.Attachment,Implements:[Options,Events],load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview()}this.createInforNode(function(){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},zIndex:10013,attach:this.node,transition:"flyin"})}.bind(this)),this.setEvent()},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.selectAttachment(t)}.bind(this)})},selectAttachment:function(t){this.controller.selectAttachment(t,null,[this])}}),o2.widget.AttachmentSelector.AttachmentMin=new Class({Extends:o2.widget.AttachmentController.AttachmentMin,setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css.minAttachmentNode_list_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css.minAttachmentNode_list)}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.selectAttachment(t)}.bind(this)})},selectAttachment:function(t){this.controller.selectAttachment(t,null,[this])}});