o2.widget=o2.widget||{},o2.require("o2.xDesktop.UserData",null,!1),o2.widget.JavascriptEditor=new Class({Implements:[Options,Events],options:{type:"monaco",forceType:null,title:"JavascriptEditor",style:"default",option:{value:"",mode:"javascript",lineNumbers:!0},runtime:"all"},initialize:function(t,e){this.setOptions(e),this.unbindEvents=[],this.node=$(t),this.id=o2.uuid(),o2.JSEditorCWE.isInit||o2.JSEditorCWE.init()},getDefaultEditorData:function(){switch(this.options.type){case"ace":return{javascriptEditor:{theme:"tomorrow",fontSize:"12px"}};case"monaco":return{javascriptEditor:{monaco_theme:"vs",fontSize:"12px"}}}},getEditorTheme:function(t){o2.editorData?t&&t():o2.UD.getData("editor",function(e){e.data?o2.editorData=JSON.decode(e.data):o2.editorData=this.getDefaultEditorData(),t&&t()}.bind(this))},load:function(t){this.getEditorTheme(function(e){for(this.options.type=this.options.forceType||o2.editorData.javascriptEditor.editor||"monaco","ace"==this.options.type.toLowerCase()&&this.loadAce(t),"monaco"==this.options.type.toLowerCase()&&this.loadMonaco(t),"codeMirror"==this.options.type.toLowerCase()&&this.loadCodeMirror(t);this.unbindEvents.length;){var i=this.unbindEvents.shift();this.addEditorEvent(i.name,i.fun)}}.bind(this))},loadMonacoEditor:function(t){window.monaco?t&&t():o2.load("monaco",{sequence:!0},function(){require.config({paths:{vs:"../o2_lib/vs"}}),require(["vs/editor/editor.main"],(function(){t&&t()}))}.bind(this))},loadMonaco:function(t){o2.editorData.javascriptEditor?(this.theme=o2.editorData.javascriptEditor.monaco_theme,this.fontSize=o2.editorData.javascriptEditor.fontSize):o2.editorData.javascriptEditor={monaco_theme:"vs",fontSize:"12px"},this.theme||(this.theme="vs"),this.fontSize||(this.fontSize="12px"),o2.require("o2.widget.monaco",function(){this.editorClass=o2.widget.monaco,this.editorClass.load(function(){this.editor=monaco.editor.create(this.node,{value:this.options.option.value,language:this.options.option.mode,theme:this.theme,fontSize:this.fontSize,lineNumbersMinChars:3,lineNumbers:this.options.option.lineNumbers?"on":"off",mouseWheelZoom:!0,automaticLayout:!0}),this.focus(),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S,function(t){this.fireEvent("save")}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_I,function(t){this.format()}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_F,function(t){this.format()}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_F,function(t){this.format()}.bind(this)),this.fontSize&&this.editor.updateOptions({fontSize:this.fontSize}),this.editor.onDidFocusEditorText(function(t){o2.shortcut.keyboard.deactivate()}.bind(this)),this.editor.onDidBlurEditorText(function(t){o2.shortcut.keyboard.activate(),this.fireEvent("blur")}.bind(this)),this.editor.onDidChangeModelContent(function(t){this.fireEvent("change")}.bind(this)),this.monacoModel=this.editor.getModel(),this.monacoModel.o2Editor=this,this.registerCompletion(),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},loadAce:function(t){o2.editorData.javascriptEditor?(this.theme=o2.editorData.javascriptEditor.theme,this.fontSize=o2.editorData.javascriptEditor.fontSize):o2.editorData.javascriptEditor={theme:"tomorrow",fontSize:"12px"},this.theme||(this.theme="tomorrow"),this.fontSize||(this.fontSize="12px"),o2.require("o2.widget.ace",function(){this.editorClass=o2.widget.ace,this.editorClass.load(function(){this.editor=ace.edit(this.node),this.editor.session.setMode("ace/mode/"+this.options.option.mode),this.editor.setTheme("ace/theme/"+this.theme),this.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,showLineNumbers:this.options.option.lineNumbers}),this.options.option.value&&this.editor.setValue(this.options.option.value),this.editor.o2Editor=this,this.focus(),this.editor.commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(t){this.fireEvent("save")}.bind(this),readOnly:!1}),this.editor.commands.addCommand({name:"format",bindKey:{win:"Ctrl-Alt-i|Ctrl-Alt-f",mac:"Command-i|Command-f"},exec:function(t,e,i){this.format()}.bind(this),readOnly:!1}),this.editor.commands.addCommand({name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-Alt-h",mac:"Command-Alt-h"},exec:function(t){ace.config.loadModule("ace/ext/keybinding_menu",(function(e){e.init(t),t.showKeyboardShortcuts()}))}.bind(this)}),this.editor.on("blur",function(){this.fireEvent("blur")}.bind(this)),this.editor.on("change",function(){this.fireEvent("change")}.bind(this)),this.node.addEvent("keydown",(function(t){t.stopPropagation()})),this.fontSize&&this.setFontSize(this.fontSize),this.registerCompletion(),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},registerCompletion:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.registerCompletionAce();break;case"monaco":this.registerCompletionMonaco()}},registerCompletionMonaco:function(){o2.widget.monaco.registeredCompletion||(monaco.languages.registerCompletionItemProvider("javascript",{triggerCharacters:["."],provideCompletionItems:function(t,e,i,o){var n=t.getValueInRange({startLineNumber:e.lineNumber,startColumn:1,endLineNumber:e.lineNumber,endColumn:e.column}),s=n.substr(0,n.lastIndexOf("."));if(s){var r="",a=e.lineNumber>1?e.lineNumber-1:0;if(a>0){var d={endColumn:t.getLineMaxColumn(a),endLineNumber:a,startColumn:1,startLineNumber:1};r=t.getValueInRange(d)}var c="",h=t.getLineCount(),u=e.lineNumber+1;u<=h&&(d={endColumn:t.getLineMaxColumn(h),endLineNumber:h,startColumn:1,startLineNumber:u},c=t.getValueInRange(d));var l=t.getWordUntilPosition(e),m={startLineNumber:e.lineNumber,endLineNumber:e.lineNumber,startColumn:l.startColumn,endColumn:l.endColumn};return new Promise(function(e){o2.widget.JavascriptEditor.getCompletionObject(s,r+"\n"+c,m,t.o2Editor.options.runtime,function(t){e({suggestions:t})}.bind(this),"monaco")}.bind(this))}}.bind(this)}),o2.widget.monaco.registeredCompletion=!0)},registerCompletionAce:function(){o2.widget.ace.registeredCompletion||(ace.require("ace/ext/language_tools").addCompleter({identifierRegexps:[/[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/],getCompletions:function(t,e,i,o,n){var s=e.getWordRange(i.row,0);s.setEnd(i.row,i.column);var r=e.getTextRange(s);if(r=r.substr(0,r.lastIndexOf("."))){var a=i.row>0?i.row-1:-1,d="";if(a>-1)(c=e.getWordRange(0,0)).setEnd(a,e.getLine(a).length),d=e.getTextRange(c);var c,h="",u=e.getLength()-1,l=i.row+1;if(l<=u)(c=e.getWordRange(l,0)).setEnd(u,e.getLine(u).length),h=e.getTextRange(c);return new Promise(function(e){o2.widget.JavascriptEditor.getCompletionObject(r,d+"\n"+h,null,t.o2Editor.options.runtime,function(t){n(null,t),e&&e(t)}.bind(this),"ace")}.bind(this))}}.bind(this)}),o2.widget.ace.registeredCompletion=!0)},changeEditor:function(t){if(this.editor){var e=this.getValue();this.destroyEditor(),this.options.type=t,this.load(function(){this.setValue(e)}.bind(this))}else this.options.type=o2.editorData.javascriptEditor.editor,"ace"==this.options.type.toLowerCase()&&this.loadAce(callback),"monaco"==this.options.type.toLowerCase()&&this.loadMonaco(callback),"codeMirror"==this.options.type.toLowerCase()&&this.loadCodeMirror(callback)},destroyEditor:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.destroy(),this.node.empty();break;case"monaco":this.editor.dispose()}},destroy:function(){this.fireEvent("destroy"),this.destroyEditor(),o2.release(this)},setTheme:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setTheme("ace/theme/"+t);break;case"monaco":monaco.editor.setTheme(t)}},setFontSize:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setFontSize(t);break;case"monaco":this.editor.updateOptions({fontSize:t})}},getRange:function(t,e,i,o){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":var n=this.editor.getSelection().getWordRange(t-1,e-1);return n.setStart(t-1,e-1),i&&o&&n.setEnd(i-1,o-1),n;case"monaco":return{endColumn:o,endLineNumber:i,startColumn:e,startLineNumber:t}}return null},selectRange:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":if("array"===o2.typeOf(t)){this.editor.getSelection().setSelectionRange(t[0]);for(var e=1;e<t.length;e++)this.editor.getSelection().addRange(t[e])}else this.editor.getSelection().setSelectionRange(t);break;case"monaco":if("array"===o2.typeOf(t)){var i=[];t.each((function(t){i.push({positionColumn:t.endColumn,positionLineNumber:t.endLineNumber,selectionStartColumn:t.startColumn,selectionStartLineNumber:t.startLineNumber})})),this.editor.setSelections(i)}else{var o={positionColumn:t.endColumn,positionLineNumber:t.endLineNumber,selectionStartColumn:t.startColumn,selectionStartLineNumber:t.startLineNumber};this.editor.setSelection(o)}this.editor.focus()}},setValue:function(t){this.editor&&this.editor.setValue(t)},insertValue:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.insert(t);break;case"monaco":this.editor.executeEdits("",[{range:monaco.Range.fromPositions(this.editor.getPosition()),text:t}])}},getValue:function(){return this.editor?this.editor.getValue():""},resize:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.resize();break;case"monaco":this.editor.layout()}},addEditorEvent:function(t,e){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.on(t,e);break;case"monaco":var i=t;switch(i){case"change":i="onDidChangeModelContent";break;case"blur":i="onDidBlurEditorText"}this.editor[i]&&this.editor[i](e)}else this.unbindEvents.push({name:t,fun:e})},validatedAce:function(){for(var t=this.editor.getSession().getAnnotations(),e=0;e<t.length;e++)if("error"==t[e].type)return!1;return!0},validatedMonaco:function(){for(var t=this.editor.getModel(),e=monaco.editor.getModelMarkers({resource:t.uri}),i=0;i<e.length;i++)if(8==e[i].severity)return!1;return!0},validated:function(){if(this.editor){switch(this.options.type.toLowerCase()){case"ace":return this.validatedAce();case"monaco":return this.validatedMonaco()}return!0}return!0},formatAce:function(){var t=this.options.option.mode.toString().toLowerCase();"javascript"===t?o2.load("JSBeautifier",function(){this.editor.setValue(js_beautify(editor.getValue()))}.bind(this)):"html"===t?o2.load("JSBeautifier_html",function(){this.editor.setValue(html_beautify(editor.getValue()))}.bind(this)):"css"===t?o2.load("JSBeautifier_css",function(){this.editor.setValue(css_beautify(editor.getValue()))}.bind(this)):o2.load("JSBeautifier",function(){this.editor.setValue(js_beautify(editor.getValue()))}.bind(this))},formatMonaco:function(){this.editor.getAction("editor.action.formatDocument").run()},format:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.formatAce();case"monaco":this.formatMonaco()}},focus:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.focus(),this.goto();break;case"monaco":this.editor.focus()}},gotoLine:function(t,e){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.gotoLine(t-1,e-1,!0);break;case"monaco":this.editor.revealPositionInCenterIfOutsideViewport({column:e,lineNumber:t},0)}},goto:function(){var t=this.editor.getCursorPosition();0==t.row&&(t.row=this.editor.renderer.getScrollBottomRow()),this.editor.gotoLine(t.row+1,t.column+1,!0)},showLineNumbers:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setOption("showLineNumbers",!0);break;case"codeMirror":this.editor.setOption("lineNumbers",!0);break;case"monaco":this.editor.updateOptions({lineNumbers:"on"})}},hideLineNumbers:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setOption("showLineNumbers",!1);break;case"codeMirror":this.editor.setOption("lineNumbers",!1);break;case"monaco":this.editor.updateOptions({lineNumbers:"off"})}},max:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"codeMirror":this.editor.setSize("100%","100%");break;case"ace":this.editor.resize();break;case"monaco":this.editor.layout()}},loadCodeMirror:function(t){this.fireEvent("queryLoad")&&this.editorClass.load(function(){this.editorClass.loadJavascript(function(e){this.options.option.mode="javascript",this.editor=CodeMirror(this.node,this.options.option),this.editor.setSize("100%","100%"),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},getCursorPixelPosition:function(){var t=this.editor.getSession(),e=this.editor.getCursorPosition(),i=t.getLine(e.row),o=this.retrievePrecedingIdentifier(i,e.column),n=t.doc.createAnchor(e.row,e.column-o.length);n.$insertRight=!0;var s=this.editor.renderer,r=(e=s.$cursorLayer.getPixelPosition(n,!0),this.editor.container.getBoundingClientRect());return e.top+=r.top-s.layerConfig.offset,e.left+=r.left-this.editor.renderer.scrollLeft,e.left+=s.gutterWidth,e},retrievePrecedingIdentifier:function(t,e,i){i=i||/[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/;for(var o=[],n=e-1;n>=0&&i.test(t[n]);n--)o.push(t[n]);return o.reverse().join("")}}),o2.widget.JavascriptEditor.filterRangeScript=function(t,e,i){for(var o="",n=0,s=t.length-1;s>=0;s--){var r=t.charAt(s);if(r==i&&n++,r==e&&--n<0)break;o=r+o}return o},o2.widget.JavascriptEditor.getCompletionObject=function(t,e,i,o,n,s){t=o2.widget.JavascriptEditor.filterRangeScript(t,"(",")"),t=o2.widget.JavascriptEditor.filterRangeScript(t,"{","}"),-1!=(t=o2.widget.JavascriptEditor.filterRangeScript(t,"[","]")).lastIndexOf("=")&&(t=t.substr(t.lastIndexOf("=")+1)),-1!=t.lastIndexOf(" new ")&&(t=t.substr(t.lastIndexOf(" new ")+5));var r={code:t,preCode:e,runtime:o,id:o2.uuid(),type:s,range:i};return o2.JSEditorCWE.exec(r,n)},o2.widget.JavascriptEditor.completionWorkerEnvironment=o2.JSEditorCWE={init:function(){return this.callbackPool={},this.scriptWorker=new Worker("../o2_core/scriptWorker.js"),this.scriptWorker.onmessage=function(t){t.data&&"ready"==t.data.type&&this.setOnMessage()}.bind(this),this.isInit=!0,this},setOnMessage:function(){this.scriptWorker.onmessage=function(t){var e=t.data;if(e){var i=this.callbackPool[e.id];i.uuid==e.uuid&&i.callback&&i.callback(e.o)}}.bind(this)},exec:function(t,e){if(this.scriptWorker){var i=o2.uuid();t.uuid=i,this.callbackPool[t.id]={callback:e,uuid:i},this.scriptWorker.postMessage(t)}}};