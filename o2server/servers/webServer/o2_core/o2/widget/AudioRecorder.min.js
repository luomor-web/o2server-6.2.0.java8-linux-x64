o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.AudioRecorder=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",config:{sampleBits:8,sampleRate:7350,inputChannels:1,outputChannels:1},visible:!0,visualize:!0},initialize:function(t,e){this.setOptions(e),this.content=t,this.options.visible&&(this.path=o2.session.path+"/widget/$AudioRecorder/",this.cssPath=o2.session.path+"/widget/$AudioRecorder/"+this.options.style+"/css.wcss",this._loadCss()),COMMON.AjaxModule.loadDom("../o2_lib/adapter/adapter.js",function(){this.load()}.bind(this))},load:function(){this.options.visible&&this.content&&(this.createLayout(),this.createToolbar())},createLayout:function(){if(this.node=new Element("div",{styles:this.css.node}).inject(this.content),this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node),this.options.visualize){this.visualizeNode=new Element("div",{styles:this.css.visualizeNode}).inject(this.node);var t=this.node.getSize(),e=this.actionNode.getSize(),i=t.y-e.y;this.visualizeNode.setStyles({height:i+"px"}),this.canvas=new Element("canvas",{width:t.x,height:i}).inject(this.visualizeNode),this.canvasCtx=this.canvas.getContext("2d")}},createToolbar:function(){o2.require("o2.widget.Toolbar",function(){this.toolbar=new o2.widget.Toolbar(this.actionNode,{style:"audio"},this),new Element("div",{MWFnodeid:"record",MWFnodetype:"MWFToolBarOnOffButton",MWFButtonImage:this.path+""+this.options.style+"/icon/record.png",title:o2.LP.widget.record,MWFButtonAction:"recordAction",MWFButtonText:o2.LP.widget.record}).inject(this.actionNode),new Element("div",{MWFnodeid:"stop",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/stop.png",title:o2.LP.widget.stop,MWFButtonAction:"stopAction",MWFButtonText:o2.LP.widget.stop}).inject(this.actionNode),new Element("div",{MWFnodeid:"",MWFnodetype:"MWFToolBarSeparator"}).inject(this.actionNode),new Element("div",{MWFnodeid:"play",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/play.png",title:o2.LP.widget.play,MWFButtonAction:"playAction",MWFButtonText:o2.LP.widget.play}).inject(this.actionNode),new Element("div",{MWFnodeid:"save",MWFnodetype:"MWFToolBarButton",MWFButtonDisable:"yes",MWFButtonImage:this.path+""+this.options.style+"/icon/save.png",title:o2.LP.widget.save,MWFButtonAction:"saveAction",MWFButtonText:o2.LP.widget.save}).inject(this.actionNode),new Element("div",{MWFnodeid:"cancel",MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/icon/cancel.png",title:o2.LP.widget.cancel,MWFButtonAction:"cancelAction",MWFButtonText:o2.LP.widget.cancel}).inject(this.actionNode),this.toolbar.load()}.bind(this))},saveAction:function(){var t=this.audioData.encodeWAV();this.fireEvent("save",[t]),this.close()},cancelAction:function(){this.fireEvent("cancel"),this.close()},close:function(){this.context&&this.context.close(),this.node&&this.node.destroy(),o2.release(this)},recordAction:function(t,e){"on"===e.status?(this.toolbar.items.stop.enable(),this.toolbar.items.play.disable(),this.toolbar.items.save.disable(),this.toolbar.items.cancel.disable(),this.startRecord()):e.on()},stopAction:function(){var t=this.toolbar.items.record;"on"===t.status&&(t.off(),this.stopRecord(),this.audioData&&this.audioData.buffer.length&&this.toolbar.items.play.enable()),this.toolbar.items.save.enable(),this.toolbar.items.cancel.enable(),this.toolbar.items.stop.disable()},playAction:function(){var t=this.toolbar.items.record;t.off(),t.enable(!1),this.toolbar.items.stop.enable(),this.toolbar.items.save.disable(),this.toolbar.items.cancel.disable(),this.audioNode||(this.audioNode=new Element("audio",{loop:!1})),this.audioNode.set("src",window.URL.createObjectURL(this.audioData.encodeWAV())),this.audioNode.addEventListener("ended",function(){this.toolbar.items.save.enable(),this.toolbar.items.cancel.enable()}.bind(this),!0),this.audioNode.play()},stopRecord:function(){this.audioInput.disconnect(),this.canvas&&(this.canvasCtx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawVisual&&window.cancelAnimationFrame(this.drawVisual),this.audioNode&&(this.audioNode.paused||this.audioNode.pause())),this.context.suspend()},startRecord:function(){this.loadAudio(function(t){this.initAudio(t),this.initAudioData(),this.startAudio(),this.visualize(t)}.bind(this))},startAudio:function(){"suspended"===this.context.state&&this.context.resume(),this.audioData&&(this.audioData.size=0,this.audioData.buffer=[]),this.audioInput.connect(this.analyser),this.analyser.connect(this.recorder),this.recorder.connect(this.volume),this.volume.connect(this.context.destination),this.volume.gain.value=0},initAudioData:function(){if(!this.audioData){this.audioData={size:0,buffer:[],inputSampleRate:this.context.sampleRate,inputSampleBits:16,outputSampleRate:this.options.config.sampleRate,outputSampleBits:this.options.config.sampleBits,input:function(t){this.buffer.push(new Float32Array(t)),this.size+=t.length},compress:function(){for(var t=new Float32Array(this.size),e=0,i=0;i<this.buffer.length;i++)t.set(this.buffer[i],e),e+=this.buffer[i].length;for(var o=parseInt(this.inputSampleRate/this.outputSampleRate),n=t.length/o,s=new Float32Array(n),a=0,c=0;a<n;)s[a]=t[c],c+=o,a++;return s},encodeWAV:function(){var t=Math.min(this.inputSampleRate,this.outputSampleRate),e=Math.min(this.inputSampleBits,this.outputSampleBits),i=this.compress(),o=i.length*(e/8),n=new ArrayBuffer(44+o),s=new DataView(n),a=0,c=function(t){for(var e=0;e<t.length;e++)s.setUint8(a+e,t.charCodeAt(e))};if(c("RIFF"),a+=4,s.setUint32(a,36+o,!0),a+=4,c("WAVE"),a+=4,c("fmt "),a+=4,s.setUint32(a,16,!0),a+=4,s.setUint16(a,1,!0),a+=2,s.setUint16(a,1,!0),a+=2,s.setUint32(a,t,!0),a+=4,s.setUint32(a,1*t*(e/8),!0),a+=4,s.setUint16(a,e/8*1,!0),a+=2,s.setUint16(a,e,!0),a+=2,c("data"),a+=4,s.setUint32(a,o,!0),a+=4,8===e)for(var r=0;r<i.length;r++,a++){var h=(d=Math.max(-1,Math.min(1,i[r])))<0?32768*d:32767*d;h=parseInt(255/(65535/(h+32768))),s.setInt8(a,h,!0)}else for(r=0;r<i.length;r++,a+=2){var d=Math.max(-1,Math.min(1,i[r]));s.setInt16(a,d<0?32768*d:32767*d,!0)}return new Blob([s],{type:"audio/wav"})}}}},initAudio:function(t){if(!this.context){this.context=new(window.AudioContext||window.webkitAudioContext),this.audioInput=this.context.createMediaStreamSource(t),this.volume=this.context.createGain();this.recorder=this.context.createScriptProcessor(4096,this.options.config.inputChannels,this.options.config.outputChannels),this.analyser=this.context.createAnalyser(),this.recorder.onaudioprocess=function(t){this.recordAudioData(t.inputBuffer.getChannelData(0))}.bind(this)}},recordAudioData:function(t){this.audioData.input(t)},loadAudio:function(t){navigator.getUserMedia?navigator.getUserMedia({audio:!0},(function(e){t&&t(e)}),function(t){switch(t.code||t.name){case"PERMISSION_DENIED":case"PermissionDeniedError":o2.xDesktop.notice("error",{x:"right",y:"top"},o2.LP.widget.userRefuse,this.node);break;case"NOT_SUPPORTED_ERROR":case"NotSupportedError":o2.xDesktop.notice("error",{x:"right",y:"top"},o2.LP.widget.explorerNotSupportDevice,this.node);break;case"MANDATORY_UNSATISFIED_ERROR":case"MandatoryUnsatisfiedError":o2.xDesktop.notice("error",{x:"right",y:"top"},o2.LP.widget.canNotFindDevice,this.node);break;default:o2.xDesktop.notice("error",{x:"right",y:"top"},o2.LP.widget.canNotOpenMicrophone+(t.code||t.name),this.node)}}.bind(this)):o2.xDesktop.notice("error",{x:"right",y:"top"},o2.LP.widget.explorerNotSupportRecordVoice,this.node)},visualize:function(t){var e=this.canvas.width,i=this.canvas.height;this.analyser.fftSize=1024;var o=this.analyser.frequencyBinCount,n=new Uint8Array(o);this.canvasCtx.clearRect(0,0,e,i);var s=this;!function t(){s.drawVisual=requestAnimationFrame(t),s.analyser.getByteTimeDomainData(n),s.canvasCtx.fillStyle="rgb(204, 204, 204)",s.canvasCtx.fillRect(0,0,e,i),s.canvasCtx.lineWidth=1,s.canvasCtx.strokeStyle="rgb(0, 0, 0)",s.canvasCtx.beginPath();for(var a=1*e/o,c=0,r=0;r<o;r++){var h=n[r]/128,d=30*(h-=1)+i/2;0===r?s.canvasCtx.moveTo(c,d):s.canvasCtx.lineTo(c,d),c+=a}s.canvasCtx.lineTo(s.canvas.width,s.canvas.height/2),s.canvasCtx.stroke()}()}});