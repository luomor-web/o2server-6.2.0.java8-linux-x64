o2.widget.SimpleEditor.Actions=o2.widget.SimpleEditor.Actions||{},o2.widget.SimpleEditor.Actions.Image=new Class({Implements:[Options,Events],options:{style:"default",title:o2.LP.widget.SimpleEditor.insertImage},initialize:function(e,t,i,o){this.setOptions(e),this.editor=t,this.toolbar=i,this.button=o},command:function(e){this.fireEvent("queryCommand");var t="";function i(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}this.webImageNode&&""!=this.webImageNode.get("value")?(t='<img src="'+i(this.webImageNode.get("value"))+'" data-ke-src="'+i(this.webImageNode.get("value"))+'" ',this.imageWidthNode&&""!=this.imageWidthNode.get("value")&&(t+='width="'+i(this.imageWidthNode.get("value"))+'" '),this.imageHeightNode&&""!=this.imageHeightNode.get("value")&&(t+='height="'+i(this.imageHeightNode.get("value"))+'" '),this.imageTitleNode&&""!=this.imageTitleNode.get("value")&&(t+='title="'+i(this.imageTitleNode.get("value"))+'" ',t+='alt="'+i(this.imageTitleNode.get("value"))+'" '),t+="/>",this.closeDialog(),this.editor.selectionRange?this.editor.selection.setRange(this.editor.selectionRange):this.editor.editareaNode.focus(),this.editor.selection.insertContent(t),this.editor.selectionRange=this.editor.selection.getRange(),!this.editor.iframe||"visible"!=this.editor.options.overFlow&&"max"!=this.editor.options.overFlow||this.editor.setIframeHeight(),this.fireEvent("postCommand")):this.closeDialog()},closeDialog:function(){this.fireEvent("queryCloseDialog"),this.dialog.node.destroy(),this.dialog.node=null,this.button&&(this.button.isActive=!1),this.editor.selectionRange&&this.editor.selection.setRange(this.editor.selectionRange),this.fireEvent("postCloseDialog")},showDialog:function(){var e=this,t=0,i=0,o=0;this.fireEvent("queryOpenDialog");var s="";if(s+="<center>",s+="  <table width='100%' style='padding:2px;'>",s+="    <tr>",s+="       <td width='50' style='padding:2px;'>",s+="         <span style='font-size:12px;color:#888;'>图片地址</span>",s+="      </td>",s+="      <td width='210' style='padding:2px;'>",s+="         <input type='text' style='width:200px;border:1px solid #ccc;font-size:12px;' name='webImage' id='webImage' value='http://'>",s+="      </td>",s+="    </tr>",s+="    <tr>",s+="       <td width='50' style='padding:2px;'>",s+="         <span style='font-size:12px;color:#888;'>图片大小</span>",s+="      </td>",s+="      <td width='210' style='padding:2px;'>",s+="         <label style='font-size:12px;color:#888;display:inline-block;'>宽</label>",s+="         <input type='text' style='width:40px;border:1px solid #ccc;font-size:12px;display:inline-block;' name='imageWidth' id='imageWidth' value=''>",s+="         <label style='font-size:12px;color:#888;display:inline-block;'>高</label>",s+="         <input type='text' style='width:40px;border:1px solid #ccc;font-size:12px;display:inline-block;' name='imageHeight' id='imageHeight' value=''>",s+="         <image src='"+o2.session.path+"/widget/$SimpleEditor/default/img/refresh.png' style='cursor:pointer;' id='imageRefresh' title='重置大小'>",s+="      </td>",s+="    </tr>",s+="    <tr>",s+="       <td width='50' style='padding:2px;'>",s+="         <span style='font-size:12px;color:#888;'>图片说明</span>",s+="      </td>",s+="      <td width='210' style='padding:2px;'>",s+="         <input type='text' style='width:200px;border:1px solid #ccc;font-size:12px;' name='imageTitle' id='imageTitle' value=''>",s+="      </td>",s+="    </tr>",s+="    <tr>",s+="  </table>",s+="</center>",e.editor.iframe)var a=(l=e.editor.iframe.getParent()).getCoordinates().top+(e.button?e.button.node.getCoordinates().bottom:130),n=l.getCoordinates().left+(e.button?e.button.node.getCoordinates().left-15:10);else{a=e.button?e.button.node.getCoordinates().bottom:130,n=e.button?e.button.node.getCoordinates().left:10;var l=e.editor.doc.body}function d(s){var a=new Element("img",{id:"testaaaa",src:e.webImageNode.get("value")+"&sep="+o++,styles:{position:"absolute",visibility:"hidden",top:0,left:"-1000px"},events:{load:function(){!function(o,s,a){a&&(e.imageWidthNode.set("value",o),e.imageHeightNode.set("value",s)),t=o,i=s}(a.getSize().x,a.getSize().y,s),a.dispose()}}}).inject($(document.body))}this.dialog=new o2.widget.SimpleEditor.Dialog(l,{style:e.options.style,html:s,width:300,height:120,top:a,left:n,fromTop:a,fromLeft:n,isMax:!1,isClose:!0,isResize:!1,isMove:!1,mark:!1,buttons:{"确定":function(){e.command.call(e)},"取消":function(){e.closeDialog.call(e)}},onPostLoad:function(){this.button.setStyle("display","block")},onQueryInjectNode:function(){this.node.getElement(".MWF_dialod_close").addEvent("click",e.closeDialog.bind(e)),this.node.getElement("#imageRefresh").addEvent("click",(function(){d.call(this,!0)})),e.webImageNode=this.node.getElement("#webImage"),e.imageWidthNode=this.node.getElement("#imageWidth"),e.imageHeightNode=this.node.getElement("#imageHeight"),e.imageTitleNode=this.node.getElement("#imageTitle"),e.webImageNode.addEvents({change:function(){d.call(this,!1)},focus:function(e){"http://"==this.value&&(this.value="")}}),e.imageWidthNode.addEvents({keyup:function(o){this.value=this.value.replace(/[^0-9_]/g,""),t>0&&(""!=this.value?e.imageHeightNode.set("value",Math.round(i/t*parseInt(this.value,10))):e.imageHeightNode.set("value",""))}}),e.imageHeightNode.addEvents({keyup:function(o){this.value=this.value.replace(/[^0-9_]/g,""),t>0&&""!=this.value&&(""!=this.value?e.imageHeightNode.set("value",Math.round(i/t*parseInt(this.value,10))):e.imageHeightNode.set("value",""))}})},onPostShow:function(){this.node.setStyle("height",180)}}),this.dialog.show(),this.button&&(this.button.isActive=!0),this.fireEvent("postOpenDialog")}});