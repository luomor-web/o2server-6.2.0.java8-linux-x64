o2.widget=o2.widget||{},o2.widget.ImageClipper=o2.ImageClipper=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",path:o2.session.path+"/widget/$ImageClipper/",imageUrl:"",action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",description:"",aspectRatio:1,resultMaxSize:800,editorSize:340,frameMinSize:30,previewerSize:260,showPreviewer:!0,fromLocalEnable:!0,fromFileEnable:!0,resetEnable:!1,uploadSourceEnable:!0},initialize:function(t,e){this.node=t,isNaN(e.aspectRatio)&&(e.aspectRatio=0),isNaN(e.resultMaxSize)&&(e.resultMaxSize=800),this.setOptions(e),this.path=this.options.path||o2.session.path+"/widget/$ImageClipper/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.fireEvent("init")},load:function(t){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node),this.container.addEvent("selectstart",(function(t){t.preventDefault(),t.stopPropagation()})),this.checkBroswer()?this._loadWithH5(t):this._loadWithSWF()},_loadWithSWF:function(){this.clipper=new o2.widget.FlashImageClipper(this.container,this.options,this),this.clipper.load()},_loadWithH5:function(t){this.clipper=new o2.widget.HTML5ImageClipper(this.container,this.options,this),this.clipper.load(t)},uploadImage:function(t,e){this.clipper.uploadImage(t,e)},getFormData:function(){return this.clipper.getFormData()},getResizedImage:function(){return this.clipper.getResizedImage()},getBase64Code:function(){return this.clipper.getBase64Code()},getBase64Image:function(){return this.clipper.getBase64Image()},close:function(){this.clipper.close()},checkBroswer:function(){return window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob?(this.available=!0,!0):(this.available=!1,!1)}}),o2.widget.FlashImageClipper=new Class({Implements:[Options,Events],options:{style:"default",path:o2.session.path+"/widget/$ImageClipper/",imageUrl:"",action:null,method:"",parameter:{},reference:"",referenceType:"",description:"",aspectRatio:1,resultMaxSize:800},initialize:function(t,e,i){this.container=t,this.setOptions(e),this.parent=i,this.options.aspectRatio||(this.options.aspectRatio=1),this.Previer_MaxSize=240,this.css=this.parent.css,this.fireEvent("init")},load:function(){window.uploadevent_flash=function(t){if("number"==typeOf(t))switch(t+=""){case"1":alert(o2.LP.widget.uploadSuccess);(new Date).getTime();ok();break;case"2":return this.isUploading?0:(this.isUploading=!0,1);case"-1":this.isUploading=!1;break;case"-2":this.isUploading=!1,alert(o2.LP.widget.uploadFail),window.location.href="#"}else{this.isUploading=!1;var e=JSON.parse(t);"error"==e.type?alert(e.message):this.uploadSuccess&&this.uploadSuccess(e.data)}}.bind(this),this.getUploadUrl(function(){this.renderFlash()}.bind(this))},renderFlash:function(){this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode,id:"imageclipper_swf"}).inject(this.container);var t=o2.session.path+"/widget/$ImageClipper/",e=this.options.imageUrl||t+"flash_default.png";if(this.options.aspectRatio>1)var i=this.Previer_MaxSize,s=this.Previer_MaxSize/this.options.aspectRatio;else i=this.Previer_MaxSize*this.options.aspectRatio,s=this.Previer_MaxSize;COMMON.AjaxModule.load(t+"swfobject.js",function(){swfobject.embedSWF(t+"FaustCplus.swf",this.contentNode,"650","370","9.0.0",t+"expressInstall.swf",{jsfunc:"uploadevent_flash",imgUrl:e,tip:this.options.description,aspectRatio:this.options.aspectRatio,reqContentDisposition:"",imageUploadKey:"thumb.jpg",imageSrcUploadKey:"src.jpg",showZoom:!1,showSaveBtns:!1,showTurn:!1,showColorAdjuster:!1,pid:"75642723",uploadSrc:!1,showBrow:!0,showCame:!1,pSize:"300|300|"+i+"|"+s,uploadUrl:this.uploadUrl},{menu:"false",scale:"noScale",allowFullscreen:"true",allowScriptAccess:"always",wmode:"transparent",bgcolor:"#FFFFFF"},{id:"FaustCplus"},function(t){this.swf=t}.bind(this))}.bind(this))},getUploadUrl:function(t){if(this.options.action)this.action="string"==typeOf(this.options.action)?o2.Actions.get(action).action:this.options.action,this.action.getActions(function(){var e=this.action.actions[this.options.method];e=this.action.address+e.uri,this.options.parameter&&Object.each(this.options.parameter,(function(t,i){e=e.replace("{"+i+"}",t)})),this.uploadUrl=e,t&&t(e)}.bind(this));else{var e=layout.serviceAddressList.x_file_assemble_control;if(e)var i=layout.config.app_protocol+"//"+e.host+(80==e.port?"":":"+e.port)+e.context;else{var s=layout.config.center.host||window.location.hostname,o=layout.config.center.port;i=layout.config.app_protocol+"//"+s+("80"==o?"":":"+o)+"/x_program_center"}var n="/jaxrs/file/upload/referencetype/"+this.options.referenceType+"/reference/"+this.options.reference+"/scale/"+this.options.resultMaxSize;this.uploadUrl=i+n,t&&t(this.uploadUrl)}},uploadImage:function(t,e){this.uploadSuccess=t,this.swf&&this.swf.ref.jscall_updateAvatar()},getFormData:function(){return!0},getResizedImage:function(){return!0},getBase64Code:function(){return!0},getBase64Image:function(){return!0},close:function(){}}),o2.widget.HTML5ImageClipper=new Class({Implements:[Options,Events],options:{style:"default",path:o2.session.path+"/widget/$ImageClipper/",imageUrl:"",editorSize:340,aspectRatio:1,frameMinSize:30,previewerSize:260,resultMaxSize:800,action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",uploadSourceEnable:!0,showPreviewer:!0,fromLocalEnable:!0,fromFileEnable:!0,resetEnable:!1,description:""},initialize:function(t,e,i){this.container=t,this.setOptions(e),this.parent=i,this.fileName="untitled.png",this.fileType="image/png",this.fileSize=null,this.css=this.parent.css,this.fireEvent("init")},load:function(t){this.lastPoint=null,this.loadToolBar(),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.container),this.loadEditorNode(),this.loadResultNode(),this.options.description&&this.loadDescriptionNode(),this.options.imageUrl&&this.loadImageAsUrl(this.options.imageUrl),t&&this.loadImageAsFile(this.base64ToBlob(t))},uploadImage:function(t,e){if(this.resizedImage)if(this.options.action)this.action="string"==typeOf(this.options.action)?o2.Actions.get(action).action:this.options.action,this.action.invoke({name:this.options.method,async:!0,data:this.getFormData(),file:this.resizedImage,parameter:this.options.parameter,success:function(e){t(e)}.bind(this)});else{var i=this.options.resultMaxSize;this.uploadSourceInput&&this.uploadSourceInput.get("checked")&&(i=0),o2.xDesktop.uploadImageByScale(this.options.reference,this.options.referenceType,i,this.getFormData(),this.resizedImage,t,e)}},getFormData:function(){var t=new FormData;return t.append("file",this.resizedImage,this.fileName),this.options.data&&Object.each(this.options.data,(function(e,i){t.append(i,e)})),t},getResizedImage:function(){return this.resizedImage},getBase64Code:function(){return this.base64Code},getBase64Image:function(){return this.base64Code?"data:"+this.fileType+";base64,"+this.base64Code:null},checkBroswer:function(){return window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob?(this.available=!0,!0):(this.available=!1,!1)},close:function(){this.docBody.removeEvent("touchmove",this.bodyMouseMoveFun),this.docBody.removeEvent("mousemove",this.bodyMouseMoveFun),this.docBody.removeEvent("touchend",this.bodyMouseEndFun),this.docBody.removeEvent("mouseup",this.bodyMouseEndFun),this.container.destroy()},loadToolBar:function(){if(this.uploadToolbar=new Element("div.uploadToolbar",{styles:this.css.uploadToolbar}).inject(this.container),this.options.fromLocalEnable&&(this.uploadLocalImage=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:o2.LP.widget.selectLocalImage}).inject(this.uploadToolbar),this.uploadLocalImage.addEvents({click:function(){this.fileNode.click()}.bind(this)}),this.fileNode=new Element("input.file",{type:"file",accept:"image/*",styles:{display:"none"}}).inject(this.container),this.fileNode.addEvent("change",function(t){var e=this.fileNode.files[0];this.fileType=e.type,this.fileName=e.name,this.fileSize=e.size,this.loadImageAsFile(e)}.bind(this))),this._createUploadButtom(),this.uploadCloudFileArea=new Element("span").inject(this.uploadToolbar),this.options.fromFileEnable){var t=o2.session.path+"/xDesktop/$Layout/applications.json";o2.getJSON(t,function(t){t.each(function(t){"File"!=t.name&&"File"!=t.path||(this.uploadCloudFile=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:o2.LP.widget.selectCloudImage}).inject(this.uploadCloudFileArea),this.uploadCloudFile.addEvents({click:function(){this.selectFileImage(function(t,e,i){this.fileName=i.name,this.fileType=["jpeg","jpg"].contains(i.extension.toLowerCase())?"image/jpeg":"image/png",this.fileSize=i.length,this.loadImageAsUrl(t)}.bind(this))}.bind(this)}))}.bind(this))}.bind(this))}this.options.resetEnable&&(this.resetAction=new Element("button.resetAction",{styles:this.css.resetActionNode,text:o2.LP.widget.reset}).inject(this.uploadToolbar),this.resetAction.addEvents({click:function(){this.reset()}.bind(this)})),this.options.uploadSourceEnable&&(this.uploadSourceInput=new Element("input",{type:"checkbox",events:{change:function(){this.clipImage()}.bind(this)}}).inject(this.uploadToolbar),new Element("span",{text:o2.LP.widget.uploadOriginalImage}).inject(this.uploadToolbar))},_createUploadButtom:function(){},reset:function(){this.fileName="untitled.png",this.fileType="image/png",this.fileSize=null,this.resizedImage="",this.base64Code="",this.resetImage(),this.setFrameSize({width:0,height:0}),this.frameOffset.top=0,this.frameOffset.left=0,this.frameNode.setStyles({top:0,left:0}),this.resultNode.empty(),this.editorContainer.setStyles(this.css.editorContainer),this.imageNode.setStyle("display","none"),this.innerNode.setStyles({width:0,height:0})},selectFileImage:function(t){var e=this;o2.xDesktop.requireApp("File","FileSelector",(function(){e.selector_cloud=new o2.xApplication.File.FileSelector(document.body,{style:"default",title:o2.LP.widget.selectCloudImage,copyToPublic:!1,listStyle:"preview",selectType:"images",onPostSelectAttachment:function(e,i,s){t&&t(e,i,s)}}),e.selector_cloud.load()}),!0)},loadResultNode:function(){if(this.options.showPreviewer){this.resultContainer=new Element("div",{styles:this.css.resultContainer}).inject(this.contentNode);var t=Math.max(this.options.editorSize,this.options.previewerSize)-2*parseInt(this.resultContainer.getStyle("padding-left"));this.resultContainer.setStyles({width:this.options.previewerSize+"px",height:t+"px"}),this.resultTitleNode=new Element("div",{styles:this.css.resultTitleNode,text:o2.LP.widget.preview}).inject(this.resultContainer);var e=this.resultTitleNode.getSize().y,i=this.options.aspectRatio?this.options.previewerSize/this.options.aspectRatio:this.options.previewerSize;this.resultNode=new Element("div.resultNode",{styles:this.css.resultNode}).inject(this.resultContainer),this.resultNode.setStyles({"padding-top":(t-e-i)/2-10+"px"})}else this.resultNode=new Element("div",{styles:{display:"none"}}).inject(this.contentNode)},loadEditorNode:function(){this.docBody=window.document.body,this.editorContainer=new Element("div.editorContainer",{styles:this.css.editorContainer}).inject(this.contentNode),this.editorContainer.setStyles({width:this.options.editorSize+"px",height:this.options.editorSize+"px"}),this.editorNode=new Element("div.editorNode",{styles:this.css.editorNode}).inject(this.editorContainer),this.innerNode=new Element("div.innerNode",{styles:this.css.innerNode}).inject(this.editorNode),this.imageNode=new Element("img",{styles:this.css.imageNode,crossOrigin:"use-credentials"}).inject(this.innerNode),this.imageNode.ondragstart=function(){return!1},this.frameNode=new Element("div.frameNode",{styles:this.css.frameNode}).inject(this.innerNode),this.frameOffset={top:0,left:0},this.frameNode.addEvents({touchstart:function(t){this.getOffset(t)}.bind(this),mousedown:function(t){this.getOffset(t)}.bind(this),touchmove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeMode?this.resizeFrames(e):this.moveFrames(e),t.stopPropagation()}}.bind(this),mousemove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeMode?this.resizeFrames(e):this.moveFrames(e),t.stopPropagation()}}.bind(this),touchend:function(t){this.lastPoint=null,this.resizeMode&&(this.frameNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1),this.clipImage(),t.stopPropagation()}.bind(this),mouseup:function(t){this.lastPoint=null,this.resizeMode&&(this.frameNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1),this.clipImage(),t.stopPropagation()}.bind(this)}),this.reizeNode=new Element("div.reizeNode",{styles:this.css.reizeNode}).inject(this.frameNode),this.reizeNode.addEvents({touchstart:function(t){this.frameNode.setStyle("cursor","nw-resize"),this.docBody.setStyle("cursor","nw-resize"),this.resizeMode=!0,this.getOffset(t),t.stopPropagation()}.bind(this),mousedown:function(t){this.frameNode.setStyle("cursor","nw-resize"),this.docBody.setStyle("cursor","nw-resize"),this.resizeMode=!0,this.getOffset(t),t.stopPropagation()}.bind(this),touchmove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeFrames(e),t.stopPropagation()}}.bind(this),mousemove:function(t){if(this.lastPoint){var e=this.getOffset(t);this.resizeFrames(e),t.stopPropagation()}}.bind(this),touchend:function(t){this.frameNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1,this.lastPoint=null,this.clipImage(),t.stopPropagation()}.bind(this),mouseup:function(t){this.frameNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1,this.lastPoint=null,this.clipImage(),t.stopPropagation()}.bind(this)}),this.bodyMouseMoveFun=this.bodyMouseMove.bind(this),this.docBody.addEvent("touchmove",this.bodyMouseMoveFun),this.docBody.addEvent("mousemove",this.bodyMouseMoveFun),this.bodyMouseEndFun=this.bodyMouseEnd.bind(this),this.docBody.addEvent("touchend",this.bodyMouseEndFun),this.docBody.addEvent("mouseup",this.bodyMouseEndFun)},loadDescriptionNode:function(){new Element("div",{styles:this.css.descriptionNode,text:this.options.description}).inject(this.container)},bodyMouseMove:function(t){if(this.lastPoint&&this.resizeMode){var e=this.getOffset(t);this.resizeFrames(e)}},bodyMouseEnd:function(t){this.lastPoint=null,this.resizeMode&&(this.frameNode.setStyle("cursor","move"),this.docBody.setStyle("cursor","default"),this.resizeMode=!1,this.clipImage())},clipImage:function(){this.resultNode.empty();var t,e,i=this.imageNode.naturalHeight,s=this.imageNode.naturalWidth,o=this.uploadSourceInput&&this.uploadSourceInput.get("checked")?0:this.options.resultMaxSize;if(e=this.options.aspectRatio?this.options.aspectRatio:this.frameOffset.size.width/this.frameOffset.size.height,0==o||i<=o&&s<=o)t=this.getRatioMaxSize(s,i,e);else{var n=Math.min(o,i,s);t=this.getRatioMaxSize(n,n,e)}var a=new Element("canvas",t),h=a.getContext("2d"),r=s/this.offset.width,l=this.frameOffset.left*r,d=this.frameOffset.top*r,c=this.frameOffset.size.width*r,p=this.frameOffset.size.height*r;h.drawImage(this.imageNode,l,d,c,p,0,0,t.width,t.height);var u=a.toDataURL(this.fileType);if(this.canvas=a,a.inject(this.resultNode),!(u=u.split(",")[1]))return this.resizedImage=null,void(this.base64Code="");this.base64Code=u,u=window.atob(u);for(var f=new Uint8Array(u.length),m=0;m<u.length;m++)f[m]=u.charCodeAt(m);this.resizedImage=new Blob([f],{type:this.fileType});n=Math.min(this.options.previewerSize,i,s,this.options.resultMaxSize);t=this.getRatioMaxSize(n,n,e),a.setStyles({width:t.width+"px",height:t.height+"px"})},loadImageAsFile:function(t){this.resetImage(),this.editorContainer.setStyles(this.css.editorContainer_active),this.imageNode.setStyle("display",""),this.setFrameSize({width:0,height:0}),this.frameOffset.top=0,this.frameOffset.left=0,this.frameNode.setStyles({top:0,left:0});var e=new FileReader;e.onload=function(){this.imageNode.src=e.result,e=null,this.onImageLoad()}.bind(this),e.readAsDataURL(t)},loadImageAsUrl:function(t){this.resetImage(),this.editorContainer.setStyles(this.css.editorContainer_active),this.imageNode.setStyle("display",""),this.setFrameSize({width:0,height:0}),this.frameOffset.top=0,this.frameOffset.left=0,this.frameNode.setStyles({top:0,left:0}),this.onImageLoadFun=this.onImageLoad.bind(this),this.imageNode.addEvent("load",this.onImageLoadFun),this.imageNode.src=t},onImageLoad:function(){var t=this.imageNode.naturalHeight,e=this.imageNode.naturalWidth;isNaN(t)||isNaN(e)||0==t||0==e?setTimeout(function(){this.onImageLoad()}.bind(this),100):this._onImageLoad()},_onImageLoad:function(){this.setImageSize(),this.setFrameSize(this.getDefaultSize()),this.clipImage(),this.onImageLoadFun&&(this.imageNode.removeEvent("load",this.onImageLoadFun),this.onImageLoadFun=null)},resetImage:function(){this.imageNode.src="",this.canvas&&this.canvas.destroy()},setImageSize:function(){var t,e=this.imageNode.naturalHeight,i=this.imageNode.naturalWidth;t=i>e?{width:this.options.editorSize,height:this.options.editorSize*(e/i)}:{width:this.options.editorSize*(i/e),height:this.options.editorSize},this.offset=t,this.imageNode.setStyles(t)},setFrameSize:function(t){return this.frameOffset.size=t,this.frameNode.setStyles({width:t.width+"px",height:t.height+"px"})},getDefaultSize:function(){return this.innerNode.setStyles({width:this.offset.width,height:this.offset.height,"margin-left":(this.options.editorSize-this.offset.width)/2+"px","margin-top":(this.options.editorSize-this.offset.height)/2+"px"}),this.options.aspectRatio?this.getRatioMaxSize(this.offset.width,this.offset.height):{width:this.offset.width,height:this.offset.height}},getRatioMaxSize:function(t,e,i){return i||(i=this.options.aspectRatio),t/e>i?{width:e*i,height:e}:{width:t,height:t/i}},resizeFrames:function(t){var e=t.x;if(0!=e){var i=t.y;if(0!=i){var s,o,n=this.frameOffset.top,a=this.frameOffset.left,h=this.frameOffset.size,r=this.offset.width,l=this.offset.height,d=this.options.aspectRatio;if(d)if(Math.abs(e)/Math.abs(i)>d){if(e+h.width+a>r)return;if((o=(s=e+h.width)/d)+n>l)return}else{if(i+h.height+n>l)return;if((s=(o=i+h.height)*d)+a>r)return}else{if(e+h.width+a>r)return;if(s=e+h.width,i+h.height+n>l)return;o=i+h.height}var c=this.options.frameMinSize,p=d?c/d:c;s=s<c?c:s,o=o<p?p:o,this.frameNode.setStyles({width:s+"px",height:o+"px"}),this.frameOffset.size={width:s,height:o}}}},moveFrames:function(t){var e=t.x,i=t.y,s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,a=this.offset.width,h=this.offset.height;e+n.width+o>a?e=a-n.width:e+=o,i+n.height+s>h?i=h-n.height:i+=s,e=e<0?0:e,i=i<0?0:i,this.frameNode.setStyles({top:i+"px",left:e+"px"}),this.frameOffset.top=i,this.frameOffset.left=e},getOffset:function(t){var e,i;if((t=t.event).touches){var s=t.touches[0];e=s.clientX,i=s.clientY}else e=t.clientX,i=t.clientY;this.lastPoint||(this.lastPoint={x:e,y:i});var o={x:e-this.lastPoint.x,y:i-this.lastPoint.y};return this.lastPoint={x:e,y:i},o},base64ToBlob:function(t){if("data:image"==t.substr(0,10))var e=window.atob(t.split(",")[1]);else e=window.atob(t);for(var i=new ArrayBuffer(e.length),s=new Uint8Array(i),o=0;o<e.length;o++)s[o]=e.charCodeAt(o);return new Blob([i],{type:this.fileType})}});