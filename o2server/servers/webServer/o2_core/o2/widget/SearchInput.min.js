o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.SearchInput=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",width:800,height:40},initialize:function(t){this.setOptions(t),this.path=o2.session.path+"/widget/$SearchInput/",this.cssPath=o2.session.path+"/widget/$SearchInput/"+this.options.style+"/css.wcss",this._loadCss(),this.load()},load:function(){this.fireEvent("queryLoad")&&(this.node=new Element("div",{styles:this.css.searchNode}),this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.node),this.searchAction=new Element("div",{styles:this.css.searchAction}).inject(this.searchBarNode),this.searchInputArea=new Element("div",{styles:this.css.searchInputArea}).inject(this.searchBarNode),this.input=new Element("input",{type:"text",styles:this.css.searchInputNode}).inject(this.searchInputArea),this.copyPrototype(),this.setEvent(),this.fireEvent("postLoad"))},copyPrototype:function(){this.inject=this.node.inject.bind(this.node),this.setStyle=this.node.setStyle.bind(this.node),this.setStyles=this.node.setStyles.bind(this.node),this.set=this.node.set.bind(this.node)},setEvent:function(){this.node.addEvent("mousedown",(function(t){t.stopPropagation()})),this.searchAction.addEvent("click",function(){this.doSearch()}.bind(this)),o2.UD.getDataJson("searchKeys",function(t){this.keys=t||[],this.input.addEvents({input:function(){if(this.keys&&this.keys.length){var t=this.input.get("value"),e=this.keys.filter((function(e){return-1!==e.indexOf(t)}));e=e.slice(0,9),this.showAutoCompleted(e)}}.bind(this),keydown:function(t){var e;(13===t.code&&(this.hideAutoCompleted(),this.doSearch()),38===t.code)&&(this.autoCompletedNode&&((e=this.currentKey?this.currentKey.getPrevious():this.autoCompletedNode.getLast())||(e=this.autoCompletedNode.getLast()),e&&(this.setCurrentKey(e),this.input.set("value",e.get("text")))));40===t.code&&(this.autoCompletedNode&&((e=this.currentKey?this.currentKey.getNext():this.autoCompletedNode.getFirst())||(e=this.autoCompletedNode.getFirst()),e&&(this.setCurrentKey(e),this.input.set("value",e.get("text")))))}.bind(this)})}.bind(this))},doSearch:function(){var t=this.input.get("value");if(t){if(this.keys){var e=this.keys.indexOf(t);-1===e?this.keys.length>=50&&json.shift():this.keys.splice(e,1),this.keys.push(t),o2.UD.putData("searchKeys",this.keys)}this.fireEvent("search",[t])}},showAutoCompleted:function(t){if(t.length){var e=this;if(!this.autoCompletedNode){this.autoCompletedNode=new Element("div",{styles:this.css.autoCompletedNode}).inject(this.node);var s=this.node.getSize();this.autoCompletedNode.setStyle("width",s.x+"px")}this.autoCompletedNode.empty(),this.autoCompletedNode.show(),this.hideAutoCompletedFun=this.hideAutoCompleted.bind(this),$(document.body).addEvent("mousedown",this.hideAutoCompletedFun),t.each(function(t){new Element("div",{styles:this.css.searchKeyItem,text:t}).inject(this.autoCompletedNode).addEvents({mouseover:function(){e.setCurrentKey(this)},mouseout:function(){e.removeCurrentKey(this)},click:function(){e.hideAutoCompleted(),e.input.set("value",this.get("text")),e.doSearch()}})}.bind(this))}else this.hideAutoCompleted()},setCurrentKey:function(t){this.currentKey&&this.removeCurrentKey(this.currentKey),this.currentKey=t,t.setStyles(this.css.searchKeyItem_over)},removeCurrentKey:function(t){this.currentKey==t&&(this.currentKey=null),t.setStyles(this.css.searchKeyItem)},hideAutoCompleted:function(){this.hideAutoCompletedFun&&$(document.body).removeEvent("mousedown",this.hideAutoCompletedFun),this.autoCompletedNode&&(this.autoCompletedNode.empty(),this.autoCompletedNode.hide())},getValue:function(){return this.input.get("value")},setValue:function(t){this.input.set("value",t)}});