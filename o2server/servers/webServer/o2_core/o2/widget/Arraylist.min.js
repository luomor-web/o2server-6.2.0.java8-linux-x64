o2.widget=o2.widget||{},o2.widget.Arraylist=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{title:"arraylist",htmlTitle:"",style:"default",isAdd:!0,isDelete:!0,isModify:!0},initialize:function(t,e){this.setOptions(e),this.node=$(t),this.container=new Element("div"),this.path=o2.session.path+"/widget/$Arraylist/",this.cssPath=o2.session.path+"/widget/$Arraylist/"+this.options.style+"/css.wcss",this._loadCss(),this.items=[]},load:function(t){this.fireEvent("queryLoad")&&(this.container.set("styles",this.css.container),this.container.inject(this.node),this.createTitleNode(),this.createContent(t),this.fireEvent("postLoad"))},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.container),this.options.isAdd&&(this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,events:{click:function(t){this.addNewItem(null,"top")}.bind(this)}}).inject(this.titleNode)),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode),this.options.htmlTitle&&this.titleTextNode.set("html",this.options.htmlTitle)},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container),this.contentItemsNode=new Element("div",{styles:this.css.contentItemsNode}).inject(this.contentNode),this.loadContent(t)},loadContent:function(t){t.each(function(t){var e=new o2.widget.Arraylist.Item(this,t);e.load(),e.itemNode.inject(this.contentItemsNode),this.items.push(e)}.bind(this))},addNewItem:function(t,e){if(this.notAddItem)this.notAddItem=!1;else{var i=new o2.widget.Arraylist.Item(this,"","");i.load(),t?i.itemNode.inject(t.itemNode,"after"):i.itemNode.inject(this.contentItemsNode,e),i.isNewItem=!0,i.editValue(),this.items.push(i)}},deleteItem:function(t){this.notAddItem=!1,this.items.erase(t),t.itemNode.destroy(),delete t,this.fireEvent("change")},toArray:function(){var t=this.contentItemsNode.getChildren("div"),e=[];return t.each((function(t){var i=t.retrieve("item");i.text&&e.push(i.text)})),e},getValue:function(){return this.toArray()},destroy:function(){this.fireEvent("destroy"),this.container.destroy(),o2.release(this)}}),o2.widget.Arraylist.Item=new Class({initialize:function(t,e){this.arraylist=t,this.text=e},load:function(){this.creatItemNode(),this.setItemEvents()},creatItemNode:function(){this.itemNode=new Element("div",{styles:this.arraylist.css.contentItemNode}),this.itemNode.store("item",this),this.iconNode=new Element("div",{styles:this.arraylist.css.contentItemIconNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.itemNode),this.valueNode=new Element("span",{styles:this.arraylist.css.contentItemValueNode,text:this.text}).inject(this.itemNode)},setItemEvents:function(){this.itemNode.addEvents({mouseover:function(t){t.target.setStyles(this.arraylist.css.contentItemNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.arraylist.css.contentItemNode)}.bind(this),click:function(t){this.arraylist.options.isAdd&&this.arraylist.addNewItem(this)}.bind(this)}),this.valueNodeClick=function(t){this.arraylist.options.isModify&&this.editValue(),t.stopPropagation()}.bind(this),this.valueNode.addEvent("click",this.valueNodeClick)},editValue:function(){this.editItem(this.valueNode,function(t){t&&this.valueNode.addEvent("click",this.valueNodeClick)}.bind(this)),this.valueNode.removeEvent("click",this.valueNodeClick)},editItem:function(t,e){var i=t.get("text");t.set("html","");var s=new Element("div",{styles:this.arraylist.css.editInputDiv}),n=new Element("input",{styles:this.arraylist.css.editInput,type:"text",value:i}).inject(s),o=o2.getTextSize(i+"a").x;n.setStyle("width",o),s.setStyle("width",o),s.inject(t),n.select(),n.addEvents({keydown:function(t){var e=o2.getTextSize(n.get("value")+"a").x;t.target.setStyle("width",e),t.target.getParent().setStyle("width",e),13==t.code&&(this.isEnterKey=!0,t.target.blur())}.bind(this),blur:function(i){var s=this.editItemComplate(t,i.target);e&&e(s)}.bind(this),click:function(t){t.stopPropagation()}.bind(this)})},editItemComplate:function(t,e){var i=e.get("value");i||this.arraylist.deleteItem(this);var s=!0;if(this.arraylist.items.each(function(t){t.text==i&&t!=this&&(s=!1)}.bind(this)),!s)return this.iconNode.setStyle("background","url("+this.arraylist.path+this.arraylist.options.style+"/icon/error.png) center center no-repeat"),this.iconNode.title=o2.LP.process.repetitionsValue,e.select(),!1;this.text=i,this.arraylist.notAddItem=!0;var n=!1;return this.isEnterKey&&(this.isNewItem&&(n=!0),this.editOkAddNewItem=!1),this.isNewItem=!1,t.set("html",i),this.iconNode.setStyle("background","transparent"),this.iconNode.title="",this.arraylist.fireEvent("change"),n?(this.arraylist.notAddItem=!1,this.arraylist.options.isAdd&&this.arraylist.addNewItem(this)):this.arraylist.notAddItem=!0,!0}});