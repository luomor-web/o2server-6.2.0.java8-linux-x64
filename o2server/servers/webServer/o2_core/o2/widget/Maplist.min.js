o2.widget=o2.widget||{},o2.widget.Maplist=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{title:"maplist",htmlTitle:"",style:"default",collapse:!1,isAdd:!0,isDelete:!0,isModify:!0,isProperty:!1},initialize:function(t,e){this.setOptions(e),this.node=$(t),this.container=new Element("div"),this.path=o2.session.path+"/widget/$Maplist/",this.cssPath=o2.session.path+"/widget/$Maplist/"+this.options.style+"/css.wcss",this._loadCss(),this.items=[]},load:function(t){if(this.fireEvent("queryLoad")&&(this.container.set("styles",this.css.container),this.container.inject(this.node),this.createTitleNode(),this.createContent(t),this.fireEvent("postLoad"),this.options.collapse)){var e=this.contentNode.getSize().y.toInt()-2;this.contentNode.store("showHeight",e),this.contentNode.setStyles({display:"none",height:"0px"})}},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.container),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode),this.options.htmlTitle&&this.titleTextNode.set("html",this.options.htmlTitle),this.titleTextNode.addEvent("click",function(){this.isShowCode||this.expandOrCollapse()}.bind(this)),this.createTitleActions()},createTitleActions:function(){this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.titleActionNode),this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)"),this.actionNode.addEvent("click",function(t){this.isShowingCode||this.showCode(),t.stopPropagation()}.bind(this))},showCode:function(){if(this.isShowCode)this.items=[],this.contentItemsNode.empty(),this.contentNode.setStyle("display","block"),this.loadContent(JSON.decode(this.codeTextNode.get("value"))),this.fireEvent("change"),this.codeContentNode.destroy(),this.codeContentNode=null,this.codeTextNode=null,this.contentNode.setStyle("display","block"),this.titleActionNode.setStyles({border:"1px solid #EEE",background:"transparent"}),this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)"),this.isShowCode=!1;else{this.codeContentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container),this.codeTextNode=new Element("textarea",{styles:this.css.codeTextNode,events:{blur:function(){this.showCode(),this.isShowingCode=!0,window.setTimeout(function(){this.isShowingCode=!1}.bind(this),1e3),this.fireEvent("change")}.bind(this)}}).inject(this.codeContentNode);var t=this.contentNode.getSize();this.codeTextNode.setStyle("height",t.y+"px"),o2.require("o2.widget.JsonParse",function(){this.json=new o2.widget.JsonParse(this.toJson(),null,this.codeTextNode),this.json.load()}.bind(this)),this.contentNode.setStyle("display","none"),this.titleActionNode.setStyles({border:"1px solid #999",background:"#FFF"}),this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code.png)"),this.isShowCode=!0}},reload:function(t){this.isShowCode?(this.contentItemsNode.empty(),this.loadContent(t),this.codeContentNode.destroy(),this.codeContentNode=null,this.codeTextNode=null,this.contentNode.setStyle("display","block"),this.titleActionNode.setStyles({border:"1px solid #EEE",background:"transparent"}),this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)"),this.isShowCode=!1):(this.contentItemsNode.empty(),this.loadContent(t))},addAction:function(t,e){var i=new Element("div",{styles:this.css.actionNode}).inject(this.titleActionNode);i.setStyle("background-image","url("+this.path+this.options.style+"/icon/"+t+")"),i.addEvent("click",e)},expandOrCollapse:function(){"none"!=this.contentNode.getStyle("display")?this.collapse():this.expand()},collapse:function(){this.morph||(this.morph=new Fx.Morph(this.contentNode,{duration:200}));var t=this.contentNode.getSize().y.toInt()-2;this.contentNode.store("showHeight",t),this.morph.start({height:[t,0]}).chain(function(){this.contentNode.setStyle("display","none")}.bind(this))},expand:function(){this.morph||(this.morph=new Fx.Morph(this.contentNode,{duration:200}));var t=this.contentNode.retrieve("showHeight");this.contentNode.setStyle("display","block"),this.morph.start({height:[0,t]}).chain(function(){this.contentNode.setStyle("height","auto")}.bind(this))},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container),this.contentStartNode=new Element("div",{styles:this.css.contentStartNode,text:"{"}).inject(this.contentNode),this.contentStartNode.addEvents({mouseover:function(t){t.target.setStyles(this.css.contentStartNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.css.contentStartNode)}.bind(this),click:function(t){this.options.isAdd&&this.addNewItem(null,"top")}.bind(this)}),this.contentItemsNode=new Element("div",{styles:this.css.contentItemsNode}).inject(this.contentNode),this.contentEndNode=new Element("div",{styles:this.css.contentEndNode,text:"}"}).inject(this.contentNode),this.contentEndNode.addEvents({mouseover:function(t){t.target.setStyles(this.css.contentEndNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.css.contentEndNode)}.bind(this),click:function(t){this.options.isAdd&&this.addNewItem(null,"bottom")}.bind(this)}),this.loadContent(t)},createItem:function(t,e){return new o2.widget.Maplist.Item(this,t,e)},loadContent:function(t){Object.each(t,(function(t,e){var i=this.createItem(t,e);i.load(),i.itemNode.inject(this.contentItemsNode),this.items.push(i)}),this)},addNewItem:function(t,e){if(this.notAddItem)this.notAddItem=!1;else{var i=this.createItem("","");i.load(),t?i.itemNode.inject(t.itemNode,"after"):i.itemNode.inject(this.contentItemsNode,e),i.isNewItem=!0,i.editKey(),this.items.push(i)}},deleteItem:function(t){var e=t.key;this.notAddItem=!1,this.items.erase(t),t.itemNode.destroy(),delete t,this.fireEvent("delete",[e]),this.fireEvent("change")},toJson:function(){var t={};return this.items.each((function(e){e.key&&(t[e.key]=e.value)})),t},getValue:function(){return this.toJson()},destroy:function(){this.fireEvent("destroy"),this.container.destroy(),o2.release(this)}}),o2.widget.Maplist.Item=new Class({initialize:function(t,e,i){this.maplist=t,this.key=i,this.value=e},load:function(){this.creatItemNode(),this.setItemEvents()},creatItemNode:function(){this.itemNode=new Element("div",{styles:this.maplist.css.contentItemNode}),this.iconNode=new Element("div",{styles:this.maplist.css.contentItemIconNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.itemNode),this.keyNode=new Element("span",{styles:this.maplist.css.contentItemKeyNode,text:this.key}).inject(this.itemNode),this.colonNode=new Element("span",{styles:this.maplist.css.contentItemColonNode,text:":"}).inject(this.itemNode),this.valueNode=new Element("span",{styles:this.maplist.css.contentItemValueNode,text:this.value}).inject(this.itemNode)},setItemEvents:function(){this.itemNode.addEvents({mouseover:function(t){t.target.setStyles(this.maplist.css.contentItemNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.maplist.css.contentItemNode)}.bind(this),click:function(t){this.maplist.options.isAdd&&this.maplist.addNewItem(this)}.bind(this)}),this.keyNodeClick=function(t){this.maplist.options.isModify&&this.editKey(this.keyNode),t.stopPropagation()}.bind(this),this.keyNode.addEvent("click",this.keyNodeClick),this.valueNodeClick=function(t){this.maplist.options.isModify&&this.editValue(),t.stopPropagation()}.bind(this),this.valueNode.addEvent("click",this.valueNodeClick)},editKey:function(){this.editItem(this.keyNode,function(t){t&&this.keyNode.addEvent("click",this.keyNodeClick)}.bind(this)),this.keyNode.removeEvent("click",this.keyNodeClick)},editValue:function(){this.editItem(this.valueNode,function(t){t&&this.valueNode.addEvent("click",this.valueNodeClick)}.bind(this)),this.valueNode.removeEvent("click",this.valueNodeClick)},editItem:function(t,e){var i=t.get("text");t.set("html","");var s=new Element("div",{styles:this.maplist.css.editInputDiv}),n=new Element("input",{styles:this.maplist.css.editInput,type:"text",value:i}).inject(s),o=o2.getTextSize(i+"a").x;n.setStyle("width",o),s.setStyle("width",o),s.inject(t),n.select(),n.addEvents({keydown:function(t){var e=o2.getTextSize(n.get("value")+"a").x;t.target.setStyle("width",e),t.target.getParent().setStyle("width",e),13==t.code&&(this.isEnterKey=!0,t.target.blur()),t.stopPropagation()}.bind(this),blur:function(i){var s=this.editItemComplate(t,i.target);e&&e(s)}.bind(this),click:function(t){t.stopPropagation()}.bind(this)})},editItemComplate:function(t,e){var i=!1,s=e.get("value");if(t==this.keyNode){s||this.maplist.deleteItem(this);var n=!0;if(this.maplist.items.each(function(t){t.key==s&&t!=this&&(n=!1)}.bind(this)),s&&this.maplist.options.isProperty)try{new Element("div").set(s,this.value||"")}catch(t){n=!1}if(!n)return this.iconNode.setStyle("background","url("+this.maplist.path+this.maplist.options.style+"/icon/error.png) center center no-repeat"),this.iconNode.title=o2.LP.process.repetitionsOrUnvalid,e.select(),!1;this.key!==s&&(i=!0),this.key=s,this.editValue(),this.maplist.notAddItem=!0}var o=!1;return t==this.valueNode&&(this.value!==s&&(i=!0),this.value=s,this.isEnterKey&&(this.isNewItem&&(o=!0),this.editOkAddNewItem=!1),this.isNewItem=!1),t.set("html",s),this.iconNode.setStyle("background","transparent "),this.iconNode.title="",i&&this.maplist.fireEvent("change"),o?(this.maplist.notAddItem=!1,this.maplist.options.isAdd&&this.maplist.addNewItem(this)):this.maplist.notAddItem=!0,!0}}),o2.widget.Maplist.Style=new Class({Implements:[Options,Events],Extends:o2.widget.Maplist,createItem:function(t,e){return new o2.widget.Maplist.Style.Item(this,t,e)}}),o2.widget.Maplist.Style.Item=new Class({Extends:o2.widget.Maplist.Item,imgKeys:["background","background-image"],creatItemNode:function(){this.itemNode=new Element("div",{styles:this.maplist.css.contentItemNode}),this.iconNode=new Element("div",{styles:this.maplist.css.contentItemIconNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.itemNode),this.keyNode=new Element("span",{styles:this.maplist.css.contentItemKeyNode,text:this.key}).inject(this.itemNode),this.colonNode=new Element("span",{styles:this.maplist.css.contentItemColonNode,text:":"}).inject(this.itemNode),-1==this.imgKeys.indexOf(this.key)?this.valueNode=new Element("span",{styles:this.maplist.css.contentItemValueNode,text:this.value}).inject(this.itemNode):this.valueNode=new Element("span",{styles:this.maplist.css.contentItemImgValueNode,text:"image"}).inject(this.itemNode)},setItemEvents:function(){this.itemNode.addEvents({mouseover:function(t){t.target.setStyles(this.maplist.css.contentItemNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.maplist.css.contentItemNode)}.bind(this),click:function(t){this.maplist.options.isAdd&&this.maplist.addNewItem(this)}.bind(this)}),this.keyNodeClick=function(t){this.maplist.options.isModify&&this.editKey(this.keyNode),t.stopPropagation()}.bind(this),this.keyNode.addEvent("click",this.keyNodeClick),-1==this.imgKeys.indexOf(this.key)?(this.valueNodeClick=function(t){this.maplist.options.isModify&&this.editValue(),t.stopPropagation()}.bind(this),this.valueNode.addEvent("click",this.valueNodeClick)):this.valueNode.addEvent("click",this.valueNodeEditImage.bind(this))},valueNodeEditImage:function(t){var e=this.valueNode.getPosition(this.valueNode.getOffsetParent()),i=this.maplist.app.content.getSize();e.y+200>i.y&&(e.y=i.y-200-10),e.y<0&&(e.y=10),e.x+500>i.x&&(e.x=i.x-500-10),e.x<0&&(e.x=10);var s=this;o2.require("o2.xDesktop.Dialog",function(){var t=new o2.xDesktop.Dialog({title:this.maplist.options.title+" - "+this.key,style:"settingStyle",top:e.y,left:e.x,fromTop:e.y,fromLeft:e.x,width:500,height:200,html:"",maskNode:this.maplist.app.content,container:this.maplist.app.content,buttonList:[{text:o2.LP.widget.ok,action:function(){s.saveImage(this)}},{text:o2.LP.widget.cancel,action:function(){this.close()}}]});t.show(),this.createImageContent(t)}.bind(this)),t.stopPropagation()},saveImage:function(t){this.textValue=this.valueInput.get("value"),this.value=this.imgUrl?"url("+this.imgUrl+") ":"",this.value+=this.textValue,this.maplist.fireEvent("change"),t.close()},createImageContent:function(t){var e=new Element("div",{styles:this.maplist.css.imageEditContent}).inject(t.content),i=new Element("div",{styles:this.maplist.css.imageEditArea}).inject(e);this.imgPreviewArea=new Element("div",{styles:this.maplist.css.imageEditPreview}).inject(i);var s=new Element("div",{styles:this.maplist.css.imageEditActionArea}).inject(i);this.uploadImageAction=new Element("div",{styles:this.maplist.css.imageEditActionNode,text:o2.LP.widget.uploadImg}).inject(s),this.clearImageAction=new Element("div",{styles:this.maplist.css.imageEditActionNode,text:o2.LP.widget.clearImg}).inject(s);var n=new Element("div",{styles:this.maplist.css.valueEditArea}).inject(e);this.valueInput=new Element("input",{styles:this.maplist.css.valueEditInput}).inject(n);var o=this.value.match(/(url\().+?\)/gi);this.imgUrl="",this.textValue=this.value,o&&o.length&&(this.imgUrl=o[0].substr(0,o[0].lastIndexOf(")")),this.imgUrl=this.imgUrl.substr(this.imgUrl.indexOf("(")+1,this.imgUrl.length),this.textValue=this.value.replace(/(url\().+?\)/i,"").trim()),this.valueInput.set("value",this.textValue),this.showImg(),this.uploadImageAction.addEvent("click",function(t){this.uploadImage()}.bind(this)),this.clearImageAction.addEvent("click",function(t){var e=this;this.maplist.app.confirm("infor",t,o2.LP.widget.clearImg_confirmTitle,o2.LP.widget.clearImg_confirm,300,100,(function(){e.clearImage(this)}),(function(){this.close()}))}.bind(this))},uploadImage:function(){this.fileNode||(this.fileNode=new Element("input.file",{styles:{display:"none"},type:"file",accept:"images/*"}).inject(this.itemNode),this.fileNode.addEvent("change",function(t){var e=this.fileNode.files[0];this.fileType=e.type,this.fileName=e.name,this.fileSize=e.size,this.loadImage(e)}.bind(this))),this.fileNode.click()},loadImage:function(t){var e=new FileReader;e.onload=function(){this.imgUrl=e.result,this.showImg()}.bind(this),e.readAsDataURL(t)},showImg:function(){if(this.imgPreviewArea.empty(),this.imgUrl){this.img=new Element("img",{styles:this.maplist.css.imageEditPreviewImg,src:this.imgUrl}).inject(this.imgPreviewArea);var t=this.img.getSize(),e=80/Math.max(t.x,t.y),i=t.y*e,s=t.x*e;this.img.setStyles({width:s+"px",height:i+"px"})}},clearImage:function(t){this.imgUrl="",this.showImg(),t.close()},editItemComplate:function(t,e){var i=!1,s=e.get("value");if(t==this.keyNode){s||this.maplist.deleteItem(this);var n=!0;if(this.maplist.items.each(function(t){t.key==s&&t!=this&&(n=!1)}.bind(this)),!n)return this.iconNode.setStyle("background","url("+this.maplist.path+this.maplist.options.style+"/icon/error.png) center center no-repeat"),this.iconNode.title=o2.LP.process.repetitions,e.select(),!1;this.key!==s&&(i=!0),this.key=s,-1==this.imgKeys.indexOf(this.key)&&this.editValue(),this.maplist.notAddItem=!0}var o=!1;return t==this.valueNode&&(this.value!==s&&(i=!0),this.value=s,this.isEnterKey&&(this.isNewItem&&(o=!0),this.editOkAddNewItem=!1),this.isNewItem=!1),t.set("html",s),this.iconNode.setStyle("background","transparent "),this.iconNode.title="",i&&this.maplist.fireEvent("change"),o?(this.maplist.notAddItem=!1,this.maplist.options.isAdd&&this.maplist.addNewItem(this)):this.maplist.notAddItem=!0,!0}});