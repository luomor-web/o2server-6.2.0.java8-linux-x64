o2.widget=o2.widget||{},o2.require("o2.widget.UUID",null,!1),o2.widget.MediaRecorder=o2.MediaRecorder=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",path:o2.session.path+"/widget/$MediaRecorder/",videoHeight:"232px",constraints:{audio:!0,video:!0},reference:"",referenceType:""},initialize:function(e,t){this.node=e,this.setOptions(t),this.path=this.options.path||o2.session.path+"/widget/$MediaRecorder/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.fireEvent("init")},load:function(){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node),this.checkBroswer()&&this.loadResource(function(){this._load()}.bind(this))},loadResource:function(e){COMMON.AjaxModule.load("../o2_lib/adapter/adapter.js",function(){e&&e()}.bind(this))},_load:function(){this.gumVideo=new Element("video",{styles:this.css.gumVideo,autoplay:!0,muted:!0}).inject(this.container),this.gumVideo.setStyles({height:parseInt(this.options.videoHeight)+"px",width:"calc(20em - 10px)"}),this.recordedVideo=new Element("video",{styles:this.css.recordedVideo,loop:!0,controls:!0}).inject(this.container),this.recordedVideo.setStyles({height:parseInt(this.options.videoHeight)+"px",width:"calc(20em - 10px)"});var e=new Element("div",{styles:this.css.toolbar}).inject(this.container);this.recordButton=new Element("button",{styles:this.css.recordButton,text:o2.LP.widget.startRecord,events:{click:function(){this.toggleRecording()}.bind(this)}}).inject(e),this.playButton=new Element("button",{styles:this.css.playButton,text:o2.LP.widget.play,disable:!0,events:{click:function(){this.play()}.bind(this)}}).inject(e),this.downloadButton=new Element("button",{styles:this.css.downloadButton,text:o2.LP.widget.download,disable:!0,events:{click:function(){this.download()}.bind(this)}}).inject(e),(this.mediaSource=new MediaSource).addEventListener("sourceopen",this.handleSourceOpen.bind(this),!1),navigator.mediaDevices.getUserMedia(this.options.constraints).then(this.handleSuccess.bind(this)).catch(this.handleError.bind(this)),this.recordedVideo.addEventListener("error",function(e){console.error("MediaRecording.recordedMedia.error()"),alert("Your browser can not play\n\n"+this.recordedVideo.src+"\n\n media clip. event: "+JSON.stringify(e))}.bind(this),!0)},handleSuccess:function(e){this.recordButton.disabled=!1,console.log("getUserMedia() got stream: ",e),this.stream=e,this.activeFlag=!0,this.gumVideo.srcObject=e},handleError:function(e){console.log("navigator.getUserMedia error: ",e)},handleSourceOpen:function(e){console.log("MediaSource opened"),this.sourceBuffer=this.mediaSource.addSourceBuffer('video/webm; codecs="vp8"'),console.log("Source buffer: ",this.sourceBuffer)},handleDataAvailable:function(e){e.data&&e.data.size>0&&this.recordedBlobs.push(e.data)},handleStop:function(e){console.log("Recorder stopped: ",e)},toggleRecording:function(){this.isRecording?(this.stopRecording(),this.recordButton.textContent=o2.LP.widget.startRecord,this.playButton.disabled=!1,this.downloadButton.disabled=!1,this.isRecording=!1):(this.startRecording(),this.recordButton.textContent=o2.LP.widget.completeRecord,this.isRecording=!0)},startRecording:function(){this.recordedBlobs=[];var e={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(e.mimeType)||(console.log(e.mimeType+" is not Supported"),e={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(e.mimeType)||(console.log(e.mimeType+" is not Supported"),e={mimeType:"video/webm"},MediaRecorder.isTypeSupported(e.mimeType)||(console.log(e.mimeType+" is not Supported"),e={mimeType:""})));try{var t=this.mediaRecorder=new MediaRecorder(this.stream,e)}catch(t){return console.error("Exception while creating MediaRecorder: "+t),void alert("Exception while creating MediaRecorder: "+t+". mimeType: "+e.mimeType)}console.log("Created MediaRecorder",t,"with options",e),this.recordButton.textContent="Stop Recording",this.playButton.disabled=!0,this.downloadButton.disabled=!0,t.onstop=this.handleStop.bind(this),t.ondataavailable=this.handleDataAvailable.bind(this),t.start(10),console.log("MediaRecorder started",t)},stopRecording:function(){this.mediaRecorder.stop(),console.log("Recorded Blobs: ",this.recordedBlobs),this.recordedVideo.controls=!0},play:function(){var e=new Blob(this.recordedBlobs,{type:"video/webm"}),t=this.recordedVideo;t.src=window.URL.createObjectURL(e),t.addEventListener("loadedmetadata",(function(){t.duration===1/0&&(t.currentTime=1e101,t.ontimeupdate=function(){t.currentTime=0,t.ontimeupdate=function(){delete t.ontimeupdate,t.play()}})}))},download:function(){var e=new Blob(this.recordedBlobs,{type:"video/webm"}),t=window.URL.createObjectURL(e),o=document.createElement("a");o.style.display="none",o.href=t,o.download="test.webm",document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),window.URL.revokeObjectURL(t)}),100)},getFormData:function(){var e=new FormData;return e.append("file",this.resizedImage,this.fileName),e},checkBroswer:function(){"https:"===location.protocol||"localhost"===location.hostname||(this.available=!1,this.container.set("html","<p>"+o2.LP.widget.requireHttps+"</p>"));var e=o2.MediaRecorder.getUnavailableBrowerFeatures();if(e.length>0){var t=e.map((function(e,t){return"<li>"+e+"</li>"})).join("");return this.available=!1,this.container.set("html","<p>"+o2.LP.widget.canNotToRecordVideo+"</p><ul>"+t+"</ul>"),!1}return!0},stopDevice:function(){if(this.sourceBuffer&&this.mediaSource.removeSourceBuffer(this.sourceBuffer),this.stream){for(var e=this.stream.getTracks(),t=0;t<e.length;t++)e[t].stop();this.stream=null,this.activeFlag=!1}},close:function(){this.stopDevice(),this.gumVideo&&this.gumVideo.destroy(),this.container.destroy()},isActive:function(){return!!this.activeFlag},reset:function(){}}),o2.MediaRecorder.getUnavailableBrowerFeatures=function(){var e=[];return window.navigator&&window.navigator.mediaDevices||e.push("mediaDevices"),window.Blob||e.push("Blob"),window.URL||e.push("URL"),window.MediaRecorder||e.push("MediaRecorder"),window.MediaSource||e.push("MediaSource"),e},o2.MediaRecorder.isAvailable=function(){return!("https:"!==location.protocol&&"localhost"!==location.hostname)&&!(o2.MediaRecorder.getUnavailableBrowerFeatures().length>0)};