o2.widget=o2.widget||{},o2.widget.JsonTemplate=new Class({Implements:[Options,Events],options:{},initialize:function(t,e,n){this.setOptions(n),this.json=t,this.html=e},load:function(){return this.fireEvent("queryLoad")&&(this.setContentText(),this.setContentFun(),this.setContentEach(),this.fireEvent("postLoad")),this.html},setContentText:function(){var t=this.html.match(/(text\{).+?\}/g);if(t&&t.length)for(var e=0;e<t.length;e++){var n=t[e].substr(0,t[e].lastIndexOf("}"));n=n.substr(n.indexOf("{")+1,n.length);var s=this.getJsonContent(this.json,n);this.html=this.html.replace(/(text\{).+?\}/,s)}},setContentFun:function(){var t=this.html.match(/(fun\{).+?\}/g);if(t&&t.length)for(var e=0;e<t.length;e++){var n=t[e].substr(0,t[e].lastIndexOf("}"));n=n.substr(n.indexOf("{")+1,n.length);var s=this.getJsonFunContent(this.json,n);this.html=this.html.replace(/(fun\{).+?\}/,s)}},getJsonContent:function(json,text){var $=json,f=eval("(x = function($){\n return "+text+";\n})");return returnValue=f.apply(json,[$]),void 0===returnValue&&(returnValue=""),returnValue=returnValue.toString(),returnValue||""},getJsonFunContent:function(json,text){var $=json,f=eval("(x = function($){\n "+text+";\n})");return returnValue=f.apply(json,[$]),returnValue||""},setContentEach:function(){var t=this.html.match(/(\{each\([\s\S]+\)\})[\s\S]+?(\{endEach\})/g);if(t&&t.length)for(var e=0;e<t.length;e++){var n=t[e].substr(0,t[e].indexOf(")")),s=(n=n.substr(n.indexOf("(")+1,n.length)).split(/,[\s]*/g);eachItemsPar=s[0],eachItemsCount=s[1].toInt();var h=this.getJsonContent(this.json,eachItemsPar);h&&0==eachItemsCount&&(eachItemsCount=h.length);var r=t[e].substr(0,t[e].lastIndexOf("{endEach}"));r=r.substr(r.indexOf("}")+1,r.length);var a=[];if(h)for(var i=0;i<Math.min(h.length,eachItemsCount);i++){var o=h[i];if(o){var l=r;if(texts=l.match(/(eachText\{).+?\}/g),texts&&texts.length)for(var u=0;u<texts.length;u++){var f=texts[u].substr(0,texts[u].lastIndexOf("}"));f=f.substr(f.indexOf("{")+1,f.length);var c=this.getJsonContent(o,f);l=l.replace(/(eachText\{).+?\}/,c)}a.push(l)}}this.html=this.html.replace(/(\{each\([\s\S]+\)\})[\s\S]+?(\{endEach\})/,a.join(""))}}});