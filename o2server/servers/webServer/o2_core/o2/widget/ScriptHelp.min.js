o2.widget=o2.widget||{},o2.require("o2.widget.Menu",null,!1),o2.widget.ScriptHelpCodes={},o2.widget.ScriptHelp=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{code:"code.json",style:"default"},initialize:function(t,e,i){this.setOptions(i),this.node=$(t),this.editor=e,this.path=o2.session.path+"/widget/$ScriptHelp/",this.cssPath=o2.session.path+"/widget/$ScriptHelp/"+this.options.style+"/css.wcss",this.load()},getEditor:function(){return null},load:function(){this.menu=new o2.widget.ScriptHelp.Menu(this.node,{event:"click",style:"script"}),this.menu.scriptHelp=this,this.menu.load(),o2.widget.ScriptHelpCodes[this.path+this.options.style+"/"+this.options.code]?(this.codeJson=o2.widget.ScriptHelpCodes[this.path+this.options.style+"/"+this.options.code],this.loadMenuItems(this.codeJson,this.menu),this.fireEvent("postLoad")):o2.getJSON(this.path+this.options.style+"/"+this.options.code,function(t){this.codeJson=t,this.loadMenuItems(this.codeJson,this.menu),o2.widget.ScriptHelpCodes[this.path+this.options.style+"/"+this.options.code]=t,this.fireEvent("postLoad")}.bind(this),!0,!0,!1)},loadMenuItems:function(t,e){t.each(function(t){if("-"==t)e.addMenuLine();else if("string"==typeOf(t.value))e.addMenuItem(t.name,"click",function(){var e=this.getEditor();e&&(e.insert(t.value),e.focus())}.bind(this));else{var i=new o2.widget.ScriptHelp.Menu(this.node,{style:"script"});i.load(),this.loadMenuItems(t.value,i),e.addMenuMenu(t.name,"",i)}}.bind(this))},show:function(){this.menu.showIm()}}),o2.widget.ScriptHelp.Menu=new Class({Extends:o2.widget.Menu,showIm:function(t){this.options.disable||(this.hide=this.hideIm.bind(this),this.fireEvent("queryShow",[t])&&(this.tmpBodyOncontextmenu=document.body.oncontextmenu,document.body.oncontextmenu=function(){return!1},this.pauseCount<=0?(this.setItemWidth(),this.node.setStyles({display:"block",opacity:this.options.opacity||1}),this.setPosition(t),$(document.body).removeEvent("mousedown",this.hide),$(document.body).addEvent("mousedown",this.hide),this.show=!0):this.pauseCount--,this.node.focus(),this.isSetKeyEvents||this.setKeyEvents(),this.fireEvent("postShow")))},setKeyEvents:function(){this.node.addEvent("keydown",function(t){this.keyMenuAction(t)}.bind(this)),this.isSetKeyEvents=!0},keyMenuAction:function(t){switch(t.key){case"down":this.keyMenuDown(t);break;case"up":this.keyMenuUp(t);break;case"left":this.keyMenuLeft(t);break;case"right":this.keyMenuRight(t);break;case"esc":this.keyMenuEsc(t);break;case"space":case"enter":this.keyMenuEnter(t)}},keyMenuDown:function(t){if(this.current){for(idx=this.items.indexOf(this.current),idx++;idx<this.items.length&&"line"==this.items[idx].type;)idx++;var e=this.items[idx];idx>=this.items.length&&(e=this.items[0]),e._menuItemMouseOver(t),"menu"==e.type&&this.node.focus()}else this.items[0]._menuItemMouseOver(t)},keyMenuUp:function(t){if(this.current){for(idx=this.items.indexOf(this.current),idx--;idx>=0&&"line"==this.items[idx].type;)idx--;var e=this.items[idx];idx<0&&(e=this.items[this.items.length-1]),e._menuItemMouseOver(t),"menu"==e.type&&this.node.focus()}else this.items[this.items.length-1]._menuItemMouseOver(t)},keyMenuRight:function(t){this.current&&"menu"==this.current.type&&(this.current.subMenu.showIm(),this.current.subMenu.node.focus(),this.current.subMenu.current=null,this.current.subMenu.keyMenuDown())},keyMenuLeft:function(t){this.topMenu&&(this.hideIm(),this.topMenu.node.focus())},keyMenuEsc:function(){this.topMenu?(this.hideIm(),this.topMenu.node.focus()):(this.hideIm(),this.scriptHelp.getEditor().focus())},keyMenuEnter:function(t){this.current&&this.current.doAction(),t.stopPropagation()}});