MWF.require("MWF.widget.Calendar",null,!1);var MWFCalendarWeekView=MWF.xApplication.Calendar.WeekView=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",date:""},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_Calendar/$WeekView/",this.cssPath="../x_component_Calendar/$WeekView/"+this.options.style+"/css.wcss",this._loadCss(),this.app=t,this.container=$(e),this.weekBegin=this.app.calendarConfig.weekBegin||"0",this.load()},load:function(){this.node=new Element("div.node",{styles:this.css.node}).inject(this.container),this.node.setStyle("position","relative"),this.resetNodeSize(),this.loadCalendar()},resetNodeSize:function(){var e=this.container.getSize().y-50;this.node.setStyle("height",e+"px"),this.calendar&&this.calendar.resetBodySize()},loadCalendar:function(){var e="";e=this.options.date?Date.parse(this.options.date):new Date,this.currentWeek=this.getWeekNumber(e),this.calendar=new MWFCalendarWeekView.Calendar(this,e)},hide:function(){new Fx.Morph(this.node,{duration:"300",transition:Fx.Transitions.Expo.easeOut}).start({opacity:0}).chain(function(){this.node.setStyle("display","none")}.bind(this))},show:function(){this.node.setStyles(this.css.node),new Fx.Morph(this.node,{duration:"800",transition:Fx.Transitions.Expo.easeOut}).start({opacity:1}).chain(function(){this.calendar.dataTable_WholeDay&&this.calendar.dataTable_WholeDay.setStyle("display","")}.bind(this))},reload:function(){this.calendar&&this.calendar.reLoadCalendar()},recordStatus:function(){var e="";return this.calendar&&(e=this.calendar.baseDate),{date:e.toString()}},destroy:function(){this.calendar&&this.calendar.destroy(),this.node.destroy()},getWeekNumber:function(e){var t=e.clone(),i=(7+e.getDay()-parseInt(this.weekBegin))%7;t.setDate(t.getDate()-i+3);var a=t.valueOf();return t.setMonth(0,1),4!=t.getDay()&&t.setMonth(0,1+(4-t.getDay()+7)%7),1+Math.ceil((a-t)/6048e5)}});MWFCalendarWeekView.DayWidth,MWFCalendarWeekView.HourHeight=48,MWFCalendarWeekView.DayHeight=24*MWFCalendarWeekView.HourHeight,MWFCalendarWeekView.DayMsec=864e5,MWFCalendarWeekView.WeekWidth,MWFCalendarWeekView.WeekMsec=7*MWFCalendarWeekView.DayMsec,MWFCalendarWeekView.Calendar=new Class({Implements:[Events],initialize:function(e,t){this.view=e,this.css=this.view.css,this.container=this.view.node,this.app=this.view.app,this.weekBegin=this.app.calendarConfig.weekBegin||"0",this.baseDate=t||new Date,this.today=new Date,this.load()},load:function(){this.date=this.getWeekStartTime(this.baseDate),this.weekStartTime=new Date(this.date.get("year"),this.date.get("month"),this.date.get("date"),0,0,0),this.weekStartTimeStr=this.weekStartTime.format("db");var e=this.date.clone().increment("day",6);this.weekEndTime=new Date(e.get("year"),e.get("month"),e.get("date"),23,59,59),this.weekEndTimeStr=this.weekEndTime.format("db"),this.titleNode=new Element("div",{styles:this.css.calendarTitleNode}).inject(this.container),this.titleTable=new Element("table.titleTable",{styles:this.css.titleTable,border:"0",cellPadding:"0",cellSpacing:"0"}).inject(this.container),this.scrollNode=new Element("div.scrollNode",{styles:this.css.scrollNode}).inject(this.container),this.contentWarpNode=new Element("div.contentWarpNode",{styles:this.css.contentWarpNode}).inject(this.scrollNode),this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.bodyNode=new Element("div.bodyNode",{styles:this.css.contentNode}).inject(this.contentContainerNode),this.bodyNode.setStyle("position","relative"),this.setTitleNode(),this.loadTitleTable(),this.loadBodyTable(),this.loadDataTable_WholeDay(),this.loadDataTable(),this.loadCalendar()},getWeekStartTime:function(e){var t=e.clone(),i=(7+e.getDay()-parseInt(this.weekBegin))%7;return t.decrement("day",i)},setTitleNode:function(){this.prevWeekNode=new Element("div",{styles:this.css.calendarPrevWeekNode}).inject(this.titleNode);var e=this.baseDate.format(this.app.lp.dateFormatMonth),t=this.view.getWeekNumber(this.baseDate),i=this.app.lp.weeklyViewTitle.replace("{month}",e).replace("{week}",t);this.titleTextNode=new Element("div",{styles:this.css.calendarTitleTextNode,text:i}).inject(this.titleNode),this.nextWeekNode=new Element("div",{styles:this.css.calendarNextWeekNode}).inject(this.titleNode),this.prevWeekNode.addEvents({mouseover:function(){this.prevWeekNode.setStyles(this.css.calendarPrevWeekNode_over)}.bind(this),mouseout:function(){this.prevWeekNode.setStyles(this.css.calendarPrevWeekNode)}.bind(this),mousedown:function(){this.prevWeekNode.setStyles(this.css.calendarPrevWeekNode_down)}.bind(this),mouseup:function(){this.prevWeekNode.setStyles(this.css.calendarPrevWeekNode_over)}.bind(this),click:function(){this.changeWeekPrev()}.bind(this)}),this.nextWeekNode.addEvents({mouseover:function(){this.nextWeekNode.setStyles(this.css.calendarNextWeekNode_over)}.bind(this),mouseout:function(){this.nextWeekNode.setStyles(this.css.calendarNextWeekNode)}.bind(this),mousedown:function(){this.nextWeekNode.setStyles(this.css.calendarNextWeekNode_down)}.bind(this),mouseup:function(){this.nextWeekNode.setStyles(this.css.calendarNextWeekNode_over)}.bind(this),click:function(){this.changeWeekNext()}.bind(this)}),this.titleTextNode.addEvents({mouseover:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this),mouseout:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode)}.bind(this),mousedown:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_down)}.bind(this),mouseup:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this)}),this.createWeekSelector()},changeWeekPrev:function(){this.date.decrement("week",1),this.baseDate=this.date;var e=this.baseDate.format(this.app.lp.dateFormatMonth),t=this.view.getWeekNumber(this.baseDate),i=this.app.lp.weeklyViewTitle.replace("{month}",e).replace("{week}",t);this.titleTextNode.set("text",i),this.reLoadCalendar()},changeWeekNext:function(){this.date.increment("week",1),this.baseDate=this.date;var e=this.baseDate.format(this.app.lp.dateFormatMonth),t=this.view.getWeekNumber(this.baseDate),i=this.app.lp.weeklyViewTitle.replace("{month}",e).replace("{week}",t);this.titleTextNode.set("text",i),this.reLoadCalendar()},changeWeekSelect:function(){this.monthSelector||this.createWeekSelector()},createWeekSelector:function(){this.weekCalendar=new MWFCalendarWeekView.WeekCalendar(this.titleTextNode,{style:"meeting_blue",weekBegin:this.weekBegin,target:this.node,baseDate:this.baseDate,onInit:function(){this.options.dayPath=this.options.path+this.options.style+"/day_week.html"},onQueryComplate:function(e,t,i){var a=new Date.parse(t);this.changeWeekTo(a)}.bind(this)})},changeWeekTo:function(e){this.baseDate=e,this.date=this.getWeekStartTime(e);var t=this.baseDate.format(this.app.lp.dateFormatMonth),i=this.view.getWeekNumber(this.baseDate),a=this.app.lp.weeklyViewTitle.replace("{month}",t).replace("{week}",i);this.titleTextNode.set("text",a),this.reLoadCalendar()},isToday:function(e){var t=new Date;return t.get("year")==e.get("year")&&(t.get("month")==e.get("month")&&t.get("date")==e.get("date"))},loadTitleTable:function(){var e=this;if(this.tableHead){t=this.date.clone();this.tableHead.getElements("th").each(function(e,i){if(0!=i){var a=(i-1+parseInt(this.weekBegin))%7;e.set("text",this.app.lp.weeks.arr[a]+"("+t.format("%d")+")"),e.store("date",t.format("%Y-%m-%d")),t.increment("day",1)}}.bind(this));t=this.date.clone();Object.each(this.wholeDayTdMap,function(e,i){e.store("dateStr",t.format("%Y-%m-%d")),t.increment("day",1)}.bind(this))}else{var t=this.date.clone(),i=this.tableHead=new Element("tr",{styles:this.css.calendarTableTitleTr}).inject(this.titleTable);new Element("th",{styles:this.css.calendarTableTh_hour}).inject(i);for(var a=0;a<7;a++){var s=(a+parseInt(this.weekBegin))%7,n=new Element("th",{styles:this.css.calendarTableTh,text:this.app.lp.weeks.arr[s]+"("+t.format("%m.%d")+")"}).inject(i);n.store("date",t.format("%Y-%m-%d")),n.addEvent("click",function(){e.app.toDay(this.retrieve("date"))}.bind(n)),t.increment("day",1)}var o=this.wholeDayTr=new Element("tr").inject(this.titleTable),h=new Element("td.calendarTableCell",{tdType:"hour",styles:this.css.calendarTableCell_hour}).inject(o);h.setStyle("min-height","80px");new Element("div",{text:"全天"}).inject(h);h.store("hour",a),this.wholeDayTdMap={};for(var t=this.date.clone(),d=0;d<7;d++)(h=this.wholeDayTdMap[d]=new Element("td",{tdType:"calendar",styles:this.css.calendarTableCell,index:d+1}).inject(o)).store("dateStr",t.format("%Y-%m-%d")),h.store("index",d),h.addEvent("click",function(e){this.setCurrentTd(e.target)}.bind(this)),h.addEvent("dblclick",function(e){this.cancelCurrentTd();var t=new MWF.xApplication.Calendar.EventForm(this,{},{startTime:Date.parse(e.target.retrieve("dateStr")),endTime:Date.parse(e.target.retrieve("dateStr")),isWholeday:!0},{app:this.app});t.view=this,t.create()}.bind(this)),new Drag(h,{onStart:function(e,t){this.cancelCurrentTd(),this.cellDragStart_wholeDay(e,t)}.bind(this),onDrag:function(e,t){this.cellDrag_wholeDay(e,t)}.bind(this),onComplete:function(e,t){this.completeDrag_wholeDay(e,t)}.bind(this)}),t.increment("day",1)}},loadBodyTable:function(){this.calendarTable=new Element("table.dragTable",{styles:this.css.calendarTable,height:"100%",border:"0",cellPadding:"0",cellSpacing:"0"}).inject(this.bodyNode),this.hourTdMap={},this.hourTrMap={};for(var e=0;e<24;e++){var t=new Element("tr").inject(this.calendarTable),i=new Element("td.calendarTableCell",{tdType:"hour",styles:this.css.calendarTableCell_hour,valign:"top"}).inject(t);new Element("div",{text:e+":00"}).inject(i);i.store("hour",e);for(var a=0;a<7;a++){this.hourTdMap[a]||(this.hourTdMap[a]={}),(i=this.hourTdMap[a][e]=new Element("td",{tdType:"calendar",styles:this.css.calendarTableCell,index:a+1}).inject(t)).store("hour",e),i.store("index",a),i.addEvent("click",function(e){this.setCurrentTd(e.target)}.bind(this)),i.addEvent("dblclick",function(e){this.cancelCurrentTd();var t=e.target.retrieve("hour"),i=e.target.retrieve("index"),a=this.getDateByIndex(i),s=new MWF.xApplication.Calendar.EventForm(this,{},{startTime:Date.parse(a+" "+t+":00"),endTime:Date.parse(a+" "+(t+1)+":00")},{app:this.app});s.view=this,s.create()}.bind(this)),new Drag(i,{onStart:function(e,t){this.cancelCurrentTd(),this.cellDragStart(e,t)}.bind(this),onDrag:function(e,t){this.cellDrag(e,t)}.bind(this),onComplete:function(e,t){this.completeDrag(e,t)}.bind(this)})}this.hourTrMap[e]=t}},setCurrentTd:function(e){if(e.setStyle("background-color","#fffdf2"),this.currentSelectedTd){var t=this.currentSelectedTd.retrieve("index")==this.todayIndex;this.currentSelectedTd.setStyle("background-color",t?"#F8FBFF":"#fff")}this.currentSelectedTd=e},cancelCurrentTd:function(){if(this.currentSelectedTd){var e=this.currentSelectedTd.retrieve("index")==this.todayIndex;this.currentSelectedTd.setStyle("background-color",e?"#F8FBFF":"#fff")}this.currentSelectedTd=null},reLoadCalendar:function(){this.weekStartTime=new Date(this.date.get("year"),this.date.get("month"),this.date.get("date"),0,0,0),this.weekStartTimeStr=this.weekStartTime.format("db");var e=this.date.clone().increment("day",6);this.weekEndTime=new Date(e.get("year"),e.get("month"),e.get("date"),23,59,59),this.weekEndTimeStr=this.weekEndTime.format("db"),Object.each(this.dayMap||{},function(e){e.destroy()}.bind(this)),this.dayMap={},this.wholeday&&this.wholeday.destroy(),this.wholeday=null,this.loadTitleTable(),this.loadCalendar()},loadCalendar:function(){this.app.currentDate=this.baseDate.clone(),this.dateIndexMap=null,this.titleTable.getElement("td:nth-child(1)").setStyle("height","auto"),this.loadData(function(){this.loadWholeday(this.wholeDayData),this.loadDataDay(this.inOneDayEvents),this.resetBodySize(),this.setTodayTds(),this.cancelCurrentTd()}.bind(this))},setTodayTds:function(){var e=new Date,t=this.todayIndex=this.getDateNumOfWeek(e.format("%Y-%m-%d")),i=e.get("hours"),a=e.get("minutes");if(a=a<2?2:a,t>-1){this.todayTds=[];var s=this.wholeDayTdMap[t];s.setStyle("background-color","#f8fbff"),this.todayTds.push(s);var n=this.hourTdMap[t];Object.each(n,function(e,t){e.setStyle("background-color","#f8fbff"),this.todayTds.push(e)}.bind(this)),this.nowTd=n[i];var o=this.nowTd.getPosition(this.bodyNode);this.nowTimeNode=new Element("div",{styles:{position:"absolute",left:o.x,top:o.y+(a-2)/60*MWFCalendarWeekView.HourHeight,height:"2px",width:MWFCalendarWeekView.DayWidth,"background-color":"#ff3333"}}).inject(this.bodyNode)}else if(this.todayTds&&this.todayTds.length){for(;this.todayTds.length>0;)this.todayTds.pop().setStyle("background-color","#fff");this.nowTd&&(this.nowTd=null),this.nowTimeNode&&this.nowTimeNode.destroy()}},loadData:function(e){this.app.actions.listEventWithFilter({calendarIds:this.app.getSelectedCalendarId(),startTime:this.weekStartTimeStr,endTime:this.weekEndTimeStr},function(t){this.wholeDayData=t.data&&t.data.wholeDayEvents?t.data.wholeDayEvents:[],this.inOneDayEvents=[],(t.data&&t.data.inOneDayEvents?t.data.inOneDayEvents:[]).each(function(e){e.inOneDayEvents.length>0&&this.inOneDayEvents.push(e)}.bind(this)),e&&e()}.bind(this))},loadDataTable_WholeDay:function(e){this.dataTable_WholeDay=new Element("table.dataTable",{styles:this.css.calendarTable,border:"0",cellPadding:"0",height:"0",cellSpacing:"0"}).inject(this.container),this.dataTable_WholeDay.setStyles({display:"none",position:"absolute",top:"92px",left:"0px",margin:"0px auto 0px 12px"});var t=new Element("tr").inject(this.dataTable_WholeDay);new Element("td",{styles:{height:"0px",position:"relative"}}).inject(t),this.dataTd_WholeDay=new Element("td",{valign:"top",styles:{height:"0px",position:"relative"}}).inject(t)},loadWholeday:function(e){this.wholeday=new MWFCalendarWeekView.Calendar.WholeDay(this,e,this.date)},loadDataTable:function(e){this.dataTable=new Element("table.dataTable",{styles:this.css.calendarTable,height:"0",border:"0",cellPadding:"0",cellSpacing:"0"}).inject(this.bodyNode),this.dataTable.setStyles({position:"absolute",top:"0px",left:"0px"});var t=new Element("tr").inject(this.dataTable);new Element("td",{styles:{height:"0px",position:"relative"}}).inject(t),this.dataTdMap={};for(var i=0;i<7;i++)this.dataTdMap[i]=new Element("td",{styles:{height:"0px",position:"relative"},index:i}).inject(t)},getDateIndexMap:function(){if(!this.dateIndexMap){var e=this.getWeekStartTime(this.baseDate);this.dateIndexMap={};for(var t=0;t<7;t++){var i=e.format("%Y-%m-%d");this.dateIndexMap[i]=t,e.increment()}}return this.dateIndexMap},getDateByIndex:function(e){var t=this.getDateIndexMap();for(var i in t)if(t[i]==e)return i},getDateNumOfWeek:function(e){this.getDateIndexMap();return this.dateIndexMap[e]},loadDataDay:function(e){this.dayMap={},e.each(function(e){var t=e.eventDate,i=this.dataTdMap[this.getDateNumOfWeek(t)];i&&this.loadDay(i,t,e.inOneDayEvents)}.bind(this))},loadDay:function(e,t,i){var a=Date.parse(t),s=a.get("month"),n=a.get("year"),o=a.get("date");new Date(n,s,o,0,0,0),new Date(n,s,o,23,59,59);this.dayMap[t]=new MWFCalendarWeekView.Calendar.Day(e,a,this,i)},resetBodySize:function(){var e=this.container.getSize(),t=this.titleNode.getSize(),i=this.titleTable.getSize(),a=e.y-t.y-i.y;this.contentWarpNode&&this.contentWarpNode.setStyles({width:e.x-40+"px"}),this.scrollNode.setStyle("height",a+"px");MWFCalendarWeekView.WeekWidth=e.x-40-60;var s=MWFCalendarWeekView.DayWidth=Math.floor((MWFCalendarWeekView.WeekWidth-8)/7);this.calendarTable&&(this.calendarTable.setStyles({width:e.x-40+"px"}),(o=this.calendarTable.getElement("tr:nth-child(1)")).getElements("td").each((function(e,t){e.setStyle("width",(0==t?60:s)+"px")})));this.titleTable&&(this.titleTable.setStyles({width:e.x-40+"px"}),(o=this.titleTable.getElement("tr:nth-child(1)")).getElements("th").each((function(e,t){e.setStyle("width",(0==t?60:s)+"px")})));this.dataTable&&(this.dataTable.setStyles({width:e.x-40+"px"}),(o=this.dataTable.getElement("tr:nth-child(1)")).getElements("td").each((function(e,t){e.setStyle("width",(0==t?60:s)+"px")})));for(var n in this.dayMap)this.dayMap[n].resize();if(this.dataTable_WholeDay){this.dataTable_WholeDay.setStyles({width:e.x-40+"px"});var o=this.dataTable_WholeDay.getElement("tr:nth-child(1)"),h=e.x-40-60-2;o.getElements("td").each((function(e,t){e.setStyle("width",(0==t?60:h)+"px")}))}this.wholeday&&this.wholeday.resize(),this.nowTimeNode&&(this.nowTimeNode.setStyle("width",s),this.nowTd&&this.nowTimeNode.setStyle("left",this.nowTd.getPosition(this.bodyNode).x))},reload:function(){this.view.reload()},destroy:function(){Object.each(this.dayMap||{},function(e){e.destroy()}.bind(this)),this.wholeday&&this.wholeday.destroy(),this.container.empty()},getIndexByPage:function(e){var t=this.calendarTable.getPosition();this.calendarTableFirstTd||(this.calendarTableFirstTd=this.calendarTable.getElement("td")),t.x=t.x+this.calendarTableFirstTd.getSize().x;var i=(e.x-t.x)/(MWFCalendarWeekView.DayWidth+1);if(i<0||i>7)return null;this.pageOffsetHeight=e.y-t.y;var a=(e.y-t.y)/MWFCalendarWeekView.HourHeight;return a<0||a>24?null:{row:Math.floor(a),col:Math.floor(i)}},getIndexListByRange:function(e,t){var i,a,s,n;e.col==t.col?e.row<=t.row?(i=e,a=t):(i=t,a=e):e.col<t.col?(i=e,a=t):(i=t,a=e);for(var o=[],h=i.col;h<=a.col;h++){s=h==i.col?i.row:0,n=h==a.col?a.row:23;for(var d=s;d<=n;d++)o.push(h+"_"+d)}return o},getTdByIndexString:function(e){var t=e.split("_"),i=t[0],a=t[1];return this.hourTdMap[i][a]},cellDragStart:function(e,t){e.store("index",this.getIndexByPage(t.page)),this.scrollNodeHeight=this.scrollNode.getSize().y},cellDrag:function(e,t){var i=e.retrieve("index"),a=this.getIndexByPage(t.page);if(a){var s=this.getIndexListByRange(i,a),n=this.todayIndex>-1;if(this.selectedIndexRange){this.selectedIndexRange;this.selectedIndexRange.each(function(e){s.contains(e)||this.getTdByIndexString(e).setStyle("background-color",n&&e.split("_")[0]==this.todayIndex?"#F8FBFF":"#fff")}.bind(this)),s.each(function(e){this.selectedIndexRange.contains(e)||this.getTdByIndexString(e).setStyle("background-color","#fffdf2")}.bind(this))}else for(var o=0;o<s.length;o++)this.getTdByIndexString(s[o]).setStyle("background-color","#fffdf2");this.selectedIndexRange=s;var h=this.scrollNode.getScroll().y;this.pageOffsetHeight+1.5*MWFCalendarWeekView.HourHeight>this.scrollNodeHeight+h?window.setTimeout(function(){this.scrollNode.scrollTo(0,h+MWFCalendarWeekView.HourHeight)}.bind(this),200):this.pageOffsetHeight-1.5*MWFCalendarWeekView.HourHeight<h&&window.setTimeout(function(){this.scrollNode.scrollTo(0,h-MWFCalendarWeekView.HourHeight)}.bind(this),200)}},completeDrag:function(e,t){var i=this.todayIndex>-1;if(this.selectedIndexRange&&this.selectedIndexRange.length){this.selectedIndexRange.each(function(e){this.getTdByIndexString(e).setStyle("background-color",i&&e.split("_")[0]==this.todayIndex?"#F8FBFF":"#fff")}.bind(this));var a=this.selectedIndexRange[0].split("_"),s=this.selectedIndexRange.getLast().split("_"),n=this.getDateByIndex(a[0])+" "+a[1]+":00",o=this.getDateByIndex(s[0])+" "+s[1]+":59",h=new MWF.xApplication.Calendar.EventForm(this,{},{startTime:n,endTime:o},{app:this.app});h.view=this,h.create(),this.selectedIndexRange=null}},getIndexByPage_wholeDay:function(e){var t=this.wholeDayTr.getPosition();this.wholeDayFirstTd||(this.wholeDayFirstTd=this.wholeDayTr.getElement("td")),t.x=t.x+this.wholeDayFirstTd.getSize().x;var i=(e.x-t.x)/(MWFCalendarWeekView.DayWidth+1);return i<0||i>7?null:Math.floor(i)},getIndexListByRange_wholeDay:function(e,t){for(var i=Math.min(e,t),a=Math.max(e,t),s=[],n=i;n<=a;n++)s.push(n);return s},cellDragStart_wholeDay:function(e,t){e.store("index",this.getIndexByPage_wholeDay(t.page))},cellDrag_wholeDay:function(e,t){var i=e.retrieve("index"),a=this.getIndexByPage_wholeDay(t.page);if(a){var s=this.getIndexListByRange_wholeDay(i,a),n=this.todayIndex>-1;if(this.selectedIndexRange_wholeDay){this.selectedIndexRange_wholeDay;this.selectedIndexRange_wholeDay.each(function(e){s.contains(e)||this.wholeDayTdMap[e].setStyle("background-color",n&&e==this.todayIndex?"#F8FBFF":"#fff")}.bind(this)),s.each(function(e){this.selectedIndexRange_wholeDay.contains(e)||this.wholeDayTdMap[e].setStyle("background-color","#fffdf2")}.bind(this))}else for(var o=0;o<s.length;o++)this.wholeDayTdMap[s[o]].setStyle("background-color","#fffdf2");this.selectedIndexRange_wholeDay=s}},completeDrag_wholeDay:function(e,t){var i=this.todayIndex>-1;if(this.selectedIndexRange_wholeDay&&this.selectedIndexRange_wholeDay.length){this.selectedIndexRange_wholeDay.each(function(e){this.wholeDayTdMap[e].setStyle("background-color",i&&e==this.todayIndex?"#F8FBFF":"#fff")}.bind(this));var a=this.selectedIndexRange_wholeDay[0],s=this.selectedIndexRange_wholeDay.getLast(),n=this.getDateByIndex(a),o=this.getDateByIndex(s),h=new MWF.xApplication.Calendar.EventForm(this,{},{startTime:n,endTime:o,isWholeday:!0},{app:this.app});h.view=this,h.create(),this.selectedIndexRange_wholeDay=null}}}),MWFCalendarWeekView.Calendar.WholeDay=new Class({Implements:[Events],initialize:function(e,t,i){this.calendar=e,this.view=this.calendar.view,this.css=this.calendar.css,this.app=this.calendar.app,this.date=i.clone(),this.data=t,this.load()},load:function(){this.weekStartTime=this.calendar.weekStartTime,this.weekEndTime=this.calendar.weekEndTime,this.rangeList=[],this.rangeObject={},this.data.each(function(e,t){var i=this.getTimeRange(e.startTime,e.endTime);if(!i)return null;e.range=i,e.range.id=e.id,e.range.data=e,this.rangeList.push(i),this.rangeObject[e.id]=i}.bind(this));var e={};for(var t in this.rangeList.each(function(t){t.days.each(function(t){e[t]=e[t]?e[t]+1:1}.bind(this))}.bind(this)),this.maxDayLength=0,e)e[t]>this.maxDayLength&&(this.maxDayLength=e[t]);this.maxDayLength&&this.calendar.titleTable.getElement("td:nth-child(1)").setStyle("height",24*this.maxDayLength),this.usefulTdFlagArray=[];for(var i=0;i<this.maxDayLength;i++){for(var a=[],s=0;s<7;s++)a.push(!0);this.usefulTdFlagArray.push(a)}this.sortRange(),this.documentList=[],this.rangeList.each(function(e,t){var i=e.data;if(!i)return null;this.documentList.push(new MWFCalendarWeekView.Calendar.WholeDayDocument(this,i,e))}.bind(this))},sortRange:function(){this.rangeList.sort(function(e,t){return e.days[0]>t.days[0]?1:e.days[0]<t.days[0]?-1:t.diff-e.diff}.bind(this))},getTimeRange:function(e,t){var i=Date.parse(e);if((a=Date.parse(t))<this.weekStartTime||i>this.weekEndDate)return null;i<this.weekStartTime&&(i=this.weekStartTime.clone()),this.weekEndTime<a&&(a=this.weekEndTime.clone());for(var a=new Date(a.get("year"),a.get("month"),a.get("date"),23,59,59),s=[];i<a;)s.push(i.clone().format("%Y-%m-%d")),i.increment();return{start:i=Date.parse(e),end:a=Date.parse(t),days:s,diff:a-i}},resize:function(){this.documentList&&this.documentList.each(function(e){e.resize()}.bind(this))},destroy:function(){if(this.documentList){for(;this.documentList.length;)this.documentList.pop().destroy();this.calendar.dataTd_WholeDay.empty()}}}),MWFCalendarWeekView.Calendar.WholeDayDocument=new Class({initialize:function(e,t,i){this.day=e,this.calendar=e.calendar,this.view=this.calendar.view,this.css=this.calendar.css,this.app=this.calendar.app,this.date=e.date.clone(),this.data=t,this.range=i,this.load()},load:function(){this.container=this.calendar.dataTd_WholeDay;this.items=[];this.data.timeStart=Date.parse(this.data.startTime),this.data.timeEnd=Date.parse(this.data.endTime),this.getUsefulTdYIndex(),this.createNode()},getUsefulTdYIndex:function(){for(var e=0;e<this.day.maxDayLength;e++){for(var t=!0,i=0;i<this.range.days.length;i++){var a=this.calendar.getDateNumOfWeek(this.range.days[i]);if(!this.day.usefulTdFlagArray[e][a]){t=!1;break}}if(t){this.yIndex=e;for(i=0;i<this.range.days.length;i++){a=this.calendar.getDateNumOfWeek(this.range.days[i]);this.day.usefulTdFlagArray[e][a]=!1}break}}},createNode:function(){var e=this.lightColor=MWFCalendar.ColorOptions.getLightColor(this.data.color),t=this.node=new Element("div",{styles:{position:"absolute","background-color":"#cae2ff",overflow:"hidden",height:"20px","line-height":"20px","border-top":"1px solid "+e,"border-bottom":"1px solid "+e},events:{click:function(){var e=new MWF.xApplication.Calendar.EventForm(this,this.data,{isFull:!0},{app:this.app});e.view=this.view,this.calendar.app.isEventEditable(this.data)?e.edit():e.open()}.bind(this),mouseover:function(){this.node.setStyle("border-color",this.data.color)}.bind(this),mouseout:function(){this.node.setStyle("border-color",this.lightColor)}.bind(this)}}).inject(this.container);t.setStyles(this.getCoordinate()),this.startTimeOutRange||t.setStyles({"border-left":"1px solid "+e,"border-top-left-radius":"10px","border-bottom-left-radius":"10px"}),this.endTimeOutRange||t.setStyles({"border-right":"1px solid "+e,"border-top-right-radius":"10px","border-bottom-right-radius":"10px"});new Element("div",{styles:{"font-size":"10px","padding-left":"2px",float:"left"},text:this.data.timeStart.format("%m-%d %H:%M")+MWF.xApplication.Calendar.LP.to+this.data.timeEnd.format("%m-%d %H:%M")}).inject(t),new Element("div",{styles:{"padding-left":"5px","font-size":"12px",float:"left"},text:this.data.title}).inject(t);this.tooltip=new MWF.xApplication.Calendar.EventTooltip(this.app.content,this.node,this.app,this.data,{axis:"y",delay:350}),this.tooltip.view=this.view},getCoordinate:function(){this.data,this.range;var e=24*this.yIndex,t=this.day.weekStartTime,i=this.day.weekEndTime;this.data.timeStart<t?this.startTimeOutRange=!0:(this.startTimeOutRange=!1,t=this.data.timeStart),this.data.timeEnd>i?this.endTimeOutRange=!0:(this.endTimeOutRange=!1,i=this.data.timeEnd);var a=(i-t)/MWFCalendarWeekView.WeekMsec*MWFCalendarWeekView.WeekWidth-2;return{top:e+2,left:(t-this.day.weekStartTime)/MWFCalendarWeekView.WeekMsec*MWFCalendarWeekView.WeekWidth+3,width:a}},resize:function(){this.node.setStyles(this.getCoordinate())},reload:function(){this.tooltip&&this.tooltip.destroy(),this.view.reload()},destroy:function(){this.tooltip&&this.tooltip.destroy(),this.node.destroy()}}),MWFCalendarWeekView.Calendar.Day=new Class({Implements:[Events],initialize:function(e,t,i,a){this.container=e,this.calendar=i,this.view=this.calendar.view,this.css=this.calendar.css,this.app=this.calendar.app,this.date=t.clone(),this.data=a,this.calendars=[],this.load()},load:function(){this.day=this.date.getDate(),this.month=this.date.getMonth(),this.year=this.date.getFullYear(),this.startTime=new Date(this.year,this.month,this.day,0,0,0),this.endTime=new Date(this.year,this.month,this.day,23,59,59),this.rangeList=[],this.rangeObject={},this.data.each(function(e,t){var i=this.getTimeRange(e.startTime,e.endTime);if(!i)return null;e.range=i,e.range.id=e.id,this.rangeList.push(i),this.rangeObject[e.id]=i}.bind(this)),this.sortRange();var e=this.data.length;this.documentList=[],this.data.each(function(t,i){var a=t.range;if(a.dayRangeCount=e,a.index=this.rangeList.indexOf(a),!a)return null;this.documentList.push(new MWFCalendarWeekView.Calendar.Document(this.container,this,t,a))}.bind(this))},sortRange:function(){this.rangeList.sort((function(e,t){return e.startTime-t.startTime}))},getTimeRange:function(e,t){var i="string"==typeOf(e)?Date.parse(e):e,a="string"==typeOf(t)?Date.parse(t):t;if(a<=this.startTime)return null;if(this.endTime<=i)return null;var s={start:i<=this.startTime?[0,0,0]:[i.get("hr"),i.get("min"),i.get("sec")],end:this.endTime<=a?[23,59,59]:[a.get("hr"),a.get("min"),a.get("sec")]};return s.startTime=new Date(this.year,this.month,this.day,s.start[0],s.start[1],s.start[2]),s.endTime=new Date(this.year,this.month,this.day,s.end[0],s.end[1],s.end[2]),s.diff=s.endTime-s.startTime,s},resize:function(){this.documentList&&this.documentList.each(function(e){e.resize()}.bind(this))},reload:function(){this.view.reload()},destroy:function(){for(;this.documentList.length>0;)this.documentList.pop().destroy();this.container.empty()}}),MWFCalendarWeekView.Calendar.Document=new Class({initialize:function(e,t,i,a,s){this.container=e,this.day=t,this.calendar=t.calendar,this.view=this.calendar.view,this.css=this.calendar.css,this.app=this.calendar.app,this.date=t.date.clone(),this.data=i,this.range=a,this.coordinate=s,this.load()},load:function(){var e=this.lightColor=MWFCalendar.ColorOptions.getLightColor(this.data.color),t=this.node=new Element("div",{styles:{position:"absolute",border:"1px solid "+e,"background-color":e,overflow:"hidden","border-radius":"5px"},events:{click:function(){var e=new MWF.xApplication.Calendar.EventForm(this,this.data,{isFull:!0},{app:this.app});e.view=this.view,this.calendar.app.isEventEditable(this.data)?e.edit():e.open()}.bind(this),mouseover:function(){this.node.setStyle("border-color",this.data.color)}.bind(this),mouseout:function(){this.node.setStyle("border-color",this.lightColor)}.bind(this)}}).inject(this.container);t.setStyles(this.getCoordinate());new Element("div",{styles:{"font-size":"10px","padding-top":"2px","padding-left":"2px"},text:this.range.startTime.format("%H:%M")+"-"+this.range.endTime.format("%H:%M")}).inject(t),new Element("div",{styles:{"padding-top":"7px","padding-left":"5px","font-size":"12px"},text:this.data.title}).inject(t);this.tooltip=new MWF.xApplication.Calendar.EventTooltip(this.app.content,this.node,this.app,this.data,{axis:"x",delay:350}),this.tooltip.view=this.view},resize:function(){this.node.setStyles(this.getCoordinate())},getCoordinate:function(){this.data;var e=this.range,t=4,i=0;"ie"===Browser.name&&(t=4,i=-2);var a=Math.floor((e.endTime-e.startTime)/MWFCalendarWeekView.DayMsec*MWFCalendarWeekView.DayHeight)-t;a<16&&(a=16);var s=Math.floor((e.startTime-this.day.startTime)/MWFCalendarWeekView.DayMsec*MWFCalendarWeekView.DayHeight)-i,n=Math.floor(MWFCalendarWeekView.DayWidth/this.range.dayRangeCount)-5;return{top:s,left:(n+5)*this.range.index+3,width:n,height:a}},reload:function(){this.tooltip&&this.tooltip.destroy(),this.view.reload()},destroy:function(){this.tooltip&&this.tooltip.destroy(),this.node.destroy()}}),MWFCalendarWeekView.WeekCalendar=new Class({Extends:MWF.widget.Calendar,initialize:function(e,t){this.options.weekBegin="0",Locale.use("zh-CHS"),this.options.defaultTime=this.options.baseDate.getHours()+":"+this.options.baseDate.getMinutes()+":"+this.options.baseDate.getSeconds(),this.setOptions(t),this.path=MWF.defaultPath+"/widget/$Calendar/",this.cssPath=MWF.defaultPath+"/widget/$Calendar/"+this.options.style+"/css.wcss",this._loadCss(),this.options.format||(this.options.isTime?this.options.timeOnly?this.options.format="%H:%M":this.options.format=Locale.get("Date").shortDate+" %H:%M":this.options.format=Locale.get("Date").shortDate),this.options.containerPath=this.options.path+this.options.style+"/container.html",this.options.dayPath=this.options.path+this.options.style+"/day_week.html",this.options.monthPath=this.options.path+this.options.style+"/month.html",this.options.yearPath=this.options.path+this.options.style+"/year.html",this.options.timePath=this.options.path+this.options.style+"/time.html",this.today=new Date,this.currentView=this.options.defaultView,this.node=$(e),this.visible=!1,this.container=this.createContainer(),this.container.inject(this.options.target||$(document.body)),this.contentTable=this.createContentTable(),this.contentTable.inject(this.contentDateNode),this.addEvents(),this.container.set({styles:{display:"none",opacity:1}}),this.fireEvent("init")},showDay:function(e,t){this._setDayTitle(null,e,t),this._setDayWeekTitleTh(),this._setDayDate(null,e,t)},_setDayTitle:function(e,t,i){var a,s=null!=t?t:this.options.baseDate.getFullYear(),n=null!=i?i:this.options.baseDate.getMonth();n++,a="zh"===MWF.language.substr(0,2)?s+MWF.xApplication.Calendar.LP.year+n+MWF.xApplication.Calendar.LP.month:s+"-"+n;var o=e||this.currentTextNode;o.set("text",a),o.store("year",s),o.store("month",n)},_setDayWeekTitleTh:function(e){var t=(e||this.contentTable).getElement("thead").getElements("th");this.css.calendarDaysContentTh&&t.setStyles(this.css.calendarDaysContentTh);var i=MWF.LP.widget.days_abbr;return t.each(function(e,t){if(0==t)e.set("text",MWF.xApplication.Calendar.LP.week);else{var a=(t-1+parseInt(this.options.weekBegin))%7;e.set("text",i[a])}}.bind(this)),t},_setDayDate:function(e,t,i){var a=e||this.contentTable,s=this.options.baseDate;null!=t&&null!=i&&((s=new Date).setDate(1),s.setFullYear(t),s.setMonth(i));var n=a.getElement("tbody").getElements("td"),o=s.clone();o.setDate(1);for(var h=(7+o.getDay()-parseInt(this.options.weekBegin))%7+1,d=o.clone(),r=h-1;r>=0;r--){if(r%8==0){var l=this.getWeekNumber(d);if(n[r].set("text",l),n[r].setStyles(this.css.week),n[r].store("weekValue",l.toString()),n[r].store("dateValue",d.toString()),--r<0)break}d.increment("day",-1),n[r].set("text",d.getDate()),n[r].addClass("gray_"+this.options.style),n[r].setStyles(this.css["gray_"+this.options.style]),n[r].store("dateValue",d.toString())}for(r=h;r<n.length;r++){if(r%8==0){l=this.getWeekNumber(o);if(n[r].set("text",l),n[r].setStyles(this.css.week),n[r].store("weekValue",l.toString()),n[r].store("dateValue",o.toString()),++r>=n.length)break}n[r].set("text",o.getDate()),o.toString()==this.options.baseDate.toString()?(n[r].addClass("current_"+this.options.style),n[r].setStyles(this.css["current_"+this.options.style]),n[r].removeClass("gray_"+this.options.style),n[r].setStyle("border","1px solid #FFF")):o.getMonth()!=s.getMonth()?(n[r].addClass("gray_"+this.options.style),n[r].setStyles(this.css["gray_"+this.options.style]),n[r].removeClass("current_"+this.options.style),n[r].setStyle("border","1px solid #FFF")):(n[r].setStyles(this.css["normal_"+this.options.style]),n[r].removeClass("current_"+this.options.style),n[r].removeClass("gray_"+this.options.style),n[r].setStyle("border","1px solid #FFF")),o.clone().clearTime().toString()==this.today.clearTime().toString()&&(n[r].setStyles(this.css["today_"+this.options.style]),n[r].setStyle("border","0px solid #AAA")),n[r].store("dateValue",o.toString()),o.increment("day",1)}},getWeekNumber:function(e){var t=e.clone(),i=(7+e.getDay()-parseInt(this.options.weekBegin))%7;t.setDate(t.getDate()-i+3);var a=t.valueOf();return t.setMonth(0,1),4!=t.getDay()&&t.setMonth(0,1+(4-t.getDay()+7)%7),1+Math.ceil((a-t)/6048e5)}});