MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Template","MTooltips",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.AttachmentController",null,!1);var MWFCalendar=MWF.xApplication.Calendar=MWF.xApplication.Calendar||{};MWFCalendar.ColorOptions={deep:["#428ffc","#5bcc61","#f9bf24","#f75f59","#f180f7","#9072f1","#909090","#1462be"],light:["#cae2ff","#d0f1b0","#fef4bb","#fdd9d9","#f4c5f7","#d6ccf9","#e7e7e7","#cae2ff"],getLightColor:function(t){var e=this.deep.indexOf(t);return e>-1?this.light[e]:this.light[0]},getDeepColor:function(t){var e=this.light.indexOf(t);return e>-1?this.deep[e]:this.deep[0]}},MWFCalendar.EventForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"800",height:"475",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,maxAction:!0,closeAction:!0,isFull:!1,startTime:null,endTime:null,isWholeday:!1,defaultCalendarId:""},open:function(t){this.options.isFull&&(this.options.width="800",this.options.height="630"),this.fireEvent("queryOpen"),this.isNew=!1,this.isEdited=!1,this._open(),this.fireEvent("postOpen")},create:function(){this.options.isFull&&(this.options.width="1100",this.options.height="630"),this.fireEvent("queryCreate"),this.isNew=!0,this._open(),this.fireEvent("postCreate")},edit:function(){this.options.isFull&&(this.options.width="1100",this.options.height="630"),this.fireEvent("queryEdit"),this.isEdited=!0,this._open(),this.fireEvent("postEdit")},_createTableContent:function(){this.getEventData(function(){this.loadEventContent()}.bind(this))},loadEventContent:function(){COMMON.AjaxModule.load("../o2_lib/rrule/rrule.js",function(){this.isEdited||this.isNew?this.app.actions.listMyCalendar(function(t){this.calendarIds=[],this.calendarNames=[],this.calendarList=[],(t.data.myCalendars||[]).each(function(t){(t.publishable||t.manageable)&&this.calendarList.push(t)}.bind(this)),(t.data.unitCalendars||[]).each(function(t){(t.publishable||t.manageable)&&this.calendarList.push(t)}.bind(this)),this.calendarList.each(function(t){this.calendarIds.push(t.id),this.calendarNames.push(t.name)}.bind(this)),this._createTableContent_Edit()}.bind(this)):this.app.actions.getCalendar(this.data.calendarId,function(t){this.calendarName=t.data.name,this._createTableContent_Read()}.bind(this))}.bind(this))},_createTableContent_Read:function(){this.formTopTextNode.set("text",this.lp.readEvent),this.formTableContainer.setStyle("width","86%");var t=this.data,e=Date.parse(t.startTime),i=Date.parse(t.endTime),s=e.format(this.lp.dateFormatAll)+"（"+this.lp.weeks.arr[e.get("day")]+"）",a=i.format(this.lp.dateFormatAll)+"（"+this.lp.weeks.arr[i.get("day")]+"）";t.recurrenceRule?(this.oldRecurrenceRule=t.recurrenceRule,this.rRule=RRule.fromString(t.recurrenceRule).origOptions):this.rRule={};var l,n,o=this.lp.repeatFrequencyArr,r=["NONE",RRule.DAILY,RRule.WEEKLY,RRule.MONTHLY,RRule.YEARLY];if(this.rRule.freq){if(l=o[r.indexOf(this.rRule.freq)],this.rRule.byweekday){var d=this.rRule.byweekday.toString().split(","),h=[],c=this.lp.weeks.arr,p=this.lp.weeks.rruleArr;d.each((function(t){h.push(c[p.indexOf(t)])})),l=this.lp.repeatInfor.replace("{frequency}",h.join("、"))}else l+=this.lp.repeat;!this.rRule.until||"不重复"===l&&l===this.lp.notRepeat||(l+="  "+this.lp.endDate+"："+this.rRule.until.format("%Y-%m-%d"))}else l=this.lp.notRepeat;t.valarmTime_config&&("0,0,0,-5"===t.valarmTime_config?n=this.lp.remindWhenBegin:t.valarmTime_config.split(",").each(function(t,e){var i;i=0==e?this.lp.date:1==e?this.lp.hour:2==e?this.lp.minute:this.lp.second,t&&"0"!=t&&(n=this.lp.remindInAdvance.replace("{text}",Math.abs(t)+i))}.bind(this)));var m=this.calendarName,u="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='table-layout:fixed;'><tr><td styles='formTableTitle' width='40'>"+this.lp.calendar+"：</td>    <td styles='formTableValue' width='400'>"+m+"</td></tr><tr><td styles='formTableTitle'>"+this.lp.subject+"：</td>    <td styles='formTableValue'><div styles='colorItem'></div>"+t.title+"</td></tr><tr><td styles='formTableTitle'>"+this.lp.beginTime+"：</td>    <td styles='formTableValue'>"+s+"</td></tr><tr><td styles='formTableTitle'>"+this.lp.endTime+"：</td>    <td styles='formTableValue'>"+a+"</td></tr><tr><td styles='formTableTitle'>"+this.lp.address+"：</td>    <td styles='formTableValue'>"+(t.locationName||"")+"</td></tr>";u+=n?"<tr><td styles='formTableTitle'>"+this.lp.remind+"：</td>    <td styles='formTableValue'>"+n+"</td></tr>":"<tr><td styles='formTableTitle'>"+this.lp.remind+"：</td>    <td styles='formTableValue'>"+this.lp.remindIntervalArr[0]+"</td></tr>",l&&l!==this.lp.no&&l!==this.lp.notRepeat?u+="<tr><td styles='formTableTitle'>"+this.lp.repeat+"：</td>    <td styles='formTableValue'>"+l+"</td></tr>":u+="<tr><td styles='formTableTitle'>"+this.lp.repeat+"：</td>    <td styles='formTableValue'>"+this.lp.notRepeat+"</td></tr>",t.comment?u+="<tr><td styles='formTableTitle' valign='top'><div style='padding-top: 15px;'>"+this.lp.content+"：</div></td>    <td styles='formTableValue'>"+t.comment+"</td></tr>":u+="<tr><td styles='formTableTitle' valign='top'>"+this.lp.content+"：</td>    <td styles='formTableValue'>"+this.lp.none+"</td></tr>",this.formTableArea.set("html",u),this.formTableArea.getElements("[styles='formTableTitle']").setStyles({color:"#333","font-size":"16px",padding:"0px 20px 0px 0px",height:"35px","line-height":"35px","text-align":"left"}),this.formTableArea.getElements("[styles='formTableValue']").setStyles({"text-align":"left","font-size":"16px"});var f=this.formTableArea.getElement("[styles='colorItem']");new Element("div",{styles:this.css.colorNode}).inject(f).setStyle("background-color",this.data.color)},_createTableContent_Edit:function(){this.oldCoordinate=null;var t,e,i,s,a,l;this.editEnable=this.isEdited||this.isNew;this.userName=layout.desktop.session.user.distinguishedName,this.userId=layout.desktop.session.user.id,this.options.isFull?this.formTableContainer.setStyles({width:"auto","padding-left":"40px"}):this.formTableContainer.setStyle("width","80%"),this.isNew?this.formTopTextNode.set("text",this.lp.addEvent):this.isEdited&&(this.formTopTextNode.set("text",this.lp.editEvent),this.options.height="590"),this.options.startTime&&this.options.endTime?(t=this.date="string"==typeOf(this.options.startTime)?Date.parse(this.options.startTime):this.options.startTime,e="string"==typeOf(this.options.endTime)?Date.parse(this.options.endTime):this.options.endTime,i=t.format("%Y-%m-%d"),s=t.format("%H:%M"),a=e.format("%Y-%m-%d"),l=e.format("%H:%M")):(e=(t=this.date=(new Date).increment("hour",1)).clone().increment("hour",1),i=t.format("%Y-%m-%d"),s=t.format("%H")+":00",a=e.format("%Y-%m-%d"),l=e.format("%H")+":00");var n=this.data;if(this.options.isWholeday&&this.isNew&&(n.isAllDayEvent=!0),n.startTime){var o=Date.parse(n.startTime);n.startDateInput=o.format("%Y-%m-%d"),n.startTimeInput=this.getString(o.getHours())+":"+this.getString(o.getMinutes())}if(n.endTime){var r=Date.parse(n.endTime);n.endDateInput=r.format("%Y-%m-%d"),n.endTimeInput=this.getString(r.getHours())+":"+this.getString(r.getMinutes())}(n.recurrenceRule?(this.oldRecurrenceRule=n.recurrenceRule,this.rRule=RRule.fromString(n.recurrenceRule).origOptions):this.rRule={},n.repeat=this.rRule.freq||"",this.rRule.until&&(n.repeatUntilAvailable="AVAILABLE",n.repeatUntilDate=this.rRule.until.format("%Y-%m-%d")),this.rRule.byweekday&&(n.repeatWeeks=this.rRule.byweekday.toString().split(",")),n.valarmTime_config)&&n.valarmTime_config.split(",").each(function(t,e){var i;i=0==e?"d":1==e?"h":2==e?"m":"s",t&&"0"!=t&&(n.remind=t+"_"+i)}.bind(this));this.formTableArea.set("html",this.getHtml()),this.colorItem=this.formTableArea.getElement("[item='color']"),this.data.color||(this.options.defaultCalendarId?this.data.color=this.getColorByCalendarId(this.options.defaultCalendarId):this.data.color=this.calendarList[0].color),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,n,{isEdited:this.isEdited||this.isNew,style:"meeting",hasColon:!0,itemTemplate:{calendarId:{text:this.lp.calendar,defaultValue:this.options.defaultCalendarId,type:"select",selectValue:this.calendarIds,selectText:this.calendarNames,event:{change:function(t){this.setColorByCalendarId(t.getValue())}.bind(this)}},startDateInput:{text:this.lp.beginTime,tType:"date",defaultValue:i,notEmpty:!0},startTimeInput:{tType:"time",defaultValue:s,className:this.isNew||this.isEdited?"inputTimeUnformatWidth":"",disable:n.isAllDayEvent},endDateInput:{text:this.lp.endTime,tType:"date",defaultValue:a,notEmpty:!0},endTimeInput:{tType:"time",defaultValue:l,className:this.isNew||this.isEdited?"inputTimeUnformatWidth":"",disable:n.isAllDayEvent},remind:{text:this.lp.remind,type:"select",selectText:this.lp.remindIntervalArr,selectValue:["","-5_s","-5_m","-10_m","-15_m","-30_m","-1_h","-2_h"]},isAllDayEvent:{type:"checkbox",selectValue:["true"],selectText:[this.lp.allDay],event:{change:function(t){var e=t.form.getItem("startTimeInput"),i=t.form.getItem("endTimeInput");"true"!=t.getValue()||e.options.disable||i.options.disable?(e.options.disable&&e.enable(),i.options.disable&&i.enable(),e.getElements().setStyle("display",""),i.getElements().setStyle("display","")):(e.getElements().setStyle("display","none"),i.getElements().setStyle("display","none"))}.bind(this)}},title:{text:this.lp.eventSubject,notEmpty:!0},description:{type:"textarea"},locationName:{text:this.lp.locationName},repeat:{text:this.lp.repeat,type:"select",defaultValue:"NONE",selectText:this.lp.repeatFrequencyArr2,selectValue:["NONE",RRule.DAILY,RRule.WEEKLY,RRule.MONTHLY,RRule.YEARLY],event:{change:function(t){var e=t.getValue(),i=this.formTableArea.getElement("[item='repeatUntilArea']");i.setStyle("display","NONE"==e?"none":""),e==RRule.WEEKLY?this.showWeek():(i=this.formTableArea.getElement("[item='repeatWeekArea']")).setStyle("display","none")}.bind(this)}},repeatUntilAvailable:{text:this.lp.repeatUntilAvailable,type:"radio",selectText:this.lp.repeatUntilAvailableTextArr,selectValue:["NONE","AVAILABLE"],defaultValue:"NONE"},repeatUntilDate:{tType:"date",event:{click:function(){this.form.getItem("repeatUntilAvailable").setValue("AVAILABLE")}.bind(this)}},comment:{text:this.lp.content,type:"rtf",RTFConfig:{skin:"bootstrapck",resize_enabled:!1,toolbar:[{name:"document",items:["Preview"]},{name:"basicstyles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"list",items:["NumberedList","BulletedList"]},{name:"links",items:["Link","Unlink"]}]}}}},this.app),this.form.load(),this.data.repeat==RRule.WEEKLY&&this.showWeek(),this.loadColor()}.bind(this),!0)},getRRuleString:function(t){if(t||(t=this.form.getResult(!1,null,!1,!1,!1)),!t.repeat||"NONE"==t.repeat)return"";var e={freq:t.repeat};return"NONE"!=t.repeatUntilAvailable&&""!=t.repeatUntilDate&&(e.until=Date.parse(t.repeatUntilDate)),t.repeat==RRule.WEEKLY&&(e.byweekday=[],this.getSelectWeek().each((function(t){e.byweekday.push(RRule[t])}))),new RRule(e).toString()},getHtml:function(){this.isEdited||this.isNew;return this.options.isFull?"<div style='overflow: hidden;'><div item='baseInforContainer' style='float: left; width : 500px;'><table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='table-layout:fixed;'><tr><td styles='formTableTitle' width='80' lable='calendarId'></td>    <td styles='formTableValue' item='calendarId' colspan='2' width='400'></td></tr><tr><td styles='formTableTitle' lable='title'></td>    <td styles='formTableValue' item='title'  colspan='2'></td></tr><tr><td styles='formTableTitle' lable='startDateInput'></td>    <td styles='formTableValue' item='startDateInput' width='"+(this.editEnable?"260":"100")+"'></td>    <td styles='formTableValue' item='startTimeInput'></td></tr><tr><td styles='formTableTitle' lable='endDateInput'></td>    <td styles='formTableValue' item='endDateInput'></td>    <td styles='formTableValue' item='endTimeInput'></td></tr><tr><td styles='formTableTitle'></td>    <td styles='formTableValue' item='isAllDayEvent' colspan='2'></td></tr><tr><td styles='formTableTitle' lable='locationName'></td>    <td styles='formTableValue' item='locationName' colspan='2'></td></tr><tr><td styles='formTableTitle' lable='remind'></td>    <td styles='formTableValue' item='remind' colspan='2'></td></tr><tr><td styles='formTableTitle' lable='repeat'></td>    <td styles='formTableValue' item='repeat' colspan='2'></td></tr><tr item='repeatWeekArea' style='display:"+(this.data.repeat==RRule.WEEKLY?"":"none")+";'><td styles='formTableTitle'></td>    <td styles='formTableValue' item='repeatWeek' colspan='2' style='overflow:hidden;'></td></tr><tr item='repeatUntilArea' style='display:"+(this.data.repeat&&""!=this.data.repeat?"":"none")+";'><td styles='formTableTitle'></td>    <td styles='formTableValue' colspan='2' style='overflow: hidden;line-height:34px;'>        <div lable='repeatUntilAvailable' style='float: left;'></div>        <div item='repeatUntilAvailable'  style='float: left;'></div>        <div item='repeatUntilDate'  style='float: left;width:170px;'></div>    </td></tr><tr><td styles='formTableTitle'>"+this.lp.color+"：</td>    <td styles='formTableValue' item='color' colspan='2' style='overflow: hidden;'></td></tr></table></div><div style='float: left; width : 500px;' item='commentContainer'><table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' ></td>    <td styles='formTableValue' lable='comment' colspan='2'></td></tr><tr><td styles='formTableTitle' ></td>    <td styles='formTableValue' item='comment' colspan='2'></td></tr><tr item='attachmentTr'><td styles='formTableTitle'></td>    <td styles='formTableValue' item='attachment'></td></tr></table></div></div>":"<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='calendarId'></td>    <td styles='formTableValue' item='calendarId'  colspan='2'></td></tr><tr><td styles='formTableTitle' lable='title'></td>    <td styles='formTableValue' item='title'  colspan='2'></td></tr><tr><td styles='formTableTitle' width='100' lable='startDateInput'></td>    <td styles='formTableValue' item='startDateInput' width='300'></td>    <td styles='formTableValue' item='startTimeInput'></td></tr><tr><td styles='formTableTitle' lable='endDateInput'></td>    <td styles='formTableValue' item='endDateInput'></td>    <td styles='formTableValue' item='endTimeInput'></td></tr><tr><td styles='formTableTitle'></td>    <td styles='formTableValue' item='isAllDayEvent' colspan='2'></td></tr><tr><td styles='formTableTitle' lable='remind'></td>    <td styles='formTableValue' item='remind' colspan='2'></td></tr></table>"},_setNodesSize:function(t,e,i,s){if(this.options.isFull){var a=this.formAreaNode.getElement("[item='baseInforContainer']"),l=this.formAreaNode.getElement("[item='commentContainer']");a&&a.setStyle("width",(t-100)/2),l&&l.setStyle("width",(t-100)/2)}},getColorByCalendarId:function(t){var e;return this.calendarList.each(function(i){i.id==t&&(e=i.color)}.bind(this)),e},setColorByCalendarId:function(t){var e=this.getColorByCalendarId(t);e&&(this.data.color=e,this.setColor(e))},setColor:function(t){(this.colorOptions||[]).each((function(e){e.retrieve("color")==t&&e.click()}))},loadColor:function(){this.isEdited||this.isNew?this.loadColor_Edited():this.loadColor_Read()},loadColor_Read:function(){if(this.colorItem){var t=new Element("div",{styles:this.css.colorNode}).inject(this.colorItem);t.setStyle("background-color",this.data.color),t.setStyles(this.css.colorNode_current)}},loadColor_Edited:function(){this.colorItem&&(this.colorOptions=[],this.data.color||(this.options.defaultCalendarId?this.getColorByCalendarId(this.options.defaultCalendarId):this.data.color=this.calendarList[0].color),MWFCalendar.ColorOptions.deep.each(function(t,e){var i=new Element("div",{styles:this.css.colorNode,events:{click:function(t){this.currentColorNode&&this.currentColorNode.setStyles(this.css.colorNode),t.target.setStyles(this.css.colorNode_current),this.currentColorNode=t.target}.bind(this)}}).inject(this.colorItem);i.setStyle("background-color",t),i.store("color",t),this.data.color?this.data.color==t&&(i.setStyles(this.css.colorNode_current),this.currentColorNode=i):0==e&&(i.setStyles(this.css.colorNode_current),this.currentColorNode=i),this.colorOptions.push(i)}.bind(this)))},showWeek:function(){var t=this.formTableArea.getElement("[item='repeatWeekArea']");if(t&&(t.setStyle("display",""),!this.isWeekSelectCreated)){this.weekItems=[];for(var e=this.formTableArea.getElement("[item='repeatWeek']"),i=this.css.weekDayStyle={border:"1px solid #ccc","border-radius":"3px",height:"20px","line-heigh":"20px",background:"#f7f7f7",color:"#666",padding:"0px 9px","margin-right":"9px",float:"left","font-size":"12px",cursor:"pointer"},s=this.css.weekDayOnStyle=Object.merge(Object.clone(i),{border:"1px solid #3c75b7",background:"#3c75b7",color:"#fff"}),a=this.data.repeatWeeks||[this.lp.weeks.rruleArr[this.date.getDay()]],l=0;l<7;l++){var n=this.lp.weeks.rruleArr[l],o=a.contains(n),r=new Element("div",{styles:o?s:i,text:this.lp.weeks.arr[l],events:{click:function(t){this.triggerWeek(t.target)}.bind(this)}}).inject(e);o&&(this.date.getDay()==l&&(this.currrentWeekDayItem=r),r.store("isOn",!0)),r.store("weekDay",n),this.weekItems.push(r)}this.isWeekSelectCreated=!0}},triggerWeek:function(t){t.retrieve("isOn")?(t.store("isOn",!1),t.setStyles(this.css.weekDayStyle)):(t.store("isOn",!0),t.setStyles(this.css.weekDayOnStyle)),0==this.getSelectWeek().length&&this.triggerWeek(this.currrentWeekDayItem)},getSelectWeek:function(){if(!this.weekItems)return[];var t=[];return this.weekItems.each((function(e){e.retrieve("isOn")&&t.push(e.retrieve("weekDay"))})),t},isEditable:function(){return!!MWF.AC.isAdministrator()||(!!(this.data.manageablePersonList||[]).contains(layout.desktop.session.user.distinguishedName)||this.data.createPerson===layout.desktop.session.user.distinguishedName)},_createBottomContent:function(){var t=this.isEditable(this.data),e="<div style='width:724px;margin:0px auto;'><table width='724' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'><tr><td styles='formTableValue' width='80'></td>    <td styles='formTableValue' style='padding-top: 15px;'>       <div item='saveAction' style='float:left;display:"+(t&&this.isEdited||this.isNew?"":"none")+";'></div>       <div item='editAction' style='float:left;display:"+(!t||this.isEdited||this.isNew?"none":"")+";'></div>       <div item='removeAction' style='float:left;display:"+(t&&this.isEdited?"":"none")+";'></div>       <div item='cancelAction' style='"+(t&&(this.isEdited||this.isNew)?"float:left;":"float:left;wdith:100px;")+"'></div>       <div item='moreInfor' style='float: right;margin-top:5px;'></div>   </td></tr></table></div>";this.formBottomNode.set("html",e),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.formBottomNode,{},{isEdited:this.isEdited||this.isNew,style:"meeting",hasColon:!0,itemTemplate:{moreInfor:{type:"a",value:this.lp.editMore,event:{click:function(){this.openMoreInfor()}.bind(this)},disable:this.options.isFull},saveAction:{type:"button",className:"inputOkButton",value:this.lp.save,event:{click:function(){this.save()}.bind(this)}},removeAction:{type:"button",className:"inputCancelButton",value:this.lp.cancelEvent,event:{click:function(t,e){this.cancelEvent(e)}.bind(this)}},editAction:{type:"button",className:"inputOkButton",value:this.lp.editEvent,event:{click:function(){this.editEvent()}.bind(this)}},cancelAction:{type:"button",className:"inputCancelButton",value:this.lp.close,event:{click:function(){this.close()}.bind(this)}}}},this.app).load()}.bind(this),!0)},openMoreInfor:function(){this.options.isFull=!0,this.options.width="1100",this.options.height="620",this.isWeekSelectCreated=!1,this.reload(!0)},getString:function(t){var e="00"+t;return e.substr(e.length-2,2)},getEventData:function(t){this.data&&this.data.id?this.app.actions.getEvent(this.data.id,function(e){this.data=e.data,t&&t()}.bind(this)):t&&t()},editEvent:function(){this.isWeekSelectCreated=!1,this.formTopNode=null,this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.edit()},reset:function(){this.formTableArea.empty(),this._createTableContent()},loadAttachment:function(){if(this.attachmentTr){this.attachmentTr.setStyle("display",""),this.attachmentNode=new Element("div",{styles:this.css.createEventAttachmentNode}).inject(this.attachmentArea);var t=new Element("div",{styles:this.css.createEventAttachmentContentNode}).inject(this.attachmentNode);MWF.require("MWF.widget.AttachmentController",function(){this.attachmentController=new MWF.widget.AttachmentController(t,this,{size:"min",isSizeChange:!1,isReplace:!1,isUpload:this.isNew||this.isEdited,isDelete:this.isNew||this.isEdited,isDownload:!0,readonly:!this.isNew&&!this.isEdited}),this.attachmentController.load(),this.data.attachmentList&&this.data.attachmentList.each(function(t){t.person=t.lastUpdatePerson.split("@")[0];this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))}},uploadAttachment:function(t,e){this.uploadFileAreaNode||this.createUploadFileNode(),this.fileUploadNode.click()},createUploadFileNode:function(){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" type="file" multiple/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var t=this.fileUploadNode.files;if(t.length)for(var e=0;e<t.length;e++){var i=t.item(e),s=new FormData;s.append("file",i),this.app.actions.addAttachment(function(t,e){t.id&&this.app.actions.getAttachment(t.id,function(t){t.data&&this.attachmentController.addAttachment(t.data),this.attachmentController.checkActions()}.bind(this)),this.attachmentController.checkActions()}.bind(this),null,s,this.data.id,i)}}.bind(this))},deleteAttachments:function(t,e,i){var s=[];i.each(function(t){s.push(t.data.name)}.bind(this));var a=this;(this.app&&this.app.confirm?this.app.confirm:MWF.xDesktop.confirm)("warn",t,this.lp.deleteAttachmentTitle,this.lp.deleteAttachment+"( "+s.join(", ")+" )",300,120,(function(){for(;i.length;)attachment=i.shift(),a.deleteAttachment(attachment);this.close()}),(function(){this.close()}),null)},deleteAttachment:function(t){this.app.actions.deleteFile(t.data.id,function(e){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions()}.bind(this))},downloadAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFileDownload(t.data.id)}.bind(this))},openAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFile(t.data.id)}.bind(this))},getAttachmentUrl:function(t,e){this.app.actions.getFileUrl(t.data.id,e)},cancelEvent:function(t){var e=this,i=this.data,s=function(){this.view&&this.view.reload(),this.close()}.bind(this);if(this.oldRecurrenceRule)this.openDeleteOptionForm(function(t){"single"==t?this.app.actions.deleteSingleEvent(i.id,function(t){s(t)}.bind(this)):"after"==t?this.app.actions.deleteAfterEvent(i.id,function(t){s(t)}.bind(this)):"all"==t&&this.app.actions.deleteAllEventsWithRepeatMaster(i.id,function(t){s(t)}.bind(this))}.bind(this));else if(i.id){var a=this.app.lp.cancel_confirm.replace(/{name}/g,this.data.title);(0,MWF.xDesktop.confirm)("infor",t,this.app.lp.cancel_confirm_title,a,380,200,(function(){e._cancelEvent(),this.close()}),(function(){this.close()}))}},_cancelEvent:function(){var t=this.view;this.app.actions.deleteSingleEvent(this.data.id,function(){t&&t.reload(),this.close()}.bind(this))},openDeleteOptionForm:function(t){this.deleteOptionsForm=new MWFCalendar.DeleteOptionDialog(this,{},{onPostOk:function(e){t&&t(e)}.bind(this)},{}),this.deleteOptionsForm.edit()},save:function(){this._save(function(){this.app&&this.app.notice?this.app.notice(this.lp.event_saveSuccess,"success"):MWF.xDesktop.notice("ok",{x:"right",y:"top"},this.lp.event_saveSuccess,$(document.body)),this.close()}.bind(this))},_save:function(t){var e=this.getSaveData();if(e){var i="";if(e.title||(i+=this.lp.event_input_subject_error),e.startTime&&Date.parse(e.startTime)-Date.parse(e.endTime)>0&&(i+=this.lp.event_input_time_error),i)return this.app&&this.app.notice?this.app.notice(this.lp.event_input_error+i,"error"):MWF.xDesktop.notice("error",{x:"right",y:"top"},this.lp.event_input_error+i,$(document.body)),!1;var s=function(i){this.data.id=i.data.id,this.oldRecurrenceRule=e.recurrenceRule,this.waitReload=!0,t&&t()}.bind(this);this.data=e,this.oldRecurrenceRule?this.openSaveOptionForm(function(t){"single"==t?this.app.actions.updateSingleEvent(e.id,this.data,function(t){s(t)}.bind(this)):"after"==t?this.app.actions.updateAfterEvent(e.id,this.data,function(t){s(t)}.bind(this)):"all"==t&&this.app.actions.updateAllEventsWithRepeatMaster(e.id,this.data,function(t){s(t)}.bind(this))}.bind(this)):e.id?this.app.actions.updateSingleEvent(e.id,this.data,function(t){s(t)}.bind(this)):this.app.actions.addEvent(this.data,function(t){s(t)}.bind(this))}},openSaveOptionForm:function(t){this.saveOptionsForm=new MWFCalendar.SaveOptionDialog(this,{},{onPostOk:function(e){t&&t(e)}.bind(this)},{}),this.saveOptionsForm.edit()},getSaveData:function(){var t=this.form.getResult(!0,"",!0,!1,!0);if(!t)return null;if(t){if(t.isAllDayEvent="array"==typeOf(t.isAllDayEvent)?t.isAllDayEvent.join(""):t.isAllDayEvent,"true"==t.isAllDayEvent?(t.startTime=this.data.startDateInput+" 00:00:00",t.endTime=this.data.endDateInput+" 23:59:59"):(t.startTime=this.data.startDateInput+" "+this.data.startTimeInput+":00",t.endTime=this.data.endDateInput+" "+this.data.endTimeInput+":00"),t.recurrenceRule=this.getRRuleString(t),t.remind){var e=[0,0,0,0],i=t.remind.split("_"),s=parseInt(i[0]);"d"==i[1]?e[0]=s:"h"==i[1]?e[1]=s:"m"==i[1]?e[2]=s:"s"==i[1]&&(e[3]=s),t.valarmTime_config=e.join(",")}t.calendarId||(t.calendarId=this.app.currentCalendarData.id),this.currentColorNode?t.color=this.currentColorNode.retrieve("color"):t.calendarId?t.color=this.getColorByCalendarId(t.calendarId):t.color=MWFCalendar.ColorOptions.deep[0],delete t.range}return t},close:function(t){this.fireEvent("queryClose"),this._close(),this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.fireEvent("postClose"),this.waitReload&&this.view&&this.view.reload()}}),MWFCalendar.CalendarForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"800",height:"500",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,maxAction:!0,resizeable:!0,closeAction:!0,resultSeparator:null},_createTableContent:function(){var t=this.data;this.editEnable=!this.isEdited&&!this.isNew&&this.data.manageable;this.userName=(layout.desktop.session.user||layout.user).distinguishedName,this.userId=(layout.desktop.session.user||layout.user).id,"UNIT"==t.type&&(this.options.height="650"),this.isNew?this.formTopTextNode.set("text",this.lp.createCalendar):this.isEdited?this.formTopTextNode.set("text",this.lp.editCalendar):this.formTopTextNode.set("text",this.lp.calendar),this.formTableArea.set("html",this.getHtml()),this.formTableContainer.setStyle("width","80%"),this.colorItem=this.formTableArea.getElement("[item='color']"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,t,{isEdited:this.isEdited||this.isNew,style:"meeting",hasColon:!0,itemTemplate:{name:{text:this.lp.calendarName,notEmpty:!0},description:{text:this.lp.description,type:"textarea"},type:{text:this.lp.type,type:"select",isEdited:this.isNew,selectValue:["PERSON","UNIT"],selectText:this.lp.canlendarTypeArr,defaultValue:"PERSON",event:{change:function(t){this.changeType(t.getValue())}.bind(this)}},target:{text:this.lp.unit,type:"org",orgType:"unit",validRule:{empty:function(t,e){return"UNIT"!=e.form.getItem("type").getValue()||""!=t}},validMessage:{empty:this.lp.unitEmptyNotice}},isPublic:{text:this.lp.isOpened,type:"select",selectValue:["true","false"],selectText:this.lp.trueFalseArr,defaultValue:"false"},status:{text:this.lp.isAvaliable,type:"radio",selectValue:["OPEN","CLOSE"],selectText:this.lp.trueFalseArr,defaultValue:"OPEN"},manageablePersonList:{text:this.lp.manager,type:"org",orgType:"person",count:0},viewerList:{text:this.lp.viewerRange,type:"org",orgType:["person","unit","group"],count:0,value:function(){return(t.viewablePersonList||[]).combine(t.viewableUnitList||[]).combine(t.viewableGroupList||[])}.bind(this)},publisherList:{text:this.lp.publisherRange,type:"org",orgType:["person","unit","group"],count:0,value:function(){return(t.publishablePersonList||[]).combine(t.publishableUnitList||[]).combine(t.publishableGroupList||[])}.bind(this)}}},this.app),this.form.load(),this.loadColor()}.bind(this),!0)},getHtml:function(){this.isEdited||this.isNew;var t="UNIT"!=this.data.type?"style='display:none'":"",e="UNIT"!=this.data.type?"style='display:none'":"";return"<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='table-layout:fixed;'><tr><td styles='formTableTitle' width='80' lable='name'></td>    <td styles='formTableValue' item='name' width='400' colspan='3'></td></tr><tr><td styles='formTableTitle'>"+this.lp.color+"：</td>    <td styles='formTableValue' item='color' style='overflow: hidden;' colspan='3'></td></tr><tr><td styles='formTableTitle' lable='type' width='80'></td>    <td styles='formTableValue' item='type'></td>   <td styles='formTableTitleRight' lable='isPublic'  width='50'></td>    <td styles='formTableValue' item='isPublic'></td></tr><tr><td styles='formTableTitle' lable='description'></td>    <td styles='formTableValue' item='description' colspan='3'></td></tr><tr "+t+"><td styles='formTableTitle' lable='target'></td>    <td styles='formTableValue' item='target' colspan='3'></td></tr><tr "+e+"><td styles='formTableTitle' lable='manageablePersonList'></td>    <td styles='formTableValue' item='manageablePersonList' colspan='3'></td></tr><tr "+e+"><td styles='formTableTitle' lable='viewerList'></td>    <td styles='formTableValue' item='viewerList' colspan='3'></td></tr><tr "+e+"><td styles='formTableTitle' lable='publisherList'></td>    <td styles='formTableValue' item='publisherList' colspan='3'></td></tr></tr><tr><td styles='formTableTitle' lable='status'></td>   <td styles='formTableValue' item='status' colspan='3'></td></tr></table>"},changeType:function(t){["target","manageablePersonList","viewerList","publisherList"].each(function(e){this.formTableArea.getElement("[item='"+e+"']").getParent().setStyle("display","UNIT"==t?"":"none")}.bind(this)),this.options.height="UNIT"==t?"650":"500",this.setFormNodeSize()},loadColor:function(){this.isEdited||this.isNew?this.loadColor_Edited():this.loadColor_Read()},loadColor_Read:function(){if(this.colorItem){var t=new Element("div",{styles:this.css.colorNode}).inject(this.colorItem);t.setStyle("background-color",this.data.color),t.setStyles(this.css.colorNode_current)}},loadColor_Edited:function(){this.colorItem&&(this.colorOptions=[],MWFCalendar.ColorOptions.deep.each(function(t,e){var i=new Element("div",{styles:this.css.colorNode,events:{click:function(t){this.currentColorNode&&this.currentColorNode.setStyles(this.css.colorNode),t.target.setStyles(this.css.colorNode_current),this.currentColorNode=t.target}.bind(this)}}).inject(this.colorItem);i.setStyle("background-color",t),i.store("color",t),this.data.color?this.data.color==t&&(i.setStyles(this.css.colorNode_current),this.currentColorNode=i):0==e&&(i.setStyles(this.css.colorNode_current),this.currentColorNode=i),this.colorOptions.push(i)}.bind(this)))},_createBottomContent:function(){var t="<div style='width:724px;margin:0px auto;'><table width='724' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'><tr><td styles='formTableValue' width='80'></td>    <td styles='formTableValue' style='padding-top: 15px;'>       <div item='saveAction' style='float:left;display:"+(this.isEdited||this.isNew?"":"none")+";'></div>       <div item='editAction' style='float:left;display:"+(this.editEnable?"":"none")+";'></div>       <div item='removeAction' style='float:left;display:"+(this.isEdited?"":"none")+";'></div>       <div item='cancelAction' style='"+(this.isEdited||this.isNew||this.editEnable?"float:left;":"float:right;margin-right:15px;")+"'></div>   </td></tr></table></div>";this.formBottomNode.set("html",t),MWF.xDesktop.requireApp("Template","MForm",function(){new MForm(this.formBottomNode,{},{isEdited:this.isEdited||this.isNew,style:"meeting",hasColon:!0,itemTemplate:{saveAction:{type:"button",className:"inputOkButton",value:this.lp.save,event:{click:function(){this.ok()}.bind(this)}},removeAction:{type:"button",className:"inputCancelButton",value:this.lp.deleteCalendar,event:{click:function(t,e){this.deleteCalendar(e)}.bind(this)}},editAction:{type:"button",className:"inputOkButton",value:this.lp.editCalendar,event:{click:function(){this.editCalendar()}.bind(this)}},cancelAction:{type:"button",className:"inputCancelButton",value:this.lp.close,event:{click:function(){this.close()}.bind(this)}}}},this.app).load()}.bind(this),!0)},deleteCalendar:function(t){var e=this;e.app.confirm("warn",t,e.lp.deleteCalendarTitle,e.lp.deleteCalendarContent.replace("{name}",e.data.name),300,120,(function(){e.app.actions.deleteCalendar(e.data.id,function(t){e.close(),e.app.notice(e.lp.deleteSuccess),e.app.leftNavi.reload()}.bind(this)),this.close()}),(function(){this.close()}),null)},editCalendar:function(){this.formTopNode=null,this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.edit()},reset:function(){this.formTableArea.empty(),this._createTableContent()},_ok:function(t,e){if("UNIT"==t.type){var i=this.form.getItem("viewerList").dom;t.viewablePersonList=i.getValueByType("person"),t.viewableUnitList=i.getValueByType("unit"),t.viewableGroupList=i.getValueByType("group");var s=this.form.getItem("publisherList").dom;t.publishablePersonList=s.getValueByType("person"),t.publishableUnitList=s.getValueByType("unit"),t.publishableGroupList=s.getValueByType("group"),t.target=t.target.join("")}else t.target=this.userName,["manageablePersonList","viewablePersonList","publishablePersonList"].each(function(e){t[e]=[this.userName]}.bind(this)),["viewableUnitList","viewableGroupList","publishableUnitList","publishableGroupList"].each((function(e){t[e]=[]}));this.currentColorNode?t.color=this.currentColorNode.retrieve("color"):t.color=MWFCalendar.ColorOptions.deep[0],delete t.viewerList,delete t.publisherList,this.app.actions.saveCalendar(t,function(t){this.view&&this.view.reload(),e(t)}.bind(this))},close:function(t){this.fireEvent("queryClose"),this._close(),this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.fireEvent("postClose"),this.waitReload&&this.view&&this.view.reload()}}),MWFCalendar.SaveOptionDialog=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"470",height:"325",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,closeAction:!0,title:MWF.xApplication.Calendar.LP.saveOptionDialogTitle},_createTableContent:function(){this.formTableContainer.setStyles({width:"auto","padding-top":"20px","padding-left":"40px"});var t=MWF.xApplication.Calendar.LP;this.lp={ok:t.modifyConfirm,cancel:t.cancel};this.formTableArea.set("html","<table width='80%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='saveOption'></td><tr><td styles='formTableValue' item='saveOption'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{empName:"xadmin"},{style:"meeting",isEdited:this.isEdited||this.isNew,itemTemplate:{saveOption:{defaultValue:"single",text:t.selectModifyCalendarTypeNotice,type:"radio",selectText:t.calendarModifyTypeArr,selectValue:["single","after","all"]}}},this.app),this.form.load()}.bind(this),!0)},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,this.options.resultSeparator,!0,!1,!0);e&&(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.fireEvent("postOk",e.saveOption))}}),MWFCalendar.DeleteOptionDialog=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"470",height:"325",hasTop:!0,hasIcon:!1,hasTopIcon:!1,hasTopContent:!1,draggable:!0,closeAction:!0,title:MWF.xApplication.Calendar.LP.deleteOptionDialogTitle},_createTableContent:function(){this.formTableContainer.setStyles({width:"auto","padding-top":"20px","padding-left":"40px"});var t=MWF.xApplication.Calendar.LP;this.lp={ok:t.modifyConfirm,cancel:t.cancel};this.formTableArea.set("html","<table width='80%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='saveOption'></td><tr><td styles='formTableValue' item='saveOption'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{empName:"xadmin"},{isEdited:this.isEdited||this.isNew,style:"meeting",itemTemplate:{saveOption:{defaultValue:"single",text:t.selectDeleteCalendarTypeNotice,type:"radio",selectText:t.calendarDeleteTypeArr,selectValue:["single","after","all"]}}},this.app),this.form.load()}.bind(this),!0)},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,this.options.resultSeparator,!0,!1,!0);e&&(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.fireEvent("postOk",e.saveOption))}}),MWFCalendar.EventTooltip=new Class({Extends:MTooltips,options:{displayDelay:300},_loadCustom:function(t){this.loadAttachment(),this.loadButton(),t&&t()},_getHtml:function(){var t=this.data,e="font-size:14px;color:#333",i="font-size:14px;color:#666;padding-right:10px",s=Date.parse(this.data.startTime),a=Date.parse(this.data.endTime),l=s.format(this.lp.dateFormatAll)+"（"+this.lp.weeks.arr[s.get("day")]+"）",n=a.format(this.lp.dateFormatAll)+"（"+this.lp.weeks.arr[a.get("day")]+"）";return"<div style='font-size: 16px;color:#333;padding:10px 10px 10px 20px;'>"+t.title+"</div><div style='height:1px;margin:0px 20px;border-bottom:1px solid #ccc;'></div><table width='100%' bordr='0' cellpadding='7' cellspacing='0' style='margin:13px 13px 13px 13px;'><tr><td style='"+e+";' width='40'>"+this.lp.begin+":</td>    <td style='"+i+"'>"+l+"</td></tr><tr><td style='"+e+"'>"+this.lp.end+":</td>    <td style='"+i+"'>"+n+"</td></tr><tr><td style='"+e+"'>"+this.lp.locationName+":</td>    <td style='"+i+"'>"+(this.data.locationName||"")+"</td></tr><tr><td style='"+e+"'></td>    <td style='"+i+"' item='seeMore'></td></tr></table>"},destroy:function(){this.node&&(this.node.destroy(),this.node=null)},isEditable:function(){return!!MWF.AC.isAdministrator()||(!!(this.data.manageablePersonList||[]).contains(layout.desktop.session.user.distinguishedName)||this.data.createPerson===layout.desktop.session.user.distinguishedName)},loadButton:function(){var t=this.node.getElement("[item='seeMore']");new Element("div",{styles:{"background-color":"#3c75b7",height:"28px","line-height":"28px","border-radius":"5px",width:"80px","text-align":"center","font-size":"12px",cursor:"pointer",color:"#fff"},events:{click:function(){var t=new MWFCalendar.EventForm(this,this.data,{isFull:!0},{app:this.app});t.view=this.view,this.isEditable()?t.edit():t.open(),this.hide()}.bind(this)},text:this.lp.seeMore}).inject(t)},loadAttachment:function(){if(!this.options.isHideAttachment&&"array"==typeOf(this.data.attachmentList)&&this.data.attachmentList[0]){var t=this.node.getElement("[item='attachment']");this.attachmentNode=new Element("div").inject(t);var e=new Element("div",{}).inject(this.attachmentNode);this.attachmentController=new MWFCalendar.EventTooltip.AttachmentController(e,this,{size:"min",isSizeChange:!1,isReplace:!1,isUpload:!1,isDelete:!1,isDownload:!0,readonly:!0}),this.attachmentController.load(),this.data.attachmentList.each(function(t){t.person=t.lastUpdatePerson.split("@")[0];this.attachmentController.addAttachment(t)}.bind(this))}},downloadAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFileDownload(t.data.id)}.bind(this))},openAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFile(t.data.id)}.bind(this))},getAttachmentUrl:function(t,e){this.app.actions.getFileUrl(t.data.id,e)}}),MWFCalendar.EventTooltip.AttachmentController=new Class({Extends:MWF.widget.AttachmentController,loadMin:function(){this.node||(this.node=new Element("div",{styles:this.css.container_min})),this.minActionAreaNode?(this.minContent.setStyle("display","block"),this.minContent.empty()):(this.minContent=new Element("div",{styles:this.css.minContentNode}).inject(this.node),this.minContent.setStyles({"margin-right":"0px"}),this.node.inject(this.container),this.checkActions(),this.setEvent());for(var t=[];this.attachments.length;){var e=this.attachments.shift();t.push(new MWFCalendar.EventTooltip.AttachmentMin(e.data,this))}this.attachments=t},addAttachment:function(t){"min"==this.options.size?this.attachments.push(new MWFCalendar.EventTooltip.AttachmentMin(t,this)):this.attachments.push(new MWF.widget.AttachmentController.Attachment(t,this))}}),MWFCalendar.EventTooltip.AttachmentMin=new Class({Extends:MWF.widget.AttachmentController.AttachmentMin,setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css.minAttachmentNode_list_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css.minAttachmentNode_list)}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),click:function(t){this.downloadAttachment(t)}.bind(this)})},downloadAttachment:function(t){this.controller.module&&this.controller.module.downloadAttachment(t,null,[this])}});