MWF.require("MWF.widget.Mask",null,!1),MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.Index=MWF.xApplication.cms.Index||{},MWF.xApplication.cms.Index.Starter=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",ignoreDrafted:!1,categoryFlag:"",columnFlag:"",appFlag:""},initialize:function(t,e,i,s){this.setOptions(s),this.path="../x_component_cms_Index/$Starter/",this.cssPath="../x_component_cms_Index/$Starter/"+this.options.style+"/css.wcss",this._loadCss(),MWF.xDesktop.requireApp("cms.Index","$Starter."+MWF.language,null,!1),this.lp=MWF.xApplication.cms.Index.Starter.lp,this.columnData=t,this.categoryData=e,this.app=i},initData:function(){var t=this.options.appFlag||this.options.columnFlag;!this.columnData&&t&&MWF.Actions.get("x_cms_assemble_control").getColumn(t,function(t){this.columnData=t.data}.bind(this),null,!1);var e=this.options.categoryFlag;!this.categoryData&&e&&MWF.Actions.get("x_cms_assemble_control").getCategory(e,function(t){this.categoryData=t.data,this.columnData||MWF.Actions.get("x_cms_assemble_control").getColumn(this.categoryData.appId,function(t){this.columnData=t.data}.bind(this),null,!1)}.bind(this),null,!1)},load:function(){if(this.initData(),this.identityList=this.getIdentities(),this.options.ignoreDrafted)this._load(),this.fireEvent("postLoad");else if(this.categoryData.workflowAppId&&this.categoryData.workflowFlag)this._load(),this.fireEvent("postLoad");else{var t={categoryIdList:[this.categoryData.id],creatorList:[layout.desktop.session.user.distinguishedName]};this.getDocumentAction(function(){this.documentAction.listDraftNext("(0)",1,t,function(t){t.data.length>0?(this._openDocument(t.data[0].id),this.fireEvent("postLoad")):(this._load(),this.fireEvent("postLoad"))}.bind(this))}.bind(this))}},_load:function(){this.categoryData&&this.isIgnoreTitle()&&1==this.identityList.length?this.okStart():(this.createMarkNode(),this.createAreaNode(),this.createStartNode(),this.checkSubject(),this.areaNode.inject(this.markNode,"after"),this.areaNode.fade("in"),$("form_startSubject")&&$("form_startSubject").focus(),this.setStartNodeSize(),this.setStartNodeSizeFun=this.setStartNodeSize.bind(this),this.app.addEvent("resize",this.setStartNodeSizeFun))},_openDocument:function(t,e){var i="cms.Document"+t;if(this.app.desktop.apps[i])this.app.desktop.apps[i].setCurrent();else{var s={readonly:!1,documentId:t,appId:i,postPublish:function(){this.fireEvent("postPublish")}.bind(this)};this.app.desktop.openApplication(e,"cms.Document",s)}},createMarkNode:function(){this.markNode=new Element("div#mark",{styles:this.css.markNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content)},createAreaNode:function(){this.areaNode=new Element("div#area",{styles:this.css.areaNode})},createStartNode:function(){this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.areaNode),this.createNewNode=new Element("div",{styles:this.css.createNewNode}).inject(this.createNode),this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.createNode);var t=this.categoryData.name||this.categoryData.categoryName,e='<table width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0"><tr><td colSpan="2" style="height: 60px; line-height: 60px; text-align: center; font-size: 24px; font-weight: bold">'+this.lp.start+" - "+t+'</td></tr><tr><td style="height: 30px; line-height: 30px; text-align: left">'+this.lp.department+':</td><td style="; text-align: left;" id="form_startDepartment"></td></tr><tr><td style="height: 30px; line-height: 30px;  text-align: left">'+this.lp.identity+':</td><td style="; text-align: left;"><div id="form_startIdentity"></div></td></tr><tr><td style="height: 30px; line-height: 30px;  text-align: left">'+this.lp.date+':</td><td style="; text-align: left;"><div id="form_startDate"></div></td></tr><tr><td style="height: 30px; line-height: 30px;  text-align: left">'+this.lp.subject+':</td><td style="; text-align: left;"><input type="text" id="form_startSubject" style="width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; height: 26px;"/></td></tr></table>';this.formNode.set("html",e),this.setStartFormContent(),this.cancelActionNode=new Element("div",{styles:this.css.cancelActionNode,text:this.lp.cancel}).inject(this.formNode),this.startOkActionNode=new Element("div",{styles:this.css.startOkActionNode,text:this.lp.ok}).inject(this.formNode),this.cancelActionNode.addEvent("click",function(t){this.cancelStart(t)}.bind(this)),this.startOkActionNode.addEvent("click",function(t){this.okStart(t)}.bind(this))},getIdentities:function(){var t=[];return MWF.Actions.get("x_organization_assemble_personal").getPerson(function(e){(e.data&&e.data.woIdentityList?e.data.woIdentityList:[]).each(function(e){this.options.identity?this.options.identity==e.distinguishedName&&e.distinguishedName&&t.push(e):e.distinguishedName&&t.push(e)}.bind(this))}.bind(this),null,!1),t},setStartFormContent:function(){this.dateArea=this.formNode.getElementById("form_startDate");var t=new Date;this.dateArea.set("text",t.format("%Y-%m-%d %H:%M")),this.departmentSelArea=this.formNode.getElementById("form_startDepartment"),this.identityArea=this.formNode.getElementById("form_startIdentity"),this.loadDepartments()},isIgnoreTitle:function(){return this.categoryData&&this.categoryData.documentType!=this.lp.documentTypeInfor},checkSubject:function(){this.categoryData&&this.subjectInput&&(this.isIgnoreTitle()?this.subjectInput.getParent("tr").setStyle("display","none"):this.subjectInput.getParent("tr").setStyle("display",""))},loadDepartments:function(){MWF.Actions.get("x_organization_assemble_personal").getPerson(function(t){var e=t.data&&t.data.woIdentityList?t.data.woIdentityList:[],i=[];e.each(function(t){t.distinguishedName&&i.push(t)}.bind(this));var s=1==i.length;i.each(function(t){var e=new MWF.xApplication.cms.Index.Starter.DepartmentSel(t,this,this.departmentSelArea,this.identityArea);s&&e.selected()}.bind(this))}.bind(this),null)},setStartNodeSize:function(){var t=this.app.content.getSize(),e=this.app.content.getSize();this.markNode.setStyles({width:e.x+"px",height:e.y+"px"}),this.areaNode.setStyles({width:t.x+"px",height:t.y+"px"});var i=.8*t.y,s=.2*t.y/2;i>500&&(i=500),this.createNode.setStyles({height:i+"px","margin-top":s+"px"});var a=.7*i;a>250&&(a=250);var n=.3*i/2-this.createNewNode.getSize().y;this.formNode.setStyles({height:a+"px","margin-top":n+"px"})},cancelStart:function(t){var e=this;$("form_startSubject")&&$("form_startSubject").get("value")?this.app.confirm("warn",t,this.lp.start_cancel_title,this.lp.start_cancel,"320px","100px",(function(){e.markNode.destroy(),e.areaNode.destroy(),this.close()}),(function(){this.close()}),null,this.app.content):(this.markNode.destroy(),this.areaNode.destroy())},okStart:function(){this.categoryData.workflowAppId&&this.categoryData.workflowFlag?this._createProcessDocument():this._createDocument()},_createDocument:function(t){var e=$("form_startSubject"),i=e?e.get("value"):"";this.getDocumentAction();var s={id:this.documentAction.getUUID(),isNewDocument:!0,title:i,creatorIdentity:this.identityArea?this.identityArea.get("value"):this.identityList[0].distinguishedName,identity:this.identityArea?this.identityArea.get("value"):this.identityList[0].distinguishedName,appId:this.categoryData.appId,categoryId:this.categoryData.id,form:this.categoryData.formId,formName:this.categoryData.formName,docStatus:"draft",categoryName:this.categoryData.name||this.categoryData.categoryName,categoryAlias:this.categoryData.alias||this.categoryData.categoryAlias,attachmentList:[]};s.title||this.isIgnoreTitle()?s.creatorIdentity?(this.isIgnoreTitle()&&(s.title=this.lp.untitled),this.areaNode&&(this.mask=new MWF.widget.Mask({style:"desktop"}),this.mask.loadNode(this.areaNode)),this.getDocumentAction(function(){this.documentAction.addDocument(s,function(t){this.mask&&this.mask.hide(),this.markNode&&this.markNode.destroy(),this.areaNode&&this.areaNode.destroy(),this._openDocument(t.data.id),this.app.notice(this.lp.Started,"success")}.bind(this),null)}.bind(this))):(this.departmentSelArea.setStyle("border-color","red"),this.app.notice(this.lp.selectStartId,"error")):(e&&(e.setStyle("border-color","red"),e.focus()),this.app.notice(this.lp.inputSubject,"error"))},getDocumentAction:function(t){this.documentAction||(this.documentAction=MWF.Actions.get("x_cms_assemble_control")),t&&t()},_createProcessDocument:function(t){var e=$("form_startSubject"),i=e?e.get("value"):"",s=this.categoryData.workflowFlag,a={title:i,identity:this.identityArea.get("value")};if(a.title&&this.isIgnoreTitle())if(a.identity){this.isIgnoreTitle()&&(i=this.lp.untitled);var n={cmsDocument:{isNewDocument:!0,title:i,creatorIdentity:a.identity,identity:a.identity,appId:this.categoryData.appId,categoryId:this.categoryData.id,docStatus:"draft",categoryName:this.categoryData.name||this.categoryData.categoryName,categoryAlias:this.categoryData.alias||this.categoryData.categoryAlias,createTime:(new Date).format("db"),attachmentList:[]}};this.mask=new MWF.widget.Mask({style:"desktop"}),this.mask.loadNode(this.areaNode),this.getDocumentAction(function(){MWF.Actions.get("x_processplatform_assemble_surface").startWork(function(t){this.mask.hide(),this.markNode.destroy(),this.areaNode.destroy(),this.afterStartProcess(t.data,a.title,this.categoryData.workflowName,n),this.app.notice(this.lp.Started,"success")}.bind(this),null,s,a)}.bind(this))}else this.departmentSelArea.setStyle("border-color","red"),this.app.notice(this.lp.selectStartId,"error");else e&&(e.setStyle("border-color","red"),e.focus()),this.app.notice(this.lp.inputSubject,"error")},afterStartProcess:function(t,e,i,s){var a=[],n=[];t.each(function(t){-1!=t.currentTaskIndex&&n.push(t.taskList[t.currentTaskIndex].work),a.push(this.getStartWorkInforObj(t))}.bind(this));var o=n[0];MWF.Actions.get("x_processplatform_assemble_surface").saveData(function(){if(1==n.length){var t={workId:o};this.app.desktop.openApplication(null,"process.Work",t),this.createStartWorkResault(a,e,i,!1)}else this.createStartWorkResault(a,e,i,!0)}.bind(this),null,o,s)},getStartWorkInforObj:function(t){var e=[],i="";return t.taskList.each(function(s,a){e.push(s.person+"("+s.department+")"),t.currentTaskIndex==a&&(i=s.id)}.bind(this)),{activity:t.fromActivityName,users:e,currentTask:i}},createStartWorkResault:function(t,e,i,s){var a="";t.each(function(t){a+="<div><b>"+this.lp.nextActivity+'<font style="color: #ea621f">'+t.activity+"</font>, "+this.lp.nextUser+'<font style="color: #ea621f">'+t.users.join(", ")+"</font></b>",t.currentTask&&s?a+='&nbsp;&nbsp;&nbsp;&nbsp;<span value="'+t.currentTask+'">'+this.lp.deal+"</span></div>":a+="</div>"}.bind(this));var n={subject:this.lp.processStarted,content:"<div>"+this.lp.processStartedMessage+"“["+i+"]"+e+"”</div>"+a},o=layout.desktop.message.addTooltip(n),r=layout.desktop.message.addMessage(n);this.setStartWorkResaultAction(o),this.setStartWorkResaultAction(r)},setStartWorkResaultAction:function(t){var e=t.node.getElements("span");e.setStyles(this.css.dealStartedWorkAction);var i=this;e.addEvent("click",(function(t){var e={taskId:this.get("value")};i.app.desktop.openApplication(t,"process.Work",e)}))}}),MWF.xApplication.cms.Index.Starter.DepartmentSel=new Class({initialize:function(t,e,i,s){this.data=t,this.starter=e,this.container=i,this.idArea=s,this.css=this.starter.css,this.isSelected=!1,this.load()},load:function(){this.node=new Element("div",{styles:this.css.departSelNode}).inject(this.container);this.data.woUnit?this.data.woUnit.name:this.lp.unnamedUnit;this.node.set("text",this.data.woUnit.name),this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css.departSelNode_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css.departSelNode_out)}.bind(this),click:function(){this.selected()}.bind(this)})},selected:function(){this.isSelected||(this.starter.currentDepartment&&this.starter.currentDepartment.unSelected(),this.node.setStyles(this.css.departSelNode_selected),this.isSelected=!0,this.starter.currentDepartment=this,this.idArea.set({text:this.data.name,value:this.data.distinguishedName}))},unSelected:function(){this.isSelected&&(this.starter.currentDepartment&&(this.starter.currentDepartment=null),this.node.setStyles(this.css.departSelNode),this.isSelected=!1)}});