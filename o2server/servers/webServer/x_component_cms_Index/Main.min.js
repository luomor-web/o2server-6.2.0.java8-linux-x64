MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.CMSE=MWF.xApplication.cms.Index=MWF.xApplication.cms.Index||{},MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.cms.Index.options={multitask:!1,executable:!0},MWF.xApplication.cms.Index.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Index",icon:"icon.png",width:"1220",height:"680",isResize:!0,isMax:!0,title:MWF.CMSE.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.cms.Index.LP},loadApplication:function(t){this.columns=[],this.restActions=MWF.Actions.get("x_cms_assemble_control"),this.createNode(),this.loadApplicationContent()},reload:function(){this.scrollNode.destroy(),this.loadContent(),this.setCurrentAppType(this.currentAppType,this.currentAppTypeNode)},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:this.css.container}).inject(this.content)},loadApplicationContent:function(){this.loadTitle(),this.loadContent(),this.setCurrentAppType("all",this.allTypeNode)},loadTitle:function(){this.loadTitleBar(),this.loadAllTypeNode(),this.loadCreateDocumentActionNode(),this.loadSearchNode(),this.loadAppType()},loadTitleBar:function(){this.titleBarContainer=new Element("div",{styles:this.css.titleBarContainer}).inject(this.node),this.titleBar=new Element("div",{styles:this.css.titleBar}).inject(this.titleBarContainer)},loadAllTypeNode:function(){this.allTypeNode=new Element("div.columnTop_All",{styles:this.css.columnTop_All,text:this.lp.allColumn}).inject(this.titleBar),this.allTypeNode.addEvents({mouseover:function(){this.currentAppTypeNode!==this.allTypeNode&&this.allTypeNode.setStyles(this.css.columnTop_All_over)}.bind(this),mouseout:function(){this.currentAppTypeNode!==this.allTypeNode&&this.allTypeNode.setStyles(this.css.columnTop_All)}.bind(this),click:function(){this.setCurrentAppType("all",this.allTypeNode)}.bind(this)})},loadCreateDocumentActionNode:function(){this.createDocumentAction=new Element("div",{styles:this.css.createDocumentAction,text:this.lp.start}).inject(this.titleBar),this.createDocumentAction.addEvents({click:function(t){MWF.xDesktop.requireApp("cms.Index","Newer",function(){this.creater=new MWF.xApplication.cms.Index.Newer(null,null,this,this),this.creater.load()}.bind(this))}.bind(this),mouseover:function(t){this.createDocumentAction.setStyles(this.css.createDocumentAction_over),this.createDocumentAction.addClass("o2_cms_index_createDocument_over")}.bind(this),mouseout:function(t){this.createDocumentAction.setStyles(this.css.createDocumentAction),this.createDocumentAction.removeClass("o2_cms_index_createDocument_over")}.bind(this)})},loadSearchNode:function(){this.searchBarAreaNode=new Element("div",{styles:this.css.searchBarAreaNode}).inject(this.titleBar),this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.searchBarAreaNode),this.searchBarActionNode=new Element("div",{styles:this.css.searchBarActionNode,title:this.lp.search}).inject(this.searchBarNode),this.searchBarResetActionNode=new Element("div",{styles:this.css.searchBarResetActionNode,title:this.lp.reset}).inject(this.searchBarNode),this.searchBarResetActionNode.setStyle("display","none"),this.searchBarInputBoxNode=new Element("div",{styles:this.css.searchBarInputBoxNode}).inject(this.searchBarNode),this.searchBarInputNode=new Element("input",{type:"text",value:this.lp.searchKey,styles:this.css.searchBarInputNode}).inject(this.searchBarInputBoxNode);var t=this;this.searchBarActionNode.addEvent("click",function(){this.search()}.bind(this)),this.searchBarResetActionNode.addEvent("click",function(){this.reset()}.bind(this)),this.searchBarInputNode.addEvents({focus:function(){this.value==t.lp.searchKey&&this.set("value","")},blur:function(){this.value||this.set("value",t.lp.searchKey)},keydown:function(t){13==t.code&&(this.search(),t.preventDefault())}.bind(this),selectstart:function(t){t.preventDefault()}})},loadAppType:function(){var t=this;this.typeListContainer=new Element("div.columnTop_category",{styles:this.css.columnTop_category}).inject(this.titleBar),this.restActions.listAllAppType(function(e){(e.data||[]).each(function(e){new Element("div.columnTop_category",{styles:this.css.columnTop_categoryItem,text:e.appType+"("+e.count+")",events:{mouseover:function(t){this.currentAppTypeNode!==t.target&&t.target.setStyles(this.css.columnTop_categoryItem_over)}.bind(this),mouseout:function(t){this.currentAppTypeNode!==t.target&&t.target.setStyles(this.css.columnTop_categoryItem)}.bind(this),click:function(e){t.setCurrentAppType(this,e.target)}.bind(e.appType)}}).inject(this.typeListContainer)}.bind(this)),this.typeListContainer.getScrollSize().y>Math.round(this.typeListContainer.getSize().y)&&!this.columnTypeExpandNode&&this.createTypeExpandButton()}.bind(this))},createTypeExpandButton:function(){this.columnTypeExpandNode=new Element("div.columnTop_categoryExpandButton",{styles:this.css.columnTop_categoryExpandButton}).inject(this.typeListContainer,"before"),this.columnTypeExpandNode.addEvent("click",this.expandOrCollapseCategory.bind(this))},expandOrCollapseCategory:function(t){this.categoryMorph||(this.categoryMorph=new Fx.Morph(this.typeListContainer,{duration:100})),this.expand?(this.typeListContainer.setStyle("width","auto"),this.typeListContainer.setStyles(this.css.columnTop_category),this.categoryMorph.start({height:this.titleBar.getSize().y+"px"}),this.expandOrCollapseCategoryFun&&this.content.removeEvent("click",this.expandOrCollapseCategoryFun),this.expand=!1):(this.typeListContainer.setStyle("width",this.typeListContainer.getSize().x+"px"),this.typeListContainer.setStyles(this.css.columnTop_category_more),this.categoryMorph.start({height:this.typeListContainer.getScrollSize().y+"px"}),this.expandOrCollapseCategoryFun=this.expandOrCollapseCategory.bind(this),this.content.addEvent("click",this.expandOrCollapseCategoryFun),this.expand=!0),t.stopPropagation()},setCurrentAppType:function(t,e){this.currentAppType&&("all"===this.currentAppType?(this.currentAppTypeNode.setStyles(this.css.columnTop_All),this.currentAppTypeNode.removeClass("o2_cms_index_all_current")):(this.currentAppTypeNode.setStyles(this.css.columnTop_categoryItem),this.currentAppTypeNode.removeClass("o2_cms_index_categoryItem_current"))),"all"===t?(e.setStyles(this.css.columnTop_All_current),e.addClass("o2_cms_index_all_current")):(e.setStyles(this.css.columnTop_categoryItem_current),e.addClass("o2_cms_index_categoryItem_current")),this.currentAppType=t,this.currentAppTypeNode=e,this.createColumnNodes()},loadContent:function(t){this.scrollNode=new Element("div",{styles:this.css.scrollNode}).inject(this.node),this.contentWarpNode=new Element("div",{styles:this.css.node}).inject(this.scrollNode),this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode),this.setContentSize(),this.addEvent("resize",function(){this.setContentSize()}.bind(this))},createColumnNodes:function(){this.contentNode.empty(),"all"===this.currentAppType?this.restActions.listColumn(function(t){this._createColumnNodes(t)}.bind(this)):this.restActions.listWhatICanViewWithAppType(this.currentAppType,function(t){this._createColumnNodes(t)}.bind(this))},_createColumnNodes:function(t){if("array"==typeOf(t.data)){var e=t.data;e.sort((function(t,e){return parseFloat(t.appInfoSeq)-parseFloat(e.appInfoSeq)})),t.data=e;var s=0;t.data.each(function(t){(t=new MWF.xApplication.cms.Index.Column(this,t,{index:s++})).load(),this.columns.push(t)}.bind(this))}},search:function(t){t||(t=this.searchBarInputNode.get("value")),t==this.lp.searchKey&&(t=""),""!=t&&(this.searchBarResetActionNode.setStyle("display","block"),this.searchBarActionNode.setStyle("display","none")),this.columns.each(function(e){e.search(t)}.bind(this))},reset:function(){this.searchBarInputNode.set("value",this.lp.searchKey),this.searchBarResetActionNode.setStyle("display","none"),this.searchBarActionNode.setStyle("display","block"),this.columns.each(function(t){t.loadList()}.bind(this))},clearContent:function(){},openManager:function(){var t="cms.Column";this.desktop.apps[t]?this.desktop.apps[t].setCurrent():this.desktop.openApplication(null,"cms.Column",{appId:t,onQueryLoad:function(){}})},recordStatus:function(){},setContentSize:function(){var t=this.content.getSize(),e=this.titleBarContainer?this.titleBarContainer.getSize():{x:0,y:0};if(this.scrollNode.setStyle("height",t.y-e.y+"px"),this.contentWarpNode){var s=550*(t.x/550).toInt(),i=(t.x-s)/2-10;this.contentWarpNode.setStyles({width:s+"px","margin-left":i+"px"}),this.typeListContainer&&(this.typeListContainer.getScrollSize().y>Math.round(this.typeListContainer.getSize().y)?this.columnTypeExpandNode?this.columnTypeExpandNode.setStyle("display",""):this.createTypeExpandButton():this.columnTypeExpandNode&&this.columnTypeExpandNode.setStyle("display","none"))}}}),MWF.xApplication.cms.Index.Column=new Class({Implements:[Options,Events],options:{where:"bottom",index:0},initialize:function(t,e,s){this.setOptions(s),this.app=t,this.container=this.app.contentNode,this.data=e,this.isNew=!1,this.defaultColumnIcon="../x_component_cms_Index/$Main/"+this.app.options.style+"/icon/column.png"},load:function(){this.loadNode(),this.loadTop(),this.loadCategory(),this.loadList()},loadNode:function(){this.node=new Element("div.columnItem",{styles:this.app.css.columnItemNode}).inject(this.container,this.options.where);this.leftNode=new Element("div.columnItemLeftNode",{styles:this.app.css.columnItemLeftNode}).inject(this.node),this.rightNode=new Element("div.columnItemRightNode",{styles:this.app.css.columnItemRightNode}).inject(this.node);this.categoryContainer=new Element("div.categoryContainer",{styles:this.app.css.categoryContainer}).inject(this.rightNode),this.categoryList=new Element("div.categoryList",{styles:this.app.css.categoryList}).inject(this.categoryContainer),this.documentList=new Element("div",{styles:this.app.css.documentList}).inject(this.rightNode)},loadTop:function(){this.data.name=this.data.appName;var t=this.data.appName,e=this.data.appAlias,s=this.data.description,i=(this.data.appInfoSeq,this.data.creatorUid,this.data.createTime,this.leftNode),o=this.iconAreaNode=new Element("div",{styles:this.app.css.columnItemIconAreaNode}).inject(i),n=this.iconNode=new Element("img",{styles:this.app.css.columnItemIconNode}).inject(o);this.data.appIcon?this.iconNode.set("src","data:image/png;base64,"+this.data.appIcon):this.iconNode.set("src",this.defaultColumnIcon),n.makeLnk({par:this._getLnkPar()});var a=new Element("div",{styles:this.app.css.columnItemTextNode}).inject(i),c=(new Element("div",{styles:this.app.css.columnItemTitleNode,text:t,title:e?t+" ("+e+") ":t}).inject(a),s&&""!=s?s:this.app.lp.noDescription),r=(new Element("div",{styles:this.app.css.columnItemDescriptionNode,text:c,title:c}).inject(a),this);i.addEvents({click:function(t){r.clickColumnNode(r,this,t)}})},_getLnkPar:function(){var t=this.defaultColumnIcon;this.data.appIcon&&(t="data:image/png;base64,"+this.data.appIcon);var e="cms.Module"+this.data.id;return{icon:t,title:this.data.appName,par:'cms.Module#{"columnId": "'+this.data.id+'", "appId": "'+e+'"}'}},clickColumnNode:function(t,e,s){this.openModule("all",s)},clickMoreLink:function(t){var e=this.app.searchBarInputNode.get("value");e==this.app.lp.searchKey&&(e=""),this.openModule("all",t,e)},openModule:function(t,e,s,i){var o="cms.Module"+this.data.id;if(this.app.desktop.apps[o]){if(!s)return void this.app.desktop.apps[o].setCurrent();this.app.desktop.apps[o].close()}this.app.desktop.openApplication(e,"cms.Module",{columnData:{id:this.data.id},appId:o,categoryId:t,isCategory:i||!1,searchKey:s})},loadCategory:function(){var t=this;if("array"==typeOf(this.data.wrapOutCategoryList)){var e=this.data.wrapOutCategoryList;e.sort((function(t,e){return parseFloat(t.categorySeq)-parseFloat(e.categorySeq)})),this.data.wrapOutCategoryList=e,this.data.wrapOutCategoryList.each(function(e){var s=new Element("div.categoryItem",{text:e.categoryName,styles:this.app.css.categoryItem}).addClass("o2_cms_index_categoryItem_text").inject(this.categoryList,"top");s.store("category",e),s.addEvents({mouseover:function(){this.setStyles(t.app.css.categoryItem_over),this.addClass("o2_cms_index_categoryItem_text_over")},mouseout:function(){this.setStyles(t.app.css.categoryItem),this.removeClass("o2_cms_index_categoryItem_text_over")},click:function(e){t.openModule(this.retrieve("category").id,e,"",!0)}})}.bind(this)),this.categoryList.getScrollSize().y>this.categoryContainer.getSize().y&&(this.categoryArrowNode=new Element("div.categoryArrowNode",{styles:this.app.css.categoryArrowNode}).inject(this.categoryContainer),this.categoryArrowNode.addEvents({mouseover:function(){this.categoryArrowNode.setStyles("down"!=this.categoryArrow?this.app.css.categoryArrowNode_over:this.app.css.categoryArrowNode_down_over)}.bind(this),mouseout:function(){this.categoryArrowNode.setStyles("down"!=this.categoryArrow?this.app.css.categoryArrowNode:this.app.css.categoryArrowNode_down)}.bind(this),click:function(t){"down"!=this.categoryArrow?this.openCategoryList(t):this.closeCategoryList(t)}.bind(this)}))}},openCategoryList:function(t){this.categoryArrow="down",this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode_down_over),this.categoryContainer.setStyles({overflow:"visible",position:"relative"}),this.categoryList.setStyles(this.app.css.categoryList_all),window.closeCategoryList=this.closeCategoryList.bind(this),this.app.content.addEvent("click",window.closeCategoryList),t.stopPropagation()},closeCategoryList:function(t){this.categoryArrow="up",this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode),this.categoryContainer.setStyles({overflow:"hidden",position:"static"}),this.categoryList.setStyles(this.app.css.categoryList),this.app.content.removeEvent("click",window.closeCategoryList),t.stopPropagation()},destroy:function(){this.node.destroy(),MWF.release(this)},search:function(t){if(t&&""!=t){this.documentList&&this.documentList.empty(),this.moreArea&&this.moreArea.destroy();var e={title:t,appIdList:[this.data.id],statusList:["published"]};this.getDocumentData(function(t){t.count>t.size&&this.loadMoreItem(t.count,t.size),t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this),null,e)}else this.loadList()},loadList:function(){this.documentList&&this.documentList.empty(),this.moreArea&&this.moreArea.destroy(),this.getDocumentData(function(t){t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this))},listDocument:function(t){var e=this,s=new Element("div",{text:t.title,title:t.title,styles:this.app.css.documentItem}).inject(this.documentList);s.store("documentId",t.id),s.addEvents({mouseover:function(){this.setStyles(e.app.css.documentItem_over),this.addClass("mainColor_color")},mouseout:function(){this.setStyles(e.app.css.documentItem),this.removeClass("mainColor_color")},click:function(){var t=this.retrieve("documentId"),s="cms.Document"+t;if(e.app.desktop.apps[s])e.app.desktop.apps[s].setCurrent();else{var i={documentId:t,appId:s,readonly:!0,postDelete:function(){try{this.loadList()}catch(t){}}.bind(e)};e.app.desktop.openApplication(null,"cms.Document",i)}}})},getDocumentData:function(t,e,s){e||(e=6);s||(s={appIdList:[this.data.id],statusList:["published"]}),this.app.restActions.listDocumentFilterNext("(0)",e,s,(function(e){t&&t(e)}))},loadMoreItem:function(t,e){var s=this;this.moreArea=new Element("div",{styles:this.app.css.moreArea}).inject(this.rightNode),this.moreLinkText=new Element("div",{styles:this.app.css.moreLinkText,text:this.app.lp.more+"("+(t-e)+")"}).inject(this.moreArea),this.moreLinkImage=new Element("div",{styles:this.app.css.moreLinkImage}).inject(this.moreArea),this.moreArea.addEvents({mouseover:function(){this.moreLinkText.setStyles(s.app.css.moreLinkText_over),this.moreLinkImage.setStyles(s.app.css.moreLinkImage_over)}.bind(this),mouseout:function(){this.moreLinkText.setStyles(s.app.css.moreLinkText),this.moreLinkImage.setStyles(s.app.css.moreLinkImage)}.bind(this),click:function(t){s.clickMoreLink(t)}})}});