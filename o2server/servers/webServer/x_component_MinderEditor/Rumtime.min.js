MWF.xApplication.MinderEditor.History=new Class({initialize:function(e){this.minder=e,this.MAX_HISTORY=100,this.lastSnap,this.patchLock,this.undoDiffs=[],this.redoDiffs=[],this.reset(),e.on("contentchange",this.changed.bind(this)),e.on("import",this.reset.bind(this)),e.on("patch",this.updateSelection.bind(this))},reset:function(){this.undoDiffs=[],this.redoDiffs=[],this.lastSnap=this.minder.exportJson()},makeUndoDiff:function(){var e=this.minder.exportJson(),t=MWF.xApplication.MinderEditor.JsonDiff(e,this.lastSnap);if(t.length){for(this.undoDiffs.push(t);this.undoDiffs.length>this.MAX_HISTORY;)this.undoDiffs.shift();return this.lastSnap=e,!0}},makeRedoDiff:function(){var e=this.minder.exportJson();this.redoDiffs.push(MWF.xApplication.MinderEditor.JsonDiff(e,this.lastSnap)),this.lastSnap=e},undo:function(){this.patchLock=!0;var e=this.undoDiffs.pop();e&&(this.minder.applyPatches(e),this.makeRedoDiff()),this.patchLock=!1},redo:function(){this.patchLock=!0;var e=this.redoDiffs.pop();e&&(this.minder.applyPatches(e),this.makeUndoDiff()),this.patchLock=!1},changed:function(){this.patchLock||this.makeUndoDiff()&&(this.redoDiffs=[])},hasUndo:function(){return!!this.undoDiffs.length},hasRedo:function(){return!!this.redoDiffs.length},updateSelection:function(e){if(this.patchLock){var t=e.patch;switch(t.express){case"node.add":this.minder.select(t.node.getChild(t.index),!0);break;case"node.remove":case"data.replace":case"data.remove":case"data.add":this.minder.select(t.node,!0)}}}}),MWF.xApplication.MinderEditor.ClipboardMimeType=new Class({initialize:function(){this.SPLITOR="\ufeff",this.MIMETYPE={"application/km":"￿"},this.SIGN={"\ufeff":"SPLITOR","￿":"application/km"}},process:function(e,t){if(t=t||"",!this.isPureText(t)){if(!this.whichMimeType(t))throw new Error("unknow mimetype!");t=this.getPureText(t)}return!1===e?t:e+this.SPLITOR+t},registMimeTypeProtocol:function(e,t){if(t&&this.SIGN[t])throw new Error("sing has registed!");if(e&&this.MIMETYPE[e])throw new Error("mimetype has registed!");this.SIGN[t]=e,this.MIMETYPE[e]=t},getMimeTypeProtocol:function(e,t){var i=this.MIMETYPE[e]||!1;return void 0===t?this.process(i):this.process(i,t)},getSpitor:function(){return this.SPLITOR},getMimeType:function(e){return void 0!==e?this.SIGN[e]||null:this.MIMETYPE},isPureText:function(e){return!e||!~e.indexOf(this.getSpitor())},getPureText:function(e){return this.isPureText(e)?e:e.split(this.getSpitor())[1]},whichMimeType:function(e){return this.isPureText(e)?null:this.getMimeType(e.split(this.getSpitor())[0])}}),MWF.xApplication.MinderEditor.Clipboard=new Class({initialize:function(e){this.editor=e,this.minder=e.minder,this.Data=window.kityminder.data,this.minder.supportClipboardEvent&&!kity.Browser.gecko&&(this.fsm=this.editor.fsm,this.receiver=this.editor.receiver,this.MimeType=this.editor.MimeType,this.kmencode=this.MimeType.getMimeTypeProtocol("application/km"),this.decode=this.Data.getRegisterProtocol("json").decode,this._selectedNodes=[],document.addEventListener("copy",this.beforeCopy.bind(this)),document.addEventListener("cut",this.beforeCut.bind(this)),document.addEventListener("paste",this.beforePaste.bind(this)))},encode:function(e){for(var t=[],i=0,n=e.length;i<n;i++)t.push(this.minder.exportNode(e[i]));return kmencode(this.Data.getRegisterProtocol("json").encode(t))},beforeCopy:function(e){if(document.activeElement==this.receiver.element){var t=e;switch(this.fsm.state()){case"input":break;case"normal":var i=[].concat(this.minder.getSelectedNodes());if(i.length){var n;if(i.length>1)if(i.sort((function(e,t){return e.getLevel()-t.getLevel()})),(n=i[0].getLevel())!==i[i.length-1].getLevel()){var s,r=0,o=i.length,a=o-1;for(s=i[a];s.getLevel()!==n;){for(r=0;r<o&&i[r].getLevel()===n;){if(i[r].isAncestorOf(s)){i.splice(a,1);break}r++}s=i[--a]}}var h=encode(i);t.clipboardData.setData("text/plain",h)}e.preventDefault()}}},beforeCut:function(e){if(document.activeElement==this.receiver.element){if("normal"!==this.minder.getStatus())return void e.preventDefault();var t=e;this.fsm.state();switch(this.state){case"input":break;case"normal":var i=this.minder.getSelectedNodes();i.length&&(t.clipboardData.setData("text/plain",encode(i)),this.minder.execCommand("removenode")),e.preventDefault()}}},beforePaste:function(e){if(document.activeElement==this.receiver.element){if("normal"!==this.minder.getStatus())return void e.preventDefault();var t=e,i=this.fsm.state(),n=t.clipboardData.getData("text/plain");switch(i){case"input":if(!this.MimeType.isPureText(n))return void e.preventDefault();break;case"normal":var s=this.minder.getSelectedNodes();if("application/km"===this.MimeType.whichMimeType(n)){var r,o=this.decode(this.MimeType.getPureText(n));s.forEach((function(e){for(var t=o.length-1;t>=0;t--)r=this.minder.createNode(null,e),this.minder.importNode(r,o[t]),this._selectedNodes.push(r),e.appendChild(r)})),this.minder.select(this._selectedNodes,!0),this._selectedNodes=[],this.minder.refresh()}else t.clipboardData&&t.clipboardData.items[0].type.indexOf("image")>-1||s.forEach((function(e){this.minder.Text2Children(e,n)}));e.preventDefault()}}}}),MWF.xApplication.MinderEditor.Input=new Class({initialize:function(e){this.editor=e,this.fsm=e.fsm,this.minder=e.minder,this.receiver=e.receiver,this.receiverElement=this.receiver.element,this.isGecko=window.kity.Browser.gecko,this.debug=this.editor.debug,this.setupReciverElement(),this.setupFsm()},setupFsm:function(){this.fsm.when("* -> input",this.enterInputMode.bind(this)),this.fsm.when("input -> *",function(e,t,i){switch(i){case"input-cancel":return this.exitInputMode();case"input-commit":default:return this.commitInputResult()}}.bind(this)),this.receiver.onblur(function(e){"input"==this.fsm.state()&&this.fsm.jump("normal","input-commit")}.bind(this)),this.minder.on("beforemousedown",function(){"input"==this.fsm.state()&&this.fsm.jump("normal","input-commit")}.bind(this)),this.minder.on("dblclick",function(){this.minder.getSelectedNode()&&"readonly"!==this.minder._status&&this.editText()}.bind(this))},setupReciverElement:function(){this.debug.flaged&&this.receiverElement.classList.add("debug"),this.receiverElement.onmousedown=function(e){e.stopPropagation()},this.minder.on("layoutallfinish viewchange viewchanged selectionchange",function(e){"viewchange"==e.type&&"input"!=this.fsm.state()||this.updatePosition()}.bind(this)),this.updatePosition()},setupHotbox:function(){hotbox.state("main").button({position:"center",label:"编辑",key:"F2",enable:function(){return-1!=minder.queryCommandState("text")},action:editText})},editText:function(){var e=this.minder.getSelectedNode();if(e){var t=this.receiverElement;if(this.receiverElement.innerText="","bold"===e.getData("font-weight")){var i=document.createElement("b");t.appendChild(i),t=i}if("italic"===e.getData("font-style")){var n=document.createElement("i");t.appendChild(n),t=n}t.innerText=this.minder.queryCommandValue("text")||"",this.isGecko&&this.receiver.fixFFCaretDisappeared(),this.fsm.jump("input","input-request"),this.receiver.selectAll()}},enterInputMode:function(){var e=this.minder.getSelectedNode(),t=this.receiverElement;if(e){var i=e.getData("font-size")||e.getStyle("font-size");t.style.fontSize=i+"px",t.style.minWidth=0,t.style.minWidth=t.clientWidth+"px",t.style.fontWeight=e.getData("font-weight")||"",t.style.fontStyle=e.getData("font-style")||"",t.classList.add("input"),t.focus()}},commitInputText:function(e){for(var t,i,n,s="",r=/\S/,o=new RegExp("( |"+String.fromCharCode(160)+")"),a=document.createElement("br"),h=!1,d=!1,c=0,l=e.length;c<l;c++)switch(t=e[c],Object.prototype.toString.call(t)){case"[object HTMLBRElement]":s+="\n";break;case"[object Text]":if(t=t.textContent.replace("&nbsp;"," "),r.test(t))s+=t;else for(n=t.length;n--;)o.test(t[n])?s+=" ":"\t"===t[n]&&(s+="\t");break;case"[object HTMLElement]":switch(t.nodeName){case"B":h=!0;break;case"I":d=!0}[].splice.apply(e,[c,1].concat([].slice.call(t.childNodes))),l=e.length,c--;break;case"[object HTMLSpanElement]":[].splice.apply(e,[c,1].concat([].slice.call(t.childNodes))),l=e.length,c--;break;case"[object HTMLImageElement]":t.src&&/http(|s):\/\//.test(t.src)&&minder.execCommand("Image",t.src,t.alt);break;case"[object HTMLDivElement]":i=[];var m=0;for(l=t.childNodes.length;m<l;m++)i.push(t.childNodes[m]);i.push(a),[].splice.apply(e,[c,1].concat(i)),l=e.length,c--;break;default:if(t&&t.childNodes.length){i=[];for(m=0,l=t.childNodes.length;m<l;m++)i.push(t.childNodes[m]);i.push(a),[].splice.apply(e,[c,1].concat(i)),l=e.length,c--}else t&&void 0!==t.textContent?s+=t.textContent:s+=""}return s=(s=s.replace(/^\n*|\n*$/g,"")).replace(new RegExp("(\n|\r|\n\r)( |"+String.fromCharCode(160)+"){4}","g"),"$1\t"),this.minder.getSelectedNode().setText(s),h?this.minder.queryCommandState("bold")||this.minder.execCommand("bold"):this.minder.queryCommandState("bold")&&this.minder.execCommand("bold"),d?this.minder.queryCommandState("italic")||this.minder.execCommand("italic"):this.minder.queryCommandState("italic")&&this.minder.execCommand("italic"),this.exitInputMode(),s},commitInputNode:function(e,t){try{this.minder.decodeData("text",t).then(function(t){!function e(t,i,n){var s=i.data;t.setText(s.text||"");for(var r=i.children||[],o=0;o<r.length;o++){e(n.createNode(null,t),r[o],n)}return t}(e,t,this.minder),this.minder.fire("contentchange"),this.minder.getRoot().renderTree(),this.minder.layout(300)}.bind(this))}catch(e){if(this.minder.fire("contentchange"),this.minder.getRoot().renderTree(),"Error: Invalid local format"!==e.toString())throw e}},commitInputResult:function(){var e=[].slice.call(this.receiverElement.childNodes);setTimeout(function(){this.receiverElement.innerHTML=""}.bind(this),0);var t=this.minder.getSelectedNode();if(e=this.commitInputText(e),this.commitInputNode(t,e),"root"==t.type){var i=this.minder.getRoot().getText();this.minder.fire("initChangeRoot",{text:i})}},exitInputMode:function(){this.receiverElement.classList.remove("input"),this.receiver.selectAll()},updatePosition:function(){var e=this.minder.getSelectedNode();e&&(this.timer||(this.timer=setTimeout(function(){var t=e.getRenderBox("TextRenderer");this.receiverElement.style.left=Math.round(t.x)+"px",this.receiverElement.style.top=(this.debug.flaged?Math.round(t.bottom+30):Math.round(t.y))+"px",this.timer=0}.bind(this))))}}),MWF.xApplication.MinderEditor.Drag=new Class({initialize:function(e){var t,i;this.editor=e,this.fsm=e.fsm,this.minder=e.minder,this.receiver=e.receiver,this.receiverElement=this.receiver.element,this.setupFsm();var n,s,r,o,a,h=1,d=this.freeHorizen=!1,c=this.freeVirtical=!1;this.frame=null,this.minder.on("mousedown",function(e){h=0;var r=this.minder.getPaper().container.getBoundingClientRect();t=e.originEvent.clientX,i=e.originEvent.clientY,a=r.top,n=r.width,s=r.height}.bind(this)),this.minder.on("mousemove",function(e){if("drag"===this.fsm.state()&&0==h&&this.minder.getSelectedNode()&&(Math.abs(t-e.originEvent.clientX)>20||Math.abs(i-e.originEvent.clientY)>20)&&(r=e.originEvent.clientX,o=e.originEvent.clientY-a,r<20?this.move("right",20-r):r>n-20?this.move("left",20+r-n):d=!0,o<20?this.move("bottom",o):o>s-20?this.move("top",20+o-s):c=!0,d&&c&&this.move(!1)),"drag"!==this.fsm.state()&&0===h&&this.minder.getSelectedNode()&&(Math.abs(t-e.originEvent.clientX)>20||Math.abs(i-e.originEvent.clientY)>20))return this.fsm.state(),this.fsm.jump("drag","user-drag")}.bind(this)),window.addEventListener("mouseup",function(){if(h=1,"drag"===this.fsm.state())return this.move(!1),this.fsm.jump("normal","drag-finish")}.bind(this),!1)},setupFsm:function(){this.fsm.when("* -> drag",(function(){})),this.fsm.when("drag -> *",(function(e,t,i){}))},move:function(e,t){if(!e)return this.freeHorizen=this.freeVirtical=!1,this.frame&&kity.releaseFrame(this.frame),void(this.frame=null);this.frame||(this.frame=kity.requestFrame(function(e,t,i){return function(n){switch(e){case"left":i._viewDragger.move({x:-t,y:0},0);break;case"top":i._viewDragger.move({x:0,y:-t},0);break;case"right":i._viewDragger.move({x:t,y:0},0);break;case"bottom":i._viewDragger.move({x:0,y:t},0);break;default:return}n.next()}}(e,t,this.minder)))}}),MWF.xApplication.MinderEditor.FSM=new Class({initialize:function(e){this.currentState=e,this.BEFORE_ARROW=" - ",this.AFTER_ARROW=" -> ",this.handlers=[],this.debug=new MWF.xApplication.MinderEditor.Debug("fsm")},jump:function(e,t){if(!t)throw new Error("Please tell fsm the reason to jump");var i,n,s=this.currentState,r=[s,e].concat([].slice.call(arguments,1));for(i=0;i<this.handlers.length;i++)if(n=this.handlers[i],this.handlerConditionMatch(n.condition,"before",s,e)&&n.apply(null,r))return;for(this.currentState=e,this.debug.log("[{0}] {1} -> {2}",t,s,e),i=0;i<this.handlers.length;i++)n=this.handlers[i],this.handlerConditionMatch(n.condition,"after",s,e)&&n.apply(null,r);return this.currentState},state:function(){return this.currentState},when:function(e,t){var i,n,s,r;if(1==arguments.length&&(t=e,e="* -> *"),2==(n=e.split(this.BEFORE_ARROW)).length?i="before":2==(n=e.split(this.AFTER_ARROW)).length&&(i="after"),!i)throw new Error("Illegal fsm condition: "+e);s=n[0],r=n[1],t.condition={when:i,exit:s,enter:r},this.handlers.push(t)},handlerConditionMatch:function(e,t,i,n){return e.when==t&&(("*"==e.enter||e.enter==n)&&("*"==e.exit||e.exit==i||void 0))}}),MWF.xApplication.MinderEditor.Jumping=function(){var e,t,i=this.fsm,n=this.minder,s=this.receiver,r=this.container,o=s.element,a=this.hotbox;s.listen("normal",(function(e){if(s.enable(),e.is("Space"))return e.preventDefault(),kity.Browser.safari&&(o.innerHTML=""),i.jump("hotbox","space-trigger");switch(e.type){case"keydown":if(n.getSelectedNode()){if(function(e){return!(e.ctrlKey||e.metaKey||e.altKey)&&(e.keyCode>=65&&e.keyCode<=90||(e.keyCode>=48&&e.keyCode<=57||(108!=e.keyCode&&e.keyCode>=96&&e.keyCode<=111||(108!=e.keyCode&&e.keyCode>=96&&e.keyCode<=111||(229==e.keyCode||0===e.keyCode)))))}(e))return i.jump("input","user-input")}else o.innerHTML="";i.jump("normal","shortcut-handle",e)}})),s.listen("hotbox",(function(e){s.disable(),e.preventDefault();a.dispatch(e);if(a.state()==Hotbox.STATE_IDLE&&"hotbox"==i.state())return i.jump("normal","hotbox-idle")})),s.listen("input",(function(e){if(s.enable(),"keydown"==e.type){if(e.is("Enter"))return e.preventDefault(),i.jump("normal","input-commit");if(e.is("Esc"))return e.preventDefault(),i.jump("normal","input-cancel");(e.is("Tab")||e.is("Shift + Tab"))&&e.preventDefault()}else if("keyup"==e.type&&e.is("Esc"))return e.preventDefault(),i.jump("normal","input-cancel")}));r.addEventListener("mousedown",(function(n){2==n.button&&n.preventDefault(),"hotbox"==i.state()?(a.active(Hotbox.STATE_IDLE),i.jump("normal","blur")):"normal"==i.state()&&2==n.button&&(e=n.clientX,t=n.clientY)}),!1),r.addEventListener("mousewheel",(function(e){"hotbox"==i.state()&&(a.active(Hotbox.STATE_IDLE),i.jump("normal","mousemove-blur"))}),!1),r.addEventListener("contextmenu",(function(e){e.preventDefault()})),r.addEventListener("mouseup",(function(s){"normal"==i.state()&&2==s.button&&s.clientX==e&&s.clientY==t&&n.getSelectedNode()&&i.jump("hotbox","content-menu")}),!1),a.$element.addEventListener("mousedown",(function(e){e.stopPropagation()}))},MWF.xApplication.MinderEditor.Receiver=new Class({initialize:function(e){this.editor=e,this.minder=e.minder,this.fsm=e.fsm;var t=this.element=document.createElement("div");t.contentEditable=!0,t.setAttribute("tabindex",-1),t.classList.add("receiver"),t.onkeydown=t.onkeypress=t.onkeyup=this.dispatchKeyEvent.bind(this),this.editor.contentNode.appendChild(t),this.selectAll(),this.minder.on("beforemousedown",this.selectAll.bind(this)),this.minder.on("receiverfocus",this.selectAll.bind(this)),this.minder.on("readonly",function(){this.minder.disable(),this.element.parentElement.removeChild(this.element)}.bind(this)),this.listeners=[]},selectAll:function(){this.element.innerHTML||(this.element.innerHTML="&nbsp;");var e=document.createRange(),t=window.getSelection();e.selectNodeContents(this.element),t.removeAllRanges(),t.addRange(e),this.element.focus()},enable:function(){this.element.setAttribute("contenteditable",!0)},disable:function(){this.element.setAttribute("contenteditable",!1)},fixFFCaretDisappeared:function(){this.element.removeAttribute("contenteditable"),this.element.setAttribute("contenteditable","true"),this.element.blur(),this.element.focus()},onblur:function(e){this.element.onblur=e},listen:function(e,t){1==arguments.length&&(t=e,e="*"),t.notifyState=e,listeners.push(t)},dispatchKeyEvent:function(e){var t;e.is=function(e){for(var t=e.split("|"),i=0;i<t.length;i++)if(key.is(this,t[i]))return!0;return!1};for(var i=0;i<this.listeners.length;i++)if(("*"==(t=listeners[i]).notifyState||t.notifyState==fsm.state())&&this.listener.call(null,e))return}});