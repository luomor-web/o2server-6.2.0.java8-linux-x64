MWF.xApplication.MinderEditor.Drag=new Class({initialize:function(e){var t,i;this.editor=e,this.fsm=e.fsm,this.minder=e.minder,this.popmenu=e.popmenu,this.receiver=e.receiver,this.receiverElement=this.receiver.element,this.setupFsm();var n,s,r,o,h,a=1,l=this.freeHorizen=!1,d=this.freeVirtical=!1;this.frame=null,this.minder.on("mousedown",function(e){a=0;var r=this.minder.getPaper().container.getBoundingClientRect();t=e.originEvent.clientX,i=e.originEvent.clientY,h=r.top,n=r.width,s=r.height}.bind(this)),this.minder.on("mousemove",function(e){if("drag"===this.fsm.state()&&0==a&&this.minder.getSelectedNode()&&(Math.abs(t-e.originEvent.clientX)>20||Math.abs(i-e.originEvent.clientY)>20)&&(r=e.originEvent.clientX,o=e.originEvent.clientY-h,r<20?this.move("right",20-r):r>n-20?this.move("left",20+r-n):l=!0,o<20?this.move("bottom",o):o>s-20?this.move("top",20+o-s):d=!0,l&&d&&this.move(!1)),"drag"!==this.fsm.state()&&0===a&&this.minder.getSelectedNode()&&(Math.abs(t-e.originEvent.clientX)>20||Math.abs(i-e.originEvent.clientY)>20))return"popmenu"===this.fsm.state()&&popmenu.active(Popmenu.STATE_IDLE),this.fsm.jump("drag","user-drag")}.bind(this)),window.addEventListener("mouseup",function(){if(a=1,"drag"===this.fsm.state())return this.move(!1),this.fsm.jump("normal","drag-finish")}.bind(this),!1)},setupFsm:function(){this.fsm.when("* -> drag",(function(){})),this.fsm.when("drag -> *",(function(e,t,i){}))},move:function(e,t){if(!e)return this.freeHorizen=this.freeVirtical=!1,this.frame&&kity.releaseFrame(this.frame),void(this.frame=null);this.frame||(this.frame=kity.requestFrame(function(e,t,i){return function(n){switch(e){case"left":i._viewDragger.move({x:-t,y:0},0);break;case"top":i._viewDragger.move({x:0,y:-t},0);break;case"right":i._viewDragger.move({x:t,y:0},0);break;case"bottom":i._viewDragger.move({x:0,y:t},0);break;default:return}n.next()}}(e,t,this.minder)))}}),MWF.xApplication.MinderEditor.FSM=new Class({initialize:function(e){this.currentState=e,this.BEFORE_ARROW=" - ",this.AFTER_ARROW=" -> ",this.handlers=[],this.debug=new MWF.xApplication.MinderEditor.Debug("fsm")},jump:function(e,t){if(!t)throw new Error("Please tell fsm the reason to jump");var i,n,s=this.currentState,r=[s,e].concat([].slice.call(arguments,1));for(i=0;i<this.handlers.length;i++)if(n=this.handlers[i],this.handlerConditionMatch(n.condition,"before",s,e)&&n.apply(null,r))return;for(this.currentState=e,this.debug.log("[{0}] {1} -> {2}",t,s,e),i=0;i<this.handlers.length;i++)n=this.handlers[i],this.handlerConditionMatch(n.condition,"after",s,e)&&n.apply(null,r);return this.currentState},state:function(){return this.currentState},when:function(e,t){var i,n,s,r;if(this.debug.log("[{0}] {1} ",e,t),1==arguments.length&&(t=e,e="* -> *"),2==(n=e.split(this.BEFORE_ARROW)).length?i="before":2==(n=e.split(this.AFTER_ARROW)).length&&(i="after"),!i)throw new Error("Illegal fsm condition: "+e);s=n[0],r=n[1],t.condition={when:i,exit:s,enter:r},this.handlers.push(t)},handlerConditionMatch:function(e,t,i,n){return e.when==t&&(("*"==e.enter||e.enter==n)&&("*"==e.exit||e.exit==i||void 0))}}),MWF.xApplication.MinderEditor.Receiver=new Class({initialize:function(e){this.editor=e,this.minder=e.minder,this.fsm=e.fsm,this.key=e.key;var t=this.element=document.createElement("div");t.contentEditable=!0,t.setAttribute("tabindex",-1),t.classList.add("receiver"),t.onkeydown=t.onkeypress=t.onkeyup=this.dispatchKeyEvent.bind(this),this.editor.contentNode.appendChild(t),this.selectAll(),this.minder.on("beforemousedown",this.selectAll.bind(this)),this.minder.on("receiverfocus",this.selectAll.bind(this)),this.minder.on("readonly",function(){this.minder.disable(),this.element.parentElement.removeChild(this.element)}.bind(this)),this.listeners=[]},selectAll:function(){this.element.innerHTML||(this.element.innerHTML="&nbsp;");var e=document.createRange(),t=window.getSelection();e.selectNodeContents(this.element),t.removeAllRanges(),t.addRange(e),this.element.focus()},enable:function(){this.element.setAttribute("contenteditable",!0)},disable:function(){this.element.setAttribute("contenteditable",!1)},fixFFCaretDisappeared:function(){this.element.removeAttribute("contenteditable"),this.element.setAttribute("contenteditable","true"),this.element.blur(),this.element.focus()},onblur:function(e){this.element.onblur=e},listen:function(e,t){1==arguments.length&&(t=e,e="*"),t.notifyState=e,this.listeners.push(t)},dispatchKeyEvent:function(e){var t,i=this;e.is=function(e){for(var t=e.split("|"),n=0;n<t.length;n++)if(i.key.is(this,t[n]))return!0;return!1};for(var n=0;n<this.listeners.length;n++)if(("*"==(t=this.listeners[n]).notifyState||t.notifyState==this.fsm.state())&&t.call(null,e))return}});