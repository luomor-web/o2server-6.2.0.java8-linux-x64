var Popmenu=MWF.xApplication.MinderEditor.PopMenu=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,s){this.container=t,this.app=s,this.lp=MWF.xApplication.MinderEditor.LP,this.actions=this.app.restActions,this.editor=e,this.minder=i,this.receiver=e.receiver;var n=this.fsm=e.fsm;this.path="../x_component_MinderEditor/$PopMenu/",this.cssPath=this.path+this.options.style+"/css.wcss",this._loadCss(),this.nodeMenu=new MWF.xApplication.MinderEditor.NodePopMenu(this.container,null,this.app,null,{nodeStyles:this.css.tooltipNode,onPostLoad:function(){this.nodeMenu.isActive=!0}.bind(this),onHide:function(){this.nodeMenu.isActive=!1}.bind(this)},{}),this.nodeMenu.popmenu=this,this.nodeMenu.minder=this.minder,n.when("normal -> popmenu",function(t,e,i){var s,n=this.minder.getSelectedNode();if(n){var o=n.getRenderBox();s={x:o.cx,y:o.cy},this.active("main",s)}}.bind(this)),n.when("popmenu -> popmenu",function(t,e,i){var s,n=this.minder.getSelectedNode();if(n){var o=n.getRenderBox();s={x:o.cx,y:o.cy},this.active("main",s)}}.bind(this)),n.when("popmenu -> normal",function(t,e,i,s){"popmenu-idle"==i&&this.nodeMenu.isActive&&this.nodeMenu.hide()}.bind(this)),n.when("modal -> normal",function(t,e,i,s){"import-text-finish"==i&&this.receiver.element.focus()}.bind(this))},dispatch:function(t){if(this.nodeMenu.isActive){if(this.nodeMenu.dispatchKey(t))return!0;this.minder.dispatchKeyEvent(t)}return!1},active:function(t,e){"main"==t?(this.nodeMenu.targetCoordinates={top:parseInt(e.y+this.editor.Content_Offset_Top),left:e.x,width:1,height:1,right:e.x+1,bottom:parseInt(e.y)+this.editor.Content_Offset_Top+1},this.nodeMenu.load(),this.nodeMenu.checkStatus()):this.nodeMenu.hide()},state:function(){return this.nodeMenu.state},load:function(t){},destroy:function(){this.node.destroy()}});Popmenu.STATE_IDLE="idle",MWF.xApplication.MinderEditor.NodePopMenu=new Class({Extends:MTooltips,options:{axis:"x",position:{x:"auto",y:"bottom"},priorityOfAuto:{x:["right","left"],y:["bottom","middle","top"]},event:"mouseenter",hasArrow:!1,isAutoHide:!1},load:function(){this.fireEvent("queryLoad",[this]),this.isEnable()&&(this.node?this.show():this.create()),this.stat="main",this.fireEvent("postLoad",[this])},hide:function(){this.node&&(this.node.setStyle("display","none"),this.status="hidden",this.maskNode&&this.maskNode.setStyle("display","none"),this.commands.activeTooltip&&this.commands.activeTooltip.hide(),this.fireEvent("hide",[this]))},_customNode:function(t,e){this.itemNodeList=[],this.itemNodeObject={},this.availableCommands=["appendChild","appendParent","appendSibling","arrangeUp","arrangeDown","edit","remove","hyperLink","image","priority","progress"],this.commands=new MWF.xApplication.MinderEditor.Commands(this.app,{type:"popmenu",onPostExecCommand:function(t,e){this.state="idle",this.hide()}.bind(this)}),this.commands.selectOptions={tooltipsOptions:{axis:"x",position:{x:"auto",y:"auto"},priorityOfAuto:{x:["right","left"],y:["bottom"]},event:"mouseenter",hiddenDelay:200,displayDelay:0,onQueryLoad:function(t){t.selector.command&&this.commands.commands&&(t.disable=this.commands.commands[t.selector.command].disable())}.bind(this),onPostLoad:function(t){this.commands.activeTooltip=t}.bind(this),onHide:function(t){this.commands.activeTooltip==t&&(this.commands.activeTooltip=null)}.bind(this),event:"mouseenter"}},e.addEvent("contextmenu",(function(t){t.preventDefault()})),this.createItemList(e),this.state="idle"},createItemList:function(t){var e=this.popmenu;this.css=e.css,this.listContentNode=new Element("div.listContentNode",{styles:this.css.listContentNode}).inject(t),this.listNode=new Element("div.listNode",{styles:this.css.listNode}).inject(this.listContentNode);var i=this.commands.commands;this.availableCommands.each(function(t){i[t]&&this.createItem(i[t],t)}.bind(this))},createItem:function(t,e){var i=this,s=new Element("div.listItemNode",{text:t.locale||null}).inject(this.listNode),n=new Element("div.listItemKeyNode",{styles:this.css.listItemKeyNode,text:"array"==typeOf(t.key)?t.key.join(","):t.key||""}).inject(s);s.keyNode=n,this.setNormalStye(s,n,t),t.disable()&&this.setDisableStye(s,n,t);var o=t.title||"";s.set("title",o),s.addEvents({mouseover:function(){t.disable()?this.setDisableStye(s,n,t):this.setActiveStye(s,n,t)}.bind(this),mouseout:function(){t.disable()?this.setDisableStye(s,n,t):this.setNormalStye(s,n,t)}.bind(this)}),t.action&&s.addEvent("click",function(e){t.disable()||(t.action(),i.checkStatus(),i.state="idle",i.hide(),i.fireEvent("postExecCommand",[i.commands,t]),e.stopPropagation())}.bind(e)),t.init&&t.init(s,e),this.itemNodeList.push(s),this.itemNodeObject[e]=s},setDisableStye:function(t,e,i){t.setStyles(this.css.listItemNode_disable),e.setStyles(this.css.listItemKeyNode_disable),i.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.popmenu.options.style+"/icon/"+i.icon+"_disable.png)")},setActiveStye:function(t,e,i){t.setStyles(this.css.listItemNode_over),e.setStyles(this.css.listItemKeyNode_over),i.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.popmenu.options.style+"/icon/"+i.icon+"_menu.png)")},setNormalStye:function(t,e,i){t.setStyles(this.css.listItemNode),e.setStyles(this.css.listItemKeyNode),i.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.popmenu.options.style+"/icon/"+i.icon+"_normal.png)")},checkStatus:function(){for(var t in this.itemNodeObject){var e=this.itemNodeObject[t];if(this.commands.commands[t]){var i=this.commands.commands[t];i.disable()?this.setDisableStye(e,e.keyNode,i):this.setNormalStye(e,e.keyNode,i)}}},dispatchKey:function(t){var e=this.commands.getKey(t),i=this.commands.keyCommands[e];if(i&&!i.disable()&&this.itemNodeObject[i.name])return i.action?(i.action(),this.checkStatus(),this.state="idle",this.commands.fireEvent("postExecCommand",[this.commands,i]),!0):i.keyAction?(this.commands.activeTooltip&&this.commands.activeTooltip.hide(),i.keyAction(),this.state="expand",!0):(this.state="main",!0);var s=this.commands.defaultKeyCommands[e];return s&&!s.disable()&&this.itemNodeObject[s.name]?(this.state="idle",!1):(this.state="main",!0)}});