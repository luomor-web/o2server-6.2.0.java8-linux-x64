MWF.APPDD=MWF.xApplication.process.DictionaryDesigner,MWF.APPDD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("process.DictionaryDesigner","Dictionary",null,!1),MWF.xApplication.process.DictionaryDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"process.DictionaryDesigner",icon:"icon.png",title:MWF.APPDD.LP.title,appTitle:MWF.APPDD.LP.title,id:"",width:"1200",height:"600",actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.application=this.status.applicationId,this.application=this.status.application||this.status.applicationId,this.options.id=this.status.id,this.setOptions(this.status.options)),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.APPDD.LP.newDictionary),this.actions||(this.actions=MWF.Actions.get("x_processplatform_assemble_designer"),this.actions.application=this.application),this.lp=MWF.xApplication.process.DictionaryDesigner.LP,this.addEvent("queryClose",function(t){this.explorer&&this.explorer.reload()}.bind(this))},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openForm():this.maxSize(function(){this.openForm()}.bind(this)),this.options.readMode||this.addKeyboardEvents(),t&&t()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this)),this.addEvent("paste",function(){this.pasteModule()}.bind(this)),this.addEvent("cut",function(){this.cutModule()}.bind(this)),this.addEvent("keySave",function(t){this.keySave(t)}.bind(this)),this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){if(this.shortcut&&this.tab.showPage){var i=this.tab.showPage.dictionary;i&&(i.save(),t.preventDefault())}},keyDelete:function(){if(this.shortcut&&this.tab.showPage){var t=this.tab.showPage.dictionary;if(t&&t.currentSelectedItem){var i=t.currentSelectedItem;i.delItem(i.itemTextNode)}}},copyModule:function(){if(this.shortcut&&this.tab.showPage){var t=this.tab.showPage.dictionary;if(t&&t.currentSelectedItem){var i=t.currentSelectedItem;MWF.clipboard.data={type:"dictionary",data:{key:i.key,value:"object"==typeOf(i.value)?Object.clone(i.value):i.value}}}}},cutModule:function(){if(this.shortcut&&this.tab.showPage){var t=this.tab.showPage.dictionary;if(t)if(t.currentSelectedItem)this.copyModule(),t.currentSelectedItem.destroy()}},pasteModule:function(){if(this.shortcut&&MWF.clipboard.data&&"dictionary"==MWF.clipboard.data.type&&this.tab.showPage){var t=this.tab.showPage.dictionary;if(t&&t.currentSelectedItem){var i=t.currentSelectedItem,e=MWF.clipboard.data.data.key,o="object"==typeOf(MWF.clipboard.data.data.value)?Object.clone(MWF.clipboard.data.data.value):MWF.clipboard.data.data.value,n=i.level,s=i,a=null;i.parent?"array"!=i.type&&"object"!=i.type?(s=i.parent,a=i):i.exp?n=i.level+1:(s=i.parent,a=i):n=1;var r=s.children.length;if("array"==i.type){if(a){e=a.key,s.value.splice(a.key,0,o);for(var d=a.key;d<s.children.length;d++)subItem=s.children[d],subItem.key=subItem.key+1,subItem.setNodeText()}else{e=s.value.length;s.value.push(o)}r=e}else{var h=e;for(d=0;null!=s.value[e];)e=h+ ++d;if(s.value[e]=o,a)r=s.children.indexOf(a)}i=new MWF.xApplication.process.DictionaryDesigner.Dictionary.item(e,o,s,n,this.dictionary,!0,a);r&&(s.children[r-1].nextSibling=i),s.children.splice(r,0,i)}}},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},getApplication:function(t){this.application?t&&t():this.actions.getApplication(this.options.application,function(i){this.application={name:i.data.name,id:i.data.id},t&&t()}.bind(this))},openForm:function(){this.getApplication(function(){this.initOptions(),this.loadNodes(),this.loadDictionaryListNodes(),this.loadContentNode(),this.loadProperty(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadDictionary(),this.toolbarContentNode&&(this.setScrollBar(this.toolbarContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}}),this.setScrollBar(this.propertyDomArea,null,{V:{x:0,y:0},H:{x:0,y:0}}))}.bind(this))},initOptions:function(){},loadNodes:function(){this.dictionaryListNode=new Element("div",{styles:this.css.dictionaryListNode}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node)},loadDictionaryListNodes:function(){this.dictionaryListTitleNode=new Element("div",{styles:this.css.dictionaryListTitleNode,text:MWF.APPDD.LP.dictionary}).inject(this.dictionaryListNode),this.dictionaryListResizeNode=new Element("div",{styles:this.css.dictionaryListResizeNode}).inject(this.dictionaryListNode),this.dictionaryListAreaSccrollNode=new Element("div",{styles:this.css.dictionaryListAreaSccrollNode}).inject(this.dictionaryListNode),this.dictionaryListAreaNode=new Element("div",{styles:this.css.dictionaryListAreaNode}).inject(this.dictionaryListAreaSccrollNode),this.loadDictionaryListResize(),this.loadDictionaryList()},loadDictionaryListResize:function(){this.dictionaryListResize=new Drag(this.dictionaryListResizeNode,{snap:1,onStart:function(t,i){var e="firefox"==Browser.name?i.event.clientX:i.event.x,o="firefox"==Browser.name?i.event.clientY:i.event.y;t.store("position",{x:e,y:o});var n=this.dictionaryListAreaSccrollNode.getSize();t.store("initialWidth",n.x)}.bind(this),onDrag:function(t,i){var e="firefox"==Browser.name?i.event.clientX:i.event.x,o=this.content.getSize(),n=t.retrieve("position"),s=t.retrieve("initialWidth").toFloat()+(e.toFloat()-n.x.toFloat());s>o.x/2&&(s=o.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-left",s+1),this.dictionaryListNode.setStyle("width",s)}.bind(this)})},loadDictionaryList:function(){this.actions.listDictionary(this.application.id||this.application,function(t){t.data.each(function(t){this.createListDictionaryItem(t)}.bind(this))}.bind(this),null,!1)},createListDictionaryItem:function(t,i){var e=this,o=new Element("div",{styles:this.css.listDictionaryItem}).inject(this.dictionaryListAreaNode,i?"top":"bottom");new Element("div",{styles:this.css.listDictionaryItemIcon}).inject(o),new Element("div",{styles:this.css.listDictionaryItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newDictionary}).inject(o);o.store("dictionary",t),o.addEvents({dblclick:function(t){e.loadDictionaryByData(this,t)},mouseover:function(){e.currentListDictionaryItem!=this&&this.setStyles(e.css.listDictionaryItem_over)},mouseout:function(){e.currentListDictionaryItem!=this&&this.setStyles(e.css.listDictionaryItem)}})},loadDictionaryByData:function(t,i){for(var e=t.retrieve("dictionary"),o=!0,n=0;n<this.tab.pages.length;n++)if(e.id==this.tab.pages[n].dictionary.data.id){this.tab.pages[n].showTabIm(),o=!1;break}o&&this.loadDictionaryData(e.id,function(t){new MWF.xApplication.process.DictionaryDesigner.Dictionary(this,t).load()}.bind(this),!0)},loadContentNode:function(){this.contentToolbarNode=new Element("div#contentToolbarNode",{styles:this.css.contentToolbarNode}).inject(this.contentNode),this.options.readMode||this.loadContentToolbar(),this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode),this.loadEditContent(function(){this.designNode&&this.designNode.setStyles(this.css.designNode)}.bind(this))},loadContentToolbar:function(t){this.getFormToolbarHTML(function(i){i.getElements("span").each(function(t,i){var e=t.get("MWFButtonImage");e&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+e)}.bind(this)),$(i).inject(this.contentToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(i,{style:"ProcessCategory"},this),this.toolbar.load(),t&&t()}.bind(this))}.bind(this))},getFormToolbarHTML:function(t){var i=this.path+this.options.style+"/toolbars.html";new Request.HTML({url:i,method:"get",onSuccess:function(i,e,o,n){var s=i[0];t&&t(s)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},maxOrReturnEditor:function(){this.isMax?(this.isMax=!1,this.designNode.inject(this.editContentNode),this.designNode.setStyles(this.css.designNode),this.designNode.setStyles({position:"static"}),this.resizeNode(),this.tab.pages.each((function(t){t.dictionary.setAreaNodeSize()}))):(this.designNode.inject(this.node),this.designNode.setStyles({position:"absolute",width:"100%",height:"100%",top:"0px",margin:"0px",left:"0px"}),this.tab.pages.each((function(t){t.dictionary.setAreaNodeSize()})),this.isMax=!0)},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode),MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.designNode,{style:"dictionary"}),this.tab.load()}.bind(this),!1)},loadProperty:function(){this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:MWF.APPDD.LP.property}).inject(this.propertyNode),this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyDomArea=new Element("div",{styles:this.css.propertyDomArea}).inject(this.propertyContentNode),this.propertyDomPercent=.3,this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize(),this.setPropertyContent(),this.propertyNode.addEvent("keydown",(function(t){t.stopPropagation()}))},setPropertyContent:function(){this.dictionaryPropertyNode=new Element("div",{styles:this.css.dictionaryPropertyNode}),this.jsonDomNode=new Element("div",{styles:this.css.jsonDomNode}),this.jsonTextNode=new Element("div",{styles:this.css.jsonTextNode}),this.jsonTextAreaNode=new Element("textarea",{styles:this.css.jsonTextAreaNode}).inject(this.jsonTextNode),MWF.require("MWF.widget.Tab",function(){var t=new MWF.widget.Tab(this.propertyContentArea,{style:"moduleList"});t.load(),t.addTab(this.dictionaryPropertyNode,this.lp.property,!1),t.addTab(this.jsonDomNode,"JSON",!1),t.addTab(this.jsonTextNode,"TEXT",!1),t.pages[0].showTab()}.bind(this));new Element("div",{styles:this.css.propertyTitleNode,text:this.lp.id+":"}).inject(this.dictionaryPropertyNode);this.propertyIdNode=new Element("div",{styles:this.css.propertyTextNode}).inject(this.dictionaryPropertyNode),new Element("div",{styles:this.css.propertyTitleNode,text:this.lp.name+":"}).inject(this.dictionaryPropertyNode),this.propertyNameNode=new Element("input",{styles:this.css.propertyInputNode}).inject(this.dictionaryPropertyNode),(this.options.noModifyName||this.options.readMode)&&(this.propertyNameNode.set("readonly",!0),this.propertyNameNode.addEvent("keydown",function(){this.notice(this.lp.notice.noModifyName,"error")}.bind(this))),new Element("div",{styles:this.css.propertyTitleNode,text:this.lp.alias+":"}).inject(this.dictionaryPropertyNode),this.propertyAliasNode=new Element("input",{styles:this.css.propertyInputNode}).inject(this.dictionaryPropertyNode),(this.options.noModifyName||this.options.readMode)&&(this.propertyAliasNode.set("readonly",!0),this.propertyAliasNode.addEvent("keydown",function(){this.notice(this.lp.notice.noModifyName,"error")}.bind(this))),new Element("div",{styles:this.css.propertyTitleNode,text:this.lp.description+":"}).inject(this.dictionaryPropertyNode),this.propertyDescriptionNode=new Element("textarea",{styles:this.css.propertyInputAreaNode}).inject(this.dictionaryPropertyNode),(this.options.noModifyName||this.options.readMode)&&this.propertyDescriptionNode.set("readonly",!0)},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,i){var e="firefox"==Browser.name?i.event.clientX:i.event.x,o="firefox"==Browser.name?i.event.clientY:i.event.y;t.store("position",{x:e,y:o});var n=this.propertyNode.getSize();t.store("initialWidth",n.x)}.bind(this),onDrag:function(t,i){var e="firefox"==Browser.name?i.event.clientX:i.event.x,o=this.content.getSize(),n=t.retrieve("position"),s=t.retrieve("initialWidth").toFloat()+(n.x.toFloat()-e.toFloat());s>o.x/2&&(s=o.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-right",s+1),this.propertyNode.setStyle("width",s)}.bind(this)})},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,i){var e="firefox"==Browser.name?i.event.clientX:i.event.x,o="firefox"==Browser.name?i.event.clientY:i.event.y;t.store("position",{x:e,y:o});var n=this.propertyDomArea.getSize();t.store("initialHeight",n.y)}.bind(this),onDrag:function(t,i){var e=this.propertyContentNode.getSize(),o="firefox"==Browser.name?i.event.clientY:i.event.y,n=t.retrieve("position"),s=o.toFloat()-n.y.toFloat(),a=t.retrieve("initialHeight").toFloat()+s;a<40&&(a=40),a>e.y-40&&(a=e.y-40),this.propertyDomPercent=a/e.y,this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize(),i=this.propertyContentResizeNode.getSize(),e=t.y-i.y,o=this.propertyDomPercent*e,n=e-o;if(this.propertyDomArea.setStyle("height",o+"px"),this.propertyContentArea.setStyle("height",n+"px"),this.form&&this.form.currentSelectedModule&&this.form.currentSelectedModule.property){var s=this.form.currentSelectedModule.property.propertyTab;if(s){var a=s.tabNodeContainer.getSize();s.pages.each(function(t){var i=t.contentNodeArea.getStyle("margin-top").toFloat(),e=t.contentNodeArea.getStyle("margin-bottom").toFloat(),o=n-i-e-a.y.toFloat()-15;t.contentNodeArea.setStyle("height",o)}.bind(this))}}},resizeNode:function(){var t=this.node.getSize();this.contentNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var i=this.contentToolbarNode.getStyle("margin-top").toFloat(),e=this.contentToolbarNode.getStyle("margin-bottom").toFloat(),o=this.contentToolbarNode.getComputedSize(),n=t.y-o.totalHeight-i-e;if(this.editContentNode.setStyle("height",n+"px"),this.designNode){var s=this.designNode.getStyle("margin-top").toFloat(),a=this.designNode.getStyle("margin-bottom").toFloat();n=t.y-o.totalHeight-i-e-s-a,this.designNode.setStyle("height",n+"px")}titleSize=this.propertyTitleNode.getSize(),titleMarginTop=this.propertyTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.propertyTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),n=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom,n=t.y-n,this.propertyContentNode.setStyle("height",n+"px"),this.propertyResizeBar.setStyle("height",n+"px"),this.setPropertyContentResize(),titleSize=this.dictionaryListTitleNode.getSize(),titleMarginTop=this.dictionaryListTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.dictionaryListTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.dictionaryListTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.dictionaryListTitleNode.getStyle("padding-bottom").toFloat(),nodeMarginTop=this.dictionaryListAreaSccrollNode.getStyle("margin-top").toFloat(),nodeMarginBottom=this.dictionaryListAreaSccrollNode.getStyle("margin-bottom").toFloat(),n=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom,n=t.y-n,this.dictionaryListAreaSccrollNode.setStyle("height",n+"px"),this.dictionaryListResizeNode.setStyle("height",n+"px")},loadDictionary:function(){this.getDictionaryData(this.options.id,function(t){this.setTitle(this.options.appTitle+"-"+t.name),this.taskitem&&this.taskitem.setText(this.options.appTitle+"-"+t.name),this.options.appTitle=this.options.appTitle+"-"+t.name,this.options.readMode?this.dictionary=new MWF.xApplication.process.DictionaryDesigner.DictionaryReader(this,t):this.dictionary=new MWF.xApplication.process.DictionaryDesigner.Dictionary(this,t),this.dictionary.load(),this.status&&this.status.openDictionarys&&this.status.openDictionarys.each(function(t){this.loadDictionaryData(t,function(t){var i=!0;if(this.status.currentId&&this.status.currentId!=t.id&&(i=!1),this.options.readMode)var e=new MWF.xApplication.process.DictionaryDesigner.DictionaryReader(this,t,{showTab:i});else e=new MWF.xApplication.process.DictionaryDesigner.Dictionary(this,t,{showTab:i});e.load()}.bind(this),!0)}.bind(this))}.bind(this))},getDictionaryData:function(t,i){this.options.id?this.loadDictionaryData(t,i):this.loadNewDictionaryData(i)},loadNewDictionaryData:function(t){var i={name:"",id:"",application:this.application.id,alias:"",description:"",data:{}};this.createListDictionaryItem(i,!0),t&&t(i)},loadDictionaryData:function(t,i){this.actions.getDictionary(t,function(t){if(t){var e=t.data;this.application?i&&i(e):this.actions.getApplication(e.application,function(t){this.application={name:t.data.name,id:t.data.id},i&&i(e)}.bind(this))}}.bind(this))},saveDictionary:function(){if(this.tab.showPage){var t=this.tab.showPage.dictionary;t.save(function(){if(t==this.dictionary){var i=t.data.name;this.setTitle(MWF.APPDD.LP.title+"-"+i),this.options.desktopReload=!0,this.options.id=t.data.id}}.bind(this))}},saveDictionaryAs:function(){this.dictionary.saveAs()},dictionaryExplode:function(){this.dictionary.explode()},dictionaryImplode:function(){this.dictionary.implode()},dictionarySearch:function(){this.dictionary.loadSearch()},recordStatus:function(){if(this.tab){var t=[];this.tab.pages.each(function(i){i.dictionary.data.id!=this.options.id&&t.push(i.dictionary.data.id)}.bind(this));var i=this.tab.showPage.dictionary.data.id;return{id:this.options.id,application:this.application,applicationId:this.application.id||this.application,openDictionarys:t,currentId:i,options:{action:this.options.action,noCreate:this.options.noCreate,noDelete:this.options.noDelete,noModifyName:this.options.noModifyName,readMode:this.options.readMode}}}return{id:this.options.id,application:this.application}}});