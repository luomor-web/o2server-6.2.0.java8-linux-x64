MWF.xApplication.Note.options.multitask=!1,MWF.xApplication.Note.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"Note",icon:"icon.png",width:"400",height:"500",isResize:!1,isMax:!1,title:MWF.xApplication.Note.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Note.LP},loadWindowFlat:function(t){this.loadWindow(!1)},loadWindow:function(t){this.fireAppEvent("queryLoadWindow"),this.window=new MWF.xDesktop.WindowTransparent(this),this.fireAppEvent("loadWindow"),this.window.show(),this.content=this.window.content,t&&this.setCurrent(),this.fireAppEvent("postLoadWindow"),this.fireAppEvent("queryLoadApplication"),this.loadApplication(function(){this.fireAppEvent("postLoadApplication")}.bind(this))},setCurrent:function(){if(this.desktop.currentApp==this)return!0;this.desktop.currentApp&&(this.desktop.currentApp.taskitem.unSelected(),this.desktop.currentApp.desktop.currentApp=null),this.window.setCurrent(),this.window.isHide?this.window.isMax?this.window.maxSize(function(){this.fireAppEvent("current")}.bind(this)):this.window.restore(function(){this.fireAppEvent("current")}.bind(this)):this.fireAppEvent("current"),this.taskitem&&this.taskitem.selected(),this.desktop.currentApp=this,this.desktop.appCurrentList.erase(this),this.desktop.appCurrentList.push(this)},loadApplication:function(t){this.noteList=[],this.notes=[],this.topIndex=101,MWF.UD.getData("noteList",function(e){e.data&&(this.noteList=JSON.decode(e.data)),this.loadNotes(),t&&t()}.bind(this)),this.addEvent("queryClose",function(){this.notes.each((function(t){t.save(!1)}))}.bind(this)),this.unloadSaveFun=function(){this.notes.each((function(t){t.save(!1)}))}.bind(this),this.desktop.addEvent("unload",this.unloadSaveFun),this.addEvent("postClose",function(){this.desktop.removeEvent("unload",this.unloadSaveFun)}.bind(this))},loadNotes:function(){this.noteList.length?this.noteList.each(function(t){this.loadNote(t)}.bind(this)):this.loadNewNote()},loadNote:function(t){this.notes.push(new MWF.xApplication.Note.NoteItem(this,t))},loadNewNote:function(t){this.notes.push(new MWF.xApplication.Note.NoteItem(this,"",t))}}),MWF.xApplication.Note.NoteItem=new Class({Implements:[Events],initialize:function(t,e,i){this.note=t,this.css=this.note.css,this.id=e,this.load(i)},load:function(t){if(this.id)MWF.UD.getData(this.id,function(t){t.data&&(this.noteData=JSON.decode(t.data),this.loadNode())}.bind(this));else{var e=(new Date).getTime();this.id="node"+e;var i=t;if(!i){var s=this.note.desktop.desktopNode.getPosition(),n=this.note.desktop.desktopNode.getSize(),o=s.y+10;i={left:n.x-645+"px",top:o+"px"}}this.noteData={id:this.id,data:"",position:i,size:{width:"200px",height:"200px"}},this.loadNode()}},loadNode:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.note.content),this.titleNode=new Element("div",{styles:this.css.itemTitleNode}).inject(this.node),this.textarea=new Element("textarea",{styles:this.css.itemTextarea}).inject(this.node),this.bottomNode=new Element("div",{styles:this.css.itemBottomNode}).inject(this.node),this.addActionNode=new Element("div",{styles:this.css.addActionNode}).inject(this.titleNode),this.closeActionNode=new Element("div",{styles:this.css.closeActionNode}).inject(this.titleNode),this.resizeActionNode=new Element("div",{styles:this.css.resizeActionNode}).inject(this.bottomNode),this.node.setStyles({height:this.noteData.size.height,width:this.noteData.size.width}),Object.each(this.noteData.position,function(t,e){this.node.setStyle(e,t)}.bind(this));var t=this.noteData.size.width.toFloat()-10,e=this.titleNode.getSize().y,i=this.noteData.size.height.toFloat()-10-e-10-10;this.textarea.setStyles({height:i+"px",width:t+"px"}),this.textarea.set("value",this.noteData.data);new Drag.Move(this.node,{handle:this.titleNode,container:this.note.desktop.desktopNode,onDrop:function(){this.save()}.bind(this)});this.node.makeResizable({handle:this.resizeActionNode,stopPropagation:!0,preventDefault:!0,limit:{x:[100,null],y:[100,null]},onDrag:function(){var t=this.node.getSize();this.noteData.size={width:t.x+"px",height:t.y+"px"};var e=this.noteData.size.width.toFloat()-10,i=this.titleNode.getSize().y,s=this.noteData.size.height.toFloat()-10-i-10-10;this.textarea.setStyles({height:s+"px",width:e+"px"})}.bind(this),onComplete:function(){this.save()}.bind(this)}),this.setEvents()},setEvents:function(){var t=this.css;this.addActionNode.addEvents({mouseover:function(){this.setStyles(t.addActionNode_over)},mouseout:function(){this.setStyles(t.addActionNode)},click:function(){this.addNote()}.bind(this)}),this.closeActionNode.addEvents({mouseover:function(){this.setStyles(t.closeActionNode_over)},mouseout:function(){this.setStyles(t.closeActionNode)},click:function(t){this.closeNote(t)}.bind(this)}),this.textarea.addEvents({change:function(){this.save()}.bind(this),blur:function(){this.save()}.bind(this)}),this.node.addEvent("click",function(){this.note.setCurrent();this.note.notes.length;this.node.getStyle("z-index")<this.note.topIndex&&(this.node.setStyle("z-index",this.note.topIndex),this.note.topIndex++)}.bind(this))},save:function(t){var e=!0;!1===t&&(e=!1),this.noteData.data=this.textarea.get("value");var i=this.node.getPosition(),s=this.node.getSize();this.noteData.position={left:i.x+"px",top:i.y+"px"},this.noteData.size={width:s.x+"px",height:s.y+"px"},this.noteData.data&&MWF.UD.putData(this.id,this.noteData,function(t){-1==this.note.noteList.indexOf(this.id)&&(this.note.noteList.push(this.id),MWF.UD.putData("noteList",this.note.noteList))}.bind(this),e)},addNote:function(){var t=this.note.desktop.desktopNode.getSize(),e=this.node.getPosition(),i=e.x-205,s=e.y;i<0&&(i=0),i>t.x&&(i=t.x),s<0&&(s=0),s>t.y&&(s=t.y),this.note.loadNewNote({left:i+"px",top:s+"px"})},closeNote:function(t){var e=this;this.note.confirm("warn",t,this.note.lp.deleteNoteTitle,this.note.lp.deleteNote,300,120,(function(){MWF.UD.deleteData(this.id,function(t){this.note.notes.erase(this),this.note.noteList.erase(this.id),MWF.UD.putData("noteList",this.note.noteList),this.node.destroy(),this.note.notes.length||this.note.close(),MWF.release(this)}.bind(e)),this.close()}),(function(){this.close()}))}});