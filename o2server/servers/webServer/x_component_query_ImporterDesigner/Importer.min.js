MWF.xApplication=MWF.xApplication||{},MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.ImporterDesigner=MWF.xApplication.query.ImporterDesigner||{},MWF.APPDIPD=MWF.APPDIPD||MWF.xApplication.query.ImporterDesigner,MWF.xDesktop.requireApp("query.ViewDesigner","View",null,!1),MWF.xDesktop.requireApp("query.ImporterDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("query.ImporterDesigner","Property",null,!1),MWF.xApplication.query.ImporterDesigner.Importer=new Class({Extends:MWF.xApplication.query.ViewDesigner.View,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_query_ImporterDesigner/$Importer/importer.html"},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_query_ImporterDesigner/$Importer/",this.cssPath="../x_component_query_ImporterDesigner/$Importer/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=e,this.data=t,this.data.data||(this.data.data={}),this.parseData(),this.node=this.designer.designNode,this.areaNode=new Element("div.areaNode",{styles:{height:"100%",overflow:"auto"}}),this.propertyListNode=this.designer.propertyDomArea,this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewImportModel=!this.data.name,this.items=[],this.calculateItems=[],this.importer=this.view=this,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},loadViewNodes:function(){this.viewAreaNode=new Element("div#viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.areaNode),this.viewTitleNode=new Element("div#viewTitleNode",{styles:this.css.viewTitleNode}).inject(this.viewAreaNode),this.excelTitleNode=new Element("div#excelTitleNode",{styles:this.css.excelTitleNode,text:this.designer.lp.columnField+":"}).inject(this.viewTitleNode),this.addColumnLeftNode=new Element("div",{styles:this.css.addColumnLeftNode}).inject(this.viewTitleNode),this.addColumnNode=new Element("div",{styles:this.css.addColumnNode}).inject(this.viewTitleNode),this.viewTitleContentNode=new Element("div",{styles:this.css.viewTitleContentNode}).inject(this.viewTitleNode),this.viewTitleTableNode=new Element("table",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewTitleContentNode),this.viewTitleTrNode=new Element("tr",{styles:this.css.viewTitleTrNode}).inject(this.viewTitleTableNode),this.viewContentScrollNode=new Element("div",{styles:this.css.viewContentScrollNode}).inject(this.viewAreaNode),this.viewContentNode=new Element("div",{styles:this.css.viewContentNode}).inject(this.viewContentScrollNode),this.calculateTitleNode=new Element("div#calculateTitleNode",{styles:this.css.calculateTitleNode,text:this.designer.lp.calculateField+":"}).inject(this.viewContentNode),this.addCalculateFieldNode=new Element("div#addCalculateFieldNode",{styles:this.css.addCalculateFieldNode}).inject(this.calculateTitleNode),this.viewContentBodyNode=new Element("div",{styles:this.css.viewContentBodyNode}).inject(this.viewContentNode)},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFDictionaryAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4)},parseData:function(){if("string"===o2.typeOf(this.data.data)&&(this.data.data=JSON.parse(this.data.data)),this.json=this.data,this.json.data||(this.json.data={}),this.json.data.calculateFieldList||(this.json.data.calculateFieldList=[]),this.json.data.columnList||(this.json.data.columnList=[]),!this.json.data.events){MWF.getJSON("../x_component_query_ImporterDesigner/$Importer/importer.json",{onSuccess:function(e){this.json.data.events=e.data.events}.bind(this),onerror:function(e){this.notice(e,"error")}.bind(this),onRequestFailure:function(e){this.notice(e.responseText,"error")}.bind(this)},!1)}},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.ImporterDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},load:function(){this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.areaNode.inject(this.node),this.designer.viewListAreaNode.getChildren().each(function(e){var t=e.retrieve("importer");t&&t.id==this.data.id&&(this.designer.currentListViewItem&&this.designer.currentListViewItem.setStyles(this.designer.css.listViewItem),e.setStyles(this.designer.css.listViewItem_current),this.designer.currentListViewItem=e,this.lisNode=e)}.bind(this)),this.domListNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.designer.propertyDomArea),this.loadView(),this.selected(),this.setEvent(),this.setViewWidth(),this.designer.addEvent("resize",this.setViewWidth.bind(this)),this.fireEvent("postLoad")},setEvent:function(){this.areaNode.addEvent("click",this.selected.bind(this)),this.addColumnLeftNode.addEvent("click",function(e){this.addColumn(!0),e.stopPropagation()}.bind(this)),this.addColumnNode.addEvent("click",function(e){this.addColumn(),e.stopPropagation()}.bind(this)),this.addCalculateFieldNode.addEvent("click",function(e){this.addCalculateField(),e.stopPropagation()}.bind(this))},addCalculateField:function(){var e={id:(new MWF.widget.UUID).id,displayName:this.designer.lp.unnamed};this.json.data.calculateFieldList.push(e);var t=new MWF.xApplication.query.ImporterDesigner.Importer.CalculateField(e,this,null);this.calculateItems.push(t),t.selected()},addColumn:function(e){MWF.require("MWF.widget.UUID",function(){var t,i={id:(new MWF.widget.UUID).id,displayName:this.designer.lp.unnamed};e&&0!==this.json.data.columnList.length?(this.json.data.columnList.unshift(i),t=new MWF.xApplication.query.ImporterDesigner.Importer.Column(i,this,this.items[0]),this.items.unshift(t)):(this.json.data.columnList.push(i),t=new MWF.xApplication.query.ImporterDesigner.Importer.Column(i,this,null),this.items.push(t)),t.selected(),this.setViewWidth(),this.items.each((function(e,t){e.resetIndex(t)})),e?this.addColumnLeftNode.scrollIntoView(!0):this.addColumnNode.scrollIntoView(!0)}.bind(this))},loadViewColumns:function(){this.json.data.columnList&&this.json.data.columnList.each(function(e,t){this.items.push(new MWF.xApplication.query.ImporterDesigner.Importer.Column(e,this,null,t))}.bind(this))},loadViewCalculateFields:function(){this.json.data.calculateFieldList&&this.json.data.calculateFieldList.each(function(e,t){this.calculateItems.push(new MWF.xApplication.query.ImporterDesigner.Importer.CalculateField(e,this,null,t))}.bind(this))},loadView:function(){this.loadViewNodes(),this.loadViewColumns(),this.loadViewCalculateFields()},setViewWidth:function(){if(this.viewAreaNode){this.viewAreaNode.setStyle("width","auto"),this.viewTitleNode.setStyle("width","auto");var e=this.viewTitleTableNode.getSize(),t=this.viewTitleNode.getStyle("margin-left"),i=this.viewTitleNode.getStyle("margin-right"),s=this.addColumnLeftNode.getSize(),o=(this.addColumnNode.getSize(),e.x+s.x+s.x-t.toFloat()-i.toFloat()),n=this.areaNode.getSize();o>n.x?(this.viewTitleNode.setStyle("width",o+"px"),this.viewAreaNode.setStyle("width",o+"px")):(this.viewTitleNode.setStyle("width",n.x+"px"),this.viewAreaNode.setStyle("width",n.x+"px")),this.setContentColumnWidth(),this.setContentHeight()}},setContentHeight:function(){var e=this.areaNode.getSize(),t=this.viewTitleNode.getSize(),i=this.calculateTitleNode?this.calculateTitleNode.getSize():{x:0,y:0};e.y,t.y,i.y},setAreaNodeSize:function(){},saveSilence:function(e){if(!this.data.name)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.designer.actions.saveImportModel(this.data,function(t){this.data.id=t.data.id,this.isNewImportModel=!1,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),e&&e()}.bind(this))},save:function(e){if(!this.data.name)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;var t=[],i=[],s=this.json.data,o=[],n=[];"cms"===this.json.type?("importer"!==s.documentPublisher&&(t.push("documentPublisherField"),i.push("publisher")),"importer"!==s.documentPublishTime&&(t.push("documentPublisherTimeField"),i.push("publishTime"))):"process"===this.json.type&&("importer"!==s.processDrafter&&(t.push("processDrafterField"),i.push("processDrafter")),"completed"===s.processStatus&&(t=t.concat(["processStartTimeField","processCompleteTimeField"]),i=i.concat(["startTimeField","completeTimeField"]),o.push("processForm"),n.push("selectForm")));var d=[],a=this.view.designer.lp.propertyTemplate;if(t.length||o.length){o.each((function(e,t){s[e]||d.push(a[n[t]])}));var h=[].concat(s.columnList,s.calculateFieldList);t.each(function(e,t){if(s[e]){var o=s[e];h.some((function(e){return e.path===o}))||d.push(a[i[t]])}else d.push(a[i[t]])}.bind(this))}if(d.length){var l=this,r=MWF.APPDIPD.LP.notice.someFieldIsEmpty.replace("{text}",d.join("„ÄÅ"));this.designer.confirm("warn",this.node,MWF.APPDIPD.LP.notice.saveNotice,r,300,120,(function(){l._save(),this.close()}),(function(){this.close()}),null)}else this._save(e)},_save:function(e){this.designer.actions.saveImportModel(this.data,function(t){this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.isNewImportModel=!1,this.data.id=t.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),e&&e()}.bind(this))},explode:function(){},implode:function(){},_setEditStyle:function(e,t,i){"data.process"===e&&this.property.loadFormSelect()},reloadMaplist:function(){this.property&&Object.each(this.property.maplists,function(e,t){e.reload(this.json[t])}.bind(this))},setCustomStyles:function(){},saveAs:function(){new MWF.xApplication.query.ImporterDesigner.Importer.NewNameForm(this,{name:this.data.name+"_"+MWF.xApplication.query.ImporterDesigner.LP.copy,query:this.data.query||this.data.application,queryName:this.data.queryName||this.data.applicationName},{onSave:function(e,t){this._saveAs(e,t)}.bind(this)},{app:this.designer}).edit()},_saveAs:function(e,t){var i=this.cloneObject(this.data);i.isNewImportModel=!0,i.id=this.designer.actions.getUUID(),i.name=e.name,i.alias="",i.query=e.query,i.queryName=e.queryName,i.application=e.query,i.applicationName=e.queryName,i.pid=i.id+i.id,delete i[this.data.id+"viewFilterType"],i[i.id+"viewFilterType"]="custom",i.data.columnList.each(function(e){e.id=(new MWF.widget.UUID).id}.bind(this)),this.designer.actions.saveImportModel(i,function(e){this.designer.notice(this.designer.lp.notice.saveAs_success,"success",this.node,{x:"left",y:"bottom"}),t&&t()}.bind(this))},checkUniqueSetting:function(e,t,i){"true"===i&&[].concat(this.items,this.calculateItems).each((function(i){i===e||"true"!==i.json[t]&&!0!==i.json[t]||(i.json[t]=!1,i.property&&i.property.propertyContent.getElements("input[name$='"+t+"']").each((function(e){"true"===e.value&&e.set("checked",!1),"false"===e.value&&e.set("checked",!0)})))}))},preview:function(){this.isNewView?this.designer.notice(this.designer.lp.saveViewNotice,"error"):this.saveSilence(function(){var e="../x_desktop/app.html?app=query.Query&status=";e+=JSON.stringify({id:this.data.application,importerId:this.data.id}),window.open(o2.filterUrl(e),"_blank")}.bind(this))}}),MWF.xApplication.query.ImporterDesigner.Importer.Column=new Class({Extends:MWF.xApplication.query.ViewDesigner.View.Column,initialize:function(e,t,i,s){this.propertyPath="../x_component_query_ImporterDesigner/$Importer/column.html",this.view=t,this.json=e,this.next=i,this.index=s,this.css=this.view.css,this.content=this.view.viewTitleTrNode,this.domListNode=this.view.domListNode,this.load()},load:function(){this.json.events?this._load():this.loadDefaultJson(function(){this._load()}.bind(this))},_load:function(){this.areaNode=new Element("td",{styles:this.css.viewTitleColumnAreaNode}),this.areaNode.store("column",this),this.next?this.areaNode.inject(this.next.areaNode,"before"):this.areaNode.inject(this.content),this.node=new Element("div",{styles:this.css.viewTitleColumnNode}).inject(this.areaNode);var e,t=this.index2ColumnName(this.index);t=t?t+": ":"",e=!this.json.path||this.json.displayName&&this.json.displayName!==this.view.designer.lp.unnamed?this.json.displayName:this.json.path,this.textNode=new Element("div",{styles:this.css.viewTitleColumnTextNode,text:t+e}).inject(this.node),this.createDomListItem(),this._createIconAction(),this.setEvent()},loadDefaultJson:function(e){if(this.view.defaultColumnJson)return this.json=Object.merge(this.json,Object.clone(this.view.defaultColumnJson)),void(e&&e(this.json));var t=this.view.path+"column.json";MWF.getJSON(t,{onSuccess:function(t){this.view.defaultColumnJson=Object.clone(t),this.json=Object.merge(this.json,Object.clone(t)),e&&e(this.json)}.bind(this),onerror:function(e){this.view.designer.notice(e,"error")}.bind(this),onRequestFailure:function(e){this.view.designer.notice(e.responseText,"error")}.bind(this)},!1)},createDomListItem:function(){this.listNode=new Element("div",{styles:this.css.cloumnListNode}),this.next?this.listNode.inject(this.next.listNode,"before"):this.listNode.inject(this.domListNode);new Element("div",{styles:this.css.cloumnListIconNode}).inject(this.listNode),new Element("div",{styles:this.css.cloumnListTextNode}).inject(this.listNode);this.resetTextNode()},setEvent:function(){this.node.addEvents({click:function(e){this.selected(),e.stopPropagation()}.bind(this),mouseover:function(){this.isSelected||this.node.setStyles(this.css.viewTitleColumnNode_over)}.bind(this),mouseout:function(){this.isSelected||(this.isError?this.node.setStyles(this.css.viewTitleColumnNode_error):this.node.setStyles(this.css.viewTitleColumnNode))}.bind(this)}),this.listNode.addEvents({click:function(e){this.selected(),e.stopPropagation()}.bind(this),mouseover:function(){this.isSelected||this.listNode.setStyles(this.css.cloumnListNode_over)}.bind(this),mouseout:function(){this.isSelected||this.listNode.setStyles(this.css.cloumnListNode)}.bind(this)})},_createIconAction:function(){this.actionArea||(this.actionArea=new Element("div",{styles:this.css.actionAreaNode}).inject(this.view.areaNode,"after"),this._createAction({name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPDIPD.LP.action.move}),this._createAction({name:"add",icon:"add.png",event:"click",action:"addColumn",title:MWF.APPDIPD.LP.action.add}),this._createAction({name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPDIPD.LP.action.delete}))},_createAction:function(e){var t=new Element("div",{styles:this.css.actionNodeStyles,title:e.title}).inject(this.actionArea);t.setStyle("background","url("+this.view.path+this.view.options.style+"/action/"+e.icon+") no-repeat left center"),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),t.addEvents({mouseover:function(e){e.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(e){e.target.setStyle("border","1px solid #F1F1F1")}.bind(this)})},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.ImporterDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show();var e=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedProcessArea"),t=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedCMSArea");"cms"==this.view.json.type?(e.setStyle("display","none"),t.setStyle("display","block")):(e.setStyle("display","block"),t.setStyle("display","none"))}.bind(this)}),this.property.load())},delete:function(e){var t=this;e||(e=this.node),this.view.designer.confirm("warn",e,MWF.APPDIPD.LP.notice.deleteColumnTitle,MWF.APPDIPD.LP.notice.deleteColumn,300,120,(function(){t.destroy(),this.close()}),(function(){this.close()}),null)},_setEditStyle:function(e,t,i){"displayName"===e&&(this.resetTextNode(),this.view.property.loadSelectField()),"path"===e&&(this.resetTextNode(),this.view.property.loadSelectField()),"selectType"===e&&this.resetTextNode(),"attribute"===e&&this.resetTextNode()},resetTextNode:function(e){var t="attribute"==this.json.selectType?this.json.attribute||"":this.json.path||"";t||(t="unnamed");var i,s=this.index2ColumnName(e||this.index);s=s?s+": ":"",i=!this.json.path||this.json.displayName&&this.json.displayName!==this.view.designer.lp.unnamed?this.json.displayName:this.json.path,this.textNode.set("text",s+i),this.listNode.getLast().set("text",this.json.displayName+"("+t+")")},destroy:function(){this.view.currentSelectedModule==this&&(this.view.currentSelectedModule=null),this.actionArea&&this.actionArea.destroy(),this.listNode&&this.listNode.destroy(),this.property&&this.property.propertyContent.destroy();this.view.items.indexOf(this);this.view.json.data.columnList&&this.view.json.data.columnList.erase(this.json),this.view.items.erase(this),this.view.property&&this.view.property.loadStatColumnSelect(),this.areaNode.destroy(),this.view.property.loadSelectField(),this.view.selected(),this.view.setViewWidth(),this.view.items.each((function(e,t){e.resetIndex(t)})),MWF.release(this)},addColumn:function(e,t){MWF.require("MWF.widget.UUID",function(){var e;if(t)(e=Object.clone(t)).id=(new MWF.widget.UUID).id,e.column=(new MWF.widget.UUID).id;else{var i=(new MWF.widget.UUID).id;e={id:i,column:i,displayName:this.view.designer.lp.unnamed,orderType:"original"}}var s=this.view.json.data.columnList.indexOf(this.json);this.view.json.data.columnList.splice(s,0,e);var o=new MWF.xApplication.query.ImporterDesigner.Importer.Column(e,this.view,this);(this.view.items.splice(s,0,o),o.selected(),this.view.viewContentTableNode)&&this.view.viewContentTableNode.getElements("tr").each(function(e){e.insertCell(s).setStyles(this.css.viewContentTdNode)}.bind(this));this.view.setViewWidth(),this.view.items.each((function(e,t){e.resetIndex(t)}))}.bind(this))},resetIndex:function(e){this.index=e,this.resetTextNode()},index2ColumnName:function(e){if("number"!==typeOf(e))return null;if(e<0)return null;var t="";do{t.length>0&&e--;var i=e%26;t=String.fromCharCode(i+65)+t,e=(e-i)/26}while(e>0);return t},move:function(e){var t=[];this.view.items.each(function(e){e!=this&&t.push(e.areaNode)}.bind(this)),this._createMoveNode(),this._setNodeMove(t,e)},_setNodeMove:function(e,t){this._setMoveNodePosition(t);var i=this.moveNode.getPosition(),s=this.moveNode.getSize(),o=this.content.getPosition(),n=this.content.getSize();new Drag.Move(this.moveNode,{droppables:e,limit:{x:[o.x,o.x+n.x],y:[i.y,i.y+s.y]},onEnter:function(e,t){this.moveFlagNode||this.createMoveFlagNode(),this.moveFlagNode.inject(t,"before")}.bind(this),onLeave:function(e,t){this.moveFlagNode&&this.moveFlagNode.dispose()}.bind(this),onDrop:function(e,t){if(t){this.areaNode.inject(t,"before");var i=t.retrieve("column");this.listNode.inject(i.listNode,"before"),this.view.json.data.columnList.erase(this.json),this.view.items.erase(this);var s=this.view.json.data.columnList.indexOf(i.json);this.view.json.data.columnList.splice(s,0,this.json),this.view.items.splice(s,0,this),this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy(),this._setActionAreaPosition(),this.view.items.each((function(e,t){e.resetIndex(t)}))}else this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this),onCancel:function(e){this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this)}).start(t)}}),MWF.xApplication.query.ImporterDesigner.Importer.CalculateField=new Class({Extends:MWF.QV$Module,initialize:function(e,t,i){this.propertyPath="../x_component_query_ImporterDesigner/$Importer/calculateField.html",this.view=t,this.json=e,this.next=i,this.css=this.view.css,this.content=this.view.viewContentBodyNode,this.load()},load:function(){this.json.events?this._load():this.loadDefaultJson(function(){this._load()}.bind(this))},_load:function(){this.areaNode=new Element("div",{styles:this.css.viewCalculateFieldAreaNode}),this.areaNode.store("column",this),this.next?this.areaNode.inject(this.next.areaNode,"before"):this.areaNode.inject(this.content),this.node=new Element("div",{styles:this.css.viewCalculateFieldNode}).inject(this.areaNode),this.textNode=new Element("div",{styles:this.css.viewCalculateFieldTextNode,text:this.json.displayName}).inject(this.node),this._createIconAction(),this.setEvent(),this.setCustomStyles()},loadDefaultJson:function(e){if(this.view.defaultCalculateFieldJson)return this.json=Object.merge(this.json,Object.clone(this.view.defaultCalculateFieldJson)),void(e&&e(this.json));var t=this.view.path+"calculateField.json";MWF.getJSON(t,{onSuccess:function(t){this.view.defaultCalculateFieldJson=Object.clone(t),this.json=Object.merge(this.json,Object.clone(t)),e&&e(this.json)}.bind(this),onerror:function(e){this.view.designer.notice(e,"error")}.bind(this),onRequestFailure:function(e){this.view.designer.notice(e.responseText,"error")}.bind(this)},!1)},setEvent:function(){this.node.addEvents({click:function(e){this.selected(),e.stopPropagation()}.bind(this),mouseover:function(){this.isSelected||this.node.setStyles(this.css.viewTitleColumnNode_over)}.bind(this),mouseout:function(){this.isSelected||(this.isError?this.node.setStyles(this.css.viewTitleColumnNode_error):this.node.setStyles(this.css.viewTitleColumnNode))}.bind(this)})},selected:function(){if(this.view.currentSelectedModule){if(this.view.currentSelectedModule==this)return!0;this.view.currentSelectedModule.unSelected()}this.node.setStyles(this.css.viewCalculateFieldNode_selected),new Fx.Scroll(this.view.areaNode,{wheelStops:!1,duration:100}).toElementEdge(this.node),this.view.currentSelectedModule=this,this.isSelected=!0,this._showActions(),this.showProperty()},unSelected:function(){this.view.currentSelectedModule=null,this.node.setStyles(this.css.viewCalculateFieldNode),this.isSelected=!1,this._hideActions(),this.hideProperty()},_createIconAction:function(){this.actionArea||(this.actionArea=new Element("div",{styles:this.css.actionAreaNode}).inject(this.view.areaNode,"after"),this._createAction({name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPDIPD.LP.action.move}),this._createAction({name:"add",icon:"add.png",event:"click",action:"addColumn",title:MWF.APPDIPD.LP.action.add}),this._createAction({name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPDIPD.LP.action.delete}))},_createAction:function(e){var t=new Element("div",{styles:this.css.actionNodeStyles,title:e.title}).inject(this.actionArea);t.setStyle("background","url("+this.view.path+this.view.options.style+"/action/"+e.icon+") no-repeat left center"),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),t.addEvents({mouseover:function(e){e.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(e){e.target.setStyle("border","1px solid #F1F1F1")}.bind(this)})},_setActionAreaPosition:function(){var e=this.node.getPosition(this.view.areaNode.getOffsetParent()),t=e.y-25,i=e.x;this.actionArea.setPosition({x:i,y:t})},_showActions:function(){this.actionArea&&(this._setActionAreaPosition(),this.actionArea.setStyle("display","block"))},_hideActions:function(){this.actionArea&&this.actionArea.setStyle("display","none")},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.ImporterDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show();var e=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedProcessArea"),t=this.property.propertyContent.getElements("#"+this.json.id+"dataPathSelectedCMSArea");"cms"==this.view.json.type?(e.setStyle("display","none"),t.setStyle("display","block")):(e.setStyle("display","block"),t.setStyle("display","none"))}.bind(this)}),this.property.load())},delete:function(e){var t=this;e||(e=this.node),this.view.designer.confirm("warn",e,MWF.APPDIPD.LP.notice.deleteFieldTitle,MWF.APPDIPD.LP.notice.deleteField,300,120,(function(){t.destroy(),this.close()}),(function(){this.close()}),null)},_setEditStyle_custom:function(e,t,i){"displayName"==e&&(this.resetTextNode(),this.view.property.loadSelectField()),"selectType"==e&&this.resetTextNode(),"attribute"==e&&this.resetTextNode(),"path"==e&&(this.resetTextNode(),this.view.property.loadSelectField())},resetTextNode:function(e){var t;t=!this.json.path||this.json.displayName&&this.json.displayName!==this.view.designer.lp.unnamed?this.json.displayName:this.json.path,this.textNode.set("text",t)},destroy:function(){this.view.currentSelectedModule==this&&(this.view.currentSelectedModule=null),this.actionArea&&this.actionArea.destroy(),this.property&&this.property.propertyContent.destroy();this.view.calculateItems.indexOf(this);this.view.json.data.calculateFieldList&&this.view.json.data.calculateFieldList.erase(this.json),this.view.calculateItems.erase(this),this.view.property&&this.view.property.loadStatColumnSelect(),this.areaNode.destroy(),this.view.property.loadSelectField(),this.view.selected(),MWF.release(this)},addColumn:function(e,t){MWF.require("MWF.widget.UUID",function(){var e;if(t)(e=Object.clone(t)).id=(new MWF.widget.UUID).id,e.column=(new MWF.widget.UUID).id;else{var i=(new MWF.widget.UUID).id;e={id:i,column:i,displayName:this.view.designer.lp.unnamed,orderType:"original"}}var s=this.view.json.data.calculateFieldList.indexOf(this.json);this.view.json.data.calculateFieldList.splice(s,0,e);var o=new MWF.xApplication.query.ImporterDesigner.Importer.CalculateField(e,this.view,this);this.view.calculateItems.splice(s,0,o),o.selected()}.bind(this))},move:function(e){var t=[];this.view.calculateItems.each(function(e){e!=this&&t.push(e.areaNode)}.bind(this)),this._createMoveNode(),this._setNodeMove(t,e)},_createMoveNode:function(){this.moveNode=new Element("div",{text:this.node.get("text")}),this.moveNode.inject(this.view.designer.content),this.moveNode.setStyles({border:"2px dashed #ffa200",opacity:.7,height:"30px","line-height":"30px",padding:"0px 10px",position:"absolute"})},_setMoveNodePosition:function(e){var t=e.page.x+2,i=e.page.y+2;this.moveNode.positionTo(t,i)},createMoveFlagNode:function(){this.moveFlagNode=new Element("td",{styles:this.css.moveFieldFlagNode})},_setNodeMove:function(e,t){this._setMoveNodePosition(t);var i=this.moveNode.getPosition(),s=this.moveNode.getSize(),o=this.content.getPosition(),n=this.content.getSize();new Drag.Move(this.moveNode,{droppables:e,limit:{x:[o.x,o.x+n.x],y:[i.y,i.y+s.y]},onEnter:function(e,t){this.moveFlagNode||this.createMoveFlagNode(),this.moveFlagNode.inject(t,"before")}.bind(this),onLeave:function(e,t){this.moveFlagNode&&this.moveFlagNode.dispose()}.bind(this),onDrop:function(e,t){if(t){this.areaNode.inject(t,"before");var i=t.retrieve("column");this.view.json.data.calculateFieldList.erase(this.json),this.view.calculateItems.erase(this);var s=this.view.json.data.calculateFieldList.indexOf(i.json);this.view.json.data.calculateFieldList.splice(s,0,this.json),this.view.calculateItems.splice(s,0,this),this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy(),this._setActionAreaPosition()}else this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this),onCancel:function(e){this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this)}).start(t)}});