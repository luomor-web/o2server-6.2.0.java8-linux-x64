MWF.xApplication=MWF.xApplication||{},MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.StatDesigner=MWF.xApplication.query.StatDesigner||{},MWF.APPDSTD=MWF.xApplication.query.StatDesigner,MWF.xDesktop.requireApp("query.StatDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("query.ViewDesigner","ViewBase",null,!1),MWF.xDesktop.requireApp("query.StatDesigner","Property",null,!1),MWF.xApplication.query.StatDesigner.Stat=new Class({Extends:MWF.xApplication.query.ViewDesigner.ViewBase,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_query_StatDesigner/$Stat/stat.html"},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_query_StatDesigner/$Stat/",this.cssPath="../x_component_query_StatDesigner/$Stat/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=t,this.data=e,this.data.data||(this.data.data={}),this.parseData(),this.node=this.designer.designNode,this.areaNode=new Element("div",{styles:{height:"100%",overflow:"auto"}}),this.propertyListNode=this.designer.propertyDomArea,this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewView=!this.data.id,this.items=[],this.view=this,this.queryView=null,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},changeViewSelected:function(){this.json.view&&(this.queryView?(this.items.each(function(t){t.changeViewSelected(this.queryView)}.bind(this)),this.checkIsGroupRadioDisplay()):this.designer.actions.getView(this.json.view,function(t){this.queryView=JSON.decode(t.data.data),this.items.each(function(t){t.changeViewSelected(this.queryView)}.bind(this)),this.checkIsGroupRadioDisplay()}.bind(this)))},checkIsGroupRadioDisplay:function(){if(this.property){var t=this.property.propertyContent.getElement(".MWFIsGroupArea");if(t)if(this.queryView.group.column)t.setStyle("display","block");else{this.json.data.calculate.isGroup=!1;for(var e=t.getElements("input"),i=0;i<e.length;i++)if("false"==e[i].value){e[i].set("checked",!0);break}this.hideGroupTitle(),t.setStyle("display","none")}}},checkIsGroupRadio:function(){this.queryView?this.checkIsGroupRadioDisplay():this.designer.actions.getView(this.json.view,function(t){this.queryView=JSON.decode(t.data.data),this.checkIsGroupRadioDisplay()}.bind(this))},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},loadViewData:function(){this.data.id&&this.saveSilence(function(){this.viewContentBodyNode.empty(),this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode),this.designer.actions.loadStat(this.data.id,null,function(t){var e={};if(t.data.calculate.calculateList.each(function(t){e[t.id]=t}.bind(this)),this.json.data.calculate.isGroup){if(t.data.calculateGrid.length&&t.data.calculateGrid.each(function(i){var s=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode),n=new Element("td",{styles:this.css.viewContentTdNode}).inject(s);n.set("text",i.group),n.setStyle("font-weight","bold"),i.list.each(function(i){new Element("td",{styles:this.css.viewContentTdNode}).inject(s).set("text",e[i.column].code?MWF.Macro.exec(e[i.column].code,{value:i.value,data:t.data}):i.value)}.bind(this))}.bind(this)),t.data.calculateAmountGrid){var i=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode),s=new Element("td",{styles:this.css.viewContentTdNode}).inject(i);s.set("text",this.designer.lp.amount),s.setStyles({"font-weight":"bold",color:"#0000FF"}),t.data.calculateAmountGrid.each(function(t){var e=new Element("td",{styles:this.css.viewContentTdNode}).inject(i);e.set("text",t.value),e.setStyles({"font-weight":"bold",color:"#0000FF"})}.bind(this))}}else if(t.data.calculateGrid.length){i=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);t.data.calculateGrid.each(function(t){new Element("td",{styles:this.css.viewContentTdNode}).inject(i).set("text",t.value)}.bind(this))}this.setContentColumnWidth(),this.setContentHeight()}.bind(this))}.bind(this))},addColumn:function(){MWF.require("MWF.widget.UUID",function(){var t={id:(new MWF.widget.UUID).id,column:"",displayName:this.designer.lp.unnamed,calculateType:"sum",orderType:"original",orderEffectType:"key"};this.json.data.calculate.calculateList||(this.json.data.calculate.calculateList=[]),this.json.data.calculate.calculateList.push(t);var e=new MWF.xApplication.query.StatDesigner.Stat.Column(t,this);(this.items.push(e),e.selected(),this.property&&this.property.loadStatColumnSelect(),this.viewContentTableNode)&&this.viewContentTableNode.getElements("tr").each(function(t){new Element("td",{styles:this.css.viewContentTdNode}).inject(t)}.bind(this));this.setViewWidth(),this.addColumnNode.scrollIntoView(!0)}.bind(this))},loadViewColumns:function(){this.json.data.calculate.calculateList&&this.json.data.calculate.calculateList.each(function(t){this.items.push(new MWF.xApplication.query.StatDesigner.Stat.Column(t,this))}.bind(this))},saveSilence:function(t){return this.data.name?this.checkViewAndColumn()?void this.designer.actions.saveStat(this.data,function(e){this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),t&&t()}.bind(this)):(this.designer.notice(this.designer.lp.notice.errorViewColumn,"error"),!1):(this.designer.notice(this.designer.lp.notice.inputName,"error"),!1)},save:function(t){return this.data.name?this.checkViewAndColumn()?void this.designer.actions.saveStat(this.data,function(e){this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),t&&t()}.bind(this)):(this.designer.notice(this.designer.lp.notice.errorViewColumn,"error"),!1):(this.designer.notice(this.designer.lp.notice.inputName,"error"),!1)},checkViewAndColumn:function(){for(var t=!0,e=0;e<this.items.length;e++)this.items[e].checkColumn()||(t=!1);return t},_setEditStyle:function(t,e,i){"data.calculate.isGroup"==t&&(this.viewContentBodyNode.empty(),this.data.data.calculate.isGroup?this.showGroupTitle():this.hideGroupTitle()),"data.calculate.title"==t&&(this.data.data.calculate.title||(this.data.data.calculate.title=this.designer.lp.category),this.data.data.calculate.title!=i&&this.groupTitleNode&&this.groupTitleNode.getFirst().getFirst().set("text",this.data.data.calculate.title))},showGroupTitle:function(){this.groupTitleNode||this.createGroupTitltNode()},hideGroupTitle:function(){this.groupTitleNode&&(this.groupTitleNode.destroy(),this.groupTitleNode=null)},createGroupTitltNode:function(){this.data.data.calculate.title=this.data.data.calculate.title||this.designer.lp.category,this.groupTitleNode=new Element("td",{styles:this.css.viewGroupTitleNode});var t=new Element("div",{styles:this.css.viewGroupTitleColumnNode}).inject(this.groupTitleNode);new Element("div",{styles:this.css.viewGroupTitleColumnTextNode,text:this.data.data.calculate.title}).inject(t);this.items.length?this.groupTitleNode.inject(this.items[0].areaNode,"before"):this.groupTitleNode.inject(this.viewTitleTrNode)},saveAs:function(){new MWF.xApplication.query.StatDesigner.Stat.NewNameForm(this,{name:this.data.name+"_"+MWF.xApplication.query.StatDesigner.LP.copy,view:this.data.view,query:this.data.query||this.data.application,queryName:this.data.queryName||this.data.applicationName},{onSave:function(t,e){this._saveAs(t,e)}.bind(this)},{app:this.designer}).edit()},explode:function(){},implode:function(){},_saveAs:function(t,e){var i=Object.clone(this.data);i.isNewView=!0,i.id=this.designer.actions.getUUID(),i.name=t.name,i.alias="",i.query=t.query,i.queryName=t.queryName,i.application=t.query,i.applicationName=t.queryName,i.view=t.view,i.data.calculate&&i.data.calculate.calculateList&&i.data.calculate.calculateList.each(function(t){t.id=(new MWF.widget.UUID).id}.bind(this)),this.designer.actions.saveStat(i,function(t){this.designer.notice(this.designer.lp.notice.saveAs_success,"success",this.node,{x:"left",y:"bottom"}),e&&e()}.bind(this))}}),MWF.xApplication.query.StatDesigner.Stat.Column=new Class({Extends:MWF.xApplication.query.ViewDesigner.ViewBase.Column,initialize:function(t,e,i){this.propertyPath="../x_component_query_StatDesigner/$Stat/column.html",this.view=e,this.json=t,this.next=i,this.css=this.view.css,this.content=this.view.viewTitleTrNode,this.domListNode=this.view.domListNode,this.load()},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.StatDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show(),this.changeViewSelected()}.bind(this)}),this.property.load())},_setEditStyle:function(t,e,i){"displayName"==t&&this.resetTextNode(),"column"==t&&this.checkColumn(),"view"==t&&this.json.view!=i&&(this.view.viewContentBodyNode.empty(),this.view.designer.actions.getView(this.json.view,function(t){this.queryView=JSON.decode(t.data.data)}.bind(this),null,!1),this.changeViewSelected())},resetTextNode:function(){var t=this.json.displayName+"("+this.json.calculateType+")";this.textNode.set("text",this.json.displayName),this.listNode.getLast().set("text",t),this.view.property&&this.view.property.loadStatColumnSelect()},delete:function(t){var e=this;t||(t=this.node),this.view.designer.confirm("warn",t,MWF.APPDSTD.LP.notice.deleteColumnTitle,MWF.APPDSTD.LP.notice.deleteColumn,300,120,(function(){e.destroy(),this.close()}),(function(){this.close()}),null)},addColumn:function(t,e){MWF.require("MWF.widget.UUID",function(){var t;e?((t=Object.clone(e)).id=(new MWF.widget.UUID).id,t.column=(new MWF.widget.UUID).id):t={id:(new MWF.widget.UUID).id,column:"",displayName:this.view.designer.lp.unnamed,calculateType:"sum",orderType:"original",orderEffectType:"key"};var i=this.view.json.data.calculate.calculateList.indexOf(this.json);this.view.json.data.calculate.calculateList.splice(i,0,t);var s=new MWF.xApplication.query.StatDesigner.Stat.Column(t,this.view,this);(this.view.items.splice(i,0,s),s.selected(),this.view.property&&this.view.property.loadStatColumnSelect(),this.view.viewContentTableNode)&&this.view.viewContentTableNode.getElements("tr").each(function(t){t.insertCell(i).setStyles(this.css.viewContentTdNode)}.bind(this));this.view.setViewWidth()}.bind(this))},_setNodeMove:function(t,e){this._setMoveNodePosition(e);var i=this.moveNode.getPosition(),s=this.moveNode.getSize(),n=this.content.getPosition(),o=this.content.getSize();new Drag.Move(this.moveNode,{droppables:t,limit:{x:[n.x,n.x+o.x],y:[i.y,i.y+s.y]},onEnter:function(t,e){this.moveFlagNode||this.createMoveFlagNode(),this.moveFlagNode.inject(e,"before")}.bind(this),onLeave:function(t,e){this.moveFlagNode&&this.moveFlagNode.dispose()}.bind(this),onDrop:function(t,e){if(e){this.areaNode.inject(e,"before");var i=e.retrieve("column");this.listNode.inject(i.listNode,"before"),this.view.json.data.calculate.calculateList.erase(this.json),this.view.items.erase(this);var s=this.view.json.data.calculate.calculateList.indexOf(i.json);this.view.json.data.calculate.calculateList.splice(s,0,this.json),this.view.items.splice(s,0,this),this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy(),this._setActionAreaPosition()}else this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this),onCancel:function(t){this.moveNode&&this.moveNode.destroy(),this.moveFlagNode&&this.moveFlagNode.destroy()}.bind(this)}).start(e)},changeViewSelected:function(t){t?this.changeViewColumnOptions(t):this.json.view?this.queryView?this.changeViewColumnOptions(this.queryView):this.view.designer.actions.getView(this.json.view,function(t){this.queryView=JSON.decode(t.data.data),this.changeViewColumnOptions(this.queryView)}.bind(this)):this.changeViewColumnOptions(t)},changeViewColumnOptions:function(t){this.property&&this.property.propertyContent.getElements(".MWFViewColumnSelect").each(function(e){e.empty(),t?(new Element("option",{value:"",text:"(none)",selected:!this.json.column}).inject(e),t.selectList.each(function(t){new Element("option",{value:t.column,text:t.displayName,selected:t.column==this.json.column}).inject(e)}.bind(this))):this.json.column=""}.bind(this))},checkColumn:function(){var t=!0;if(!this.queryView){if(!this.json.view)return this.errorMark(),!1;this.view.designer.actions.getView(this.json.view,function(t){this.queryView=JSON.decode(t.data.data)}.bind(this),null,!1)}return this.queryView.selectList.filter(function(t){return t.column==this.json.column}.bind(this)).length?this.errorMark(!0):(this.errorMark(),t=!1),t},errorMark:function(t){t?(this.isError=!1,this.isSelected||this.node.setStyles(this.css.viewTitleColumnNode)):(this.isError=!0,this.isSelected||this.node.setStyles(this.css.viewTitleColumnNode_error))}});