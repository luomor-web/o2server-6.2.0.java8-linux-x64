MWF.require("MWF.widget.Common",null,!1),MWF.require("MWF.widget.JsonTemplate",null,!1),MWF.xApplication.query.StatDesigner.Property=MWF.FVProperty=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",path:"../x_component_query_FormDesigner/property/property.html"},initialize:function(t,e,n,i){this.setOptions(i),this.module=t,this.view=t.view,this.data=t.json,this.htmlPath=this.options.path,this.designer=n,this.propertyNode=e},load:function(){this.fireEvent("queryLoad")&&MWF.getRequestText(this.htmlPath,function(t,e){this.htmlString=t,this.fireEvent("postLoad")}.bind(this)),this.propertyNode.addEvent("keydown",(function(t){t.stopPropagation()}))},editProperty:function(t){},getHtmlString:function(t){this.htmlString?t&&t():MWF.getRequestText(this.htmlPath,function(e,n){this.htmlString=e,t&&t()}.bind(this))},show:function(){this.propertyContent?this.propertyContent.setStyle("display","block"):this.getHtmlString(function(){this.htmlString&&(this.htmlString=o2.bindJson(this.htmlString,{lp:MWF.xApplication.query.StatDesigner.LP.propertyTemplate}),this.JsonTemplate=new MWF.widget.JsonTemplate(this.data,this.htmlString),this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyNode),this.propertyContent.set("html",this.JsonTemplate.load()),this.setEditNodeEvent(),this.setEditNodeStyles(this.propertyContent),this.loadPropertyTab(),this.loadPersonInput(),this.loadPersonSelectInput(),this.loadViewSelect(),this.loadStatColumnSelect(),this.loadArrayList(),this.loadScriptArea(),this.loadJSONArea(),this.module.changeViewSelected())}.bind(this))},hide:function(){this.propertyContent&&this.propertyContent.setStyle("display","none")},loadJSONArea:function(){var t=this.propertyContent.getElement(".MWFJSONArea");t&&this.propertyTab.pages.each(function(e){e.contentNode==t.parentElement&&e.setOptions({onShow:function(){t.empty(),MWF.require("MWF.widget.JsonParse",function(){this.json=new MWF.widget.JsonParse(this.module.json,t,null),this.json.load()}.bind(this))}.bind(this)})}.bind(this))},loadPropertyTab:function(){var t=this.propertyContent.getElements(".MWFTab");if(t.length){var e=this.propertyContent.getFirst(),n=new Element("div",{styles:this.view.css.propertyTabNode}).inject(e,"before");MWF.require("MWF.widget.Tab",function(){var e=new MWF.widget.Tab(n,{style:"formPropertyList"});e.load();var i=[];t.each(function(t){var n=e.addTab(t,t.get("title"),!1);i.push(n),this.setScrollBar(n.contentNodeArea,"small",null,null)}.bind(this)),i[0].showTab(),this.propertyTab=e,this.designer.resizeNode()}.bind(this),!1)}},setEditNodeEvent:function(){var t=this;this.propertyContent.getElements("input").each(function(e){var n=e.get("name");if(n&&"_"!=n.substr(0,1)){if(this.module){var i=this.module.json.id;e.set("name",i+n)}if(n)switch(e.get("type").toLowerCase()){case"radio":e.addEvent("change",(function(e){t.setRadioValue(n,this)})),e.addEvent("keydown",(function(t){t.stopPropagation()})),t.setRadioValue(n,e);break;case"checkbox":e.addEvent("change",(function(e){t.setCheckboxValue(n,this)})),e.addEvent("click",(function(e){t.setCheckboxValue(n,this)})),e.addEvent("keydown",(function(t){t.stopPropagation()}));break;default:e.addEvent("change",(function(e){t.setValue(n,this.value,this)})),e.addEvent("blur",(function(e){t.setValue(n,this.value,this)})),e.addEvent("keydown",(function(e){13==e.code&&t.setValue(n,this.value,this),e.stopPropagation()})),e.hasClass("editTableInputDate")&&this.loadCalendar(e)}}}.bind(this)),this.propertyContent.getElements("select").each((function(e){var n=e.get("name");n&&e.addEvent("change",(function(e){t.setSelectValue(n,this)}))})),this.propertyContent.getElements("textarea").each(function(e){var n=e.get("name");n&&(e.addEvent("change",(function(e){t.setValue(n,this.value)})),e.addEvent("blur",(function(e){t.setValue(n,this.value)})),e.addEvent("keydown",(function(t){t.stopPropagation()})))}.bind(this))},loadCalendar:function(t){MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(t,{style:"xform",isTime:!1,target:this.module.designer.content,format:"%Y-%m-%d",onComplate:function(){}.bind(this)})}.bind(this))},changeStyle:function(t){this.module.setPropertiesOrStyles(t)},changeData:function(t,e,n){this.module._setEditStyle(t,e,n)},changeJsonDate:function(t,e){"array"!=typeOf(t)&&(t=[t]);var n=this.data,i=t.length-1;t.each(function(t,e){n[t]||(n[t]={}),e<i&&(n=n[t])}.bind(this)),n[t[i]]=e},setRadioValue:function(t,e){if(e.checked){var n=t.indexOf("*"),i=-1==n?t.split("."):t.substr(n+1,t.length).split("."),s=e.value;"false"==s&&(s=!1),"true"==s&&(s=!0);for(var a=this.data,o=0;o<i.length;o++){if(!a[i[o]]){a=null;break}a=a[i[o]]}this.changeJsonDate(i,s),this.changeData(t,e,a)}},setCheckboxValue:function(t,e){var n=t.indexOf("*"),i=-1==n?t.split("."):t.substr(n+1,t.length).split("."),s=this.module.json.id,a=$$("input[name='"+s+t+"']"),o=[];a.each((function(t){t.get("checked")&&o.push(t.value)}));var r=this.data;i.each(function(t){r=r[t]}.bind(this));var h=r;this.changeJsonDate(i,o),this.changeData(t,e,h)},setSelectValue:function(t,e){var n=e.selectedIndex,i=e.getElements("option"),s="";i[n]&&(s=i[n].get("value"));var a=this.data[t],o=t.split(".");this.changeJsonDate(o,s),this.changeData(t,e,a)},setValue:function(t,e,n){for(var i=t.split("."),s=this.data,a=0;a<i.length;a++){if(!s[i[a]]){s=null;break}s=s[i[a]]}this.changeJsonDate(i,e),this.changeData(t,n,s)},setEditNodeStyles:function(t){var e=t.getChildren();e.length&&e.each(function(t){var e=t.get("class");e&&this.view.css[e]&&t.setStyles(this.view.css[e]),this.setEditNodeStyles(t)}.bind(this))},loadPersonInput:function(){var t=this.propertyContent.getElements(".MWFPersonIdentity"),e=this.propertyContent.getElements(".MWFPersonUnit"),n=this.propertyContent.getElements(".MWFDutySelector"),i=this.propertyContent.getElements(".MWFPersonDuty"),s=this.propertyContent.getElements(".MWFViewSelect"),a=this.propertyContent.getElements(".MWFCMSViewSelect"),o=this.propertyContent.getElements(".MWFQueryViewSelect"),r=this.propertyContent.getElements(".MWFQueryStatSelect");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"identity",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),e.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"unit",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),n.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"duty",names:this.data[t.get("name")],onChange:function(e){this.addDutyItem(t,e)}.bind(this),onRemoveDuty:function(e){this.removeDutyItem(t,e)}.bind(this)})}.bind(this)),i.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"dutyName",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),s.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"View",count:1,names:[this.data[t.get("name")]],onChange:function(e){this.saveViewItem(t,e)}.bind(this)})}.bind(this)),a.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"CMSView",count:1,names:[this.data[t.get("name")]],onChange:function(e){this.saveViewItem(t,e)}.bind(this)})}.bind(this)),o.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"QueryView",count:1,names:[this.data[t.get("name")]],onChange:function(e){this.saveViewItem(t,e)}.bind(this)})}.bind(this)),r.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"QueryStat",count:1,names:[this.data[t.get("name")]],onChange:function(e){this.saveViewItem(t,e)}.bind(this)})}.bind(this))}.bind(this))},saveViewItem:function(t,e){var n=this.data[t.get("name")];if(e[0]){var i=e[0].data;i.name,i.alias,i.id,i.appName||i.applicationName,i.appId,i.application;this.data[t.get("name")]=i.id}else this.data[t.get("name")]=null;this.changeData(t.get("name"),t,n)},removeViewItem:function(t,e){},savePersonItem:function(t,e){var n=[];e.each(function(t){n.push(t.data.distinguishedName||t.data.id||t.data.name)}.bind(this));var i=t.get("name");key=i.split(".");var s=this.data,a=key.length-1;key.each(function(t,e){s[t]||(s[t]={}),e<a&&(s=s[t])}.bind(this)),s[key[a]]=n},loadPersonSelectInput:function(){var t=this.propertyContent.getElements(".MWFSelectApplication"),e=this.propertyContent.getElements(".MWFSelectProcess"),n=this.propertyContent.getElements(".MWFSelectPerson"),i=this.propertyContent.getElements(".MWFSelectIdentity"),s=this.propertyContent.getElements(".MWFSelectUnit");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"application",names:this.data.data.restrictWhereEntry?this.data.data.restrictWhereEntry.applicationList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),e.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"process",names:this.data.data.restrictWhereEntry?this.data.data.restrictWhereEntry.processList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),s.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"unit",names:this.data.data.restrictWhereEntry?this.data.data.restrictWhereEntry.unitList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),n.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"person",names:this.data.data.restrictWhereEntry?this.data.data.restrictWhereEntry.personList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),i.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"identity",names:this.data.data.restrictWhereEntry?this.data.data.restrictWhereEntry.identityList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this))}.bind(this))},savePersonSelectItem:function(t,e){var n=[];e.each(function(t){n.push({name:t.data.name,id:t.data.id})}.bind(this));var i=t.get("name");key=i.split(".");var s=this.data,a=key.length-1;key.each(function(t,e){s[t]||(s[t]={}),e<a&&(s=s[t])}.bind(this)),s[key[a]]=n},loadArrayList:function(){this.propertyContent.getElements(".MWFArraylist").each(function(t){for(var e=t.get("title"),n=t.get("name"),i=n.split("."),s=this.data,a=0;a<i.length;a++){if(!s[i[a]]){s=null;break}s=s[i[a]]}s||(s=[]),MWF.require("MWF.widget.Arraylist",function(){var i=new MWF.widget.Arraylist(t,{title:e,onChange:function(){this.setValue(n,i.toArray(),t)}.bind(this)});i.load(s)}.bind(this)),t.addEvent("keydown",(function(t){t.stopPropagation()}))}.bind(this))},loadStatColumnSelect:function(){var t=this.propertyContent.getElements(".MWFStatSelectColumn");t.length&&t.each(function(t){var e=t.get("name"),n=this.data[e];t.empty(),new Element("option",{value:"",selected:!0,text:this.module.designer.lp.category}).inject(t),this.module.items.each(function(e){new Element("option",{value:e.json.id,selected:n===e.json.id,text:e.json.displayName}).inject(t)}.bind(this))}.bind(this))},loadViewSelect:function(){var t=this.propertyContent.getElements(".MWFViewSelect");t.length&&this.getViewList(function(){t.each(function(t){var e=new Element("select").inject(t);e.addEvent("change",function(t){var e=t.target.options[t.target.selectedIndex].value,n=t.target.options[t.target.selectedIndex].get("text");this.setValue(t.target.getParent("div").get("name"),e),this.setValue(t.target.getParent("div").get("name")+"Name",n)}.bind(this)),this.setViewSelectOptions(t,e),new Element("div",{styles:this.view.css.propertyRefreshFormNode}).inject(t).addEvent("click",function(n){this.getViewList(function(){this.setViewSelectOptions(t,e)}.bind(this),!0)}.bind(this))}.bind(this))}.bind(this))},setViewSelectOptions:function(t,e){var n=t.get("name");e.empty();new Element("option",{text:"(none)"}).inject(e);this.views.each(function(t){new Element("option",{text:t.name,value:t.id,selected:this.data[n]==t.id}).inject(e)}.bind(this))},getViewList:function(t,e){!this.views||e?this.view.designer.actions.listView(this.view.designer.application.id,function(e){this.views=e.data,t&&t()}.bind(this)):t&&t()},loadScriptArea:function(){var t=this.propertyContent.getElements(".MWFScriptArea"),e=this.propertyContent.getElements(".MWFFormulaArea");this.loadScriptEditor(t),this.loadScriptEditor(e,"formula")},loadScriptEditor:function(t,e){t.each(function(t){var n=t.get("title"),i=t.get("name"),s=this.data[i];MWF.require("MWF.widget.ScriptArea",function(){var a=new MWF.widget.ScriptArea(t,{title:n,maxObj:this.designer.editContentNode,onChange:function(){this.data[i]=a.toJson().code}.bind(this),onSave:function(){this.designer.saveView()}.bind(this),style:e||"default"});a.load({code:s})}.bind(this))}.bind(this))}});