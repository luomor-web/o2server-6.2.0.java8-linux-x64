MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Component",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Module.Table$Td",null,!1),MWF.xApplication.process.FormDesigner.Module.Table=MWF.FCTable=new Class({Extends:MWF.FC$Component,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/Table/table.html",propertyMultiPath:"../x_component_process_FormDesigner/Module/Table$Td/table$tdMulti.html",multiActions:[{name:"mergerCell",icon:"mergerCell.png",event:"click",action:"mergerCell",title:MWF.APPFD.LP.formAction.mergerCell}]},initialize:function(e,t){this.setOptions(t),this.path="../x_component_process_FormDesigner/Module/Table/",this.cssPath="../x_component_process_FormDesigner/Module/Table/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="component",this.moduleName="table",this.form=e,this.container=null,this.containerNode=null,this.containers=[],this.elements=[],this.selectedMultiTds=[]},clearTemplateStyles:function(e){e&&(e.styles&&this.removeStyles(e.styles,"styles"),e.properties&&this.removeStyles(e.properties,"properties"),e.titleStyles&&this.removeStyles(e.titleStyles,"titleTdStyles"),e.contentStyles&&this.removeStyles(e.contentStyles,"contentTdStyles"),e.layoutStyles&&this.removeStyles(e.layoutStyles,"layoutTdStyles"))},setTemplateStyles:function(e){e.styles&&this.copyStyles(e.styles,"styles"),e.properties&&this.copyStyles(e.properties,"properties"),e.titleStyles&&this.copyStyles(e.titleStyles,"titleTdStyles"),e.contentStyles&&this.copyStyles(e.contentStyles,"contentTdStyles"),e.layoutStyles&&this.copyStyles(e.layoutStyles,"layoutTdStyles")},_createMoveNode:function(){this.moveNode=new Element("div",{html:'<table border="0" cellpadding="0" cellspacing="2" width="100%" align="center"><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr></table>'}).inject(this.form.container),this.moveNode.setStyles(this.css.moduleNodeMove),this._setTableStyle()},_setTableStyle:function(){this.moveNode.getElements("td").setStyles({border:"1px dashed #999",height:"20px"}),this.moveNode.getElements("th").setStyles({border:"1px dashed #999",height:"20px"})},_getTds:function(e){tds=[];for(var t=(e||this.node).getElement("table").rows,s=0;s<t.length;s++)for(var o=t[s],i=0;i<o.cells.length;i++)tds.push(o.cells[i]);return tds},_checkSelectedTds:function(e,t){this.selectedMultiTds=[];for(var s=this._getTds(),o=e.x,i=e.y,n=t.x,l=t.y;;){var r=e.x,d=e.y,a=t.x,h=t.y;if(s.each(function(e){if(e.isInPointInRect(o,i,n,l)){var t=e.getPosition(),s=e.getSize();(!r||t.x<r)&&(r=t.x),(!d||t.y<d)&&(d=t.y),(!a||t.x+s.x>a)&&(a=t.x+s.x),(!h||t.y+s.y>h)&&(h=t.y+s.y)}}.bind(this)),o==r&&i==d&&n==a&&l==h)break;o=r,i=d,n=a,l=h}s.each(function(e){var t=e.retrieve("module");e.isInPointInRect(o,i,n,l)?t.selectedMulti():t.unSelectedMulti()}.bind(this))},_setOtherNodeEvent:function(){this.dragInfor={},this.tdDragSelect=new Drag(this.node,{stopPropagation:!0,preventDefault:!0,onStart:function(e,t){this.form._beginSelectMulti();var s=t.event.target.getPosition();this.dragInfor.start={x:t.event.offsetX+s.x,y:t.event.offsetY+s.y}}.bind(this),onDrag:function(e,t){var s=t.event.target.getPosition(),o={x:t.event.offsetX+s.x,y:t.event.offsetY+s.y};this._checkSelectedTds(this.dragInfor.start,o),t.stopPropagation()}.bind(this),onComplete:function(e,t){var s=t.event.target.getPosition(),o={x:t.event.offsetX+s.x,y:t.event.offsetY+s.y};this._checkSelectedTds(this.dragInfor.start,o),this.form._completeSelectMulti(),this._createMultiSelectedActions(),this.showMultiProperty(),t.stopPropagation(),t.preventDefault()}.bind(this)})},showMultiProperty:function(){this.form.propertyMultiTd&&(this.form.propertyMultiTd.hide(),this.form.propertyMultiTd=null),this.form.propertyMultiTd=new MWF.xApplication.process.FormDesigner.PropertyMulti(this.form,this.form.selectedModules,this.form.designer.propertyContentArea,this.form.designer,{path:this.options.propertyMultiPath,onPostLoad:function(){this.show()}}),this.form.propertyMultiTd.load()},_createMultiSelectedActions:function(){this.form.selectedModules.length>1?this.form.multimoduleActionsArea&&(this.form.multimoduleActionsArea.empty(),this.options.multiActions.each(function(e){var t=new Element("div",{styles:this.options.actionNodeStyles,title:e.title}).inject(this.form.multimoduleActionsArea);t.setStyle("background","url("+this.path+this.options.style+"/icon/"+e.icon+") no-repeat left center"),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this))}.bind(this)),this.form.multimoduleActionsArea.setStyle("width",18*this.options.multiActions.length)):this.form.multimoduleActionsArea.setStyle("display","none")},mergerCell:function(){if(this.form.selectedModules.length>1){for(var e=this.form._getFirstMultiSelectedModule().module,t=e.node,s=0;t&&-1!=this.form.selectedModules.indexOf(t.retrieve("module"));){s+=t.get("colspan").toInt()||1,t=t.getNext("td")}var o=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;this.form.selectedModules.each(function(e,t){var s=e.node.getParent("tr").rowIndex+(e.node.get("rowspan").toInt()||1)-1;o=Math.max(o,s),i=Math.min(i,s)}.bind(this));var n=o-i+1;for(s>1?(e.node.set("colspan",s),e.json.properties.colspan=s):(e.node.set("colspan",1),delete e.node.colspan,delete e.json.properties.colspan),n>1?(e.node.set("rowspan",n),e.json.properties.rowspan=n):(e.node.set("rowspan",1),delete e.node.rowspan,delete e.json.properties.rowspan);this.form.selectedModules.length;){var l=this.form.selectedModules[0];if(this.form.selectedModules.erase(l),l!==e)l._getSubModule().each((function(t){t._moveTo(e)})),this.containers.erase(l),l.destroy()}e.selected()}},_getContainers:function(){var e=this._getTds();this.form.getTemplateData("Table$Td",function(t){e.each(function(e){var s=this.form.getDomjson(e),o=null;if(s){i=Object.clone(t);Object.merge(i,s),Object.merge(s,i),(o=new MWF.FCTable$Td(this.form)).table=this,o.load(s,e,this)}else{var i=Object.clone(t);(o=new MWF.FCTable$Td(this.form)).table=this,o.load(i,e,this)}this.containers.push(o)}.bind(this))}.bind(this))},_getElements:function(){this.node.getElements("caption").each(function(e){var t=this.form.getDomjson(e),s=null;t?((s=new MWF.FCCommon(this.form)).table=this,s.load(t,e,this)):this.form.getTemplateData("Common",function(t){var o=Object.clone(t);(s=new MWF.FCCommon(this.form)).table=this,s.load(o,e,this)}.bind(this)),this.elements.push(s)}.bind(this))},_createNode:function(e){var t=this,s=this.path+"tableCreate.html";MWF.require("MWF.widget.Dialog",function(){var o=$(document.body).getSize(),i=o.x/2-180,n=o.y/2-130;new MWF.DL({title:"Create Table",style:"property",top:n,left:i-40,fromTop:o.y/2-65,fromLeft:o.x/2,width:360,height:260,url:s,lp:MWF.xApplication.process.FormDesigner.LP.propertyTemplate,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){t._createTableNode(),e(),this.close()}}]}).show()}.bind(this))},_createTableNode:function(){var e=$("MWFNewTableLine").get("value"),t=$("MWFNewTableColumn").get("value"),s=$("MWFNewTableWidth").get("value"),o=$("MWFNewTableWidthUnit"),i=o.options[o.selectedIndex].value,n=$("MWFNewTableBorder").get("value"),l=$("MWFNewTableCellpadding").get("value"),r=$("MWFNewTableCellspacing").get("value"),d="";d="percent"==i?s+"%":s+"px",this.json.properties.width=d,this.json.properties.border=n,this.json.properties.cellpadding=l,this.json.properties.cellspacing=r;for(var a='<table border="'+n+'" cellpadding="'+l+'" cellspacing="'+r+'" width="'+d+'" align="center">',h=0;h<e.toInt();h++){a+="<tr>";for(var c=0;c<t.toInt();c++)a+="<td></td>";a+="</tr>"}a+="</table>",this.node=this.node=new Element("div",{id:this.json.id,MWFType:"table",html:a,styles:this.css.moduleNode,events:{selectstart:function(e){e.preventDefault()}}}).inject(this.form.node)},_dragComplete:function(){this.node?this._dragMoveComplete():this._createNode(function(){this._dragMoveComplete()}.bind(this))},_dragMoveComplete:function(){this._resetTreeNode(),this.node.inject(this.copyNode,"before"),this._initModule();var e=this.node.retrieve("thisDisplay");e&&this.node.setStyle("display",e),this.copyNode&&this.copyNode.destroy(),this.moveNode&&this.moveNode.destroy(),this.moveNode=null,this.copyNode=null,this.nextModule=null,this.form.moveModule=null,this.form.json.moduleList[this.json.id]=this.json,this.selected()},setPropertiesOrStyles:function(e){if("styles"==e)try{this.setCustomStyles()}catch(e){}"properties"==e&&(this.node.getFirst().setProperties(this.json.properties),"0"===this.json.properties.cellspacing&&this.node.getFirst().setProperties({cellspacing:"1"}))},_setEditStyle_custom:function(e,t,s){if("id"==e&&e!=s){var o=new RegExp("^"+s,"i");this.containers.each(function(e){var t=e.json.id,s=t.replace(o,this.json.id);e.json.id=s,delete this.form.json.moduleList[t],this.form.json.moduleList[s]=e.json,e._setEditStyle("id")}.bind(this))}"titleTdStyles"==e&&this.setTabStyles(),"contentTdStyles"==e&&this.setTabStyles(),"layoutTdStyles"==e&&this.setTabStyles()},setTabStyles:function(){this.containers.each(function(e){e.setCustomStyles()}.bind(this))},setAllStyles:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("properties"),this.setTabStyles(),this.reloadMaplist()},copyComponentJsonData:function(e,t){this._getTds(e).each(function(e,s){var o=Object.clone(this.containers[s].json);o.id=this.containers[s]._getNewId(t),this.form.json.moduleList[o.id]=o,e.set("id",o.id)}.bind(this))},getContainerNodes:function(){return this._getTds()},_preprocessingModuleData:function(){this.node.clearStyles(),this.json.recoveryStyles=Object.clone(this.json.styles),this.json.recoveryStyles&&Object.each(this.json.recoveryStyles,function(e,t){if(-1!=e.indexOf("x_processplatform_assemble_surface")||-1!=e.indexOf("x_portal_assemble_surface"));else{t.test(/^border\w*/gi)||t&&(this.node.setStyle(t,e),delete this.json.styles[t])}}.bind(this)),this.json.styles&&this.json.styles.border&&(this.table||(this.table=this.node.getElement("table")),this.json.styles["table-layout"]&&this.table.setStyle("table-layout",this.json.styles["table-layout"]),this.table.setStyle("border-collapse","collapse")),this.json.preprocessing="y"},_recoveryModuleData:function(){this.json.recoveryStyles&&(this.json.styles=this.json.recoveryStyles),this.json.recoveryStyles=null,this.table||(this.table=this.node.getElement("table")),this.table.setStyle("border-collapse","separate")}});