MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Container",null,!1),MWF.xApplication.process.FormDesigner.Module.Table$Td=MWF.FCTable$Td=new Class({Extends:MWF.FC$Container,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/Table$Td/table$td.html",actions:[{name:"insertRow",icon:"insertRow1.png",event:"click",action:"insertRow",title:MWF.APPFD.LP.formAction.insertRow},{name:"insertCol",icon:"insertCol1.png",event:"click",action:"insertCol",title:MWF.APPFD.LP.formAction.insertCol},{name:"deleteRow",icon:"deleteRow1.png",event:"click",action:"deleteRow",title:MWF.APPFD.LP.formAction.deleteRow},{name:"deleteCol",icon:"deleteCol1.png",event:"click",action:"deleteCol",title:MWF.APPFD.LP.formAction.deleteCol},{name:"splitCell",icon:"splitCell.png",event:"click",action:"splitCell",title:MWF.APPFD.LP.formAction.splitCell}],injectActions:[{name:"top",styles:"injectActionTop",event:"click",action:"injectTop",title:MWF.APPFD.LP.formAction.insertTop},{name:"bottom",styles:"injectActionBottom",event:"click",action:"injectBottom",title:MWF.APPFD.LP.formAction.insertBottom}]},initialize:function(e,t){this.setOptions(t),this.path="../x_component_process_FormDesigner/Module/Table$Td/",this.cssPath="../x_component_process_FormDesigner/Module/Table$Td/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="container",this.moduleName="table$Td",this.Node=null,this.form=e},setAllStyles:function(){Object.each(this.json.styles,function(e,t){t.test(/^border\w*/gi)||t&&this.node.setStyle(t,e)}.bind(this)),this.setPropertiesOrStyles("properties"),this.reloadMaplist()},over:function(){-1==this.form.selectedModules.indexOf(this)&&(this.form.moveModule||this.form.currentSelectedModule!=this&&this.node.setStyles({"border-width":"1px","border-color":"#0072ff"}))},unOver:function(){-1==this.form.selectedModules.indexOf(this)&&(this.form.moveModule||this.form.currentSelectedModule!=this&&this.node.setStyles({"border-width":"1px","border-color":"#999"}))},unSelected:function(){this.node.setStyles({"border-width":"1px","border-color":"#999"}),this._hideActions(),this.form.currentSelectedModule=null,this.hideProperty()},_showActions:function(){if(this.actionArea){this._setActionAreaPosition(),this.actionArea.setStyle("display","block");var e=this.node.get("colspan").toInt()||1,t=this.node.get("rowspan").toInt()||1;e<=1&&t<=1?this.actionArea.getLast("div").setStyle("display","none"):this.actionArea.getLast("div").setStyle("display","block")}},unSelectedMulti:function(){-1!=this.form.selectedModules.indexOf(this)&&(this.form.selectedModules.erase(this),this.node.setStyle("border-color","#999"))},load:function(e,t,s){if(this.json=e,this.node=t,this.node.store("module",this),this.node.setStyles(this.css.moduleNode),!this.json.id){var o=this._getNewId(s.json.id);this.json.id=o}t.set({MWFType:"table$Td",id:this.json.id}),this.form.json.moduleList[this.json.id]||(this.form.json.moduleList[this.json.id]=this.json),this._initModule(),this._loadTreeNode(s),this.form.parseModules(this,this.node),this.parentContainer=this.treeNode.parentNode.module,this._setEditStyle_custom("id"),this.json.moduleName=this.moduleName},_createMoveNode:function(){return!1},_setEditStyle_custom:function(e){"cellType"==e&&this.setCustomStyles()},_preprocessingSetNodeStyles:function(e){Object.each(e,function(e,t){-1==e.indexOf("x_processplatform_assemble_surface")&&-1==e.indexOf("x_portal_assemble_surface")&&this.node.setStyle(t,e)}.bind(this))},_preprocessingModuleData:function(){this.node.clearStyles();var e={};"title"===this.json.cellType&&(e=this.table.json.titleTdStyles),"content"===this.json.cellType&&(e=this.table.json.contentTdStyles),"layout"===this.json.cellType&&(e=this.table.json.layoutTdStyles),this._preprocessingSetNodeStyles(e),this.json.styles&&(this.json.recoveryStyles=Object.clone(this.json.styles),this.json.recoveryStyles&&Object.each(this.json.recoveryStyles,function(e,t){-1==e.indexOf("x_processplatform_assemble_surface")&&-1==e.indexOf("x_portal_assemble_surface")&&(this.node.setStyle(t,e),delete this.json.styles[t])}.bind(this))),this.table&&(this.json.styles&&this.json.styles.border||!this.table.json.styles||!this.table.json.styles.border||this.node.setStyle("border",this.table.json.styles.border)),this.json.preprocessing="y"},_recoveryModuleData:function(){this.json.recoveryStyles&&(this.json.styles=this.json.recoveryStyles),this.json.recoveryStyles=null,this.table&&(this.json.styles&&this.json.styles.border||!this.table.json.styles||!this.table.json.styles.border||this.node.setStyle("border",""))},setCustomStyles:function(){this._recoveryModuleData();var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles(this.css.moduleNode);var t={};"title"==this.json.cellType&&(t=this.table.json.titleTdStyles),"content"==this.json.cellType&&(t=this.table.json.contentTdStyles),"layout"==this.json.cellType&&(t=this.table.json.layoutTdStyles),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",e),Object.each(t,function(e,t){if(-1!==e.indexOf("x_processplatform_assemble_surface")||-1!==e.indexOf("x_portal_assemble_surface")){var s=MWF.Actions.getHost("x_processplatform_assemble_surface"),o=MWF.Actions.getHost("x_portal_assemble_surface");-1!==e.indexOf("/x_processplatform_assemble_surface")?e=e.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==e.indexOf("x_processplatform_assemble_surface")&&(e=e.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==e.indexOf("/x_portal_assemble_surface")?e=e.replace("/x_portal_assemble_surface",o+"/x_portal_assemble_surface"):-1!==e.indexOf("x_portal_assemble_surface")&&(e=e.replace("x_portal_assemble_surface",o+"/x_portal_assemble_surface")),e=o2.filterUrl(e)}t.test(/^border\w*/gi)||t&&("display"===t.toString().toLowerCase()?"none"===e.toString().toLowerCase()?this.node.setStyle("opacity",.3):(this.node.setStyle("opacity",1),this.node.setStyle(t,e)):this.node.setStyle(t,e))}.bind(this)),Object.each(this.json.styles,function(e,t){if(-1!==e.indexOf("x_processplatform_assemble_surface")||-1!==e.indexOf("x_portal_assemble_surface")){var s=MWF.Actions.getHost("x_processplatform_assemble_surface"),o=MWF.Actions.getHost("x_portal_assemble_surface");-1!==e.indexOf("/x_processplatform_assemble_surface")?e=e.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==e.indexOf("x_processplatform_assemble_surface")&&(e=e.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==e.indexOf("/x_portal_assemble_surface")?e=e.replace("/x_portal_assemble_surface",o+"/x_portal_assemble_surface"):-1!==e.indexOf("x_portal_assemble_surface")&&(e=e.replace("x_portal_assemble_surface",o+"/x_portal_assemble_surface")),e=o2.filterUrl(e)}t.test(/^border\w*/gi)||t&&("display"===t.toString().toLowerCase()?"none"===e.toString().toLowerCase()?this.node.setStyle("opacity",.3):(this.node.setStyle("opacity",1),this.node.setStyle(t,e)):this.node.setStyle(t,e))}.bind(this))},_dragInLikeElement:function(e){return!1},insertRow:function(){var e=this,t=this.path+"insertRow.html";MWF.require("MWF.widget.Dialog",function(){var s=$(document.body).getSize(),o=s.x/2-150,n=s.y/2-90;new MWF.DL({title:"Insert Row",style:"property",top:n,left:o-40,fromTop:s.y/2-45,fromLeft:s.x/2,width:300,height:180,url:t,lp:MWF.xApplication.process.FormDesigner.LP.propertyTemplate,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){e._insertRow(),this.close()}},{text:MWF.APPFD.LP.button.cancel,action:function(){this.close()}}]}).show()}.bind(this))},_insertRow:function(){for(var e=$("MWFInsertRowNumber").get("value"),t=document.getElementsByName("MWFInsertRowPosition"),s="before",o=0;o<t.length;o++)if(t[o].checked){s=t[o].value;break}var n=this.node.getParent("tr"),r=n.getParent("table"),i=n.cells.length,l=n.rowIndex,a=r.getElements("td:rowspanBefore("+l+")");(n.getElements("td:colspan").each((function(e){var t=e.get("colspan").toInt()||1;i=i+t-1})),a.each(function(t){this.__rowspanPlus(t,e)}.bind(this)),"after"==s)&&n.getElements("td:rowspan").each(function(t){this.__rowspanPlus(t,e);var s=t.get("colspan").toInt()||1;i-=s}.bind(this));for(var c=1;c<=e;c++)for(var d=new Element("tr").inject(n,s),p=1;p<=i;p++){var h=new Element("td").inject(d);this.form.getTemplateData("Table$Td",function(e){var t=Object.clone(e),s=new MWF.FCTable$Td(this.form);s.table=this.table,s.load(t,h,this.parentContainer),this.parentContainer.containers.push(s)}.bind(this))}this.unSelected(),this.selected()},insertCol:function(){var e=this,t=this.path+"insertCol.html";MWF.require("MWF.widget.Dialog",function(){var s=$(document.body).getSize(),o=s.x/2-150,n=s.y/2-90;new MWF.DL({title:"Insert Col",style:"property",top:n,left:o-40,fromTop:s.y/2-45,fromLeft:s.x/2,width:300,height:180,url:t,lp:MWF.xApplication.process.FormDesigner.LP.propertyTemplate,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){e._insertCol(),this.close()}},{text:MWF.APPFD.LP.button.cancel,action:function(){this.close()}}]}).show()}.bind(this))},_insertCol:function(){for(var e=$("MWFInsertColNumber").get("value"),t=document.getElementsByName("MWFInsertColPosition"),s="before",o=0;o<t.length;o++)if(t[o].checked){s=t[o].value;break}for(var n=this.node.getParent("tr").getParent("table"),r=this.__getCellIndex(this.node),i=1;i<=e;i++){this.__getInsertTableColTds(n,r).each(function(e){e.td.inject(e.toTd,s),this.form.getTemplateData("Table$Td",function(t){var s=Object.clone(t),o=new MWF.FCTable$Td(this.form);o.table=this.table,o.load(s,e.td,this.parentContainer),this.parentContainer.containers.push(o)}.bind(this))}.bind(this))}this.unSelected(),this.selected()},deleteRow:function(e){var t=this;this.form.designer.confirm("warn",e,MWF.APPFD.LP.notice.deleteRowTitle,MWF.APPFD.LP.notice.deleteRow,300,120,(function(){t._deleteRow(),this.close()}),(function(){this.close()}),null)},__rowspanPlus:function(e,t){var s=e.get("rowspan").toInt()||1;s+=t.toInt();var o=e.retrieve("module");s>1?(e.set("rowspan",s),o&&(o.json.properties.rowspan=s)):(e.set("rowspan",1),delete e.rowspan,o&&delete o.json.properties.rowspan)},__rowspanMinus:function(e){var t=e.get("rowspan").toInt()||1;t-=1;var s=e.retrieve("module");t>1?(e.set("rowspan",t),s&&(s.json.properties.rowspan=t)):(e.set("rowspan",1),delete e.rowspan,s&&delete s.json.properties.rowspan)},__colspanPlus:function(e,t){var s=e.get("colspan").toInt()||1;s+=t.toInt();var o=e.retrieve("module");s>1?(e.set("colspan",s),o&&(o.json.properties.colspan=s)):(e.set("colspan",1),delete e.colspan,o&&delete o.json.properties.colspan)},__colspanMinus:function(e){var t=e.get("colspan").toInt()||1;t-=1;var s=e.retrieve("module");t>1?(e.set("colspan",t),s&&(s.json.properties.colspan=t)):(e.set("colspan",1),delete e.colspan,s&&delete s.json.properties.colspan)},__getNextTd:function(e,t){for(var s=null;t>0;){t=--t-((s=s?s.getNext("td"):e.getFirst("td")).get("colspan").toInt()||1)-1}return s},__getCellIndex:function(e){for(var t=-1,s=e.getParent("tr").getParent("table").rows,o={},n=!1,r=0;r<s.length;r++){for(var i=null,l=0;;){if(a=o["rowspan_"+l])a.rows=a.rows-1,a.rows||delete o["rowspan_"+l],l++;else{if(!(i=i?i.getNext("td"):s[r].getFirst("td")))break;if(i==e){t=l,n=!0;break}var a=i.get("rowspan").toInt()||1,c=i.get("colspan").toInt()||1;if(a>1)for(var d=a-1,p=0;p<c;p++){o["rowspan_"+(l+p)]={rows:d}}l=l+c-1,l++}}if(n)break}return t},__getInsertTableColTds:function(e,t){for(var s=[],o=e.rows,n={},r=0;r<o.length;r++)for(var i=null,l=0;;){if(a=n["rowspan_"+l])a.rows=a.rows-1,a.rows||delete n["rowspan_"+l],l++;else{if(!(i=i?i.getNext("td"):o[r].getFirst("td")))break;var a=i.get("rowspan").toInt()||1,c=i.get("colspan").toInt()||1;if(a>1)for(var d=a-1,p=0;p<c;p++){n["rowspan_"+(l+p)]={rows:d}}if(c>1){if(l+c-1>=t&&l<=t){this.__colspanPlus(i,1);break}}else if(l==t){var h=new Element("td");s.push({td:h,toTd:i});break}l=l+c-1,l++}}return s},__getDeleteTableColTds:function(e,t){for(var s=[],o=e.rows,n={},r=0;r<o.length;r++)for(var i=null,l=0;;){if(a=n["rowspan_"+l])a.rows=a.rows-1,a.rows||delete n["rowspan_"+l],l++;else{if(!(i=i?i.getNext("td"):o[r].getFirst("td")))break;var a=i.get("rowspan").toInt()||1,c=i.get("colspan").toInt()||1;if(a>1)for(var d=a-1,p=0;p<c;p++){n["rowspan_"+(l+p)]={rows:d}}if(c>1){if(l+c-1>=t&&l<=t){this.__colspanMinus(i);break}}else if(l==t){s.push(i);break}l=l+c-1,l++}}return s},_deleteRow:function(){var e=this.form,t=this.node.getParent("tr"),s=t.getParent("table"),o=t.rowIndex,n=s.getElements("td:rowspanBefore("+o+")"),r=t.getElements("td:rowspan");n.each(function(e){this.__rowspanMinus(e)}.bind(this)),r.each(function(e){this.__rowspanMinus(e);var t=s.rows[o+1];if(t){var n=e.cellIndex,r=null;(r=n>0?this.__getNextTd(t,n):this.__getNextTd(t,2))&&e.inject(r,"after")}}.bind(this)),s.rows.length<=1?this.parentContainer.destroy():(tds=t.getElements("td"),tds.each((function(e){var t=e.retrieve("module");t&&(t.parentContainer.containers.erase(t),t.destroy())})),t.destroy()),e.currentSelectedModule=null,e.selected(),e=null},deleteCol:function(e){var t=this;this.form.designer.confirm("warn",e,MWF.APPFD.LP.notice.deleteColTitle,MWF.APPFD.LP.notice.deleteCol,300,120,(function(){t._deleteCol(),this.close()}),(function(){this.close()}),null)},_deleteCol:function(){var e=this.form,t=this.node.getParent("tr"),s=t.getParent("table"),o=this.__getCellIndex(this.node),n=this.node.get("colspan").toInt()||1;t.cells.length<=1&&n<=1?this.parentContainer.destroy():this.__getDeleteTableColTds(s,o).each((function(e){var t=e.retrieve("module");t&&(t.parentContainer.containers.erase(t),t.destroy())}));e.currentSelectedModule=null,e.selected(),e=null},__getTdsByIndex:function(e,t,s,o){for(var n=[],r=e.rows,i={},l=0;l<r.length;l++)for(var a=null,c=0,d=!1;;){if(p=i["rowspan_"+c])p.rows=p.rows-1,p.rows||delete i["rowspan_"+c],c++;else{if(!(a=a?a.getNext("td"):r[l].getFirst("td"))){l>=t&&l<=t+s&&(d||n.push(null));break}var p=a.get("rowspan").toInt()||1,h=a.get("colspan").toInt()||1;if(p>1){s=p-1;for(var f=0;f<h;f++){i["rowspan_"+(c+f)]={rows:s}}}if(c+h-1>=o&&c<=o){l>=t&&l<=t+s&&(n.push(a),d=!0);break}c=c+h-1,c++}}return n},splitCell:function(){var e=this.node.get("colspan").toInt()||1,t=this.node.get("rowspan").toInt()||1,s=(c=this.node.getParent("tr")).getParent("table"),o=c.rowIndex,n=this.__getCellIndex(this.node);this.node.set("rowspan",1),delete this.node.rowspan,delete this.json.properties.rowspan,this.node.set("colspan",1),delete this.node.colspan,delete this.json.properties.colspan,this.form.currentSelectedModule&&this.form.currentSelectedModule.unSelected(),this.unSelectedMulti(),this.selectedMulti();for(var r=this.__getTdsByIndex(s,o+1,t-1,n-1),i=1;i<=t;i++)if(1==i)for(var l=2;l<=e;l++){var a=new Element("td").inject(this.node,"after");this.form.getTemplateData("Table$Td",function(e){var t=Object.clone(e),s=new MWF.FCTable$Td(this.form);s.table=this.table,s.load(t,a,this.parentContainer),this.parentContainer.containers.push(s),s.selectedMulti()}.bind(this))}else{var c=c.getNext("tr"),d=r[i-2];for(l=1;l<=e;l++){a=new Element("td");d?a.inject(d,"after"):a.inject(c,"top"),this.form.getTemplateData("Table$Td",function(e){var t=Object.clone(e),s=new MWF.FCTable$Td(this.form);s.table=this.table,s.load(t,a,this.parentContainer),this.parentContainer.containers.push(s),s.selectedMulti()}.bind(this))}}this.form._completeSelectMulti()}});