MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Element",null,!1),MWF.xApplication.process.FormDesigner.Module.Subform=MWF.FCSubform=new Class({Extends:MWF.FC$Element,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/Subform/subform.html",actions:[{name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPFD.LP.formAction.move},{name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPFD.LP.formAction.delete}]},initialize:function(e,t){this.setOptions(t),this.path="../x_component_process_FormDesigner/Module/Subform/",this.cssPath="../x_component_process_FormDesigner/Module/Subform/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="element",this.moduleName="subform",this.form=e,this.container=null,this.containerNode=null},load:function(e,t,o){this.json=e,this.node=t,this.node.store("module",this),this.node.setStyles(this.css.moduleNode),this._initModule(),this.json.subformSelected&&"none"!==this.json.subformSelected&&"script"!==this.json.subformType?this.redoSelectedSubform(this.json.subformSelected,null,""):(this.node.empty(),this.loadIcon()),this._loadTreeNode(o),this.setCustomStyles(),this.parentContainer=this.treeNode.parentNode.module,this._setEditStyle_custom("id"),this.parseModules(),this.json.moduleName=this.moduleName,this.node.addEvent("click",function(){this.refreshSubform()}.bind(this)),this.node.addEvent("dblclick",function(e){this.openSubform(e)}.bind(this))},_initModule:function(){this.json.isSaved||this.setStyleTemplate(),this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("inputStyles"),this.setPropertiesOrStyles("properties"),this._setNodeProperty(),this.form.isSubform||this._createIconAction(),this._setNodeEvent(),this.json.isSaved=!0,this.form.subformModuleList||(this.form.subformModuleList=[]),this.form.subformModuleList.push(this),this.queryGetFormDataFun=this.queryGetFormData.bind(this),this.postGetFormDataFun=this.postGetFormData.bind(this),this.form.addEvent("queryGetFormData",this.queryGetFormDataFun),this.form.addEvent("postGetFormData",this.postGetFormDataFun)},openSubform:function(e){this.json.subformSelected&&"none"!==this.json.subformSelected&&"script"!==this.json.subformType&&layout.desktop.openApplication(e,"process.FormDesigner",{id:this.json.subformSelected,appId:"FormDesigner"+this.json.subformSelected})},_createMoveNode:function(){this.moveNode=new Element("div",{MWFType:"subform",id:this.json.id,styles:this.css.moduleNodeMove,events:{selectstart:function(){return!1}}}).inject(this.form.container)},_getDroppableNodes:function(){var e=[this.form.node].concat(this.form.moduleElementNodeList,this.form.moduleContainerNodeList,this.form.moduleComponentNodeList);return this.form.moduleList.each(function(t){if("datatemplate"===t.moduleName){var o=this.form.getModuleNodes(t.node);e.erase(t.node),o.each((function(t){e.erase(t)}))}}.bind(this)),e},_createNode:function(){this.node=this.moveNode.clone(!0,!0),this.node.setStyles(this.css.moduleNode),this.node.set("id",this.json.id),this.node.addEvent("selectstart",(function(){return!1})),this.loadIcon(),this.node.addEvent("click",function(){this.refreshSubform()}.bind(this))},postGetFormData:function(e){e&&!e.contains(this.node)||this.show()},queryGetFormData:function(e){e&&!e.contains(this.node)||this.hide()},hide:function(){this.node.empty()},show:function(){this.subformData?(this.subformModule=new MWF.FCSubform.Form(this.form,this.node,{mode:this.form.options.mode,parentformIdList:this.getParentformIdList(),level:this.getLevel()}),this.subformModule.subformSelector=this.getSubformSelector(),this.subformModule.subformSelectedValue=this.getSubformSelectedValue(),this.subformModule.level1Subform=this.getLevel1Subform(),this.subformModule.load(this.subformData)):(this.node.empty(),this.loadIcon())},delete:function(e){var t=this;this.form.designer.shortcut=!1,this.form.designer.confirm("warn",t.node,MWF.APPFD.LP.notice.deleteElementTitle,MWF.APPFD.LP.notice.deleteElement,300,120,(function(){this.queryGetFormDataFun&&t.form.removeEvent("queryGetFormData",this.queryGetFormDataFun),this.postGetFormDataFun&&t.form.removeEvent("postGetFormData",this.postGetFormDataFun),t.destroy(),t.form.selected(),t.form.designer.shortcut=!0,this.close()}),(function(){t.form.designer.shortcut=!0,this.close()}),null)},getLevel:function(){return(this.form.options.level1||0)+1},getLevel1Subform:function(){return this.form.level1Subform||this},getSubformSelector:function(){return this.subformSelector||this.form.subformSelector},getSubformSelectedValue:function(){return this.subformSelectedValue||this.form.subformSelectedValue},checkSubformNested:function(e){return!this.form.options.parentformIdList||!this.form.options.parentformIdList.contains(e)},isSubformUnique:function(e,t){return!this.form.topform||(!this.getLevel1Subform()||!this.getLevel1Subform().json||this.form.topform.isSubformUnique(e,this.getLevel1Subform().json.id,t))},getParentformIdList:function(){var e;return this.form.options.parentformIdList?(e=Array.clone(this.form.options.parentformIdList)).push(this.form.json.id):e=[this.form.json.id],e},refreshSubform:function(){this.json.subformSelected&&"none"!==this.json.subformSelected&&"script"!==this.json.subformType&&MWF.Actions.get("x_processplatform_assemble_designer").getForm(this.json.subformSelected,function(e){if(this.subformData.updateTime!==e.data.updateTime){var t=null;this.property&&(t=$(this.property.data.pid+"selectSubform").getElement("select")),this.clearSubformList(this.json.subformSelected),this.reloadSubform(e.data,t,"")}}.bind(this))},loadIcon:function(){this.iconNode=new Element("div",{styles:this.css.iconNode}).inject(this.node),new Element("div",{styles:this.css.iconNodeIcon}).inject(this.iconNode),new Element("div",{styles:this.css.iconNodeText,text:"Subform"}).inject(this.iconNode)},_loadNodeStyles:function(){this.iconNode=this.node.getElement("div").setStyles(this.css.iconNode),this.iconNode.getFirst("div").setStyles(this.css.iconNodeIcon),this.iconNode.getLast("div").setStyles(this.css.iconNodeText)},_setEditStyle_custom:function(e,t,o){"subformSelected"===e&&this.json.subformSelected!==o&&this.redoSelectedSubform(e,t,o),"subformType"===e&&this.json.subformType!==o&&("script"!==this.json.subformType&&this.redoSelectedSubform(e,$(this.property.data.pid+"selectSubform").getElement("select"),""),"script"===this.json.subformType&&(this.subformData=null,this.clearSubformList(this.json.subformSelected),this.node.empty(),this.loadIcon()))},redoSelectedSubform:function(e,t,o){if("none"===this.json.subformSelected&&(this.json.subformSelected=""),this.json.subformSelected&&"none"!==this.json.subformSelected){t&&(this.subformSelector=t),t||(t=this.getSubformSelector()),o&&(this.subformSelectedValue=o),o||(o=this.getSubformSelectedValue()||"");var s=this.getLevel1Subform();if(this.checkSubformNested(this.json.subformSelected))if(this.isSubformUnique(this.json.subformSelected,o))MWF.Actions.get("x_processplatform_assemble_designer").getForm(this.json.subformSelected,function(e){this.reloadSubform(e.data,t,o)}.bind(this));else{if(this.form.designer.notice(this.form.designer.lp.subformConflictInfor,"error",s.node),s.json.subformSelected=o,t)for(i=0;i<t.options.length;i++)if(t.options[i].value===o||"none"===t.options[i].value&&!o){t.options[i].set("selected",!0);break}o?s.refreshSubform():(s.node.empty(),s.loadIcon())}else{if(this.form.designer.notice(this.form.designer.lp.subformNestedInfor,"error",s.node),s.json.subformSelected=o,t)for(var i=0;i<t.options.length;i++)if(t.options[i].value===o||"none"===t.options[i].value&&!o){t.options[i].set("selected",!0);break}o?s.refreshSubform():(s.node.empty(),s.loadIcon())}}else this.subformData=null,this.clearSubformList(o),this.node.empty(),this.loadIcon()},clearSubformList:function(e){this.form.subformList||(this.form.subformList={}),e&&this.form.subformList[e]&&delete this.form.subformList[e],this.form.topform||(this.form.topform=this.form),this.form.topform.clearSubformList(this.getLevel1Subform().json.id)},addSubformList:function(){this.form.subformList||(this.form.subformList={}),this.form.subformList[this.json.subformSelected]=Object.clone(this.subformData.json),this.form.topform||(this.form.topform=this.form),this.form.topform.addSubformList(this.getLevel1Subform().json.id,this.json.subformSelected)},getSubformData:function(e){var t=null;t="Mobile"!==this.form.options.mode?e.data:e.mobileData,this.subformData=null,t&&(this.subformData=JSON.decode(MWF.decodeJsonString(t)),this.subformData.updateTime=e.updateTime)},reloadSubform:function(e,t,o){if(this.getSubformData(e),this.subformData){var s=this.form.subformList&&o?this.form.subformList[o]:null;if(this.clearSubformList(o),this.checkSubform(e,t))this.node.empty(),this.loadSubform(null),this.addSubformList();else if(s?(this.form.subformList||(this.form.subformList={}),this.form.subformList[o]=s):(this.clearSubformList(o),this.node.empty(),this.loadIcon()),this.json.subformSelected=o,o){if(t)for(var i=0;i<t.options.length;i++)if(t.options[i].value===o){t.options[i].set("selected",!0);break}}else t&&t.options[0].set("selected",!0)}else if(this.json.subformSelected=o,t)if(o){for(i=0;i<t.options.length;i++)if(t.options[i].value===o){t.options[i].set("selected",!0);break}}else t.options[0].set("selected",!0)},regetSubformData:function(){var e=!1;return this.json.subformSelected&&"none"!==this.json.subformSelected&&"script"!==this.json.subformType&&MWF.Actions.get("x_processplatform_assemble_designer").getForm(this.json.subformSelected,function(t){this.subformData&&this.subformData.updateTime===t.data.updateTime||(this.getSubformData(t.data),e=!0)}.bind(this),null,!1),e},getConflictFields:function(){var e=[];return this.subformData&&Object.each(this.subformData.json.moduleList,function(t,o){var s=this.form.checkModuleId(o,t.type,this.subformData.json.id);s.fieldConflict?e.push(o):s.elementConflict&&(t.changeId=this.json.id+"_"+o)}.bind(this)),e},checkSubform:function(e,t){var o=this.getConflictFields();if(o.length){var s=this.form.designer.lp.subformNameConflictInfor;return s=s.replace("{name}",o.join(", ")),this.form.designer.notice(s,"error",this.node),!1}return!0},loadSubform:function(e){this.subformData.json.style=this.form.json.style,this.subformData.json.properties=this.form.json.properties,this.subformData.json.jsheader={code:"",html:""},this.subformData.json.events={},this.subformData.json.formStyleType=this.form.json.formStyleType,this.subformModule=new MWF.FCSubform.Form(this.form,this.node,{mode:this.form.options.mode,parentformIdList:this.getParentformIdList(),level:this.getLevel()}),this.subformModule.subformSelector=this.getSubformSelector(),this.subformModule.subformSelectedValue=this.getSubformSelectedValue(),this.subformModule.level1Subform=this.getLevel1Subform(),this.subformModule.load(this.subformData)},destroy:function(){this.form.moduleList.erase(this),this.form.moduleNodeList.erase(this.node),this.form.moduleElementNodeList.erase(this.node),this.form.subformModuleList.erase(this),this.clearSubformList(this.json.subformSelected),this.node.destroy(),this.actionArea.destroy(),delete this.form.json.moduleList[this.json.id],this.json=null,delete this.json,this.treeNode.destroy()}}),MWF.xApplication.process.FormDesigner.Module.Subform.Form=new Class({Extends:MWF.FCForm,initialize:function(e,t,o){this.setOptions(o),this.topform=e.topform||e,this.parentform=e,this.css=this.parentform.css,this.container=t,this.form=this,this.isSubform=!0,this.moduleType="subform",this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.designer=this.parentform.designer,this.selectedModules=[]},load:function(e){this.data=e,this.json=e.json,this.html=e.html,this.json.mode=this.options.mode,this.container.set("html",this.html),this.loadDomModules(),this.options.mode},loadDomModules:function(){this.node=this.container.getFirst(),this.node.set("id",this.json.id),this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode),this.node.store("module",this),this.loadDomTree()},loadDomTree:function(){this.createFormTreeNode(),this.parseModules(this,this.node)},createFormTreeNode:function(){this.treeNode={insertChild:function(){return this},appendChild:function(){return this},selectNode:function(){},node:null,parentNode:{}},this.treeNode.module=this}});