MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Container",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Module.$Component",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Module.Datagrid$Data",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Module.Datagrid$Title",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Module.Table$Td",null,!1),MWF.xApplication.process.FormDesigner.Module.Datagrid=MWF.FCDatagrid=new Class({Extends:MWF.FC$Component,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/Datagrid/datagrid.html"},initialize:function(t,e){this.setOptions(e),this.path="../x_component_process_FormDesigner/Module/Datagrid/",this.cssPath="../x_component_process_FormDesigner/Module/Datagrid/"+this.options.style+"/css.wcss",this._loadCss(),this.moduleType="component",this.moduleName="datagrid",this.form=t,this.container=null,this.containerNode=null,this.containers=[],this.elements=[],this.selectedMultiTds=[]},clearTemplateStyles:function(t){t&&(t.styles&&this.removeStyles(t.styles,"styles"),t.tableStyles&&this.removeStyles(t.tableStyles,"tableStyles"),t.titleStyles&&this.removeStyles(t.titleStyles,"titleStyles"),t.contentStyles&&this.removeStyles(t.contentStyles,"contentStyles"),t.actionStyles&&this.removeStyles(t.actionStyles,"actionStyles"),t.editStyles&&this.removeStyles(t.editStyles,"editStyles"),t.amountStyles&&this.removeStyles(t.amountStyles,"amountStyles"),t.itemTitleStyles&&this.removeStyles(t.itemTitleStyles,"itemTitleStyles"),t.properties&&this.removeStyles(t.properties,"properties"))},setTemplateStyles:function(t){t.styles&&this.copyStyles(t.styles,"styles"),t.tableStyles&&this.copyStyles(t.tableStyles,"tableStyles"),t.titleStyles&&this.copyStyles(t.titleStyles,"titleStyles"),t.contentStyles&&this.copyStyles(t.contentStyles,"contentStyles"),t.actionStyles&&this.copyStyles(t.actionStyles,"actionStyles"),t.editStyles&&this.copyStyles(t.editStyles,"editStyles"),t.amountStyles&&this.copyStyles(t.amountStyles,"amountStyles"),t.itemTitleStyles&&this.copyStyles(t.itemTitleStyles,"itemTitleStyles"),t.properties&&this.copyStyles(t.properties,"properties")},_createMoveNode:function(){this.moveNode=new Element("div",{html:'<table border="0" cellpadding="0" cellspacing="2" width="100%" align="center"><tr><th></th><th></th><th></th></tr><tr><td></td><td></td><td></td></tr></table>'}).inject(this.form.container),this.moveNode.setStyles(this.css.moduleNodeMove),this._setTableStyle()},_setTableStyle:function(){this.moveNode.getElements("td").setStyles({border:"1px dashed #999",height:"20px"}),this.moveNode.getElements("th").setStyles({background:"#C3CEEA",border:"1px dashed #999",height:"20px"})},_getContainers:function(){var t=this.node.getElements("td");this.form.getTemplateData("Datagrid$Data",function(e){t.each(function(t){var i=this.form.getDomjson(t),s=null;if(i){o=Object.clone(e);Object.merge(o,i),Object.merge(i,o),(s=new MWF.FCDatagrid$Data(this.form)).load(i,t,this)}else{var o=Object.clone(e);(s=new MWF.FCDatagrid$Data(this.form)).load(o,t,this)}this.containers.push(s)}.bind(this))}.bind(this),!1)},_getElements:function(){var t=this.node.getElements("th");this.form.getTemplateData("Datagrid$Title",function(e){t.each(function(t){var i=this.form.getDomjson(t),s=null;if(i){o=Object.clone(e);Object.merge(o,i),Object.merge(i,o),(s=new MWF.FCDatagrid$Title(this.form)).load(i,t,this)}else{var o=Object.clone(e);(s=new MWF.FCDatagrid$Title(this.form)).load(o,t,this)}this.elements.push(s)}.bind(this))}.bind(this),!1)},_getDroppableNodes:function(){var t=[this.form.node].concat(this.form.moduleElementNodeList,this.form.moduleContainerNodeList,this.form.moduleComponentNodeList);return this.form.moduleList.each(function(e){if("datatemplate"===e.moduleName){var i=this.form.getModuleNodes(e.node);t.erase(e.node),i.each((function(e){t.erase(e)}))}}.bind(this)),t},_createNode:function(t){var e=this,i=this.path+"datagridCreate.html";MWF.require("MWF.widget.Dialog",function(){var s=$(document.body).getSize(),o=s.x/2-180,n=s.y/2-130;new MWF.DL({title:"Create Datagrid",style:"property",top:n,left:o-40,fromTop:s.y/2-65,fromLeft:s.x/2,width:360,height:260,url:i,lp:MWF.xApplication.process.FormDesigner.LP.propertyTemplate,buttonList:[{text:MWF.APPFD.LP.button.ok,action:function(){e._createTableNode(),t(),this.close()}}]}).show()}.bind(this))},_createTableNode:function(){var t=$("MWFNewTableColumn").get("value"),e=$("MWFNewTableWidth").get("value"),i=$("MWFNewTableWidthUnit"),s=i.options[i.selectedIndex].value,o=$("MWFNewTableBorder").get("value"),n=$("MWFNewTableCellpadding").get("value"),l=$("MWFNewTableCellspacing").get("value"),r="";r="percent"==s?e+"%":e+"px",this.json.properties.width=r,this.json.properties.border=o,this.json.properties.cellpadding=n,this.json.properties.cellspacing=l;var p='<table border="'+o+'" cellpadding="'+n+'" cellspacing="'+l+'" width="'+r+'" align="center">';p+="<tr>";for(var h=0;h<t.toInt();h++)p+="<th></th>";p+="</tr>",p+="<tr>";for(h=0;h<t.toInt();h++)p+="<td></td>";p+="</tr></table>",this.node=new Element("div",{id:this.json.id,MWFType:"datagrid",html:p,styles:this.css.moduleNode,events:{selectstart:function(t){t.preventDefault()}}}).inject(this.form.node),this.table=this.node.getElement("table")},_dragComplete:function(){this.node?this._dragMoveComplete():this._createNode(function(){this._dragMoveComplete()}.bind(this))},_dragMoveComplete:function(){this._resetTreeNode(),this.node.inject(this.copyNode,"before"),this._initModule();var t=this.node.retrieve("thisDisplay");t&&this.node.setStyle("display",t),this.copyNode&&this.copyNode.destroy(),this.moveNode&&this.moveNode.destroy(),this.moveNode=null,this.copyNode=null,this.nextModule=null,this.form.moveModule=null,this.form.json.moduleList[this.json.id]=this.json,this.selected()},_initModule:function(){this.initialized||("yes"!==this.json.initialized&&this.setStyleTemplate(),this.table=this.node.getElement("table"),this._getElements(),this._getContainers(),this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("tableStyles"),this.setPropertiesOrStyles("properties"),this._setNodeProperty(),this.form.isSubform||this._createIconAction(),this._setNodeEvent(),this.setDatagridStyles(),this._setEditStyle_custom("impexpType"),this.initialized=!0,this.json.initialized="yes")},setPropertiesOrStyles:function(t){if("styles"==t){var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles(this.css.moduleNode),this.node.setStyle("border",e),Object.each(this.json.styles,function(t,e){e.test(/^border\w*/gi)||this.node.setStyle(e,t)}.bind(this))}"tableStyles"==t&&(this.table.clearStyles(),Object.each(this.json.tableStyles,function(t,e){e.test(/^border\w*/gi)||this.table.setStyle(e,t)}.bind(this))),"properties"==t&&this.node.getFirst().setProperties(this.json.properties)},_setEditStyle_custom:function(t,e,i){if("id"==t&&t!=i){var s=new RegExp("^"+i,"i");this.containers.each(function(t){var e=t.json.id,i=e.replace(s,this.json.id);t.json.id=i,delete this.form.json.moduleList[e],this.form.json.moduleList[i]=t.json,t._setEditStyle("id")}.bind(this))}"titleStyles"==t&&this.table.getElements("th").each(function(t){var e=t.getStyle("opacity");this.setCustomNodeStyles(t,this.json.titleStyles),e&&t.setStyle("opacity",e)}.bind(this));"contentStyles"==t&&this.table.getElements("td").each(function(t){var e=t.getStyle("opacity");this.setCustomNodeStyles(t,this.json.contentStyles),e&&t.setStyle("opacity",e)}.bind(this));var o=function(){if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var t=2;this.exportActionNode&&(t=t+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(t=t+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",t+"px")}else this.importExportAreaNode.setStyle("width","auto")}.bind(this);if("impexpType"===t){var n="impexp"===this.json.impexpType||"imp"===this.json.impexpType,l="impexp"===this.json.impexpType||"exp"===this.json.impexpType;if(this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,!l&&!n)return;var r=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom";this.impexpNode=new Element("div.impexpNode",{styles:{width:"100%",overflow:"hidden"}}).inject(this.node,r);var p,h=new Element("div.importExportAreaNode").inject(this.impexpNode);["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?h.setStyles({float:"left",margin:"0px"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?h.setStyles({float:"right",margin:"0px"}):h.setStyles({float:"none",margin:"0px auto"}),this.importExportAreaNode=h;if(l){var d=new Element("div.exportActionStyles",{text:this.json.exportActionText}).inject(h);p=this.json.exportActionStyles?Object.clone(this.json.exportActionStyles):{color:"#777","border-radius":"5px",border:"1px solid #ccc",cursor:"pointer",height:"26px",float:"left","line-height":"26px",padding:"0px 5px","background-color":"#efefef",margin:"5px"},d.setStyles(p),this.exportActionNode=d}if(n){var a=new Element("div.importActionNode",{text:this.json.importActionText}).inject(h);p=this.json.importActionStyles?Object.clone(this.json.importActionStyles):{color:"#777","border-radius":"5px",border:"1px solid #ccc",cursor:"pointer",height:"26px",float:"left","line-height":"26px",padding:"0px 5px","background-color":"#efefef",margin:"5px"},a.setStyles(p),this.importActionNode=a}o()}if("impexpPosition"===t&&this.impexpNode&&this.importExportAreaNode){r=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom";this.impexpNode.inject(this.node,r);h=this.importExportAreaNode;["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?h.setStyles({float:"left",margin:"0px"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?h.setStyles({float:"right",margin:"0px"}):h.setStyles({float:"none",margin:"0px auto"}),o()}"importActionText"===t&&this.importActionNode&&(this.importActionNode.set("text",this.json.importActionText),o()),"exportActionText"===t&&this.exportActionNode&&(this.exportActionNode.set("text",this.json.exportActionText),o()),"importActionStyles"===t&&this.importActionNode&&(this.importActionNode.setStyles(this.json.importActionStyles||{}),o()),"exportActionStyles"===t&&this.exportActionNode&&(this.exportActionNode.setStyles(this.json.exportActionStyles||{}),o())},setDatagridStyles:function(){this.json.titleStyles&&this.table.getElements("th").each(function(t){var e=t.getStyle("opacity");this.setCustomNodeStyles(t,this.json.titleStyles),e&&t.setStyle("opacity",e)}.bind(this));this.json.contentStyles&&this.table.getElements("td").each(function(t){var e=t.getStyle("opacity");this.setCustomNodeStyles(t,this.json.contentStyles),e&&t.setStyle("opacity",e)}.bind(this))},setAllStyles:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("tableStyles"),this.setPropertiesOrStyles("properties"),this.setDatagridStyles(),this.reloadMaplist()},getContainerNodes:function(){return this.node.getElements("td")},copyComponentJsonData:function(t,e){var i=t.getElements("td"),s=t.getElements("th");i.each(function(t,i){var s=Object.clone(this.containers[i].json);s.id=this.containers[i]._getNewId(e),this.form.json.moduleList[s.id]=s,t.set("id",s.id)}.bind(this)),s.each(function(t,i){var s=Object.clone(this.elements[i].json);s.id=this.elements[i]._getNewId(e),this.form.json.moduleList[s.id]=s,t.set("id",s.id)}.bind(this))}});