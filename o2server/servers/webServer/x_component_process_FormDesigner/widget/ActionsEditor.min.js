MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.FormDesigner=MWF.xApplication.process.FormDesigner||{},MWF.xApplication.process.FormDesigner.widget=MWF.xApplication.process.FormDesigner.widget||{},MWF.require("MWF.widget.ScriptArea",null,!1),MWF.require("MWF.widget.Maplist",null,!1),MWF.xApplication.process.FormDesigner.widget.ActionsEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",maxObj:document.body,isSystemTool:!1,noCreate:!1,noDelete:!1,noCode:!1,noHide:!1,systemToolsAddress:"../x_component_process_FormDesigner/Module/Actionbar/toolbars.json"},initialize:function(t,i,e,o){this.setOptions(o),this.node=$(t),this.module=e,this.designer=i,this.path="../x_component_process_FormDesigner/widget/$ActionsEditor/",this.cssPath="../x_component_process_FormDesigner/widget/$ActionsEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=[],this.currentEditItem=null,this.createActionsAreaNode()},createActionsAreaNode:function(){this.actionsContainer=new Element("div",{styles:this.css.actionsContainer}).inject(this.node)},load:function(t){this.loadActionsArea(),this.options.noCreate||this.loadCreateActionButton(),this.data=t,this.data&&"array"==typeOf(this.data)||(this.data=[]),this.loadRestoreActionButton(),this.data.each(function(t,i){if("MWFToolBarSeparator"!=t.type){var e=new MWF.xApplication.process.FormDesigner.widget.ActionsEditor.ButtonAction(this);e.load(t),this.actions.push(e)}}.bind(this))},loadActionsArea:function(){this.options.noCreate||(this.actionTitleArea=new Element("div",{styles:this.css.actionTitleArea}).inject(this.actionsContainer)),this.actionArea=new Element("div",{styles:this.css.actionArea}).inject(this.actionsContainer)},loadCreateActionButton:function(){this.createActionButtonButton=new Element("div",{styles:this.css.createActionButton,title:this.designer.lp.actionbar.addCustomTool,text:"+"}).inject(this.actionTitleArea),this.createActionButtonButton.addEvent("click",function(){this.addButtonAction()}.bind(this))},loadRestoreActionButton:function(){this.options.isSystemTool&&(this.actionTitleArea||(this.actionTitleArea=new Element("div",{styles:this.css.actionTitleArea}).inject(this.actionArea,"before")),this.restoreActionButtonButton=new Element("div",{styles:this.css.restoreActionButton,title:this.designer.lp.actionbar.restoreDefaultTool}).inject(this.actionTitleArea),this.restoreActionButtonButton.addEvent("click",function(){this.restoreButtonAction()}.bind(this)))},listRemovedSystemTool:function(){var t=[];return this.defaultTools||MWF.getJSON(this.options.systemToolsAddress,function(t){this.defaultTools=t,this.options.target&&"mobileForm"===this.options.target&&this.defaultTools.push({type:"MWFToolBarButton",img:"read.png",title:this.designer.lp.actionbar.setReaded,action:"readedWork",text:this.designer.lp.actionbar.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0})}.bind(this),!1),this.defaultTools.each(function(i){for(var e=!0,o=0;o<(this.data||[]).length;o++)if(this.data[o].id===i.id){e=!1;break}e&&t.push(i)}.bind(this)),t},addButtonAction:function(){var t={type:"MWFToolBarButton",img:"4.png",title:"",action:"",text:"Unnamed",actionScript:"",condition:"",editShow:!0,readShow:!0},i=new MWF.xApplication.process.FormDesigner.widget.ActionsEditor.ButtonAction(this);i.load(t),this.data.push(t),this.actions.push(i),this.fireEvent("change")},restoreButtonAction:function(){var t=this.listRemovedSystemTool();if(t.length){var i=[];t.each(function(t){var e="";t.text&&this.designer.lp.actionBar&&(e=(e=this.designer.lp.actionBar[t.text.split(".").getLast().replace("}}","")]||"")?"  ("+e+")":""),i.push({name:t.text+e,id:t.id})}.bind(this)),MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var e={count:0,title:this.designer.lp.actionbar.selectDefaultTool,selectableItems:i,values:[],onComplete:function(i){i&&0!=i.length&&(i.each(function(i){for(var e=0;e<t.length;e++)if(t[e].id===i.data.id){t[e].system=!0,this.data.push(t[e]);var o=new MWF.xApplication.process.FormDesigner.widget.ActionsEditor.ButtonAction(this);o.load(t[e]),this.actions.push(o);break}}.bind(this)),this.fireEvent("change"))}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.options.maxObj,e).load()}}}),MWF.xApplication.process.FormDesigner.widget.ActionsEditor.ButtonAction=new Class({initialize:function(t){this.editor=t,this.css=this.editor.css,this.container=this.editor.actionArea},load:function(t){this.data=t,this.loadNode();var i=this.editor.designer.form||this.editor.designer.page||this.editor.designer.view;i&&i.scriptDesigner&&(this.scriptItem=i.scriptDesigner.addScriptItem(this.data,"actionScript",this.editor.module,"action.tools",this.data.text));var e=this.data.text;Object.defineProperty(this.data,"text",{configurable:!0,enumerable:!0,get:function(){return e},set:function(t){this.scriptItem&&(this.scriptItem.par=t,this.scriptItem.resetText()),e=t}.bind(this)})},loadNode:function(){if(this.node=new Element("div",{styles:this.css.actionNode}).inject(this.container),this.titleNode=new Element("div",{styles:this.css.actionTitleNode}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.actionIconNode}).inject(this.titleNode),this.textNode=new Element("div",{styles:this.css.actionTextNode,text:this.data.text}).inject(this.titleNode),this.data.text&&this.editor.designer.lp.actionBar){var t=this.editor.designer.lp.actionBar[this.data.text.split(".").getLast().replace("}}","")]||"";this.textNode.set("title",t||"")}this.upButton=new Element("div",{styles:this.css.actionUpButtonNode,title:this.editor.designer.lp.actionbar.up}).inject(this.titleNode),this.propertiesButton=new Element("div",{styles:this.css.actionPropertiesButtonNode,title:this.editor.designer.lp.actionbar.property}).inject(this.titleNode),this.data.properties&&0!==Object.keys(this.data.properties).length?this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property.png)"):this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property_empty.png)"),this.propertiesNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.propertiesArea=new MWF.widget.Maplist(this.propertiesNode,{title:this.editor.designer.lp.actionbar.setProperties,collapse:!1,onChange:function(){this.data.properties=this.propertiesArea.toJson(),this.data.properties&&0!==Object.keys(this.data.properties).length?this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property.png)"):this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property_empty.png)"),this.editor.fireEvent("change")}.bind(this)}),this.propertiesArea.load(this.data.properties||{}),this.editor.options.noDelete||(this.delButton=new Element("div",{styles:this.css.actionDelButtonNode,text:"-",title:this.editor.designer.lp.actionbar.delete}).inject(this.titleNode)),this.conditionButton=new Element("div",{styles:this.css.actionConditionButtonNode,title:this.editor.designer.lp.actionbar.hideCondition}).inject(this.titleNode),this.data.condition?this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code.png)"):this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code_empty.png)"),this.editor.options.noEditShow||this.data.system||(this.editButton=new Element("div",{styles:this.css.actionEditButtonNode,title:this.editor.designer.lp.actionbar.edithide}).inject(this.titleNode),this.data.editShow?this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit.png)"):this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit_hide.png)")),this.editor.options.noReadShow||this.data.system||(this.readButton=new Element("div",{styles:this.css.actionReadButtonNode,title:this.editor.designer.lp.actionbar.readhide}).inject(this.titleNode),this.data.readShow?this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read.png)"):this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read_hide.png)"));var i=this.editor.path+this.editor.options.style+"/tools/"+this.data.img;this.iconNode.setStyle("background-image","url("+i+")"),this.editor.options.noCode||this.data.system||(this.scriptNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.scriptArea=new MWF.widget.ScriptArea(this.scriptNode,{title:this.editor.designer.lp.actionbar.editScript,maxObj:this.editor.designer.formContentNode,key:"actionScript",onChange:function(){this.data.actionScript=this.scriptArea.editor.getValue(),this.editor.fireEvent("change")}.bind(this),onSave:function(){this.data.actionScript=this.scriptArea.editor.getValue(),this.editor.fireEvent("change"),this.editor.designer.saveForm()}.bind(this),onPostLoad:function(){}.bind(this)}),this.scriptArea.load({code:this.data.actionScript})),this.conditionNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.conditionArea=new MWF.widget.ScriptArea(this.conditionNode,{title:this.editor.designer.lp.actionbar.editCondition,maxObj:this.editor.designer.formContentNode,onChange:function(){this.data.condition=this.conditionArea.editor.getValue(),this.data.condition?this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code.png)"):this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code_empty.png)"),this.editor.fireEvent("change")}.bind(this),onSave:function(){this.data.condition=this.conditionArea.editor.getValue(),this.editor.fireEvent("change"),this.editor.designer.saveForm()}.bind(this),onPostLoad:function(){}.bind(this)}),this.conditionArea.load({code:this.data.condition}),this.setEvent()},setEvent:function(){this.iconMenu=new MWF.widget.Menu(this.iconNode,{event:"click",style:"actionbarIcon",onPostShow:function(t){t.stopPropagation()}}),this.iconMenu.load();for(var t=this,i=1;i<=136;i++){var e=this.editor.path+this.editor.options.style+"/tools/"+i+".png";this.iconMenu.addMenuItem("","click",(function(i){var e=this.item.getElement("img").get("src");t.data.img=e.substr(e.lastIndexOf("/")+1,e.length),t.iconNode.setStyle("background-image","url("+e+")"),t.editor.fireEvent("change"),i.stopPropagation()}),e).iconName=i+".png"}this.upButton.addEvent("click",function(t){var i=this.editor.actions,e=this.editor.data,o=e.indexOf(this.data),s=i.indexOf(this);if(0!==s&&0!==o){var n=s-1,d=i[n];this.node.inject(d.node,"before"),i[n]=i.splice(s,1,i[n])[0],this.editor.actions=i;var r=o-1;e[r]=e.splice(o,1,e[r])[0],this.editor.data=e,this.editor.fireEvent("change"),t.stopPropagation()}else t.stopPropagation()}.bind(this)),this.propertiesButton.addEvent("click",function(t){"none"==this.propertiesNode.getStyle("display")?this.propertiesNode.setStyle("display","block"):this.propertiesNode.setStyle("display","none"),t.stopPropagation()}.bind(this)),this.textNode.addEvent("click",function(t){this.textNode.empty();var i=new Element("input",{styles:this.css.actionEditTextNode,type:"text",value:this.data.text}).inject(this.textNode);i.focus(),i.select();var e=this;i.addEvent("blur",(function(){e.editTitleComplete(this)})),i.addEvent("keydown:keys(enter)",(function(){e.editTitleComplete(this)})),i.addEvent("click",(function(t){t.stopPropagation()})),t.stopPropagation()}.bind(this)),this.conditionButton.addEvent("click",function(t){t.stopPropagation(),this.editCondition()}.bind(this)),this.editButton&&this.editButton.addEvent("click",function(t){this.data.editShow?(this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit_hide.png)"),this.data.editShow=!1):(this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit.png)"),this.data.editShow=!0),this.editor.fireEvent("change"),t.stopPropagation()}.bind(this)),this.readButton&&this.readButton.addEvent("click",function(t){this.data.readShow?(this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read_hide.png)"),this.data.readShow=!1):(this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read.png)"),this.data.readShow=!0),this.editor.fireEvent("change"),t.stopPropagation()}.bind(this)),this.titleNode.addEvent("click",function(){this.scriptNode&&("none"==this.scriptNode.getStyle("display")?(this.scriptNode.setStyle("display","block"),this.scriptArea&&(this.scriptArea.resizeContentNodeSize(),this.scriptArea.editor&&this.scriptArea.editor.resize(),this.scriptArea.jsEditor||(this.scriptArea.contentNode.empty(),this.scriptArea.loadEditor({code:this.data.actionScript})))):this.scriptNode.setStyle("display","none"))}.bind(this)),this.delButton&&this.delButton.addEvent("click",function(t){var i=this;this.editor.designer.confirm("warn",this.delButton,MWF.APPFD.LP.notice.deleteButtonTitle,MWF.APPFD.LP.notice.deleteButton,300,120,(function(){i.destroy(),this.close()}),(function(){this.close()}),null),t.stopPropagation()}.bind(this))},editCondition:function(){"none"==this.conditionNode.getStyle("display")?(this.conditionNode.setStyle("display","block"),this.conditionArea&&(this.conditionArea.resizeContentNodeSize(),this.conditionArea.editor&&this.conditionArea.editor.resize(),this.conditionArea.jsEditor||(this.conditionArea.contentNode.empty(),this.conditionArea.loadEditor({code:this.data.condition})))):this.conditionNode.setStyle("display","none")},destroy:function(){var t=this.editor.designer.form||this.editor.designer.page||this.editor.designer.view;t&&t.scriptDesigner&&t.scriptDesigner.deleteScriptItem(this.editor.module,"action.tools",this.data.text),this.editor.data.erase(this.data),this.editor.actions.erase(this),this.editor.fireEvent("change"),this.node.destroy(),MWF.release(this.scriptArea),MWF.release(this)},editTitleComplete:function(t){this.data.text=t.get("value"),this.data.title=t.get("value"),t.destroy(),this.textNode.empty(),this.textNode.set("text",this.data.text),this.editor.fireEvent("change")}});