MWF.APPFD=MWF.xApplication.process.FormDesigner,MWF.APPFD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("process.FormDesigner","Module.Package",null,!1),MWF.xApplication.process.FormDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",template:"form_classical.json",templateId:"",name:"process.FormDesigner",icon:"icon.png",title:MWF.APPFD.LP.title,appTitle:MWF.APPFD.LP.title,id:"",actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.APPFD.LP.newForm),this.actions=MWF.Actions.get("x_processplatform_assemble_designer"),this.lp=MWF.xApplication.process.FormDesigner.LP},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openForm():this.maxSize(function(){this.openForm()}.bind(this)),this.addKeyboardEvents(),t&&t()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this)),this.addEvent("paste",function(){this.pasteModule()}.bind(this)),this.addEvent("cut",function(){this.cutModule()}.bind(this)),this.addEvent("keySave",function(t){this.keySave(t)}.bind(this)),this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){this.shortcut&&(this.form&&this.saveForm(),t.preventDefault())},keyDelete:function(t){if(this.form&&this.shortcut&&this.form.currentSelectedModule){var e=this.form.currentSelectedModule;"form"!=e.moduleType&&-1==e.moduleName.indexOf("$")&&e.delete(e.node)}},copyModule:function(){if(this.shortcut&&this.form&&this.form.currentSelectedModule){var t=this.form.currentSelectedModule;if("form"!=t.moduleType&&-1==t.moduleName.indexOf("$")){this.form.fireEvent("queryGetFormData",[t.node]);var e=t.getHtml(),o=t.getJson();this.form.fireEvent("postGetFormData",[t.node]),MWF.clipboard.data={type:"form",data:{html:e,json:o}}}else MWF.clipboard.data=null}},cutModule:function(){if(this.shortcut&&this.form&&this.form.currentSelectedModule){var t=this.form.currentSelectedModule;if("form"!=t.moduleType&&-1==t.moduleName.indexOf("$")){this.copyModule();var e=t.form;t.destroy(),e.currentSelectedModule=null,e.selected(),e=null}}},pasteModule:function(){if(this.shortcut&&this.form&&MWF.clipboard.data&&"form"==MWF.clipboard.data.type){var t=MWF.clipboard.data.data.html,e=Object.clone(MWF.clipboard.data.data.json),o=Element("div",{styles:{display:"none"},html:t}).inject(this.content);Object.each(e,function(t){for(var e=t.id,i=t.id,s=1;this.form.json.moduleList[i];)i=e+"_"+s,s++;if(e!=i){t.id=i;var r=o.getElementById(e);r&&r.set("id",i)}this.form.json.moduleList[t.id]=t}.bind(this)),delete e;var i=this.form.node,s="bottom",r=this.form;if(this.form.currentSelectedModule){var n=this.form.currentSelectedModule;i=n.node,r=n,"container"!=n.moduleType&&"form"!=n.moduleType&&(s="after",r=n.parentContainer)}for(var a=o.getFirst();a;){a.inject(i,s);var l=this.form.getDomjson(a);module=this.form.loadModule(l,a,r),module._setEditStyle_custom("id"),module.selected(),a=o.getFirst()}o.destroy(),delete o}},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},openForm:function(){this.initOptions(),this.loadNodes(),this.loadToolbar(),this.loadFormNode(),this.loadProperty(),this.loadTools(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadForm(),this.toolbarContentNode&&(this.setScrollBar(this.toolbarContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}}),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.propertyDomScrollArea,{style:"default",where:"before",distance:30,friction:4,indent:!1,axis:{x:!1,y:!0}})}.bind(this))),this.checkSidebars()},checkSidebars:function(){this.positionSidebarsFun=this.positionSidebars.bind(this),this.positionSidebarsId=window.setInterval(this.positionSidebarsFun,1e3),this.addEvent("queryClose",function(){this.positionSidebarsId&&(window.clearInterval(this.positionSidebarsId),this.positionSidebarsId="")}.bind(this))},positionSidebars:function(){this.pcForm&&this.pcForm.moduleList.each(function(t){"sidebar"===t.moduleName&&t.position()}.bind(this))},initOptions:function(){this.toolsData=null,this.toolbarMode="all",this.tools=[],this.toolbarDecrease=0,this.designNode=null,this.form=null},loadNodes:function(){this.toolbarNode=new Element("div",{styles:this.css.toolbarNode,events:{selectstart:function(t){t.preventDefault()}}}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.node),"bottom"==this.options.style&&this.propertyNode.inject(this.formNode,"after")},loadToolbar:function(){this.toolbarTitleNode=new Element("div",{styles:this.css.toolbarTitleNode,text:MWF.APPFD.LP.tools}).inject(this.toolbarNode),this.toolbarTitleActionNode=new Element("div",{styles:this.css.toolbarTitleActionNode,events:{click:function(t){this.switchToolbarMode()}.bind(this)}}).inject(this.toolbarNode),this.toolbarContentNode=new Element("div",{styles:this.css.toolbarContentNode,events:{selectstart:function(t){t.preventDefault(),t.stopPropagation()}}}).inject(this.toolbarNode)},switchToolbarMode:function(){if("all"==this.toolbarMode){var t=this.toolbarNode.getSize();this.toolbarDecrease=t.x.toFloat()-60,this.tools.each((function(t){t.getLast().setStyle("display","none")})),this.toolbarTitleNode.set("text",""),this.toolbarNode.setStyle("width","60px");var e=this.formNode.getStyle("margin-left").toFloat();e-=this.toolbarDecrease,this.formNode.setStyle("margin-left",e+"px"),this.toolbarTitleActionNode.setStyles(this.css.toolbarTitleActionNodeRight),this.toolbarMode="simple"}else{sizeX=60+this.toolbarDecrease;e=this.formNode.getStyle("margin-left").toFloat();e+=this.toolbarDecrease,this.toolbarNode.setStyle("width",sizeX+"px"),this.formNode.setStyle("margin-left",e+"px"),this.tools.each((function(t){t.getLast().setStyle("display","block")})),this.toolbarTitleNode.set("text",MWF.APPFD.LP.tools),this.toolbarTitleActionNode.setStyles(this.css.toolbarTitleActionNode),this.toolbarMode="all"}},loadFormNode:function(){this.formToolbarNode=new Element("div",{styles:this.css.formToolbarNode}).inject(this.formNode),this.loadFormToolbar(),this.formContentNode=new Element("div",{styles:this.css.formContentNode}).inject(this.formNode),this.loadFormContent(function(){this.designDcoument&&this.designDcoument.body.setStyles(this.css.designBody),this.designNode&&this.designNode.setStyles(this.css.designNode)}.bind(this))},loaddesignerActionNode:function(){this.pcDesignerActionNode=this.formToolbarNode.getElement("#MWFFormPCDesignerAction"),this.mobileDesignerActionNode=this.formToolbarNode.getElement("#MWFFormMobileDesignerAction"),this.currentDesignerMode="PC",this.pcDesignerActionNode.setStyles(this.css.designerActionNode_current),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode);new Element("div",{styles:this.css.designerActionPcIconNode}).inject(this.pcDesignerActionNode);new Element("div",{styles:this.css.designerActionMobileIconNode}).inject(this.mobileDesignerActionNode);new Element("div",{styles:this.css.designerActiontextNode,text:"PC"}).inject(this.pcDesignerActionNode);new Element("div",{styles:this.css.designerActiontextNode,text:"Mobile"}).inject(this.mobileDesignerActionNode),this.pcDesignerActionNode.addEvent("click",function(){"PC"!=this.currentDesignerMode&&this.changeDesignerModeToPC()}.bind(this)),this.mobileDesignerActionNode.addEvent("click",function(){"PC"==this.currentDesignerMode&&this.changeDesignerModeToMobile()}.bind(this))},changeDesignerModeToPC:function(){if(this.pcDesignerActionNode.setStyles(this.css.designerActionNode_current),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode),this.designMobileNode.setStyle("display","none"),this.designNode.setStyle("display","block"),this.form.currentSelectedModule){if(this.form.currentSelectedModule==this)return!0;this.form.currentSelectedModule.unSelected()}this.form.propertyMultiTd&&(this.form.propertyMultiTd.hide(),this.form.propertyMultiTd=null),this.form.unSelectedMulti(),this.form.designTabPageScriptAreaNode&&this.form.designTabPageScriptAreaNode.hide(),this.form=this.pcForm,(this.scriptPage&&this.scriptPage.isShow||this.scriptPanel)&&this.loadAllScript(),this.currentDesignerMode="PC"},changeDesignerModeToMobile:function(){if(this.pcDesignerActionNode.setStyles(this.css.designerActionNode),this.mobileDesignerActionNode.setStyles(this.css.designerActionNode_current),this.designMobileNode.setStyle("display","block"),this.designNode.setStyle("display","none"),this.form.currentSelectedModule){if(this.form.currentSelectedModule==this)return!0;this.form.currentSelectedModule.unSelected()}this.form.propertyMultiTd&&(this.form.propertyMultiTd.hide(),this.form.propertyMultiTd=null),this.form.unSelectedMulti(),this.mobileForm||(this.mobileForm=new MWF.FCForm(this,this.designMobileNode,{mode:"Mobile"}),Object.keys(this.formMobileData.json.moduleList).length||(this.formMobileData=Object.clone(this.formData)),this.mobileForm.load(this.formMobileData)),this.form.designTabPageScriptAreaNode&&this.form.designTabPageScriptAreaNode.hide(),this.form=this.mobileForm,(this.scriptPage&&this.scriptPage.isShow||this.scriptPanel)&&this.loadAllScript(),this.currentDesignerMode="Mobile"},loadFormToolbar:function(t){this.getFormToolbarHTML(function(e){e.getElements("span").each(function(t,e){var o=t.get("MWFButtonImage");o&&t.set("MWFButtonImage",this.path+""+this.options.style+"/formtoolbar/"+o)}.bind(this)),$(e).inject(this.formToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.formToolbar=new MWF.widget.Toolbar(e,{style:"ProcessCategory"},this),this.formToolbar.load(),this.loaddesignerActionNode(),t&&t()}.bind(this))}.bind(this))},getFormToolbarHTML:function(t){var e=this.path+this.options.style+"/formToolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,o,i,s){var r=e[0];t&&t(r)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},loadFormContent:function(t){MWF.require("MWF.widget.Tab",null,!1),this.designTabNode=new Element("div").inject(this.formContentNode),this.designTab=new MWF.widget.Tab(this.designTabNode,{style:"design"}),this.designTab.load(),this.designTabPageAreaNode=Element("div"),this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.designTabPageAreaNode),this.designMobileNode=new Element("div",{styles:this.css.designMobileNode}).inject(this.designTabPageAreaNode),this.designTabScriptAreaNode=Element("div",{styles:this.css.designTabScriptAreaNode}),this.designPage=this.designTab.addTab(this.designTabPageAreaNode,this.lp.design),this.scriptPage=this.designTab.addTab(this.designTabScriptAreaNode,this.lp.script),this.setScriptPageEvent(),this.designPage.showTabIm(),this.scriptPage.addEvent("postShow",function(){this.checkLoadAllScript(),this.fireEvent("resize")}.bind(this)),this.designPage.addEvent("postShow",function(){this.fireEvent("resize")}.bind(this))},createScriptPanel:function(t,e){MWF.require("MWF.widget.Panel",function(){this.scriptPanel=new MWF.widget.Panel(this.designTabScriptAreaNode,{title:this.lp.script,minLeft:"500",minTop:"1",style:"page",target:this.content,limitMove:!1,isClose:!1,width:e.x,height:e.y,top:t.y,left:t.x,onPostLoad:function(){this.loadAllScript(),this.fireEvent("resize")}.bind(this),onResize:function(){this.fireEvent("resize")}.bind(this),onDrag:function(t,e){t.getStyle("top").toInt()<0&&t.setStyle("top","0px"),this.scriptPage.tab.tabNodeContainer.isOutside(e)?(this.scriptPage.tabNode.hide(),this.scriptPanel.container.setStyle("opacity","1")):(this.scriptPage.tabNode.show(),this.scriptPanel.container.setStyle("opacity","0.5"))}.bind(this),onCompleteMove:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)||(this.scriptPage.tabNode.show(),this.designTabScriptAreaNode.inject(this.designTab.contentNodeContainer.getLast()),this.fireEvent("resize"),this.scriptPage.showTabIm(),this.scriptPanel.closePanel(),this.scriptPanel=null)}.bind(this)}),this.scriptPanel.load()}.bind(this))},createScriptPageDragNode:function(t){var e=this.scriptPage.tab.contentNodeContainer.getSize(),o=this.scriptPage.tab.contentNodeContainer.getPosition(this.content);if(!this.scriptPageContentDrag){var i=new Element("div",{styles:this.css.scriptPageDragNode}).inject(this.content);this.scriptPageContentDrag=new Drag.Move(i,{droppables:[this.scriptPage.tab.tabNodeContainer],onEnter:function(e,o){this.scriptPage.tabNode.show(),this.designTabScriptAreaNode.show(),this.scriptPageContentDrag=null,i.destroy(),this.scriptPageDrag.start(t)}.bind(this),onComplete:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)&&(this.createScriptPanel(i.getPosition(this.content),i.getSize()),this.designPage.showTabIm()),this.scriptPageContentDrag=null,i&&i.destroy(),this.designTabScriptAreaNode.show()}.bind(this)})}var s=this.scriptPage.tabNode.getPosition(),r=t.page.x-s.x,n=t.page.y-s.y;this.scriptPage.tabNode.hide(),this.designTabScriptAreaNode.hide();var a=.7*e.x,l=.7*e.y,h=o.x+r,d=o.y+n-20;i.setStyles({width:a+"px",height:l+"px",top:d+"px",left:h+"px"}),this.scriptPageContentDrag.start(t)},setScriptPageEvent:function(){this.scriptPageDrag=new Drag(this.scriptPage.tabNode,{snap:20,onStart:function(t,e){t.setStyle("position","static")},onDrag:function(t,e){this.scriptPage.tab.tabNodeContainer.isOutside(e)&&(this.scriptPageDrag.stop(),t.setStyle("left","auto"),this.createScriptPageDragNode(e))}.bind(this),onComplete:function(t){t.setStyle("left","auto")}.bind(this)})},checkLoadAllScript:function(){this.form?this.loadAllScript():this.designPage.showTabIm()},loadAllScript:function(){this.form.designTabPageScriptAreaNode||(this.form.designTabPageScriptAreaNode=Element("div",{styles:this.css.designTabScriptPcAreaNode}).inject(this.designTabScriptAreaNode)),this.form.designTabPageScriptAreaNode.show(),this.form.scriptDesigner||MWF.xDesktop.requireApp("portal.PageDesigner","Script",function(){this.form.scriptDesigner=new MWF.xApplication.portal.PageDesigner.Script(this,this.form.designTabPageScriptAreaNode,this.form.json)}.bind(this))},reloadPropertyStyles:function(){this.css=null,this.cssPath="../x_component_"+this.options.name.replace(/\./g,"_")+"/$Main/"+this.options.style+"/css.wcss",this._loadCss(),"bottom"==this.options.style?(this.propertyNode.inject(this.formNode,"after"),this.propertyTitleNode.setStyle("cursor","row-resize"),this.loadPropertyResizeBottom()):(this.propertyNode.inject(this.formNode,"before"),this.propertyTitleNode.setStyle("cursor","default"),this.propertyResizeBottom&&this.propertyResizeBottom.detach()),this.formNode.clearStyles(!1),this.formNode.setStyles(this.css.formNode),this.propertyNode.clearStyles(!1),this.propertyNode.setStyles(this.css.propertyNode),this.propertyTitleNode.clearStyles(!1),this.propertyTitleNode.setStyles(this.css.propertyTitleNode),this.propertyResizeBar.clearStyles(!1),this.propertyResizeBar.setStyles(this.css.propertyResizeBar),this.propertyContentNode.clearStyles(!1),this.propertyContentNode.setStyles(this.css.propertyContentNode),this.propertyDomContentArea.clearStyles(!1),this.propertyDomContentArea.setStyles(this.css.propertyDomContentArea),this.propertyDomScrollArea.clearStyles(!1),this.propertyDomScrollArea.setStyles(this.css.propertyDomScrollArea),this.propertyDomArea.clearStyles(!1),this.propertyDomArea.setStyles(this.css.propertyDomArea),this.propertyContentArea.clearStyles(!1),this.propertyContentArea.setStyles(this.css.propertyContentArea),this.propertyContentResizeNode.clearStyles(!1),this.propertyContentResizeNode.setStyles(this.css.propertyContentResizeNode),this.propertyTitleActionNode.clearStyles(!1),this.propertyTitleActionNode.setStyles(this.css.propertyTitleActionNode),this.resizeNode()},loadProperty:function(){this.propertyTitleActionNode=new Element("div",{styles:this.css.propertyTitleActionNode}).inject(this.propertyNode),this.propertyTitleActionNode.addEvent("click",function(){this.options.style="default"==this.options.style?"bottom":"default",MWF.UD.putData("formDesignerStyle",{style:this.options.style}),this.reloadPropertyStyles()}.bind(this)),this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:MWF.APPFD.LP.property}).inject(this.propertyNode),"bottom"==this.options.style&&(this.propertyTitleNode.setStyle("cursor","row-resize"),this.loadPropertyResizeBottom()),this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyDomContentArea=new Element("div",{styles:this.css.propertyDomContentArea}).inject(this.propertyContentNode),this.propertyDomScrollArea=new Element("div",{styles:this.css.propertyDomScrollArea}).inject(this.propertyDomContentArea),this.propertyDomArea=new Element("div",{styles:this.css.propertyDomArea}).inject(this.propertyDomScrollArea),this.propertyDomPercent=.3,this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize()},loadPropertyResizeBottom:function(){this.propertyResizeBottom?this.propertyResizeBottom.attach():this.propertyResizeBottom=new Drag(this.propertyTitleNode,{snap:1,onStart:function(t,e){var o="firefox"==Browser.name?e.event.clientX:e.event.x,i="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:o,y:i});var s=this.propertyNode.getSize();t.store("initialWidth",s.x),t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var o="firefox"==Browser.name?e.event.clientY:e.event.y,i=this.content.getSize(),s=t.retrieve("position"),r=t.retrieve("initialHeight").toFloat()+(s.y.toFloat()-o.toFloat());r>i.y/1.5&&(r=i.y/1.5),r<40&&(r=40);var n=1-r/i.y;this.resizeNode(n)}.bind(this)})},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var o="firefox"==Browser.name?e.event.clientX:e.event.x,i="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:o,y:i});var s=this.propertyNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var o="firefox"==Browser.name?e.event.clientX:e.event.x,i=this.content.getSize(),s=t.retrieve("position"),r=t.retrieve("initialWidth").toFloat()+(s.x.toFloat()-o.toFloat());r>i.x/2&&(r=i.x/2),r<40&&(r=40),this.formNode.setStyle("margin-right",r+1),this.propertyNode.setStyle("width",r)}.bind(this)})},propertyResizeDragTopBottom:function(t,e){var o=this.propertyContentNode.getSize(),i=e.event.y,s=t.retrieve("position"),r=i.toFloat()-s.y.toFloat(),n=t.retrieve("initialHeight").toFloat()+r;n<40&&(n=40),n>o.y-40&&(n=o.y-40),this.propertyDomPercent=n/o.y,this.setPropertyContentResize()},propertyResizeDragLeftRight:function(t,e){var o=this.propertyContentNode.getSize(),i="firefox"==Browser.name?e.event.clientX:e.event.x,s=t.retrieve("position"),r=i.toFloat()-s.x.toFloat(),n=t.retrieve("initialWidth").toFloat()+r;n<40&&(n=40),n>o.x-40&&(n=o.x-40),this.propertyDomPercent=n/o.x,this.setPropertyContentResizeBottom()},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var o="firefox"==Browser.name?e.event.clientX:e.event.x,i="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:o,y:i});var s=this.propertyDomContentArea.getSize();t.store("initialHeight",s.y),t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){"bottom"==this.options.style?this.propertyResizeDragLeftRight(t,e):this.propertyResizeDragTopBottom(t,e)}.bind(this)})},setPropertyContentResizeBottom:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),o=t.x-e.x-6,i=this.propertyDomPercent*o,s=i+e.x+6;this.propertyDomContentArea.setStyle("width",i+"px"),this.propertyContentArea.setStyle("margin-left",s+"px")},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),o=t.y-e.y,i=this.propertyDomPercent*o,s=o-i;if(this.propertyDomContentArea.setStyle("height",i+"px"),this.propertyDomScrollArea.setStyle("height",i+"px"),this.propertyContentArea.setStyle("height",s+"px"),this.form&&this.form.currentSelectedModule&&this.form.currentSelectedModule.property){var r=this.form.currentSelectedModule.property.propertyTab;if(r){var n=r.tabNodeContainer.getSize();r.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),o=t.contentNodeArea.getStyle("margin-bottom").toFloat(),i=s-e-o-n.y.toFloat()-15;t.contentNodeArea.setStyle("height",i)}.bind(this))}}},loadTools:function(){var t=this;this.getTools(function(){Object.each(this.toolsData,function(e,o){var i=new Element("div",{styles:this.css.toolbarToolNode,title:e.text,events:{mouseover:function(e){try{this.setStyles(t.css.toolbarToolNodeOver)}catch(e){this.setStyles(t.css.toolbarToolNodeOverCSS2)}},mouseout:function(e){try{this.setStyles(t.css.toolbarToolNode)}catch(e){}},mousedown:function(e){try{this.setStyles(t.css.toolbarToolNodeDown)}catch(e){this.setStyles(t.css.toolbarToolNodeDownCSS2)}},mouseup:function(e){try{this.setStyles(t.css.toolbarToolNodeUp)}catch(e){this.setStyles(t.css.toolbarToolNodeUpCSS2)}}}}).inject(this.toolbarContentNode);i.store("toolClass",e.className),new Element("div",{styles:this.css.toolbarToolIconNode}).inject(i).setStyle("background-image","url("+this.path+this.options.style+"/icon/"+e.icon+")"),new Element("div",{styles:this.css.toolbarToolTextNode,text:e.text}).inject(i),i.addEvent("mousedown",(function(e){var o=this.retrieve("toolClass");t.form.createModule(o,e)})),this.tools.push(i)}.bind(this))}.bind(this))},getTools:function(t){if(this.toolsData)t&&t();else{var e=this.path+this.options.style+"/tools.json";new Request.JSON({url:e,secure:!1,async:!1,method:"get",noCache:!0,onSuccess:function(e,o){this.toolsData=e,t&&t()}.bind(this),onError:function(t,e){this.notice("request tools data error: "+e,"error")}.bind(this)}).send()}},resizeNodeLeftRight:function(){var t=this.node.getSize();this.toolbarNode.setStyle("height",t.y+"px"),this.formNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var e=this.formToolbarNode.getStyle("margin-top").toFloat(),o=this.formToolbarNode.getStyle("margin-bottom").toFloat(),i=this.formToolbarNode.getComputedSize(),s=t.y-i.totalHeight-e-o;this.formContentNode.setStyle("height",s+"px");var r=this.designTab.tabNodeContainer.getComputedSize(),n=this.designTab.tabNodeContainer.getStyle("margin-top").toFloat(),a=this.designTab.tabNodeContainer.getStyle("margin-bottom").toFloat();(s=s-r.totalHeight-n-a,this.designTab.contentNodeContainer.setStyle("height",s+"px"),this.designNode)&&(s=s-this.designNode.getStyle("margin-top").toFloat()-this.designNode.getStyle("margin-bottom").toFloat(),this.designNode.setStyle("height",s+"px"));var l=this.toolbarTitleNode.getSize(),h=this.toolbarTitleNode.getStyle("margin-top").toFloat(),d=this.toolbarTitleNode.getStyle("margin-bottom").toFloat(),c=this.toolbarTitleNode.getStyle("padding-top").toFloat(),p=this.toolbarTitleNode.getStyle("padding-bottom").toFloat();s=l.y+h+d+c+p,s=t.y-s,this.toolbarContentNode.setStyle("height",s+"px"),l=this.propertyTitleNode.getSize(),h=this.propertyTitleNode.getStyle("margin-top").toFloat(),d=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),c=this.propertyTitleNode.getStyle("padding-top").toFloat(),p=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),s=l.y+h+d+c+p,s=t.y-s,this.propertyContentNode.setStyle("height",s+"px"),this.propertyResizeBar.setStyle("height",s+"px")},resizeNodeTopBottom:function(t){var e=this.node.getSize();this.toolbarNode.setStyle("height",e.y+"px");var o=t||.6,i=e.y*o,s=e.y-i;this.formNode.setStyle("height",i+"px"),this.propertyNode.setStyle("height",s+"px");var r=this.formToolbarNode.getStyle("margin-top").toFloat(),n=this.formToolbarNode.getStyle("margin-bottom").toFloat(),a=i-this.formToolbarNode.getComputedSize().totalHeight-r-n,l=this.designTab.tabNodeContainer.getComputedSize(),h=this.designTab.tabNodeContainer.getStyle("margin-top").toFloat(),d=this.designTab.tabNodeContainer.getStyle("margin-bottom").toFloat();if(a=a-l.totalHeight-h-d,this.designTab.contentNodeContainer.setStyle("height",a+"px"),this.designNode){var c=this.designNode.getStyle("margin-top").toFloat(),p=this.designNode.getStyle("margin-bottom").toFloat();a=a-c-p,this.designNode.setStyle("height",a+"px")}var m=this.toolbarTitleNode.getSize(),y=this.toolbarTitleNode.getStyle("margin-top").toFloat(),g=this.toolbarTitleNode.getStyle("margin-bottom").toFloat(),f=this.toolbarTitleNode.getStyle("padding-top").toFloat(),u=this.toolbarTitleNode.getStyle("padding-bottom").toFloat();if(a=m.y+y+g+f+u,a=e.y-a,this.toolbarContentNode.setStyle("height",a+"px"),m=this.propertyTitleNode.getSize(),y=this.propertyTitleNode.getStyle("margin-top").toFloat(),g=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),f=this.propertyTitleNode.getStyle("padding-top").toFloat(),u=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),a=s-(a=m.y+y+g+f+u),this.propertyContentNode.setStyle("height",a+"px"),this.propertyResizeBar.setStyle("height",a+"px"),this.propertyDomContentArea.setStyle("height",a+"px"),this.propertyDomScrollArea.setStyle("height",a+"px"),this.propertyContentResizeNode.setStyle("height",a+"px"),this.propertyContentArea.setStyle("height",a+"px"),this.form&&this.form.currentSelectedModule&&this.form.currentSelectedModule.property){var b=this.form.currentSelectedModule.property.propertyTab;if(b){var N=b.tabNodeContainer.getSize();b.pages.each(function(t){var e=t.contentNodeArea.getStyle("margin-top").toFloat(),o=t.contentNodeArea.getStyle("margin-bottom").toFloat(),i=a-e-o-N.y.toFloat()-15;t.contentNodeArea.setStyle("height",i)}.bind(this))}}},resizeNode:function(t){"bottom"==this.options.style?(this.resizeNodeTopBottom(t),this.setPropertyContentResizeBottom()):(this.resizeNodeLeftRight(t),this.setPropertyContentResize())},loadForm:function(){this.getFormData(function(){this.pcForm=new MWF.FCForm(this,this.designNode),this.pcForm.load(this.formData),this.form=this.pcForm}.bind(this))},getFormData:function(t){this.options.id?this.loadFormData(t):this.options.templateId?this.loadNewFormDataFormTemplate(t):this.loadNewFormData(t)},loadNewFormData:function(t){var e="../x_component_process_FormDesigner/Module/Form/template/"+this.options.template;MWF.getJSON(e,{onSuccess:function(e){this.formData=e.pcData,this.formData.id="",this.formData.isNewForm=!0,this.formMobileData=e.mobileData,this.formMobileData.id="",this.formMobileData.isNewForm=!0,t&&t()}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadNewFormDataFormTemplate:function(t){this.actions.getFormTemplate(this.options.templateId,function(e){e&&(this.formData=JSON.decode(MWF.decodeJsonString(e.data.data)),this.formData.isNewForm=!0,this.formData.json.id="",e.data.mobileData?(this.formMobileData=JSON.decode(MWF.decodeJsonString(e.data.mobileData)),this.formMobileData.isNewForm=!0,this.formMobileData.json.id=""):this.formMobileData=Object.clone(this.formData),t&&t())}.bind(this))},loadFormData:function(t){this.actions.getForm(this.options.id,function(e){if(e){var o=null;MWF.getJSON("../x_component_process_FormDesigner/Module/Form/template/form.json",{onSuccess:function(t){o=t}.bind(this)},!1),this.formData=JSON.decode(MWF.decodeJsonString(e.data.data)),o.pcData&&(Object.merge(o.pcData,this.formData),Object.merge(this.formData,o.pcData)),this.formData.isNewForm=!1,this.formData.json.id=e.data.id,e.data.mobileData?(this.formMobileData=JSON.decode(MWF.decodeJsonString(e.data.mobileData)),o.mobileData&&(Object.merge(o.mobileData,this.formMobileData),Object.merge(this.formMobileData,o.mobileData)),this.formMobileData.isNewForm=!1,this.formMobileData.json.id=e.data.id):this.formMobileData=Object.clone(this.formData),this.setTitle(this.options.appTitle+"-"+this.formData.json.name),this.taskitem&&this.taskitem.setText(this.options.appTitle+"-"+this.formData.json.name),this.options.appTitle=this.options.appTitle+"-"+this.formData.json.name,this.application?t&&t():this.actions.getApplication(e.data.application,function(e){this.application={name:e.data.name,id:e.data.id},t&&t()}.bind(this))}}.bind(this))},getFieldList:function(){return dataTypes={string:["htmledit","radio","select","textarea","textfield"],person:["personfield","orgfield","org"],date:["calender"],number:["number"],array:["checkbox"]},fieldList=[],this.pcForm.moduleList.each(function(t){var e="";for(k in dataTypes)if(-1!=dataTypes[k].indexOf(t.moduleName.toLowerCase())){e=k;break}e&&fieldList.push({name:t.json.id,dataType:e})}.bind(this)),fieldList},checkSubform:function(){var t=[];this.pcForm&&(this.pcForm.data.json.subformList=[],this.pcForm.moduleList.each(function(e){if("subform"===e.moduleName&&(e.json.subformSelected&&"none"!==e.json.subformSelected&&"script"!==e.json.subformType&&-1===this.pcForm.data.json.subformList.indexOf(e.json.subformSelected)&&this.pcForm.data.json.subformList.push(e.json.subformSelected),e.regetSubformData())){e.subformData.updateTime="";var o=e.getConflictFields();if(o.length){var i={id:e.json.id,fields:o};t.push(i)}}}.bind(this)));var e=[];this.mobileForm&&(this.mobileForm.data.json.subformList=[],this.mobileForm.moduleList.each(function(t){if("subform"===t.moduleName&&(t.json.subformSelected&&"none"!==t.json.subformSelected&&"script"!==t.json.subformType&&-1===this.mobileForm.data.json.subformList.indexOf(t.json.subformSelected)&&this.mobileForm.data.json.subformList.push(t.json.subformSelected),t.regetSubformData())){t.subformData.updateTime="";var o=t.getConflictFields();if(o.length){var i={id:t.json.id,fields:o};e.push(i)}}}.bind(this)));var o="";if(t.length){var i="";t.each((function(t){i+=t.id+" ( "+t.fields.join(", ")+" ) <br>"})),o+=this.lp.checkSubformPcInfor.replace("{subform}",i)}if(e.length){var s="";e.each((function(t){s+=t.id+" ( "+t.fields.join(", ")+" ) <br>"})),o+=this.lp.checkSubformMobileInfor.replace("{subform}",s)}return o},saveForm:function(){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.lp.isSave);else{var t,e,o=this.checkSubform();if(o)return o=this.lp.checkFormSaveError+o,this.notice(o,"error",this.form.node),!1;this.pcForm&&(t=this.pcForm._getFormData()),this.mobileForm?e=this.mobileForm._getFormData():this.formMobileData&&(e=this.formMobileData),this.isSave=!0;var i=this.getFieldList();this.actions.saveForm(t,e,i,function(t){this.notice(MWF.APPFD.LP.notice.save_success,"ok",null,{x:"left",y:"bottom"}),this.pcForm.json.name||this.pcForm.treeNode.setText("<"+this.json.type+"> "+this.json.id),this.pcForm.treeNode.setTitle(this.pcForm.json.id),this.pcForm.node.set("id",this.pcForm.json.id),this.mobileForm&&(this.mobileForm.json.name||this.mobileForm.treeNode.setText("<"+this.mobileForm.json.type+"> "+this.mobileForm.json.id),this.mobileForm.treeNode.setTitle(this.mobileForm.json.id),this.mobileForm.node.set("id",this.mobileForm.json.id+"_"+this.options.mode));var e=this.pcForm.json.name;this.pcForm.data.isNewForm&&this.setTitle(this.options.appTitle+"-"+e),this.pcForm.data.isNewForm=!1,this.mobileForm&&(this.mobileForm.data.isNewForm=!1),this.options.desktopReload=!0,this.options.id=this.pcForm.json.id,this.pcForm&&this.pcForm.fireEvent("postSave"),this.mobileForm&&this.mobileForm.fireEvent("postSave"),this.isSave=!1}.bind(this),function(t,e,o){this.isSave=!1,this.pcForm&&this.pcForm.fireEvent("postSaveError"),this.mobileForm&&this.mobileForm.fireEvent("postSaveError");var i=o+":"+e;t&&(i=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+i)}.bind(this))}},previewForm:function(){this.form.preview()},formExplode:function(){this.form.explode()},formImplode:function(){this.form.implode()},htmlImplode:function(){this.form.implodeHTML()},officeImplode:function(){this.form.implodeOffice()},recordStatus:function(){return{id:this.options.id}},showFormVersion:function(){this.form.showFormVersion()},clearNoDomModule:function(){var t=this;this.confirm("warn",new Event,MWF.APPFD.LP.clearNoDomModuleTitle,MWF.APPFD.LP.clearNoDomModuleContent,460,120,(function(){t.form._clearNoDomModule(),this.close()}),(function(){this.close()}))},onPostClose:function(){this.pcForm&&(MWF.release(this.pcForm.moduleList),MWF.release(this.pcForm.moduleNodeList),MWF.release(this.pcForm.moduleContainerNodeList),MWF.release(this.pcForm.moduleElementNodeList),MWF.release(this.pcForm.moduleComponentNodeList),MWF.release(this.pcForm)),this.mobileForm&&(MWF.release(this.mobileForm.moduleList),MWF.release(this.mobileForm.moduleNodeList),MWF.release(this.mobileForm.moduleContainerNodeList),MWF.release(this.mobileForm.moduleElementNodeList),MWF.release(this.mobileForm.moduleComponentNodeList),MWF.release(this.mobileForm))},setTemplateFormNode:function(t){var e='<table align="center" width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0"><tr><td colSpan="2" style="height: 50px; line-height: 60px; text-align: center; font-size: 24px; font-weight: bold">'+this.lp.saveTemplate+'</td></tr><tr><td style="height: 40px;" width="80px">'+this.lp.templateName+'</td><td><input value="'+this.pcForm.json.name+'" type="text" style="width: 98%; height: 22px; border: 1px solid #cccccc"/></td></tr><tr><td style="height: 40px;">'+this.lp.templateCategory+'</td><td><select style="width: 30%; height: 24px; border: 1px solid #cccccc"></select><input type="text" style="width: 68%; height: 22px; border: 1px solid #cccccc"/></td></tr><tr><td style="height: 40px;">'+this.lp.templateDescription+'</td><td><textarea type="text" style="width: 98%; height: 44px; border: 1px solid #cccccc">'+this.pcForm.json.description+'</textarea></td></tr><tr><td colSpan="2" id="form_templatePreview"><div style="position: relative; width: 180px; height: 180px; margin: 20px auto 0px auto;  overflow: hidden"></div></td></tr></table>';t.set("html",e);var o=t.getElements("td"),i=o[o.length-1].getFirst();return this.pcForm.node.clone().setStyles({"transform-origin":"0px 0px",transform:"scale(0.15,0.15)",position:"absolute",top:"0px",left:"0px"}).inject(i),i},setCategorySelect:function(t){t&&(new Element("option",{value:"$newCategory",text:this.lp.newCategory}).inject(t),this.actions.listFormTemplateCategory(function(e){e.data.each(function(e){new Element("option",{value:e.name,text:e.name}).inject(t)}.bind(this))}.bind(this)))},setTemplateActions:function(t,e,o,i,s,r,n,a){var l=new Element("div",{styles:this.css.templateActionNode}).inject(o);new Element("div",{styles:this.css.templateCancelActionNode,text:this.lp.cancel,events:{click:function(){t.destroy(),e.destroy()}}}).inject(l),new Element("div",{styles:this.css.templateSaveActionNode,text:this.lp.save,events:{click:function(){this.saveTemplate(t,e,i,s,r,n,a)}.bind(this)}}).inject(l)},saveTemplate:function(t,e,o,i,s,r,n){var a,l;this.pcForm&&(a=this.pcForm._getFormData()),this.mobileForm&&(l=this.mobileForm._getFormData());var h=i.get("value"),d="$newCategory"==s.options[s.selectedIndex].value?r.get("value"):s.options[s.selectedIndex].value,c=n.get("value");if(!h)return this.notice(MWF.APPFD.LP.notice.saveTemplate_inputName,"error",i,{x:"left",y:"top"}),!1;if("$newCategory"==s.options[s.selectedIndex].value&&!r.get("value"))return this.notice(MWF.APPFD.LP.notice.saveTemplate_inputCategory,"error",s,{x:"left",y:"top"}),!1;var p={name:h,category:d,description:c,outline:o.get("html")};this.actions.addFormTemplate(a,l,p,function(){this.notice(MWF.APPFD.LP.notice.saveTemplate_success,"ok",null,{x:"left",y:"bottom"}),t.destroy(),e.destroy()}.bind(this),(function(t,e,o){var i=o+":"+e;t&&(i=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+i)}))},createTemplateSaveNode:function(){var t=new Element("div",{styles:this.css.templateMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.content),e=new Element("div",{styles:this.css.templateAreaNode}).inject(this.content),o=new Element("div",{styles:this.css.templateInfoNode}).inject(e),i=new Element("div",{styles:this.css.templateFormNode}).inject(o),s=this.setTemplateFormNode(i),r=i.getElements("input"),n=r[0],a=r[1],l=i.getElement("textarea"),h=i.getElement("select");this.setCategorySelect(h),this.setTemplateActions(t,e,i,s,n,h,a,l)},saveFormAsTemplate:function(){this.isSave?MWF.xDesktop.notice("info",{x:"right",y:"top"},this.lp.isSave):this.createTemplateSaveNode()},styleBrush:function(t,e){if("on"===t){var o=this.form.currentSelectedModule;o&&"Form"!==o.json.type?(this.form.brushStyle=o.json.styles,o.json.inputStyles&&(this.form.brushInputStyle=Object.clone(o.json.inputStyles)),this.brushCursor=new Element("div",{styles:{position:"absolute",width:"16px",height:"16px","z-index":2e4,background:"url("+this.path+this.options.style+"/formtoolbar/wand.png)"}}).inject(this.content),this.brushCursorMoveFun=this.brushCursorMove.bind(this),this.contentPosition=this.content.getPosition(),this.content.addEvent("mousemove",this.brushCursorMoveFun)):e.off()}else this.form.brushStyle=null,this.form.brushInputStyle=null,this.brushCursorMoveFun&&this.content.removeEvent("mousemove",this.brushCursorMoveFun),this.brushCursor&&(this.brushCursor.destroy(),this.brushCursor=null)},brushCursorMove:function(t){if(this.brushCursor){var e=t.page.x-this.contentPosition.x+10,o=t.page.y-this.contentPosition.y+10;this.brushCursor.setStyles({left:e+"px",top:o+"px"})}}});