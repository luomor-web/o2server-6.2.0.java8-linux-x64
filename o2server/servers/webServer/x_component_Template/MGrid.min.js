MWF.xDesktop.requireApp("Template","MDomItem",null,!1);var MGrid=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isNew:!1,isEdited:!1,showNotEmptyFlag:!1,verifyType:"batch",itemTemplate:null,objectId:"",hasSequence:!0,hasOperation:!1,isCreateTh:!0,containerIsTable:!1,isCreateTrOnNull:!0,minTrCount:0,maxTrCount:0,tableAttributes:null,thAttributes:null,tdAttributes:null,textOnly:!1,tableClass:"formTable",thClass:"formTableTitle",tdClass:"formTableValue",thAlign:"center",tdAlign:"left",sequenceClass:"formTableSequence",addActionTdClass:"formTableAddTd",removeActionTdClass:"formTableRemoveTd",lp:{remove:"",add:""}},initialize:function(t,e,s,i,n){this.setOptions(s),this.path="../x_component_Template/$MGrid/",this.cssPath="../x_component_Template/$MGrid/"+this.options.style+"/css.wcss",this._loadCss(),n&&(this.css=Object.merge(this.css,n)),this.app=i,this.container=$(t),this.data=e,this.isSourceDataEmpty=!1,this.data&&""!=this.data||(this.isSourceDataEmpty=!0,this.data=[{}]),this.itemTemplate=this.options.itemTemplate,this.items=null,this.th=null,this.trIndex=0,this.trList=[],this.trObjs=null,this.trObjs_removed=null,this.trObjs_new=null,this.thTemplate=null,this.trTemplate=null,this.valSeparator=/,|;|\^\^|\|/g},load:function(){for(var t in this.fireEvent("queryLoad"),this.itemTemplate)this.itemTemplate[t].name||(this.itemTemplate[t].name=t),this.itemTemplate[t].key=t;var e={};for(var t in this.itemTemplate)t!=this.itemTemplate[t].name&&(e[this.itemTemplate[t].name]=this.itemTemplate[t]);for(var t in e)this.itemTemplate[t]=e[t];this.createTable(this.itemTemplate),this.createHead(this.itemTemplate),this.trObjs={},this.trObjs_removed={},this.trObjs_new={},this.trList=[],this.options.textOnly?this.loadTextOnly():this.options.isEdited||this.options.isNew?this.loadEdit():this.loadRead(),this.fireEvent("postLoad",[this])},setTrTemplate:function(t){"string"==typeOf(t)?this.trTemplate=$(this.string2DOM(t)[0]):this.trTemplate=$(t),this.formatStyles(this.trTemplate)},setThTemplate:function(t){"string"==typeOf(t)?this.thTemplate=$(this.string2DOM(t)[0]):this.thTemplate=$(t),this.formatStyles(this.thTemplate)},loadEdit:function(){if(this.isSourceDataEmpty)this.options.isCreateTrOnNull&&this.createTr(this.itemTemplate,!0);else{"array"!=typeOf(this.data)&&(this.data=[this.data]);for(var t=0;t<this.data.length;t++){var e=this.data[t],s=this.itemTemplate;for(var i in e)s[i]&&(s[i].value=e[i]);this.createTr(s,!1,null,e)}for(var i in this.itemTemplate)this.itemTemplate[i].value=""}},loadRead:function(){if(this.isSourceDataEmpty)this.options.isCreateTrOnNull&&this.createTr(this.itemTemplate,!0);else{"array"!=typeOf(this.data)&&(this.data=[this.data]);for(var t=0;t<this.data.length;t++){var e=this.data[t],s=this.itemTemplate;for(var i in e)s[i]&&(s[i].value=e[i]);this.createTr(s,!1,null,e)}for(var i in this.itemTemplate)this.itemTemplate[i].value=""}},loadTextOnly:function(){if(this.isSourceDataEmpty)this.options.isCreateTrOnNull&&this.createTr_textOnly(this.itemTemplate);else{"array"!=typeOf(this.data)&&(this.data=[this.data]);for(var t=0;t<this.data.length;t++){var e=this.data[t],s=this.itemTemplate;for(var i in e)s[i]&&(s[i].value=e[i]);this.createTr_textOnly(s)}}},createTable:function(t){if(this.options.containerIsTable){this.table=this.container,this.table.getElements("[lable]").each((function(e){var s=t[e.get("lable")];s&&s.text&&e.set("text",s.text)})),this.fireEvent("postCreateTable",[this])}else{var e={};this.options.tableClass&&this.css[this.options.tableClass]&&(e=this.css[this.options.tableClass]);var s=this.options.tableAttributes||{};this.table=new Element("table",{styles:e}).inject(this.container),this.table.set(s),this.fireEvent("postCreateTable",[this])}},createHead:function(t){this.options.isCreateTh&&(this.thTemplate?this.createHead_byTemplate(t):this.createHead_noTemplate(t))},createHead_byTemplate:function(t){var e=this.options.showNotEmptyFlag,s=this.options.isEdited,i=this.tableHead=this.thTemplate;if(i.getElements("[lable]").each((function(i){var n=i.get("lable"),a=t[n];a&&(a.text&&i.set("text",a.text),e&&t[n].notEmpty&&s&&new Element("span",{styles:{color:"red"},text:"*"}).inject(i))})),this.options.hasOperation&&s){var n=i.getElement("[button_add]");n&&this.createAddButton(n)}i.inject(this.table)},createHead_noTemplate:function(t){var e=this.tableHead=new Element("tr"),s=""==this.options.thAlign?{}:{align:this.options.thAlign},i=this.options.thClass&&this.css[this.options.thClass]?this.css[this.options.thClass]:{};this.options.hasSequence&&((o=new Element("th",{text:MWF.xApplication.Template.LP.MGrid.sequence}).inject(e)).set(s),o.setStyles(i));var n=1;for(var a in this.itemTemplate){this.options.thAttributes&&this.options.thAttributes["_"+n]&&this.options.thAttributes["_"+n];var o=new Element("th").inject(e);this.options.showNotEmptyFlag&&this.itemTemplate[a].notEmpty&&this.options.isEdited&&new Element("span",{styles:{color:"red",text:"*"}}).inject(o),o.set(s),o.setStyles(i),this.itemTemplate[a].text&&o.set("text",this.itemTemplate[a].text),n++}if(this.options.hasOperation&&this.options.isEdited){o=new Element("th",{align:"center",styles:{width:"24px",styles:{"text-align":"center"}}}).inject(e);this.options.addActionTdClass&&this.css[this.options.addActionTdClass]&&o.setStyles(this.css[this.options.addActionTdClass]),this.createAddButton(o)}e.inject(this.table),this.fireEvent("postCreateHead",[e])},createAddButton:function(t){var e=new Element("div",{title:MWF.xApplication.Template.LP.MGrid.add}).inject(t);return this.options.lp.add&&e.set("text",this.options.lp.add),this.css.actionAdd&&e.setStyles(this.css.actionAdd),e.addEvent("click",function(t){this.fireEvent("queryAddTr"),this.createTr(this.itemTemplate,!0),this.fireEvent("postAddTr")}.bind(this)),this.css.actionAdd&&this.css.actionAdd_over&&e.addEvents({mouseover:function(t){this.node.setStyles(this.obj.css.actionAdd_over)}.bind({node:e,obj:this}),mouseout:function(t){this.node.setStyles(this.obj.css.actionAdd)}.bind({node:e,obj:this})}),e},addTrs:function(t){100<t&&(t=100);for(var e=0;e<t;e++)this.createTr(this.itemTemplate,!0)},appendTr:function(t,e,s,i){var n=this.itemTemplate;for(var a in t)n[a]&&(n[a].value=t[a]);for(var a in this.createTr(n,e,s,i),this.itemTemplate)this.itemTemplate[a].value=""},getTrCounts:function(){return this.trList.length},createTr:function(t,e,s,i){if(this.options.maxTrCount){if(this.getTrCounts()<this.options.maxTrCount)this._createTr(t,e,s,i);else if(this.app&&this.app.notice){var n=MWF.xApplication.Template.LP.MGrid.addMaxLimitText.replace("{count}",this.options.maxTrCount);this.app.notice(n,"error")}}else this._createTr(t,e,s,i)},_createTr:function(t,e,s,i){var n;if(this.fireEvent("queryCreateTr",[this]),e&&(this.fireEvent("newData",[this,function(t){n=t}.bind(this)]),n)){for(var a in t=Object.clone(this.itemTemplate),n)t[a]&&(t[a].value=n[a]);e=!1,i=n}this.trIndex++;var o={objectId:s||"_"+this.trIndex,isEdited:this.options.isEdited,id:"_"+this.trIndex,index:this.trIndex,indexText:this.maxIndexText?this.maxIndexText++:this.trIndex,hasSequence:this.options.hasSequence,hasOperation:this.options.hasOperation,align:this.options.tdAlign,isNew:e,className:this.options.tdClass,tdAttributes:this.options.tdAttributes},r=null;this.trTemplate&&(r=this.trTemplate.clone());var h=new MGridTr(this.table,o,t,this,r,i);h.load(),this.trObjs[o.objectId]=h,this.trList.push(h),e&&(this.trObjs_new[o.objectId]=h),this.fireEvent("postCreateTr",[this,h])},replaceTr:function(t,e,s,i,n){var a;a="string"==typeof t?this.trObjs[t]:t;var o=this.itemTemplate;for(var r in e)o[r]&&(o[r].value=e[r]);var h=a.options.index,l={objectId:i||"_"+h,isEdited:this.options.isEdited,id:"_"+h,index:h,indexText:h,hasSequence:this.options.hasSequence,hasOperation:this.options.hasOperation,align:this.options.tdAlign,isNew:s,className:this.options.tdClass,tdAttributes:this.options.tdAttributes},p=null;this.trTemplate&&(p=this.trTemplate.clone());var c=new MGridTr(this.table,l,o,this,p,n);c.load(),c.mElement.inject(a.mElement,"before");var d=this.trList.indexOf(a);for(var r in this.trList[d]=c,this.trObjs[l.objectId]=c,a.options.isNew?this.trObjs_new[a.options.objectId]=null:this.trObjs_removed[a.options.objectId]=a,s&&(this.trObjs_new[l.objectId]=c),a.mElement.destroy(),this.itemTemplate)this.itemTemplate[r].value=""},createRemoveButton:function(t,e){var s=new Element("div",{title:MWF.xApplication.Template.LP.MGrid.delete}).inject(e);return this.options.lp.remove&&s.set("text",this.options.lp.remove),this.css.actionRemove&&s.setStyles(this.css.actionRemove),s.addEvents({click:function(e){this.removeTr(e,e.target,t)}.bind(this)}),this.css.actionRemove&&this.css.actionRemove_over&&s.addEvents({mouseover:function(t){this.node.setStyles(this.obj.css.actionRemove_over)}.bind({node:s,obj:this}),mouseout:function(t){this.node.setStyles(this.obj.css.actionRemove)}.bind({node:s,obj:this})}),s},removeTr:function(t,e,s){this.fireEvent("queryRemoveTr",[t,e,s]);var i=s.options,n=i.objectId;i.isNew||(this.trObjs_removed[n]=this.trObjs[n]),this.trList.erase(s),this.trObjs[n]=null,this.trObjs_new[n]&&(this.trObjs_new[n]=null),s.destroy(),this.adjustSequenceText(),this.fireEvent("postRemoveTr",[t,e,s])},replaceText:function(t,e,s){for(var i="array"==typeOf(t)?t:t.split(this.valSeparator),n="array"==typeOf(e)?e:e.split(this.valSeparator),a="array"==typeOf(s)?s:s.split(this.valSeparator),o=0;o<i.length;o++)for(var r=0;r<n.length;r++)i[o]==n[r]&&(i[o]=a[r]);return i},createTr_textOnly:function(t){this.trIndex++,this.trTemplate?this.createTr_textOnly_byTemplate(t):this.createTr_textOnly_noTemplate(t)},createTr_textOnly_byTemplate:function(t){var e=this.trTemplate.clone();e.set("data-id","_"+this.trIndex);var s=e.getElements("[lable]"),i=e.getElements("[item]"),n=e.getElements("[sequence]");s.each((function(e){var s=t[e.get("lable")];s&&s.text&&e.set("text",s.text)})),i.each(function(e){var s=t[e.get("item")];if(s){var i=s.value?s.value:"",n=typeOf(i);if("string"===n&&(i=i.replace(/\n/g,"<br/>")),s.selectValue&&s.selectText)i=this.replaceText(i,s.selectValue,s.selectText).join(",");else"string"===n&&(i=i.replace(this.valSeparator,","));e.set("html",i)}}.bind(this)),n.set("text",this.trIndex),e.inject(this.table)},createTr_textOnly_noTemplate:function(t){var e=new Element("tr",{"data-id":"_"+this.trIndex});if(this.options.hasSequence){var s=new Element("td",{align:"center",text:this.trIndex}).inject(e);this.options.sequenceClass&&this.css[this.options.sequenceClass]&&s.setStyles(this.css[this.options.sequenceClass])}this.options.tdAlign&&this.options.tdAlign;var i=1;for(var n in t){var a={};this.options.tdAttributes&&this.options.tdAttributes["_"+i]&&(a=this.options.tdAttributes["_"+i]);var o=t[n],r=o.value||"",h=typeOf(r);if("string"===h&&(r=r.replace(/\n/g,"<br/>")),o.selectValue&&o.selectText)r=this.replaceText(r,o.selectValue,o.selectText).join(",");else"string"===h&&(r=r.replace(this.valSeparator,","));(s=new Element("td",a).inject(e)).set("text",r),this.options.tdAlign&&s.set("align",this.options.tdAlign),this.options.tdClass&&this.css[this.options.tdClass]&&s.setStyles(this.css[this.options.tdClass]),i++}e.inject(this.table)},getResult:function(t,e,s,i,n){var a=[],o=this.trObjs,r=!0;for(var h in o)if(h&&o[h]){var l=o[h].getResult(t,e,s,i,n);if(l)a.push(l);else{if("batch"!=this.options.verifyType)return!1;r=!1}}return!!r&&a},enableItem:function(t){for(var e in this.trObjs)e&&this.trObjs[e]&&this.trObjs[e].enableItem(t)},disableItem:function(t){for(var e in this.trObjs)e&&this.trObjs[e]&&this.trObjs[e].disableItem(t)},adjustSequenceText:function(){var t=[];for(var e in this.trObjs)e&&this.trObjs[e]&&t.push(this.trObjs[e]);t.sort((function(t,e){return t.options.index-e.options.index})),t.each(function(t,e){t.setSequenceText(e+1),this.maxIndexText=e+2}.bind(this))},string2DOM:function(t,e,s){var i=t.test("^<the|^<tf|^<tb|^<colg|^<ca")&&["<table>","</table>",1]||t.test("^<col")&&["<table><colgroup>","</colgroup><tbody></tbody></table>",2]||t.test("^<tr")&&["<table><tbody>","</tbody></table>",2]||t.test("^<th|^<td")&&["<table><tbody><tr>","</tr></tbody></table>",3]||t.test("^<li")&&["<ul>","</ul>",1]||t.test("^<dt|^<dd")&&["<dl>","</dl>",1]||t.test("^<le")&&["<fieldset>","</fieldset>",1]||t.test("^<opt")&&['<select multiple="multiple">',"</select>",1]||["","",0];if(e){for(var n=new Element("div",{html:i[0]+t+i[1]}).getChildren();i[2]--;)n=n[0].getChildren();return n.inject(e),s&&s(e),n}var a=new Element("div",{html:i[0]+t+i[1]});a.setStyle("display","none").inject($(document.body)),s&&s(a);for(n=a.getChildren();i[2]--;)n=n[0].getChildren();return a.dispose(),n},formatStyles:function(t){t.getElements("[styles]").each(function(t){var e=t.get("styles");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this)),t.getElements("[class]").each(function(t){var e=t.get("class");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))}}),MGridTr=new Class({Implements:[Options,Events],options:{objectId:"",isEdited:!0,id:"",index:0,indexText:"0",hasSequence:!0,hasOperation:!0,align:"left",isNew:!0,className:"",tdAttributes:null},initialize:function(t,e,s,i,n,a){this.setOptions(e),this.container=t,this.mElement=null,this.items={},this.itemData=s,this.parent=i,this.template=n,this.sourceData=a,this.css=this.parent.css||{},this.app=this.parent.app},load:function(){this.create()},reload:function(t){t||(t=this.getResult(!1,null,!1,!1,!0)),this.parent.replaceTr(this,t,this.options.isNew,this.options.objectId,this.sourceData)},create:function(t,e){this.template?this.create_byTemplate(t,e):this.create_noTemplate(t,e)},setSequenceText:function(t){this.sequenceTd&&this.sequenceTd.set("text",t)},create_byTemplate:function(){if(this.mElement=this.template,this.mElement.set("data-id",this.options.id),this.options.hasSequence&&(this.sequenceTd=this.mElement.getElement("[sequence]"),this.sequenceTd&&this.sequenceTd.set("text",this.options.indexText||this.options.index)),this.mElement.getElements("[lable]").each(function(t){var e=this.itemData[t.get("lable")];e&&e.text&&t.set("text",e.text)}.bind(this)),this.mElement.getElements("[item]").each(function(t){var e=this.itemData[t.get("item")];e&&this.createItem(t,e)}.bind(this)),this.options.hasOperation&&this.options.isEdited&&this.parent.options.minTrCount&&this.options.index>this.parent.options.minTrCount){var t=this.mElement.getElement("[button_remove]");this.parent.createRemoveButton(this,t)}this.mElement.setStyle("display",""),this.mElement.inject(this.container)},create_noTemplate:function(){this.mElement=new Element("tr",{"data-id":this.options.id});var t={};this.options.align&&(t.align=this.options.align);var e={};if(this.options.className&&this.css[this.options.className]&&(e=this.css[this.options.className]),this.options.hasSequence){var s=this.sequenceTd=new Element("td",{align:"center",text:this.options.indexText||this.options.index}).inject(this.mElement);this.parent.options.sequenceClass&&this.css[this.parent.options.sequenceClass]&&s.setStyles(this.css[this.parent.options.sequenceClass])}var i=1;for(var n in this.itemData){var a=this.options.tdAttributes&&this.options.tdAttributes["_"+i]?this.options.tdAttributes["_"+i]:{};(s=new Element("td").inject(this.mElement)).set(t),s.set(a),s.setStyles(e);var o=this.itemData[n];this.createItem(s,o),i++}if(this.options.hasOperation&&this.options.isEdited)if(this.parent.options.minTrCount&&this.options.index>this.parent.options.minTrCount){var r=new Element("td",{align:"center",style:{width:"30px"}}).inject(this.mElement);(h=this.parent.options.removeActionTdClass)&&this.css[h]&&r.setStyles(this.css[h]),this.parent.createRemoveButton(this,r)}else{var h;r=new Element("td").inject(this.mElement);(h=this.parent.options.removeActionTdClass)&&this.css[h]&&r.setStyles(this.css[h])}this.mElement.inject(this.container)},createItem:function(t,e){e.isEdited=this.options.isEdited,e.objectId=e.name;var s=new MDomItem(t,e,this,this.app,this.css);this.options.isEdited&&("batchSingle"==this.parent.options.verifyType?s.options.warningType="single":s.options.warningType=this.parent.options.verifyType),s.options.name=e.name+"_"+this.options.index,s.index=this.options.index,s.parent=this,s.load(),this.items[e.objectId]=s},destroy:function(){Object.each(this.items,function(t){t.destroy()}.bind(this)),this.mElement.destroy(),MWF.release(this)},enableItem:function(t){if(t&&this.items[t]){var e=this.items[t];e.options.disable&&e.enable()}},disableItem:function(t){if(t&&this.items[t]){var e=this.items[t];e.options.disable||e.disable()}},getPrevSilbing:function(){var t=this.parent.trList.indexOf(this);return t>0?this.parent.trList[t-1]:null},getNextSilbing:function(){var t=this.parent.trList.indexOf(this);return-1!=t&&t<this.parent.trList.length-1?this.parent.trList[t+1]:null},verify:function(t){var e=!0;for(var s in this.items)if(!this.items[s].verify(t)){if("batch"!=this.parent.options.verifyType&&"batchSingle"!=this.parent.options.verifyType)return!1;e=!1}return e},getItemsKeyValue:function(t,e){var s={};for(var i in this.items){var n=this.items[i],a=e?n.getModifiedValue():n.getValue();null!=a&&("array"===typeOf(a)?s[n.options.objectId]="string"==typeOf(t)?a.join(t):a:s[n.options.objectId]=a)}return s},getResult:function(t,e,s,i,n){if(!t||this.verify(s)){if(n&&this.sourceData){var a=this.sourceData,o=this.getItemsKeyValue(e,i);for(var r in o)a[r]=o[r];return a}return this.getItemsKeyValue(e,i)}return!1}});