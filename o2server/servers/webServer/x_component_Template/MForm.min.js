MWF.xDesktop.requireApp("Template","MDomItem",null,!1);var MForm=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isNew:!1,isEdited:!1,emptyItemContainer:!0,showNotEmptyFlag:!1,verifyType:"alert",itemTemplateUrl:"",containerHtml:null,itemTemplate:null,hasColon:!1},initialize:function(t,e,i,s,a){this.setOptions(i),this.path="../x_component_Template/$MForm/",this.cssPath="../x_component_Template/$MForm/"+this.options.style+"/css.wcss",this._loadCss(),a&&(this.css=Object.merge(this.css,a)),this.app=s,this.container=$(t),this.data=e,this.isSourceDataEmpty=!1,this.data&&""!=this.data||(this.isSourceDataEmpty=!0,this.data=[{}]),this.itemTemplateUrl=this.options.itemTemplateUrl,this.itemTemplate=this.options.itemTemplate,this.items=null,this.labelContainers=null,this.itemContainers=null,this.valSeparator=/,|;|\^\^|\|/g},load:function(){this.fireEvent("queryLoad"),this.loadTemplate(function(){for(var t in this.itemTemplate)this.itemTemplate[t].name||(this.itemTemplate[t].name=t),this.itemTemplate[t].key=t;var e={};for(var t in this.itemTemplate)t!=this.itemTemplate[t].name&&(e[this.itemTemplate[t].name]=this.itemTemplate[t]);for(var t in e)this.itemTemplate[t]=e[t];this.items={},this.itemsByKey={},this.options.containerHtml&&this.container.set("html",this.options.containerHtml),this.labelContainers=this.container.getElements("[lable]"),this.itemContainers=this.container.getElements("[item]"),this.formatStyles(),this.options.isEdited||this.options.isNew?this.loadEdit():this.loadRead(),this.fireEvent("postLoad")}.bind(this))},formatStyles:function(){this.container.getElements("[styles]").each(function(t){var e=t.get("styles");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this)),this.container.getElements("[class]").each(function(t){var e=t.get("class");e&&this.css[e]&&t.setStyles(this.css[e])}.bind(this))},loadTemplate:function(t){!this.itemTemplate&&this.itemTemplateUrl?MWF.getJSON(this.itemTemplateUrl,function(e){this.itemTemplate=e,t&&t()}.bind(this)):t&&t()},loadEdit:function(){if(this.options.isNew)this.formatEdit(this.itemTemplate,!0);else if(this.isSourceDataEmpty)this.formatEdit(this.itemTemplate,!0);else{"array"!=typeOf(this.data)&&(this.data=[this.data]);for(var t=0;t<this.data.length;t++){var e=this.data[t],i=this.itemTemplate;for(var s in e)i[s]&&(i[s].value=e[s]);this.formatEdit(i,!1)}for(var s in this.itemTemplate)this.itemTemplate[s].value=""}},loadRead:function(){if(this.options.isNew)this.formatRead(this.itemTemplate);else if(!this.isSourceDataEmpty){"array"!=typeOf(this.data)&&(this.data=[this.data]);for(var t=0;t<this.data.length;t++){var e=this.data[t],i=this.itemTemplate;for(var s in e)i[s]&&(i[s].value=e[s]);this.formatRead(i)}for(var s in this.itemTemplate)this.itemTemplate[s].value=""}},formatRead:function(t){var e=this;this.labelContainers.each((function(i){var s=t[i.get("lable")];s&&i.set("text",s.text+(e.options.hasColon?"：":""))})),this.itemContainers.each((function(i){var s=t[i.get("item")];s&&(e.options.emptyItemContainer&&i.set("html",""),s.isEdited=!1,e.loadItem(s,i))}))},_getSelectOpt:function(t){var e=t;return"function"==typeOf(e)&&(e=e.call()),"array"==typeOf(e)?e:e.split(this.valSeparator)},formatEdit:function(t,e,i){var s=this;this.labelContainers.each((function(e){var i=t[e.get("lable")];if(i){var a=i.text+(s.options.hasColon?"：":"");s.options.showNotEmptyFlag&&i.notEmpty?e.set("html",a+"<span style='color:red;'>*</span>"):e.set("text",a)}})),this.itemContainers.each((function(e){var i=t[e.get("item")];i&&(s.options.emptyItemContainer&&e.set("html",""),s.loadItem(i,e))}))},loadItem:function(t,e){t.objectId=t.name;var i=new MDomItem(e,t,this,this.app,this.css);"batchSingle"==this.options.verifyType?i.options.warningType="single":i.options.warningType=this.options.verifyType,i.load(),this.items[t.objectId]=i,this.itemsByKey[t.key]=i},enableItem:function(t){if(t&&this.items[t]){var e=this.items[t];e.options.disable&&e.enable()}},disableItem:function(t){if(t&&this.items[t]){var e=this.items[t];e.options.disable||e.disable()}},verify:function(t){var e=!0;for(var i in this.items)if(!this.items[i].verify(t)){if("batch"!=this.options.verifyType&&"batchSingle"!=this.options.verifyType)return!1;e=!1}return e},getItemsKeyValue:function(t,e){var i={};for(var s in this.items){var a=this.items[s],n=e?a.getModifiedValue():a.getValue();null!=n&&("array"===typeOf(n)?i[a.options.objectId]="string"==typeOf(t)?n.join(t):n:i[a.options.objectId]=n)}return i},getResult:function(t,e,i,s,a){if(!t||this.verify(i)){if(a){var n=this.data[0],o=this.getItemsKeyValue(e,s);for(var r in o)n[r]=o[r];return n}return this.getItemsKeyValue(e,s)}return!1},getItem:function(t){return this.items[t]||this.itemsByKey[t]},clearWarning:function(t){for(var e in this.items){var i=this.items[e];t?i.clearWarning(t):(i.clearWarning("empty"),i.clearWarning("invalid"))}},reset:function(){for(var t in this.items){this.items[t].reset()}},destroy:function(){Object.each(this.items,function(t){t.destroy()}.bind(this)),this.container.empty(),MWF.release(this)}});