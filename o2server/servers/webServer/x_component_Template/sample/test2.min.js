MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("cms.Module","ExcelForm",null,!1),this.define("dipatchNumberToCity",function(){var t=this.getSelectedId();if(0!=t.length){var e=this.getLevel1Unit(),i=[];e.each((function(t){i.push({name:t.name,id:t.distinguishedName})})),MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var n={count:1,title:"选择分配的组织",selectableItems:i,values:[],onComplete:function(e){if(e&&0!=e.length){var i=e[0].data.id;i&&this.saveDocList(t,i,"","")}}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.form.app.content,n).load()}else this.form.app.notice("先选择号码","error")}.bind(this)),this.define("dipatchNumberToCounty",function(t,e){var i=this.getSelectedId();if(0!=i.length){var n=[];if(t)this.org.listSubUnit(t,!1).each((function(t){n.push({name:t.name,id:t.distinguishedName})}));if(t){MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var o={count:1,title:"选择分配的组织",selectableItems:n,values:[],onComplete:function(e){if(e&&0!=e.length){var n=e[0].data.id;this.saveDocList(i,t,n,"")}}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.form.app.content,o).load()}else{MWF.xDesktop.requireApp("Selector","package",null,!1);o={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(t){if(t&&0!=t.length){var e=t[0].data.distinguishedName,n=t[0].data.levelName;if(2!=n.split("/").length)return this.form.app.notice("请选择县级分公司","error"),!1;this.getAllUnit();var o=this.name_dnName[n.split("/")[0]];this.saveDocList(i,o,e,"")}}.bind(this)};e&&(o.units=[e]);new MWF.O2Selector(this.form.app.content,o)}}else this.form.app.notice("先选择号码","error")}.bind(this)),this.define("dipatchNumberToBranch",function(t,e){var i=this.getSelectedId();if(0!=i.length){var n=[];if(t)this.org.listSubUnit(t,!1).each((function(t){n.push({name:t.name,id:t.distinguishedName})}));if(t){MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var o={count:1,title:"选择分配的组织",selectableItems:n,values:[],onComplete:function(e){if(e&&0!=e.length){var n=e[0].data.id;this.getAllUnit();var o=this.dnName_levelName[n];if(3!=o.split("/").length)return this.form.app.notice("请选择网格","error"),!1;var s=this.name_dnName[o.split("/")[0]];this.saveDocList(i,s,t,n)}}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.form.app.content,o).load()}else{MWF.xDesktop.requireApp("Selector","package",null,!1);o={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(t){if(t&&0!=t.length){var e=t[0].data.distinguishedName;this.getAllUnit();var n=this.dnName_levelName[e];if(3!=n.split("/").length)return this.form.app.notice("请选择网格","error"),!1;var o=this.name_dnName[n.split("/")[0]],s=this.name_dnName[n.split("/")[1]];this.saveDocList(i,o,s,e)}}.bind(this)};e&&(o.units=[e]);new MWF.O2Selector(this.form.app.content,o)}}else this.form.app.notice("先选择号码","error")}.bind(this)),this.define("saveDocList",function(t,e,i,n){if(t.each(function(t){var o=this.form.selectedItemJson[t],s={docStatus:"published",city:e,county:i,branch:n};this.form.statJson||(this.form.statJson=new StatJson(this)),this.form.statJson.changeData(s,o,o.batch),this.form.statJson.submit()}.bind(this)),"error"==this.form.currentView.docStatus){var o=0;t.each(function(s){this.saveDoc(s,e,i,n,function(){++o==t.length&&this.setUploadedUnit(function(){this.form.app.notice("分配成功",""),this.createImportBatchDiv(),this.loadStatTable(this.statTableOptions?this.statTableOptions.container:this.form.get("statContaienr").node),this.form.view.reload(),this.form.view.selectedItems=[],this.form.view_error&&(this.form.view_error.reload(),this.form.view_error.selectedItems=[])}.bind(this))}.bind(this))}.bind(this))}else this.saveDcc(t,["city","county","branch"],[e,i,n],function(){this.setUploadedUnit(function(){this.form.app.notice("分配成功",""),this.createImportBatchDiv(),this.loadStatTable(this.statTableOptions?this.statTableOptions.container:this.form.get("statContaienr").node),this.form.currentView.reload(),this.form.currentView.selectedItems=[]}.bind(this))}.bind(this))}.bind(this)),this.define("saveDoc",function(t,e,i,n,o){MWF.Actions.get("x_cms_assemble_control").getDocument(t,function(t){var s=t.data;s.data.city=e,s.data.county=i,s.data.branch=n,s.data.errorText="",s.data.docStatus="published",s.data.status="成功",s.data.title=s.data.subject,delete s.data.$document,delete s.document.viewCount,delete s.document.publishTime,delete s.document.hasIndexPic,delete s.document.readPersonList,delete s.document.readUnitList,delete s.document.readGroupList,delete s.document.authorPersonList,delete s.document.authorUnitList,delete s.document.authorGroupList,delete s.document.managerList,delete s.document.pictureList,delete s.documentLogList,delete s.isAppAdmin,delete s.isCategoryAdmin,delete s.isManager,delete s.isCreator,delete s.isEditor,s.document.docData=s.data,delete s.data,s.document.docStatus="published",s.document.subject=s.document.title,MWF.Actions.get("x_cms_assemble_control").updateDocument(s.document,function(){o&&o()}.bind(this))}.bind(this))}.bind(this)),this.define("dipatchNumber",(function(){var t=this.getSelectedId();if(0!=t.length){var e=this.getSubUnit();if(e){MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var i={count:1,title:"选择分配的组织",selectableItems:e,values:[],onComplete:function(e){if(e&&0!=e.length){var i=e[0].data.id;this.setUnit(t,i)}}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.form.app.content,i).load()}else{MWF.xDesktop.requireApp("Selector","package",null,!1);i={count:1,title:"选择分配的组织",type:"unit",values:[],onComplete:function(e){if(e&&0!=e.length){var i=e[0].data.distinguishedName;this.setUnit(t,i)}}.bind(this)},new MWF.O2Selector(this.form.app.content,i)}}else this.form.app.notice("先选择号码","error")})),this.define("getSelectedId",(function(){var t=[];return this.form.currentView||(this.form.currentView=this.form.view),this.form.selectedItemJson={},this.form.currentView.selectedItems.each(function(e){t.push(e.data.bundle),this.form.selectedItemJson[e.data.bundle]={batch:e.data.data.batch,city:e.data.data.city,county:e.data.data.county,branch:e.data.data.branch,docStatus:this.form.currentView.docStatus||"published"}}.bind(this)),t})),this.define("getSubUnit",(function(){var t=this.data.currentUnit;if(t)var e=this.org.listSubUnit(t,!1);else{if(this.data.newFlag)return null;e=this.getLevel1Unit()}var i=[];return e.each((function(t){i.push({name:t.name,id:t.distinguishedName})})),i})),this.define("getLevel1Unit",function(t){var e=[];return new this.Action("x_organization_assemble_express",{lookup:{uri:"/jaxrs/unit/list/level/object",method:"POST"}}).invoke({name:"lookup",parameter:{},data:{levelList:["1"]},success:function(i){e=i.data,t&&t(i)}.bind(this),async:!1}),e}.bind(this)),this.define("setUnit",(function(t,e){if(e){var i,n=this.data.flag||this.data.newFlag;n?"city"==n?i="county":"county"==n&&(i="branch"):i="city",this.saveDcc(t,i,e,function(){var t=this.data[i+"TaskPerson"],n=[];(t.length?t:[]).each(function(t){n.push("string"==typeOf(t)?t:t.distinguishedName)}.bind(this)),n.push(e),n=n.unique(),this.data[i+"TaskPerson"]=n,this.form.app.notice("分配成功",""),this.form.save(),this.form.view.reload(),this.form.view.selectedItems=[]}.bind(this))}})),this.define("saveDcc",function(t,e,i,n){var o=new this.Action("x_cms_assemble_control",{save:{uri:"/jaxrs/document/batch/data/modify",method:"PUT"}}),s=[];if("array"==typeOf(e))for(var r=0;r<e.length;r++)s.push({dataPath:e[r],dataType:"String",dataString:i[r],dataInteger:null,dataBoolean:null,dataDate:null});else s.push({dataPath:e,dataType:"String",dataString:i,dataInteger:null,dataBoolean:null,dataDate:null});o.invoke({name:"save",data:{docIds:t,dataChanges:s},success:function(t){n&&n(t)}.bind(this)})}.bind(this)),MWF.require("MWF.xDesktop.Actions.RestActions",null,!1);var ChannelTaskPhoneService=new Class({Extends:MWF.xDesktop.Actions.RestActions,initialize:function(t,e){this.context=t,this.serviceUrl="http://localhost:8080/channeltask/",this.importUrl=this.serviceUrl+"import",this.phoneUrl=this.serviceUrl+"phone",this.importcheckUrl=this.serviceUrl+"importcheck"},import:function(t,e,i,n,o){this.invoke({method:"POST",uri:this.importUrl,async:o,enctype:"formdata",data:t,file:e,withCredentials:!0,success:function(t){i&&i(t)},failure:function(){}}),n&&window.setTimeout(function(){this.importcheck(n)}.bind(this),1e3)},importcheck:function(t){this.invoke({method:"GET",uri:this.importUrl+"?workId"+this.workId,async:!0,withCredentials:!0,success:function(e){t&&t(e)},failure:function(){}})},listByImportbatchName:function(t,e,i,n,o){this.phoneAction("list",{importbatchName:t,start:e,end:i,docStatus:n},o)},listByWork:function(t,e,i,n){this.phoneAction("list",{workId:this.workId,start:t,end:e,docStatus:i},n)},listByWorkAndCity:function(t,e,i,n,o){this.phoneAction("list",{workId:this.workId,city:t,start:e,end:i,docStatus:n},o)},listByWorkAndCounty:function(t,e,i,n,o){this.phoneAction("list",{workId:this.workId,county:t,start:e,end:i,docStatus:n},o)},listByWorkAndBranch:function(t,e,i,n,o){this.phoneAction("list",{workId:this.workId,branch:t,start:e,end:i,docStatus:n},o)},deleteByImportbatchName:function(t,e){this.phoneAction("delete",{importbatchName:t},e)},deleteByWorkId:function(t){this.phoneAction("delete",{workId:this.workId},t)},dispatch:function(t,e,i,n,o){this.phoneAction("dispatch",{workId:this.workId,branch:t,start:e,end:i,docStatus:n},o)},phoneAction:function(t,e,i){var n="";for(var o in e)e[o]&&(n=n+"&"+o+"="+e[o]);this.invoke({method:"GET",uri:this.phoneUrl+"?action="+t+n,async:!0,withCredentials:!0,success:function(t){i&&i(t)},failure:function(){}})},invoke:function(t){var e=t.method||"GET",i=t.uri,n=!1!==t.async,o=new MWF.xDesktop.Actions.RestActions.Callback(t.success,t.failure);if(!t.enctype||"formdata"!=t.enctype.toLowerCase()){var s=t.data?JSON.encode(t.data):"",r=!0;return!1===t.withCredentials&&(r=!1),MWF.restful(e,i,s,o,n,r)}this.invokeFormData(e,i,t.data,t.file,o,n)}}),UploadExcelDialog=new Class({Extends:MWF.xApplication.cms.Module.ImportForm,Implements:[Options,Events],options:{style:"minder",width:"650",height:"430",hasTop:!0,hasIcon:!1,draggable:!0,maxAction:!0,title:"导入号码"},_createTableContent:function(){this.formTableContainer.setStyles({margin:"0px auto 20px atuo"});this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable' style='margin-top: 20px; '><tr><td styles='formTableTitle' width='20%'>说明：</td>    <td styles='formTableValue' colspan='3' width='80%' style='font-size:12px;color:#666;line-height:20px;'>       您可以直接在Excel表格里填写地市分公司、区县分公司和网格的名称，系统会以您导入的分公司名称进行流转分发。<br/>请注意填写的名称需要与系统内的分公司/组织名称一致。<div item='openUnit''></div><div item='url2'></div></td></tr><tr><td styles='formTableTitle' lable='url' width='20%'></td>    <td styles='formTableValue' item='url' colspan='3' width='80%'></td></tr><tr><td styles='formTableTitle' lable='file' ></td>    <td styles='formTableValue' colspan='3'><div item='filename'></div><div item='file'></div></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",null,!1),this.form=new MForm(this.formTableArea,{},{isEdited:!0,style:"cms",hasColon:!0,itemTemplate:{openUnit:{type:"Innerhtml",value:"<a href='javascript:void(0)'>点击查看组织名称</a>",event:{click:function(t,e){layout.desktop.openApplication(e,"Org",{onQueryLoad:function(){this.status={navi:0}}})}.bind(this)}},url2:{type:"Innerhtml",text:"下载模板",value:"<a target='_blank' href='../x_component_cms_Module/$ExcelForm/"+encodeURIComponent("Excel导入合法性说明.xls")+"'>点击查看校验说明</a>"},url:{type:"Innerhtml",text:"下载模板",value:"<a target='_blank' href='../x_component_cms_Module/$ExcelForm/"+encodeURIComponent("Excel模板下载.xls")+"'>Excel模板下载</a>"},file:{type:"button",value:"选择Excel文件",text:"选择文件",event:{click:function(){this.selectFile()}.bind(this)}}}},this.app),this.form.load()},_setCustom:function(){this.formBottomNode.setStyles({margin:"0px auto 0px auto",width:"300px"})},ok:function(t){if(this.formData){var e=layout.desktop.session.user,i=e.identityList&&e.identityList.length>0?e.identityList[0]:{},n={workName:this.data.workName,workId:this.data.workId,jobId:this.data.jobId,creatorPerson:e.distinguishedName,creatorIdentity:i.distinguishedName,creatorUnitName:i.unitLevelName.replace(/[\/]/,"^^")};if(!this.isSetData){for(var o in n)this.formData.append(o,n[o]);this.isSetData=!0}this.loadProgressBar();var s=function(t){var e=this.context.form;this.progressBar.setProgress(js.data.processTotal,js.data.dataTotal,"正在导入数据");var i=this.context.data.importBatchNames?this.context.data.importBatchNames.split(","):[];i.push(n.data.importBatchName),this.context.data.importBatchNames=i.toString(),this.context.form.save(),this.progressBar.gotoStep(3),this.setResult(),e.statJson||(e.statJson=new StatJson(this.context)),e.statJson.addBatch(importBatchName,!0),e.statJson.submit(),this.context.setUploadedUnit(function(){e.view.reload(),e.view.selectedItems=[],e.view_error&&(e.view_error.reload(),e.view_error.selectedItems=[]),this.context.createImportBatchDiv(),this.context.loadStatTable(this.context.statTableOptions?this.context.statTableOptions.container:this.context.form.get("statContaienr").node)}.bind(this)),this.formData=null,this.file=null}.bind(this),r=function(t){this.progressBar.setProgress(js.data.processTotal,js.data.dataTotal,"正在导入数据")}.bind(this);new ChannelTaskPhoneService(this.context,this.data.workId).import(this.formData,this.file,s,r,!0)}else this.app.notice("请先选择Excel文件","error")},setResult:function(){this.formTableArea.empty(),this.formTopCloseActionNode.setStyle("display",""),this.formTopTextNode.set("text","导入结束");var t=this.importedResultJson.data;new Element("div",{styles:{"margin-top":"10px","font-size":"14px","margin-left":"10px"},text:"本批次共导入"+t.dataTotal+"条数据,成功导入"+t.successTotal+"条数据,发生错误"+t.errorTotal+"条"}).inject(this.formTableArea),this.context.form.statJson||(this.context.form.statJson=new StatJson(this.context)),this.context.form.statJson.loadTable(this.formTableArea,this.importBatchName),this.setFormNodeSize()},loadProgressBar:function(){this.formTableArea.empty(),this.formBottomNode.setStyle("display","none"),this.formTopCloseActionNode.setStyle("display","none"),this.formTopTextNode.set("text","正在导入数据，请不要关闭窗口..."),this.progressBar=new ProgressBar(this.formTableArea),this.progressBar.load()}});this.define("setNumberCount",function(){if(this.data.currentUnit){this.form.statJson||(this.form.statJson=new StatJson(this));var t=this.form.statJson.getUnitCount(this.data.currentUnit);this.data.numberCount!=t&&(this.data.numberCount=t,this.form.save())}}.bind(this)),this.define("getErrorCount",function(){return this.form.statJson||(this.form.statJson=new StatJson(this)),this.form.statJson.getErrorCount()}.bind(this)),this.define("setUploadedUnit",(function(t){if((this.form.statJson||(this.form.statJson=new StatJson(this)),""==(i=this.data.currentUnit)&&!this.data.newFlag)&&(r=this.workContext.getWork().creatorUnitLevelName))var e=r.split("/")[0],i=this.org.getUnit(e);var n,o=this.data.flag||this.data.newFlag,s=[];if(o){if("city"==o)i?(s=this.form.statJson.getCounty(i),this.data.numberCount=this.form.statJson.getUnitCount(i)):(this.data.numberCount=this.form.statJson.getUnitCount(),s=this.form.statJson.getAllCounty());else if("county"==o)if(i){var r,a=this.data.city;if(!a)if(r=this.workContext.getWork().creatorUnitLevelName){e=r.split("/")[0];a=this.org.getUnit(e)}else{a=(e=this.org.listSupUnit(i))[0].distinguishedName}this.data.numberCount=this.form.statJson.getUnitCount(i),s=this.form.statJson.getBranch(a,i)}else this.data.numberCount=this.form.statJson.getUnitCount(),s=this.form.statJson.getAllBranch()}else s=this.form.statJson.getCity(),this.data.numberCount=this.form.statJson.getUnitCount();o?"city"==o?n="county":"county"==o&&(n="branch"):n="city",this.data[n+"TaskPerson"]=s,this.form.save((function(){t&&t()}))})),this.define("loadView",(function(t,e){var i=this.data.provinceWorkId||this.data.cityWorkId||this.data.countyWorkId,n=this.data.currentUnit;""!=n||this.data.newFlag||(n=this.workContext.getWork().creatorUnitLevelName.split("/")[0]);var o,s=this.data.flag||this.data.newFlag,r=this.workContext.getControl(),a={application:"渠道-手机号码设置",viewName:"published"==t?"手机号码-导入成功":"error"==t?"手机号码-导入失败":"手机号码",isTitle:"yes",select:r.allowSave?"multi":"none",isExpand:"no",filter:[{logic:"and",path:"workId",title:"workId",comparison:"equals",comparisonTitle:"等于",value:i,formatType:"textValue"}]};s&&n&&a.filter.push({logic:"and",path:s,title:s,comparison:"equals",comparisonTitle:"等于",value:n,formatType:"textValue"}),o="published"==t?this.form.get("view_container_published").node:"error"==t?this.form.get("view_container_error").node:this.form.get("view_container").node,MWF.xDesktop.requireApp("query.Query","Viewer",function(){var i=new MWF.xApplication.query.Query.Viewer(o,a,{resizeNode:!0,onSelect:function(){}.bind(this)});"published"==t?(i.docStatus="published",this.form.view=i):"error"==t?(i.docStatus="error",this.form.view_error=i):this.form.view=i,e&&(this.form.currentView=i)}.bind(this))})),this.define("createImportBatchDiv",(function(){if(this.data.importBatchNames){this.form.statJson||(this.form.statJson=new StatJson(this));var t=this,e=this.form.get("importBatchDiv").node;e.empty();var i={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"},n=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto"}}).inject(e),o=new Element("tr").inject(n);new Element("th",{styles:i,text:"导入时间"}).inject(o),new Element("th",{styles:i,text:"校验通过条数"}).inject(o),new Element("th",{styles:i,text:"校验未通过条数"}).inject(o),new Element("th",{styles:i,text:"操作"}).inject(o),this.data.importBatchNames.split(",").each(function(e){var o=e.split("_")[1],s=o.substring(0,4)+"-"+o.substring(4,6)+"-"+o.substring(6,8)+" "+o.substring(8,10)+":"+o.substring(10,12)+":"+o.substring(12,14),r=new Element("tr").inject(n);new Element("td",{styles:i,text:s}).inject(r),new Element("td",{styles:i,text:this.form.statJson.getPublishedCount(e)}).inject(r),new Element("td",{styles:i,text:this.form.statJson.getErrorCount(e)}).inject(r);var a,l=new Element("td",{styles:i}).inject(r);(a=new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer","margin-right":"20px"},text:"只查看该批次导入的数据"}).inject(l)).store("data",e),a.addEvent("click",function(t){var e=t.target,i={logic:"and",path:"$document.importBatchName",title:"workId",comparison:"equals",comparisonTitle:"等于",value:e.retrieve("data"),formatType:"textValue"};if(this.form.view){var n=this.form.view;(s=n.json.filter?n.json.filter.clone():[]).push(i);var o={filterList:s};n.createViewNode(o)}if(this.form.view_error){var s,r=this.form.view_error;(s=r.json.filter?r.json.filter.clone():[]).push(i);o={filterList:s};r.createViewNode(o)}this.loadStatTable(this.statTableOptions?this.statTableOptions.contaier:this.form.get("statContaienr").node,e.retrieve("data"))}.bind(this)),(a=new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer"},text:"删除该批次导入的数据"}).inject(l)).store("data",e),a.store("time",s),a.addEvent("click",function(e){this.form.app.confirm("infor",e,"删除确认","删除后无法恢复，确定要删除"+e.target.retrieve("time")+"导入的数据？",380,150,(function(){MWF.Actions.get("x_cms_assemble_control").deleteDocumentWithBatchName(e.target.retrieve("data"),(function(){var i=t.data.importBatchNames.split(","),n=e.target.retrieve("data");t.form.statJson.deleteBatch(n),t.form.statJson.submit(),i.erase(n),t.data.importBatchNames=i.toString(),t.form.save((function(){t.setUploadedUnit((function(){t.form.app.notice("删除成功"),t.form.loadErrorView=!1,t.form.app.refresh()}))}))})),this.close()}),(function(){this.close()}))}.bind(this))}.bind(this));o=new Element("tr").inject(n);new Element("td",{styles:i,text:"总数"}).inject(o),new Element("td",{styles:i,text:this.form.statJson.getPublishedCount()}).inject(o),new Element("td",{styles:i,text:this.form.statJson.getErrorCount()}).inject(o);var s=new Element("td",{styles:i}).inject(o);new Element("button",{styles:{"border-radius":"5px",border:"1px solid rgb(204, 204, 204)",height:"26px",color:"rgb(119, 119, 119)",cursor:"pointer","margin-right":"20px"},text:"查看全部"}).inject(s).addEvent("click",function(t){t.target;if(this.form.view){var e=this.form.view,i={filterList:e.json.filter?e.json.filter.clone():[]};e.createViewNode(i)}if(this.form.view_error){var n=this.form.view_error;i={filterList:n.json.filter?n.json.filter.clone():[]};n.createViewNode(i)}this.loadStatTable(this.statTableOptions?this.statTableOptions.contaier:this.form.get("statContaienr").node)}.bind(this))}})),this.define("getAllUnit",function(t){this.name_all&&t&&t();var e=this.name_all=[];return this.name_levelName={},this.dnName_levelName={},this.name_dnName={},new this.Action("x_organization_assemble_express",{lookup:{uri:"/jaxrs/unit/list/all/object",method:"GET"}}).invoke({name:"lookup",parameter:{},data:null,success:function(i){i.data.each(function(t){this.name_levelName[t.name]=t.levelName,this.dnName_levelName[t.distinguishedName]=t.levelName,this.name_dnName[t.name]=t.distinguishedName,e.push(t.name),e.push(t.distinguishedName),e.push(t.shortName),e.push(t.levelName)}.bind(this)),t&&t(i)}.bind(this),async:!1}),e}.bind(this)),this.define("setWorkId",(function(){"发起"==this.workContext.getWork().activityName&&(this.form.get("provinceWorkId").setData(this.workContext.getWork().id),this.form.get("currentWorkId").setData(this.workContext.getWork().id)),"市级接收单元负责人处理"==this.workContext.getWork().activityName&&(this.form.get("cityWorkId").setData(this.workContext.getWork().id),this.form.get("currentWorkId").setData(this.workContext.getWork().id)),"县级接收单元负责人处理"==this.workContext.getWork().activityName&&(this.form.get("countyWorkId").setData(this.workContext.getWork().id),this.form.get("currentWorkId").setData(this.workContext.getWork().id)),"网格接收单元负责人处理"==this.workContext.getWork().activityName&&(this.form.get("branchWorkId").setData(this.workContext.getWork().id),this.form.get("currentWorkId").setData(this.workContext.getWork().id))})),this.define("getUnitLevel",function(t,e){var i,n=this.workContext.getWork().creatorIdentityDn;return MWF.Actions.get("x_organization_assemble_express")[e?"getUnitWithIdentityAndLevel":"getUnitWithIdentityAndLevelValue"]({identity:n,level:t},function(t){i=t.data.unit}.bind(this),null,!1),i}.bind(this)),this.define("openMinder",(function(t){var e={pageId:"71acdde6-97cc-4c6d-abe2-817ea5afad4f",portalId:"b66420c3-dee9-4b4c-9d52-050fd0921864",workId:t,appId:"portal_"+t};layout.desktop.openApplication?layout.desktop.openApplication(null,"portal.Portal",e):window.open(o2.filterUrl("../x_desktop/app.html?app=portal.Portal&option="+JSON.stringify(e)))})),this.define("openUploadForm",(function(){if(this.data.subject){var t=this.form.uploadExcelDialog=new UploadExcelDialog({app:this.form.app},{workName:this.data.subject,workId:this.data.provinceWorkId||this.data.currentWorkId,jobId:this.workContext.getWork().job,categoryId:"288a0f05-78dd-4650-af79-236e33832a7e"},{});t.contextForm=this.form,t.context=this,t.edit()}else this.form.app.notice("请填写任务名称并保存","error")}));var ProgressBar=new Class({initialize:function(t){this.container=t},load:function(){this.getCss(),this.loadSteps(),this.loadProgressBar()},setProgress:function(t,e,i){var n=Math.floor(t/e*100);this.progressFront.setStyles({width:n+"%"}),this.textNode.set("text",i+"，共"+e+"条，已处理"+t+"条，进度"+n+"%")},loadProgressBar:function(){this.progressNode=new Element("div",{styles:this.css.progressNode}).inject(this.container),this.progressBack=new Element("div.progressBack",{styles:this.css.progressBack}).inject(this.progressNode),this.progressBack.setStyle("width","100%"),this.progressFront=new Element("div.progressFront",{styles:this.css.progressFront,text:" "}).inject(this.progressBack),this.progressFront.setStyle("width","0px"),this.textNode=new Element("div",{styles:this.css.textNode}).inject(this.container)},getCss:function(){this.css={loadingNode:{},textNode:{"margin-top":"10px","font-size":"12px","margin-left":"10px"},progressNode:{margin:"10px 0px",overflow:"hidden"},progressBack:{float:"left","border-radius":"10px","background-color":"#f4f4f4",height:"16px"},progressFront:{height:"16px","background-color":"#4a9adb"}}}});this.define("loadStatTable",(function(t,e,i,n){t.empty(),this.form.statJson||(this.form.statJson=new StatJson(this)),!i&&this.statTableOptions&&(i=this.statTableOptions.unitLevel),!n&&this.statTableOptions&&(n=this.statTableOptions.unitName),this.form.statJson.loadTable(t,e,i,n)}));var StatJson=new Class({initialize:function(t){this.context=t,this.context.data.statJson?this.json=JSON.parse(this.context.data.statJson):this.json={total:{publishedCount:0,errorCount:0},batch:{}}},submit:function(){for(var t in this.deleteEmptyUnit(),this.json.batch)this.deleteEmptyUnit(t);this.context.data.statJson=JSON.stringify(this.json)},addBatch:function(t,e){this.json.batch[t]||(this.json.batch[t]={publishedCount:0,errorCount:0}),e&&(this.currentBatch=this.json.batch[t])},deleteBatch:function(t){var e=this.json,i=e.batch[t];i&&(i.publishedCount&&(e.total.publishedCount=e.total.publishedCount-i.publishedCount),i.errorCount&&(e.total.errorCount=e.total.errorCount-i.errorCount),this.reduceByBatchData(i),delete this.json.batch[t])},reduceByBatchData:function(t){var e=this.json.total;for(var i in t)if("publishedCount"!=i&&"errorCount"!=i){var n=e[i],o=t[i];for(var s in t.publishedCount&&(n.publishedCount=n.publishedCount-o.publishedCount),t.errorCount&&(n.errorCount=n.errorCount-o.errorCount),o)if("publishedCount"!=s&&"errorCount"!=s){var r=n[s],a=o[s];for(var l in a.publishedCount&&(r.publishedCount=r.publishedCount-a.publishedCount),a.errorCount&&(r.errorCount=r.errorCount-a.errorCount),a)if("publishedCount"!=l&&"errorCount"!=l){var d=r[l],h=a[l];h.publishedCount&&(d.publishedCount=d.publishedCount-h.publishedCount),h.errorCount&&(d.errorCount=d.errorCount-h.errorCount)}}}},addData:function(t){var e=t,i=this.json.total,n=this.currentBatch;"published"==e.docStatus?(i.publishedCount++,n.publishedCount++,this.addCount(i,e),this.addCount(n,e)):"error"==e.docStatus&&(i.errorCount++,n.errorCount++)},addCount:function(t,e){if(e.city){if((o=t[e.city])||(o=t[e.city]={publishedCount:0}),o.publishedCount++,e.county){var i=o[e.county];if(i||(i=o[e.county]={publishedCount:0}),i.publishedCount++,e.branch){var n=i[e.branch];n||(n=i[e.branch]={publishedCount:0}),n.publishedCount++}}}else{var o;(o=t["未设置组织"])||(o=t["未设置组织"]={publishedCount:0}),o.publishedCount++}},reduceCount:function(t,e){if(e.city){if((o=t[e.city])||(o=t[e.city]={publishedCount:0}),o.publishedCount--,e.county){var i=o[e.county];if(i||(i=o[e.county]={publishedCount:0}),i.publishedCount--,e.branch){var n=i[e.branch];n||(n=i[e.branch]={publishedCount:0}),n.publishedCount--}}}else{var o;(o=t["未设置组织"])||(o=t["未设置组织"]={publishedCount:0}),o.publishedCount--}},getCity:function(){var t=this.json.total,e=[];for(var i in t)"publishedCount"!=i&&"errorCount"!=i&&"未设置组织"!=i&&t[i].publishedCount>0&&e.push(i);return e},getCounty:function(t){var e=this.json.total,i=[];if(e[t]){var n=e[t];for(var o in n)"publishedCount"!=o&&"errorCount"!=o&&"未设置组织"!=o&&n[o].publishedCount>0&&i.push(o)}return i},getBranch:function(t,e){var i=this.json.total,n=[];if(i[t]){var o=i[t];if(o[e]){var s=o[e];for(var r in s)"publishedCount"!=r&&"errorCount"!=r&&"未设置组织"!=r&&s[r].publishedCount>0&&n.push(r)}}return n},getAllCounty:function(){var t=this.json.total,e=[];for(var i in t)if("publishedCount"!=i&&"errorCount"!=i&&"未设置组织"!=i)for(var n in t[i])"publishedCount"!=n&&"errorCount"!=n&&"未设置组织"!=n&&t[i][n].publishedCount>0&&e.push(n);return e},getAllBranch:function(){var t=this.json.total,e=[];for(var i in t)if("publishedCount"!=i&&"errorCount"!=i&&"未设置组织"!=i)for(var n in t[i])if("publishedCount"!=n&&"errorCount"!=n&&"未设置组织"!=n)for(var o in t[i][n])"publishedCount"!=o&&"errorCount"!=o&&"未设置组织"!=o&&t[i][n][o].publishedCount>0&&e.push(o);return e},getUnitCount:function(t,e){var i;if(i=e&&this.json.batch[e]?this.json.batch[e]:this.json.total,!t)return i.publishedCount;for(var n in i){var o=i[n];if(n==t)return o.publishedCount;for(var s in o){var r=o[s];if(s==t)return r.publishedCount;for(var a in r){var l=r[a];if(a==t)return l.publishedCount}}}return 0},changeData:function(t,e,i){var n;i&&this.json.batch[i]&&(n=this.json.batch[i]);var o=this.json.total;"error"==e.docStatus&&(o.errorCount--,n&&n.errorCount--),"published"==e.docStatus&&(o.publishedCount--,this.reduceCount(o,e),n&&(n.publishedCount--,this.reduceCount(n,e))),"error"==t.docStatus&&(o.errorCount++,n&&n.errorCount++),"published"==t.docStatus&&(o.publishedCount++,this.addCount(o,t),n&&(n.publishedCount++,this.addCount(n,t)))},getPublishedCount:function(t){return t?this.json.batch[t]?this.json.batch[t].publishedCount:void 0:this.json.total.publishedCount},getErrorCount:function(t){return t?this.json.batch[t]?this.json.batch[t].errorCount:void 0:this.json.total.errorCount},deleteEmptyUnit:function(t){if(t)var e=this.json.batch[t];else e=this.json.total;for(var i in e)if("publishedCount"!=i&&"errorCount"!=i){var n=e[i];if(n.publishedCount||n.errorCount){for(var o in n)if("publishedCount"!=o&&"errorCount"!=o){var s=n[o];if(s.publishedCount||s.errorCount){for(var r in s)if("publishedCount"!=r&&"errorCount"!=r){var a=s[r];a.publishedCount||a.errorCount||delete e[i][o][r]}}else delete e[i][o]}}else delete e[i]}},getNoUnitJson:function(t){var e=Object.clone(t);for(var i in e)if("publishedCount"!=i&&"errorCount"!=i){var n=e[i],o=(n.publishedCount,0);for(var s in n)if("publishedCount"!=s&&"errorCount"!=s){var r=n[s];o+=r.publishedCount;var a=0;for(var l in r){if("publishedCount"!=l&&"errorCount"!=l)a+=r[l].publishedCount}r.publishedCount>a&&(r["未设置"]={publishedCount:r.publishedCount-a})}n.publishedCount>o&&(n["未设置"]={publishedCount:n.publishedCount-o})}return e},loadTable:function(t,e,i,n){i?this._loadTableByUnit(t,e,i,n):this._loadTable(t,e)},_loadTableByUnit:function(t,e,i,n){if(e)var o=this.json.batch[e];else o=this.json.total;var s=this.getNoUnitJson(o),r=this.table=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto","font-size":"14px"}}).inject(t);if(e)var a=e.split("_")[1],l=a.substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6,8)+" "+a.substring(8,10)+":"+a.substring(10,12)+":"+a.substring(12,14)+"批次数据统计";else l="数据统计";"city"==i&&this._loadTableByCity(l,s,r,n),"county"==i&&this._loadTableByCounty(l,s,r,n),"branch"==i&&this._loadTableByBranch(l,s,r,n)},_loadTableByCity:function(t,e,i,n){var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"},s=new Element("tr").inject(i);new Element("td",{styles:{"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"},text:t,colspan:3}).inject(s);s=new Element("tr").inject(i);for(var r in new Element("th",{styles:o,text:"市分"}).inject(s),new Element("th",{styles:o,text:"县分"}).inject(s),new Element("th",{styles:o,text:"网格"}).inject(s),e)if(r==n&&"publishedCount"!=r&&"errorCount"!=r){var a=new Element("tr").inject(i),l=e[r],d="未设置组织"==r?"未设置":r.split("@")[0],h=new Element("td",{styles:o,text:d+"("+l.publishedCount+")"}).inject(a),c=1,u=0,p=null,m=null,f=null;for(var b in l)if("publishedCount"!=b&&"errorCount"!=b){0!=u&&(c++,p=new Element("tr").inject(i)),u++;var v=1,g=l[b];m=new Element("td",{styles:o,text:b.split("@")[0]+"("+g.publishedCount+")"}).inject(p||a);var C=0,x=null;for(var w in g)if("publishedCount"!=w&&"errorCount"!=w){0!=C&&(x=new Element("tr").inject(i),c++,v++),C++;var y=g[w];f=new Element("td",{styles:o,text:w.split("@")[0]+"("+y.publishedCount+")"}).inject(x||p||a)}0==C&&(f=new Element("td",{styles:o,text:""}).inject(x||p||a)),m.set("rowspan",v)}0==u&&(m=new Element("td",{styles:o,text:""}).inject(p||a)),f||new Element("td",{styles:o,text:""}).inject(p||a),h.set("rowspan",c)}},_loadTableByCounty:function(t,e,i,n){var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"},s=new Element("tr").inject(i);new Element("td",{styles:{"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"},text:t,colspan:2}).inject(s);s=new Element("tr").inject(i);for(var r in new Element("th",{styles:o,text:"县分"}).inject(s),new Element("th",{styles:o,text:"网格"}).inject(s),e)if("publishedCount"!=r&&"errorCount"!=r){var a=e[r],l=null,d=null,h=null;for(var c in a)if(n==c&&"publishedCount"!=c&&"errorCount"!=c){l=new Element("tr").inject(i);var u=1,p=a[c];d=new Element("td",{styles:o,text:c.split("@")[0]+"("+p.publishedCount+")"}).inject(l);var m=0,f=null;for(var b in p)if("publishedCount"!=b&&"errorCount"!=b){0!=m&&(f=new Element("tr").inject(i),u++),m++;var v=p[b];h=new Element("td",{styles:o,text:b.split("@")[0]+"("+v.publishedCount+")"}).inject(f||l)}0==m&&(h=new Element("td",{styles:o,text:""}).inject(f||l)),d.set("rowspan",u)}!h&&l&&new Element("td",{styles:o,text:""}).inject(l)}},_loadTableByBranch:function(t,e,i,n){var o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"},s=new Element("tr").inject(i);for(var r in new Element("td",{styles:{"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"},text:t}).inject(s),e)if("publishedCount"!=r&&"errorCount"!=r){var a=e[r];for(var l in a)if("publishedCount"!=l&&"errorCount"!=l){var d=a[l];for(var h in d)if(h==n&&"publishedCount"!=h&&"errorCount"!=h){var c=new Element("tr").inject(i),u=d[h];new Element("td",{styles:o,text:h.split("@")[0]+"("+u.publishedCount+")"}).inject(c)}}}},_loadTable:function(t,e){if(e)var i=this.json.batch[e];else i=this.json.total;var n=this.getNoUnitJson(i),o={"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center"},s=this.table=new Element("table",{width:"90%",border:"0",cellpadding:"5",cellspacing:"0",styles:{"border-top":"1px solid #ccc","border-left":"1px solid #ccc",margin:"20px auto 10px auto","font-size":"14px"}}).inject(t),r=new Element("tr").inject(s);if(e)var a=e.split("_")[1],l=a.substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6,8)+" "+a.substring(8,10)+":"+a.substring(10,12)+":"+a.substring(12,14)+"批次数据统计";else l="数据统计";new Element("td",{styles:{"border-right":"1px solid #ccc","border-bottom":"1px solid #ccc","text-align":"center","font-size":"16px","font-weight":"bold"},text:l,colspan:3}).inject(r);r=new Element("tr").inject(s);new Element("td",{styles:o,text:"校验未通过（条）"}).inject(r),new Element("td",{styles:o,colspan:2,text:n.errorCount||""}).inject(r);r=new Element("tr").inject(s);new Element("td",{styles:o,text:"校验通过（条）"}).inject(r),new Element("td",{styles:o,colspan:2,text:n.publishedCount||""}).inject(r);r=new Element("tr").inject(s);for(var d in new Element("th",{styles:o,text:"市分"}).inject(r),new Element("th",{styles:o,text:"县分"}).inject(r),new Element("th",{styles:o,text:"网格"}).inject(r),n)if("publishedCount"!=d&&"errorCount"!=d){var h=new Element("tr").inject(s),c=n[d],u="未设置组织"==d?"未设置":d.split("@")[0],p=new Element("td",{styles:o,text:u+"("+c.publishedCount+")"}).inject(h),m=1,f=0,b=null,v=null,g=null;for(var C in c)if("publishedCount"!=C&&"errorCount"!=C){0!=f&&(m++,b=new Element("tr").inject(s)),f++;var x=1,w=c[C];v=new Element("td",{styles:o,text:C.split("@")[0]+"("+w.publishedCount+")"}).inject(b||h);var y=0,k=null;for(var j in w)if("publishedCount"!=j&&"errorCount"!=j){0!=y&&(k=new Element("tr").inject(s),m++,x++),y++;var E=w[j];g=new Element("td",{styles:o,text:j.split("@")[0]+"("+E.publishedCount+")"}).inject(k||b||h)}0==y&&(g=new Element("td",{styles:o,text:""}).inject(k||b||h)),v.set("rowspan",x)}0==f&&(v=new Element("td",{styles:o,text:""}).inject(b||h)),g||new Element("td",{styles:o,text:""}).inject(b||h),p.set("rowspan",m)}}});