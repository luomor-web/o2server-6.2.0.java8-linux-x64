MWF.xApplication.Template=MWF.xApplication.Template||{},MWF.xApplication.Template.MPopupForm=MPopupForm=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",width:500,height:450,top:null,left:null,bottom:null,right:null,minWidth:300,minHeight:220,isLimitSize:!0,ifFade:!0,hasTop:!1,hasTopIcon:!1,hasTopContent:!1,hasIcon:!0,hasBottom:!0,hasMask:!0,closeByClickMask:!1,hasScroll:!0,scrollType:"",title:"",draggable:!1,resizeable:!1,maxAction:!1,closeAction:!0,relativeToApp:!0,sizeRelateTo:"app",resultSeparator:","},initialize:function(t,e,o,i){this.setOptions(o),this.explorer=t,i?this.options.relativeToApp?(this.app=i.app||this.explorer.app,this.container=i.container||this.app.content,this.lp=i.lp||this.explorer.lp||this.app.lp,this.css=i.css||this.explorer.css||this.app.css,this.actions=i.actions||this.explorer.actions||this.app.actions||this.app.restActions):(this.container=i.container,this.lp=i.lp||this.explorer.lp,this.css=i.css||this.explorer.css,this.actions=i.actions||this.explorer.actions):this.options.relativeToApp?(this.app=this.explorer.app,this.container=this.app.content,this.lp=this.explorer.lp||this.app.lp,this.css=this.explorer.css||this.app.css,this.actions=this.explorer.actions||this.app.actions||this.app.restActions):(this.container=window.document.body,this.lp=this.explorer.lp,this.css=this.explorer.css,this.actions=this.explorer.actions),this.data=e||{},this.cssPath="../x_component_Template/$MPopupForm/"+this.options.style+"/css.wcss",this.load()},load:function(){this._loadCss()},_loadCss:function(){var t={};new Request.JSON({url:o2.filterUrl(this.cssPath),secure:!1,async:!1,method:"get",noCache:!1,onSuccess:function(e,i){t=e,MWF.widget.css[o]=e}.bind(this),onError:function(t,e){alert(e+t)}}).send();var e=!0;for(var o in t)if(o){e=!1;break}e||(this.css=Object.merge(t,this.css))},reload:function(t){t&&(this.data=this.form.getResult(!1,this.options.resultSeparator,!1,!1,!0)),this.formTopNode=null,this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.isNew?this.create():this.isEdited?this.edit():this.open()},open:function(t){this.fireEvent("queryOpen"),this.isNew=!1,this.isEdited=!1,this._open(),this.fireEvent("postOpen")},create:function(){this.fireEvent("queryCreate"),this.isNew=!0,this._open(),this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryEdit"),this.isEdited=!0,this._open(),this.fireEvent("postEdit")},_open:function(){if(this.options.hasMask&&(this.formMaskNode=new Element("div.formMaskNode",{styles:this.css.formMaskNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()},mousewheel:function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,t.preventDefault?t.preventDefault():t.returnValue=!1},DOMMouseScroll:function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,t.preventDefault?t.preventDefault():t.returnValue=!1}}}).inject(this.container||this.app.content)),this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}),this.createFormNode(),this.formMaskNode?this.formAreaNode.inject(this.formMaskNode,"after"):this.formAreaNode.inject(this.container||this.app.content),this.options.ifFade?this.formAreaNode.fade("in"):this.formAreaNode.setStyle("opacity",1),this.setFormNodeSize(),this.setFormNodeSizeFun=this.setFormNodeSize.bind(this),this.app&&this.app.addEvent&&this.app.addEvent("resize",this.setFormNodeSizeFun),this.options.draggable&&this.formTopNode){var t=(this.container||this.app.content).getSize(),e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]},onDrag:function(){this.fireEvent("drag")}.bind(this),onComplete:function(){this.fireEvent("dragCompleted")}.bind(this)})}this.options.closeByClickMask&&this.formMaskNode&&this.formMaskNode.addEvent("click",function(t){this.close(t)}.bind(this)),this.options.resizeable&&(this.resizeNode=new Element("div.resizeNode",{styles:this.css.resizeNode}).inject(this.formNode),this.formAreaNode.makeResizable({handle:this.resizeNode,limit:{x:[this.options.minWidth,null],y:[this.options.minHeight,null]},onDrag:function(){var t=this.formAreaNode.getComputedSize();this.setNodesSize(t.width,t.height),this.fireEvent("resize")}.bind(this),onComplete:function(){var t=this.formAreaNode.getComputedSize();this.options.width=t.width,this.options.height=t.height,this.oldCoordinate&&(this.oldCoordinate.width=t.width,this.oldCoordinate.height=t.height),this.fireEvent("resizeCompleted")}.bind(this)}))},createFormNode:function(){this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode),this.options.hasTop&&this.createTopNode(),this.options.hasIcon&&(this.formIconNode=new Element("div.formIconNode",{styles:this.isNew?this.css.formNewNode:this.css.formIconNode}).inject(this.formNode)),this.createContent(),this.options.hasBottom&&this.createBottomNode(),this._setCustom(),this.options.hasScroll&&("window"==this.options.scrollType?(this.formContentNode.setStyle("overflow","auto"),this.formTableContainer.setStyle("overflow","visible")):MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.formTableContainer,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){}})}.bind(this)))},_setCustom:function(){},createTopNode:function(){this.fireEvent("queryCreateTop"),this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.options.hasTopIcon&&(this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode)),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode,title:MWF.xApplication.Template.LP.MPopupForm.close}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(t){this.close(),t.stopPropagation()}.bind(this))),this.options.maxAction&&(this.formTopMaxActionNode=new Element("div",{styles:this.css.formTopMaxActionNode,title:MWF.xApplication.Template.LP.MPopupForm.max}).inject(this.formTopNode),this.formTopMaxActionNode.addEvent("click",function(){this.maxSize()}.bind(this)),this.formTopRestoreActionNode=new Element("div",{styles:this.css.formTopRestoreActionNode,title:MWF.xApplication.Template.LP.MPopupForm.restore}).inject(this.formTopNode),this.formTopRestoreActionNode.addEvent("click",function(){this.restoreSize()}.bind(this)),this.formTopNode.addEvent("dblclick",function(){this.switchMax()}.bind(this))),this.options.hasTopContent&&(this.formTopContentNode=new Element("div.formTopContentNode",{styles:this.css.formTopContentNode}).inject(this.formTopNode),this._createTopContent())),this.fireEvent("postCreateTop")},_createTopContent:function(){},createContent:function(){this.formContentNode=new Element("div.formContentNode",{styles:this.css.formContentNode}).inject(this.formNode),this.formTableContainer=new Element("div.formTableContainer",{styles:this.css.formTableContainer}).inject(this.formContentNode),this.formTableArea=new Element("div.formTableArea",{styles:this.css.formTableArea}).inject(this.formTableContainer),this._createTableContent()},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td styles='formTableTitle' lable='empName'></td>    <td styles='formTableValue' item='empName'></td></tr><tr><td styles='formTableTitle' lable='departmentName'></td>    <td styles='formTableValue' item='departmentName'></td></tr><tr><td styles='formTableTitle' lable='recordDateString'></td>    <td styles='formTableValue' item='recordDateString'></td></tr><tr><td styles='formTableTitle' lable='status'></td>    <td styles='formTableValue' item='status'></td></tr><tr><td styles='formTableTitle' lable='appealReason'></td>    <td styles='formTableValue' item='appealReason'></td></tr><tr><td styles='formTableTitle' lable='appealDescription'></td>    <td styles='formTableValue' item='appealDescription'></td></tr><tr><td styles='formTableTitle' lable='opinion1'></td>    <td styles='formTableValue' item='opinion1'></td></tr></table>"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{empName:"xadmin"},{isEdited:this.isEdited||this.isNew,itemTemplate:{empName:{text:"姓名",type:"innertext"},departmentName:{text:"部门",tType:"department",notEmpty:!0},recordDateString:{text:"日期",tType:"date"},status:{text:"状态",tType:"number"},appealReason:{text:"下拉框",type:"select",selectValue:["测试1","测试2"]},appealDescription:{text:"描述",type:"textarea"},opinion1:{text:"测试",type:"button",value:"测试"}}},this.app),this.form.load()}.bind(this),!0)},createBottomNode:function(){this.fireEvent("queryCreateBottom"),this.formBottomNode=new Element("div.formBottomNode",{styles:this.css.formBottomNode}).inject(this.formNode),this._createBottomContent(),this.fireEvent("postCreateBottom")},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.cancel}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this)),(this.isNew||this.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.lp.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this)))},cancel:function(t){this.fireEvent("queryCancel"),this.close(),this.fireEvent("postCancel")},close:function(t){this.fireEvent("queryClose"),this._close(),this.setFormNodeSizeFun&&this.app&&this.app.removeEvent&&this.app.removeEvent("resize",this.setFormNodeSizeFun),this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.fireEvent("postClose")},_close:function(){},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,this.options.resultSeparator,!0,!1,!0);e&&this._ok(e,function(t){"error"==t.type?this.app&&this.app.notice&&this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode&&this.formAreaNode.destroy(),this.explorer&&this.explorer.view&&this.explorer.view.reload(),this.app&&this.app.notice&&this.app.notice(this.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postOk"))}.bind(this))},_ok:function(t,e){},switchMax:function(){this.isMax?this.restoreSize():this.maxSize()},maxSize:function(){this.oldCoordinate||(this.oldCoordinate={width:this.options.width,height:this.options.height,top:this.options.top,left:this.options.left,bottom:this.options.bottom,right:this.options.right}),this.options.width="100%",this.options.height="100%",this.options.top=null,this.options.left=null,this.options.bottom=null,this.options.right=null,this.setFormNodeSize(),this.formTopMaxActionNode.setStyle("display","none"),this.formTopRestoreActionNode.setStyle("display",""),this.isMax=!0,this.fireEvent("max")},restoreSize:function(){this.oldCoordinate&&(this.options.width=this.oldCoordinate.width,this.options.height=this.oldCoordinate.height,this.options.top=this.oldCoordinate.top,this.options.left=this.oldCoordinate.left,this.options.bottom=this.oldCoordinate.bottom,this.options.right=this.oldCoordinate.right),this.setFormNodeSize(),this.formTopMaxActionNode.setStyle("display",""),this.formTopRestoreActionNode.setStyle("display","none"),this.isMax=!1,this.fireEvent("restore")},setFormNodeSize:function(t,e,o,i,s,n){this._beforeFormNodeSize(),t||(t=this.options.width?this.options.width:"50%"),e||(e=this.options.height?this.options.height:"50%"),o||0==o||(o=this.options.top),i||0==i||(i=this.options.left),s||0==s||(s=this.options.bottom),n||0==n||(n=this.options.right),t=t.toString(),e=e.toString();var r=(this.container||this.app.content).getSize(),h=r.x,a=r.y;this.options.isLimitSize&&("%"!=t.substr(t.length-1,1)&&r.x<parseInt(t)&&(t=r.x),"%"!=e.substr(e.length-1,1)&&r.y<parseInt(e)&&(e=r.y)),"string"==typeof t&&1<t.length&&"%"==t.substr(t.length-1,1)&&(t=parseInt(h*parseInt(t,10)/100,10)),this.options.minWidth>t&&(t=this.options.minWidth),"string"==typeof e&&1<e.length&&"%"==e.substr(e.length-1,1)&&(e=parseInt(a*parseInt(e,10)/100,10)),this.options.minHeight>e&&(e=this.options.minHeight);var p={width:t+"px",height:e+"px"};null!=o?(p.top=o+"px",p.bottom="auto"):null!=s?(p.top="auto",p.bottom=s+"px"):(p.top=parseInt((a-e)/2,10)+"px",p.bottom="auto"),null!=i?(p.left=i+"px",p.right="auto"):null!=n?(p.left="auto",p.right=n+"px"):(p.left=parseInt((h-t)/2,10)+"px",p.right="auto"),this.formAreaNode&&this.formAreaNode.setStyles(p),this._setFormNodeSize(p),this.setNodesSize(t,e)},_beforeFormNodeSize:function(){},_setFormNodeSize:function(t){},setNodesSize:function(t,e){this.options.minWidth>t&&(t=this.options.minWidth),this.options.minHeight>e&&(e=this.options.minHeight),this.formNode.setStyles({width:t+"px",height:e+"px"});var o=this.formIconNode?this.formIconNode.getSize():{x:0,y:0},i=this.formTopNode?this.formTopNode.getSize():{x:0,y:0},s=this.formBottomNode?this.formBottomNode.getSize():{x:0,y:0},n=e-o.y-i.y-s.y,r=parseFloat(this.formContentNode.getStyle("margin-top"))||0,h=parseFloat(this.formContentNode.getStyle("margin-bottom"))||0,a=n-r-h;this.formContentNode.setStyles({height:a+"px"});var p=parseFloat(this.formContentNode.getStyle("padding-top"))||0,l=parseFloat(this.formContentNode.getStyle("padding-bottom"))||0,d=n-(r=parseFloat(this.formTableContainer.getStyle("margin-top"))||0)-(h=parseFloat(this.formTableContainer.getStyle("margin-bottom"))||0)-p-l-(parseFloat(this.formTableContainer.getStyle("padding-top"))||0)-(parseFloat(this.formTableContainer.getStyle("padding-bottom"))||0);"window"==this.options.scrollType&&(d-=10),this.formTableContainer.setStyles({height:d+"px"}),this._setNodesSize(t,e,a,d),this.fireEvent("resizeForm")},_setNodesSize:function(t,e,o,i){}});