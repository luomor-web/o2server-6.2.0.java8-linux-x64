MWF.xDesktop.requireApp("Template","MTooltips",null,!1);var MSelector=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",width:"230px",height:"30px",defaultOptionLp:"请选择",trigger:"delay",isSetSelectedValue:!0,isChangeOptionStyle:!0,inputEnable:!1,isCreateReadNode:!0,emptyOptionEnable:!0,containerIsTarget:!1,tooltipWhenNoSelectValue:!1,hasScrollBar:!0,hideByClickBody:!1,textField:"",valueField:"",value:"",text:"",defaultVaue:"",selectValue:"",selectText:"",isEdited:!0,tooltipsOptions:{axis:"y",position:{x:"center",y:"bottom"},event:"click",hiddenDelay:200,displayDelay:0}},initialize:function(t,e,i,s,o){this.setOptions(e),(this.options.isEdited||this.options.isCreateReadNode)&&(this.path="../x_component_Template/$MSelector/",this.cssPath="../x_component_Template/$MSelector/"+this.options.style+"/css.wcss",this._loadCss(),s&&(this.css=Object.merge(Object.clone(this.css),s))),this.valSeparator=/,|;|\^\^|\|/,this.app=i,this.container=$(t),this.dropdownContainer=o||$(o)},load:function(t){this.options.isEdited?this.loadEdit(t):this.loadRead(t)},initPara:function(){if(this.itemNodeList=[],this.itemNodeObject={},this.value=this.options.value||this.options.text||this.options.defaultVaue,this.text=this.options.text||this.options.value||this.options.defaultVaue,this.textField=this.options.textField||this.options.valueField,this.valueField=this.options.valueField||this.options.textField,this.options.selectValue||this.options.selectText){this.textField="text",this.valueField="value";var t=this.options.selectValue,e=this.options.selectText;this.selectValues="array"==typeOf(t)?t:t.split(this.valSeparator),this.selectTexts="array"==typeOf(e)?e:e.split(this.valSeparator),this.data=[],this.options.emptyOptionEnable&&this.data.push({value:"",text:this.options.defaultOptionLp||""}),this.selectValues.each(function(t,e){this.data.push({value:t,text:this.selectTexts[e]})}.bind(this))}},loadRead:function(t){this.initPara();var e=function(){for(var e=0;e<this.data.length;e++){var i=this.data[e];if(this.options.text){if(i[this.textField]==this.options.text){this.value=i[this.valueField],this.text=this.options.text,this.currentItemData=i;break}}else if(this.options.value&&i[this.valueField]==this.options.value){this.value=this.options.value,this.text=i[this.textField],this.currentItemData=i;break}}this.loadReadNode(this.text),t&&t()}.bind(this);this.data?e():this._loadData(function(t){this.data=this.parseData(t),e()}.bind(this))},loadReadNode:function(t){this.fireEvent("loadReadNode",t),this.options.isCreateReadNode&&(this.node&&this.node.destroy(),this.node=new Element("div",{styles:this.css.readNode,text:t}).inject(this.container))},loadEdit:function(t){this.initPara(),this.node||(this.options.containerIsTarget?this.node=this.container:(this.node=new Element("div.selectNode",{styles:this.css.selectNode}).inject(this.container),this.node.setStyles({width:this.options.width,height:this.options.height}))),this.data?(this.createDefaultItem(),this.loadContent(this.data),this.fireEvent("postLoad",[this])):this._loadData(function(t){this.data=this.parseData(t),this.createDefaultItem(),this.loadContent(this.data),this.fireEvent("postLoad",[this])}.bind(this)),t&&t()},resetOptions:function(){this.contentTooltip&&(this.contentTooltip.destroy(),this.contentTooltip=null),this.node&&this.node.empty(),this.data=null,this.load()},addOption:function(t,e){var i={};i[this.textField]=t,i[this.valueField]=e,this.data.push(i),this.contentTooltip&&this.contentTooltip.createItem(i)},deleteOption:function(t){for(var e=0;e<this.itemNodeList.length;e++){var i=this.itemNodeList[e];if(i.retrieve("data")[this.valueField]==t){this.itemNodeList.erase(i),i.destroy();break}}if(this.itemNodeObject[t]&&delete this.itemNodeObject[t],this.data)for(e=0;e<this.data.length;e++){var s=this.data[e];s[this.valueField]==t&&this.data.erase(s)}},loadContent:function(t){if(!this.contentTooltip){var e=parseInt(this.options.width)+"px";this.css.tooltipNode.width=e,this.css.tooltipNode["max-width"]=e;var i=Object.merge({hideByClickBody:this.options.hideByClickBody,nodeStyles:this.css.tooltipNode,onPostLoad:function(){this.selectArrowNode&&this.selectArrowNode.setStyles(this.css.selectArrowNode_up),this.inputNode&&this.inputNode.focus();for(var t,e=this.node.getParent();e;)t=e.getStyle("z-index"),e=t&&"NaN"!==parseFloat(t).toString()?null:e.getParent();for(t&&"NaN"!==parseFloat(t).toString()?this.contentTooltip.node.setStyle("z-index",parseFloat(t)+1):this.contentTooltip.node.setStyle("z-index","auto"),e=this.node.getParent();e;){var i=e.getStyle("overflow"),s=e.getStyle("overflow-y");"auto"===i||"scroll"===i||"auto"===s||"scroll"===s?(this.scrollFun=function(t){this.contentTooltip.setPosition()}.bind(this),this.scrollParentNode=e,e.addEvent("scroll",this.scrollFun),e=null):e=e.getParent()}}.bind(this),onPostInitialize:function(){"immediately"==this.options.trigger&&this.contentTooltip.load()}.bind(this),onHide:function(){this.status="hidden",this.selectArrowNode&&this.selectArrowNode.setStyles(this.css.selectArrowNode),this.scrollParentNode&&this.scrollFun&&this.scrollParentNode.removeEvent("scroll",this.scrollFun)}.bind(this)},this.options.tooltipsOptions);this.contentTooltip=new MSelector.Tootips(this.dropdownContainer||this.app.content,this.node,this.app,t,i),this.contentTooltip.selector=this}},setWidth:function(t){this.options.width=t,this.contentTooltip&&(this.contentTooltip.options.nodeStyles.width=t,this.contentTooltip.options.nodeStyles["max-width"]=t,this.contentTooltip.nodeStyles&&(this.contentTooltip.nodeStyles.width=t,this.contentTooltip.nodeStyles["max-width"]=t),this.contentTooltip.node&&(this.contentTooltip.node.setStyle("width",t),this.contentTooltip.node.setStyle("max-width",t))),this.node&&this.node.setStyle("width",t),this.selectValueNode.setStyle("width",parseInt(t)-25)},createDefaultItem:function(){if(!this.options.containerIsTarget){this.selectValueNode=new Element("div.selectValueNode",{styles:this.css.selectValueNode}).inject(this.node),this.selectValueNode.setStyles({width:parseInt(this.options.width)-parseInt(this.options.height)-10+"px",height:this.options.height,"line-height":this.options.height});var t=this._getData(this.options.value),e=t?t[this.textField]:this.options.value;this.options.inputEnable?(this.inputNode=new Element("input",{value:e||this.options.defaultOptionLp,styles:this.css.inputNode}).inject(this.selectValueNode),this.inputNode.addEvents({focus:function(){this.inputNode.get("value")==this.options.defaultOptionLp&&this.inputNode.set("value","")}.bind(this),blur:function(){var t=!1,e=this.inputNode.get("value");if(""==e)this.inputNode.set("value",this.options.defaultOptionLp);else{for(var i=0;i<this.data.length;i++){var s=this.data[i];if(s[this.textField]==e){var o=this.itemNodeObject[s[this.valueField]];this.setCurrentItem(o),t=!0;break}}t||this.cancelCurrentItem()}}.bind(this)})):this.selectValueNode.set("text",e||this.options.defaultOptionLp),this.selectArrowNode=new Element("div.selectArrowNode",{styles:this.css.selectArrowNode}).inject(this.node),this.selectArrowNode.setStyles({width:this.options.height,height:this.options.height})}},setCurrentItem:function(t){var e=t.retrieve("data");this.currentItemNode&&this.currentItemNode.setStyles(this.css.listItemNode),this.currentItemNode=t,this.currentItemData=e,this.currentItemText=t.get("text"),this.options.isChangeOptionStyle&&t.setStyles(this.css.listItemNode_current),this.options.isSetSelectedValue&&this.selectValueNode&&(this.options.inputEnable?this.inputNode.set("value",e[this.textField]):this.selectValueNode.set("text",e[this.textField]))},cancelCurrentItem:function(){this.currentItemNode&&this.currentItemNode.setStyles(this.css.listItemNode),this.currentItemNode=null,this.currentItemData=null,this.currentItemText=null},parseData:function(t){if("string"==typeOf(t[0])){var e=[];return this.textField="text",this.valueField="value",this.options.emptyOptionEnable&&e.push({value:"",text:this.options.defaultOptionLp||""}),t.each(function(t){e.push({value:t,text:t})}.bind(this)),e}if(this.options.emptyOptionEnable&&this.textField){var i={};i[this.textField]=this.options.defaultOptionLp||"",this.valueField!=this.textField&&(i[this.valueField]=""),t.unshift(i)}return t},destroy:function(){this.node&&this.node.destroy(),this.contentTooltip&&this.contentTooltip.destroy()},showTooltip:function(){this.contentTooltip.load()},hide:function(){this.status="hidden",this.selectArrowNode&&this.selectArrowNode.setStyles(this.css.selectArrowNode),this.contentTooltip&&this.contentTooltip.hide()},setValue:function(t){if(this.options.isEdited){var e=this.itemNodeObject[t];if(e)this.setCurrentItem(e);else if(this.options.inputEnable){(i=this._getData(t))?this.inputNode.set("value",i[this.textField]):this.inputNode.set("value",t)}else{if(this.options.isSetSelectedValue&&this.selectValueNode)(i=this._getData(t))?this.selectValueNode.set("text",i[this.textField]):this.selectValueNode.set("text",t||""),this.value=t}}else{var i;(i=this._getData(t))?this.loadReadNode(i[this.textField]):this.loadReadNode(t)}},get:function(){return{value:this.getValue(),text:this.getText()}},getValue:function(){return this.options.isEdited?this.currentItemData&&this.valueField?this.currentItemData[this.valueField]:this.inputNode?this.inputNode.get("value"):this.value:this.value},getText:function(){if(this.options.isEdited){if(this.currentItemData&&this.textField)return this.currentItemData[this.textField];if(this.inputNode){var t=this._getData(this.inputNode.get("value"),"text");return t?t[this.textField]:this.inputNode.get("value")}return this.text}return this.text},getData:function(){if(this.currentItemData)return this.currentItemData;if(this.inputNode)return this.inputNode.get("value");if(!this.options.text||!this.options.value)return null;for(var t=0;t<this.data.length;t++){var e=this.data[t];if(this.options.text){if(e[this.textField]==this.options.text)return e}else if(this.options.value&&e[this.valueField]==this.options.value)return e}return null},_getData:function(t,e){for(var i=0;i<this.data.length;i++){var s=this.data[i];if("text"==e){if(s[this.textField]==t)return s}else if(s[this.valueField]==t)return s}return null},_selectItem:function(t,e,i){},_loadData:function(t){this.fireEvent("loadData",t)},_postCreateItem:function(t,e){}});MSelector.Tootips=new Class({Extends:MTooltips,options:{axis:"y",position:{x:"center",y:"bottom"},event:"click",hiddenDelay:200,displayDelay:0,hasArrow:!1},_customNode:function(t,e){this.data&&this.data.length>0?this.createItemList(this.data,e):this.selector.options.tooltipWhenNoSelectValue&&this.createNoSelectValueNode(e)},createNoSelectValueNode:function(t){var e=this.selector;this.css=e.css,e.selectArrowNode&&e.selectArrowNode.setStyles(this.css.selectArrowNode_up),e.listContentNode=new Element("div.listContentNode",{styles:this.css.listContentNode}).inject(t),e.listNode=new Element("div.listNode",{styles:this.css.listNode}).inject(e.listContentNode);var i=new Element("div.listItemNode",{styles:this.css.listItemNode,text:e.options.tooltipWhenNoSelectValue}).inject(e.listNode),s=parseFloat(e.options.height)+"px";i.setStyles({height:s,"line-height":s})},createItemList:function(t,e){t=t||[];var i=this.selector;this.css=i.css,i.selectArrowNode&&i.selectArrowNode.setStyles(this.css.selectArrowNode_up),i.listContentNode=new Element("div.listContentNode",{styles:this.css.listContentNode}).inject(e),i.listNode=new Element("div.listNode",{styles:this.css.listNode}).inject(i.listContentNode),i.options.hasScrollBar&&i.setScrollBar(i.listNode),t.each(function(t){this.createItem(t)}.bind(this))},createItem:function(t){var e=this.selector;if(e.listNode){var i=new Element("div.listItemNode",{styles:this.css.listItemNode,text:t[e.textField]}).inject(e.listNode);i.setStyles({height:e.options.height,"line-height":e.options.height}),t&&i.store("data",t),i.addEvents({mousedown:function(t){t.stopPropagation()},click:function(t){var e=this.obj,i=this.itemNode.retrieve("data");e.selector.setCurrentItem(this.itemNode),e.selector._selectItem(this.itemNode,i,t),e.selector.fireEvent("selectItem",[this.itemNode,i,t]),e.hide(),t.stopPropagation()}.bind({obj:this,itemNode:i}),mouseover:function(){this.obj.selector.currentItemNode==this.itemNode&&this.obj.selector.options.isChangeOptionStyle||this.itemNode.setStyles(this.obj.selector.css.listItemNode_over)}.bind({obj:this,itemNode:i}),mouseout:function(){this.obj.selector.currentItemNode==this.itemNode&&this.obj.selector.options.isChangeOptionStyle||this.itemNode.setStyles(this.obj.selector.css.listItemNode)}.bind({obj:this,itemNode:i})}),e.itemNodeList.push(i),e.itemNodeObject[t[e.valueField]]=i;var s=!1;e.currentItemData?s=t[e.valueField]==e.currentItemData[e.valueField]:e.value?s=t[e.valueField]==e.value:e.text&&(s=t[e.textField]==e.text),s&&e.setCurrentItem(i),e.fireEvent("postCreateItem",[i,t]),e._postCreateItem(i,t)}}}),MWF.xApplication.Template=MWF.xApplication.Template||{},MWF.xApplication.Template.MSelector=MSelector;