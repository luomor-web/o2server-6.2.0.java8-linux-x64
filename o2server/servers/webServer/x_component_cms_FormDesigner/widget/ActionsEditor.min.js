MWF.xApplication.cms.FormDesigner.widget=MWF.xApplication.cms.FormDesigner.widget||{},MWF.xDesktop.requireApp("process.FormDesigner","widget.ActionsEditor",null,!1),MWF.xApplication.cms.FormDesigner.widget.ActionsEditor=new Class({Extends:MWF.xApplication.process.FormDesigner.widget.ActionsEditor,load:function(t){this.loadActionsArea(),this.options.noCreate||this.loadCreateActionButton(),this.data=t,this.data&&"array"==typeOf(this.data)||(this.data=[]),this.loadRestoreActionButton(),this.data.each(function(t,i){var e=new MWF.xApplication.cms.FormDesigner.widget.ActionsEditor.ButtonAction(this);e.load(t),this.actions.push(e)}.bind(this))},listRemovedSystemTool:function(){var t=[];return this.defaultTools||MWF.getJSON("../x_component_cms_FormDesigner/Module/Actionbar/toolbars.json",function(t){this.defaultTools=t}.bind(this),!1),this.defaultTools.each(function(i){for(var e=!0,o=0;o<(this.data||[]).length;o++)if(this.data[o].id===i.id){e=!1;break}e&&t.push(i)}.bind(this)),t},addButtonAction:function(){var t={type:"MWFToolBarButton",img:"4.png",title:"",action:"",text:"Unnamed",actionScript:"",condition:"",editShow:!0,readShow:!0},i=new MWF.xApplication.cms.FormDesigner.widget.ActionsEditor.ButtonAction(this);i.load(t),this.data.push(t),this.actions.push(i),this.fireEvent("change")},restoreButtonAction:function(){var t=this.listRemovedSystemTool();if(t.length){var i=[];t.each(function(t){var e="";t.text&&this.designer.lp.actionBar&&(e=(e=this.designer.lp.actionBar[t.text.split(".").getLast().replace("}}","")]||"")?"  ("+e+")":""),i.push({name:t.text+e,id:t.id})}.bind(this)),MWF.xDesktop.requireApp("Template","Selector.Custom",null,!1);var e={count:0,title:this.designer.lp.actionbar.selectDefaultTool,selectableItems:i,values:[],onComplete:function(i){i&&0!=i.length&&(i.each(function(i){for(var e=0;e<t.length;e++)if(t[e].id===i.data.id){t[e].system=!0,this.data.push(t[e]);var o=new MWF.xApplication.cms.FormDesigner.widget.ActionsEditor.ButtonAction(this);o.load(t[e]),this.actions.push(o);break}}.bind(this)),this.fireEvent("change"))}.bind(this)};new MWF.xApplication.Template.Selector.Custom(this.options.maxObj,e).load()}}}),MWF.xApplication.cms.FormDesigner.widget.ActionsEditor.ButtonAction=new Class({Extends:MWF.xApplication.process.FormDesigner.widget.ActionsEditor.ButtonAction,loadNode:function(){if(this.node=new Element("div",{styles:this.css.actionNode}).inject(this.container),this.titleNode=new Element("div",{styles:this.css.actionTitleNode}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.actionIconNode}).inject(this.titleNode),this.textNode=new Element("div",{styles:this.css.actionTextNode,text:this.data.text}).inject(this.titleNode),this.data.text&&this.editor.designer.lp.actionBar){var t=this.editor.designer.lp.actionBar[this.data.text.split(".").getLast().replace("}}","")]||"";this.textNode.set("title",t||"")}this.upButton=new Element("div",{styles:this.css.actionUpButtonNode,title:this.editor.designer.lp.actionbar.up}).inject(this.titleNode),this.propertiesButton=new Element("div",{styles:this.css.actionPropertiesButtonNode,title:this.editor.designer.lp.actionbar.property}).inject(this.titleNode),this.data.properties&&0!==Object.keys(this.data.properties).length?this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property.png)"):this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property_empty.png)"),this.propertiesNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.propertiesArea=new MWF.widget.Maplist(this.propertiesNode,{title:this.editor.designer.lp.actionbar.setProperties,collapse:!1,onChange:function(){this.data.properties=this.propertiesArea.toJson(),this.data.properties&&0!==Object.keys(this.data.properties).length?this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property.png)"):this.propertiesButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/property_empty.png)"),this.editor.fireEvent("change")}.bind(this)}),this.propertiesArea.load(this.data.properties||{}),this.editor.options.noDelete||(this.delButton=new Element("div",{styles:this.css.actionDelButtonNode,text:"-",title:this.editor.designer.lp.actionbar.delete}).inject(this.titleNode)),this.conditionButton=new Element("div",{styles:this.css.actionConditionButtonNode,title:this.editor.designer.lp.actionbar.hideCondition}).inject(this.titleNode),this.data.condition?this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code.png)"):this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code_empty.png)"),this.editor.options.noEditShow||this.data.system||(this.editButton=new Element("div",{styles:this.css.actionEditButtonNode,title:this.editor.designer.lp.actionbar.edithide}).inject(this.titleNode),this.data.editShow?this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit.png)"):this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit_hide.png)")),this.editor.options.noReadShow||this.data.system||(this.readButton=new Element("div",{styles:this.css.actionReadButtonNode,title:this.editor.designer.lp.actionbar.readhide}).inject(this.titleNode),this.data.readShow?this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read.png)"):this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read_hide.png)"));var i=this.editor.path+this.editor.options.style+"/tools/"+this.data.img;this.iconNode.setStyle("background-image","url("+i+")"),this.editor.options.noCode||this.data.system||(this.scriptNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.scriptArea=new MWF.widget.ScriptArea(this.scriptNode,{title:this.editor.designer.lp.actionbar.editScript,maxObj:this.editor.designer.formContentNode,onChange:function(){this.data.actionScript=this.scriptArea.editor.getValue(),this.editor.fireEvent("change")}.bind(this),onSave:function(){this.data.actionScript=this.scriptArea.editor.getValue(),this.editor.fireEvent("change"),this.editor.designer.saveForm()}.bind(this),onPostLoad:function(){}.bind(this),helpStyle:"cms"}),this.scriptArea.load({code:this.data.actionScript})),this.conditionNode=new Element("div",{styles:this.css.actionScriptNode}).inject(this.node),this.conditionArea=new MWF.widget.ScriptArea(this.conditionNode,{title:this.editor.designer.lp.actionbar.editCondition,maxObj:this.editor.designer.formContentNode,onChange:function(){this.data.condition=this.conditionArea.editor.getValue(),this.data.condition?this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code.png)"):this.conditionButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/code_empty.png)"),this.editor.fireEvent("change")}.bind(this),onSave:function(){this.data.condition=this.conditionArea.editor.getValue(),this.editor.fireEvent("change"),this.editor.designer.saveForm()}.bind(this),onPostLoad:function(){}.bind(this),helpStyle:"cms"}),this.conditionArea.load({code:this.data.condition}),this.setEvent()},setEvent:function(){this.iconMenu=new MWF.widget.Menu(this.iconNode,{event:"click",style:"actionbarIcon",onPostShow:function(t){t.stopPropagation()}}),this.iconMenu.load();for(var t=this,i=-6;i<0;i++){var e="../x_component_cms_FormDesigner/Module/Actionbar/"+this.editor.options.style+"/custom/"+i+".png";this.iconMenu.addMenuItem("","click",(function(i){var e=this.item.getElement("img").get("src");t.data.img=e.substr(e.lastIndexOf("/")+1,e.length),t.iconNode.setStyle("background-image","url("+e+")"),t.editor.fireEvent("change"),i.stopPropagation()}),e).iconName=i+".png"}for(i=1;i<=134;i++){e="../x_component_cms_FormDesigner/Module/Actionbar/"+this.editor.options.style+"/custom/"+i+".png";this.iconMenu.addMenuItem("","click",(function(i){var e=this.item.getElement("img").get("src");t.data.img=e.substr(e.lastIndexOf("/")+1,e.length),t.iconNode.setStyle("background-image","url("+e+")"),t.editor.fireEvent("change"),i.stopPropagation()}),e).iconName=i+".png"}this.upButton.addEvent("click",function(t){var i=this.editor.actions,e=this.editor.data,o=e.indexOf(this.data),s=i.indexOf(this);if(0!==s&&0!==o){var n=s-1,d=i[n];this.node.inject(d.node,"before"),i[n]=i.splice(s,1,i[n])[0],this.editor.actions=i;var a=o-1;e[a]=e.splice(o,1,e[a])[0],this.editor.data=e,this.editor.fireEvent("change"),t.stopPropagation()}else t.stopPropagation()}.bind(this)),this.propertiesButton.addEvent("click",function(t){"none"==this.propertiesNode.getStyle("display")?this.propertiesNode.setStyle("display","block"):this.propertiesNode.setStyle("display","none"),t.stopPropagation()}.bind(this)),this.textNode.addEvent("click",function(t){this.textNode.empty();var i=new Element("input",{styles:this.css.actionEditTextNode,type:"text",value:this.data.text}).inject(this.textNode);i.focus(),i.select();var e=this;i.addEvent("blur",(function(){e.editTitleComplete(this)})),i.addEvent("keydown:keys(enter)",(function(){e.editTitleComplete(this)})),i.addEvent("click",(function(t){t.stopPropagation()})),t.stopPropagation()}.bind(this)),this.conditionButton.addEvent("click",function(t){t.stopPropagation(),this.editCondition()}.bind(this)),this.editButton&&this.editButton.addEvent("click",function(t){this.data.editShow?(this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit_hide.png)"),this.data.editShow=!1):(this.editButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/edit.png)"),this.data.editShow=!0),this.editor.fireEvent("change"),t.stopPropagation()}.bind(this)),this.readButton&&this.readButton.addEvent("click",function(t){this.data.readShow?(this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read_hide.png)"),this.data.readShow=!1):(this.readButton.setStyle("background-image","url("+this.editor.path+this.editor.options.style+"/icon/read.png)"),this.data.readShow=!0),this.editor.fireEvent("change"),t.stopPropagation()}.bind(this)),this.titleNode.addEvent("click",function(){this.scriptNode&&("none"==this.scriptNode.getStyle("display")?(this.scriptNode.setStyle("display","block"),this.scriptArea&&(this.scriptArea.resizeContentNodeSize(),this.scriptArea.editor&&this.scriptArea.editor.resize(),this.scriptArea.jsEditor||(this.scriptArea.contentNode.empty(),this.scriptArea.loadEditor({code:this.data.actionScript})))):this.scriptNode.setStyle("display","none"))}.bind(this)),this.delButton&&this.delButton.addEvent("click",function(t){var i=this;this.editor.designer.confirm("warn",this.delButton,MWF.APPFD.LP.notice.deleteButtonTitle,MWF.APPFD.LP.notice.deleteButton,300,120,(function(){i.destroy(),this.close()}),(function(){this.close()}),null),t.stopPropagation()}.bind(this))}});