MWF.xApplication.cms.FormDesigner.Module=MWF.xApplication.cms.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.Form",null,!1),MWF.xDesktop.requireApp("cms.FormDesigner","Property",null,!1),MWF.xApplication.cms.FormDesigner.Module.Form=MWF.CMSFCForm=new Class({Extends:MWF.FCForm,options:{style:"default",propertyPath:"../x_component_cms_FormDesigner/Module/Form/form.html",mode:"PC",fields:["Calendar","Checkbox","Datagrid","Datagrid$Title","Datagrid$Data","Datatable","Datatable$Title","Datatable$Data","Datatemplate","Htmleditor","Number","Office","Orgfield","Personfield","Readerfield","Authorfield","Org","Reader","Author","Radio","Select","Textarea","Textfield"],injectActions:[{name:"top",styles:"injectActionTop",event:"click",action:"injectTop",title:MWF.APPFD.LP.formAction.insertTop},{name:"bottom",styles:"injectActionBottom",event:"click",action:"injectBottom",title:MWF.APPFD.LP.formAction.insertBottom}]},initialize:function(e,t,s){this.setOptions(s),this.path="../x_component_process_FormDesigner/Module/Form/",this.cssPath="../x_component_process_FormDesigner/Module/Form/"+this.options.style+"/css.wcss",this._loadCss(),this.container=null,this.form=this,this.moduleType="form",this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.designer=e,this.container=t,this.selectedModules=[]},loadTemplateStyleFile:function(e,t){if(e){var s="../x_component_cms_FormDesigner/Module/Form/skin/"+e;MWF.getJSON(s,{onSuccess:function(e){t&&t(e)}.bind(this),onRequestFailure:function(){t&&t({})}.bind(this),onError:function(){t&&t({})}.bind(this)})}else t&&t({})},loadTemplateExtendStyleFile:function(e,t){if(e){var s="../x_component_cms_FormDesigner/Module/Form/skin/"+e;MWF.getJSON(s,{onSuccess:function(e){t&&t(e)}.bind(this),onRequestFailure:function(){t&&t({})}.bind(this),onError:function(){t&&t({})}.bind(this)})}else t&&t({})},loadStylesList:function(e){MWF.getJSON("../x_component_cms_FormDesigner/Module/Form/skin/config.json",{onSuccess:function(t){this.stylesList=t,e&&e(this.stylesList)}.bind(this),onRequestFailure:function(){this.stylesList={},e&&e(this.stylesList)}.bind(this),onError:function(){this.stylesList={},e&&e(this.stylesList)}.bind(this)})},loadModule:function(e,t,s){if(e){if(MWF["CMSFC"+e.type]){o=e.type.capitalize();return this.getTemplateData(o,function(o){var n=Object.clone(o);Object.merge(n,e),Object.merge(e,n),(i=new MWF["CMSFC"+e.type](this)).load(e,t,s)}.bind(this),!1),i}o=e.type.capitalize();return this.getTemplateData(o,function(o){var n=Object.clone(o);Object.merge(n,e),Object.merge(e,n),(i=new MWF.CMSFCDiv(this)).load(e,t,s)}.bind(this),!1),i}var i,o=(t.get("MWFType")||"div").capitalize();return this.getTemplateData(o,function(e){var n=Object.clone(e);n.id=t.get("id"),this.json.moduleList[t.get("id")]=n,(i=new MWF["CMSFC"+o](this)).load(n,t,s)}.bind(this),!1),i},createModule:function(e,t){this.getTemplateData(e,function(s){var i=Object.clone(s);new MWF["CMSFC"+e](this).create(i,t)}.bind(this))},getTemplateData:function(e,t,s){if(this.dataTemplate[e])t&&t(this.dataTemplate[e]);else{var i="../"+(-1!=MWF.CMSFD.ResetTemplateModules.indexOf(e.toLowerCase())?"x_component_cms_FormDesigner":"x_component_process_FormDesigner")+"/Module/"+e+"/template.json";MWF.getJSON(i,function(s,i){this.dataTemplate[e]=s,t&&t(s)}.bind(this),s)}},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.cms.FormDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},save:function(e){this.designer.saveForm()},implode:function(){MWF.xDesktop.requireApp("cms.FormDesigner","Import",function(){MWF.CMSFormImport.create("O2",this)}.bind(this))},implodeHTML:function(){MWF.xDesktop.requireApp("cms.FormDesigner","Import",function(){MWF.CMSFormImport.create("html",this,{type:"process"})}.bind(this))},implodeOffice:function(){MWF.xDesktop.requireApp("cms.FormDesigner","Import",function(){MWF.CMSFormImport.create("office",this)}.bind(this))},setPropertiesOrStyles:function(e){"styles"==e&&this.setCustomStyles(),"properties"==e&&this.node.setProperties(this.json.properties)},setCustomStyles:function(){var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode);var t=this.container.getStyle("height");t=t?t.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",t+"px"),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",e),Object.each(this.json.styles,function(e,t){t.test(/^border\w*/gi)||this.node.setStyle(t,e)}.bind(this))},_setEditStyle:function(e,t,s){if("name"==e){var i=this.json.name||this.json.id;this.treeNode.setText("<"+this.json.type+"> "+i+" ["+this.options.mode+"] ")}if("id"==e&&(this.json.name||this.treeNode.setText("<"+this.json.type+"> "+this.json.id+" ["+this.options.mode+"] "),this.treeNode.setTitle(this.json.id),this.node.set("id",this.json.id)),"formStyleType"==e){var o=this.stylesList&&this.json.formStyleType?this.stylesList[this.json.formStyleType].file:null,n=this.stylesList&&this.json.formStyleType?this.stylesList[this.json.formStyleType].extendFile:null;this.loadTemplateStyles(o,n,function(e){var t,i;this.templateStyles=e,s&&this.stylesList[s]&&(t=this.stylesList[s].file,i=this.stylesList[s].extendFile),this.loadTemplateStyles(t,i,function(e){this.json.styleConfig=this.stylesList&&this.json.formStyleType?this.stylesList[this.json.formStyleType]:null,e.form&&this.clearTemplateStyles(e.form),this.templateStyles.form&&this.setTemplateStyles(this.templateStyles.form),this.setAllStyles(),this.moduleList.each(function(t){e[t.moduleName]&&t.clearTemplateStyles(e[t.moduleName]),t.setStyleTemplate(),t.setAllStyles()}.bind(this))}.bind(this))}.bind(this))}"css"===e&&this.reloadCss(),this._setEditStyle_custom(e,t,s)},parseCSS:function(e){for(var t,s=/(url\(.*\))/g;null!==(t=s.exec(e));){var i=t[0],o=i.length,n=i.substring(i.length-2,i.length-1),r="'"===n||'"'===n?5:4,l="'"===n||'"'===n?2:1;if(-1!=(i=i.substring(r,i.length-l)).indexOf("x_processplatform_assemble_surface")||-1!=i.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var a=MWF.Actions.getHost("x_portal_assemble_surface");-1!==i.indexOf("/x_processplatform_assemble_surface")?i=i.replace("/x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface"):-1!==i.indexOf("x_processplatform_assemble_surface")&&(i=i.replace("x_processplatform_assemble_surface",i+"/x_processplatform_assemble_surface")),-1!==i.indexOf("/x_portal_assemble_surface")?i=i.replace("/x_portal_assemble_surface",a+"/x_portal_assemble_surface"):-1!==i.indexOf("x_portal_assemble_surface")&&(i=i.replace("x_portal_assemble_surface",a+"/x_portal_assemble_surface")),i=o2.filterUrl(i)}var c=(i="url('"+i+"')").length;e=e.substring(0,t.index)+i+e.substring(s.lastIndex,e.length),s.lastIndex=s.lastIndex+(c-o)}return e},preview:function(){MWF.xDesktop.requireApp("cms.FormDesigner","Preview",function(){"Mobile"==this.options.mode?this.previewBox=new MWF.xApplication.cms.FormDesigner.Preview(this,{size:{x:"340",y:580}}):this.previewBox=new MWF.xApplication.cms.FormDesigner.Preview(this),this.previewBox.load()}.bind(this))}});