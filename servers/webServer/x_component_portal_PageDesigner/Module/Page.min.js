MWF.xApplication.portal.PageDesigner.Module=MWF.xApplication.portal.PageDesigner.Module||{},MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.portal.PageDesigner.Module.Page=MWF.PCPage=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_portal_PageDesigner/Module/Page/page.html",mode:"PC",fields:["Calendar","Checkbox","Datagrid","Datagrid$Title","Datagrid$Data","Datatable","Datatable$Title","Datatable$Data","Datatemplate","Htmleditor","Number","Office","Orgfield","Org","Personfield","Radio","Select","Textarea","Textfield","Address","Combox"],injectActions:[{name:"top",styles:"injectActionTop",event:"click",action:"injectTop",title:MWF.APPPD.LP.formAction.insertTop},{name:"bottom",styles:"injectActionBottom",event:"click",action:"injectBottom",title:MWF.APPPD.LP.formAction.insertBottom}]},initializeBase:function(e){this.setOptions(e),this.path="../x_component_portal_PageDesigner/Module/Page/",this.cssPath="../x_component_portal_PageDesigner/Module/Page/"+this.options.style+"/css.wcss",this._loadCss()},initialize:function(e,t,i){this.initializeBase(i),this.container=null,this.page=this,this.form=this,this.moduleType="page",this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.designer=e,this.container=t,this.selectedModules=[]},reload:function(e){this.moduleList.each(function(e){e.property&&e.property.destroy()}.bind(this)),this.property&&this.property.destroy(),this.property=null,this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.selectedModules=[],this.container.empty(),this.treeNode&&(this.domTree.empty(),this.domTree.node.destroy(),this.domTree=null,this.treeNode=null),this.currentSelectedModule=null,this.propertyMultiTd=null,this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.load(e)},load:function(e){this.data=e,this.json=e.json,this.html=e.html,this.json.mode=this.options.mode,this.json.css||(this.json.css={code:""}),this.isNewPage=!this.json.id,this.isNewPage&&this.checkUUID(),this.designer.application&&(this.data.json.applicationName=this.designer.application.name),this.designer.application&&(this.data.json.application=this.designer.application.id),this.container.set("html",this.html),this.loadStylesList(function(){var e="";this.json.pageStyleType&&this.stylesList[this.json.pageStyleType]||(this.json.pageStyleType="blue-simple"),"Mobile"==this.options.mode&&"defaultMobile"!=this.json.pageStyleType&&(e=this.json.pageStyleType,this.json.pageStyleType="defaultMobile"),this.templateStyles=this.stylesList&&this.json.pageStyleType?this.stylesList[this.json.pageStyleType]:null,this.loadDomModules(),this.json.pageStyleType&&this.stylesList[this.json.pageStyleType]&&this.stylesList[this.json.pageStyleType].page&&this.setTemplateStyles(this.stylesList[this.json.pageStyleType].page),this.setCustomStyles(),this.node.setProperties(this.json.properties),this.setNodeEvents(),"Mobile"==this.options.mode&&e&&this._setEditStyle("pageStyleType",null,e),this.selected(),this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this)),this.fireEvent("postLoad")}.bind(this))},removeStyles:function(e,t){this.json[t]&&Object.each(e,function(e,i){this.json[t][i]&&this.json[t][i]==e&&delete this.json[t][i]}.bind(this))},copyStyles:function(e,t){this.json[t]||(this.json[t]={}),Object.each(e,function(e,i){this.json[t][i]||(this.json[t][i]=e)}.bind(this))},clearTemplateStyles:function(e){e&&(e.styles&&this.removeStyles(e.styles,"styles"),e.properties&&this.removeStyles(e.properties,"properties"))},setTemplateStyles:function(e){e.styles&&this.copyStyles(e.styles,"styles"),e.properties&&this.copyStyles(e.properties,"properties")},loadStylesList:function(e){var t="../x_component_portal_PageDesigner/Module/Page/template/"+(this.options.mode,"styles.json");MWF.getJSON(t,{onSuccess:function(t){this.stylesList=t,e&&e(this.stylesList)}.bind(this),onRequestFailure:function(){this.stylesList={},e&&e(this.stylesList)}.bind(this),onError:function(){this.stylesList={},e&&e(this.stylesList)}.bind(this)})},autoSave:function(){this.autoSaveCheckNode=this.designer.pageToolbarNode.getElement("#MWFPageAutoSaveCheck"),this.autoSaveCheckNode&&(this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4))},checkUUID:function(){this.designer.actions.getUUID(function(e){this.json.id=e}.bind(this))},loadDomModules:function(){this.node=this.container.getFirst(),this.node.set("id",this.json.id),this.node.setStyles(this.css.pageNode),this.node.store("module",this);var e=this.json.id.replace(/\-/g,"");(this.node.get("class")||"").split(" ").each(function(e){0===e.indexOf("css")&&35===e.length&&this.node.removeClass(e)}.bind(this)),this.node.addClass("css"+e),this.reloadCss();var t=this.container.getStyle("height");t=t?t.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",t+"px"),this.designer.addEvent("resize",function(){var e=this.container.getStyle("height");e=e?e.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",e+"px")}.bind(this)),this.loadDomTree()},loadDomTree:function(){MWF.require("MWF.widget.Tree",function(){this.domTree=new MWF.widget.Tree(this.designer.propertyDomArea,{style:"domtree"}),this.domTree.load(),this.createPageTreeNode(),this.parseModules(this,this.node)}.bind(this))},createPageTreeNode:function(){var e="<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",t={expand:!0,title:this.json.id,text:"<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",icon:"Mobile"==this.options.mode?"mobile.png":"pc.png",action:function(){this.module&&this.module.selected()}};this.treeNode=this.domTree.appendChild(t),this.treeNode.setText(e),this.treeNode.module=this},getModuleNodes:function(e,t){for(var i=[],s=e.getFirst();s;){var o=s.get("MWFtype")||s.get("mwftype");if(o){if(t)-1===o.indexOf("$")&&i.push(s);else i.push(s);i=i.concat(this.getModuleNodes(s))}else i=i.concat(this.getModuleNodes(s));s=s.getNext()}return i},parseModules:function(e,t){for(var i=null,s=t.getFirst();s;){if(s.get("MWFtype")){var o=this.getDomjson(s);o&&(module=this.loadModule(o,s,e))}o||(i=s),s=s.getNext(),i&&(i.destroy(),i=null)}},getDomjson:function(e){switch(e.get("MWFtype")){case"page":return this.json;case"":return null;default:var t=e.get("id");return t?this.json.moduleList[t]:null}},loadModule:function(e,t,i){if(e){var s=new MWF["PC"+e.type](this);return s.load(e,t,i),s}},setNodeEvents:function(){this.node.addEvent("click",function(e){this.selected()}.bind(this))},createModuleImmediately:function(e,t,i,s,o,n){var l;return this.getTemplateData(e,function(n){var a=Object.clone(n);l=new MWF["PC"+e](this),t&&(l.onDragModule=t,t.Component||(l.inContainer=t),l.parentContainer=t,l.nextModule=null),l.createImmediately(a,i,s,o)}.bind(this),n),l},createModule:function(e,t){this.getTemplateData(e,function(i){var s=Object.clone(i);new MWF["PC"+e](this).create(s,t)}.bind(this))},getTemplateData:function(e,t,i){if(this.dataTemplate[e])t&&t(this.dataTemplate[e]);else{var s="../x_component_portal_PageDesigner/Module/"+e+"/template.json";MWF.getJSON(s,function(i,s){this.dataTemplate[e]=i,t&&t(i)}.bind(this),i)}},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this)return!0;this.currentSelectedModule.unSelected()}this.propertyMultiTd&&(this.propertyMultiTd.hide(),this.propertyMultiTd=null),this.unSelectedMulti(),this.currentSelectedModule=this,this.treeNode&&this.treeNode.selectNode(),this.showProperty()},unSelectedMulti:function(){for(;this.selectedModules.length;)this.selectedModules[0].unSelectedMulti();this.multimoduleActionsArea&&this.multimoduleActionsArea.setStyle("display","none")},unSelectAll:function(){},_beginSelectMulti:function(){this.currentSelectedModule&&this.currentSelectedModule.unSelected(),this.unSelectedMulti(),this.noSelected=!0},_completeSelectMulti:function(){this.selectedModules.length<2?this.selectedModules[0].selected():this._showMultiActions()},createMultimoduleActionsArea:function(){this.multimoduleActionsArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999","z-index":10001}}).inject(this.page.container,"after")},_showMultiActions:function(){this.multimoduleActionsArea||this.createMultimoduleActionsArea();var e=this._getFirstMultiSelectedModule();if(e){var t=e.position.y-25,i=e.position.x;this.multimoduleActionsArea.setPosition({x:i,y:t}),this.multimoduleActionsArea.setStyle("display","block")}},_getFirstMultiSelectedModule:function(){var e=null;return this.selectedModules.each((function(t){var i=t.node.getPosition(t.form.node.getOffsetParent());e?(i.y<e.position.y||i.y==e.position.y&&i.x<e.position.x)&&(e={module:t,position:i}):e={module:t,position:i}})),e},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.process.FormDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},unSelected:function(){this.currentSelectedModule=null,this.hideProperty()},_dragIn:function(e){this.Component||(e.inContainer=this),e.parentContainer=this,this.node.setStyles({border:"1px solid #ffa200"}),e._getCopyNode().inject(this.node)},_dragOut:function(e){e.inContainer=null,e.parentContainer=null,this.node.setStyles(this.css.pageNode),this.node.setStyles(this.json.styles),e._getCopyNode().setStyle("display","none")},_dragDrop:function(e,t){(t||!new Event(event).control)&&(this.node.setStyles(this.css.pageNode),this.node.setStyles(this.json.styles))},_showInjectAction:function(e){e.moveNode&&e.moveNode.setStyle("display","none"),this.draggingModule=e,this.injectActionArea||this._createInjectAction(),this.injectActionArea.setStyle("display","block"),this._setInjectActionAreaPosition(),this.injectActionEffect=new Fx.Morph(this.injectActionArea,{duration:200,transition:Fx.Transitions.Sine.easeOut}),this.injectActionEffect.start(this.form.css.injectActionArea_to)},_hideInjectAction:function(){this.draggingModule=null,this.injectActionArea&&this.injectActionArea.setStyle("display","none")},_createInjectAction:function(){var e=this.form.css;if(!this.injectActionArea){this.injectActionArea=new Element("div",{styles:e.injectActionArea}).inject(this.form.container,"after"),this.injectActionTopBGNode=new Element("div",{styles:e.injectActionTopBGNode}).inject(this.injectActionArea),this.injectActionLeftBGNode=new Element("div",{styles:e.injectActionLeftBGNode}).inject(this.injectActionArea),this.injectActionRightBGNode=new Element("div",{styles:e.injectActionRightBGNode}).inject(this.injectActionArea),this.injectActionBottomBGNode=new Element("div",{styles:e.injectActionBottomBGNode}).inject(this.injectActionArea);var t={};this.options.injectActions.each((function(e){t[e.name]=e})),t.before&&this._createInjectActionNode(t.before,this.injectActionTopBGNode),t.top&&this._createInjectActionNode(t.top,this.injectActionLeftBGNode),t.bottom&&this._createInjectActionNode(t.bottom,this.injectActionRightBGNode),t.after&&this._createInjectActionNode(t.after,this.injectActionBottomBGNode),new Element("div",{styles:e.injectActionCancelNode,events:{click:function(){this.draggingModule._dragCancel(),this._dragDrop(this.node,!0),this._hideInjectAction()}.bind(this),mouseover:function(){this.setStyles(e.injectActionCancelNode_over)},mouseout:function(){this.setStyles(e.injectActionCancelNode)}}}).inject(this.injectActionArea)}},_createInjectActionNode:function(e,t){var i=new Element("div",{styles:this.css[e.styles],title:e.title}).inject(this.injectActionArea);i.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),i.addEvents({mouseover:function(i){t.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,e.name)}.bind(this),mouseout:function(e){t.setStyle("background","transparent")}.bind(this)}),t.set("title",e.title),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),t.setStyle("cursor","pointer"),t.addEvents({mouseenter:function(i){t.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,e.name)}.bind(this),mouseleave:function(e){t.setStyle("background","transparent")}.bind(this)})},_setInjectActionAreaPosition:function(){var e=new Event(event),t=this.node.getOffsetParent().getPosition(),i=e.page.y-t.y-60,s=e.page.x-t.x-60;this.injectActionArea.setPosition({x:s,y:i})},injectBefore:function(e){this.inject("before")},injectAfter:function(e){this.inject("after")},injectTop:function(e){this.inject("top")},injectBottom:function(e){this.inject("bottom")},inject:function(e){this.draggingModule.moveNode&&this.draggingModule.moveNode.setStyle("display",""),this.draggingModule._dragComplete(this.node,e),this._dragDrop(this.node,!0),this._hideInjectAction()},_resetTreeNode:function(){},_clearNoId:function(e){for(var t=e.getFirst();t;){var i=t.getNext();t.get("MWFType")?t.get("id")?t&&this._clearNoId(t):t.destroy():t&&this._clearNoId(t),t=i}},_getPageData:function(){this.fireEvent("queryGetPageData");var e=this.node.clone(!0,!0);e.clearStyles(!0),this.fireEvent("postGetPageData"),this._clearNoId(e);var t=e.outerHTML;return e.destroy(),this.data.json.mode=this.options.mode,this.data.html=t,this.data},preview:function(){var e="../x_desktop/portal.html?id="+this.json.application+"&page="+this.json.id;window.open(o2.filterUrl(e))},save:function(e){this.designer.savePage()},explode:function(){this._getPageData(),MWF.require("MWF.widget.Base64",null,!1);MWF.widget.Base64.encode(JSON.encode(this.data));MWF.require("MWF.widget.Panel",function(){var e=new Element("div"),t=(this.designer.pageNode.getSize(),this.designer.pageNode.getPosition(this.designer.pageNode.getOffsetParent()));new Element("textarea",{styles:{border:"1px solid #999",width:"770px","margin-left":"14px","margin-top":"14px",height:"580px"},text:JSON.encode(this.data)}).inject(e);this.explodePanel=new MWF.widget.Panel(e,{style:"page",isResize:!1,isMax:!1,title:"",width:800,height:660,top:t.y,left:t.x+3,isExpand:!1,target:this.designer.node}),this.explodePanel.load()}.bind(this))},implode:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("O2",this)}.bind(this))},implodeHTML:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("html",this)}.bind(this))},implodeOffice:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("office",this)}.bind(this))},deletePropertiesOrStyles:function(e,t){if("styles"==e)try{t&&this.json.styles[t]&&delete this.json.styles[t],this.setCustomStyles()}catch(e){}if("properties"==e)try{this.node.removeProperty(t)}catch(e){}},setPropertiesOrStyles:function(e){"styles"===e&&this.setCustomStyles(),"properties"===e&&this.node.setProperties(this.json.properties)},setCustomStyles:function(){var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles(this.css.pageNode);var t=this.container.getSize().y-2;this.node.setStyle("min-height",t+"px"),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",e),Object.each(this.json.styles,function(e,t){t.test(/^border\w*/gi)||this.node.setStyle(t,e)}.bind(this))},_setEditStyle:function(e,t,i){if("name"==e){var s=this.json.name||this.json.id;this.treeNode.setText("<"+this.json.type+"> "+s+" ["+this.options.mode+"] ")}if("id"==e&&(this.json.name||this.treeNode.setText("<"+this.json.type+"> "+this.json.id+" ["+this.options.mode+"] "),this.treeNode.setTitle(this.json.id),this.node.set("id",this.json.id)),"pageStyleType"==e){if(this.templateStyles=this.stylesList&&this.json.pageStyleType?this.stylesList[this.json.pageStyleType]:null,i){var o=this.stylesList[i];o&&o.page&&this.clearTemplateStyles(o.page)}this.templateStyles&&this.templateStyles.page&&this.setTemplateStyles(this.templateStyles.page),this.setAllStyles(),this.moduleList.each(function(e){o&&e.clearTemplateStyles(o[e.moduleName]),e.setStyleTemplate(),e.setAllStyles()}.bind(this))}"css"===e&&this.reloadCss(),this._setEditStyle_custom(e,t,i)},parseCSS:function(e){for(var t,i=/(url\(.*\))/g;null!==(t=i.exec(e));){var s=t[0],o=s.length,n=s.substring(s.length-2,s.length-1),l="'"===n||'"'===n?5:4,a="'"===n||'"'===n?2:1;if(-1!=(s=s.substring(l,s.length-a)).indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var r=MWF.Actions.getHost("x_portal_assemble_surface");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",r+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",r+"/x_portal_assemble_surface")),s=o2.filterUrl(s)}var d=(s="url('"+s+"')").length;e=e.substring(0,t.index)+s+e.substring(i.lastIndex,e.length),i.lastIndex=i.lastIndex+(d-o)}return e},reloadCss:function(){if(cssText=this.json.css?this.json.css.code:"",(n=$("style"+this.json.id))&&n.destroy(),cssText){cssText=this.parseCSS(cssText);for(var e,t=new RegExp("(.+)(?=\\{)","g"),i=this.json.id.replace(/\-/g,"");null!==(e=t.exec(cssText));){var s=".css"+i+" ",o=s+e[0];cssText=cssText.substring(0,e.index)+o+cssText.substring(t.lastIndex,cssText.length),t.lastIndex=t.lastIndex+s.length}var n;if((n=document.createElement("style")).setAttribute("type","text/css"),n.id="style"+this.json.id,n.inject(this.container,"before"),n.styleSheet){var l=function(){n.styleSheet.cssText=cssText};n.styleSheet.disabled?setTimeout(l,10):l()}else{var a=document.createTextNode(cssText);n.appendChild(a)}}},setAllStyles:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("properties"),this.reloadMaplist()},reloadMaplist:function(){this.property&&Object.each(this.property.maplists,function(e,t){e.reload(this.json[t])}.bind(this))},_setEditStyle_custom:function(){},saveAsTemplete:function(){},checkModuleId:function(e,t,i){var s=!1,o=!1;return this.json.moduleList[e]?(o=!0,-1==this.options.fields.indexOf(t)&&-1==this.options.fields.indexOf(this.json.moduleList[e].type)||(s=!0),{fieldConflict:s,elementConflict:o}):{fieldConflict:s,elementConflict:o}}});