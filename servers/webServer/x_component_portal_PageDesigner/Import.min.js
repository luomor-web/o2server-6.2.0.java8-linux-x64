MWF.xApplication=MWF.xApplication||{},MWF.xApplication.portal=MWF.xApplication.portal||{},MWF.xApplication.portal.PageDesigner=MWF.xApplication.portal.PageDesigner||{},MWF.xApplication.portal.PageDesigner.Import=MWF.FormImport=MWF.PageImport=new Class({Implements:[Options,Events],options:{style:"default",type:"portal",stylePath:"../x_component_portal_PageDesigner/$Import/{style}/style.css",viewPath:"../x_component_portal_PageDesigner/$Import/{style}/view.html"},initialize:function(e,t){this.setOptions(t),this.path="../x_component_portal_PageDesigner/$Import/",this.stylePath=this.options.stylePath.replace("{style}",this.options.style),this.viewPath=this.options.viewPath.replace("{style}",this.options.style),this.form=e,this.init(),this.loadView()},init:function(){this.inforText=this.form.designer.lp.importO2_infor,this.panelTitle=this.form.designer.lp.importO2,this.panelWidth=800,this.panelHeight=660,this.editorMode="json"},loadView:function(){MWF.require("MWF.widget.Panel",function(){this.node=new Element("div.importNode"),this.node.set("load",{onSuccess:function(){this.inforNode=this.node.getElement(".importInfor"),this.contentNode=this.node.getElement(".importContent"),this.bottomNode=this.node.getElement(".importBottom"),this.okNode=this.node.getElement(".importOkButton"),this.cancelNode=this.node.getElement(".importCancelButton"),o2.loadCss(this.stylePath,this.node,function(){this.load()}.bind(this))}.bind(this)}).load(this.viewPath);var e=this.form.designer.pageNode||this.form.designer.formNode,t=e.getPosition(e.getOffsetParent());this.implodePanel=new MWF.widget.Panel(this.node,{style:"wizard",isResize:!1,isMax:!1,title:this.panelTitle,width:this.panelWidth,height:this.panelHeight,top:t.y,left:t.x+3,isExpand:!1,target:this.form.designer.node}),this.implodePanel.load()}.bind(this))},load:function(){this.loadContent(),this.loadEditor(),this.loadEvent()},loadContent:function(){this.inforNode.set("html",this.inforText),this.okNode.set("text",this.form.designer.lp.import_ok),this.cancelNode.set("text",this.form.designer.lp.import_cancel)},loadEditor:function(){MWF.require("MWF.widget.ScriptArea",function(){this.scriptArea=new MWF.widget.ScriptArea(this.contentNode,{isload:!0,style:"page",isbind:!1,mode:this.editorMode}),this.scriptArea.load({code:""})}.bind(this))},loadEvent:function(){this.cancelNode.addEvent("click",function(){this.implodePanel.closePanel()}.bind(this)),this.okNode.addEvent("click",function(e){var t=this.scriptArea.editor.getValue();if(!t)return this.form.designer.notice(this.form.designer.lp.implodeEmpty,"error",this.node),!1;var i=this;this.form.designer.confirm("warn",e,this.form.designer.lp.implodeConfirmTitle,this.form.designer.lp.implodeConfirmText,400,100,(function(){i.implode(t),this.close()}),(function(){this.close()}))}.bind(this))},implode:function(e){if(e){var t=JSON.decode(e);if(t&&t.json&&t.html){var i=t.json;t.id=this.form.data.id,t.isNewPage=this.form.data.isNewPage,i.id=this.form.json.id,i.name=this.form.json.name,i.application=this.form.json.application,i.applicationName=this.form.json.applicationName,this.form.reload(t),this.implodePanel.closePanel()}else this.form.designer.notice(this.designer.lp.implodeError,"error",this.node)}else this.form.designer.notice(this.designer.lp.implodeEmpty,"error",this.node)}}),MWF.FormImport.O2=new Class({Extends:MWF.FormImport}),MWF.FormImport.Html=new Class({Extends:MWF.FormImport,options:{stylePath:"../x_component_portal_PageDesigner/$Import/{style}/style_html.css",viewPath:"../x_component_portal_PageDesigner/$Import/{style}/view_html.html"},init:function(){this.inforText=this.form.designer.lp.importHTML_infor,this.inforText2=this.form.designer.lp.importHTML_infor2,this.panelTitle=this.form.designer.lp.importHTML,this.panelWidth=800,this.panelHeight=700,this.editorMode="html"},loadContent:function(){this.inforTextNode=this.node.getElement(".importInforText"),this.inforOptionsNode=this.node.getElement(".importInforOption"),this.inforTextNode.set("html",this.inforText),this.inforText2Node=this.node.getElement(".importInforText2"),this.inforText2Node.set("html",this.inforText2),this.contentHtml=this.node.getElement(".importContentHtml"),this.contentCss=this.node.getElement(".importContentCss");var e="<input type='checkbox'>"+this.form.designer.lp.import_option1;e+="<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><input type='checkbox'>"+this.form.designer.lp.import_option2,this.inforOptionsNode.set("html",e);var t=this.inforOptionsNode.getElements("input");this.option1=t[0],this.option2=t[1],this.okNode.set("text",this.form.designer.lp.import_ok),this.cancelNode.set("text",this.form.designer.lp.import_cancel)},loadEditor:function(){MWF.require("MWF.widget.ScriptArea",function(){this.scriptArea=new MWF.widget.ScriptArea(this.contentHtml,{isload:!0,style:"page",isbind:!1,mode:this.editorMode}),this.scriptArea.load({code:""})}.bind(this)),MWF.require("MWF.widget.ScriptArea",function(){this.cssArea=new MWF.widget.ScriptArea(this.contentCss,{isload:!0,style:"page",isbind:!1,mode:"css"}),this.cssArea.load({code:""})}.bind(this))},implode:function(e){MWF.require("MWF.widget.Mask",null,!1);var t=this.implodePanel.container.getStyle("z-index").toInt(),i=new MWF.widget.Mask({zIndex:t});i.loadNode(this.form.designer.content);try{var o=new Element("iframe").inject(document.body),n=o.contentWindow.document;o2.load("mootools",{doc:n},function(){var t=this.form.node.get("html"),s=this.form.json.moduleList,r=this.form.data.html;try{n.body.set("html",e),n.body.normalize();var l={},d=[],a=n.body.getElements("style");a&&this.loadStyles(a);var c="";for(this.cssArea&&(c=this.cssArea.editor.getValue())&&(this.form.json.css.code+=this.parseImplodeCSS(c,n)),this.parseImplodeHTML(n.body,l,n,d);d.length;)d.shift().destroy();var m=n.body.get("html");this.form.node.empty();var p=this.form.node.outerHTML.split(/\>\s*\</);m=p[0]+">"+m+"<"+p[1],this.form.json.moduleList=l,this.form.data.html=m,this.form.reload(this.form.data),o.destroy(),this.implodePanel.closePanel(),i.hide()}catch(e){this.form.designer.notice(e.message,"error",this.node),this.form.node.set("html",t),this.form.json.moduleList=s,this.form.data.html=r,this.form.reload(this.form.data),i.hide()}finally{t=null,s=null,s=null}}.bind(this))}catch(e){this.form.designer.notice(e.message,"error",this.node),i.hide()}},parseImplodeCSS:function(e,t,i){for(var o,n=/(url\(.*\))/g;null!==(o=n.exec(e));){var s=o[0],r=s.length,l=s.substring(s.length-2,s.length-1),d="'"===l||'"'===l?2:1;s=s.substring(s.lastIndexOf("/")+1,s.length-d);var a="portal"===this.options.type?"x_portal_assemble_surface":"x_processplatform_assemble_surface",c=a+o2.Actions.get(a).action.actions.readFile.uri,m=(c="url('"+(c=(c=c.replace("{flag}",s)).replace("{applicationFlag}",this.form.json.application||this.form.json.portal))+"')").length;e=e.substring(0,o.index)+c+e.substring(n.lastIndex,e.length),n.lastIndex=n.lastIndex+(m-r)}return e},loadStyles:function(e){var t="";e.each(function(e){t+=e.get("text")}.bind(this)),e.destroy(),this.form.json.css.code=t},getInnerStyles:function(e){var t={};(style=e.get("style"),style)&&style.split(/\s*\;\s*/g).each(function(e){if(e){var i=e.split(/\s*\:\s*/g);t[i[0]]=i.length>1?i[1]:""}}.bind(this));return t},getInnerProperties:function(e){var t={};if(e.attributes.length)for(var i=0;i<e.attributes.length;i++){var o=e.attributes[i].nodeName.toString().toLowerCase();"mwftype"!==o&&"id"!==o&&"style"!==o&&(t[o]=e.attributes[i].nodeValue)}return t},getImplodeModuleJson:function(e,t,i,o,n){var s=i;t=t;this.form.getTemplateData(t,function(r){for(var l=Object.clone(r),d=1;e[s];)s=i+"_"+d,d++;o.nodeType===Node.ELEMENT_NODE?(l.styles=this.getInnerStyles(o),l.properties=this.getInnerProperties(o)):o.nodeType===Node.TEXT_NODE&&(l.styles.display="inline"),"Label"===t&&(l.styles.display="inline"),l.id=s,e[s]=l,n&&n(s,l)}.bind(this),!1)},convertTextLabelNode:function(e,t){return e.nodeValue.trim()&&this.getImplodeModuleJson(t,"Label","label",e,function(t,i){i.text=e.nodeValue;var o=new Element("div#"+t,{mwftype:"label",text:i.text});e.replaceWith?e.replaceWith(o):e.replaceNode&&e.replaceNode(o),e=o}.bind(this)),e},convertLabelNode:function(e,t,i){return this.getImplodeModuleJson(t,"Label",e.get("id")||"label",e,function(t,o){if(o.text=e.get("text"),"div"!==i){var n=new Element("div#"+t,{mwftype:"label",text:o.text}).inject(e,"before");e.destroy(),e=n}else e.set({mwftype:"label",id:t})}.bind(this)),e},convertDivNode:function(e,t,i){return this.getImplodeModuleJson(t,"Div",e.get("id")||"div",e,function(t,o){if("p"===i){var n=new Element("div#"+t,{mwftype:"div"}).inject(e,"before");n.set("html",e.get("html")),n.set("MWFOriginalTag","p"),e.destroy(),e=n}else e.set({mwftype:"div",id:t})}.bind(this)),e},convertTableNode:function(e,t){return this.getImplodeModuleJson(t,"Table",e.get("id")||"table",e,function(t,i){i.styles.display="table";var o=new Element("div#"+t,{mwftype:"table"}).inject(e,"before");e.inject(o)}.bind(this)),e},convertTdNode:function(e,t){return this.getImplodeModuleJson(t,"Table$Td",e.get("id")||"table$Td",e,function(t){e.set({mwftype:"table$Td",id:t})}.bind(this)),e},convertImgNode:function(e,t){return this.getImplodeModuleJson(t,"Image",e.get("id")||"image",e,function(t,i){var o=e.get("src");if(o){var n="portal"===this.options.type?"x_portal_assemble_surface":"x_processplatform_assemble_surface",s=o.substring(o.lastIndexOf("/")+1,o.length),r=n+o2.Actions.get(n).action.actions.readFile.uri;r=(r=r.replace("{flag}",s)).replace("{applicationFlag}",this.form.json.application||this.form.json.portal),i.properties.src=r,e.set("src",r)}e.set({mwftype:"img",id:t})}.bind(this)),e},convertInputImgNode:function(e,t){return this.getImplodeModuleJson(t,"Img",e.get("id")||"img",e,function(t){var i=new Element("img#"+t,{mwftype:"img"}).inject(e,"before");e.destroy(),e=i}.bind(this)),e},convertButtonNode:function(e,t){return this.getImplodeModuleJson(t,"Button",e.get("id")||"button",e,function(t,i){var o=e.get("value");o&&(i.name=o),delete i.properties.type,delete i.properties.name;var n=new Element("div#"+t,{mwftype:"button"}).inject(e,"before");e.inject(n)}.bind(this)),e},convertIframeNode:function(e,t){return this.getImplodeModuleJson(t,"Iframe",e.get("id")||"iframe",e,function(t,i){i.properties.src&&(i.src=i.properties.src,delete i.properties.src);var o=new Element("div#"+t,{mwftype:"iframe"}).inject(e,"before");e.destroy(),e=o}.bind(this)),e},convertTextareaNode:function(e,t){return this.getImplodeModuleJson(t,"Textarea",e.get("id")||"textarea",e,function(t,i){var o=e.get("text");if(o){i.defaultValue||(i.defaultValue={code:"",html:""});var n=o.replace(/\"/g,'\\"');i.defaultValue.code='return "'+n+'"'}var s=new Element("div#"+t,{mwftype:"textarea"}).inject(e,"before");e.destroy(),e=s}.bind(this)),e},convertSelectNode:function(e,t){return this.getImplodeModuleJson(t,"Select",e.get("id")||"select",e,function(t,i){var o=e.getElements("option");i.itemValues=[],o.each(function(e){var t=e.get("text"),o=e.get("value")||t;i.itemValues.push(t+"|"+o)}.bind(this));var n=new Element("div#"+t,{mwftype:"select"}).inject(e,"before");e.destroy(),e=n}.bind(this)),e},convertTextfieldNode:function(e,t){return this.getImplodeModuleJson(t,"Textfield",e.get("id")||"textfield",e,function(t,i){if(e.get("value")){i.defaultValue||(i.defaultValue={code:"",html:""});var o=i.properties.value.replace(/\"/g,'\\"');i.defaultValue.code='return "'+o+'"'}delete i.properties.type,delete i.properties.name;var n=new Element("div#"+t,{mwftype:"textfield"}).inject(e,"before");e.destroy(),e=n}.bind(this)),e},convertNumberNode:function(e,t){return this.getImplodeModuleJson(t,"Number",e.get("id")||"number",e,function(t,i){if(e.get("value")){i.defaultValue||(i.defaultValue={code:"",html:""});var o=i.properties.value.replace(/\"/g,'\\"');i.defaultValue.code='return "'+o+'"'}delete i.properties.type,delete i.properties.name;var n=new Element("div#"+t,{mwftype:"number"}).inject(e,"before");e.destroy(),e=n}.bind(this)),e},convertCalendarNode:function(e,i){return this.getImplodeModuleJson(i,"Calendar",e.get("id")||"calendar",e,function(i,o){if(e.get("value")){o.defaultValue||(o.defaultValue={code:"",html:""});var n=o.properties.value.replace(/\"/g,'\\"');o.defaultValue.code='return "'+n+'"'}"date"===t&&(o.selectType="date"),"time"===t&&(o.selectType="time"),delete o.properties.type,delete o.properties.name;var s=new Element("div#"+i,{mwftype:"calendar"}).inject(e,"before");e.destroy(),e=s}.bind(this)),e},convertRadioNode:function(e,t){return this.getImplodeModuleJson(t,"Radio",e.get("id")||"radio",e,function(t,i){i.itemValues=[];var o=e.nextSibling;o&&o.nodeType===Node.TEXT_NODE&&(text=o.nodeValue,o.remove?o.remove():o.removeNode&&o.removeNode());var n=e.get("value");i.itemValues.push(text+"|"+n),delete i.properties.type,delete i.properties.name,delete i.properties.value;var s=new Element("div#"+t,{mwftype:"radio"}).inject(e,"before");e.destroy(),e=s}.bind(this)),e},convertCheckboxNode:function(e,t){return this.getImplodeModuleJson(t,"Checkbox",e.get("id")||"checkbox",e,function(t,i){i.itemValues=[];var o=e.nextSibling;o&&o.nodeType===Node.TEXT_NODE&&(text=o.nodeValue,o.remove?o.remove():o.removeNode&&o.removeNode());var n=e.get("value");i.itemValues.push(text+"|"+n),delete i.properties.type,delete i.properties.name,delete i.properties.value;var s=new Element("div#"+t,{mwftype:"checkbox"}).inject(e,"before");e.destroy(),e=s}.bind(this)),e},convertCommonTextNode:function(e,t,i){return this.getImplodeModuleJson(t,"Common",e.get("id")||"common",e,function(t,o){o.innerHTML=e.get("text"),o.tagName=i,e.set({mwftype:"common",id:t}),e.empty()}.bind(this)),e},convertCommonNode:function(e,t,i){return this.getImplodeModuleJson(t,"Common",e.get("id")||"common",e,function(t,o){o.tagName=i,e.set({mwftype:"common",id:t})}.bind(this)),e},checkNodeEmpty:function(e){return e.nodeType===Node.TEXT_NODE?!e.nodeValue.trim():e.nodeType===Node.ELEMENT_NODE&&(!e.getElements("input").length&&(!e.getElements("img").length&&(!e.getElements("button").length&&(!e.getElements("audio").length&&(!e.getElements("canvas").length&&(!e.getElements("iframe").length&&(!e.getElements("object").length&&(!e.getElements("select").length&&(!e.getElements("video").length&&!e.get("text").trim())))))))))},parseImplodeHTML:function(e,t,i,o){if(e)for(var n=e.childNodes,s=0;s<n.length;s++){var r=n[s];if(r){r.normalize();var l=!0;if(r.nodeType===Node.TEXT_NODE&&(r=this.convertTextLabelNode(r,t),l=!1),r.nodeType===Node.ELEMENT_NODE){var d=r.tagName.toString().toLowerCase();if(this.option2.checked&&"table"!==d&&"td"!==d&&"th"!==d&&"tr"!==d&&"tbody"!==d&&"thead"!==d&&"tfoot"!==d&&"input"!==d&&"img"!==d&&"button"!==d&&"audio"!==d&&"canvas"!==d&&"iframe"!==d&&"object"!==d&&"select"!==d&&"video"!==d&&this.checkNodeEmpty(r)&&(r.readyDelete=!0,o.push(r)),r.readyDelete)continue;switch(d){case"div":1===r.childNodes.length&&r.childNodes[0].nodeType===Node.TEXT_NODE&&r.childNodes[0].nodeValue.trim()?(r=this.convertLabelNode(r,t,d),l=!1):r=this.convertDivNode(r,t,d);break;case"table":r=this.convertTableNode(r,t);break;case"colgroup":case"col":case"br":case"tr":break;case"th":case"td":this.option1.checked&&this.checkNodeEmpty(r)&&new Element("input",{tyep:"text"}).inject(r);break;case"img":r=this.convertImgNode(r,t),l=!1;break;case"button":r=this.convertButtonNode(r,t),l=!1;break;case"iframe":r=this.convertIframeNode(r,t),l=!1;break;case"textarea":r=this.convertTextareaNode(r,t),l=!1;break;case"select":r=this.convertSelectNode(r,t),l=!1;break;case"input":switch(r.get("type").toString().toLowerCase()){case"text":r=this.convertTextfieldNode(r,t);break;case"number":r=this.convertNumberNode(r,t);break;case"reset":case"submit":case"button":r=this.convertCommonNode(r,t,d);break;case"datetime":case"datetime-local":case"time":case"date":r=this.convertCalendarNode(r,t);break;case"radio":r=this.convertRadioNode(r,t);break;case"checkbox":r=this.convertCheckboxNode(r,t);break;case"file":break;case"image":r=this.convertInputImgNode(r,t);break;default:r=this.convertTextfieldNode(r,t)}l=!1;break;case"base":case"tbody":case"thead":case"tfoot":break;default:1===r.childNodes.length&&r.childNodes[0].nodeType===Node.TEXT_NODE&&r.childNodes[0].nodeValue.trim()?(r=this.convertCommonTextNode(r,t,d),l=!1):r=this.convertCommonNode(r,t,d)}}l&&this.parseImplodeHTML(r,t,i,o)}}}}),MWF.FormImport.Office=new Class({Extends:MWF.FormImport.Html,options:{stylePath:"../x_component_portal_PageDesigner/$Import/{style}/style_office.css"},init:function(){this.inforText=this.form.designer.lp.importOffice_infor,this.inforText2=this.form.designer.lp.importOffice_infor2,this.panelTitle=this.form.designer.lp.importOffice,this.panelWidth=800,this.panelHeight=240,this.editorMode="html"},loadEditor:function(){this.contentCss&&this.contentCss.destroy(),this.inforText2Node&&this.inforText2Node.destroy(),this.file=new Element("input.importFile",{type:"file",accept:".doc,.docx,.xls,.xlsx"}).inject(this.contentHtml)},loadEvent:function(){this.cancelNode.addEvent("click",function(){this.implodePanel.closePanel()}.bind(this)),this.okNode.addEvent("click",function(e){var t=this.file.files;if(!t.length)return this.form.designer.notice(this.form.designer.lp.implodeOfficeEmpty,"error",this.node),!1;var i=this;this.form.designer.confirm("warn",e,this.form.designer.lp.implodeConfirmTitle,this.form.designer.lp.implodeConfirmText,400,100,(function(){i.implodeOffice(t),this.close()}),(function(){this.close()}))}.bind(this))},implodeOffice:function(e){var t=e.item(0),i=new FormData;i.append("file",t),MWF.Actions.get("x_general_assemble_control").convertHtml(i,t,function(e){var t=e.data.value;this.implode(t)}.bind(this))}}),MWF.FormImport.create=function(e,t,i){return new(MWF.FormImport[e.capitalize()])(t,i)};