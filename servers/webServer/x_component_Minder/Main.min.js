MWF.require("MWF.widget.Tree",null,!1),MWF.xApplication.Minder.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"Minder",icon:"icon.png",width:"1200",height:"700",isResize:!1,title:MWF.xApplication.Minder.LP.title,defaultAction:"openMineExplorer"},onQueryLoad:function(){this.lp=MWF.xApplication.Minder.LP,this.restActions=MWF.Actions.get("x_mind_assemble_control")},loadApplication:function(t){this.createNode(),this.loadApplicationContent(),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},loadApplicationContent:function(){this.naviNode=new Element("div.naviNode",{styles:this.css.naviNode}).inject(this.node),new Element("div.naviTopNode",{styles:this.css.naviTopNode}).inject(this.naviNode),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.node),this.resizeContent(),this.resizeFun=this.resizeContent.bind(this),this.addEvent("resize",this.resizeFun),this.loadNavi()},loadNavi:function(){[{title:"我的文件",action:"openMineExplorer",icon:"navi_mine"},{title:"分享文件",action:"openSharedExplorer",icon:"navi_share"},{title:"收到文件",action:"openReceivedExplorer",icon:"navi_receive"},{title:"回收站",action:"openRecycleExplorer",icon:"navi_recycle"}].each(function(t){this.createNaviNode(t)}.bind(this))},openMineExplorer:function(){MWF.xDesktop.requireApp("Minder","MineExplorer",null,!1),this.currentExplorer&&this.currentExplorer.destroy();var t=this.status&&this.status.explorerStatus?this.status.explorerStatus:{};this.currentExplorer=new MWF.xApplication.Minder.MineExplorer(this.contentNode,this,t),this.currentExplorer.load()},openSharedExplorer:function(){MWF.xDesktop.requireApp("Minder","SharedExplorer",null,!1),this.currentExplorer&&this.currentExplorer.destroy();var t=this.status&&this.status.explorerStatus?this.status.explorerStatus:{};this.currentExplorer=new MWF.xApplication.Minder.SharedExplorer(this.contentNode,this,t),this.currentExplorer.load()},openReceivedExplorer:function(){MWF.xDesktop.requireApp("Minder","ReceivedExplorer",null,!1),this.currentExplorer&&this.currentExplorer.destroy();var t=this.status&&this.status.explorerStatus?this.status.explorerStatus:{};this.currentExplorer=new MWF.xApplication.Minder.ReceivedExplorer(this.contentNode,this,t),this.currentExplorer.load()},openRecycleExplorer:function(){MWF.xDesktop.requireApp("Minder","RecycleBinExplorer",null,!1),this.currentExplorer&&this.currentExplorer.destroy();var t=this.status&&this.status.explorerStatus?this.status.explorerStatus:{};this.currentExplorer=new MWF.xApplication.Minder.RecycleBinExplorer(this.contentNode,this,t),this.currentExplorer.load()},createNaviNode:function(t){var e=this,i=new Element("div",{text:t.title,styles:this.css.naviItemNode,events:{click:function(i){e.currentAction!=t.action&&(i.target.setStyles(e.css.naviItemNode_selected),e.currentNaviItemNode&&e.currentNaviItemNode.setStyles(e.css.naviItemNode),e.currentNaviItemNode=i.target,e.currentAction=t.action,e[t.action]())}}}).inject(this.naviNode);i.setStyle("background-image","url("+this.path+this.options.style+"/icon/"+t.icon+".png)"),(this.status&&this.status.action&&this.status.action==t.action||this.options.defaultAction==t.action)&&i.click()},recordStatus:function(){return{action:this.currentAction,explorerStatus:this.currentExplorer.recordStatus()}},resizeContent:function(){var t=this.content.getSize();this.naviNode.setStyle("height",t.y)},getDateDiff:function(t){if(!t)return"";var e=Date.parse(t.replace(/-/gi,"/")),i=864e5,n=(new Date).getTime()-e,s=(new Date).decrement("day",1),o=(new Date).decrement("day",2),r=n/31104e6,a=n/2592e6,c=n/(7*i),h=n/i,l=n/36e5,d=n/6e4;return s.getFullYear()==e.getFullYear()&&s.getMonth()==e.getMonth()&&s.getDate()==e.getDate()?result="昨天 "+e.getHours()+":"+e.getMinutes():o.getFullYear()==e.getFullYear()&&o.getMonth()==e.getMonth()&&o.getDate()==e.getDate()?result="前天 "+e.getHours()+":"+e.getMinutes():result=r>1||a>=1?e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate():c>=1?parseInt(c)+"周前":h>=1?parseInt(h)+"天前":l>=1?parseInt(l)+"小时前":d>=1?parseInt(d)+"分钟前":"刚刚",result}}),MWF.xApplication.Minder.History=new Class({initialize:function(t){this.app=t,this.css=t.css,this.MAX_HISTORY=100,this.lastSnap,this.patchLock,this.undoDiffs=[],this.redoDiffs=[],this.reset(),this.app.addEvent("patchChange",this.changed.bind(this))},load:function(t){this.node?this.node.inject(t):this.loadNode(t)},loadNode:function(t){this.node=new Element("div",{styles:this.css.historyNode}).inject(t),this.undoNode=new Element("div",{styles:this.css.undoNode}).inject(this.node),this.redoNode=new Element("div",{styles:this.css.redoNode}).inject(this.node),this.patchNode=new Element("div",{styles:this.css.patchNode}).inject(this.node)},reset:function(){this.undoDiffs=[],this.redoDiffs=[],this.lastSnap="mine/root"},makeUndoDiff:function(t){if(t!=this.lastSnap){for(this.undoDiffs.push(t);this.undoDiffs.length>this.MAX_HISTORY;)this.undoDiffs.shift();return this.lastSnap=t,!0}},makeRedoDiff:function(t){this.redoDiffs.push(t)},undo:function(){this.patchLock=!0;var t=this.undoDiffs.pop();t&&(this.app.applyPatches(t),this.makeRedoDiff(t)),this.patchLock=!1},redo:function(){this.patchLock=!0;var t=this.redoDiffs.pop();t&&(this.app.applyPatches(t),this.makeUndoDiff(t)),this.patchLock=!1},changed:function(t){this.patchLock||this.makeUndoDiff(t)&&(this.redoDiffs=[])},hasUndo:function(){return!!this.undoDiffs.length},hasRedo:function(){return!!this.redoDiffs.length}});