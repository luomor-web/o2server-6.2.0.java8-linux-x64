MWF.require("MWF.widget.AttachmentController",null,!1),MWF.xApplication.Forum.Attachment=new Class({Implements:[Options,Events],options:{documentId:"",isNew:!1,isEdited:!0,size:"max",isSizeChange:!0},initialize:function(t,e,i,n,a){this.setOptions(a),this.app=e,this.node=$(t),this.actions=i,this.lp=n},load:function(){this.loadAttachmentController()},loadAttachmentController:function(){var t={style:"cms",title:this.lp.attachmentArea,size:this.options.size,resize:!0,isUpload:this.options.isNew||this.options.isEdited,isDelete:this.options.isNew||this.options.isEdited,isReplace:!1,isDownload:!0,isSizeChange:this.options.isSizeChange,readonly:!this.options.isNew&&!this.options.isEdited};this.attachmentController=new MWF.widget.ATTER(this.node,this,t),this.attachmentController.load(),this.data?this.data.each(function(t){this.attachmentController.addAttachment(t)}.bind(this)):!this.options.isNew&&this.options.documentId&&""!=this.options.documentId&&this.listAttachment(function(t){t.data.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},transportData:function(t){if("array"==typeOf(t.data))t.data.each((function(t){t.person=t.creatorUid,t.lastUpdateTime=t.updateTime}));else if("object"==typeOf(t.data)){var e=t.data;e.person=e.creatorUid,e.lastUpdateTime=e.updateTime}else t.each((function(t){t.person=t.creatorUid,t.lastUpdateTime=t.updateTime}));return t},listAttachment:function(t){!this.options.isNew&&this.options.documentId&&""!=this.options.documentId&&this.actions.listAttachment(this.options.documentId,function(e){t&&t(this.transportData(e))}.bind(this))},createUploadFileNode:function(){this.attachmentController.doUploadAttachment({site:this.options.documentId},this.actions.action,"uploadAttachment",{id:this.options.documentId,documentid:this.options.documentId},null,function(t){var e=t;if(e.data){var i="object"==typeOf(e.data)?e.data.id:e.data[0].id;this.actions.getAttachment(i,this.options.documentId,function(e){(e=this.transportData(e)).data&&this.attachmentController.addAttachment(e.data,t.messageId),this.attachmentController.checkActions(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this))}this.attachmentController.checkActions()}.bind(this),function(t){return this.isQueryUploadSuccess=!0,this.fireEvent("queryUploadAttachment"),this.isQueryUploadSuccess}.bind(this),null,null,null,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},uploadAttachment:function(t,e){this.createUploadFileNode()},deleteAttachments:function(t,e,i){var n=[];i.each(function(t){n.push(t.data.name)}.bind(this));var a=this;this.app.confirm("warn",t,this.lp.deleteAttachmentTitle,this.lp.deleteAttachment+"( "+n.join(", ")+" )",300,120,(function(){for(;i.length;)attachment=i.shift(),a.deleteAttachment(attachment);this.close()}),(function(){this.close()}),null)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]),this.actions.deleteAttachment(t.data.id,this.documentId,function(e){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions()}.bind(this))},replaceAttachment:function(t,e,i){return!1},createReplaceFileNode:function(t){this.replaceFileAreaNode=new Element("div");this.replaceFileAreaNode.set("html",'<input name="file" type="file" multiple/>'),this.fileReplaceNode=this.replaceFileAreaNode.getFirst(),this.fileReplaceNode.addEvent("change",function(){var e=this.fileReplaceNode.files;if(e.length)for(var i=0;i<e.length;i++){var n=e.item(i),a=new FormData;a.append("file",n),this.actions.replaceAttachment(t.data.id,this.options.documentId,function(e,i){this.form.documentAction.getAttachment(t.data.id,this.opetions.documentId,function(i){if(t.data=i.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var n=this.attachmentController.messageItemList[e.messageId];n&&n.node&&n.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,a,n)}}.bind(this))},replaceAttachmentFile:function(t){this.replaceFileAreaNode||this.createReplaceFileNode(t),this.fileReplaceNode.click()},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],i=0;i<e.length;i++)if(t===e[i])return!0;return!1},downloadAttachment:function(t,e,i){i.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:"bbs"}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=bbs&subjectId="+this.options.documentId}):layout.mobile?this.actions.getAttachmentUrl(t.data.id,this.options.documentId,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.actions.getAttachmentStream(t.data.id,this.options.documentId)}.bind(this))},openAttachment:function(t,e,i){i.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:"bbs"}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=bbs&subjectId="+this.options.documentId}):layout.mobile?this.actions.getAttachmentUrl(t.data.id,this.options.documentId,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.actions.getAttachmentData(t.data.id,this.options.documentId)}.bind(this))},getAttachmentUrl:function(t,e){this.actions.getAttachmentUrl(t.data.id,this.options.documentId,e)},getAttachmentData:function(){var t=[];return this.attachmentController.attachments.each((function(e){t.push(e.data)})),t},getAttachmentIds:function(){var t=[];return this.attachmentController.attachments.each((function(e){t.push(e.data.id)})),t},loadAttachmentSelecter:function(t,e){MWF.require("MWF.widget.AttachmentSelector",function(){var i={style:"cms",title:this.lp.selectAttachment,listStyle:"icon",selectType:"all",size:"max",attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,toBase64:!0,base64MaxSize:800,readonly:!1};i=Object.merge(i,t),this.readonly&&(i.readonly=!0),this.attachmentController=new MWF.widget.AttachmentSelector(document.body,this,i),this.attachmentController.load(),this.postSelect=e,this.data?this.data.each(function(t){this.attachmentController.addAttachment(t)}.bind(this)):this.listAttachment(function(t){t.data.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))}.bind(this))},selectAttachment:function(t,e,i){if(i.length>0){var n=i[i.length-1].data;this.actions.getAttachmentUrl(n.id,this.options.documentId,function(t){this.attachmentController.options.toBase64?this.actions.getSubjectAttachmentBase64(n.id,this.attachmentController.options.base64MaxSize,function(e){var i=e.data?"data:image/png;base64,"+e.data.value:null;this.postSelect&&this.postSelect(t,n,i)}.bind(this)):this.postSelect&&this.postSelect(t,n)}.bind(this))}}});