MWF.xApplication.Forum=MWF.xApplication.Forum||{},window.MWFForum=window.MWFForum||MWF.xApplication.Forum,MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Forum","Common",null,!1),MWF.xDesktop.requireApp("Forum","Access",null,!1),MWF.xDesktop.requireApp("Forum","ColumnTemplate",null,!1),MWF.xDesktop.requireApp("Forum","TopNode",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xApplication.Forum.options={multitask:!1,executable:!0},MWF.xApplication.Forum.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"Forum",icon:"icon.png",width:"1230",height:"700",isResize:!0,isMax:!0,title:MWF.xApplication.Forum.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Forum.LP,this.setTitle(this.getMainPageTitle())},getMainPageTitle:function(){var t=this.inBrowser&&MWFForum.getSystemConfigValue(MWFForum.BBS_TITLE_TAIL)||"";return(MWFForum.getBBSName()||MWF.xApplication.Forum.LP.title)+t},loadApplication:function(t){this.userName=layout.desktop.session.user.distinguishedName,this.restActions=MWF.Actions.get("x_bbs_assemble_control"),this.path="../x_component_Forum/$Main/"+this.options.style+"/",this.createNode(),this.loadApplicationContent()},loadController:function(t){this.access=new MWF.xApplication.Forum.Access(this.restActions,this.lp),t&&t()},reload:function(){this.clearContent(),this.explorer?this.openSetting(this.explorer.currentNaviItem.retrieve("index")):this.loadApplicationLayout()},isAdmin:function(){return this.access.isAdmin()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:this.css.node}).inject(this.content)},loadApplicationContent:function(){this.loadController(function(){this.access.login(function(){this.status&&this.status.setting?this.openSetting(this.status.index):this.loadApplicationLayout()}.bind(this))}.bind(this))},loaNavi:function(t){this.naviNode=new Element("div.naviNode",{styles:this.css.naviNode}).inject(this.node);var e={id:""};this.status&&(e.id=this.status.id),this.navi=new MWF.xApplication.Forum.Navi(this,this.naviNode,e)},loadApplicationLayout:function(){this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node),this.createTopNode(!1),this.createContainerNode()},createTopNode:function(t){(this.topObject=new MWF.xApplication.Forum.TopNode(this.contentContainerNode,this,this,{type:this.options.style,settingEnable:!0,naviModeEnable:!0,naviMode:t})).load()},createContainerNode:function(){this.createContent()},createContent:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode),this.setContentSizeFun=this.setContentSize.bind(this),this.addEvent("resize",this.setContentSizeFun),this.setContentSize(),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.middleNode),this.createRecommand(),this.restActions.listCategoryAll(function(t){t.data||(t.data=[]),t.data.each(function(t,e){t.forumStatus!=this.lp.invalid&&this._createCategory(t,e)}.bind(this))}.bind(this))},setContentSize:function(){var t=this.node.getSize(),e=this.contentContainerNode.getStyle("padding-top").toFloat(),n=this.contentContainerNode.getStyle("padding-bottom").toFloat(),o=t.y-0-e-n;this.contentContainerNode.setStyle("height",o+"px")},createRecommand:function(){var t=new Element("div.recommandNode",{styles:this.css.recommandNode}).inject(this.contentNode),e=new Element("div.recommandTopNode",{styles:this.css.recommandTopNode}).inject(t);new Element("div.recommandTopTitleNode",{styles:this.css.recommandTopTitleNode,text:this.lp.recommandSubject}).inject(e);new MWF.xApplication.Forum.Main.RecommandView(t,this,this,{templateUrl:this.path+"listItemRecommand.json"},{lp:this.lp}).load()},_createCategory:function(t,e){var n=new Element("div.categoryNode",{styles:this.css.categoryNode}).inject(this.contentNode),o=new Element("div.categoryTopNode",{styles:this.css.categoryTopNode}).inject(n),i=new Element("div.categoryTopTitleNode",{styles:this.css.categoryTopTitleNode,text:t.forumName}).inject(o);i.addEvents({click:function(t){this.obj.openCategory(this.data)}.bind({obj:this,data:t})}),i.setStyle("color",t.forumColor||this.lp.defaultForumColor);var s=new Element("div.categoryTopRightNode",{styles:this.css.categoryTopRightNode2}).inject(o);this.createPersonNode(s,t.forumManagerName),new Element("div.categoryTopRightNode",{styles:this.css.categoryTopRightNode,text:this.lp.categoryManager+"："}).inject(o),new MWF.xApplication.Forum.ColumnTemplate(n,this,this,{type:t.indexListStyle||"type_1_0",categoryId:t.id}).load()},clearContent:function(){this.explorer&&this.explorer.destroy(),this.explorer=null,this.setContentSizeFun&&this.removeEvent("resize",this.setContentSizeFun),this.scrollBar&&this.scrollBar.scrollVAreaNode&&this.scrollBar.scrollVAreaNode.destroy(),this.scrollBar&&delete this.scrollBar,this.contentContainerNode&&this.contentContainerNode.destroy()},openCategory:function(t){var e="ForumCategory"+t.id;this.desktop.apps[e]?this.desktop.apps[e].setCurrent():this.desktop.openApplication(null,"ForumCategory",{categoryId:t.id,appId:e})},openView:function(){},openNavi:function(){MWF.xDesktop.requireApp("Forum","NaviMode",null,!1),this.clearContent(),this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node),this.createTopNode(!0),this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.middleNode),this.navi=new MWF.xApplication.Forum.NaviMode(this,this.contentNode,{}),this.navi.load()},closeNavi:function(){this.navi&&this.navi.close()},openSetting:function(t){MWF.xDesktop.requireApp("Forum","Setting",null,!1),this.clearContent(),this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node),this.createTopNode(!1),this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode),this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.middleNode),this.explorer=new MWF.xApplication.Forum.Setting(this.contentNode,this,this.restActions,{isAdmin:this.isAdmin(),index:t||0}),this.explorer.load()},recordStatus:function(){var t={};return this.explorer&&(t={setting:!0,index:this.explorer.currentNaviItem.retrieve("index")}),t},openPerson:function(t){var e="ForumPerson"+t;this.desktop.apps[e]?this.desktop.apps[e].setCurrent():this.desktop.openApplication(null,"ForumPerson",{personName:t,appId:e})},createPersonNode:function(t,e){var n=e.split(",");n.each(function(e,o){var i=new Element("span",{text:e.split("@")[0],styles:this.css.person}).inject(t);i.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.person_over)}.bind({node:i,obj:this}),mouseout:function(){this.node.setStyles(this.obj.css.person)}.bind({node:i,obj:this}),click:function(){this.obj.openPerson(this.userName)}.bind({userName:e,obj:this})}),o!=n.length-1&&new Element("span",{text:"、"}).inject(t)}.bind(this))}}),MWF.xApplication.Forum.Main.RecommandView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.Forum.Main.RecommandDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e){e||(e=12),this.actions.listRecommendedSubject(e,function(e){e.data||(e.data=[]),t&&t(e)}.bind(this))},_removeDocument:function(t,e){},_create:function(){},_openDocument:function(t){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.Forum.Main.RecommandDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverDocument:function(){},mouseoutDocument:function(){},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(){var t=this.data,e="ForumDocument"+t.id;this.app.desktop.apps[e]?this.app.desktop.apps[e].setCurrent():this.app.desktop.openApplication(null,"ForumDocument",{sectionId:t.sectionId,id:t.id,appId:e,isEdited:!1,isNew:!1})},openSection:function(t){var e=this.data,n="ForumSection"+e.sectionId;this.app.desktop.apps[n]?this.app.desktop.apps[n].setCurrent():this.app.desktop.openApplication(t,"ForumSection",{sectionId:e.sectionId,appId:n})}});