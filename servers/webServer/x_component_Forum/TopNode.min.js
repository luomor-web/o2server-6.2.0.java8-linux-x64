MWF.xApplication.Forum.TopNode=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",settingEnable:!1,logoutEnable:!0,naviModeEnable:!1},initialize:function(t,e,s,i){this.setOptions(i),this.container=t,this.app=e,this.lp=e.lp,this.restActions=e.restActions,this.access=e.access,this.explorer=s,this.userName=layout.desktop.session.user.distinguishedName||"",this.path="../x_component_Forum/$TopNode/",this.cssPath="../x_component_Forum/$TopNode/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.createTopNode()},getMainPageTitle:function(){var t=this.app.inBrowser&&MWFForum.getSystemConfigValue(MWFForum.BBS_TITLE_TAIL)||"";return(MWFForum.getBBSName()||MWF.xApplication.Forum.LP.title)+t},openMainPage:function(){if(this.app.inBrowser||this.options.naviMode){this.app.clearContent(),this.app.node&&this.app.node.destroy(),MWF.xDesktop.requireApp("Forum","MainInContainer",null,!1);var t=new MWF.xApplication.Forum.MainInContainer(this.app.desktop,{hasTop:!0,hasBreadCrumb:!0,naviMode:!1,autoWidth:!1},this.app.content,this.app.content,this.app.content);t.inBrowser=this.app.inBrowser,t.window=this.app.window,t.taskitem=this.app.taskitem,t.load(),this.app.setTitle(this.getMainPageTitle())}else{if(this.app.desktop.apps.Forum){var e=this.app.desktop.apps.Forum;e.setCurrent(),e.clearContent(),e.loadApplicationLayout()}else this.app.desktop.openApplication(null,"Forum",{appId:"Forum"}),this.app.close()}},createTopNode:function(){this.topContainerNode=new Element("div.topContainerNode",{styles:this.css.topContainerNode}).inject(this.container),this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.topContainerNode),this.topMainPageNode=new Element("div.topMainPageNode",{styles:{cursor:"pointer"}}).inject(this.topNode),this.topMainPageNode.addEvent("click",function(){this.openMainPage()}.bind(this)),this.restActions.getBBSName(function(t){var e=t.data;e.configValue&&""!=e.configValue&&"O2社区"!=e.configValue?(this.bbsName=e.configValue,this.topTextNode=new Element("div.topTextNode",{styles:this.css.topTextNode,text:e.configValue}).inject(this.topMainPageNode)):this.topIconNode=new Element("div",{styles:this.css.topIconNode}).inject(this.topMainPageNode)}.bind(this),null,!1),this.topContentNode=new Element("div",{styles:this.css.topContentNode}).inject(this.topNode),this.access.isAnonymous()?("disable"!=this.access.signUpMode&&(this.signupNode=new Element("div",{styles:this.css.signupNode}).inject(this.topContentNode),this.signupTextNode=new Element("div",{styles:this.css.signupTextNode,text:this.lp.signup}).inject(this.signupNode),this.signupNode.addEvent("click",function(){this.openSignUpForm()}.bind(this)),new Element("div",{styles:this.css.topSepNode,text:"|"}).inject(this.topContentNode)),this.loginNode=new Element("div",{styles:this.css.loginNode}).inject(this.topContentNode),this.loginTextNode=new Element("div",{styles:this.css.loginTextNode,text:this.lp.login}).inject(this.loginNode),this.loginNode.addEvent("click",function(){this.openLoginForm()}.bind(this)),this.options.naviModeEnable&&(new Element("div",{styles:this.css.topSepNode,text:"|"}).inject(this.topContentNode),this.loadNaviNode())):(this.app.inBrowser&&this.options.logoutEnable&&(this.logoutNode=new Element("div",{styles:this.css.logoutNode}).inject(this.topContentNode),this.logoutTextNode=new Element("div",{styles:this.css.logoutTextNode,text:this.lp.logout}).inject(this.logoutNode),this.logoutNode.addEvent("click",function(){this.logout()}.bind(this)),new Element("div",{styles:this.css.topSepNode,text:"|"}).inject(this.topContentNode)),this.options.settingEnable&&(this.settingNode=new Element("div",{styles:this.css.settingNode}).inject(this.topContentNode),this.settingTextNode=new Element("div",{styles:this.css.settingTextNode,text:this.lp.setting,title:this.lp.forumConfig}).inject(this.settingNode),this.settingNode.addEvent("click",function(){this.app.openSetting()}.bind(this))),this.options.settingEnable&&new Element("div",{styles:this.css.topSepNode,text:"|"}).inject(this.topContentNode),this.options.naviModeEnable&&(this.loadNaviNode(),new Element("div",{styles:this.css.topSepNode,text:"|"}).inject(this.topContentNode)),this.personNode=new Element("div",{styles:this.css.personNode}).inject(this.topContentNode),this.personTextNode=new Element("div",{styles:this.css.personTextNode,text:MWF.xApplication.Forum.LP.welcomeTitle.replace("{user}",(this.userName||"").split("@")[0]),title:MWF.xApplication.Forum.LP.seePersonCenter}).inject(this.personNode),this.personNode.addEvent("click",function(){this.openPerson(this.userName)}.bind(this))),this.searchDiv=new Element("div.searchDiv",{styles:this.css.searchDiv}).inject(this.topNode),this.searchInput=new Element("input.searchInput",{styles:this.css.searchInput,value:this.lp.searchKey,title:this.lp.searchTitle}).inject(this.searchDiv);var t=this;this.searchInput.addEvents({focus:function(){this.value==t.lp.searchKey&&this.set("value","")},blur:function(){this.value||this.set("value",t.lp.searchKey)},keydown:function(t){13==t.code&&(this.search(),t.preventDefault())}.bind(this)}),this.searchAction=new Element("div.searchAction",{styles:this.css.searchAction}).inject(this.searchDiv),this.searchAction.addEvents({click:function(){this.search()}.bind(this),mouseover:function(t){this.searchAction.setStyles(this.css.searchAction_over2),t.stopPropagation()}.bind(this),mouseout:function(){this.searchAction.setStyles(this.css.searchAction)}.bind(this)}),this.searchDiv.addEvents({mouseover:function(){this.searchInput.setStyles(this.css.searchInput_over),this.searchAction.setStyles(this.css.searchAction_over)}.bind(this),mouseout:function(){this.searchInput.setStyles(this.css.searchInput),this.searchAction.setStyles(this.css.searchAction)}.bind(this)}),this._createTopContent()},loadNaviNode:function(){this.options.naviModeEnable&&(this.naviNode=new Element("div",{styles:this.css.settingNode}).inject(this.topContentNode),this.options.naviMode?(this.closeNaviTextNode=new Element("div",{styles:this.css.settingTextNode,text:MWF.xApplication.Forum.LP.closeNavi,title:MWF.xApplication.Forum.LP.closeNavi}).inject(this.naviNode),this.closeNaviTextNode.addEvent("click",function(){this.app.closeNavi()}.bind(this))):(this.naviTextNode=new Element("div",{styles:this.css.settingTextNode,text:MWF.xApplication.Forum.LP.navi,title:MWF.xApplication.Forum.LP.naviLayout}).inject(this.naviNode),this.naviTextNode.addEvent("click",function(){this.app.openNavi()}.bind(this))))},_createTopContent:function(){},getSystemSetting:function(t,e,s){this.restActions.getSystemSettingByCode({configCode:t},function(t){e&&e(t.data)}.bind(this),null,s)},search:function(){var t=this.searchInput.get("value");if(""!=t&&t!=this.lp.searchKey){var e="ForumSearch";if("ForumSearch"==this.app.options.name)this.app.search(t);else if(this.app.desktop.apps[e]&&!this.app.inBrowser){var s=this.app.desktop.apps[e];s.setCurrent(),s.search(t)}else this.app.desktop.openApplication(null,"ForumSearch",{appId:e,searchContent:t})}else this.notice(this.lp.noSearchContentNotice,"error")},openPerson:function(t){var e="ForumPerson"+t;this.app.desktop.apps[e]?this.app.desktop.apps[e].setCurrent():this.app.desktop.openApplication(null,"ForumPerson",{personName:t,appId:e})},openLoginForm:function(){MWF.require("MWF.xDesktop.Authentication",null,!1);var t=new MWF.xDesktop.Authentication({style:"flat",popupStyle_password:"o2platformSignupFlat",onPostOk:function(){window.location.reload()}},this.app);t.popupOptions={draggable:!0,closeAction:!0,hasMask:!0,relativeToApp:!0,width:"420",height:"640"},t.openLoginForm()},openSignUpForm:function(){MWF.require("MWF.xDesktop.Authentication",null,!1);var t=new MWF.xDesktop.Authentication({style:"flat",popupStyle_password:"o2platformSignupFlat",onPostOk:function(){}},this.app);t.popupOptions={draggable:!0,closeAction:!0,hasMask:!0,relativeToApp:!0,width:"420",height:"640"},t.openSignUpForm()},logout:function(){MWF.Actions.get("x_organization_assemble_authentication").logout(function(){this.socket&&(this.socket.close(),this.socket=null),Cookie.dispose(o2.tokenName),layout.session&&layout.session.user&&(layout.session.user.token=""),layout.desktop.session.user.distinguishedName="anonymous",this.app.clearContent(),this.app.loadApplicationContent(),this.openLoginForm()}.bind(this))}});