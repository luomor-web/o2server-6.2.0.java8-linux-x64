MWF.xDesktop.requireApp("process.ProcessManager","FileExplorer",null,!1),MWF.xApplication.portal.PortalManager.FileExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.FileExplorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.file.create,search:MWF.APPPM.LP.file.search,searchText:MWF.APPPM.LP.file.searchText,noElement:MWF.APPPM.LP.file.noDictionaryNoticeText},openFindDesigner:function(){this.app.options.application.moduleType="portal";var e={filter:{moduleList:["portal"],appList:[this.app.options.application]}};layout.openApplication(null,"FindDesigner",e)},getNewData:function(){return{id:"",name:"",alias:"",description:"",portal:(this.app.options.application||this.app.application).id,fileName:""}},implodeFiles:function(){this.upload&&this.upload.upload(),MWF.require("MWF.widget.Upload",function(){var e=[];new MWF.widget.Upload(this.app.content,{action:MWF.Actions.get("x_portal_assemble_designer").action,multiple:!0,method:"uploadFile",parameter:{id:""},onBeforeUploadEntry:function(t,i){var a=this.getNewData();a.name=t.name,a.fileName=t.name,a.description=t.name+" "+this.getSizeText(t.size),a.updateTime=(new Date).format("db"),MWF.Actions.get("x_portal_assemble_designer").saveFile(a,function(t){i.options.parameter={id:t.data.id};var s=this.elementContentListNode.getFirst();s&&s.hasClass("noElementNode")&&s.destroy(),e.push(a)}.bind(this),null,!1)}.bind(this),onEvery:function(t,i,a,s){var n=e[i-1];this._getItemObject(n).load()}.bind(this)}).load()}.bind(this))},_getItemObject:function(e){return new MWF.xApplication.portal.PortalManager.FileExplorer.File(this,e)}}),MWF.xApplication.portal.PortalManager.FileExplorer.File=new Class({Extends:MWF.xApplication.process.ProcessManager.FileExplorer.File,_open:function(e){MWF.Actions.get("x_portal_assemble_designer").getFile(this.data.id,function(e){this.data=e.data,new MWF.xApplication.portal.PortalManager.FileDesigner(this.explorer,this.data)}.bind(this))},_getUrl:function(){var e=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;return e="/x_portal_assemble_surface"+(e=(e=e.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.portal)),o2.filterUrl(MWF.Actions.getHost("x_portal_assemble_surface")+e)},_getIcon:function(){return"file.png"},_getLnkPar:function(){var e=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;e="/x_portal_assemble_surface"+(e=(e=e.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.portal));var t=o2.filterUrl(MWF.Actions.getHost("x_portal_assemble_surface")+e);return{icon:this.data.iconUrl,title:this.data.name,par:"@url#"+t}},deleteFile:function(e){this.explorer.app.restActions.deleteFile(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))}}),MWF.xApplication.portal.PortalManager.FileDesigner=new Class({Extends:MWF.xApplication.process.ProcessManager.FileDesigner,getNewData:function(){return{id:"",name:"",alias:"",description:"",portal:(this.explorer.app.options.application||this.explorer.app.application).id,fileName:""}},createContentFileUrl:function(){if(this.data.fileName){var e=new Element("div",{styles:this.css.fileDesignerContentLineNode}).inject(this.contentAreaNode);new Element("div",{styles:this.css.fileDesignerContentLineTitleNode,text:"URL"}).inject(e);this.fileUrlNode=new Element("div",{styles:this.css.fileDesignerContentLineContentNode}).inject(e),e.setStyle("height","80px");var t=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;t="/x_portal_assemble_surface"+(t=(t=t.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.portal)),this.fileUrlNode.setStyle("line-height","18px");var i=MWF.Actions.getHost("x_portal_assemble_surface")+t;this.fileUrlNode.set("text",t);new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+o2.filterUrl(i)+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}},modifyContentFileUrl:function(){if(this.fileUrlNode){var e=MWF.Actions.get("x_portal_assemble_surface").action.actions.readFile.uri;e="/x_portal_assemble_surface"+(e=(e=e.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.portal)),this.fileUrlNode.setStyle("line-height","18px");var t=MWF.Actions.getHost("x_portal_assemble_surface")+e;this.fileUrlNode.set("text",e);new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+o2.filterUrl(t)+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}else this.createContentFileUrl()},upload:function(){this.data.id,this.uploadFile(function(){this.app.notice(this.lp.file.uploadSuccess,"success")}.bind(this))},uploadFile:function(e){MWF.require("MWF.widget.Upload",function(){new MWF.widget.Upload(this.app.content,{action:MWF.Actions.get("x_portal_assemble_designer").action,method:"uploadFile",parameter:{id:this.data.id},onCompleted:function(){this.loadFileIcon(),this.modifyContentFileUrl(),e&&e()}.bind(this),onBeforeUpload:function(e,t){var i=e[0].name;this.nameInput.set("value",i);var a=this.getData();this.data=Object.merge(this.data,a),MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data,function(e){this.explorer.reload(),t.options.parameter={id:e.data.id}}.bind(this),null,!1)}.bind(this),onEvery:function(e,t,i,a){this.data.fileName=a.name,this.data.description=a.name+" "+this.getSizeText(a.size),this.descriptionInput.set("value",this.data.description),MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data)}.bind(this)}).load()}.bind(this))},save:function(){var e=this.getData();this.data=Object.merge(this.data,e),MWF.Actions.get("x_portal_assemble_designer").saveFile(this.data,function(){this.explorer.reload(),this.app.notice(this.lp.file.saveSuccess,"success"),this.destroy()}.bind(this))}});