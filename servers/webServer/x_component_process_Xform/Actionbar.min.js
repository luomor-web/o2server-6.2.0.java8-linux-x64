MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Actionbar=MWF.APPActionbar=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","postLoad","afterLoad"]},reload:function(){this._loadUserInterface()},_loadUserInterface:function(){this.toolbarNode=this.node.getFirst("div"),this.toolbarNode&&(this.toolbarNode.empty(),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.toolbarNode,{style:this.json.style,onPostLoad:function(){this.fireEvent("afterLoad")}.bind(this)},this),this.json.actionStyles&&(this.toolbarWidget.css=this.json.actionStyles),this.json.multiTools){var t=!this.json.hideSystemTools&&!this.json.hideReadedAction,o=JSON.stringify(this.json.multiTools);if(o=o2.bindJson(o,{lp:MWF.xApplication.process.Xform.LP.form}),this.json.multiTools=JSON.parse(o),this.json.multiTools.each(function(o){o.system?this.json.hideSystemTools||("action_readed"===o.id&&(t=!1),this.setToolbars([o],this.toolbarNode,this.readonly)):this.setCustomToolbars([o],this.toolbarNode)}.bind(this)),t){var s=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(s,this.toolbarNode,this.readonly)}this.toolbarWidget.load()}else if(this.json.hideSystemTools)this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load();else if(this.json.defaultTools){s=[{type:"MWFToolBarButton",img:"read.png",title:MWF.xApplication.process.Xform.LP.setReaded,action:"readedWork",text:MWF.xApplication.process.Xform.LP.readed,id:"action_readed",control:"allowReadProcessing",condition:"",read:!0}];this.setToolbars(this.json.defaultTools,this.toolbarNode,this.readonly),this.json.hideReadedAction||this.setToolbars(s,this.toolbarNode,this.readonly),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}else MWF.getJSON(this.form.path+"toolbars.json",function(t){this.setToolbars(t,this.toolbarNode,this.readonly,!0),this.setCustomToolbars(this.json.tools,this.toolbarNode),this.toolbarWidget.load()}.bind(this),null)}.bind(this)))},setCustomToolbars:function(t,o){var s="../x_component_process_FormDesigner/Module/Actionbar/",e="";this.json.customIconStyle&&(e=this.json.customIconStyle+"/"),t.each(function(t){var i=!0;if(i=this.readonly?t.readShow:t.editShow){if(i=!0,t.control&&(i=this.form.businessData.control[t.control]),t.condition)i=!this.form.Macro.exec(t.condition,this);if(i){var r=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:s+""+this.form.options.style+"/custom/"+e+t.img,title:t.title,MWFButtonAction:"runCustomAction",MWFButtonText:t.text}).inject(o);if(this.json.customIconOverStyle&&r.set("MWFButtonImageOver",s+""+this.form.options.style+"/custom/"+this.json.customIconOverStyle+"/"+t.img),t.properties&&r.set(t.properties),t.actionScript&&r.store("script",t.actionScript),t.sub){var n=o.getLast();this.setCustomToolbars(t.sub,n)}}}}.bind(this))},setToolbarItem:function(t,o,s,e){var i="../x_component_process_FormDesigner/Module/Actionbar/",r=!0;if(t.control&&(r=this.form.businessData.control[t.control]),!e&&t.condition){var n=this.form.Macro.exec(t.condition,this);r=r&&!n}if("action_downloadAll"!=t.id&&"action_print"!=t.id||this.form.businessData.work.startTime||(r=!1),"action_delete"==t.id&&(this.form.businessData.work&&this.form.businessData.work.id||(r=!1)),"action_rollback"==t.id&&(t.read=!0),s&&(t.read||(r=!1)),r){var a=new Element("div",{id:t.id,MWFnodetype:t.type,MWFButtonImage:i+(this.options.style||"default")+"/tools/"+(this.json.style||"default")+"/"+t.img,title:t.title,MWFButtonAction:t.action,MWFButtonText:t.text}).inject(o);if(this.json.iconOverStyle&&a.set("MWFButtonImageOver",i+""+(this.options.style||"default")+"/tools/"+(this.json.iconOverStyle||"default")+"/"+t.img),t.properties&&a.set(t.properties),t.sub){var l=o.getLast();this.setToolbars(t.sub,l,s,e)}}},getItem:function(t){if(this.toolbarWidget&&t)return this.toolbarWidget.items[t]},getAllItem:function(){return this.toolbarWidget?this.toolbarWidget.childrenButton:[]},setToolbars:function(t,o,s,e){t.each(function(t){this.setToolbarItem(t,o,s,e)}.bind(this))},runCustomAction:function(t){var o=t.node.retrieve("script");this.form.Macro.exec(o,this)},saveWork:function(){this.form.saveWork()},closeWork:function(){this.form.closeWork()},processWork:function(){this.form.processWork()},resetWork:function(){this.form.resetWork()},retractWork:function(t,o){this.form.retractWork(t,o)},rerouteWork:function(t,o){this.form.rerouteWork(t,o)},deleteWork:function(){this.form.deleteWork()},printWork:function(){this.form.printWork()},readedWork:function(t,o){this.form.readedWork(o)},addSplit:function(t){this.form.addSplit(t)},rollback:function(t){this.form.rollback(t)},downloadAll:function(t){this.form.downloadAll(t)},pressWork:function(t){this.form.pressWork(t)},pauseTask:function(t){var o=this.form.pauseTask(t);o&&o.then(function(){t.setText(MWF.xApplication.process.Xform.LP.resume),t.options.action="resumeTask";var o=t.picNode.getElement("img"),s=o.get("src");s=s.substr(0,s.lastIndexOf("/")),s+="/resume.png",o.set("src",s)}.bind(this),(function(){}))},resumeTask:function(t){var o=this.form.resumeTask(t);o&&o.then(function(){t.setText(MWF.xApplication.process.Xform.LP.pause),t.options.action="pauseTask";var o=t.picNode.getElement("img"),s=o.get("src");s=s.substr(0,s.lastIndexOf("/")),s+="/pause.png",o.set("src",s)}.bind(this),(function(){}))}});