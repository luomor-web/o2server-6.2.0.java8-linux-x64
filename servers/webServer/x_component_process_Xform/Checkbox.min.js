MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.require("MWF.widget.UUID",null,!1),MWF.xApplication.process.Xform.Checkbox=MWF.APPCheckbox=new Class({Implements:[Events],Extends:MWF.APP$Input,loadDescription:function(){},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){var i=[];t.each((function(t){var n=t.split("|"),s=n[0],o=n[1]||s;-1!=e.indexOf(o)&&i.push(s)})),this.node.set("text",i.join(", "))}},_resetNodeEdit:function(){var t=new Element("div");t.set(this.json.properties),t.inject(this.node,"after"),this.node.destroy(),this.node=t},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.set({id:this.json.id,MWFType:this.json.type,styles:{display:"inline"}}),this.setOptions()},_loadDomEvents:function(){},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1!=this.options.moduleEvents.indexOf(e)&&this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.getElements("input").each(function(i){i.addEvent(t,function(t){return e?e(this,t):null}.bind(this))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions()},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var n=i.split("|");t.push(n[0]),e.push(n[1]||n[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){if(this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)){var e=(new MWF.widget.UUID).toString();t.each(function(t){var i=t.split("|"),n=i[0],s=i[1]||n,o=new Element("input",{type:"checkbox",name:(this.json.properties?this.json.properties.name:null)||e+this.json.id,value:s,showText:n,styles:this.json.buttonStyles}).inject(this.node);new Element("span",{text:n,styles:{cursor:"default"}}).inject(this.node).addEvent("click",function(t){!0!==this.radio.get("disabled")&&"true"!==this.radio.get("disabled")&&(this.radio.checked=!this.radio.checked,this.radio.fireEvent("change"),this.radio.fireEvent("click"))}.bind({radio:o})),o.addEvent("click",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")||[]),this.fireEvent("change"))}.bind(this)),Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)||o.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))}.bind(this))}}.bind(this),(function(){}));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},_setValue:function(t,e){var i=e||"__setValue";if(t){var n=o2.promiseAll(t).then(function(t){return this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=n,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){this._setBusinessData(t);for(var e=this.node.getElements("input"),i=0;i<e.length;i++){var n=e[i];n.checked=-1!=t.indexOf(n.value)}},getTextData:function(){var t=this.node.getElements("input"),e=[],i=[];return t.length&&t.each((function(t){if(t.checked){var n=t.get("value"),s=t.get("showText");e.push(n||""),i.push(s||n||"")}})),e.length||(e=[""]),i.length||(i=[""]),{value:e,text:i}},isEmpty:function(){var t=this.getData();return"array"!==typeOf(t)||0===t.length},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("input"),e=[];return t.length&&t.each((function(t){if(t.checked){var i=t.get("value");i&&e.push(i||"")}})),e.length?e:[]},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){this._setBusinessData(t);var e=this.node.getElements("input");e.length&&(e.each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("checked",!0):e.set("checked",!1):t==e.get("value")?e.set("checked",!0):e.set("checked",!1)})),this.validationMode()),this.fireEvent("setData")},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("background",this.node.getStyles("background")),this.node.setStyle("background","#ffdcdc"),this.errNode=this.createErrorNode(t),this.iconNode?this.errNode.inject(this.iconNode,"after"):this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node),this.node.isIntoView()||this.node.scrollIntoView())},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("background")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData();"array"===typeOf(i)&&0===i.length&&(i="");var n="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!n)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(n)return this.notValidationMode(e.prompt),!1;break;case"gt":if(n>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(n<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(n==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(n!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=n.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==n.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}});