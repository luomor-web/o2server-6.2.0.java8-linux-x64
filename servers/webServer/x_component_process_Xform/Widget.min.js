MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Widget=MWF.APPWidget=new Class({Extends:MWF.APP$Module,_loadUserInterface:function(){this.node.empty(),this.modules=[],this.moduleList={},this.getWidget(function(){this.loadWidget()}.bind(this))},reload:function(){this.clean(),this.getWidget(function(){this.loadWidget()}.bind(this))},clean:function(){if((this.modules||[]).each(function(t){this.form.modules.erase(t)}.bind(this)),Object.each(this.moduleList||{},function(t,e){delete this.form.json.moduleList[e]}.bind(this)),this.widgetData&&this.widgetData.json.id){var t=this.widgetData.json.id;this.parentpageIdList&&this.parentpageIdList.length&&this.parentpageIdList.erase(t)}this.json&&this.json.id&&this.form.widgetModules&&this.form.widgetModules[this.json.id]&&(this.form.widgetModules[this.json.id]={}),this.modules=[],this.moduleList={},this.node.empty()},loadCss:function(){if(this.widgetData.json.css&&this.widgetData.json.css.code){for(var t,e=this.form.parseCSS(this.widgetData.json.css.code),i=new RegExp("(.+)(?=\\{)","g"),s=this.form.json.id.replace(/\-/g,"");null!==(t=i.exec(e));){var o=".css"+s+" ",a=o+t[0];e=e.substring(0,t.index)+a+e.substring(i.lastIndex,e.length),i.lastIndex=i.lastIndex+o.length}var d;if(!(d=$("style"+this.form.json.id)))(d=document.createElement("style")).setAttribute("type","text/css"),d.id="style"+this.form.json.id,d.inject(this.form.container,"before");if(d.styleSheet){var n=function(){d.styleSheet.cssText+=e};d.styleSheet.disabled?setTimeout(n,10):n()}else{var r=document.createTextNode(e);d.appendChild(r)}}},checkWidgetNested:function(t){return this.parentpageIdList?!this.parentpageIdList.contains(t):![this.form.json.id].contains(t)},getParentpageIdList:function(){var t;return this.parentpageIdList?(t=Array.clone(this.parentpageIdList)).push(this.widgetData.json.id):t=[this.form.json.id,this.widgetData.json.id],t},loadWidget:function(){if(this.widgetData)if(this.checkWidgetNested(this.widgetData.json.id)){this.loadCss(),this.modules=[],this.moduleList={},this.form.widgetModules=this.form.widgetModules||{};var t=this.form.widgetModules[this.json.id]={},e=this.getPageParamenters();if("object"===typeOf(e)&&this.form.Macro&&this.form.Macro.environment){var i=this.form.Macro.environment;i.widgetParameters=i.widgetParameters||{},i.widgetParameters[this.json.id]=e}this.node.set("html",this.widgetData.html),Object.each(this.widgetData.json.moduleList,function(t,e){var i=e;if(this.form.json.moduleList[e]){i=this.json.id+"_"+e;var s=this.node.getElement("#"+e);s&&s.set("id",i),t.orgiginalId=e,t.id=i}this.form.json.moduleList[i]=t,this.moduleList[i]=t}.bind(this)),this.form._getModuleNodes(this.node).each(function(e){if("form"!==e.get("MWFtype")){var i=this,s=this.form._getDomjson(e),o=this.form._loadModule(s,e,(function(){this.widget=i,this.parentpageIdList=i.getParentpageIdList()}));this.form.modules.push(o),this.modules.push(o),t[s.orgiginalId||s.id]=o}}.bind(this))}else this.form.notice(MWF.xApplication.process.Xform.LP.widgetNestedError,"error");this.form.widgetLoadedCount?this.form.widgetLoadedCount++:this.form.widgetLoadedCount=1,this.form.checkSubformLoaded()},getWidget:function(t){var e="Mobile"===this.form.options.mode||layout.mobile?"getWidgetByNameMobile":"getWidgetByName";if("script"===this.json.widgetType){if(this.json.widgetScript&&this.json.widgetScript.code){var i=this.form.Macro.exec(this.json.widgetScript.code,this);if(i){var s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](i,s,function(e){this.getWidgetData(e.data),t&&t()}.bind(this))}else t&&t()}}else if(this.json.widgetSelected&&"none"!==this.json.widgetSelected){var o=this.form.app.relatedFormMap?this.form.app.relatedFormMap[this.json.widgetSelected]:null;if(o)this.getWidgetData({data:o.data}),t&&t();else{s=this.form.businessData.pageInfor.portal;o2.Actions.get("x_portal_assemble_surface")[e](this.json.widgetSelected,s,function(e){this.getWidgetData(e.data),t&&t()}.bind(this))}}else t&&t()},getWidgetData:function(t){var e;if(e=t.data,this.widgetData=null,e){var i=o2.bindJson(MWF.decodeJsonString(e),{lp:MWF.xApplication.process.Xform.LP.form});this.widgetData=JSON.decode(i),this.widgetData.updateTime=t.updateTime}},getPageParamenters:function(){var t=null;if("map"===this.json.parameterType)t=this.json.parametersMapList;else if("script"===this.json.parameterType){var e=this.json.parametersScript?this.json.parametersScript.code:"";e&&(t=this.form.Macro.exec(e,this))}return t}});