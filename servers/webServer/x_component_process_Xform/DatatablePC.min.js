MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatatablePC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","afterLoad","beforeLoadLine","afterLoadLine","addLine","deleteLine","afterDeleteLine","completeLineEdit","cancelLineEdit","export","import","validImport"]},initialize:function(t,e,i,n){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.tBody=this.table.getElement("tbody"),this.editable=!(this.readonly||!0===this.json.isReadonly),this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.importenable=this.editable&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable="impexp"===this.json.impexpType||"exp"===this.json.impexpType,this.multiEditMode="multi"===this.json.editMode,this.totalFlag=!1,this.totalColumns=[],this.totalNumberModuleIds=[],this.data=this.getValue(),this._getBusinessData()||(this.isNew=!0,this._setValue(this.data)),this.lineList=[],this.loadDatatable()},loadDatatable:function(){this._loadStyles(),this._loadTitleTr(),this._loadTemplate(),this._loadTotalTr(),this.fireEvent("load"),this._loadDatatable(function(){this._loadImportExportAction(),this.fireEvent("postLoad")}.bind(this))},_loadTitleTr:function(){this.titleTr=this.table.getElement("tr");var t=this.titleTr.getElements("th");if(this.json.border&&t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.json.titleStyles&&t.setStyles(this.json.titleStyles),t.each(function(t,e){var i=this.form._getDomjson(t);if(t.store("dataTable",this),t.addClass("mwf_origional"),i){var n=this.form._loadModule(i,t);this.form.modules.push(n),!1===i.isShow&&t.hide(),"number"!==i.total&&"count"!==i.total||(this.totalFlag=!0)}}.bind(this)),this.editable){var e=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");if(this.addable)new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target,!0)}.bind(this)}}).inject(e);var i=new Element("th").inject(this.titleTr,"bottom");this.json.border&&Array.each([e,i],function(t){t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border})}.bind(this)),this.json.titleStyles&&(e.setStyles(this.json.titleStyles),i.setStyles(this.json.titleStyles))}},_loadTemplate:function(){var t=this.table.getElements("tr");this.templateTr=t[t.length-1],this.templateNode=this.templateTr;var e=this.templateNode.getElements("td");if(this.json.border&&e.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}),this.json.contentStyles&&e.setStyles(this.json.contentStyles),e.each(function(t,e){var i=this.form._getDomjson(t);t.store("dataTable",this),t.addClass("mwf_origional"),i&&("sequence"===i.cellType&&t.addClass("mwf_sequence"),!1===i.isShow&&t.hide())}.bind(this)),this.editable){var i=new Element("td.mwf_editaction",{styles:this.json.actionStyles||{}}).inject(this.templateNode,"top"),n=new Element("td.mwf_moveaction",{styles:this.form.css.gridMoveActionCell||{}}).inject(this.templateNode,"bottom");this.json.border&&Array.each([i,n],function(t){t.setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})}.bind(this)),this.json.contentStyles&&(i.setStyles(this.json.contentStyles),n.setStyles(this.json.contentStyles))}this.templateHtml=this.templateNode.get("html"),this.templateNode.hide()},_loadTotalTr:function(){this.totalFlag&&(this.totalTr=new Element("tr.mwf_totaltr",{styles:this.form.css.datagridTotalTr}).inject(this.tBody||this.table),this.titleTr.getElements("th").each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);this.json.amountStyles&&i.setStyles(this.json.amountStyles);var n=this.form._getDomjson(t);n&&(!1===n.isShow&&i.hide(),"number"!==n.total&&"count"!==n.total||this.totalColumns.push({th:t,td:i,index:e,type:n.total}))}.bind(this)),this.templateTr.getElements("td").each(function(t,e){if(this.form._getDomjson(t)){var i=this.totalColumns.find((function(t){return t.index===e}));if(i){var n=this.form._getModuleNodes(t);n.length>0&&(i.moduleJson=this.form._getDomjson(n[0]),"number"===i.type&&this.totalNumberModuleIds.push(i.moduleJson.id))}}}.bind(this)))},_loadTotal:function(){var t={};if(!this.totalFlag)return t;this.totalTr||this._loadTotalTr();var e=this.getValue();return this.totalColumns.each(function(i,n){var s=i.moduleJson;if(s){var o,a=0;if("count"===i.type)o=e.data.length;else if("number"===i.type){o=new Decimal(0);for(var r=0;r<e.data.length;r++){var l=e.data[r];if(l[s.id]){o=o.plus(l[s.id].toFloat()||0);var h=l[s.id].toString();h.indexOf(".")>-1&&(a=Math.max(a,h.split(".")[1].length))}}}if(isNaN(o))t[s.id]="",i.td.set("text","");else{if(a>0&&"0"!==o.toString()){var d=o.toString();if(d.indexOf(".")>-1){var c=d.split(".")[1].length;t[s.id]=c<a?d+"0".repeat(a-c):d}else t[s.id]=d+"."+"0".repeat(a)}else t[s.id]=o.toString();i.td.set("text",t[s.id])}}}.bind(this)),e.total=t,t},_createLineNode:function(){return this.totalTr?new Element("tr").inject(this.totalTr,"before"):new Element("tr").inject(this.tBody||this.table)},_loadStyles:function(){this.json.border&&this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.node.setStyles(this.json.styles),this.table.setStyles(this.json.tableStyles),this.table.set(this.json.properties)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();if(t||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"array"===o2.typeOf(t)&&(t={data:t||[],total:{}})),!t&&this.multiEditMode){t={data:[],total:{}};for(var e=this.json.defaultCount?this.json.defaultCount.toInt():0,i=0;i<e;i++)t.data.push({})}return t||{data:[],total:{}}},getValue:function(){return this._getValue()},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.moduleValueAG=null,t},_loadDatatable:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this._loadLineList(function(){this._loadTotal(),t&&t()}.bind(this)),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},_loadLineList:function(t){this.data.data.each(function(t,e){var i=this.isNew||"number"===o2.typeOf(this.newLineIndex)&&e===this.newLineIndex,n=this.multiEditMode||"number"!==o2.typeOf(this.newLineIndex)?this.multiEditMode:e===this.newLineIndex,s=this._createLineNode(),o=this._loadLine(s,t,e,n,i);this.lineList.push(o)}.bind(this)),this.isNew=!1,this.newLineIndex=null,t&&t()},isMax:function(){var t=this.json.maxCount?this.json.maxCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length>=t)},isMin:function(){var t=this.json.minCount?this.json.minCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length<=t)},_loadLine:function(t,e,i,n,s){var o=new MWF.xApplication.process.Xform.DatatablePC.Line(t,this,e,{index:i,indexText:(i+1).toString(),isNew:s,isEdited:"boolean"===typeOf(n)?n:this.editable,isEditable:this.editable,isDeleteable:this.deleteable,isAddable:this.addable});return this.fireEvent("beforeLoadLine",[o]),o.load(),this.fireEvent("afterLoadLine",[o]),o},_setLineData:function(t,e){var i=t.options.index,n=this.getData();n.data[i]=e,this.setData(n)},_addLine:function(t,e,i){if(this._completeLineEdit()){if(this.isMax()){var n=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(n,"info"),!1}var s=this.lineList.length,o=this.getData();o.data.push(i||{}),this.newLineIndex=s,this.setData(o);var a=this.getLine(s);return a.isNewAdd=!0,this.fireEvent("addLine",[{line:a,ev:t}]),a}},_insertLine:function(t,e){if(this._completeLineEdit()){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var n=e.options.index+1,s=this.getData();s.data.splice(n,0,{}),this.newLineIndex=n,this.setData(s);var o=this.getLine(n);return o.isNewAdd=!0,this.fireEvent("addLine",[{line:o,ev:t}]),o}},_insertLineByIndex:function(t,e,i){if(this._completeLineEdit()){if(this.isMax()){var n=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(n,"info"),!1}var s=this.getData();if(s.data.length<e)return null;s.data.splice(e,0,i||{}),this.setData(s);var o=this.getLine(e);return o.isNewAdd=!0,this.fireEvent("addLine",[{line:o,ev:t}]),o}},_deleteSelectedLine:function(t){var e=this.lineList.filter((function(t){return t.selected}));if(0===e.length)return this.form.notice(MWF.xApplication.process.Xform.LP.selectItemNotice,"info"),!1;var i=this.json.minCount?this.json.minCount.toInt():0;if(i>0&&this.lineList.length-e.length<i){var n=MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}",i);return this.form.notice(n,"info"),!1}var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice,300,120,(function(){s._delLines(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLines:function(t){var e=this,i=!1,n=e.getData();t.reverse().each((function(t){e.fireEvent("deleteLine",[t]),t.deleteAttachment()&&(i=!0),n.data.splice(t.options.index,1),this.currentEditedLine===t&&(this.currentEditedLine=null),e.fireEvent("afterDeleteLine")})),e.setData(n),i&&this.form.saveFormData()},_deleteLine:function(t,e){if(this.isMin()){var i=MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}",this.json.minCount);return this.form.notice(i,"info"),!1}var n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){n._delLine(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLine:function(t){this.fireEvent("deleteLine",[t]);var e=t.deleteAttachment(),i=this.getData();i.data.splice(t.options.index,1),this.currentEditedLine===t&&(this.currentEditedLine=null),this.setData(i),this.fireEvent("afterDeleteLine"),e&&this.form.saveFormData()},_cancelLineEdit:function(){var t=this.currentEditedLine;return!t||(t.isNewAdd?(this._delLine(t),this.currentEditedLine=null):(t.resetDataWithOriginalData(),t.changeEditMode(!1),this._loadTotal(),t.attachmentChangeFlag&&(this.form.saveFormData(),t.attachmentChangeFlag=!1),this.currentEditedLine=null,this.fireEvent("cancelLineEdit",[t])),!0)},_completeLineEdit:function(){var t=this.currentEditedLine;return!t||!!t.validation()&&(t.isNewAdd=!1,t.originalData=Object.clone(t.data),t.changeEditMode(!1),this._loadTotal(),t.attachmentChangeFlag&&(this.form.saveFormData(),t.attachmentChangeFlag=!1),this.currentEditedLine=null,this.fireEvent("completeLineEdit",[t]),!0)},_moveUpLine:function(t,e){if(this.currentEditedLine&&!this._completeLineEdit())return!1;if(0!==e.options.index){var i=this.getData(),n=i.data[e.options.index-1],s=i.data[e.options.index];i.data[e.options.index]=n,i.data[e.options.index-1]=s,this.setData(i)}},_changeEditedLine:function(t){if(this.currentEditedLine){if(t===this.currentEditedLine)return;if(!this._completeLineEdit())return}t.changeEditMode(!0),this.currentEditedLine=t},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!==e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_afterLoaded:function(){},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){this._setBusinessData(t),this.data=t,this.data&&this.clearSubModules(),this.lineList=[],this._loadDatatable()},clearSubModules:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].clearSubModules()},isEmpty:function(){var t=this.getData();return!t||!t.data||"array"===o2.typeOf(t.data)&&0===t.data.length},getLine:function(t){return this.lineList[t]||null},addLine:function(t){return this._addLine(null,null,t)},insertLine:function(t,e){return this._insertLineByIndex(null,t,e)},deleteLine:function(t,e){var i=this.lineList[t];if(!i)return null;this._delLine(i)},getModule:function(t,e){var i=this.lineList[t];return i?i.getModule(e):null},getData:function(){return this.importer&&this.importer.destroySimulateModule(),this.editable,this._getBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),n=i.getPrevious("div"),s=i.getChildren().indexOf(e.getParent("div"));n.getLast().getFirst().getChildren()[s].click(),e=n.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();if("object"===o2.typeOf(i)){var n=[];Object.each(i,(function(t,e){"array"===o2.typeOf(t)&&(n=n.concat(t))})),i=n}var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var n=this.json.validationConfig[i];if(!this.validationConfigItem(t,n))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"===i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t},_loadImportExportAction:function(){if(this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.exportenable||this.importenable){var t,e=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom",i=new Element("div").inject(this.node,e);if(this.importExportAreaNode=new Element("div").inject(i),["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"left"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"right"}):this.importExportAreaNode.setStyles({margin:"0px auto"}),this.exportenable)this.exportActionNode=new Element("div",{text:this.json.exportActionText||MWF.xApplication.process.Xform.LP.datagridExport}).inject(this.importExportAreaNode),t=this.json.exportActionStyles?this.json.exportActionStyles:this.form.css.gridExportActionStyles,this.exportActionNode.setStyles(t),this.exportActionNode.addEvent("click",function(){this.exportToExcel()}.bind(this));if(this.importenable)this.importActionNode=new Element("div",{text:this.json.importActionText||MWF.xApplication.process.Xform.LP.datagridImport}).inject(this.importExportAreaNode),t=this.json.importActionStyles?this.json.importActionStyles:this.form.css.gridImportActionStyles,this.importActionNode.setStyles(t),this.importActionNode.addEvent("click",function(){this.importFromExcel()}.bind(this));if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var n=2;this.exportActionNode&&(n=n+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(n=n+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",n+"px")}}},exportToExcel:function(){this.exporter=new MWF.xApplication.process.Xform.DatatablePC.Exporter(this),this.exporter.exportToExcel()},importFromExcel:function(){this.importer=new MWF.xApplication.process.Xform.DatatablePC.Importer(this),this.importer.importFromExcel()}}),MWF.xApplication.process.Xform.DatatablePC$Title=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatablePC$Data=new Class({Extends:MWF.APP$Module}),MWF.xApplication.process.Xform.DatatablePC.Line=new Class({Implements:[Options,Events],options:{isNew:!1,isEdited:!0,isEditable:!0,isDeleteable:!0,isAddable:!0,index:0,indexText:"0"},initialize:function(t,e,i,n){this.setOptions(n),this.node=t,this.datatable=e,this.data=i,this.form=this.datatable.form,this.init()},init:function(){this.modules=[],this.all={},this.all_templateId={},this.fields=[],this.allField={},this.allField_templateId={},this.changedAttachmentMap={}},load:function(){!this.datatable.multiEditMode&&this.options.isEdited&&(this.datatable.currentEditedLine=this),this.loadModules(),this.loadSequence(),this.createActions(),this.loadZebraStyle(),this.loadEditedStyle(),this.addNodeEvent(),this.datatable.multiEditMode||(this.originalData=Object.clone(this.data))},loadModules:function(){this.node.set("html",this.datatable.templateHtml),this.form._getModuleNodes(this.node,!0).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t);if(i){var n=Object.clone(i);this.options.isEdited&&this.options.isEditable||(n.isReadonly=!0);var s=n.id,o=this.options.index,a=this.datatable.json.id+"..data.."+o+".."+n.id;n.id=a,t.set("id",a),"Attachment"!==n.type&&"AttachmentDg"!==n.type||(n.type="AttachmentDg",n.ignoreSite=!0,n.site=this.getAttachmentSite(n,s)),this.form.all[a]&&(this.form.all[a]=null),this.form.forms[a]&&(this.form.forms[a]=null);this.data.hasOwnProperty(s);var r=this.form._loadModule(n,t,(function(){}));"Attachment"!==n.type&&"AttachmentDg"!==n.type||r.addEvent("change",function(){this.datatable.multiEditMode?e.form.saveFormData():e.attachmentChangeFlag=!0}.bind(this)),this.form.modules.push(r),this.modules.push(r),this.all[a]=r,this.all_templateId[s]=r,r.field&&(this.options.isEdited&&"Attachment"!==n.type&&"AttachmentDg"!==n.type&&(this.data[s]=r.getData()),this.allField[a]=r,this.allField_templateId[s]=r,this.fields.push(r),this.datatable.multiEditMode&&this.datatable.totalNumberModuleIds.contains(s)&&r.addEvent("change",function(){this.datatable._loadTotal()}.bind(this)))}}}.bind(this))},getModule:function(t){return this.all_templateId[t]},getAttachmentSite:function(t,e){var i,n=64-(i="."+this.options.index+"."+(t.site||e)).length,s=this.datatable.json.id;return(s=s.length>n?s.substr(s.length-n,n):s)+i},deleteAttachment:function(){var t=!1;for(var e in this.allField){var i=this.allField[e];if("Attachment"===i.json.type||"AttachmentDg"===i.json.type)(i._getBusinessData()||[]).each(function(e){t=!0,this.form.workAction.deleteAttachment(e.id,this.form.businessData.work.id);for(var i=0;i<this.form.businessData.attachmentList.length;i++){var n=this.form.businessData.attachmentList[i];if(n.id===e.id){this.form.businessData.attachmentList.erase(n);break}}}.bind(this))}return t},loadSequence:function(){var t=this.node.getElements(".mwf_sequence");t&&t.set("text",this.options.indexText)},loadZebraStyle:function(){this.options.index%2==0&&this.datatable.json.zebraColor?this.node.setStyle("background-color",this.datatable.json.zebraColor):this.datatable.json.backgroundColor&&this.node.setStyle("background-color",this.datatable.json.backgroundColor)},loadEditedStyle:function(){!this.datatable.multiEditMode&&this.options.isEdited&&this.datatable.json.editStyles&&this.node.getElements("td").setStyles(this.datatable.json.editStyles)},addNodeEvent:function(){!this.datatable.multiEditMode&&this.options.isEditable&&(this.editFun=function(){this.options.isEdited||this.datatable._changeEditedLine(this)}.bind(this),this.node.addEvent("click",this.editFun))},createActions:function(){if(this.options.isEditable){var t=this.node.getElement(".mwf_editaction"),e=this.node.getElement(".mwf_moveaction");this.datatable.multiEditMode?(this.options.isAddable&&this.createAddAction(t),this.options.isDeleteable&&this.createDelAction(t)):(this.options.isAddable&&this.createAddAction(t),this.options.isDeleteable&&this.createDelAction(t),this.createCompleteAction(t),this.createCancelEditAction(t),this.checkActionDisplay()),this.createMoveAction(e)}},checkActionDisplay:function(){this.options.isEdited?(this.addLineAction&&this.addLineAction.hide(),this.delLineAction&&this.delLineAction.hide(),this.completeLineAction&&this.completeLineAction.show(),this.cancelLineEditAction&&this.cancelLineEditAction.show()):(this.addLineAction&&this.addLineAction.show(),this.delLineAction&&this.delLineAction.show(),this.completeLineAction&&this.completeLineAction.hide(),this.cancelLineEditAction&&this.cancelLineEditAction.hide())},createAddAction:function(t){this.addLineAction=new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this.datatable._insertLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createCompleteAction:function(t){this.completeLineAction=new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this.datatable._completeLineEdit(t),t.stopPropagation()}.bind(this)}}).inject(t)},createCancelEditAction:function(t){this.cancelLineEditAction=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this.datatable._cancelLineEdit(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createDelAction:function(t){this.delLineAction=new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this.datatable._deleteLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},createMoveAction:function(t){this.moveAction=new Element("div",{styles:this.form.css.datatableMoveLineAction,text:"↑",events:{click:function(t){this.datatable._moveUpLine(t,this),t.stopPropagation()}.bind(this)}}).inject(t)},changeEditMode:function(t){t!==this.options.isEdited&&this.options.isEditable&&(this.options.isEdited=t,this.reload())},reload:function(){for(var t in this.all){var e=this.all[t];this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.empty(),this.editFun&&(this.node.removeEvent("click",this.editFun),this.editFun=null),this.init(),this.load()},clearSubModules:function(){for(var t in this.all){var e=this.all[t];e.clearSubModules&&e.clearSubModules(),this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.destroy(),this.init()},getData:function(){var t=this.data;for(var e in this.allField_templateId){var i=this.allField_templateId[e];"Attachment"===i.json.type||"AttachmentDg"===i.json.type?t[e]=i._getBusinessData():t[e]=i.getData()}return t},setData:function(t){this.datatable._setLineData(this,t)},validation:function(){if(!this.options.isEdited||!this.options.isEditable)return!0;var t=!0;return this.fields.each(function(e,i){"sequence"!=e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},resetDataWithOriginalData:function(){var t=this.originalData,e=this.form.businessData.attachmentList;for(var i in this.allField_templateId){var n=this.allField_templateId[i];"Attachment"!==n.json.type&&"AttachmentDg"!==n.json.type||(t[i]=(t[i]||[]).filter(function(t,i){for(var n=0;n<e.length;n++)if(e[n].id===t.id)return!0;return!1}.bind(this))),this.data[i]=t[i]}return t}}),MWF.xApplication.process.Xform.DatatablePC.Exporter=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.datatable=t,this.form=this.datatable.form,this.columnJsonList=[]},exportToExcel:function(){this.getColumnList();var t=[],e=this.getTitleArray();t.push(e),this.datatable.lineList.each(function(e,i){t.push(this.getLineExportData(e,i))}.bind(this));var i=this.getColWidthArray(),n=this.getExcelName(),s={data:t,colWidthArray:i,title:n};this.datatable.fireEvent("export",[s]),new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).exportToExcel(s.data||t,s.title||n,s.colWidthArray||i,this.getDateIndexArray())},getColumnList:function(){this.columnJsonList=[];var t=this.datatable.titleTr.getElements("th.mwf_origional"),e=this.datatable.templateTr.getElements("td.mwf_origional");t.each(function(t,i){var n,s=this.form._getDomjson(t);if(e[i]){var o=this.form._getModuleNodes(e[i]);o.length>0&&(n=this.form._getDomjson(o[0]))}s&&n&&this.isAvaliableColumn(s,n)&&this.columnJsonList.push({thJson:s,title:t.get("text"),mJson:n,available:!0})}.bind(this))},getLineExportData:function(t,e){var i=[];return this.columnJsonList.each(function(e){var n;if(e.mJson&&e.available&&(n=t.all_templateId[e.mJson.id]),n){var s="";if(r=n.getData())switch(e.mJson.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if("array"===o2.typeOf(r)){var o=[];r.each(function(t){"object"===o2.typeOf(t)?o.push(t.distinguishedName):o.push(t)}.bind(this)),s=o.join(", \n")}else s="object"===o2.typeOf(r)?r.distinguishedName:r;break;case"Combox":case"Address":s="array"===o2.typeOf(r)?r.join(", "):r;break;case"Checkbox":var a=n.getOptionsObj(),r="array"===o2.typeOf(r)?r:[r],l=[];r.each((function(t,e){var i=a.valueList.indexOf(t);l.push(i>-1?a.textList[i]:"")})),s=l.join(", ");break;case"Radio":case"Select":var h=(a=n.getOptionsObj()).textList.indexOf(r);s=h>-1?a.valueList[h]:"";break;case"Textarea":case"Calendar":default:s=r}else"Label"===e.mJson.type&&n.node&&(s=n.node.get("text"));s||"number"===o2.typeOf(s)||(s=""),i.push(s)}else i.push("")}.bind(this)),i},isAvaliableColumn:function(t,e){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.type&&"sequence"!=e.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.type)))},getColWidthArray:function(){var t=[];return this.columnJsonList.each(function(e,i){e.available&&(e.mJson&&["Org","Reader","Author","Personfield","Orgfield"].contains(e.mJson.type)?t.push(340):e.mJson&&"Address"===e.mJson.type?t.push(170):e.mJson&&"Textarea"===e.mJson.type?t.push(260):e.mJson&&"Htmleditor"===e.mJson.type?t.push(500):(e.mJson&&e.mJson.type,t.push(150)))}.bind(this)),t},getDateIndexArray:function(){var t=[],e=0;return this.columnJsonList.each(function(i){i.available&&i.mJson&&"Calendar"===i.mJson.type&&(t.push(e),e++)}.bind(this)),t},getTitleArray:function(){var t=[];return this.columnJsonList.each(function(e,i){e.available&&e.mJson&&t.push(e.title)}.bind(this)),t},getExcelName:function(){var t=(this.datatable.json.excelName&&this.datatable.json.excelName.code?this.form.Macro.exec(this.datatable.json.excelName.code,this):MWF.xApplication.process.Xform.LP.datatableExportDefaultName).split(".");return["xls","xlst"].contains(t[t.length-1].toLowerCase())&&t.splice(t.length-1),t.join(".")},exportWithImportDataToExcel:function(t){this.getColumnList();var e=[],i=this.getTitleArray("import");i.push(MWF.xApplication.process.Xform.LP.validationInfor),e.push(i),t.each(function(t,i){var n=[];this.columnJsonList.each((function(e,i){n.push((t[e.title]||"").replace(/&#10;/g,"\n"))})),n.push(t.errorTextListExcel?t.errorTextListExcel.join("\n"):""),e.push(n)}.bind(this));var n=this.getColWidthArray();n.push(300);var s=this.getExcelName(),o={data:e,colWidthArray:n,title:s,withError:!0};this.datatable.fireEvent("export",[o]),new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).exportToExcel(o.data||e,o.title||s,o.colWidthArray||n,this.getDateIndexArray())}}),MWF.xApplication.process.Xform.DatatablePC.Importer=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.datatable=t,this.form=this.datatable.form,this.columnJsonList=[]},isAvaliableColumn:function(t,e){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.type&&"sequence"!=e.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.type)))},importFromExcel:function(){this.getColumnList();var t=this.getDateIndexArray(),e=this.getOrgTitleArray();new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable).upload(t,function(t){if(this.checkCount(t)){var i=function(){this.checkData(t)?this.importData(t):this.openErrorDlg(t),this.destroySimulateModule()}.bind(this);e.length>0?this.listAllOrgData(e,t,function(){i()}.bind(this)):i()}}.bind(this))},destroySimulateModule:function(){this.simelateModuleMap&&(Object.keys(this.simelateModuleMap).each(function(t,e){var i=this.simelateModuleMap[t];if(i){var n=i.json.id;this.form.businessData.data.hasOwnProperty(n)&&delete this.form.businessData.data[n],delete this.simelateModuleMap[t]}}.bind(this)),this.simelateModuleMap=null,this.simulateNode&&(this.simulateNode.destroy(),this.simulateNode=null))},loadSimulateModule:function(){this.simelateModuleMap&&this.destroySimulateModule(),this.simelateModuleMap={},this.simulateNode=new Element("div").inject(this.datatable.node),this.simulateNode.hide(),this.simulateNode.set("html",this.datatable.templateHtml),this.form._getModuleNodes(this.simulateNode).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);if(e&&this.isAvaliableColumn(null,e)){var i=Object.clone(e),n=i.id;i.id="dtSimulate_"+i.id,t.set("id",i.id),MWF["APP"+i.type]||MWF.xDesktop.requireApp("process.Xform",i.type,null,!1);var s=new MWF["APP"+i.type](t,i,this.form);this.simelateModuleMap[n]=s,s.load()}}}.bind(this))},getColumnList:function(){this.loadSimulateModule(),this.columnJsonList=[];var t=this.datatable.titleTr.getElements("th.mwf_origional"),e=this.datatable.templateTr.getElements("td.mwf_origional"),i=0;return t.each(function(t,n){var s,o=this.form._getDomjson(t);if(e[n]){var a=this.form._getModuleNodes(e[n]);a.length>0&&(s=this.form._getDomjson(a[0]))}o&&s&&this.isAvaliableColumn(o,s)&&(this.columnJsonList.push({thJson:o,title:t.get("text"),mJson:s,field:s.id,index:i,module:this.simelateModuleMap[s.id]}),i++)}.bind(this)),this.columnJsonList},getDateIndexArray:function(){var t=[],e=0;return this.columnJsonList.each(function(i){i.mJson&&"Calendar"===i.mJson.type&&(t.push(e),e++)}.bind(this)),t},getOrgTitleArray:function(){var t=[];return this.columnJsonList.each(function(e){e.mJson&&["Org","Reader","Author","Personfield","Orgfield"].contains(e.mJson.type)&&t.push(e.title)}.bind(this)),t},parseImportedData:function(t){var e=[];return t.each(function(t){var i={};this.columnJsonList.each(function(e,n){e.index;var s,o=e.module,a=e.mJson,r=e.title,l=t[r]||"";if(""===l||null==l)s="";else switch(a.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":var h=this.stringToArray(l);0===h.length?s=this.getOrgData(l):(s=[],h.each(function(t,e){var i=this.getOrgData(t);s.push(i)}.bind(this)));break;case"Combox":case"Address":h=this.stringToArray(l),s=0===h.length?h[0]:h;break;case"Checkbox":h=this.stringToArray(l);var d=o.getOptionsObj();h.each((function(t,e){var i=d.textList.indexOf(t);h[e]=i>-1?d.valueList[i]:t})),s=1===h.length?h[0]:h;break;case"Radio":case"Select":s=l.replace(/&#10;/g,"");var c=(d=o.getOptionsObj()).textList.indexOf(s);s=c>-1?d.valueList[c]:s;break;case"Textarea":s=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if((s=l.replace(/&#10;/g,""))&&new Date(s).isValid())u=a.format?a.format:"datetime"===a.selectType||"time"===a.selectType?"time"===a.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,s=Date.parse(s).format(u);break;default:s=l.replace(/&#10;/g,"")}i[a.id]=s}.bind(this)),e.push(i)}.bind(this)),e},stringToArray:function(t){return t.replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},importData:function(t){var e=this.parseImportedData(t);this.datatable.fireEvent("import",[e]),this.datatable.setData({data:e}),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openErrorDlg:function(t){var e=this,i=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,n){"style"===e?i.push(n+":"+t+";"):i.push(n+"='"+t+"'")})),i.join(" ")},n=["<table "+i(this.datatable.json.impExpTableProperties)+" style='"+i(this.datatable.json.impExpTableStyles,"style")+"'>"],s=i(this.datatable.json.impExpTableTitleStyles,"style");n.push("<tr>"),this.columnJsonList.each((function(t,e){n.push("<th style='"+s+"'>"+t.title+"</th>")})),n.push("<th style='"+s+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),n.push("</tr>");var o=Object.clone(this.datatable.json.impExpTableContentStyles);o["border-bottom"]||o.border||(o["border-bottom"]="1px solid #eee");var a=i(Object.merge(o,{"text-align":"left"}),"style");t.each(function(t,e){n.push("<tr>"),this.columnJsonList.each((function(e,i){n.push("<td style='"+a+"'>"+(t[e.title]||"").replace(/&#10;/g,"<br/>")+"</td>")})),n.push("<td style='"+a+"'>"+(t.errorTextList?t.errorTextList.join("<br/>"):"")+"</td>"),n.push("</tr>")}.bind(this)),n.push("</table>");var r=this.datatable.json.impExpDlgWidth||1e3,l=this.datatable.json.impExpDlgHeight||700;r=r.toInt(),l=l.toInt();var h=new Element("div",{style:"padding:10px;",html:n.join("")}),d=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:h,offset:{y:0},isMax:!0,width:r,height:l,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){e.exportWithImportDataToExcel(t)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}],onPostClose:function(){d=null}.bind(this)})},checkCount:function(t){var e=MWF.xApplication.process.Xform.LP,i=!1,n=this.datatable.json.maxCount?this.datatable.json.maxCount.toInt():0;n>0&&t.length>n&&(i=!0);var s=!1,o=this.datatable.json.minCount?this.datatable.json.minCount.toInt():0;if(o>0&&t.length<o&&(s=!0),i){var a=e.importTooManyNotice.replace("{n1}",t.length).replace("{n2}",this.datatable.json.maxCount);return this.form.notice(a,"error"),!1}if(s){a=e.importTooFewNotice.replace("{n1}",t.length).replace("{n2}",this.datatable.json.minCount);return this.form.notice(a,"error"),!1}return!0},checkData:function(t){var e=!0,i=MWF.xApplication.process.Xform.LP,n=i.importValidationColumnText,s=i.importValidationColumnTextExcel,o=new MWF.xApplication.process.Xform.DatatablePC.ExcelUtils(this.datatable),a=this.parseImportedData(t,!0);t.each(function(t,r){var l=[],h=[],d=a&&a[r]?a[r]:[];this.columnJsonList.each(function(e,a){var r=e.index,c=e.mJson,u=e.module,p=e.title,m=n.replace("{n}",r+1),f=s.replace("{n}",o.index2ColName(r)),b=t[p]||"",g=d[c.id]||"";if(b)switch(c&&c.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":this.stringToArray(b).each(function(t,e){var n=this.getOrgData(t);n.errorText&&(l.push(m+n.errorText+i.fullstop),h.push(f+n.errorText+i.fullstop))}.bind(this));break;case"Number":isNaN(b)&&(l.push(m+b+i.notValidNumber+i.fullstop),h.push(f+b+i.notValidNumber+i.fullstop));break;case"Calendar":isNaN(b)&&!isNaN(Date.parse(b))||(l.push(m+b+i.notValidDate+i.fullstop),h.push(f+b+i.notValidDate+i.fullstop))}if(u&&u.setData&&"Address"!==c.type){var v=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(c.type)&&"array"===o2.typeOf(g)&&g.length&&(v=g.some((function(t){return t.errorText}))),v||(u.setData(g),u.validationMode(),!u.validation()&&u.errNode&&(l.push(m+u.errNode.get("text")),h.push(f+u.errNode.get("text")),u.errNode.destroy()))}}.bind(this)),l.length>0&&(t.errorTextList=l,t.errorTextListExcel=h,e=!1)}.bind(this));var r={validted:e,data:t};return this.datatable.fireEvent("validImport",[r]),r.validted},exportWithImportDataToExcel:function(t){new MWF.xApplication.process.Xform.DatatablePC.Exporter(this.datatable).exportWithImportDataToExcel(t)},getOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMap[t]||this.personMap[t]||this.unitMap[t]||this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listAllOrgData:function(t,e,i){var n=[],s=[],o=[],a=[];if(t.length>0){var r,l,h,d;e.each(function(e,i){t.each(function(t,i){e[t]&&this.stringToArray(e[t]).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":n.push(t);break;case"@p":s.push(t);break;case"@u":o.push(t);break;case"@g":a.push(t);break;default:n.push(t),s.push(t),o.push(t),a.push(t)}}))}.bind(this))}.bind(this));var c=function(){r&&l&&h&&d&&i&&i()};this.identityMap={},n.length?(n=n.unique(),o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:n},function(t){t.data.each(function(t){this.identityMap[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this))):(r=!0,c()),this.personMap={},s.length?(s=s.unique(),o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:s},function(t){t.data.each(function(t){this.personMap[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this))):(l=!0,c()),this.unitMap={},o.length?(o=o.unique(),o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:o},function(t){t.data.each(function(t){this.unitMap[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this))):(h=!0,c()),this.groupMap={},a.length?(a=a.unique(),o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMap[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this))):(d=!0,c())}}}),MWF.xApplication.process.Xform.DatatablePC.ExcelUtils=new Class({initialize:function(t){this.datatable=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,n=new FileReader;n.onload=function(t){for(var s=new Uint8Array(n.result),o=s.byteLength,a=0;a<o;a++)e+=String.fromCharCode(s[a]);i.content=e,i.onload()},n.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,n=document.createElement("a");n.href=t,n.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var n=new Element("div");n.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),n.getFirst().addEvent("change",function(){var t=s.files;if(t.length){var o=t.item(0);this.importFromExcel(o,function(t){e&&e(t),n.destroy()}.bind(this),i)}}.bind(this));var s=n.getFirst();s.click()},exportToExcel:function(t,e,i,n){this._loadResource(function(){var s=window.xlsxUtils.format2Sheet(t,0,0,null),o=window.xlsxUtils.format2WB(s,"sheet1",void 0),a=o.Sheets[o.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var n=String.fromCharCode(97+e).toUpperCase();a[n+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),n&&n.length&&n.each(function(t,e){n[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var h=a[l];if(h.s||(h.s={}),h.s.alignment||(h.s.alignment={}),h.s.alignment.wrapText=!0,n&&n.length){var d=l.replace(/\d+/g,"");l.replace(d,"")>1&&n.contains(d)&&(h.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(o),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var n,s,o=new FileReader;o.onload=function(t){s=t?t.target.result:o.content;var a=(n=window.XLSX.read(s,{type:"binary"})).SheetNames[0];if(n.Sheets.hasOwnProperty(a)){var r=n.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var h=r["!ref"].split(":");2===h.length&&(l=parseInt(h[1].replace(/[^0-9]/gi,"")))}if(l)for(var d=0;d<i.length;d++)for(var c=1;c<=l;c++){var u=r[i[d]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},o.readAsBinaryString(t)}))}});