MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Documenteditor=MWF.APPDocumenteditor=new Class({Extends:MWF.APP$Module,options:{moduleEvents:["load","queryLoad","beforeLoad","postLoad","afterLoad","loadPage","fullScreen","returnScreen"],docPageHeight:850.4,docPageFullWidth:794,pageShow:"single"},initialize:function(t,e,i,o){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadCss:function(t){var e=encodeURIComponent(this.cssPath);!t&&o2.widget.css[e]?this.css=o2.widget.css[e]:(this.cssPath=-1!=this.cssPath.indexOf("?")?this.cssPath+"&v="+o2.version.v:this.cssPath+"?v="+o2.version.v,new Request.JSON({url:this.cssPath,secure:!1,async:!1,method:"get",noCache:!1,onSuccess:function(t,i){this.css=t,o2.widget.css[e]=t}.bind(this),onError:function(t,e){console.log(e+t)}}).send())},load:function(){this.json.isDelay||this.active()},active:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this.fireEvent("beforeLoad"),this.cssPath=this.form.path+this.form.options.style+"/doc.wcss",this._loadCss(),this._queryLoaded(),this._loadUserInterface(function(){this.fireEvent("postLoad"),this.fireEvent("afterLoad"),this.fireEvent("load"),this.form.app.addEvent("resize",function(){this._singlePage(),this._checkScale()}.bind(this)),o2.UD.getDataJson("documenteditorScale",function(t){t&&(this.scaleTo(t.scale),this.documenteditorScale=t.scale),this.addEvent("loadPage",function(){this.documenteditorScale&&this.scaleTo(this.documenteditorScale)}.bind(this))}.bind(this))}.bind(this)),this._loadStyles(),this._afterLoaded())},_createNewPage:function(){var t=new Element("div.doc_layout_page",{styles:this.css.doc_page}).inject(this.contentNode);new Element("div.doc_layout_page_content",{styles:this.css.doc_layout_page_content}).inject(t);return t.set("data-pagecount",this.pages.length+1),this.pages.push(t),t},_getShow:function(t,e,i){switch(this.json[e]){case"y":return!0;case"n":return!1;case"a":return!["copies","secret","priority","attachment","annotation","copyto","copyto2"].indexOf(-1!=t)||!!this.data[t]&&!!this.data[t].length;case"s":return!this.json[i]||!this.json[i].code||!!this.form.Macro.exec(this.json[i].code,this);default:return!0}},_createPage:function(t,e){var i=this._createNewPage().getFirst(),o=this.getShowControl();if(this.json.fileup=!!o.signer,this.json.css&&this.json.css.code&&!this.styleNode){var s=this.form.parseCSS(this.json.css.code);s=s.replace(/documenteditor_table/g,"documenteditor_table"+this.form.json.id+this.json.id);var n=document.createElement("style");if(n.setAttribute("type","text/css"),n.id="style"+this.json.id,n.inject(this.node,"top"),n.styleSheet){var a=function(){n.styleSheet.cssText=s};n.styleSheet.disabled?setTimeout(a,10):a()}else{var l=document.createTextNode(s);n.appendChild(l)}this.styleNode=n}"cus"==this.json.documentTempleteType?i.loadHtml(o2.filterUrl(this.json.documentTempleteUrl),function(){if("y"==this.json.toWordPageNumber&&this.doPageStyles(i),this.attachmentTemplete){var s=i.getElement(".doc_layout_attachment_content");s&&s.empty()}t&&t(o),this.fireEvent("loadPage"),e&&e(o)}.bind(this)):this.getTempleteJson(function(){var s=this.json.documentTempleteName||"standard";i.loadHtml(o2.filterUrl("../x_component_process_FormDesigner/Module/Documenteditor/templete/"+this.templeteJson[s].file),function(){if("y"==this.json.toWordPageNumber&&this.doPageStyles(i),this.attachmentTemplete){var s=i.getElement(".doc_layout_attachment_content");s&&s.empty()}t&&t(o),this.fireEvent("loadPage"),e&&e(o)}.bind(this))}.bind(this))},doPageStyles:function(t){var e=t.getLast("style");if(e){var i=window.location.origin,o=o2.filterUrl(i+"/x_component_process_FormDesigner/Module/Documenteditor/header.htm"),s=e.get("html"),n=/(?:@page\s*\{)([\s\S]*?)(?:\})/,a=s.match(n);if(a&&a.length){if(cssText=a[2],cssText)";"!==cssText.substr(cssText.length-1,1)&&(cssText+=";"),cssText+='mso-page-border-surround-header:no;\n        mso-page-border-surround-footer:no;\n        mso-footnote-separator:url("'+o+'") fs;\n        mso-footnote-continuation-separator:url("'+o+'") fcs;\n        mso-endnote-separator:url("'+o+'") es;\n        mso-endnote-continuation-separator:url("'+o+'") ecs;\n        mso-facing-pages:yes;',s=s.replace(a[0],a[1]+cssText+a[3])}else s+='@page\n    {mso-page-border-surround-header:no;\n        mso-page-border-surround-footer:no;\n        mso-footnote-separator:url("'+o+'") fs;\n        mso-footnote-continuation-separator:url("'+o+'") fcs;\n        mso-endnote-separator:url("'+o+'") es;\n        mso-endnote-continuation-separator:url("'+o+'") ecs;\n        mso-facing-pages:yes;}';if(n=/(@page\s*WordSection1\s*\{)([\s\S]*?)(\})/,(a=s.match(n))&&a.length){if(cssText=a[2],cssText)";"!==cssText.substr(cssText.length-1,1)&&(cssText+=";"),cssText+='mso-header-margin:42.55pt;\n        mso-footer-margin:70.9pt;\n        mso-even-footer:url("'+o+'") ef1;\n        mso-footer:url("'+o+'") f1;\n        mso-paper-source:0;',s=s.replace(a[0],a[1]+cssText+a[3])}else s+='@page WordSection1\n    {size:595.3pt 841.9pt;\n        margin:104.9pt 73.7pt 99.25pt 79.4pt;\n        layout-grid:15.6pt;\n        line-height:normal;\n        font-size:16.0pt;\n        font-family:仿宋;\n        letter-spacing:-0.4pt;\n        mso-header-margin:42.55pt;\n        mso-footer-margin:70.9pt;\n        mso-even-footer:url("'+o+'") ef1;\n        mso-footer:url("'+o+'") f1;\n        mso-paper-source:0;\n    }';e.set("html",s)}},getTempleteJson:function(t){this.templeteJson?t&&t():o2.getJSON(o2.filterUrl("../x_component_process_FormDesigner/Module/Documenteditor/templete/templete.json"),function(e){this.templeteJson=e,t&&t()}.bind(this))},getShowControl:function(){var t={};return t.copiesSecretPriority=this._getShow("copiesSecretPriority","copiesSecretPriorityShow","copiesSecretPriorityShowScript"),t.copies=this._getShow("copies","copiesShow","copiesShowScript"),t.secret=this._getShow("secret","secretShow","secretShowScript"),t.priority=this._getShow("priority","priorityShow","priorityShowScript"),t.redHeader=this._getShow("redHeader","redHeaderShow","redHeaderShowScript"),t.redLine=this._getShow("redLine","redLineShow","redLineShowScript"),t.signer=this._getShow("signer","signerShow","signerShowScript"),t.fileno=this._getShow("fileno","filenoShow","filenoShowScript"),t.subject=this._getShow("subject","subjectShow","subjectShowScript"),t.mainSend=this._getShow("mainSend","mainSendShow","mainSendShowScript"),t.attachment=this._getShow("attachment","attachmentShow","attachmentShowScript"),t.issuanceUnit=this._getShow("issuanceUnit","issuanceUnitShow","issuanceUnitShowScript"),t.issuanceDate=this._getShow("issuanceDate","issuanceDateShow","issuanceDateShowScript"),t.annotation=this._getShow("annotation","annotationShow","annotationShowScript"),t.copyto=this._getShow("copyto","copytoShow","copytoShowScript"),t.copyto2=this._getShow("copyto2","copyto2Show","copyto2ShowScript"),t.editionUnit=this._getShow("editionUnit","editionUnitShow","editionUnitShowScript"),t.editionDate=this._getShow("editionDate","editionDateShow","editionDateShowScript"),t.meetingAttend=this._getShow("meetingAttend","meetingAttendShow","meetingAttendShowScript"),t.meetingLeave=this._getShow("meetingLeave","meetingLeaveShow","meetingLeaveShowScript"),t.meetingSit=this._getShow("meetingSit","meetingSitShow","meetingSitShowScript"),t.meetingRecord=this._getShow("meetingRecord","meetingRecordShow","meetingRecordShowScript"),t},getEditControl:function(){var t={};return t.copies=this._getEdit("copies","copiesEdit","copiesEditScript"),t.secret=this._getEdit("secret","secretEdit","secretEditScript"),t.priority=this._getEdit("priority","priorityEdit","priorityEditScript"),t.redHeader=this._getEdit("redHeader","redHeaderEdit","redHeaderEditScript"),t.signer=this._getEdit("signer","signerEdit","signerEditScript"),t.fileno=this._getEdit("fileno","filenoEdit","filenoEditScript"),t.subject=this._getEdit("subject","subjectEdit","subjectEditScript"),t.mainSend=this._getEdit("mainSend","mainSendEdit","mainSendEditScript"),t.attachment=this._getEdit("attachment","attachmentEdit","attachmentEditScript"),t.issuanceUnit=this._getEdit("issuanceUnit","issuanceUnitEdit","issuanceUnitEditScript"),t.issuanceDate=this._getEdit("issuanceDate","issuanceDateEdit","issuanceDateEditScript"),t.annotation=this._getEdit("annotation","annotationEdit","annotationEditScript"),t.copyto=this._getEdit("copyto","copytoEdit","copytoEditScript"),t.copyto2=this._getEdit("copyto2","copyto2Edit","copyto2EditScript"),t.editionUnit=this._getEdit("editionUnit","editionUnitEdit","editionUnitEditScript"),t.editionDate=this._getEdit("editionDate","editionDateEdit","editionDateEditScript"),t.meetingAttend=this._getShow("meetingAttend","meetingAttendEdit","meetingAttendEditScript"),t.meetingLeave=this._getShow("meetingLeave","meetingLeaveEdit","meetingLeaveEditScript"),t.meetingSit=this._getShow("meetingSit","meetingSitEdit","meetingSitEditScript"),t.meetingRecord=this._getShow("meetingRecord","meetingRecordEdit","meetingRecordEditScript"),t},_loadCopiesSecretPriority:function(){this.layout_copiesSecretPriority=this.contentNode.getElement(".doc_layout_copiesSecretPriority"),this.layout_copiesSecretPriority&&this.layout_copiesSecretPriority.setStyles(this.css.doc_layout_copiesSecretPriority),this.layout_copies=this.contentNode.getElement(".doc_layout_copies"),this.layout_copies&&this.layout_copies.setStyles(this.css.doc_layout_copies),this.layout_secret=this.contentNode.getElement(".doc_layout_secret"),this.layout_secret&&this.layout_secret.setStyles(this.css.doc_layout_secret),this.layout_priority=this.contentNode.getElement(".doc_layout_priority"),this.layout_priority&&this.layout_priority.setStyles(this.css.doc_layout_priority),this.layout_copiesSecretPriority_blank=this.contentNode.getElement(".doc_layout_copiesSecretPriority_blank")},_loadRedHeader:function(){this.layout_redHeader=this.contentNode.getElement(".doc_layout_redHeader"),this.layout_redHeader&&this.layout_redHeader.setStyles(this.css.doc_layout_redHeader)},_loadFileNoUp:function(){this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_fileNoUpTable&&this.layout_fileNoUpTable.setStyles(this.css.doc_layout_filenoup);var t=this.contentNode.getElement(".doc_layout_filenoup_fileno_td");t&&t.setStyles(this.css.doc_layout_filenoup_fileno_td),this.layout_fileno=this.contentNode.getElement(".doc_layout_filenoup_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_filenoup_fileno),(t=this.contentNode.getElement(".doc_layout_filenoup_signer_td"))&&t.setStyles(this.css.doc_layout_filenoup_signer_td);var e=this.contentNode.getElement(".doc_layout_filenoup_signer_table");e&&e.setStyles(this.css.doc_layout_filenoup_signer_table),(e=this.contentNode.getElement(".doc_layout_filenoup_signerTitle_td"))&&e.setStyles(this.css.doc_layout_filenoup_signerTitle_td),this.layout_signerTitle=this.contentNode.getElement(".doc_layout_filenoup_signer"),this.layout_signerTitle&&this.layout_signerTitle.setStyles(this.css.doc_layout_filenoup_signer),(e=this.contentNode.getElement(".doc_layout_filenoup_signerContent_td"))&&e.setStyles(this.css.doc_layout_filenoup_signerContent_td),this.layout_signer=this.contentNode.getElement(".doc_layout_filenoup_signerContent"),this.layout_signer&&this.layout_signer.setStyles(this.css.doc_layout_filenoup_signerContent),this.layout_fileno||(this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileno=this.contentNode.getElement(".doc_layout_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_fileno))},_loadFileNo:function(){this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileno=this.contentNode.getElement(".doc_layout_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_fileno),(e=this.contentNode.getElement(".doc_layout_filenoup_signer_td"))&&e.setStyles(this.css.doc_layout_filenoup_signer_td);var t=this.contentNode.getElement(".doc_layout_filenoup_signer_table");if(t&&t.setStyles(this.css.doc_layout_filenoup_signer_table),(t=this.contentNode.getElement(".doc_layout_filenoup_signerTitle_td"))&&t.setStyles(this.css.doc_layout_filenoup_signerTitle_td),this.layout_signerTitle=this.contentNode.getElement(".doc_layout_filenoup_signer"),this.layout_signerTitle&&this.layout_signerTitle.setStyles(this.css.doc_layout_filenoup_signer),(t=this.contentNode.getElement(".doc_layout_filenoup_signerContent_td"))&&t.setStyles(this.css.doc_layout_filenoup_signerContent_td),this.layout_signer=this.contentNode.getElement(".doc_layout_filenoup_signerContent"),this.layout_signer&&this.layout_signer.setStyles(this.css.doc_layout_filenoup_signerContent),!this.layout_fileno){this.layout_filenoArea=this.contentNode.getElement(".doc_layout_fileno_area"),this.layout_fileNoUpTable=this.contentNode.getElement(".doc_layout_filenoup"),this.layout_fileNoUpTable&&this.layout_fileNoUpTable.setStyles(this.css.doc_layout_filenoup);var e=this.contentNode.getElement(".doc_layout_filenoup_fileno_td");e&&e.setStyles(this.css.doc_layout_filenoup_fileno_td),this.layout_fileno=this.contentNode.getElement(".doc_layout_filenoup_fileno"),this.layout_fileno&&this.layout_fileno.setStyles(this.css.doc_layout_filenoup_fileno)}},_loadRedLine:function(){this.layout_redLine=this.contentNode.getElement(".doc_layout_redline"),this.layout_redLine&&this.layout_redLine.setStyles(this.css.doc_layout_redline)},_loadSubject:function(){this.layout_subject=this.contentNode.getElement(".doc_layout_subject"),this.layout_subject&&this.layout_subject.setStyles(this.css.doc_layout_subject)},_loadMainSend:function(){this.layout_mainSend=this.contentNode.getElement(".doc_layout_mainSend"),this.layout_mainSend&&this.layout_mainSend.setStyles(this.css.doc_layout_mainSend)},_loadFiletext:function(){this.layout_filetext=this.contentNode.getElement(".doc_layout_filetext"),this.layout_filetext.addClass("css"+this.form.json.id+this.json.id),this.layout_filetext.setStyles(this.css.doc_layout_filetext)},_loadAttachment:function(){this.layout_attachmentTable=this.contentNode.getElement(".doc_layout_attachment"),this.layout_attachmentTable&&this.layout_attachmentTable.setStyles(this.css.doc_layout_attachment);var t=this.contentNode.getElement(".doc_layout_attachment_title_td");t&&t.setStyles(this.css.doc_layout_attachment_title_td),this.layout_attachmentTitle=this.contentNode.getElement(".doc_layout_attachment_title"),t&&t.setStyles(this.css.doc_layout_attachment_title),(t=this.contentNode.getElement(".doc_layout_attachment_content_td"))&&t.setStyles(this.css.doc_layout_attachment_content_td),this.layout_attachment=this.contentNode.getElement(".doc_layout_attachment_content"),this.layout_attachment&&this.layout_attachment.setStyles(this.css.doc_layout_attachment_content)},_loadIssuance:function(){this.layout_issuanceTable=this.contentNode.getElement(".doc_layout_issuance"),this.layout_issuanceUnit=this.contentNode.getElement(".doc_layout_issuanceUnit"),this.layout_issuanceDate=this.contentNode.getElement(".doc_layout_issuanceDate"),this.layout_issuanceTable&&this.layout_issuanceTable.setStyles(this.css.doc_layout_issuance),this.layout_issuanceUnit&&this.layout_issuanceUnit.setStyles(this.css.doc_layout_issuanceUnit),this.layout_issuanceDate&&this.layout_issuanceDate.setStyles(this.css.doc_layout_issuanceDate)},_loadAnnotation:function(){this.layout_annotation=this.contentNode.getElement(".doc_layout_annotation"),this.layout_annotation&&this.layout_annotation.setStyles(this.css.doc_layout_annotation)},_loadEdition:function(){var t;this.layout_editionArea=this.contentNode.getElement(".doc_layout_editionArea"),this.layout_edition=this.contentNode.getElement(".doc_layout_edition"),this.layout_edition&&this.layout_edition.setStyles(this.css.doc_layout_edition),(t=this.contentNode.getElement(".doc_layout_edition_copyto"))&&t.setStyles(this.css.doc_layout_edition_copyto),(t=this.contentNode.getElement(".doc_layout_edition_copyto_table"))&&t.setStyles(this.css.doc_layout_edition_copyto_table),(t=this.contentNode.getElement(".doc_layout_edition_copyto2"))&&t.setStyles(this.css.doc_layout_edition_copyto),(t=this.contentNode.getElement(".doc_layout_edition_copyto2_table"))&&t.setStyles(this.css.doc_layout_edition_copyto_table),this.layout_copytoTitle=this.contentNode.getElement(".doc_layout_edition_copyto_title"),this.layout_copytoTitle&&this.layout_copytoTitle.setStyles(this.css.doc_layout_edition_copyto_title),this.layout_copytoContent=this.contentNode.getElement(".doc_layout_edition_copyto_content"),this.layout_copytoContent&&this.layout_copytoContent.setStyles(this.css.doc_layout_edition_copyto_content),this.layout_copyto2Title=this.contentNode.getElement(".doc_layout_edition_copyto2_title"),this.layout_copyto2Title&&this.layout_copyto2Title.setStyles(this.css.doc_layout_edition_copyto_title),this.layout_copyto2Content=this.contentNode.getElement(".doc_layout_edition_copyto2_content"),this.layout_copyto2Content&&this.layout_copyto2Content.setStyles(this.css.doc_layout_edition_copyto_content);var e=this.contentNode.getElement(".doc_layout_edition_issuance");e&&e.setStyles(this.css.doc_layout_edition_issuance);var i=this.contentNode.getElement(".doc_layout_edition_issuance_table");i&&i.setStyles(this.css.doc_layout_edition_issuance_table),this.layout_edition_issuance_unit=this.contentNode.getElement(".doc_layout_edition_issuance_unit"),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit.setStyles(this.css.doc_layout_edition_issuance_unit),this.layout_edition_issuance_date=this.contentNode.getElement(".doc_layout_edition_issuance_date"),this.layout_edition_issuance_date&&this.layout_edition_issuance_date.setStyles(this.css.doc_layout_edition_issuance_date)},_loadMeeting:function(){this.layout_meetingAttendArea=this.contentNode.getElement(".doc_layout_meeting_attend"),this.layout_meetingAttendTitle=this.contentNode.getElement(".doc_layout_meeting_attend_title"),this.layout_meetingAttendContent=this.contentNode.getElement(".doc_layout_meeting_attend_content"),this.layout_meetingLeaveArea=this.contentNode.getElement(".doc_layout_meeting_leave"),this.layout_meetingLeaveTitle=this.contentNode.getElement(".doc_layout_meeting_leave_title"),this.layout_meetingLeaveContent=this.contentNode.getElement(".doc_layout_meeting_leave_content"),this.layout_meetingSitArea=this.contentNode.getElement(".doc_layout_meeting_sit"),this.layout_meetingSitTitle=this.contentNode.getElement(".doc_layout_meeting_sit_title"),this.layout_meetingSitContent=this.contentNode.getElement(".doc_layout_meeting_sit_content"),this.layout_meetingRecordArea=this.contentNode.getElement(".doc_layout_meeting_record"),this.layout_meetingRecordTitle=this.contentNode.getElement(".doc_layout_meeting_record_title"),this.layout_meetingRecordContent=this.contentNode.getElement(".doc_layout_meeting_record_content")},_loadCustom:function(){this.contentNode.getElements(".doc_layout").each(function(t){var e=t.get("data-doc-layout");this.customLayouts||(this.customLayouts=[]),this.customLayouts.push({name:e,node:t}),this[e]=t}.bind(this))},_loadPageLayout:function(t){this._loadCopiesSecretPriority(),this._loadRedHeader(),this.json.fileup?this._loadFileNoUp():this._loadFileNo(),this.layout_fileno||this._loadFileNo(),this._loadRedLine(),this._loadSubject(),this._loadMainSend(),this._loadFiletext(),this._loadAttachment(),this._loadIssuance(),this._loadAnnotation(),this._loadEdition(),this._loadMeeting(),this._loadCustom(),this.reSetShow(t),this.reSetEdit()},reSetShow:function(t){t||(t=this.getShowControl());var e=function(e){return t[e]?"show":"hide"};this.layout_copiesSecretPriority&&this.layout_copiesSecretPriority[e("copiesSecretPriority")]();var i=0;if(t.copies||i++,t.secret||i++,t.priority||i++,this.layout_copiesSecretPriority_blank)for(;i>0;)this.layout_copiesSecretPriority_blank.empty(),this.layout_copiesSecretPriority_blank.appendHTML("<span style='font-size:16.0pt'>&nbsp;</span>"),i--;if(this.layout_copies&&this.layout_copies[e("copies")](),this.layout_secret&&this.layout_secret[e("secret")](),this.layout_priority&&this.layout_priority[e("priority")](),this.layout_redHeader&&this.layout_redHeader[e("redHeader")](),this.layout_redLine&&this.layout_redLine[e("redLine")](),this.layout_fileNoUpTable&&this.layout_fileNoUpTable[e("signer")](),this.layout_filenoArea&&this.layout_filenoArea[t.signer?"hide":"show"](),this.layout_signerTitle&&this.layout_signerTitle[e("signer")](),this.layout_signer&&this.layout_signer[e("signer")](),this.layout_fileno&&this.layout_fileno[e("fileno")](),this.layout_subject&&this.layout_subject[e("subject")](),this.layout_mainSend&&this.layout_mainSend[e("mainSend")](),this.layout_attachmentTable&&this.layout_attachmentTable[e("attachment")](),this.layout_issuanceUnit&&this.layout_issuanceUnit[e("issuanceUnit")](),this.layout_issuanceDate&&this.layout_issuanceDate[e("issuanceDate")](),this.layout_issuanceUnit&&this.layout_issuanceDate){var o=this.layout_issuanceUnit.getParent("table");if(o&&!o.hasClass("doc_layout_headIssuance")){var s=o2.getTextSize(this.layout_issuanceUnit.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x,n=o2.getTextSize(this.layout_issuanceDate.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x;if(s<n){if(a=this.layout_issuanceDate.getParent("td").getNext("td")){a.setStyle("width","64pt"),(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","64pt")}this.layout_issuanceUnit.getParent("td").setStyle("width",n),(l=this.layout_issuanceUnit.getParent("p"))&&l.setStyle("text-align","center")}else{var a,l;(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","32pt"),this.layout_issuanceUnit.getParent("td").setStyle("width","auto"),(a=this.layout_issuanceDate.getParent("td").getNext("td"))&&a.setStyle("width","64pt"),(l=this.layout_issuanceDate.getParent("p"))&&l.setStyle("text-align","right")}}}if(this.layout_annotation&&this.layout_annotation[e("annotation")](),t.copyto&&this.layout_copytoContent||t.copyto2&&this.layout_copyto2Content||t.editionUnit&&this.layout_edition_issuance_unit||t.editionDate&&this.layout_edition_issuance_date){if(t.copyto&&this.layout_copytoContent||t.copyto2&&this.layout_copyto2Content?t.copyto&&this.layout_copytoContent?t.copyto2&&this.layout_copyto2Content||this.layout_copyto2Content&&this.layout_copyto2Content.getParent("tr").destroy():this.layout_copytoContent&&this.layout_copytoContent.getParent("tr").destroy():this.layout_edition&&(this.layout_copytoContent&&this.layout_copytoContent.getParent("tr").destroy(),this.layout_copyto2Content&&this.layout_copyto2Content.getParent("tr").destroy()),!(t.editionUnit&&this.layout_edition_issuance_unit||t.editionDate&&this.layout_edition_issuance_date)&&this.layout_editionArea&&(this.contentNode.getElement(".doc_layout_edition_issuance_date")||this.contentNode.getElement(".doc_layout_edition_issuance_unit"))){var h=this.layout_editionArea.getElement("table").rows;h.item(h.length-1).destroy()}if(this.layout_editionArea&&(this.layout_edition_issuance_date||this.layout_edition_issuance_unit)){h=this.layout_editionArea.getElement("table").rows;for(var c=0;c<h.length;c++){var r=h.item(c).cells;for(i=0;i<r.length;i++){var d=r.item(i),u=d.get("class"),_=u?u.split(/\s+/g):[];-1!=_.indexOf("line_top_thin_bottom_thick")&&(_=_.erase("line_top_thin_bottom_thick")),-1!=_.indexOf("line_top_thick_bottom_thin")&&(_=_.erase("line_top_thick_bottom_thin")),-1!=_.indexOf("line_top_thick_bottom_thick")&&(_=_.erase("line_top_thick_bottom_thick")),-1==_.indexOf("line_top_thin_bottom_thin")&&_.unshift("line_top_thin_bottom_thin"),0==c&&c!=h.length-1?(-1!=_.indexOf("line_top_thin_bottom_thin")&&(_=_.erase("line_top_thin_bottom_thin")),_.unshift("line_top_thick_bottom_thin")):0==c&&c==h.length-1?(-1!=_.indexOf("line_top_thin_bottom_thin")&&(_=_.erase("line_top_thin_bottom_thin")),_.unshift("line_top_thick_bottom_thick")):0!=c&&c==h.length-1&&(-1!=_.indexOf("line_top_thin_bottom_thin")&&(_=_.erase("line_top_thin_bottom_thin")),_.unshift("line_top_thin_bottom_thick")),u=_.join(" "),d.set("class",u)}}}var p=this.layout_copytoTitle||this.layout_copyto2Title;if(p){var y=p.getParent("table");if(y&&"y"==y.get("data-compute-style")){var m=y.rows;for(c=0;c<m.length;c++){var g=m[c].cells[0],f=g.getElement(".doc_layout_edition_issuance_unit");if(f||(f=g.getElement(".doc_layout_edition_issuance_date")),!f){var S=g.get("text").trim(),b=14*S.length,x=19*S.length;g.setStyles({"max-width":b+"pt","min-width":b+"pt",width:x+"pt"})}}}}this.layout_editionArea&&this.layout_editionArea.show(),this.layout_copytoTitle&&this.layout_copytoTitle[e("copyto")](),this.layout_copytoContent&&this.layout_copytoContent[e("copyto")](),this.layout_copyto2Title&&this.layout_copyto2Title[e("copyto2")](),this.layout_copyto2Content&&this.layout_copyto2Content[e("copyto2")](),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit[e("editionUnit")](),this.layout_edition_issuance_date&&this.layout_edition_issuance_date[e("editionDate")]()}else this.layout_editionArea&&this.layout_editionArea.hide();this.layout_meetingAttendArea&&this.layout_meetingAttendArea[e("meetingAttend")](),this.layout_meetingLeaveArea&&this.layout_meetingLeaveArea[e("meetingLeave")](),this.layout_meetingSitArea&&this.layout_meetingSitArea[e("meetingSit")](),this.layout_meetingRecordArea&&this.layout_meetingRecordArea[e("meetingRecord")]()},reSetEdit:function(t){if(!t)t=this.getEditControl();this.layout_subject&&(this.json.subjectValueData||"data"!=this.json.subjectValueType||(this.layout_subject.set("contenteditable",t.subject),this.layout_subject.addEvent("blur",function(t){var e=this.layout_subject.get("text");e?(this.json.subjectEditBindFormData&&(this.form.Macro.environment.data[this.json.subjectEditBindFormData]=e),this.getData()):(this.layout_subject.set("html",this.data.subject),this.form.app.notice(MWF.xApplication.process.Xform.LP.subjectEmpty,"error",this.layout_subject,{x:"center",y:"top"},{x:0,y:60}),t.preventDefault(),t.stopPropagation())}.bind(this)))),this.layout_issuanceUnit&&(this.json.issuanceUnitValueData||"data"!=this.json.issuanceUnitValueType||(this.layout_issuanceUnit.set("contenteditable",t.issuanceUnit),this.layout_issuanceUnit.addEvent("blur",function(t){this.layout_issuanceUnit.get("text")?this.getData():(this.layout_issuanceUnit.set("html",this.data.issuanceUnit),this.form.app.notice(MWF.xApplication.process.Xform.LP.issuanceUnitEmpty,"error",this.layout_issuanceUnit,{x:"center",y:"top"},{x:0,y:60}),t.preventDefault(),t.stopPropagation())}.bind(this))))},_loadUserInterface:function(t){this.node.empty(),this.node.setStyles(this.form.css.documentEditorNode),this.pages=[],this.allowEdit=this._isAllowEdit(),this.allowPrint=this._isAllowPrint(),this.allowHistory=this._isAllowHistory(),this.toolNode=new Element("div",{styles:this.css.doc_toolbar}).inject(this.node),this.contentNode=new Element("div#doc_content",{styles:this.css.doc_content}).inject(this.node),this.form.isLoaded?this.loadDocumentEditor(t):this.form.addEvent("afterModulesLoad",function(){this.loadDocumentEditor(t)}.bind(this))},loadDocumentEditor:function(t){this._loadToolbars(),this._loadFiletextPage(function(){if("double"!==this.options.pageShow?this._singlePage():this._doublePage(),this.form.addEvent("beforeSave",function(){this.resetData(),this.checkSaveNewEdition()}.bind(this)),"y"==this.json.toWord&&("open"==this.json.toWordTrigger&&this.docToWord(),"save"==this.json.toWordTrigger&&(this.form.toWordSaveList||(this.form.toWordSaveList=[]),this.form.toWordSaveList.push(this)),"submit"==this.json.toWordTrigger&&(this.form.toWordSubmitList||(this.form.toWordSubmitList=[]),this.form.toWordSubmitList.push(this))),layout.mobile||this.loadSideToolbar(),o2.load("../o2_lib/diff-match-patch/diff_match_patch.js"),this.form.businessData.data.$work){var e=this.form.businessData.data.$work.job;o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.listWithJobCategory(e,this.json.id,function(t){this.historyDocumentList=t.data,this.historyDocumentList.length&&o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.get(this.historyDocumentList[this.historyDocumentList.length-1].id,function(t){var e=JSON.parse(t.data.data);this.originaHistoryData=e.data}.bind(this))}.bind(this))}t&&t()}.bind(this)),this.form.documenteditorList||(this.form.documenteditorList=[]),this.form.documenteditorList.push(this)},getFiletextText:function(t){var e=new Element("div",{html:t}),i=e.get("text");return e.destroy(),i},checkSaveNewEdition:function(t){if(!this.allowEdit||!this.data.filetext||this.data.filetext==this.json.defaultValue.filetext)return!1;if(this.form.businessData.work){var e=this.form.businessData.originalData[this.json.id],i={category:this.json.id};if(e&&e.filetext&&this.originaHistoryData){if(e.filetext==this.data.filetext)return!1;var o=this.getFiletextText(this.data.filetext),s=this.getFiletextText(e.filetext),n=new diff_match_patch,a=n.diff_main(s,o);n.diff_cleanupSemantic(a);var l=n.patch_make(s,o,a),h={patchs:n.patch_toText(l),data:this.data.filetext,v:"6"};i.data=JSON.stringify(h)}else this.originaHistoryData={data:this.data.filetext,v:"6"},i.data=JSON.stringify({data:this.data.filetext,v:"6"});o2.Actions.load("x_processplatform_assemble_surface").DocumentVersionAction.create(this.form.businessData.work.id,i,function(e){t&&t()}.bind(this))}},checkSaveNewHistroy:function(){var t=o2.Actions.load("x_processplatform_assemble_surface").DocumentRevisionAction.getLast(this.form.businessData.work.job,this.json.id);return t.then(function(t){if(!t.data||t.data.data!=this.data.filetext){var e={category:this.json.id,data:this.data.filetext};return o2.Actions.load("x_processplatform_assemble_surface").DocumentRevisionAction.create(this.form.businessData.work.id,e)}}.bind(this)),t},resizeToolbar:function(t){if(this.toolbarNode){var e=this.toolNode.getPosition(t||this.scrollNode),i=this.toolNode.getSize(),o=this.toolbarNode.getStyle("padding-left").toInt(),s=this.toolbarNode.getStyle("padding-right").toInt(),n=i.x-o-s,a=this.isFullScreen?0:(t||this.form.node).getStyle("padding-top");try{a=a.toInt()}catch(t){a=0}e.y<a&&this.toolNode.offsetParent?(this.toolbarNode.inject(t||this.scrollNode),this.toolbarNode.setStyles({position:"absolute",width:n+"px","z-index":200,top:a+"px",left:e.x+"px"})):(this.toolbarNode.inject(this.toolNode),this.toolbarNode.setStyles({position:"static",width:"auto"}))}},resizeSidebar:function(){if(this.sidebarNode){var t=this.contentNode.getElement("div.doc_layout_filetext");if(t){this.sidebarNode.position({relativeTo:t,position:"topLeft",edge:"topRight",offset:{x:-20,y:60}});var e=t.getPosition(this.form.app.content),i=t.getPosition(this.node);if(e.y<0){var o=i.y-e.y+200;this.sidebarNode.setStyle("top",o)}}}},loadSideToolbar:function(){this.allowEdit&&(this.pages.length&&this.pages[0].getElement("div.doc_layout_filetext")&&(this.sidebarNode=new Element("div",{styles:this.css.doc_sidebar}).inject(this.node),this.resizeSidebar(),this.scrollNode=this.sidebarNode.getParentSrcollNode(),this.scrollNode&&this.scrollNode.addEvent("scroll",function(){this.resizeSidebar()}.bind(this)),html='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/editdoc.png" title="'+MWF.xApplication.process.Xform.LP.editdoc+'" MWFButtonAction="_switchReadOrEditInline" MWFButtonText="'+MWF.xApplication.process.Xform.LP.editdoc+'"></span>',this.sidebarNode.set("html",html),MWF.require("MWF.widget.Toolbar",function(){this.sideToolbar=new MWF.widget.Toolbar(this.sidebarNode,{style:"documentEdit_side"},this),this.sideToolbar.load()}.bind(this))))},_returnScale:function(){this.isScale=!1,this.scale=0,this.contentNode.setStyles({transform:"scale(1)"}),this.pages.length&&this.pages.each((function(t){t.setStyles({transform:"scale(1)"})})),this.node.setStyles({height:"auto"})},_checkScale:function(t){if(0,this.pages.length){var e=this.options.docPageFullWidth,i=this.contentNode.getSize(),o=i.x-20;if(o<e){this.isScale=!0;var s=o/e;this.scale=s,this.zoom(),this.resetNodeSize()}}},zoom:function(t){if(t&&(this.scale=t),this.zoomSelectAction)for(var e=0;e<this.zoomSelectAction.options.length;e++){var i=this.zoomSelectAction.options[e];if(Math.abs(this.scale-i.value.toFloat())<.05){i.set("selected",!0);break}}var o=this.node.getSize().x;this.history&&this.history.historyListAreaNode&&(o=o-this.history.historyListAreaNode.getComputedSize().totalWidth-2),o/=this.scale,this.contentNode.setStyles({transform:"scale("+this.scale+")","transform-origin":"0px 0px",overflow:"auto",width:o+"px"}),this.filetextEditor&&this.filetextEditor.element&&this.filetextEditor.element.$.store("scale",this.scale)},_switchReadOrEdit:function(){if(this.editMode){if(this._readFiletext(),this.allowEdit)(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png");this.editMode=!1}else{var t;if(this._editFiletext(),this.allowEdit)(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png");this.editMode=!0}},_switchReadOrEditInline:function(){if(this.editMode){if(this._readFiletext(),this.allowEdit){if(!layout.mobile)(t=this.sideToolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png");(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc.png")}this.editMode=!1}else{if(this._editFiletext("inline"),this.allowEdit){var t;if(!layout.mobile)(t=this.sideToolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png");(t=this.toolbar.childrenButton[0]).setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdocCompleted_mobile:MWF.xApplication.process.Xform.LP.editdocCompleted),t.picNode.getElement("img").set("src","../x_component_process_Xform/$Form/default/icon/editdoc_completed.png")}this.editMode=!0}},_printDoc:function(){var t=this.scale;this.toWord(function(e,i){i?o2.saveAs(e,i):this.form.businessData.work&&!this.form.businessData.work.completedTime?this.form.workAction.getAttachmentStream(e.id,this.form.businessData.work.id):this.form.workAction.getWorkcompletedAttachmentStream(e.id,this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id),this.scaleTo(t)}.bind(this),"",null,!0)},_historyDoc:function(){this.getHistory(function(){}.bind(this))},getHistory:function(t){this.history?this.history.active((function(){t&&t()})):MWF.xDesktop.requireApp("process.Xform","widget.DocumentHistory",function(){this.history=new MWF.xApplication.process.Xform.widget.DocumentHistory(this),this.history.load((function(){t&&t()}))}.bind(this))},htmlToText:function(t){var e=new Element("div",{html:t}),i=e.get("text");return e.destroy(),i},_readFiletext:function(){var t=this.scale;this.filetextEditor&&this.filetextEditor.destroy(),this.filetextScrollNode&&(this.reLocationFiletextToolbarFun&&(this.filetextScrollNode.removeEvent("scroll",this.reLocationFiletextToolbarFun),this.reLocationFiletextToolbarFun=null),this.filetextScrollNode=null),this.filetextToolbarNode&&(this.filetextToolbarNode=null),this.layout_filetext.setAttribute("contenteditable",!1),this.data=this.getData(),this.data.filetext||this.layout_filetext.set("html",this.json.defaultValue.filetext),this._repage(),this.scaleTo(t)},_editFiletext:function(t){this._returnScale(),this.zoom(1),this._singlePage(),this.pages=[],this.contentNode.empty(),this._createPage(function(e){this._loadPageLayout(e),this.data.filetext==this.json.defaultValue.filetext&&(this.data.filetext="　　"),this.setData(this.data),this._checkScale(),this.node.setStyles({height:"auto"}),this._createEditor(t)}.bind(this))},_createEditor:function(t){this.allowEdit&&this.loadCkeditorFiletext(function(t){var e;(t.editor.focus(),this.data.filetext.replace(/\u3000*/g,""))?t.editor.getSelection().scrollIntoView():((e=t.editor.createRange()).moveToElementEditEnd(t.editor.editable()),e.select(),e.scrollIntoView());this.data.filetext.replace(/\u3000*/g,"")?t.editor.getSelection().scrollIntoView():((e=t.editor.createRange()).moveToElementEditEnd(t.editor.editable()),e.select(),e.scrollIntoView());this.locationFiletextToolbar()}.bind(this),t)},getFiletextToolber:function(){if(this.filetextEditor&&!this.filetextToolbarNode){var t="cke_editor_"+this.filetextEditor.name,e=$$("."+t)[0];this.filetextToolbarNode=e}},reLocationFiletextToolbar:function(){if(this.getFiletextToolber(),this.filetextToolbarNode){if(!this.filetextScrollNode){for(var t=this.contentNode;t&&(t.getScrollSize().y<=t.getSize().y||"auto"!==t.getStyle("overflow")&&"auto"!==t.getStyle("4-y"));)t=t.getParent();this.filetextScrollNode=t}var e=this.filetextToolbarNode.getSize().y,i=this.layout_filetext.getPosition(),o=this.layout_filetext.getSize(),s=this.filetextScrollNode.getSize();if(layout.userLayout&&layout.userLayout.scale&&1!==layout.userLayout.scale){var n=this.filetextEditor.editable().$.getPosition().x;this.filetextToolbarNode.setStyle("left",n+"px")}if(this.filetextToolbarNode.setStyle("min-width","530px"),i.y<0&&o.y+i.y+e<s.y){var a=this.toolbar.node.getPosition(),l=this.toolbar.node.getSize().y;e=a.y+l;this.filetextToolbarNode.setStyle("top",e+"px")}else if(i.y-e<0){a=this.toolbar.node.getPosition(),l=this.toolbar.node.getSize().y,e=a.y+l;this.filetextToolbarNode.setStyle("top",e+"px")}else{var h=this.layout_filetext.getPosition().y-e;this.filetextToolbarNode.setStyle("top",h+"px")}}},locationFiletextToolbar:function(){if(this.reLocationFiletextToolbar(),this.filetextToolbarNode){for(var t=this.contentNode;t&&(t.getScrollSize().y<=t.getSize().y||"auto"!==t.getStyle("overflow")&&"auto"!==t.getStyle("overflow-y"));)t=t.getParent();t&&(this.filetextScrollNode=t,this.reLocationFiletextToolbarFun=this.reLocationFiletextToolbar.bind(this),this.filetextScrollNode.addEvent("scroll",this.reLocationFiletextToolbarFun))}},_isAllowEdit:function(){return!this.readonly&&("n"!=this.json.allowEdit&&("s"!=this.json.allowEdit||!this.json.allowEditScript||!this.json.allowEditScript.code||!!this.form.Macro.exec(this.json.allowEditScript.code,this)))},_isAllowPrint:function(){return"n"!=this.json.allowPrint&&("s"!=this.json.allowPrint||!this.json.allowPrintScript||!this.json.allowPrintScript.code||!!this.form.Macro.exec(this.json.allowPrintScript.code,this))},_isAllowHistory:function(){return"n"!=this.json.allowHistory&&("s"!=this.json.allowHistory||!this.json.allowHistoryScript||!this.json.allowHistoryScript.code||!!this.form.Macro.exec(this.json.allowHistoryScript.code,this))},_getEdit:function(t,e,i){switch(this.json[e]){case"y":return!0;case"n":return!1;case"s":return!this.json[i]||!this.json[i].code||!!this.form.Macro.exec(this.json[i].code,this)}},loadCkeditorStyle:function(t){t&&o2.load("ckeditor",function(){t.setAttribute("contenteditable",!0);CKEDITOR.inline(this.layout_filetext,this._getEditorConfig());this.filetextEditor.on("instanceReady",function(t){callback&&callback(t)}.bind(this))}.bind(this))},_loadToolbars:function(){var t,e,i,o="",s=MWF.xApplication.process.Xform.LP.fullScreen;layout.mobile?(t=MWF.xApplication.process.Xform.LP.editdoc_mobile,e=MWF.xApplication.process.Xform.LP.printdoc_mobile,i=MWF.xApplication.process.Xform.LP.history_mobile):(t=MWF.xApplication.process.Xform.LP.editdoc,e=MWF.xApplication.process.Xform.LP.printdoc,i=MWF.xApplication.process.Xform.LP.history),this.allowEdit&&(o+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/editdoc.png" title="'+t+'" MWFButtonAction="_switchReadOrEditInline" MWFButtonText="'+t+'"></span>'),this.allowPrint&&(o+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/print.png" title="'+e+'" MWFButtonAction="_printDoc" MWFButtonText="'+e+'"></span>'),this.allowHistory&&(o+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/versions.png" title="'+i+'" MWFButtonAction="_historyDoc" MWFButtonText="'+i+'"></span>'),"n"!==this.json.canFullScreen&&(o+='<span MWFnodetype="MWFToolBarButton" MWFButtonImage="../x_component_process_Xform/$Form/default/icon/fullscreen.png" title="'+s+'" MWFButtonAction="fullScreen" MWFButtonText="'+s+'"></span>'),this.toolbarNode=new Element("div",{styles:this.css.doc_toolbar_node}).inject(this.toolNode),this.toolbarNode.set("html",o),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:"documentEdit"},this),this.toolbar.load()}.bind(this)),layout.mobile||(this.scrollNode=this.toolbarNode.getParentSrcollNode(),this.scrollNode&&this.scrollNode.addEvent("scroll",function(){this.resizeToolbar()}.bind(this))),this.doublePageAction=new Element("div",{styles:this.css.doc_toolbar_doublePage,text:MWF.xApplication.process.Xform.LP.doublePage}).inject(this.toolbarNode),this.doublePageAction.addEvent("click",function(){"double"!==this.options.pageShow?this._doublePage():(this.options.pageShow="single",this.reload())}.bind(this)),("n"===this.json.canDoublePage||layout.mobile)&&this.doublePageAction.hide(),this.zoomActionArea=new Element("div",{styles:{float:"right","margin-right":"10px"}}).inject(this.toolbarNode),"y"!==this.json.isScale&&this.zoomActionArea.hide(),this.zoomAddAction=new Element("div",{styles:{float:"right","margin-top":"3px",height:"20px",width:"20px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"+"}).inject(this.zoomActionArea),this.zoomSelectAction=new Element("select",{styles:{float:"right","margin-top":"3px",height:"20px",width:"60px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"100%"}).inject(this.zoomActionArea),this.zoomSubAction=new Element("div",{styles:{float:"right","margin-top":"3px",height:"20px",width:"20px","text-align":"center","line-height":"20px",border:"1px solid #cccccc","background-color":"#ffffff","margin-left":"5px"},text:"-"}).inject(this.zoomActionArea);this.zoomSelectAction.set("html","<option value='2'>200%</option> <option value='1.95'>195%</option><option value='1.9'>190%</option><option value='1.85'>185%</option><option value='1.8'>180%</option><option value='1.75'>175%</option><option value='1.7'>170%</option><option value='1.65'>165%</option><option value='1.6'>160%</option><option value='1.55'>155%</option><option value='1.5'>150%</option> <option value='1.45'>145%</option><option value='1.4'>140%</option><option value='1.35'>135%</option><option value='1.3'>130%</option><option value='1.25'>125%</option><option value='1.2'>120%</option><option value='1.15'>115%</option><option value='1.1'>110%</option><option value='1.05'>105%</option><option value='1' selected>100%</option><option value='0.95'>95%</option><option value='0.90'>90%</option><option value='0.85'>85%</option><option value='0.80'>80%</option><option value='0.75'>75%</option><option value='0.70'>70%</option><option value='0.65'>65%</option><option value='0.6'>60%</option><option value='0.55'>55%</option><option value='0.5'>50%</option>"),this.zoomSelectAction.addEvent("change",function(t){this.scaleTo(t.target.options[t.target.selectedIndex].value),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this)),this.zoomAddAction.addEvent("click",function(){var t=(this.scale/.05).toInt();.05*t<this.scale&&t++;var e=.05*t;(e+=.05)<.5&&(e=.5),e>2&&(e=2),this.scaleTo(e),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this)),this.zoomSubAction.addEvent("click",function(){var t=(this.scale/.05).toInt();.05*t<this.scale&&t++;var e=.05*t;(e-=.05)<.5&&(e=.5),e>2&&(e=2),this.scaleTo(e),o2.UD.putData("documenteditorScale",{scale:this.scale}),this.documenteditorScale=this.scale}.bind(this))},fullScreen:function(t){var e=t.node.get("text");this.form.app.content;e===MWF.xApplication.process.Xform.LP.returnScreen?(this.form.node.getParent().show(),this.node.inject(this.positionNode,"before"),this.positionNode.destroy(),this.node.setStyle("min-height",""),this.fireEvent("returnScreen"),t.setText(MWF.xApplication.process.Xform.LP.fullScreen),this.isFullScreen=!1,this.resizeToolbar()):(this.positionNode=new Element("div").inject(this.node,"after"),this.node.inject(this.scrollNode,"top"),this.form.node.getParent().hide(),this.node.setStyle("min-height","100%"),this.fireEvent("fullScreen"),t.setText(MWF.xApplication.process.Xform.LP.returnScreen),this.isFullScreen=!0,this.resizeToolbar()),this.reload()},scaleTo:function(t){this._returnScale(),this.scale=t,this.zoom();var e=(this.contentNode.offsetWidth*this.scale-1*(this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth))/2;if(this.isScale&&(e="10"),this.scale&&(e/=this.scale),e<10){var i=10-e;e=10,this.contentNode.scrollTo(i,0)}this.pages.each((function(t,i){t.setStyles({float:"left","margin-left":e+"px"})})),this.resetNodeSize()},_repage:function(t){"double"!==this.options.pageShow?this._singlePage():this._doublePage(),t?this.form.isLoaded?this._checkScale():this.form.addEvent("afterLoad",this._checkScale.bind(this)):this._checkScale()},_singlePage:function(){var t=this.singlePageZoom||1;this.singlePageZoom&&1!=this.singlePageZoom.toInt()&&(this.isScale=!0,this.scale=this.singlePageZoom,this.singlePageZoom=null),this.zoom(t),this._checkScale();var e=(this.contentNode.getSize().x-1*(this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth))/2;this.isScale&&(e="10"),this.scale&&(e/=this.scale),this.pages.each((function(t,i){t.setStyles({float:"left","margin-left":e+"px"})})),this.resetNodeSize(),this.resizeSidebar(),this.options.pageShow="single",this.doublePageAction.set("text",MWF.xApplication.process.Xform.LP.doublePage)},resetNodeSize:function(){var t=this.contentNode.offsetHeight,e=this.toolNode.getSize(),i=(t*=this.scale||1)+e.y+20;this.node.setStyles({height:i+"px"}),this.resizeSidebar()},createWaitSplitPage:function(){this.node.mask({style:{"background-color":"#cccccc",opacity:.3}}),this.waitSplitPageNode=new Element("div",{styles:this.form.css.waitSplitPageNode,text:MWF.xApplication.process.Xform.LP.computePage}).inject(this.node),this.waitSplitPageNode.position({relativeTo:this.node,position:"topRight",edge:"topRight",offset:{x:-10,y:45}})},clearWaitSplitPage:function(){this.node.unmask(),this.waitSplitPageNode&&this.waitSplitPageNode.destroy(),this.waitSplitPageNode=null},_doublePage:function(){this.editMode&&this._switchReadOrEditInline(),this.zoomSelectAction&&(this.singlePageZoom=this.zoomSelectAction.options[this.zoomSelectAction.selectedIndex].value.toFloat()),this.zoom(1),this.createWaitSplitPage(),window.setTimeout(function(){this._checkSplitPage(this.pages[0]),this.zoom(1);var t=this.contentNode.getSize().x;scale=(t-100)/2/this.options.docPageFullWidth,scale<1&&this.zoom(scale);var e=this.scale?this.scale*this.options.docPageFullWidth:this.options.docPageFullWidth,i=((t=this.contentNode.getSize().x)/e).toInt(),o=this.contentNode.getElements(".doc_layout_page"),s=(t-(i=Math.min(o.length,i))*e)/(i+1);this.scale&&(s/=this.scale),this.pages.each((function(t,e){t.setStyles({float:"left","margin-left":s+"px"})})),this.resetNodeSize(),this.options.pageShow="double",this.doublePageAction.set("text",MWF.xApplication.process.Xform.LP.singlePage),this.resizeSidebar(),this.clearWaitSplitPage()}.bind(this),1e3)},_getDefaultData:function(){return Object.clone(this.json.defaultValue)},_loadFiletextPage:function(t){this.data=this._getBusinessData(),this.data||(this.data=this._getDefaultData()),this._computeData(!0),this._createPage(function(e){this._loadPageLayout(e),this.setData(this.data),this.readonly,t&&t()}.bind(this))},_getEditorConfig:function(){var t={qtRows:20,qtColumns:20,qtBorder:"1",qtWidth:"95%",qtStyle:{"border-collapse":"collapse"},qtClass:"documenteditor_table"+this.form.json.id+this.json.id,qtCellPadding:"0",qtCellSpacing:"0",qtPreviewBorder:"4px double black",qtPreviewSize:"4px",qtPreviewBackground:"#c8def4",language:o2.language,format_tags:"标题一;标题二;正文(标题三,四)","format_标题一":{name:"标题一(三号黑体)",element:"div",styles:{"font-family":"黑体","font-size":"16pt"}},"format_标题二":{name:"标题二(三号楷体)",element:"div",styles:{"font-family":"楷体","font-size":"16pt"}},"format_正文(标题三,四)":{name:"正文(标题三,四)",element:"div",styles:{"font-family":"仿宋","font-size":"16pt"}},toolbarGroups:[{name:"document",groups:["mode","document","doctools"]},{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection","spellchecker","editing"]},{name:"forms",groups:["forms"]},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi","paragraph"]},{name:"links",groups:["links"]},{name:"insert",groups:["insert"]},{name:"styles",groups:["styles"]},{name:"colors",groups:["colors"]},{name:"tools",groups:["tools"]},{name:"others",groups:["others"]},{name:"about",groups:["about"]}],extraPlugins:"quicktable,tableresize",removeButtons:"Source,Save,NewPage,Preview,Print,Templates,Paste,PasteFromWord,Scayt,Form,Checkbox,Radio,TextField,Textarea,Select,Button,ImageButton,HiddenField,Bold,Italic,Underline,Strike,Subscript,Superscript,CopyFormatting,RemoveFormat,Outdent,Indent,Blockquote,CreateDiv,BidiLtr,BidiRtl,Language,Link,Unlink,Anchor,Flash,HorizontalRule,Smiley,SpecialChar,PageBreak,Iframe,TextColor,BGColor,Maximize,ShowBlocks,About,Styles,Font,FontSize",pasteFromWordRemoveFontStyles:!1,pasteFromWordRemoveStyles:!1,removePlugins:["magicline"]};return t.enterMode=CKEDITOR.ENTER_DIV,t.pasteFilter="plain-text",t},_checkSplitPage:function(t){this.layout_edition&&this.layout_edition.setStyles({position:"static"}),t.getFirst().getSize().y>this.options.docPageHeight&&this._splitPage(t);var e=t.get("data-pagecount").toInt();e&&this.pages.length-1>=e&&this._checkSplitPage(this.pages[e]),this.layout_edition&&this.layout_edition.setStyles({position:"absolute",bottom:"0px"})},_splitFiletextNodeOneWord:function(t,e){var i=t.textContent,o=i.length,s=i.substring(0,o-1),n=i.substring(o-1,o);t.textContent=s,e.textContent=n+e.textContent},_splitFiletext:function(t,e,i,o){var s=o.getFirst(),n=t.lastChild;if(n){for(;s.getSize().y>this.options.docPageHeight&&n;){var a=n.previousSibling,l=n.nodeType;if(e||(e=i),l==Node.ELEMENT_NODE)if("table"==n.tagName)n.inject(e);else if("BR"==n.tagName)n.parentNode&&n.parentNode.removeChild(n);else{var h=n.get("data-pagePart");h||(h=(new o2.widget.UUID).toString(),n.set("data-pagePart",h));var c=e.getFirst();e=c&&c.get("data-pagePart")==h?c:n.clone(!1).inject(e,"top"),this._splitFiletext(n,e,i,o),n.firstChild||n.parentNode&&n.parentNode.removeChild(n),e=e.getParent()}else if(l==Node.TEXT_NODE){for(var r=e.insertBefore(document.createTextNode(""),e.firstChild);s.getSize().y>this.options.docPageHeight&&n.textContent;)this._splitFiletextNodeOneWord(n,r);n.textContent||n.parentNode&&n.parentNode.removeChild(n)}else n.parentNode&&n.parentNode.removeChild(n);n=a}t.lastChild||t.parentNode&&t.parentNode.removeChild(t)}else t.parentNode&&t.parentNode.removeChild(t)},_splitPage:function(t){var e=t.getFirst(),i=t.getElements(".doc_block");if(i.length){var o=i[i.length-1],s=this.pages.indexOf(t);this.pages.length<=s+1&&this._createNewPage();var n=this.pages[s+1];if(o.hasClass("doc_layout_filetext")){var a=n.getElement(".doc_layout_filetext");a||(a=new Element("div.doc_layout_filetext").inject(n.getFirst(),"top")),a.hasClass("doc_block")||a.addClass("doc_block");var l=o,h=a;this._splitFiletext(l,h,a,t)}else o.inject(n.getFirst(),"top"),e.getSize().y>this.options.docPageHeight&&this._splitPage(t)}},transWidth:function(t){if(!t)return"";for(;t;)3==t.nodeType?t.nodeValue=t.nodeValue.replace(/\x20/g,"　"):8==t.nodeType||this.transWidth(t.firstChild),t=t.nextSibling},insertFullWidth:function(t,e){if(!t)return"";for(;t;){if(3==t.nodeType)return t.nodeValue=e+t.nodeValue,!0;if(8==t.nodeType);else if(this.insertFullWidth(t.firstChild,e))return!0;t=t.nextSibling}},loadCkeditorFiletext:function(t,e){this.layout_filetext&&o2.load("../o2_lib/htmleditor/ckeditor4130/ckeditor.js",function(){CKEDITOR.disableAutoInline=!0,this.layout_filetext.setAttribute("contenteditable",!0),this.filetextEditor=e?CKEDITOR.inline(this.layout_filetext,this._getEditorConfig()):CKEDITOR.replace(this.layout_filetext,this._getEditorConfig()),this.filetextEditor.on("instanceReady",function(e){t&&t(e)}.bind(this)),this.filetextEditor.on("focus",function(t){window.setTimeout(this.reLocationFiletextToolbar.bind(this),10)}.bind(this)),this.filetextEditor.on("loaded",function(t){this.filetextEditor.element.$.store("module",this),this.filetextEditor.element.$.store("scale",this.scale)}.bind(this)),this.filetextEditor.on("afterPaste",function(t){}.bind(this)),this.filetextEditor.on("afterPasteFromWord",function(t){}.bind(this)),this.filetextEditor.on("paste",function(t){var e=t.data.dataValue;if(/\<br\>|\<br \/\>|\<br\/\>/g.test(e)&&!/\<p\>/g.test(e)){var i=e.split(/\<br\>|\<br \/\>|\<br\/\>/g);e="",i.each((function(t){e=e+"<p>"+t+"</p>"}))}var o=new Element("div");o.set("html",e),o.getElements("p").each(function(t,e){if("n"!==this.json.fullWidth&&this.transWidth(t),!t.getParent("table")){var i=t.get("text").match(/^\u3000*/),o=i[0]?Math.max(2-i[0].length,0):2;for(e=0;e<o;e++)t.appendText("　","top")}}.bind(this));var s=o.getElements("table");if(s&&s.length){var n=this.layout_filetext.offsetWidth.toFloat();s.each((function(t){var e=t.getStyle("width"),i=e&&e.toFloat()||0,o=t.get("width"),s=o&&o.toFloat()||0,a=Math.max(i,s);(0===a||a>n)&&t.setStyle("width",n+"px")})),s.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"})}o.getElements("td").each((function(t){var e=t.getStyle("border-top-width").toFloat()||0,i=t.getStyle("border-bottom-width").toFloat()||0,o=t.getStyle("border-left-width").toFloat()||0,s=t.getStyle("border-right-width").toFloat()||0;t.setStyles({"border-top-width":e/2+"px","border-bottom-width":i/2+"px","border-left-width":o/2+"px","border-right-width":s/2+"px"})})),t.data.dataValue=o.get("html"),o.destroy(),this.fireEvent("paste")}.bind(this)),this.filetextEditor.on("afterPaste",function(t){this.resetNodeSize(),this.fireEvent("afterPaste")}.bind(this)),this.filetextEditor.on("change",function(t){this.filetextEditor.on("change",function(t){for(var e=document.documentElement.scrollTop,i=this.contentNode;i&&(i.getScrollSize().y<=i.getSize().y||"auto"!==i.getStyle("overflow")&&"auto"!==i.getStyle("4-y"));)i=i.getParent();if(i){var o=i.scrollTop.toFloat();i.scrollTop=e+o}document.documentElement.scrollTop=0}.bind(this))}.bind(this)),this.filetextEditor.on("insertElement",function(t){"table"==t.data.$.tagName.toString().toLowerCase()&&t.data.$.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"});var e=t.data.$.getElement("tr");if(e){var i=e.getElements("td");if(i&&i.length){var o=100/i.length;i.setStyle("width",o+"%")}}}.bind(this)),"n"!==this.json.textIndent&&this.layout_filetext.addEvent("keyup",function(t){13==t.code&&this.filetextEditor.insertText("　　")}.bind(this)),"n"!==this.json.fullWidth&&(this.filetextEditor.addCommand("insertHalfSpace",{exec:function(t){t.insertText(" ")}}),this.filetextEditor.setKeystroke(CKEDITOR.SHIFT+32,"insertHalfSpace"),this.filetextEditor.on("key",function(t){"n"!==this.json.fullWidth&&32==t.data.keyCode&&(t.editor.insertText("　"),t.cancel())}.bind(this)))}.bind(this))},_loadEvents:function(t){Object.each(this.json.events,function(t,e){t.code&&this.editor.on(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this),this)}.bind(this))},_bindFieldChange:function(t,e,i){var o=this.form.all[this.json[e]];if(o){var s=function(){this._computeItemFieldData(t,e),this[i]&&("layout_redHeader"==i||"layout_issuanceUnit"==i||"layout_meetingAttendContent"==i||"layout_meetingLeaveContent"==i||"layout_meetingSitContent"==i||"layout_meetingRecordContent"==i||"layout_subject"==i?this[i].set("html",this.data[t]||""):"layout_attachment"==i?this.setAttachmentData():this[i].set("text",this.data[t]||"")),this.reSetShow()}.bind(this);o.node.store(this.json.id+"bindFun",s),o.addModuleEvent("change",s)}},_computeItemFieldData:function(t,e,i){var o="",s=i?this.form.all[i]:this.form.all[this.json[e]];if(s&&s.getData&&(o=s.getData()),o||(o=i?this.form.businessData.data[i]:this.form.businessData.data[this.json[e]]),o)switch(o2.typeOf(o)){case"string":switch(t){case"issuanceDate":case"editionDate":var n=new Date(o);if(n.isValid()&&1970!=n.getFullYear()){var a=n.getFullYear(),l=n.getMonth(),h=n.getDate();l+=1;var c=MWF.xApplication.process.Xform.LP;this.data[t]=""+a+c.year+l+c.month+h+c.date}else this.data[t]=o;break;case"mainSend":this.data[t]=o+"：";break;default:"subject"===t&&(o=o2.txt(o)),this.data[t]=o}break;case"array":var r=[];switch(o.each((function(t){"object"==o2.typeOf(t)&&t.distinguishedName?r.push(t.name):r.push(t.toString())})),t){case"attachment":var d=r.map((function(t){return-1!=t.indexOf(".")?t.substring(0,t.lastIndexOf(".")):t}));this.data[t]=d;break;case"issuanceDate":case"editionDate":var u=r.map((function(t,e){var i=Date.parse(t);if(i.isValid()&&1970!=i.getFullYear()){var o=i.getFullYear(),s=i.getMonth(),n=i.getDate();s+=1;var a=MWF.xApplication.process.Xform.LP;return""+o+a.year+s+a.month+n+a.date}return t}));this.data[t]=u.join("，");break;case"mainSend":this.data[t]=r.join("，")+"：";break;default:this.data[t]=r.join("，")}break;default:this.data[t]=o.toString()}else this.data[t]=this.json.defaultValue[t]},computeData:function(){this._computeData(!1),this.setData(this.data)},_computeItemData:function(t,e,i,o,s,n){switch(this.json[e]){case"data":this.json[i]&&(s&&this._bindFieldChange(t,i,n),this._computeItemFieldData(t,i));break;case"script":if(this.json[o]&&this.json[o].code){var a=this.form.Macro.exec(this.json[o].code,this);if(this.data[t]=a,"attachment"==t&&(this.data[t]="array"==typeOf(a)?a:[a]),"issuanceDate"==t||"editionDate"==t){var l=Date.parse(a);if(l.isValid()&&1970!=l.getFullYear()){var h=l.getFullYear(),c=l.getMonth(),r=l.getDate();c+=1;var d=MWF.xApplication.process.Xform.LP;this.data[t]=""+h+d.year+c+d.month+r+d.date}else this.data[t]=a}}}},_computeCustomItemData:function(t,e,i){i&&this._bindCustomFieldChange(t,e,t),this._computeItemFieldData(t,null,e)},_bindCustomFieldChange:function(t,e,i){var o=this.form.all[e];if(o){var s=function(){this._computeItemFieldData(t,null,e),this[i]&&("layout_redHeader"==i||"layout_issuanceUnit"==i||"layout_subject"==i?this[i].set("html",this.data[t]||""):"layout_attachment"==i?this.setAttachmentData():this[i].set("text",this.data[t]||"")),this.reSetShow()}.bind(this);o.node.store(this.json.id+"bindFun",s),o.addModuleEvent("change",s)}},_computeData:function(t){this._computeItemData("copies","copiesValueType","copiesValueData","copiesValueScript",t,"layout_copies"),this._computeItemData("secret","secretValueType","secretValueData","secretValueScript",t,"layout_secret"),this._computeItemData("priority","priorityValueType","priorityValueData","priorityValueScript",t,"layout_priority"),this._computeItemData("redHeader","redHeaderValueType","redHeaderValueData","redHeaderValueScript",t,"layout_redHeader"),this._computeItemData("fileno","filenoValueType","filenoValueData","filenoValueScript",t,"layout_fileno"),this._computeItemData("signer","signerValueType","signerValueData","signerValueScript",t,"layout_signer"),this._computeItemData("subject","subjectValueType","subjectValueData","subjectValueScript",t,"layout_subject"),this._computeItemData("mainSend","mainSendValueType","mainSendValueData","mainSendValueScript",t,"layout_mainSend"),this._computeItemData("attachment","attachmentValueType","attachmentValueData","attachmentValueScript",t,"layout_attachment"),this._computeItemData("issuanceUnit","issuanceUnitValueType","issuanceUnitValueData","issuanceUnitValueScript",t,"layout_issuanceUnit"),this._computeItemData("issuanceDate","issuanceDateValueType","issuanceDateValueData","issuanceDateValueScript",t,"layout_issuanceDate"),this._computeItemData("annotation","annotationValueType","annotationValueData","annotationValueScript",t,"layout_annotation"),this._computeItemData("copyto","copytoValueType","copytoValueData","copytoValueScript",t,"layout_copytoContent"),this._computeItemData("copyto2","copyto2ValueType","copyto2ValueData","copyto2ValueScript",t,"layout_copyto2Content"),this._computeItemData("editionUnit","editionUnitValueType","editionUnitValueData","editionUnitValueScript",t,"layout_edition_issuance_unit"),this._computeItemData("editionDate","editionDateValueType","editionDateValueData","editionDateValueScript",t,"layout_edition_issuance_date"),this._computeItemData("meetingAttend","meetingAttendValueType","meetingAttendValueData","meetingAttendValueScript",t,"layout_meetingAttendContent"),this._computeItemData("meetingLeave","meetingLeaveValueType","meetingLeaveValueData","meetingLeaveValueScript",t,"layout_meetingLeaveContent"),this._computeItemData("meetingSit","meetingSitValueType","meetingSitValueData","meetingSitValueScript",t,"layout_meetingSitContent"),this._computeItemData("meetingRecord","meetingRecordValueType","meetingRecordValueData","meetingRecordValueScript",t,"layout_meetingRecordContent"),Object.each(this.json.customFields,function(e,i){this._computeCustomItemData(i,e,t)}.bind(this))},_loadValue:function(){this._getBusinessData()},reload:function(){this.resetData()},resetData:function(t){this.editMode&&this._switchReadOrEditInline(),this._computeData(!1),this.pages=[],this.contentNode.empty(),this.allowEdit&&this.toolbar.childrenButton[0].setText(layout.mobile?MWF.xApplication.process.Xform.LP.editdoc_mobile:MWF.xApplication.process.Xform.LP.editdoc),this.editMode=!1,this._createPage(function(e){this._loadPageLayout(e),this.setData(this.data,t),this._repage()}.bind(this))},isEmpty:function(){var t=this.getData();return"object"!==typeOf(t)||(!t.filetext||t.filetext===this.json.defaultValue.filetext)},getData:function(){if(this.layout_copies&&(this.data.copies=this.layout_copies.get("text")),this.layout_secret&&(this.data.secret=this.layout_secret.get("text")),this.layout_priority&&(this.data.priority=this.layout_priority.get("text")),this.layout_redHeader&&(this.data.redHeader=this.layout_redHeader.get("html")),this.layout_fileno&&(this.data.fileno=this.layout_fileno.get("text")),this.layout_signerTitle&&(this.data.signerTitle=this.layout_signerTitle.get("text")),this.layout_signer&&(this.data.signer=this.layout_signer.get("text")),this.layout_subject&&(this.data.subject=this.layout_subject.get("html")),this.layout_mainSend&&(this.data.mainSend=this.layout_mainSend.get("text")),this.editMode&&this.layout_filetext){var t=this.layout_filetext.get("text");(t=t.replace(/\u3000*/g,""))&&t!==this.json.defaultValue.filetext?this.data.filetext=this.layout_filetext.get("html"):this.data.filetext=""}return this.layout_signer&&(this.data.signer=this.layout_signer.get("text")),this.layout_attachmentTitle&&(this.data.attachmentTitle=this.layout_attachmentTitle.get("text")),this.layout_attachment&&this._computeItemData("attachment","attachmentValueType","attachmentValueData","attachmentValueScript",!1,"layout_attachment"),this.layout_issuanceUnit&&(this.data.issuanceUnit=this.layout_issuanceUnit.get("html")),this.layout_issuanceDate&&(this.data.issuanceDate=this.layout_issuanceDate.get("text")),this.layout_annotation&&(this.data.annotation=this.layout_annotation.get("text")),this.layout_copytoTitle&&(this.data.copytoTitle=this.layout_copytoTitle.get("text")),this.layout_copytoContent&&(this.data.copyto=this.layout_copytoContent.get("text")),this.layout_copyto2Title&&(this.data.copyto2Title=this.layout_copyto2Title.get("text")),this.layout_copyto2Content&&(this.data.copyto2=this.layout_copyto2Content.get("text")),this.layout_edition_issuance_unit&&(this.data.editionUnit=this.layout_edition_issuance_unit.get("text")),this.layout_edition_issuance_date&&(this.data.editionDate=this.layout_edition_issuance_date.get("text")),this.layout_meetingAttendTitle&&(this.data.meetingAttendTitle=this.layout_meetingAttendTitle.get("text")),this.layout_meetingLeaveTitle&&(this.data.meetingLeaveTitle=this.layout_meetingLeaveTitle.get("text")),this.layout_meetingSitTitle&&(this.data.meetingSitTitle=this.layout_meetingSitTitle.get("text")),this.layout_meetingAttendContent&&(this.data.meetingAttend=this.layout_meetingAttendContent.get("html")),this.layout_meetingLeaveContent&&(this.data.meetingLeave=this.layout_meetingLeaveContent.get("html")),this.layout_meetingSitContent&&(this.data.meetingSit=this.layout_meetingSitContent.get("html")),this.layout_meetingRecordContent&&(this.data.meetingRecord=this.layout_meetingRecordContent.get("html")),this.customLayouts&&this.customLayouts.each(function(t){this.data[t.name]=t.node.get("html")}.bind(this)),this.data},setAttachmentData:function(){if(this.attachmentTemplete||(this.attachmentTemplete=this.layout_attachment.get("html")),this.layout_attachment.empty(),this.data.attachment&&this.data.attachment.length&&this.data.attachment.each){var t=new Element("div");this.data.attachment.each(function(e,i){t.set("html",this.attachmentTemplete);var o=t.getElement(".doc_layout_attachment_content_serial"),s=t.getElement(".doc_layout_attachment_content_name");o&&o.set("text",i+1),s&&s.set("text",e);var n=t.get("html");t.empty(),this.layout_attachment.appendHTML(n)}.bind(this)),t.destroy()}},setData:function(t,e){if(t){if(this.data=t,this._setBusinessData(t),this.layout_copies&&(t.copies?this.layout_copies.set("text",t.copies||" "):this.layout_copies.set("html","<span>&nbsp</span>")),this.layout_secret&&(t.secret?this.layout_secret.set("text",t.secret||" "):this.layout_secret.set("html","<span>&nbsp</span>")),this.layout_priority&&(t.priority?this.layout_priority.set("text",t.priority||" "):this.layout_priority.set("html","<span>&nbsp</span>")),this.layout_redHeader&&this.layout_redHeader.set("html",t.redHeader||""),this.layout_fileno&&this.layout_fileno.set("text",t.fileno||" "),this.layout_signerTitle&&this.layout_signerTitle.set("text",t.signerTitle||" "),this.layout_signer&&this.layout_signer.set("text",t.signer||" "),this.layout_subject&&this.layout_subject.set("html",t.subject||" "),this.layout_mainSend&&this.layout_mainSend.set("text",t.mainSend||" "),e)this.layout_filetext.set("html",e);else if(this.layout_filetext){this.layout_filetext.set("html",t.filetext||"　　");var i=this.layout_filetext.getElements("table");i&&i.length&&i.setStyles({"margin-left":"","margin-right":"","word-break":"break-all"})}if(this.layout_signer&&this.layout_signer.set("text",t.signer||""),this.layout_attachmentTitle&&this.layout_attachmentTitle.set("text",t.attachmentTitle||" "),this.layout_attachment&&this.setAttachmentData(),this.layout_issuanceUnit&&this.layout_issuanceUnit.set("html",t.issuanceUnit||" "),this.layout_issuanceDate&&this.layout_issuanceDate.set("text",t.issuanceDate||" "),this.layout_annotation&&this.layout_annotation.set("text",t.annotation||" "),this.layout_copytoTitle&&this.layout_copytoTitle.set("text",t.copytoTitle||" "),this.layout_copytoContent&&this.layout_copytoContent.set("text",t.copyto||" "),this.layout_copyto2Title&&this.layout_copyto2Title.set("text",t.copyto2Title||" "),this.layout_copyto2Content&&this.layout_copyto2Content.set("text",t.copyto2||" "),this.layout_edition_issuance_unit&&this.layout_edition_issuance_unit.set("text",t.editionUnit||" "),this.layout_edition_issuance_date&&this.layout_edition_issuance_date.set("text",t.editionDate||" "),this.layout_meetingAttendTitle&&this.layout_meetingAttendTitle.set("text",t.meetingAttendTitle||this.json.defaultValue.meetingAttendTitle||" "),this.layout_meetingLeaveTitle&&this.layout_meetingLeaveTitle.set("text",t.meetingLeaveTitle||this.json.defaultValue.meetingLeaveTitle||" "),this.layout_meetingSitTitle&&this.layout_meetingSitTitle.set("text",t.meetingSitTitle||this.json.defaultValue.meetingSitTitle||" "),this.layout_meetingAttendContent&&this.layout_meetingAttendContent.set("html",t.meetingAttend||" "),this.layout_meetingLeaveContent&&this.layout_meetingLeaveContent.set("html",t.meetingLeave||" "),this.layout_meetingSitContent&&this.layout_meetingSitContent.set("html",t.meetingSit||" "),this.layout_meetingRecordContent&&this.layout_meetingRecordContent.set("html",t.meetingRecord||" "),this.customLayouts&&this.customLayouts.each(function(t){t.node.set("html",this.data[t.name]||"　")}.bind(this)),this.layout_issuanceUnit&&this.layout_issuanceDate){var o=this.layout_issuanceUnit.getParent("table");if(o&&!o.hasClass("doc_layout_headIssuance")){var s=o2.getTextSize(this.layout_issuanceUnit.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x,n=o2.getTextSize(this.layout_issuanceDate.get("text"),{"font-size":"16pt","font-family":"'Times New Roman',仿宋","letter-spacing":"-0.4pt"}).x;if(s<n){if(a=this.layout_issuanceDate.getParent("td").getNext("td")){a.setStyle("width","64pt"),(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","64pt")}this.layout_issuanceUnit.getParent("td").setStyle("width",n),(l=this.layout_issuanceUnit.getParent("p"))&&l.setStyle("text-align","center")}else{var a,l;(a=this.layout_issuanceUnit.getParent("td").getNext("td"))&&a.setStyle("width","32pt"),this.layout_issuanceUnit.getParent("td").setStyle("width","auto"),(a=this.layout_issuanceDate.getParent("td").getNext("td"))&&a.setStyle("width","64pt"),(l=this.layout_issuanceDate.getParent("p"))&&l.setStyle("text-align","right")}}}var h=this.layout_copytoTitle||this.layout_copyto2Title;if(h){var c=h.getParent("table");if(c&&"y"==c.get("data-compute-style"))for(var r=c.rows,d=0;d<r.length;d++){var u=r[d].cells[0],_=u.getElement(".doc_layout_edition_issuance_unit");if(_||(_=u.getElement(".doc_layout_edition_issuance_date")),!_){var p=u.get("text").trim(),y=14*p.length,m=19*p.length;u.setStyles({"max-width":y+"pt !important","min-width":y+"pt !important",width:m+"pt"})}}}}},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),o=i.getPrevious("div"),s=i.getChildren().indexOf(e.getParent("div"));o.getLast().getFirst().getChildren()[s].click(),e=o.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData(),o="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!o)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(e.prompt),!1;break;case"gt":if(o>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(o<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(o==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(o!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=o.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==o.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var o=this.json.validationConfig[i];if(!this.validationConfigItem(t,o))return!1}return!0}return!0},validation:function(t,e){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)},removeDisplayNone:function(t){for(var e=t.getFirst();e;)if("none"==e.getStyle("display")){var i=e.getNext();e.destroy(),e=i}else e=(e=this.removeDisplayNone(e)).getNext();return t},getDocumentHtml:function(){(a=this.contentNode.getFirst().getFirst().getElement(".doc_layout_filetext").getElements("table")).each((function(t){var e=t.offsetWidth;t.set("data-o2-width",e),t.getElements("td").each((function(t){var e=t.offsetWidth;t.set("data-o2-width",e)}))}));var t=this.contentNode.getFirst().getFirst().clone(!0),e=t.getLast();e=this.removeDisplayNone(e);var i=t.querySelectorAll("[data-w-style]");if(i.length)for(var o=0;o<i.length;o++){var n=i.item(o);wStyle=n.dataset.wStyle,wStyle.split(/\s*\;\s*/g).each((function(t){if(t)try{s=t.split(/\s*\:\s*/g),n.setStyle(s[0],s[1])}catch(t){}}))}t.getElement(".doc_layout_filetext").getElements("td").setStyle("width","");var a=t.querySelectorAll("table[data-o2-width]");for(o=0;o<a.length;o++)a[o].setStyle("width",a[o].dataset.o2Width+"px");var l=t.querySelectorAll("td[data-o2-width]");for(o=0;o<l.length;o++)l[o].setStyle("width",l[o].dataset.o2Width+"px");var h=t.get("html");return t.destroy(),'<html xmlns:v="urn:schemas-microsoft-com:vml"><head><meta charset="UTF-8" /></head><body>'+h+"</body></html>"},toWord:function(t,e,i,o){var s=e||"";if(!s)try{s=this.json.toWordFilename||this.form.businessData.data.subject||this.form.businessData.data.$work.title}catch(t){}var n=!1;this.editMode&&(n=!0,this._readFiletext()),this.zoom(1),this.pages=[],this.contentNode.empty(),this._createPage(function(t){this._loadPageLayout(t),this.setData(this.data),this._checkScale(),this.node.setStyles({height:"auto"})}.bind(this),function(){var e=s||this.json.toWordFilename||"$doc",a=e.lastIndexOf(".");if("service"===this.json.wordConversionType){-1==a&&(e+=".doc");var l=encodeURIComponent(this.getDocumentHtml()),h={fileName:e,site:this.json.toWordSite||"$doc",content:l};o2.Actions.get("x_processplatform_assemble_surface").docToWord(this.form.businessData.work.id,h,function(e){this.form.businessData.workCompleted?o2.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompleted(e.data.id,this.form.businessData.workCompleted.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)):o2.Actions.get("x_processplatform_assemble_surface").getAttachment(e.data.id,this.form.businessData.work.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this))}.bind(this)),i&&i()}else{-1==a&&(e+=".docx");l=this.getDocumentHtml();o2.xDesktop.requireApp("process.Xform","widget.OOXML",function(){(new o2.OOXML.WML).load(l).then(function(s){if(o)t&&t(s,e),i&&i();else{s.name=e;var n=new FormData;n.append("site",this.json.toWordSite||"$doc"),n.append("fileName",e),n.append("file",s),o2.Actions.get("x_processplatform_assemble_surface").V2UploadWorkOrWorkCompleted(this.form.businessData.work.id,n,s,function(e){this.form.businessData.workCompleted?o2.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompleted(e.data.id,this.form.businessData.workCompleted.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)):o2.Actions.get("x_processplatform_assemble_surface").getAttachment(e.data.id,this.form.businessData.work.id,function(e){t&&t(e.data),this.showToWord(e.data)}.bind(this)),i&&i()}.bind(this))}}.bind(this))}.bind(this))}n?this._createEditor("inline"):this._readFiletext()}.bind(this))},docToWord:function(t){try{var e=!0;this.json.toWordConditionScript&&this.json.toWordConditionScript.code&&(e=!!this.form.Macro.exec(this.json.toWordConditionScript.code,this)),e?this.toWord(null,"",t):t&&t()}catch(e){console.error(e),t&&t()}},showToWord:function(t){var e=this.json.toWordSite||"$doc",i=this.form.all[e];if(i){var o=[];i.attachmentController.attachments.each(function(e){e.data.name!==t.name&&o.push(e.data)}.bind(this)),i.attachmentController.clear(),o.each(function(e){e.site===i.json.id&&e.name!==t.name&&i.attachmentController.addAttachment(e)}.bind(this)),i.attachmentController.addAttachment(t)}}});