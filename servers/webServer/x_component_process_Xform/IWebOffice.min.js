MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.IWebOffice=MWF.APPIWebOffice=new Class({Extends:MWF.APP$Module,options:{copyright:"金格科技iWebOffice2015智能文档中间件[演示版];V5.0S0xGAAEAAAAAAAAAEAAAAJ0BAACgAQAALAAAAFgHOIQT3Ejo2JZMmSVxBkTixI2YkNh+cy/HGFlQ3HNIRG8j2V9vAnBWM8B384zkV79hltghTpDkba9QJTjGCDkylzhl3rian7v/AFF5DXQ7HdoXpN2imHbGHf8ieQNf672v38ODXJum7VaWv4P3DXzlzdnmzoaTTukFl+3ntFH29dQSjC94c4v0npn9rnXK5OsjJGR5mVGJJd6GWjE9rP3fo+kWCBYzb+bhn2sL+SKoyFjUuSptNHsOn3nRKrXyqkRd+QaHR/MDuKd1kEbUpRqCz9CjgfZFX00Zaz2l6ChA6LmdMMjjECalHZQA9WuxAc7cynGbvNfEgi277ahRpSZHmjKY5s18dJM/t9gdatg5b/dCqnUEn0+HS511XaM3xvy4DCVnD1n8xC9I5w+16NGrtTMiMSZFpc3QJphdShC0j+1l/ZyVj33YM31JmuxkI5SDL2CAfMUNsioseUfpOKvpxdcA7nmwlKrpxNetm9Bq0kwJn/jUU2bQa2c+bPRX82JcmFUwAz0ctOQ+Tyi+MoRpATEYW35KZtWepeDTGHJRfaJR81x8dVU0Lp1TuxtQiw==",version:"12,7,0,828",clsid:"D89F482C-5045-4DB5-8C53-D2C9EE71D025",codeBase:"../o2_lib/iWebOffice/iWebOffice2015.cab",version64:"12,5,0,652",clsid64:"D89F482C-5045-4DB5-8C53-D2C9EE71D024",codeBase64:"../o2_lib/iWebOffice/iWebOffice2015.cab",moduleEvents:[,"afterOpen","afterCreate","beforeSave","afterSave"]},initialize:function(e,i,t,o){this.node=$(e),this.node.store("module",this),this.json=i,this.form=t,this.field=!0,this.openedAttachment=null},_loadUserInterface:function(){this.node.empty(),this.node.setStyles({"min-height":"100px"}),"ie"===Browser.name&&(this.file=null,this.form.officeList||(this.form.officeList=[]),this.form.officeList.push(this))},_afterLoaded:function(){if("ie"===Browser.name){if(!layout.serviceAddressList.x_jg_assemble_control)return this.node.set("html","<h3><font color=red>please install weboffice !!!</font></h3>"),!1;var e=layout.serviceAddressList.x_jg_assemble_control.host,i=layout.serviceAddressList.x_jg_assemble_control.port;this.webUrl=layout.protocol+"//"+e+":"+i+"/x_jg_assemble_control/IndexServlet",this.action=o2.Actions.load("x_jg_assemble_control"),this.json.isNotLoadNow||(this.data=this.getData(),""===this.data.documentId?this.createDocument(function(){this.loadOffice()}.bind(this)):(this.documentId=this.data.documentId,this.loadOffice())),this.json.isNotLoadNow||this.loadOffice()}else this.node.set("html","<h3><font color=red>只支持ie浏览器!</font></h3>")},createDocument:function(e){this.action.ManageJGAction.create({fileType:this.getFileType()},function(i){this.fireEvent("afterCreate"),this.documentId=i.data.message,this.setData(),e&&e()}.bind(this),null,!1)},createNew:function(){this.officeOCX.CreateFile()},getData:function(){var e={documentId:""};return this.form.businessData.data[this.json.id]&&(e.documentId=this.form.businessData.data[this.json.id].documentId),e},setData:function(){var e={documentId:this.documentId};this._setBusinessData(e)},loadOffice:function(){this.officeLoaded||(MWF.getJSON("../o2_lib/iWebOffice/config.json",function(e){this.officeConfig=e}.bind(this),!1),this.loadOfficeContorl(),this.officeLoaded=!0)},defaultParam:function(e){return{copyright:this.json.copyright||this.options.copyright}},loadOfficeContorl:function(e){if(this.node.getSize().y<800&&this.node.setStyle("height","800px"),layout.desktop.offices||(layout.desktop.offices={}),layout.desktop.offices[this.getOfficeObjectId()]=this,this.json.isReadonly)this.readonly=!0;else if(this.json.readScript&&this.json.readScript.code){this.form.Macro.exec(this.json.readScript.code,this)&&(this.readonly=!0)}this.loadOfficeEditor()},loadOfficeSpacer:function(){var e=this.node.getSize();this.officeNode=new Element("div#officeNode",{styles:this.form.css.officeAreaNode}).inject(this.node);var i=e.y-40;this.officeNode.setStyle("height",i+"px"),this.form.app.addEvent("uncurrent",function(){var e=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",e),this.officeNode.setStyle("display","none")}.bind(this)),this.form.app.addEvent("current",function(){var e=this.officeNode.retrieve("officeDisplay");e&&this.officeNode.setStyle("display",e),this.officeOCX&&this.officeOCX.Activate(!0)}.bind(this)),this.form.app.addEvent("queryClose",function(){this.fireEvent("queryClose");var e=this.getOfficeObjectId();layout.desktop.offices[e]=null,delete layout.desktop.offices[e]}.bind(this))},hide:function(){if("none"!=this.officeNode.getStyle("display")){var e=this.officeNode.getStyle("display");this.officeNode.store("officeDisplay",e),this.officeNode.setStyle("display","none")}},show:function(){if(layout.desktop.currentApp&&layout.desktop.currentApp.appId===this.form.app.appId||this.form.app.inBrowser){var e=this.officeNode.retrieve("officeDisplay");e&&this.officeNode.setStyle("display",e),this.officeOCX&&this.officeOCX.Activate(!0)}},getFormId:function(){var e=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"form"+this.json.id+e},getFileType:function(){var e="docx";switch(this.json.officeType){case"word":e="docx";break;case"excel":e="xlsx";break;case"ppt":e="pptx"}return e},getOfficeObjectId:function(){var e=this.form.businessData.workCompleted?this.form.businessData.workCompleted.id:this.form.businessData.work.id;return"WebOffice"+this.json.id+e},loadOfficeEditor:function(){if(!this.officeOCX){this.loadOfficeSpacer(),this.node.setStyle("pisition","absolute");var e=this.officeConfig.codeBase||this.json.codeBase||this.options.codeBase,i=this.officeConfig.version||this.json.version||this.options.version,t=this.officeConfig.classid||this.json.clsid||this.options.clsid,o=this.officeConfig.codeBase64||this.json.codeBase64||this.options.codeBase64,s=this.officeConfig.classid64||this.json.clsid64||this.options.clsid64,n="";n="Win64"==window.navigator.platform?"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+o+"#version="+i+'" classid="clsid:'+s+'">':"<form id='"+this.getFormId()+"' style='height:100%'><OBJECT id=\""+this.getOfficeObjectId()+'" style="HEIGHT: 99%; WIDTH: 100%" codeBase="'+e+"#version="+i+'" classid="clsid:'+t+'">';var f=this.defaultParam();f=Object.merge(f,this.json.ntkoEditProperties),f=Object.merge(f,this.json.editProperties),Object.each(f,(function(e,i){n+='<PARAM NAME="'+i+'" value="'+e+'">'})),n+="</OBJECT></form>",this.officeNode.appendHTML(n),this.officeForm=this.officeNode.getFirst()}setTimeout(function(){this.loadIwebOfficeEditor()}.bind(this),3e3)},loadIwebOfficeEditor:function(){this.officeOCX=document.getElementById(this.getOfficeObjectId()).FuncExtModule,this.officeOCX.WebUrl=this.webUrl,this.officeOCX.FileName="文件正文.docx",this.officeOCX.UserName=layout.desktop.session.user.name,this.officeOCX.RecordID=this.documentId,this.officeOCX.FileType="."+this.getFileType(),this.readonly&&(this.officeOCX.EditType="0,0"),this.officeOCX.ShowMenu=this.json.iWebOfficeEditProperties.Menubar,this.officeOCX.ShowToolBar=this.json.iWebOfficeEditProperties.ToolBars,this.officeOCX.ShowWindow=!1,this.officeOCX.MaxFileSize=32768,this.officeOCX.Print="1",this.officeOCX.WebOpen(),this.fireEvent("afterOpen"),this.loadMenu(),this.readonly?"1"===this.json.iWebOfficeReadProperties.IsNoCopy?this.unableCopy():this.enableCopy():("1"===this.json.iWebOfficeEditProperties.IsNoCopy?this.unableCopy():this.enableCopy(),"1"===this.json.trackRevisions?this.showRevision():this.hideRevision())},setBookMark:function(e,i){this.officeOCX.WebSetBookMarks(e,i)},getBookMark:function(e){return this.officeOCX.WebGetBookMarks(e)},openLocal:function(){try{this.officeOCX.WebOpenLocal()}catch(e){this.officeOCX.Alert(e.description)}},saveLocal:function(){try{this.officeOCX.WebSaveLocal(),this.officeOCX.Alert("success")}catch(e){this.officeOCX.Alert(e.description)}},savePdf:function(){try{this.officeOCX.WebSavePDF()?this.officeOCX.Alert("success"):this.officeOCX.Alert("error")}catch(e){alert(e.description)}},print:function(){try{this.officeOCX.WebOpenPrint()}catch(e){alert(e.description)}},protect:function(){try{this.officeOCX.WebSetProtect(!0,"")}catch(e){this.officeOCX.Alert(e.description)}},unProtect:function(){try{this.officeOCX.WebSetProtect(!1,"")}catch(e){this.officeOCX.Alert(e.description)}},enableCopy:function(){try{this.officeOCX.CopyType=!0}catch(e){this.officeOCX.Alert(e.description)}},unableCopy:function(){try{this.officeOCX.CopyType=!1}catch(e){this.officeOCX.Alert(e.description)}},showRevision:function(){this.officeOCX.WebShow(!0)},hideRevision:function(){this.officeOCX.WebShow(!1)},acceptAllRevisions:function(){return this.officeOCX.WebObject.Application.ActiveDocument.AcceptAllRevisions(),!(this.officeOCX.WebObject.Application.ActiveDocument.Revisions.Count>0)},isEmpty:function(){},save:function(){if(!this.readonly){this.fireEvent("beforeSave");this.officeOCX.WebSave();this.fireEvent("afterSave")}},loadMenu:function(){this.isMenuLoad||(this.json.menuEditButtons&&this.json.menuEditButtons.length&&(this.menuNode=new Element("div",{styles:this.form.css.officeMenuNode}).inject(this.node,"top"),MWF.require("MWF.widget.Toolbar",function(){if(this.toolbarWidget=new MWF.widget.Toolbar(this.menuNode,{style:"xform_blue_simple"},this),-1!==this.json.menuEditButtons.indexOf("new")&&(this.newItem=this.createMenuAction("menu_new","","99.png")),-1!==this.json.menuEditButtons.indexOf("open")&&(this.openItem=this.createMenuAction("menu_openfile","","77.png")),-1!==this.json.menuEditButtons.indexOf("save")&&(this.saveItem=this.createMenuAction("menu_savefile","","67.png")),-1!==this.json.menuEditButtons.indexOf("revisions")){var e=MWF.xApplication.process.Xform.LP.menu_revisions_show;try{0!==this.officeOCX.ActiveDocument.ActiveWindow.View.RevisionsFilter.Markup&&(e=MWF.xApplication.process.Xform.LP.menu_revisions_hide)}catch(e){}this.revisionsItem=this.createMenuAction("revisions",e,"76.png")}if(-1!==this.json.menuEditButtons.indexOf("toolbar")&&!this.readonly){e=MWF.xApplication.process.Xform.LP.menu_toolbar_show;this.officeOCX.ToolBars&&(e=MWF.xApplication.process.Xform.LP.menu_toolbar_hide),this.toolbarItem=this.createMenuAction("toolbar",e,"91.png")}-1!==this.json.menuEditButtons.indexOf("preview")&&(this.fullscreenItem=this.createMenuAction("menu_preview","","21.png")),this.toolbarWidget.load()}.bind(this))),this.isMenuLoad=!0)},createMenuAction:function(e,i,t){i=i||MWF.xApplication.process.Xform.LP[e];return new Element("div",{MWFnodeid:e,MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.form.path+""+this.form.options.style+"/actionbar/"+t,title:i,MWFButtonAction:"menuAction",MWFButtonText:i}).inject(this.menuNode)},menuAction:function(e){switch(e.buttonID){case"menu_new":this.createNew();break;case"menu_openfile":this.openLocal();break;case"menu_savefile":this.saveLocal();break;case"revisions":this.toggleRevisions(e);break;case"toolbar":break;case"menu_preview":this.print()}},toggleRevisions:function(e){this.revisionsItem.get("text")===MWF.xApplication.process.Xform.LP.menu_revisions_show?(e.setText(MWF.xApplication.process.Xform.LP.menu_revisions_hide),this.showRevision()):(e.setText(MWF.xApplication.process.Xform.LP.menu_revisions_show),this.hideRevision())},validationMode:function(){},validation:function(){return!0}});