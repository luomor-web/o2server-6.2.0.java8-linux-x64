MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridPC=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine","export","import","validImport"]},initialize:function(t,e,i,o){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.editable=!this.readonly&&!0!==this.json.isReadonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.importenable=this.editable&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable="impexp"===this.json.impexpType||"exp"===this.json.impexpType,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._addTitleActionColumn(),this._loadEditDatagrid(function(){this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._getDatagridEditorTr(),this._loadReadDatagrid(function(){this.editorTr&&this.editorTr.setStyle("display","none"),this._loadImportExportAction(),this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},_loadStyles:function(){this.table.setStyles(this.json.tableStyles),this.node.setStyles(this.json.styles)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||{}},getValue:function(){return this._getValue()},_getDatagridTr:function(){this._getDatagridTitleTr(),this._getDatagridEditorTr()},_getDatagridTitleTr:function(){return this.titleTr=this.table.getElement("tr"),this.titleTr},_getDatagridEditorTr:function(){var t=this.table.getElements("tr");return this.editorTr=t[t.length-1],this.editorTr.addClass("datagridEditorTr"),this.editorTr},_addTitleActionColumn:function(){this.titleTr||this._getDatagridTitleTr(),this.editorTr||this._getDatagridEditorTr();var t=new Element("th",{styles:{width:"46px"}}).inject(this.titleTr,"top");new Element("th").inject(this.titleTr,"bottom"),this.addable&&this._createAddLineAction(t);var e=new Element("td").inject(this.editorTr,"top");this._createCompleteAction(e),this.deleteable&&this._createCancelAction(e),new Element("td").inject(this.editorTr,"bottom")},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.titleTr.getElements("th"),i=this.editorTr.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,o){var n=$(this.table.insertRow(o+1));n.store("data",t),e.each(function(s,a){var r=t[s.get("id")],l="";if("array"!==typeOf(r))for(key in r){var d=r[key];l=this._getValueText(a-1,d);break}this._createNewEditTd(n,a,i[a].get("id"),l,e.length-1,o)}.bind(this))}.bind(this)),this.editorTr.setStyle("display","none"),t&&t()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var o=0;o<i.json.itemValues.length;o++){var n=i.json.itemValues[o].split(/\|/),s=n[0];if(e===(n.length>1?n[1]:n[0]))return s}break;case"Radio":var a=i.node.getElements("input");for(o=0;o<a.length;o++)if(a[o].value==e)return a[o].get("showText");break;case"Checkbox":a=i.node.getElements("input");var r=[];for(o=0;o<a.length;o++)-1!=e.indexOf(a[o].value)&&r.push(a[o].get("showText"));if(r.length)return r.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var l=[];return e.each(function(t){"object"===typeOf(t)?l.push(t.name+(t.unitName?"("+t.unitName+")":"")):l.push(t)}.bind(this)),l.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var d=new RegExp("\n","g"),h=new RegExp("<","g"),c=new RegExp(">","g");e=e.replace(h,"&lt").replace(c,"&gt").replace(d,"<br/>")}return e},_createNewEditTd:function(t,e,i,o,n,s){var a=$(t.insertCell(e));if(0==e)a.setStyles(this.form.css.gridLineActionCell),this.addable&&this._createAddLineAction(a),this.deleteable&&this._createDelLineAction(a);else if(e==n)a.setStyles(this.form.css.gridMoveActionCell),this._createMoveLineAction(a);else{a.set("MWFId",i),(l=this.editModules[e-1])&&"ImageClipper"==l.json.type?this._createImage(a,l,o):l&&"Image"==l.json.type?this._createImg(a,l,s):l&&"Button"==l.json.type?this._createButton(a,l,s):l&&"Label"==l.json.type?this._createLabel(a,l,s):!l||"Attachment"!=l.json.type&&"AttachmentDg"!=l.json.type?l&&"Textarea"==l.json.type?a.set("html",o):a.set("text",o):this._createAttachment(a,l,o),l&&["Button"].contains(l.json.type)||a.addEvent("click",function(t){this._editLine(t.target)}.bind(this))}var r=this.form._getDomjson(a);if(r){a.store("dataGrid",this);var l=this.form._loadModule(r,a);a.store("module",l),this.form.modules.push(l),!1===r.isShow&&a.hide()}},_createAddLineAction:function(t){new Element("div",{styles:this.form.css.addLineAction,events:{click:function(t){this._addLine(t.target)}.bind(this)}}).inject(t)},_createDelLineAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._deleteLine(t)}.bind(this)}}).inject(t)},_createCompleteAction:function(t){new Element("div",{styles:this.form.css.completeLineAction,events:{click:function(t){this._completeLineEdit(t)}.bind(this)}}).inject(t)},_createCancelAction:function(t){new Element("div",{styles:this.form.css.delLineAction,events:{click:function(t){this._cancelLineEdit(t)}.bind(this)}}).inject(t)},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;if(this.currentEditLine=t.getParent("tr"),this.currentEditLine){this.editorTr.setStyles({display:"table-row"}),this.editorTr.inject(this.currentEditLine,"before"),this.currentEditLine.setStyle("display","none");var e=this.currentEditLine.retrieve("data");this.titleTr.getElements("th").each(function(t,i){var o=t.get("id"),n=this.editModules[i-1];n&&("sequence"==n.json.type?n.node.set("text",n.node.getParent("tr").rowIndex):n.setData&&(e[o]?n.setData(e[o][n.json.id]):n.setData(null)))}.bind(this));var i=this.currentEditLine.getElements("td").indexOf(t),o=this.editModules[i-1];o&&o.focus(),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_cancelLineEdit:function(t){var e=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){e.currentEditLine&&e.currentEditLine.setStyle("display","table-row"),e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.isEdit=!1,e.currentEditLine=null,e._editorTrGoBack(),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e=!0,i=!1,o={},n=null;this.currentEditLine?(n=this.currentEditLine,o=this.currentEditLine.retrieve("data")):(n=new Element("tr").inject(this.editorTr,"before"),o={});var s=this.titleTr.getElements("th"),a=this.editorTr.getElements("td"),r=n.getElements("td");(s.each(function(t,l){var d=r[l],h=t.get("id"),c=this.editModules[l-1];if(c){if("sequence"==c.json.type){e=!1;var u=n.rowIndex,p={value:[u],text:[u]}}else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type){i=!0,e=!1;p=c.getTextData();o[h]||(o[h]={}),o[h][c.json.id]=p}else if(c.getTextData){(p=c.getTextData()).value[0]&&(e=!1),p.value.length<2?(o[h]||(o[h]={}),o[h][c.json.id]=p.value[0]):(o[h]||(o[h]={}),o[h][c.json.id]=p.value)}if(p)if(d)if("ImageClipper"==c.json.type)this._createImage(d,c,p.text[0]);else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type)this._createAttachment(d,c,p);else{var f=this._getValueText(l-1,p.text.join(", "));"Textarea"==c.json.type?d.set("html",f):d.set("text",p.text.join(", "))}else if("Attachment"==c.json.type||"AttachmentDg"==c.json.type)this._createNewEditTd(n,l,a[l].get("id"),p,s.length-1);else{f=this._getValueText(l-1,p.text.join(", "));this._createNewEditTd(n,l,a[l].get("id"),f,s.length-1)}else d||this._createNewEditTd(n,l,h,"",s.length-1)}else d||this._createNewEditTd(n,l,h,"",s.length-1);c=null}.bind(this)),n.store("data",o),n.setStyle("display","table-row"),e&&n.destroy(),this.currentEditLine=null,this._editorTrGoBack(),this.json.contentStyles)&&n.getElements("td").setStyles(this.json.contentStyles);return this.json.actionStyles&&n.getFirst().setStyles(this.json.actionStyles),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence(),this.getData(),this.validationMode(),this.fireEvent("completeLineEdit",[n]),i&&this.form.saveFormData(),!0},_createImg:function(t,e,i){this._cloneModule(t,e,i)},_createLabel:function(t,e,i){this._cloneModule(t,e,i)},_createButton:function(t,e,i){this._cloneModule(t,e,i)},_cloneModule:function(t,e,i){if(t.empty(),e.node&&e.json){var o=Object.clone(e.json);o.id=o.id+"_"+i;var n=e.node.clone();n.set("id",o.id),n.inject(t),this.form._loadModule(o,n)}},_createImage:function(t,e,i){if(t.empty(),i){var o=new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top");if("size"==e.json.clipperType){var n=e.json.imageWidth,s=e.json.imageHeight;n&&s&&o.setStyles({width:n+"px",height:s+"px"})}}},_createAttachment:function(t,e,i){t.empty();var o={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(o.readonly=!0),this.editable||this.addable||(o.readonly=!0);(i||[]).each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var n=new MWF.xApplication.process.Xform.AttachmentController(t,e,o);n.load(),(i||[]).each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;n.addAttachment(e)}.bind(this))},_editorTrGoBack:function(){if(this.editorTr.setStyle("display","none"),this.totalTr)this.editorTr.inject(this.totalTr,"before");else{var t=this.table.getElements("tr"),e=t[t.length-1];this.editorTr.inject(e,"after")}},_addLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.editorTr.setStyles({display:"table-row"}),this.currentEditLine=null;var e=t.getParent("tr");e&&this.editorTr.inject(e,"after"),this.isEdit=!0,this.validationMode(),this.fireEvent("addLine",[this.editorTr])},_deleteLine:function(t){var e=!1,i=t.target.getParent("tr");if(i){var o=i.getStyle("background");i.store("bgcolor",o),i.tween("background-color","#ffd4d4");var n=this,s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){s.fireEvent("deleteLine",[i]);var t=i.retrieve("data");s.titleTr.getElements("th").each((function(i,o){var n=i.get("id"),a=o>0?s.editModules[o-1]:null;n&&a&&("Attachment"==a.json.type||"AttachmentDg"==a.json.type)&&(t[n][a.json.id].each((function(t){s.form.workAction.deleteAttachment(t.id,s.form.businessData.work.id)})),e=!0)})),i.destroy(),n._loadZebraStyle(),n._loadSequence(),n._loadTotal(),n.getData(),this.close(),s.fireEvent("afterDeleteLine"),e&&s.form.saveFormData()}),(function(){var t=i.retrieve("bgcolor");i.tween("background",t),this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},_createMoveLineAction:function(t){new Element("div",{styles:this.form.css.moveLineAction,events:{mousedown:function(t){this._moveLine(t)}.bind(this)}}).inject(t)},_getMoveDragNode:function(t){var e=t.getParent("table").getParent("div"),i=e.getSize(),o=e.clone().setStyle("width",i.x).inject(document.body),n=o.getElement("table");n.empty();var s=t.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(n),a=t.getElements("td"),r=s.getElements("td");a.each((function(t,e){var i=t.getComputedSize();r[e].setStyle("width",i.width+1)}));var l=t.getCoordinates();return o.setStyles(this.form.css.gridMoveLineDragNode),o.setStyles(l),o},_moveLine:function(t){var e=this.table.getElements("tr"),i=t.target.getParent("tr"),o=this._getMoveDragNode(i);coordinates=o.getCoordinates();var n=o.getElement("tr"),s=o.getElement("table"),a=i.getStyle("background");i.store("bgcolor",a),i.tween("background-color","#e4f6e9"),new Drag.Move(o,{droppables:e.erase(i),limit:{x:[coordinates.left,coordinates.left]},onDrop:function(t,e){t.destroy();var o=i.retrieve("bgcolor");o?i.tween("background",o):i.tween("background","transparent"),i.setStyle("display","table-row"),null!=e&&(i.inject(n,"after"),n.destroy(),this._loadDatagridStyle(),this.getData())}.bind(this),onEnter:function(t,e){o.setStyle("display","none"),n.inject(e,"after")},onLeave:function(t,e){n.inject(s),o.setStyle("display","block")},ondrag:function(){this.table.setStyle("cursor","move"),o.setStyle("cursor","move")},onCancel:function(t){t.destroy();var e=i.retrieve("bgcolor");e?i.tween("background",e):i.tween("background","transparent"),i.setStyle("display","table-row")}}).start(t),i.setStyle("display","none")},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){this.titleTr||this._getDatagridTitleTr();var e=this.titleTr.getElements("th"),i=this.table.getElements("tr");i[i.length-1];this.gridData.data&&this.gridData.data.each(function(t,i){var o=this.table.insertRow(i+1);o.store("data",t),e.each(function(e,n){var s=o.insertCell(n),a=t[e.get("id")],r=this.editModules[n];if("array"!==typeOf(a))if(a)for(key in a){var l=a[key];if(r&&"ImageClipper"==r.json.type)this._createImage(s,r,l);else if(!r||"Attachment"!=r.json.type&&"AttachmentDg"!=r.json.type){var d=this._getValueText(n,l);r&&"Textarea"==r.json.type?s.set("html",d):s.set("text",d)}else this._createAttachment(s,r,l);break}else r&&"Image"==r.json.type?this._createImg(s,r,i):r&&"Button"==r.json.type?this._createButton(s,r,i):r&&"Label"==r.json.type?this._createLabel(s,r,i):r&&"sequence"==r.json.type&&(s.setStyle("text-align","center"),s.set("text",o.rowIndex));var h=this.form._getDomjson(e);h&&!1===h.isShow&&s.hide()}.bind(this))}.bind(this)),this._loadTotal(),t&&t()},_loadImportExportAction:function(){if(this.impexpNode=this.node.getElement("div.impexpNode"),this.impexpNode&&this.impexpNode.destroy(),this.impexpNode=null,this.exportenable||this.importenable){var t,e=["leftTop","centerTop","rightTop"].contains(this.json.impexpPosition||"")?"top":"bottom",i=new Element("div").inject(this.node,e);if(this.importExportAreaNode=new Element("div").inject(i),["leftTop","leftBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"left"}):["rightTop","rightBottom"].contains(this.json.impexpPosition||"")?this.importExportAreaNode.setStyles({float:"right"}):this.importExportAreaNode.setStyles({margin:"0px auto"}),this.exportenable)this.exportActionNode=new Element("div",{text:this.json.exportActionText||MWF.xApplication.process.Xform.LP.datagridExport}).inject(this.importExportAreaNode),t=this.json.exportActionStyles?this.json.exportActionStyles:this.form.css.gridExportActionStyles,this.exportActionNode.setStyles(t),this.exportActionNode.addEvent("click",function(){this.exportToExcel()}.bind(this));if(this.importenable)this.importActionNode=new Element("div",{text:this.json.importActionText||MWF.xApplication.process.Xform.LP.datagridImport}).inject(this.importExportAreaNode),t=this.json.importActionStyles?this.json.importActionStyles:this.form.css.gridImportActionStyles,this.importActionNode.setStyles(t),this.importActionNode.addEvent("click",function(){this.importFromExcel()}.bind(this));if(["centerTop","centerBottom"].contains(this.json.impexpPosition)){var o=2;this.exportActionNode&&(o=o+this.exportActionNode.getSize().x+this.exportActionNode.getStyle("padding-left").toFloat()+ +this.exportActionNode.getStyle("padding-right").toFloat()+ +this.exportActionNode.getStyle("margin-left").toFloat()+ +this.exportActionNode.getStyle("margin-right").toFloat()),this.importActionNode&&(o=o+this.importActionNode.getSize().x+this.importActionNode.getStyle("padding-left").toFloat()+ +this.importActionNode.getStyle("padding-right").toFloat()+ +this.importActionNode.getStyle("margin-left").toFloat()+ +this.importActionNode.getStyle("margin-right").toFloat()),this.importExportAreaNode.setStyle("width",o+"px")}}},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridActionStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.editorTr&&(this.json.editStyles&&this.editorTr.getElements("td").setStyles(this.json.editStyles))},loadGridActionStyle:function(){0!=this.editable&&(this.json.actionStyles&&this.table.getElements("tr").each(function(t,e){0!=e&&t.getFirst().setStyles(this.json.actionStyles)}.bind(this)))},loadGridTitleStyle:function(){this.json.titleStyles&&this.titleTr.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.table.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++)t[e].hasClass("datagridTotalTr")||(this.json.backgroundColor&&t[e].setStyle("background-color",this.json.backgroundColor),e%2==0&&this.json.zebraColor&&t[e].setStyle("background-color",this.json.zebraColor))},createTotalTr:function(){var t=this.node.getElements("tr"),e=t[t.length-1];this.totalTr=new Element("tr.datagridTotalTr",{styles:this.form.css.datagridTotalTr}).inject(e,"after"),this.node.getElements("th").each(function(t,e){var i=new Element("td",{text:"",styles:this.form.css.datagridTotalTd}).inject(this.totalTr);this.json.amountStyles&&i.setStyles(this.json.amountStyles);var o=this.form._getDomjson(t);o&&!1===o.isShow&&i.hide()}.bind(this))},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalTr||this.createTotalTr();for(var e=[],i=this.table.getElements("tr"),o=this.totalTr.getElements("td"),n=1;n<i.length;n++)if(!i[n].hasClass("datagridTotalTr")&&!i[n].hasClass("datagridEditorTr")){var s=i[n].getElements("td");this.totalModules.each(function(i,o){e[o]||e.push(0);var n=new Decimal(e[o]);if("number"==i.type){var a=s[i.index].get("text").toFloat();n=n.plus(a||0)}"count"==i.type&&(n=n.plus(1)),e[o]=n.toString(),t[i.module.json.id]=e[o]}.bind(this))}this.totalModules.each(function(t,i){this.totalResaults[t.module.json.id]=e[i],o[t.index].set("text",isNaN(e[i])?"":e[i])}.bind(this))}return t},_loadSequence:function(){for(var t=this.table.getElements("tr"),e=1;e<t.length;e++){t[e].getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}},_loadBorderStyle:function(){this.json.border&&(this.table.setStyles({"border-top":this.json.border,"border-left":this.json.border}),this.table.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),this.table.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"}))},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i),!1===e.isShow&&t.hide()}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,o=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&o.node.setStyle("padding-right","0px"),t.store("module",o),this.form.modules.push(o),!1===e.isShow&&t.hide()}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle()}.bind(this)):this._loadDatagridStyle()},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit&&(this.currentEditLine&&this.currentEditLine.setStyle("display","table-row"),this.isEdit=!1,this.currentEditLine=null,this._editorTrGoBack()),this.gridData){for(var e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var o=e[i];if(!o.hasClass("datagridEditorTr"))for(var n=o.getElements("td"),s=0;s<n.length;s++){var a=n[s].retrieve("module");a&&(this.form.modules.erase(a),a=null)}}for(i=1;i<e.length-1;i++)e[i].hasClass("datagridTotalTr")||e[i].hasClass("datagridEditorTr")||e[i].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.table.getElements("tr"),i=1;i<e.length-1;i++){var o=e[i].retrieve("data");o&&t.push(o)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),o=i.getPrevious("div"),n=i.getChildren().indexOf(e.getParent("div"));o.getLast().getFirst().getChildren()[n].click(),e=o.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var o="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!o)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(o)return this.notValidationMode(e.prompt),!1;break;case"gt":if(o>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(o<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(o==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(o!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=o.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==o.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var o=this.json.validationConfig[i];if(!this.validationConfigItem(t,o))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t},isAvaliableImpExpColumn:function(t,e,i){return(!t||!1!==t.isShow&&!1!==t.isImpExp)&&((!e||"sequence"!=e.json.type&&"sequence"!=e.json.cellType)&&(!e||!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(e.json.type)))},getExportColWidthArray:function(){var t=this.titleTr.getElements("th"),e=[];return t.each(function(i,o){if(!this.editable||0!==o&&o!==t.length-1){var n=this.form._getDomjson(i),s=this.editModules[this.editable?o-1:o];this.isAvaliableImpExpColumn(n,s)&&(s&&["Org","Reader","Author","Personfield","Orgfield"].contains(s.json.type)?e.push(340):s&&"Address"===s.json.type?e.push(170):s&&"Textarea"===s.json.type?e.push(260):s&&"Htmleditor"===s.json.type?e.push(500):(s&&s.json.type,e.push(150)))}}.bind(this)),e},getExportDateIndexArray:function(){var t=this.titleTr.getElements("th"),e=[],i=0;return t.each(function(o,n){if(!this.editable||0!==n&&n!==t.length-1){var s=this.form._getDomjson(o),a=this.editModules[this.editable?n-1:n];this.isAvaliableImpExpColumn(s,a)&&(a&&"Calendar"===a.json.type&&e.push(i),i++)}}.bind(this)),e},getExportTitleArray:function(t){var e=this.titleTr.getElements("th"),i=[];return e.each(function(o,n){if(!this.editable||0!==n&&n!==e.length-1){var s=this.form._getDomjson(o),a=this.editModules[this.editable?n-1:n];this.isAvaliableImpExpColumn(s,a,t)&&i.push(o.get("text"))}}.bind(this)),i},exportToExcel:function(){var t,e=this.titleTr.getElements("th"),i=[],o=this.getExportTitleArray(),n=this.getExportColWidthArray(),s=this.getExportDateIndexArray();i.push(o),this.gridData.data&&this.gridData.data.each(function(t,o){var n=[];e.each(function(i,o){if(!this.editable||0!==o&&o!==e.length-1){var s=this.editModules[this.editable?o-1:o],a=this.form._getDomjson(i);if(this.isAvaliableImpExpColumn(a,s)){var r=t[i.get("id")],l="";if(r){if("array"!==typeOf(r))for(key in r){var d=r[key];if(s&&["Org","Reader","Author","Personfield","Orgfield"].contains(s.json.type))if("array"===typeOf(d)){var h=[];d.each(function(t){"object"===typeOf(t)?h.push(t.distinguishedName):h.push(t)}.bind(this)),l=h.join(", \n")}else l="object"===typeOf(d)?d.distinguishedName:d;else l=s&&"Textarea"===s.json.type?d:this._getValueText(this.editable?o-1:o,d);break}}else s&&"Label"===s.json.type&&s.node&&(l=s.node.get("text"));l||"number"===typeOf(l)||(l=""),n.push(l)}}}.bind(this)),i.push(n)}.bind(this));var a=(t=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(a[a.length-1].toLowerCase())&&a.splice(a.length-1),t=a.join(".");var r={data:i,colWidthArray:n,title:t};this.fireEvent("export",[r]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,r.title||t,n,s)},importFromExcel:function(){var t=[],e=[],i=this.titleTr.getElements("th"),o=1,n=[];i.each(function(s,a){if(!this.editable||0!==a&&a!==i.length-1){var r=this.editModules[this.editable?a-1:a],l=this.form._getDomjson(s);this.isAvaliableImpExpColumn(l,r,"import")&&(t.push({text:s.get("text").trim(),index:o,thJson:l,module:r}),o++,r&&"Calendar"===r.json.type?e.push(o):r&&["Org","Reader","Author","Personfield","Orgfield"].contains(r.json.type)&&n.push(s.get("text")))}}.bind(this)),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).upload(e,function(e){var i=function(){this.checkImportedData(t,e)?this.setImportData(t,e):this.openImportedErrorDlg(t,e)}.bind(this);n.length>0?this.listImportAllOrgData(n,e,function(){i()}.bind(this)):i()}.bind(this))},parseImportedData:function(t,e){var i={data:[]};return e.each(function(e,o){var n={};t.each(function(t,i){t.index;var o,s=t.module,a=t.thJson,r=t.text,l=e[r]||"";switch(s.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if(l){var d=l.split(/\s*,\s*/g);o=[],d.each(function(t,e){var i=this.getImportOrgData(t);o.push(i)}.bind(this))}else o=[];break;case"Combox":case"Address":d=l.split(/\s*,\s*/g),o=d;break;case"Checkbox":d=l.split(/\s*,\s*/g);var h=s.getOptionsObj();d.each((function(t,e){var i=h.textList.indexOf(t);d[e]=i>-1?h.valueList[i]:""})),o=1===d.length?d[0]:d;break;case"Radio":case"Select":o=l.replace(/&#10;/g,"");var c=(h=s.getOptionsObj()).textList.indexOf(o);o=c>-1?h.valueList[c]:"";break;case"Textarea":o=l.replace(/&#10;/g,"\n");break;case"Calendar":var u;if(o=l.replace(/&#10;/g,""))u=s.json.format?s.json.format:"datetime"===s.json.selectType||"time"===s.json.selectType?"time"===s.json.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,o=Date.parse(o).format(u);break;default:o=l.replace(/&#10;/g,"")}n[a.id]={},n[a.id][s.json.id]=o}.bind(this)),i.data.push(n)}.bind(this)),i},setImportData:function(t,e){var i=this.parseImportedData(t,e);this.fireEvent("import",[i]),this.setData(i),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openImportedErrorDlg:function(t,e){var i=this,o=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,o){"style"===e?i.push(o+":"+t+";"):i.push(o+"='"+t+"'")})),i.join(" ")},n=["<table "+o(this.json.properties)+" style='"+o(this.json.tableStyles,"style")+"'>"],s=o(this.json.titleStyles,"style");n.push("<tr>"),t.each((function(t,e){n.push("<th style='"+s+"'>"+t.text+"</th>")})),n.push("<th style='"+s+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),n.push("</tr>");var a=Object.clone(this.json.contentStyles);a["border-bottom"]||a.border||(a["border-bottom"]="1px solid #eee");var r=o(Object.merge(a,{"text-align":"left"}),"style");e.each(function(e,i){n.push("<tr>"),t.each((function(t,i){n.push("<td style='"+r+"'>"+(e[t.text]||"").replace(/&#10;/g,"<br/>")+"</td>")})),n.push("<td style='"+r+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),n.push("</tr>")}.bind(this)),n.push("</table>");var l=new Element("div",{style:"padding:10px;",html:n.join("")}),d=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:l,offset:{y:0},isMax:!0,width:1e3,height:700,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){i.exportWithImportDataToExcel(t,e)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){d.close()}}],onPostClose:function(){d=null}.bind(this)})},exportWithImportDataToExcel:function(t,e){this.titleTr.getElements("th");var i=[],o=this.getExportColWidthArray();o.push(220);var n,s=this.getExportDateIndexArray(),a=this.getExportTitleArray("import");a.push(MWF.xApplication.process.Xform.LP.validationInfor),i.push(a),e.each(function(e,o){var n=[];t.each((function(t,i){n.push((e[t.text]||"").replace(/&#10;/g,"\n"))})),n.push(e.errorTextListExcel?e.errorTextListExcel.join("\n"):""),i.push(n)}.bind(this));var r=(n=this.json.excelName&&this.json.excelName.code?this.form.Macro.exec(this.json.excelName.code,this):MWF.xApplication.process.Xform.LP.exportDefaultName).split(".");["xls","xlst"].contains(r[r.length-1].toLowerCase())&&r.splice(r.length-1),n=r.join(".");var l={data:i,colWidthArray:o,title:n,withError:!0};this.fireEvent("export",[l]),new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel(i,l.title||n,o,s)},checkImportedData:function(t,e){var i=!0,o=this.parseImportedData(t,e),n=MWF.xApplication.process.Xform.LP,s=n.importValidationColumnText,a=n.importValidationColumnTextExcel,r=new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this);e.each(function(e,l){var d=o&&o.data?o.data[l]:{},h=[],c=[];t.each(function(t,i){var o=t.index,l=t.module,u=t.thJson,p=t.text,f=s.replace("{n}",o),m=a.replace("{n}",r.index2ColName(o-1)),g=e[p]||"",y="",v=d[u.id];if("object"===typeOf(v)&&(y=v[l.json.id]),g)switch(l.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":g.split(/\s*,\s*/g).each(function(t,e){var i=this.getImportOrgData(t);i.errorText&&(h.push(f+i.errorText+n.fullstop),c.push(m+i.errorText+n.fullstop))}.bind(this));break;case"Number":isNaN(g)&&(h.push(f+g+n.notValidNumber+n.fullstop),c.push(m+g+n.notValidNumber+n.fullstop));break;case"Calendar":isNaN(g)&&!isNaN(Date.parse(g))||(h.push(f+g+n.notValidDate+n.fullstop),c.push(m+g+n.notValidDate+n.fullstop))}if("sequence"!=l.json.type&&l.setData&&"Address"!==l.json.type){var b=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(l.json.type)&&"array"===o2.typeOf(y)&&y.length&&(b=y.some((function(t){return t.errorText}))),b||(l.setData(y),l.validationMode(),!l.validation()&&l.errNode&&(h.push(f+l.errNode.get("text")),c.push(m+l.errNode.get("text")),l.errNode.destroy()))}}.bind(this)),h.length>0&&(e.errorTextList=h,e.errorTextListExcel=c,i=!1)}.bind(this));var l={validted:i,data:e};return this.fireEvent("validImport",[l]),l.validted},getImportOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMapImported[t]||this.personMapImported[t]||this.unitMapImported[t]||this.groupMapImported[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listImportAllOrgData:function(t,e,i){var o=[],n=[],s=[],a=[];if(t.length>0){var r,l,d,h;e.each((function(e,i){t.each((function(t,i){e[t]&&e[t].split(/\s*,\s*/g).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":o.push(t);break;case"@p":n.push(t);break;case"@u":s.push(t);break;case"@g":a.push(t);break;default:o.push(t),n.push(t),s.push(t),a.push(t)}}))}))}));var c=function(){r&&l&&d&&h&&i&&i()};this.identityMapImported={},o.length?o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:o},function(t){t.data.each(function(t){this.identityMapImported[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this)):(r=!0,c()),this.personMapImported={},n.length?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:n},function(t){t.data.each(function(t){this.personMapImported[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this)):(l=!0,c()),this.unitMapImported={},s.length?o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:s},function(t){t.data.each(function(t){this.unitMapImported[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this)):(d=!0,c()),this.groupMapImported={},a.length?o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMapImported[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this)):(h=!0,c())}}}),MWF.xApplication.process.Xform.DatagridPC$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:0!=this.dataGrid.editable?this.node.cellIndex+1:this.node.cellIndex,type:this.json.total})}}),MWF.xApplication.process.Xform.DatagridPC$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}})}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t);if(e){var i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var o=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&o.node.setStyle("padding-right","0px"),o.dataModule=this,this.dataGrid.editModules.push(o)}}.bind(this))}}}),MWF.xApplication.process.Xform.DatagridPC.ExcelUtils=new Class({initialize:function(t){this.datagrid=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,o=new FileReader;o.onload=function(t){for(var n=new Uint8Array(o.result),s=n.byteLength,a=0;a<s;a++)e+=String.fromCharCode(n[a]);i.content=e,i.onload()},o.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,o=document.createElement("a");o.href=t,o.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),o.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var o=new Element("div");o.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),o.getFirst().addEvent("change",function(){var t=n.files;if(t.length){var s=t.item(0);if(s.name.indexOf(" ")>-1)return this.form.notice(MWF.xApplication.process.Xform.LP.uploadedFilesCannotHaveSpaces,"error"),!1;this.importFromExcel(s,function(t){e&&e(t),o.destroy()}.bind(this),i)}}.bind(this));var n=o.getFirst();n.click()},exportToExcel:function(t,e,i,o){this._loadResource(function(){var n=window.xlsxUtils.format2Sheet(t,0,0,null),s=window.xlsxUtils.format2WB(n,"sheet1",void 0),a=s.Sheets[s.SheetNames[0]],r=[];for(var l in t[0].each(function(t,e){i||r.push({wpx:100});var o=String.fromCharCode(97+e).toUpperCase();a[o+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),o&&o.length&&o.each(function(t,e){o[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==l.substr(0,1)){var d=a[l];if(d.s||(d.s={}),d.s.alignment||(d.s.alignment={}),d.s.alignment.wrapText=!0,o&&o.length){var h=l.replace(/\d+/g,"");l.replace(h,"")>1&&o.contains(h)&&(d.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){r.push({wpx:t})})),a["!cols"]=r,this._openDownloadDialog(window.xlsxUtils.format2Blob(s),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var o,n,s=new FileReader;s.onload=function(t){n=t?t.target.result:s.content;var a=(o=window.XLSX.read(n,{type:"binary"})).SheetNames[0];if(o.Sheets.hasOwnProperty(a)){var r=o.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var l;if(r["!range"])l=r["!range"].e.r;else{var d=r["!ref"].split(":");2===d.length&&(l=parseInt(d[1].replace(/[^0-9]/gi,"")))}if(l)for(var h=0;h<i.length;h++)for(var c=1;c<=l;c++){var u=r[i[h]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(r);e&&e(p)}},s.readAsBinaryString(t)}))}});