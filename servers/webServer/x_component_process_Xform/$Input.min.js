MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.$Input=MWF.APP$Input=new Class({Implements:[Events],Extends:MWF.APP$Module,iconStyle:"personfieldIcon",initialize:function(t,e,i,n){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this._loadNode(),"show"===this.json.compute?this._setValue(this._computeValue()):this._loadValue()},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!==this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):(this.node.getFirst()||this.node).addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):(this.node.getFirst()||this.node).addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadNode:function(){this.readonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type})},loadDescription:function(){if(!this.readonly&&!this.json.isReadonly&&(!this._getBusinessData()&&this.json.description)){var t=this.node.getFirst().getSize(),e=t.x-3;"no"==this.json.showIcon||this.form.json.hideModuleIcon||COMMON.Browser.safari&&(e-=20),this.descriptionNode=new Element("div",{styles:this.form.css.descriptionNode,text:this.json.description}).inject(this.node),this.descriptionNode.setStyles({width:e+"px",height:t.y+"px","line-height":t.y+"px"}),this.setDescriptionEvent()}},setDescriptionEvent:function(){this.descriptionNode&&(this.descriptionNode.addEvents({mousedown:function(){this.descriptionNode.setStyle("display","none"),this.clickSelect()}.bind(this)}),this.node.getFirst().addEvents({focus:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),blur:function(){this.node.getFirst().get("value")||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)}))},checkDescription:function(){this.node.getFirst().get("value")?this.descriptionNode&&this.descriptionNode.setStyle("display","none"):this.descriptionNode&&this.descriptionNode.setStyle("display","block")},_resetNodeEdit:function(){var t=new Element("input",{styles:{background:"transparent",width:"100%",border:"0px"},readonly:!0}),e=new Element("div",{styles:{overflow:"hidden",position:"relative","margin-right":"20px","padding-right":"4px"}}).inject(this.node,"after");t.inject(e),this.node.destroy(),this.node=e},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit(),this.node.getFirst().set(this.json.properties),this.node.set({id:this.json.id,MWFType:this.json.type,readonly:!0,events:{click:this.clickSelect.bind(this)}}),"no"==this.json.showIcon||this.form.json.hideModuleIcon?this.form.json.nodeStyleWithhideModuleIcon&&this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon):this.iconNode=new Element("div",{styles:this.form.css[this.iconStyle],events:{click:this.clickSelect.bind(this)}}).inject(this.node,"before"),this.node.getFirst().addEvent("change",function(){this.validationMode(),this.validation()&&(this._setBusinessData(this.getInputData("change")),this.fireEvent("change"))}.bind(this))},_loadStyles:function(){if(this.json.styles&&this.node.setStyles(this.json.styles),this.json.inputStyles&&this.node.getFirst()&&this.node.getFirst().setStyles(this.json.inputStyles),this.iconNode&&null!==this.iconNode.offsetParent){var t=this.node.getSize();this.iconNode.setStyle("height",t.y+"px")}},_computeValue:function(t){return this.json.defaultValue&&this.json.defaultValue.code?this.form.Macro.exec(this.json.defaultValue.code,this):t||""},getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();return t||(t=this._computeValue()),t||""},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.node.getFirst()&&this.node.getFirst().set("value",t||""),(this.readonly||this.json.isReadonly)&&this.node.set("text",t),this.moduleValueAG=null,t},_loadValue:function(){this._setValue(this.getValue())},clickSelect:function(){},_afterLoaded:function(){this.readonly||this.json.isReadonly||this.loadDescription()},isReadonly:function(){return!(!this.readonly&&!this.json.isReadonly)},getTextData:function(){var t=this.node.getFirst()?this.node.getFirst().get("value"):this.node.get("text");return{value:[t||""],text:[(this.node.getFirst()?this.node.getFirst().get("text"):this.node.get("text"))||t||""]}},isEmpty:function(){var t=this.getData();return!t||!t.trim()},getData:function(t){return"save"==this.json.compute&&this._setValue(this._computeValue()),this.getInputData()},getInputData:function(){return this.node.getFirst()?this.node.getFirst().get("value"):this._getBusinessData()},resetData:function(){this.setData(this.getValue())},setData:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setData(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setData(t)},__setData:function(t){this._setBusinessData(t),this.node.getFirst()?(this.node.getFirst().set("value",t),this.checkDescription(),this.validationMode()):this.node.set("text",t),this.moduleValueAG=null},createErrorNode:function(t){var e;if(this.form.json.errorStyle){if("notice"===this.form.json.errorStyle.type)this.form.errorNoticing||(this.form.errorNoticing=!0,this.form.notice(t,"error",this.node,null,null,{onClose:function(){this.form.errorNoticing=!1}.bind(this)}));else if(e=new Element("div",{styles:this.form.json.errorStyle.node,text:t}),this.form.json.errorStyle.close)new Element("div",{styles:this.form.json.errorStyle.close,events:{click:function(){this.destroy()}.bind(e)}}).inject(e)}else{e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{height:"20px","line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e)}return e},notValidationMode:function(t){if(!this.isNotValidationMode){this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border-color","red"),this.errNode=this.createErrorNode(t),this.errNode.inject(this.node,"after"),this.showNotValidationMode(this.node);for(var e=this.node;null===e.offsetParent;)e=e.getParent();e.isIntoView()||e.scrollIntoView()}},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==(e.get("MWFtype")||e.get("mwftype"))&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),n=i.getPrevious("div"),o=i.getChildren().indexOf(e.getParent("div"));n.getLast().getFirst().getChildren()[o].click(),e=n.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"===e.status||t===e.decision){var i=this.getInputData(),n="value"===e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!n)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(n)return this.notValidationMode(e.prompt),!1;break;case"gt":if(n>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(n<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(n==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(n!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=n.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==n.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var n=this.json.validationConfig[i];if(!this.validationConfigItem(t,n))return!1}return!0}return!0},validation:function(t,e){if(!this.readonly&&!this.json.isReadonly){if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);if(this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"!=i.toString())return this.notValidationMode(i),!1}return!0}});