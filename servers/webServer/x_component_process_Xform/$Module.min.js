MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.process.Xform.$Module=MWF.APP$Module=new Class({Implements:[Events],options:{moduleEvents:["load","queryLoad","postLoad"]},initialize:function(s,t,e,i){this.node=$(s),this.node.store("module",this),this.json=t,this.form=e},_getSource:function(){for(var s=this.node.getParent();s&&"source"!=s.get("MWFtype")&&"subSource"!=s.get("MWFtype")&&"subSourceItem"!=s.get("MWFtype");)s=s.getParent();return s?s.retrieve("module"):null},hide:function(){var s=this.node.getStyle("display");"none"!==s&&this.node.store("mwf_display",s),this.node.setStyle("display","none"),this.iconNode&&this.iconNode.setStyle("display","none")},show:function(){var s=this.node.retrieve("mwf_display",s);this.node.setStyle("display",s),this.iconNode&&this.iconNode.setStyle("display","block")},load:function(){this._loadModuleEvents(),this.fireEvent("queryLoad")&&(this._queryLoaded(),this._loadUserInterface(),this._loadStyles(),this._loadDomEvents(),this._afterLoaded(),this.fireEvent("postLoad"),this.fireEvent("load"))},_loadUserInterface:function(){},_loadStyles:function(){this.json.styles&&Object.each(this.json.styles,function(s,t){if(-1!=s.indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")||-1!=s.indexOf("x_cms_assemble_control")){var e=MWF.Actions.getHost("x_processplatform_assemble_surface"),i=MWF.Actions.getHost("x_portal_assemble_surface"),n=MWF.Actions.getHost("x_cms_assemble_control");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",e+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",i+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",i+"/x_portal_assemble_surface")),-1!==s.indexOf("/x_cms_assemble_control")?s=s.replace("/x_cms_assemble_control",n+"/x_cms_assemble_control"):-1!==s.indexOf("x_cms_assemble_control")&&(s=s.replace("x_cms_assemble_control",n+"/x_cms_assemble_control")),s=o2.filterUrl(s)}this.node.setStyle(t,s)}.bind(this))},_loadModuleEvents:function(){Object.each(this.json.events,function(s,t){s.code&&-1!==this.options.moduleEvents.indexOf(t)&&this.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this))}.bind(this))},_loadDomEvents:function(){Object.each(this.json.events,function(s,t){s.code&&-1===this.options.moduleEvents.indexOf(t)&&this.node.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(s,t){s.code&&(-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this)):this.node.addEvent(t,function(t){return this.form.Macro.fire(s.code,this,t)}.bind(this)))}.bind(this))},addModuleEvent:function(s,t){-1!==this.options.moduleEvents.indexOf(s)?this.addEvent(s,function(s){return t?t(this,s):null}.bind(this)):this.node.addEvent(s,function(s){return t?t(this,s):null}.bind(this))},_getBusinessData:function(){var s;if("yes"==this.json.section)s=this._getBusinessSectionData();else{if("Opinion"!==this.json.type)return this.getBusinessDataById()||"";s=this._getBusinessSectionDataByPerson()}return s},_getBusinessSectionData:function(){switch(this.json.sectionBy){case"person":return this._getBusinessSectionDataByPerson();case"unit":return this._getBusinessSectionDataByUnit();case"activity":return this._getBusinessSectionDataByActivity();case"splitValue":return this._getBusinessSectionDataBySplitValue();case"script":return this._getBusinessSectionDataByScript(this.json.sectionByScript?this.json.sectionByScript.code:"");default:return this.getBusinessDataById()||""}},_getBusinessSectionDataByPerson:function(){this.form.sectionListObj[this.json.id]=layout.desktop.session.user.id;var s=this.getBusinessDataById();return s&&s[layout.desktop.session.user.id]||""},_getBusinessSectionDataByUnit:function(){this.form.sectionListObj[this.json.id]="";var s=this.getBusinessDataById();if(!s)return"";var t=this.form.businessData.task?this.form.businessData.task.unit:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataByActivity:function(){this.form.sectionListObj[this.json.id]="";var s=this.getBusinessDataById();if(!s)return"";var t=this.form.businessData.work?this.form.businessData.work.activity:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataBySplitValue:function(){this.form.sectionListObj[this.json.id]="";var s=this.getBusinessDataById();if(!s)return"";var t=this.form.businessData.work?this.form.businessData.work.splitValue:"";return t&&(this.form.sectionListObj[this.json.id]=t),t&&s[t]||""},_getBusinessSectionDataByScript:function(s){this.form.sectionListObj[this.json.id]="";var t=this.getBusinessDataById();if(!t)return"";var e=this.form.Macro.exec(s,this);return e&&(this.form.sectionListObj[this.json.id]=e),e&&t[e]||""},_setBusinessData:function(s){"yes"==this.json.section?this._setBusinessSectionData(s):"Opinion"===this.json.type?this._setBusinessSectionDataByPerson(s):(this.form.businessData.data[this.json.id]?this.setBusinessDataById(s):(this.setBusinessDataById(s),this.form.Macro.environment.setData(this.form.businessData.data)),this.json.isTitle&&(this.form.businessData.work.title=s))},_setBusinessSectionData:function(s){switch(this.json.sectionBy){case"person":this._setBusinessSectionDataByPerson(s);break;case"unit":this._setBusinessSectionDataByUnit(s);break;case"activity":this._setBusinessSectionDataByActivity(s);break;case"splitValue":this._setBusinessSectionDataBySplitValue(s);break;case"script":this._setBusinessSectionDataByScript(this.json.sectionByScript.code,s);break;default:this.form.businessData.data[this.json.id]?this.setBusinessDataById(s):(this.setBusinessDataById(s),this.form.Macro.environment.setData(this.form.businessData.data))}},_setBusinessSectionDataByPerson:function(s){var t=!1,e=layout.desktop.session.user.id,i=this.getBusinessDataById();i||(i={},this.setBusinessDataById(i),t=!0),i[e]||(t=!0),i[e]=s,t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByUnit:function(s){var t=!1,e=this.form.businessData.task?this.form.businessData.task.unit:"";if(e){var i=this.getBusinessDataById();i||(i={},this.setBusinessDataById(i),t=!0),i[e]||(t=!0),i[e]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByActivity:function(s){var t=!1,e=this.form.businessData.work?this.form.businessData.work.activity:"";if(e){var i=this.getBusinessDataById();i||(i={},this.setBusinessDataById(i),t=!0),i[e]||(t=!0),i[e]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataBySplitValue:function(s){var t=!1,e=this.form.businessData.work?this.form.businessData.work.splitValue:"";if(e){var i=this.getBusinessDataById();i||(i={},this.setBusinessDataById(i),t=!0),i[e]||(t=!0),i[e]=s}t&&this.form.Macro.environment.setData(this.form.businessData.data)},_setBusinessSectionDataByScript:function(s,t){var e=!1,i=this.form.Macro.exec(s,this);if(i){var n=this.getBusinessDataById();n||(n={},this.setBusinessDataById(n),e=!0),n[i]||(e=!0),n[i]=t}e&&this.form.Macro.environment.setData(this.form.businessData.data)},getBusinessDataById:function(){if(this.json.id.indexOf("..")<1)return this.form.businessData.data[this.json.id];var s=this.json.id.split("..");s=s.map((function(s){return s.test(/^\d+$/)?s.toInt():s}));for(var t=this.form.businessData.data,e=s.length-1,i=0;i<=e;i++){var n=s[i];if(!n&&0!==n)return null;if(!["object","array"].contains(o2.typeOf(t)))return null;if(i===e)return t[n];t=t[n]}},setBusinessDataById:function(s){if(this.json.id.indexOf("..")<1)this.form.businessData.data[this.json.id]=s;else{var t=this.json.id.split("..");t=t.map((function(s){return s.test(/^\d+$/)?s.toInt():s}));for(var e=this.form.businessData.data,i=t.length-1,n=0;n<=i;n++){var a=t[n];if(!a&&0!==a)return;if(n===i)e[a]=s;else{var o=t[n+1];if("number"===o2.typeOf(o)){if(e[a]||"array"===o2.typeOf(e[a])||(e[a]=[]),o>e[a].length)return}else e[a]&&"object"===o2.typeOf(e[a])||(e[a]={});e=e[a]}}}},_queryLoaded:function(){},_afterLoaded:function(){},setValue:function(){},focus:function(){this.node.focus()},_getModuleByPath:function(s){if(s){var t=this.json.id.split("..");if(s.contains("*")){for(var e=s.split("."),i=0;i<e.length;i++)if(e[i].contains("*")&&t[i]){var n=e[i].replace("*",t[i]);n=this.form.Macro.exec("return "+n,this),e[i]=(n||"").toString()}s=e.join("..")}else if(s.contains("./")){var a=s.substring(s.indexOf("./")+2,s.length),o=(s.substring(0,s.indexOf("./"))+".").split(".").length-1,r=Array.clone(t);if(r.length>2*o){for(i=0;i<o;i++)r.pop(),i>0&&r.pop();s=r.join("..")+".."+a}else r[r.length-1]=a,s=r.join("..")}return this.form.all[s]}}});