MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xDesktop.requireApp("process.Xform","Button",null,!1),MWF.xApplication.process.Xform.Importer=MWF.APPImporter=new Class({Implements:[Events],Extends:MWF.xApplication.process.Xform.Button,options:{moduleEvents:["queryLoad","postLoad","afterLoad","loadImporter","beforeImport","validImport","afterImport","beforeCreateRowData","afterCreateRowData"]},_loadUserInterface:function(){var t=this.node.getElement("button");t||(t=new Element("button")),t.inject(this.node,"after"),this.node.destroy(),this.node=t,this.node.set({id:this.json.id,text:this.json.name||this.json.id,styles:this.form.css.buttonStyles,MWFType:this.json.type}),this.node.addEvent("click",function(){this.upload()}.bind(this)),this.json.allowDownloadTempalte&&this.json.downloadTempalteFieldId&&this.setDownloadEvent()},getImporter:function(t){var e;e=this.json.queryImportModel.id?{id:this.json.queryImportModel.id}:{application:this.json.queryImportModel.application||this.json.queryImportModel.appName,name:this.json.queryImportModel.alias||this.json.queryImportModel.name},MWF.xDesktop.requireApp("query.Query","Importer",function(){this.importer=new MWF.xApplication.query.Query.Importer(this.form.app.content,e,{onQueryLoad:function(){this.fireEvent("loadImporter")}.bind(this),onBeforeImport:function(t){this.fireEvent("beforeImport",t)}.bind(this),onValidImport:function(t){this.fireEvent("validImport",[t])}.bind(this),onAfterImport:function(t){this.fireEvent("afterImport",[t])}.bind(this),onBeforeCreateRowData:function(t){this.fireEvent("beforeCreateRowData",[t])}.bind(this),onAfterCreateRowData:function(t){this.fireEvent("afterCreateRowData",[t])}.bind(this)},this.form.app,this.form.Macro),t&&t()}.bind(this))},upload:function(){this.importer?this.importer.importFromExcel():this.getImporter(function(){this.importer.load()}.bind(this))},setDownloadEvent:function(){this.bindEvent=function(){var t=this._getModuleByPath(this.json.downloadTempalteFieldId);t&&t.node.addEvent("click",function(){this.downloadTemplate()}.bind(this)),this.fireEvent("afterLoad"),this.form.removeEvent("afterModulesLoad",this.bindEvent)}.bind(this),this.form.addEvent("afterModulesLoad",this.bindEvent)},downloadTemplate:function(){this.importer?this.importer.downloadTemplate(this.getExcelName()):this.getImporter(function(){this.importer.downloadTemplate(this.getExcelName())}.bind(this))},getExcelName:function(){var t;return this.json.excelName&&this.json.excelName.code&&(t=this.form.Macro.exec(this.json.excelName.code,this)),t||""}});