MWF.xDesktop.requireApp("process.Xform","$Input",null,!1),MWF.xApplication.process.Xform.Select=MWF.APPSelect=new Class({Implements:[Events],Extends:MWF.APP$Input,iconStyle:"selectIcon",initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadNode:function(){this.readonly||this.json.isReadonly?this._loadNodeRead():this._loadNodeEdit()},_loadNodeRead:function(){this.node.empty(),this.node.set({nodeId:this.json.id,MWFType:this.json.type});var t=this.getOptions(),e=this.getValue();if(e){"array"!==typeOf(e)&&(e=[e]);var i=[];t.each((function(t){var s=t.split("|"),n=s[0],o=s[1]||n;o&&-1!=e.indexOf(o)&&i.push(n)})),this.node.set("text",i.join(", "))}},_loadDomEvents:function(){Object.each(this.json.events,function(t,e){t.code&&-1===this.options.moduleEvents.indexOf(e)&&this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this))}.bind(this))},_loadEvents:function(){Object.each(this.json.events,function(t,e){t.code&&(-1!=this.options.moduleEvents.indexOf(e)?this.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)):this.node.addEvent(e,function(e){return this.form.Macro.fire(t.code,this,e)}.bind(this)))}.bind(this))},addModuleEvent:function(t,e){-1!==this.options.moduleEvents.indexOf(t)?this.addEvent(t,function(t){return e?e(this,t):null}.bind(this)):this.node.addEvent(t,function(t){return e?e(this,t):null}.bind(this))},_loadStyles:function(){this.areaNode?(this.json.styles&&this.areaNode&&this.areaNode.setStyles(this.json.styles),this.json.inputStyles&&this.node.setStyles(this.json.inputStyles)):this.json.styles&&this.node.setStyles(this.json.styles)},_resetNodeEdit:function(){this.node.empty();var t=new Element("select");t.set(this.json.properties),t.inject(this.node)},_loadNodeEdit:function(){this.json.preprocessing||this._resetNodeEdit();var t=this.node.getFirst();this.areaNode=this.node,this.node=t,this.node.set({id:this.json.id,MWFType:this.json.type,styles:{"margin-right":"12px"}}),this.setOptions(),this.node.addEvent("change",function(){var t=this.getInputData("change");this._setBusinessData(t),this.validationMode(),this.validation()&&(this._setBusinessData(t),this.fireEvent("change"))}.bind(this))},resetOption:function(){this.node.empty(),this.setOptions(),this.fireEvent("resetOption")},getOptions:function(){return"values"==this.json.itemType?this.json.itemValues:this.form.Macro.exec(this.json.itemScript?this.json.itemScript.code:"",this)},getOptionsObj:function(){var t=[],e=[],i=this.getOptions();return i||(i=[]),"array"===o2.typeOf(i)&&i.each(function(i){var s=i.split("|");t.push(s[0]),e.push(s[1]||s[0])}.bind(this)),{textList:t,valueList:e}},setOptions:function(){var t=this.getOptions();this._setOptions(t)},_setOptions:function(t){var e=o2.promiseAll(t).then(function(t){this.moduleSelectAG=null,t||(t=[]),"array"===o2.typeOf(t)&&(t.each(function(t){var e=t.split("|"),i=e[0],s=e[1]||i;new Element("option",{value:s,text:i}).inject(this.node)}.bind(this)),this.fireEvent("setOptions",[t]))}.bind(this),function(){this.moduleSelectAG=null}.bind(this));this.moduleSelectAG=e,e&&e.then(function(){this.moduleSelectAG=null}.bind(this),function(){this.moduleSelectAG=null}.bind(this))},addOption:function(t,e){new Element("option",{value:e||t,text:t}).inject(this.node);this.fireEvent("addOption",[t,e])},_setValue:function(t,e){var i=e||"__setValue";if(t){var s=o2.promiseAll(t).then(function(t){return"array"==o2.typeOf(t)&&(t=t[0]),this.moduleSelectAG?(this.moduleValueAG=this.moduleSelectAG,this.moduleSelectAG.then(function(){return this[i](t),t}.bind(this),(function(){}))):this[i](t),t}.bind(this),(function(){}));this.moduleValueAG=s,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this[i](t)},__setValue:function(t){if(!this.readonly&&!this.json.isReadonly){this._setBusinessData(t);for(var e=this.node.getElements("option"),i=0;i<e.length;i++){var s=e[i];s.value==t?s.selected=!0:s.selected=!1}}this.moduleValueAG=null},getTextData:function(){var t=[],e=[];if(this.readonly||this.json.isReadonly){var i=this.getOptionsObj(),s=this._getBusinessData();("array"===typeOf(s)?s:[s]).each((function(s){var n=i.valueList.indexOf(s);t.push(s||""),e.push(n>-1?i.textList[n]:s||"")}))}else{(i=this.node.getElements("option")).each((function(i){if(i.selected){var s=i.get("value"),n=i.get("text");t.push(s||""),e.push(n||s||"")}}))}return t.length||(t=[""]),e.length||(e=[""]),{value:t,text:e}},getInputData:function(){if(this.readonly||this.json.isReadonly)return this._getBusinessData();var t=this.node.getElements("option"),e=[];return t.each((function(t){if(t.selected){var i=t.get("value");i&&e.push(i)}})),e.length?1==e.length?e[0]:e:null},resetData:function(){this.setData(this.getValue())},setData:function(t){return this._setValue(t,"__setData")},__setData:function(t){if(this._setBusinessData(t),this.readonly||this.json.isReadonly){var e="array"===typeOf(t)?t:[t],i=this.getOptionsObj(),s=[];e.each((function(t){var e=i.valueList.indexOf(t);s.push(e>-1?i.textList[e]:t)})),this.node.set("text",s.join(","))}else{(i=this.node.getElements("option")).each((function(e){"array"==typeOf(t)?-1!=t.indexOf(e.get("value"))?e.set("selected",!0):e.set("selected",!1):t==e.get("value")?e.set("selected",!0):e.set("selected",!1)})),this.validationMode()}this.fireEvent("setData",[t])}});