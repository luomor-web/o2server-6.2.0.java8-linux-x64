MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.DatagridMobile=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","completeLineEdit","addLine","deleteLine","afterDeleteLine","editLine"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","hidden"),this.node.setStyle("overflow-y","hidden"),this.table=this.node.getElement("table"),this.createMobileTable(),this.editable=!this.readonly,this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.deleteable="no"!==this.json.deleteable,this.addable="no"!==this.json.addable,this.gridData=this._getValue(),this.totalModules=[],this._loadDatagridTitleModules(),0!=this.editable?(this._loadDatagridDataModules(),this._loadEditDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this))):(this._loadDatagridDataModules(),this._loadReadDatagrid(function(){this.fireEvent("postLoad"),this.fireEvent("load")}.bind(this)))},createMobileTable:function(){var t=new Element("table").inject(this.node);t.set(this.json.properties);var e=this.table.getElements("tr"),i=e[0].getElements("th"),s=e[1].getElements("td");i.each(function(e,i){var n=t.insertRow();new Element("th").inject(n).set({html:e.get("html"),id:e.get("id"),mwftype:e.get("mwftype")}),new Element("td").inject(n).set({html:s[i].get("html"),id:s[i].get("id"),mwftype:s[i].get("mwftype")});var a=this.form._getDomjson(e);a&&!1===a.isShow&&n.hide()}.bind(this)),this.table.destroy(),this.table=null,this.table=t},_loadStyles:function(){this.node.setStyles(this.json.styles),this.node.getElements("table").each(function(t){t.setStyles(this.json.tableStyles)}.bind(this))},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=[];return(t=this._getBusinessData())||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.isAG||"array"==o2.typeOf(t)&&(t={data:t||[]})),t||[]},getValue:function(){return this._getValue()},_getValueText:function(t,e){var i=this.editModules[t];if(i)switch(i.json.type){case"Select":for(var s=0;s<i.json.itemValues.length;s++){var n=i.json.itemValues[s].split(/\|/),a=n[0];if(e===(n.length>1?n[1]:n[0]))return a}break;case"Radio":var o=i.node.getElements("input");for(s=0;s<o.length;s++)if(o[s].value==e)return o[s].get("showText");break;case"Checkbox":o=i.node.getElements("input");var l=[];for(s=0;s<o.length;s++)-1!=e.indexOf(o[s].value)&&l.push(o[s].get("showText"));if(l.length)return l.join(", ");break;case"Orgfield":case"Personfield":case"Org":if("array"===typeOf(e)){var d=[];return e.each(function(t){"object"===typeOf(t)?d.push(t.name+(t.unitName?"("+t.unitName+")":"")):d.push(t)}.bind(this)),d.join(", ")}return"object"===typeOf(e)?e.name+(e.unitName?"("+e.unitName+")":""):e;case"Textarea":var r=new RegExp("\n","g"),h=new RegExp("<","g"),c=new RegExp(">","g");e=e.replace(h,"&lt").replace(c,"&gt").replace(r,"<br/>")}return e},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!=e.json.type&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},_loadReadDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadReadDatagrid(t),this.moduleValueAG=null,e}.bind(this),(function(){}));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadReadDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data&&this.gridData.data.each(function(t,s){var n=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?n.inject(this.totalDiv,"before"):n.inject(this.node),this._createItemTitleNode(n,s);var a=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(n),o=new Element("table").inject(a);o.set(this.json.properties),o.store("data",t),e.each(function(e,n){var a=o.insertRow(n),l=new Element("th").inject(a);l.set("text",e.get("text")),l.setStyle("width","30%");var d=a.insertCell(1);d.set("MWFId",i[n].get("id"));var r=t[e.get("id")];if("array"!==typeOf(r))if(r)for(key in r){var h=r[key],c=this.editModules[n];c&&"ImageClipper"==c.json.type?this._createImage(d,c,h):!c||"Attachment"!=c.json.type&&"AttachmentDg"!=c.json.type?(text=this._getValueText(n,h),c&&"Textarea"==c.json.type?d.set("html",text):d.set("text",text)):this._createAttachment(d,c,h);break}else d.setStyle("text-align","left"),d.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&a.hide()}.bind(this))}.bind(this)),t&&t()},_loadEditDatagrid:function(t){var e=o2.promiseAll(this.gridData).then(function(e){return this.gridData=e,"array"==o2.typeOf(this.gridData)&&(this.gridData={data:this.gridData}),this.__loadEditDatagrid(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__loadEditDatagrid:function(t){var e=this.table.getElements("th"),i=this.table.getElements("td");this.gridData.data.length?(this.addAction&&this.addAction.setStyle("display","none"),this.gridData.data.each(function(t,s){var n=new Element("div.dataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?n.inject(this.totalDiv,"before"):n.inject(this.node),this._createItemTitleNode(n,s);var a=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(n),o=new Element("table").inject(a);o.set(this.json.properties),o.store("data",t),e.each(function(e,n){var a=o.insertRow(n),l=new Element("th").inject(a);l.set("text",e.get("text")),l.setStyle("width","30%");var d=a.insertCell(1);d.set("MWFId",i[n].get("id"));var r=t[e.get("id")];if("array"!==typeOf(r))if(r)for(key in r){var h=r[key],c=this.editModules[n];c&&"ImageClipper"==c.json.type?this._createImage(d,c,h):!c||"Attachment"!=c.json.type&&"AttachmentDg"!=c.json.type?(text=this._getValueText(n,h),c&&"Textarea"==c.json.type?d.set("html",text):d.set("text",text)):this._createAttachment(d,c,h);break}else d.setStyle("text-align","left"),d.set("text",s+1);var u=this.form._getDomjson(e);u&&!1===u.isShow&&a.hide()}.bind(this));n.getSize()}.bind(this))):this.addAction?this.addable&&this.addAction.setStyle("display","block"):this.addable&&this._loadAddAction(),t&&t()},_loadActions:function(t){var e=new Element("div",{styles:this.form.css.mobileDatagridActionNode}).inject(t),i=new Element("div",{styles:this.form.css.mobileDatagridDelActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(e);this.deleteable||i.hide();var s=new Element("div",{styles:this.form.css.mobileDatagridEditActionNode,text:MWF.xApplication.process.Xform.LP.edit}).inject(e),n=new Element("div",{styles:this.form.css.mobileDatagridAddActionNode,text:MWF.xApplication.process.Xform.LP.add}).inject(e);this.addable||n.hide();var a=new Element("div",{styles:this.form.css.mobileDatagridCancelActionNode,text:MWF.xApplication.process.Xform.LP.cancelEdit}).inject(e),o=new Element("div",{styles:this.form.css.mobileDatagridCompleteActionNode,text:MWF.xApplication.process.Xform.LP.completedEdit}).inject(e),l=this;this.deleteable&&i.addEvent("click",(function(t){l._deleteLine(this.getParent().getParent().getParent(),t)})),s.addEvent("click",(function(t){l._editLine(this.getParent().getParent().getParent(),t)})),o.addEvent("click",(function(t){l._completeLineEdit()})),a.addEvent("click",(function(t){l._cancelLineEdit(t)})),this.addable&&n.addEvent("click",(function(t){l._addLine()}))},_createImage:function(t,e,i){(t.empty(),i)&&new Element("img",{src:MWF.xDesktop.getImageSrc(i)}).inject(t,"top").setStyles({"max-width":"90%"})},_createAttachment:function(t,e,i){t.empty();var s={style:e.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:e.json.dg_listStyle||"icon",size:e.json.dg_size||"min",resize:"y"===e.json.dg_resize||"true"===this.json.dg_resize,attachmentCount:0,isUpload:!1,isDelete:!1,isReplace:!1,isDownload:!0,isSizeChange:"y"===e.json.dg_isSizeChange||"true"===e.json.dg_isSizeChange,readonly:!0,availableListStyles:e.json.dg_availableListStyles?e.json.dg_availableListStyles:["list","seq","icon","preview"],isDeleteOption:"n",isReplaceOption:"n",toolbarGroupHidden:e.json.dg_toolbarGroupHidden||[]};this.readonly&&(s.readonly=!0),this.editable||this.addable||(s.readonly=!0);i.each((function(t){var i=e.attachmentController.attachments.find((function(e){return t.id==e.data.id}));i&&e.attachmentController.removeAttachment(i)})),e.setAttachmentBusinessData();var n=new MWF.xApplication.process.Xform.AttachmentController(t,e,s);n.load(),i.each(function(t){var e=this.form.businessData.attachmentList.find((function(e){return e.id==t.id}))||t;n.addAttachment(e)}.bind(this))},_createItemTitleNode:function(t,e){var i=e+1,s=new Element("div",{styles:this.json.itemTitleStyles}).inject(t);s.setStyle("overflow","hidden");new Element("div.sequenceDiv",{styles:{float:"left"},text:MWF.xApplication.process.Xform.LP.item+i}).inject(s);0!=this.editable&&this._loadActions(s)},_createHelpNode:function(){this.helpNode=new Element("div",{styles:this.form.css.mobileGridHelpNode}).inject(this.node,"top"),this.helpContentNode=new Element("div",{styles:this.form.css.mobileGridHelpContentNode}).inject(this.helpNode),this.helpContentNode.set("html",MWF.xApplication.process.Xform.LP.mobileGridHelp),new mBox.Tooltip({content:this.helpContentNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.helpNode,transition:"flyin",position:{x:["right"],y:["center"]},event:"click"})},_editLine:function(t){if(this.isEdit&&!this._completeLineEdit())return!1;this.currentEditLine=t;var e=t.getElement("table");if(this.currentEditLine){this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.table.inject(e,"after"),e.setStyle("display","none");var i=this.currentEditLine.getFirst("div").getLast("div").getElements("div");i[0]&&i[0].setStyle("display","none"),i[1]&&i[1].setStyle("display","none"),i[2]&&i[2].setStyle("display","none"),i[3]&&i[3].setStyle("display","block"),i[4]&&i[4].setStyle("display","block");var s=this.currentEditLine.getElement("table").retrieve("data");this.table.getElements("th").each(function(t,e){var i=t.get("id"),n=this.editModules[e];n&&("sequence"==n.json.type?n.node.set("text",this.currentEditLine.getElement("table").getElements("tr")[e].getElement("td").get("text")):s[i]?n.setData(s[i][n.json.id]):n.setData(null))}.bind(this)),this.fireEvent("editLine"),this.isEdit=!0}this.validationMode()},_loadAddAction:function(){this.addAction||(this.addAction=new Element("div",{styles:this.form.css.gridMobileActionNode}).inject(this.node,"top"),this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.addEvent("click",function(){this._addLine()}.bind(this)))},_addLine:function(){if(this.isEdit&&!this._completeLineEdit())return!1;this.addAction&&this.addAction.setStyle("display","none");var t,e=this.node.getElements("table"),i=new Element("div.datagridDataDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}});this.totalDiv?(t=e.length-2,i.inject(this.totalDiv,"before")):(t=e.length-1,i.inject(this.node)),this._createItemTitleNode(i,t);var s=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(i);this.table.setStyles({"background-color":"#fffeb5",display:"table"}),this.currentEditLine=null,this.table.inject(s),this.isEdit=!0;var n=i.getFirst("div").getLast("div").getElements("div");n[0]&&n[0].setStyle("display","none"),n[1]&&n[1].setStyle("display","none"),n[2]&&n[2].setStyle("display","none"),n[3]&&n[3].setStyle("display","block"),n[4]&&n[4].setStyle("display","block"),i.isIntoView()||i.scrollIntoView(!0),this.validationMode(),this.fireEvent("addLine",[this.table])},_cancelLineEdit:function(t){var e=this,i=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle,MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit,300,120,(function(){if(e.isEdit=!1,e.currentEditLine){e.currentEditLine.getElement("table").setStyle("display","table");var s=e.currentEditLine.getFirst("div").getLast("div").getElements("div");s[0]&&this.deleteable&&s[0].setStyle("display","block"),s[1]&&s[1].setStyle("display","block"),s[2]&&this.addable&&s[2].setStyle("display","block"),s[3]&&s[3].setStyle("display","none"),s[4]&&s[4].setStyle("display","none"),e._editorTrGoBack()}else{var n=t.target.getParent(".datagridDataDiv");e._editorTrGoBack(),n&&n.destroy()}e.editModules.each((function(t){!t||"Attachment"!=t.json.type&&"AttachmentDg"!=t.json.type||(t.attachmentController.attachments.each((function(t){e.form.workAction.deleteAttachment(t.data.id,e.form.businessData.work.id)})),t.attachmentController.clear())})),e.currentEditLine=null,i.gridData.data.length||(i.addAction?i.addable&&i.addAction.setStyle("display","block"):i.addable&&i._loadAddAction()),this.close(),e.fireEvent("cancelLineEdit")}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_completeLineEdit:function(t){if(!this.editValidation())return!1;this.isEdit=!1;var e,i=!1,s={},n=null;if(this.currentEditLine){n=this.currentEditLine,s=n.getElement("table").retrieve("data"),this.currentEditLine.getElement("table").setStyle("display","table"),e=n.getElement("table"),(a=this.currentEditLine.getFirst("div").getLast("div").getElements("div"))[0]&&this.deleteable&&a[0].setStyle("display","block"),a[1]&&a[1].setStyle("display","block"),a[2]&&this.addable&&a[2].setStyle("display","block"),a[3]&&a[3].setStyle("display","none"),a[4]&&a[4].setStyle("display","none")}else{var a,o=this.table.getParent(".datagridDataDiv");o&&o.removeClass("datagridDataDiv").addClass("dataDiv"),(a=this.table.getParent().getPrevious("div").getLast("div").getElements("div"))[0]&&this.deleteable&&a[0].setStyle("display","block"),a[1]&&a[1].setStyle("display","block"),a[2]&&this.addable&&a[2].setStyle("display","block"),a[3]&&a[3].setStyle("display","none"),a[4]&&a[4].setStyle("display","none"),(e=new Element("table",{styles:this.json.tableStyles}).inject(this.table,"before")).set(this.json.properties),s={}}var l=this.node.getElements("table"),d=this.table.getElements("th"),r=this.table.getElements("td"),h=e.getElements("tr");return d.each(function(t,n){var a=h[n],o=t.get("id"),d=this.editModules[n];if(d){var c,u;if("sequence"==d.json.type)this.currentEditLine?c=this.currentEditLine.getElement("table").getElements("tr")[n].getElement("td").get("text"):(c=l.length-1,this.totalTable&&(c=l.length-2)),m={value:[c],text:[c]};else if("Attachment"==d.json.type||"AttachmentDg"==d.json.type){i=!0;var m=d.getTextData();s[o]||(s[o]={}),s[o][d.json.id]=m}else(m=d.getTextData()).value.length<2?(s[o]||(s[o]={}),s[o][d.json.id]=m.value[0]):(s[o]||(s[o]={}),s[o][d.json.id]=m.value);if(a)if(u=a.getElement("td"),"ImageClipper"==d.json.type)this._createImage(u,d,m.text);else if("Attachment"==d.json.type||"AttachmentDg"==d.json.type)this._createAttachment(u,d,m);else{var f=this._getValueText(n,m.text.join(", "));d&&"Textarea"==d.json.type?u.set("html",f):u.set("text",f)}else{a=e.insertRow(n);var g=new Element("th").inject(a);g.set("text",t.get("text")),g.setStyle("width","30%"),(u=a.insertCell(1)).set("MWFId",r[n].get("id"));m[t.get("id")];if("ImageClipper"==d.json.type)this._createImage(u,d,m.text);else if("Attachment"==d.json.type||"AttachmentDg"==d.json.type)this._createAttachment(u,d,m);else{f=this._getValueText(n,m.text.join(", "));d&&"Textarea"==d.json.type?u.set("html",f):u.set("text",f)}}}else if(!a){a=e.insertRow(n);var p=new Element("th").inject(a);p.set("text",t.get("text")),p.setStyle("width","30%"),u=a.insertCell(1)}var v=this.form._getDomjson(t);v&&!1===v.isShow&&a.hide(),d=null}.bind(this)),e.store("data",s),e.setStyle("display","table"),this.currentEditLine=null,this._editorTrGoBack(),this.getData(),this._loadDatagridStyle(),this.validationMode(),this.fireEvent("completeLineEdit",[e]),this.addAction&&(this.addAction.set("text",MWF.xApplication.process.Xform.LP.addLine),this.addAction.removeEvents("click"),this.addAction.addEvent("click",function(){this._addLine()}.bind(this))),i&&this.form.saveFormData(),!0},_editorTrGoBack:function(){this.table.setStyle("display","none"),this.table.inject(this.node,"top")},_actionMousedown:function(t,e){t.retrieve("editStatus")||t.store("editStatus",new Date),this._checkMouseDown(t)},_checkMouseDown:function(t){var e=t.retrieve("editStatus");e&&((new Date).getTime()-e.getTime()>1e3?(this._editLine(t),t.eliminate("editStatus")):window.setTimeout(function(){this._checkMouseDown(t)}.bind(this),1e3))},_actionMouseup:function(t,e){t.eliminate("editStatus")},actionTouchstart:function(t,e){var i={x:e.touches[0].pageX,y:e.touches[0].pageY};t.retrieve("action")?t.store("touchStatus",{p:i,status:"hide",isHide:!1}):t.store("touchStatus",{p:i,status:"show"}),this._actionMousedown(t,e)},actionTouchmove:function(t,e){var i=t.retrieve("touchStatus"),s=i.p,n=i.status,a=e.touches[0].pageX,o=e.touches[0].pageY;(Math.abs(s.x-a)>10||Math.abs(s.y-o)>10)&&this._actionMouseup(t),"show"==n?s.x-a>20&&Math.abs(s.y-o)<40&&(this.showMoveAction(t,s.x-a),e.preventDefault()):a-s.x>20&&Math.abs(s.y-o)<40&&(i.isHide=!0,this.hideMoveAction(t,a-s.x),e.preventDefault())},actionTouchend:function(t,e){var i=t.retrieve("touchStatus");i.p;"show"==i.status?t.retrieve("action")&&this.showEndMoveAction(t):i.isHide&&this.hideEndMoveAction(t)},actionTouchcancel:function(t,e){this._actionMouseup(t)},showEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","60px"),new Fx.Tween(i,{duration:100}).start("margin-right","60px");var s=this;e.addEvent("click",(function(e){s._deleteLine(t,e)}))},_deleteLine:function(t,e){var i=!1,s=t.getElement("table");if(s){var n=this,a=this;this.form.confirm("warn",e,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){a.fireEvent("deleteLine",[s]);var e=s.retrieve("data");a.table.getElements("th").each((function(t,s){var n=t.get("id"),o=a.editModules[s];n&&o&&("Attachment"==o.json.type||"AttachmentDg"==o.json.type)&&(i=!0,e[n][o.json.id].each((function(t){a.form.workAction.deleteAttachment(t.id,a.form.businessData.work.id)})))})),t.destroy(),n._loadSequence(),n._loadTotal(),n.getData(),a.gridData.data.length||(a.addAction?a.addable&&a.addAction.setStyle("display","block"):a.addable&&a._loadAddAction()),this.close(),a.fireEvent("afterDeleteLine"),i&&a.form.saveFormData()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)}this.validationMode()},hideEndMoveAction:function(t){var e=t.retrieve("action"),i=t.getLast("div");new Fx.Tween(e,{duration:100}).start("width","0px"),new Fx.Tween(i,{duration:100}).start("margin-right","0px").chain((function(){e.destroy(),t.eliminate("action")}))},showMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div");if(!i){var n=t.getSize();i=new Element("div",{styles:this.form.css.gridMobileDeleteActionAreaNode}).inject(t,"top");new Element("div",{styles:this.form.css.gridMobileDeleteActionNode,text:MWF.xApplication.process.Xform.LP.delete}).inject(i);i.setStyle("height",n.y+"px"),i.setStyle("line-height",n.y+"px"),t.store("action",i)}e>60&&(e=60),i.setStyle("width",e+"px"),s.setStyle("margin-right",e+"px")},hideMoveAction:function(t,e){var i=t.retrieve("action"),s=t.getLast("div"),n=60-e;n<0&&(n=0),i&&i.setStyle("width",n+"px"),s.setStyle("margin-right",n+"px")},_loadDatagridStyle:function(){this.loadGridTitleStyle(),this.loadGridContentStyle(),this.loadGridEditStyle(),this._loadTotal(),this._loadBorderStyle(),this._loadZebraStyle(),this._loadSequence()},loadGridEditStyle:function(){this.table&&(this.json.editStyles&&this.table.getElements("td").setStyles(this.json.editStyles))},loadGridTitleStyle:function(){this.json.titleStyles&&this.node.getElements("th").setStyles(this.json.titleStyles)},loadGridContentStyle:function(){this.json.contentStyles&&this.node.getElements("td").setStyles(this.json.contentStyles)},_loadZebraStyle:function(){(this.json.zebraColor||this.json.backgroundColor)&&this.node.getElements("table").each(function(t){this._loadTableZebraStyle(t)}.bind(this))},_loadTableZebraStyle:function(t){for(var e=t.getElements("tr"),i=0;i<e.length;i++)this.json.backgroundColor&&e[i].setStyle("background-color",this.json.backgroundColor),i%2==0&&this.json.zebraColor&&e[i].setStyle("background-color",this.json.zebraColor)},createTotalDiv:function(){this.totalDiv=new Element("div.totalDiv",{styles:{overflow:"hidden","margin-bottom":"10px"}}).inject(this.node),new Element("div",{styles:this.json.itemTitleStyles}).inject(this.totalDiv).set("text",MWF.xApplication.process.Xform.LP.amount);var t=new Element("div",{styles:this.form.css.gridMobileTableNode}).inject(this.totalDiv);this.totalTable=new Element("table",{styles:this.json.tableStyles}).inject(t),this.totalTable.set(this.json.properties)},_loadTotal:function(){var t={};if(this.totalResaults={},this.totalModules.length){this.totalDiv||this.createTotalDiv();for(var e=[],i=this.node.getElements("table"),s=1;s<i.length-1;s++){var n=i[s].getElements("td");this.totalModules.each(function(i,s){e[s]||e.push(0);var a=new Decimal(e[s]);if("number"==i.type){var o=n[i.index].get("text").toFloat();a=a.plus(o||0)}"count"==i.type&&(a=a.plus(1)),e[s]=a.toString(),t[i.module.json.id]=e[s]}.bind(this))}var a=this.totalTable.getElements("tr");if(this.totalModules.each(function(t,i){var s=a[i];if(s)s.getElement("td").set("text",e[i]||"");else{s=this.totalTable.insertRow(i);var n=new Element("th").inject(s);n.set("text",t.module.node.get("text")),n.setStyles(this.json.titleStyles),s.insertCell(1).setStyles(this.json.amountStyles).set("text",e[i]||"")}!1===t.isShow&&s.hide(),this.totalResaults[t.module.json.id]=e[i]}.bind(this)),this.totalTable)this.totalTable.getElements("th").setStyles(this.json.titleStyles)}return t},_loadSequence:function(){this.node.getElements("table").each(function(t,e){t.getElements("td").each(function(t){var i=t.retrieve("module");i&&"sequence"==i.json.cellType&&t.set("text",e)}.bind(this))}.bind(this)),this.node.getElements(".sequenceDiv").each((function(t,e){t.set("text",MWF.xApplication.process.Xform.LP.item+(e+1))}))},_loadBorderStyle:function(){this.json.border&&this.node.getElements("table").each(function(t){this._loadTableBorderStyle(t)}.bind(this))},_loadTableBorderStyle:function(t){t.setStyles({"border-top":this.json.border,"border-left":this.json.border}),t.getElements("th").setStyles({"border-bottom":this.json.border,"border-right":this.json.border}),t.getElements("td").setStyles({"border-bottom":this.json.border,"border-right":this.json.border,background:"transparent"})},_loadDatagridTitleModules:function(){this.node.getElements("th").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=this.form._loadModule(e,t);this.form.modules.push(i)}}.bind(this))},_loadDatagridDataModules:function(){this.node.getElements("td").each(function(t){var e=this.form._getDomjson(t);if(t.store("dataGrid",this),e){var i=!1,s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),t.store("module",s),this.form.modules.push(s)}}.bind(this))},_afterLoaded:function(){this.moduleValueAG?this.moduleValueAG.then(function(){this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none")}.bind(this)):(this._loadDatagridStyle(),this.table&&this.table.setStyle("display","none"))},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.gridData=e,"array"==o2.typeOf(t)&&(t={data:t}),this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){if(this._setBusinessData(t),this.gridData=t,this.isEdit){if(this.isEdit=!1,this.currentEditLine)this._editorTrGoBack(),this.currentEditLine.destroy();else{var e=this.node.getElement(".datagridDataDiv");this._editorTrGoBack(),e&&e.destroy()}this.currentEditLine=null}if(this.gridData){for(var i=this.node.getElements(".dataDiv"),s=0;s<i.length;s++){for(var n=i[s].getElement("table"),a=n.getElements("td"),o=0;o<a.length;o++){var l=a[o].retrieve("module");l&&(this.form.modules.erase(l),l=null)}for(var d=n.getElements("th"),r=0;r<d.length;r++){var h=d[r].retrieve("module");h&&(this.form.modules.erase(h),h=null)}}for(s=0;s<i.length;s++)i[s].destroy();0!=this.editable?this._loadEditDatagrid():this._loadReadDatagrid(),this._loadDatagridStyle()}},getTotal:function(){return this._loadTotal(),this.totalResaults},isEmpty:function(){var t=this.getData();if(!t)return!0;if("object"===typeOf(t)){if("array"!==typeOf(t.data))return!0;if(0===t.data.length)return!0}return!1},getData:function(){if(0!=this.editable){this.isEdit&&this._completeLineEdit();for(var t=[],e=this.node.getElements("table"),i=1;i<(this.totalTable?e.length-1:e.length);i++){var s=e[i].retrieve("data");s&&t.push(s)}return this.gridData={},this.gridData.data=t,this._loadTotal(),this.gridData.total=this.totalResaults,this._setBusinessData(this.gridData),this.gridData.data.length?this.gridData:{data:[]}}return this._getBusinessData()},getAmount:function(){return this._loadTotal()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px","text-align":"left",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),n=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[n].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();"object"===typeOf(i)&&JSON.stringify(i)===JSON.stringify({data:[]})&&(i="");var s="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!s)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(s)return this.notValidationMode(e.prompt),!1;break;case"gt":if(s>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(s<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(s==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(s!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=s.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==s.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"==i.toString()||(this.notValidationMode(i),!1)}}),MWF.xApplication.process.Xform.DatagridMobile$Title=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid"),"number"!=this.json.total&&"count"!=this.json.total||this.dataGrid.totalModules.push({module:this,index:this.node.getParent("tr").rowIndex,type:this.json.total,isShow:this.json.isShow})}}),MWF.xApplication.process.Xform.DatagridMobile$Data=new Class({Extends:MWF.APP$Module,_afterLoaded:function(){this.dataGrid=this.node.retrieve("dataGrid");var t=this.node;if("sequence"==this.json.cellType){for(var e=!0,i=0;i<this.dataGrid.editModules.length;i++)if(this.dataGrid.editModules[i].json.id==this.json.id){e=!1;break}e&&this.dataGrid.editModules.push({json:{type:"sequence",id:this.json.id},node:t,focus:function(){}}),t.empty()}else{this.form._getModuleNodes(this.node).each(function(t){var e=this.form._getDomjson(t),i=!1;"Attachment"!=e.type&&"AttachmentDg"!=e.type||(e.type="AttachmentDg");var s=this.form._loadModule(e,t,(function(){i=this.field,this.field=!1}));i&&s.node.setStyle("padding-right","0px"),s.dataModule=this,this.dataGrid.editModules.push(s)}.bind(this))}}});