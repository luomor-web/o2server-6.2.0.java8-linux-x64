MWF.xDesktop.requireApp("process.Xform","$Module",null,!1),MWF.xApplication.process.Xform.Datatemplate=MWF.APPDatatemplate=new Class({Implements:[Events],Extends:MWF.APP$Module,isEdit:!1,options:{moduleEvents:["queryLoad","postLoad","load","afterLoad","beforeLoadLine","afterLoadLine","addLine","deleteLine","afterDeleteLine","export","import","validImport"]},initialize:function(t,e,i,s){this.node=$(t),this.node.store("module",this),this.json=e,this.form=i,this.field=!0},_loadUserInterface:function(){this.fireEvent("queryLoad"),this.editModules=[],this.node.setStyle("overflow-x","auto"),this.node.setStyle("overflow-y","hidden"),this.editable=!(this.readonly||!0===this.json.isReadonly),this.editable&&this.json.editableScript&&this.json.editableScript.code&&(this.editable=this.form.Macro.exec(this.json.editableScript?this.json.editableScript.code:"",this)),this.getRelativeId(),this.importenable=this.editable&&this.importActionIdList.length>0&&("impexp"===this.json.impexpType||"imp"===this.json.impexpType),this.exportenable=this.exportActionIdList.length>0&&("impexp"===this.json.impexpType||"exp"===this.json.impexpType),this.data=this._getValue(),this._getBusinessData()||(this.isNew=!0,this._setValue(this.data)),this.lineList=[],this._loadStyles(),this.getTemplate(),this.form.isLoaded||this.setOuterActionEvents(),this.node.getChildren().hide(),this.fireEvent("load"),this._loadDataTemplate(function(){this.fireEvent("postLoad")}.bind(this))},getRelativeId:function(){this.outerAddActionIdList=(this.json.outerAddActionId||"").split(","),this.outerDeleteActionIdList=(this.json.outerDeleteActionId||"").split(","),this.outerSelectAllIdList=(this.json.outerSelectAllId||"").split(","),this.addActionIdList=(this.json.addActionId||"").split(","),this.deleteActionIdList=(this.json.deleteActionId||"").split(","),this.sequenceIdList=(this.json.sequenceId||"").split(","),this.selectorId=this.json.selectorId,this.importActionIdList=(this.json.importActionId||"").split(","),this.exportActionIdList=(this.json.exportActionId||"").split(",")},getTemplate:function(){this.templateJson={},this.templateHtml=this.node.get("html"),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);this.templateJson[e.id]=e}}.bind(this))},_loadStyles:function(){this.node.setStyles(this.json.styles),this.node.set(this.json.properties)},_getOuterActionModules:function(t){var e=[];return t.each(function(t){var i=this._getModuleByPath(t),s=t.split("..").getLast();!this.templateJson.hasOwnProperty(s)&&i&&e.push(i)}.bind(this)),e},_setOuterActionEvents:function(){this.addActionList=this._getOuterActionModules([].concat(this.addActionIdList,this.outerAddActionIdList)),this.addActionList.each(function(t){t.node.addEvents({click:function(t){this._addLine(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.deleteActionList=this._getOuterActionModules([].concat(this.outerDeleteActionIdList)),this.deleteActionList.each(function(t){t.node.addEvents({click:function(t){this._deleteSelectedLine(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.selectAllList=this._getOuterActionModules(this.outerSelectAllIdList),this.selectAllList.each(function(t){t.node.addEvents({click:function(t){this._checkSelectAll(t)}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.selectAllSelector=this.selectAllList[0],this.selectAllSelector&&this.unselectAll(),this.importActionList=this._getOuterActionModules(this.importActionIdList),this.importActionList.each(function(t){t.node.addEvents({click:function(t){this.importFromExcel()}.bind(this)}),this.editable||t.node.hide()}.bind(this)),this.exportActionList=this._getOuterActionModules(this.exportActionIdList),this.exportActionList.each(function(t){t.node.addEvents({click:function(t){this.exportToExcel()}.bind(this)})}.bind(this))},setOuterActionEvents:function(){this.bindEvent=function(){this._setOuterActionEvents(),this.fireEvent("afterLoad"),this.form.removeEvent("afterModulesLoad",this.bindEvent)}.bind(this),this.form.addEvent("afterModulesLoad",this.bindEvent)},_getValue:function(){if(this.moduleValueAG)return this.moduleValueAG;var t=this._getBusinessData();if(t||(this.json.defaultData&&this.json.defaultData.code&&(t=this.form.Macro.exec(this.json.defaultData.code,this)),t.then||"object"===o2.typeOf(t)&&(t=[t])),!t){t=[];for(var e=this.json.defaultCount?this.json.defaultCount.toInt():0,i=0;i<e;i++)t.push({})}return t},getValue:function(){return this._getValue()},_setValue:function(t){if(t&&"function"==o2.typeOf(t.then)){var e=o2.promiseAll(t).then(function(t){this.__setValue(t)}.bind(this),(function(){}));this.moduleValueAG=e,e.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))}else this.moduleValueAG=null,this.__setValue(t)},__setValue:function(t){return this._setBusinessData(t),this.moduleValueAG=null,t},_loadDataTemplate:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this._loadLineList(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},_loadLineList:function(t){this.data.each(function(t,e){var i=this.isNew||"number"===o2.typeOf(this.newLineIndex)&&e===this.newLineIndex,s=new Element("div").inject(this.node),n=this._loadLine(s,t,e,i);this.lineList.push(n)}.bind(this)),this.newLineIndex=null,this.isNew=!1,t&&t()},isMax:function(){var t=this.json.maxCount?this.json.maxCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length>=t)},isMin:function(){var t=this.json.minCount?this.json.minCount.toInt():0;return!!(this.editable&&t>0&&this.lineList.length<=t)},_loadLine:function(t,e,i,s){var n=new MWF.xApplication.process.Xform.Datatemplate.Line(t,this,e,{index:i,indexText:(i+1).toString(),isEdited:this.editable,isNew:s});return this.fireEvent("beforeLoadLine",[n]),n.load(),this.fireEvent("afterLoadLine",[n]),n},_setLineData:function(t,e){var i=t.options.index,s=this.getData();s[i]=e,this.setData(s)},_addLine:function(t,e){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var s,n=this.getData();n.push(e||{});var o=n.length-1;return this.newLineIndex=o,this.setData(n),s=this.getLine(o),this.fireEvent("addLine",[{line:s,ev:t}]),s},_insertLine:function(t,e){if(this.isMax()){var i=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(i,"info"),!1}var s,n,o=e.options.index+1;return(s=this.getData()).splice(o,0,{}),this.newLineIndex=o,this.setData(s),n=this.getLine(o),this.fireEvent("addLine",[{line:n,ev:t}]),n},_insertLineByIndex:function(t,e,i){if(this.isMax()){var s=MWF.xApplication.process.Xform.LP.maxItemCountNotice.replace("{n}",this.json.maxCount);return this.form.notice(s,"info"),!1}var n=this.getData();if(n.length<e)return null;n.splice(e,0,i||{}),this.newLineIndex=e,this.setData(n);var o=this.getLine(e);return this.fireEvent("addLine",[{line:o,ev:t}]),o},_deleteSelectedLine:function(t){var e=this.lineList.filter((function(t){return t.selected}));if(0===e.length)return this.form.notice(MWF.xApplication.process.Xform.LP.selectItemNotice,"info"),!1;var i=this.json.minCount?this.json.minCount.toInt():0;if(i>0&&this.lineList.length-e.length<i){var s=MWF.xApplication.process.Xform.LP.minItemNotice.replace("{n}",i);return this.form.notice(s,"info"),!1}var n=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteSelectedItemNotice,300,120,(function(){n._delLines(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLines:function(t){var e=this,i=e.getData(),s=!1;t.reverse().each((function(t){e.fireEvent("deleteLine",[t]),t.deleteAttachment()&&(s=!0),i.splice(t.options.index,1),e.fireEvent("afterDeleteLine")})),e.setData(i),s&&this.form.saveFormData()},_deleteLine:function(t,e){if(this.isMin()){var i=MWF.xApplication.process.Xform.LP.minItemCountNotice.replace("{n}",this.json.minCount);return this.form.notice(i,"info"),!1}var s=this;this.form.confirm("warn",t,MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle,MWF.xApplication.process.Xform.LP.deleteDatagridLine,300,120,(function(){s._delLine(e),this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},_delLine:function(t){this.fireEvent("deleteLine",[t]);var e=t.deleteAttachment(),i=this.getData();i.splice(t.options.index,1),this.setData(i),this.fireEvent("afterDeleteLine"),e&&this.form.saveFormData()},_checkSelectAll:function(){var t,e=this.selectAllSelector.getData();t="array"===o2.typeOf(e)?e.contains(this.json.outerSelectAllSelectedValue):e===this.json.outerSelectAllSelectedValue,this.selected=t,this.lineList.each(function(t){this.selected?t.select():t.unselect()}.bind(this))},selectAll:function(){this.selected=!0,this.selectAllSelector&&this.selectAllSelector.setData(this.json.outerSelectAllSelectedValue)},unselectAll:function(){if(this.selected=!1,this.selectAllSelector.getOptionsObj){for(var t="",e=this.selectAllSelector.getOptionsObj().valueList||[],i=0;i<e.length;i++){var s=e[i];if(s!==this.json.outerSelectAllSelectedValue){t=s;break}}this.selectAllSelector.setData(t)}else this.selectAllSelector.setData("")},editValidation:function(){var t=!0;return this.editModules.each(function(e,i){"sequence"!==e.json.type&&e.validationMode&&(e.validationMode(),e.validation()||(t=!1))}.bind(this)),t},exportToExcel:function(){this.exporter=new MWF.xApplication.process.Xform.Datatemplate.Exporter(this),this.exporter.exportToExcel()},importFromExcel:function(){this.importer=new MWF.xApplication.process.Xform.Datatemplate.Importer(this),this.importer.importFromExcel()},_afterLoaded:function(){},resetData:function(){this.setData(this._getValue())},setData:function(t){t||(t=this._getValue()),this._setData(t)},_setData:function(t){var e=o2.promiseAll(this.data).then(function(e){return this.data=e,this.__setData(t),this.moduleValueAG=null,e}.bind(this),function(){this.moduleValueAG=null}.bind(this));this.moduleValueAG=e,this.moduleValueAG&&this.moduleValueAG.then(function(){this.moduleValueAG=null}.bind(this),function(){this.moduleValueAG=null}.bind(this))},__setData:function(t){this._setBusinessData(t),this.data=t,this.data&&this.clearSubModules(),this.lineList=[],this._loadDataTemplate(function(){this._setSubDatatemplateOuterEvents()}.bind(this))},_setSubDatatemplateOuterEvents:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].setSubDatatemplateOuterActionEvents()},clearSubModules:function(){for(var t=0;t<this.lineList.length;t++)this.lineList[t].clearSubModules()},isEmpty:function(){var t=this.getData();return!t||("array"===o2.typeOf(t)?0===t.length:"object"===o2.typeOf(t)&&0===Object.keys(t).length)},getLine:function(t){return this.lineList[t]||null},addLine:function(t){return this._addLine(null,t)},insertLine:function(t,e){return this._insertLineByIndex(null,t,e)},deleteLine:function(t,e){var i=this.lineList[t];if(!i)return null;this._delLine(i)},getModule:function(t,e){var i=this.lineList[t];return i?i.getModule(e):null},getData:function(){return this.importer&&this.importer.destroySimulateModule(),this.editable,this._getBusinessData()},createErrorNode:function(t){var e=new Element("div");new Element("div",{styles:{width:"20px",height:"20px",float:"left",background:"url(../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"}}).inject(e),new Element("div",{styles:{"line-height":"20px","margin-left":"20px",color:"red","word-break":"keep-all"},text:t}).inject(e);return e},notValidationMode:function(t){this.isNotValidationMode||(this.isNotValidationMode=!0,this.node.store("borderStyle",this.node.getStyles("border-left","border-right","border-top","border-bottom")),this.node.setStyle("border","1px solid red"),this.errNode=this.createErrorNode(t).inject(this.node,"after"),this.showNotValidationMode(this.node))},showNotValidationMode:function(t){var e=t.getParent("div");if(e){if("tab$Content"==e.get("MWFtype")&&"none"==e.getParent("div").getStyle("display")){var i=e.getParent("div").getParent("div"),s=i.getPrevious("div"),n=i.getChildren().indexOf(e.getParent("div"));s.getLast().getFirst().getChildren()[n].click(),e=s.getParent("div")}this.showNotValidationMode(e)}},validationMode:function(){this.isNotValidationMode&&(this.isNotValidationMode=!1,this.node.setStyles(this.node.retrieve("borderStyle")),this.errNode&&(this.errNode.destroy(),this.errNode=null))},validationConfigItem:function(t,e){if("all"==e.status||t==e.decision){var i=this.getData();if("object"===o2.typeOf(i)){var s=[];Object.each(i,(function(t,e){"array"===o2.typeOf(t)&&(s=s.concat(t))})),i=s}var n="value"==e.valueType?i:i.length;switch(e.operateor){case"isnull":if(!n)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(n)return this.notValidationMode(e.prompt),!1;break;case"gt":if(n>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(n<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(n==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(n!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=n.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==n.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0},validationConfig:function(t,e){if(this.json.validationConfig){if(this.json.validationConfig.length)for(var i=0;i<this.json.validationConfig.length;i++){var s=this.json.validationConfig[i];if(!this.validationConfigItem(t,s))return!1}return!0}return!0},validation:function(t,e){if(this.isEdit&&!this.editValidation())return!1;if(!this.validationConfig(t,e))return!1;if(!this.json.validation)return!0;if(!this.json.validation.code)return!0;this.currentRouteName=t;var i=this.form.Macro.exec(this.json.validation.code,this);return this.currentRouteName="",i||(i=MWF.xApplication.process.Xform.LP.notValidation),"true"===i.toString()||(this.notValidationMode(i),!1)},getAttachmentRandomSite:function(){var t=(new Date).getTime();return this.json.id+t}}),MWF.xApplication.process.Xform.Datatemplate.Line=new Class({Implements:[Options,Events],options:{isNew:!1,isEdited:!0,index:0,indexText:"0"},initialize:function(t,e,i,s){this.setOptions(s),this.node=t,this.template=e,this.data=i,this.form=this.template.form,this.modules=[],this.all={},this.all_templateId={},this.fields=[],this.allField={},this.allField_templateId={},this.addActionList=[],this.deleteActionList=[],this.sequenceNodeList=[],this.selector=null,this.importActionList=[],this.exportActionList=[],this.subDatatemplateModuleList=[]},load:function(){this.node.set("html",this.template.templateHtml),this.form._getModuleNodes(this.node).each(function(t){if("form"!==t.get("MWFtype")){var e=this,i=this.form._getDomjson(t);if(i){var s=Object.clone(i);this.options.isEdited||(s.isReadonly=!0);var n=s.id,o=this.options.index,a=this.template.json.id+".."+o+".."+s.id;s.id=a,t.set("id",a),"Attachment"!==s.type&&"AttachmentDg"!==s.type||(s.type="AttachmentDg",s.ignoreSite=!0,s.site=this.getAttachmentSite(s,n)),this.form.all[a]&&(this.form.all[a]=null),this.form.forms[a]&&(this.form.forms[a]=null);var l=this.form._loadModule(s,t,(function(){}));"Attachment"===s.type||"AttachmentDg"===s.type?l.addEvent("change",function(){e.form.saveFormData()}.bind(this)):"Datatemplate"===s.type&&this.subDatatemplateModuleList.push(l),this.form.modules.push(l),this.modules.push(l),this.all[a]=l,this.all_templateId[n]=l,l.field&&(this.allField[a]=l,this.allField_templateId[n]=l,this.fields.push(l)),this.setEvents(l,n)}}}.bind(this)),this.options.isNew&&(this.data=this.getData(),this.options.isNew=!1)},setSubDatatemplateOuterActionEvents:function(){this.subDatatemplateModuleList.each((function(t){t._setOuterActionEvents(),t._setSubDatatemplateOuterEvents()}))},getModule:function(t){return this.all_templateId[t]},getAttachmentSite:function(t,e){var i,s=64-(i="."+this.options.index+"."+(t.site||e)).length,n=this.template.json.id;return(n=n.length>s?n.substr(n.length-s,s):n)+i},setEvents:function(t,e){if(this.template.addActionIdList.contains(e)&&(this.addActionList.push(t),t.node.addEvent("click",function(t){this.template._insertLine(t,this)}.bind(this)),this.template.editable||t.node.hide()),this.template.deleteActionIdList.contains(e)&&(this.deleteActionList.push(t),t.node.addEvent("click",function(t){this.template._deleteLine(t,this)}.bind(this)),this.template.editable||t.node.hide()),this.template.selectorId===e&&(this.selector=t,t.node.addEvent("click",function(t){this.checkSelect()}.bind(this)),this.template.editable||t.node.hide(),this.unselect()),this.template.sequenceIdList.contains(e)){this.sequenceNodeList.push(t);var i=this.options.indexText;"label"===this.form.getModuleType(t)?t.node.set("text",i):t.set(i)}},checkSelect:function(){var t,e=this.selector.getData();t="array"===o2.typeOf(e)?e.contains(this.template.json.selectorSelectedValue):e===this.template.json.selectorSelectedValue,this.selected=t},select:function(){this.selected=!0,this.selector&&this.selector.setData(this.template.json.selectorSelectedValue)},unselect:function(){if(this.selected=!1,this.selector.getOptionsObj){for(var t="",e=this.selector.getOptionsObj().valueList||[],i=0;i<e.length;i++){var s=e[i];if(s!==this.template.json.selectorSelectedValue){t=s;break}}this.selector.setData(t)}else this.selector.setData("")},reload:function(){for(var t in this.all){var e=this.all[t];this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.empty(),this.load()},clearSubModules:function(){for(var t in this.all){var e=this.all[t];e.clearSubModules&&e.clearSubModules(),this.form.modules.erase(e),this.form.all[t]&&delete this.form.all[t],this.form.forms[t]&&delete this.form.forms[t]}this.node.destroy()},getData:function(){var t=this.data;for(var e in this.allField){var i=this.allField[e],s=e.split("..").getLast();"Attachment"===i.json.type||"AttachmentDg"===i.json.type?t[s]=i._getBusinessData():t[s]=i.getData()}return t},setData:function(t){this.template._setLineData(this,t)},deleteAttachment:function(){var t=!1;for(var e in this.allField){var i=this.allField[e];if("Attachment"===i.json.type||"AttachmentDg"===i.json.type)(i._getBusinessData()||[]).each(function(e){t=!0,this.form.workAction.deleteAttachment(e.id,this.form.businessData.work.id)}.bind(this))}return t}}),MWF.xApplication.process.Xform.Datatemplate.Exporter=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.template=t,this.form=this.template.form},exportToExcel:function(){var t=[],e=this.template.json.excelFieldConfig.map((function(t){return t.title}));t.push(e),this.template.lineList.each(function(e,i){t.push(this.getLineExportData(e,i))}.bind(this));var i=this.getColWidthArray(),s=this.getExcelName(),n={data:t,colWidthArray:i,title:s};this.template.fireEvent("export",[n]),new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).exportToExcel(n.data||t,n.title||s,n.colWidthArray||i,this.getDateIndexArray())},getLineExportData:function(t,e){var i=[];return this.template.json.excelFieldConfig.each(function(e){var s=t.all_templateId[e.field],n=s?s.json:"";if(s&&n&&this.isAvaliableField(n)){var o="";if(r=s.getData())switch(s.json.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":if("array"===o2.typeOf(r)){var a=[];r.each(function(t){"object"===o2.typeOf(t)?a.push(t.distinguishedName):a.push(t)}.bind(this)),o=a.join(", \n")}else o="object"===o2.typeOf(r)?r.distinguishedName:r;break;case"Combox":case"Address":o="array"===o2.typeOf(r)?r.join(", "):r;break;case"Checkbox":var l=s.getOptionsObj(),r="array"===o2.typeOf(r)?r:[r],h=[];r.each((function(t,e){var i=l.valueList.indexOf(t);h.push(i>-1?l.textList[i]:"")})),o=h.join(", ");break;case"Radio":case"Select":var d=(l=s.getOptionsObj()).textList.indexOf(r);o=d>-1?l.valueList[d]:"";break;case"Textarea":case"Calendar":default:o=r}else"Label"===n.type&&s.node&&(o=s.node.get("text"));o||"number"===o2.typeOf(o)||(o=""),i.push(o)}else i.push("")}.bind(this)),i},isAvaliableField:function(t){return!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(t.type)},getExcelName:function(){var t=(this.template.json.excelName&&this.template.json.excelName.code?this.form.Macro.exec(this.template.json.excelName.code,this):MWF.xApplication.process.Xform.LP.datatemplateExportDefaultName).split(".");return["xls","xlst"].contains(t[t.length-1].toLowerCase())&&t.splice(t.length-1),t.join(".")},getColWidthArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e){var i=this.form.json.moduleList[e.field];i?["Org","Reader","Author","Personfield","Orgfield"].contains(i.type)?t.push(340):"Address"===i.type?t.push(170):"Textarea"===i.type?t.push(260):"Htmleditor"===i.type?t.push(500):(i.type,t.push(150)):t.push(150)}.bind(this)),t},getDateIndexArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&"Calendar"===s.type&&t.push(i)}.bind(this)),t},exportWithImportDataToExcel:function(t,e){var i=[],s=this.template.json.excelFieldConfig.map((function(t){return t.title}));s.push(MWF.xApplication.process.Xform.LP.validationInfor),i.push(s),e.each(function(e,s){var n=[];t.each((function(t,i){n.push((e[t.text]||"").replace(/&#10;/g,"\n"))})),n.push(e.errorTextListExcel?e.errorTextListExcel.join("\n"):""),i.push(n)}.bind(this));var n=this.getColWidthArray();n.push(300);var o=this.getExcelName(),a={data:i,colWidthArray:n,title:o,withError:!0};this.template.fireEvent("export",[a]),new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).exportToExcel(a.data||i,a.title||o,a.colWidthArray||n,this.getDateIndexArray())}}),MWF.xApplication.process.Xform.Datatemplate.Importer=new Class({Implements:[Options,Events],options:{},initialize:function(t,e){this.setOptions(e),this.template=t,this.form=this.template.form},isAvaliableField:function(t,e,i){return!["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(t.type)},importFromExcel:function(){var t=this.getFieldArray(),e=this.getDateIndexArray(),i=this.getOrgTitleArray();new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template).upload(e,function(e){var s=function(){this.checkCount(e)&&(this.checkData(t,e)?this.importData(t,e):this.openErrorDlg(t,e),this.destroySimulateModule())}.bind(this);i.length>0?this.listAllOrgData(i,e,function(){s()}.bind(this)):s()}.bind(this))},destroySimulateModule:function(){this.simelateModuleMap&&(Object.keys(this.simelateModuleMap).each(function(t,e){var i=this.simelateModuleMap[t];if(i){var s=i.json.id;this.form.businessData.data.hasOwnProperty(s)&&delete this.form.businessData.data[s],delete this.simelateModuleMap[t]}}.bind(this)),this.simelateModuleMap=null,this.simulateNode&&(this.simulateNode.destroy(),this.simulateNode=null))},loadSimulateModule:function(){this.simelateModuleMap&&this.destroySimulateModule(),this.simelateModuleMap={},this.simulateNode=new Element("div").inject(this.template.node),this.simulateNode.hide(),this.simulateNode.set("html",this.template.templateHtml),this.form._getModuleNodes(this.simulateNode).each(function(t){if("form"!==t.get("MWFtype")){var e=this.form._getDomjson(t);if(e&&this.isAvaliableField(e)){var i=Object.clone(e),s=i.id;i.id="dtSimulate_"+i.id,t.set("id",i.id),MWF["APP"+i.type]||MWF.xDesktop.requireApp("process.Xform",i.type,null,!1);var n=new MWF["APP"+i.type](t,i,this.form);this.simelateModuleMap[s]=n,n.load()}}}.bind(this))},getFieldArray:function(){this.loadSimulateModule();var t=[];return this.template.json.excelFieldConfig.each(function(e,i){t.push({text:e.title,field:e.field,index:i,module:this.simelateModuleMap[e.field],json:this.form.json.moduleList[e.field]})}.bind(this)),t},getDateIndexArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&"Calendar"===s.type&&t.push(i)}.bind(this)),t},getOrgTitleArray:function(){var t=[];return this.template.json.excelFieldConfig.each(function(e,i){var s=this.form.json.moduleList[e.field];s&&["Org","Reader","Author","Personfield","Orgfield"].contains(s.type)&&t.push(e.title)}.bind(this)),t},parseImportedData:function(t,e){var i=[];return e.each(function(e){var s={};t.each(function(t,i){t.index;var n,o=t.module,a=t.json,l=t.text,r=e[l]||"";if(""===r||null==r)n="";else switch(a.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":var h=this.stringToArray(r);0===h.length?n=this.getOrgData(r):(n=[],h.each(function(t,e){var i=this.getOrgData(t);n.push(i)}.bind(this)));break;case"Combox":case"Address":h=this.stringToArray(r),n=0===h.length?h[0]:h;break;case"Checkbox":h=this.stringToArray(r);var d=o.getOptionsObj();h.each((function(t,e){var i=d.textList.indexOf(t);h[e]=i>-1?d.valueList[i]:t})),n=1===h.length?h[0]:h;break;case"Radio":case"Select":n=r.replace(/&#10;/g,"");var c=(d=o.getOptionsObj()).textList.indexOf(n);n=c>-1?d.valueList[c]:n;break;case"Textarea":n=r.replace(/&#10;/g,"\n");break;case"Calendar":var u;if((n=r.replace(/&#10;/g,""))&&new Date(n).isValid())u=a.format?a.format:"datetime"===a.selectType||"time"===a.selectType?"time"===a.selectType?"%H:%M":Locale.get("Date").shortDate+" %H:%M":Locale.get("Date").shortDate,n=Date.parse(n).format(u);break;default:n=r.replace(/&#10;/g,"")}s[a.id]=n}.bind(this)),i.push(s)}.bind(this)),i},stringToArray:function(t){return t.replace(/&#10;/g,",").split(/\s*,\s*/g).filter((function(t){return!!t}))},importData:function(t,e){var i=this.parseImportedData(t,e);this.template.fireEvent("import",[i]),this.template.setData(i),this.form.notice(MWF.xApplication.process.Xform.LP.importSuccess)},openErrorDlg:function(t,e){var i=this,s=function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,s){"style"===e?i.push(s+":"+t+";"):i.push(s+"='"+t+"'")})),i.join(" ")},n=["<table "+s(this.template.json.impExpTableProperties)+" style='"+s(this.template.json.impExpTableStyles,"style")+"'>"],o=s(this.template.json.impExpTableTitleStyles,"style");n.push("<tr>"),t.each((function(t,e){n.push("<th style='"+o+"'>"+t.text+"</th>")})),n.push("<th style='"+o+"'> "+MWF.xApplication.process.Xform.LP.validationInfor+"</th>"),n.push("</tr>");var a=Object.clone(this.template.json.impExpTableContentStyles);a["border-bottom"]||a.border||(a["border-bottom"]="1px solid #eee");var l=s(Object.merge(a,{"text-align":"left"}),"style");e.each(function(e,i){n.push("<tr>"),t.each((function(t,i){n.push("<td style='"+l+"'>"+(e[t.text]||"").replace(/&#10;/g,"<br/>")+"</td>")})),n.push("<td style='"+l+"'>"+(e.errorTextList?e.errorTextList.join("<br/>"):"")+"</td>"),n.push("</tr>")}.bind(this)),n.push("</table>");var r=this.template.json.impExpDlgWidth||1e3,h=this.template.json.impExpDlgHeight||700;r=r.toInt(),h=h.toInt();var d=new Element("div",{style:"padding:10px;",html:n.join("")}),c=o2.DL.open({style:this.form.json.dialogStyle||"user",title:MWF.xApplication.process.Xform.LP.importFail,content:d,offset:{y:0},isMax:!0,width:r,height:h,buttonList:[{type:"exportWithError",text:MWF.xApplication.process.Xform.LP.datagridExport,action:function(){i.exportWithImportDataToExcel(t,e)}},{type:"cancel",text:MWF.LP.process.button.cancel,action:function(){c.close()}}],onPostClose:function(){c=null}.bind(this)})},exportWithImportDataToExcel:function(t,e){new MWF.xApplication.process.Xform.Datatemplate.Exporter(this.template).exportWithImportDataToExcel(t,e)},checkCount:function(t){var e=MWF.xApplication.process.Xform.LP,i=!1,s=this.template.json.maxCount?this.template.json.maxCount.toInt():0;s>0&&t.length>s&&(i=!0);var n=!1,o=this.template.json.minCount?this.template.json.minCount.toInt():0;if(o>0&&t.length<o&&(n=!0),i){var a=e.importTooManyNotice.replace("{n1}",t.length).replace("{n2}",this.template.json.maxCount);return this.form.notice(a,"error"),!1}if(n){a=e.importTooFewNotice.replace("{n1}",t.length).replace("{n2}",this.template.json.minCount);return this.form.notice(a,"error"),!1}return!0},checkData:function(t,e){var i=!0,s=MWF.xApplication.process.Xform.LP,n=s.importValidationColumnText,o=s.importValidationColumnTextExcel,a=new MWF.xApplication.process.Xform.Datatemplate.ExcelUtils(this.template),l=this.parseImportedData(t,e,!0);e.each(function(e,r){var h=[],d=[],c=l&&l[r]?l[r]:[];t.each(function(t,i){var l=t.index,r=t.json,u=t.module,p=t.text,f=n.replace("{n}",l+1),m=o.replace("{n}",a.index2ColName(l)),v=e[p]||"",g=c[r.id]||"";if(v)switch(r&&r.type){case"Org":case"Reader":case"Author":case"Personfield":case"Orgfield":this.stringToArray(v).each(function(t,e){var i=this.getOrgData(t);i.errorText&&(h.push(f+i.errorText+s.fullstop),d.push(m+i.errorText+s.fullstop))}.bind(this));break;case"Number":isNaN(v)&&(h.push(f+v+s.notValidNumber+s.fullstop),d.push(m+v+s.notValidNumber+s.fullstop));break;case"Calendar":isNaN(v)&&!isNaN(Date.parse(v))||(h.push(f+v+s.notValidDate+s.fullstop),d.push(m+v+s.notValidDate+s.fullstop))}if(u&&u.setData&&"Address"!==r.type){var x=!1;["Org","Reader","Author","Personfield","Orgfield"].contains(r.type)&&"array"===o2.typeOf(g)&&g.length&&(x=g.some((function(t){return t.errorText}))),x||(u.setData(g),u.validationMode(),!u.validation()&&u.errNode&&(h.push(f+u.errNode.get("text")),d.push(m+u.errNode.get("text")),u.errNode.destroy()))}}.bind(this)),h.length>0&&(e.errorTextList=h,e.errorTextListExcel=d,i=!1)}.bind(this));var r={validted:i,data:e};return this.template.fireEvent("validImport",[r]),r.validted},getOrgData:function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":return this.identityMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@p":return this.personMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@u":return this.unitMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};case"@g":return this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem};default:return this.identityMap[t]||this.personMap[t]||this.unitMap[t]||this.groupMap[t]||{errorText:t+MWF.xApplication.process.Xform.LP.notExistInSystem}}},listAllOrgData:function(t,e,i){var s=[],n=[],o=[],a=[];if(t.length>0){var l,r,h,d;e.each(function(e,i){t.each(function(t,i){e[t]&&this.stringToArray(e[t]).each((function(t){switch((t=t.trim()).substr(t.length-2,2).toLowerCase()){case"@i":s.push(t);break;case"@p":n.push(t);break;case"@u":o.push(t);break;case"@g":a.push(t);break;default:s.push(t),n.push(t),o.push(t),a.push(t)}}))}.bind(this))}.bind(this));var c=function(){l&&r&&h&&d&&i&&i()};this.identityMap={},s.length?(s=s.unique(),o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:s},function(t){t.data.each(function(t){this.identityMap[t.matchKey]=t}.bind(this)),l=!0,c()}.bind(this))):(l=!0,c()),this.personMap={},n.length?(n=n.unique(),o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:n},function(t){t.data.each(function(t){this.personMap[t.matchKey]=t}.bind(this)),r=!0,c()}.bind(this))):(r=!0,c()),this.unitMap={},o.length?(o=o.unique(),o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:o},function(t){t.data.each(function(t){this.unitMap[t.matchKey]=t}.bind(this)),h=!0,c()}.bind(this))):(h=!0,c()),this.groupMap={},a.length?(a=a.unique(),o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({groupList:a},function(t){t.data.each(function(t){this.groupMap[t.matchKey]=t}.bind(this)),d=!0,c()}.bind(this))):(d=!0,c())}}}),MWF.xApplication.process.Xform.Datatemplate.ExcelUtils=new Class({initialize:function(t){this.datatemplate=t,this.form=t.form,FileReader.prototype.readAsBinaryString||(FileReader.prototype.readAsBinaryString=function(t){var e="",i=this,s=new FileReader;s.onload=function(t){for(var n=new Uint8Array(s.result),o=n.byteLength,a=0;a<o;a++)e+=String.fromCharCode(n[a]);i.content=e,i.onload()},s.readAsArrayBuffer(t)})},_loadResource:function(t){if(window.XLSX&&window.xlsxUtils)t();else{COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("../x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))}},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},index2ColName:function(t){if(t<0)return null;var e="";do{e.length>0&&t--;var i=t%26;e=String.fromCharCode(i+65)+e,t=(t-i)/26}while(t>0);return e},upload:function(t,e){var i=[];t.each(function(t){i.push(this.index2ColName(t))}.bind(this));var s=new Element("div");s.set("html",'<input name="file" type="file" accept="csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />'),s.getFirst().addEvent("change",function(){var t=n.files;if(t.length){var o=t.item(0);this.importFromExcel(o,function(t){e&&e(t),s.destroy()}.bind(this),i)}}.bind(this));var n=s.getFirst();n.click()},exportToExcel:function(t,e,i,s){this._loadResource(function(){var n=window.xlsxUtils.format2Sheet(t,0,0,null),o=window.xlsxUtils.format2WB(n,"sheet1",void 0),a=o.Sheets[o.SheetNames[0]],l=[];for(var r in t[0].each(function(t,e){i||l.push({wpx:100});var s=String.fromCharCode(97+e).toUpperCase();a[s+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s&&s.length&&s.each(function(t,e){s[e]=this.index2ColName(t)}.bind(this)),a)if("!"!==r.substr(0,1)){var h=a[r];if(h.s||(h.s={}),h.s.alignment||(h.s.alignment={}),h.s.alignment.wrapText=!0,s&&s.length){var d=r.replace(/\d+/g,"");r.replace(d,"")>1&&s.contains(d)&&(h.z="yyyy-mm-dd HH:MM:SS")}}i&&i.each((function(t){l.push({wpx:t})})),a["!cols"]=l,this._openDownloadDialog(window.xlsxUtils.format2Blob(o),e+".xlsx")}.bind(this))},importFromExcel:function(t,e,i){this._loadResource((function(){var s,n,o=new FileReader;o.onload=function(t){n=t?t.target.result:o.content;var a=(s=window.XLSX.read(n,{type:"binary"})).SheetNames[0];if(s.Sheets.hasOwnProperty(a)){var l=s.Sheets[a];if(i&&"array"==typeOf(i)&&i.length){var r;if(l["!range"])r=l["!range"].e.r;else{var h=l["!ref"].split(":");2===h.length&&(r=parseInt(h[1].replace(/[^0-9]/gi,"")))}if(r)for(var d=0;d<i.length;d++)for(var c=1;c<=r;c++){var u=l[i[d]+c];u&&(delete u.w,u.z="yyyy-mm-dd",window.XLSX.utils.format_cell(u))}}var p=window.XLSX.utils.sheet_to_json(l);e&&e(p)}},o.readAsBinaryString(t)}))}});