MWF.xApplication.process.Xform.widget=MWF.xApplication.process.Xform.widget||{},MWF.require("MWF.widget.Common",null,!1),MWF.require("MWF.widget.MWFRaphael",null,!1),MWF.xApplication.process.Xform.widget.Monitor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default"},initialize:function(t,e,s,o){this.setOptions(o),this.path="../x_component_process_Xform/widget/$Monitor/",this.cssPath="../x_component_process_Xform/widget/$Monitor/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(t),this.worklog=e,this.processid=s,this.load()},load:function(){this.logProcessChartNode=new Element("div",{styles:this.css.logProcessChartNode}).inject(this.container),this.logPathChartNode=new Element("div",{styles:this.css.logPathChartNode}).inject(this.container),this.checkMonitorOpen()},checkMonitorOpen:function(){for(var t=this.container,e=t.retrieve("module"),s=!1,o=!1;"none"===t.getStyle("display")&&(s=!0),e&&"Tab$Content"===e.json.type&&(o=!0),(!s||!o)&&(t=t.getParent());)o||(e=t.retrieve("module"));if(s)if(o){for(var i=0;i<e.tab.tab.pages.length&&e.tab.tab.pages[i].contentNode!==e.node;i++);e.tab.tab.pages[i].setOptions({onPostShow:function(){this.openProcess()}.bind(this)})}else this.openProcessChartAction=new Element("div",{styles:this.css.openProcessChartAction,text:"Show Process"}).inject(this.logProcessChartNode),this.openProcessChartAction.addEvent("click",function(t){this.openProcess(t)}.bind(this));else this.openProcess()},openProcess:function(){this.process||(this.logProcessChartNode.empty(),this.loadToolbar(),this.paperNode=new Element("div.paperNode",{styles:layout.mobile?this.css.paperNodeMobile:this.css.paperNode}).inject(this.logProcessChartNode),this.getProcess(function(t){this.processData=t.data,this.loadPaper()}.bind(this)))},loadToolbar:function(){MWF.require("MWF.widget.Toolbar",function(){this.toolbarNode=new Element("div").inject(this.logProcessChartNode),this.createToolbarNode("play.png","logPlay",""),this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:this.options.style},this),this.toolbar.load()}.bind(this))},createToolbarNode:function(t,e,s){new Element("div",{MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/tools/"+t,title:"",MWFButtonAction:e,MWFButtonText:"",MWFButtonDisable:s}).inject(this.toolbarNode)},logPlay:function(){this.process&&(this.isPlaying=!0,this.toolbar.childrenButton[0].setDisable(!0),this.processReturnStyle(),this.playBegin(),this.playToNextActivity())},playBegin:function(){var t="../x_component_process_Xform/widget/$Monitor/"+this.options.style+"/fly.png";this.playIcon=this.paper.image(t,this.process.begin.center.x-16,this.process.begin.center.y-16,32,32),this.playLogNode=null,this.playsStatus={index:0},this.isPlaying=!0},playGetNextActivity:function(){var t=this.worklog[this.playsStatus.index],e=t.fromActivityType;return{log:t,activity:"begin"==e.toLowerCase()?this.process.begin:this.process[e+"s"][t.fromActivity]}},playToNextActivity:function(t){var e=this.playGetNextActivity();0==this.playsStatus.index?this.playToActivityStop(e.activity,e.log):this.playMoveToActivity(e.activity,e.log,t)},playMoveToActivity:function(t,e,s){if(s){var o=[s.beginPoint];o=o.concat(s.positionPoints,[s.endPoint],[{x:t.center.x,y:t.center.y}]),this.playMoveByRoutePoint(o,function(){this.playToActivityStop(t,e,s)}.bind(this))}else this.playToActivityStop(t,e,s)},playMoveByRoutePoint:function(t,e){var s={x:this.playIcon.attr("x").toFloat(),y:this.playIcon.attr("y").toFloat()},o=t.shift(),i=MWFRaphael.getPointDistance(s,o)/.2;this.playIcon.animate({x:o.x-16,y:o.y-16},i,"linear",function(){t.length?this.playMoveByRoutePoint(t,e):e&&e()}.bind(this))},playToActivityStop:function(t,e,s){this.playIcon.attr({x:t.center.x-16,y:t.center.y-16}),e.connected?t.shap.attr(this.css.passedActivityShap):t.shap.attr(this.css.currentActivityShap);var o=this.process.routes[e.route];s&&(s.line.attr(this.css.passedRouteShap),s.point.attr(this.css.passedRouteFillShap),s.arrow.attr(this.css.passedRouteFillShap)),this.showPlayLog(t,e),this.playsStatus.index++,window.setTimeout(function(){this.worklog.length<=this.playsStatus.index?this.playStop():(this.playLogNode.destroy(),this.playLogNode=null,this.playToNextActivity(o))}.bind(this),2e3)},showPlayLog:function(t,e){var s=this.paperNode.getPosition(this.paperNode.getOffsetParent()),o=this.paperNode.getSize();this.playLogNode=this.createWorkLogNode([e]),this.playLogNode.setStyle("display","block");var i=this.getlogNodePosition(t,this.playLogNode,s,o);this.playLogNode.setPosition({x:i.x,y:i.y})},playStop:function(){this.playIcon.remove(),this.playLogNode&&this.playLogNode.destroy(),this.playLogNode=null,this.playsStatus={index:0},this.isPlaying=!1,this.toolbar.childrenButton[0].setDisable(!1),this.loadWorkLog()},processReturnStyle:function(){this.worklog.each(function(t){var e=t.fromActivityType,s="begin"==e.toLowerCase()?this.process.begin:this.process[e+"s"][t.fromActivity];s.shap.attr(s.style.shap),s.passedCount=0,s.worklogs=[];var o=this.process.routes[t.route];o&&(o.line.attr(this.process.css.route.line.normal),o.point.attr(this.process.css.route.decision.normal),o.arrow.attr(this.process.css.route.arrow.normal)),t.taskCompletedList&&t.taskCompletedList.length&&t.taskCompletedList.each(function(t){"appendTask"===t.processingType&&s.routes&&s.routes.length&&s.routes.each(function(e){t.routeName===e.data.name&&(e.line.attr(this.process.css.route.line.normal),e.point.attr(this.process.css.route.decision.normal),e.arrow.attr(this.process.css.route.arrow.normal))}.bind(this))}.bind(this)),s.countSet&&s.countSet.remove()}.bind(this))},loadPaper:function(){MWFRaphael.load(function(){if(this.paperInNode=new Element("div",{styles:this.css.paperInNode}).inject(this.paperNode),this.paper=Raphael(this.paperInNode,"98%","99%"),layout.mobile){var t=this.paper.canvas.getSize(),e=2*t.x,s=2*t.y;this.paper.canvas.set({viewBox:"0 0 "+e+" "+s,preserveAspectRatio:"xMinYMin meet"})}this.paper.container=this.paperNode,MWF.xDesktop.requireApp("process.ProcessDesigner","Process",function(){this.process=new MWF.APPPD.Process(this.paper,this.processData,this,{style:"flat",isView:!0,onPostLoad:function(){this.loadWorkLog(),this.fireEvent("postLoad")}.bind(this)}),this.process.load()}.bind(this))}.bind(this))},getProcess:function(t){this.action=MWF.Actions.get("x_processplatform_assemble_surface"),this.action.getProcess((function(e){t&&t(e)}),null,this.processid)},loadWorkLog:function(){this.countNodes=[];var t={};this.worklogToken={},this.worklog.each(function(e){this.worklogToken[e.fromActivityToken]=e;var s=e.fromActivityType,o="begin"==s.toLowerCase()?this.process.begin:this.process[s+"s"][e.fromActivity];e.connected?o.shap.attr(this.css.passedActivityShap):o.shap.attr(this.css.currentActivityShap);var i=this.process.routes[e.route];i&&(i.line.attr(this.css.passedRouteShap),i.point.attr(this.css.passedRouteFillShap),i.arrow.attr(this.css.passedRouteFillShap)),e.taskCompletedList&&e.taskCompletedList.length&&e.taskCompletedList.each(function(t){"appendTask"===t.processingType&&o.routes&&o.routes.length&&o.routes.each(function(e){t.routeName===e.data.name&&(e.line.attr(this.css.passedRouteShap),e.point.attr(this.css.passedRouteFillShap),e.arrow.attr(this.css.passedRouteFillShap))}.bind(this))}.bind(this));var n=e.taskCompletedList.length;n&&(o.passedCount=o.passedCount?o.passedCount+n:n),o.worklogs||(o.worklogs=[]),o.worklogs.push(e),t[e.fromActivity]||(t[e.fromActivity]=o)}.bind(this));var e=this.paperNode.getPosition(this.paperNode.getOffsetParent()),s=this.paperNode.getSize();Object.each(t,function(t){this.writePassCount(t),this.writeWorkLog(t,e,s)}.bind(this))},writePassCount:function(t){if(t.passedCount){var e=t.point.x+t.width,s=t.point.y,o=this.paper.circle(e,s,9);o.attr(this.css.activityPassedCount),text=this.paper.text(e,s,t.passedCount),text.attr(this.css.activityPassedCountText),t.countSet=this.paper.set(),t.countSet.push(o,text)}},writeWorkLog:function(t,e,s){var o=this;t.set.click(function(t){o.isPlaying||(this.process.selectedActivitys.length&&(this.noselected||(this.selected(),o.showWorklog(this,e,s)),this.noselected=!1),this.countSet&&this.countSet.toFront()),t.stopPropagation()}.bind(t)),t.set.mousedown(function(t){o.isPlaying||(this.process.selectedActivitys.length||(this.selected(),o.showWorklog(this,e,s)),this.countSet&&this.countSet.toFront()),t.stopPropagation()}.bind(t)),this.paper.canvas.addEvent("click",function(t){o.isPlaying||(this.unSelectedEvent?(this.currentSelected||this.selectedActivitys.length)&&(this.unSelected(t),o.hideCurrentWorklog()):this.unSelectedEvent=!0)}.bind(this.process))},getlogNodePosition:function(t,e,s,o){s.x=0,s.y=0;var i=e.getSize(),n=0,r=t.point.x+t.width+15+s.x;return tmpX=r+i.x,tmpX>s.x+o.x&&(r=t.point.x-i.x-15+s.x)<s.x?(n=t.point.y-i.y-15+s.y,r=t.center.x-i.x/2+s.x):(n=t.center.y-i.y/2+s.y)<s.y&&(n=s.y),{x:r,y:n}},showWorklog:function(t,e,s){this.hideCurrentWorklog(),t.worklogNode||(t.worklogNode=this.createWorkLogNode(t.worklogs)),this.currentWorklogNode=t.worklogNode,this.currentWorklogNode.setStyle("display","block");var o=this.getlogNodePosition(t,t.worklogNode,e,s);t.worklogNode.setPosition({x:o.x,y:o.y})},hideCurrentWorklog:function(){this.currentWorklogNode&&(this.currentWorklogNode.setStyle("display","none"),this.currentWorklogNode=null)},createWorkLogNode:function(t){var e=new Element("div",{styles:this.css.workLogNode});return t.each(function(t,s){var o=new Element("div",{styles:this.css.workLogWorkNode}).inject(e);if(s%2==0?o.setStyle("background-color","#FFF"):o.setStyle("background-color","#EEE"),t.taskCompletedList.length+t.taskList.length<1)if(t.connected){var i=new Element("div",{styles:this.css.workLogTaskNode}).inject(o),n="<div style='font-weight: bold'>"+MWF.xApplication.process.Xform.LP.systemProcess+" </div>";n+="<div style='text-align: right'>"+t.arrivedTime+"</div>",i.set("html",n)}else{i=new Element("div",{styles:this.css.workLogTaskNode}).inject(o),n="<div style='font-weight: bold; color: red'>"+MWF.xApplication.process.Xform.LP.systemProcess+" </div>";i.set("html",n)}else t.taskCompletedList.each(function(t){var e=new Element("div",{styles:this.css.workLogTaskNode}).inject(o),s="<div style='font-weight: bold'>"+t.person.substring(0,t.person.indexOf("@"))+": </div>";s+="<div style='margin-left: 10px'>["+(t.routeName||"")+"] "+t.opinion+"</div>",s+="<div style='text-align: right'>"+t.completedTime+"</div>",e.set("html",s)}.bind(this)),t.taskList.each(function(t){var e=new Element("div",{styles:this.css.workLogTaskNode}).inject(o),s="<div style='font-weight: bold; color: red'>"+t.person.substring(0,t.person.indexOf("@"))+" "+MWF.xApplication.process.Xform.LP.processing+" </div>";e.set("html",s)}.bind(this))}.bind(this)),e.inject(this.paperNode),e}}),MWF.xApplication.process.Xform.widget.Monitor.Animation=new Class({Implements:[Events],initialize:function(t,e){}});