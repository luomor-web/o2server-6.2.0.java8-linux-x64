MWF.xApplication.Selector=MWF.xApplication.Selector||{},MWF.xDesktop.requireApp("Selector","IdentityWidthDuty",null,!1),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty,options:{style:"default",count:0,title:"",dutys:[],units:[],values:[],zIndex:1e3,expand:!1,noUnit:!1,include:[],resultType:"",expandSubEnable:!0,selectAllEnable:!0,exclude:[],dutyUnitLevelBy:"duty",identitySortBy:"identityNumber",selectType:"identity"},setInitTitle:function(){this.setOptions({title:MWF.xApplication.Selector.LP.selectIdentity})},_init:function(){this.selectType="identity",this.className="IdentityWidthDutyCategoryByUnit"},getUnitUniqueFormDn:function(t){if(!t)return"";var i=t.split("@");return 3===i.length?i[1]:t},loadSelectItems:function(t){if("person"===this.options.resultType&&(this.titleTextNode?this.titleTextNode.set("text",MWF.xApplication.Selector.LP.selectPerson):this.options.title=MWF.xApplication.Selector.LP.selectPerson),this.options.disabled)this.afterLoadSelectItem();else if(this.options.dutys.length){this.loadInclude(function(){this.includeLoaded=!0,this.dutyLoaded&&this.afterLoadSelectItem()}.bind(this));for(var i=[],e=[],n=0;n<this.options.units.length;n++){var s=this.options.units[n];"string"===typeOf(s)?(i.push(s),e.push(this.getUnitUniqueFormDn(s))):(i.push(s.distinguishedName||s.unique||s.id||s.levelName),e.push(s.distinguishedName?this.getUnitUniqueFormDn(s.distinguishedName):s.unique||s.id||s.levelName))}this.unitStringList=i,this.unitUniqueList=e,o2.Actions.load("x_organization_assemble_express").UnitDutyAction.listIdentityWithUnitWithNameObject({nameList:this.options.dutys,unitList:i,recursiveUnit:!!this.options.expandSubEnable},function(t){this.allIdentityData=t.data,this._loadSelectItems(t.data)}.bind(this))}else this.afterLoadSelectItem()},_loadSelectItems:function(t){var i=this.listNestedUnitByIdentity(t);this.dataTree=i,this.uniqueIdentity(i),"duty"===this.options.dutyUnitLevelBy?(this.level1Container=[],this.options.units&&this.options.units.length&&this.options.units.each(function(t,i){var e=new Element("div").inject(this.itemAreaNode);this.level1Container.push(e)}.bind(this)),this._loadSelectItemsByDutyUnit(i)):this._loadSelectItemsByIdentityUnit(i),this.dutyLoaded=!0,this.includeLoaded&&this.afterLoadSelectItem()},_loadSelectItemsByIdentityUnit:function(t){if(t.unitList){this.sortUnit(t.unitList);for(var i=0;i<t.unitList.length;i++){var e=t.unitList[i],n=this._newItemCategory("ItemCategory",e,this,this.itemAreaNode);this.subCategorys.push(n)}}},sortUnit:function(t){"duty"===this.options.dutyUnitLevelBy&&this.options.units?t.sort(function(t,i){var e=this.getIndexFromUnitOption(t),n=this.getIndexFromUnitOption(i);return 0===t.orderNumber&&(t.orderNumber=-1),0===i.orderNumber&&(i.orderNumber=-1),(e=-1===e?9999999+(t.orderNumber||9999999):e)-(n=-1===n?9999999+(i.orderNumber||9999999):n)}.bind(this)):t.sort(function(t,i){return 0===t.orderNumber&&(t.orderNumber=-1),0===i.orderNumber&&(i.orderNumber=-1),(t.orderNumber||9999999)-(i.orderNumber||9999999)}.bind(this))},_loadSelectItemsByDutyUnit:function(t){if(t.unitList)for(var i=0;i<t.unitList.length;i++){var e=t.unitList[i];if(this.isUnitContain(e)){var n=this.itemAreaNode;if(this.level1Container&&this.level1Container.length){var s=this.getIndexFromUnitOption(e);s>-1&&this.level1Container.length>s&&this.level1Container[s]&&(n=this.level1Container[s])}var u=this._newItemCategory("ItemCategory",e,this,n);this.subCategorys.push(u)}else this._loadSelectItemsByDutyUnit(e)}},getIndexFromUnitOption:function(t){if(!this.unitStringList||!this.unitStringList.length)return-1;var i=-1;return-1==i&&t.distinguishedName&&(i=this.unitStringList.indexOf(t.distinguishedName)),-1==i&&t.id&&(i=this.unitStringList.indexOf(t.id)),-1==i&&t.unique&&(i=this.unitStringList.indexOf(t.unique)),-1==i&&t.levelName&&(i=this.unitStringList.indexOf(t.levelName)),-1==i&&t.unique&&(i=this.unitUniqueList.indexOf(t.unique)),-1==i&&!t.unique&&t.distinguishedName&&(i=this.unitUniqueList.indexOf(t.distinguishedName.split("@")[1]||"")),i},isUnitContain:function(t){if(0===this.options.units.length)return!0;this.unitFlagMap||(this.unitFlagMap={},this.options.units.each(function(t){t&&(this.unitFlagMap["string"===typeOf(t)?t:t.distinguishedName||t.id||t.unique||t.employee||t.levelName]=!0)}.bind(this))),this.unitUniqueMap||(this.unitUniqueMap={},this.unitUniqueList.each(function(t){t&&(this.unitUniqueMap[t]=!0)}.bind(this)));var i=this.unitFlagMap,e=this.unitUniqueMap,n=t.distinguishedName&&i[t.distinguishedName]||t.levelName&&i[t.levelName]||t.id&&i[t.id]||t.unique&&i[t.unique]||t.unique&&e[t.unique];if(!n&&!t.unique&&t.distinguishedName){var s=t.distinguishedName.split("@");3===s.length&&s[1]&&e[s[1]]&&(n=!0)}return n},getUnitOrderNumber:function(t){return this.allIdentityInUnitObject[t.levelName].orderNumber},listAllUnitObject:function(t,i){for(var e="duty"===this.options.dutyUnitLevelBy?"matchUnitLevelName":"unitLevelName",n=[],s=0;s<t.length;s++)for(var u=t[s][e].split("/"),o=[],r=0;r<u.length;r++){o.push(u[r]);var a=o.join("/");n.contains(a)||n.push(a)}o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){this.allUnitObject={},t.data.each(function(t){this.allUnitObject[t.levelName]=t}.bind(this)),i&&i()}.bind(this),null,!1)},listNestedUnitByIdentity:function(t){return this.listAllUnitObject(t),this._listNestedUnitByIdentity(t)},_listNestedUnitByIdentity:function(t){for(var i="duty"===this.options.dutyUnitLevelBy?"matchUnitLevelName":"unitLevelName",e={},n=0;n<t.length;n++){var s=!0;if(!this.isExcluded(t[n])){for(var u=t[n][i].split("/"),o=[],r=e,a=0;a<u.length;a++){o.push(u[a]);var d=o.join("/");if(this.isExcluded(this.allUnitObject[d]||{})){s=!1;break}r.unitList||(r.unitList=[]);for(var h=!1,l=0;l<r.unitList.length;l++)if(r.unitList[l].levelName==d){r=r.unitList[l],h=!0;break}if(!h){var c=this.allUnitObject[d]||{};c.matchLevelName=d,r.unitList.push(c),r=c}r.identityList||(r.identityList=[])}s&&r.identityList.push(t[n])}}return e},uniqueIdentity:function(t){var i={},e={},n=function(t,n){if(t.distinguishedName&&i[t.distinguishedName]||t.levelName&&i[t.levelName]||t.id&&i[t.id]||t.unique&&i[t.unique])return!0;var s="string"===typeOf(t)?t:t.distinguishedName||t.id||t.unique||t.employee||t.levelName;return i[s]=!0,e[s]=n+1,!1},s=function(t){var i=t.distinguishedName&&e[t.distinguishedName]||t.levelName&&e[t.levelName]||t.id&&e[t.id]||t.unique&&e[t.unique];return i||(i=0),i-1},u=[];if(t.identityList)for(var o=0;o<t.identityList.length;o++)if(n(t.identityList[o],o)){if("identityNumber"!==this.options.identitySortBy){var r=s(t.identityList[o]);if(r>-1){var a=t.identityList[r];a.otherMatchUnitDutyList||(a.otherMatchUnitDutyList=[]),a.otherMatchUnitDutyList.push({matchUnitDutyNumber:t.identityList[o].matchUnitDutyNumber,matchUnitDutyName:t.identityList[o].matchUnitDutyName})}}}else u.push(t.identityList[o]);if(t.identityList=u,this.options.isCheckStatus){var d=(t.matchLevelName||t.levelName||"").split("/"),h=[];for(o=0;o<d.length;o++){h.push(d[o]);var l=h.join("/"),c=this.allUnitObject[l];c&&(c.subNestedIdentityCount=(c.subNestedIdentityCount||0)+u.length)}}if(t.unitList)for(o=0;o<t.unitList.length;o++)this.uniqueIdentity(t.unitList[o])},createItemsSearchData:function(t){this.itemsSearchData?t&&t():(this.itemsSearchData=[],MWF.require("MWF.widget.PinYin",function(){var i=[],e=this;function n(t){t.identityList&&t.identityList.length&&t.identityList.each((function(t){!function(t){var n=t.distinguishedName||t.id||t.name||t.text;if(-1==i.indexOf(n)){var s=t.name||"";if(!s&&t.distinguishedName)s=t.distinguishedName.split("@")[0];var u=s.toPY().toLowerCase(),o=s.toPYFirst().toLowerCase();e.itemsSearchData.push({text:s,pinyin:u,firstPY:o,data:t}),i.push(n)}}(t)})),t.unitList&&t.unitList.length&&t.unitList.each((function(t){n(t)}))}this.dataTree.unitList.each(function(t){n(t)}.bind(this)),delete i,t&&t()}.bind(this)))},_scrollEvent:function(t){return!0},_getChildrenItemIds:function(){return null},_newItemCategory:function(t,i,e,n,s,u,o){return new MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit[t](i,e,n,s,u,o)},_listItemByKey:function(t,i,e){this.options.units.length&&(e={key:e,unitList:this.options.units}),this.orgAction.listIdentityByKey(function(i){t&&t.apply(this,[i])}.bind(this),i,e)},_getItem:function(t,i,e,n){"string"===typeOf(e)?this.orgAction.getIdentity(function(i){t&&t.apply(this,[i])}.bind(this),i,"string"===typeOf(e)?e:e.distinguishedName,n):t&&t.apply(this,[e])},_newItemSelected:function(t,i,e,n){return new MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.ItemSelected(t,i,e,n)},_listItemByPinyin:function(t,i,e){this.options.units.length&&(e={key:e,unitList:this.options.units}),this.orgAction.listIdentityByPinyin(function(i){t&&t.apply(this,[i])}.bind(this),i,e)},_newItem:function(t,i,e,n,s,u){return new MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.Item(t,i,e,n,s,u)},_newItemSearch:function(t,i,e,n){return new MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.SearchItem(t,i,e,n)}}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.Item=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.Item}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.SearchItem=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.SearchItem}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.ItemSelected=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.ItemSelected}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.ItemCategory=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.ItemCategory,_getShowName:function(){return this.data.name},_addSelectedCount:function(t,i){var e=(this._getSelectedCount()||0)+t;this.selectedCount=e,this.checkCountAndStatus(e),i&&this.category&&this.category._addSelectedCount&&this.category._addSelectedCount(t,i)},_getTotalCount:function(){return this.data.subNestedIdentityCount},_getSelectedCount:function(){return"number"===typeOf(this.selectedCount)?this.selectedCount:0},_checkStatus:function(){},isExisted:function(t){if(!t)return!0;this.createdItemObject||(this.createdItemObject={});var i=this.createdItemObject;return!!(t.distinguishedName&&i[t.distinguishedName]||t.levelName&&i[t.levelName]||t.id&&i[t.id]||t.unique&&i[t.unique])||(this.createdItemObject["string"===typeOf(t)?t:t.distinguishedName||t.id||t.unique||t.employee||t.levelName]=!0,!1)},sortIdentityList:function(){if("identityNumber"===this.selector.options.identitySortBy)this.data.identityList.sort((function(t,i){return 0===t.orderNumber&&(t.orderNumber=-1),0===i.orderNumber&&(i.orderNumber=-1),(t.orderNumber||9999999)-(i.orderNumber||9999999)}));else{var t=function(t){var i="999";if(t.matchUnitDutyName){var e=this.selector.options.dutys.indexOf(t.matchUnitDutyName);e>-1&&(i=e.toString())}return"number"===typeOf(t.matchUnitDutyNumber)?i+=t.matchUnitDutyNumber.toString():i+="9999",i.toInt()}.bind(this),i=function(i){if(i.otherMatchUnitDutyList&&i.otherMatchUnitDutyList.length){var e=[t(i)];return i.otherMatchUnitDutyList.each((function(i){e.push(t(i))})),e.min()}return t(i)}.bind(this);this.data.identityList.sort((function(t,e){return i(t)-i(e)}))}},loadSub:function(t){this._loadSub(function(i){if(i&&(this.selector.options.showSelectedCount||this.selector.options.isCheckStatus)){var e=0;this.subCategorys.each((function(t){var i=t.subItems.filter((function(t){return t.isSelected}));e+=i.length}));var n=this.subItems.filter((function(t){return t.isSelected}));this.selectedCount=e+n.length,this.checkCountAndStatus(this.selectedCount)}t&&t()}.bind(this))},_loadSub:function(t){this.loaded?t&&t():(this.itemLoaded||(this.data.identityList&&this.data.identityList.length>0&&(this.sortIdentityList(),this.data.identityList.each(function(t){var i=this.selector._newItem(t,this.selector,this.children,this.level+1,this);this.selector.items.push(i),this.subItems&&this.subItems.push(i)}.bind(this))),this.itemLoaded=!0),this.categoryLoaded||(this.data.unitList&&this.data.unitList.length&&(this.data.unitList.sort((function(t,i){return 0===t.orderNumber&&(t.orderNumber=-1),0===i.orderNumber&&(i.orderNumber=-1),(t.orderNumber||9999999)-(i.orderNumber||9999999)})),this.data.unitList.each(function(t){var i=this.selector._newItemCategory("ItemCategory",t,this.selector,this.children,this.level+1,this);this.subCategorys.push(i)}.bind(this))),this.categoryLoaded=!0),this.loaded=!0,t&&t(!0))},loadCategoryChildren:function(t){this.categoryLoaded||(this.loadSub(),this.categoryLoaded=!0,this.itemLoaded=!0),t&&t()},loadItemChildren:function(t){this.itemLoaded||(this.data.identityList&&this.data.identityList.length>0&&(this.sortIdentityList(),this.data.identityList.each(function(t){var i=this.selector._newItem(t,this.selector,this.children,this.level+1,this);this.selector.items.push(i),this.subItems&&this.subItems.push(i)}.bind(this))),this.itemLoaded=!0),t&&t()},_hasChild:function(){return this.data.unitList&&this.data.unitList.length>0||this.data.identityList&&this.data.identityList.length>0},_hasChildCategory:function(){return this.data.unitList&&this.data.unitList.length>0},_hasChildItem:function(){return this.data.identityList&&this.data.identityList.length>0}}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.ItemUnitCategory=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.ItemUnitCategory}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.ItemGroupCategory=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.ItemGroupCategory}),MWF.xApplication.Selector.IdentityWidthDutyCategoryByUnit.Filter=new Class({Extends:MWF.xApplication.Selector.IdentityWidthDuty.Filter});