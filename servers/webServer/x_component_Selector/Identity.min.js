MWF.xApplication.Selector=MWF.xApplication.Selector||{},MWF.xDesktop.requireApp("Selector","Person",null,!1),MWF.xApplication.Selector.Identity=new Class({Extends:MWF.xApplication.Selector.Person,options:{style:"default",count:0,title:"",units:[],values:[],dutys:[],zIndex:1e3,expand:!1,noUnit:!1,include:[],exclude:[],resultType:"",expandSubEnable:!0,selectAllEnable:!0},setInitTitle:function(){this.setOptions({title:MWF.xApplication.Selector.LP.selectIdentity})},_init:function(){this.selectType="identity",this.className="Identity"},loadSelectItems:function(){if(this.options.disabled)this.afterLoadSelectItem();else if("Identity"===this.className&&(this.options.isCheckStatus||this.options.showSelectedCount)){var t=[],e=[],i=function(){this.options.include.length>0&&this.options.include.each((function(i){var s="string"===typeOf(i)?i:i.distinguishedName,n=s.split("@").getLast().toLowerCase();"u"===n?t.push(s):"g"===n&&e.push(s)}))}.bind(this),s=function(){var i,s,n,o,a,d;this.unitExcludedIdentityCount={},this.groupExcludedIdentityCount={},this.unitSelectedIdentityCount={},this.groupSelectedIdentityCount={};var l=function(){i&&s&&n&&o&&this.caculateNestedSubCount(a,d,function(){this._loadSelectItems()}.bind(this))}.bind(this);this.getIdentityCountMap(this.options.values,e&&e.length>0,function(t){this.unitSelectedIdentityCount=t.unitMap,this.groupSelectedIdentityCount=t.groupMap,n=!0,l()}.bind(this)),this.getIdentityCountMap(this.options.exclude,e&&e.length>0,function(t){this.unitExcludedIdentityCount=t.unitMap,this.groupExcludedIdentityCount=t.groupMap,o=!0,l()}.bind(this)),t&&t.length>0?o2.Actions.load("x_organization_assemble_express").UnitAction.listWithUnitTree({unitList:t},function(t){a=t.data,i=!0,l()}.bind(this)):(i=!0,l()),e&&e.length>0?o2.Actions.load("x_organization_assemble_express").GroupAction.listWithGroupTree({groupList:e},function(t){d=t.data,s=!0,l()}.bind(this)):(s=!0,l())}.bind(this);this.options.noUnit?(i(),s()):this.options.units.length?(i(),this.options.units.each(function(e){t.push("string"===typeOf(e)?e:e.distinguishedName||e.id||e.unique||e.levelName)}.bind(this)),s()):this.orgAction.listTopUnit(function(e){this.topUnitObj=e.data,this.topUnitObj.each(function(e){t.push(e.distinguishedName)}.bind(this)),s()}.bind(this))}else this._loadSelectItems()},_loadSelectItems:function(t){var e=this.afterLoadSelectItem.bind(this);if("person"===this.options.resultType&&(this.titleTextNode?this.titleTextNode.set("text",MWF.xApplication.Selector.LP.selectPerson):this.options.title=MWF.xApplication.Selector.LP.selectPerson),this.options.noUnit)this.loadInclude(e);else if(this.options.units.length){var i=function(){this.unitLoaded=!0,this.includeLoaded&&e()}.bind(this),s=i;this.loadInclude(function(){this.includeLoaded=!0,this.unitLoaded&&e()}.bind(this));for(var n=[],o=0;o<this.options.units.length;o++){var a=this.options.units[o];"string"===typeOf(a)?n.push(a):"object"===typeOf(a)&&n.push(a.id||a.distinguishedName||a.unique||a.levelName)}o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({unitList:n},function(t){t.data.length&&t.data.each(function(t){var e=this._newItemCategory("ItemUnitCategory",t,this,this.itemAreaNode);this.subCategorys.push(e)}.bind(this)),i()}.bind(this),s)}else{var d=function(t){t.each(function(t){if(!this.isExcluded(t)){var e=this._newItemCategory("ItemUnitCategory",t,this,this.itemAreaNode);this.subCategorys.push(e)}}.bind(this)),e()}.bind(this);this.topUnitObj?d(this.topUnitObj):this.orgAction.listTopUnit(function(t){d(t.data)}.bind(this))}},loadInclude:function(t){this.includeObject||(this.includeObject=new MWF.xApplication.Selector.Identity.Include(this,this.itemAreaNode,{include:this.options.include,resultType:this.options.resultType,expandSubEnable:this.options.expandSubEnable,onAfterLoad:t})),this.includeObject.load()},checkLoadSelectItems:function(){this.options.units.length,this.loadSelectItems()},_scrollEvent:function(t){return!0},_getChildrenItemIds:function(){return null},_newItemCategory:function(t,e,i,s,n,o,a){return new MWF.xApplication.Selector.Identity[t](e,i,s,n,o,a)},_listItem:function(t,e,i,s){if(this.options.noUnit)this.includeObject.listByFilter(t,s,function(t){var i={data:t};e&&e.apply(this,[i])}.bind(this));else{var n="key"===t?"listIdentityByKey":"listIdentityByPinyin";this.options.units.length?(s=this.getLikeKey(s,this.options.units),this.orgAction[n](function(i){this.includeObject.listByFilter(t,s,function(t){i.data=t.concat(i.data||[]),e&&e.apply(this,[i])}.bind(this))}.bind(this),i,s)):this.orgAction[n](function(t){e&&e.apply(this,[t])}.bind(this),i,s)}},_listItemByKey:function(t,e,i){this._listItem("key",t,e,i)},_getItem:function(t,e,i,s){this.orgAction.getIdentity(function(e){t&&t.apply(this,[e])}.bind(this),e,"string"===typeOf(i)?i:i.distinguishedName,s)},_newItemSelected:function(t,e,i,s){return new MWF.xApplication.Selector.Identity.ItemSelected(t,e,i,s)},_listItemByPinyin:function(t,e,i){this._listItem("pinyin",t,e,i)},_newItem:function(t,e,i,s,n,o){return new MWF.xApplication.Selector.Identity.Item(t,e,i,s,n,o)},_newItemSearch:function(t,e,i,s){return new MWF.xApplication.Selector.Identity.SearchItem(t,e,i,s)},getLikeKey:function(t,e){var i=[];(e=e||[]).each((function(t){"string"===typeOf(t)&&i.push(t),"object"===typeOf(t)&&i.push(t.distinguishedName)}));var s={key:t,unitList:i};if(!this.dutyDnList){var n=[],o=[];(this.options.dutys||[]).each((function(t){if("string"===typeOf(t)){var e=t.split("@");"UD"===e[e.length-1].toUpperCase()?n.push(t):o.push(t)}"object"===typeOf(t)&&(t.distinguishedName?n.push(t.distinguishedName):t.name&&o.push(t.name))})),o.length&&o2.Actions.get("x_organization_assemble_express").listDutyWithName({nameList:o},function(t){t.data&&t.data.unitDutyList&&(n=n.concat(t.data.unitDutyList))}.bind(this),null,!1),this.dutyDnList=n}return this.dutyDnList.length&&(s.unitDutyList=this.dutyDnList),i.length?s:t},getIdentityAllLevelName:function(t,e,i){var s={unitMap:{},groupMap:{}};this.listIndetityObject(t,function(t,n){t.each(function(t){t.unitLevelName&&(s.unitMap[t.unitLevelName]=(s.unitMap[t.unitLevelName]||0)+1)}.bind(this)),e?this.listLevelNameGroupMap(t,function(t){for(var e in t){var n=t[e].identityList.length;n&&(s.groupMap[e]=n)}i&&i(s)}.bind(this)):i&&i(s)}.bind(this))},getIdentityCountMap:function(t,e,i){var s={unitMap:{},groupMap:{}};this.listIndetityObject(t,function(t,n){t.each(function(t){t.unitLevelName&&(s.unitMap[t.unitLevelName]=(s.unitMap[t.unitLevelName]||0)+1)}.bind(this)),e?this.listLevelNameGroupMap(t,function(t){for(var e in t){var n=t[e].identityList.length;n&&(s.groupMap[e]=n)}i&&i(s)}.bind(this)):i&&i(s)}.bind(this))},listIndetityObject:function(t,e){var i=[];t.each((function(t){"object"===typeOf(t)?t.unitLevelName&&t.distinguishedName||i.push(t.distinguishedName||t.id||t.unique):i.push(t)})),i.length>0?o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:i},function(i){var s={};i.data.each((function(t){s[t.matchKey]=t}));var n=[];t.each((function(t){var e="object"===typeOf(t)?t.distinguishedName||t.id||t.unique:t;n.push(s[e]?s[e]:t)})),e&&e(n,s)}.bind(this)):e&&e(t,{})},listLevelNameGroupMap:function(t,e,i,s){var n=t.map((function(t){return t.distinguishedName})).clean();n.length>0?o2.Actions.load("x_organization_assemble_express").GroupAction.listWithIdentityObject({recursiveGroupFlag:!0,identityList:n,referenceFlag:!!i,recursiveOrgFlag:!!s},function(t){var i={},s=t.data;s.each((function(t){i[t.distinguishedName]=t})),s.each((function(t){t.identityList=t.identityList.filter((function(t){return n.contains(t)})),t.groupObjectList=[],t.groupList.each((function(e){i[e]&&t.groupObjectList.push(i[e])}))}));var o={},a=function(t,e){var i=e?e+"/"+t.name:t.name;o[i]=t,t.groupObjectList.each((function(t){a(t,i)}))};s.each((function(t){a(t)})),e&&e(o)}.bind(this)):e&&e({})},caculateNestedSubCount:function(t,e,i){if(this.allUnitObject||(this.allUnitObject={}),this.allGroupObject||(this.allGroupObject={}),this.allGroupObjectByDn||(this.allGroupObjectByDn={}),e&&e.length&&e.each(function(t){this.caculateGroupNestedCount(t)}.bind(this)),t&&t.length&&t.each(function(t){this.allUnitObject[t.levelName]||this.caculateUnitNestedCount(t)}.bind(this)),this.allGroupObject)for(var s in this.allGroupObject){var n=this.allGroupObject[s];this.allGroupObjectByDn[n.distinguishedName]=n}i&&i()},caculateGroupNestedCount:function(t,e){if(!this.isExcluded(t)){var i=e?e+"/"+t.distinguishedName.split("@")[0]:t.distinguishedName.split("@")[0];if(!this.allGroupObject[i]){this.allGroupObject[i]=t;var s=t.subDirectIdentityCount;this.groupExcludedIdentityCount&&this.groupExcludedIdentityCount[i]&&(s=(s||0)-this.groupExcludedIdentityCount[i]);var n=0;this.groupSelectedIdentityCount&&this.groupSelectedIdentityCount[i]&&(n=this.groupSelectedIdentityCount[i]);var o=i.split("/"),a=[];o.each(function(t){a.push(t);var e=a.join("/"),i=this.allGroupObject[e];i&&(i.subNestedIdentityCount=(i.subNestedIdentityCount||0)+s,i.selectedNestedIdentityCount=(i.selectedNestedIdentityCount||0)+n)}.bind(this)),t.subGroups.each(function(t){this.caculateGroupNestedCount(t,i)}.bind(this)),t.subUnits.each(function(t){var e=this.allUnitObject[t.levelName];this.caculateUnitNestedCount(t,i,!!e)}.bind(this))}}},caculateUnitNestedCount:function(t,e,i){if(!this.isExcluded(t)){var s,n;if(this.allUnitObject[t.levelName]){if(!i)return;s=this.allUnitObject[t.levelName].subNestedIdentityCount||0,s=this.allUnitObject[t.levelName].selectedNestedIdentityCount||0}else this.allUnitObject[t.levelName]=t,s=t.subDirectIdentityCount,this.unitExcludedIdentityCount&&this.unitExcludedIdentityCount[t.levelName]&&(s=(s||0)-this.unitExcludedIdentityCount[t.levelName]),n=0,this.unitSelectedIdentityCount&&this.unitSelectedIdentityCount[t.levelName]&&(n=this.unitSelectedIdentityCount[t.levelName]);if(e){var o=e.split("/"),a=[];o.each(function(t){a.push(t);var e=a.join("/"),i=this.allGroupObject[e];i&&(i.subNestedIdentityCount=(i.subNestedIdentityCount||0)+s,i.selectedNestedIdentityCount=(i.selectedNestedIdentityCount||0)+n)}.bind(this))}if(!i){var d=t.levelName.split("/"),l=[];d.each(function(t){l.push(t);var e=l.join("/"),i=this.allUnitObject[e];i&&(i.subNestedIdentityCount=(i.subNestedIdentityCount||0)+s,i.selectedNestedIdentityCount=(i.selectedNestedIdentityCount||0)+n)}.bind(this)),t.subUnits.each(function(t){this.caculateUnitNestedCount(t,e)}.bind(this))}}}}),MWF.xApplication.Selector.Identity.Item=new Class({Extends:MWF.xApplication.Selector.Person.Item,_getShowName:function(){return this.data.name},_getTtiteText:function(){return this.data.name+(this.data.unitLevelName?"("+this.data.unitLevelName+")":"")},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/personicon.png)")},getData:function(t,e){if("person"===this.selector.options.resultType){var i=!1;if(this.data&&this.data.distinguishedName){var s=this.data.distinguishedName;"p"===s.substr(s.length-1,1).toLowerCase()&&(i=!0)}i?t&&t():this.data.woPerson?(this.data=this.data.woPerson,t&&t()):this.data.person?this.selector.orgAction.getPerson(function(e){this.data=e.data,t&&t()}.bind(this),null,this.data.person):t&&t()}else{if(this.selector.options.ignorePerson||"simple"===this.selector.options.storeRange)return void(t&&t());!e&&t&&t(),this.data.woPerson||this.data.personDn&&this.data.personEmployee&&this.data.personUnique?e&&t&&t():this.selector.orgAction.getPerson(function(i){this.data.woPerson=i.data,e&&t&&t()}.bind(this),null,this.data.person)}},checkSelectedSingle:function(){var t="person"===this.selector.options.resultType;this.selector.options.values.filter(function(e,i){return t?"object"===typeOf(e)&&(e.id&&e.id===this.data.person||e.person&&e.person===this.data.id||this.data.distinguishedName&&this.data.distinguishedName===e.distinguishedName):"object"===typeOf(e)?this.data.distinguishedName===e.distinguishedName:"string"===typeOf(e)&&this.data.distinguishedName===e}.bind(this)).length&&this.selectedSingle()},checkSelected:function(){var t="person"===this.selector.options.resultType,e=this.selector.selectedItems.filter(function(e,i){return t?e.data.id&&e.data.id===this.data.person||e.data.person&&e.data.person===this.data.id||e.data.distinguishedName&&e.data.distinguishedName===this.data.distinguishedName:e.data.distinguishedName===this.data.distinguishedName}.bind(this));e.length&&(e[0].addItem(this),this.selectedItem=e[0],this.setSelected(),("all"===this.selector.options.selectAllRange||"identity"==this.selector.selectType&&(this.selector.options.showSelectedCount||this.selector.options.isCheckStatus))&&this.category&&this.category._addSelectedCount&&this.category._addSelectedCount(1,!0))}}),MWF.xApplication.Selector.Identity.SearchItem=new Class({Extends:MWF.xApplication.Selector.Identity.Item,_getShowName:function(){return this.data.name+(this.data.unitLevelName?"("+this.data.unitLevelName+")":"")}}),MWF.xApplication.Selector.Identity.ItemSelected=new Class({Extends:MWF.xApplication.Selector.Person.ItemSelected,getData:function(t,e){if("person"===this.selector.options.resultType){var i=!1;if(this.data&&this.data.distinguishedName){var s=this.data.distinguishedName;"p"===s.substr(s.length-1,1).toLowerCase()&&(i=!0)}i?t&&t():this.data.woPerson?(this.data=this.data.woPerson,t&&t()):this.data.person?this.selector.orgAction.getPerson(function(e){this.data=e.data,t&&t()}.bind(this),null,this.data.person):t&&t()}else if(this.data.woPerson||this.data.personDn&&this.data.personEmployee&&this.data.personUnique)t&&t();else{if(this.selector.options.ignorePerson||"simple"===this.selector.options.storeRange)return void(t&&t());!e&&t&&t(),this.data.person?this.selector.orgAction.getPerson(function(i){this.data.woPerson=i.data,e&&t&&t()}.bind(this),function(i,s,n){var o=n;if(i){var a=JSON.decode(i.responseText);o=a?a.message.trim()||"request json error":"request json error: "+i.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},o),e&&t&&t()}.bind(this),this.data.person):(MWF.xDesktop.notice("error",{x:"right",y:"top"},MWF.SelectorLP.noPerson.replace(/{name}/g,this.data.name)),e&&t&&t())}},_getShowName:function(){return this.data.name+(this.data.unitLevelName?"("+this.data.unitLevelName+")":"")},_getTtiteText:function(){return this.data.name+(this.data.unitLevelName?"("+this.data.unitLevelName+")":"")},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/personicon.png)")},check:function(){if(this.selector.items.length){var t="person"===this.selector.options.resultType,e=this.selector.items.filter(function(e,i){return t?e.data.person&&e.data.person===this.data.id||e.data.id&&e.data.id===this.data.person||e.data.distinguishedName&&e.data.distinguishedName===this.data.distinguishedName:e.data.distinguishedName===this.data.distinguishedName}.bind(this));this.items=e,e.length&&e.each(function(t){t.selectedItem=this,t.setSelected(),("all"===this.selector.options.selectAllRange||"identity"==this.selector.selectType&&(this.selector.options.showSelectedCount||this.selector.options.isCheckStatus))&&t.category&&t.category._addSelectedCount&&t.category._addSelectedCount(1,!0)}.bind(this))}this.afterCheck&&this.afterCheck()}}),MWF.xApplication.Selector.Identity.ItemCategory=new Class({Extends:MWF.xApplication.Selector.Person.ItemCategory,createNode:function(){this.node=new Element("div",{styles:this.selector.css.selectorItemCategory_department,title:this._getTtiteText()}).inject(this.container)},_addSelectedCount:function(t,e){var i=(this._getSelectedCount()||0)+t;this.selectedCount=i,this.checkCountAndStatus(i),e&&this.category&&this.category._addSelectedCount&&this.category._addSelectedCount(t,e)},checkCountAndStatus:function(t){if(this.selector.options.showSelectedCount&&this.selectedCountNode.set("text",t?"("+t+")":""),this.selector.options.isCheckStatus&&this.selectAllNode){var e,i=this._getTotalCount();if(i)t>=i?(e=this.selector.css.selectorItemCategoryActionNode_selectAll_selected,this.isSelectedSome=!1,this.isSelectedAll=!0):t>0?(e=this.selector.css.selectorItemCategoryActionNode_selectsome_selected,this.isSelectedSome=!0,this.isSelectedAll=!1):(e=this.selector.css.selectorItemCategoryActionNode_selectAll,this.isSelectedSome=!1,this.isSelectedAll=!1),this.selectAllNode.setStyles(e)}else 0===t&&"all"===this.selector.options.selectAllRange&&this.selectAllNode&&(e=this.selector.css.selectorItemCategoryActionNode_selectAll,this.isSelectedSome=!1,this.isSelectedAll=!1,this.selectAllNode.setStyles(e))},_getShowName:function(){return this.data.name},_getTotalCount:function(){if(!this.selector.allUnitObject)return 0;var t=this.selector.allUnitObject[this.data.levelName];return t?t.subNestedIdentityCount:0},_getSelectedCount:function(){if("number"===typeOf(this.selectedCount))return this.selectedCount;if(!this.selector.allUnitObject)return 0;var t=this.selector.allUnitObject[this.data.levelName],e=t?t.selectedNestedIdentityCount:0;return this.selectedCount=e,e},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/companyicon.png)")},_beforeSelectAll:function(t){if(this.selector.options.ignorePerson||"simple"===this.selector.options.storeRange&&"person"!==this.selector.options.resultType)t();else{var e={};"person"===this.selector.options.resultType?this.subItems.each(function(t){var i=!1;if(t.data&&t.data.distinguishedName){var s=t.data.distinguishedName;"p"===s.substr(s.length-1,1).toLowerCase()&&(i=!0)}i||t.data.woPerson||!t.data.person||(e[t.data.person]=t)}.bind(this)):this.subItems.each(function(t){!t.data.woPerson&&t.data.person&&(e[t.data.person]=t)}.bind(this));var i=Object.keys(e);i.length>0?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:i},(function(i){i.data.each(function(t){e[t.id]&&(e[t.id].data.woPerson=t)}.bind(this)),t()})):t()}},clickItem:function(t){if(this._hasChild()&&!this.loading){var e=!this.loaded;this.loading=!0,this.loadSub(function(){(this.loading=!1,e)?(this.selector.isFlatCategory||(this.children.setStyles({display:"block",height:"auto"}),this.actionNode.setStyles(this.selector.css.selectorItemCategoryActionNode_expand),this.isExpand=!0),this.selector.fireEvent("expand",[this])):"none"===this.children.getStyle("display")?(this.children.setStyles({display:"block",height:"auto"}),this.actionNode.setStyles(this.selector.css.selectorItemCategoryActionNode_expand),this.isExpand=!0,this.selector.fireEvent("expand",[this])):(this.children.setStyles({display:"none",height:"0px"}),this.actionNode.setStyles(this.selector.css.selectorItemCategoryActionNode_collapse),this.isExpand=!1,this.selector.fireEvent("collapse",[this]));t&&t()}.bind(this))}},loadSub:function(t){this._loadSub(function(e){t&&t()}.bind(this))},_loadSub:function(t){if(this.loaded)t&&t();else{var e=function(){this.selector.options.expandSubEnable&&!this.categoryLoaded?this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItemCategory("ItemUnitCategory",t,this.selector,this.children,this.level+1,this);this.subCategorys.push(e)}}.bind(this)),this.loaded=!0,t&&t(!0)}.bind(this),null,this.data.distinguishedName):(this.loaded=!0,t&&t(!0))}.bind(this);this.itemLoaded?e():this.selector.orgAction.listIdentityWithUnit(function(t){t.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this);this.selector.items.push(e),this.subItems&&this.subItems.push(e)}}.bind(this)),e()}.bind(this),null,this.data.distinguishedName)}},_hasChild:function(){return(this.data.subDirectUnitCount?this.data.subDirectUnitCount:0)+(this.data.subDirectIdentityCount?this.data.subDirectIdentityCount:0)},_hasChildCategory:function(){return this.data.subDirectUnitCount?this.data.subDirectUnitCount:0},_hasChildItem:function(){return this.data.subDirectIdentityCount?this.data.subDirectIdentityCount:0},afterLoad:function(){if(1===this.level&&this.clickItem(),this.selector.options.showSelectedCount||this.selector.options.isCheckStatus){var t=this._getSelectedCount();this.checkCountAndStatus(t)}},clickFlatCategoryItem:function(t,e){if(this._hasChildItem()){var i=!this.itemLoaded;this.loadItemChildren(function(){if(e)this.children.setStyles({display:"none",height:"0px"}),this.node.setStyles(this.selector.css.flatCategoryItemNode),this.isExpand=!1;else if(i)this.children.setStyles({display:"block",height:"auto"}),this.node.setStyles(this.selector.css.flatCategoryItemNode_selected),this.isExpand=!0;else{"none"===this.children.getStyle("display")?(this.children.setStyles({display:"block",height:"auto"}),this.node.setStyles(this.selector.css.flatCategoryItemNode_selected),this.isExpand=!0):(this.children.setStyles({display:"none",height:"0px"}),this.node.setStyles(this.selector.css.flatCategoryItemNode),this.isExpand=!1)}t&&t()}.bind(this))}},loadCategoryChildren:function(t){this.categoryLoaded?t&&t():this.selector.options.expandSubEnable?this.selector.orgAction.listSubUnitDirect(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItemCategory("ItemUnitCategory",t,this.selector,this.children,this.level+1,this);this.subCategorys.push(e)}}.bind(this)),this.categoryLoaded=!0,t&&t()}.bind(this),null,this.data.distinguishedName):t&&t()},loadItemChildren:function(t){this.itemLoaded?t&&t():this.selector.orgAction.listIdentityWithUnit(function(e){e.data.each(function(t){if(!this.selector.isExcluded(t)){var e=this.selector._newItem(t,this.selector,this.children,this.level+1,this);this.selector.items.push(e),this.subItems&&this.subItems.push(e)}this.itemLoaded=!0}.bind(this)),t&&t()}.bind(this),null,this.data.distinguishedName)}}),MWF.xApplication.Selector.Identity.ItemUnitCategory=new Class({Extends:MWF.xApplication.Selector.Identity.ItemCategory}),MWF.xApplication.Selector.Identity.ItemGroupCategory=new Class({Extends:MWF.xApplication.Selector.Identity.ItemCategory,createNode:function(){this.node=new Element("div",{styles:this.selector.css.selectorItemCategory}).inject(this.container)},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/groupicon.png)")},_getTotalCount:function(){if(!this.selector.allGroupObjectByDn)return 0;var t=this.selector.allGroupObjectByDn[this.data.distinguishedName];return t?t.subNestedIdentityCount:0},_getSelectedCount:function(){if("number"===typeOf(this.selectedCount))return this.selectedCount;if(!this.selector.allGroupObjectByDn)return 0;var t=this.selector.allGroupObjectByDn[this.data.distinguishedName],e=t?t.selectedNestedIdentityCount:0;return this.selectedCount=e,e},loadSub:function(t){if(this.loaded)t&&t();else{var e,i,s,n;this.data.personList&&(e=new Element("div").inject(this.children)),this.data.identityList&&(i=new Element("div").inject(this.children)),this.data.groupList&&(s=new Element("div").inject(this.children)),this.data.unitList&&(n=new Element("div").inject(this.children));var o=0,a=0,d=0,l=0,h=function(e,i){var s=i||1;this.selector.options.expandSubEnable?("person"===e&&(o+=s),"identity"===e&&(a+=s),"unit"===e&&(d+=s),"group"===e&&(l+=s),this.data.personList&&0!==this.data.personList.length&&this.data.personList.length!=o||this.data.identityList&&0!==this.data.identityList.length&&this.data.identityList.length!=a||this.data.unitList&&0!==this.data.unitList.length&&this.data.unitList.length!=d||this.data.groupList&&0!==this.data.groupList.length&&this.data.groupList.length!=l||(this.loaded=!0,t&&t())):("person"===e&&(o+=s),"identity"===e&&(a+=s),this.data.personList&&0!==this.data.personList.length&&this.data.personList.length!=o||this.data.identityList&&0!==this.data.identityList.length&&this.data.identityList.length!=a||(this.loaded=!0,t&&t()))}.bind(this);h(),this.data.identityList&&this.data.identityList.length>0&&("person"===this.selector.options.resultType?o2.Actions.load("x_organization_assemble_express").PersonAction.listWithIdentityObject({identityList:this.data.identityList},function(t){this.selector.includeObject.loadPersonItem(t,i,this.level+1,this),h("identity",this.data.identityList.length)}.bind(this),function(){h("identity",this.data.identityList.length)}.bind(this)):o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:this.data.identityList},function(t){this.selector.includeObject.loadIdentityItem(t,i,this.level+1,this),h("identity",this.data.identityList.length)}.bind(this),function(){h("identity",this.data.identityList.length)}.bind(this))),this.data.personList&&this.data.personList.length>0&&("person"===this.selector.options.resultType?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:this.data.personList},function(t){this.selector.includeObject.loadPersonItem(t,e,this.level+1,this),h("person",this.data.personList.length)}.bind(this),function(){h("person",this.data.personList.length)}.bind(this)):o2.Actions.load("x_organization_assemble_express").IdentityAction.listWithPersonObject({personList:this.data.personList},function(t){this.selector.includeObject.loadIdentityItem(t,e,this.level+1,this),h("person",this.data.personList.length)}.bind(this),function(){h("person",this.data.personList.length)}.bind(this))),this.selector.options.expandSubEnable&&((this.data.unitList||[]).each(function(t){this.selector.orgAction.getUnit(function(t){this.selector.includeObject.loadUnitItem(t,n,this.level+1,this),h("unit")}.bind(this),(function(){h("unit")}),t)}.bind(this)),(this.data.groupList||[]).each(function(t){this.selector.orgAction.getGroup(function(t){this.selector.includeObject.loadGroupItem(t,s,this.level+1,this),h("group")}.bind(this),(function(){h("group")}),t)}.bind(this)))}},loadCategoryChildren:function(t){if(this.categoryLoaded)t&&t();else{var e,i;this.data.groupList&&(e=new Element("div").inject(this.children)),this.data.unitList&&(i=new Element("div").inject(this.children));var s=0,n=0,o=function(e,i){var o=i||1;this.selector.options.expandSubEnable?("unit"===e&&(s+=o),"group"===e&&(n+=o),this.data.unitList&&0!==this.data.unitList.length&&this.data.unitList.length!=s||this.data.groupList&&0!==this.data.groupList.length&&this.data.groupList.length!=n||(this.categoryLoaded=!0,t&&t())):this.categoryLoaded=!0}.bind(this);o(),this.selector.options.expandSubEnable&&((this.data.unitList||[]).each(function(t){this.selector.orgAction.getUnit(function(t){this.selector.includeObject.loadUnitItem(t,i,this.level+1,this),o("unit")}.bind(this),(function(){o("unit")}),t)}.bind(this)),(this.data.groupList||[]).each(function(t){this.selector.orgAction.getGroup(function(t){this.selector.includeObject.loadGroupItem(t,e,this.level+1,this),o("group")}.bind(this),(function(){o("group")}),t)}.bind(this)))}},loadItemChildren:function(t){if(this.itemLoaded)t&&t();else{var e,i;this.data.personList&&(e=new Element("div").inject(this.children)),this.data.identityList&&(i=new Element("div").inject(this.children));var s=0,n=0,o=function(e,i){var o=i||1;"person"===e&&(s+=o),"identity"===e&&(n+=o),this.data.personList&&0!==this.data.personList.length&&this.data.personList.length!=s||this.data.identityList&&0!==this.data.identityList.length&&this.data.identityList.length!=n||(this.itemLoaded=!0,t&&t())}.bind(this);o(),this.data.identityList&&this.data.identityList.length>0&&("person"===this.selector.options.resultType?o2.Actions.load("x_organization_assemble_express").PersonAction.listWithIdentityObject({identityList:this.data.identityList},function(t){this.selector.includeObject.loadPersonItem(t,i,this.level+1,this),o("identity",this.data.identityList.length)}.bind(this),function(){o("identity",this.data.identityList.length)}.bind(this)):o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({identityList:this.data.identityList},function(t){this.selector.includeObject.loadIdentityItem(t,i,this.level+1,this),o("identity",this.data.identityList.length)}.bind(this),function(){o("identity",this.data.identityList.length)}.bind(this))),this.data.personList&&this.data.personList.length>0&&("person"===this.selector.options.resultType?o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({personList:this.data.personList},function(t){this.selector.includeObject.loadPersonItem(t,e,this.level+1,this),o("person",this.data.personList.length)}.bind(this),function(){o("person",this.data.personList.length)}.bind(this)):o2.Actions.load("x_organization_assemble_express").IdentityAction.listWithPersonObject({personList:this.data.personList},function(t){this.selector.includeObject.loadIdentityItem(t,e,this.level+1,this),o("person",this.data.personList.length)}.bind(this),function(){o("person",this.data.personList.length)}.bind(this)))}},_hasChild:function(){return(this.data.unitList?this.data.unitList.length:0)+(this.data.groupList?this.data.groupList.length:0)+(this.data.personList?this.data.personList.length:0)+(this.data.identityList?this.data.identityList.length:0)},_hasChildCategory:function(){return(this.data.unitList?this.data.unitList.length:0)+(this.data.groupList?this.data.groupList.length:0)},_hasChildItem:function(){return(this.data.personList?this.data.personList.length:0)+(this.data.identityList?this.data.identityList.length:0)}}),MWF.xApplication.Selector.Identity.ItemRoleCategory=new Class({Extends:MWF.xApplication.Selector.Person.ItemCategory,_getShowName:function(){return this.data.name},_setIcon:function(){var t=this.selector.options.style;this.iconNode.setStyle("background-image","url(../x_component_Selector/$Selector/"+t+"/icon/roleicon.png)")}}),MWF.xApplication.Selector.Identity.Include=new Class({Implements:[Options,Events],options:{include:[],resultType:"",expandSubEnable:!0},initialize:function(t,e,i){this.setOptions(i),this.selector=t,this.itemAreaNode=$(e),this.orgAction=MWF.Actions.get("x_organization_assemble_control")},load:function(t){if(!this.options.include||0===this.options.include.length)return this.fireEvent("afterLoad"),void(t&&t());var e=0,i=function(){++e===this.options.include.length&&(this.fireEvent("afterLoad"),t&&t())}.bind(this);this.includeAreaNode=new Element("div.includeAreaNode").inject(this.itemAreaNode,"top"),this.selector.isFlatCategory&&(this.flatCategoryAreaNode=new Element("div.includeFlatCategoryAreaNode").inject(this.selector.flatCategoryNode,"top")),this.options.include.each(function(t){var e,s,n,o=new Element("div").inject(this.includeAreaNode);(this.flatCategoryAreaNode&&(e=new Element("div").inject(this.flatCategoryAreaNode)),"string"===typeOf(t))?"u"===(n=(s=t.split("@"))[s.length-1].toLowerCase())?this.orgAction.listUnitByKey(function(t){this.loadUnitItem(t,o,null,null,e),i()}.bind(this),i,t):"i"===n?this.orgAction.listIdentityByKey(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t):"g"===n?this.orgAction.listGroupByKey(function(t){this.loadGroupItem(t,o,null,null,e),i()}.bind(this),i,t):"p"===n?"person"===this.options.resultType?this.orgAction.getPerson(function(t){this.loadPersonItem(t,o,null,null,!0),i()}.bind(this),i,t):this.orgAction.listIdentityByPerson(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t):"person"===this.options.resultType?this.orgAction.listPersonByKey(function(t){this.loadPersonItem(t,o,null,null,!0),i()}.bind(this),i,t):this.orgAction.listIdentityByKey(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t):"u"===(n=(s=t.distinguishedName.split("@"))[s.length-1].toLowerCase())?this.orgAction.getUnit(function(t){this.loadUnitItem(t,o,null,null,e),i()}.bind(this),i,t.distinguishedName):"i"===n?this.orgAction.getIdentity(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t.distinguishedName):"g"===n?this.orgAction.getGroup(function(t){this.loadGroupItem(t,o,null,null,e),i()}.bind(this),i,t.distinguishedName,null,null,!0):"p"===n?"person"===this.options.resultType?this.orgAction.getPerson(function(t){this.loadPersonItem(t,o,null,null,!0),i()}.bind(this),i,t.distinguishedName):this.orgAction.listIdentityByPerson(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t.distinguishedName):"person"===this.options.resultType?this.orgAction.getPerson(function(t){this.loadPersonItem(t,o,null,null,!0),i()}.bind(this),i,t.distinguishedName):this.orgAction.getIdentity(function(t){this.loadIdentityItem(t,o,null,null,!0),i()}.bind(this),i,t.distinguishedName)}.bind(this))},loadPersonItem:function(t,e,i,s,n){t.data&&("array"===typeOf(t.data)?t.data:[t.data]).each(function(t){if(!this.selector.isExcluded(t)){this.includePerson||(this.includePerson=[]),n&&this.includePerson.push(t.distinguishedName),this.includePersonObject||(this.includePersonObject=[]),n&&this.includePersonObject.push(t);var o=this.selector._newItem(t,this.selector,e||this.includeAreaNode,i||1,s);this.selector.items.push(o),s&&s.subItems?s.subItems.push(o):this.selector.subItems&&this.selector.subItems.push(o)}}.bind(this))},loadIdentityItem:function(t,e,i,s,n){t.data&&("array"===typeOf(t.data)?t.data:[t.data]).each(function(t){if(!this.selector.isExcluded(t)){this.includeIdentity||(this.includeIdentity=[]),n&&this.includeIdentity.push(t.distinguishedName),this.includeIdentityObject||(this.includeIdentityObject=[]),n&&this.includeIdentityObject.push(t);var o=this.selector._newItem(t,this.selector,e||this.includeAreaNode,i||1,s);this.selector.items.push(o),s&&s.subItems?s.subItems.push(o):this.selector.subItems&&this.selector.subItems.push(o)}}.bind(this))},loadUnitItem:function(t,e,i,s,n){t.data&&("array"===typeOf(t.data)?t.data:[t.data]).each(function(t){var o;this.selector.isExcluded(t)||(this.includeUnit||(this.includeUnit=[]),this.includeUnit.push(t.distinguishedName),n?((o=this.selector._newItemCategory("ItemUnitCategory",t,this.selector,e||this.includeAreaNode,i,s,!0)).nodeContainer=n,o.load()):o=this.selector._newItemCategory("ItemUnitCategory",t,this.selector,e||this.includeAreaNode,i,s),s&&s.subCategorys?s.subCategorys.push(o):this.selector.subCategorys&&this.selector.subCategorys.push(o))}.bind(this))},loadGroupItem:function(t,e,i,s,n){t.data&&("array"===typeOf(t.data)?t.data:[t.data]).each(function(t){var o;this.selector.isExcluded(t)||(this.includeGroup||(this.includeGroup=[]),this.includeGroup.push(t.distinguishedName),n?((o=this.selector._newItemCategory("ItemGroupCategory",t,this.selector,e||this.includeAreaNode,i,s,!0)).nodeContainer=n,o.load()):o=this.selector._newItemCategory("ItemGroupCategory",t,this.selector,e||this.includeAreaNode,i,s),s&&s.subCategorys?s.subCategorys.push(o):this.selector.subCategorys&&this.selector.subCategorys.push(o))}.bind(this))},listByFilter:function(t,e,i){var s=this.listByFilterPerson(e)||[];this.listByFilterUnitAndGroup(t,e,function(n){this.listByFilterGroup(t,e,function(t){i&&i(s.concat(n||[]).concat(t||[]))}.bind(this))}.bind(this))},listByFilterPerson:function(t){var e=[],i=[],s="string"===typeOf(t)?t.toLowerCase():t.key.toLowerCase();return this.includeIdentityObject&&this.includeIdentityObject.length&&(e=this.includeIdentityObject.filter((function(t){return(t.pinyin||"").indexOf(s)>-1||(t.pinyinInitial||"").indexOf(s)>-1||(t.distinguishedName||"").indexOf(s)>-1}))),this.includePersonObject&&this.includePersonObject.length&&(i=this.includePersonObject.filter((function(t){return(t.pinyin||"").indexOf(s)>-1||(t.pinyinInitial||"").indexOf(s)>-1||(t.distinguishedName||"").indexOf(s)>-1}))),e.concat(i)},listByFilterGroup:function(t,e,i){var s="string"===typeOf(e)?e.toLowerCase():e.key.toLowerCase();if(this.includeGroup&&this.includeGroup.length){var n={key:s,groupList:this.includeGroup};this.orgAction["pinyin"===t?"listPersonByPinyin":"listPersonByKey"](function(t){if("person"===this.options.resultType)i&&i(t.data);else{var e=(t.data||[]).map((function(t){return t.id}));o2.Actions.get("x_organization_assemble_express").listIdentityWithPerson({personList:e},function(t){i&&i(t.data)}.bind(this),function(){i&&i()}.bind(this))}}.bind(this),function(){i&&i()}.bind(this),n)}else i&&i()},listByFilterUnitAndGroup:function(t,e,i){"string"===typeOf(e)?e.toLowerCase():e.key.toLowerCase();this.includeUnit&&this.includeUnit.length?(e=this.getUnitFilterKey(e,this.includeUnit,this.includeGroup),this.orgAction.listIdentityByKey(function(t){i&&i(t.data)}.bind(this),(function(){i&&i()}),e)):i&&i()},getUnitFilterKey:function(t,e,i){var s=[];(e||[]).each((function(t){"string"===typeOf(t)&&s.push(t),"object"===typeOf(t)&&s.push(t.distinguishedName)}));var n=[];if((i||[]).each((function(t){"string"===typeOf(t)&&n.push(t),"object"===typeOf(t)&&n.push(t.distinguishedName)})),s.length||n.length){var o={key:t};return s.length&&(o.unitList=s),n.length&&(o.groupList=n),o}return t}}),MWF.xApplication.Selector.Identity.Filter=new Class({Implements:[Options,Events],options:{style:"default",units:[],resultType:""},initialize:function(t,e){this.setOptions(e),this.value=t,this.orgAction=MWF.Actions.get("x_organization_assemble_control")},filter:function(t,e){this.value=t;var i=this.value;if(this.options.units.length){var s=[];this.options.units.each((function(t){"string"===typeOf(t)&&s.push(t),"object"===typeOf(t)&&s.push(t.distinguishedName)})),i={key:this.value,unitList:s}}var n=null;this.orgAction.listIdentityByKey(function(t){n=t.data,e&&e(n)}.bind(this),null,i)}});