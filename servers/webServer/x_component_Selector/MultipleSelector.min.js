MWF.xApplication.Selector=MWF.xApplication.Selector||{},MWF.xApplication.Selector.MultipleSelector=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",types:[],count:0,title:"",groups:[],roles:[],units:[],values:[],zIndex:1e3,expand:!0,contentUrl:"",injectToBody:!1},initialize:function(t,e){this.active=!0,e.title||(e.title=MWF.xApplication.Selector.LP.multiSelectTitle),this.setOptions(e),this.path="../x_component_Selector/$Selector/",this.cssPath="../x_component_Selector/$Selector/"+this.options.style+"/css.wcss",this._loadCss(),this.container=$(t),this.lp=MWF.xApplication.Selector.LP,this.lastPeople="",this.pageCount="13",this.selectedItems=[],this.selectedItemsObject={},this.items=[],this.selectors={}},load:function(){this.options.contentUrl?this.loadWithUrl():layout.mobile?this.loadMobile():this.loadPc(),this.fireEvent("load")},loadWithUrl:function(){new Request.HTML({url:this.options.contentUrl,method:"GET",async:!1,onSuccess:function(t,e,i,s){this.node=t[0],this.loadContentWithHTML(),this.fireEvent("load")}.bind(this),onFailure:function(t){alert(t)}}).send()},loadContentWithHTML:function(){var t,e=this.options.injectToBody?$(document.body):this.container;if(this.options.embedded||(this.css.maskNode["z-index"]=this.options.zIndex,this.maskRelativeNode=e,this.maskRelativeNode.mask({destroyOnHide:!0,style:this.css.maskNode})),this.options.embedded||(this.node.setStyles(this.css.containerNodeMobile),this.node.setStyle("z-index",this.options.zIndex.toInt()+1)),this.node.setStyle("height",e.getSize().y+"px"),this.titleNode=this.node.getElement(".MWF_selector_titleNode"),this.titleTextNode=this.node.getElement(".MWF_selector_titleTextNode"),this.titleCancelActionNode=this.node.getElement(".MWF_selector_titleCancelActionNode"),this.titleOkActionNode=this.node.getElement(".MWF_selector_titleOkActionNode"),this.tabContainer=this.node.getElement(".MWF_selector_tabContainer"),this.tabContainer.show(),this.contentNode=this.node.getElement(".MWF_selector_contentNode"),this.selectNode=this.node.getElement(".MWF_selector_selectNode"),this.searchInputDiv=this.node.getElement(".MWF_selector_searchInputDiv"),this.searchInput=this.node.getElement(".MWF_selector_searchInput"),this.flatCategoryScrollNode=this.node.getElement(".MWF_selector_flatCategoryScrollNode"),this.flatCategoryNode=this.node.getElement(".MWF_selector_flatCategoryNode"),this.letterAreaNode=this.node.getElement(".MWF_selector_letterAreaNode"),this.itemAreaScrollNode=this.node.getElement(".MWF_selector_itemAreaScrollNode"),this.itemAreaNode=this.node.getElement(".MWF_selector_itemAreaNode"),this.itemSearchAreaScrollNode=this.node.getElement(".MWF_selector_itemSearchAreaScrollNode"),this.itemSearchAreaNode=this.node.getElement(".MWF_selector_itemSearchAreaNode"),this.selectedScrollNode=this.node.getElement(".MWF_selector_selectedScrollNode"),this.selectedNode=this.node.getElement(".MWF_selector_selectedNode"),this.selectedItemSearchAreaNode=this.node.getElement(".MWF_selector_selectedItemSearchAreaNode"),this.actionNode=this.node.getElement(".MWF_selector_actionNode"),this.okActionNode=this.node.getElement(".MWF_selector_okActionNode"),this.cancelActionNode=this.node.getElement(".MWF_selector_cancelActionNode"),this.titleNode&&this.titleNode.setStyles(this.css.titleNodeMobile),this.titleTextNode&&(this.titleTextNode.setStyles(this.css.titleTextNodeMobile),this.options.title&&this.titleTextNode.set("text",this.options.title)),this.titleCancelActionNode&&this.titleCancelActionNode.setStyles(this.css.titleCancelActionNodeMobile),this.titleOkActionNode&&this.titleOkActionNode.setStyles(this.css.titleOkActionNodeMobile),this.tabContainer&&this.tabContainer.setStyles(this.css.tabContainer),this.contentNode&&this.contentNode.setStyles(this.css.contentNode),this.selectNode&&this.selectNode.setStyles(this.css.selectNodeMobile),this.searchInputDiv&&this.searchInputDiv.setStyles(this.css.searchInputDiv),this.searchInput&&this.searchInput.setStyles(1===this.options.count.toInt()?this.css.searchInputSingle:this.css.searchInput),this.letterAreaNode&&this.letterAreaNode.setStyles(this.css.letterAreaNode),this.itemAreaScrollNode&&this.itemAreaScrollNode.setStyles(this.css.itemAreaScrollNode),this.itemAreaNode&&this.itemAreaNode.setStyles(this.css.itemAreaNode),this.itemSearchAreaScrollNode&&this.itemSearchAreaScrollNode.setStyles(this.css.itemSearchAreaScrollNode),this.itemSearchAreaNode&&this.itemSearchAreaNode.setStyles(this.css.itemAreaNode),this.selectedScrollNode&&this.selectedScrollNode.setStyles(this.css.selectedScrollNode),this.selectedNode&&this.selectedNode.setStyles(this.css.selectedNode),this.selectedItemSearchAreaNode&&this.selectedItemSearchAreaNode.setStyles(this.css.itemAreaNode),this.actionNode&&this.actionNode.setStyles(this.css.actionNode),this.okActionNode&&(this.okActionNode.setStyles(this.css.okActionNode),this.okActionNode.set("text",MWF.SelectorLP.ok)),this.cancelActionNode&&(this.cancelActionNode.setStyles(this.css.cancelActionNode),this.cancelActionNode.set("text",MWF.SelectorLP.cancel)),this.options.injectToBody)t=$(document.body).getSize();else{var i=this.container.getSize(),s=$(document.body).getSize();0===i.y&&(i.y=s.y),t={x:Math.min(i.x,s.x),y:Math.min(i.y,s.y)}}var o=this.node.getStyle("zoom").toInt()||0;o&&(t.x=100*t.x/o,t.y=100*t.y/o),this.node.setStyles({width:t.x+"px",height:t.y+"px"});window.location.href.toLowerCase().indexOf("workmobilewithaction.html");var n=t.y-this.getOffsetY(this.contentNode);this.tabContainer&&(n=n-this.getOffsetY(this.tabContainer)-(this.tabContainer.getStyle("height").toInt()||0)),this.titleNode&&(n=n-this.getOffsetY(this.titleNode)-(this.titleNode.getStyle("height").toInt()||0)),this.actionNode&&(n=n-this.getOffsetY(this.actionNode)-(this.actionNode.getStyle("height").toInt()||0)),this.contentNode.setStyle("height",n+"px"),this.selectNode.setStyle("height",n+"px"),this.contentHeight=n,this.contentHTML=this.contentNode.get("html"),this.contentNode.empty(),this.loadContent(),this.actionNode&&this.loadAction(),this.node.inject(e),this.options.embedded||this.node.setStyles({top:"0px",left:"0px"}),this.setEvent()},loadMobile:function(){this.maskRelativeNode=$(document.body),this.maskRelativeNode.mask({destroyOnHide:!0,style:this.css.maskNode}),this.node=new Element("div",{styles:this.css.containerNodeMobile}),this.node.setStyle("z-index",this.options.zIndex.toInt()+1),this.node.setStyle("height",$(document.body).getSize().y+"px"),this.titleNode=new Element("div",{styles:this.css.titleNodeMobile}).inject(this.node),this.titleCancelActionNode=new Element("div",{styles:this.css.titleCancelActionNodeMobile,text:MWF.SelectorLP.back}).inject(this.titleNode),this.titleOkActionNode=new Element("div",{styles:this.css.titleOkActionNodeMobile,text:MWF.SelectorLP.ok}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:{margin:"0px 50px",height:"40px",padding:"0px 10px",color:"#FFF","font-weight":"bold","font-size":"14px","line-height":"40px"}}).inject(this.titleNode),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node);var t=$(document.body).getSize().y;this.contentNode.setStyle("height",t+"px"),this.contentNode.setStyle("margin-top","2px"),this.loadContent(),this.node.inject($(document.body)),this.node.setStyles({top:"0px",left:"0px"}),this.setEvent()},loadPc:function(){this.css.maskNode["z-index"]=this.options.zIndex;var t=this.container.getPosition(this.container.getOffsetParent());this.container.mask({destroyOnHide:!0,style:this.css.maskNode,useIframeShim:!0,iframeShimOptions:{browsers:!0},onShow:function(){this.shim.shim.setStyles({opacity:0,top:t.y+"px",left:t.x+"px"})}}),this.node=new Element("div",{styles:this.css.containerNode_multiple}),this.node.setStyle("z-index",this.options.zIndex.toInt()+1),this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.node),this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node),this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node),this.loadAction(),this.node.inject(this.container),(this.options.width||this.options.height)&&this.setSize(),this.loadContent(),this.node.position({relativeTo:this.container,position:"center",edge:"center"});var e=this.container.getSize(),i=this.node.getSize();this.node.makeDraggable({handle:this.titleNode,limit:{x:[0,e.x-i.x],y:[0,e.y-i.y]}}),this.setEvent()},isSingle:function(){var t=!0,e=!0;return this.options.types.each(function(i,s){var o=this.options[i+"Options"];o&&(1!==Number.convert(o.count)&&(t=!1),e=!1)}.bind(this)),e&&(t=1===Number.convert(this.options.count)),t},setEvent:function(){this.titleActionNode&&this.titleActionNode.addEvent("click",function(){this.close()}.bind(this)),this.titleCancelActionNode&&this.titleCancelActionNode.addEvent("click",function(){this.close()}.bind(this)),this.titleOkActionNode&&this.titleOkActionNode.addEvent("click",function(){this.fireEvent("complete",[this.getSelectedItems(),this.getSelectedItemsObject()]),this.close()}.bind(this))},close:function(){this.fireEvent("close"),this.node.destroy(),(this.maskRelativeNode||this.container).unmask(),this.active=!1,MWF.release(this)},loadAction:function(){this.okActionNode||(this.okActionNode=new Element("button",{styles:this.css.okActionNode,text:MWF.SelectorLP.ok}).inject(this.actionNode)),this.cancelActionNode||(this.cancelActionNode=new Element("button",{styles:this.css.cancelActionNode,text:MWF.SelectorLP.cancel}).inject(this.actionNode)),this.okActionNode.addEvent("click",function(){this.fireEvent("complete",[this.getSelectedItems(),this.getSelectedItemsObject()]),this.close()}.bind(this)),this.cancelActionNode.addEvent("click",function(){this.fireEvent("cancel"),this.close()}.bind(this))},loadContent:function(){this.options.contentUrl?MWF.require("MWF.widget.Tab",function(){if(this.tab=new MWF.widget.Tab(this.tabContainer||this.titleTextNode,{style:this.options.tabStyle}),this.tabContainer){var t=0;this.tab.css.tabNode&&(this.tab.css.tabNode["border-left"]&&(t+=this.tab.css.tabNode["border-left"].toInt()),this.tab.css.tabNode["border-right"]&&(t+=this.tab.css.tabNode["border-right"].toInt()));var e="calc("+100/this.options.types.length+"% - "+t+"px)";this.tab.css.tabNode&&(this.tab.css.tabNode.width=e),this.tab.css.tabNodeCurrent&&(this.tab.css.tabNodeCurrent.width=e)}else{var i=(this.container.getSize().x-160)/this.options.types.length-2;e=i<60?i:60;this.tab.css.tabNode&&(this.tab.css.tabNode["min-width"]=e+"px"),this.tab.css.tabNodeCurrent&&(this.tab.css.tabNodeCurrent["min-width"]=e+"px")}this.tab.load(),this.tab.contentNodeContainer.inject(this.contentNode)}.bind(this),!1):layout.mobile?MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.tabContainer||this.titleTextNode,{style:"orgMobile"});var t=(this.container.getSize().x-160)/this.options.types.length-2,e=t<60?t:60;this.tab.css.tabNode&&(this.tab.css.tabNode["min-width"]=e+"px"),this.tab.css.tabNodeCurrent&&(this.tab.css.tabNodeCurrent["min-width"]=e+"px"),this.tab.load(),this.tab.contentNodeContainer.inject(this.contentNode)}.bind(this),!1):MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.contentNode,{style:this.options.tabStyle||"default"}),this.tab.load()}.bind(this),!1);var t=window.location.href.toLowerCase().indexOf("workmobilewithaction.html")>-1;this.options.types.each(function(e,i){var s=Object.clone(this.options);"identity"===e.toLowerCase()&&(s.expand=!1),this.options[e+"Options"]&&(s=Object.merge(s,this.options[e+"Options"]));var o=new Element("div").inject(this.contentNode),n=this.tab.addTab(o,this.lp[e],!1);0===i&&this.contentHeight&&!this.tabContainer&&(this.contentHeight=this.contentHeight-this.getOffsetY(n.tab.tabNodeContainer)-n.tab.tabNodeContainer.getStyle("height").toInt());var h=e.capitalize();"unit"===e.toLowerCase()&&s.unitType&&(h="UnitWithType"),"identity"===e.toLowerCase()&&s.dutys&&s.dutys.length&&(h="duty"===s.categoryType.toLowerCase()?"IdentityWidthDuty":"IdentityWidthDutyCategoryByUnit"),MWF.xDesktop.requireApp("Selector",h,function(){"identity"===e.toLowerCase()&&s.resultType&&"person"===s.resultType?s.values=this.getValueByType(s.values,[e,"person"]):s.values=this.getValueByType(s.values,e),this.selectors[h]=new MWF.xApplication.Selector[h](this.container,s);var l=this.selectors[h];if(this.options.contentUrl){if(o.set("html",this.contentHTML),o.setStyle("height",this.contentHeight),l.selectNode=o.getElement(".MWF_selector_selectNode"),l.searchInputDiv=o.getElement(".MWF_selector_searchInputDiv"),l.searchInput=o.getElement(".MWF_selector_searchInput"),l.flatCategoryScrollNode=o.getElement(".MWF_selector_flatCategoryScrollNode"),l.flatCategoryNode=o.getElement(".MWF_selector_flatCategoryNode"),l.letterAreaNode=o.getElement(".MWF_selector_letterAreaNode"),l.itemAreaScrollNode=o.getElement(".MWF_selector_itemAreaScrollNode"),l.itemAreaNode=o.getElement(".MWF_selector_itemAreaNode"),l.itemSearchAreaScrollNode=o.getElement(".MWF_selector_itemSearchAreaScrollNode"),l.itemSearchAreaNode=o.getElement(".MWF_selector_itemSearchAreaNode"),l.selectedScrollNode=o.getElement(".MWF_selector_selectedScrollNode"),l.selectedNode=o.getElement(".MWF_selector_selectedNode"),l.selectedItemSearchAreaNode=o.getElement(".MWF_selector_selectedItemSearchAreaNode"),this.options.flatCategory&&l.flatCategoryScrollNode&&(l.isFlatCategory=!0,l.flatSubCategoryNodeList=[]),l.loadContent(o,!0),"person"==h.toLowerCase()||"group"==h.toLowerCase()){var c=0,d=0;(r=l.itemAreaScrollNode).addEvents({touchstart:function(t){var e=t.touches[0];c=Number(e.pageY)}.bind(this),touchmove:function(t){var e=t.touches[0];d=Number(e.pageY)}.bind(this),touchend:function(t){if(c-d>10){var e=this.selectors.Person;e._scrollEvent(e.itemAreaScrollNode.scrollTop+100)}c=0,d=0}.bind(this)})}}else if(this.contentWidth&&(this.selectors[h].options.width=this.contentWidth),this.contentHeight&&(this.selectors[h].options.height=this.contentHeight),this.selectors[h].loadContent(o),this.selectors[h].setSize(),layout.mobile){var a,r,N=this.container.getSize(),p=$(document.body).getSize(),m={x:Math.min(N.x,p.x),y:Math.min(N.y,p.y)};if(a=t?m.y-40-20-6-20:m.y,this.selectors[h].selectNode&&this.selectors[h].selectNode.setStyle("height",a+"px"),a=t?m.y-40-20-78-20:m.y-42-31-40,a-=5,(r=this.selectors[h].itemAreaScrollNode)&&r.setStyle("height",a+"px"),"person"==h.toLowerCase()||"group"==h.toLowerCase()){c=0,d=0;r.addEvents({touchstart:function(t){var e=t.touches[0];c=Number(e.pageY)}.bind(this),touchmove:function(t){var e=t.touches[0];d=Number(e.pageY)}.bind(this),touchend:function(t){if(c-d>10){var e=this.selectors.Person;e._scrollEvent(e.itemAreaScrollNode.scrollTop+100)}c=0,d=0}.bind(this)})}}0==i&&n.showIm()}.bind(this))}.bind(this))},getValueByType:function(t,e){var i=[];t="array"==typeOf(t)?t:[t];var s="array"==typeOf(e)?e:[e];return t.each((function(t){if(t){if("string"==typeOf(t))var o=t;else o=t.distinguishedName;if(o&&e)switch(o.substr(o.length-1,1).toLowerCase()){case"i":("identity"==e||s.contains("identity"))&&i.push(t);break;case"p":("person"==e||s.contains("person"))&&i.push(t);break;case"u":"unit"==e&&i.push(t);break;case"g":"group"==e&&i.push(t);break;case"r":"role"==e&&i.push(t);break;default:"person"==e&&i.push(t)}}})),i},emptySelectedItems:function(){for(var t in this.selectors){var e=this.selectors[t];e.selectedItems&&e.selectedItems.length>0&&e.emptySelectedItems()}},getSelectedItems:function(){for(var t in this.selectedItems=[],this.selectors){var e=this.selectors[t];e.selectedItems&&e.selectedItems.length>0&&(this.selectedItems=this.selectedItems.concat(e.selectedItems))}return this.selectedItems},getSelectedItemsObject:function(){for(var t in this.selectedItemsObject={},this.selectors){var e=this.selectors[t];e.selectedItems&&e.selectedItems.length>0&&(this.selectedItemsObject[t.toLowerCase()]=e.selectedItems)}return this.selectedItemsObject},getOffsetX:function(t){return(t.getStyle("margin-left").toInt()||0)+(t.getStyle("margin-right").toInt()||0)+(t.getStyle("padding-left").toInt()||0)+(t.getStyle("padding-right").toInt()||0)+(t.getStyle("border-left-width").toInt()||0)+(t.getStyle("border-right-width").toInt()||0)},getOffsetY:function(t){return(t.getStyle("margin-top").toInt()||0)+(t.getStyle("margin-bottom").toInt()||0)+(t.getStyle("padding-top").toInt()||0)+(t.getStyle("padding-bottom").toInt()||0)+(t.getStyle("border-top-width").toInt()||0)+(t.getStyle("border-bottom-width").toInt()||0)},setSize:function(){if(this.options.width||this.options.height){if(this.options.width&&"auto"===this.options.width)this.node.setStyle("width","auto"),this.contentWidth="auto";else if(this.options.width&&"number"===typeOf(this.options.width.toInt())){var t=this.options.width.toInt()-this.getOffsetX(this.node);this.node.setStyle("width",t),this.contentNode&&(t-=this.getOffsetX(this.contentNode)),this.contentWidth=t}if(this.options.height&&"number"===typeOf(this.options.height.toInt())){var e=this.options.height.toInt()-this.getOffsetY(this.node);this.node.setStyle("height",e),this.titleNode&&(e=e-this.getOffsetY(this.titleNode)-this.titleNode.getStyle("height").toInt()),this.actionNode&&(e=e-this.getOffsetY(this.actionNode)-this.actionNode.getStyle("height").toInt()),this.contentNode&&(e-=this.getOffsetY(this.contentNode)),this.contentHeight=e}}}}),MWF.xApplication.Selector.MultipleSelector.Filter=new Class({Implements:[Options,Events],options:{types:[],groups:[],roles:[],units:[]},initialize:function(t,e){this.setOptions(e),this.value=t,this.orgAction=MWF.Actions.get("x_organization_assemble_control"),this.selectors={},this.options.types.each(function(t,e){var i=Object.clone(this.options);this.options[t+"Options"]&&(i=Object.merge(i,this.options[t+"Options"]));var s=t.capitalize();"unit"===t.toLowerCase()&&i.unitType&&(s="UnitWithType"),"identity"===t.toLowerCase()&&i.dutys&&i.dutys.length&&(s="IdentityWidthDuty"),MWF.xDesktop.requireApp("Selector",s,function(){this.selectors[s]=new MWF.xApplication.Selector[s].Filter(this.value,i)}.bind(this),!1)}.bind(this))},filter:function(t,e){this.value=t;this.value;for(i in this.filterData=[],this.filterCount=0,this.selectors)this.selectors[i].filter(t,function(t){this.filterData=this.filterData.concat(t),this.filterCount++,this.endFilter(e)}.bind(this))},endFilter:function(t){this.filterCount>=Object.keys(this.selectors).length&&t&&t(this.filterData)}});