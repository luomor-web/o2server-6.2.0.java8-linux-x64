MWF.xApplication.AppMarketV2.Application.Comment=new Class({Implements:[Options,Events],options:{view:"applicationComment.html"},initialize:function(t,e,n){this.setOptions(n),this.app=t,this.appdata=this.app.appdata,this.container=e,this.viewPath=this.app.path+this.app.options.style+"/"+this.options.view,this.iconPath=this.app.path+this.app.options.style+"/icon/",this.actions=MWF.Actions.load("x_program_center"),this.load()},load:function(){this.container.loadHtml(this.viewPath,{bind:{lp:this.app.lp},module:this},function(){this.loadApplication(function(){this.fireEvent("load")}.bind(this))}.bind(this))},loadApplication:function(t){this.isLoading||(this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.Application.Comment.ViewPage(this,{onLoad:function(){t&&t()}}))}}),MWF.xApplication.AppMarketV2.Application.Comment.ViewPage=new Class({Implements:[Options,Events],options:{type:"commentViewPage"},initialize:function(t,e){this.setOptions(e),this.content=t,this.app=this.content.app,this.appdata=this.content.appdata,this.actions=this.app.actions,this.container=this.content.container,this.page=1,this.pageSize=100,this.querydata={},this.bbsUrlPath="",this.bbsUrl="",this.load()},load:function(){""==this.app.collectToken||""==this.app.collectUrl?this.actions.CollectAction.login(function(t){t.type&&"success"==t.type&&(data=t.data,this.app.collectUrl=data.collectUrl,this.app.collectToken=data.collectToken,this.loadCommentsGrade(this,this.commentsGrade.bind(this)),this.loadCommentPower(this),this.loadCommentsList(this,this.commentsView.bind(this)))}.bind(this),null,!1):(this.loadCommentsGrade(this,this.commentsGrade.bind(this)),this.loadCommentPower(this),this.loadCommentsList(this,this.commentsView.bind(this)))},loadBbsInfo:function(t){var e=null,n=t.app.collectUrl+"/o2_collect_assemble/jaxrs/collect/config/key/(0)?time="+(new Date).getMilliseconds();new Request.JSON({url:n,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,n){e=t,this.bbsUrlPath=e.data.bbsUrlPath,this.bbsUrl=e.data.bbsUrl}.bind(this),onFailure:function(t){o2.runCallback(callback,"requestFailure",[t])}.bind(this),onError:function(t,e){o2.runCallback(callback,"error",[t,e])}.bind(this)}).send()},loadCommentsGrade:function(t,e){this.loadBbsInfo(t);var n=this.bbsUrlPath+"/x_bbs_assemble_control/jaxrs/subject/statgrade/sectionName/"+encodeURI(t.app.lp.title)+"/subjectType/"+encodeURI(t.appdata.name)+"?time="+(new Date).getMilliseconds();new Request.JSON({url:n,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,n){t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,n])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,n){o2.runCallback(e,"error",[t,n])}.bind(this)}).send()},loadCommentPower:function(t,e){var n=new Element("div",{class:"o2_appmarket_application_comment_middle_tip"}).inject(this.content.applicationcommentmiddle);new Element("span",{class:"o2_appmarket_application_introduce_tab_current",text:t.app.lp.bbsNotice}).inject(n),n.addEvents({click:function(e){window.open(t.bbsUrl)}})},loadCommentsList:function(t,e){var n={};n.sectionName=t.app.lp.title,n.subjectType=t.appdata.name;var i=this.bbsUrlPath+"/x_bbs_assemble_control/jaxrs/subject/filter/listsubjectinfo/page/1/count/10";new Request.JSON({url:i,headers:{"Content-Type":"application/json; charset=utf-8","x-debugger":!0},secure:!1,method:"POST",async:!0,emulation:!1,noCache:!0,withCredentials:!0,crossDomain:!0,data:JSON.stringify(n),onSuccess:function(t,n){json=t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,n])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,n){o2.runCallback(e,"error",[t,n])}.bind(this)}).send()},loadCommentsList_bak:function(t,e){var n=t.app.collectUrl+"/o2_collect_assemble/jaxrs/comment/list/app/"+t.appdata.id+"?time="+(new Date).getMilliseconds();new Request.JSON({url:n,headers:{"x-debugger":!0,Authorization:t.app.collectToken,"c-token":t.app.collectToken},secure:!1,method:"get",async:!0,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,n){t,"function"==typeOf(e).toLowerCase()?e(t):o2.runCallback(e,"success",[t,n])}.bind(this),onFailure:function(t){o2.runCallback(e,"requestFailure",[t])}.bind(this),onError:function(t,n){o2.runCallback(e,"error",[t,n])}.bind(this)}).send()},commentsGrade:function(t){var e=0,n=0,i=0,a=t.data,o=["0","0","0","0","0"];a.each(function(t){o[parseInt(t.grade)-1]=t.count,e+=parseInt(t.count)}.bind(this)),o.each((function(t,e){i+=parseInt(t)*(e+1)})),e>0&&(n=this.numberFix(i/e,1)),this.content.applicationcommenttopgrade.set("text",n+"");for(var c=parseInt(n),r=n-c,l=0;l<c;l++)new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular);r>=.5&&(new Element("img",{src:this.content.iconPath+"halffiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular),c++);for(l=0;l<5-c;l++)new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(this.content.applicationcommenttopangular);new Element("span",{class:"o2_appmarket_application_introduce_memo_remark_inner_text",text:this.app.lp.commentCountText.replace("{n}",e)}).inject(this.content.applicationcommenttopangular),new Element("div",{text:"5",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightfive),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=parseInt(o[4])/e,blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfive),new Element("div",{text:"4",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightfour),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=parseInt(o[3])/e,blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightfour),new Element("div",{text:"3",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightthree),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[2])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightthree),new Element("div",{text:"2",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrighttwo),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[1])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrighttwo),new Element("div",{text:"1",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone),gradeangular=new Element("div",{class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone),new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(gradeangular),graderatiodiv=new Element("div",{class:"o2_appmarket_application_comment_gradetotal"}).inject(this.content.applicationcommentrightone),blackratiodiv=new Element("div",{class:"o2_appmarket_application_comment_graderatio"}).inject(graderatiodiv),graderratiodivwidth=graderatiodiv.clientWidth,0==e?(blackratio=0,blackratiodiv.setStyle("width","0px")):(blackratio=(parseInt(o[0])/e).toFixed(4),blackratiowidth=blackratio*graderratiodivwidth,blackratiodiv.setStyle("width",blackratiowidth+"px")),new Element("div",{text:this.numberFix(100*blackratio,1)+"%",class:"o2_appmarket_application_comment_top_right_graderatioItem"}).inject(this.content.applicationcommentrightone)},commentsPower:function(t){var e="";if(t.type&&"success"==t.type&&t.data.value&&(e=this.app.lp.commented),""==this.appdata.installedVersion&&(e=this.app.lp.notInstall),""==e){var n=new Element("div",{class:"o2_appmarket_application_comment_middle_commentbutton"}).inject(this.content.applicationcommentmiddle);new Element("span",{class:"o2_appmarket_application_comment_middle_commentbutton_InnerSpan",text:this.app.lp.iNeedComment}).inject(n);var i=this;n.addEvents({click:function(t){i.createComment(t)}})}else new Element("div",{class:"o2_appmarket_application_comment_middle_tip",text:e}).inject(this.content.applicationcommentmiddle)},commentsView:function(t){t.data.each(function(t){var e=new Element("div",{class:"o2_appmarket_application_comment_content"}).inject(this.content.applicationcommentbottom),n=new Element("div",{class:"o2_appmarket_application_comment_content_left"}).inject(e),i=new Element("div",{class:"o2_appmarket_application_comment_content_left_icon"}).inject(n);new Element("img",{src:this.content.iconPath+"icon_men.png"}).inject(i),new Element("div",{class:"o2_appmarket_application_comment_content_left_name",text:t.creatorNameShort}).inject(n);for(var a=new Element("div",{class:"o2_appmarket_application_comment_content_right"}).inject(e),o=new Element("div").inject(a),c=0;c<parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);for(c=0;c<5-parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);t.content.replace("<p>","").replace("</p>","");var r=this.bbsUrlPath;r.indexOf(":",8)>0&&(r=r.slice(0,r.indexOf(":",8))),r=r+"/x_desktop/forum.html?app=ForumDocument&id="+t.id;var l=new Element("div",{class:"o2_appmarket_application_comment_content_title"}).inject(a),p=(new Element("a",{class:"o2_appmarket_application_comment_content_title_a",text:t.title,href:r,target:"_blank"}).inject(l),new Element("div",{class:"o2_appmarket_application_comment_content_text"}).inject(a)),s=t.content;p.set("html",s)}.bind(this))},commentsView_bak:function(t){t.data.each(function(t){var e=new Element("div",{class:"o2_appmarket_application_comment_content"}).inject(this.content.applicationcommentbottom),n=new Element("div",{class:"o2_appmarket_application_comment_content_left"}).inject(e),i=new Element("div",{class:"o2_appmarket_application_comment_content_left_icon"}).inject(n);new Element("img",{src:this.content.iconPath+"icon_men.png"}).inject(i),new Element("div",{class:"o2_appmarket_application_comment_content_left_name",text:t.person}).inject(n);for(var a=new Element("div",{class:"o2_appmarket_application_comment_content_right"}).inject(e),o=new Element("div").inject(a),c=0;c<parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);for(c=0;c<5-parseInt(t.grade);c++)new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_introduce_memo_remark_inner_pic"}).inject(o);new Element("div",{class:"o2_appmarket_application_comment_content_title",text:t.title}).inject(a),new Element("div",{class:"o2_appmarket_application_comment_content_text",text:t.comment,title:t.comment}).inject(a)}.bind(this))},reload:function(){this.content.isLoading||(this.loadComments(),this.loadCommentPower())},emptyLoadContent:function(){this.content.commentnode.empty(),this.content.isLoading=!1},createComment:function(t){var e,n=new Element("div",{styles:{margin:"20px"}}),i=new Element("div").inject(n);new Element("div",{class:"comment_dlg_title",text:this.app.lp.score}).inject(i),xingpngdiv=new Element("div",{class:"comment_dlg_png"}).inject(i);for(var a=this,o=0,c=0;c<5;c++)(e=new Element("img",{src:this.content.iconPath+"whitefiveangular.png",class:c+"star comment_dlg_star"}).inject(xingpngdiv)).store("id",c),e.addEvents({click:function(t){var e=this.retrieve("id");o=e+1;for(var n=this,i=this.nextElementSibling;i;)i.set("src",a.content.iconPath+"whitefiveangular.png"),i=i.nextElementSibling;for(;n;)n.set("src",a.content.iconPath+"blackfiveangular.png"),n=n.previousElementSibling}});new Element("div",{style:"clear:both"}).inject(n);var r=new Element("div").inject(n);new Element("div",{class:"comment_dlg_title",text:"评论："}).inject(r),inputdiv=new Element("div",{class:"comment_dlg_input_div"}).inject(r),commentcontentNode=new Element("textarea",{class:"comment_dlg_input"}).inject(inputdiv),o2.DL.open({title:this.app.lp.commentTitle,content:n,width:740,height:520,buttonList:[{text:this.app.lp.ok,class:"comment_dlg_button_ok",action:function(){if(0==o||""==commentcontentNode.get("value"))MWF.xDesktop.notice("error",{x:"right",y:"top"},this.app.lp.commentNotice);else{var t={title:""};t.application=a.appdata.id,t.grade=o+"",t.comment=commentcontentNode.get("value"),a.submitComment(t),this.close()}}},{text:this.app.lp.cancel,class:"comment_dlg_button_cancel",action:function(){this.close()}}]})},submitComment:function(t){JSON.stringify(t);var e=this.app.collectUrl+"/o2_collect_assemble/jaxrs/comment";new Request.JSON({url:e,headers:{"Content-Type":"application/json; charset=utf-8","x-debugger":!0,Authorization:this.app.collectToken,"c-token":this.app.collectToken},secure:!1,method:"POST",secure:!1,emulation:!1,noCache:!0,withCredentials:!0,crossDomain:!0,data:JSON.stringify(t),onSuccess:function(t,e){MWF.xDesktop.notice("success",{x:"right",y:"top"},this.app.lp.commentsuccess),this.app.loadIntroduceComment()}.bind(this),onFailure:function(t){MWF.xDesktop.notice("error",{x:"right",y:"top"},t)}.bind(this),onError:function(t,e){MWF.xDesktop.notice("error",{x:"right",y:"top"},t)}.bind(this)}).send()},numberFix:function(t,e){for(var n="",i=0;i<e;i++)n+="0";var a=1+n,o=Math.round(parseFloat(t)*a)/a,c=o.toString().split(".");return 1==c.length?o=o.toString():c.length>1?(c[1].length<e&&(o=o.toString()+"0"),o):void 0}});