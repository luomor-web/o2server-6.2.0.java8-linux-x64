MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.Query=MWF.xApplication.query.Query||{},MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("query.Query","lp."+o2.language,null,!1),MWF.xApplication.query.Query.ImporterRecord=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{queryId:"",importerId:"",style:"default",resizeNode:!0,viewPageNum:1},initialize:function(t,e,i){this.setOptions(i),this.container=t,this.path="../x_component_query_Query/$ImporterRecord/",this.cssPath="../x_component_query_Query/$ImporterRecord/"+this.options.style+"/css.wcss",this._loadCss(),this.app=e,this.lp=MWF.xApplication.query.Query.LP},load:function(){this.checkManager(function(){this._load()}.bind(this))},_load:function(){this.container.empty(),this.actionbarAreaNode=new Element("div.actionbarAreaNode",{styles:this.css.actionbarAreaNode}).inject(this.container),this.viewContainerTop=Element("div",{styles:this.css.viewContainerTop}).inject(this.container),this.viewContainer=Element("div",{styles:this.css.viewContainer}).inject(this.container),this.loadToolbar(),this.loadView(),this.options.resizeNode&&(this.setContentHeightFun=this.setContentHeight.bind(this),this.container.addEvent("resize",this.setContentHeightFun))},setContentHeight:function(){var t=this.container.getSize().y;this.actionbarAreaNode&&(t-=this.actionbarAreaNode.getComputedSize().totalHeight);t-=this.view.pagingContainerBottom.getComputedSize().totalHeight,this.view.viewWrapNode.setStyles({height:t+"px",overflow:"auto"})},destroy:function(){this.resizeWindowFun&&this.app.removeEvent("resize",this.resizeWindowFun),this.view.destroy()},loadToolbar:function(){MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.actionbarAreaNode,{style:"simple"},this);new Element("div",{id:"",MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/icon/upload1.png",title:this.lp.importData,MWFButtonAction:"doImport",MWFButtonText:this.lp.importData}).inject(this.actionbarAreaNode),new Element("div",{id:"",MWFnodetype:"MWFToolBarButton",MWFButtonImage:this.path+""+this.options.style+"/icon/download1.png",title:this.lp.downloadTemplate,MWFButtonAction:"downloadTemplate",MWFButtonText:this.lp.downloadTemplate}).inject(this.actionbarAreaNode);this.toolbar.load()}.bind(this))},loadView:function(){var t=this;this.view=new MWF.xApplication.query.Query.ImporterRecord.View(this.viewContainer,this.app,this,{templateUrl:this.path+this.options.style+"/listItem.json",pagingEnable:!0,wrapView:!0,onPostCreateViewBody:function(){this.app.fireEvent("postCreateViewBody")}.bind(this),pagingPar:{pagingBarUseWidget:!0,position:["bottom"],style:"blue_round",hasReturn:!1,currentPage:this.options.viewPageNum,countPerPage:15,visiblePages:9,hasNextPage:!0,hasPrevPage:!0,hasTruningBar:!0,hasJumper:!0,returnText:"",hiddenWithDisable:!1,text:{prePage:"",nextPage:"",firstPage:this.lp.firstPage,lastPage:this.lp.lastPage},onPostLoad:function(){t.setContentHeight()}}}),this.view.lp=this.lp,this.view.load()},reloadView:function(){this.viewContainer.setStyle("display",""),this.viewContainerTop.setStyle("display",""),this.loadView()},resizeWindow:function(){var t=this.app.content.getSize();this.viewContainer.setStyles({height:t.y-121+"px"})},doImport:function(){MWF.xDesktop.requireApp("query.Query","Importer",function(){new MWF.xApplication.query.Query.Importer(this.container,{id:this.options.importerId},{onAfterImport:function(){this.view&&this.view.reload()}.bind(this)},this.app).load()}.bind(this))},downloadTemplate:function(){MWF.xDesktop.requireApp("query.Query","Importer",function(){new MWF.xApplication.query.Query.Importer(this.container,{id:this.options.importerId},{},this.app).downloadTemplate()}.bind(this))},checkManager:function(t){if("boolean"!==typeOf(this.isManager))return MWF.AC.isQueryManager()?(this.isManager=!0,t&&t(),!0):void(this.options.queryId?o2.Actions.load("x_query_assemble_surface").QueryAction.get(this.options.queryId,function(e){this.isManager=(e.data.controllerList||[]).contains(layout.desktop.session.user.distinguishedName),t&&t()}.bind(this)):this.options.importerId?o2.Actions.load("x_query_assemble_surface").ImportModelAction.get(this.options.importerId,function(e){this.options.queryId=e.data.query,o2.Actions.load("x_query_assemble_surface").QueryAction.get(this.options.queryId,function(e){this.isManager=(e.data.controllerList||[]).contains(layout.desktop.session.user.distinguishedName),t&&t()}.bind(this))}.bind(this)):(this.isManager=!1,t&&t()));t&&t()}}),MWF.xApplication.query.Query.ImporterRecord.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.query.Query.ImporterRecord.ViewLine(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=15),i||(i=1);var o={modelId:this.explorer.options.importerId};o2.Actions.load("x_query_assemble_surface").ImportModelAction.recordListPaging(i,e,o,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){o2.Actions.load("x_query_assemble_surface").ImportModelAction.deleteRecord(t.id,function(t){this.reload(),this.app.notice(this.explorer.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_openDocument:function(t,e){var i=new MWF.xApplication.query.Query.ImporterRecord.Detail(this.explorer.container,this.app,{importerId:this.explorer.options.importerId,recordId:t.id});i.recordView=this,i.load()},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.query.Query.ImporterRecord.ViewLine=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){}}),MWF.xApplication.query.Query.ImporterRecord.Detail=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",importerId:"",recordId:""},initialize:function(t,e,i){this.setOptions(i),this.container=t,this.path="../x_component_query_Query/$ImporterRecord/",this.cssPath="../x_component_query_Query/$ImporterRecord/"+this.options.style+"/css.wcss",this._loadCss(),this.app=e,this.lp=MWF.xApplication.query.Query.LP},load:function(t){o2.Actions.load("x_query_assemble_surface").ImportModelAction.getRecord(this.options.recordId,function(e){this.data=e.data,this.currentStatus=["导入成功","导入失败"].contains(this.data.status)?this.data.status:"",this.createNode(),this.setBaseInfor(),"部分成功"===this.data.status&&this.createTab(),this.dlg||this.openDlg(),t&&t()}.bind(this))},reload:function(){this.view.destroy(),this.node.destroy(),this.load(function(){this.loadView(),this.dlg.button.getElements("input[type='button']").each(function(t){[this.lp.reExecuteImport,this.lp.exportErrorDataToExcel].contains(t.get("value"))&&t.setStyle("display","导入成功"===this.data.status?"none":"")}.bind(this))}.bind(this))},createNode:function(){this.node=new Element("div",{style:"padding:0px;"}),this.dlg&&this.node.inject(this.dlg.content),this.inforNode=new Element("div",{style:"padding:0px;"}).inject(this.node),"部分成功"===this.data.status&&(this.tabNode=new Element("div",{styles:this.css.tabNode}).inject(this.node)),this.viewNode=new Element("div",{style:"padding:0px;"}).inject(this.node)},createTab:function(){[{text:this.lp.importStatusList[0],value:""},{text:this.lp.importStatusList[1],value:"导入成功"},{text:this.lp.importStatusList[2],value:"导入失败"}].each(function(t,e){var i=new Element("div",{styles:this.css.tabItemNode,text:t.text}).inject(this.tabNode);i.addEvent("click",function(){this.currentTabItem&&this.currentTabItem.setStyles(this.css.tabItemNode),this.currentTabItem=i,i.setStyles(this.css.currentTabItemNode),this.currentStatus=t.value,this.view.reload()}.bind(this)),0===e&&(this.currentTabItem=i,i.setStyles(this.css.currentTabItemNode))}.bind(this))},openDlg:function(){var t=this,e={style:"user",title:this.lp.importRecordDetail,content:this.node,offset:{y:0},isMax:!0,width:1e3,height:750,buttonList:[{type:"reExecute",text:this.lp.reExecuteImport,action:function(){t.reExecuteImport()}},{type:"exportWithError",text:this.lp.exportErrorDataToExcel,action:function(){t.exportErrorDataToExcel()}},{type:"cancel",text:this.lp.close,action:function(){t.dlg.close()}}],onResizeCompleted:function(){t.setContentHeight()},onMax:function(){t.setContentHeight()},onRestore:function(){t.setContentHeight()},onPostShow:function(){this.content.setStyle("overflow","hidden"),t.loadView()},onPostClose:function(){t.dlg=null}};"导入成功"===this.data.status&&e.buttonList.splice(0,2),this.dlg=o2.DL.open(e)},setContentHeight:function(){var t=this.dlg.content.getSize().y;this.inforNode&&(t-=this.inforNode.getComputedSize().totalHeight);this.tabNode&&(t-=this.tabNode.getComputedSize().totalHeight);this.view.viewWrapNode.setStyles({height:t+"px",overflow:"auto"})},objectToString:function(t,e){if(!t)return"";var i=[];return Object.each(t,(function(t,o){"style"===e?i.push(o+":"+t+";"):i.push(o+"='"+t+"'")})),i.join(" ")},setBaseInfor:function(){var t=this.objectToString,e=["<table "+t(this.css.properties)+" style='"+t(this.css.tableStyles,"style")+"'>"],i=t(this.css.titleStyles,"style"),o=Object.clone(this.css.contentStyles);o["border-bottom"]||o.border||(o["border-bottom"]="1px solid #eee");var s=t(Object.merge(o,{"text-align":"left"}),"style");e.push("<tr>"),e.push("<th style='"+i+" width:100px;'> "+this.lp.importerName+"</th>"),e.push("<td style='"+s+"'> "+this.data.name+"</td>"),e.push("<th style='"+i+"'> "+this.lp.importCount+"</th>"),e.push("<td style='"+s+"'> "+this.data.count+"</td>"),e.push("<th style='"+i+"'> "+this.lp.importTime+"</th>"),e.push("<td style='"+s+"'> "+this.data.createTime+"</td>"),e.push("<th style='"+i+"'> "+this.lp.importPerson+"</th>"),e.push("<td style='"+s+"'> "+(this.data.creatorPerson||"").split("@")[0]+"</td>"),e.push("</tr>"),e.push("<tr>"),e.push("<th style='"+i+"'> "+this.lp.status+"</th>"),e.push("<td style='"+s+"'> "+this.data.status+"</td>"),e.push("<th style='"+i+"'> "+this.lp.failCount+"</th>"),e.push("<td style='"+s+"'> "+("null"===o2.typeOf(this.data.failCount)?"":this.data.failCount)+"</td>"),e.push("<th style='"+i+"'> "+this.lp.updateTime+"</th>"),e.push("<td style='"+s+"'> "+this.data.updateTime+"</td>"),e.push("<th style='"+i+"'> </th>"),e.push("<td style='"+s+"'> </td>"),e.push("</tr>"),e.push("</table>"),this.inforNode.set("html",e.join(""))},reExecuteImport:function(){var t=this;o2.Actions.load("x_query_assemble_surface").ImportModelAction.reExecuteRecord(this.options.recordId,function(){window.setTimeout(function(e){MWF.xDesktop.requireApp("query.Query","Importer",null,!1);var i=new MWF.xApplication.query.Query.Importer(this.container);new MWF.xApplication.query.Query.Importer.ProgressBar(i,{zindex:(t.dlg.css.from["z-index"]||"1").toInt()+2,disableDetailButton:!0,onPostShow:function(){this.showImporting(t.options.recordId,(function(){t.reload(),t.recordView&&t.recordView.reload()}))}}).importerId=this.options.importerId}.bind(this),500)}.bind(this))},getImporterConfig:function(t){this.importerJSON?t&&t():o2.Actions.load("x_query_assemble_surface").ImportModelAction.get(this.options.importerId,function(e){e.data.data=JSON.parse(e.data.data),this.importerJSON=e.data,t&&t()}.bind(this))},loadView:function(){this.getImporterConfig(function(){this._loadView()}.bind(this))},_loadView:function(){this.view=new MWF.xApplication.query.Query.ImporterRecord.DetailView(this.viewNode,this.app,this,{templateUrl:this.path+this.options.style+"/detailListItem.json",pagingEnable:!0,wrapView:!0,onPostCreateViewBody:function(){this.app.fireEvent("postCreateViewBody")}.bind(this),onPostReloadLoad:function(){this.setContentHeight()}.bind(this),pagingPar:{pagingBarUseWidget:!0,position:["bottom"],style:"blue_round",hasReturn:!1,currentPage:this.options.viewPageNum,countPerPage:15,visiblePages:7,hasNextPage:!0,hasPrevPage:!0,hasTruningBar:!0,hasJumper:!0,returnText:"",hiddenWithDisable:!1,text:{prePage:"",nextPage:"",firstPage:this.lp.firstPage,lastPage:this.lp.lastPage},onPostLoad:function(){this.setContentHeight()}.bind(this)}}),this.view.lp=this.lp,this.view.pagingContainerBottom=new Element("div",{styles:{float:"left"}}).inject(this.dlg.button),this.view.load()},exportErrorDataToExcel:function(){var t=function(t){MWF.xDesktop.requireApp("query.Query","Importer",null,!1),new MWF.xApplication.query.Query.Importer(this.container,{id:this.options.importerId},{},this.app).exportWithImportDataToExcel(t)}.bind(this);if("dynamicTable"===this.importerJSON.type){this.viewData||(this.viewData=JSON.parse(this.data.data));var e=[];this.viewData.each(function(t){var i="string"===o2.typeOf(t)?JSON.parse(t):t;"object"===o2.typeOf(i)?i.o2ErrorText=this.data.distribution||"":i.push(this.data.distribution||""),e.push(i)}.bind(this)),t(e)}else o2.Actions.load("x_query_assemble_surface").ImportModelAction.recordItemListPaging(1,1e5,{recordId:this.options.recordId,status:"导入失败"},function(e){var i=[];e.data.each((function(t){var e="string"===o2.typeOf(t.srcData)?JSON.parse(t.srcData):t.srcData;"object"===o2.typeOf(e)?e.o2ErrorText=t.distribution||"":e.push(t.distribution||""),i.push(e)})),t(i)}.bind(this))},switchSrcDataCount:function(){this.isShowAll=!this.isShowAll,this.view.options.pagingPar.currentPage=this.view.paging.options.currentPage,this.view.reload()}}),MWF.xApplication.query.Query.ImporterRecord.DetailView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.query.Query.ImporterRecord.DetailViewLine(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){if(this.clearBody(),e||(e=15),i||(i=1),"dynamicTable"===this.explorer.importerJSON.type&&"导入失败"===this.explorer.currentStatus){this.explorer.viewData||(this.explorer.viewData=JSON.parse(this.explorer.data.data));for(var o={data:[],count:this.explorer.viewData.length},s=e*i,n=e*(i-1);n<s&&n<o.count;n++)o.data.push({status:"导入失败",createTime:this.explorer.data.createTime,distribution:this.explorer.data.distribution||"",srcData:this.explorer.viewData[n]||[]});t&&t(o)}else{var r={recordId:this.explorer.options.recordId};this.explorer.currentStatus&&(r.status=this.explorer.currentStatus),o2.Actions.load("x_query_assemble_surface").ImportModelAction.recordItemListPaging(i,e,r,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))}},_removeDocument:function(t,e){},_create:function(){},_openDocument:function(t,e){"cms"===t.docType?this.openCms(t,e):"process"===t.docType&&this.openWork(t.docId,e)},openCms:function(t,e){var i={documentId:t.docId};layout.desktop.openApplication(e,"cms.Document",i)},openWork:function(t,e){var i={workId:t};layout.desktop.openApplication(e,"process.Work",i)},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){var e=this.explorer.importerJSON.data.columnList;t.getElements("th").each(function(i){if("importData"===i.get("lable")){var o=this.explorer.isShowAll?e.length:Math.min(e.length,5);if(e.length>5)new Element("div",{text:this.explorer.isShowAll?this.lp.showFiveColumn:this.lp.showAll,styles:this.css.actionNode_showAll}).inject(i).addEvent("click",function(){this.explorer.switchSrcDataCount()}.bind(this));for(var s=new Element("tr").inject(t,"after"),n=0;n<o;n++){var r=e[n];new Element("th",{text:r.displayName,styles:this.css.normalThNode}).inject(s)}i.set("colspan",o)}else i.set("rowspan",2)}.bind(this))}}),MWF.xApplication.query.Query.ImporterRecord.DetailViewLine=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElement("[item='importData']"),o="string"===o2.typeOf(e.srcData)?JSON.parse(e.srcData||"{}"):e.srcData,s=this.explorer.importerJSON.data.columnList,n=this.explorer.isShowAll?s.length:Math.min(s.length,5),r=function(t){var e=o2.typeOf(t);return"object"===e?JSON.stringify(t):"array"===e?t.join(","):"null"===e?"":t};if("object"===o2.typeOf(o))for(var a=0;a<n;a++){var p=s[a];new Element("td",{text:r(o[p.path]),styles:this.css.normalTdCenterNode}).inject(i,"before")}else for(a=0;a<n;a++)new Element("td",{text:r(o[a]),styles:this.css.normalTdCenterNode}).inject(i,"before");i.destroy()},open:function(t){this.view._openDocument(this.data,t)},edit:function(){}});