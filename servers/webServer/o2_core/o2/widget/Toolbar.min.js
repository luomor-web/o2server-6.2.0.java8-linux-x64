o2.widget=o2.widget||{},o2.widget.Toolbar=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default"},initialize:function(t,s,i){this.setOptions(s),this.bindObject=i,this.items={},this.children=[],this.childrenButton=[],this.childrenMenu=[],this.path=o2.session.path+"/widget/$Toolbar/",this.cssPath=o2.session.path+"/widget/$Toolbar/"+this.options.style+"/css.wcss",this._loadCss(),this.node=$(t),this.node.onselectstart=function(){return!1},this.node.oncontextmenu=function(){return!1}},load:function(){this.fireEvent("queryLoad")&&(this.node.set("styles",this.css.container),this._loadToolbarItemNode(),this._loadToolbarItems(),this.fireEvent("postLoad"))},_loadToolbarItemNode:function(){this.node.getChildren().each(function(t,s){var i=t.get("MWFnodetype");i&&("array"==typeOf(this[i])||(this[i]=[]),this[i].push(t))}.bind(this))},_loadToolbarItems:function(){this._loadToolBarSeparator(this.MWFToolBarSeparator),this._loadToolBarButton(this.MWFToolBarButton),this._loadToolBarOnOffButton(this.MWFToolBarOnOffButton),this._loadToolBarMenu(this.MWFToolBarMenu)},_loadToolBarSeparator:function(t){t&&t.each(function(t,s){t.set("styles",this.css.toolbarSeparator)}.bind(this))},_loadToolBarButton:function(t){t&&t.each(function(t,s){var i=new o2.widget.ToolbarButton(t,this,this.options);i.load(),this.fireEvent("buttonLoad",[i]),i.buttonID&&(this.items[i.buttonID]=i),this.children.push(i),this.childrenButton.push(i)}.bind(this))},_loadToolBarOnOffButton:function(t){t&&t.each(function(t,s){var i=new o2.widget.ToolbarOnOffButton(t,this,this.options);i.load(),this.fireEvent("buttonLoad",[i]),i.buttonID&&(this.items[i.buttonID]=i),this.children.push(i),this.childrenButton.push(i)}.bind(this))},_loadToolBarMenu:function(t){var s=this;t&&t.each(function(t,i){var o=new o2.widget.ToolbarMenu(t,this,{onAddMenuItem:function(t){this.fireEvent("addMenuItem",[t])}.bind(this),onMenuQueryShow:function(t){s.fireEvent("menuQueryShow",[this,t])},onMenuPostShow:function(t){s.fireEvent("menuPostShow",[this,t])},onMenuQueryHide:function(t){s.fireEvent("menuQueryHide",[this,t])},onMenuPostHide:function(t){s.fireEvent("menuPostHide",[this,t])},onLoad:function(t){s.fireEvent("menuLoaded",[this,t])}});o.load(),this.fireEvent("menuLoad",[o]),o.buttonID&&(this.items[o.buttonID]=o),this.children.push(o),this.childrenMenu.push(o)}.bind(this))}}),o2.widget.ToolbarButton=new Class({Implements:[Options,Events],options:{text:"",title:"",pic:"",action:"",actionScript:"",disable:!1},initialize:function(t,s,i){if(this.setOptions(i),this.node=$(t),this.toolbar=s,this.buttonID=this.node.get("MWFnodeid")||this.node.get("id"),this.node){var o=this.node.get("MWFButtonText");o&&(this.options.text=o);var e=this.node.get("title");e&&(this.options.title=e);var n=this.node.get("MWFButtonImage");n&&(this.options.pic=n);var h=this.node.get("MWFButtonImageOver");h&&(this.options.pic_over=h),this.node.get("MWFButtonDisable")&&(this.options.disable=!0);var d=this.node.get("MWFButtonAction");d&&(this.options.action=d)}else this.node=new Element("div").inject(this.toolbar.node);this.modifiyStyle=!0},load:function(){this._addButtonEvent(),this.node.title=this.options.title,this.node.set("styles",this.toolbar.css.button),this.options.pic&&(this.picNode=this._createImageNode(this.options.pic)),this.options.text&&(this.textNode=this._createTextNode(this.options.text)),this.setDisable(this.options.disable)},enable:function(){this.options.disable&&(this.setDisable(!1),this.options.disable=!1)},disable:function(){this.options.disable||(this.setDisable(!0),this.options.disable=!0)},setDisable:function(t){if(t){if(!this.options.disable){if(this.options.disable=!0,this.node.set("styles",this.toolbar.css.buttonDisable),this.picNode){this.picNode.set("styles",this.toolbar.css.buttonImgDivDisable);var s=(o=(i=this.picNode.getElement("img")).get("src")).substr(o.lastIndexOf("."),o.length);o=(o=o.substr(0,o.lastIndexOf(".")))+"_gray"+s,i.set("src",o)}this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDivDisable)}}else if(this.options.disable){var i,o;if(this.options.disable=!1,this.node.set("styles",this.toolbar.css.button),this.picNode)this.picNode.set("styles",this.toolbar.css.buttonImgDiv),o=(o=(i=this.picNode.getElement("img")).get("src")).replace("_gray",""),i.set("src",o);this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDiv)}},_createImageNode:function(t){if(t){var s=new Element("span",{styles:this.toolbar.css.buttonImgDiv}).inject(this.node);this.imgNode=new Element("img",{styles:this.toolbar.css.buttonImg,src:t}).inject(s);return s}return null},_createTextNode:function(t){return t?new Element("span",{styles:this.toolbar.css.buttonTextDiv,text:t}).inject(this.node):null},setText:function(t){this.node.getLast().set("text",t)},_addButtonEvent:function(){this.node.addEvent("mouseover",this._buttonMouseOver.bind(this)),this.node.addEvent("mouseout",this._buttonMouseOut.bind(this)),this.node.addEvent("mousedown",this._buttonMouseDown.bind(this)),this.node.addEvent("mouseup",this._buttonMouseUp.bind(this)),this.node.addEvent("click",this._buttonClick.bind(this))},_buttonMouseOver:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonOver)),this.options.pic_over&&!this.options.disable&&this.imgNode&&this.imgNode.set("src",this.options.pic_over)},_buttonMouseOut:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonOut)),this.options.pic_over&&!this.options.disable&&this.imgNode&&this.imgNode.set("src",this.options.pic)},_buttonMouseDown:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonDown))},_buttonMouseUp:function(){this.modifiyStyle&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonUp))},_buttonClick:function(t){if(!this.options.disable&&this.options.action)if("string"===typeOf(this.options.action)){var s=this.options.action.split(":"),i=s.shift(),o=this.toolbar.bindObject?this.toolbar.bindObject:window;o[i]?(s.push(this),s.push(t),o[i].apply(o,s)):window[i]&&window[i].apply(this,s)}else this.options.action()}}),o2.widget.ToolbarOnOffButton=new Class({Implements:[Options,Events],Extends:o2.widget.ToolbarButton,on:function(){"on"!==this.status&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonDown),this.modifiyStyle=!1,this.status="on",this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDivDown))},off:function(){"on"===this.status&&(this.options.disable||this.node.set("styles",this.toolbar.css.buttonOut),this.modifiyStyle=!0,this.status="off",this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDiv))},_buttonClick:function(t){if("on"===this.status?(this.options.disable||this.node.set("styles",this.toolbar.css.buttonOut),this.modifiyStyle=!0,this.status="off",this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDiv)):(this.options.disable||this.node.set("styles",this.toolbar.css.buttonDown),this.modifiyStyle=!1,this.status="on",this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDivDown)),!this.options.disable&&this.options.action)if("string"===typeOf(this.options.action)){var s=this.options.action.split(":"),i=s.shift(),o=this.toolbar.bindObject?this.toolbar.bindObject:window;s.push(this.status),s.push(this),o[i]?(s.push(this),s.push(t),o[i].apply(o,s)):window[i]&&window[i].apply(this,s)}else this.options.action()}}),o2.widget.ToolbarMenu=new Class({Implements:[Options,Events],Extends:o2.widget.ToolbarButton,initialize:function(t,s,i){this.parent(t,s,i),this.modifiyStyle=!0,this.menu=null,this.buttonID=this.node.get("MWFnodeid")||this.node.get("id")},setDisable:function(t){if(this.menu&&(this.menu.options.disable=t),t){if(this.node.set("styles",this.toolbar.css.buttonDisable),this.picNode){this.picNode.set("styles",this.toolbar.css.buttonImgDivDisable);var s=(o=(i=this.picNode.getElement("img")).get("src")).substr(o.lastIndexOf("."),o.length);o=(o=o.substr(0,o.lastIndexOf(".")))+"_gray"+s,i.set("src",o)}this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDivDisable)}else{var i,o;if(this.node.set("styles",this.toolbar.css.button),this.picNode)this.picNode.set("styles",this.toolbar.css.buttonImgDiv),o=(o=(i=this.picNode.getElement("img")).get("src")).replace("_gray",""),i.set("src",o);this.textNode&&this.textNode.set("styles",this.toolbar.css.buttonTextDiv)}},load:function(){this._addButtonEvent(),this.node.title=this.options.title,this.node.set("styles",this.toolbar.css.button),this.options.pic&&(this.picNode=this._createImageNode(this.options.pic)),this.options.text&&(this.textNode=this._createTextNode(this.options.text)),this._createDownNode();var t=this;o2.require("o2.widget.Menu",function(){this.menu=new o2.widget.Menu(this.node,{style:this.toolbar.options.style,bindObject:this.options.bindObject,event:"click",disable:t.options.disable,onQueryShow:function(){var s=t.node.getPosition(t.node.getOffsetParent()),i=t.node.getSize();return this.setOptions({top:s.y+i.y-2,left:s.x}),t.fireEvent("menuQueryShow",[this]),!0},onPostShow:function(){var s=t.node.getPosition(t.node.getOffsetParent()),i=t.node.getSize();t.node.set("styles",{"background-color":this.node.getStyle("background-color"),"border-top":this.node.getStyle("border-top"),"border-right":this.node.getStyle("border-top"),"border-left":this.node.getStyle("border-top"),"border-bottom":"0"}),t.modifiyStyle=!1,t.tmpStyleNode=new Element("div.MWFtmpStyleNode",{styles:{position:"absolute",top:s.y+i.y-2,left:s.x+1,width:i.x-2,"z-index":this.node.getStyle("z-index")+1,"background-color":this.node.getStyle("background-color"),height:"1px",overflow:"hidden"}}).inject(t.node),t.fireEvent("menuPostShow",[this])},onQueryHide:function(){t.fireEvent("menuQueryHide",[this])},onPostHide:function(){t.node.set("styles",t.toolbar.css.button),t.modifiyStyle=!0,t.tmpStyleNode&&t.tmpStyleNode.destroy(),t.fireEvent("menuPostHide",[this])}}),this.menu.load(),this.fireEvent("load",[this.menu]),this.addMenuItems()}.bind(this)),this.setDisable(this.options.disable)},_createDownNode:function(){var t=new Element("div",{styles:this.toolbar.css.toolbarButtonDownNode}).inject(this.node);return t.set("html",'<img src="'+o2.session.path+"/widget/$Toolbar/"+this.toolbar.options.style+'/downicon.gif" />'),t},addMenuItems:function(){this.node.getChildren().each(function(t,s){var i=t.get("MWFnodetype");"MWFToolBarMenuItem"==i&&this._loadMenuItem(t),"MWFToolBarMenuLine"==i&&this._loadMenuLine(t)}.bind(this))},_loadMenuItem:function(t){var s=this,i=this.menu.addMenuItem(t.get("MWFButtonText"),"click",(function(i){s._menuItemClick(t.get("MWFButtonAction"),i,this)}),t.get("MWFButtonImage"),t.get("MWFButtonDisable"));this.fireEvent("addMenuItem",[i])},_menuItemClick:function(t,s,i){if(t){var o=t.split(":"),e=o.shift(),n=this.toolbar.bindObject?this.toolbar.bindObject:window;n[e]?(o.push(this),o.push(s),o.push(i),n[e].apply(n,o),this.menu.hideMenu()):window[e]&&(window[e].apply(this,o),this.menu.hideMenu())}},_loadMenuLine:function(){this.menu.addMenuLine()}});