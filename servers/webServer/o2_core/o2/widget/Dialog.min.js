o2.widget=o2.widget||{},o2.widget.Dialog=o2.DL=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",title:"dialog",width:"300",height:"150",contentWidth:null,contentHeight:null,top:"0",left:"0",fromTop:"0",fromLeft:"0",mark:!0,html:"",text:"",url:"",content:null,lp:null,isMax:!1,isClose:!1,isResize:!0,isMove:!0,isTitle:!0,buttons:null,buttonList:null,maskNode:null,transition:null,duration:200,container:null},initialize:function(t){this.setOptions(t),this.path=o2.session.path+"/widget/$Dialog/",this.cssPath=o2.session.path+"/widget/$Dialog/"+this.options.style+"/css.wcss",this._loadCss(),this.reStyle(),this.fireEvent("queryLoad"),this.getContentUrl(),new Request.HTML({url:this.contentUrl,method:"GET",async:!1,onSuccess:function(t,i,e,s){this.node=t[0],this.getDialogNode(),this.fireEvent("postLoad")}.bind(this),onFailure:function(t){alert(t)}}).send()},getContentUrl:function(){this.contentUrl=o2.session.path+"/widget/$Dialog/"+this.options.style+"/dialog.html"},reStyle:function(t){t&&this.setOptions(t),this.css.to.height=this.options.height+"px",this.css.to.width=this.options.width+"px",this.css.to.top=this.options.top+"px",this.css.to.left=this.options.left+"px",this.css.from.top=this.options.fromTop+"px",this.css.from.left=this.options.fromLeft+"px",this.node&&this.node.set("styles",this.css.from)},getParentSelect:function(t){for(var i="",e=t.getParent();!i&&e;){i=e.getStyle("-webkit-user-select");e=e.getParent()}return i},getDialogNode:function(){this.node.set("styles",this.css.from),this.node.inject(this.options.container||$(document.body)),this.node.addEvent("selectstart",function(t){var i=t.target.getStyle("-webkit-user-select");i||(i=this.getParentSelect(t.target)),i=i?i.toString().toLowerCase():"none";var e=t.target.tagName.toString().toLowerCase();"text"!=i&&"auto"!=i&&-1==["input","textarea"].indexOf(e)&&t.preventDefault()}.bind(this)),this.title=this.node.getElement(".MWF_dialod_title"),this.titleCenter=this.node.getElement(".MWF_dialod_title_center"),this.titleRefresh=this.node.getElement(".MWF_dialod_title_refresh"),this.titleText=this.node.getElement(".MWF_dialod_title_text"),this.titleAction=this.node.getElement(".MWF_dialod_title_action"),this.under=this.node.getElement(".MWF_dialod_under"),this.content=this.node.getElement(".MWF_dialod_content"),this.bottom=this.node.getElement(".MWF_dialod_bottom"),this.resizeNode=this.node.getElement(".MWF_dialod_bottom_resize"),this.button=this.node.getElement(".MWF_dialod_button"),this.options.isTitle||(this.title.destroy(),this.title=null,this.titleCenter=null,this.titleRefresh=null,this.titleText=null,this.titleAction=null),this.title&&this.title.setStyles(this.css.MWF_dialod_title),this.titleCenter&&this.titleCenter.setStyles(this.css.MWF_dialod_title_center),this.titleRefresh&&this.titleRefresh.setStyles(this.css.MWF_dialod_title_refresh),this.titleText&&this.titleText.setStyles(this.css.MWF_dialod_title_text),this.titleAction&&this.titleAction.setStyles(this.css.MWF_dialod_title_action),this.under&&this.under.setStyles(this.css.MWF_dialod_under),this.content&&this.content.setStyles(this.css.MWF_dialod_content),this.bottom&&this.bottom.setStyles(this.css.MWF_dialod_bottom),this.resizeNode&&this.resizeNode.setStyles(this.css.MWF_dialod_bottom_resize),this.button&&this.button.setStyles(this.css.MWF_dialod_button),this.title&&this.setTitleEvent(),this.titleRefresh&&this.setTitleRefreshNode(),this.content&&this.getContent(),this.titleAction&&this.getAction(),this.resizeNode&&this.setResizeNode(),this.content&&this.setContentSize()},setTitleRefreshNode:function(){this.titleRefresh.setStyles(this.css.titleRefresh),this.titleRefresh.set("title",o2.LP.widget.refresh)},setTitleEvent:function(){var t;layout.app&&(t=layout.app.content),layout.desktop.currentApp&&(t=layout.desktop.currentApp.content),this.containerDrag=new Drag.Move(this.node,{handle:this.title,container:this.options.container||this.markNode||t,snap:5})},setResizeNode:function(){this.options.isResize?this.resizeNode&&this.node.makeResizable({handle:this.resizeNode||this.bottom,limit:{x:[200,null],y:[150,null]},onDrag:function(){var t=this.node.getComputedSize();this.css.to.width=t.width,this.css.to.height=t.height,this.setContentSize(t.height,t.width),this.fireEvent("resize")}.bind(this),onComplete:function(){this.fireEvent("resizeCompleted")}.bind(this)}):this.resizeNode&&this.resizeNode.hide()},getAction:function(){this.options.isClose&&(this.closeAction=new Element("div",{styles:this.css.closeAction}).inject(this.titleAction),this.closeAction.addEvent("click",this.close.bind(this)))},getButton:function(){for(i in this.options.buttons)new Element("input",{type:"button",value:i,class:"mainColor_bg",styles:this.css.button,events:{click:this.options.buttons[i].bind(this)}}).inject(this.button);this.options.buttonList&&this.options.buttonList.each(function(t){var i=this.css.button;"ok"===t.type&&this.css.okButton&&(i=this.css.okButton),"cancel"===t.type&&this.css.cancelButton&&(i=this.css.cancelButton),t.styles&&(i=t.styles);new Element("input",{type:"button",value:t.text,title:t.title,class:"cancel"!==t.type?"mainColor_bg":"",styles:i,events:{click:function(i){t.action.call(this,this,i)}.bind(this)}}).inject(this.button)}.bind(this))},getContentSize:function(t,i){var e,s;t||(this.options.contentHeight?e=t=this.options.contentHeight.toFloat():t=this.options.height.toFloat()),i||(this.options.contentWidth?s=i=this.options.contentWidth.toFloat():i=this.options.width.toFloat());var o,n=0;if(this.title){var h=this.title.getSize().y,l=this.title.getStyle("padding-top").toFloat(),a=this.title.getStyle("padding-bottom").toFloat(),d=this.title.getStyle("margin-top").toFloat(),r=this.title.getStyle("margin-bottom").toFloat();n+=h+l+a+d+r}if(this.bottom){var c=this.bottom.getSize().y,p=this.bottom.getStyle("padding-top").toFloat(),u=this.bottom.getStyle("padding-bottom").toFloat(),g=this.bottom.getStyle("margin-top").toFloat(),m=this.bottom.getStyle("margin-bottom").toFloat();n+=c+p+u+g+m}if(this.button){var f=this.button.getSize().y,y=this.button.getStyle("padding-top").toFloat(),b=this.button.getStyle("padding-bottom").toFloat(),S=this.button.getStyle("margin-top").toFloat(),_=this.button.getStyle("margin-bottom").toFloat();n+=f+y+b+S+_}var F=this.content.getStyle("padding-top").toFloat(),x=this.content.getStyle("padding-bottom").toFloat(),v=this.content.getStyle("margin-top").toFloat(),w=this.content.getStyle("margin-bottom").toFloat();n+=F+x+v+w;var k=0;if(e?e=e+n+2:(t-=n)<0&&(k=(k=(this.options.container||$(document.body)).getSize().y)-n-10),o=this.content.getStyle("padding-left").toFloat()+this.content.getStyle("padding-right").toFloat()+this.content.getStyle("margin-left").toFloat()+this.content.getStyle("margin-right").toFloat(),s?s+=o:i-=o,e&&(this.options.height=e,this.options.contentHeight=null,this.options.fromTop=this.options.fromTop.toFloat()-n/2,this.options.top=this.options.top.toFloat()-n/2,this.css.to.height=e+"px",this.css.to.top=this.options.top+"px",this.css.from.top=this.options.fromTop+"px"),s&&(this.options.width=s,this.options.contentWidth=null,this.options.fromLeft=this.options.fromLeft.toFloat()-o/2,this.options.left=this.options.left.toFloat()-o/2,this.css.to.width=s+"px",this.css.to.left=this.options.left+"px",this.css.from.left=this.options.fromLeft+"px"),!t||t<0){this.content.setStyles({overflow:"hidden",height:"auto",width:i+"px"}),k&&this.content.setStyles({"max-height":k+"px"});var z=(t=this.content.getSize().y)+h+l+a+d+r;z=(z=(z=z+c+p+u+g+m)+f+y+b+S+_)+F+x+v+w,this.css.to.height=z}return{height:t+"px",width:i+"px"}},setContentSize:function(t,i){this.content.setStyles(this.getContentSize(t,i)),this.content.setStyle("width","auto")},reCenter:function(){var t=this.node.getSize(),i=$(document.body);layout.desktop.currentApp?i=layout.desktop.currentApp.content:this.options.container&&this.options.container.getSize().y<$(document.body).getSize().y&&(i=this.options.container);var e=o2.getCenter(t,i,i);e.y<0&&(e.y=0),this.options.top=e.y,this.options.left=e.x,this.css.to.top=this.options.top+"px",this.css.to.left=this.options.left+"px",this.node.setStyles({top:this.css.to.top,left:this.css.to.left})},getTitle:function(){this.titleText.set("text",this.options.title)},getContent:function(){this.content.setStyles(this.css.content),this.options.content?this.options.content.inject(this.content):this.options.url?(this.content.set("load",{method:"get",async:!1}),$(this.content).loadHtml(this.options.url,{bind:{lp:this.options.lp}})):this.options.html?this.content.set("html",this.options.html):this.options.text&&this.content.set("text",this.options.text)},show:function(){if(this.options.mark&&this._markShow(),this.morph||(this.morph=new Fx.Morph(this.node,{duration:this.options.duration,transition:this.options.transition})),this.fireEvent("queryShow")){this.node.setStyle("display","block");var t=this.node.getOffsetParent().getPosition(),i=this.css.to.height.toInt(),e=this.css.to.top.toInt();e+=t.y;var s=window.innerHeight.toInt();i+e>s&&((e=s-t.y-i-20)<0&&(e=0),this.css.to.top=e+"px"),this.morph.start(this.css.to).chain(function(){this.titleText&&this.getTitle(),this.button&&this.getButton(),this.fireEvent("postShow")}.bind(this))}},hide:function(){this.morph||(this.morph=new Fx.Morph(this.node,{duration:this.options.duration,transition:this.options.transition})),this.fireEvent("queryHide")&&(this.titleText&&this.titleText.set("text",""),this.button&&this.button.set("html",""),this.morph.start(this.css.from).chain(function(){this._markHide(),this.node.setStyle("display","none"),this.fireEvent("postHide")}.bind(this)))},close:function(){this.morph||(this.morph=new Fx.Morph(this.node,{duration:this.options.duration,transition:this.options.transition})),this.fireEvent("queryClose")&&this.morph.start(this.css.from).chain(function(){this._markHide(),this.node.destroy(),this.node=null,this.fireEvent("postClose")}.bind(this))},_markShow:function(){if(this.options.mark){if(!this.markNode){var t=o2.getMarkSize(this.options.maskNode);this.markNode=new Element("div",{styles:this.css.mark}).inject(this.options.container||$(document.body)),this.markNode.set("styles",{height:t.y,width:t.x})}this.markNode.setStyle("display","block")}},_markHide:function(){this.markNode&&(this.markNode.setStyle("display","none"),this.markNode.destroy(),this.markNode=null),this.markNode_up&&(this.markNode_up.setStyle("display","none"),this.markNode_up.destroy(),this.markNode_up=null)}});