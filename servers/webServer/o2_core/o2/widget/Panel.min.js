o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.Panel=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{title:"Panel",style:"default",width:260,height:300,top:0,left:0,minTop:0,minLeft:0,isMove:!0,isClose:!0,isMax:!0,isExpand:!0,isResize:!0,limitMove:!0,transition:Fx.Transitions.Back.easeIn,transitionOut:Fx.Transitions.Back.easeOut,duration:100,target:null},initialize:function(t,i){this.setOptions(i),this.node=$(t),this.container=new Element("div"),this.path=o2.session.path+"/widget/$Panel/",this.cssPath=o2.session.path+"/widget/$Panel/"+this.options.style+"/css.wcss",this._loadCss(),this.setStatus(),o2.widget.Panel.panels.push(this)},load:function(){this.fireEvent("queryLoad")&&(this.container.set("styles",this.css.container),this.container.set("styles",{width:this.options.width.toFloat()+"px",height:this.options.height.toFloat()+"px"}),this.createTitleNode(),this.content=new Element("div",{styles:this.css.panelContent}).inject(this.container),this.createBottomNode(),this.options.target||(this.options.target=$(document.body)),this.container.inject(this.options.target),this.content.setStyle("height",this.getContentHeight()),this.node.inject(this.content),this.setPositions(),this.options.isMove&&this.setMove(),this.options.isResize&&this.setResize(),this.show())},show:function(){this.showHideMorph||(this.showHideMorph=new Fx.Morph(this.container,{duration:this.options.duration,transition:this.options.transition})),this.showHideMorph.start(this.css.containerShow).chain(function(){this.fireEvent("postLoad")}.bind(this))},getContentHeight:function(t,i,e){var n=t;n||(n=this.titleNode.getSize());var o=i;o||(o=this.bottomNode.getSize());var s=e;s||(s=this.container.getSize()),paddingTop=this.container.getStyle("padding-top"),paddingBottom=this.container.getStyle("padding-bottom"),paddingLeft=this.container.getStyle("padding-left"),paddingRight=this.container.getStyle("padding-right"),this.options.height=s.y.toFloat()-paddingTop.toFloat()-paddingBottom.toFloat(),this.options.width=s.x.toFloat()-paddingLeft.toFloat()-paddingRight.toFloat();var h=this.options.height.toFloat()-n.y.toFloat()-o.y.toFloat();return h<10&&(h=10),h-2},setMove:function(){this.panelMove=new Drag.Move(this.container,{container:this.options.limitMove?this.options.target:null,handle:this.titleNode,onDrag:function(t,i){this.fireEvent("drag",[t,i])}.bind(this),onComplete:function(t,i){this.options.top=this.container.getStyle("top").toFloat(),this.options.left=this.container.getStyle("left").toFloat(),this.fireEvent("completeMove",[t,i])}.bind(this)})},setResize:function(){this.container.makeResizable({handle:this.resizeAction,onDrag:function(){this.content.setStyle("height",this.getContentHeight()),this.fireEvent("resize")}.bind(this),limit:{x:[120,null],y:[120,null]}})},setPositions:function(){if(this.options.status.active){var t=this.options.target.getPosition(),i=t.y.toFloat()+this.options.top.toFloat(),e=t.x.toFloat()+this.options.left.toFloat(),n=this.options.target.getOffsetParent();if(n){var o=n.getPosition();i-=o.y,e-=o.x}this.container.setStyles({position:"absolute",top:i,left:e})}},setStatus:function(){this.options.status={},this.options.status.active=!0,this.options.status.expand=!0,this.options.status.max=!1},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.panelTitleNode}).inject(this.container),this.actionNode=new Element("div",{styles:this.css.panelActionNode}).inject(this.titleNode),this.textNode=new Element("div",{styles:this.css.panelTextNode,text:this.options.title}).inject(this.titleNode),this.options.isClose&&this.createCloseAction(),this.options.isMax&&this.createMaxAction(),this.options.isExpand&&this.createExpandAction(),this.titleNode.addEvent("click",function(){var t=this.container.getStyle("z-index").toInt(),i=t;o2.widget.Panel.panels.each(function(i){var e=i.container.getStyle("z-index");t.toFloat()<e.toFloat()&&(t=e)}.bind(this)),i!=(t=t.toFloat()+1)&&this.container.setStyle("z-index",t)}.bind(this))},createCloseAction:function(){this.closeAction=new Element("div",{styles:this.css.closeAction}).inject(this.actionNode),this.closeAction.addEvent("click",function(){this.closePanel()}.bind(this))},closePanel:function(){this.fireEvent("queryClose"),this.showHideMorph||(this.showHideMorph=new Fx.Morph(this.container,{duration:this.options.duration,transition:this.options.transition})),this.showHideMorph.start(this.css.container).chain(function(){o2.widget.Panel.panels.erase(this),this.container.destroy(),this.fireEvent("postClose"),o2.release(this)}.bind(this))},destroy:function(){this.container.destroy()},createMaxAction:function(){this.maxAction=new Element("div",{styles:this.css.maxAction}).inject(this.actionNode),this.maxAction.addEvent("click",function(){this.maxReturnPanel()}.bind(this))},maxReturnPanel:function(){var t;this.options.status.max?(this.returnPanel(),t=(t=this.maxAction.getStyle("background-image")).replace(/return.gif/g,"max.gif"),this.maxAction.setStyle("background-image",t),this.options.status.max=!1):(this.maxPanel(),t=(t=this.maxAction.getStyle("background-image")).replace(/max.gif/g,"return.gif"),this.maxAction.setStyle("background-image",t),this.options.status.max=!0);this.fireEvent("resize")},returnPanel:function(){this.options.status.expand||this.setExpand(),this.container.setStyles({position:"absolute",top:this.options.top,left:this.options.left,width:this.returnMaxContainerSize.x,height:this.returnMaxContainerSize.y}),this.content.setStyle("height",this.getContentHeight()),this.panelMove.attach()},maxPanel:function(){this.options.status.expand||this.setExpand(),this.returnMaxContainerSize=this.container.getSize();var t=this.container.getOffsetParent().getSize();this.container.setStyles({position:"absolute",top:2,left:2,width:t.x-6,height:t.y}),this.panelMove.detach(),this.content.setStyle("height",this.getContentHeight())},createExpandAction:function(){this.explandAction=new Element("div",{styles:this.css.explandAction}).inject(this.actionNode),this.explandAction.addEvent("click",function(){this.explandPanel()}.bind(this))},explandPanel:function(){var t;this.options.status.expand?(this.collapse(),t=(t=this.explandAction.getStyle("background-image")).replace(/up.gif/g,"down.gif"),this.explandAction.setStyle("background-image",t),this.options.status.expand=!1):(this.expand(),t=(t=this.explandAction.getStyle("background-image")).replace(/down.gif/g,"up.gif"),this.explandAction.setStyle("background-image",t),this.options.status.expand=!0)},collapse:function(){this.returnTopSize=this.titleNode.getComputedSize(),this.returnBottomSize=this.bottomNode.getComputedSize(),this.returnContainerSize=this.container.getComputedSize(),this.returnContentSize=this.content.getComputedSize(),this.returnContainerPosition=this.container.getPosition(this.options.target),this.containerTween||(this.containerTween=new Fx.Morph(this.container,{duration:this.options.duration,transition:this.options.transition})),this.bottomTween||(this.bottomTween=new Fx.Morph(this.bottomNode,{duration:this.options.duration,transition:this.options.transition})),this.contentTween||(this.contentTween=new Fx.Morph(this.content,{duration:this.options.duration,transition:this.options.transition})),this.containerTween.options.transition=this.options.transition,this.bottomTween.options.transition=this.options.transition,this.contentTween.options.transition=this.options.transition,this.contentTween.start({height:0}),this.bottomTween.start({height:0}),this.containerTween.start({height:this.returnTopSize.height,width:"120px",top:this.options.minTop||this.returnContainerPosition.y,left:this.options.minLeft||this.returnContainerPosition.x}).chain(function(){this.bottomNode.setStyle("display","none"),this.content.setStyle("display","none")}.bind(this))},expand:function(){this.containerTween||(this.containerTween=new Fx.Morph(this.container,{duration:this.options.duration,transition:this.options.transition})),this.bottomTween||(this.bottomTween=new Fx.Morph(this.bottomNode,{duration:this.options.duration,transition:this.options.transition})),this.contentTween||(this.contentTween=new Fx.Morph(this.content,{duration:this.options.duration,transition:this.options.transition})),this.containerTween.options.transition=this.options.transitionOut,this.bottomTween.options.transition=this.options.transitionOut,this.contentTween.options.transition=this.options.transitionOut,this.bottomNode.setStyle("display","block"),this.content.setStyle("display","block"),this.containerTween.start({height:this.returnContainerSize.height,width:this.returnContainerSize.width,left:this.returnContainerPosition.x,top:this.returnContainerPosition.y}),this.contentTween.start({height:this.returnContentSize.height,width:"auto"}),this.bottomTween.start({height:this.returnBottomSize.height,width:"auto"})},setExpand:function(){this.container.setStyle("height",this.returnContainerSize.height+"px"),this.container.setStyle("width",this.returnContainerSize.width+"px"),this.content.setStyle("height",this.returnContentSize.height+"px"),this.content.setStyle("width","auto"),this.bottomNode.setStyle("height",this.returnBottomSize.height+"px"),this.bottomNode.setStyle("width","auto"),this.bottomNode.setStyle("display","block"),this.content.setStyle("display","block");var t=this.explandAction.getStyle("background-image");t=t.replace(/down.gif/g,"up.gif"),this.explandAction.setStyle("background-image",t),this.options.status.expand=!0},createBottomNode:function(){this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.container),this.options.isResize&&this.createResizeAction()},createResizeAction:function(){this.resizeAction=new Element("div",{styles:this.css.resizeAction}).inject(this.bottomNode)}}),o2.widget.Panel.panels=[];