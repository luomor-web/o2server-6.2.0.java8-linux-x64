o2.widget=o2.widget||{},o2.widget.chart=o2.widget.chart||{},o2.require("o2.widget.Common",null,!1),o2.require("o2.widget.chart.d3",null,!1),o2.require("o2.widget.UUID",null,!1),o2.widget.chart.Dashboard=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",margin:"10px",sort:"ASC",red:.3,green:.3,borderWidth:6,arcWidth:15,arcMargin:22,ticks:7,tickLong:6,miniTicks:31,miniTickLong:3,centerWidth:6,format:"",formatdData:"",text:"",domain:[]},initialize:function(t,i,s){this.setOptions(s),this.container=$(t),this.data=i,this.classId=new o2.widget.UUID,this.path=o2.session.path+"/widget/chart/$Dashboard/",this.cssPath=o2.session.path+"/widget/chart/$Dashboard/"+this.options.style+"/css.wcss",this._loadCss()},load:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container),this.setNodeSize(),o2.widget.chart.d3.load(function(){if(this.fireEvent("queryLoad")){this.svg=d3.select(this.node).append("svg"),this.setSvgSize(),this.showData=this.data;var t=d3.max(this.options.domain),i=d3.min(this.options.domain);this.data>t&&(this.showData=t),this.data<i&&(this.showData=i),this.drawCircleOutline(),this.drawArc(),this.drawMiniTicks(),this.drawTicks(),this.drawText(),this.drawPointer()}}.bind(this)),this.fireEvent("postLoad")},setNodeSize:function(){var t=this.options.margin.toInt(),i=this.container.getSize(),s=i.x-2*t,e=i.y-2*t;this.size={x:s,y:e,m:t}},setSvgSize:function(){this.svg.attr("width","100%").attr("height","100%")},drawCircleOutline:function(){var t=this.size.x/2,i=this.size.x/2+this.size.m;this.circleBig=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",t),Object.each(this.css.circleBig,function(t,i){this.circleBig.attr(i,t)}.bind(this)),t-=this.options.borderWidth,this.circleSmall=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",t),Object.each(this.css.circleSmall,function(t,i){this.circleSmall.attr(i,t)}.bind(this)),this.circleCenter=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",this.options.centerWidth),Object.each(this.css.circleCenter,function(t,i){this.circleCenter.attr(i,t)}.bind(this)),this.setDefs("circleBig_defs",this.circleBig),this.setDefs("circleSmall_defs",this.circleSmall),this.setDefs("circleCenter_defs",this.circleCenter)},setDefs:function(t,i){if(this.css[t]){var s=this.svg.append("defs");this.createDefs(s,this.css[t]),s.select((function(){return this.getFirst()})).attr("id",this.classId+"_"+t),i.attr(this.css[t].urlAttr,"url(#"+this.classId+"_"+t+")")}},createDefs:function(t,i){var s=t.append(i.tag);Object.each(i.attrs,(function(t,i){s.attr(i,t)})),i.subs&&i.subs.each(function(t){this.createDefs(s,t)}.bind(this))},drawArc:function(){this.angleScale=d3.scaleLinear().domain(this.options.domain).range([0-.75*Math.PI,.75*Math.PI]);var t=this.angleScale(this.options.green*d3.max(this.options.domain)),i=this.angleScale((1-this.options.red)*d3.max(this.options.domain)),s={startAngle:0-.75*Math.PI,endAngle:t},e={startAngle:t,endAngle:i},a={startAngle:i,endAngle:.75*Math.PI},n=this.size.x/2-this.options.arcMargin-this.options.borderWidth,r=this.size.x/2-this.options.arcMargin-this.options.arcWidth-this.options.borderWidth,h=this.size.x/2+this.size.m,o=d3.arc().innerRadius(r).outerRadius(n);this.greenArc=this.svg.append("path").attr("d",o(s)).attr("transform","translate("+h+", "+h+")"),this.yellowArc=this.svg.append("path").attr("d",o(e)).attr("transform","translate("+h+", "+h+")"),this.redArc=this.svg.append("path").attr("d",o(a)).attr("transform","translate("+h+", "+h+")"),Object.each(this.css.greenArc,function(t,i){this.greenArc.attr(i,t)}.bind(this)),Object.each(this.css.yellowArc,function(t,i){this.yellowArc.attr(i,t)}.bind(this)),Object.each(this.css.redArc,function(t,i){this.redArc.attr(i,t)}.bind(this)),this.setDefs("greenArc_defs",this.greenArc),this.setDefs("yellowArc_defs",this.yellowArc),this.setDefs("redArc_defs",this.redArc)},drawTicks:function(){for(var t=d3.max(this.options.domain)/(this.options.ticks-1),i=this.size.x/2-this.options.borderWidth,s=this.size.x/2-this.options.tickLong-this.options.borderWidth,e=this.size.x/2+this.size.m,a=d3.arc().innerRadius(s).outerRadius(i),n=d3.arc().innerRadius(s-16).outerRadius(s),r=0;r<this.options.ticks;r++){var h=this.angleScale(t*r),o={startAngle:h,endAngle:h},d=this.svg.append("path").attr("d",a(o)).attr("transform","translate("+e+", "+e+")");Object.each(this.css.tick,function(t,i){d.attr(i,t)}.bind(this));var c=n.centroid(o),l=Math.round(t*r);l>1e3&&(l/=1e3,l=d3.format("0.3r")(l),l+="k"),this.svg.append("text").attr("transform","translate("+e+", "+e+") translate("+c[0]+", "+c[1]+")").attr("text-anchor","middle").attr("dy","4").attr("font-size","10px").text(l)}},drawMiniTicks:function(){for(var t=d3.max(this.options.domain)/(this.options.miniTicks-1),i=this.size.x/2-this.options.borderWidth,s=this.size.x/2-this.options.miniTickLong-this.options.borderWidth,e=this.size.x/2+this.size.m,a=d3.arc().innerRadius(s).outerRadius(i),n=0;n<this.options.miniTicks;n++){var r=this.angleScale(t*n),h={startAngle:r,endAngle:r},o=this.svg.append("path").attr("d",a(h)).attr("transform","translate("+e+", "+e+")");Object.each(this.css.miniTick,function(t,i){o.attr(i,t)}.bind(this))}},getPointerPath:function(t){var i,s,e=this.size.x/2+this.size.m,a=this.size.x/2-this.options.tickLong-this.options.borderWidth,n=d3.arc().innerRadius(a-24).outerRadius(a),r=this.angleScale(t),h={startAngle:r,endAngle:r},o=n.centroid(h),d=o[0]+e,c=o[1]+e,l=(this.angleScale(d3.min(this.options.domain)),0-o[0]),p=0-o[1],g=Math.sqrt(Math.pow(l,2)+Math.pow(p,2)),f=this.options.centerWidth-4,u=Math.asin(p/g),m=Math.asin(f/g);l>=0?(i=u-m+Math.PI/2,s=u+m+Math.PI/2):(s=2*Math.PI-(u-m+Math.PI/2),i=2*Math.PI-(u+m+Math.PI/2)),this.arcPointerPath||(this.arcPointerPath=d3.arc().innerRadius(0).outerRadius(g+10));h={startAngle:i,endAngle:s};return{d:this.arcPointerPath(h),lx:d,ly:c}},drawPointer:function(){var t=this.getPointerPath(d3.min(this.options.domain));this.pointer=this.svg.append("path").attr("d",t.d).attr("transform","translate("+t.lx+", "+t.ly+")"),Object.each(this.css.pointer,function(t,i){this.pointer.attr(i,t)}.bind(this)),this.setDefs("pointer_defs",this.pointer),this.transition()},transition:function(){var t=this.getPointerPath(d3.min(this.options.domain)),i=t.lx,s=t.ly;this.pointer.attr("d",t.d).attr("transform","translate("+t.lx+", "+t.ly+")"),this.pointer.transition().delay(200).duration(3e3).ease(d3.easeElasticOut).attrTween("d",function(t,e,a){return function(t){var e=this.getPointerPath(this.showData*t);return i=e.lx,s=e.ly,e.d}.bind(this)}.bind(this)).attrTween("transform",function(t,e,a){return function(t){return"translate("+i+", "+s+")"}.bind(this)}.bind(this))},drawText:function(){var t=this.size.x/2-this.options.arcMargin-this.options.borderWidth,i=this.size.x/2+this.size.m,s=this.size.x/2+this.size.m+t;this.dataText=this.svg.append("text").attr("transform","translate("+i+", "+s+") ").attr("text-anchor","middle").attr("dy","4").attr("font-size","10px").text(this.options.formatData?d3.format(this.options.formatData)(this.options.text||this.data):this.options.text||this.data),Object.each(this.css.dataText,function(t,i){this.dataText.attr(i,t)}.bind(this)),this.setDefs("dataText_defs",this.dataText)},hide:function(){this.node.setStyle("display","none")},show:function(){this.node.setStyle("display","block"),this.transition()},destroy:function(){this.node.destroy(),d3.interrupt(this.pointer),o2.release(this)}});