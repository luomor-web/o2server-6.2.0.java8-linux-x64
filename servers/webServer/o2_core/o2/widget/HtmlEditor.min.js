o2.widget=o2.widget||{},o2.require("o2.widget.codemirror",null,!1),o2.require("o2.widget.ace",null,!1),o2.require("o2.xDesktop.UserData",null,!1),o2.widget.HtmlEditor=new Class({Implements:[Options,Events],options:{type:"ace",title:"JavascriptEditor",style:"default",option:{value:"",mode:"javascript",lineNumbers:!0}},initialize:function(t,e){this.setOptions(e),this.editorClass=o2.widget[this.options.type],this.node=$(t)},getEditorTheme:function(t){o2.editorData?t&&t():o2.UD.getData("editor",(function(e){e.data?o2.editorData=JSON.decode(e.data):o2.editorData={javascriptEditor:{theme:"tomorrow"}},t&&t()}))},load:function(t){this.getEditorTheme(function(e){o2.editorData.javascriptEditor?this.theme=o2.editorData.javascriptEditor.theme:o2.editorData.javascriptEditor={theme:"tomorrow"},this.theme||(this.theme="tomorrow"),"ace"==this.options.type.toLowerCase()&&this.loadAce(t),"codeMirror"==this.options.type.toLowerCase()&&this.loadCodeMirror(t)}.bind(this))},loadAce:function(t){this.editorClass.load(function(){ace.require("ace/ext/language_tools"),this.editor=ace.edit(this.node),this.editor.session.setMode("ace/mode/html"),this.editor.setTheme("ace/theme/"+this.theme),this.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!1}),this.options.option.value&&this.editor.setValue(this.options.option.value),this.editor.commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(t){this.fireEvent("save")}.bind(this),readOnly:!1}),this.editor.commands.addCommand({name:"help",bindKey:{win:"Ctrl-Q|Ctrl-Alt-Space|Ctrl-Space|Alt-/",mac:"Command-Q"},exec:function(t,e,i){this.fireEvent("reference",[t,e,i])}.bind(this),readOnly:!1}),this.node.addEvent("keydown",(function(t){t.stopPropagation()})),this.fireEvent("postLoad"),t&&t()}.bind(this))},loadCodeMirror:function(t){this.fireEvent("queryLoad")&&this.editorClass.load(function(){this.editorClass.loadJavascript(function(e){this.options.option.mode="javascript",this.editor=CodeMirror(this.node,this.options.option),this.editor.setSize("100%","100%"),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},showLineNumbers:function(){"codeMirror"==this.options.type.toLowerCase()&&this.editor.setOption("lineNumbers",!0)},max:function(){"codeMirror"==this.options.type.toLowerCase()&&this.editor.setSize("100%","100%")},getCursorPixelPosition:function(){var t=this.editor.getSession(),e=this.editor.getCursorPosition(),i=t.getLine(e.row),o=this.retrievePrecedingIdentifier(i,e.column),r=t.doc.createAnchor(e.row,e.column-o.length);r.$insertRight=!0;var s=this.editor.renderer,n=(e=s.$cursorLayer.getPixelPosition(r,!0),this.editor.container.getBoundingClientRect());return e.top+=n.top-s.layerConfig.offset,e.left+=n.left-this.editor.renderer.scrollLeft,e.left+=s.gutterWidth,e},retrievePrecedingIdentifier:function(t,e,i){i=i||/[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/;for(var o=[],r=e-1;r>=0&&i.test(t[r]);r--)o.push(t[r]);return o.reverse().join("")}});