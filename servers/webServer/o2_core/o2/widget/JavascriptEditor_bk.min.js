o2.widget=o2.widget||{},o2.require("o2.widget.codemirror",null,!1),o2.require("o2.xDesktop.UserData",null,!1),o2.widget.JavascriptEditor=new Class({Implements:[Options,Events],options:{type:"monaco",title:"JavascriptEditor",style:"default",option:{value:"",mode:"javascript",lineNumbers:!0},runtime:"all"},initialize:function(t,e){this.setOptions(e),this.unbindEvents=[],this.node=$(t)},getDefaultEditorData:function(){switch(this.options.type){case"ace":return{javascriptEditor:{theme:"tomorrow",fontSize:"12px"}};case"monaco":return{javascriptEditor:{monaco_theme:"vs",fontSize:"12px"}}}},getEditorTheme:function(t){o2.editorData?t&&t():o2.UD.getData("editor",function(e){e.data?o2.editorData=JSON.decode(e.data):o2.editorData=this.getDefaultEditorData(),t&&t()}.bind(this))},load:function(t){this.getEditorTheme(function(e){for(this.options.type=o2.editorData.javascriptEditor.editor||"monaco","ace"==this.options.type.toLowerCase()&&this.loadAce(t),"monaco"==this.options.type.toLowerCase()&&this.loadMonaco(t),"codeMirror"==this.options.type.toLowerCase()&&this.loadCodeMirror(t);this.unbindEvents.length;){var i=this.unbindEvents.shift();this.addEditorEvent(i.name,i.fun)}}.bind(this))},loadMonacoEditor:function(t){window.monaco?t&&t():o2.load("monaco",{sequence:!0},function(){require.config({paths:{vs:"../o2_lib/vs"}}),require(["vs/editor/editor.main"],(function(){t&&t()}))}.bind(this))},loadMonaco:function(t){o2.editorData.javascriptEditor?(this.theme=o2.editorData.javascriptEditor.monaco_theme,this.fontSize=o2.editorData.javascriptEditor.fontSize):o2.editorData.javascriptEditor={monaco_theme:"vs",fontSize:"12px"},this.theme||(this.theme="vs"),this.fontSize||(this.fontSize="12px"),o2.require("o2.widget.monaco",function(){this.editorClass=o2.widget.monaco,this.editorClass.load(function(){this.editor=monaco.editor.create(this.node,{value:this.options.option.value,language:this.options.option.mode,theme:this.theme,fontSize:this.fontSize,lineNumbersMinChars:3,lineNumbers:this.options.option.lineNumbers?"on":"off",mouseWheelZoom:!0,automaticLayout:!0}),this.focus(),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KEY_S,function(t){this.fireEvent("save")}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_I,function(t){this.format()}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_F,function(t){this.format()}.bind(this)),this.editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyMod.Alt|monaco.KeyCode.KEY_F,function(t){this.format()}.bind(this)),this.fontSize&&this.editor.updateOptions({fontSize:this.fontSize}),this.editor.onDidFocusEditorText(function(t){o2.shortcut.keyboard.deactivate()}.bind(this)),this.editor.onDidBlurEditorText(function(t){o2.shortcut.keyboard.activate()}.bind(this)),this.monacoModel=this.editor.getModel(),this.monacoModel.o2Editor=this,this.registerCompletion(),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},loadAce:function(t){o2.editorData.javascriptEditor?(this.theme=o2.editorData.javascriptEditor.theme,this.fontSize=o2.editorData.javascriptEditor.fontSize):o2.editorData.javascriptEditor={theme:"tomorrow",fontSize:"12px"},this.theme||(this.theme="tomorrow"),this.fontSize||(this.fontSize="12px"),o2.require("o2.widget.ace",function(){this.editorClass=o2.widget.ace,this.editorClass.load(function(){this.editor=ace.edit(this.node),this.editor.session.setMode("ace/mode/"+this.options.option.mode),this.editor.setTheme("ace/theme/"+this.theme),this.editor.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,showLineNumbers:this.options.option.lineNumbers}),this.options.option.value&&this.editor.setValue(this.options.option.value),this.editor.o2Editor=this,this.focus(),this.editor.commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(t){this.fireEvent("save")}.bind(this),readOnly:!1}),this.editor.commands.addCommand({name:"format",bindKey:{win:"Ctrl-Alt-i|Ctrl-Alt-f",mac:"Command-i|Command-f"},exec:function(t,e,i){this.format()}.bind(this),readOnly:!1}),this.editor.commands.addCommand({name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-Alt-h",mac:"Command-Alt-h"},exec:function(t){ace.config.loadModule("ace/ext/keybinding_menu",(function(e){e.init(t),t.showKeyboardShortcuts()}))}.bind(this)}),this.node.addEvent("keydown",(function(t){t.stopPropagation()})),this.fontSize&&this.setFontSize(this.fontSize),o2.widget.JavascriptEditor.getCompletionEnvironment(this.options.runtime,function(){this.registerCompletion()}.bind(this)),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},registerCompletion:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.registerCompletionAce();break;case"monaco":this.registerCompletionMonaco()}},filterRangeScript:function(t,e,i){for(var o="",n=0,r=t.length-1;r>=0;r--){var s=t.charAt(r);if(s==i&&n++,s==e&&--n<0)break;o=s+o}return o},getCompletionObject:function(t,e){var i=o2.widget.JavascriptEditor.runtimeEnvironment[e],o=null;return i&&(t=this.filterRangeScript(t,"(",")"),t=this.filterRangeScript(t,"{","}"),t=(t=this.filterRangeScript(t,"[","]")).substr(t.lastIndexOf("=")+1).substr(t.lastIndexOf(":")+1).substr(t.lastIndexOf(",")+1).substr(t.lastIndexOf(";")+1),code="try {return "+t+";}catch(e){return null;}",o=i.exec(code)),o},registerCompletionMonaco:function(){o2.widget.monaco.registeredCompletion||(monaco.languages.registerCompletionItemProvider("javascript",{triggerCharacters:["."],provideCompletionItems:function(t,e,i,o){var n=t.getValueInRange({startLineNumber:e.lineNumber,startColumn:1,endLineNumber:e.lineNumber,endColumn:e.column}),r=n.substr(0,n.lastIndexOf(".")),s=this.getCompletionObject(r,t.o2Editor.options.runtime),a=t.getWordUntilPosition(e),d={startLineNumber:e.lineNumber,endLineNumber:e.lineNumber,startColumn:a.startColumn,endColumn:a.endColumn};if(s){var c=[];Object.keys(s).each((function(t){var e=typeOf(s[t]);if("function"===e){for(var i=s[t].length,o=t+"(",n=1;n<=i;n++)o+=n==i?"par"+n:"par"+n+", ";o+=")",c.push({label:t,kind:monaco.languages.CompletionItemKind.Function,insertText:o,range:d,detail:e})}else c.push({label:t,kind:monaco.languages.CompletionItemKind.Interface,insertText:t,range:d,detail:e})}))}return new Promise((function(t){t({suggestions:c})}))}.bind(this)}),o2.widget.monaco.registeredCompletion=!0)},registerCompletionAce:function(){o2.widget.ace.registeredCompletion||(ace.require("ace/ext/language_tools").addCompleter({identifierRegexps:[/./],getCompletions:function(t,e,i,o,n){var r=o.substr(0,o.lastIndexOf(".")),s=this.getCompletionObject(r,t.o2Editor.options.runtime);if(s){var a=[];Object.keys(s).each((function(t){var e=typeOf(s[t]);if("function"===e){for(var i=s[t].length,o=r+"."+t+"(",n=1;n<=i;n++)o+=n==i?"par"+n:"par"+n+", ";o+=")",a.push({caption:r+"."+t,value:o,score:3,meta:e,type:e,docText:s[t]})}else a.push({caption:r+"."+t,value:r+"."+t,score:3,meta:e,type:e,docText:s[t]})})),n(null,a)}}.bind(this)}),o2.widget.ace.registeredCompletion=!0)},changeEditor:function(t){if(this.editor){var e=this.getValue();this.destroyEditor(),this.options.type=t,this.load(function(){this.setValue(e)}.bind(this))}else this.options.type=o2.editorData.javascriptEditor.editor,"ace"==this.options.type.toLowerCase()&&this.loadAce(callback),"monaco"==this.options.type.toLowerCase()&&this.loadMonaco(callback),"codeMirror"==this.options.type.toLowerCase()&&this.loadCodeMirror(callback)},destroyEditor:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.destroy(),this.node.empty();break;case"monaco":this.editor.dispose()}},setTheme:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setTheme("ace/theme/"+t);break;case"monaco":monaco.editor.setTheme(t)}},setFontSize:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setFontSize(t);break;case"monaco":this.editor.updateOptions({fontSize:t})}},setValue:function(t){this.editor&&this.editor.setValue(t)},insertValue:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.insert(t);break;case"monaco":this.editor.executeEdits("",[{range:monaco.Range.fromPositions(this.editor.getPosition()),text:t}])}},getValue:function(){return this.editor?this.editor.getValue():""},resize:function(t){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.resize();break;case"monaco":this.editor.layout()}},addEditorEvent:function(t,e){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.on(t,e);break;case"monaco":var i=t;switch(i){case"change":i="onDidChangeModelContent";break;case"blur":i="onDidBlurEditorText"}this.editor[i]&&this.editor[i](e)}else this.unbindEvents.push({name:t,fun:e})},validatedAce:function(){for(var t=this.editor.getSession().getAnnotations(),e=0;e<t.length;e++)if("error"==t[e].type)return!1;return!0},validatedMonaco:function(){for(var t=this.editor.getModel(),e=monaco.editor.getModelMarkers({resource:t.uri}),i=0;i<e.length;i++)if(8==e[i].severity)return!1;return!0},validated:function(){if(this.editor){switch(this.options.type.toLowerCase()){case"ace":return this.validatedAce();case"monaco":return this.validatedMonaco()}return!0}return!0},formatAce:function(){var t=this.options.option.mode.toString().toLowerCase();"javascript"===t?o2.load("JSBeautifier",function(){this.editor.setValue(js_beautify(editor.getValue()))}.bind(this)):"html"===t?o2.load("JSBeautifier_html",function(){this.editor.setValue(html_beautify(editor.getValue()))}.bind(this)):"css"===t?o2.load("JSBeautifier_css",function(){this.editor.setValue(css_beautify(editor.getValue()))}.bind(this)):o2.load("JSBeautifier",function(){this.editor.setValue(js_beautify(editor.getValue()))}.bind(this))},formatMonaco:function(){this.editor.getAction("editor.action.formatDocument").run()},format:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.formatAce();case"monaco":this.formatMonaco()}},focus:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.focus(),this.goto();break;case"monaco":this.editor.focus()}},goto:function(){var t=this.editor.getCursorPosition();0==t.row&&(t.row=this.editor.renderer.getScrollBottomRow()),this.editor.gotoLine(t.row+1,t.column+1,!0)},showLineNumbers:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setOption("showLineNumbers",!0);break;case"codeMirror":this.editor.setOption("lineNumbers",!0);break;case"monaco":this.editor.updateOptions({lineNumbers:"on"})}},hideLineNumbers:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"ace":this.editor.setOption("showLineNumbers",!1);break;case"codeMirror":this.editor.setOption("lineNumbers",!1);break;case"monaco":this.editor.updateOptions({lineNumbers:"off"})}},max:function(){if(this.editor)switch(this.options.type.toLowerCase()){case"codeMirror":this.editor.setSize("100%","100%");break;case"ace":this.editor.resize();break;case"monaco":this.editor.layout()}},loadCodeMirror:function(t){this.fireEvent("queryLoad")&&this.editorClass.load(function(){this.editorClass.loadJavascript(function(e){this.options.option.mode="javascript",this.editor=CodeMirror(this.node,this.options.option),this.editor.setSize("100%","100%"),this.fireEvent("postLoad"),t&&t()}.bind(this))}.bind(this))},getCursorPixelPosition:function(){var t=this.editor.getSession(),e=this.editor.getCursorPosition(),i=t.getLine(e.row),o=this.retrievePrecedingIdentifier(i,e.column),n=t.doc.createAnchor(e.row,e.column-o.length);n.$insertRight=!0;var r=this.editor.renderer,s=(e=r.$cursorLayer.getPixelPosition(n,!0),this.editor.container.getBoundingClientRect());return e.top+=s.top-r.layerConfig.offset,e.left+=s.left-this.editor.renderer.scrollLeft,e.left+=r.gutterWidth,e},retrievePrecedingIdentifier:function(t,e,i){i=i||/[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/;for(var o=[],n=e-1;n>=0&&i.test(t[n]);n--)o.push(t[n]);return o.reverse().join("")}}),o2.widget.JavascriptEditor.runtimeEnvironment={},o2.widget.JavascriptEditor.getCompletionEnvironment=function(t,e){o2.widget.JavascriptEditor.runtimeEnvironment[t]?e&&e():o2.require("o2.xScript.Macro",(function(){switch(t){case"service":o2.widget.JavascriptEditor.getServiceCompletionEnvironment(t,e);break;case"server":o2.widget.JavascriptEditor.getServerCompletionEnvironment(t,e);break;case"all":o2.widget.JavascriptEditor.getAllCompletionEnvironment(t,e);break;default:o2.widget.JavascriptEditor.getDefaultCompletionEnvironment(t,e)}}))},o2.widget.JavascriptEditor.getServiceCompletionEnvironment=function(t,e){var i=null,o=function(){if("null"!==o2.typeOf(i)){var o="o2.Macro.swapSpace.tmpMacroCompletionFunction = function (){\n"+i+"\nreturn bind;\n};";Browser.exec(o);var n=o2.Macro.swapSpace.tmpMacroCompletionFunction();o2.widget.JavascriptEditor.runtimeEnvironment[t]={environment:n,exec:function(t){return o2.Macro.exec(t,this.environment)}},e&&e()}};o2.xhr_get("../x_desktop/js/initalServiceScriptSubstitute.js",(function(t){i=t.responseText,o()}),(function(){i="",o()}))},o2.widget.JavascriptEditor.getServerCompletionEnvironment=function(t,e){var i=null,o=function(){if("null"!==o2.typeOf(i)){var o="o2.Macro.swapSpace.tmpMacroCompletionFunction = function (){\n"+i+"\nreturn bind;\n};";Browser.exec(o);var n=o2.Macro.swapSpace.tmpMacroCompletionFunction();o2.widget.JavascriptEditor.runtimeEnvironment[t]={environment:n,exec:function(t){return o2.Macro.exec(t,this.environment)}},e&&e()}};o2.xhr_get("../x_desktop/js/initalScriptSubstitute.js",(function(t){i=t.responseText,o()}),(function(){i="",o()}))},o2.widget.JavascriptEditor.getDefaultCompletionEnvironment=function(t,e){var i=null;o2.getJSON("../o2_core/o2/widget/$JavascriptEditor/environment.json",(function(o){i=o,o2.widget.JavascriptEditor.runtimeEnvironment[t]=new o2.Macro.FormContext(i),e&&e()}))},o2.widget.JavascriptEditor.getAllCompletionEnvironment=function(t,e){var i=function(){if(o2.widget.JavascriptEditor.runtimeEnvironment.service&&o2.widget.JavascriptEditor.runtimeEnvironment.server&&o2.widget.JavascriptEditor.runtimeEnvironment.web){var i=Object.merge(o2.widget.JavascriptEditor.runtimeEnvironment.service.environment,o2.widget.JavascriptEditor.runtimeEnvironment.server.environment,o2.widget.JavascriptEditor.runtimeEnvironment.web.environment);o2.widget.JavascriptEditor.runtimeEnvironment[t]={environment:i,exec:function(t){return o2.Macro.exec(t,this.environment)}},e&&e()}};o2.widget.JavascriptEditor.getServiceCompletionEnvironment("service",i),o2.widget.JavascriptEditor.getServerCompletionEnvironment("server",i),o2.widget.JavascriptEditor.getDefaultCompletionEnvironment("web",i)},o2.widget.JavascriptEditor.completionWorkerEnvironment=o2.JSEditorCWE={init:function(){this.callbackPool={},this.scriptWorker=new Worker("../o2_core/o2/widget/$JavascriptEditor/scriptWorker.js"),this.scriptWorker.onmessage=function(t){var e=t.data,i=this.callbackPool[e.id];i.uuid==e.uuid&&i.callback&&i.callback(e.o)}},exec:function(t,e){this.scriptWorker||this.init();var i=o2.uuid();t.uuid=i,this.callbackPool[t.id]={callback:e,id:i},this.scriptWorker.postMessage(t)}};