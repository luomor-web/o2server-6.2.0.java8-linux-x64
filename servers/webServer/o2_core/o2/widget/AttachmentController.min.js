o2.widget=o2.widget||{},o2.widget.UUID||o2.require("o2.widget.UUID",null,!1),o2.widget.AttachmentController=o2.widget.ATTER=new Class({Extends:o2.widget.Common,Implements:[Options,Events],options:{style:"default",listStyle:"icon",size:"max",resize:!0,attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,isPreviewAtt:!0,isSizeChange:!0,readonly:!1,availableListStyles:["list","seq","icon","preview"],toolbarGroupHidden:[],images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"],actionShowText:!1},initialize:function(t,e,i){this.setOptions(i),this.pages=[],this.path=o2.session.path+"/widget/$AttachmentController/",this.cssPath=o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/css.wcss",this._loadCss();var s=this.options.iconConfigUrl?this.options.iconConfigUrl:"../x_component_File/$Main/icon.json";o2.getJSON(s,function(t){this.icons=t}.bind(this),!1,!1),this.module=e,this.actions=[],this.attachments=[],this.selectedAttachments=[],this.container=$(t)},load:function(){"min"===this.options.size?this.loadMin():this.loadMax()},reloadAttachments:function(){if("min"===this.options.size){this.minContent.empty();var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(e.data,this))}}else{this.content.empty();t=this.attachments;for(this.attachments=[];t.length;){e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}}this.checkActions()},getAttachmentById:function(t){for(var e=0;e<this.attachments.length;e++)if(this.attachments[e].data.id===t)return this.attachments[e];return null},loadMax:function(){this.node||(this.node=new Element("div",{styles:this.css.container})),this.createTopNode(),this.contentScrollNode?(this.contentScrollNode.setStyle("display","block"),this.bottomNode&&this.bottomNode.setStyle("display","block"),this.titleNode&&this.titleNode.setStyle("display","block"),this.content.empty()):(this.createContentNode(),this.options.resize&&(this.createBottomNode(),this.createResizeNode()),this.node.inject(this.container),this.checkActions(),this.setEvent());var t=this.attachments;for(this.attachments=[];t.length;){var e=t.shift();this.attachments.push(new o2.widget.AttachmentController.Attachment(e.data,this))}this.checkActions()},loadMin:function(){this.node||(this.node=new Element("div",{styles:this.css.container_min})),this.minActionAreaNode?(this.minActionAreaNode.setStyle("display",""),this.minActionAreaNode.empty(),this.loadMinActions(),this.setEvent()):(this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node),this.loadMinActions(),this.node.inject(this.container),this.setEvent());var t=this.options.toolbarGroupHidden;t.contains("edit")&&t.contains("read")&&t.contains("view")&&this.minActionAreaNode.setStyle("display","none"),this.minContent?(this.minContent.setStyle("display","block"),this.minContent.empty()):(this.minContent=new Element("div",{styles:layout.mobile?this.css.minContentNode_mobile:this.css.minContentNode}).inject(this.node),layout.mobile&&this.minContent.setStyle("clear","both"));var e=this.attachments;for(this.attachments=[];e.length;){var i=e.shift();this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(i.data,this))}this.checkActions()},loadMobile:function(){},loadMinActions:function(){var t=this.options.toolbarGroupHidden;t.contains("edit")||(this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this)))),t.contains("read")||(this.min_downloadAction=this.createAction(this.minActionAreaNode,"download",o2.LP.widget.download,function(t,e){this.downloadAttachment(t,e)}.bind(this))),t.contains("edit")&&t.contains("read")||this.createSeparate(this.minActionAreaNode),this.options.isSizeChange&&(t.contains("view")||(this.sizeAction=this.createAction(this.minActionAreaNode,"max",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this))))},setEvent:function(){this.contentScrollNode&&this.contentScrollNode.addEvents({mousedown:this.unSelectedAttachments.bind(this)}),this.minContent&&this.minContent.addEvents({mousedown:this.unSelectedAttachments.bind(this)})},resetToolbarGroupHidden:function(t){this.options.toolbarGroupHidden=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},resetToolbarAvailableListStyle:function(t){this.options.availableListStyles=t,"max"==this.options.size?this.reloadTopNode():this.loadMin()},createContentNode:function(){this.contentScrollNode=new Element("div.contentScrollNode",{styles:this.css.contentScrollNode}).inject(this.node),this.content=new Element("div.content",{styles:this.css.contentNode}).inject(this.contentScrollNode),o2.require("o2.widget.ScrollBar",function(){new o2.widget.ScrollBar(this.contentScrollNode,{style:"attachment",where:"before",distance:30,friction:4,axis:{x:!1,y:!0}})}.bind(this))},createBottomNode:function(){this.bottomNode=new Element("div",{styles:this.css.bottomNode}).inject(this.node)},createResizeNode:function(){this.resizeNode=new Element("div",{styles:this.css.resizeNode}).inject(this.bottomNode),this.resizeDrag=new Drag(this.resizeNode,{snap:"2",onStart:function(t,e){t.store("startY",e.event.y),t.store("nodeHeight",this.node.getSize().y);var i=this.node.getStyle("min-height");t.store("nodeMinHeight",i?i.toFloat():"");var s=this.contentScrollNode.getStyle("min-height");t.store("contentScrollNodeMinHeight",s?s.toFloat():""),this.nodeHeight||(this.nodeHeight=i.toFloat())}.bind(this),onDrag:function(t,e){var i=t.retrieve("startY"),s=t.retrieve("nodeHeight"),o=t.retrieve("nodeMinHeight"),n=t.retrieve("contentScrollNodeMinHeight"),c=e.event.y-i+s;if(!(o&&c<o&&e.event.y<i)){c<this.nodeHeight&&(c=this.nodeHeight);var a=c-81;n&&a<n&&e.event.y<i||(this.node.setStyle("height",c+"px"),this.contentScrollNode.setStyle("height",a+"px"))}}.bind(this)})},createTopNode:function(){this.options.title&&(this.titleNode||(this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node))),this.topNode?(this.topNode.empty(),this.editActionBoxNode=null,this.editActionsGroupNode=null,this.topNode.setStyle("display",""),this.isHiddenTop&&(this.oldContentScrollNodeHeight&&this.contentScrollNode&&(this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight),this.oldContentScrollNodeHeight=null),this.isHiddenTop=!1)):this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);var t=this.options.toolbarGroupHidden;if(t.contains("edit")&&t.contains("read")&&t.contains("list")&&t.contains("view"))return this.contentScrollNode&&(this.oldContentScrollNodeHeight=this.contentScrollNode.getStyle("min-height"),this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height")),this.topNode.setStyle("display","none")),void(this.isHiddenTop=!0);t.contains("edit")||this.createEditGroupActions(),t.contains("read")||this.createReadGroupActions(),t.contains("list")||this.createListGroupActions(),t.contains("view")||this.createViewGroupActions()},reloadTopNode:function(){this.createTopNode()},createEditGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.uploadAction=this.createAction(this.editActionsGroupNode,"upload",o2.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this)),this.deleteAction=this.createAction(this.editActionsGroupNode,"delete",o2.LP.widget.delete,function(t,e){this.deleteAttachment(t,e)}.bind(this)),this.options.isReplaceHidden||(this.replaceAction=this.createAction(this.editActionsGroupNode,"replace",o2.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this))),this.options.toolbarGroupHidden.contains("read")||(this.editActionSeparateNode=this.createSeparate(this.editActionsGroupNode))},createReadGroupActions:function(){this.editActionBoxNode||(this.editActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode)),this.editActionsGroupNode||(this.editActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.editActionBoxNode)),this.downloadAction=this.createAction(this.editActionsGroupNode,"download",o2.LP.widget.download,function(){this.downloadAttachment()}.bind(this))},createListGroupActions:function(){var t=this.options.availableListStyles;t&&t.length>0&&(this.listActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.listActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.listActionBoxNode),t.contains("list")&&(this.listAction=this.createAction(this.listActionsGroupNode,"list",o2.LP.widget.list,function(){this.changeListStyle("list")}.bind(this))),t.contains("seq")&&(this.sequenceAction=this.createAction(this.listActionsGroupNode,"seq",o2.LP.widget.sequence,function(){this.changeListStyle("sequence")}.bind(this))),t.contains("icon")&&(this.iconAction=this.createAction(this.listActionsGroupNode,"icon",o2.LP.widget.icon,function(){this.changeListStyle("icon")}.bind(this))),t.contains("preview")&&(this.previewAction=this.createAction(this.listActionsGroupNode,"preview",o2.LP.widget.preview,function(){this.changeListStyle("preview")}.bind(this))))},createViewGroupActions:function(){this.options.isSizeChange&&(this.viewActionBoxNode=new Element("div",{styles:this.css.actionsBoxNode}).inject(this.topNode),this.viewActionBoxNode.setStyles({float:"right","margin-right":"7px"}),this.viewActionsGroupNode=new Element("div",{styles:this.css.actionsGroupNode}).inject(this.viewActionBoxNode),this.sizeAction=this.createAction(this.viewActionsGroupNode,"min",o2.LP.widget.min,function(){this.changeControllerSize()}.bind(this)))},createSeparate:function(t){return new Element("div.separateNode",{styles:this.css.separateNode}).inject(t)},createAction:function(t,e,i,s){var o=new Element("div",{styles:this.css.actionNode,title:i}).inject(t);new Element("div",{styles:this.css.actionIconNode}).inject(o).setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/icon/"+e+".png)");var n=this;return o.addEvents({mouseover:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+n.options.style+"/overbg.png)")},mouseout:function(){this.retrieve("disabled")||this.retrieve("selected")||this.setStyle("background","transparent")},click:function(t){this.retrieve("disabled")||n.doAction(t,this,s),t.stopPropagation()}}),this.actions.push(o),o},checkActions:function(){this.checkUploadAction(),this.checkDeleteAction(),this.checkReplaceAction(),this.checkDownloadAction(),this.checkSizeAction(),this.checkListStyleAction()},checkUploadAction:function(){if(this.options.readonly)return this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction),!1;this.options.isUpload?0!=this.options.attachmentCount&&this.attachments.length>=this.options.attachmentCount?(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction)):(this.setActionEnabled(this.uploadAction),this.setActionEnabled(this.min_uploadAction)):(this.setActionDisabled(this.uploadAction),this.setActionDisabled(this.min_uploadAction))},checkDeleteAction:function(){if(this.options.readonly)return this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1),!1;this.options.isDelete?(this.selectedAttachments.length?(this.setActionEnabled(this.deleteAction),this.setActionEnabled(this.min_deleteAction)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction)),this.setAttachmentsAction("delete",!0)):(this.setActionDisabled(this.deleteAction),this.setActionDisabled(this.min_deleteAction),this.setAttachmentsAction("delete",!1))},isAttDeleteAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isDelete)},checkReplaceAction:function(){if(!this.options.isReplaceHidden)return this.options.readonly?(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1),!1):void(this.options.isReplace?(this.selectedAttachments.length&&1==this.selectedAttachments.length?(this.setActionEnabled(this.replaceAction),this.setActionEnabled(this.min_replaceAction)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction)),this.setAttachmentsAction("replace",!0)):(this.setActionDisabled(this.replaceAction),this.setActionDisabled(this.min_replaceAction),this.setAttachmentsAction("replace",!1)))},isAttReplaceAvailable:function(t){return!this.options.readonly&&(!this.options.toolbarGroupHidden.contains("edit")&&this.options.isReplace)},checkDownloadAction:function(){this.options.isDownload?(this.selectedAttachments.length?(this.setActionEnabled(this.downloadAction),this.setActionEnabled(this.min_downloadAction)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction)),this.setActionEnabled(this.downloadAllAction),this.setAttachmentsAction("download",!0)):(this.setActionDisabled(this.downloadAction),this.setActionDisabled(this.min_downloadAction),this.setActionDisabled(this.downloadAllAction),this.setAttachmentsAction("download",!1))},isAttDownloadAvailable:function(t){return!this.options.toolbarGroupHidden.contains("read")&&this.options.isDownload},checkSizeAction:function(){this.sizeAction&&(this.options.isSizeChange?this.setActionEnabled(this.sizeAction):this.setActionDisabled(this.sizeAction))},checkListStyleAction:function(){switch(this.options.listStyle){case"list":this.setActionSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"icon":this.setActionUnSelcted(this.listAction),this.setActionSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"preview":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionSelcted(this.previewAction),this.setActionUnSelcted(this.sequenceAction);break;case"sequence":this.setActionUnSelcted(this.listAction),this.setActionUnSelcted(this.iconAction),this.setActionUnSelcted(this.previewAction),this.setActionSelcted(this.sequenceAction)}},setActionSelcted:function(t){t&&(t.retrieve("selected")||(t.setStyle("background","url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)"),t.store("selected",!0)))},setActionUnSelcted:function(t){t&&t.retrieve("selected")&&(t.setStyle("background",""),t.store("selected",!1))},setActionEnabled:function(t){if(t&&t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("_gray"))+"."+s,e.setStyle("background-image",i),t.store("disabled",!1)}},setActionDisabled:function(t){if(t&&!t.retrieve("disabled")){var e=t.getFirst(),i=e.getStyle("background-image"),s=i.substr(i.lastIndexOf(".")+1,i.length);i=i.substr(0,i.lastIndexOf("."))+"_gray."+s,e.setStyle("background-image",i),t.store("disabled",!0)}},setReadonly:function(){this.actions.each(function(t){this.setActionDisabled(t),this.setAttachmentsAction("all",!1)}.bind(this))},setAttachmentsAction:function(t,e){this.attachments.each(function(i){this.setAttachmentAction(i,t,e)}.bind(this))},setAttachmentAction:function(t,e,i){var s;if("all"===e)(t.actions||[]).each((function(e){t[i?"setActionEnabled":"setActionDisabled"](e)}));else{switch(e){case"download":s=t.downloadAction;break;case"config":s=t.configAction;break;case"delete":s=t.deleteAction;break;case"replace":s=t.replaceAction}if(!s)return;if("config"===e){var o=i;if(o){var n=layout.session.user.distinguishedName;!t.data.person&&t.data.creatorUid&&(t.data.person=t.data.creatorUid),t.data.control.allowControl||t.data.person===n||(o=!1)}t[o?"setActionEnabled":"setActionDisabled"](s)}else t[i?"setActionEnabled":"setActionDisabled"](s)}},doAction:function(t,e,i){i&&i.apply(this,[t,e])},uploadAttachment:function(t,e){this.module&&this.module.uploadAttachment(t,e)},doUploadAttachment:function(t,e,i,s,o,n,c,a,h,l,d){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,c,a,h,l,d):this.doFormDataUploadAttachment(t,e,i,s,o,n,c,a,h,l,d)},addUploadMessage:function(t){var e;e='<div style="overflow: hidden"><div style="height: 2px; border:0px solid #999; margin: 3px 0px"><div style="height: 2px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+o2.LP.desktop.action.uploadTitle+"</div></div><iframe name='o2_upload_iframe' style='display:none'></iframe>";var i={subject:o2.LP.desktop.action.uploadTitle,content:t+"<br/>"+e};if(layout.desktop.message){var s=layout.desktop.message.addMessage(i);s.close=function(t,e){s.completed&&s.closeItem(t,e)}}return window.setTimeout(function(){layout.desktop.message&&(layout.desktop.message.isShow||layout.desktop.message.show())}.bind(this),300),s},setMessageTitle:function(t,e){t&&t.subjectNode.set("text",e)},setMessageText:function(t,e){if(t){t.contentNode.getFirst("div").getFirst("div").getFirst("div");t.contentNode.getFirst("div").getLast("div").set("text",e),t.dateNode.set("text",(new Date).format("db"))}},doInputUploadAttachment:function(t,e,i,s,o,n,c,a,h,l){var d=e;"string"==typeOf(e)&&(d=o2.Actions.get(e).action),d.getActions(function(){var e=d.actions[i];e=d.address+e.uri,Object.each(s,(function(t,i){e=e.replace("{"+i+"}",t)}));var a=this.module.content;a||this.module.form&&(a=this.module.form.app.content),a||(a=this.node),a&&a.mask({style:{opacity:.7,"background-color":"#999"}}),this.inputUploadAreaNode=new Element("div",{styles:this.css.inputUploadAreaNode}).inject(this.container),this.inputUploadAreaNode.position({relativeTo:this.module.content,position:"center"});var h=null;document.O2UploadCallbackFun=function(t){var e=JSON.decode(t);h.completed=!0,"success"===e.type?(n&&n(e.data),this.setMessageTitle(h,o2.LP.desktop.action.uploadComplete),this.setMessageText(h,o2.LP.desktop.action.uploadComplete),o&&o()):(this.setMessageTitle(h,o2.LP.desktop.action.sendError),this.setMessageText(h,o2.LP.desktop.action.sendError+": "+e.message),o2.xDesktop.notice("error",{x:"right",y:"top"},e.message))}.bind(this);var l=new Element("form",{method:"POST",action:e+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(this.inputUploadAreaNode),r=(new Element("div",{styles:this.css.inputUploadAreaTitleNode,text:o2.LP.widget.uploadTitle}).inject(l),new Element("div",{styles:this.css.inputUploadAreaInforNode,text:o2.LP.widget.uploadInfor}).inject(l),new Element("div",{styles:this.css.inputUploadAreaInputAreaNode}).inject(l)),m=new Element("input",{name:"file",type:"file",styles:this.css.inputUploadAreaInputNode}).inject(r),p=new Element("input",{type:"hidden",name:"fileName"}).inject(r);Object.each(t,(function(t,e){new Element("input",{type:"hidden",name:e,value:t}).inject(r)}));var u=new Element("div",{styles:this.css.inputUploadActionNode}).inject(l),A=new Element("button",{styles:this.css.inputUploadCancelButton,text:o2.LP.widget.cancel}).inject(u),g=new Element("input",{type:"button",styles:this.css.inputUploadOkButton,value:o2.LP.widget.ok}).inject(u);m.addEvent("change",function(){var t=m.get("value");if(t){var e=t.replace(/\\/g,"/"),i=e.lastIndexOf("/"),s=-1===i?e:e.substr(i+1,e.length-i);p.set("value",s)}}.bind(this)),A.addEvent("click",function(){a&&a.unmask(),this.inputUploadAreaNode.destroy()}.bind(this)),g.addEvent("click",function(){l.mask({style:{opacity:.7,"background-color":"#999"}});var t=!0;c&&(t=c([p.get("value")])),t&&(h=this.addUploadMessage(p.get("value")),l.submit(),a&&a.unmask(),this.inputUploadAreaNode&&this.inputUploadAreaNode.destroy())}.bind(this))}.bind(this))},doFormDataUploadAttachment:function(t,e,i,s,o,n,c,a,h,l,d){if(!this.uploadFileAreaNode){this.uploadFileAreaNode=new Element("div");this.uploadFileAreaNode.set("html",'<input name="file" multiple type="file" accept="*/*"/>'),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",function(){var a=this.fileUploadNode.files;if(a.length){var r=a.length,m=0,p=!1,u=e;"string"==typeOf(e)&&(u=o2.Actions.get(e).action);var A=function(){m==r&&o&&o(p)},g=!0;if(c&&(g=c(a)),g)for(var y=h?h.split(o2.splitStr):null,N=0;N<a.length;N++){var v=a.item(N),f=v.name.substr(v.name.lastIndexOf("."),v.name.length);if(f=f.toLowerCase(),y&&-1===y.indexOf(f)&&-1===y.indexOf("*")&&-1===y.indexOf("*/*")){var w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML.replace("{filename}",v.name)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);var b=o2.LP.widget.refuseUploadNotice.replace("{filename}",v.name);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},b,this.node)}else if(l&&v.size>1024*l*1024){w={subject:o2.LP.widget.refuseUpload,content:o2.LP.widget.refuseUploadHTML_size.replace("{filename}",v.name).replace("{size}",l)};layout.desktop.message&&layout.desktop.message.addTooltip(w),layout.desktop.message&&layout.desktop.message.addMessage(w);b=o2.LP.widget.refuseUploadNotice_size.replace("{filename}",v.name).replace("{size}",l);o2&&o2.xDesktop&&o2.xDesktop.notice&&o2.xDesktop.notice("info",{x:"right",y:"top"},b,this.node)}else{var x=new FormData;Object.each(t,(function(t,e){x.append(e,t)})),x.append("file",v),s.fileMd5?o2.load("../o2_lib/CryptoJS/components/spark-md5-min.js",function(){var t=new FileReader,e=(document.getElementById("box"),File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice),o=Math.ceil(v.size/20971520),c=0,a=new SparkMD5;function h(){var i=20971520*c,s=i+20971520>=v.size?v.size:i+20971520;t.readAsBinaryString(e.call(v,i,s))}t.onload=function(t){if(console.log("read chunk nr",c+1,"of",o),a.appendBinary(t.target.result),++c<o)h();else{console.log("finished loading");var e=a.end();u.invoke({name:"checkFileExist",async:!0,parameter:{fileMd5:e},success:function(t){if(t.data.value){var o=new FormData;o.append("fileMd5",e),o.append("fileName",v.name),u.invoke({name:"addAttachmentMd5",async:!0,data:o,parameter:s,success:function(t){m++,n&&n(t,m,r),A()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),m++,p=!0,d&&d(t,m,r),A()}})}else u.invoke({name:i,async:!0,data:x,file:v,parameter:s,success:function(t){m++,n&&n(t,m,r),A()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),m++,p=!0,d&&d(t,m,r),A()}})}})}},h()}.bind(this),null,!1):(u.targetModule={module:this,file:v},u.invoke({name:i,async:!0,data:x,file:v,parameter:s,success:function(t){m++,n&&n(t,m,r),A()},failure:function(t){var e=JSON.decode(t.responseText);e&&e.message&&o2.xDesktop.notice("error",{x:"right",y:"top"},e.message),m++,p=!0,d&&d(t,m,r),A()}}))}}this.uploadFileAreaNode.destroy(),this.uploadFileAreaNode=null}}.bind(this))}this.fileUploadNode.set("accept",h||"*/*"),this.fileUploadNode.set("multiple",!1!==a),this.fileUploadNode.click()},addFormDataMessage:function(t){return this.addAttachmentMessage(t)},addAttachmentMessage:function(t){var e;return e="min"==this.options.size?new o2.widget.AttachmentController.AttachmentMessageMin(t,this):new o2.widget.AttachmentController.AttachmentMessage(t,this),this.messageItemList||(this.messageItemList={}),this.messageItemList[e.data.id]=e,e},openInOfficeControl:function(t,e){},deleteAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.deleteAttachments(t,e,this.selectedAttachments)},replaceAttachment:function(t,e){this.selectedAttachments.length&&1==this.selectedAttachments.length&&this.module&&this.module.replaceAttachment(t,e,this.selectedAttachments[0])},doReplaceAttachment:function(t,e,i,s,o,n,c,c,a){FormData.expiredIE?this.doInputUploadAttachment(t,e,i,s,o,n,c,c,a):this.doFormDataUploadAttachment(t,e,i,s,o,n,c,c,a)},previewAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.previewAttachment(this.selectedAttachments)},downloadAttachment:function(t,e){this.selectedAttachments.length&&this.module&&this.module.downloadAttachment(t,e,this.selectedAttachments)},openAttachment:function(t,e,i){this.options.isDownload&&i&&this.module&&this.module.openAttachment(t,e,i)},downloadAllAttachment:function(t,e){this.module&&this.module.downloadAttachment(t,e,this.attachments)},changeListStyle:function(t){this.options.listStyle=t,this.attachments.each(function(e){e.changeListStyle(t)}.bind(this)),this.checkListStyleAction()},changeControllerSize:function(t,e){"max"==this.options.size?this.changeControllerSizeToMin():this.changeControllerSizeToMax()},changeControllerSizeToMin:function(){"min"!=this.options.size&&(this.contentScrollNode&&this.contentScrollNode.setStyle("display","none"),this.bottomNode&&this.bottomNode.setStyle("display","none"),this.topNode&&this.topNode.setStyle("display","none"),this.titleNode&&this.titleNode.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container_min).chain(function(){this.options.size="min",this.loadMin()}.bind(this)))},changeControllerSizeToMax:function(){"max"!=this.options.size&&(this.minActionAreaNode&&this.minActionAreaNode.setStyle("display","none"),this.minContent&&this.minContent.setStyle("display","none"),this.nodeMorph||(this.nodeMorph=new Fx.Morph(this.node,{duration:100})),this.nodeMorph.start(this.css.container).chain(function(){this.options.size="max",this.loadMax()}.bind(this)))},getAttachmentNames:function(){var t=[];return this.attachments.each((function(e){t.push(e.data.name)})),t},addAttachment:function(t,e,i){"min"==this.options.size?this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(t,this,e,i)):this.attachments.push(new o2.widget.AttachmentController.Attachment(t,this,e,i)),this.checkActions()},removeAttachment:function(t){this.attachments.erase(t),this.selectedAttachments.erase(t),t.node.destroy(),delete t},unSelectedAttachments:function(){for(;this.selectedAttachments.length;){this.selectedAttachments.shift().unSelected()}this.checkActions()},clear:function(){this.selectedAttachments=[],this.attachments.each((function(t){t.node.destroy(),o2.release(t)})),this.attachments=[];var t=this.minContent||this.content;t&&t.empty()}}),o2.widget.AttachmentController.Attachment=new Class({Implements:[Events],initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.isCheckPosition=s,this.actions=[],i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},_getLnkPar:function(t){return{icon:this.getIcon(),title:this.data.name,par:"@url#"+t}},isNumber:function(t){return"NaN"!==parseFloat(t).toString()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.controller.module.getAttachmentUrl(this,function(t){this.node.makeLnk({par:this._getLnkPar(t)})}.bind(this)),this.createInforNode(function(){Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"}))}.bind(this)),this.setEvent()},createInforNode:function(t){var e="",i=this.data.length/1024;if(i>1024){var s=i/1024;e=(s=Math.round(100*s)/100)+"M"}else e=(i=Math.round(100*i)/100)+"K";this.inforNode=new Element("div",{styles:this.css.attachmentInforNode});var o="<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.person||this.data.creatorUid)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName||o2.LP.widget.unknow)+"</div></div>",o+="<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+e+"</div></div>",this.inforNode.set("html",o),t&&t()},getIcon:function(){this.data.extension||(this.data.extension="unkonw");var t=this.controller.icons[this.data.extension.toLowerCase()]||this.controller.icons.unknow;return(this.controller.options.iconFolderUrl?this.controller.options.iconFolderUrl:"../x_component_File/$Main/default/file/")+t},loadList:function(){this.node.setStyles(this.css.attachmentNode_list),this.isSelected&&this.node.setStyles(this.css.attachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_list}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_List()},custom_List:function(){},loadSequence:function(){this.node.setStyles(this.css.attachmentNode_sequence),this.isSelected&&this.node.setStyles(this.css.attachmentNode_sequence_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode_sequence}).inject(this.node),this.textTitleNode=new Element("div",{styles:this.css.attachmentTextTitleNode_list}).inject(this.textNode),this.textTitleNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.attachmentTextSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text",t),this.textUploaderNode=new Element("div",{styles:this.css.attachmentTextUploaderNode_list}).inject(this.textNode),this.textUploaderNode.set("text",o2.name.cn(this.data.person||this.data.creatorUid)),this.textTimeNode=new Element("div",{styles:this.css.attachmentTextTimeNode_list}).inject(this.textNode),this.textTimeNode.set("text",this.data.lastUpdateTime),this.textActivityNode=new Element("div",{styles:this.css.attachmentTextActivityNode_list}).inject(this.textNode),this.textActivityNode.set("text",this.data.activityName||o2.LP.widget.unknow),this.custom_Sequence()},custom_Sequence:function(){},loadIcon:function(){this.node.setStyles(this.css.attachmentNode_icon),this.isSelected&&this.node.setStyles(this.css.attachmentNode_icon_selected),this.iconNode=new Element("div",{styles:this.css.attachmentIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.attachmentTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.custom_Icon()},custom_Icon:function(){},loadPreview:function(){this.node.setStyles(this.css.attachmentNode_preview),this.isSelected&&this.node.setStyles(this.css.attachmentNode_preview_selected),this.iconNode=new Element("div",{styles:this.css.attachmentPreviewIconNode}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);var t=this.getIcon();-1!==this.controller.options.images.indexOf(this.data.extension.toLowerCase())?(this.controller.module.getAttachmentUrl(this,function(e){t=e,this.getPreviewImgSize(t,function(e){this.iconImgNode.set({src:t,border:0}),this.iconImgAreaNode.setStyles({width:e.x+"px",height:e.y+"px"}),this.iconImgNode.setStyles({width:e.x+"px",height:e.y+"px","margin-top":e.top+"px"}),window.setTimeout(function(){this.getPreviewImgSize(t,function(t){this.iconImgAreaNode&&this.iconImgAreaNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.iconImgNode&&this.iconImgNode.setStyles({width:t.x+"px",height:t.y+"px","margin-top":t.top+"px"})}.bind(this))}.bind(this),100)}.bind(this))}.bind(this)),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)):-1!==this.controller.options.audios.indexOf(this.data.extension.toLowerCase())?(this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name),this.controller.module.getAttachmentUrl(this,function(e){this.iconImgNode.set({src:t,border:0}),this.iconAudioNode=new Element("div",{styles:this.css.attachmentPreviewAudioNode,html:'<audio preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+e+'" type="audio/mpeg"></source></audio>'}).inject(this.textNode,"after"),this.iconAudioNode.addEvent("dblclick",(function(t){t.stopPropagation()}))}.bind(this))):-1!==this.controller.options.videos.indexOf(this.data.extension.toLowerCase())?this.controller.module.getAttachmentUrl(this,function(t){this.iconNode.empty(),this.iconVideoNode=new Element("div",{styles:this.css.attachmentPreviewVideoNode,html:'<video preload="metadata" controls="controls" style="width: 100%; height: 100%"><source src="'+t+'"></source></video>'}).inject(this.iconNode),this.iconVideoNode.addEvent("dblclick",(function(t){t.stopPropagation()})),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)}.bind(this)):(this.iconImgNode.set({src:t,border:0}),this.textNode=new Element("div",{styles:this.css.attachmentPreviewTextNode}).inject(this.node),this.textNode.set("text",this.data.name)),this.custom_Preview()},custom_Preview:function(){},getPreviewImgSize:function(t,e){var i=this.iconNode.getSize(),s=new Element("img",{src:t}).inject($(document.body));s.set("src",t);var o,n=s.getSize();s.destroy();var c,a=i.x/n.x;(c=n.y*a)<=i.y?o=i.x:(a=i.y/n.y,o=n.x*a,c=i.y);n={x:o,y:c,top:(i.y-c)/2};e&&e(n)},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]),this.controller.selectedAttachments.erase(this)},changeListStyle:function(t){if(this.listStyle!=t){switch(this.node.empty(),t){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.listStyle=t}},reload:function(){var t=new Element("div").inject(this.node,"after");switch(this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},openAttachment:function(t){this.controller.options.isDownload&&this.controller.module&&this.controller.module.openAttachment(t,null,[this])},setActionEnabled:function(t){t&&(t.setStyle("display",""),t.store("disabled",!1))},setActionDisabled:function(t){t&&(t.setStyle("display","none"),t.store("disabled",!0))},createAction:function(t,e,i,s,o,n){var c;if(this.controller.options.actionShowText){c=new Element("div",{styles:this.controller.css.minActionNode,text:n||s,title:s}).inject(t);var a=this;c.addEvents({mouseover:function(t){!this.actionNode.retrieve("disabled")&&a.controller.css.minActionNode_over&&c.setStyles(a.controller.css.minActionNode_over)}.bind({actionNode:c}),mouseout:function(){!this.actionNode.retrieve("disabled")&&a.controller.css.minActionNode_over&&c.setStyles(a.controller.css.minActionNode)}.bind({actionNode:c}),click:function(t){this.retrieve("disabled")||(o.apply(a.controller,[t,this]),t.stopPropagation())}})}else{c=new Element("div",{styles:this.controller.css.minActionNode,title:s}).inject(t);var h=new Element("div",{styles:this.controller.css.minActionIconNode}).inject(c);h.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+this.controller.options.style+"/icon/"+e+".png)");a=this;c.addEvents({mouseover:function(t){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+a.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:c,actionIconNode:h,img:i}),mouseout:function(){this.actionNode.retrieve("disabled")||this.actionIconNode.setStyle("background-image","url("+o2.session.path+"/widget/$AttachmentController/"+a.controller.options.style+"/icon/"+this.img+".png)")}.bind({actionNode:c,actionIconNode:h,img:e}),click:function(t){this.retrieve("disabled")||(o.apply(a.controller,[t,this]),t.stopPropagation())}})}return this.actions||(this.actions=[]),this.actions.push(c),c}}),o2.widget.AttachmentController.AttachmentMin=new Class({Extends:o2.widget.AttachmentController.Attachment,initialize:function(t,e,i,s){this.data=t,!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.content=this.controller.minContent,this.isSelected=!1,this.isCheckPosition=s,this.seq=this.controller.attachments.length+1,i&&this.controller.messageItemList&&(this.message=this.controller.messageItemList[i]),this.load()},load:function(){if(this.message?(this.node=new Element("div").inject(this.message.node,"after"),this.message.node.destroy(),delete this.controller.messageItemList[this.message.data.id]):this.node=new Element("div").inject(this.content),this.isCheckPosition&&this.isNumber(this.data.orderNumber))for(var t=this.controller.attachments,e=0;e<t.length;e++){var i=t[e];if(!this.isNumber(i.data.orderNumber)||this.data.orderNumber<i.data.orderNumber){this.node.inject(i.node,"before");break}}switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.createInforNode(),Browser.Platform.ios||layout.mobile||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.iconImgNode,transition:"flyin"})),this.setEvent()},loadList:function(){this.node.setStyles(layout.mobile?this.css.minAttachmentNode_list_mobile:this.css.minAttachmentNode_list),layout.mobile||(this.sepNode=new Element("div",{styles:this.css.minAttachmentSepNode_list}).inject(this.node)),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",o2.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this),o2.LP.widget.configAttachmentText)),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）"),this.node.set("title",this.data.name+"（"+t+"）")},loadSequence:function(){this.node.setStyles(this.css.minAttachmentNode_sequence),this.actionAreaNode=new Element("div",{styles:this.css.minAttachmentActionAreaNode}).inject(this.node),this.controller.isAttDownloadAvailable(this)&&(this.downloadAction=this.createAction(this.actionAreaNode,"download_single","download_single_over",o2.LP.widget.download,function(t,e){this.controller.downloadAttachment(t,e)}.bind(this))),this.controller.isAttDeleteAvailable(this)&&(this.deleteAction=this.createAction(this.actionAreaNode,"delete_single","delete_single_over",o2.LP.widget.delete,function(t,e){this.controller.deleteAttachment(t,e)}.bind(this))),this.controller.configAttachment&&this.controller.isAttConfigAvailable(this)&&(this.configAction=this.createAction(this.actionAreaNode,"config_single","config_single_over",MWF.LP.widget.configAttachment,function(t,e){this.controller.configAttachment(t,e)}.bind(this))),this.isSelected&&this.node.setStyles(this.css.minAttachmentNode_list_selected),this.sequenceNode=new Element("div",{styles:this.css.attachmentSeqNode_sequence,text:this.seq||1}).inject(this.node),this.iconNode=new Element("div",{styles:this.css.minAttachmentIconNode_list}).inject(this.node),this.iconImgAreaNode=new Element("div",{styles:this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode),this.iconImgNode=new Element("img",{styles:this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode),this.iconImgNode.set({src:this.getIcon(),border:0}),this.textNode=new Element("div",{styles:this.css.minAttachmentTextNode_list}).inject(this.node),this.textNode.set("text",this.data.name);var t="",e=this.data.length/1024;if(e>1024){var i=e/1024;t=(i=Math.round(100*i)/100)+"M"}else t=(e=Math.round(100*e)/100)+"K";this.textSizeNode=new Element("div",{styles:this.css.minAttachmentSizeNode_list}).inject(this.textNode),this.textSizeNode.set("text","（"+t+"）")},setEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_over"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"]))}.bind(this),mouseout:function(){if(!this.isSelected)if("list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t),t.stopPropagation()}.bind(this),click:function(t){t.stopPropagation()}.bind(this),dblclick:function(t){this.openAttachment(t)}.bind(this)})},selected:function(t){t.event.ctrlKey||this.controller.unSelectedAttachments(),this.controller.selectedAttachments.push(this),this.isSelected=!0,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle?this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_selected"]):this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]),t&&t.stopPropagation(),this.controller.checkActions()},reload:function(){var t=new Element("div").inject(this.node,"after");this.inforNode.destroy(),this.inforNode=null,this.tooltip&&this.tooltip.destroy(),this.tooltip=null,this.node.destroy(),delete this.node,this.node=t,this.loadList(),this.createInforNode(),Browser.Platform.ios||(this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},attach:this.node,transition:"flyin"})),this.setEvent()},unSelected:function(){if(this.isSelected=!1,"list"===this.controller.options.listStyle||"sequence"===this.controller.options.listStyle){var t="minAttachmentNode_"+this.controller.options.listStyle+(layout.mobile?"_mobile":"");this.node.setStyles(this.css[t])}else this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);this.controller.selectedAttachments.erase(this)}}),o2.widget.AttachmentController.AttachmentMessage=new Class({Extends:o2.widget.AttachmentController.Attachment,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.content,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}}),o2.widget.AttachmentController.AttachmentMessageMin=new Class({Extends:o2.widget.AttachmentController.AttachmentMin,Implements:[Events],initialize:function(t,e){var i=(new Date).format("db"),s=t.name.substring(t.name.lastIndexOf(".")+1,t.name.length);this.file=t,this.data={activity:"",activityName:"",activityToken:"",activityType:"manual",application:"",completed:!1,control:{allowRead:!0,allowEdit:!1,allowControl:!1},controllerIdentityList:[],controllerUnitList:[],createTime:i,deepPath:!1,divisionList:[],editIdentityList:[],editUnitList:[],extension:s,id:(new o2.widget.UUID).toString(),job:"",lastUpdatePerson:layout?layout.session.user.name:"",lastUpdateTime:i,length:t.size,name:t.name,person:layout?layout.session.user.name:"",process:"",readIdentityList:[],readUnitList:[],site:"$doc",storage:t.size,type:"",updateTime:i,workCreateTime:""},!this.data.person&&this.data.creatorUid&&(this.data.person=this.data.creatorUid),this.controller=e,this.css=this.controller.css,this.listStyle=this.controller.options.listStyle,this.content=this.controller.minContent,this.isSelected=!1,this.seq=this.controller.attachments.length+1,this.actions=[],this.load()},load:function(){switch(this.node=new Element("div").inject(this.content),this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break;case"sequence":this.loadSequence()}this.setEvent(),this.loadMessage()},loadMessage:function(){var t=this.node.getSize();switch(this.node.setStyle("position","relative"),this.messageMaskNode=new Element("div",{styles:this.css.messageMaskNode}).inject(this.node),this.messageMaskNode.setStyles({width:t.x+"px",height:t.y+"px"}),this.messageNode=new Element("div",{styles:this.css.messageNode}).inject(this.node),this.controller.options.listStyle){case"list":case"sequence":this.messageNode.setStyles({width:"0px",height:t.y+"px"});break;case"icon":case"preview":this.messageNode.setStyles({width:t.x+"px",height:t.y+"px"})}this.messageText=new Element("div",{styles:this.css.messageText,text:"0%"}).inject(this.node),this.messageText.setStyles({width:t.x+"px",height:t.y+"px","line-height":t.y+"px"})},updateProgress:function(t){var e=this.node.getSize();switch(this.controller.options.listStyle){case"list":case"sequence":var i=e.x*(t/100);this.messageNode.setStyles({width:i+"px"});break;case"icon":case"preview":var s=e.y*(1-t/100);this.messageNode.setStyle("height",s+"px")}var o=(100*t).toInt()/100;this.messageText.set("text",o+"%")},transferComplete:function(){this.messageText.set("text","loading...")}});