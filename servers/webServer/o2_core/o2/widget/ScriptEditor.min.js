o2.widget=o2.widget||{},o2.require("o2.widget.Common",null,!1),o2.widget.ScriptEditor=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",keySeparat:/[\.\,\;\s\{\}\(\)\n\r\t\:\/\*\"\'=\[\]\+\-\/]+/gi,keyCodes:[220,46,13,222,219,221,57,48,191,190,186,188,32,55,187,189,8,9]},initialize:function(e,t){this.setOptions(t),this.node=$(e),this.path=o2.session.path+"/widget/$ScriptEditor/",this.cssPath=o2.session.path+"/widget/$ScriptEditor/"+this.options.style+"/css.wcss",this._loadCss(),this.checkTextNodes=[],this.checkAll=!1},load:function(e,t){this.fireEvent("queryLoad")&&(this.createContent(e,t),this.fireEvent("postLoad"))},toCode:function(){return this.editDocument.body.innerText},toHTML:function(){return this.editDocument.body.innerHTML},focus:function(){this.editDocument.body.focus()},createContent:function(e,t){this.editArea=new Element("iframe",{styles:this.css.contentEditArea,border:"0",frameBorder:"0",marginHeight:"0",marginWidth:"0",scrolling:"auto"}).inject(this.node),this.loadContent(e,t)},loadContent:function(e,t){this.editDocument=this.editArea.contentWindow.document,this.editWindow=this.editArea.contentWindow,t?this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+t+"</body>"):this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+e+"</body>"),this.editDocument.designMode="On",this.clearFontElements(this.editDocument.body),this.checkScriptFormatComment(this.editDocument.body),this.checkScriptFormatString(this.editDocument.body),this.checkScriptFormatNumber(this.editDocument.body),this.checkScriptFormatKeyword(this.editDocument.body),this.setBodyEvent()},addElementEvent:function(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,(function(){return i()}))},setBodyEvent:function(){this.editDocument.body.style.whiteSpace="nowrap",this.addElementEvent(this.editDocument.body,"blur",function(e){this.fireEvent("change")}.bind(this)),this.addElementEvent(this.editDocument.body,"keydown",function(e){if(9==e.keyCode){this.editWindow.getSelection().getRangeAt(0).insertNode(this.editDocument.createTextNode("\t"));try{e.preventDefault()}catch(e){}return!1}}.bind(this)),this.addElementEvent(this.editDocument.body,"paste",function(e){this.checkAll=!0}.bind(this)),this.addElementEvent(this.editDocument.body,"focus",function(e){this.checkAll&&(this.clearFontElements(this.editDocument.body),this.checkScriptFormatComment(this.editDocument.body),this.checkScriptFormatString(this.editDocument.body),this.checkScriptFormatNumber(this.editDocument.body),this.checkScriptFormatKeyword(this.editDocument.body),this.checkAll=!1)}.bind(this)),this.addElementEvent(this.editDocument.body,"blur",function(e){this.checkAll&&(this.clearFontElements(this.editDocument.body),this.checkScriptFormatComment(this.editDocument.body),this.checkScriptFormatString(this.editDocument.body),this.checkScriptFormatNumber(this.editDocument.body),this.checkScriptFormatKeyword(this.editDocument.body),this.checkAll=!1)}.bind(this)),this.addElementEvent(this.editDocument.body,"keyup",function(e){-1!=this.options.keyCodes.indexOf(e.keyCode)&&this.checkScriptFormat(e.keyCode)}.bind(this))},clearFontElements:function(e){var t=e.getElementsByTagName("font");for(t.length;t.length;){var i=t.item(0);if(i.previousSibling&&3==i.previousSibling.nodeType){i.previousSibling.nodeValue=i.previousSibling.nodeValue+i.firstChild.nodeValue;var n=i.previousSibling;for(i.parentElement.removeChild(i);n.nextSibling&&3==n.nextSibling.nodeType;)n.nodeValue=n.nodeValue+n.nextSibling.nodeValue,n.nextSibling.parentNode.removeChild(n.nextSibling)}else if(i.nextSibling&&3==i.nextSibling.nodeType){i.nextSibling.nodeValue=i.firstChild.nodeValue+i.nextSibling.nodeValue;n=i.nextSibling;for(i.parentElement.removeChild(i);n.previousSibling&&3==n.previousSibling.nodeType;)n.nodeValue=n.nodeValue+n.previousSibling.nodeValue,n.previousSibling.parentNode.removeChild(n.previousSibling)}else i.firstChild?i.parentNode.replaceChild(this.editDocument.createTextNode(i.firstChild.nodeValue),i):i.parentNode.removeChild(i)}},getCheckScriptElements:function(e){if(e)if(3==e.nodeType)this.checkTextNodes.push(e);else if(1==e.nodeType&&"font"==e.tagName.toString().toLowerCase());else for(var t=e.childNodes,i=0;i<t.length;i++)this.getCheckScriptElements(t[i])},checkScriptFormat:function(e){var t=this.editWindow.getSelection(),i=t.focusNode;if(8!=e&&13!=e&&9!=e)try{var n=t.focusOffset,o=this.getCurrentOffset(i)+n}catch(e){}var r=null;if(3==i.nodeType)for(r=i.parentNode;r&&1==r.nodeType&&"p"!=r.tagName.toString().toLowerCase()&&"body"!=r.tagName.toString().toLowerCase();)r=r.parentElement;else for(r=i.previousSibling;r&&1==r.nodeType&&"p"!=r.tagName.toString().toLowerCase()&&"body"!=r.tagName.toString().toLowerCase();)r=r.parentElement;if(r){var s=this.checkAll?this.editDocument.body:r;if(this.clearFontElements(s),this.checkScriptFormatComment(s),this.checkScriptFormatString(s),this.checkScriptFormatNumber(s),this.checkScriptFormatKeyword(s),this.checkAll=!1,8!=e&&13!=e&&9!=e)try{var c=this.getBackOffset(o,r);t.collapse(c.node,c.offset)}catch(e){}}},getCurrentOffset:function(e){var t=0,i=e.previousSibling;return i?(t=3==i.nodeType?i.nodeValue.length:i.innerText.length,t+=this.getCurrentOffset(i)):(i=e.parentNode)&&1==i.nodeType&&"p"!=i.tagName.toString().toLowerCase()&&"body"!=i.tagName.toString().toLowerCase()&&(t+=this.getCurrentOffset(i)),t},getBackOffset:function(e,t){if(3==t.nodeType){var i=t.nodeValue.length;if(i>=e)return{node:t,offset:e};for(e-=i,tmpNode=t.nextSibling;!tmpNode;)t=t.parentNode,tmpNode=t.nextSibling;return this.getBackOffset(e,t.nextSibling)}return this.getBackOffset(e,t.firstChild)},checkScriptFormatNumber:function(e){this.checkTextNodes=[],this.getCheckScriptElements(e),this.checkTextNodes.each(function(e){this.checkScriptTextFormatNumber(e)}.bind(this))},checkScriptTextFormatNumber:function(e){var t=this.css.number.color,i=this.editDocument.createRange(),n=e.nodeValue.match(/\b(-?\d+(\.\d+)?)/g);if(n){var o=n[0],r=e.nodeValue.indexOf(o),s=r+o.length;i.setStart(e,r),i.setEnd(e,s);var c=this.createFormatFont(i,t,"number").nextSibling;c&&3==c.nodeType&&this.checkScriptTextFormatNumber(c)}},checkScriptFormatString:function(e){this.checkTextNodes=[],this.getCheckScriptElements(e),this.isScriptTextString=!1,this.checkTextNodes.each(function(e){this.checkScriptTextFormatString(e)}.bind(this))},checkScriptTextFormatString:function(e){var t=this.css.string.color,i=this.editDocument.createRange(),n=e.nodeValue,o=n.indexOf('"'),r=n.indexOf("'"),s=-1,c=-1;if(-1!=o&&-1==r?s=o:-1==o&&-1!=r?(s=r,"'"):-1!=o&&-1!=r&&(o<r?s=o:(s=r,"'")),-1!=s){for(var d=n.indexOf('"',s+1);-1!=d;){if("\\"!=n.substr(d-1,1)){c=d+1;break}d=n.indexOf('"',d+1)}if(-1!=c){i.setStart(e,s),i.setEnd(e,c);var a=this.createFormatFont(i,t,"string").nextSibling;a&&3==a.nodeType&&this.checkScriptTextFormatString(a)}}},checkScriptFormatKeyword:function(e){this.checkTextNodes=[],this.getCheckScriptElements(e),this.checkTextNodes.each(function(e){this.checkScriptTextFormatKeyword(e)}.bind(this))},checkScriptTextFormatKeyword:function(e){var t=this.css.keywords.color,i=this.editDocument.createRange(),n=e.nodeValue.match(/\b((function)|(if)|(else)|(case)|(switch)|(for)|(in)|(do)|(while)|(with)|(var)|(this)|(break)|(continue)|(return)|(true)|(false)|(throw)|(try)|(finally)|(catch)|(finally)|(debugger)|(new)|(delete))/gi);if(n){var o=n[0],r=e.nodeValue.indexOf(o),s=r+o.length;i.setStart(e,r),i.setEnd(e,s);var c=this.createFormatFont(i,t,"keyword").nextSibling;c&&3==c.nodeType&&this.checkScriptTextFormatKeyword(c)}},checkScriptFormatComment:function(e){this.checkTextNodes=[],this.getCheckScriptElements(e),this.isScriptTextComment=!1,this.checkTextNodes.each(function(e){this.checkScriptTextFormatComment(e)}.bind(this))},checkScriptTextFormatComment:function(e){var t=this.css.comment.color,i=this.editDocument.createRange();if(this.isScriptTextComment){var n=e.nodeValue.indexOf("*/");-1!=n?(i.setStart(e,0),i.setEnd(e,n+2),this.isScriptTextComment=!1,this.createFormatFont(i,t,"comment")):(i.setStart(e,0),i.setEnd(e,e.nodeValue.length),this.createFormatFont(i,t,"comment"))}else{var o=e.nodeValue.indexOf("//"),r=e.nodeValue.indexOf("/*");-1!=o&&-1==r?(i.setStart(e,o),i.setEnd(e,e.nodeValue.length),this.createFormatFont(i,t,"comment")):-1==o&&-1!=r?(i.setStart(e,r),i.setEnd(e,e.nodeValue.length),this.isScriptTextComment=!0,this.createFormatFont(i,t,"comment")):-1!=o&&-1!=r&&(o<r?(i.setStart(e,o),i.setEnd(e,e.nodeValue.length),this.createFormatFont(i,t,"comment")):(i.setStart(e,r),i.setEnd(e,e.nodeValue.length),this.isScriptTextComment=!0,this.createFormatFont(i,t,"comment")))}},createFormatFont:function(e,t,i){var n=this.editDocument.createElement("font");return n.appendChild(this.editDocument.createTextNode(e.toString())),n.MWFScriptType=i,n.setAttribute("color",t),e.deleteContents(),e.insertNode(n),n},checkScriptFormat1:function(){var e=this.editWindow.getSelection().focusNode;if(3!=e.nodeType)e=null;else{var t=e.parentElement;if("font"==t.tagName.toString().toLowerCase())switch(t.MWFScriptType){case"comment_line":var i=t.firstChild.nodeValue,n=i.injdexOf("//");if(-1!=n){var o=i.substr(0,n);if(o)(r=t.previousSibling)&&3==r.nodeType?(r.nodeValue=r.nodeValue+o,e=r):t.parentElement.insertBefore(document.createTextNode(o),t),e.nodeValue=i.substr(n,i.length)}else{var r;(r=t.previousSibling)&&3==r.nodeType?r.nodeValue=r.nodeValue+i:t.parentElement.insertBefore(document.createTextNode(i),t),t.parentElement.removeChild(t)}}}}});