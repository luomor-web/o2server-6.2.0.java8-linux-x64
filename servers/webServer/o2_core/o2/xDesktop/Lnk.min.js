Element.implement({makeLnk:function(t){return new MWF.xDesktop.LnkMaker(this,t)}}),MWF.xDesktop.LnkMaker=new Class({Implements:[Options,Events],initialize:function(t,e){this.setOptions(e),this.node=t,this.desktop=layout.desktop,this.tmpApps=[],this.isReadyDrag=!1,this.readyDragPosition=null,this.setEvent()},setEvent:function(){this.node.addEvents({mousedown:function(t){t.rightClick||(this.isReadyDrag=!0,this.readyDragPosition={x:t.page.x,y:t.page.y},document.body.addEvent("mousemove",function(t){this.isReadyDrag&&(Math.abs(t.page.x-this.readyDragPosition.y)>6||Math.abs(t.page.y-this.readyDragPosition.y)>6)&&(this.isReadyDrag=!1,this.readyDragPosition=null,this.node.removeEvents("mousemove"),this.beginMoveToDesktop(t))}.bind(this)))}.bind(this),mouseup:function(t){this.isReadyDrag=!1,this.readyDragPosition=null,this.node.removeEvents("mousemove")}.bind(this)})},createMoveNode:function(){var t=new Element("div",{styles:this.desktop.css.lnkMoveNode}).inject(this.desktop.desktopNode),e=this.node.getSize();return t.setStyles({width:e.x+"px",height:e.y+"px"}),this.node.clone().inject(t),t.position({relativeTo:this.node}),t},beginMoveToDesktop:function(t){var e=this.createMoveNode(),i=this.desktop;new Drag.Move(e,{snap:10,stopPropagation:!0,droppables:i.lnkAreas,onStart:function(){this.fireEvent("start"),this.start(),this.fireEvent("afterStart")}.bind(this),onDrag:function(t,e){this.fireEvent("drag",t),this.drag(t,e),this.fireEvent("afterDrag",t)}.bind(this),onEnter:function(t,e){this.fireEvent("enter",t,e),this.enter(t,e),this.fireEvent("afterEnter",t,e)}.bind(this),onLeave:function(t,e){this.fireEvent("leave",t,e),this.leave(t),this.fireEvent("afterLeave",t,e)}.bind(this),onDrop:function(e,i){this.fireEvent("drop",e,i),this.drop(e,t),this.fireEvent("afterDrop",e,i)}.bind(this),onCancel:function(t){this.fireEvent("cancel",t),this.cancel(t),this.fireEvent("afterCancel",t)}.bind(this),onComplete:function(t,e){this.fireEvent("complete",t,e),this.fireEvent("afterComplete",t,e)}.bind(this)}).start(t)},start:function(){this.tmpApps=[],Object.each(this.desktop.apps,function(t,e){t.window.isHide||(this.tmpApps.push(t),t.window._fadeOut())}.bind(this))},enter:function(t,e){this.addLnkMark(t,e)},drag:function(t,e){this.moveLnkMark(t,e)},leave:function(t){this.removeLnkMark(t)},drop:function(t){this.addLnk(t),this.endMoveToDesktop(t)},cancel:function(t){this.endMoveToDesktop(t)},addLnkMark:function(t,e){this.lnkMarkNode||(this.lnkMarkNode=new Element("div",{styles:this.desktop.css.dsektoplnkMarkNode}).inject(e))},moveLnkMark:function(t,e){if(this.lnkMarkNode){for(var i=t.getPosition(),s=t.getSize(),n=this.lnkMarkNode.getParent(),o=n.getChildren(),d=!1,h=0;h<o.length;h++)if(o[h]!=this.lnkMarkNode&&o[h]!=t){var a=o[h].getPosition(),r=o[h].getSize();if(a.y+r.y>i.y+s.y/2&&a.x+r.x>i.x+s.x/2);else if(a.y+r.y>i.y+s.y){this.lnkMarkNode.inject(o[h],"before"),this.lnkMarkNode.setStyle("top",a.y-10),d=!0;break}}d||(this.lnkMarkNode.inject(n),this.lnkMarkNode.setStyle("top","auto"),this.desktop.lnks.length&&this.lnkMarkNode.setStyle("top",this.lnkMarkNode.getPosition().y-10))}},removeLnkMark:function(t){this.lnkMarkNode&&(this.lnkMarkNode.destroy(),this.lnkMarkNode=null)},addLnk:function(t){if(this.lnkMarkNode){var e=this.options.par,i=new MWF.xDesktop.Lnk(e.icon,e.title,e.par),s=this.lnkMarkNode.getNext();if(s){var n=s.retrieve("lnk"),o=this.desktop.lnks.indexOf(n);this.desktop.lnks.splice(o,0,i)}else this.desktop.lnks.push(i);i.inject(this.lnkMarkNode,"after"),this.removeLnkMark(),this.desktop.resizeLnk()}},endMoveToDesktop:function(t){this.tmpApps.each((function(t){t.window._fadeIn()})),this.tmpApps=[],t&&t.destroy()}}),MWF.xDesktop.LnkMove=new Class({Extends:MWF.xDesktop.LnkMaker,setEvent:function(){this.isReadySwing=!1,this.readySwingTime="",this.node.addEvents({mousedown:function(t){t.rightClick||(this.isReadyDrag=!0,this.readyDragPosition={x:t.page.x,y:t.page.y},this.readySwingTime=(new Date).getTime(),this.node.addEvent("mousemove",function(e){this.isReadyDrag&&(Math.abs(e.page.x-this.readyDragPosition.x)>10||Math.abs(e.page.y-this.readyDragPosition.y)>10)&&(this.clearEvent(),this.beginMoveToDesktop(t))}.bind(this)))}.bind(this),mouseup:function(t){this.clearEvent()}.bind(this)})},clearEvent:function(){this.isReadyDrag=!1,this.readyDragPosition=null,this.isReadySwing=!1,this.readySwingTime="",this.node.removeEvents("mousemove"),window.clearTimeout(this.swingTimer)},beginNodeSwing:function(t){this.isReadySwing&&(this.clearEvent(),this.morph=new Fx.Morph(this.node,{duration:100}),this.node.retrieve("lnk").isSwing=!0,this.nodeSwing(22))},nodeSwing:function(t){var e=22==t?18:22;this.morph.start({"margin-left":e}).chain(function(){this.nodeSwing(e)}.bind(this))},stopSwing:function(){this.morph.cancel();var t=this.node.retrieve("lnk");this.morph.start({"margin-left":20}).chain(function(){t.isSwing=!1}.bind(this))},createMoveNode:function(){var t=this.node.clone().inject(this.desktop.desktopNode);return t.position({relativeTo:this.node}),t.setStyles(this.desktop.css.desktopLnkNode),t},start:function(){this.node.setStyle("opacity",.5),this.node.setStyles(this.desktop.css.desktopLnkNode_current)},addLnk:function(t){if(this.lnkMarkNode){var e=this.lnkMarkNode.getNext(),i=this.lnkMarkNode.getPrevious(),s=e?e.retrieve("lnk"):null,n=i?i.retrieve("lnk"):null,o=this.node.retrieve("lnk");if(s)if(s==o||n==o);else{this.desktop.lnks.erase(o);var d=this.desktop.lnks.indexOf(s);-1!=d?this.desktop.lnks.splice(d,0,o):this.desktop.lnks.push(o)}else this.desktop.lnks.erase(o),this.desktop.lnks.push(o);this.removeLnkMark(),this.desktop.resizeLnk()}this.node.fade("in")},endMoveToDesktop:function(t){this.node.setStyles(this.desktop.css.desktopLnkNode),t&&t.destroy()}}),MWF.xDesktop.Lnk=new Class({initialize:function(t,e,i){this.desktop=layout.desktop,this.icon=t,this.title=e,this.par=i,this.node=new Element("div",{styles:this.desktop.css.desktopLnkNode,title:this.title}),this.node.store("lnk",this),this.iconNode=new Element("div",{styles:this.desktop.css.desktopLnkIconNode}).inject(this.node);var s=new Element("img").inject(this.iconNode),n=this.iconNode.getSize();n.x||(n.x=this.iconNode.getStyle("width").toFloat()),n.y||(n.y=this.iconNode.getStyle("height").toFloat());var o=n.x-10,d=n.y-10;s.setStyles({margin:"5px","max-width":o+"px","max-height":d+"px"}),"url"==this.icon.substr(0,3).toLowerCase()?s.set("src",this.icon.substring(4,this.icon.length-1)):s.set("src",this.icon),this.titleNode=new Element("div",{styles:this.desktop.css.desktopLnkTitleNode,text:this.title}).inject(this.node),this.node.addEvents({mouseover:function(t){this.node.setStyles(this.desktop.css.desktopLnkNode_current)}.bind(this),mouseout:function(t){this.node.setStyles(this.desktop.css.desktopLnkNode)}.bind(this),click:function(t){this.open(t)}.bind(this)}),this.lnkMove=new MWF.xDesktop.LnkMove(this.node),this.loadMenu()},loadMenu:function(){this.menu=new MWF.widget.Menu(this.node,{style:"lnk",container:this.desktop.node}),this.menu.load(),this.menu.addMenuItem(o2.LP.desktop.deleteLink,"click",function(){this.deleteLnk()}.bind(this))},deleteLnk:function(){this.desktop.lnks.erase(this),this.node.destroy(),MWF.release(this)},inject:function(t,e){this.node.inject(t,e)},open:function(t){if(this.isSwing)this.stopSwingFun=function(){this.lnkMove.stopSwing(),this.node.removeEvent("click",this.stopSwingFun)}.bind(this),this.node.addEvent("click",this.stopSwingFun);else{var e=this.par.split("#"),i=e[0],s=e[1]||"";if("@url"===i.toLowerCase())window.open(s);else{var n=JSON.decode(s,!1),o={};n&&(o=n.appId?{appId:n.appId,onQueryLoad:function(){this.status=n}}:{onQueryLoad:function(){this.status=n}}),this.desktop.openApplication(t,i,o)}}}});