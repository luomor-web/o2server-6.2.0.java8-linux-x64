MWF.xDesktop.MessageV2=new Class({Implements:[Events],initialize:function(t){this.desktop=t,this.container=this.desktop.contentNode,this.actionNode=this.desktop.msgActionNode,this.items=[],this.isShow=!1,this.isMorph=!1,this.unread=0,this.itemTemplate='<div class="layout_message_item_top" data-o2-element="topNode">\t<div class="layout_message_item_top_close icon_msg_close" data-o2-element="closeNode" data-o2-events="click:closeMsg"></div>\t<div class="layout_message_item_top_subject" data-o2-element="subjectNode" title="{{$.msg.subject}}">{{$.msg.subject}}</div></div><div class="layout_message_item_content" data-o2-element="contentNode"></div><div class="layout_message_item_bottom" data-o2-element="bottomNode">\t<div class="layout_message_item_bottom_date" data-o2-element="dateNode"></div>\t<div class="layout_message_item_bottom_action" data-o2-element="actionsNode"></div></div>'},load:function(){var t=this.desktop.path+this.desktop.options.style+(o2.session.isMobile||layout.mobile?"/layout-message-mobile.html":"/layout-message-pc.html");this.container.loadHtml(t,{bind:{lp:o2.LP.desktop},module:this},function(){MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.scrollNode,{style:"xDesktop_Message",where:"before",indent:!1,distance:100,friction:6,axis:{x:!1,y:!0}})}.bind(this)),this.node.addEvent("mousedown",(function(t){t.stopPropagation(),t.preventDefault()})),this.hideMessage=function(){this.hide()}.bind(this),this.fireEvent("load")}.bind(this))},setPosition:function(){var t=this.container.getSize(),e=this.container.getPosition();this.maskNode.setStyle("height",t.y+"px"),this.node.setStyle("height",t.y+"px");var s=t.y-40;this.scrollNode.setStyle("height",s+"px");var i=t.x;e.y;this.maskNode.setStyles({left:i+"px",top:"0px"}),this.node.setStyles({left:i+"px",top:"0px"})},show:function(){var t=MWF.xDesktop.zIndexPool.zIndex;if(!this.isMorph){this.isMorph=!0,this.setPosition(),this.morph||(this.maskMorph=new Fx.Morph(this.maskNode,{duration:"200",transition:Fx.Transitions.Sine.easeOut}),this.morph=new Fx.Morph(this.node,{duration:"200",transition:Fx.Transitions.Sine.easeOut})),this.maskNode.setStyles({display:"block","z-index":t}),this.node.setStyles({display:"block","z-index":t});var e=this.node.getPosition(this.node.getOffsetParent()),s=this.node.getSize(),i=e.x-s.x;this.maskMorph.start({left:i+"px","z-index":t}),this.morph.start({left:i+"px","z-index":t}).chain(function(){this.isShow=!0,this.isMorph=!1,this.desktop.desktopNode.addEvent("mousedown",this.hideMessage),this.fireEvent("show")}.bind(this))}},hide:function(){if(!this.isMorph){this.isMorph=!0,this.morph||(this.maskMorph=new Fx.Morph(this.maskNode,{duration:"200",transition:Fx.Transitions.Sine.easeOut}),this.morph=new Fx.Morph(this.node,{duration:"200",transition:Fx.Transitions.Sine.easeOut}));var t=this.node.getPosition(this.node.getOffsetParent()),e=this.node.getSize(),s=t.x+e.x;this.maskMorph.start({left:s+"px"}).chain(function(){this.maskNode.setStyle("display","none")}.bind(this)),this.morph.start({left:s+"px"}).chain(function(){this.node.setStyle("display","none"),this.isShow=!1,this.isMorph=!1,this.desktop.desktopNode.removeEvent("mousedown",this.hideMessage),this.fireEvent("hide")}.bind(this))}},resize:function(){this.setPosition()},clearMessage:function(){var t=[];for(this.items.each(function(e){"progress"!=e.status&&t.push(e)}.bind(this));t.length;)t[0].close(),t.erase(t[0])},addMessage:function(t,e){var s=e?(new Date).parse(e):new Date,i=new MWF.xDesktop.Message.Item(this,t,s);return this.items.push(i),this.addUnread(),i},addTooltip:function(t,e){var s=e?(new Date).parse(e):new Date;return new MWF.xDesktop.Message.Tooltip(this,t,s)},getUnread:function(){return this.unread||0},setUnread:function(){this.unread>0?(this.unreadNode||(this.unreadNode=new Element("div.layout_message_unread_node").inject(this.actionNode)),this.unreadNode.set("text",this.unread)):this.unreadNode&&(this.unreadNode.destroy(),this.unreadNode=null,delete this.unreadNode)},addUnread:function(t){var e=t||1;this.unread=this.unread+e,this.setUnread()}}),MWF.xDesktop.MessageV2.Item=new Class({Implements:[Events],initialize:function(t,e,s){this.message=t,this.container=this.message.contentNode,this.css=this.message.css,this.msg=e,this.showTime=s,this.load()},load:function(){this.node=new Element("div.layout_message_item").inject(this.container,"top"),this.node.injectHtml(this.message.itemTemplate,{bind:{msg:this.msg},module:this}),this.contentNode.set({html:this.msg.content}),this.contentNode.set({title:this.contentNode.get("text")}),this.dateNode.set("text",this.showTime.format("db")),this.setEvent()},setEvent:function(){},closeMsg:function(t){this.close(null,t)},close:function(t,e){this.closeItem(t,e)},closeItem:function(t){var e=new Fx.Morph(this.node,{duration:"200"}),s=this.node.getSize();this.node.setStyle("height",s.y+"px"),this.message.items.erase(this),e.start({opacity:0,height:"0px"}).chain(function(){this.message.addUnread(-1),this.node.destroy(),t&&t()}.bind(this))}}),MWF.xDesktop.MessageV2.Item.tooltips=[],MWF.xDesktop.MessageV2.tooltipNode=null,MWF.xDesktop.MessageV2.Tooltip=new Class({Extends:MWF.xDesktop.MessageV2.Item,setEvent:function(){if(!MWF.xDesktop.MessageV2.tooltipNode){MWF.xDesktop.MessageV2.tooltipNode=new Element("div.layout_message_tooltipArea").inject(this.message.container);var t=this.message.desktop.contentNode;MWF.xDesktop.MessageV2.tooltipNode.position({relativeTo:t,position:"rightTop",edge:"rightTop"})}this.node.inject(MWF.xDesktop.MessageV2.tooltipNode),this.node.addClass("layout_message_tooltip_item"),MWF.xDesktop.MessageV2.Item.tooltips.push(this),window.setTimeout(function(){this.close(function(){MWF.xDesktop.MessageV2.Item.tooltips.erase(this)}.bind(this))}.bind(this),1e4)},closeMsg:function(){this.close(function(){MWF.xDesktop.MessageV2.Item.tooltips.erase(this)}.bind(this))},closeItem:function(t){var e=new Fx.Morph(this.node,{duration:"200"}),s=this.node.getSize();this.node.setStyle("height",s.y+"px"),this.message.items.erase(this),e.start({opacity:0,height:"0px"}).chain(function(){this.node.destroy(),t&&t()}.bind(this))}}),MWF.xDesktop.Message=MWF.xDesktop.MessageV2;