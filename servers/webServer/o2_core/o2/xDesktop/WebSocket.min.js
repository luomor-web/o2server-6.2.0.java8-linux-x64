MWF.xDesktop=MWF.xDesktop||{},MWF.xApplication=MWF.xApplication||{},MWF.require("MWF.xDesktop.Actions.RestActions",null,!1),MWF.xDesktop.WebSocket=new Class({Implements:[Options,Events],options:{},initialize:function(e){var t=layout.serviceAddressList.x_message_assemble_communicate,s="https"===new URI(window.location.href).get("scheme").toString().toLowerCase()?"wss":"ws";this.ws=s+"://"+t.host+(80==t.port?"":":"+t.port)+t.context+"/ws/collaboration",this.reConnect=!0,this.checking=!1,this.heartTimeout=3e4,this.checkingTimeout=4e3,this.heartMsg="heartbeat",this.maxErrorCount=10,this.errorCount=0,this.connect()},connect:function(){if(layout.config.webSocketEnable){var e=this.ws+"?"+o2.tokenName+"="+encodeURIComponent(layout.session.token);e=o2.filterUrl(e);try{this.webSocket=new WebSocket(e),this.webSocket.onopen=function(e){this.onOpen(e)}.bind(this),this.webSocket.onclose=function(e){this.onClose(e)}.bind(this),this.webSocket.onmessage=function(e){this.onMessage(e)}.bind(this),this.webSocket.onerror=function(e){this.onError(e)}.bind(this)}catch(e){this.errorCount++,console.log("Unable to connect to the websocket server, will retry in "+this.checkingTimeout/1e3+" seconds"),this.checkRetry()}}},onOpen:function(e){this.errorCount=0,console.log("websocket is open, You can receive system messages"),this.heartbeat()},onClose:function(e){console.log("websocket is closed. ")},onMessage:function(e){if(e.data)try{if(e.data===this.heartMsg)return this.heartbeat(),!0;var t=JSON.decode(e.data);switch(t.category){case"dialog":switch(t.type){case"text":this.receiveChatMessage(t)}break;default:switch(t.type){case"task":case"task_create":case"task_urge":case"task_expire":case"task_press":this.receiveTaskMessage(t);break;case"read":case"read_create":this.receiveReadMessage(t);break;case"review":this.receiveReviewMessage(t);break;case"fileEditor":case"attachment_editor":case"attachment_editorCancel":case"attachment_editorModify":this.receiveFileEditorMessage(t);break;case"fileShare":case"attachment_share":case"attachment_shareCancel":this.receiveFileShareMessage(t);break;case"meetingInvite":case"meeting_invite":this.receiveMeetingInviteMessage(t);break;case"meetingCancel":case"meeting_cancel":this.receiveMeetingCancelMessage(t);break;case"meetingAccept":case"meeting_accept":this.receiveMeetingAcceptMessage(t);break;case"meetingReject":case"meeting_reject":this.receiveMeetingRejectMessage(t);break;case"attendanceAppealInvite":this.receiveAttendanceAppealInviteMessage(t);break;case"attendanceAppealAccept":this.receiveAttendanceAppealAcceptMessage(t);break;case"attendanceAppealReject":this.receiveAttendanceAppealRejectMessage(t);break;case"calendar_alarm":this.receiveCalendarAlarmMessage(t);break;case"teamwork_taskCreate":case"teamwork_taskUpdate":case"teamwork_taskDelelte":case"teamwork_taskOvertime":case"teamwork_taskChat":this.receiveTeamWorkMessage(t);break;case"custom_create":this.receiveCustomMessage(t);case"im_create":console.log("im 消息来了！！！"),this.receiveIMMessage(t);break;case"cms_publish":this.receiveCMSPublishMessage(t)}}}catch(e){}},onError:function(e){this.errorCount++,console.log("Unable to connect to the websocket server, will retry in "+this.checkingTimeout/1e3+" seconds."),this.checkRetry()},checkRetry:function(){this.serverCheck&&window.clearTimeout(this.serverCheck),this.heartbeatCheck&&window.clearTimeout(this.heartbeatCheck),this.errorCount<this.maxErrorCount&&(this.serverCheck=window.setTimeout(function(){this.retry()}.bind(this),this.checkingTimeout))},retry:function(){this.webSocket&&this.close(),console.log("Retry connect to websocket server. ("+this.errorCount+"/"+this.maxErrorCount+")"),this.connect()},close:function(){this.reConnect=!1,this.webSocket&&this.webSocket.close()},send:function(e){this.webSocket&&1==this.webSocket.readyState||(this.serverCheck&&window.clearTimeout(this.serverCheck),this.retry()),this.webSocket.send(JSON.encode(e))},heartbeat:function(){this.serverCheck&&window.clearTimeout(this.serverCheck),this.heartbeatCheck&&window.clearTimeout(this.heartbeatCheck),this.heartbeatCheck=window.setTimeout(function(){this.sendHeartbeat(this.heartMsg)}.bind(this),this.heartTimeout)},sendHeartbeat:function(e){this.webSocket&&1==this.webSocket.readyState||(this.serverCheck&&window.clearTimeout(this.serverCheck),this.retry());try{this.webSocket.send(e),this.checkRetry()}catch(e){this.serverCheck&&window.clearTimeout(this.serverCheck),this.retry()}},receiveCMSPublishMessage:function(e){var t="<font style='color: #ea621f'>"+(e.body.creatorPerson||"").split("@")[0]+"</font>"+MWF.LP.desktop.messsage.publishDocument+e.body.title,s={subject:e.body.categoryName,content:t},o=layout.desktop.message.addMessage(s);layout.desktop.message.addTooltip(s).contentNode.addEvent("click",(function(t){layout.desktop.message.hide();var s="cms.Document"+e.body.id;if(layout.desktop.apps&&layout.desktop.apps[s])layout.desktop.apps[s].setCurrent();else{var o={documentId:e.body.id,appId:s};layout.desktop.openApplication(t,"cms.Document",o)}})),o.contentNode.addEvent("click",(function(t){layout.desktop.message.addUnread(-1),layout.desktop.message.hide();var s="cms.Document"+e.body.id;if(layout.desktop.apps&&layout.desktop.apps[s])layout.desktop.apps[s].setCurrent();else{var o={documentId:e.body.id,appId:s};layout.desktop.openApplication(t,"cms.Document",o)}}))},receiveChatMessage:function(e){layout.desktop.widgets.IMIMWidget&&layout.desktop.widgets.IMIMWidget.receiveChatMessage(e)},openWork:function(e,t){o2.Actions.get("x_processplatform_assemble_surface").getWorkInfor(e,function(){var s={workId:e,appId:"process.Work"+e};layout.desktop.openApplication(t,"process.Work",s)}.bind(this),function(){layout.desktop.openApplication(t,"process.TaskCenter",null,{status:{navi:"task"}})}.bind(this))},receiveTaskMessage:function(e){var t=e.body,s=e.title;s+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+t.applicationName+"</font>;  <font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+t.processName+"</font>";var o={subject:MWF.LP.desktop.messsage.taskMessage,content:s},a=layout.desktop.message.addMessage(o,e.body.startTime);layout.desktop.message.addTooltip(o,e.body.startTime).contentNode.addEvent("click",function(e){layout.desktop.message.hide(),this.openWork(t.work,e)}.bind(this)),a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),this.openWork(t.work,e)}.bind(this))},receiveReadMessage:function(e){var t=e.body,s=e.title;s+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+t.applicationName+"</font>;  <font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+t.processName+"</font>";var o={subject:MWF.LP.desktop.messsage.readMessage,content:s},a=layout.desktop.message.addMessage(o,e.body.startTime);layout.desktop.message.addTooltip(o,e.body.startTime).contentNode.addEvent("click",function(e){layout.desktop.message.hide(),this.openWork(t.work,e)}.bind(this)),a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),this.openWork(t.work,e)}.bind(this))},receiveCustomMessage:function(e){var t="<font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.customMessage+"：</font>"+e.body,s={subject:MWF.LP.desktop.messsage.customMessageTitle,content:t};layout.desktop.message.addMessage(s),layout.desktop.message.addTooltip(s)},receiveIMMessage:function(e){var t=e.body,s=t.body,o=t.conversationId,a=JSON.parse(s),n=a.body;a.type&&"emoji"==a.type&&(n="["+MWF.LP.desktop.messsage.emoji+"]");var i="<font style='color: #333; font-weight: bold'>"+e.title+"</font>: "+n,d={subject:MWF.LP.desktop.messsage.customMessageTitle,content:i},c=layout.desktop.message.addMessage(d),p={conversationId:o};c.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"IMV2",p)}.bind(this)),layout.desktop.message.addTooltip(d).contentNode.addEvent("click",function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"IMV2",p)}.bind(this))},receiveReviewMessage:function(e){var t=MWF.LP.desktop.messsage.receiveReview+"《"+e.title+"》. ";t+="<br/><font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.appliction+": </font><font style='color: #ea621f'>"+e.applicationName+"</font>;  <font style='color: #333; font-weight: bold'>"+MWF.LP.desktop.messsage.process+": </font><font style='color: #ea621f'>"+e.processName+"</font>";var s={subject:MWF.LP.desktop.messsage.reviewMessage,content:t},o=layout.desktop.message.addMessage(s,e.body.startTime);layout.desktop.message.addTooltip(s,e.body.startTime).contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"review"}})})),o.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"process.TaskCenter",null,{status:{navi:"review"}})}))},receiveFileEditorMessage:function(e){var t="<font style='color: #ea621f; font-weight: bold'>"+MWF.name.cn(e.body.person)+"</font> "+MWF.LP.desktop.messsage.receiveFileEditor+"“"+e.body.name+"”. ",s={subject:MWF.LP.desktop.messsage.fileEditorMessage,content:t},o=layout.desktop.message.addMessage(s,e.body?e.body.startTime:"");layout.desktop.message.addTooltip(s,e.body?e.body.startTime:"").contentNode.addEvent("click",(function(t){layout.desktop.message.hide(),layout.desktop.openApplication(t,"File",null,{status:{tab:"editor",node:e.person}})})),o.contentNode.addEvent("click",(function(t){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(t,"File",null,{status:{tab:"editor",node:e.person}})}))},receiveFileShareMessage:function(e){var t="<font style='color: #ea621f; font-weight: bold'>"+MWF.name.cn(e.body.person)+"</font> "+MWF.LP.desktop.messsage.receiveFileShare+"“"+e.body.name+"”. ",s={subject:MWF.LP.desktop.messsage.fileShareMessage,content:t},o=layout.desktop.message.addMessage(s,e.body?e.body.createTime:"");layout.desktop.message.addTooltip(s,e.body?e.body.createTime:"").contentNode.addEvent("click",(function(t){layout.desktop.message.hide(),o2.Actions.load("x_portal_assemble_surface").PortalAction.get("cloudFile",(function(){layout.desktop.openApplication(t,"portal.Portal",{portalId:"cloudFile"})}),(function(){layout.desktop.openApplication(t,"File",null,{status:{tab:"share",node:e.person}})}))})),o.contentNode.addEvent("click",(function(t){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(t,"File",null,{status:{tab:"share",node:e.person}})}))},getMeeting:function(e,t){if(e.body&&"object"===typeOf(e.body)){e=e.body;MWF.Actions.get("x_meeting_assemble_control").getRoom(e.room,function(s){e.roomName=s.data.name,MWF.Actions.get("x_meeting_assemble_control").getBuilding(s.data.building,function(s){e.buildingName=s.data.name,t&&t(e)}.bind(this))}.bind(this))}else MWF.Actions.get("x_meeting_assemble_control").getMeeting(e.metting,function(e){var s=e.data;MWF.Actions.get("x_meeting_assemble_control").getRoom(s.room,function(e){s.roomName=e.data.name,MWF.Actions.get("x_meeting_assemble_control").getBuilding(e.data.building,function(e){s.buildingName=e.data.name,t&&t(s)}.bind(this))}.bind(this))}.bind(this))},receiveMeetingInviteMessage:function(e){this.getMeeting(e,function(t){var s=MWF.LP.desktop.messsage.meetingInvite;s=s.replace(/{person}/g,MWF.name.cn(t.applicant));var o=Date.parse(t.startTime).format("%Y-%m-%d- %H:%M");s=(s=(s=s.replace(/{date}/g,o)).replace(/{subject}/g,t.subject)).replace(/{addr}/g,t.roomName+"("+t.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingInviteMessage,content:s},n=layout.desktop.message.addMessage(a,e.body?e.body.startTime:"");layout.desktop.message.addTooltip(a,e.body?e.body.startTime:"").contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)})),n.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)}))}.bind(this))},receiveMeetingCancelMessage:function(e){this.getMeeting(e,function(t){var s=MWF.LP.desktop.messsage.meetingCancel;s=s.replace(/{person}/g,MWF.name.cn(t.applicant));var o=Date.parse(t.startTime).format("%Y-%m-%d- %H:%M");s=(s=(s=s.replace(/{date}/g,o)).replace(/{subject}/g,t.subject)).replace(/{addr}/g,t.roomName+"("+t.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingCancelMessage,content:s},n=layout.desktop.message.addMessage(a,e.body?e.body.startTime:"");layout.desktop.message.addTooltip(a,e.body?e.body.startTime:"").contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)})),n.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)}))}.bind(this))},receiveMeetingAcceptMessage:function(e){this.getMeeting(e,function(t){var s=MWF.LP.desktop.messsage.meetingAccept;s=s.replace(/{person}/g,MWF.name.cn(e.person));var o=Date.parse(t.startTime).format("%Y-%m-%d- %H:%M");s=(s=(s=s.replace(/{date}/g,o)).replace(/{subject}/g,t.subject)).replace(/{addr}/g,t.roomName+"("+t.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingAcceptMessage,content:s},n=layout.desktop.message.addMessage(a,e.body?e.body.startTime:"");layout.desktop.message.addTooltip(a,e.body?e.body.startTime:"").contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)})),n.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)}))}.bind(this))},receiveMeetingRejectMessage:function(e){this.getMeeting(e,function(t){var s=MWF.LP.desktop.messsage.meetingReject;s=s.replace(/{person}/g,MWF.name.cn(e.person));var o=Date.parse(t.startTime).format("%Y-%m-%d- %H:%M");s=(s=(s=s.replace(/{date}/g,o)).replace(/{subject}/g,t.subject)).replace(/{addr}/g,t.roomName+"("+t.buildingName+")");var a={subject:MWF.LP.desktop.messsage.meetingRejectMessage,content:s},n=layout.desktop.message.addMessage(a,e.body?e.body.startTime:"");layout.desktop.message.addTooltip(a,e.body?e.body.startTime:"").contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)})),n.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Meeting",null)}))}.bind(this))},receiveAttendanceAppealInviteMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealInvite;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealInviteMessage,content:t},o=layout.desktop.message.addMessage(s);layout.desktop.message.addTooltip(s).contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"13"})})),o.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"13"})}))},receiveAttendanceAppealAcceptMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealAccept;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealAcceptMessage,content:t},o=layout.desktop.message.addMessage(s);layout.desktop.message.addTooltip(s).contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})})),o.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})}))},receiveAttendanceAppealRejectMessage:function(e){var t=MWF.LP.desktop.messsage.attendanceAppealReject;t=t.replace(/{subject}/g,e.subject);var s={subject:MWF.LP.desktop.messsage.attendanceAppealRejectMessage,content:t},o=layout.desktop.message.addMessage(s);layout.desktop.message.addTooltip(s).contentNode.addEvent("click",(function(e){layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})})),o.contentNode.addEvent("click",(function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.openApplication(e,"Attendance",{curNaviId:"12"})}))},receiveCalendarAlarmMessage:function(e){var t=MWF.LP.desktop.messsage.canlendarAlarm;t=t.replace(/{title}/g,e.title);var s={subject:MWF.LP.desktop.messsage.canlendarAlarmMessage,content:t},o=layout.desktop.message.addMessage(s);layout.desktop.message.addTooltip(s).contentNode.addEvent("click",(function(t){layout.desktop.message.hide(),layout.desktop.apps&&layout.desktop.apps.Calendar?layout.desktop.apps.Calendar.openEvent?(layout.desktop.apps.Calendar.setCurrent(),layout.desktop.apps.Calendar.openEvent(e.body.id)):layout.desktop.apps.Calendar.options?(layout.desktop.apps.Calendar.options.eventId=e.body.id,layout.desktop.apps.Calendar.setCurrent()):layout.desktop.openApplication(t,"Calendar",{eventId:e.body.id}):layout.desktop.openApplication(t,"Calendar",{eventId:e.body.id})})),o.contentNode.addEvent("click",(function(t){layout.desktop.message.addUnread(-1),layout.desktop.message.hide(),layout.desktop.apps&&layout.desktop.apps.Calendar?layout.desktop.apps.Calendar.openEvent?(layout.desktop.apps.Calendar.setCurrent(),layout.desktop.apps.Calendar.openEvent(e.body.id)):layout.desktop.apps.Calendar.options?(layout.desktop.apps.Calendar.options.eventId=e.body.id,layout.desktop.apps.Calendar.setCurrent()):layout.desktop.openApplication(t,"Calendar",{eventId:e.body.id}):layout.desktop.openApplication(t,"Calendar",{eventId:e.body.id})}))},receiveTeamWorkMessage:function(e){var t=e.body,s=e.title,o={subject:t.name,content:s},a=layout.desktop.message.addMessage(o);layout.desktop.message.addTooltip(o).contentNode.addEvent("click",function(e){layout.desktop.message.hide();var s={taskId:t.id,projectId:t.project};layout.desktop.openApplication(e,"TeamWork.Task",s)}.bind(this)),a.contentNode.addEvent("click",function(e){layout.desktop.message.addUnread(-1),layout.desktop.message.hide();var s={taskId:t.id,projectId:t.project};layout.desktop.openApplication(e,"TeamWork.Task",s)}.bind(this))}});