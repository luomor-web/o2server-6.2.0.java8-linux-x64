MWF.xDesktop.Actions=MWF.xDesktop.Actions||{},MWF.xDesktop.Actions.RestActions=new Class({Implements:[Events],initialize:function(e,t,s){this.actionPath=e,this.serviceName=t,this.root=s},listApplicationAddress:function(e,t){var s=this.actions.listAddress;s=this.actions.slotHost+s;var a=new MWF.xApplication.Common.Actions.RestActions.Callback(e,t);MWF.getJSON(s,a)},getAddress:function(e,t){var s=layout.serviceAddressList[this.serviceName];if(s)this.address=layout.config.app_protocol+"//"+(s.host||window.location.hostname)+(80==s.port?"":":"+s.port)+s.context;else{var a=layout.desktop.centerServer.host||window.location.hostname,o=layout.desktop.centerServer.port;this.address=layout.config.app_protocol+"//"+a+("80"==o?"":":"+o)+"/x_program_center"}return e&&e.apply(),this.address},getActions:function(e){if(this.actions)e&&e();else{var t=this.root?"/"+this.root+this.actionPath:MWF.defaultPath+this.actionPath;MWF.getJSON(t,function(t){this.actions=t,e&&e()}.bind(this),!1,!1,!1)}},invokeUri:function(e){this.address||this.getAddress();var t=this.address+e.uri,s=!1!==e.async,a=e.method||"GET",o=new MWF.xDesktop.Actions.RestActions.Callback(e.success,e.failure),i=e.data?JSON.encode(e.data):"",n=!0;!1===e.withCredentials&&(n=!1),MWF.restful(a,t,i,o,s,n)},invoke:function(e){if(window.importScripts&&window.isCompletionEnvironment)return null;this.address||this.getAddress();var t=null;return this.getActions(function(){var s=this.actions[e.name],a=s.method||"GET",o=s.uri,i=s.progress;if(e.parameter&&Object.each(e.parameter,(function(t,s){var a=new RegExp("{"+s+"}","g");o=!1===e.urlEncode?o.replace(a,t):o.replace(a,encodeURI(t))})),o=this.address+o,layout.config.mock&&layout.config.mock[this.serviceName]){var n=layout.config.mock[this.serviceName][a.toLowerCase()];if(n){a=n.to||a;var r=n.append;o+="/"==o.substr(o.length-1,1)?r:"/"+r}}var d=!1!==e.async,l=new MWF.xDesktop.Actions.RestActions.Callback(e.success,e.failure);if(s.enctype&&"formdata"==s.enctype.toLowerCase())t=this.invokeFormData(a,o,e.data,e.file,l,d,i);else{var c=e.data?JSON.encode(e.data):"",u=!0;!1===e.withCredentials&&(u=!1),t=MWF.restful(a,o,c,l,d,u,e.cache)}}.bind(this)),t},formDataUpdateProgress:function(){},invokeFormDataWithProgress:function(e,t,s,a,o,i,n,r){var d=null,l=new Date;e.upload.addEventListener("progress",function(t){this.updateProgress(t,e,d,l)}.bind(this),!1),e.upload.addEventListener("load",function(t){o&&this.transferComplete(t,e,d,l,o)}.bind(this),!1),e.upload.addEventListener("loadstart",function(t){this.transferStart(t,e,d)}.bind(this),!1),e.upload.addEventListener("error",function(t){this.transferFailed(t,e,d)}.bind(this),!1),e.upload.addEventListener("abort",function(t){this.transferCanceled(t,e,d)}.bind(this),!1),e.upload.addEventListener("timeout",function(t){this.transferCanceled(t,e,d)}.bind(this),!1),e.addEventListener("readystatechange",function(t){this.xhrStateChange(t,e,d,i)}.bind(this),!1),e.open(t,s,!1!==n),e.withCredentials=!0,o&&File.prototype.isPrototypeOf(o)&&(d=this.addFormDataMessage(o,!1,e,r)),e.send(a)},setMessageText:function(e,t){if(e&&e.message){e.contentNode.getFirst("div").getFirst("div").getFirst("div");e.contentNode.getFirst("div").getLast("div").set("text",t),e.dateNode.set("text",(new Date).format("db"))}e&&e.moduleMessage&&e.moduleMessage.setMessageText&&e.moduleMessage.setMessageText()},setMessageTitle:function(e,t){e&&e.message&&e.subjectNode.set("text",t),e&&e.moduleMessage&&e.moduleMessage.setMessageTitle&&e.moduleMessage.setMessageTitle()},clearMessageProgress:function(e){e&&e.message&&e.contentNode.getFirst("div").getFirst("div").destroy();e&&e.moduleMessage&&e.moduleMessage.clearMessageProgress&&e.moduleMessage.clearMessageProgress()},transferStart:function(e,t,s){s&&s.message&&(this.setMessageText(s,MWF.LP.desktop.action.sendStart),s.status="progress"),s&&s.moduleMessage&&s.moduleMessage.transferStart&&s.moduleMessage.transferStart(),this.fireEvent("loadstart")},transferFailed:function(e,t,s){s&&s.message&&(this.setMessageText(s,MWF.LP.desktop.action.sendError),this.setMessageTitle(s,MWF.LP.desktop.action.sendError),this.clearMessageProgress(s),s.status="failed"),s&&s.moduleMessage&&s.moduleMessage.transferFailed&&s.moduleMessage.transferFailed(),this.fireEvent("error")},transferCanceled:function(e,t,s){s&&s.message&&(this.setMessageText(s,MWF.LP.desktop.action.sendAbort),this.setMessageTitle(s,MWF.LP.desktop.action.sendAbort),this.clearMessageProgress(s),s.status="cancel"),s&&s.moduleMessage&&s.moduleMessage.transferCanceled&&s.moduleMessage.transferCanceled(),this.fireEvent("abort")},transferComplete:function(e,t,s,a,o){var i=(new Date).getTime()-a.getTime(),n=o.size/i,r="K/S";n>1024&&(r="M/S",n/=1024),n>1024&&(r="G/S",n/=1024),n=n.round(2);var d="";if(i>36e5){var l=i%36e5,c=l/6e4,u=l%6e4/1e3;d=""+(i/36e5).toInt()+MWF.LP.desktop.action.hour+c.toInt()+MWF.LP.desktop.action.minute+u.toInt()+MWF.LP.desktop.action.second}else if(i>6e4){u=i%6e4/1e3;d=""+(c=i/6e4).toInt()+MWF.LP.desktop.action.minute+u.toInt()+MWF.LP.desktop.action.second}else{d=""+(u=i/1e3).toInt()+MWF.LP.desktop.action.second}s&&s.message&&(this.setMessageText(s,MWF.LP.desktop.action.uploadComplete+"  "+MWF.LP.desktop.action.speed+": "+n+r+"  "+MWF.LP.desktop.action.time+": "+d,MWF.LP.desktop.action.uploadComplete),this.setMessageTitle(s,MWF.LP.desktop.action.uploadComplete),this.clearMessageProgress(s),s.status="completed"),s&&s.moduleMessage&&s.moduleMessage.transferComplete&&s.moduleMessage.transferComplete(),this.fireEvent("load")},updateProgress:function(e,t,s,a){var o=e.loaded/e.total*100,i=(new Date).getTime()-a.getTime(),n=e.loaded/i,r="K/S";if(n>1024&&(r="M/S",n/=1024),n>1024&&(r="G/S",n/=1024),n=n.round(2),s&&s.message&&s.contentNode){var d=s.contentNode.getFirst("div").getFirst("div").getFirst("div"),l=s.contentNode.getFirst("div").getLast("div");d.setStyle("width",o+"%"),l.set("text",MWF.LP.desktop.action.sendStart+": "+n+r)}s&&s.moduleMessage&&s.moduleMessage.updateProgress&&s.moduleMessage.updateProgress(o),this.fireEvent("progress")},xhrStateChange:function(e,t,s,a){if(4==t.readyState){var o=t.status;if((o=1223==o?204:o)>=200&&o<300){var i=JSON.decode(t.responseText);if(i)switch(i.type){case"success":var n="";"array"==(r=typeOf(i.data))&&(n=i.data[0].id),"object"==r&&(n=i.data.id),MWF.runCallback(a,"success",[{type:"success",id:n,messageId:s&&s.moduleMessage?s.moduleMessage.data.id:"",data:i.data},t.responseText]);break;case"warn":MWF.xDesktop.notice("info",{x:"right",y:"top"},i.errorMessage.join("\n"));var r;n="";"array"==(r=typeOf(i.data))&&(n=i.data[0].id),"object"==r&&(n=i.data.id),MWF.runCallback(a,"success",[{type:"success",id:n},t.responseText]);break;case"error":(d=s&&s.moduleMessage?s.moduleMessage.data.id:"")&&t&&(t.messageId=d),MWF.runCallback(a,"failure",[t])}else(d=s&&s.moduleMessage?s.moduleMessage.data.id:"")&&t&&(t.messageId=d),MWF.runCallback(a,"failure",[t])}else{var d;(d=s&&s.moduleMessage?s.moduleMessage.data.id:"")&&t&&(t.messageId=d),MWF.runCallback(a,"failure",[t])}}},invokeFormDataWithoutProgress:function(e,t,s,a,o,i,n,r){var d=null,l=new Date;e.addEventListener("readystatechange",function(t){4==e.readyState&&(o&&this.transferComplete(t,e,d,l,o),this.xhrStateChange(t,e,d,i))}.bind(this),!1),e.open(t,s,!0),e.withCredentials=!0,d=this.addFormDataMessage(o,!0,e,r),e.send(a),this.setMessageText(d,MWF.LP.desktop.action.sendStart)},invokeFormDataWithForm:function(e,t,s,a,o,i,n){MWF.O2UploadCallback=i,MWF.O2UploadCallbackFun=function(){MWF.O2UploadCallback&&MWF.O2UploadCallback()};var r=a.items[0].value.el.getParent();r.set("styles",{width:"500px",height:"300px","background-color":"#999999",position:"absolute",top:"100px",left:"100px","z-index":"30000",display:"block"}).inject(document.body);var d=new Element("form",{method:t,action:-1!=s.indexOf("?")?s+"&callback=MWF.O2UploadCallbackFun":s+"?callback=MWF.O2UploadCallbackFun",enctype:"multipart/form-data",target:"o2_upload_iframe"}).inject(r);new Element("iframe",{name:"o2_upload_iframe"}).inject(r);a.items.each(function(e){"string"==typeOf(e.value)?new Element("input",{name:e.name,value:e.value}).inject(d):(e.value.el.inject(d),e.value.el.set("name",e.name))}.bind(this));new Element("input",{type:"submit"}).inject(d)},invokeFormData:function(e,t,s,a,o,i,n){t=o2.filterUrl(t);var r=new COMMON.Browser.Request;return a&&s.append("fileName",a.name),"o2_formdata"===s.type?this.invokeFormDataWithForm(r,e,t,s,a,o,i):r.upload?this.invokeFormDataWithProgress(r,e,t,s,a,o,i,n):this.invokeFormDataWithoutProgress(r,e,t,s,a,o,i,n),r},addFormDataMessage:function(e,t,s,a){if(layout.desktop.message){var o="";o=t?'<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.sendReady+"</div></div>":'<div style="overflow: hidden"><div style="height: 3px; border:1px solid #999; margin: 3px 0px"><div style="height: 3px; background-color: #acdab9; width: 0px;"></div></div><div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.sendReady+"</div></div>";var i={subject:MWF.LP.desktop.action.uploadTitle,content:(e.name?e.name+"<br/>":"")+o},n=layout.desktop.message.addMessage(i);n.close=function(t,a){if("progress"==this.status){flag=!1;var o=MWF.LP.desktop.action.cancelUpload.replace(/{name}/g,e.name||"");MWF.xDesktop.confirm("wram",a,MWF.LP.desktop.action.cancelUploadTitle,o,"400","140",(function(){s.abort(),this.close()}),(function(){this.close()}))}else n.closeItem(t,a)}}if(this.targetModule){var r=this.targetModule.module.addFormDataMessage(this.targetModule.file);n||(n={}),n.moduleMessage=r,this.targetModule=null}return a&&window.setTimeout(function(){layout.desktop.message&&(layout.desktop.message.isShow||layout.desktop.message.show())}.bind(this),300),n},getAuthentication:function(e,t){this.invoke({name:"authentication",async:!0,success:function(s,a){"anonymous"!=s.data.tokenType?e&&e(s):t&&t(null,a,s.message)},failure:t})},login:function(e,t,s){this.invoke({name:"login",async:!0,data:e,success:function(e,a){"anonymous"!=e.data.tokenType?t&&t(e):s&&s(null,a,e.message)},failure:s})},logout:function(e,t){this.invoke({name:"logout",async:!1,success:e,failure:t})}}),MWF.xDesktop.Actions.RestActions.Callback=new Class({initialize:function(e,t,s,a){this.success=e,this.failure=t,this.appendSuccess=s,this.appendFailure=a},onSuccess:function(e,t){if(!e)return this.doError(null,t,"");switch(e.type){case"success":return this.appendSuccess&&this.appendSuccess(e),this.success?this.success(e,t):e;case"warn":return MWF.xDesktop.notice("info",{x:"right",y:"top"},e.errorMessage.join("\n")),this.appendSuccess&&this.appendSuccess(e),this.success?this.success(e):e;case"error":return this.doError(null,t,e.message)}},onRequestFailure:function(e){return this.doError(e,"","")},onFailure:function(e,t,s){return this.doError(e,t,s)},onError:function(e,t){return this.doError(null,e,t)},doError:function(e,t,s){if(this.appendFailure&&this.appendFailure(e,t,s),this.failure&&this.failure.owner){if(this.failure.reject||this.failure.rejectList&&this.failure.rejectList.length)return this.failure(e,t,s);this.failure=null}else if(this.failure)return this.failure(e,t,s);if(!this.failure&&!this.appendFailure&&0!=e.status){var a=s;if(e){var o=JSON.decode(e.responseText);a=o?o.message.trim()||"request json error":"request json error: "+e.responseText}a=(a=a.replace(/\</g,"&lt;")).replace(/\</g,"&gt;"),layout.session&&layout.session.user&&MWF.xDesktop.notice("error",{x:"right",y:"top"},a)}return Promise.reject(e)}});