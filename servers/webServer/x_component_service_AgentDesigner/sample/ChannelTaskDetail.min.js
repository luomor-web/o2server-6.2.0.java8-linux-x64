printLog("运行代理渠道任务明细下发文件"),load("nashorn:mozilla_compat.js");var File=Java.type("java.io.File"),Root_Dir="D:"+File.separator+"FTPFile"+File.separator+"ChannelTask"+File.separator+"Detail"+File.separator,Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator;function getSeq(e){var t=resources.getWebservicesClient().jaxrsGet("x_processplatform_assemble_surface","applicationdict/ChannelTaskDetail_Seq/application/channelTaskProcess/seq/data"),r=(t=getPureText(t.toString())).split("-"),a=0;r.length>1&&r[0]===e&&(a=parseInt(r[1]));var i="0000"+ ++a;return i=i.substr(i.length-4,4),resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","applicationdict/ChannelTaskDetail_Seq/application/channelTaskProcess/seq/data",e+"-"+i),i}function createRecordFloder(){var e=new(Java.type("java.util.Date")),t=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(e)+File.separator+new java.text.SimpleDateFormat("MM").format(e)+File.separator+new java.text.SimpleDateFormat("dd").format(e)+File.separator+"Detail",r=new File(t);return r.exists()||r.mkdirs()?r:(print("创建记录文件夹失败："+t),null)}function createFile(){var e=new(Java.type("java.util.Date")),t=new java.text.SimpleDateFormat("yyyyMMdd").format(e),r=getSeq(t),a=Root_Dir+t+"_ChannelTaskDetail_"+(r||"0001")+".REQ";print("path="+a);var i=new File(a);return i.exists()&&i.delete(),i.createNewFile()?(printLog("创建文件:"+a),i):(printLog("不能创建文件:"+a),null)}function printLog(e){print(e)}function setWorkFlag(e,t){printLog("设置标志位"),""===t?resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus","detailNone"):(resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus","detailDone"),resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/File_Name",t))}function getWorkData(){return resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify({filterList:[{logic:"and",path:"interfaceStatus",title:"接口状态",comparison:"equals",comparisonTitle:"等于",value:"wait",formatType:"textValue"}]})).getAsJsonObject().get("grid")}function getNumberData(e,t){var r={filterList:[{logic:"and",path:"workId",title:"workId",comparison:"equals",comparisonTitle:"等于",value:e,formatType:"textValue"},{logic:"and",path:"branch",title:"branch",comparison:"equals",comparisonTitle:"等于",value:t,formatType:"textValue"}]};return resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface",encodeURI("view/flag/byPhoneNumber/query/channelTask/execute"),JSON.stringify(r)).get("grid").getAsJsonArray()}function isEmpty(e){if(null===e)return!0;var t=e.trim();return'""'===t||(!!t.equals('""')||(""===t||!!t.equals("")))}function getPureText(e){return null===e||('"'===e.substr(0,1)&&(e=e.substr(1,e.length-1)),'"'===e.substr(e.length-1,1)&&(e=e.substr(0,e.length-1))),e}function ouputNumberList(e,t,r,a){var i=createFile();if(null===i)return null;printLog("输出数据");var n=new java.io.PrintWriter(i,"GBK");n.print(a||e.size()),n.write(13),n.write(10),n.write(13),n.write(10);for(var o=e.iterator();o.hasNext();){var s=getPureText(o.next().get("data").get("subject").toString());n.print(s),n.print("|"),n.print(t),n.print("|"),n.print(r),n.write(13),n.write(10)}return n.close(),i}function init(){var e=Java.type("org.apache.commons.io.FileUtils"),t=getWorkData();if(print("workList="+t),t.size()>0)var r=createRecordFloder();for(var a=t.iterator();a.hasNext();){var i=a.next().get("data"),n=i.get("currentUnit").toString(),o=i.get("provinceWorkId").toString();isEmpty(o)&&(o=i.get("cityWorkId").toString()),isEmpty(o)&&(o=i.get("countyWorkId").toString()),isEmpty(o)&&(o=i.get("branchWorkId").toString());var s=i.get("branchWorkId").toString(),l=i.get("numberCount").toString(),c=i.get("workCompletedId").toString();c=getPureText(c),print("workId="+o),print("branch="+n);var u=null;if(!isEmpty(o)&&!isEmpty(n)){o=getPureText(o),n=getPureText(n),s=getPureText(s),l=getPureText(l);var p=getNumberData(o,n);p.size()>0?u=ouputNumberList(p,o,s,l):print("根据workId="+o+",branch="+n+"未找到号码！")}if(c&&""!==c&&null!==u){if(setWorkFlag(c,u.getName()),null!==r)try{e.copyFileToDirectory(u,r),print("明细文件拷贝到记录文件夹成功："+r.getCanonicalPath())}catch(e){e.printStackTrace(),print("明细文件拷贝到记录文件夹出错："+r.getCanonicalPath()+" 错误："+e.getMessage())}print("根据workId="+o+",branch="+n+"下发明细文件成功！")}}}init();