print("运行渠道任务工单任务同步实时接口");var File=Java.type("java.io.File"),Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator,recordFile=null,workcompletedid="",pw=null;function createRecordFile(){var e=new(Java.type("java.util.Date")),t=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(e)+File.separator+new java.text.SimpleDateFormat("MM").format(e)+File.separator+new java.text.SimpleDateFormat("dd").format(e)+File.separator+"Add",r=new File(t);if(r.exists()||r.mkdirs()||(print("创建记录文件夹失败："+t),r=null),null!==r){var a=t+File.separator+workcompletedid+".txt";(recordFile=new File(a)).exists()&&recordFile.delete(),recordFile.createNewFile()?print("创建记录文件:"+a):(print("不能记录文件:"+a),recordFile=null)}}function printRecorder(e){print(e),null==recordFile&&createRecordFile(),null!=recordFile&&(null==pw&&(pw=new java.io.PrintWriter(recordFile,"GBK")),pw.print(e),pw.write(13),pw.write(10))}function getPureText(e){return null===e||('"'===e.substr(0,1)&&(e=e.substr(1,e.length-1)),'"'===e.substr(e.length-1,1)&&(e=e.substr(0,e.length-1))),e}function getWorkCompleteIds(){var e=new(Java.type("java.util.ArrayList")),t=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify({filterList:[{logic:"and",path:"interfaceStatus",title:"接口状态",comparison:"equals",comparisonTitle:"等于",value:"detailDone",formatType:"textValue"}]})).getAsJsonObject().get("grid");if(t)for(var r=t.getAsJsonArray().iterator();r.hasNext();){var a=r.next();if(a&&null!=a){var n=a.get("data");if(n&&null!=n){var o=n.get("workCompletedId");o&&null!=o&&(o=getPureText(o.toString()),e.add(o))}}}return e}function getIdo(){for(var e=new(Java.type("java.util.Random")),t="",r=0;r<14;r++)t+=e.nextInt(10);return t}function getXml(e){var t=new(Java.type("java.util.Date")),r=new java.text.SimpleDateFormat("yyyyMMddHHmmss").format(t),a='<?xml version="1.0" encoding="UTF-8"?>';return a+="<xml>",a+="<head>",a+="<sign>",a+="<service_name>addChannelTask</service_name>",a+="<Trans_ido>"+getIdo()+"</Trans_ido>",a+="</sign>",a+="</head>",a+="<body>",a+="<msg>",a+="<Task_id>"+(e.provinceWorkId||e.cityWorkId||e.countyWorkId||e.branchWorkId)+"</Task_id>",a+="<Sub_task_id>"+e.branchWorkId+"</Sub_task_id>",a+="<Task_name>"+e.subject+"</Task_name>",a+="<Region_code>"+e.cityBSSId+"</Region_code>",a+="<Group_id>"+e.branchBSSId+"</Group_id>",a+="<Task_type>"+e.taskType+"</Task_type>",a+="<Task_target></Task_target>",a+="<Task_dev_num>"+e.numberCount+"</Task_dev_num>",a+="<prize>"+(e.reward_branch||e.reward_county||e.reward_city||e.reward)+"</prize>",a+="<File_Name>"+e.File_Name+"</File_Name>",a+="<Eff_date>"+e.taskStartDate.replace(/-/g,"")+"000000</Eff_date>",a+="<Exp_date>"+e.taskEndDate.replace(/-/g,"")+"235959</Exp_date>",a+="<Send_time>"+r+"</Send_time>",a+="</msg>",a+="</body>",printRecorder("请求xml="+(a+="</xml>")),a}function sendData(e){var t=new(Java.type("java.util.ArrayList")),r=new(Java.type("com.x.base.core.project.bean.NameValuePair"))("Content-Type","text/xml; charset=utf-8");return t.add(r),Java.type("com.x.base.core.project.connection.HttpConnection").postAsString("http://130.30.6.38:12007/adapter",t,e)}function getText(e,t){var r=e.getElementsByTagName(t);if(null==r)return null;var a=r.item(0);return null==a?null:a.getTextContent()}function setWorkFlag(e,t){"0000"===t.Response_code?resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus","syncDone"):resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus2","syncError"),t.Response_desc&&resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceResponseDesc",t.Response_desc),printRecorder("workCompletedId为"+e+"的工单设置标志位成功")}function parseResp(e){var t=Java.type("javax.xml.parsers.DocumentBuilderFactory"),r=Java.type("java.io.StringReader"),a=Java.type("org.xml.sax.InputSource"),n=t.newInstance().newDocumentBuilder(),o=new a(new r(e)),s=n.parse(o).getDocumentElement(),i=getText(s,"Response_code"),l=getText(s,"Response_desc");return printRecorder("Response_code="+i),printRecorder("Response_desc="+l),{Response_code:i,Response_desc:l}}function init(){var e=getWorkCompleteIds();print("idList="+e),0===e.size()&&print("未找到需要同步的工单");for(var t=0;t<e.size();t++)try{var r=e.get(t);workcompletedid=r,printRecorder("处理工单，workCompletedId="+r);var a=resources.getWebservicesClient().jaxrsGet("x_processplatform_assemble_surface","data/workcompleted/"+r),n=sendData(getXml(JSON.parse(a.toString())));printRecorder("BSS端返回 "+n),setWorkFlag(r,parseResp(n)),printRecorder("workCompletedId为"+r+"的工单同步结束"),printRecorder("文件URL：../x_desktop/work.html?workcompletedid="+r),null!==pw&&(pw.close(),pw=null),null!=recordFile&&(recordFile=null)}catch(e){e.printStackTrace()}}init();