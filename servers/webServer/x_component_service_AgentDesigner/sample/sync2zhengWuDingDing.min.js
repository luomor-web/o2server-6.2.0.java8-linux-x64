var type="zhengwuDingdingMessage",resp=resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/list/"+type+"/count/100"),messages=resp.getDataAsList(com.x.message.core.entity.Message.class);for(var i in messages){var message=messages[i];switch(message.getType()){case"task_create":if(com.x.base.core.project.config.Config.zhengwuDingding().getTaskToMessage()){var person=resources.getOrganization().person().getObject(message.getPerson());if(body=JSON.parse(message.getBody()))if(person)if(person.getZhengwuDingdingId()){var txt="您有新的待办需要处理:"+body.title+".";send("184707353",person.getZhengwuDingdingId(),txt),print("发送政务钉钉待办消息,通知对象: "+message.getPerson()+"("+person.getZhengwuDingdingId()+"), 消息:"+txt+".")}else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 无法获取政务钉钉id.");else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 不存在.");else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 无法获取消息对象.")}break;case"taskCompleted_create":if(com.x.base.core.project.config.Config.zhengwuDingding().getTaskCompletedToMessage()){person=resources.getOrganization().person().getObject(message.getPerson());if(body=JSON.parse(message.getBody()))if(person)if(person.getZhengwuDingdingId()){txt="您的待办已经处理完成:"+body.title+".";send("184707353",person.getZhengwuDingdingId(),txt),print("发送政务钉钉已办消息,通知对象: "+message.getPerson()+"("+person.getZhengwuDingdingId()+"), 消息:"+txt+".")}else print("发送政务钉钉已办消息失败,通知对象"+message.getPerson()+" 无法获取政务钉钉id.");else print("发送政务钉钉已办消息失败,通知对象"+message.getPerson()+" 不存在.");else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 无法获取消息对象.")}break;case"read_create":if(com.x.base.core.project.config.Config.zhengwuDingding().getReadToMessage()){person=resources.getOrganization().person().getObject(message.getPerson());if(body=JSON.parse(message.getBody()))if(person)if(person.getZhengwuDingdingId()){txt="您有新的待阅需要处理:"+body.title+".";send("184707353",person.getZhengwuDingdingId(),txt),print("发送政务钉钉待阅消息,通知对象: "+message.getPerson()+"("+person.getZhengwuDingdingId()+"), 消息:"+txt+".")}else print("发送政务钉钉待阅消息失败,通知对象"+message.getPerson()+" 无法获取政务钉钉id.");else print("发送政务钉钉待阅消息失败,通知对象"+message.getPerson()+" 不存在.");else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 无法获取消息对象.")}break;case"readCompleted_create":if(com.x.base.core.project.config.Config.zhengwuDingding().getReadCompletedToMessage()){var body;person=resources.getOrganization().person().getObject(message.getPerson());if(body=JSON.parse(message.getBody()))if(person)if(person.getZhengwuDingdingId()){txt="您的待阅已经处理完成:"+body.title+".";send("184707353",person.getZhengwuDingdingId(),txt),print("发送政务钉钉已阅消息,通知对象: "+message.getPerson()+"("+person.getZhengwuDingdingId()+"), 消息:"+txt+".")}else print("发送政务钉钉已阅消息失败,通知对象"+message.getPerson()+" 无法获取政务钉钉id.");else print("发送政务钉钉已阅消息失败,通知对象"+message.getPerson()+" 不存在.");else print("发送政务钉钉待办消息失败,通知对象"+message.getPerson()+" 无法获取消息对象.")}break;default:system.print("未知的消息类型: "+message.getType()+" , title: "+message.getTitle()+".")}consume(message.getId(),type)}function send(e,s,t){var g='{"agentId":"agentId","touser":"touser","toparty": "","msgtype":"text","context":"'+t+'"}',n=com.x.base.core.project.config.Config.zhengwuDingding().getOapiAddress()+"/ent_message/send?access_token="+com.x.base.core.project.config.Config.zhengwuDingding().appAccessToken();com.x.base.core.project.connection.HttpConnection.postAsString(n,null,g)}function consume(e,s){resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/"+e+"/type/"+s)}