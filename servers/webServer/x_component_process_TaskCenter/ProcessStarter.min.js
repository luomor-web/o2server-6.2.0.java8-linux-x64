MWF.require("MWF.widget.Mask",null,!1),MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.TaskCenter=MWF.xApplication.process.TaskCenter||{},MWF.xDesktop.requireApp("process.TaskCenter","lp."+o2.language,null,!1),MWF.xApplication.process.TaskCenter.ProcessStarter=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",workData:null,identity:null,latest:!1},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_process_TaskCenter/$ProcessStarter/",this.cssPath="../x_component_process_TaskCenter/$ProcessStarter/"+this.options.style+"/css.wcss",this._loadCss(),MWF.xDesktop.requireApp("process.TaskCenter","$ProcessStarter."+MWF.language,null,!1),this.lp=MWF.xApplication.process.TaskCenter.ProcessStarter.lp,this.data=t,this.app=e},load:function(){this.getOrgAction(function(){this.app.desktop.session.user.distinguishedName&&this.orgAction.getPerson(function(t){if(this.identitys=t.data.woIdentityList||[],this.identitys.length){if(this.options.identity&&(this.identitys=this.identitys.filter(function(t){var e="string"===typeOf(this.options.identity)?this.options.identity:this.options.identity.distinguishedName;return t.distinguishedName===e}.bind(this))),this.identitys.length)if(1==this.identitys.length){var e={title:this.data.name+"-"+this.lp.unnamed,identity:this.identitys[0].distinguishedName,latest:this.options.latest};this.options.workData&&(e.data=this.options.workData,(e.data.title||e.data.subject)&&(e.title=e.data.title||e.data.subject)),this.mask=new MWF.widget.Mask({style:"desktop"}),this.mask.loadNode(this.app.content),this.getWorkAction(function(){this.workAction.startWork(function(t){this.mask.hide(),this.fireEvent("started",[t.data,e.title,this.data.name]),this.app.refreshAll&&this.app.refreshAll()}.bind(this),null,this.data.id,e)}.bind(this))}else this.createMarkNode(),this.createAreaNode(),this.createStartNode(),this.areaNode.inject(this.markNode,"after"),this.areaNode.fade("in"),this.setStartNodeSize(),this.setStartNodeSizeFun=this.setStartNodeSize.bind(this),this.app.addEvent("resize",this.setStartNodeSizeFun),this.fireEvent("selectId")}else{var i=this.lp.noIdentitys.replace("{name}",this.app.desktop.session.user.name);this.app.notice(i,"error")}}.bind(this),null,this.app.desktop.session.user.distinguishedName)}.bind(this))},createMarkNode:function(){this.markNode=new Element("div#mark",{styles:this.css.markNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.app.content)},createAreaNode:function(){this.areaNode=new Element("div#area",{styles:this.css.areaNode})},createStartNode:function(){this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.areaNode),this.createNewNode=new Element("div",{styles:this.css.createNewNode}).inject(this.createNode),this.createCloseNode=new Element("div",{styles:this.css.createCloseNode}).inject(this.createNode),this.createCloseNode.addEvent("click",function(t){this.cancelStartProcess(t)}.bind(this)),this.formNode=new Element("div",{styles:this.css.formNode}).inject(this.createNode);var t='<table width="100%" height="90%" border="0" cellPadding="0" cellSpacing="0"><tr><td colSpan="2" style="height: 50px; line-height: 50px; text-align: center; font-size: 24px; font-weight: bold">'+this.lp.start+" - "+this.data.name+'</td></tr><tr><td colSpan="2" style="height: 40px; color: #0044cc; line-height: 40px; text-align: center; font-size: 18px; font-weight: bold">'+this.lp.selectStartIdentity+'</td></tr><tr><td colSpan="2" id="form_startIdentity"></td></tr></table>';this.formNode.set("html",t),this.identityArea=this.formNode.getElementById("form_startIdentity");var e=this;this.identitys.each(function(t){var i=new MWF.xApplication.process.TaskCenter.ProcessStarter.Identity(this.identityArea,t,this,this.css);i.node.store("identity",i),i.node.addEvents({mouseover:function(){this.setStyles(e.css.identityNode_over),this.getFirst().getLast().setStyles(e.css.identityInforNameTextNode_over),this.getFirst().getNext().getFirst().setStyles(e.css.identityTitleNode_over),this.getFirst().getNext().getNext().getFirst().setStyles(e.css.identityTitleNode_over)},mouseout:function(){this.setStyles(layout.mobile?e.css.identityNode_mobile:e.css.identityNode),this.getFirst().getLast().setStyles(e.css.identityInforNameTextNode),this.getFirst().getNext().getFirst().setStyles(e.css.identityTitleNode),this.getFirst().getNext().getNext().getFirst().setStyles(e.css.identityTitleNode)},click:function(){var t=this.retrieve("identity");t&&e.okStartProcess(t.data.distinguishedName)}})}.bind(this)),layout.mobile&&(this.areaNode.setStyles(this.css.areaNode_mobile),this.createNode.setStyles(this.css.createNode_mobile))},getOrgAction:function(t){this.orgAction||(this.orgAction=MWF.Actions.get("x_organization_assemble_control")),t&&t()},setStartNodeSize:function(){if(!layout.mobile){var t=this.app.content.getSize(),e=this.app.content.getSize();this.markNode.setStyles({width:e.x+"px",height:e.y+"px"}),this.areaNode.setStyles({width:t.x+"px",height:t.y+"px"});var i=.7*t.y,s=.3*t.y/2;this.createNode.setStyles({height:i+"px","margin-top":s+"px"});var n=this.identitys.length;n>2&&(n=2);var o=294*n;this.formNode.setStyles({width:o+"px"}),o+=60,this.createNode.setStyles({width:o+"px"})}},cancelStartProcess:function(t){this.markNode.destroy(),this.areaNode.destroy()},okStartProcess:function(t){var e={title:this.data.name+"-"+this.lp.unnamed,identity:t};this.options.workData&&(e.data=this.options.workData),e.identity?(this.mask=new MWF.widget.Mask({style:"desktop"}),this.mask.loadNode(this.areaNode),this.getWorkAction(function(){this.workAction.startWork(function(t){this.mask.hide(),this.markNode.destroy(),this.areaNode.destroy(),this.fireEvent("started",[t.data,e.title,this.data.name]),this.app&&this.app.refreshAll&&this.app.refreshAll()}.bind(this),null,this.data.id,e)}.bind(this))):(this.departmentSelArea.setStyle("border-color","red"),this.app&&this.app.notice&&this.app.notice(this.lp.selectStartId,"error"))},getWorkAction:function(t){this.workAction||(this.workAction=MWF.Actions.get("x_processplatform_assemble_surface")),t&&t()}}),MWF.xApplication.process.TaskCenter.ProcessStarter.Identity=new Class({initialize:function(t,e,i,s){this.container=$(t),this.data=e,this.starter=i,this.action=this.starter.orgAction,this.style=s,this.load()},load:function(){this.node=new Element("div",{styles:layout.mobile?this.style.identityNode_mobile:this.style.identityNode}).inject(this.container);var t=new Element("div",{styles:this.style.identityInforNameNode}).inject(this.node),e="<img width='50' height='50' border='0' src='"+this.action.getPersonIcon(this.starter.app.desktop.session.user.id)+"'></img>",i=(new Element("div",{styles:this.style.identityInforPicNode,html:e}).inject(t),new Element("div",{styles:this.style.identityInforNameTextNode,text:this.data.name}).inject(t),new Element("div",{styles:this.style.identityDepartmentNode}).inject(this.node));new Element("div",{styles:this.style.identityTitleNode,text:MWF.xApplication.process.TaskCenter.LP.unit}).inject(i);this.unitTextNode=new Element("div",{styles:this.style.identityTextNode}).inject(i),this.data.woUnit&&this.unitTextNode.set({text:this.data.woUnit.levelName,title:this.data.woUnit.levelName});var s=new Element("div",{styles:this.style.identityDutyNode}).inject(this.node);new Element("div",{styles:this.style.identityTitleNode,text:MWF.xApplication.process.TaskCenter.LP.duty}).inject(s);this.dutyTextNode=new Element("div",{styles:this.style.identityTextNode}).inject(s);var n=[],o=[];this.data.woUnitDutyList.each(function(t){n.push(t.name),t.woUnit&&o.push(t.name+"("+t.woUnit.levelName+")")}.bind(this)),this.dutyTextNode.set({text:n.join(", "),title:o.join(", ")})}});