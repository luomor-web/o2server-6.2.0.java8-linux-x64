MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,!1),MWF.xApplication.cms.ColumnManager.ViewExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{style:"default",create:MWF.CMSCM.LP.view.create,search:MWF.CMSCM.LP.view.search,searchText:MWF.CMSCM.LP.view.searchText,noElement:MWF.CMSCM.LP.view.noViewNoticeText},_createElement:function(e){var t=this;this.loadSelectFormDialog((function(e,i){layout.desktop.getFormDesignerStyle(function(){var s={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.actions=t.app.restActions,this.column=t.app.options.column,this.application=t.app.options.column,this.relativeForm=i},onPostSave:function(){t.reload()}};layout.desktop.openApplication(e,"cms.ViewDesigner",s)}.bind(this))}))},loadSelectFormDialog:function(e,t,i){var s=new Element("div",{styles:this.css.selectFormMaskNode}).inject(this.app.content),n=new Element("div",{styles:this.css.selectFormTemplateAreaNode}).inject(this.app.content);n.fade("in");new Element("div",{styles:this.css.createTemplateFormTitleNode,text:t||this.app.lp.view.selectRelativeForm}).inject(n);var o=new Element("div",{styles:this.css.selectFormScrollNode}).inject(n),a=new Element("div",{styles:this.css.selectFormContentNode}).inject(o);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(o,{indent:!1})}.bind(this));var p=this;this.app.restActions.listForm(i||this.app.options.column.id,function(t){t.data.each(function(t){var i=new Element("div",{styles:this.css.formNode}).inject(a),o="process_icon_"+(33*Math.random()).toInt()+".png",l=this.path+this.options.style+"/processIcon/"+o;new Element("div",{styles:this.css.formIconNode}).inject(i).setStyle("background","url("+l+") center center no-repeat"),new Element("div",{styles:this.css.formTitleNode,text:t.name}).inject(i),new Element("div",{styles:this.css.formDescriptionNode,text:t.description||"",title:t.description||""}).inject(i),new Element("div",{styles:this.css.formDateNode,text:t.updateTime||""}).inject(i),i.store("form",{name:t.name,id:t.id}),i.addEvents({mouseover:function(){this.setStyles(p.css.formNode_over)},mouseout:function(){this.setStyles(p.css.formNode)},mousedown:function(){this.setStyles(p.css.formNode_down)},mouseup:function(){this.setStyles(p.css.formNode_over)},click:function(t){e&&e(t,this.retrieve("form")),n.destroy(),s.destroy()}})}.bind(this));var i=this.app.content.getSize(),o=n.getSize(),l=(i.y-o.y)/2,c=(i.x-o.x)/2;l<0&&(l=0),c<0&&(c=0),n.setStyles({top:l+"px",left:c+"px"})}.bind(this)),s.addEvent("click",(function(){n.destroy(),s.destroy()}))},_loadItemDataList:function(e){this.actions.listView(this.app.options.column.id,e)},_getItemObject:function(e,t){return new MWF.xApplication.cms.ColumnManager.ViewExplorer.View(this,e,{index:t})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.view.create,search:MWF.CMSCM.LP.view.search,searchText:MWF.CMSCM.LP.view.searchText,noElement:MWF.CMSCM.LP.view.noViewNoticeText}},loadElementList:function(){this._loadItemDataList(function(e){if(e.data=e.data||[],e.data.length)e.data.each(function(e){var t=this._getItemObject(e,this.itemArray.length+1);t.load(),this.itemObject[e.id]=t,this.itemArray.push(t)}.bind(this));else{var t=new Element("div",{styles:this.css.noElementNode,text:this.options.noCreate?MWF.CMSCM.LP.view.noViewNoCreateNoticeText:this.options.tooltip.noElement}).inject(this.elementContentListNode);this.options.noCreate||t.addEvent("click",function(e){this._createElement(e)}.bind(this))}}.bind(this))},deleteItems:function(){for(;this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteView():e.deleteView(function(){this.hideDeleteAction(),this.reload()}.bind(this))}},keyCopy:function(e){if(this.selectMarkItems.length){var t=[],i=0,s=function(e){if(i>=this.selectMarkItems.length&&t.length){var s=JSON.encode(t);e?e.clipboardData.setData("text/plain",s):window.clipboardData.setData("Text",s),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getView(n.data.id,function(n){n.data.elementType="view",t.push(n.data),i++,s(e)}.bind(this),null,!1)}.bind(this))}},keyPaste:function(e){var t="";t=e?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(t);this.loadSelectFormDialog(function(e,t){this.pasteItem(i,0,t)}.bind(this),MWF.CMSCM.LP.view.selectRelativeFormNoticeText)},pasteItem:function(e,t,i){if(t<e.length){var s=e[t];"view"===s.elementType?this.saveItemAs(s,function(){t++,this.pasteItem(e,t,i)}.bind(this),function(){t++,this.pasteItem(e,t,i)}.bind(this),function(){this.reload()}.bind(this),i):(t++,this.pasteItem(e,t,i))}else this.reload()},saveItemAs:function(e,t,i,s,n){this.app.restActions.listView(this.app.options.application.id,function(o){o.data=o.data||[];var a=o.data.filter((function(t){return t.id===e.id}));if(a.length){var p=a[0],l=this.app.lp,c=this,r=(new Date).parse(e.updateTime),d=(new Date).parse(p.updateTime),h="<div>"+l.copyConfirmInfor+"</div>";h+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+l.copySource+" "+p.name+"</div>",h+="<div style='font-size:12px; color: #666666; float: left'>"+p.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(r>=d?"":l.copynew)+"</div></div>",h+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+l.copyTarget+" "+e.name+"</div>",h+="<div style='font-size:12px; color: #666666; float: left;'>"+e.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(r<=d?"":l.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:h},500,290,[{text:l.copyConfirm_overwrite,action:function(){c.saveItemAsUpdate(p,e,t,i),this.close()}},{text:l.copyConfirm_new,action:function(){c.saveItemAsNew(o,e,t,i),this.close()}},{text:l.copyConfirm_skip,action:function(){this.close(),t&&t()}},{text:l.copyConfirm_cancel,action:function(){this.close(),s&&s()}}])}else this.saveItemAsNew(o,e,t,i,n)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(e,t,i,s,n){t.isNew=!1,t.id=e.id,t.application=e.appId||e.application,t.applicationName=e.appName||e.applicationName,t.appId=t.application,t.appName=t.applicationName,t.name=e.name,t.alias=e.alias,t.formId=n.id;var o=JSON.parse(t.content);o.application=t.application,o.applicationName=t.applicationName,o.relativeForm=n,o.id=t.id,o.name=e.name,o.alias=e.alias;var a=[];o.columns.each(function(e){e.id=this.app.restActions.getUUID(),e.isNew=!1;var i={};i.id=e.id,i.isNew=!0,i.viewId=t.id,i.fieldTitle=e.title,i.fieldName=e.value,i.xshowSequence=n.id,a.push(i)}.bind(this)),t.content=JSON.stringify(o),this.app.restActions.saveView(t,function(){i&&i()}.bind(this),function(){s&&s()}.bind(this))},saveItemAsNew:function(e,t,i,s,n){for(var o=this.app.options.application,a=o.id,p=o.name,l=t.name,c=1;e.data.some((function(e){return e.name==t.name||e.alias==t.name}));)t.name=l+"_copy"+c,t.alias=l+"_copy"+c,c++;t.isNew=!0,t.id=this.app.restActions.getUUID(),t.application=a,t.applicationName=p,t.appId=a,t.appName=p,t.formId=n.id;var r=JSON.parse(t.content);r.application=t.application,r.applicationName=t.applicationName,r.relativeForm=n,r.id=t.id,r.name=t.name,r.alias=t.alias;var d=[];r.columns.each(function(e){e.id=this.app.restActions.getUUID(),e.isNew=!1;var i={};i.id=e.id,i.isNew=!0,i.viewId=t.id,i.fieldTitle=e.title,i.fieldName=e.value,i.xshowSequence=n.id,d.push(i)}.bind(this)),t.content=JSON.stringify(r),delete t.createTime,delete t.updateTime,delete t.elementType,this.app.restActions.saveView(t,function(){i&&i()}.bind(this),function(){s&&s()}.bind(this))}}),MWF.xApplication.cms.ColumnManager.ViewExplorer.View=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,load_bak:function(){this.options.index%2==0?this.itemNodeCss=this.explorer.css.itemNode_even:this.itemNodeCss=this.explorer.css.itemNode,this.node=new Element("div",{styles:this.itemNodeCss,events:{click:function(e){this._open(e),e.stopPropagation()}.bind(this),mouseover:function(){this.node.setStyles(this.explorer.css.itemNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.itemNodeCss)}.bind(this)}}).inject(this.container,this.options.where),this.data.name.icon&&(this.icon=this.data.name.icon);var e=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon,t=new Element("div",{styles:this.explorer.css.itemIconNode}).inject(this.node);t.setStyle("background","url("+e+") center center no-repeat"),t.makeLnk({par:this._getLnkPar()}),this.actionsArea=new Element("div.actionsArea",{styles:this.explorer.css.actionsArea}).inject(this.node),this.explorer.options.noDelete||(this.deleteActionNode=new Element("div.deleteAction",{styles:this.explorer.css.deleteAction}).inject(this.actionsArea),this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e),e.stopPropagation()}.bind(this)),this.deleteActionNode.addEvents({mouseover:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction_over)}.bind(this),mouseout:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction)}.bind(this)}));var i=new Element("div.itemInforNode",{styles:this.explorer.css.itemInforNode}).inject(this.node),s=new Element("div.itemInforBaseNode",{styles:this.explorer.css.itemInforBaseNode}).inject(i);new Element("div.itemTextTitleNode",{styles:this.explorer.css.itemTextTitleNode,text:this.data.name,title:this.data.name}).inject(s),new Element("div.itemTextAliasNode",{styles:this.explorer.css.itemTextAliasNode,text:this.data.alias,title:this.data.alias}).inject(s),new Element("div.itemTextDateNode",{styles:this.explorer.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s),new Element("div.itemTextDescriptionNode",{styles:this.explorer.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(s),this._customNodes()},_customNodes:function(){},_open:function(e){var t=this,i={appId:"cms.ViewDesigner"+t.data.id,id:t.data.id,application:t.explorer.app.options.column.id,onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.column=t.explorer.app.options.column,this.application=t.explorer.app.options.column,this.options.noModifyName=t.explorer.options.noModifyName,this.options.readMode=t.explorer.options.readMode,this.options.formId=t.data.formId}};this.explorer.app.desktop.openApplication(e,"cms.ViewDesigner",i)},_getIcon:function(){return"process_icon_"+(33*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/viewIcon/lnk.png",title:this.data.name,par:'cms.ViewDesigner#{"id": "'+this.data.id+'", "application": '+JSON.stringify(this.explorer.app.options.application)+"}"}},deleteView:function(e){this.explorer.app.restActions.deleteView(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))},saveas:function(){MWF.xDesktop.requireApp("Selector","package",function(){var e=this.explorer.app.options.application;e.name=e.appName;new MWF.O2Selector(this.explorer.app.content,{title:this.explorer.app.lp.copyto,type:"CMSApplication",count:1,values:[e],onComplete:function(e){e.each(function(e){this.saveItemAs(e.data)}.bind(this))}.bind(this)})}.bind(this))},saveItemAs:function(e){var t=MWF.xApplication.cms.ColumnManager.LP.selectRelateFormNotice;this.explorer.loadSelectFormDialog(function(t,i){this._saveItemAs(e,i)}.bind(this),t,e.id)},_saveItemAs:function(e,t){this.app=this.app||this.explorer.app;var i=e.id,s=e.name||e.appName;this.explorer.app.restActions.getView(this.data.id,function(e){var n=e.data,o=n.name;this.explorer.app.restActions.listView(i,function(e){e.data=e.data||[];for(var a=1;e.data.some((function(e){return e.name==n.name||e.alias==n.name}));)n.name=o+"_copy"+a,n.alias=o+"_copy"+a,a++;n.isNew=!0,n.id=this.app.restActions.getUUID(),n.application=i,n.applicationName=s,n.appId=i,n.appName=s,n.formId=t.id;var p=JSON.parse(n.content);p.application=n.application,p.applicationName=n.applicationName,p.relativeForm=t,p.id=n.id,p.name=n.name,p.alias=n.alias;var l=[];p.columns.each(function(e){e.id=this.app.restActions.getUUID(),e.isNew=!1;var i={};i.id=e.id,i.isNew=!0,i.viewId=n.id,i.fieldTitle=e.title,i.fieldName=e.value,i.xshowSequence=t.id,l.push(i)}.bind(this)),n.content=JSON.stringify(p),delete n.createTime,delete n.updateTime,delete n.elementType,this.explorer.app.restActions.saveView(n,function(){i==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});