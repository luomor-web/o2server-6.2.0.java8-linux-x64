MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.ColumnManager=MWF.xApplication.cms.ColumnManager||{},MWF.xDesktop.requireApp("cms.ColumnManager","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("cms.ColumnManager","package",null,!1),MWF.xApplication.cms.ColumnManager.Explorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",title:"",tooltip:{create:MWF.CMSCM.LP.category.create,search:MWF.CMSCM.LP.category.search,searchText:MWF.CMSCM.LP.category.searchText,noElement:MWF.CMSCM.LP.category.noCategoryNoticeText}},initialize:function(e,t,i){this.setOptions(i),this.setTooltip(),this.path="../x_component_cms_ColumnManager/$Explorer/",this.cssPath="../x_component_cms_ColumnManager/$Explorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=t,this.node=$(e),this.initData()},setTooltip:function(e){e&&(this.options.tooltip=Object.merge(this.options.tooltip,e))},initData:function(){this.itemArray=[],this.itemObject={},this.deleteMarkItems=[],this.selectMarkItems=[]},reload:function(){this.node&&(this.initData(),this.node.empty(),this.load())},load:function(){this.loadToolbar(),this.loadContentNode(),this.setNodeScroll(),this.loadElementList()},loadToolbar:function(){this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}),this.createTitleElementNode(),this.createCreateElementNode(),this.createSearchElementNode(),this.toolbarNode.inject(this.node)},createCreateElementNode:function(){this.createElementNode=new Element("div",{styles:this.css.createElementNode,title:this.options.tooltip.create}).inject(this.toolbarNode),this.createElementNode.addEvents({click:function(e){this._createElement(e)}.bind(this),mouseover:function(e){this.createElementNode.setStyles(this.css.createElementNode_over)}.bind(this),mouseout:function(e){this.createElementNode.setStyles(this.css.createElementNode)}.bind(this)})},createTitleElementNode:function(){this.titleElementNode=new Element("div",{styles:this.css.titleElementNode,text:this.options.title}).inject(this.toolbarNode)},createSearchElementNode:function(){return this.searchElementNode=new Element("div",{styles:this.css.searchElementNode}).inject(this.toolbarNode),!1},searchElement:function(){},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node),this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode),this.setContentSize(),this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},setContentSize:function(){var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},t=this.node.getSize(),i=this.elementContentNode.getStyle("padding-top").toFloat(),s=this.elementContentNode.getStyle("padding-bottom").toFloat(),o=t.y-e.y-i-s;this.elementContentNode.setStyle("height",o+"px");var n=this.app.content.getSize(),l=this.app.leftContentNode.getSize(),c=n.x-l.x;this.elementContentNode.setStyle("width",c-10+"px"),this.options.noCreate&&this.createElementNode.destroy()},setNodeScroll:function(){MWF.require("MWF.widget.DragScroll",function(){new MWF.widget.DragScroll(this.elementContentNode)}.bind(this)),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:!1})}.bind(this))},loadElementList:function(e){this._loadItemDataList(function(t){t.data.length?(t.data.each(function(e){var t=this._getItemObject(e,this.itemArray.length+1);t.load(),this.itemObject[e.id]=t,this.itemArray.push(t)}.bind(this)),e&&e()):(this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode)).addEvent("click",function(e){this._createElement(e)}.bind(this))}.bind(this))},showDeleteAction:function(){this.deleteItemsAction||(this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node),this.deleteItemsAction.fade("in"),this.deleteItemsAction.position({relativeTo:this.elementContentListNode}),this.deleteItemsAction.setStyle("top","50%"),this.deleteItemsAction.addEvent("click",function(){var e=this;this.app.confirm("warn",this.deleteItemsAction,MWF.CMSCM.LP.deleteElementTitle,MWF.CMSCM.LP.deleteElement,300,120,(function(){e.deleteItems(),this.close()}),(function(){this.close()}))}.bind(this)))},hideDeleteAction:function(){this.deleteItemsAction&&this.deleteItemsAction.destroy(),delete this.deleteItemsAction},_createElement:function(e){},_loadItemDataList:function(e){this.app.restActions.listCategory(this.app.options.column.id,e)},_getItemObject:function(e,t){return MWF.xApplication.cms.ColumnManager.Explorer.Item(this,e,{index:t})}}),MWF.xApplication.cms.ColumnManager.Explorer.Item=new Class({Implements:[Options],options:{where:"bottom",index:1},initialize:function(e,t,i){this.setOptions(i),this.explorer=e,this.data=t,this.container=this.explorer.elementContentListNode,this.icon=this._getIcon()},load:function(){this.options.index%2==0?this.itemNodeCss=this.explorer.css.itemNode_even:this.itemNodeCss=this.explorer.css.itemNode,this.node=new Element("div",{styles:this.itemNodeCss,events:{click:function(e){this._open(e),e.stopPropagation()}.bind(this),mouseover:function(){this.isSelected||this.node.setStyles(this.explorer.css.itemNode_over)}.bind(this),mouseout:function(){this.isSelected||this.node.setStyles(this.itemNodeCss)}.bind(this)}}).inject(this.container,this.options.where),this.data.icon&&(this.icon=this.data.icon);var e=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon,t=new Element("div",{styles:this.explorer.css.itemIconNode}).inject(this.node);t.setStyle("background","url("+e+") center center no-repeat"),t.makeLnk({par:this._getLnkPar()}),t.addEvent("click",function(e){this.toggleSelected(),e.stopPropagation()}.bind(this)),this.actionsArea=new Element("div.actionsArea",{styles:this.explorer.css.actionsArea}).inject(this.node),this.saveasActionNode=new Element("div",{styles:this.explorer.css.saveasActionNode,title:this.explorer.app.lp.copy}).inject(this.actionsArea),this.saveasActionNode.addEvent("click",function(e){this.saveas(e),e.stopPropagation()}.bind(this)),this.saveasActionNode.addEvents({mouseover:function(e){this.saveasActionNode.setStyles(this.explorer.css.saveasActionNode_over)}.bind(this),mouseout:function(e){this.saveasActionNode.setStyles(this.explorer.css.saveasActionNode)}.bind(this)}),this.explorer.options.noDelete||(this.deleteActionNode=new Element("div.deleteAction",{styles:this.explorer.css.deleteAction}).inject(this.actionsArea),this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e),e.stopPropagation()}.bind(this)),this.deleteActionNode.addEvents({mouseover:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction_over)}.bind(this),mouseout:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction)}.bind(this)}));var i=new Element("div.itemInforNode",{styles:this.explorer.css.itemInforNode}).inject(this.node),s=new Element("div.itemInforBaseNode",{styles:this.explorer.css.itemInforBaseNode}).inject(i);new Element("div.itemTextTitleNode",{styles:this.explorer.css.itemTextTitleNode,text:this.data.name,title:this.data.name}).inject(s),new Element("div.itemTextAliasNode",{styles:this.explorer.css.itemTextAliasNode,text:this.data.alias,title:this.data.alias}).inject(s),new Element("div.itemTextDateNode",{styles:this.explorer.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s),new Element("div.itemTextDescriptionNode",{styles:this.explorer.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(s)},deleteItem:function(){this.deleteMode?(this.deleteMode=!1,this.node.setStyle("background","#FFF"),this.deleteActionNode.setStyles(this.explorer.css.deleteAction),this.deleteActionNode.addEvents({mouseover:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction_over)}.bind(this),mouseout:function(e){this.deleteActionNode.setStyles(this.explorer.css.deleteAction)}.bind(this)}),this.node.addEvents({mouseover:function(){this.node.setStyles(this.explorer.css.itemNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.itemNodeCss)}.bind(this)}),this.explorer.deleteMarkItems.erase(this)):(this.deleteMode=!0,this.node.setStyle("background-color","#ffb7b7"),this.deleteActionNode.setStyle("background-image","url(../x_component_cms_ColumnManager/$Explorer/default/processIcon/deleteProcess_red1.png)"),this.deleteActionNode.removeEvents("mouseover"),this.deleteActionNode.removeEvents("mouseout"),this.node.removeEvents("mouseover"),this.node.removeEvents("mouseout"),this.explorer.deleteMarkItems.push(this)),this.explorer.deleteMarkItems.length?this.explorer.showDeleteAction():this.explorer.hideDeleteAction()},deleteItems:function(){},_open:function(e){var t=this,i={onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.column=t.explorer.app.options.column,this.application=t.explorer.app.options.column}};this.explorer.app.desktop.openApplication(e,"cms.ProcessDesigner",i)},_getIcon:function(){return"process_icon_"+(33*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'ProcessDesigner#{"id": "'+this.data.id+'"}'}},_isNew:function(){if(this.data.updateTime){var e=Date.parse(this.data.updateTime),t=new Date;e.diff(t,"hour")<12&&(this.newNode=new Element("div",{styles:this.explorer.css.itemNewNode}).inject(this.node))}},toggleSelected:function(){this.isSelected?this.unSelected():this.selected()},checkShowCopyInfor:function(){1===this.explorer.selectMarkItems.length&&this.explorer.app.notice(this.explorer.app.lp.copyInfor,"infor")},selected:function(){this.deleteMode&&this.deleteItem(),this.isSelected=!0,this.node.setStyles(this.explorer.css.itemNode_selected),this.explorer.selectMarkItems.push(this),this.checkShowCopyInfor()},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.explorer.css.itemNode),this.explorer.selectMarkItems.erase(this)},saveas:function(){MWF.xDesktop.requireApp("Selector","package",function(){var e=this.explorer.app.options.application;e.name=e.appName;new MWF.O2Selector(this.explorer.app.content,{title:this.explorer.app.lp.copyto,type:"CMSApplication",values:[e],onComplete:function(e){e.each(function(e){this.saveItemAs(e.data)}.bind(this))}.bind(this)})}.bind(this))}});