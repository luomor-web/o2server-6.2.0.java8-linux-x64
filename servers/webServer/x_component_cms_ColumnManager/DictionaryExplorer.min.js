MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,!1),MWF.xApplication.cms.ColumnManager.DictionaryExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{create:MWF.CMSCM.LP.dictionary.create,search:MWF.CMSCM.LP.dictionary.search,searchText:MWF.CMSCM.LP.dictionary.searchText,noElement:MWF.CMSCM.LP.dictionary.noDictionaryNoticeText},_createElement:function(t){var i=this,e={onQueryLoad:function(){this.actions=i.app.restActions,this.application=i.app.options.column,this.column=i.app.options.column},onPostSave:function(){i.reload()}};this.app.desktop.openApplication(t,"cms.DictionaryDesigner",e)},_loadItemDataList:function(t){this.actions.listDictionary(this.app.options.column.id,t)},_getItemObject:function(t,i){return new MWF.xApplication.cms.ColumnManager.DictionaryExplorer.Dictionary(this,t,{index:i})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.dictionary.create,search:MWF.CMSCM.LP.dictionary.search,searchText:MWF.CMSCM.LP.dictionary.searchText,noElement:MWF.CMSCM.LP.dictionary.noDictionaryNoticeText}},loadElementList:function(t){this._loadItemDataList(function(i){if(i.data.length)i.data.each(function(t){var i=this._getItemObject(t,this.itemArray.length+1);i.load(),this.itemObject[t.id]=i,this.itemArray.push(i)}.bind(this)),t&&t();else{var e=new Element("div",{styles:this.css.noElementNode,text:this.options.noCreate?MWF.CMSCM.LP.dictionary.noDictionaryNoCreateNoticeText:this.options.tooltip.noElement}).inject(this.elementContentListNode);this.options.noCreate||e.addEvent("click",function(t){this._createElement(t)}.bind(this))}}.bind(this))},deleteItems:function(){for(;this.deleteMarkItems.length;){var t=this.deleteMarkItems.shift();this.deleteMarkItems.length?t.deleteDictionary():t.deleteDictionary(function(){this.hideDeleteAction(),this.reload()}.bind(this))}},keyCopy:function(t){if(this.selectMarkItems.length){var i=[],e=0,n=function(t){if(e>=this.selectMarkItems.length&&i.length){var n=JSON.encode(i);t?t.clipboardData.setData("text/plain",n):window.clipboardData.setData("Text",n),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(a){this.app.restActions.getDictionary(a.data.id,function(a){a.data.elementType="dictionary",i.push(a.data),e++,n(t)}.bind(this),null,!1)}.bind(this))}},keyPaste:function(t){var i="";i=t?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var e=JSON.decode(i);this.pasteItem(e,0)},pasteItem:function(t,i){if(i<t.length){var e=t[i];"dictionary"===e.elementType?this.saveItemAs(e,function(){i++,this.pasteItem(t,i)}.bind(this),function(){i++,this.pasteItem(t,i)}.bind(this),function(){this.reload()}.bind(this)):(i++,this.pasteItem(t,i))}else this.reload()},saveItemAs:function(t,i,e,n){this.app.restActions.listDictionary(this.app.options.application.id,function(a){a.data=a.data||[];var o=a.data.filter((function(i){return i.id===t.id}));if(o.length){var s=o[0],p=this.app.lp,c=this,r=(new Date).parse(t.updateTime),l=(new Date).parse(s.updateTime),d="<div>"+p.copyConfirmInfor+"</div>";d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+p.copySource+" "+s.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left'>"+s.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(r>=l?"":p.copynew)+"</div></div>",d+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+p.copyTarget+" "+t.name+"</div>",d+="<div style='font-size:12px; color: #666666; float: left;'>"+t.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(r<=l?"":p.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:d},500,290,[{text:p.copyConfirm_overwrite,action:function(){c.saveItemAsUpdate(s,t,i,e),this.close()}},{text:p.copyConfirm_new,action:function(){c.saveItemAsNew(a,t,i,e),this.close()}},{text:p.copyConfirm_skip,action:function(){this.close(),i&&i()}},{text:p.copyConfirm_cancel,action:function(){this.close(),n&&n()}}])}else this.saveItemAsNew(a,t,i,e)}.bind(this),function(){e&&e()}.bind(this))},saveItemAsUpdate:function(t,i,e,n){i.id=t.id,i.application=t.appId||t.application,i.applicationName=t.appName||t.applicationName,i.appId=i.application,i.appName=i.applicationName,i.name=t.name,i.alias=t.alias,this.app.restActions.saveDictionary(i,function(){e&&e()}.bind(this),function(){n&&n()}.bind(this))},saveItemAsNew:function(t,i,e,n){for(var a=this.app.options.application,o=a.id,s=a.name,p=i.name,c=1;t.data.some((function(t){return t.name==i.name||t.alias==i.name}));)i.name=p+"_copy"+c,i.alias=p+"_copy"+c,c++;i.id="",i.application=o,i.applicationName=s,i.appId=o,i.appName=s,delete i.createTime,delete i.updateTime,delete i.elementType,this.app.restActions.saveDictionary(i,function(){e&&e()}.bind(this),function(){n&&n()}.bind(this))}}),MWF.xApplication.cms.ColumnManager.DictionaryExplorer.Dictionary=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,_customNodes:function(){},_open:function(t){var i=this,e={appId:"cms.DictionaryDesigner"+i.data.id,id:i.data.id,application:i.explorer.app.options.column.id,onQueryLoad:function(){this.actions=i.explorer.actions,this.category=i,this.options.id=i.data.id,this.column=i.explorer.app.options.column,this.application=i.explorer.app.options.column,this.options.noModifyName=i.explorer.options.noModifyName,this.options.readMode=i.explorer.options.readMode}};this.explorer.app.desktop.openApplication(t,"cms.DictionaryDesigner",e)},_getIcon:function(){return"process_icon_"+(33*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/dictionaryIcon/lnk.png",title:this.data.name,par:'cms.DictionaryDesigner#{"id": "'+this.data.id+'", "application" : '+JSON.stringify(this.explorer.app.options.column)+"}"}},deleteDictionary:function(t){this.explorer.app.restActions.removeDictionary(this.data.id,function(){this.node.destroy(),t&&t()}.bind(this))},saveItemAs:function(t){var i=t.id,e=t.name||t.appName;this.explorer.app.restActions.getDictionary(this.data.id,function(t){var n=t.data,a=n.name;this.explorer.app.restActions.listDictionary(i,function(t){t.data=t.data||[];for(var o=1;t.data.some((function(t){return t.name==n.name||t.alias==n.name}));)n.name=a+"_copy"+o,n.alias=a+"_copy"+o,o++;n.id="",n.appId=i,n.appName=e,n.application=i,n.applicationName=e,delete n.createTime,delete n.updateTime,this.explorer.app.restActions.saveDictionary(n,function(){i==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});