print("运行人员同步接口");var File=Java.type("java.io.File"),Config={localPath:File.separator+"data"+File.separator+"OrganizationSyncRequest"+File.separator+"person"+File.separator},applications=resources.getContext().applications(),archiveFlag=!1,Utils={getUserFlag:function(t){return t.flag||t.distinguishedName||t.unique||t.employee||t.mobile||t.id},getKeyEqualObjFromArray:function(t,e,r){for(var i=0;i<t.length;i++)if(t[i][e]===r)return t[i];return null},parseResp:function(t){return t&&null!==t?JSON.parse(t.toString()):{type:"error",message:"服务响应是null，需要管理员查看后台日志"}},getFailText:function(t){var e;return e=t.message?t.message+(t.prompt?"("+t.prompt+")":""):t.prompt?t.prompt:"未知异常",print(e),e},processError:function(t,e){t.printStackTrace();var r=e+" "+t.name+": "+t.message;return print(r),r},arrayIndexOf:function(t,e){for(var r=0;r<t.length;r++)if(t[r]==e)return r;return-1},objectClone:function(t){if(null==t||"object"!=typeof t)return t;if("number"==typeof t.length){for(var e=[],r=0,i=t.length;r<i;++r)e[r]=Utils.objectClone(t[r]);return e}e={};for(var s in t)e[s]=Utils.objectClone(t[s]);return e},saveToLocal:function(t){if(t.saveFlag&&"no"==t.saveFlag)print("不保存文件");else{print("保存文件开始"),null==File&&(File=Java.type("java.io.File"));var e=new File(Config.localPath);if(!e.exists()&&!e.mkdirs())return print("创建文件夹失败："+recordPath),null;var r=t.name?t.name:Utils.getUserFlag(t),i=t.unique?t.unique:"",s=Config.localPath+r+"_"+i+".json",a=new File(s);if(a.exists()&&a.delete(),!a.createNewFile())return print("不能创建文件:"+s),null;var n=new java.io.PrintWriter(a,"GBK");n.write(JSON.stringify(t)),n.close(),print("保存文件结束 path="+s)}}},AttributeAction={add:function(t,e){e.person=t;for(var r="string"==typeof e.value?[e.value]:e.value,i=0;i<r.length;i++)r[i]=r[i].replace("@","-");e.attributeList=r;try{var s=applications.postQuery("x_organization_assemble_control","personattribute",JSON.stringify(e)),a=Utils.parseResp(s);return a.type&&"success"==a.type?"":Utils.getFailText(a)}catch(t){return Utils.processError(t,"新增用户属性AttributeAction.add() 出错: ")}},remove:function(t){try{var e=applications.deleteQuery("x_organization_assemble_control","personattribute/"+t.id),r=Utils.parseResp(e);return r.type&&"success"==r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"删除用户属性AttributeAction.remove() 出错: ")}},update:function(t,e,r){for(var i in e)"distinguishedName"!=i&&(r[i]=e[i]);r.person=t,r.attributeList="string"==typeof e.value?[e.value]:e.value;try{var s=applications.putQuery("x_organization_assemble_control","personattribute/"+r.id,JSON.stringify(r)),a=Utils.parseResp(s);return a.type&&"success"==a.type?"":Utils.getFailText(a)}catch(t){return Utils.processError(t,"修改用户属性AttributeAction.update() 出错: ")}},compare:function(t){var e=t.attributeList,r="",i=Utils.getUserFlag(t);if(i)try{var s,a=applications.getQuery("x_organization_assemble_control","personattribute/list/person/"+i),n=Utils.parseResp(a);s=n.type&&"success"==n.type?n.data:[];for(var o=0;o<s.length;o++){var l=Utils.getKeyEqualObjFromArray(e,"name",s[o].name);r=null==l?AttributeAction.remove(s[o]):AttributeAction.update(i,l,s[o])}for(o=0;o<e.length;o++){null==Utils.getKeyEqualObjFromArray(s,"name",e[o].name)&&(r=AttributeAction.add(i,e[o]))}return r}catch(t){return Utils.processError(t,"修改用户属性AttributeAction.compare() 出错: ")}}},IdentityAction={add:function(t,e,r,i){var s={name:r,person:t,unit:e.flag,description:e.description};try{var a=applications.postQuery("x_organization_assemble_control","identity",JSON.stringify(s)),n=Utils.parseResp(a);return"success"===n.type?"":"no"==i?Utils.getFailText(n):(archiveFlag=!0,"")}catch(t){return Utils.processError(t,"新增用户身份IdentityAction.add() 出错: ")}},remove:function(t){try{var e=applications.deleteQuery("x_organization_assemble_control","identity/"+t.id),r=Utils.parseResp(e);return r.type&&"success"==r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"删除用户身份IdentityAction.remove() 出错: ")}},update:function(t,e,r){if(t.orderNumber!=e.orderNumber||t.description!=e.description){t.orderNumber=e.orderNumber,t.description=e.description;try{var i=applications.putQuery("x_organization_assemble_control","identity/"+t.id,JSON.stringify(t)),s=Utils.parseResp(i);return s.type&&"success"==s.type?"":Utils.getFailText(s)}catch(t){return Utils.processError(t,"修改用户身份IdentityAction.update() 出错: ")}}},compare:function(t){var e="",r=t.unitList,i=Utils.getUserFlag(t);if(!i)return"修改用户身份IdentityAction.compare() 出错: 未能找到用户标志";try{var s,a=applications.getQuery("x_organization_assemble_control","identity/list/person/"+i),n=Utils.parseResp(a);s="success"==n.type&&n.data||[];var o,l={personList:[i]},u=applications.postQuery("x_organization_assemble_express","unit/list/person/object",JSON.stringify(l)),p=Utils.parseResp(u);if("success"!=p.type)return Utils.getFailText(p);o=p.data||[];for(var c=0;c<o.length;c++){var d=IdentityAction.getEqualUnitFromArray(r,o[c]);if(null==d){print("删除身份");var g=IdentityAction.getIdentityByUnit(s,o[c]);e=IdentityAction.remove(g)}else{print("修改身份");g=IdentityAction.getIdentityByUnit(s,o[c]);e=IdentityAction.update(g,d,o[c])}}for(c=0;c<r.length;c++){if(r[c].flag&&""!=r[c].flag)null==IdentityAction.getEqualUnitFromArray(o,r[c])&&(print("新增身份"),e=IdentityAction.add(i,r[c],t.name,t.ignoreFlag))}return e}catch(t){return Utils.processError(t,"修改用户身份IdentityAction.compare() 出错: ")}},getIdentityByUnit:function(t,e){for(var r=0;r<t.length;r++){var i=t[r];if(i.unitLevelName===e.levelName)return i}},getEqualUnitFromArray:function(t,e){for(var r=0;r<t.length;r++)if(IdentityAction.unitEquals(t[r],e))return t[r];return null},unitEquals:function(t,e){return!!(e.flag&&Utils.arrayIndexOf([t.flag,t.unique,t.distinguishedName,t.levelName,t.id],e.flag)>-1)||(!!(t.flag&&Utils.arrayIndexOf([e.flag,e.unique,e.distinguishedName,e.levelName,e.id],t.flag)>-1)||(!(!e.id||e.id!=t.id)||(!(!e.unique||e.unique!=t.unique)||(!(!e.distinguishedName||e.distinguishedName!=t.distinguishedName)||!(!e.levelName||e.levelName!=t.levelName)))))}};function get(t){var e,r,i="",s=Utils.getUserFlag(t);if(s){try{e=applications.getQuery("x_organization_assemble_control","person/"+s);var a=Utils.parseResp(e);if(!a.type||"success"!=a.type)return Utils.getFailText(a);r=a.data}catch(t){return Utils.processError(t,"get() 出错: ")}return delete r.woIdentityList,delete r.woRoleList,delete r.woGroupList,delete r.woPersonAttributeList,r}return i="参数中没有个人标志：distinguishedName , unique, employee, mobile 或 id, 不能获取用户",print(i),i}function add(t){print("添加个人");var e,r,i,s=Utils.objectClone(t);try{if(s.superior&&""!=s.superior&&"no"!=s.ignoreFlag)"object"!=typeof get({flag:s.superior})&&(archiveFlag=!0,delete s.superior);var a=get(s);if("object"==typeof a)if(s.forceFlag&&"yes"==s.forceFlag){for(var n in s)"action"!==n&&"attributeList"!==n&&"unitList"!==n&&("orderNumber"!=n||s[n]&&""!=s[n])&&("id"==n||"unique"==n||"distinguishedName"==n||"changePasswordTime"==n||(a[n]=s[n]));a.controllerList&&null!=a.controllerList||(a.controllerList=[]),i=applications.putQuery("x_organization_assemble_control","person/"+a.id,JSON.stringify(a))}else e="人员“"+Utils.getUserFlag(s)+"”已经在系统内存在";else{null===s.controllerList&&(s.controllerList=[]);var o=Utils.objectClone(s);o.attributeList&&delete o.attributeList,o.unitList&&delete o.unitList,o.controllerList=[],i=applications.postQuery("x_organization_assemble_control","person",JSON.stringify(o))}i&&!e&&((r=Utils.parseResp(i)).type&&"success"==r.type?(s.attributeList||(s.attributeList=[]),e=AttributeAction.compare(s),s.unitList||(s.unitList=[]),e=IdentityAction.compare(s)):e=Utils.getFailText(r)),archiveFlag&&!e&&Utils.saveToLocal(t)}catch(t){e=Utils.processError(t,"添加个人 add() 出错：")}finally{var l={result:e?"error":"success",description:e||""};return r&&r.data&&(l.id=r.data.id),l}}function update(t){print("修改个人");var e,r=Utils.objectClone(t);try{if(r.superior&&""!=r.superior&&"no"!=r.ignoreFlag)"object"!=typeof get({flag:r.superior})&&(archiveFlag=!0,delete r.superior);var i=get(r);if("object"==typeof i){for(var s in r)"action"!==s&&"attributeList"!==s&&"unitList"!==s&&("orderNumber"!=s||r[s]&&""!=r[s])&&("id"==s||"unique"==s||"distinguishedName"==s||"changePasswordTime"==s||(i[s]=r[s]));i.controllerList&&null!=i.controllerList||(i.controllerList=[]);var a,n=applications.putQuery("x_organization_assemble_control","person/"+i.id,JSON.stringify(i));(a=Utils.parseResp(n)).type&&"success"==a.type?(r.attributeList||(r.attributeList=[]),e=AttributeAction.compare(r),r.unitList||(r.unitList=[]),e=IdentityAction.compare(r)):e=Utils.getFailText(a)}else e=i;archiveFlag&&!e&&Utils.saveToLocal(t)}catch(t){e=Utils.processError(t,"修改个人 update() 出错：")}finally{var o={result:e?"error":"success",description:e||""};return a&&a.data&&(o.id=a.data.id),o}}function updatePassword(t){print("修改用户密码");var e,r="",i=Utils.getUserFlag(t);if(i)try{var s={value:t.password},a=applications.putQuery("x_organization_assemble_control","person/"+i+"/set/password",JSON.stringify(s));(e=Utils.parseResp(a)).type&&"success"==e.type||(r=Utils.getFailText(e))}catch(t){r=Utils.processError(t,"修改用户密码出错 "+i+" updatePassword() 出错：")}else r="参数中没有个人标志：distinguishedName , unique, employee, mobile 或 id, 不能获取用户",print(r);return{result:r?"error":"success",description:r||""}}function updateSuperior(t){var e,r;print("修改个人汇报对象");try{var i=get(t);if("object"==typeof i){i.superior=t.superior,i.controllerList||(i.controllerList=[]);var s=applications.putQuery("x_organization_assemble_control","person/"+i.id,JSON.stringify(i));(r=Utils.parseResp(s)).type&&"success"==r.type||(e=Utils.getFailText(r))}else e=i}catch(t){e=Utils.processError(t,"修改个人 updateSuperior() 出错：")}finally{var a={result:e?"error":"success",description:e||""};return r&&r.data&&(a.id=r.data.id),a}}function remove(t){var e,r;print("删除个人");try{var i=get(t);if("object"==typeof i){var s=applications.deleteQuery("x_organization_assemble_control","person/"+i.id);(r=Utils.parseResp(s)).type&&"success"==r.type||(e=Utils.getFailText(r))}else e=i}catch(t){e=Utils.processError(t,"删除个人 remove() 出错：")}finally{var a={result:e?"error":"success",description:e||""};return r&&r.data&&(a.id=r.data.id),a}}function init(){var t="";try{print("requestText="+requestText);var e=JSON.parse(requestText);print("type of requestJson = "+typeof e),"string"==typeof e&&(e=JSON.parse(e));var r=e.action;switch(print("action="+r),r){case"add":t=add(e);break;case"update":t=update(e);break;case"updatepwd":t=updatePassword(e);break;case"updateSuperior":t=updateSuperior(e);break;case"delete":t=remove(e);break;default:t={result:"error",description:"requestText未设置action，不执行操作"}}}catch(e){e.printStackTrace(),t={result:"error",description:e.name+": "+e.message}}finally{return print("responseText="+JSON.stringify(t)),t}}init();