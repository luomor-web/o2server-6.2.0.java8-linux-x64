print("运行人员同步接口");var File=Java.type("java.io.File"),Config={localPath:File.separator+"data"+File.separator+"OrganizationSyncRequest"+File.separator+"person"+File.separator,ignoreDuty:["部门积分管理员","公司积分管理员","市、县公司普通员工"],ignorAttribute:["市、县公司普通员工"]},applications=resources.getContext().applications(),archiveFlag=!1,Utils={getUserFlag:function(t){return t.flag||t.unique||t.distinguishedName||t.employee||t.mobile||t.id},getKeyEqualObjFromArray:function(t,e,r){for(var i=0;i<t.length;i++)if(t[i][e]===r)return t[i];return null},parseResp:function(t){return t&&null!==t?JSON.parse(t.toString()):{type:"error",message:"服务响应是null，需要管理员查看后台日志"}},getFailText:function(t){var e;return e=t.message?t.message+(t.prompt?"("+t.prompt+")":""):t.prompt?t.prompt:"未知异常",print(e),e},processError:function(t,e){t.printStackTrace();var r=e+" "+t.name+": "+t.message;return print(r),r},arrayIndexOf:function(t,e){for(var r=0;r<t.length;r++)if(t[r]==e)return r;return-1},arrayErase:function(t,e){for(var r=t.length;r--;)t[r]===e&&t.splice(r,1);return t},objectClone:function(t){if(null==t||"object"!=typeof t)return t;if("number"==typeof t.length){for(var e=[],r=0,i=t.length;r<i;++r)e[r]=Utils.objectClone(t[r]);return e}e={};for(var s in t)e[s]=Utils.objectClone(t[s]);return e},typeOf:function(t){if(null===t)return"null";if(!t)return typeof t;if(null!=t.$family)return t.$family();if(t.constructor==Array)return"array";if(t.nodeName){if(1==t.nodeType)return"element";if(3==t.nodeType)return/\S/.test(t.nodeValue)?"textnode":"whitespace"}else if("number"==typeof t.length&&t.callee)return"arguments";return typeof t},saveToLocal:function(t){if(t.saveFlag&&"no"==t.saveFlag)print("不保存文件");else{print("保存文件开始"),null==File&&(File=Java.type("java.io.File"));var e=new File(Config.localPath);if(!e.exists()&&!e.mkdirs())return print("创建文件夹失败："+recordPath),null;var r=t.name?t.name:Utils.getUserFlag(t),i=t.unique?t.unique:"",s=Config.localPath+r+"_"+i+".json",n=new File(s);if(n.exists()&&n.delete(),!n.createNewFile())return print("不能创建文件:"+s),null;var a=new java.io.PrintWriter(n,"GBK");a.write(JSON.stringify(t)),a.close(),print("保存文件结束 path="+s)}}},AttributeAction=function(t){var e=t.attributeList;this.errorText="";var r=Utils.getUserFlag(t);if(r)try{var i,s=applications.getQuery("x_organization_assemble_control","personattribute/list/person/"+r),n=Utils.parseResp(s);i=n.type&&"success"==n.type?n.data:[];for(var a=0;a<i.length;a++)if(-1==Utils.arrayIndexOf(Config.ignorAttribute,i[a].name)){var o=Utils.getKeyEqualObjFromArray(e,"name",i[a].name);this.errorText=null==o?this.remove(i[a]):this.update(r,o,i[a])}for(a=0;a<e.length;a++){if(-1==Utils.arrayIndexOf(Config.ignorAttribute,e[a].name))null==Utils.getKeyEqualObjFromArray(i,"name",e[a].name)&&(this.errorText=this.add(r,e[a]))}}catch(t){this.errorText=Utils.processError(t,"处理用户属性AttributeAction.new() 出错: ")}};AttributeAction.prototype.add=function(t,e){e.person=t;for(var r="string"==typeof e.value?[e.value]:e.value,i=0;i<r.length;i++)r[i]=r[i].replace("@","-");e.attributeList=r;try{var s=applications.postQuery("x_organization_assemble_control","personattribute",JSON.stringify(e)),n=Utils.parseResp(s);return n.type&&"success"==n.type?"":Utils.getFailText(n)}catch(t){return Utils.processError(t,"新增用户属性AttributeAction.add() 出错: ")}},AttributeAction.prototype.remove=function(t){try{var e=applications.deleteQuery("x_organization_assemble_control","personattribute/"+t.id),r=Utils.parseResp(e);return r.type&&"success"==r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"删除用户属性AttributeAction.remove() 出错: ")}},AttributeAction.prototype.update=function(t,e,r){for(var i in e)"distinguishedName"!=i&&(r[i]=e[i]);r.person=t,r.attributeList="string"==typeof e.value?[e.value]:e.value;try{var s=applications.putQuery("x_organization_assemble_control","personattribute/"+r.id,JSON.stringify(r)),n=Utils.parseResp(s);return n.type&&"success"==n.type?"":Utils.getFailText(n)}catch(t){return Utils.processError(t,"修改用户属性AttributeAction.update() 出错: ")}};var DutyAction=function(t,e,r){try{this.errorText="",this.identity=t,this.unit=e,this.dutyNameList=r;var i=applications.getQuery("x_organization_assemble_control","unitduty/list/unit/"+e),s=Utils.parseResp(i);if("success"===s.type&&s.data){for(var n=[],a={},o=0;o<s.data.length;o++){var l=s.data[o];a[l.name]=l,this.identityEquals(l.woIdentityList,t)&&n.push(l.name)}for(o=0;o<r.length;o++){var u=r[o];-1==Utils.arrayIndexOf(n,u)&&-1==Utils.arrayIndexOf(Config.ignoreDuty,u)&&(a[u]?this.errorText=this.update(a[u]):this.errorText=this.add(u))}for(o=0;o<n.length;o++){var p=n[o];-1==Utils.arrayIndexOf(r,p)&&-1==Utils.arrayIndexOf(Config.ignoreDuty,p)&&(this.errorText=this.remove(a[p]))}}}catch(t){this.errorText=Utils.processError(t,"处理用户职位new() 出错: ")}};DutyAction.prototype.add=function(t){try{var e={name:t,unit:this.unit,identityList:[this.identity]},r=applications.postQuery("x_organization_assemble_control","unitduty",JSON.stringify(e)),i=Utils.parseResp(r);return"success"===i.type?"":Utils.getFailText(i)}catch(t){return Utils.processError(t,"新增用户职位add() 出错: ")}},DutyAction.prototype.update=function(t){try{t.identityList?t.identityList.push(this.identity):t.identityList=[this.identity];var e=applications.putQuery("x_organization_assemble_control","unitduty/"+t.id,JSON.stringify(t)),r=Utils.parseResp(e);return"success"===r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"修改用户职位add() 出错: ")}},DutyAction.prototype.remove=function(t){try{if(!t.identityList||!t.identityList.length)return;t.identityList=Utils.arrayErase(t.identityList,this.identityId);var e=applications.putQuery("x_organization_assemble_control","unitduty/"+t.id,JSON.stringify(t)),r=Utils.parseResp(e);return"success"===r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"修改用户职位remove() 出错: ")}},DutyAction.prototype.identityEquals=function(t,e){for(var r="array"===Utils.typeOf(t)?t:[t],i=0;i<r.length;i++){var s=r[i];if(Utils.arrayIndexOf([s.unique,s.distinguishedName,s.id],e)>-1)return this.identityId=s.id,!0}return!1};var IdentityAction=function(t){this.errorText="";for(var e=[],r=this.unit_new_obj={},i=0;i<t.unitList.length;i++){if(r[(g=t.unitList[i]).flag])g.duty&&r[g.flag].dutyList.push(g.duty);else(r[g.flag]=Utils.objectClone(g)).dutyList=g.duty?[g.duty]:[]}for(var s in r)e.push(r[s]);if(s=Utils.getUserFlag(t))try{var n,a=applications.getQuery("x_organization_assemble_control","identity/list/person/"+s),o=Utils.parseResp(a);n="success"==o.type&&o.data||[];var l,u={personList:[s]},p=applications.postQuery("x_organization_assemble_express","unit/list/person/object",JSON.stringify(u)),c=Utils.parseResp(p);if("success"!=c.type)return void(this.errorText=Utils.getFailText(c));l=c.data||[];for(i=0;i<l.length;i++){var d=this.getEqualUnitFromArray(e,l[i]);if(null==d){print("删除身份");var y=this.getIdentityByUnit(n,l[i]);this.errorText=this.remove(y)}else{print("修改身份");y=this.getIdentityByUnit(n,l[i]);this.errorText=this.update(y,d,l[i])}}for(i=0;i<e.length;i++){if(e[i].flag&&""!=e[i].flag)null==this.getEqualUnitFromArray(l,e[i])&&(print("新增身份"),this.errorText=this.add(s,e[i],t.name,t.ignoreFlag))}if(!this.errorText)for(var s in r){var g;if((g=r[s]).identity){var f=new DutyAction(g.identity,g.flag,g.dutyList);this.errorText=f.errorText}}}catch(t){this.errorText=Utils.processError(t,"处理用户身份IdentityAction.new() 出错: ")}else this.errorText="处理用户身份IdentityAction.new() 出错: 未能找到用户标志"};function get(t){var e,r,i="",s=Utils.getUserFlag(t);if(s){try{e=applications.getQuery("x_organization_assemble_control","person/"+s);var n=Utils.parseResp(e);if(!n.type||"success"!=n.type)return Utils.getFailText(n);r=n.data}catch(t){return Utils.processError(t,"get() 出错: ")}return delete r.woIdentityList,delete r.woRoleList,delete r.woGroupList,delete r.woPersonAttributeList,r}return i="参数中没有个人标志：distinguishedName , unique, employee, mobile 或 id, 不能获取用户",print(i),i}function add(t){print("添加个人");var e,r,i,s=Utils.objectClone(t);try{if(s.orderNumber)try{s.orderNumber=parseInt(s.orderNumber).toString()}catch(t){}if(s.superior&&""!=s.superior&&"no"!=s.ignoreFlag)"object"!=typeof get({flag:s.superior})&&(archiveFlag=!0,delete s.superior);var n=get(s);if("object"==typeof n)if(s.forceFlag&&"yes"==s.forceFlag){for(var a in s)"action"!==a&&"attributeList"!==a&&"unitList"!==a&&("orderNumber"!=a||s[a]&&""!=s[a])&&("id"==a||"unique"==a||"distinguishedName"==a||"changePasswordTime"==a||(n[a]=s[a]));n.controllerList&&null!=n.controllerList||(n.controllerList=[]),i=applications.putQuery("x_organization_assemble_control","person/"+n.id,JSON.stringify(n))}else e="人员“"+Utils.getUserFlag(s)+"”已经在系统内存在";else{null===s.controllerList&&(s.controllerList=[]);var o=Utils.objectClone(s);o.attributeList&&delete o.attributeList,o.unitList&&delete o.unitList,o.controllerList=[],i=applications.postQuery("x_organization_assemble_control","person",JSON.stringify(o))}if(i&&!e)if((r=Utils.parseResp(i)).type&&"success"==r.type)s.attributeList||(s.attributeList=[]),e=new AttributeAction(s).errorText,s.unitList||(s.unitList=[]),e=new IdentityAction(s).errorText;else e=Utils.getFailText(r);archiveFlag&&!e&&Utils.saveToLocal(t)}catch(t){e=Utils.processError(t,"添加个人 add() 出错：")}finally{var l={result:e?"error":"success",description:e||""};return r&&r.data&&(l.id=r.data.id),l}}function update(t){print("修改个人");var e,r=Utils.objectClone(t);try{if(r.orderNumber)try{r.orderNumber=parseInt(r.orderNumber).toString()}catch(t){}if(r.superior&&""!=r.superior&&"no"!=r.ignoreFlag)"object"!=typeof get({flag:r.superior})&&(archiveFlag=!0,delete r.superior);var i=get(r);if("object"==typeof i){for(var s in r)"action"!==s&&"attributeList"!==s&&"unitList"!==s&&("orderNumber"!=s||r[s]&&""!=r[s])&&("id"==s||"unique"==s||"distinguishedName"==s||"changePasswordTime"==s||(i[s]=r[s]));i.controllerList&&null!=i.controllerList||(i.controllerList=[]);var n,a=applications.putQuery("x_organization_assemble_control","person/"+i.id,JSON.stringify(i));if((n=Utils.parseResp(a)).type&&"success"==n.type)r.attributeList||(r.attributeList=[]),e=new AttributeAction(r).errorText,r.unitList||(r.unitList=[]),e=new IdentityAction(r).errorText;else e=Utils.getFailText(n)}else e=i;archiveFlag&&!e&&Utils.saveToLocal(t)}catch(t){e=Utils.processError(t,"修改个人 update() 出错：")}finally{var o={result:e?"error":"success",description:e||""};return n&&n.data&&(o.id=n.data.id),o}}function updatePassword(t){print("修改用户密码");var e,r="",i=Utils.getUserFlag(t);if(i)try{var s={value:t.password},n=applications.putQuery("x_organization_assemble_control","person/"+i+"/set/password",JSON.stringify(s));(e=Utils.parseResp(n)).type&&"success"==e.type||(r=Utils.getFailText(e))}catch(t){r=Utils.processError(t,"修改用户密码出错 "+i+" updatePassword() 出错：")}else r="参数中没有个人标志：distinguishedName , unique, employee, mobile 或 id, 不能获取用户",print(r);return{result:r?"error":"success",description:r||""}}function updateSuperior(t){var e,r;print("修改个人汇报对象");try{var i=get(t);if("object"==typeof i){i.superior=t.superior,i.controllerList||(i.controllerList=[]);var s=applications.putQuery("x_organization_assemble_control","person/"+i.id,JSON.stringify(i));(r=Utils.parseResp(s)).type&&"success"==r.type||(e=Utils.getFailText(r))}else e=i}catch(t){e=Utils.processError(t,"修改个人 updateSuperior() 出错：")}finally{var n={result:e?"error":"success",description:e||""};return r&&r.data&&(n.id=r.data.id),n}}function remove(t){var e,r;print("删除个人");try{var i=get(t);if("object"==typeof i){var s=applications.deleteQuery("x_organization_assemble_control","person/"+i.id);(r=Utils.parseResp(s)).type&&"success"==r.type||(e=Utils.getFailText(r))}else e=i}catch(t){e=Utils.processError(t,"删除个人 remove() 出错：")}finally{var n={result:e?"error":"success",description:e||""};return r&&r.data&&(n.id=r.data.id),n}}function init(){var t="";try{var e=JSON.parse(requestText);"string"==typeof e&&(e=JSON.parse(e));var r=e.action;switch(print("action="+r),r){case"add":t=add(e);break;case"update":t=update(e);break;case"updatepwd":t=updatePassword(e);break;case"updateSuperior":t=updateSuperior(e);break;case"delete":t=remove(e);break;default:t={result:"error",description:"requestText未设置action，不执行操作"}}}catch(e){e.printStackTrace(),t={result:"error",description:e.name+": "+e.message}}finally{return print("responseText="+JSON.stringify(t)),t}}IdentityAction.prototype.add=function(t,e,r,i){var s={name:r,person:t,unit:e.flag,description:e.description};try{var n=applications.postQuery("x_organization_assemble_control","identity",JSON.stringify(s)),a=Utils.parseResp(n);return"success"===a.type?(this.unit_new_obj[e.flag].identity=a.data.id,""):"no"==i?Utils.getFailText(a):(archiveFlag=!0,"")}catch(t){return Utils.processError(t,"新增用户身份IdentityAction.add() 出错: ")}},IdentityAction.prototype.remove=function(t){try{var e=applications.deleteQuery("x_organization_assemble_control","identity/"+t.id),r=Utils.parseResp(e);return r.type&&"success"==r.type?"":Utils.getFailText(r)}catch(t){return Utils.processError(t,"删除用户身份IdentityAction.remove() 出错: ")}},IdentityAction.prototype.update=function(t,e,r){if(t){if(this.unit_new_obj[e.flag].identity=t.id||t.unique||t.distinguishedName,t.orderNumber==e.orderNumber&&t.description==e.description)return"";t.orderNumber=e.orderNumber,t.description=e.description;try{var i=applications.putQuery("x_organization_assemble_control","identity/"+t.id,JSON.stringify(t)),s=Utils.parseResp(i);return s.type&&"success"==s.type?"":Utils.getFailText(s)}catch(t){return Utils.processError(t,"修改用户身份IdentityAction.update() 出错: ")}}},IdentityAction.prototype.getIdentityByUnit=function(t,e){for(var r=0;r<t.length;r++){var i=t[r];if(i.unitLevelName===e.levelName)return i}},IdentityAction.prototype.getEqualUnitFromArray=function(t,e){for(var r=0;r<t.length;r++)if(this.unitEquals(t[r],e))return t[r];return null},IdentityAction.prototype.unitEquals=function(t,e){return!(!t||!e)&&(!!(e.flag&&Utils.arrayIndexOf([t.flag,t.unique,t.distinguishedName,t.levelName,t.id],e.flag)>-1)||(!!(t.flag&&Utils.arrayIndexOf([e.flag,e.unique,e.distinguishedName,e.levelName,e.id],t.flag)>-1)||(!(!e.id||e.id!=t.id)||(!(!e.unique||e.unique!=t.unique)||(!(!e.distinguishedName||e.distinguishedName!=t.distinguishedName)||!(!e.levelName||e.levelName!=t.levelName))))))},init();