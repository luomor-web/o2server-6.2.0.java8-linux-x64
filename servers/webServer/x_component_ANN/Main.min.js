o2.require("o2.widget.O2Identity",null,!1),o2.require("o2.widget.ace",null,!1),MWF.xApplication.ANN.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style1:"default",style:"default",name:"ANN",icon:"icon.png",width:"1100",height:"600",isResize:!0,isMax:!0,title:MWF.xApplication.ANN.LP.title},initialize:function(t,e){this.setOptions(e),this.desktop=t,this.path="../x_component_"+this.options.name.replace(/\./g,"_")+"/$Main/",this.options.icon=this.path+this.options.style+"/"+this.options.icon,this.stylePath=this.path+this.options.style+"/style.css",this.viewPath=this.path+this.options.style+"/view.html"},onQueryLoad:function(){this.lp=MWF.xApplication.ANN.LP,this.models=[]},loadApplication:function(t){this.content.loadAll({css:this.stylePath,html:this.viewPath},{bind:this},function(){this.node=this.content.getElement(".o2_ann_content"),this.titleNode=this.content.getElement(".o2_ann_top"),this.contentArea=this.content.getElement(".o2_ann_contentArea"),this.listNode=this.content.getElement(".o2_ann_leftContent"),this.contentNode=this.content.getElement(".o2_ann_rightContent"),this.addAction=this.content.getElement(".o2_ann_topIcon"),o2.AC.isAdministrator()||(this.addAction.destroy(),this.addAction=null),this.addAction&&this.addAction.addEvent("click",this.createModel.bind(this)),this.resizeFun=this.resize.bind(this),this.resizeFun(),this.addEvent("resize",this.resizeFun),this.loadListModel(),t&&t()}.bind(this))},getDefaultData:function(){return{neuralNetworkType:"mlp",dataType:"processPlatform",name:this.lp.unnamed,description:"",alias:"",inValueScriptText:"",outValueScriptText:"",attachmentScriptText:"",processList:[],applicationList:[],analyzeType:"default",maxResult:0,propertyMap:{}}},checkSave:function(){return this.currentModel&&this.currentModel.context&&("edit"===this.currentModel.context.status||"new"===this.currentModel.context.status)?(this.notice(this.lp.checkSave,"error",this.contentNode,{x:"left",y:"top"}),!1):(this.currentModel&&this.currentModel.unselected(),!0)},createModel:function(){this.checkSave()&&(this.currentModel=new MWF.xApplication.ANN.Model(this.getDefaultData(),this))},resize:function(){var t=this.node.getSize(),e=this.titleNode.getComputedSize(),i=t.y-e.totalHeight;this.contentArea.setStyle("height",i+"px")},loadListModel:function(){o2.Actions.get("x_query_assemble_designer").listModel(function(t){t.data.each(function(t){this.models.push(new MWF.xApplication.ANN.Model(t,this))}.bind(this))}.bind(this))}}),MWF.xApplication.ANN.Model=new Class({initialize:function(t,e){this.data=t,this.app=e,this.lp=e.lp,this.listNode=this.app.listNode,this.load()},reload:function(){o2.Actions.get("x_query_assemble_designer").getModel(this.data.id,function(t){this.data=t.data,this.context&&(this.context.data=this.data),this.node.getElement(".o2_ann_model_nodeContentName").set("text",this.data.name),this.node.getElement(".o2_ann_model_nodeContentDate").set("text",this.data.updateTime);var e=this.node.getElement(".o2_ann_model_nodeRight");e.set("title",this.lp.status[this.data.status||"idle"]),e.setStyle("background-image","url(../x_component_ANN/$Main/default/icon/"+(this.data.status||"idle")+".png")}.bind(this))},load:function(){this.data.id?this.loadList(function(){this.loadEvent()}.bind(this)):this.loadCreate()},loadList:function(t){var e=this.app.path+this.app.options.style+"/model.html";this.listNode.loadHtml(e,{bind:{lp:this.lp,data:this.data}},function(){this.node=this.listNode.getLast(),t&&t()}.bind(this))},loadCreate:function(){this.loadList(function(){this.loadEvent(),this.selected()}.bind(this))},loadEvent:function(){this.node.addEvents({mouseover:function(){this.isSelected||this.node.addClass("o2_ann_model_node_over")}.bind(this),mouseout:function(){this.isSelected||this.node.removeClass("o2_ann_model_node_over")}.bind(this),click:function(){this.isSelected?this.context&&this.context.reload():this.selected()}.bind(this)})},getData:function(t){o2.Actions.get("x_query_assemble_designer").getModel(this.data.id,function(e){this.data=e.data,t&&t()}.bind(this))},selected:function(){this.app.checkSave()&&(this.node.addClass("o2_ann_model_node_selected"),this.isSelected=!0,this.app.currentModel=this,this.openModel())},unselected:function(){this.isSelected=!1,this.app.currentModel=null,this.node.removeClass("o2_ann_model_node_selected"),this.node.removeClass("o2_ann_model_node_over"),this.context&&this.context.destroy()},openModel:function(){this.context=new MWF.xApplication.ANN.Model.Context(this)},destroy:function(){this.node.destroy(),o2.release(this)}}),MWF.xApplication.ANN.Model.Context=new Class({initialize:function(t){this.model=t,this.data=t.data,this.app=t.app,this.lp=t.lp,this.contentNode=this.app.contentNode,this.getData(this.load.bind(this))},getData:function(t){this.data.id?o2.Actions.get("x_query_assemble_designer").getModel(this.data.id,function(e){this.data=e.data,t&&t()}.bind(this)):t&&t()},reload:function(){this.contentNode.empty(),this.getData(this.load.bind(this))},load:function(){this.status="open",this.data.id||(this.status="new");var t=this.app.path+this.app.options.style+"/content.html";this.contentNode.loadHtml(t,{bind:{lp:this.lp,data:this.data}},function(){this.node=this.contentNode.getFirst(),this.toolbarNode=this.node.getFirst(),this.content=this.node.getLast(),this.lines=this.content.getElements(".o2_ann_modelContext_line"),o2.widget.ace.load(function(){o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js",function(){this.loadContent(),this.loadToolbar(),this.resizeFun=this.resize.bind(this),this.resizeFun(),this.app.addEvent("resize",this.resizeFun),"new"===this.status&&this.edit()}.bind(this))}.bind(this))}.bind(this))},loadContent:function(){this.loadProcessList(),this.loadApplicationList(),this.loadCode(6,JSON.stringify(this.data.propertyMap,null,2)),this.loadCode(7),this.loadCode(8),this.loadCode(9),this.loadStatus()},loadStatus:function(){this.statusNode=this.node.getElement(".o2_ann_modelContext_status")},loadProcessList:function(){if(this.data.processList){var t=this.lines[3].getLast().getFirst();this.data.processList.each(function(e){new o2.widget.O2Process({id:e},t)}.bind(this))}},loadCode:function(t,e){var i=this.lines[t].getLast();e&&i.set("text",e),ace.require("ace/ext/static_highlight")(i,{mode:"ace/mode/javascript",theme:"ace/theme/tomorrow",fontSize:16})},loadApplicationList:function(){if(this.data.applicationList){var t=this.lines[4].getLast();this.data.applicationList.each(function(e){new o2.widget.O2Application({id:e},t)}.bind(this))}},destroy:function(){this.resizeFun&&this.app.removeEvent("resize",this.resizeFun),this.contentNode.empty(),o2.release(this)},close:function(t,e){if("open"!==this.status){var i=this;this.app.confirm("infor",e,this.lp.closeTitle,this.lp.closeInfor,380,100,(function(){if(i.data.id)i.model.unselected();else{var t=i.model;i.model.unselected(),t.destroy()}this.close()}),(function(){this.close()}))}else this.model.unselected()},loadToolbar:function(){MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(this.toolbarNode,{style:"simple"},this),this.toolbar.load(),this.setToolbarDisabled()}.bind(this))},setToolbarDisabled:function(){this.toolbar&&("edit"===this.status?(this.toolbar.childrenButton[0].node.hide(),this.toolbar.childrenButton[1].node.show(),this.toolbar.childrenButton[6].node.show(),this.data.status?(this.toolbar.childrenButton[2].node.hide(),this.toolbar.childrenButton[3].node.hide()):(this.toolbar.childrenButton[2].node.show(),this.toolbar.childrenButton[3].node.show(),this.toolbar.childrenButton[8].node.show()),this.data.status&&"generating"===this.data.status?(this.toolbar.childrenButton[4].node.show(),this.toolbar.childrenButton[8].node.hide()):this.toolbar.childrenButton[4].node.hide(),this.data.status&&"learning"===this.data.status?(this.toolbar.childrenButton[5].node.show(),this.toolbar.childrenButton[8].node.hide()):this.toolbar.childrenButton[5].node.hide()):"new"===this.status?(this.toolbar.childrenButton[0].node.hide(),this.toolbar.childrenButton[1].node.show(),this.toolbar.childrenButton[6].node.hide(),this.toolbar.childrenButton[2].node.hide(),this.toolbar.childrenButton[3].node.hide(),this.toolbar.childrenButton[4].node.hide(),this.toolbar.childrenButton[5].node.hide()):(this.toolbar.childrenButton[0].node.show(),this.toolbar.childrenButton[1].node.hide(),this.toolbar.childrenButton[6].node.show(),this.data.status?(this.toolbar.childrenButton[2].node.hide(),this.toolbar.childrenButton[3].node.hide()):(this.toolbar.childrenButton[2].node.show(),this.toolbar.childrenButton[3].node.show(),this.toolbar.childrenButton[8].node.show()),this.data.status&&"generating"===this.data.status?(this.toolbar.childrenButton[4].node.show(),this.toolbar.childrenButton[8].node.hide()):this.toolbar.childrenButton[4].node.hide(),this.data.status&&"learning"===this.data.status?(this.toolbar.childrenButton[5].node.show(),this.toolbar.childrenButton[8].node.hide()):this.toolbar.childrenButton[5].node.hide()))},resize:function(){var t=this.contentNode.getSize(),e=this.toolbarNode.getComputedSize(),i=t.y-e.totalHeight;this.content.setStyle("height",i+"px")},edit:function(){this.status=this.data.id?"edit":"new",this.setToolbarDisabled(),this.nameInput=this.editInput(0,"name"),this.descriptionInput=this.editInput(1,"description"),this.aliasInput=this.editInput(2,"alias"),this.editProcessList(3),this.editApplicationList(4),this.analyzeInput=this.editSelect(5,["default","full"]),o2.require("o2.widget.ScriptArea",function(){this.propertyMapInput=this.editCode(6,"propertyMap"),this.inValueScriptInput=this.editCode(7,"inValueScriptText"),this.outValueScriptInput=this.editCode(8,"outValueScriptText"),this.attachmentScriptInput=this.editCode(9)}.bind(this))},editInput:function(t,e){var i=this.lines[t].getLast(),s=i.get("text");return i.empty(),new Element("input.o2_ann_modelContext_input",{type:"text",value:s,placeholder:this.lp.placeholder[e]}).inject(i)},editProcessList:function(t){var e=this.lines[t].getLast();new Element("button.o2_ann_modelContext_button",{text:this.lp.selectProcess}).inject(e).addEvent("click",function(t){MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,{type:"process",values:this.data.processList,onComplete:function(e){t.target.getPrevious().empty(),this.data.processList=[],e.each(function(t){this.data.processList.push(t.data.id)}.bind(this)),this.loadProcessList()}.bind(this)})}.bind(this))}.bind(this))},editApplicationList:function(t){var e=this.lines[t].getLast();new Element("button.o2_ann_modelContext_button",{text:this.lp.selectApplication}).inject(e).addEvent("click",function(t){MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.app.content,{type:"application",values:this.data.applicationList,onComplete:function(e){t.target.getPrevious().empty(),this.data.applicationList=[],e.each(function(t){this.data.applicationList.push(t.data.id)}.bind(this)),this.loadApplicationList()}.bind(this)})}.bind(this))}.bind(this))},editSelect:function(t,e){var i=this.lines[t].getLast(),s=i.get("text");i.empty();var n=new Element("select").inject(i);return e.each((function(t){new Element("option",{value:t,text:t,checked:s===t}).inject(n)})),n},editCode:function(t,e){var i=this.lines[t].getLast(),s="propertyMap"===e?JSON.stringify(this.data.propertyMap,null,2):this.data[e];i.empty();var n=new o2.widget.ScriptArea(i,{title:"",maxObj:this.app.content,isbind:!1,isload:!0});return n.load({code:s}),n},getModelData:function(){this.data.name=this.nameInput.get("value"),this.data.description=this.descriptionInput.get("value"),this.data.alias=this.aliasInput.get("value"),this.data.analyzeType=this.analyzeInput.options[this.analyzeInput.selectedIndex].get("value"),this.data.propertyMap=JSON.parse(this.propertyMapInput.editor.getValue()),this.data.inValueScriptText=this.inValueScriptInput.editor.getValue(),this.data.outValueScriptText=this.outValueScriptInput.editor.getValue(),this.data.attachmentScriptText=this.attachmentScriptInput.editor.getValue(),this.data.propertyMap&&(this.data.propertyMap={})},save:function(){this.getModelData(),this.data.id?o2.Actions.get("x_query_assemble_designer").updateModel(this.data.id,this.data,function(){this.app.notice(this.lp.saveSuccess,"success"),this.model.reload(),this.reload()}.bind(this)):o2.Actions.get("x_query_assemble_designer").createModel(this.data,function(t){this.data.id=t.data.id,this.app.notice(this.lp.generate,"success"),this.model.reload(),this.reload()}.bind(this))},generate:function(){o2.Actions.get("x_query_assemble_designer").generate(this.data.id,function(){this.app.notice(this.lp.generate,"success"),this.model.reload(),this.reload()}.bind(this))},learn:function(){o2.Actions.get("x_query_assemble_designer").learn(this.data.id,function(){this.app.notice(this.lp.learn,"success"),this.model.reload(),this.reload()}.bind(this))},stopGenerate:function(t,e){var i=this;this.app.confirm("infor",e,this.lp.stopGenerateTitle,this.lp.stopGenerateInfor,380,100,(function(){o2.Actions.get("x_query_assemble_designer").stopGenerating(i.data.id,function(){this.app.notice(this.lp.stopGenerate,"success"),this.model.reload(),this.reload()}.bind(i)),this.close()}),(function(){this.close()}))},stopLearn:function(t,e){var i=this;this.app.confirm("infor",e,this.lp.stopLearningTitle,this.lp.stopLearningInfor,380,100,(function(){o2.Actions.get("x_query_assemble_designer").stopLearning(i.data.id,function(){this.app.notice(this.lp.stopLearn,"success"),this.model.reload(),this.reload()}.bind(i)),this.close()}),(function(){this.close()}))},reset:function(t,e){var i=this;this.app.confirm("infor",e,this.lp.resetStatusTitle,this.lp.resetStatusInfor,380,100,(function(){o2.Actions.get("x_query_assemble_designer").resetStatus(i.data.id,function(){this.app.notice(this.lp.resetStatus,"success"),this.model.reload(),this.reload()}.bind(i)),this.close()}),(function(){this.close()}))},remove:function(t,e){var i=this;this.app.confirm("infor",e,this.lp.removeTitle,this.lp.removeInfor,380,100,(function(){o2.Actions.get("x_query_assemble_designer").deleteModel(i.data.id,function(){var t=this.lp.deleteModel.replace("{name}",this.data.name);this.app.notice(t,"success");var e=this.model;e.unselected(),e.destroy()}.bind(i)),this.close()}),(function(){this.close()}))}});