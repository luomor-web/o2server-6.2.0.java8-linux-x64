MWF.xApplication.Forum=MWF.xApplication.Forum||{},MWF.xApplication.ForumDocument=MWF.xApplication.ForumDocument||{},MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Forum","Common",null,!1),MWF.xDesktop.requireApp("Forum","Attachment",null,!1),MWF.xDesktop.requireApp("Forum","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Forum","Access",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Template","MPopupForm",null,!1),MWF.xDesktop.requireApp("Forum","TopNode",null,!1),MWF.xApplication.ForumDocument.options={multitask:!0,executable:!0},MWF.xApplication.ForumDocument.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"ForumDocument",icon:"icon.png",width:"1324",height:"720",isResize:!0,isMax:!0,isNew:!1,isEdited:!0,index:1,replyIndex:null,viewPageNum:1,title:MWF.xApplication.ForumDocument.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Forum.LP},onQueryClose:function(){if(this.userCache)for(var t in this.userCache)delete this.userCache[t];this.userCache},loadApplication:function(t){this.userData=layout.desktop.session.user,this.userName=this.userData.distinguishedName,this.restActions=this.actions=MWF.Actions.get("x_bbs_assemble_control"),this.path="../x_component_ForumDocument/$Main/"+this.options.style+"/",this.selectstar=0,this.status&&this.setOptions(this.status),this.options.isNew&&!this.options.id?this.options.advanceId?(this.advanceId=this.options.advanceId,this.createNode(),this.loadApplicationContent()):this.actions.getUUID(function(t){this.advanceId=t,this.createNode(),this.loadApplicationContent()}.bind(this)):(this.createNode(),this.loadApplicationContent())},loadController:function(t){this.access=new MWF.xApplication.Forum.Access(this.restActions,this.lp),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:this.css.node}).inject(this.content)},loadApplicationContent:function(){this.loadController(function(){this.access.login(function(){this.loadApplicationLayout()}.bind(this))}.bind(this))},clearContent:function(){this.node.empty(),this.pagingBarTop=null,this.pagingContainerTop=null,delete this.pagingBarTop,delete this.pagingContainerTop},reload:function(t,e){this.node.empty(),this.pagingBarTop=null,this.pagingContainerTop=null,delete this.pagingBarTop,delete this.pagingContainerTop,this.loadApplicationLayout(),t&&e&&t!=e&&(delete this.desktop.apps[t],this.appId=e,this.desktop.apps[e]=this)},loadApplicationLayout:function(){this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node),this.options.id?this.restActions.listSubjectPermission(this.options.id,function(t){this.permission=t.data,this.options.isEdited?this.restActions.getSubject(this.options.id,function(t){this.data=t.data,this._loadApplicationLayout(this.data.sectionId,this.data.title)}.bind(this)):this.restActions.getSubjectView(this.options.id,function(t){this.data=t.data.currentSubject,this.nextSubject=t.data.nextSubject,this.lastSubject=t.data.lastSubject,this._loadApplicationLayout(this.data.sectionId,this.data.title)}.bind(this))}.bind(this)):this._loadApplicationLayout(this.options.sectionId,this.lp.createSubject)},_loadApplicationLayout:function(t,e){this.options.sectionId=t,this.restActions.listSectionPermission(t,function(i){this.sectionPermission=i.data,this.restActions.getSection(t,function(t){this.sectionData=t.data,this.restActions.getCategory(this.sectionData.forumId,function(t){this.forumData=t.data,this.createTopNode(e);var i=this.inBrowser&&MWFForum.getSystemConfigValue(MWFForum.BBS_TITLE_TAIL)||"";this.setTitle(e+i),this.createMiddleNode()}.bind(this))}.bind(this))}.bind(this))},createTopNode:function(t){var e=new MWF.xApplication.Forum.TopNode(this.contentContainerNode,this,this,{type:this.options.style});this.topNode=e,e.load();var i=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainerNode),s=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(i);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:MWFForum.getBBSName()||MWF.xApplication.Forum.LP.title}).inject(s).addEvent("click",function(){this.desktop.apps.Forum?this.desktop.apps.Forum.setCurrent():this.desktop.openApplication(null,"Forum",{appId:"Forum"}),this.inBrowser||this.close()}.bind(this));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(s);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.sectionData.forumName}).inject(s).addEvent("click",function(){var t="ForumCategory"+this.forumId;this.obj.desktop.apps[t]?this.obj.desktop.apps[t].setCurrent():this.obj.desktop.openApplication(null,"ForumCategory",{categoryId:this.forumId,appId:t}),this.obj.inBrowser||this.obj.close()}.bind({obj:this,forumId:this.sectionData.forumId}));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(s);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.sectionData.sectionName}).inject(s).addEvent("click",function(){var t="ForumSection"+this.sectionData.id;this.desktop.apps[t]?this.desktop.apps[t].setCurrent():this.desktop.openApplication(null,"ForumSection",{sectionId:this.sectionData.id,appId:t}),this.inBrowser||this.close()}.bind(this));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(s),new Element("div.topItemTitleNode",{styles:this.css.topItemTitleLastNode,text:this.options.isNew?this.lp.createSubject:"["+this.data.type+"]"+this.data.title}).inject(s)},createMiddleNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode),this.addEvent("resize",function(){this.setContentSize()}.bind(this)),this.setContentSize(),this.middleNode.addEvent("selectstart",(function(t){t.stopPropagation()})),this.options.isNew||this.options.isEdited?this._createMiddleNode_eidt():this._createMiddleNode_read()},_createMiddleNode_eidt:function(){this.data=this.data||{};this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleNode);var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableTitle' lable='title' width='10%' style='min-width:100px;'></td>   <td styles='formTableValue' item='typeCategory' width='10%'></td>   <td styles='formTableValue' item='type' width='10%'></td>   <td styles='formTableValue' item='title' width='70%'></td></tr><tr>   <td></td>   <td item='tipNode' colspan='3'></td></tr><tr>   <td styles='formTableTitle' lable='summary'></td>   <td styles='formTableValue' item='summary' colspan='3'></td></tr><tr item='portalImageTr' style='display:none'>   <td styles='formTableTitle' lable='picId'></td>   <td styles='formTableValue' colspan='3'><div item='picId' styles='portalImageAre' ></div></td></tr><tr>   <td styles='formTableTitle' lable='content'></td>   <td styles='formTableValue' item='content' colspan='3'></td></tr><tr style='display:none' item='gradeArea'>   <td styles='formTableTitle'>"+this.lp.sectionGrade+"</td>   <td item='gradeContainer' colspan='3'></td></tr><tr>   <td styles='formTableTitle'>"+this.lp.attachment+"</td>   <td item='attachment' colspan='3'></td></tr><tr style='display:none' item='voteArea'>   <td styles='formTableTitle'>"+this.lp.vote+"</td>   <td item='voteContainer' colspan='3'></td></tr><tr>   <td styles='formTableTitle' lable=''></td>   <td item='action' colspan='3'></td></tr></table>";this.contentDiv.set("html",t);var e,i,s=this.contentDiv.getElement("[item='tipNode']"),o=this._loadTypeSetting()[this.forumData.indexListStyle];o.image&&this.contentDiv.getElements("[item='portalImageTr']")[0].setStyle("display",""),e=this.sectionData.subjectTypeList&&this.sectionData.subjectTypeList.length>0?this.sectionData.subjectTypeList:this.sectionData.subjectType?this.sectionData.subjectType.split("|"):this.forumData.subjectType?this.forumData.subjectType.split("|"):this.lp.subjectTypeDefaultValue.split("|"),i=this.sectionData.typeCategory?this.sectionData.typeCategory.split("|"):this.forumData.typeCategory?this.forumData.typeCategory.split("|"):this.lp.typeCategoryDefaultValue.split("|"),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.contentDiv,this.data,{style:"forum",verifyType:"batch",isEdited:!0,itemTemplate:{title:{text:this.lp.subject,notEmpty:!0,onPostLoad:function(t){t.tipNode=s}},typeCategory:{type:"select",selectValue:i,notEmpty:!0,event:{change:function(t,e){t.getValue()==this.lp.vote||"投票"==t.getValue()?(this.contentDiv.getElements("[item='voteArea']").setStyle("display",""),this.loadVoteArea()):this.contentDiv.getElements("[item='voteArea']").setStyle("display","none")}.bind(this)}},type:{text:this.lp.type,type:"select",selectValue:e,notEmpty:!0},summary:{text:this.lp.summary,type:"text",event:{keyup:function(t,e){t.getValue().length>70&&t.setValue(t.getValue().substr(0,70))}}},picId:{text:this.lp.portalImage,type:"imageClipper",disable:!o.image,style:{imageStyle:this.css.portalImageNode,actionStyle:this.css.uploadActionNode},aspectRatio:1.5,reference:this.advanceId||this.data.id,referenceType:"forumDocument"},content:{text:this.lp.content,type:"rtf",notEmpty:!0,RTFConfig:{isSetImageMaxWidth:!0,reference:this.advanceId||this.data.id,referenceType:"forumDocument"}}}},this,this.css),this.form.load()}.bind(this),!0),this.data.typeCategory!=this.lp.vote&&"投票"!=this.data.typeCategory||(this.contentDiv.getElement("[item='voteArea']").setStyle("display",""),this.loadVoteArea()),this.sectionData.sectionGrade&&(this.contentDiv.getElements("[item='gradeArea']").setStyle("display",""),this.loadGradeArea());var n=this.contentDiv.getElements("[item='action']")[0];this.saveAction=new Element("div",{styles:this.css.actionNode,text:this.lp.saveSubject}).inject(n),this.saveAction.addEvent("click",function(t){this.saveSubject(t)}.bind(this));var a=this.contentDiv.getElements("[item='attachment']")[0];this.loadAttachment(a)},_loadTypeSetting:function(){var t;(MWF.xApplication.Forum.ColumnTemplate=MWF.xApplication.Forum.ColumnTemplate||{},MWF.xApplication.Forum.ColumnTemplate.Setting)?t=MWF.xApplication.Forum.ColumnTemplate.Setting:new Request.JSON({url:"../x_component_Forum/$ColumnTemplate/template/setting.json",secure:!1,async:!1,method:"get",noCache:!1,onSuccess:function(e,i){t=MWF.xApplication.Forum.ColumnTemplate.Setting=e}.bind(this),onError:function(t,e){alert(e+t)}}).send();return t},loadVoteArea:function(){this.voteContainer=this.contentDiv.getElement("[item='voteContainer']"),MWF.xDesktop.requireApp("ForumDocument","Vote",function(){this.vote=new MWF.xApplication.ForumDocument.Vote(this.voteContainer,this,{isNew:this.options.isNew,isEdited:this.options.isEdited},this.data),this.vote.load()}.bind(this),!0)},loadGradeArea:function(){this.gradeContainer=this.contentDiv.getElement("[item='gradeContainer']");for(var t,e=new Element("div").inject(this.gradeContainer),i=new Element("div").inject(e),s=new Element("div",{class:"comment_dlg_png"}).inject(i),o=this,n=0;n<5;n++)if((t=new Element("img",{src:o.path+"icon/whitefiveangular.png",class:n+"star comment_dlg_star"}).inject(s)).store("id",n),this.data.grade&&this.data.grade<6){if(this.data.grade>n)for(var a=t;a;)a.set("src",o.path+"icon/blackfiveangular.png"),a=a.previousElementSibling;o.selectstar=this.data.grade}else t.addEvents({click:function(t){var e=this.retrieve("id");o.selectstar=e+1;for(var i=this,s=this.nextElementSibling;s;)s.set("src",o.path+"icon/whitefiveangular.png"),s=s.nextElementSibling;for(;i;)i.set("src",o.path+"icon/blackfiveangular.png"),i=i.previousElementSibling}});new Element("div",{style:"clear:both"}).inject(e),new Element("div").inject(e)},reloadAllParents:function(){var t="Forum";this.desktop.apps[t]&&this.desktop.apps[t].reload&&this.desktop.apps[t].reload(),t="ForumCategory"+this.sectionData.forumId,this.desktop.apps[t]&&this.desktop.apps[t].reload&&this.desktop.apps[t].reload(),t="ForumSection"+this.sectionData.id,this.desktop.apps[t]&&this.desktop.apps[t].reload&&this.desktop.apps[t].reload()},saveSubject:function(t){var e=this,i=this.form.getResult(!0,",",!0,!1,!0);if(i)if(i.typeCategory==this.lp.vote||"投票"==i.typeCategory){var s=this.vote.getVoteInfor();if(!s)return;for(var o in s)i[o]=s[o];this.confirm("warn",t,this.lp.confirmPublishVoteDocumentTitle,this.lp.confirmPublishVoteDocumentContent,350,120,(function(){e._saveSubject(i),this.close()}),(function(){this.close()}))}else this._saveSubject(i);else{var n=this.form.getItem("typeCategory");n.getValue()!=this.lp.vote&&"投票"!=n.getValue()||this.vote.getVoteInfor()}},_saveSubject:function(t){this.advanceId&&(t.id=this.advanceId),t.attachmentList=this.attachment.getAttachmentIds(),this.sectionData.sectionGrade&&0==this.selectstar&&this.advanceId?MWF.xDesktop.notice("error",{x:"right",y:"top"},this.lp.gradeNotice):(t.grade=this.selectstar,t&&(t.sectionId=this.sectionData.id,this.restActions.saveSubject(t,function(t){this.notice(this.options.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success"),this.fireEvent("postPublish"),this.reloadAllParents();var e="ForumDocument"+(this.options.isNew?this.sectionData.id:this.data.id),i="ForumDocument"+t.data.id;this.advanceId="",this.setOptions({id:t.data.id,appId:i,isEdited:!1,isNew:!1}),this.reload(e,i)}.bind(this))))},_createMiddleNode_read:function(){this.isReplyPublisher=this.permission.replyPublishAble,this.createSidebar(),this.createPagingBar(),this.createToolbar_read();var t=new Element("div.subjectConainer",{styles:this.css.contentConainer}).inject(this.middleNode);this.subjectConainer=new Element("div.subjectConainer",{styles:this.css.subjectConainer}).inject(t),this.data.typeCategory!=this.lp.question&&"问题"!=this.data.typeCategory||(this.satisfiedReplyViewConainer=new Element("div.satisfiedReplyViewConainer",{styles:this.css.replyViewConainer}).inject(t)),this.replyViewConainer=new Element("div.replyViewConainer",{styles:this.css.replyViewConainer}).inject(t),this.createPagingBar(),this.createSubject(),this.data.typeCategory!=this.lp.question&&"问题"!=this.data.typeCategory||this.data.acceptReplyId&&this.createSatisfiedReplyView(),this.createReplyView(),!this.data.stopReply&&this.isReplyPublisher&&(this.access.isAnonymous()?this.createReplyEditor_Anonymous():this.createReplyEditor())},createPagingBar:function(){var t=new Element("div",{styles:this.css.pagingArea}).inject(this.middleNode);if(this.pagingBarTop?this.pagingBarBottom=t:this.pagingBarTop=t,this.sectionPermission.subjectPublishAble){var e=new Element("div",{styles:this.css.pagingActionNode,text:this.lp.createSubject}).inject(t);e.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.pagingActionNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.pagingActionNode)}.bind({obj:this,node:e}),click:function(){this.access.isAnonymousDynamic()?this.openLoginForm(function(){this.createNewDocument()}.bind(this)):this.createNewDocument()}.bind(this)})}var i=new Element("div").inject(t);this.pagingContainerTop?this.pagingContainerBottom=i:this.pagingContainerTop=i},setContentSize:function(){var t=this.node.getSize(),e=this.contentContainerNode.getStyle("padding-top").toFloat(),i=this.contentContainerNode.getStyle("padding-bottom").toFloat(),s=t.y-0-e-i;this.contentContainerNode.setStyle("height",s+"px")},recordStatus:function(){return{sectionId:this.options.sectionId,id:this.data?this.data.id:"",advanceId:this.advanceId,appId:this.data&&this.data.id?"ForumDocument"+this.data.id:"ForumDocument"+this.advanceId,isEdited:this.options.isEdited,isNew:this.options.isNew,viewPageNum:this.replyView?this.replyView.getCurrentPageNum():1}},loadAttachment:function(t){this.attachment=new MWF.xApplication.Forum.Attachment(t,this,this.restActions,this.lp,{documentId:this.advanceId||this.data.id,isNew:this.options.isNew,isEdited:this.options.isEdited,size:"min",onQueryUploadAttachment:function(){this.attachment.isQueryUploadSuccess=!0}.bind(this),onDelete:function(t){}.bind(this)}),this.attachment.load()},createToolbar_read:function(){this.toolBarReadTop=new Element("div.toolBarReadTop",{styles:this.css.toolBarReadTop}).inject(this.middleNode),this.toolBarRead=new Element("div.toolBarRead",{styles:this.css.toolBarRead}).inject(this.middleNode),this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(this.toolBarRead);var t=new Element("div.toolbarViewItem",{styles:this.css.toolbarViewItem}).inject(this.toolbarLeft);new Element("span.toolbarLeftTextItem",{styles:this.css.toolbarLeftTextItem,text:this.lp.readed+"："}).inject(t),new Element("span.toolbarLeftCountItem",{styles:this.css.toolbarLeftCountItem,text:this.data.viewTotal}).inject(t),new Element("div.toolbarSepItem",{styles:this.css.toolbarSepItem}).inject(this.toolbarLeft);t=new Element("div.toolbarReplyItem",{styles:this.css.toolbarReplyItem}).inject(this.toolbarLeft);new Element("span.toolbarLeftTextItem",{styles:this.css.toolbarLeftTextItem,text:this.lp.reply+"："}).inject(t),this.replyTotal=new Element("span.toolbarLeftCountItem",{styles:this.css.toolbarLeftCountItem,text:this.data.replyTotal}).inject(t),this.toolbarRight=new Element("div.toolbarRight",{styles:this.css.toolbarRight}).inject(this.toolBarRead),this.data.isTopSubject?new Element("div.top",{styles:this.css.toolbarZhiding,title:this.lp.setTop}).inject(this.toolbarRight):this.data.isCreamSubject?new Element("div.prime",{styles:this.css.toolbarPrime,title:(this.data.screamSetterName||"").split("@")[0]+this.lp.at+this.data.screamSetterTime+this.lp.setPrime}).inject(this.toolbarRight):this.data.typeCategory==this.lp.vote||"投票"==this.data.typeCategory?new Element("div.vote",{styles:this.css.toolbarVote,title:this.lp.vote}).inject(this.toolbarRight):this.data.typeCategory!=this.lp.question&&"问题"!=this.data.typeCategory||new Element("div.question",{styles:this.css.toolbarQuestion,title:this.lp.question}).inject(this.toolbarRight),this.toolbarRightTitle=new Element("div.toolbarRightTitle",{styles:this.css.toolbarRightTitle,text:"["+this.data.type+"]"+this.data.title}).inject(this.toolbarRight),this.toolbarRightTools=new Element("div.toolbarRightTools",{styles:this.css.toolbarRightTools}).inject(this.toolbarRight),this.nextSubject&&(this.toolbarNext=new Element("div.toolbarNext",{styles:this.css.toolbarNext,title:this.lp.nextSubject+"："+this.nextSubject.title}).inject(this.toolbarRightTools),this.toolbarNext.addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.toolbarNext.setStyles(this.css.toolbarNext_over)}.bind(this),mouseout:function(){this.toolbarNext.setStyles(this.css.toolbarNext)}.bind(this)})),this.lastSubject&&(this.toolbarPrev=new Element("div.toolbarRightTools",{styles:this.css.toolbarPrev,title:this.lp.prevSubject+"："+this.lastSubject.title}).inject(this.toolbarRightTools),this.toolbarPrev.addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.toolbarPrev.setStyles(this.css.toolbarPrev_over)}.bind(this),mouseout:function(){this.toolbarPrev.setStyles(this.css.toolbarPrev)}.bind(this)}))},adjustReplyCount:function(t){this.data.replyTotal=this.data.replyTotal+t,this.replyTotal.set("text",this.data.replyTotal)},createNewDocument:function(){var t="ForumDocument"+this.sectionData.id;this.desktop.apps[t]?this.desktop.apps[t].setCurrent():this.desktop.openApplication(null,"ForumDocument",{sectionId:this.sectionData.id,appId:t,isNew:!0,isEdited:!0,onPostPublish:function(){}.bind(this)})},edit:function(){var t="ForumDocument"+this.data.id;this.options.isEdited=!0,this.reload(t,t)},delete:function(t){var e=this;this.confirm("warn",t,this.lp.deleteDocumentTitle,this.lp.deleteDocument,350,120,(function(){e.restActions.deleteSubject(e.data.id,function(){e.notice(e.lp.deleteDocumentOK,"ok"),e.reloadAllParents(),e.close()}.bind(this)),this.close()}),(function(){this.close()}))},postCreateReply:function(t){this.restActions.getReply(t,function(t){var e=this.replyView._createDocument(t.data);this.adjustReplyCount(1);var i=e.node.getTop()-this.contentContainerNode.getCoordinates().top+this.contentContainerNode.scrollTop.toFloat();this.contentContainerNode.scrollTo(0,i)}.bind(this))},createReply:function(){var t=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:!0,onPostOk:function(t){this.postCreateReply(t)}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions});t.mainData=this.data,t.create()},createActionBar:function(t){this.actionBar=new Element("div",{styles:this.css.actionBar,html:"&nbsp;"}).inject(t),this.permission.manageAble&&(this.data.isCreamSubject?(action=new Element("div",{styles:this.css.actionItem,text:this.lp.cancelPrime}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_cancelprime.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.cancelPrime()}.bind(this)})):(action=new Element("div",{styles:this.css.actionItem,text:this.lp.setPrime}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_prime.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setPrime()}.bind(this)})),action=new Element("div",{styles:this.css.actionItem,text:this.lp.moveto}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_moveto.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.moveTo()}.bind(this)}),this.data.stopReply?(action=new Element("div",{styles:this.css.actionItem,text:this.lp.unlock}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_unlock.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.unlock()}.bind(this)})):(action=new Element("div",{styles:this.css.actionItem,text:this.lp.lock}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_lock.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.lock()}.bind(this)})),action=new Element("div",{styles:this.css.actionItem,text:this.lp.setTop}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+(this.data.isTopSubject?"icon/action_canceltop.png":"icon/action_top.png")+")"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setTop()}.bind(this)})),MWF.AC.isHotPictureManager()&&(action=new Element("div",{styles:this.css.actionItem,text:this.lp.setHot}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_popular.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setHotPicture()}.bind(this)})),this.permission.recommendAble&&(this.data.recommendToBBSIndex?(action=new Element("div",{styles:this.css.actionItem,text:this.lp.cancelRecommend}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_cancelrecommend.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.cancelRecommend()}.bind(this)})):this.sectionData.sectionVisible==this.lp.allPerson&&1==this.sectionData.indexRecommendable&&(action=new Element("div",{styles:this.css.actionItem,text:this.lp.setRecommend}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_recommend.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setRecommend()}.bind(this)}))),(this.permission.manageAble||this.permission.editAble||this.data.creatorName==this.userName)&&(action=new Element("div",{styles:this.css.actionItem,text:this.lp.delete}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_delete.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(t){this.delete(t)}.bind(this)})),this.data.typeCategory!=this.lp.vote&&"投票"!=this.data.typeCategory&&(this.permission.manageAble||this.permission.editAble||this.data.creatorName==this.userName)&&(action=new Element("div",{styles:this.css.actionItem,text:this.lp.edit}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_edit.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.edit()}.bind(this)})),this.data.stopReply||this.isReplyPublisher&&(action=new Element("div",{styles:this.css.actionItem,text:this.lp.reply}).inject(this.actionBar),action.setStyle("background-image","url("+this.path+"icon/action_quote.png)"),action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.access.isAnonymousDynamic()?this.openLoginForm(function(){this.reload()}.bind(this)):this.createReply()}.bind(this)}))},lock:function(){this.restActions.lock(this.data.id,function(){this.notice(this.lp.lockSuccess),this.reload()}.bind(this))},unlock:function(){this.restActions.unlock(this.data.id,function(){this.notice(this.lp.unlockSuccess),this.reload()}.bind(this))},setRecommend:function(){this.restActions.setRecommend(this.data.id,function(){this.notice(this.lp.setRecommendSuccess),this.reload()}.bind(this))},cancelRecommend:function(){this.restActions.cancelRecommend(this.data.id,function(){this.notice(this.lp.cancelRecommendSuccess),this.reload()}.bind(this))},setHotPicture:function(){MWF.xDesktop.requireApp("ForumDocument","HotLinkForm",null,!1),new MWF.xApplication.ForumDocument.HotLinkForm(this,this.data,{documentId:this.data.id,summary:this.data.summary,onPostOk:function(t){}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions}).create()},setTop:function(){new MWF.xApplication.ForumDocument.TopSettingForm(this,this.data,{onPostOk:function(t){this.reload()}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions}).create()},cancelTop:function(){this.restActions.cancelTopToSection(this.data.id,function(){this.notice(this.lp.cancelTopSuccess),this.reload()}.bind(this))},setPrime:function(){this.restActions.setCream(this.data.id,function(){this.notice(this.lp.setPrimeSuccess),this.reload()}.bind(this))},cancelPrime:function(){this.restActions.cancelCream(this.data.id,function(){this.notice(this.lp.cancelPrimeSuccess),this.reload()}.bind(this))},createSubject:function(){this.subjectView=new MWF.xApplication.ForumDocument.SubjectView(this.subjectConainer,this,this,{templateUrl:this.path+"listItemSubject.json",scrollEnable:!1}),this.subjectView.data=this.data,this.subjectView.load()},moveTo:function(){MWF.xDesktop.requireApp("Forum","SectionSelector",null,!1),new MWF.xApplication.Forum.SectionSelector(this.content,{count:1,title:this.lp.selectTargetSection,values:[],onComplete:function(t){if("array"==typeOf(t)){var e=t[0].data.id;this.restActions.changeSection({subjectIds:[this.data.id],sectionId:e},function(){this.notice(this.lp.moveSuccess.replace("{section}",t[0].data.name)),this.reload()}.bind(this))}}.bind(this)}).load()},openLoginForm:function(){MWF.require("MWF.xDesktop.Authentication",null,!1);var t=new MWF.xDesktop.Authentication({style:"flat",popupStyle_password:"o2platformSignupFlat",onPostOk:function(){callback&&callback()}},this);t.popupOptions={draggable:!0,closeAction:!0,hasMask:!0,relativeToApp:!0,width:"420",height:"640"},t.openLoginForm()},openSignUpForm:function(){MWF.require("MWF.xDesktop.Authentication",null,!1);var t=new MWF.xDesktop.Authentication({style:"flat",popupStyle_password:"o2platformSignupFlat",onPostOk:function(){callback&&callback()}},this);t.popupOptions={draggable:!0,closeAction:!0,hasMask:!0,relativeToApp:!0,width:"420",height:"640"},t.openSignUpForm()},gotoReply:function(t){this.replyView.paging.gotoItem(t)},createSatisfiedReplyView:function(){this.satisfiedReplyView=new MWF.xApplication.ForumDocument.SatisfiedReplyView(this.satisfiedReplyViewConainer,this,this,{templateUrl:this.path+"listItemSatisfied.json",scrollEnable:!1}),this.satisfiedReplyView.data=this.data,this.satisfiedReplyView.load()},createReplyView:function(){this.replyView=new MWF.xApplication.ForumDocument.ReplyView(this.replyViewConainer,this,this,{templateUrl:this.path+"listItemReply.json",scrollEnable:!1,pagingEnable:!0,documentKeyWord:"orderNumber",pagingPar:{currentPage:this.options.viewPageNum||1,currentItem:this.options.replyIndex,returnText:this.lp.returnToList,countPerPage:10,onPostLoad:function(t){t.nextPageNode&&t.nextPageNode.inject(this.pagingBarBottom,"before")}.bind(this),onPageReturn:function(t){var e="ForumSection"+this.sectionData.id;this.desktop.apps[e]?this.desktop.apps[e].setCurrent():this.desktop.openApplication(null,"ForumSection",{sectionId:this.sectionData.id,appId:e}),this.close()}.bind(this)},onGotoItem:function(t){var e=t-this.content.getTop();this.contentContainerNode.scrollTo(0,e)}.bind(this)}),this.replyView.pagingContainerTop=this.pagingContainerTop,this.replyView.pagingContainerBottom=this.pagingContainerBottom,this.replyView.data=this.data,this.replyView.filterData={subjectId:this.data.id},this.replyView.load()},createReplyEditor_Anonymous:function(){this.replyArea=new Element("div.replyArea",{styles:this.css.replyArea}).inject(this.middleNode),new Element("div.replyLeft",{styles:this.css.replyLeft}).inject(this.replyArea);var t=new Element("div.replyPicture",{styles:this.css.replyPicture}).inject(this.replyArea),e=new Element("div.replyNeedLogin",{styles:this.css.replyNeedLogin}).inject(t);(new Element("div.replyNeedLogin",{styles:this.css.replyNeedLoginText,text:this.lp.replyNeedLoginText}).inject(e),new Element("div.replyLoginAction",{styles:this.css.replyLoginAction,text:this.lp.login}).inject(e).addEvent("click",function(){this.openLoginForm(function(){this.reload()}.bind(this))}.bind(this)),"disable"!=this.access.signUpMode)&&(new Element("div.replyNeedLogin",{styles:this.css.replyNeedLoginText,text:"|"}).inject(e),new Element("div.replyLoginAction",{styles:this.css.replyLoginAction,text:this.lp.signUp}).inject(e).addEvent("click",function(){this.openSignUpForm()}.bind(this)))},createReplyEditor:function(){this.replyArea=new Element("div.replyArea",{styles:this.css.replyArea}).inject(this.middleNode),this.replyEditor=new MWF.xApplication.ForumDocument.ReplyEditor(this.replyArea,this,{style:this.options.style,isNew:!0,onPostOk:function(t){this.postCreateReply(t)}.bind(this)}),this.replyEditor.mainData=this.data,this.replyEditor.load()},createTurnSubjectNode:function(){if(this.lastSubject||this.nextSubject){var t=new Element("div.turnSubjectNode",{styles:this.css.turnSubjectNode}).inject(this.middleNode);if(this.lastSubject)(e=new Element("div.lastSubjectNode",{styles:this.css.lastSubjectNode,text:this.lp.prevSubject+"："+this.lastSubject.title}).inject(t)).addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.node.setStyles(this.obj.css.lastSubjectNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.lastSubjectNode)}.bind({obj:this,node:e})});else var e=new Element("div.lastSubjectNode",{styles:this.css.lastSubjectNoneNode}).inject(t);if(this.nextSubject)(i=new Element("div.nextSubjectNode",{styles:this.css.nextSubjectNode,text:this.lp.nextSubject+"："+this.nextSubject.title}).inject(t)).addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.node.setStyles(this.obj.css.nextSubjectNode_over)}.bind({obj:this,node:i}),mouseout:function(){this.node.setStyles(this.obj.css.nextSubjectNode)}.bind({obj:this,node:i})});else var i=new Element("div.nextSubjectNode",{styles:this.css.nextSubjectNoneNode}).inject(t)}},gotoDocument:function(t){if(1==t)var e=this.nextSubject;else e=this.lastSubject;var i="ForumDocument"+this.data.id,s="ForumDocument"+e.id;this.desktop.apps[s]?this.desktop.apps[s].setCurrent():(this.setOptions({sectionId:null,id:e.id,appId:s,isEdited:!1,isNew:!1}),this.reload(i,s))},createSidebar:function(){if(this.inBrowser){var t=this.middleNode.getCoordinates();this.sideBar=new Element("div.sideBar",{styles:{position:"fixed",left:t.right+4+"px",bottom:"100px",width:"50px",height:"155px","padding-top":"10px","text-align":"center","background-color":"#fff","box-shadow":"0 0 4px rgba(0,0,0,0.20)"}}).inject(this.middleNode),window.onresize=function(){var t=this.middleNode.getCoordinates();this.sideBar.setStyles({left:t.right+4+"px"})}.bind(this)}else{var e=this.content.getCoordinates(),i=this.middleNode.getCoordinates();this.sideBar=new Element("div.sideBar",{styles:{position:"fixed",top:e.top+e.height-220+"px",left:i.right+4+"px",width:"50px",height:"155px","padding-top":"10px","text-align":"center","background-color":"#fff","box-shadow":"0 0 4px #ccc"}}).inject(this.middleNode),this.addEvent("moveDrop",function(){var t=this.content.getCoordinates(),e=this.middleNode.getCoordinates();this.sideBar.setStyles({top:t.top+t.height-220+"px",left:e.right+4+"px"})}.bind(this)),this.addEvent("resize",function(){var t=this.content.getCoordinates(),e=this.middleNode.getCoordinates();this.sideBar.setStyles({top:t.top+t.height-220+"px",left:e.right+4+"px"})}.bind(this))}this._createSidebar()},_createSidebar:function(){var t=1,e=new Element("div",{styles:this.css.sidebarTop,title:this.lp.gotoTop}).inject(this.sideBar);if(e.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.sidebarTop_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.sidebarTop)}.bind({obj:this,node:e}),click:function(){this.contentContainerNode.scrollTo(0,0)}.bind(this)}),this.sectionPermission.subjectPublishAble){t++;var i=new Element("div",{styles:this.css.sidebarCreate,title:this.lp.createSubject}).inject(this.sideBar);i.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.sidebarCreate_over)}.bind({obj:this,node:i}),mouseout:function(){this.node.setStyles(this.obj.css.sidebarCreate)}.bind({obj:this,node:i}),click:function(){this.access.isAnonymousDynamic()?this.openLoginForm(function(){this.createNewDocument()}.bind(this)):this.createNewDocument()}.bind(this)})}if(!this.data.stopReply&&this.isReplyPublisher){t++;var s=new Element("div",{styles:this.css.sidebarReply,title:this.lp.reply}).inject(this.sideBar);s.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.sidebarReply_over)}.bind({obj:this,itemNode:s}),mouseout:function(){this.itemNode.setStyles(this.obj.css.sidebarReply)}.bind({obj:this,itemNode:s}),click:function(){this.access.isAnonymousDynamic()?this.openLoginForm(function(){this.reload()}.bind(this)):this.createReply()}.bind(this)})}var o=new Element("div",{}).inject(this.sideBar);this.nextSubject&&(t++,this.sidebarNext=new Element("div.sidebarNext",{styles:this.css.sidebarNext,title:this.lp.nextSubject+"："+this.nextSubject.title}).inject(o),this.sidebarNext.addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.sidebarNext.setStyles(this.css.sidebarNext_over)}.bind(this),mouseout:function(){this.sidebarNext.setStyles(this.css.sidebarNext)}.bind(this)})),this.lastSubject&&(t++,this.sidebarPrev=new Element("div.sidebarPrev",{styles:this.css.sidebarPrev,title:this.lp.prevSubject+"："+this.lastSubject.title}).inject(o),this.sidebarPrev.addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.sidebarPrev.setStyles(this.css.sidebarPrev_over)}.bind(this),mouseout:function(){this.sidebarPrev.setStyles(this.css.sidebarPrev)}.bind(this)})),this.sideBar.setStyle("height",30*t+5+"px")},openPerson:function(t){var e="ForumPerson"+t;this.desktop.apps[t]?this.desktop.apps[t].setCurrent():this.desktop.openApplication(null,"ForumPerson",{personName:t,appId:e})},createPersonNode:function(t,e){var i=e.split(",");i.each(function(e,s){var o=new Element("span",{text:e,styles:this.css.person}).inject(t);o.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.person_over)}.bind({node:o,obj:this}),mouseout:function(){this.node.setStyles(this.obj.css.person)}.bind({node:o,obj:this}),click:function(){this.obj.openPerson(this.userName)}.bind({userName:e,obj:this})}),s!=i.length-1&&new Element("span",{text:","}).inject(t)}.bind(this))},getUserData:function(t,e){if(this.userCache&&this.userCache[t])e&&e(this.userCache[t]);else if(this.userCache||(this.userCache={}),this.access.isAnonymous()){var i=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);if(i){var s={data:{icon:i}};this.userCache[t]=s,e&&e(s)}else{s={data:{icon:"../x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}};this.userCache[t]=s,e&&e(s)}}else MWF.Actions.get("x_organization_assemble_control").getPerson(function(i){i.data||(i.data={});var s=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);s?i.data&&(i.data.icon=s,this.userCache[t]=i,e&&e(i)):i.data&&(i.data.icon="../x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif",this.userCache[t]=i,e&&e(i))}.bind(this),function(){var i={data:{icon:"../x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}};this.userCache[t]=i,e&&e(i)}.bind(this),t,!0)}}),MWF.xApplication.ForumDocument.SubjectView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){var i;return t.index=e,this.getUserData(t.creatorName,function(e){t.userIcon=e.data.icon,t.signature=e.data.signature,this.actions.getUserInfor({userName:t.creatorName},function(e){t.subject=e.data.subjectCount,t.reply=e.data.replyCount,t.todaySubject=e.data.subjectCountToday,t.todayReply=e.data.replyCountToday,t.prime=e.data.creamCount,t.accessed=e.data.popularity,i=new MWF.xApplication.ForumDocument.SubjectDocument(this.viewNode,t,this.explorer,this,null,t.index)}.bind(this))}.bind(this)),i},getUserData:function(t,e){this.app.getUserData(t,e)},_getCurrentPageData:function(t,e){var i={type:"success",count:1,size:1,data:[this.data]};t&&t(i)},_removeDocument:function(t,e){this.actions.deleteSection(t.id,function(t){this.reload(),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ForumDocument.SubjectDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(t,e){},mouseoutSubject:function(t,e){},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElement("[item='itemSubjectTools']");if(this.app.createActionBar(i),this.data.grade&&this.data.grade<6)for(var s=new Element("div",{class:"comment_dlg_png"}).inject(t.getElements("[item='grade']")[0]),o=0;o<5;o++)if(starnode=new Element("img",{src:this.app.path+"icon/whitefiveangular.png",class:o+"star comment_dlg_star"}).inject(s),starnode.store("id",o),this.data.grade>o)for(var n=starnode;n;)n.set("src",this.app.path+"icon/blackfiveangular.png"),n=n.previousElementSibling;if(this.data.attachmentList&&this.data.attachmentList.length>0){var a=t.getElement("[item='attachment']");this.app.loadAttachment(a)}if(this.data.typeCategory==this.lp.vote||"投票"==this.data.typeCategory){var c=t.getElement("[item='vote']");MWF.xDesktop.requireApp("ForumDocument","Vote",function(){this.vote=new MWF.xApplication.ForumDocument.Vote(c,this.app,{isNew:!1,isEdited:!1},this.data),this.vote.load()}.bind(this),!0)}},sendMessage:function(t,e){var i=this;if(layout.desktop.widgets.IMIMWidget){var s=layout.desktop.widgets.IMIMWidget;s.getOwner(function(){this.openChat(e,{from:i.data.creatorName})}.bind(s))}},createReply:function(t,e){if(this.app.access.isAnonymousDynamic())this.app.openLoginForm(function(){this.app.reload()}.bind(this));else{var i=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:!0,onPostOk:function(t){this.app.postCreateReply(t)}.bind(this)});i.mainData=this.data,i.create()}}}),MWF.xApplication.ForumDocument.ReplyEditor=new Class({Implements:[Options,Events],options:{style:"default",isNew:!0},initialize:function(t,e,i){this.setOptions(i),this.node=t,this.app=e},load:function(){this.app.restActions.getUUID(function(t){this.advanceReplyId=t,this._load()}.bind(this))},_load:function(){this.node.set("html","<div styles='itemNode'> <div styles='itemLeftNode'>   <div styles='itemUserFace'>     <div styles='itemUserIcon' item='userIcon'>     </div>   </div>   <div styles='replyUserName' item='creatorName'>   </div> </div> <div styles='replyRightNode'>   <div styles='itemRightMidle'>     <div styles='itemBodyReply' item='content'></div>     <div styles='itemBodyReply' item='action'></div>   </div> </div></div>");var t=this.node.getElements("[item='action']")[0];this.saveReplyAction=new Element("div",{styles:this.app.css.actionNode,text:this.app.lp.saveReply}).inject(t),this.saveReplyAction.addEvent("click",function(){this.saveReply()}.bind(this)),MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.node,this.data||{},{style:"forum",isEdited:!0,itemTemplate:{userIcon:{className:"itemUserIcon2",type:"img",value:function(){if(this.app.userData.icon)return"data:image/png;base64,"+this.app.userData.icon;var t="../x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif";return this.app.getUserData(this.app.userData.distinguishedName,function(e){t=e.data.icon}.bind(this),(function(){this.options.style}),!1),t}.bind(this)},creatorName:{type:"innerText",value:(this.app.userName||"").split("@")[0]},content:{type:"rtf",RTFConfig:{resize_enabled:!1,isSetImageMaxWidth:!0,reference:this.advanceReplyId,referenceType:"forumReply",toolbar:[{name:"document",items:["Preview"]},{name:"basicstyles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"links",items:["Link","Unlink"]},{name:"insert",items:["Image"]},{name:"tools",items:["Maximize","-","About"]}]}}}},this,this.app.css),this.form.load()}.bind(this),!0)},saveReply:function(){var t=this.form.getResult(!0,",",!0,!1,!0);t&&(t.subjectId=this.mainData.id,t.id=this.advanceReplyId,this.app.restActions.saveReply(t,function(t){"error"==t.type?this.app.notice(t.message,"error"):(this.app.restActions.getUUID(function(t){this.advanceReplyId=t}.bind(this)),this.app.notice(this.app.lp.saveReplySuccess,"ok"),this.form.getItem("content").setValue(""),this.fireEvent("postOk",t.data.id))}.bind(this)))}}),MWF.xApplication.ForumDocument.ReplyForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"860",height:"470",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!0,title:MWF.xApplication.Forum.LP.replyFormTitle,draggable:!0,closeAction:!0,toMain:!0},_createTableContent:function(){this.isNew?this.app.restActions.getUUID(function(t){this.advanceReplyId=t,this._createTableContent_()}.bind(this)):this._createTableContent_()},_createTableContent_:function(){if(this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableValue14' item='mainSubject'></td></tr><tr>   <td styles='formTableValue' item='mainContent'></td></tr><tr>   <td styles='formTableValue' item='content'></td></tr></table>"),!this.options.toMain&&this.parentData){var t=this.formTableArea.getElements("[item='mainContent']")[0],e=new Element("div",{styles:this.css.quoteTop}).inject(t);new Element("div",{styles:this.css.quoteLeft}).inject(e),new Element("div",{styles:this.css.quoteInfor,text:this.parentData.creatorName.split("@")[0]+this.lp.publishAt+this.parentData.createTime}).inject(e);var i=new Element("div",{styles:this.css.quoteBottom}).inject(t),s=this.parentData.contentText;new Element("div",{styles:this.css.quoteText,text:s.length>50?s.substr(0,50)+"...":s}).inject(i),new Element("div",{styles:this.css.quoteRight}).inject(i)}MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"forum",isEdited:!0,itemTemplate:{mainSubject:{type:"innertext",defaultValue:"RE:"+this.mainData.title},content:{type:"rtf",RTFConfig:{resize_enabled:!1,isSetImageMaxWidth:!0,reference:this.advanceReplyId||this.data.id,referenceType:"forumReply",toolbar:[{name:"document",items:["Preview"]},{name:"basicstyles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"links",items:["Link","Unlink"]},{name:"insert",items:["Image"]},{name:"tools",items:["Maximize","-","About"]}]}}}},this.app,this.css),this.form.load()}.bind(this),!0)},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.saveReply}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))),this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,",",!0,!1,!0);e&&this._ok(e,function(t){"error"==t.type?this.app.notice(t.message,"error"):(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app.notice(this.isNew?this.app.lp.createReplySuccess:this.app.lp.updateSuccess,"success"),this.fireEvent("postOk",t.data.id))}.bind(this))},_ok:function(t,e){t.subjectId=this.mainData.id,this.advanceReplyId&&(t.id=this.advanceReplyId),this.options.toMain||(t.parentId=this.parentData.id),this.app.restActions.saveReply(t,function(t){e&&e(t)}.bind(this))}}),MWF.xApplication.ForumDocument.ReplyView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return t.index=e,new MWF.xApplication.ForumDocument.ReplyDocument(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=10),i||(i=1),1==i?(this.app.subjectConainer.setStyle("display","block"),this.app.satisfiedReplyViewConainer&&this.app.satisfiedReplyViewConainer.setStyle("display","block")):(this.app.subjectConainer.setStyle("display","none"),this.app.satisfiedReplyViewConainer&&this.app.satisfiedReplyViewConainer.setStyle("display","none"));var s=this.filterData||{};this.actions.listReplyFilterPage(i,e,s,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteReply(t.id,function(){this.reload(),this.app.notice(this.lp.deleteReplySuccess,"ok")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ForumDocument.ReplyDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(t,e){},mouseoutSubject:function(t,e){},getUserData:function(t,e){this.app.getUserData(t,e)},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElements("[item='userIcon']")[0],s=t.getElements("[item='signatureContainer']")[0];if(this.getUserData(e.creatorName,function(t){(i.src=t.data.icon,t.data.signature&&""!=t.data.signature)?s.getElements("[item='signature']")[0].set("text",t.data.signature):s.destroy()}.bind(this)),this.actions.getUserInfor({userName:e.creatorName},function(e){var i=e.data;t.getElements("[item='subject']")[0].set("text",i.subjectCount),t.getElements("[item='reply']")[0].set("text",i.replyCount),t.getElements("[item='prime']")[0].set("text",i.creamCount),t.getElements("[item='todaySubject']")[0].set("text",i.subjectCountToday),t.getElements("[item='todayReply']")[0].set("text",i.replyCountToday)}.bind(this)),e.parentId&&""!=e.parentId){var o=t.getElements("[item='quoteContent']")[0];this.actions.getReply(e.parentId,function(t){var e=this.parentData=t.data,i=new Element("div",{styles:this.css.itemQuote}).inject(o),s=i.set("html",e.content).get("text");i.empty(),e.contentText=s,new Element("div",{styles:this.css.quoteLeftBig}).inject(i);var n=new Element("div",{styles:this.css.quoteAreaBig}).inject(i);new Element("div",{styles:this.css.quoteInforBig,text:e.orderNumber+this.lp.floor+"："+e.creatorName.split("@")[0]+this.lp.publishAt+e.createTime}).inject(n).addEvent("click",function(){this.obj.app.gotoReply(this.index)}.bind({obj:this,index:e.orderNumber||e.index+2})),new Element("div",{styles:this.css.quoteTextBig,text:s.length>100?s.substr(0,100)+"...":s}).inject(n),new Element("div",{styles:this.css.quoteRightBig}).inject(i)}.bind(this),function(t){new Element("div",{styles:this.css.replyBeinngDelete,text:this.lp.quoteReplyBeingDeleted}).inject(o)}.bind(this))}},sendMessage:function(t,e){var i=this;if(layout.desktop.widgets.IMIMWidget){var s=layout.desktop.widgets.IMIMWidget;s.getOwner(function(){this.openChat(e,{from:i.data.creatorName})}.bind(s))}},createReply:function(t,e){if(this.app.access.isAnonymousDynamic())this.app.openLoginForm(function(){this.app.reload()}.bind(this));else{var i=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:!1,onPostOk:function(t){this.app.postCreateReply(t)}.bind(this)});this.data.contentText=this.node.getElements("[item='content']")[0].get("text"),i.mainData=this.app.data,i.parentData=this.data,i.create()}},editReply:function(t,e){var i=new MWF.xApplication.ForumDocument.ReplyForm(this,this.data,{toMain:!this.data.parentId||""==this.data.parentId,onPostOk:function(t){this.actions.getReply(t,function(t){this.node.getElements("[item='content']")[0].set("html",t.data.content)}.bind(this))}.bind(this)});i.mainData=this.app.data,i.parentData=this.parentData,i.edit()},deleteReply:function(t,e){var i=this;this.app.confirm("warn",e,this.lp.deleteReplyTitle,this.lp.deleteReplyText,350,120,(function(){i.actions.deleteReply(i.data.id,function(){"recursively"===MWFForum.getSystemConfigValue("BBS_REPLY_DELETETYPE").toLowerCase()?(i.destroy(),i.app.adjustReplyCount(-1),i.view.reload(),i.app.notice(i.lp.deleteReplySuccess,"ok")):(i.destroy(),i.app.adjustReplyCount(-1),i.app.notice(i.lp.deleteReplySuccess,"ok"))}.bind(this)),this.close()}),(function(){this.close()}))},satisfiedAction:function(){this.actions.acceptReply({id:this.data.id},function(){this.app.notice(this.lp.acceptReplySuccess,"ok"),this.app.reload()}.bind(this))}}),MWF.xApplication.ForumDocument.SatisfiedReplyView=new Class({Extends:MWF.xApplication.ForumDocument.ReplyView,_createDocument:function(t,e){return t.index=e,new MWF.xApplication.ForumDocument.SatisfiedReplyDocument(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=1),i||(i=1);this.filterData;this.actions.getAcceptedReply(this.data.acceptReplyId,function(e){e.data?"object"==typeOf(e.data)&&(e.data=[e.data],e.count=1):e.data=[],e.count||(e.count=0),t&&t(e)}.bind(this))}}),MWF.xApplication.ForumDocument.SatisfiedReplyDocument=new Class({Extends:MWF.xApplication.ForumDocument.ReplyDocument}),MWF.xApplication.ForumDocument.TopSettingForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"420",height:"250",hasTop:!0,hasIcon:!1,hasTopIcon:!0,hasTopContent:!0,hasBottom:!0,title:MWF.xApplication.Forum.LP.topFormTitle,draggable:!0,closeAction:!0},createTopNode:function(){this.formTopNode||(this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode),this.options.hasTopIcon&&(this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNodeDocument}).inject(this.formTopNode)),this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNodeTopSetting,text:this.options.title}).inject(this.formTopNode),this.options.closeAction&&(this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode),this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))))},_createTableContent:function(){this.formTableArea.set("html","<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr>   <td styles='formTableValue' style='font-size:14px;' lable='topType'></td></tr><tr>   <td styles='formTableValue' item='topToForum'></td></tr><tr>   <td styles='formTableValue' item='topToSection'></td></tr></table>"),this.topToBBS=this.data.topToBBS,this.topToForum=this.data.topToForum,this.topToSection=this.data.topToSection,MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"forum",isEdited:this.isEdited||this.isNew,itemTemplate:{topType:{text:this.lp.topType},topToForum:{type:"checkbox",selectValue:["true"],selectText:[this.lp.topToForum]},topToSection:{type:"checkbox",selectValue:["true"],selectText:[this.lp.topToSection]}}},this.app,this.css),this.form.load()}.bind(this),!0)},_createBottomContent:function(){(this.isNew||this.isEdited)&&(this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.ok}).inject(this.formBottomNode),this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))),this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.close}).inject(this.formBottomNode),this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(!0,",",!0,!1,!0);if(e){var i=!0;!0===e.topToForum||"true"===e.topToForum?this.actions.topToForum(this.app.data.id,(function(t){"error"==t.type&&(this.app.notice(t.message,"error"),i=!1)}),(function(){i=!1}),!1):!0!==this.topToForum&&"true"!==this.topToForum||this.actions.cancelTopToForum(this.app.data.id,(function(t){"error"==t.type&&(this.app.notice(t.message,"error"),i=!1)}),(function(){i=!1}),!1),!0===e.topToSection||"true"===e.topToSection?this.actions.topToSection(this.app.data.id,(function(t){"error"==t.type&&(this.app.notice(t.message,"error"),i=!1)}),(function(){i=!1}),!1):!0!==this.topToSection&&"true"!==this.topToSection||this.actions.cancelTopToSection(this.app.data.id,(function(t){"error"==t.type&&(this.app.notice(t.message,"error"),i=!1)}),(function(){i=!1}),!1),i?(this.formMaskNode&&this.formMaskNode.destroy(),this.formAreaNode.destroy(),this.app.notice(this.app.lp.setTopSuccess),this.fireEvent("postOk")):this.app.notice(this.app.lp.setToFail,"error")}}});