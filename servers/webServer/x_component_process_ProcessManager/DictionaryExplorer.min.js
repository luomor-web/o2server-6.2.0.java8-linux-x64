MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,!1),MWF.xApplication.process.ProcessManager.DictionaryExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.dictionary.create,search:MWF.APPPM.LP.dictionary.search,searchText:MWF.APPPM.LP.dictionary.searchText,noElement:MWF.APPPM.LP.dictionary.noDictionaryNoticeText},initialize:function(t,e,i){this.setOptions(i),this.setTooltip(),this.path="../x_component_process_ProcessManager/$DictionaryExplorer/",this.cssPath="../x_component_process_ProcessManager/$DictionaryExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=e,this.node=$(t),this.initData()},setContentSize:function(){if(this.toolbarNode){var t=this.toolbarNode.getSize(),e=this.node.getSize(),i=this.elementContentNode.getStyle("padding-top").toFloat(),n=this.elementContentNode.getStyle("padding-bottom").toFloat(),o=e.y-t.y-i-n;this.elementContentNode.setStyle("height",o+"px")}this.options.noCreate&&this.createElementNode&&this.createElementNode.destroy()},showDeleteAction:function(){this.deleteItemsAction||(this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node),this.deleteItemsAction.fade("in"),this.deleteItemsAction.position({relativeTo:this.elementContentListNode,position:"centerTop",edge:"centerTop",offset:{y:this.elementContentNode.getScroll().y}}),this.deleteItemsAction.addEvent("click",function(){var t=this;this.app.confirm("warn",this.deleteItemsAction,MWF.APPPM.LP.deleteElementTitle,MWF.APPPM.LP.deleteElement,300,120,(function(){t.deleteItems(),this.close()}),(function(){this.close()}))}.bind(this)))},keyCopy:function(t){if(this.selectMarkItems.length){var e=[],i=0,n=function(t){if(i>=this.selectMarkItems.length&&e.length){var n=JSON.encode(e);t?t.clipboardData.setData("text/plain",n):window.clipboardData.setData("Text",n),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(o){this.app.restActions.getDictionary(o.data.id,function(o){o.data.elementType="dictionary",e.push(o.data),i++,n(t)}.bind(this),null,!1)}.bind(this)),t&&t.preventDefault()}},keyPaste:function(t){var e="";e=t?t.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(e);this.pasteItem(i,0)},pasteItem:function(t,e){if(e<t.length){var i=t[e];"dictionary"===i.elementType?this.saveItemAs(i,function(){e++,this.pasteItem(t,e)}.bind(this),function(){e++,this.pasteItem(t,e)}.bind(this),function(){this.reload()}.bind(this)):(e++,this.pasteItem(t,e))}else this.reload()},saveItemAs:function(t,e,i,n){this.app.restActions.listDictionary(this.app.options.application.id,function(o){var s=o.data.filter((function(e){return e.id===t.id}));if(s.length){var a=s[0],c=this.app.lp,r=this,p=(new Date).parse(t.updateTime),d=(new Date).parse(a.updateTime),l="<div>"+c.copyConfirmInfor+"</div>";l+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+c.copySource+" "+a.name+"</div>",l+="<div style='font-size:12px; color: #666666; float: left'>"+a.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(p>=d?"":c.copynew)+"</div></div>",l+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+c.copyTarget+" "+t.name+"</div>",l+="<div style='font-size:12px; color: #666666; float: left;'>"+t.updateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'></div><div style='color: red; float: right;'>"+(p<=d?"":c.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:l},500,290,[{text:c.copyConfirm_overwrite,action:function(){r.saveItemAsUpdate(a,t,e,i),this.close()}},{text:c.copyConfirm_new,action:function(){r.saveItemAsNew(o,t,e,i),this.close()}},{text:c.copyConfirm_skip,action:function(){this.close(),e&&e()}},{text:c.copyConfirm_cancel,action:function(){this.close(),n&&n()}}])}else this.saveItemAsNew(o,t,e,i)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(t,e,i,n){e.id=t.id,e.application=t.application,e.applicationName=t.applicationName,e.name=t.name,e.alias=t.alias,this.app.restActions.saveDictionary(e,function(){i&&i()}.bind(this),function(){n&&n()}.bind(this))},saveItemAsNew:function(t,e,i,n){for(var o=this.app.options.application,s=o.id,a=o.name,c=e.name,r=1;t.data.some((function(t){return t.name==e.name||t.alias==e.name}));)e.name=c+"_copy"+r,e.alias=c+"_copy"+r,r++;e.id="",e.application=s,e.applicationName=a,this.app.restActions.saveDictionary(e,function(){i&&i()}.bind(this),function(){n&&n()}.bind(this))},_createElement:function(t){var e=this,i={onQueryLoad:function(){this.actions=e.app.restActions,this.application=e.app.options.application,this.explorer=e}};this.app.desktop.openApplication(t,"process.DictionaryDesigner",i)},_loadItemDataList:function(t){this.actions.listDictionary(this.app.options.application.id,t,function(){}.bind(this))},_getItemObject:function(t){return new MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary(this,t)},setTooltip:function(){this.options.tooltip={create:MWF.APPPM.LP.dictionary.create,search:MWF.APPPM.LP.dictionary.search,searchText:MWF.APPPM.LP.dictionary.searchText,noElement:MWF.APPPM.LP.dictionary.noDictionaryNoticeText}},loadElementList:function(){this._loadItemDataList(function(t){if(t.data.length)t.data.each(function(t){this._getItemObject(t).load()}.bind(this));else{var e=new Element("div.noElementNode",{styles:this.css.noElementNode,text:this.options.noCreate?MWF.APPPM.LP.dictionary.noDictionaryNoCreateNoticeText:this.options.noElement}).inject(this.elementContentListNode);this.options.noCreate||e.addEvent("click",function(t){this._createElement(t)}.bind(this))}this.isSetContentSize||(this.setContentSize(),this.isSetContentSize=!0)}.bind(this))},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var t=this.deleteMarkItems.shift();this.deleteMarkItems.length?t.deleteDictionary():t.deleteDictionary(function(){}.bind(this))}}}),MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,load:function(){this.node=new Element("div",{styles:this.explorer.css.itemNode,events:{mouseover:function(){this.deleteActionNode&&this.deleteActionNode.fade("in"),this.saveasActionNode&&this.saveasActionNode.fade("in")}.bind(this),mouseout:function(){this.deleteActionNode&&this.deleteActionNode.fade("out"),this.saveasActionNode&&this.saveasActionNode.fade("out")}.bind(this)}}).inject(this.container),this.data.name.icon&&(this.icon=this.data.name.icon);var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon,e=new Element("div",{styles:this.explorer.css.itemIconNode}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat"),e.addEvent("click",function(t){this.toggleSelected(),t.stopPropagation()}.bind(this)),e.makeLnk({par:this._getLnkPar()}),this.explorer.options.noDelete||this._createActions();var i=new Element("div",{styles:this.explorer.css.itemInforNode}).inject(this.node),n=new Element("div",{styles:this.explorer.css.itemInforBaseNode}).inject(i);new Element("div",{styles:this.explorer.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t),t.stopPropagation()}.bind(this)}}).inject(n),new Element("div",{styles:this.explorer.css.itemTextAliasNode,text:this.data.alias,title:this.data.alias}).inject(n),new Element("div",{styles:this.explorer.css.itemTextDateNode,text:this.data.updateTime||""}).inject(n),new Element("div",{styles:this.explorer.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(i),this._customNodes(),this._isNew()},_createActions:function(){this.deleteActionNode=new Element("div",{styles:this.explorer.css.deleteActionNode}).inject(this.node),this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this)),this.saveasActionNode=new Element("div",{styles:this.css.saveasActionNode,title:this.explorer.app.lp.copy}).inject(this.node),this.saveasActionNode.addEvent("click",function(t){this.saveas(t)}.bind(this))},_customNodes:function(){},_open:function(t){var e=this,i={appId:"process.DictionaryDesigner"+e.data.id,id:e.data.id,application:e.explorer.app.options.application.id,noModifyName:e.explorer.options.noModifyName,readMode:e.explorer.options.readMode,onQueryLoad:function(){this.actions=e.explorer.actions,this.category=e,this.options.id=e.data.id,this.application=e.explorer.app.options.application,this.options.noModifyName=e.explorer.options.noModifyName,this.options.readMode=e.explorer.options.readMode,this.explorer=e.explorer}};this.explorer.app.desktop.openApplication(t,"process.DictionaryDesigner",i)},_getIcon:function(){return"dictionary.png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/dictionaryIcon/lnk.png",title:this.data.name,par:'process.DictionaryDesigner#{"id": "'+this.data.id+'", "applicationId": "'+this.explorer.app.options.application.id+'"}'}},deleteDictionary:function(t){this.explorer.app.restActions.deleteDictionary(this.data.id,function(){this.node.destroy(),t&&t()}.bind(this))},saveItemAs:function(t){var e=t.id,i=t.name;this.explorer.app.restActions.getDictionary(this.data.id,function(t){var n=t.data,o=n.name;this.explorer.app.restActions.listDictionary(e,function(t){for(var s=1;t.data.some((function(t){return t.name==n.name||t.alias==n.name}));)n.name=o+"_copy"+s,n.alias=o+"_copy"+s,s++;n.id="",n.application=e,n.applicationName=i,this.explorer.app.restActions.saveDictionary(n,function(){e==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}});