MWF.xApplication.process=MWF.xApplication.process||{},MWF.APPPM=MWF.xApplication.process.ProcessManager=MWF.xApplication.process.ProcessManager||{},MWF.xDesktop.requireApp("process.ProcessManager","lp."+MWF.language,null,!1),MWF.xApplication.process.ProcessManager.Explorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.APPPM.LP.process.create,search:MWF.APPPM.LP.process.search,searchText:MWF.APPPM.LP.process.searchText,noElement:MWF.APPPM.LP.process.noProcessNoticeText}},initialize:function(e,t,i){this.setOptions(i),this.setTooltip(),this.path="../x_component_process_ProcessManager/$Explorer/",this.cssPath="../x_component_process_ProcessManager/$Explorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=t,this.node=$(e),this.initData()},setTooltip:function(e){e&&(this.options.tooltip=Object.merge(this.options.tooltip,e))},initData:function(){this.categoryList=[],this.deleteMarkItems=[],this.selectMarkItems=[]},reload:function(){this.node.empty(),this.load()},load:function(){this.loadToolbar(),this.loadContentNode(),this.setNodeScroll(),this.loadElementList()},loadToolbar:function(){this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}),this.createCreateElementNode(),this.createIconElementNode(),this.createTitleElementNode(),this.createSearchElementNode(),this.toolbarNode.inject(this.node),this.createCategoryElementNode()},createIconElementNode:function(){this.iconElementNode=new Element("div",{styles:this.css.iconElementNode}).inject(this.toolbarNode),this.app.options.application&&(this.app.options.application.icon?this.iconElementNode.setStyle("background-image","url(data:image/png;base64,"+this.app.options.application.icon+")"):this.iconElementNode.setStyle("background-image","url(../x_component_process_ApplicationExplorer/$Main/default/icon/application.png)"))},createCreateElementNode:function(){this.createElementNode=new Element("div",{styles:this.css.createElementNode,title:this.options.tooltip.create}).inject(this.toolbarNode),this.createElementNode.addEvent("click",function(e){this._createElement(e)}.bind(this))},createTitleElementNode:function(){this.titleElementNode=new Element("div",{styles:this.css.titleElementNode,text:this.app.options.application.name}).inject(this.toolbarNode)},openFindDesigner:function(){this.app.options.application.moduleType="processPlatform";var e={filter:{moduleList:["processPlatform"],appList:[this.app.options.application]}};layout.openApplication(null,"FindDesigner",e)},createSearchElementNode:function(){return this.searchElementNode=new Element("div.searchElementNode",{styles:this.css.searchElementNode,title:this.app.lp.findDesigner}).inject(this.toolbarNode),this.searchElementNode.addEvent("click",function(){this.openFindDesigner()}.bind(this)),!1},createCategoryElementNode:function(){this.categoryElementNode=new Element("div",{styles:this.css.categoryElementNode}).inject(this.node)},searchElement:function(){alert("search Element")},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node),this.elementContentNode.addEvent("click",function(){for(;this.selectMarkItems.length;)this.selectMarkItems[0].unSelected()}.bind(this)),this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode),this.setContentSizeFun=this.setContentSize.bind(this),this.app.addEvent("resize",this.setContentSizeFun),this.app.addEvent("close",function(){this.setContentSizeFun&&(this.app.removeEvent("resize",this.setContentSizeFun),this.setContentSizeFun=null)}.bind(this))},setContentSize:function(){if(this.elementContentListNode){var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},t=this.node?this.node.getSize():{x:0,y:0},i=this.categoryElementNode?this.categoryElementNode.getSize():{x:0,y:0},s=this.elementContentNode.getStyle("padding-top").toFloat(),o=this.elementContentNode.getStyle("padding-bottom").toFloat(),n=t.y-e.y-i.y-s-o;this.elementContentNode.setStyle("height",n+"px");var c=282*(t.x/282).toInt(),a=(t.x-c)/2-10;this.elementContentListNode.setStyles({width:c+"px","margin-left":a+"px"})}},setNodeScroll:function(){MWF.require("MWF.widget.DragScroll",function(){new MWF.widget.DragScroll(this.elementContentNode)}.bind(this)),MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:!1})}.bind(this))},loadElementList:function(){this._loadItemDataList(function(e){e.data.length?e.data.each(function(e){(-1===this.categoryList.indexOf(e.category)&&e.category&&this.categoryList.push(e.category),this.elementCategory&&e.category!==this.elementCategory)||this._getItemObject(e).load()}.bind(this)):new Element("div.noElementNode",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode).addEvent("click",function(e){this._createElement(e)}.bind(this));this.loadCategoryList(),this.isSetContentSize||(this.setContentSize(),this.isSetContentSize=!0)}.bind(this))},loadCategoryList:function(){this.categoryElementNode.empty();var e=new Element("div",{styles:this.css.categoryElementItemAllNode,text:MWF.xApplication.process.ProcessManager.LP.all}).inject(this.categoryElementNode);this.elementCategory||e.setStyles(this.css.categoryElementItemAllNode_current),this.categoryList.each(function(t){t&&"null"!==t&&(e=new Element("div",{styles:this.css.categoryElementItemNode,text:t}).inject(this.categoryElementNode),this.elementCategory===t&&e.setStyles(this.css.categoryElementItemNode_current))}.bind(this)),this.categoryElementNode.getChildren().addEvent("click",function(e){var t=e.target.get("text");this.elementCategory=t===MWF.xApplication.process.ProcessManager.LP.all?"":t,this.reload()}.bind(this))},showDeleteAction:function(){this.deleteItemsAction||(this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node),this.deleteItemsAction.fade("in"),this.deleteItemsAction.position({relativeTo:this.elementContentListNode,position:"centerTop",edge:"centerTop",offset:{y:this.elementContentNode.getScroll().y}}),this.deleteItemsAction.addEvent("click",function(){var e=this;this.app.confirm("warn",this.deleteItemsAction,MWF.APPPM.LP.deleteElementTitle,MWF.APPPM.LP.deleteElement,300,120,(function(){e.deleteItems(),this.close()}),(function(){this.close()}))}.bind(this)))},hideDeleteAction:function(){this.deleteItemsAction&&this.deleteItemsAction.destroy(),delete this.deleteItemsAction},_createElement:function(e){},_loadItemDataList:function(e){this.app.restActions.listProcess(this.app.options.application.id,e)},_getItemObject:function(e){return MWF.xApplication.process.ProcessManager.Explorer.Item(this,e)},destroy:function(){this.node.destroy(),o2.release(this)}}),MWF.xApplication.process.ProcessManager.Explorer.Item=new Class({initialize:function(e,t){this.explorer=e,this.data=t,this.container=this.explorer.elementContentListNode,this.css=this.explorer.css,this.icon=this._getIcon()},load:function(){this.createNode(),this.createIconNode(),this.createActionNode(),this.createTextNodes(),this._isNew()},createNode:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){this.deleteActionNode.fade("in"),this.saveasActionNode&&this.saveasActionNode.fade("in")}.bind(this),mouseout:function(){this.deleteActionNode.fade("out"),this.saveasActionNode&&this.saveasActionNode.fade("out")}.bind(this)}}).inject(this.container)},createIconNode:function(){this.data.icon&&(this.icon=this.data.icon.substr(this.data.icon.lastIndexOf("/")+1,this.data.icon.length));var e=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon,t=new Element("div",{styles:this.css.itemIconNode}).inject(this.node);t.setStyle("background","url("+e+") center center no-repeat"),t.addEvent("click",function(e){this.toggleSelected(),e.stopPropagation()}.bind(this)),t.makeLnk({par:this._getLnkPar()})},toggleSelected:function(){this.isSelected?this.unSelected():this.selected()},checkShowCopyInfor:function(){1===this.explorer.selectMarkItems.length&&this.explorer.app.notice(this.explorer.app.lp.copyInfor,"infor")},selected:function(){this.deleteMode&&this.deleteItem(),this.isSelected=!0,this.node.setStyles(this.css.itemNode_selected),this.explorer.selectMarkItems.push(this),this.checkShowCopyInfor()},unSelected:function(){this.isSelected=!1,this.node.setStyles(this.css.itemNode),this.explorer.selectMarkItems.erase(this)},createActionNode:function(){this.deleteActionNode=new Element("div",{styles:this.css.deleteActionNode}).inject(this.node),this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e)}.bind(this)),this.saveasActionNode=new Element("div",{styles:this.css.saveasActionNode,title:this.explorer.app.lp.copy}).inject(this.node),this.saveasActionNode.addEvent("click",function(e){this.saveas(e)}.bind(this))},createTextNodes:function(){new Element("div",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(e){this._open(e)}.bind(this)}}).inject(this.node),new Element("div",{styles:this.css.itemTextDescriptionNode,text:this.data.description||"",title:this.data.description||""}).inject(this.node),new Element("div",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(this.node)},saveas:function(){MWF.xDesktop.requireApp("Selector","package",function(){new MWF.O2Selector(this.explorer.app.content,{title:this.explorer.app.lp.copyto,type:"Application",values:[this.explorer.app.options.application],onComplete:function(e){e.each(function(e){this.saveItemAs(e.data)}.bind(this))}.bind(this)})}.bind(this))},deleteItem:function(){this.isSelected&&this.unSelected(),this.deleteMode?(this.deleteMode=!1,this.node.setStyle("background","#FFF"),this.deleteActionNode.setStyle("background-image","url(../x_component_process_ProcessManager/$Explorer/default/processIcon/deleteProcess.png)"),this.saveasActionNode&&this.saveasActionNode.fade("in"),this.node.addEvents({mouseover:function(){this.deleteActionNode.fade("in"),this.saveasActionNode&&this.saveasActionNode.fade("in")}.bind(this),mouseout:function(){this.deleteActionNode.fade("out"),this.saveasActionNode&&this.saveasActionNode.fade("out")}.bind(this)}),this.explorer.deleteMarkItems.erase(this)):(this.deleteMode=!0,this.node.setStyle("background-color","#ffb7b7"),this.deleteActionNode.setStyle("background-image","url(../x_component_process_ProcessManager/$Explorer/default/processIcon/deleteProcess_red1.png)"),this.node.removeEvents("mouseover"),this.node.removeEvents("mouseout"),this.saveasActionNode&&this.saveasActionNode.fade("out"),this.explorer.deleteMarkItems.push(this)),this.explorer.deleteMarkItems.length?this.explorer.showDeleteAction():this.explorer.hideDeleteAction()},deleteItems:function(){},_open:function(e){var t=this,i={onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.application=t.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"process.ProcessDesigner",i)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'ProcessDesigner#{"id": "'+this.data.id+'"}'}},_isNew:function(){if(this.data.updateTime){var e=Date.parse(this.data.updateTime),t=new Date;e.diff(t,"hour")<12&&(this.newNode=new Element("div",{styles:this.css.itemNewNode}).inject(this.node),this.newNode.addEvent("click",function(e){this.toggleSelected(),e.stopPropagation()}.bind(this)))}}});