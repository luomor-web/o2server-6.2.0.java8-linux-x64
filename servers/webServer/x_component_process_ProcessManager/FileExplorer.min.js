MWF.xDesktop.requireApp("process.ProcessManager","DictionaryExplorer",null,!1),MWF.xApplication.process.ProcessManager.FileExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer,Implements:[Options,Events],options:{create:MWF.APPPM.LP.file.create,search:MWF.APPPM.LP.file.search,searchText:MWF.APPPM.LP.file.searchText,noElement:MWF.APPPM.LP.file.noDictionaryNoticeText},getNewData:function(){return{id:"",name:"",alias:"",description:"",application:(this.app.options.application||this.app.application).id,fileName:""}},getSizeText:function(e){for(var t=[{t:"K",i:1024},{t:"M",i:1048576},{t:"G",i:1073741824}],i=0,s=e/t[i].i;s>1e3&&i<2;)s=e/t[++i].i;return(s=Math.round(100*s)/100)+" "+t[i].t},implodeFiles:function(){this.upload?this.upload.upload():MWF.require("MWF.widget.Upload",function(){var e=[];this.upload=new MWF.widget.Upload(this.app.content,{action:MWF.Actions.get("x_processplatform_assemble_designer").action,multiple:!0,method:"uploadFile",parameter:{id:""},onBeforeUploadEntry:function(t,i){var s=this.getNewData();s.name=t.name,s.fileName=t.name,s.description=t.name+" "+this.getSizeText(t.size),s.updateTime=(new Date).format("db"),MWF.Actions.get("x_processplatform_assemble_designer").saveFile(s,function(t){i.options.parameter={id:t.data.id};var n=this.elementContentListNode.getFirst();n&&n.hasClass("noElementNode")&&n.destroy(),e.push(s)}.bind(this),null,!1)}.bind(this),onEvery:function(t,i,s,n){var o=e[i-1];this._getItemObject(o).load()}.bind(this)}).load()}.bind(this))},loadContentNode:function(){this.cssPath=this.path+this.options.style+"/file.css",this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node),this.elementContentNode.addEvent("click",function(){for(;this.selectMarkItems.length;)this.selectMarkItems[0].unSelected()}.bind(this)),this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode),this.elementContentListNode.loadCss(this.cssPath),this.setContentSize(),this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},_createElement:function(e){this.implodeFiles()},_loadItemDataList:function(e){var t="";this.app.application&&(t=this.app.application.id),this.app.options.application&&(t=this.app.options.application.id),this.actions.listFile(t,e)},_getItemObject:function(e){return new MWF.xApplication.process.ProcessManager.FileExplorer.File(this,e)},setTooltip:function(){this.options.tooltip={create:MWF.APPPM.LP.file.create,search:MWF.APPPM.LP.file.search,searchText:MWF.APPPM.LP.file.searchText,noElement:MWF.APPPM.LP.file.noScriptNoticeText}},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteFile():e.deleteFile(function(){}.bind(this))}},destroy:function(){this.node.destroy(),o2.removeCss(this.cssPath),o2.release(this)},getIconJson:function(e){this.icons?e&&e():MWF.getJSON("../x_component_File/$Main/icon.json",function(t){this.icons=t,e&&e()}.bind(this),!1,!1)},getIcon:function(e){this.getIconJson();var t=e.substring(e.lastIndexOf(".")+1,e.length);return t||(t="unkonw"),"../x_component_File/$Main/default/file/"+(this.icons[t.toLowerCase()]||this.icons.unknow)}}),MWF.xApplication.process.ProcessManager.FileExplorer.File=new Class({Extends:MWF.xApplication.process.ProcessManager.DictionaryExplorer.Dictionary,load:function(){var e=this.explorer.path+this.explorer.options.style+"/file.html";this.node=new Element("div.o2_fileItemNode",{events:{mouseover:function(){this.deleteActionNode&&this.deleteActionNode.fade("in"),this.saveasActionNode&&this.saveasActionNode.fade("in")}.bind(this),mouseout:function(){this.deleteActionNode&&this.deleteActionNode.fade("out"),this.saveasActionNode&&this.saveasActionNode.fade("out")}.bind(this)}}).inject(this.container),this.data.name.icon&&(this.icon=this.data.name.icon);var t=this.data.fileName.substring(this.data.fileName.lastIndexOf(".")+1,this.data.fileName.length);this.data.fileUrl=this._getUrl(),-1!==["png","jpg","bmp","gif","jpeg","jpe"].indexOf(t)?this.data.iconUrl=this.data.fileUrl:this.data.iconUrl=this.explorer.getIcon(this.data.fileName),this.node.loadHtml(e,{bind:this.data},function(){var e=this.node.getElement(".o2_fileItemIconNode"),t=this.node.getElement(".o2_fileItemImgNode");this.node.getElement(".o2_fileItemUrlNode").setStyle("-webkit-user-select","text");var i=e.getSize();t.setStyles({"max-width":i.x+"px","max-height":i.y+"px"}),t.set("src",this.data.iconUrl),this.deleteActionNode=this.node.getElement(".o2_fileDeleteActionNode");var s=this.node.getElement(".o2_fileItemTextTitleNode");e.addEvent("click",function(e){this.toggleSelected(),e.stopPropagation()}.bind(this)),e.makeLnk({par:this._getLnkPar()}),this.explorer.options.noDelete||this._createActions(),s.addEvent("click",function(e){this._open(e),e.stopPropagation()}.bind(this)),this._customNodes(),this._isNew()}.bind(this))},_createActions:function(){this.deleteActionNode&&this.deleteActionNode.addEvent("click",function(e){this.deleteItem(e)}.bind(this))},_customNodes:function(){},_open:function(e){MWF.Actions.get("x_processplatform_assemble_designer").getFile(this.data.id,function(e){this.data=e.data,new MWF.xApplication.process.ProcessManager.FileDesigner(this.explorer,this.data)}.bind(this))},_getIcon:function(){return"file.png"},_getUrl:function(){var e=MWF.Actions.get("x_processplatform_assemble_surface").action.actions.readFile.uri;return e="/x_processplatform_assemble_surface"+(e=(e=e.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.application)),o2.filterUrl(MWF.Actions.getHost("x_processplatform_assemble_surface")+e)},_getLnkPar:function(){return{icon:this.data.iconUrl,title:this.data.name,par:"@url#"+this._getUrl()}},deleteFile:function(e){this.explorer.app.restActions.deleteFile(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))},_isNew:function(){if(this.data.updateTime){var e=Date.parse(this.data.updateTime),t=new Date;e.diff(t,"hour")<12&&(this.newNode=new Element("div",{styles:this.css.itemFileNewNode}).inject(this.node),this.newNode.addEvent("click",function(e){this.toggleSelected(),e.stopPropagation()}.bind(this)))}}}),MWF.xApplication.process.ProcessManager.FileDesigner=new Class({initialize:function(e,t){this.explorer=e,this.app=this.explorer.app,this.data=t,this.container=this.explorer.container,this.css=this.explorer.css,this.lp=MWF.APPPM.LP,this.load()},getNewData:function(){return{id:"",name:"",alias:"",description:"",application:(this.explorer.app.options.application||this.explorer.app.application).id,fileName:""}},resize:function(){var e=this.app.content.getSize(),t=this.fileAreaNode.getSize(),i=(e.x-t.x)/2,s=(e.y-t.y)/2;s<0&&(s=0),i<0&&(i=0),this.fileAreaNode.setStyles({top:s+"px",left:i+"px"});var n=this.titleNode.getSize(),o=this.buttonNode.getSize(),a=t.y-n.y-o.y;this.contentNode.setStyle("height",a+"px")},load:function(){this.data||(this.data=this.getNewData()),this.fileMaskNode=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content),this.fileAreaNode=new Element("div",{styles:this.css.createFormTemplateAreaNode}).inject(this.app.content),this.fileAreaNode.fade("in"),this.titleNode=new Element("div",{styles:this.css.fileDesignerTitleNode}).inject(this.fileAreaNode),this.titleIconNode=new Element("div",{styles:this.css.fileDesignerTitleIconNode}).inject(this.titleNode),this.data.id||this.titleIconNode.setStyle("background-image","url("+this.explorer.path+this.app.options.style+"/icon/new.png)"),this.titleTextNode=new Element("div",{styles:this.css.fileDesignerTitleTextNode}).inject(this.titleNode);var e=this.data.name?this.data.name:this.explorer.options.tooltip.create;this.titleTextNode.set("text",e),this.contentNode=new Element("div",{styles:this.css.fileDesignerContentNode}).inject(this.fileAreaNode),this.createContent(),this.buttonNode=new Element("div",{styles:this.css.fileDesignerButtonNode}).inject(this.fileAreaNode),this.createButton(),this.resizeFun=this.resize.bind(this),this.resizeFun(),this.app.addEvent("resize",this.resizeFun),this.setEvent()},createContent:function(){this.contentAreaNode=new Element("div",{styles:this.css.fileDesignerContentAreaNode}).inject(this.contentNode),this.nameInput=this.createContentLine(this.lp.name,this.data.name),this.aliasInput=this.createContentLine(this.lp.alias,this.data.alias),this.descriptionInput=this.createContentLine(this.lp.file.description,this.data.description,!0),this.createContentFile(),this.createContentFileUrl()},createContentFileUrl:function(){if(this.data.fileName){var e=new Element("div",{styles:this.css.fileDesignerContentLineNode}).inject(this.contentAreaNode);new Element("div",{styles:this.css.fileDesignerContentLineTitleNode,text:"URL"}).inject(e);this.fileUrlNode=new Element("div",{styles:this.css.fileDesignerContentLineContentNode}).inject(e),e.setStyle("height","80px");var t=MWF.Actions.get("x_processplatform_assemble_surface").action.actions.readFile.uri;t="/x_processplatform_assemble_surface"+(t=(t=t.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.application)),this.fileUrlNode.setStyle("line-height","18px");var i=MWF.Actions.getHost("x_processplatform_assemble_surface")+t;this.fileUrlNode.set("text",t);new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+o2.filterUrl(i)+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}},modifyContentFileUrl:function(){if(this.fileUrlNode){var e=MWF.Actions.get("x_processplatform_assemble_surface").action.actions.readFile.uri;e="/x_processplatform_assemble_surface"+(e=(e=e.replace(/{flag}/,this.data.id)).replace(/{applicationFlag}/,this.data.application)),this.fileUrlNode.setStyle("line-height","18px");var t=MWF.Actions.getHost("x_processplatform_assemble_surface")+e;this.fileUrlNode.set("text",e);new Element("div",{styles:{height:"30px"},html:"<a target='_blank' href='"+o2.filterUrl(t)+"'>open</a>"}).inject(this.fileUrlNode,"bottom")}else this.createContentFileUrl()},createContentFile:function(){var e=new Element("div",{styles:this.css.fileDesignerContentFileLineNode}).inject(this.contentAreaNode),t=(new Element("div",{styles:this.css.fileDesignerContentFileLineTitleNode,text:this.lp.attachment}).inject(e),new Element("div",{styles:this.css.fileDesignerContentFileLineRightNode}).inject(e));this.fileContentNode=new Element("div",{styles:this.css.fileDesignerContentFileLineContentNode}).inject(e),this.uploadFileButton=new Element("div",{styles:this.css.fileDesignerUploadButtonNode,text:this.lp.upload}).inject(t),this.data.fileName&&this.loadFileIcon()},loadFileIcon:function(){this.fileContentNode.empty();var e=this.explorer.getIcon(this.data.fileName);new Element("div",{styles:this.css.fileDesignerContentFileLineFileIconNode}).inject(this.fileContentNode).setStyle("background-image","url('"+e+"')");new Element("div",{styles:this.css.fileDesignerContentFileLineFileNameNode,text:this.data.fileName}).inject(this.fileContentNode),new Element("div",{styles:this.css.fileDesignerContentFileLineFileSizeNode,text:this.data.description}).inject(this.fileContentNode)},createContentLine:function(e,t,i){var s=new Element("div",{styles:this.css.fileDesignerContentLineNode}).inject(this.contentAreaNode),n=(new Element("div",{styles:this.css.fileDesignerContentLineTitleNode,text:e}).inject(s),new Element("div",{styles:this.css.fileDesignerContentLineContentNode}).inject(s));return new Element("input",{styles:this.css.fileDesignerContentLineInputNode,value:t,readonly:i}).inject(n)},createButton:function(){this.cancelButton=new Element("div",{styles:this.css.fileDesignerCancelButtonNode,text:this.lp.cancel}).inject(this.buttonNode),this.okButton=new Element("div",{styles:this.css.fileDesignerOkButtonNode,text:this.lp.ok}).inject(this.buttonNode)},setEvent:function(){this.cancelButton.addEvent("click",function(e){this.close(e)}.bind(this)),this.okButton.addEvent("click",function(){this.save()}.bind(this)),this.uploadFileButton.addEvent("click",function(){this.upload()}.bind(this))},upload:function(){this.data.id,this.uploadFile(function(){this.app.notice(this.lp.file.uploadSuccess,"success")}.bind(this))},uploadFile:function(e){MWF.require("MWF.widget.Upload",function(){new MWF.widget.Upload(this.app.content,{action:MWF.Actions.get("x_processplatform_assemble_designer").action,multiple:!1,method:"uploadFile",parameter:{id:this.data.id},onCompleted:function(){this.loadFileIcon(),this.modifyContentFileUrl(),this.explorer.reload(),e&&e()}.bind(this),onBeforeUpload:function(e,t){var i=e[0].name;this.nameInput.set("value",i);var s=this.getData();this.data=Object.merge(this.data,s),MWF.Actions.get("x_processplatform_assemble_designer").saveFile(this.data,function(e){this.explorer.reload(),t.options.parameter={id:e.data.id}}.bind(this),null,!1)}.bind(this),onEvery:function(e,t,i,s){this.data.fileName=s.name,this.data.description=s.name+" "+this.getSizeText(s.size),this.descriptionInput.set("value",this.data.description),MWF.Actions.get("x_processplatform_assemble_designer").saveFile(this.data)}.bind(this)}).load()}.bind(this))},getSizeText:function(e){for(var t=[{t:"K",i:1024},{t:"M",i:1048576},{t:"G",i:1073741824}],i=0,s=e/t[i].i;s>1e3&&i<2;)s=e/t[++i].i;return(s=Math.round(100*s)/100)+" "+t[i].t},getData:function(){return{name:this.nameInput.get("value"),alias:this.aliasInput.get("value"),description:this.descriptionInput.get("value")}},close:function(e){var t=this.getData(),i=this;t.name!==this.data.name||t.alias!==this.data.alias||t.description!==this.data.description?this.app.confirm("infor",e,this.lp.file.saveConfirm,this.lp.file.saveConfirmText,350,120,(function(){this.close(),i.save()}),(function(){this.close(),i.destroy()})):this.destroy()},save:function(){var e=this.getData();this.data=Object.merge(this.data,e),MWF.Actions.get("x_processplatform_assemble_designer").saveFile(this.data,function(){this.explorer.reload(),this.app.notice(this.lp.file.saveSuccess,"success"),this.destroy()}.bind(this))},destroy:function(){this.fileMaskNode.destroy(),this.fileAreaNode.destroy(),this.resizeFun&&this.app.removeEvent("resize",this.resizeFun),MWF.release(this)}});