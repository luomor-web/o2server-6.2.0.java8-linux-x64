MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,!1),MWF.xApplication.process.ProcessManager.ProcessExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],keyCopy:function(e){if(this.selectMarkItems.length){var t=[],i=0,s=function(e){if(i>=this.selectMarkItems.length&&t.length){var s=JSON.encode(t);e?e.clipboardData.setData("text/plain",s):window.clipboardData.setData("Text",s),this.app.notice(this.app.lp.copyed,"success")}}.bind(this);this.selectMarkItems.each(function(n){this.app.restActions.getProcess(n.data.id,function(n){n.data.elementType="process",t.push(n.data),i++,s(e)}.bind(this),null,!1)}.bind(this)),e&&e.preventDefault()}},keyPaste:function(e){var t="";t=e?e.clipboardData.getData("text/plain"):window.clipboardData.getData("Text");var i=JSON.decode(t);this.pasteItem(i,0)},pasteItem:function(e,t){if(t<e.length){var i=e[t];"process"===i.elementType?this.saveItemAs(i,function(){t++,this.pasteItem(e,t)}.bind(this),function(){t++,this.pasteItem(e,t)}.bind(this),function(){this.reload()}.bind(this)):(t++,this.pasteItem(e,t))}else this.reload()},saveItemAs:function(e,t,i,s){this.app.restActions.listProcess(this.app.options.application.id,function(n){var o=n.data.filter((function(t){return t.id===e.id}));if(o.length){var c=o[0],a=this.app.lp,p=this,r=(new Date).parse(e.lastUpdateTime),d=(new Date).parse(c.lastUpdateTime),l="<div>"+a.copyConfirmInfor+"</div>";l+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='font-weight: bold; font-size:14px;'>"+a.copySource+" "+c.name+"</div>",l+="<div style='font-size:12px; color: #666666; float: left'>"+c.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(c.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(r>=d?"":a.copynew)+"</div></div>",l+="<div style='overflow: hidden; margin: 10px 0px; padding: 5px 10px; background-color: #ffffff; border-radius: 6px;'><div style='clear: both;font-weight: bold; font-size:14px;'>"+a.copyTarget+" "+e.name+"</div>",l+="<div style='font-size:12px; color: #666666; float: left;'>"+e.lastUpdateTime+"</div><div style='font-size:12px; color: #666666; float: left; margin-left: 20px;'>"+MWF.name.cn(e.lastUpdatePerson)+"</div><div style='color: red; float: right;'>"+(r<=d?"":a.copynew)+"</div></div>",this.app.dlg("inofr",null,this.app.lp.copyConfirmTitle,{html:l},500,290,[{text:a.copyConfirm_overwrite,action:function(){p.saveItemAsUpdate(c,e,t,i),this.close()}},{text:a.copyConfirm_new,action:function(){p.saveItemAsNew(n,e,t,i),this.close()}},{text:a.copyConfirm_skip,action:function(){this.close(),t&&t()}},{text:a.copyConfirm_cancel,action:function(){this.close(),s&&s()}}])}else this.saveItemAsNew(n,e,t,i)}.bind(this),function(){i&&i()}.bind(this))},saveItemAsUpdate:function(e,t,i,s){t.id=e.id,t.name=e.name,t.alias=e.alias,t.application=e.application,t.applicationName=e.applicationName,t.isNewProcess=!1,t.begin&&(t.begin.process=t.id),t.endList&&t.endList.each((function(e){e.process=t.id})),t.agentList&&t.agentList.each((function(e){e.process=t.id})),t.manualList&&t.manualList.each((function(e){e.process=t.id})),t.conditionList&&t.conditionList.each((function(e){e.process=t.id})),t.choiceList&&t.choiceList.each((function(e){e.process=t.id})),t.parallelList&&t.parallelList.each((function(e){e.process=t.id})),t.splitList&&t.splitList.each((function(e){e.process=t.id})),t.mergeList&&t.mergeList.each((function(e){e.process=t.id})),t.embedList&&t.embedList.each((function(e){e.process=t.id})),t.invokeList&&t.invokeList.each((function(e){e.process=t.id})),t.cancelList&&t.cancelList.each((function(e){e.process=t.id})),t.delayList&&t.delayList.each((function(e){e.process=t.id})),t.messageList&&t.messageList.each((function(e){e.process=t.id})),t.serviceList&&t.serviceList.each((function(e){e.process=t.id})),t.routeList&&t.routeList.each((function(e){e.process=t.id})),this.app.restActions.saveProcess(t,function(){i&&i()}.bind(this),function(){s&&s()}.bind(this))},saveItemAsNew:function(e,t,i,s){var n=this.app.options.application,o=n.id,c=n.name;t.alias="";for(var a=t.name,p=1;e.data.some((function(e){return e.name==t.name}));)t.name=a+"_copy"+p,p++;t.application=o,t.applicationName=c;var r=[];r.push(t.id),t.begin&&r.push(t.begin.id),t.endList&&t.endList.each((function(e){r.push(e.id)})),t.agentList&&t.agentList.each((function(e){r.push(e.id)})),t.manualList&&t.manualList.each((function(e){r.push(e.id)})),t.conditionList&&t.conditionList.each((function(e){r.push(e.id)})),t.choiceList&&t.choiceList.each((function(e){r.push(e.id)})),t.parallelList&&t.parallelList.each((function(e){r.push(e.id)})),t.splitList&&t.splitList.each((function(e){r.push(e.id)})),t.mergeList&&t.mergeList.each((function(e){r.push(e.id)})),t.embedList&&t.embedList.each((function(e){r.push(e.id)})),t.invokeList&&t.invokeList.each((function(e){r.push(e.id)})),t.cancelList&&t.cancelList.each((function(e){r.push(e.id)})),t.delayList&&t.delayList.each((function(e){r.push(e.id)})),t.messageList&&t.messageList.each((function(e){r.push(e.id)})),t.serviceList&&t.serviceList.each((function(e){r.push(e.id)})),t.routeList&&t.routeList.each((function(e){r.push(e.id)})),this.app.restActions.getId(r.length,function(e){var n=e.data,o=JSON.encode(t);r.each(function(e,t){var i=new RegExp(e,"ig");o=o.replace(i,n[t].id)}.bind(this)),(t=JSON.decode(o)).isNewProcess=!0,this.app.restActions.saveProcess(t,function(){i&&i()}.bind(this),function(){s&&s()}.bind(this))}.bind(this))},_createElement:function(e){var t=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content),i=new Element("div",{styles:this.css.createTemplateAreaNode}).inject(this.app.content);i.fade("in");var s=new Element("div",{styles:this.css.createTemplateScrollNode}).inject(i),n=new Element("div",{styles:this.css.createTemplateContentNode}).inject(s);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(s,{indent:!1})}.bind(this));var o=this;MWF.getJSON("../x_component_process_ProcessDesigner/$Process/template/templates.json",function(e){e.each(function(e){var s=new Element("div",{styles:this.css.templateNode}).inject(n),c=new Element("div",{styles:this.css.templateIconNode}).inject(s);new Element("div",{styles:this.css.templateTitleNode,text:e.title}).inject(s);s.store("template",e.name),new Element("img",{styles:this.css.templateIconImgNode}).inject(c).set("src","../x_component_process_ProcessDesigner/$Process/template/"+e.icon),s.addEvents({mouseover:function(){this.setStyles(o.css.templateNode_over)},mouseout:function(){this.setStyles(o.css.templateNode)},mousedown:function(){this.setStyles(o.css.templateNode_down)},mouseup:function(){this.setStyles(o.css.templateNode_over)},click:function(e){!function(e,t){var i={template:t,onQueryLoad:function(){this.actions=o.app.restActions,this.application=o.app.options.application}};layout.desktop.openApplication(e,"process.ProcessDesigner",i)}(e,this.retrieve("template")),i.destroy(),t.destroy()}})}.bind(this))}.bind(this)),t.addEvent("click",(function(){i.destroy(),t.destroy()}));var c=this.app.content.getSize(),a=(c.y-262)/2,p=(c.x-828)/2;a<0&&(a=0),p<0&&(p=0),i.setStyles({top:a+"px",left:p+"px"})},_loadItemDataList:function(e){this.app.restActions.listProcess(this.app.options.application.id,e)},_getItemObject:function(e){return new MWF.xApplication.process.ProcessManager.ProcessExplorer.Process(this,e)},showDeleteAction:function(){this.deleteItemsAction||(this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node),this.deleteItemsAction.fade("in"),this.deleteItemsAction.position({relativeTo:this.elementContentListNode,position:"centerTop",edge:"centerTop",offset:{y:this.elementContentNode.getScroll().y}}),this.deleteItemsAction.addEvent("click",function(){var e=this;this.app.confirm("warn",this.deleteItemsAction,MWF.APPPM.LP.deleteProcessTitle,MWF.APPPM.LP.deleteProcess,430,120,(function(){e.deleteItems(),this.close()}),(function(){this.close()}))}.bind(this)))},deleteItems:function(){for(this.hideDeleteAction();this.deleteMarkItems.length;){var e=this.deleteMarkItems.shift();this.deleteMarkItems.length?e.deleteProcess():e.deleteProcess(function(){}.bind(this))}}}),MWF.xApplication.process.ProcessManager.ProcessExplorer.Process=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,_open:function(e){var t=this,i={appId:"process.ProcessDesigner"+t.data.id,id:t.data.id,application:t.explorer.app.options.application.id,onQueryLoad:function(){this.actions=t.explorer.actions,this.category=t,this.options.id=t.data.id,this.application=t.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"process.ProcessDesigner",i)},_getIcon:function(){return"process_icon_"+(49*Math.random()).toInt()+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'process.ProcessDesigner#{"id": "'+this.data.id+'"}'}},deleteProcess:function(e){this.explorer.actions.deleteProcess(this.data.id,function(){this.node.destroy(),e&&e()}.bind(this))},saveItemAs:function(e){var t=e.id,i=e.name;this.explorer.app.restActions.getProcess(this.data.id,function(e){var s=e.data;s.alias="";var n=s.name;this.explorer.app.restActions.listProcess(t,function(e){for(var o=1;e.data.some((function(e){return e.name==s.name}));)s.name=n+"_copy"+o,o++;s.application=t,s.applicationName=i;var c=[];c.push(s.id),s.begin&&c.push(s.begin.id),s.endList&&s.endList.each((function(e){c.push(e.id)})),s.agentList&&s.agentList.each((function(e){c.push(e.id)})),s.manualList&&s.manualList.each((function(e){c.push(e.id)})),s.conditionList&&s.conditionList.each((function(e){c.push(e.id)})),s.choiceList&&s.choiceList.each((function(e){c.push(e.id)})),s.parallelList&&s.parallelList.each((function(e){c.push(e.id)})),s.splitList&&s.splitList.each((function(e){c.push(e.id)})),s.mergeList&&s.mergeList.each((function(e){c.push(e.id)})),s.embedList&&s.embedList.each((function(e){c.push(e.id)})),s.invokeList&&s.invokeList.each((function(e){c.push(e.id)})),s.cancelList&&s.cancelList.each((function(e){c.push(e.id)})),s.delayList&&s.delayList.each((function(e){c.push(e.id)})),s.messageList&&s.messageList.each((function(e){c.push(e.id)})),s.serviceList&&s.serviceList.each((function(e){c.push(e.id)})),s.routeList&&s.routeList.each((function(e){c.push(e.id)})),this.explorer.app.restActions.getId(c.length,function(e){var i=e.data,n=JSON.encode(s);c.each(function(e,t){var s=new RegExp(e,"ig");n=n.replace(s,i[t].id)}.bind(this)),(s=JSON.decode(n)).isNewProcess=!0,this.explorer.app.restActions.saveProcess(s,function(){t==this.explorer.app.options.application.id&&this.explorer.reload()}.bind(this))}.bind(this))}.bind(this))}.bind(this))}});