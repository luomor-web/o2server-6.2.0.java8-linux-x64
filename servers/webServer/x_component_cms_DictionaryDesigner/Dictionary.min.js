MWF.xApplication=MWF.xApplication||{},MWF.xApplication.cms=MWF.xApplication.cms||{},MWF.xApplication.cms.DictionaryDesigner=MWF.xApplication.cms.DictionaryDesigner||{},MWF.CMSDD=MWF.xApplication.cms.DictionaryDesigner,MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("cms.DictionaryDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.JavascriptEditor",null,!1),MWF.xApplication.cms.DictionaryDesigner.Dictionary=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,types:["object","array","string","number","boolean"]},initialize:function(e,t,i){this.setOptions(i),this.path="../x_component_cms_DictionaryDesigner/$Dictionary/",this.cssPath="../x_component_cms_DictionaryDesigner/$Dictionary/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=e,this.data=t,this.data.data||(this.data.data={}),this.node=this.designer.designNode,this.tab=this.designer.tab,this.areaNode=new Element("div",{styles:{overflow:"auto"}}),this.propertyListNode=this.designer.propertyDomArea,this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewDictionary=!this.data.id,this.items=[],this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},loadTab:function(e){var t=this;MWF.require("MWF.widget.Tab",null,!1),this.designTabNode=new Element("div").inject(this.areaNode),this.designTab=new MWF.widget.Tab(this.designTabNode,{style:"design"}),this.designTab.load(),this.designTabPageAreaNode=Element("div"),this.designNode=new Element("div",{styles:{overflow:"auto","background-color":"#fff"}}).inject(this.designTabPageAreaNode),this.designTabScriptAreaNode=Element("div",{styles:{height:"100%"}}),this.scriptNode=new Element("div.scriptNode",{styles:{"background-color":"#fff"}}).inject(this.designTabScriptAreaNode),this.designPage=this.designTab.addTab(this.designTabPageAreaNode,this.designer.lp.design),this.scriptPage=this.designTab.addTab(this.designTabScriptAreaNode,"JSON"),this.designPage.showTabIm=function(e){t.scriptEditor&&t.isChanged?!1!==t.getEditorValidData()&&(this.isShow||(this.tab.pages.each((function(e){e.isShow&&e.hideIm()})),this.showIm(e))):this.isShow||(this.tab.pages.each((function(e){e.isShow&&e.hideIm()})),this.showIm(e))},this.designPage.showTabIm(),this.scriptPage.addEvent("postShow",function(){if(this.scriptEditor){var e=JSON.stringify(this.data.data,null,"\t");e&&this.scriptEditor.setValue(e),this.scriptEditor.focus()}else this.loadScriptEditor();this.fireEvent("resize")}.bind(this)),this.designPage.addEvent("postShow",function(){if(this.scriptEditor&&this.isChanged){var e=this.getEditorValidData();!1!==e&&(this.data.data=e,this.reload(),this.isChanged=!1)}this.fireEvent("resize")}.bind(this))},getEditorValidData:function(e){if(!this.scriptEditor.validated())return e||this.designer.notice(this.designer.lp.notice.editorNotValidated,"error",this.node,{x:"left",y:"bottom"}),!1;try{var t=this.scriptEditor.getValue(),i=JSON.parse(t);return!!this.checkValid(i,e)&&i}catch(t){return e||this.designer.notice(this.designer.lp.notice.jsonParseError,"error",this.node,{x:"left",y:"bottom"}),!1}},checkValid:function(e,t){if("object"!==typeOf(e))return!0;for(var i in e){if(!i||""===i.trim())return t||this.designer.notice(this.designer.lp.notice.emptyObjectKey,"error",this.node,{x:"left",y:"bottom"}),!1;if(!isNaN(parseFloat(i)))return t||this.designer.notice(this.designer.lp.notice.numberObjectKey,"error",this.node,{x:"left",y:"bottom"}),!1;if("object"===typeOf(e[i])&&!this.checkValid(e[i]))return!1}return!0},loadScriptEditor:function(){var e=JSON.stringify(this.data.data,null,"\t");this.scriptEditor=new MWF.widget.JavascriptEditor(this.scriptNode,{option:{value:e,mode:"json"}}),this.scriptEditor.load(function(){e&&this.scriptEditor.setValue(e),this.scriptEditor.addEditorEvent("change",function(e){this.isChanged||(this.isChanged=!0)}.bind(this))}.bind(this))},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFDictionaryAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4)},createTitle:function(){this.itemsNode=new Element("div",{styles:this.css.itemsNode}).inject(this.designNode),this.typesNode=new Element("div",{styles:this.css.typesNode}).inject(this.designNode),this.valuesNode=new Element("div",{styles:this.css.valuesNode}).inject(this.designNode),this.itemTitleNode=new Element("div",{styles:this.css.itemTitleNode}).inject(this.itemsNode),this.typeTitleNode=new Element("div",{styles:this.css.typeTitleNode}).inject(this.typesNode),this.valueTitleNode=new Element("div",{styles:this.css.valueTitleNode}).inject(this.valuesNode),this.itemResizeNode=new Element("div",{styles:this.css.itemResizeNode}).inject(this.itemTitleNode),this.typeResizeNode=new Element("div",{styles:this.css.typeResizeNode}).inject(this.typeTitleNode),this.itemTitleTextNode=new Element("div",{styles:this.css.itemTitleTextNode,text:this.designer.lp.item}).inject(this.itemTitleNode),this.typeTitleTextNode=new Element("div",{styles:this.css.typeTitleTextNode,text:this.designer.lp.type}).inject(this.typeTitleNode),this.valueTitleTextNode=new Element("div",{styles:this.css.valueTitleTextNode,text:this.designer.lp.value}).inject(this.valueTitleNode)},load:function(){this.loadTab(),this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.page=this.tab.addTab(this.areaNode,this.data.name||this.designer.lp.newDictionary,!this.data.isNewDictionary&&this.data.id!=this.designer.options.id),this.page.dictionary=this,this.page.addEvent("show",function(){this.designer.dictionaryListAreaNode.getChildren().each(function(e){e.retrieve("dictionary").id==this.data.id&&(this.designer.currentListDictionaryItem&&this.designer.currentListDictionaryItem.setStyles(this.designer.css.listDictionaryItem),e.setStyles(this.designer.css.listDictionaryItem_current),this.designer.currentListDictionaryItem=e,this.lisNode=e)}.bind(this)),this.setPropertyContent()}.bind(this)),this.page.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.saveSilence(),this.lisNode&&this.lisNode.setStyles(this.designer.css.listScriptItem)}.bind(this)),this.page.tabNode.addEvent("dblclick",this.designer.maxOrReturnEditor.bind(this.designer)),this.createTitle(),this.createRootItem(),this.options.showTab&&this.page.showTabIm()},setPropertyContent:function(){this.designer.propertyIdNode.set("text",this.data.id),this.designer.propertyNameNode.set("value",this.data.name),this.designer.propertyAliasNode.set("value",this.data.alias),this.designer.propertyDescriptionNode.set("value",this.data.description),this.designer.jsonDomNode.empty(),MWF.require("MWF.widget.JsonParse",function(){this.jsonParse=new MWF.widget.JsonParse(this.data.data,this.designer.jsonDomNode,this.designer.jsonTextAreaNode),window.setTimeout(function(){this.jsonParse.load()}.bind(this),1)}.bind(this))},setAreaNodeSize:function(){var e=this.node.getSize(),t=this.tab.tabNodeContainer.getSize(),i=0;this.searchNode&&(i=this.searchNode.getSize().y);var s=e.y-t.y-i;this.areaNode.setStyle("height",s+"px"),this.designNode.setStyle("height",s-18+"px"),this.scriptNode.setStyle("height",s-18+"px"),this.scriptEditor&&this.scriptEditor.editor&&this.scriptEditor.editor.resize()},reload:function(){this.items=[],this.designNode.empty(),this.createTitle(),this.createRootItem()},createRootItem:function(){this.items.push(new MWF.xApplication.cms.DictionaryDesigner.Dictionary.item("ROOT",this.data.data,null,0,this,!0))},saveSilence:function(){if(!this.isSave){if(this.scriptPage.isShow&&this.scriptEditor){var e=this.getEditorValidData(!0);if(!1===e)return!1;this.data.data=e}var t=this.designer.propertyNameNode.get("value"),i=this.designer.propertyAliasNode.get("value"),s=this.designer.propertyDescriptionNode.get("value");if(!t)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.data.name=t,this.data.alias=i,this.data.description=s,this.isSave=!0,this.designer.actions.saveDictionary(this.data,function(e){this.isSave=!1,this.data.id=e.data.id,callback&&callback()}.bind(this),function(e,t,i){this.isSave=!1}.bind(this))}},save:function(e){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{if(this.designer.tab.showPage==this.page){if(this.scriptPage.isShow&&this.scriptEditor){var t=this.getEditorValidData();if(!1===t)return!1;this.data.data=t}var i=this.designer.propertyNameNode.get("value"),s=this.designer.propertyAliasNode.get("value"),n=this.designer.propertyDescriptionNode.get("value");if(!i||!s)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.data.name=i,this.data.alias=s,this.data.description=n,this.data.appId=this.data.application}this.isSave=!0,this.designer.actions.saveDictionary(this.data,function(t){this.isSave=!1,this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.isNewDictionary=!1,this.isNewDictionary=!1,this.data.id=t.data.id,this.page.textNode.set("text",this.data.name),this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),e&&e()}.bind(this),function(e,t,i){this.isSave=!1;var s=i+":"+t;e&&(s=e.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+s)}.bind(this))}},loadSearch:function(){this.searchNode?"none"==this.searchNode.getStyle("display")?this.searchNode.setStyle("display","block"):this.searchNode.setStyle("display","none"):this.createSearchNode(),this.setAreaNodeSize()},createSearchNode:function(){this.searchNode=new Element("div",{styles:this.css.searchNode}).inject(this.designNode,"before"),this.searchInputNode=new Element("div",{styles:this.css.searchInputNode}).inject(this.searchNode),this.searchInput=new Element("input",{styles:this.css.searchInput}).inject(this.searchInputNode),this.searchAction=new Element("div",{styles:this.css.searchAction,text:this.designer.lp.search}).inject(this.searchNode);new Element("div",{styles:this.css.searchLineNode}).inject(this.searchNode);this.nextAction=new Element("div",{styles:this.css.searchNextAction,text:this.designer.lp.next}).inject(this.searchNode),this.searchAction.addEvent("click",function(){this.searchDictionary()}.bind(this)),this.nextAction.addEvent("click",function(){this.searchDictionaryNext()}.bind(this))},searchDictionary:function(){var e=this.searchInput.get("value");e&&(this.currentSearchItem=null,this.getSearchItem(e))},searchDictionaryNext:function(){var e=this.searchInput.get("value");e&&(this.getSearchItem(e,null,this.currentSearchItem)||this.getSearchItem(e))},getSearchItem:function(e,t,i){var s=t||this.items[0],n=!0;if(i){if("object"==i.type&&(i.exp||i.expOrColChildren(),this.getSearchItem(e,i)))return!0;s=i.parent,n=!1}if("object"==s.type){s.exp||s.expOrColChildren();for(var o=0;o<s.children.length;o++){var a=s.children[o];if(n){if(-1!=a.key.indexOf(e))return a.selected(),this.currentSearchItem=a,new Fx.Scroll(this.designNode).toElement(a.itemNode),!0;if("object"==a.type&&(a.exp||a.expOrColChildren(),a.children.length&&this.getSearchItem(e,a)))return!0}i&&a==i&&(n=!0)}}else if(-1!=s.key.indexOf(e))return s.selected(),this.currentSearchItem=s,!0;for(;s&&"ROOT"!=s.key;)if((s.nextSibling||(s=s.parent))&&(s=s.nextSibling),s&&this.getSearchItem(e,s))return!0;return!1},saveAs:function(){},explode:function(){},implode:function(){}}),MWF.xApplication.cms.DictionaryDesigner.Dictionary.item=new Class({initialize:function(e,t,i,s,n,o,a){this.key=e,this.value=t,this.parent=i,this.level=s,this.dictionary=n,this.exp=o||!1,this.nextSibling=a,this.children=[],this.childrenItemCreated=!1,this.css=this.dictionary.css,this.type=typeOf(this.value),this.load()},load:function(){this.createNodes(),this.setNodeText(),this.setEvent(),this.exp&&this.createChildrenItems()},createNodes:function(){this.itemNode=new Element("div",{styles:this.css.itemNode}),this.typeNode=new Element("div",{styles:this.css.typeNode}),this.valueNode=new Element("div",{styles:this.css.valueNode});var e=10;if(e+=20*this.level,this.itemNode.setStyle("padding-left",e+"px"),this.itemActionsAreaNode=new Element("div",{styles:this.css.itemActionsAreaNode}).inject(this.itemNode),("array"==this.type||"object"==this.type||this.parent&&"array"==this.parent.type)&&(this.itemAddActionNode=new Element("div",{styles:this.css.itemAddActionNode}).inject(this.itemActionsAreaNode)),this.parent&&(this.itemDelActionNode=new Element("div",{styles:this.css.itemDelActionNode}).inject(this.itemActionsAreaNode)),"array"!=this.type&&"object"!=this.type||(this.itemExpColActionNode=new Element("div",{styles:this.css.itemExpColActionNode}).inject(this.itemNode),this.exp?this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/col.png)"):this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/exp.png)")),this.typeActionsAreaNode=new Element("div",{styles:this.css.typeActionsAreaNode}).inject(this.typeNode),this.typeSelActionNode=new Element("div",{styles:this.css.typeSelActionNode}).inject(this.typeActionsAreaNode),this.valueActionsAreaNode=new Element("div",{styles:this.css.valueActionsAreaNode}).inject(this.valueNode),"boolean"==this.type&&(this.valueSelActionNode=new Element("div",{styles:this.css.valueSelActionNode}).inject(this.valueActionsAreaNode)),this.itemTextNode=new Element("div",{styles:this.css.itemTextNode}).inject(this.itemNode),this.typeTextNode=new Element("div",{styles:this.css.typeTextNode}).inject(this.typeNode),this.valueTextNode=new Element("div",{styles:this.css.valueTextNode}).inject(this.valueNode),this.nextSibling)this.itemNode.inject(this.nextSibling.itemNode,"before"),this.typeNode.inject(this.nextSibling.typeNode,"before"),this.valueNode.inject(this.nextSibling.valueNode,"before");else if(this.parent)if(this.parent.children.length){var t=this.parent.children.getLast();this.itemNode.inject(t.itemNode,"after"),this.typeNode.inject(t.typeNode,"after"),this.valueNode.inject(t.valueNode,"after")}else this.itemNode.inject(this.parent.itemNode,"after"),this.typeNode.inject(this.parent.typeNode,"after"),this.valueNode.inject(this.parent.valueNode,"after");else this.itemNode.inject(this.dictionary.itemsNode),this.typeNode.inject(this.dictionary.typesNode),this.valueNode.inject(this.dictionary.valuesNode)},resetNodes:function(){this.itemTextNode.removeEvents("mousedown"),this.valueTextNode.removeEvents("mousedown"),"array"==this.type||"object"==this.type?this.itemExpColActionNode||(this.itemExpColActionNode=new Element("div",{styles:this.css.itemExpColActionNode}).inject(this.itemTextNode,"before"),this.exp?this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/col.png)"):this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/exp.png)"),this.itemExpColActionNode.addEvents({click:function(){this.expOrColChildren()}.bind(this)})):(this.itemExpColActionNode&&(this.itemExpColActionNode.destroy(),this.itemExpColActionNode=null),"boolean"!=this.type&&this.valueTextNode.addEvent("mousedown",function(e){this.editValue()}.bind(this))),"array"==this.type||"object"==this.type||this.parent&&"array"==this.parent.type?this.itemAddActionNode||(this.itemAddActionNode=new Element("div",{styles:this.css.itemAddActionNode}).inject(this.itemActionsAreaNode),this.itemAddActionNode.addEvent("click",function(e){this.addItem(e)}.bind(this))):(this.itemAddActionNode&&this.itemAddActionNode.destroy(),this.itemAddActionNode=null),"boolean"==this.type&&(this.valueSelActionNode||(this.valueSelActionNode=new Element("div",{styles:this.css.valueSelActionNode}).inject(this.valueActionsAreaNode)),this.valueSelActionNode.addEvent("click",function(){this.selectBooleanValue()}.bind(this)),this.valueTextNode.addEvent("click",function(){this.selectBooleanValue()}.bind(this))),this.parent&&"array"!=this.parent.type&&this.itemTextNode.addEvent("mousedown",function(e){this.editKey()}.bind(this))},setNodeText:function(){var e=this.key;switch(this.parent&&"array"==this.parent.type&&(e="["+e+"]"),this.itemTextNode.set("text",e),this.typeTextNode.set("text",this.type),this.type){case"array":this.valueTextNode.setStyles(this.css.valueTextNode),this.valueTextNode.set("text",this.value.length+" Items");break;case"object":var t=0;Object.each(this.value,(function(){t++})),this.valueTextNode.setStyles(this.css.valueTextNode),this.valueTextNode.set("text",t+" Items");break;default:this.valueTextNode.setStyles(this.css.valueTextNode_edit),this.valueTextNode.set("text",this.value)}},setEvent:function(){this.itemNode.addEvent("click",function(e){this.selected()}.bind(this)),this.typeNode.addEvent("click",function(e){this.selected()}.bind(this)),this.valueNode.addEvent("click",function(e){this.selected()}.bind(this)),this.typeSelActionNode.addEvent("click",function(e){this.selectType()}.bind(this)),this.typeTextNode.addEvent("click",function(e){this.selectType()}.bind(this)),this.itemNode.addEvents({mouseover:function(){this.itemActionsAreaNode.fade("in")}.bind(this),mouseout:function(){this.itemActionsAreaNode.fade("out")}.bind(this)}),this.itemAddActionNode&&this.itemAddActionNode.addEvent("click",function(e){this.addItem(e)}.bind(this)),this.itemDelActionNode&&this.itemDelActionNode.addEvent("click",function(e){this.delItem(e)}.bind(this)),"array"==this.type||"object"==this.type?this.itemExpColActionNode.addEvents({click:function(){this.expOrColChildren()}.bind(this)}):"boolean"!=this.type&&this.valueTextNode.addEvent("mousedown",function(e){this.editValue()}.bind(this)),this.parent&&"array"!=this.parent.type&&this.itemTextNode.addEvent("mousedown",function(e){this.editKey()}.bind(this)),"boolean"==this.type&&(this.valueSelActionNode.addEvent("click",function(){this.selectBooleanValue()}.bind(this)),this.valueTextNode.addEvent("click",function(){this.selectBooleanValue()}.bind(this)))},expOrColChildren:function(){this.exp?(this.colChildren(),this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/exp.png)"),this.exp=!1):(this.expChildren(),this.itemExpColActionNode.setStyle("background-image","url(../x_component_cms_DictionaryDesigner/$Dictionary/default/icon/col.png)"),this.exp=!0)},colChildren:function(){this.children.each((function(e){e.colChildren(),e.colChildrenNode()}))},expChildren:function(){this.createChildrenItems(),this.children.each((function(e){e.exp&&e.expChildren(),e.expChildrenNode()}))},colChildrenNode:function(){this.itemNode.setStyle("display","none"),this.typeNode.setStyle("display","none"),this.valueNode.setStyle("display","none")},expChildrenNode:function(){this.itemNode.setStyle("display","block"),this.typeNode.setStyle("display","block"),this.valueNode.setStyle("display","block")},unSelected:function(){this.itemNode.setStyles(this.css.itemNode),this.typeNode.setStyles(this.css.typeNode),this.valueNode.setStyles(this.css.valueNode),this.dictionary.currentSelectedItem=null},selected:function(){this.dictionary.currentSelectedItem!=this&&(this.dictionary.currentSelectedItem&&this.dictionary.currentSelectedItem.unSelected(),this.itemNode.setStyles(this.css.itemNode_selected),this.typeNode.setStyles(this.css.typeNode_selected),this.valueNode.setStyles(this.css.valueNode_selected),this.listDataItems(),this.dictionary.currentSelectedItem=this)},listDataItems:function(){switch(this.dictionary.propertyListNode.empty(),this.type){case"array":this.value.each(function(e,t){this.createDataListItem("["+t+"]",e.toString())}.bind(this));break;case"object":Object.each(this.value,function(e,t){this.createDataListItem(t,e.toString())}.bind(this))}},createDataListItem:function(e,t){var i=new Element("div",{styles:this.css.dataListItemNode}).inject(this.dictionary.propertyListNode);new Element("div",{styles:this.css.dataListItemKeyNode,text:e,title:e}).inject(i),new Element("div",{styles:this.css.dataListItemValueNode,text:t,title:t}).inject(i)},createNewItem:function(e,t,i,s,n,o,a){return new MWF.xApplication.cms.DictionaryDesigner.Dictionary.item(e,t,i,s,n,o,a)},createChildrenItems:function(){if(!this.childrenItemCreated){switch(this.type){case"array":this.value.each(function(e,t){var i=this.createNewItem(t,e,this,this.level+1,this.dictionary,!1);this.children.length&&(this.children[this.children.length-1].nextSibling=i),this.children.push(i)}.bind(this));break;case"object":Object.each(this.value,function(e,t){var i=this.createNewItem(t,e,this,this.level+1,this.dictionary,!1);this.children.length&&(this.children[this.children.length-1].nextSibling=i),this.children.push(i)}.bind(this))}this.childrenItemCreated=!0}},addItem:function(e){this.parent?this.exp?this.addChild():this.addSibling():(this.createChildrenItems(),this.addChild()),this.dictionary.jsonParse.loadObjectTree()},addChild:function(){var e;if("array"==this.type){var t=this.value.length;this.value.push("New Element Value"),e=this.createNewItem(t,"New Element Value",this,this.level+1,this.dictionary,!1)}if("object"==this.type){for(var i="NewItem",s=0;void 0!==this.value[i];)i="NewItem"+ ++s;this.value[i]="New Item Value",e=this.createNewItem(i,"New Item Value",this,this.level+1,this.dictionary,!1)}this.children.length&&(this.children[this.children.length-1].nextSibling=e),this.children.push(e)},addSibling:function(){var e,t=null;if("array"==this.parent.type){e=this.key;var i="New Element Value";this.parent.value.splice(this.key,0,i);for(var s=this.key;s<this.parent.children.length;s++){(t=this.parent.children[s]).key=t.key+1,t.setNodeText()}t=this.createNewItem(e,i,this.parent,this.level,this.dictionary,!1,this)}else{var n="NewItem";for(s=0;null!=this.parent.value[n];)n="NewItem"+ ++s;i="New Item Value";this.parent.value[n]=i;t=this.createNewItem(n,i,this.parent,this.level,this.dictionary,!1,this);e=this.parent.children.indexOf(this)}e&&(this.parent.children[e-1].nextSibling=t),this.parent.children.splice(e,0,t)},delItem:function(e){var t=this;this.dictionary.designer.shortcut=!1,this.dictionary.designer.confirm("warn",e,this.dictionary.designer.lp.notice.deleteDataTitle,this.dictionary.designer.lp.notice.deleteData,300,120,(function(){t.destroy(),t.dictionary.jsonParse.loadObjectTree(),t.dictionary.designer.shortcut=!0,this.close()}),(function(){t.dictionary.designer.shortcut=!0,this.close()}))},destroy:function(){var e=this.parent.children.indexOf(this);if(e&&(this.parent.children[e-1].nextSibling=this.nextSibling),this.destroyAllNodes(),this.parent.children.erase(this),"object"==this.parent.type&&delete this.parent.value[this.key],"array"==this.parent.type){this.parent.value.splice(this.key,1);for(var t=this.key;t<this.parent.children.length;t++)this.parent.children[t].key=this.parent.children[t].key-1,this.parent.children[t].setNodeText()}this.dictionary.jsonParse.loadObjectTree()},destroyAllNodes:function(){this.children.each((function(e){e.destroyAllNodes()})),this.itemNode.destroy(),this.typeNode.destroy(),this.valueNode.destroy(),this.typeSelectNode&&this.typeSelectNode.destroy()},selectType:function(){this.typeSelectNode||this.createTypeSelectNode(),this.typeSelectNode.setStyle("display","block");for(var e=this.dictionary.node.getSize(),t=this.typeSelectNode.getSize(),i=this.typeSelectNode.getChildren(),s=0;s<i.length;s++)i[s].get("text")==this.type?i[s].setStyles(this.css.typeSelectItemNode_over):i[s].setStyles(this.css.typeSelectItemNode);this.typeSelectNode.position({relativeTo:this.typeNode,position:"upperLeft",edge:"upperLeft"}),this.typeSelectNode.getPosition(this.typeSelectNode.getOffsetParent()).y+t.y>e.y&&this.typeSelectNode.position({relativeTo:this.typeNode,position:"bottomLeft",edge:"bottomLeft"}),this.closeTypeSelectNodeFun=this.closeTypeSelectNode.bind(this),$(document.body).addEvent("mousedown",this.closeTypeSelectNodeFun)},closeTypeSelectNode:function(){this.typeSelectNode.setStyle("display","none"),$(document.body).removeEvent("mousedown",this.closeTypeSelectNodeFun)},createTypeSelectNode:function(){var e=this;this.typeSelectNode=new Element("div",{styles:this.css.typeSelectNode});var t=this.dictionary.options.types;this.parent||(t=["object","array"],this.typeSelectNode.setStyle("height","50px")),t.each(function(t){var i=new Element("div",{styles:this.css.typeSelectItemNode}).inject(this.typeSelectNode);i.set("text",t),this.type==t&&i.setStyles(this.css.typeSelectItemNode_over),i.addEvents({mouseover:function(){this.setStyles(e.css.typeSelectItemNode_over)},mouseout:function(){this.setStyles(e.css.typeSelectItemNode)},mousedown:function(t){e.selectedType(this,t)}})}.bind(this)),this.typeSelectNode.inject(this.dictionary.node)},selectedType:function(e,t){t.target=null;var i=e.get("text");if(this.type!=i){var s=this;switch(i){case"array":"New Item Value"!=this.value&&"New Element Value"!=this.value?this.dictionary.designer.confirm("warn",t,this.dictionary.designer.lp.notice.changeTypeTitle,this.dictionary.designer.lp.notice.changeType,300,120,(function(){"object"==s.type?s.changeTypeObjectToArray(i):s.changeTypePrimitiveToArray(i),this.close(),s.dictionary.jsonParse.loadObjectTree()}),(function(){this.close()})):("object"==this.type?this.changeTypeObjectToArray(i):this.changeTypePrimitiveToArray(i),this.dictionary.jsonParse.loadObjectTree());break;case"object":"New Item Value"!=this.value&&"New Element Value"!=this.value?this.dictionary.designer.confirm("warn",t,this.dictionary.designer.lp.notice.changeTypeTitle,this.dictionary.designer.lp.notice.changeType,300,120,(function(){"array"==s.type?s.changeTypeArrayToObject(i):s.changeTypePrimitiveToObject(i),this.close(),s.dictionary.jsonParse.loadObjectTree()}),(function(){this.close()})):("array"==this.type?this.changeTypeArrayToObject(i):this.changeTypePrimitiveToObject(i),this.dictionary.jsonParse.loadObjectTree());break;default:"New Item Value"!=this.value&&"New Element Value"!=this.value?this.dictionary.designer.confirm("warn",t,this.dictionary.designer.lp.notice.changeTypeTitle,this.dictionary.designer.lp.notice.changeTypeDeleteChildren,300,120,(function(){"array"==s.type?s.changeTypeArrayToPrimitive(i):"object"==s.type?s.changeTypeObjectToPrimitive(i):s.changeTypePrimitiveToPrimitive(i),this.close(),s.dictionary.jsonParse.loadObjectTree()}),(function(){this.close()})):("array"==this.type?this.changeTypeArrayToPrimitive(i):"object"==s.type?this.changeTypeObjectToPrimitive(i):this.changeTypePrimitiveToPrimitive(i),this.dictionary.jsonParse.loadObjectTree())}}},deleteAllChildren:function(){this.children.each((function(e){e.destroyAllNodes()}))},changeTypeObjectToPrimitive:function(e){var t;switch(this.deleteAllChildren(),this.children=[],this.childrenItemCreated=!1,e){case"string":t="";break;case"number":t=0;break;case"boolean":t=!0}delete this.parent.value[this.key],this.parent.value[this.key]=t,this.value=t,this.type=e,this.exp=!1,this.setNodeText(),this.resetNodes()},changeTypeArrayToPrimitive:function(e){this.changeTypeObjectToPrimitive(e)},changeTypePrimitiveToPrimitive:function(e){switch(e){case"string":value=this.value.toString();break;case"number":value=this.value.toFloat(),isNaN(value)&&(value=0);break;case"boolean":value=!0,"false"==this.value&&(value=!1)}delete this.parent.value[this.key],this.parent.value[this.key]=value,this.value=value,this.type=e,this.exp=!1,this.setNodeText(),this.resetNodes()},changeTypePrimitiveToObject:function(e){value={},delete this.parent.value[this.key],this.parent.value[this.key]=value,this.value=value,this.type=e,this.exp=!1,this.setNodeText(),this.resetNodes()},changeTypeArrayToObject:function(e){this.deleteAllChildren(),this.children=[],this.childrenItemCreated=!1;var t={};this.value.each((function(e,i){t["ITEM"+i]=e})),this.parent?(delete this.parent.value[this.key],this.parent.value[this.key]=t,this.value=t,this.type=e,this.setNodeText(),this.resetNodes(),this.exp&&this.createChildrenItems()):(this.dictionary.data.data=t,this.dictionary.jsonParse.json=t,this.value=t,this.type=e,this.setNodeText(),this.resetNodes(),this.exp&&this.createChildrenItems())},changeTypePrimitiveToArray:function(e){value=[],delete this.parent.value[this.key],this.parent.value[this.key]=value,this.value=value,this.type=e,this.exp=!1,this.setNodeText(),this.resetNodes()},changeTypeObjectToArray:function(e){this.deleteAllChildren(),this.children=[],this.childrenItemCreated=!1;var t=[];Object.each(this.value,(function(e,i){t.push(e)})),this.parent?(delete this.parent.value[this.key],this.parent.value[this.key]=t,this.value=t,this.type=e,this.childrenItemCreated=!1,this.setNodeText(),this.resetNodes(),this.exp&&this.createChildrenItems()):(this.dictionary.data.data=t,this.dictionary.jsonParse.json=t,this.value=t,this.type=e,this.childrenItemCreated=!1,this.setNodeText(),this.resetNodes(),this.exp&&this.createChildrenItems())},editValue:function(){this.valueTextNode.empty(),this.editValueNode=new Element("input",{styles:this.css.itemEditValueNode}).inject(this.valueTextNode),this.editValueNode.set("value",this.value),"string"===this.type&&(this.selectOrgNode=new Element("span",{styles:this.css.itemSelectOrgNode,title:this.dictionary.designer.lp.selectOrganizationByDblclick,events:{dblclick:function(e){var t={type:"",types:["person","identity","unit","group"],title:"select",count:"0",values:this.value.replace("New Item Value","").split(", "),expand:!1,onComplete:function(e){var t=[];e.each(function(e){t.push(e.data.distinguishedName)}.bind(this)),this.value=t.join(", "),this.parent.value[this.key]=this.value,this.setNodeText(),this.dictionary.jsonParse.loadObjectTree()}.bind(this)};new MWF.O2Selector(this.dictionary.designer.content,t);e.stopPropagation()}.bind(this)}}).inject(this.valueTextNode)),window.setTimeout(function(){this.editValueNode.focus(),this.editValueNode.select(),this.editValueNode.addEvents({blur:function(e){this.editValueConfirm(e)}.bind(this),keydown:function(e){13==e.code&&(this.editValueConfirm(e),this.nextSibling&&this.nextSibling.editKey()),e.stopPropagation()}.bind(this),mousedown:function(e){e.stopPropagation()}})}.bind(this),10)},editValueConfirm:function(e){var t=this.editValueNode.get("Value");if("number"==this.type){if(isNaN(parseFloat(t)))return this.dictionary.designer.notice(this.dictionary.designer.lp.notice.inputTypeError,"error",this.editValueNode,{x:"left",y:"bottom"},{x:0,y:24}),this.editValueNode.setStyles(this.css.itemEditValueNode_error),this.editValueNode.select(),e.preventDefault(),!1;t=t.toFloat()}this.value=t,this.parent.value[this.key]=this.value,this.editValueNode.destroy(),this.editValueNode=null,this.setNodeText(),this.dictionary.jsonParse.loadObjectTree()},editKey:function(){this.itemTextNode.empty(),this.editKeyNode=new Element("input",{styles:this.css.itemEditValueNode,type:"text"}).inject(this.itemTextNode),this.editKeyNode.set("value",this.key),window.setTimeout(function(){this.editKeyNode.focus(),this.editKeyNode.select(),this.editKeyNode.addEvents({blur:function(e){this.editKeyConfirm(e)}.bind(this),keydown:function(e){13==e.code&&(this.editKeyConfirm(e),"array"!=this.type&&"object"!=this.type&&"boolean"!=this.type?this.editValue():this.nextSibling&&this.nextSibling.editKey()),e.stopPropagation()}.bind(this),mousedown:function(e){e.stopPropagation()}})}.bind(this),10)},editKeyConfirm:function(e){var t=this.editKeyNode.get("Value");if(t!=this.key){if(this.parent.value[t])return this.dictionary.designer.notice(this.dictionary.designer.lp.notice.sameKey,"error",this.editKeyNode,{x:"left",y:"bottom"},{x:0,y:24}),this.editKeyNode.setStyles(this.css.itemEditValueNode_error),this.editKeyNode.select(),e.preventDefault(),!1;if(!isNaN(parseFloat(t)))return this.dictionary.designer.notice(this.dictionary.designer.lp.notice.numberKey,"error",this.editKeyNode,{x:"left",y:"bottom"},{x:0,y:24}),this.editKeyNode.setStyles(this.css.itemEditValueNode_error),this.editKeyNode.select(),e.preventDefault(),!1;if(!t)return this.dictionary.designer.notice(this.dictionary.designer.lp.notice.emptyKey,"error",this.editKeyNode,{x:"left",y:"bottom"},{x:0,y:24}),this.editKeyNode.setStyles(this.css.itemEditValueNode_error),this.editKeyNode.select(),e.preventDefault(),!1;delete this.parent.value[this.key],this.parent.value[t]=this.value,this.key=t}this.editKeyNode.destroy(),this.editKeyNode=null,this.setNodeText(),this.dictionary.jsonParse.loadObjectTree()},selectBooleanValue:function(){this.booleanSelectNode||this.createBooleanSelectNode();var e=this.dictionary.node.getSize();this.booleanSelectNode.setStyle("display","block");for(var t=this.booleanSelectNode.getSize(),i=this.booleanSelectNode.getChildren(),s=0;s<i.length;s++)i[s].get("text")==this.value.toString()?i[s].setStyles(this.css.typeSelectItemNode_over):i[s].setStyles(this.css.typeSelectItemNode);this.booleanSelectNode.position({relativeTo:this.valueNode,position:"upperLeft",edge:"upperLeft"}),this.booleanSelectNode.getPosition(this.booleanSelectNode.getOffsetParent()).y+t.y>e.y&&this.booleanSelectNode.position({relativeTo:this.valueNode,position:"bottomLeft",edge:"bottomLeft"}),this.closeBooleanSelectNodeFun=this.closeBooleanSelectNode.bind(this),$(document.body).addEvent("mousedown",this.closeBooleanSelectNodeFun)},closeBooleanSelectNode:function(){this.booleanSelectNode.setStyle("display","none"),$(document.body).removeEvent("mousedown",this.closeBooleanSelectNodeFun)},createBooleanSelectNode:function(){var e=this;this.booleanSelectNode=new Element("div",{styles:this.css.booleanSelectNode}),["true","false"].each(function(t){var i=new Element("div",{styles:this.css.typeSelectItemNode}).inject(this.booleanSelectNode);i.set("text",t),this.value.toString()==t&&i.setStyles(this.css.typeSelectItemNode_over),i.addEvents({mouseover:function(){this.setStyles(e.css.typeSelectItemNode_over)},mouseout:function(){this.setStyles(e.css.typeSelectItemNode)},mousedown:function(t){e.selectedBoolean(this,t)}})}.bind(this)),this.booleanSelectNode.inject(this.dictionary.node)},selectedBoolean:function(e,t){var i="false"!=e.get("text");this.value=i,this.parent.value[this.key]=i,this.setNodeText(),this.dictionary.jsonParse.loadObjectTree()}}),MWF.xApplication.cms.DictionaryDesigner.DictionaryReader=new Class({Extends:MWF.xApplication.cms.DictionaryDesigner.Dictionary,autoSave:function(){},createRootItem:function(){this.items.push(new MWF.xApplication.cms.DictionaryDesigner.Dictionary.ItemReader("ROOT",this.data.data,null,0,this,!0))}}),MWF.xApplication.cms.DictionaryDesigner.Dictionary.ItemReader=new Class({Extends:MWF.xApplication.cms.DictionaryDesigner.Dictionary.item,createNewItem:function(e,t,i,s,n,o,a){return new MWF.xApplication.cms.DictionaryDesigner.Dictionary.ItemReader(e,t,i,s,n,o,a)},setEvent:function(){this.itemNode.addEvent("click",function(e){this.selected()}.bind(this)),this.typeNode.addEvent("click",function(e){this.selected()}.bind(this)),this.valueNode.addEvent("click",function(e){this.selected()}.bind(this)),"array"!=this.type&&"object"!=this.type||this.itemExpColActionNode.addEvents({click:function(){this.expOrColChildren()}.bind(this)})}});