MWF.xApplication.Forum=MWF.xApplication.Forum||{},MWF.xApplication.ForumPerson=MWF.xApplication.ForumPerson||{},MWF.require("MWF.widget.O2Identity",null,!1),MWF.xDesktop.requireApp("Forum","Common",null,!1),MWF.xDesktop.requireApp("Forum","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),MWF.xDesktop.requireApp("Forum","Access",null,!1),MWF.xDesktop.requireApp("Forum","TopNode",null,!1),MWF.xApplication.ForumPerson.options={multitask:!0,executable:!0},MWF.xApplication.ForumPerson.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"ForumPerson",icon:"icon.png",width:"1230",height:"700",isResize:!1,isMax:!0,title:MWF.xApplication.ForumPerson.LP.title,personName:""},onQueryLoad:function(){this.lp=MWF.xApplication.Forum.LP},loadApplication:function(t){this.userName=layout.desktop.session.user.distinguishedName,this.restActions=MWF.Actions.get("x_bbs_assemble_control"),this.path="../x_component_ForumPerson/$Main/"+this.options.style+"/",this.createNode(),this.loadApplicationContent()},loadController:function(t){this.access=new MWF.xApplication.Forum.Access(this.restActions,this.lp),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:this.css.node}).inject(this.content)},clearContent:function(){this.node.empty()},loadApplicationContent:function(){!this.options.personName&&this.status&&this.status.personName&&(this.options.personName=this.status.personName),this.isCurrentUser=this.userName==this.options.personName,this.personNameAbbreviate=this.options.personName.split("@")[0];var t=this.inBrowser&&MWFForum.getSystemConfigValue(MWFForum.BBS_TITLE_TAIL)||"";this.setTitle(this.personNameAbbreviate+t),this.loadController(function(){this.access.login(function(){this.getUserData(this.options.personName,function(t){this.personData=t.data,this.loadApplicationLayout()}.bind(this))}.bind(this))}.bind(this))},getUserData:function(t,e){if(this.access.isAnonymous()){var i=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);e&&e({data:{icon:i,genderType:"m",signature:""}})}else MWF.Actions.get("x_organization_assemble_control").getPerson(function(i){i.data.signature||(i.data.signature="");var s=MWF.Actions.get("x_organization_assemble_personal").getIcon(t);s?i.data&&(i.data.icon=s,e&&e(i)):i.data&&(i.data.icon="../x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif",e&&e(i))}.bind(this),null,t,!0)},loadApplicationLayout:function(){this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node),this.createTopNode(),this.createMiddleNode()},reloadAllParents:function(t){this.restActions.getSection(t,function(e){var i="Forum";this.desktop.apps[i]&&this.desktop.apps[i].reload&&this.desktop.apps[i].reload(),i="ForumCategory"+e.data.forumId,this.desktop.apps[i]&&this.desktop.apps[i].reload&&this.desktop.apps[i].reload(),i="ForumSection"+t,this.desktop.apps[i]&&this.desktop.apps[i].reload&&this.desktop.apps[i].reload()}.bind(this))},createTopNode:function(){new MWF.xApplication.Forum.TopNode(this.contentContainerNode,this,this,{type:this.options.style,logoutEnable:!1}).load();this.lp.defaultForumColor;var t=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainerNode),e=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(t);new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.title}).inject(e).addEvent("click",function(){this.desktop.apps.Forum?this.desktop.apps.Forum.setCurrent():this.desktop.openApplication(null,"Forum",{appId:"Forum"}),this.inBrowser||this.close()}.bind(this));new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(e),new Element("div.topItemTitleNode",{styles:this.css.topItemTitleLastNode,text:this.lp.personCenter+"："+this.personNameAbbreviate}).inject(e)},createMiddleNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode),this.createPersonNode(),this._createMiddleNode(),this.addEvent("resize",function(){this.setContentSize()}.bind(this)),this.setContentSize()},createPersonNode:function(){var t=new Element("div.personNode",{styles:this.css.personNode}).inject(this.middleNode);this.restActions.getUserInfor({userName:this.options.personName},function(e){var i=this.userInfor=e.data,s=new Element("div.personLeftNode",{styles:this.css.personLeftNode}).inject(t),o=new Element("div.personLeftIconNode",{styles:this.css.personLeftIconNode}).inject(s),n=(new Element("img",{styles:this.css.personLeftIcon,src:this.personData.icon}).inject(o),new Element("div.personLeftContent",{styles:this.css.personLeftContent}).inject(s)),p=new Element("div.personTopDiv",{styles:this.css.personTopDiv}).inject(n);new Element("div.personTopInfor",{styles:this.css.personTopInfor,text:this.personNameAbbreviate}).inject(p);this.access.isAnonymous()||this.inBrowser||(this.isCurrentUser?new Element("input",{type:"button",styles:this.css.personSettingAction,value:this.lp.changePersonSetting}).inject(p).addEvent("click",function(){this.desktop.apps.Profile?this.desktop.apps.Profile.setCurrent():this.desktop.openApplication(null,"Profile",{})}.bind(this)):new Element("input",{type:"button",styles:this.css.personSettingAction,value:this.lp.sendMessage}).inject(p).addEvent("click",function(t){if(layout.desktop.widgets.IMIMWidget){var e=layout.desktop.widgets.IMIMWidget,i=this.options.personName;e.getOwner(function(){this.openChat(t,{from:i})}.bind(e))}}.bind(this)));new Element("div.personLeftDiv",{styles:this.css.personLeftDiv,text:this.lp.subject+"："+i.subjectCount+"，"+this.lp.replyCount+"："+i.replyCount+"，"+this.lp.prime+"："+i.creamCount+"，"+this.lp.todaySubject+"："+i.subjectCountToday+"，"+this.lp.todayReply+"："+i.replyCountToday}).inject(n),new Element("div.personLeftDiv",{styles:this.css.personLeftDiv,text:this.lp.signature+"："+this.personData.signature}).inject(n)}.bind(this))},_createMiddleNode:function(){this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleNode),this.contentDiv&&this.contentDiv.empty(),this.explorer&&(this.explorer.destroy(),delete this.explorer),this.explorer=new MWF.xApplication.ForumPerson.Explorer(this.contentDiv,this,this,{style:this.options.style,type:this.status&&this.status.type?this.status.type:"subject",viewPageNum:this.status&&this.status.viewPageNum?this.status.viewPageNum:1}),this.explorer.load()},openPerson:function(t){if(t&&""!=t){var e="ForumPerson"+t;this.desktop.apps[t]?this.desktop.apps[t].setCurrent():this.desktop.openApplication(null,"ForumPerson",{personName:t,appId:e})}else;},setContentSize:function(){var t=this.node.getSize(),e=this.contentContainerNode.getStyle("padding-top").toFloat(),i=this.contentContainerNode.getStyle("padding-bottom").toFloat(),s=t.y-0-e-i;this.contentContainerNode.setStyle("height",s+"px")},recordStatus:function(){return{type:this.explorer.options.type,personName:this.options.personName,viewPageNum:this.explorer.view.getCurrentPageNum()}}}),MWF.xApplication.ForumPerson.Explorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",type:"subject",viewPageNum:1},initialize:function(t,e,i,s){this.setOptions(s),this.container=t,this.parent=i,this.app=e,this.css=this.parent.css,this.lp=this.app.lp},load:function(){this.container.empty(),this.loadToolbar(),this.viewContainer=Element("div",{styles:this.css.viewContainer}).inject(this.container),this.loadToolbar(),"subject"==this.options.type?this.loadSubjectView():this.loadReplyView()},destroy:function(){this.resizeWindowFun&&this.app.removeEvent("resize",this.resizeWindowFun),this.view.destroy()},loadToolbar:function(){var t=new Element("div",{styles:this.css.toolbar}).inject(this.container);this.toolbarTop||(this.app.isCurrentUser?(this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(t),this.mySubjectNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:this.lp.mySubject}).inject(this.toolbarLeft),this.mySubjectNode.addEvents({mouseover:function(){this.currentNaviNode!=this.mySubjectNode&&this.mySubjectNode.setStyles(this.css.toolbarLeftItem_over)}.bind(this),mouseout:function(){this.currentNaviNode!=this.mySubjectNode&&this.mySubjectNode.setStyles(this.css.toolbarLeftItem)}.bind(this),click:function(){this.options.type="subject",this.currentNaviNode&&this.currentNaviNode.setStyles(this.css.toolbarLeftItem),this.currentNaviNode=this.mySubjectNode,this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current),this.loadSubjectView()}.bind(this)}),this.myReplyNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:this.lp.myReply}).inject(this.toolbarLeft),this.myReplyNode.addEvents({mouseover:function(){this.currentNaviNode!=this.myReplyNode&&this.myReplyNode.setStyles(this.css.toolbarLeftItem_over)}.bind(this),mouseout:function(){this.currentNaviNode!=this.myReplyNode&&this.myReplyNode.setStyles(this.css.toolbarLeftItem)}.bind(this),click:function(){this.options.type="reply",this.currentNaviNode&&this.currentNaviNode.setStyles(this.css.toolbarLeftItem),this.currentNaviNode=this.myReplyNode,this.myReplyNode.setStyles(this.css.toolbarLeftItem_current),this.loadReplyView()}.bind(this)}),"reply"==this.options.type?(this.myReplyNode.setStyles(this.css.toolbarLeftItem_current),this.currentNaviNode=this.myReplyNode):(this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current),this.currentNaviNode=this.mySubjectNode)):(this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(t),this.mySubjectNode=new Element("div.toolbarLeftItem",{styles:this.css.toolbarLeftItem,text:"f"==this.app.personData.genderType.toLowerCase()?this.lp.herSubject:this.lp.hisSubject}).inject(this.toolbarLeft),this.mySubjectNode.setStyles(this.css.toolbarLeftItem_current),this.mySubjectNode.setStyle("cursor","default"))),this.toolbarTop?this.toolbarBottom=t:this.toolbarTop=t;var e=new Element("div",{styles:this.css.fileterNode}).inject(t);this.pagingBarTop?this.pagingBarBottom=e:this.pagingBarTop=e},loadSubjectView:function(){this.view&&this.view.destroy(),this.view=new MWF.xApplication.ForumPerson.SubjectView(this.viewContainer,this.app,this,{templateUrl:this.parent.path+"listItem.json",pagingEnable:!0,pagingPar:{countPerPage:30,onPostLoad:function(t){t.nextPageNode&&t.nextPageNode.inject(this.toolbarBottom,"before")}.bind(this),onPageReturn:function(t){this.app.desktop.apps.Forum?this.app.desktop.apps.Forum.setCurrent():this.app.desktop.openApplication(null,"Forum",{appId:"Forum"}),this.app.close()}.bind(this)}}),this.view.filterData={creatorName:this.app.options.personName},this.view.pagingContainerTop=this.pagingBarTop,this.view.pagingContainerBottom=this.pagingBarBottom,this.view.load()},loadReplyView:function(){this.view&&this.view.destroy(),this.view=new MWF.xApplication.ForumPerson.ReplyView(this.viewContainer,this.app,this,{templateUrl:this.parent.path+"listItemReply.json",pagingEnable:!0,pagingPar:{countPerPage:30,onPostLoad:function(t){t.nextPageNode&&t.nextPageNode.inject(this.toolbarBottom,"before")}.bind(this),onPageReturn:function(t){this.app.desktop.apps.Forum?this.app.desktop.apps.Forum.setCurrent():this.app.desktop.openApplication(null,"Forum",{appId:"Forum"}),this.app.close()}.bind(this)}}),this.view.filterData={creatorName:this.app.options.personName},this.view.pagingContainerTop=this.pagingBarTop,this.view.pagingContainerBottom=this.pagingBarBottom,this.view.load()},resizeWindow:function(){var t=this.app.content.getSize();this.viewContainer.setStyles({height:t.y-121+"px"})}}),MWF.xApplication.ForumPerson.SubjectView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.ForumPerson.SubjectDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=30),i||(i=1);var s=this.filterData||{};this.app.isCurrentUser?this.actions.listMySubjectPage(i,e,s,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this)):this.actions.listUserSubjectPage(i,e,s,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteSubject(t.id,function(e){this.reload(),this.app.reloadAllParents(t.sectionId),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_openDocument:function(t,e){var i="ForumDocument"+t.id;this.app.desktop.apps[i]?this.app.desktop.apps[i].setCurrent():this.app.desktop.openApplication(null,"ForumDocument",{sectionId:t.sectionId,id:t.id,appId:i,isEdited:!1,isNew:!1,index:e})},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ForumPerson.SubjectDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){var t="ForumDocument"+this.data.id;this.app.desktop.apps[t]?this.app.desktop.apps[t].setCurrent():this.app.desktop.openApplication(null,"ForumDocument",{sectionId:this.data.sectionId,id:this.data.id,appId:t,isEdited:!0,isNew:!1,index:this.index})},openSection:function(t){var e=this.data,i="ForumSection"+e.sectionId;this.app.desktop.apps[i]?this.app.desktop.apps[i].setCurrent():this.app.desktop.openApplication(t,"ForumSection",{sectionId:e.sectionId,appId:i}),t.stopPropagation()},isAdmin:function(){return this.app.access.isAdmin()}}),MWF.xApplication.ForumPerson.ReplyView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){return new MWF.xApplication.ForumPerson.ReplyDocument(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody(),e||(e=30),i||(i=1);var s=this.filterData||{};this.actions.listMyReplyPage(i,e,s,function(e){e.data||(e.data=[]),e.count||(e.count=0),t&&t(e)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteReply(t.id,function(t){this.reload(),this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_openDocument:function(t,e){var i="ForumDocument"+t.id;this.app.desktop.apps[i]?this.app.desktop.apps[i].setCurrent():this.app.desktop.openApplication(null,"ForumDocument",{sectionId:t.sectionId,id:t.subjectId,replyIndex:t.orderNumber,appId:i,isEdited:!1,isNew:!1,index:e})},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}}),MWF.xApplication.ForumPerson.ReplyDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){var t="ForumDocument"+this.data.id;this.app.desktop.apps[t]?this.app.desktop.apps[t].setCurrent():this.app.desktop.openApplication(null,"ForumDocument",{sectionId:this.data.sectionId,id:this.data.id,appId:t,isEdited:!0,isNew:!1,index:this.index})},openSection:function(t){var e=this.data,i="ForumSection"+e.sectionId;this.app.desktop.apps[i]?this.app.desktop.apps[i].setCurrent():this.app.desktop.openApplication(t,"ForumSection",{sectionId:e.sectionId,appId:i}),t.stopPropagation()},isAdmin:function(){return this.app.access.isAdmin()},htmlToString:function(t){return(t=t.replace(/<img[^>]+>/g," ["+this.app.lp.picture+"] ")).replace(/<[^>]+>/g,"")}});