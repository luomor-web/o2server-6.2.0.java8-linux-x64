MWF.APPPD=MWF.xApplication.process.ProcessDesigner,MWF.APPPD.options={multitask:!0,executable:!1},MWF.require("MWF.widget.MWFRaphael",null,!1),MWF.xApplication.process.ProcessDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",template:"process.json",name:"process.ProcessDesigner",icon:"icon.png",title:MWF.APPPD.LP.title,appTitle:MWF.APPPD.LP.title,id:"",tooltip:{unCategory:MWF.APPPD.LP.unCategory},actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.APPPD.LP.newProcess),this.actions=MWF.Actions.get("x_processplatform_assemble_designer"),this.lp=MWF.xApplication.process.ProcessDesigner.LP},loadApplication:function(t){this.gadgets=[],this.gadgetMode="all",this.gadgetDecrease=0,this.createNode(),this.options.isRefresh?this.openProcess():this.maxSize(function(){this.openProcess()}.bind(this)),this.addKeyboardEvents(),t&&t()},addKeyboardEvents:function(){this.addEvent("copy",function(){this.copyModule()}.bind(this)),this.addEvent("paste",function(){this.pasteModule()}.bind(this)),this.addEvent("keySave",function(t){this.keySave(t)}.bind(this)),this.addEvent("keyDelete",function(t){this.keyDelete(t)}.bind(this))},keySave:function(t){this.shortcut&&(this.process&&this.saveProcess(),t.preventDefault())},keyDelete:function(t){if(this.shortcut&&this.process)if(this.process.selectedActivitys.length);else if(this.process.currentSelected){var e=this.content.getPosition();if(this.process.currentSelected.type){var s=this.process.currentSelected;t={event:{x:s.center.x+e.x,y:s.center.y+e.y}};this.process.deleteActivity(t,this.process.currentSelected)}else{var i=this.process.currentSelected;t={event:{x:i.beginPoint.x+e.x,y:i.beginPoint.y+e.y}};this.process.deleteRoute(t,this.process.currentSelected)}}},copyModule:function(){if(this.shortcut&&this.process)if(this.process.selectedActivitys.length){var t=[],e=[];this.process.selectedActivitys.each(function(s){t.push(Object.clone(s.data)),s.routes.each(function(t){t.toActivity,e.push(Object.clone(t.data))}.bind(this))}.bind(this)),MWF.clipboard.data={type:"process",data:{activitys:t,routes:e}}}else if(this.process.currentSelected)if(this.process.currentSelected.type){var s=Object.clone(this.process.currentSelected.data);MWF.clipboard.data={type:"process",data:{activitys:[s],routes:[]}}}else MWF.clipboard.data=null},pasteModuleError:function(t){this.notice(this.lp.notice.processCopyError,"error"),this.process.reload(t),MWF.clipboard.data=null},pasteModule:function(){if(this.process&&MWF.clipboard.data&&"process"==MWF.clipboard.data.type){var t=Object.clone(this.process.process);this.process.unSelectedAll();var e,s=MWF.clipboard.data.data.activitys,i=MWF.clipboard.data.data.routes;this.actions.getId(s.length+i.length,function(o){try{e=o.data;var n={},a=this.process.process.id;s.each((function(t){var s=e.pop().id;n[t.id]=s,t.id=s,t.process=a})),i.each((function(t){var s=e.pop().id;n[t.id]=s,t.id=s,t.process=a,t.activity=n[t.activity]})),s.each((function(t){t.route&&(t.route=n[t.route]),t.routeList&&t.routeList.each((function(e,s){t.routeList[s]=n[e]}))}));var c=function(){try{i.each(function(t){this.process.process.routeList.push(Object.clone(t)),this.process.routes[t.id]=new MWF.APPPD.Route(t,this.process),this.process.routeDatas[t.id]=t}.bind(this)),s.each(function(t){(this.process[t.type]||this.process[t.type+"s"][t.id]).loadRoutes(),s.length>1?(this.process[t.type]||this.process[t.type+"s"][t.id]).selectedMulti():this.process[t.type+"s"][t.id].selected()}.bind(this)),i.each(function(t){var e=this.process.routes[t.id];e.loaded||e.load()}.bind(this)),MWF.clipboard.data=null}catch(e){this.pasteModuleError(t)}},r=0;s.each(function(t){var e=Object.clone(t),i=e.type;if("begin"==i.toLowerCase())this.process.begin?(s.erase(t),r==s.length&&c.apply(this)):(this.process.process.begin=e,this.process.loadBegin(function(){++r==s.length&&c.apply(this)}.bind(this)));else{this.process.process[i+"List"]||(this.process.process[i+"List"]=[]),this.process.process[i+"List"].push(e);var o=i.capitalize();this.process.loadActivity(o,e,this.process[i+"s"],function(){++r==s.length&&c.apply(this)}.bind(this))}}.bind(this))}catch(e){this.pasteModuleError(t)}}.bind(this))}},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},openProcess:function(){this.loadNodes(),this.loadGadgets(),this.loadToolbar(function(){this.resizePaper(),this.addEvent("resize",function(){this.resizePaper()}.bind(this)),this.getProcessData(function(){this.loadPaper()}.bind(this))}.bind(this)),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this))},resizeNode:function(){var t=this.node.getSize(),e=this.gadgetTitleNode.getSize(),s=this.gadgetTitleNode.getStyle("margin-top").toFloat(),i=this.gadgetTitleNode.getStyle("margin-bottom").toFloat(),o=this.gadgetTitleNode.getStyle("padding-top").toFloat(),n=this.gadgetTitleNode.getStyle("padding-bottom").toFloat();y=e.y+s+i+o+n,y=t.y-y,this.gadgetContentNode.setStyle("height",y+"px")},getProcessData:function(t){this.options.id?this.loadProcessData(t):this.loadNewProcessData(t)},loadNewProcessData:function(t){var e="../x_component_process_ProcessDesigner/$Process/template/"+this.options.template;MWF.getJSON(e,{onSuccess:function(e){e.id="",e.isNewProcess=!0,this.processData=e,t&&t()}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadProcessData:function(t){this.actions.getProcess(this.options.id,function(e){e&&(this.processData=e.data,this.processData.isNewProcess=!1,this.setTitle(this.options.appTitle+"-"+this.processData.name),this.application?t&&t():this.actions.getApplication(e.data.application,function(e){this.application={name:e.data.name,id:e.data.id},t&&t()}.bind(this)))}.bind(this))},loadGadgets:function(){this.gadgetTitleNode=new Element("div",{styles:this.css.gadgetTitleNode,text:MWF.APPPD.LP.tools}).inject(this.gadgetAreaNode),this.gadgetTitleActionNode=new Element("div",{styles:this.css.gadgetTitleActionNode,events:{click:function(t){this.switchGadgetAreaMode()}.bind(this)}}).inject(this.gadgetAreaNode),this.gadgetContentNode=new Element("div",{styles:this.css.gadgetContentNode,events:{selectstart:function(t){t.preventDefault(),t.stopPropagation()}}}).inject(this.gadgetAreaNode),MWF.getJSON(this.path+"gadget.json",function(t){Object.each(t,function(t,e){this.createGadgetNode(t,e)}.bind(this))}.bind(this)),this.setScrollBar(this.gadgetContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}})},switchGadgetAreaMode:function(){if("all"==this.gadgetMode){var t=this.gadgetAreaNode.getSize();this.gadgetDecrease=t.x.toFloat()-60,this.gadgets.each((function(t){t.getLast().setStyle("display","none")})),this.gadgetTitleNode.set("text",""),this.gadgetAreaNode.setStyle("width","60px");var e=this.rightContentNode.getStyle("margin-left").toFloat();e-=this.gadgetDecrease,this.rightContentNode.setStyle("margin-left",e+"px"),this.gadgetTitleActionNode.setStyles(this.css.gadgetTitleActionNodeRight),this.gadgetMode="simple"}else{sizeX=60+this.gadgetDecrease;e=this.rightContentNode.getStyle("margin-left").toFloat();e+=this.gadgetDecrease,this.gadgetAreaNode.setStyle("width",sizeX+"px"),this.rightContentNode.setStyle("margin-left",e+"px"),this.gadgets.each((function(t){t.getLast().setStyle("display","block")})),this.gadgetTitleNode.set("text",MWF.APPPD.LP.tools),this.gadgetTitleActionNode.setStyles(this.css.gadgetTitleActionNode),this.gadgetMode="all"}},createGadgetNode:function(t,e){var s=this,i=new Element("div",{styles:this.css.gadgetToolNode,title:t.text,events:{mouseover:function(t){try{this.setStyles(s.css.gadgetToolNodeOver)}catch(t){this.setStyles(s.css.gadgetToolNodeOverCSS2)}},mouseout:function(t){try{this.setStyles(s.css.gadgetToolNode)}catch(t){}},mousedown:function(t){try{this.setStyles(s.css.gadgetToolNodeDown)}catch(t){this.setStyles(s.css.gadgetToolNodeDownCSS2)}},mouseup:function(t){try{this.setStyles(s.css.gadgetToolNodeUp)}catch(t){this.setStyles(s.css.gadgetToolNodeUpCSS2)}}}}).inject(this.gadgetContentNode);i.store("gadgetClass",t.className),i.store("gadgetType",e),i.store("gadgetIcon",t.icon),new Element("div",{styles:this.css.gadgetToolIconNode}).inject(i).setStyle("background-image","url("+this.path+this.options.style+"/gadget/"+t.icon+")"),new Element("div",{styles:this.css.gadgetToolTextNode,text:t.text}).inject(i),i.addEvent("mousedown",(function(t){var e=this.retrieve("gadgetClass"),i=this.retrieve("gadgetType"),o=this.retrieve("gadgetIcon");s.gadgetCreateActivity(this,i,o,e,t)})),this.gadgets.push(i)},gadgetCreateActivity:function(t,e,s,i,o){var n=null,a=new Element("div",{styles:{width:"30px",height:"30px",opacity:"1",background:"url("+this.path+this.options.style+"/gadget/"+s+") top left no-repeat",postion:"absolute"}}).inject(this.paperNode),c=(a.getSize(),o.page.x),r=o.page.y;a.positionTo(c,r);var d=[this.paperNode];new Drag.Move(a,{droppables:d,onEnter:function(t,e){a.setStyles({opacity:"1",background:"url("+this.path+this.options.style+"/gadget/"+s+") top left no-repeat"})}.bind(this),onLeave:function(t,e){a.setStyles({opacity:"1",background:"url("+this.path+this.options.style+"/gadget/stop.png) top left no-repeat"}),n&&n.destroy(),a.dragMove=!1}.bind(this),onDrag:function(t){if(a.dragMove){var e=a.getPosition(this.paperNode),s=e.x-a.dx,i=e.y-a.dy;n.activityMove(s,i,0,0,t)}}.bind(this),onDrop:function(t,e){}.bind(this),onComplete:function(t){var s=a.getPosition(this.paperNode);(n=this.process.createActivity(e,i,{x:s.x,y:s.y}))&&n.selected(),a.destroy()}.bind(this),onCancel:function(t){n&&n.destroy(),a.destroy()}.bind(this)}).start(o)},loadNodes:function(){this.gadgetAreaNode=new Element("div",{styles:this.css.gadgetAreaNode}).inject(this.node),this.rightContentNode=new Element("div",{styles:this.css.rightContentNode}).inject(this.node),this.toolbarNode=new Element("div",{styles:this.css.toolbarNode}).inject(this.rightContentNode),this.paperAreaNode=new Element("div",{styles:this.css.paperAreaNode}).inject(this.rightContentNode),this.paperNode=new Element("div",{styles:this.css.paperNode}).inject(this.paperAreaNode)},loadToolbar:function(t){this.getProcessToolbarHTML(function(e){e.getElements("span").each(function(t,e){var s=t.get("MWFButtonImage");s&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbarIcon/"+s)}.bind(this)),$(e).inject(this.toolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.processToolbar=new MWF.widget.Toolbar(e,{style:"Process"},this),this.processToolbar.load(),t&&t()}.bind(this));var s=e.getElement("select");s&&s.addEvent("change",function(){this.process.setStyle(s.options[s.selectedIndex].value)}.bind(this)),this.processEditionNode=e.getElement(".processEdition"),this.processEditionInforNode=e.getElement(".processEditionInfor")}.bind(this))},getProcessToolbarHTML:function(t){var e=this.path+"processToolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,s,i,o){var n=e[0];t&&t(n)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},resizePaper:function(){var t=this.node.getSize(),e=this.processToolbar.node.getSize(),s=t.y-e.y;if(s=s-this.paperNode.getStyle("margin-top").toFloat()-this.paperNode.getStyle("margin-bottom").toFloat(),this.paperNode.setStyle("height",s+"px"),this.paper&&this.paper.setSize("100%","100%"),this.process&&this.process.panel){this.process.panel.modulePanel.container.position({relativeTo:this.paperNode,position:"upperRight",edge:"upperRight"});var i=this.process.panel.modulePanel.container.getSize();if((n=this.paperNode.getSize()).y<i.y){var o=this.paperNode.getSize().y.toFloat()-6;this.process.panel.modulePanel.container.setStyle("height",o+"px"),this.process.panel.modulePanel.content.setStyle("height",this.process.panel.modulePanel.getContentHeight()),this.process.panel.setPanelSize()}if(n.x<i.x&&this.process.panel.modulePanel.container.setStyle("width",n.x+"px"),this.process.panel.propertyPanel){this.process.panel.propertyPanel.container.position({relativeTo:this.paperNode,position:"bottomRight",edge:"bottomRight"});var n;i=this.process.panel.propertyPanel.container.getSize();if((n=this.paperNode.getSize()).y<i.y){o=this.paperNode.getSize().y.toFloat()-6;this.process.panel.propertyPanel.container.setStyle("height",o+"px"),this.process.panel.propertyPanel.content.setStyle("height",this.process.panel.propertyPanel.getContentHeight()),this.process.panel.setPropertyPanelSize()}n.x<i.x&&this.process.panel.propertyPanel.container.setStyle("width",n.x+"px")}}},loadPaper:function(){MWFRaphael.load(function(){this.paperInNode=new Element("div",{styles:this.css.paperInNode}).inject(this.paperNode),this.paper=Raphael(this.paperInNode,"100%","99%"),this.paper.container=this.paperNode,MWF.xDesktop.requireApp("process.ProcessDesigner","Process",function(){this.process=new MWF.APPPD.Process(this.paper,this.processData,this,{style:"flat",onPostLoad:function(){this.fireEvent("postProcessLoad")}.bind(this)}),this.process.load()}.bind(this))}.bind(this))},setToolBardisabled:function(t){t},recordStatus:function(){return{id:this.options.id}},saveProcess:function(){if(!this.process.process.name)return this.notice(this.lp.notice.no_name,"error"),!1;this.process.save(function(){var t=this.process.process.name;this.setTitle(this.options.appTitle+"-"+t),this.options.desktopReload=!0,this.options.id=this.process.process.id}.bind(this))},saveNewProcess:function(t,e){},createManualActivity:function(){this.process.createManualActivity()},createConditionActivity:function(){this.process.createConditionActivity()},createAutoActivity:function(){this.process.createAutoActivity()},createSplitActivity:function(){this.process.createSplitActivity()},createMergeActivity:function(){this.process.createMergeActivity()},createEmbedActivity:function(){this.process.createEmbedActivity()},createInvokesActivity:function(){this.process.createInvokesActivity()},createBeginActivity:function(){this.process.createBeginActivity()},createEndActivity:function(){this.process.createEndActivity()},createRoute:function(){this.process.createRoute()},processExplode:function(){this.process.explode()},saveNewEdition:function(t,e){this.process.saveNewEdition(e)},listEdition:function(t,e){this.process.listEdition(e)},onPostClose:function(){this.process&&(this.process.activitys.each((function(t){t.routes.each((function(t){MWF.release(t)})),MWF.release(t)})),MWF.release(this.process))}});