MWF.require("MWF.widget.UUID",null,!1),MWF.require("MWF.widget.JsonTemplate",null,!1),MWF.xApplication.process.ProcessDesigner.Property=new Class({Implements:[Options,Events],load:function(){this.process.options.isView||(this.fireEvent("queryLoad")&&MWF.getRequestText(this.htmlPath,function(t,e){this.htmlString=t,this.fireEvent("postLoad")}.bind(this)),this.process.propertyListNode.addEvent("keydown",(function(t){t.stopPropagation()})))},editProperty:function(t){},getHtmlString:function(t){this.htmlString?t&&t():MWF.getRequestText(this.htmlPath,function(e,i){this.htmlString=e,t&&t()}.bind(this))},hideAdvanced:function(){if(this.process.panel.showAdvanced&&!this.process.panel.showAdvanced.checked){var t=this.propertyContent.querySelectorAll('*[data-o2-advanced="yes"]');if(t&&t.length)for(var e=0;e<t.length;e++)t[e].hide()}},show:function(){this.process.options.isView||(this.propertyContent?(this.process.panel.data=this.data,this.propertyContent.setStyle("display","block"),this.process.panel.propertyTabPage.showTabIm()):this.getHtmlString(function(){this.htmlString=o2.bindJson(this.htmlString,{lp:o2.APPPD.LP.propertyTemplate}),this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.process.propertyListNode),this.process.panel.propertyTabPage.showTabIm(),this.JsonTemplate=new MWF.widget.JsonTemplate(this.data,this.htmlString),this.propertyContent.set("html",this.JsonTemplate.load()),this.process.panel.data=this.data,this.setEditNodeEvent(),this.setEditNodeStyles(this.propertyContent),this.loadPropertyTab(),this.loadFormFieldInput(),this.loadPersonInput(),this.loadCalendarInput(),this.loadScriptInput(),this.loadScriptText(),this.loadConditionInput(),this.loadFormSelect(),this.loadSerial(),this.loadSericalActivitySelect(),this.loadApplicationSelector(),this.loadProcessSelector(),this.loadIconSelect(),this.loadContextRoot(),this.loadProjection(),this.hideAdvanced()}.bind(this)))},hide:function(){this.process.options.isView||this.propertyContent&&this.propertyContent.setStyle("display","none")},loadPropertyTab:function(){var t=this.propertyContent.getElements(".MWFTab");if(t.length){var e=this.propertyContent.getFirst(),i=new Element("div",{styles:this.process.css.propertyTabNode}).inject(e,"before");MWF.require("MWF.widget.Tab",function(){var e=new MWF.widget.Tab(i,{style:"moduleList"});e.load();var s=[];t.each(function(t){var i=e.addTab(t,t.get("title"),!1);s.push(i),t.hasAttribute("data-o2-advanced")&&"yes"==t.dataset.o2Advanced&&i.tabNode.setAttribute("data-o2-advanced","yes")}.bind(this)),s[0].showTab()}.bind(this))}},setEditNodeEvent:function(){var t=this;this.propertyContent.getElements("input").each(function(e){var i=e.get("name"),s=this.process.process.id;if(this.activity&&(s=this.activity.data.id),this.route&&(s=this.route.data.id),i)switch(e.get("type").toLowerCase()){case"radio":e.set("name",s+i),e.addEvent("change",(function(e){t.setRadioValue(i,this)})),e.addEvent("blur",(function(e){t.setRadioValue(i,this)})),e.addEvent("keydown",(function(t){t.stopPropagation()})),t.setRadioValue(i,e);break;case"checkbox":e.set("name",s+i),e.addEvent("keydown",(function(t){t.stopPropagation()}));break;default:e.addEvent("change",(function(e){t.setValue(i,this.value)})),e.addEvent("blur",(function(e){t.setValue(i,this.value)})),e.addEvent("keydown",(function(e){13===e.code&&t.setValue(i,this.value),e.stopPropagation()})),t.setValue(i,e.get("value"))}}.bind(this)),this.propertyContent.getElements("select").each((function(e){var i=e.get("name");i&&e.addEvent("change",(function(e){t.setSelectValue(i,this)}))})),this.propertyContent.getElements("textarea").each(function(e){var i=e.get("name");i&&(e.addEvent("change",(function(e){t.setValue(i,this.value)})),e.addEvent("blur",(function(e){t.setValue(i,this.value)})),e.addEvent("keydown",(function(t){t.stopPropagation()})))}.bind(this))},setSelectValue:function(t,e){var i=e.selectedIndex,s=e.getElements("option"),n="";s[i]&&(n=s[i].get("value")),this.data[t]=n},setRadioValue:function(t,e){if(e.checked){var i=this.data[t],s=e.value;"false"==s&&(s=!1),"true"==s&&(s=!0),this.data[t]=s,this.route&&this.route._setEditProperty(t,e,i)}},setValue:function(t,e){var i=this.data[t];this.data[t]=e,"name"==t&&(e||(this.data[t]=MWF.APPPD.LP.unnamed)),this.route&&this.route._setEditProperty(t,input,i)},setEditNodeStyles:function(t){var e=t.getChildren();e.length&&e.each(function(t){var e=t.get("class");e&&this.process.css[e]&&t.setStyles(this.process.css[e]),this.setEditNodeStyles(t)}.bind(this))},loadScriptText:function(){this.scriptTexts=[];var t=this.propertyContent.getElements(".MWFScriptText");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ScriptText",function(){var e=this;t.each(function(t){var i=new MWF.xApplication.process.ProcessDesigner.widget.ScriptText(t,this.data[t.get("name")],this.process.designer,{maskNode:this.process.designer.content,maxObj:this.process.designer.paperNode,onChange:function(i){e.data[t.get("name")]=i}});this.scriptTexts.push(i)}.bind(this))}.bind(this))},loadScriptInput:function(){var t=this.propertyContent.getElements(".MWFScript");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ScriptSelector",function(){var e=this;t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.ScriptSelector(t,this.data[t.get("name")],this.process.designer,{maskNode:this.process.designer.content,onSelected:function(i){e.data[t.get("name")]=i.name},onDelete:function(){e.data[t.get("name")]="",t.empty()}})}.bind(this))}.bind(this))},loadScriptArea:function(){var t=this.propertyContent.getElements(".MWFScriptArea"),e=this.propertyContent.getElements(".MWFFormulaArea");this.loadScriptEditor(t),this.loadScriptEditor(e,"formula")},loadScriptEditor:function(t,e){t.each(function(t){var i=t.get("title"),s=t.get("name");this.data[s]||(this.data[s]={code:"",html:""});var n=this.data[s];MWF.require("MWF.widget.ScriptArea",function(){var o=new MWF.widget.ScriptArea(t,{title:i,maxObj:this.process.designer.content,onChange:function(){this.data[s]||(this.data[s]={code:"",html:""});var t=o.toJson();this.data[s].code=t.code}.bind(this),style:e||"default"});o.load(n)}.bind(this))}.bind(this))},loadUnitTypeSelector:function(){var t=this.propertyContent.getElements(".MWFFormUnitTypeSelector");t.length&&this.getUnitTypeList(function(){t.each(function(t){var e=new Element("select").inject(t);e.addEvent("change",function(t){this.setValue(t.target.getParent("div").get("name"),t.target.options[t.target.selectedIndex].value)}.bind(this)),this.setUnitTypeSelectOptions(t,e),this.setValue(e.getParent("div").get("name"),e.options[e.selectedIndex].value)}.bind(this))}.bind(this))},setUnitTypeSelectOptions:function(t,e){var i=t.get("name");e.empty();new Element("option",{value:"all",text:MWF.xApplication.process.ProcessDesigner.LP.all,selected:!this.data[i]||"all"===this.data[i]}).inject(e);this.unitTypeList.each(function(t){new Element("option",{text:t,value:t,selected:this.data[i]===t}).inject(e)}.bind(this))},getUnitTypeList:function(t,e){!this.unitTypeList||e?MWF.Actions.get("x_organization_assemble_control").listUnitType(function(e){this.unitTypeList=e.data.valueList,t&&t()}.bind(this)):t&&t()},loadFormFieldInput:function(){var t=this.propertyContent.getElements(".MWFFormFieldPerson");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"formField",application:this.process.process.application,fieldType:"person",names:this.data[t.get("name")]||[],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this))}.bind(this))},createCalendar:function(t){if(!t.retrieve("calendar")){var e=new MWF.widget.Calendar(t,{isTime:!0,style:"xform",secondEnable:!0,format:"db",onChange:function(e,i,s){this.setValue(t.get("name"),e)}.bind(this)});t.store("calendar",e)}},loadCalendarInput:function(){var t=this.propertyContent.getElements(".MWFDateTime");MWF.require("MWF.widget.Calendar",function(){t.each(function(t){var e=t.getFirst();e.addEvents({click:function(){this.createCalendar(e)}.bind(this),focus:function(){this.createCalendar(e)}.bind(this)})}.bind(this))}.bind(this))},loadPersonInput:function(){var t=this.propertyContent.getElements(".MWFPersonIdentity"),e=this.propertyContent.getElements(".MWFPersonPerson"),i=this.propertyContent.getElements(".MWFPersonUnit"),s=this.propertyContent.getElements(".MWFPersonGroup"),n=this.propertyContent.getElements(".MWFPersonDuty"),o=this.propertyContent.getElements(".MWFDutySelector");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t.each(function(t){count=t.get("count")||0,new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"identity",names:this.data[t.get("name")],count:count,onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),e.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"person",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),i.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"unit",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),s.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"group",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this)),o.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"duty",names:this.data[t.get("name")],onChange:function(e){this.addDutyItem(t,e)}.bind(this),onRemoveDuty:function(e){this.removeDutyItem(t,e)}.bind(this)})}.bind(this)),n.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.process.designer,{type:"dutyName",names:this.data[t.get("name")],onChange:function(e){this.savePersonItem(t,e)}.bind(this)})}.bind(this))}.bind(this))},removeDutyItem:function(t,e){if(e.data.id){var i=JSON.decode(this.data[t.get("name")])||[];i.filter((function(t){return t.id==e.data.id})).each((function(t){i=i.erase(t)})),this.data[t.get("name")]=JSON.encode(i)}e.node.destroy(),MWF.release(e),delete e},addDutyItem:function(t,e){var i=this.data[t.get("name")]||"";i||(i="[]");var s=JSON.decode(i);e.each(function(t){if(t.data.dutyId){for(var e=0;e<s.length;e++)if(s[e].dutyId===t.data.dutyId){s[e].name=t.data.name,s[e].code=t.data.code;break}}else t.data.dutyId=(new MWF.widget.UUID).toString(),s.push({name:t.data.name,id:t.data.id,dutyId:t.data.dutyId,code:t.data.code})}.bind(this)),this.data[t.get("name")]=JSON.encode(s)},savePersonItem:function(t,e){count=t.get("count")||0;var i=[];e.each(function(t){i.push(t.data.distinguishedName||t.data.id)}.bind(this)),this.data[t.get("name")]=count&&1==count.toInt()?i[0]:i},savePersonObjectItem:function(t,e){var i=[];e.each(function(t){i.push(t.data)}.bind(this)),this.data[t.get("name")]=i},loadConditionInput:function(){this.propertyContent.getElements(".MWFCondition").each(function(t){MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ConditionEditor",function(){var e=new MWF.xApplication.process.ProcessDesigner.widget.ConditionEditor(t,{onPostSave:function(e){this.saveScriptItem(t,e)}.bind(this),onQueryDelete:function(e){this.deleteScriptItem(t,e)}.bind(this)});this.setScriptItems(e,t)}.bind(this))}.bind(this))},loadFormSelect:function(){var t=this.propertyContent.getElements(".MWFFormSelect");t.length&&this.getFormList(function(){t.each(function(t){var e=new Element("select").inject(t);new Element("option",{text:"none"}).inject(e);e.addEvent("change",function(t){this.setValue(t.target.getParent("div").get("name"),t.target.options[t.target.selectedIndex].value)}.bind(this)),this.setFormSelectOptions(t,e),new Element("div",{styles:this.process.css.propertyRefreshFormNode}).inject(t).addEvent("click",function(i){this.getFormList(function(){this.setFormSelectOptions(t,e)}.bind(this),!0)}.bind(this))}.bind(this))}.bind(this))},setFormSelectOptions:function(t,e){var i=t.get("name");e.empty();new Element("option",{text:"none"}).inject(e);this.forms.each(function(t){new Element("option",{text:t.name,value:t.id,selected:this.data[i]==t.id}).inject(e)}.bind(this))},getFormList:function(t,e){!this.forms||e?this.process.designer.actions.listForm(this.process.designer.application.id,function(e){this.forms=e.data,t&&t()}.bind(this)):t&&t()},loadSerial:function(){var t=this.propertyContent.getElements(".MWFSerial");t.length&&MWF.xDesktop.requireApp("process.ProcessDesigner","widget.SerialEditor",function(){t.each(function(t){var e=new MWF.xApplication.process.ProcessDesigner.widget.SerialEditor(t,this.data[t.get("name")]);e.addEvent("change",function(i){this.setValue(t.get("name"),JSON.encode(e.getData()))}.bind(this)),e.process=this.process,e.load()}.bind(this))}.bind(this))},loadSericalActivitySelect:function(){var t=this.propertyContent.getElements(".MWFSericalActivitySelect");t.length&&t.each(function(t){var e=new Element("select").inject(t);e.addEvent("change",function(t){this.setValue(t.target.getParent("div").get("name"),t.target.options[t.target.selectedIndex].value)}.bind(this)),this.listSericalActivityOptions(t,e),new Element("div",{styles:this.process.css.propertyRefreshFormNode}).inject(t).addEvent("click",function(i){this.listSericalActivityOptions(t,e)}.bind(this))}.bind(this))},listSericalActivityOptions:function(t,e){var i=t.get("name");e.empty();new Element("option",{text:"none"}).inject(e),new Element("option",{text:this.process.process.begin.name,value:this.process.process.begin.id,selected:this.data[i]===this.process.process.begin.id}).inject(e);this.listSericalActivitys("endList",i,e),this.listSericalActivitys("cancelList",i,e),this.listSericalActivitys("manualList",i,e),this.listSericalActivitys("conditionList",i,e),this.listSericalActivitys("choiceList",i,e),this.listSericalActivitys("splitList",i,e),this.listSericalActivitys("parallelList",i,e),this.listSericalActivitys("mergeList",i,e),this.listSericalActivitys("embedList",i,e),this.listSericalActivitys("delayList",i,e),this.listSericalActivitys("invokeList",i,e),this.listSericalActivitys("serviceList",i,e),this.listSericalActivitys("agentList",i,e),this.listSericalActivitys("messageList",i,e)},listSericalActivitys:function(t,e,i){var s=this.process.process[t];s&&(s.length&&s.each(function(t){new Element("option",{text:t.name,value:t.id,selected:this.data[e]===t.id}).inject(i)}.bind(this)))},loadApplicationSelector:function(){var t=this.propertyContent.getElements(".MWFApplicationSelect");t.length&&this._getAppSelector(function(){t.each(function(t){new Element("div",{styles:this.process.css.applicationSelectTitle,text:t.get("title")}).inject(t);var e=new Element("div",{styles:this.process.css.applicationSelectAction,text:t.get("title")}).inject(t),i=new Element("div",{styles:this.process.css.applicationSelectContent}).inject(t);e.addEvent("click",function(t){this.appSelector.load(function(t){i.empty(),t.length?(this.data.targetApplication=t[0].id,this.data.targetApplicationName=t[0].name,this.data.targetApplicationAlias=t[0].alias,new Element("div",{styles:this.process.css.applicationSelectItem,text:t[0].name}).inject(i)):(this.data.targetApplication="",this.data.targetApplicationName="",this.data.targetApplicationAlias=""),this.propertyContent.getElements(".MWFProcessSelect").each(function(t){this.data.targetProcess="",this.data.targetProcessName="",this.data.targetProcessAlias="",t.getLast().empty()}.bind(this))}.bind(this))}.bind(this)),this.data.targetApplication&&new Element("div",{styles:this.process.css.applicationSelectItem,text:this.data.targetApplicationName}).inject(i)}.bind(this))}.bind(this))},_getAppSelector:function(t){this.appSelector?t&&t():MWF.xDesktop.requireApp("process.ProcessManager","widget.ApplicationSelector",function(){this.appSelector=new MWF.xApplication.process.ProcessManager.widget.ApplicationSelector(this.process.designer,{maskNode:this.process.designer.content,multi:!1}),t&&t()}.bind(this))},loadProcessSelector:function(){var t=this.propertyContent.getElements(".MWFProcessSelect");t.length&&t.each(function(t){new Element("div",{styles:this.process.css.applicationSelectTitle,text:t.get("title")}).inject(t);var e=new Element("div",{styles:this.process.css.applicationSelectAction,text:t.get("title")}).inject(t),i=new Element("div",{styles:this.process.css.applicationSelectContent}).inject(t);e.addEvent("click",function(t){new o2.O2Selector(this.process.designer.content,{count:1,type:"process",onComplete:function(t){t.length?(i.empty(),this.data.targetApplication=t[0].data.application,this.data.targetApplicationName=t[0].data.applicationName,this.data.targetApplicationAlias="",this.data.targetProcess=t[0].data.id,this.data.targetProcessName=t[0].data.name,this.data.targetProcessAlias=t[0].data.alias,new Element("div",{styles:this.process.css.applicationSelectItem,text:this.data.targetProcessName}).inject(i)):(this.data.targetApplication="",this.data.targetApplicationName="",this.data.targetApplicationAlias="",this.data.targetProcess="",this.data.targetProcessName="",this.data.targetProcessAlias="",i.empty())}.bind(this)})}.bind(this)),this.data.targetProcess&&new Element("div",{styles:this.process.css.applicationSelectItem,text:this.data.targetProcessName}).inject(i)}.bind(this))},_getProcessSelector:function(t){this.processSelector?t&&t():MWF.xDesktop.requireApp("process.ProcessManager","widget.ProcessSelector",function(){this.processSelector=new MWF.xApplication.process.ProcessManager.widget.ProcessSelector(this.process.designer,{maskNode:this.process.designer.content,multi:!1}),t&&t()}.bind(this))},loadIconSelect:function(){var t=this.propertyContent.getElements(".MWFIcon");t.length&&t.each(function(t){var e=t.get("name"),i=this.data[e],s=new Element("div",{styles:this.process.css.processIconNode}).inject(t);i&&s.setStyles({background:"url("+i+") center center no-repeat"}),new Element("div",{styles:this.process.css.processIconSelectNode,text:this.process.designer.lp.selectIcon}).inject(t).addEvent("click",function(){this.selectIcon(t)}.bind(this))}.bind(this))},loadContextRoot:function(){var t=this.propertyContent.getElements(".MWFContextRoot");t&&t.each(function(t){var e=t.get("name"),i=this.data[e],s=new Element("select").inject(t);Object.each(layout.serviceAddressList,function(t,e){new Element("option",{value:e,text:t.name,selected:i==e}).inject(s)}.bind(this)),s.addEvent("change",function(){var t=s.options[s.selectedIndex].value;this.setValue(e,t)}.bind(this))}.bind(this))},loadProjection:function(){var t=this.propertyContent.getElements(".MWFProjection");t&&t.each(function(t){var e=t.get("name"),i=this.data[e];MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ProjectionEditor",function(){var e=new MWF.xApplication.process.ProcessDesigner.widget.ProjectionEditor(t,i,{onChange:function(){this.setValue(t.get("name"),JSON.encode(e.getData()))}.bind(this),process:this.process.process.id});e.load()}.bind(this))}.bind(this))},selectIcon:function(t){if(!t.iconMenu){var e=new MWF.widget.Menu(t,{event:"click",style:"processIcon"});e.load(),t.iconMenu=e;for(var i=this,s=0;s<=48;s++){var n="../x_component_process_ProcessManager/$Explorer/default/processIcon/process_icon_"+s+".png";e.addMenuItem("","click",(function(){var e=t.get("name"),s=this.item.getElement("img").get("src");i.data[e]=s,t.getFirst("div").setStyle("background-image","url("+s+")")}),n).iconName=n}}},deleteScriptItem:function(t,e){var i=t.get("name");this.data[i].erase(e.data.id),this.process.scripts[e.data.id]=null,delete this.process.scripts[e.data.id],this.process.process.scriptList.erase(e.data)},saveScriptItem:function(t,e){var i=t.get("name"),s=this.data[i],n=e.data;this.process.scripts[e.data.id]||(this.process.process.scriptList.push(n),this.process.scripts[e.data.id]=n),-1==s.indexOf(n.id)&&this.data[i].push(n.id)},setScriptItems:function(t,e){var i=e.get("name"),s=this.data[i];s&&s.each(function(e){if(e){var i=this.process.scripts[e];i&&t.setScriptItem(i)}}.bind(this))},showMultiActivity:function(t){this.hide();var e=new HtmlTable({properties:this.process.css.activityListTable}).inject(this.propertyContent);t.each(function(t){this.row=e.push([{content:" ",properties:{styles:t.style.listIcon}},{content:t.data.name,properties:{width:"80px",styles:this.process.css.list.listText}},{content:" "+t.data.description,properties:{styles:this.process.css.list.listTextDescription}}])}.bind(this))},loadOrgEditor:function(){var t=this.propertyContent.getElements(".MWFOrgEditor");t.length&&t.each(function(t){MWF.xDesktop.requireApp("process.ProcessDesigner","widget.OrgEditor",function(){new MWF.xApplication.process.ProcessDesigner.widget.OrgEditor(t,this.route,this.data.selectConfig,{onPostSave:function(t){}.bind(this),onQueryDelete:function(t){}.bind(this)}).load()}.bind(this))}.bind(this))}});