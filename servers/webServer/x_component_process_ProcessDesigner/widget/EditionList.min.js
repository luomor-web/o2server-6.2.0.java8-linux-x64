MWF.xApplication.process.ProcessDesigner.widget=MWF.xApplication.process.ProcessDesigner.widget||{},MWF.xApplication.process.ProcessDesigner.widget.EditionList=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default"},initialize:function(t,i,e,s){this.setOptions(s),this.application=t,this.edition=i,this.process=e,this.path="../x_component_process_ProcessDesigner/widget/$EditionList/",this.cssPath="../x_component_process_ProcessDesigner/widget/$EditionList/"+this.options.style+"/css.wcss",this._loadCss(),this.currentItem=null,this.items=[],this.lp=MWF.xApplication.process.ProcessDesigner.LP},load:function(){this.node=new Element("div",{styles:this.css.node}),this.leftNode=new Element("div",{styles:this.css.leftNode}).inject(this.node),this.rightNode=new Element("div",{styles:this.css.rightNode}).inject(this.node),this.listNode=new Element("div",{styles:this.css.listNode}).inject(this.leftNode),this.resizeNode=new Element("div",{styles:this.css.resizeNode}).inject(this.rightNode),this.diffNode=new Element("ul",{styles:this.css.diffNode}).inject(this.rightNode),this.createListTable(),this.show()},createListTable:function(){var t="<table width='100%' cellspacing='0' cellpadding='3' style='margin-top: 1px'><tr><th></th><th>"+this.lp.edition_list.number+"</th><th>"+this.lp.edition_list.update+"</th><th>"+this.lp.edition_list.updatePerson+"</th><th>"+this.lp.edition_list.enabled+"</th><th>"+this.lp.edition_list.description+"</th><th>"+this.lp.edition_list.action+"</th></tr></table>";this.listNode.set("html",t),this.listTable=this.listNode.getElement("table"),this.listTable.setStyles(this.css.listTable);var i=this.listNode.getElements("th").setStyles(this.css.listTable_th);i[i.length-1].setStyles(this.css.listTable_td_right)},reloadList:function(){this.items=[],this.listNode.empty(),this.diffNode.empty(),this.createListTable(),o2.Actions.load("x_processplatform_assemble_designer").ProcessAction.listEdition(this.application,this.edition,function(t){this.editionList=t.data,this.listEditionDlg()}.bind(this))},show:function(){this.dlg||(this.dlg=this.createDlg())},createDlg:function(t){return o2.DL.open({title:this.lp.edition_list.editionList,content:this.node,offset:{y:-100},isMax:!0,width:900,height:500,buttonList:[{text:this.lp.edition_list.open,action:function(){this.openCurrentEdition(),this.dlg.close()}.bind(this),title:this.lp.edition_list.openInfor},{type:"cancel",text:MWF.xApplication.process.ProcessDesigner.LP.close,action:function(){this.close()}}],onPostShow:function(){this.setEvent(),this.reloadList(),t&&t()}.bind(this),onPostClose:function(){this.dlg=null}.bind(this)})},listEditionDlg:function(){this.editionList.each(function(t){var i=new MWF.xApplication.process.ProcessDesigner.widget.EditionList.Item(this,t);this.items.push(i)}.bind(this))},setEvent:function(){var t=this.dlg.button.getElements("input");this.openCurrentEditionButton=t[0];var i,e,s=this.openCurrentEditionButton.getStyle("display");this.openCurrentEditionButton.store("dsp",s),this.openCurrentEditionButton.setStyle("display","none");var n=new Drag(this.resizeNode,{onSnap:function(t){t.setStyle("background","#cccccc")},onStart:function(t,s){i=this.node.getSize(),e=this.leftNode.getSize(),n.x=s.event.x}.bind(this),onComplete:function(t){t.setStyle("background-color","transparent")},onDrag:function(t,s){var o=n.x-s.event.x,c=e.x-o;(c=c/i.x*100)<30&&(c=30),c>70&&(c=70),this.leftNode.setStyle("width",c+"%"),c=100-c,this.rightNode.setStyle("width",c+"%")}.bind(this)})},openCurrentEdition:function(){this.currentItem&&this.currentItem.edition.fullProcess.id!=this.process.process.id&&this.process.save(function(){this.process.reload(this.currentItem.edition.fullProcess)}.bind(this))},checkButtonDisable:function(){this.currentItem&&this.currentItem.edition.fullProcess.id!=this.process.process.id?this.openCurrentEditionButton.setStyle("display",this.openCurrentEditionButton.retrieve("dsp")):this.openCurrentEditionButton.setStyle("display","none")}}),MWF.xApplication.process.ProcessDesigner.widget.EditionList.Item=new Class({initialize:function(t,i){this.list=t,this.edition=i,this.table=this.list.listTable,this.css=this.list.css,this.lp=this.list.lp,this.isCurrentEdition=this.list.process.process.id==this.edition.id,this.load()},load:function(){this.node=new Element("tr").inject(this.table);var t="<td></td><td>"+this.edition.editionNumber+"</td><td>"+this.edition.updateTime+"</td><td>"+o2.name.cn(this.edition.lastUpdatePerson)+"</td><td>"+(this.edition.editionEnable?this.lp.edition_list.yes:this.lp.edition_list.no)+"</td><td>"+(this.edition.editionDes||"")+"</td><td></td>";this.node.set("html",t);var i=this.node.getElements("td").setStyles(this.isCurrentEdition?this.css.listTable_td_current:this.css.listTable_td);i[i.length-1].setStyles(this.css.listTable_td_right),this.iconTd=i[0].setStyles(this.css.listTable_td_icon),this.selectIconNode=new Element("div",{styles:this.css.unselectIcon}).inject(this.iconTd),this.actionTd=i[i.length-1].setStyles(this.css.listTable_td_action),this.createActions(),this.setEvent()},createActions:function(){if(!this.edition.editionEnable){this.enableAction=new Element("div.mainColor_bg",{styles:this.css.enableAction,text:this.lp.edition_list.enable}).inject(this.actionTd);var t=this.lp.edition_list.enableInfor.replace(/{v}/,this.edition.editionNumber);this.enableAction.set("title",t)}this.isCurrentEdition||this.edition.editionEnable||(this.delAction=new Element("div",{styles:this.css.delAction,text:this.lp.edition_list.del}).inject(this.actionTd),t=this.lp.edition_list.delInfor.replace(/{v}/,this.edition.editionNumber),this.delAction.set("title",t))},setEvent:function(){this.node.addEvent("click",function(){this.selected()}.bind(this)),this.enableAction&&this.enableAction.addEvents({click:function(t){this.enable(t),t.stopPropagation()}.bind(this)}),this.delAction&&this.delAction.addEvents({click:function(t){this.del(t),t.stopPropagation()}.bind(this)})},enable:function(t){var i=o2.Actions.load("x_processplatform_assemble_designer").ProcessAction,e=this;this.list.process.designer.confirm("infor",t,this.lp.edition_list.enabledProcessTitle,{html:this.lp.edition_list.enabledProcessInfor},600,120,(function(){e.list.process.save(function(){i.enableProcess(this.edition.id,function(t){this.list.reloadList(),i.get(this.list.process.process.id,function(t){this.list.process.reload(t.data)}.bind(this))}.bind(this))}.bind(e)),this.close()}),(function(){this.close()}))},del:function(t){var i=this,e=this.lp.edition_list.deleteEditionInfor.replace(/{v}/g,this.edition.editionNumber);this.list.process.designer.confirm("warn",t,this.lp.edition_list.deleteEditionTitle,e,460,120,(function(){i.deleteEdition(),this.close()}),(function(){this.close()}))},deleteEdition:function(t){o2.Actions.load("x_processplatform_assemble_designer").ProcessAction.delete(this.edition.id,"true",function(){this.unSelected(),this.node.destroy(),t&&t()}.bind(this))},selected:function(){this.list.currentItem&&this.list.currentItem.unSelected(),this.node.setStyles(this.css.itemTr_selected).addClass("lightColor_bg"),this.selectIconNode.setStyles(this.css.selectIcon).addClass("mainColor_bg"),this.list.currentItem=this,this.checkDiff(),this.list.checkButtonDisable()},unSelected:function(){this.node.setStyles(this.css.itemTr).removeClass("lightColor_bg"),this.selectIconNode.setStyles(this.css.unselectIcon).removeClass("mainColor_bg"),this.list.currentItem=null,this.list.diffNode.empty()},checkDiff:function(){this.getFullProcess(function(){var t=this.getPrevItem();if(t){t.getFullProcess();var i=this.getDiffWithProcess(t.edition.fullProcess);i.length?(this.appendDiffLine(this.lp.edition_list.hasDiffs),i.each(function(t){this.appendDiffLine(t)}.bind(this))):this.appendDiffLine(this.lp.edition_list.noDiffs)}else this.appendDiffLine(this.lp.edition_list.newProcess),this.appendDiffLine(this.getNewProcessInfor())}.bind(this))},appendDiffLine:function(t){new Element("li",{styles:this.css.diffLine,html:t}).inject(this.list.diffNode)},getDiffWithProcess:function(t){var i=[],e=["id","editionName","editionEnable","editionNumber","createTime","updateTime","creatorPerson","lastUpdateTime","lastUpdatePerson"];Object.each(t,function(t,s){var n=o2.typeOf(t);if("array"!=n&&"object"!=n)-1==e.indexOf(s)&&this.edition.fullProcess[s]!=t&&i.push(this.getModifyFieldDiffInfor("modifyProcess",t,s,this.edition.fullProcess[s]));else if("controllerList"==s||"startableIdentityList"==s||"startableUnitList"==s){var o=JSON.stringify(o2.name.cns(this.edition.fullProcess[s])),c=JSON.stringify(o2.name.cns(t));o!=c&&this.edition.fullProcess[s]!=t&&i.push(this.getModifyFieldDiffInfor("modifyProcess",c,s,o))}}.bind(this));var s=this.getAllDiffActivitys(t);return i=(i=i.concat(this.getDiffActivityListAddDelete(s))).concat(this.getDiffActivityListModify(s,t))},getModifyFieldDiffInfor:function(t,i,e,s,n,o,c){var l=this.lp.edition_list[t],d=i.length>60?i.substring(0,60)+" ...":i,h=s.length>60?s.substring(0,60)+" ...":s;return l=l.replace(/\{field\}/,e).replace(/\{old\}/,d).replace(/\{new\}/,h).replace(/\{next\}/,n).replace(/\{name\}/,o).replace(/\{rname\}/,c)},getAllDiffActivitys:function(t){var i={addActivitys:[],deleteActivitys:[],sameActivitys:[]};return this.concatDiffActivitys(i,this.getDiffActivitys([t.begin],[this.edition.fullProcess.begin])),this.concatDiffActivitys(i,this.getDiffActivitys(t.manualList,this.edition.fullProcess.manualList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.conditionList,this.edition.fullProcess.conditionList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.choiceList,this.edition.fullProcess.choiceList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.splitList,this.edition.fullProcess.splitList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.parallelList,this.edition.fullProcess.parallelList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.mergeList,this.edition.fullProcess.mergeList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.embedList,this.edition.fullProcess.embedList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.delayList,this.edition.fullProcess.delayList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.invokeList,this.edition.fullProcess.invokeList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.serviceList,this.edition.fullProcess.serviceList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.agentList,this.edition.fullProcess.agentList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.messageList,this.edition.fullProcess.messageList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.cancelList,this.edition.fullProcess.cancelList)),this.concatDiffActivitys(i,this.getDiffActivitys(t.endList,this.edition.fullProcess.endList)),i},concatDiffActivitys:function(t,i){t.addActivitys=t.addActivitys.concat(i.addActivitys),t.deleteActivitys=t.deleteActivitys.concat(i.deleteActivitys),t.sameActivitys=t.sameActivitys.concat(i.sameActivitys)},getDiffActivitys:function(t,i){i=i||[];var e,s=[];return e=(t=t||[]).filter((function(t){var e=i.findIndex((function(i){return t.edition==i.edition}));return-1==e||(s.push({prev:t,current:i[e]}),!1)})),{addActivitys:i.filter((function(i){return-1==t.findIndex((function(t){return i.edition==t.edition}))})),deleteActivitys:e,sameActivitys:s}},getDiffActivityListAddDelete:function(t){var i=[];return t.addActivitys.each(function(t){var e=this.lp.edition_list.addActivity;e=e.replace(/\{name\}/,t.name),i.push(e)}.bind(this)),t.deleteActivitys.each(function(t){var e=this.lp.edition_list.deleteActivity;e=e.replace(/\{name\}/,t.name),i.push(e)}.bind(this)),i},getDiffActivityListModify:function(t,i){var e=[],s=["id","process","edition","createTime","updateTime","routeList","route","position"],n=["readIdentityList","readUnitList","readGroupList","readDataPathList","reviewIdentityList","reviewUnitList","reviewIdentityList","reviewUnitList","taskIdentityList","taskUnitList","taskGroupList","taskDataPathList"];return t.sameActivitys.each(function(t){var o=t.current;Object.each(t.prev,function(t,c){var l=o2.typeOf(t);if("routeList"==c||"route"==c){var d=this.getProcessRoutes("route"==c?[t]:t,i),h=this.getProcessRoutes("route"==c?[o[c]]:o[c],this.edition.fullProcess),r=this.getDiffRoutes(d,h);e=(e=e.concat(this.getDiffRouteListAddDelete(r,o))).concat(this.getDiffRouteListModify(r,o,i))}else if("array"!=l&&"object"!=l)-1==s.indexOf(c)&&o[c]!=t&&e.push(this.getModifyFieldDiffInfor("modifyActivity",t,c,o[c],"",o.name));else if(-1!==n.indexOf(c)){var a=JSON.stringify(o2.name.cns(o[c])),f=JSON.stringify(o2.name.cns(t));a!=f&&this.edition.fullProcess[c]!=t&&e.push(this.getModifyFieldDiffInfor("modifyActivity",f,c,a,"",o.name))}}.bind(this))}.bind(this)),e},getDiffRoutes:function(t,i){i=i||[];var e,s=[];return e=(t=t||[]).filter((function(t){var e=i.findIndex((function(i){return t.edition==i.edition}));return-1==e||(s.push({prev:t,current:i[e]}),!1)})),{addRoutes:i.filter((function(i){return-1==t.findIndex((function(t){return i.edition==t.edition}))})),deleteRoutes:e,sameRoutes:s}},getDiffRouteListAddDelete:function(t,i,e){var s=[];return t.addRoutes.each(function(t){var e=this.lp.edition_list.modifyActivity_addRoute;e=e.replace(/\{name\}/,i.name).replace(/\{next\}/,t.toActivity.name).replace(/\{rname\}/,t.name),s.push(e)}.bind(this)),t.deleteRoutes.each(function(t){var e=this.lp.edition_list.modifyActivity_deleteRoute;e=e.replace(/\{name\}/,i.name).replace(/\{next\}/,t.toActivity.name).replace(/\{rname\}/,t.name),s.push(e)}.bind(this)),s},getDiffRouteListModify:function(t,i,e){var s=[],n=["id","process","edition","createTime","updateTime","activityType","activity"];return t.sameRoutes.each(function(t){var o=t.current;Object.each(t.prev,function(c,l){var d=o2.typeOf(c);if("activity"==l){var h=this.getProcessActivity(o[l],o.activityType,this.edition.fullProcess),r=this.getProcessActivity(c,t.prev.activityType,e);if(h&&r&&h.edition!=r.edition){var a=this.lp.edition_list.modifyActivity_modifyRouteNext;a=a.replace(/\{name\}/,i.name).replace(/\{oldnext\}/,r.name).replace(/\{newnext\}/,h.name).replace(/\{rname\}/,o.name),s.push(a)}}else if("array"!=d&&"object"!=d&&-1==n.indexOf(l)&&o[l]!=c){var f=this.getProcessActivity(o.activity,o.activityType,this.edition.fullProcess)||{};s.push(this.getModifyFieldDiffInfor("modifyActivity_modifyRouteField",c,l,o[l],f.name||"",i.name,o.name))}}.bind(this))}.bind(this)),s},getProcessRoutes:function(t,i){var e=[];return t.each(function(t){var s=i.routeList.find((function(i){return t==i.id}));s&&(s.toActivity=this.getProcessActivity(s.activity,s.activityType,i),e.push(s))}.bind(this)),e},getProcessActivity:function(t,i,e){return e[i+"List"].find((function(i){return t==i.id}))},getNewProcessInfor:function(){var t=this.edition.fullProcess,i="",e=this.lp.edition_list.an;return i="1 "+e+this.lp.menu.newActivityType.begin,t.endList&&t.endList.length&&(i+=", "+t.endList.length+" "+e+this.lp.menu.newActivityType.end),t.agentList&&t.agentList.length&&(i+=", "+t.agentList.length+" "+e+this.lp.menu.newActivityType.agent),t.manualList&&t.manualList.length&&(i+=", "+t.manualList.length+" "+e+this.lp.menu.newActivityType.manual),t.conditionList&&t.conditionList.length&&(i+=", "+t.conditionList.length+" "+e+this.lp.menu.newActivityType.condition),t.choiceList&&t.choiceList.length&&(i+=", "+t.choiceList.length+" "+e+this.lp.menu.newActivityType.choice),t.parallelList&&t.parallelList.length&&(i+=", "+t.parallelList.length+" "+e+this.lp.menu.newActivityType.parallel),t.splitList&&t.splitList.length&&(i+=", "+t.splitList.length+" "+e+this.lp.menu.newActivityType.split),t.mergeList&&t.mergeList.length&&(i+=", "+t.mergeList.length+" "+e+this.lp.menu.newActivityType.merge),t.embedList&&t.embedList.length&&(i+=", "+t.embedList.length+" "+e+this.lp.menu.newActivityType.embed),t.invokeList&&t.invokeList.length&&(i+=", "+t.invokeList.length+" "+e+this.lp.menu.newActivityType.invoke),t.cancelList&&t.cancelList.length&&(i+=", "+t.cancelList.length+" "+e+this.lp.menu.newActivityType.cancel),t.delayList&&t.delayList.length&&(i+=", "+t.delayList.length+" "+e+this.lp.menu.newActivityType.delay),t.messageList&&t.messageList.length&&(i+=", "+t.messageList.length+" "+e+this.lp.menu.newActivityType.message),t.serviceList&&t.serviceList.length&&(i+=", "+t.serviceList.length+" "+e+this.lp.menu.newActivityType.service),i},getFullProcess:function(t,i){if(this.edition.fullProcess)t&&t();else{var e=!!i;o2.Actions.load("x_processplatform_assemble_designer").ProcessAction.get(this.edition.id,function(i){this.edition.fullProcess=i.data,t&&t()}.bind(this),null,e)}},getPrevItem:function(){var t=this.list.items.indexOf(this);return++t<this.list.items.length?this.list.items[t]:null}});