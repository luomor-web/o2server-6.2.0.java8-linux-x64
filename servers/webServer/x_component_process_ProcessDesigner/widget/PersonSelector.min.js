MWF.xApplication.process=MWF.xApplication.process||{},MWF.xApplication.process.ProcessDesigner=MWF.xApplication.process.ProcessDesigner||{},MWF.xApplication.process.ProcessDesigner.widget=MWF.xApplication.process.ProcessDesigner.widget||{},MWF.xDesktop.requireApp("Selector","package",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.ProcessDesigner.widget.PersonSelector=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",type:"identity",count:0,names:[]},initialize:function(t,e,i){this.setOptions(i),this.node=$(t),this.app=e,this.path="../x_component_process_ProcessDesigner/widget/$PersonSelector/",this.cssPath="../x_component_process_ProcessDesigner/widget/$PersonSelector/"+this.options.style+"/css.wcss",this._loadCss(),this.identitys=[],this.restActions=MWF.Actions.get("x_organization_assemble_control"),this.name=this.node.get("name"),this.load()},load:function(){this.node.setStyles(this.css.node),this.createAddNode(),this.loadIdentitys()},setData:function(t){this.node.empty(),this.identitys=[],this.options.names=t,this.loadIdentitys()},loadIdentitys:function(){if(this.options.names)if("duty"===this.options.type.toLowerCase()){JSON.decode(this.options.names).each(function(t){var e=new MWF.widget.O2Duty(t,this.node,{canRemove:!0,onRemove:function(t,e){var i=this,s=this.app.lp.deleteDutyText.replace(/{duty}/g,t.data.name);this.app.confirm("warm",e,this.app.lp.deleteDutyTitle,s,300,120,(function(){i.identitys.erase(t),i.fireEvent("removeDuty",[t]),this.close()}),(function(){this.close()})),e.stopPropagation()}.bind(this)});e.selector=this,this.identitys.push(e)}.bind(this))}else{var t=this.options.names;"string"===typeOf(t)&&(t=JSON.parse(t)),t.each(function(t){if(t){var e="string"===typeOf(t)?{name:t,id:t}:t;MWF.require("MWF.widget.O2Identity",function(){var t=this.options.type.toLowerCase();"identity"===t&&this.identitys.push(new MWF.widget.O2Identity(e,this.node)),"unit"===t&&this.identitys.push(new MWF.widget.O2Unit(e,this.node)),"group"===t&&this.identitys.push(new MWF.widget.O2Group(e,this.node)),"person"===t&&this.identitys.push(new MWF.widget.O2Person(e,this.node)),"application"===t&&this.identitys.push(new MWF.widget.O2Application(e,this.node)),"process"===t&&this.identitys.push(new MWF.widget.O2Process(e,this.node)),"formfield"===t&&this.identitys.push(new MWF.widget.O2FormField(e,this.node)),"view"===t&&this.identitys.push(new MWF.widget.O2View(e,this.node)),"cmsview"===t&&this.identitys.push(new MWF.widget.O2CMSView(e,this.node)),"queryview"===t&&this.identitys.push(new MWF.widget.O2QueryView(e,this.node)),"querystatement"===t&&this.identitys.push(new MWF.widget.O2QueryStatement(e,this.node)),"querystat"===t&&this.identitys.push(new MWF.widget.O2QueryStat(e,this.node)),"querytable"===t&&this.identitys.push(new MWF.widget.O2QueryTable(e,this.node)),"queryimportmodel"===t&&this.identitys.push(new MWF.widget.O2QueryImportModel(e,this.node)),"dutyname"===t&&this.identitys.push(new MWF.widget.O2Duty(e,this.node)),"cmsapplication"===t&&this.identitys.push(new MWF.widget.O2CMSApplication(e,this.node)),"cmscategory"===t&&this.identitys.push(new MWF.widget.O2CMSCategory(e,this.node)),"portalfile"===t&&this.identitys.push(new MWF.widget.O2File(e,this.node)),"processfile"===t&&this.identitys.push(new MWF.widget.O2File(e,this.node)),"dictionary"===t&&this.identitys.push(new MWF.widget.O2Dictionary(e,this.node)),"script"===t&&this.identitys.push(new MWF.widget.O2Script(e,this.node)),"formstyle"===t&&this.identitys.push(new MWF.widget.O2FormStyle(e,this.node))}.bind(this))}}.bind(this))}},createAddNode:function(){this.addNode=new Element("div",{styles:this.css.addPersonNode}).inject(this.node,"before"),this.addNode.addEvent("click",function(t){var e=[];"formfield"===this.options.type.toLowerCase()&&this.app.process&&this.app.process.routes&&Object.each(this.app.process.routes,(function(t){t.data.selectConfig&&(JSON.parse(t.data.selectConfig)||[]).each((function(t){e.push({name:t.name,id:t.id,form:"routeSelectConfig"})}))}));var i=[];this.identitys.each((function(t){i.push(t.data)}));var s={type:"dutyname"===this.options.type.toLowerCase()?"duty":this.options.type,application:this.options.application,fieldType:this.options.fieldType,count:"duty"===this.options.type.toLowerCase()?1:this.options.count,values:i,zIndex:2e4,isImage:this.options.isImage,include:e,onComplete:function(t){if("function"!==typeOf(this.options.validFun)||this.options.validFun(t)){this.identitys=[],"duty"!==this.options.type.toLowerCase()&&this.node.empty();var e=this.options.type.toLowerCase();MWF.require("MWF.widget.O2Identity",function(){t.each(function(t){"identity"===e&&this.identitys.push(new MWF.widget.O2Identity(t.data,this.node)),"person"===e&&this.identitys.push(new MWF.widget.O2Person(t.data,this.node)),"unit"===e&&this.identitys.push(new MWF.widget.O2Unit(t.data,this.node)),"group"===e&&this.identitys.push(new MWF.widget.O2Group(t.data,this.node)),"application"===e&&this.identitys.push(new MWF.widget.O2Application(t.data,this.node)),"process"===e&&this.identitys.push(new MWF.widget.O2Process(t.data,this.node)),"cmsapplication"===e&&this.identitys.push(new MWF.widget.O2CMSApplication(t.data,this.node)),"cmscategory"===e&&this.identitys.push(new MWF.widget.O2CMSCategory(t.data,this.node)),"formfield"===e&&this.identitys.push(new MWF.widget.O2FormField(t.data,this.node)),"view"===e&&this.identitys.push(new MWF.widget.O2View(t.data,this.node)),"cmsview"===e&&this.identitys.push(new MWF.widget.O2CMSView(t.data,this.node)),"queryview"===e&&this.identitys.push(new MWF.widget.O2QueryView(t.data,this.node)),"querystatement"===e&&this.identitys.push(new MWF.widget.O2QueryStatement(t.data,this.node)),"querystat"===e&&this.identitys.push(new MWF.widget.O2QueryStat(t.data,this.node)),"querytable"===e&&this.identitys.push(new MWF.widget.O2QueryTable(t.data,this.node)),"queryimportmodel"===e&&this.identitys.push(new MWF.widget.O2QueryImportModel(t.data,this.node)),"dutyname"===e&&this.identitys.push(new MWF.widget.O2Duty(t.data,this.node)),"portalfile"===e&&this.identitys.push(new MWF.widget.O2File(t.data,this.node)),"processfile"===e&&this.identitys.push(new MWF.widget.O2File(t.data,this.node)),"dictionary"===e&&this.identitys.push(new MWF.widget.O2Dictionary(t.data,this.node)),"script"===e&&this.identitys.push(new MWF.widget.O2Script(t.data,this.node)),"formstyle"===e&&this.identitys.push(new MWF.widget.O2FormStyle(t.data,this.node))}.bind(this)),"duty"===e&&t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector.DutyInput(this,t.data,this.node,2e4)}.bind(this)),this.fireEvent("change",[this.identitys])}.bind(this))}}.bind(this)};this.options.title&&(s.title=this.options.title),this.options.selectorOptions&&(s=Object.merge(s,this.options.selectorOptions));new MWF.O2Selector(this.app.content,s)}.bind(this))}}),MWF.xApplication.process.ProcessDesigner.widget.PersonSelector.DutyInput=Class({Implements:[Events],initialize:function(t,e,i,s){this.itemNode=$(i),this.data=e,this.isNew=!1,this.selector=t,this.css=this.selector.css,this.app=this.selector.app,this.zIndex=s,this.selector.identitys=[],this.referenceList=[],this.load()},load:function(){this.css.dutyMaskNode["z-index"]=this.zIndex,this.app.content.mask({destroyOnHide:!0,style:this.css.dutyMaskNode}),this.node=new Element("div",{styles:this.css.dutyInputArea}),this.titleNode=new Element("div",{styles:this.css.dutyTitleNode}).inject(this.node),this.titleActionNode=new Element("div",{styles:this.css.dutyTitleActionNode}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.dutyTitleTextNode,text:this.app.lp.dutyInputTitle}).inject(this.titleNode),this.contentNode=new Element("div",{styles:this.css.dutyContentNode}).inject(this.node),this.loadContent(),this.actionNode=new Element("div",{styles:this.css.dutyActionNode}).inject(this.node),this.actionNode.setStyle("text-align","center"),this.loadAction(),this.node.setStyle("z-index",this.zIndex.toInt()+1),this.node.inject(this.app.content),this.node.position({relativeTo:this.app.content,position:"center",edge:"center"});var t=this.app.content.getSize(),e=this.node.getSize();this.node.makeDraggable({handle:this.titleNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}}),this.setEvent()},setEvent:function(){this.titleActionNode&&this.titleActionNode.addEvent("click",function(){this.selector.fireEvent("cancel"),this.close()}.bind(this)),this.okActionNode.addEvent("click",function(){this.selectDuty(),this.close()}.bind(this)),this.cancelActionNode.addEvent("click",function(){this.selector.fireEvent("cancel"),this.close()}.bind(this))},selectDuty:function(){var t=this.scriptEditor.editor.editor.getValue();if(this.data.code=t,this.item)this.selector.identitys.push(this.item),this.selector.fireEvent("change",[this.selector.identitys]);else{var e=new MWF.widget.O2Duty(this.data,this.itemNode,{canRemove:!0,onRemove:function(t,e){var i=t,s=t.selector.app.lp.deleteDutyText.replace(/{duty}/g,t.data.name);t.selector.app.confirm("warm",e,t.selector.app.lp.deleteDutyTitle,s,300,120,(function(){i.selector.identitys.erase(t),i.selector.fireEvent("removeDuty",[t]),this.close()}),(function(){this.close()})),e.stopPropagation()}.bind(this)});e.selector=this.selector,this.selector.identitys.push(e),this.selector.fireEvent("change",[this.selector.identitys])}},close:function(){this.node.destroy(),this.app.content.unmask(),MWF.release(this)},loadAction:function(){this.okActionNode=new Element("button",{styles:this.css.dutyOkActionNode,text:this.app.lp.selectorButton.ok}).inject(this.actionNode),this.cancelActionNode=new Element("button",{styles:this.css.dutyCancelActionNode,text:this.app.lp.selectorButton.cancel}).inject(this.actionNode)},loadContent:function(){this.contentAreaNode=new Element("div",{styles:this.css.dutyContentAreaNode}).inject(this.contentNode);var t=this.app.lp.dutyInput.replace(/{duty}/g,this.data.name);this.textNode=new Element("div",{styles:this.css.dutyTextNode,text:t}).inject(this.contentAreaNode),this.referenceAreaNode=new Element("div",{styles:this.css.dutyReferenceAreaNode}).inject(this.contentAreaNode),this.scriptAreaNode=new Element("div",{styles:this.css.dutyScriptAreaNode}).inject(this.contentAreaNode),this.createScriptNode(),this.createReference(this.app.lp.creatorUnit,"return this.workContext.getWork().creatorUnitDn || this.workContext.getWork().creatorUnit;"),this.createReference(this.app.lp.currentUnit,"return this.workContext.getTask().unitDn || this.workContext.getTask().unit;"),this.createReference(this.app.lp.selectUnit,"",function(){var t={type:"unit",count:0,onComplete:function(t){var e=[];t.each((function(t){e.push('"'+t.data.distinguishedName+'"')})),e.length>1?this.scriptEditor.editor.editor.setValue("return ["+e.join(",")+"];"):this.scriptEditor.editor.editor.setValue("return "+e.join()+";")}.bind(this)};new MWF.O2Selector(this.node,t)}.bind(this))},createScriptNode:function(){this.scriptNode=new Element("div",{styles:this.css.dutyScriptNode}).inject(this.scriptAreaNode),MWF.xDesktop.requireApp("process.ProcessDesigner","widget.ScriptText",function(){this.scriptEditor=new MWF.xApplication.process.ProcessDesigner.widget.ScriptText(this.scriptNode,"",this.app,{height:316,maskNode:this.app.content,maxObj:this.app.content}),this.scriptEditor.loadEditor(function(){this.data.code&&this.scriptEditor.editor.editor.setValue(this.data.code)}.bind(this))}.bind(this))},createReference:function(t,e,i){var s=new Element("div",{styles:this.css.dutyReferenceItemNode}).inject(this.referenceAreaNode);s.set("text",t),s.store("code",e),s.store("action",i);var n=this.css.dutyReferenceItemNode,o=this.css.dutyReferenceItemNode_over,d=this.css.dutyReferenceItemNode_down,h=this;s.addEvents({mouseover:function(){this.retrieve("checked")||this.setStyles(o)},mouseout:function(){this.retrieve("checked")||this.setStyles(n)},mousedown:function(){this.retrieve("checked")||this.setStyles(d)},mouseup:function(){this.retrieve("checked")||this.setStyles(o)},click:function(){var t=s.retrieve("action");if(t)t();else{var e=this.retrieve("code"),i=h.scriptEditor.editor.editor.getValue();i?(i=i+"\n"+e,h.scriptEditor.editor.editor.setValue(i)):h.scriptEditor.editor.editor.setValue(e)}}})}}),MWF.widget.O2Duty=new Class({Extends:MWF.widget.O2Group,getPersonData:function(){},setEvent:function(){this.node.addEvent("click",function(){this.modifyDuty()}.bind(this))},modifyDuty:function(){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector.DutyInput(this.selector,this.data,this.selector.node,2e4).item=this}});