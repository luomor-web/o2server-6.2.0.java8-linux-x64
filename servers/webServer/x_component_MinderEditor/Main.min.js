MWF.xApplication.MinderEditor=MWF.xApplication.MinderEditor||{},MWF.xDesktop.requireApp("MinderEditor","Tools",null,!1),MWF.xDesktop.requireApp("MinderEditor","RuntimeInCommon",null,!1),MWF.xDesktop.requireApp("MinderEditor","WidgetInCommon",null,!1),MWF.xDesktop.requireApp("MinderEditor","Commands",null,!1),MWF.xDesktop.requireApp("MinderEditor","LeftToolbar",null,!1),MWF.xApplication.MinderEditor.options={multitask:!0,executable:!0},MWF.xApplication.MinderEditor.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{isEdited:!1,style:"default",name:"MinderEditor",icon:"icon.png",width:"1200",height:"700",isResize:!1,isMax:!0,title:MWF.xApplication.MinderEditor.LP.title,align:"center",folderId:"root",minderName:"",menuAction:"",id:"",defaultTheme:"fresh-blue",defaultTemplate:"default",isSetDataWhenExpand:!1,leftToolbarEnable:!0,notePreviewerEnable:!0,tools:{top:["menu","|","save","|","undoredo","|","append","|","arrange","|","edit_remove","|","hyperLink","image","priority","progress","|","style","help"],left:["zoom","camera","resetlayout","move","expandLevel","selectAll","preview","template","theme","search"],right:["font","resource","note"]},disableTools:[],template:[],theme:[],dataMode:"restful"},onQueryLoad:function(){this.lp=MWF.xApplication.MinderEditor.LP},loadApplication:function(t){this.autoSaveInter=18e4,this.userName=layout.desktop.session.user.distinguishedName||layout.desktop.session.user.name,this.restActions=MWF.Actions.get("x_mind_assemble_control"),this.status&&(this.options.isEdited=this.status.isEdited||!1,this.options.isNew=this.status.isNew||!1,this.options.dataMode=this.status.dataMode),this.options.isEdited?(MWF.xDesktop.requireApp("MinderEditor","RuntimeInEditMode",null,!1),MWF.xDesktop.requireApp("MinderEditor","WidgetInEditMode",null,!1),MWF.xDesktop.requireApp("MinderEditor","ToolbarInEditMode",null,!1),MWF.xDesktop.requireApp("MinderEditor","PopMenu",null,!1)):MWF.xDesktop.requireApp("MinderEditor","RuntimeInReadMode",null,!1),this.createNode(),this.getData(function(){var t=this.data.name||this.options.title||"新建脑图";t=t.length>30?t.substr(0,30):t,this.setTitle(t),this.loadApplicationContent()}.bind(this)),this.options.noticeText&&this.notice(this.options.noticeText,"info")},getData:function(t){var i;"outer"==this.options.dataMode||this.status&&"outer"==this.status.dataMode?this.status&&this.status.data&&(this.data=this.status.data):this.status&&this.status.id?i=this.status.id:this.options.id?i=this.options.id:this.data&&this.data.id&&(i=this.data.id),i?this.restActions.getMind(i,function(i){this.data=i.data,this.data.content=JSON.parse(this.data.content),t&&t()}.bind(this)):this.data?(this.data.content?"string"==typeOf(this.data.content)&&(this.data.content=JSON.parse(this.data.content)):this.data.content={data:{}},t&&t()):(this.data={content:{data:{}}},t&&t())},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div.node",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content),this._createNode()},_createNode:function(){this.options.isEdited&&(this.topToolbarNode=new Element("div.topToolbar").inject(this.node),this.topToolbarNode.setStyles(this.css.topToolbar)),this.contentNode=new Element("div.contentNode").inject(this.node),this.contentNode.classList.add("km-editor"),this.options.isEdited&&(this.rightToolbarNode=new Element("div.rightToolbar").inject(this.node),this.rightToolbarNode.setStyles(this.css.rightToolbar)),this.Content_Offset_Top=this.contentNode.getCoordinates(this.node).top,this.resizeContentFun=this.resizeContent.bind(this),this.addEvent("resize",this.resizeContentFun),this.resizeContent()},loadApplicationContent:function(){this.loadResource(function(){this.loadKityMinder(this.data.content),this.debug=new MWF.xApplication.MinderEditor.Debug(!0),this.key=new MWF.xApplication.MinderEditor.Key,this.fsm=new MWF.xApplication.MinderEditor.FSM("normal"),this.receiver=new MWF.xApplication.MinderEditor.Receiver(this),this.options.isEdited?(this.popmenu=new MWF.xApplication.MinderEditor.PopMenu(this.content,this,this.minder,this),this.input=new MWF.xApplication.MinderEditor.Input(this),this.minder.supportClipboardEvent&&!kity.Browser.gecko&&(this.MimeType=new MWF.xApplication.MinderEditor.ClipboardMimeType,this.clipboard=new MWF.xApplication.MinderEditor.Clipboard(this)),this.history=new MWF.xApplication.MinderEditor.History(this.minder),this.commands=new MWF.xApplication.MinderEditor.Commands(this),this.commands.load(),this.topToolbar=new MWF.xApplication.MinderEditor.TopToolbar(this,this.topToolbarNode),this.topToolbar.load(),this.rightToolbar=new MWF.xApplication.MinderEditor.RightToolbar(this,this.rightToolbarNode),this.rightToolbar.load(),this.drag=new MWF.xApplication.MinderEditor.Drag(this),MWF.xApplication.MinderEditor.JumpingInEditMode(this),this.status&&this.status.autoSave&&this.startAutoSave()):(this.commands=new MWF.xApplication.MinderEditor.Commands(this),this.commands.load(),this.drag=new MWF.xApplication.MinderEditor.Drag(this),MWF.xApplication.MinderEditor.JumpingInReadMode(this)),this.options.notePreviewerEnable&&new MWF.xApplication.MinderEditor.NotePrviewer(this)}.bind(this))},openMainMenu:function(t){this.topToolbar.getCommandNode("menu").click(),this.commands.mainMenu.show(t)},loadResource:function(t){COMMON.AjaxModule.loadCss("../x_component_MinderEditor/$Main/default/kityminder.editor.css",function(){COMMON.AjaxModule.loadCss("../o2_lib/kityminder/core/src/kityminder.css",function(){COMMON.AjaxModule.load("kity",function(){COMMON.AjaxModule.load("kityminder",function(){t&&t()}.bind(this))}.bind(this))}.bind(this))}.bind(this))},loadExtentResource:function(t){COMMON.AjaxModule.load("../o2_lib/jquery/jquery-2.2.4.min.js",function(){COMMON.AjaxModule.load("../o2_lib/kityminder/core/dist/kityminder.core.extend.js",function(){jQuery.noConflict();t&&t()}.bind(this))}.bind(this))},loadKityMinder:function(t){var i=this;this.isMovingCenter=!0;var e=this.minder=new kityminder.Minder;e.renderTo(this.contentNode),t.theme=t.theme||this.options.defaultTheme,t.template=t.template||this.options.defaultTemplate,this.deepestLevel=0,e.on("contentchange",function(){this.updateTime=new Date}.bind(this)),e.on("import",(function(t){i.alreadyBind||(e.getAllNode().forEach((function(t){i._loadMinderNode(t)})),i.alreadyBind=!0,i.options.leftToolbarEnable&&i.loadLeftToolbar(),i.fireEvent("postLoadMinder",i))})),e.on("execCommand",(function(t){"template"===t.commandName&&i.moveToCenter()})),e.on("layoutallfinish",(function(){(i.templateChanged||i.isMovingCenter)&&(i.moveToCenter(),i.templateChanged=!1,i.isMovingCenter=!1)})),e.importJson(t)},_loadMinderNode:function(t){var i=t.getLevel();this.deepestLevel=i>this.deepestLevel?i:this.deepestLevel,this.fireEvent("postLoadMinderNode",t)},addMinderNodeEvents:function(t,i){var e=t.getRenderContainer().node;for(var n in i)e.addEventListener(n,function(e){var n=t.getRenderBox("screen");i[this](e,t,n)}.bind(n))},addMinderNoteIconEvents:function(t,i){var e=t.getRenderer("NoteIconRenderer");if(e&&e.getRenderShape()){var n=e.getRenderShape();for(var o in i)n.addEventListener(o,function(e){var n=t.getRenderBox("screen");i[this](e,t,n)}.bind(o))}},onExpandMinderNode:function(t,i){var e=t.getRenderer("ExpanderRenderer").getRenderShape();e&&e.addEventListener("mousedown",function(e){var n=t.getRenderBox("screen");i&&i(e,t,n)}.bind(t))},replaceMinderNodeWithData:function(t,i){for(var e=this.minder;t.getChildren().length;){var n=t.getChildren()[0];e.removeNode(n)}e.importNode(t,i),e.refresh(),setTimeout(function(){var i=t.getChildren();i.length&&i.forEach(function(t){this._loadMinderNode(t)}.bind(this))}.bind(this),100)},resizeContent:function(){var t=this.content.getSize();this.contentNode.setStyles({height:t.y-this.Content_Offset_Top+"px"}),this.rightToolbar&&this.rightToolbar.setTooltipsSize(),this.minder&&this.moveToCenter()},loadLeftToolbar:function(){this.leftToolbar=new MWF.xApplication.MinderEditor.LeftToolbar(this.node,this,this.minder,this),this.leftToolbar.load()},moveToCenter:function(){this._moveToCenter()},_moveToCenter:function(){if("center"==this.options.align){var t,i,e=this.minder.getRenderContainer().getRenderBox("screen"),n=this.contentNode.getCoordinates(),o=this.minder.getRoot(),s=o.getRenderContainer().getRenderBox("screen"),a=s.top-e.top,r=s.left-e.left,d=o.getChildren().length,h=this.minder.queryCommandValue("template"),l=!1;if(e.width>n.width?"fish-bone"==h||d<2?t=50:l=!0:t=parseInt((n.width-e.width)/2+r+50),e.height>n.height?a>n.height?"fish-bone"==h?i=n.height-s.height:d<2?i=parseInt(n.width/2):l=!0:i=a+50:i=parseInt((n.height-e.height)/2)+a,l)this.minder.execCommand("camera",this.minder.getRoot(),600);else this.minder.getViewDragger().moveTo(new kity.Point(t,i),300)}},recordStatus:function(){var t={id:this.data?this.data.id:"",autoSave:this.autoSave,isEdited:this.options.isEdited,isNew:this.options.isNew,dataMode:this.options.dataMode};return"outer"==this.options.dataMode&&(t.data=this.data),this.rightToolbar&&(t.styleActive=this.rightToolbar.styleActive,t.noteActive=this.rightToolbar.noteActive,t.resourceActive=this.rightToolbar.resourceActive),t},startAutoSave:function(){this.notice("开启自动保存"),this.autoSave=!0,this.autosaveInterval=setInterval(function(){this.updateTime&&(!this.saveTime||this.saveTime<this.updateTime)&&(this.save("自动保存成功"),this.saveTime=this.updateTime.clone())}.bind(this),this.autoSaveInter)},stopAutoSave:function(){this.notice("关闭自动保存"),this.autoSave=!1,this.autosaveInterval&&clearInterval(this.autosaveInterval)},saveAs:function(t,i){var e=this.minder.exportJson(),n=JSON.stringify(e),o=this.minder.getRoot().getText(),s={content:n,name:i||o,folderId:t||this.options.folderId,description:""};this.restActions.saveMind(s,function(t){var i=t.data.id;this.restActions.getMind(i,function(t){new MWF.xApplication.MinderEditor.Converter(this,this.minder).toPng(180,130,function(t){var e=new FormData;e.append("file",t,"untitled.png"),e.append("site",i),MWF.xDesktop.uploadImage(i,"mindInfo",e,t,function(t){s.id=i,s.icon=t.data.id,this.restActions.saveMind(s,function(t){this.notice("另存成功")}.bind(this))}.bind(this))}.bind(this),function(){this.notice("另存成功，但由于脑图中有外网图片，浏览器无法生成缩略图")}.bind(this))}.bind(this))}.bind(this))},setNewName:function(t){this.save("重命名成功",t,null)},save:function(t,i,e){var n=this.minder.exportJson(),o=JSON.stringify(n),s=this.minder.getRoot().getText(),a=function(e,s,a){this.data.content=o;var r=a?"另存成功，但由于脑图中有外网图片，浏览器无法生成缩略图":"保存成功";this.restActions.saveMind(this.data,function(o){s?this.restActions.getMind(e,function(e){this.data=e.data,this.data.content=n,i&&this.setTitle(i),this.notice(t||r)}.bind(this)):(this.data.content=n,i&&this.setTitle(i),this.notice(t||r))}.bind(this))}.bind(this),r=function(t,i){new MWF.xApplication.MinderEditor.Converter(this,this.minder).toPng(180,130,function(e){var n=new FormData;n.append("file",e,"untitled.png"),n.append("site",t),MWF.xDesktop.uploadImage(t,"mindInfo",n,e,function(e){this.data.icon=e.data.id,a(t,i)}.bind(this))}.bind(this),function(){this.data.icon="",a(t,i,!0)}.bind(this))}.bind(this);this.data&&this.data.id?(this.data.content=o,i&&(this.data.name=i),e&&(this.data.folderId=e),r(this.data.id)):(this.data={content:o,name:i||s,folderId:e||this.options.folderId,description:""},this.restActions.saveMind(this.data,function(t){var i=this.options.id=t.data.id;r(i,!0)}.bind(this)))},openSaveAsDialog:function(){new MWF.xApplication.MinderEditor.SaveAsForm(this,{newname:this.data?this.data.name:""},{},{app:this}).edit()},openRenameDialog:function(){new MWF.xApplication.MinderEditor.NewNameForm(this,{newname:this.data?this.data.name:""},{},{app:this}).edit()},openShareDialog:function(){MWF.xDesktop.requireApp("Minder","Common",null,!1);var t=new MWF.xApplication.Minder.ShareForm({app:this},{},{},{app:this});t.checkedItemData=[this.data],t.edit()},openExportDialog:function(){new MWF.xApplication.MinderEditor.ExportForm({app:this},this.data,{},{app:this}).edit()},openNewMinderDialog:function(){MWF.xDesktop.requireApp("Minder","Common",null,!1),new MWF.xApplication.Minder.NewNameForm({app:this},{},{},{app:this}).edit()},loadCodeMirror:function(t){if(window.CodeMirror)t&&t();else{var i="../o2_lib/codemirror",e={codemirror:i+"/lib/codemirror.js",codemirror_xml:i+"/mode/xml/xml.js",codemirror_javascript:i+"/mode/javascript/javascript.js",codemirror_css:i+"/mode/css/css.js",codemirror_htmlmixed:i+"/mode/htmlmixed/htmlmixed.js",codemirror_markdown:i+"/mode/markdown/markdown.js",codemirror_overlay:i+"/addon/mode/overlay.js",codemirror_gfm:i+"/mode/gfm/gfm.js",codemirror_marked:"../o2_lib/marked/lib/marked.js"};COMMON.AjaxModule.loadCss(i+"/lib/codemirror.css",function(){o2.load(Object.values(e),function(){marked.setOptions({gfm:!0,tables:!0,breaks:!0,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1}),t&&t()}.bind(this))}.bind(this))}}}),MWF.xApplication.MinderEditor.Converter=new Class({Implements:[Options,Events],options:{background:null,zoom:1},initialize:function(t,i,e){this.setOptions(e),this.editor=t,this.minder=i},toPng:function(t,i,e,n){var o;this.toCanvas(t,i,function(t){try{var i=t.toDataURL("image/png").split(",")[1];if(!i)return void(o=null);i=window.atob(i);for(var s=new Uint8Array(i.length),a=0;a<i.length;a++)s[a]=i.charCodeAt(a);o=new Blob([s],{type:"image/png"}),e&&e(o)}catch(t){n&&n()}}.bind(this))},toCanvas:function(t,i,e,n){this.loadCanvgResource(function(){n||(n=this.editor.contentNode.get("html"));var o,s=this.getSvgCoordinates(),a=Math.abs(s.left),r=Math.abs(s.top),d=s.x,h=s.y;if(t||(t=d+a),i||(i=h+r),t&&i){var l,p,c,m,u;if(t>s.x&&i>s.y&&(t>s.x&&(a+=(t-s.x)/2,d=t),i>s.y&&(r+=(i-s.y)/2,h=i)),t<s.x&&(l=t/s.x),i<s.y&&(p=i/s.y),this.options.zoom&&1!==this.options.zoom){var g=parseFloat(this.options.zoom);l=l?l*g:g,p=p?p*g:g,t*=g,i*=g}(l||p)&&(d=t,h=i,(l=l||1)>=(p=p||1)?(c=(t-(u=p)*s.x)/2,m=0):(c=0,m=(i-(u=l)*s.y)/2),o=this.options.zoom&&1!==this.options.zoom?u+" 0 0 "+u+" 0 0":u+" 0 0 "+u+" "+c+" "+m)}var f=(n='<svg width="'+d+'" height="'+h+'">'+/<svg.*?>(.*?)<\/svg>/gi.exec(n)[1]+"</svg>").split("</defs>"),v=n.split('<g id="minder_connect_group');n=f[0]+'</defs><g transform="'+(o?"matrix("+o+")":"translate(0.5 0.5)")+'"><g transform="translate('+a+" "+r+')" text-rendering="'+(o?"geometricPrecision":"optimize-speed")+'"><g id="minder_connect_group'+v[1];var M=new Element("canvas",{width:d,height:h,styles:{width:d+"px",height:h+"px"}}).inject(this.editor.node);canvg(M,n,{useCORS:!0,log:!0,renderCallback:function(t){e&&e(M)}})}.bind(this))},loadCanvgResource:function(t){COMMON.AjaxModule.load("../o2_lib/canvg/canvg.js",function(){t&&t()}.bind(this))},getSvgCoordinates:function(){var t={top:0,left:0,right:0,bottom:0},i={top:0,left:0,right:0,bottom:0},e={top:0,left:0,right:0,bottom:0},n={top:0,left:0,right:0,bottom:0};return this.minder.getRoot().traverse(function(o){var s=o.getLayoutBox();s.top<t.top&&(t=s),s.left<i.left&&(i=s),s.right>e.right&&(e=s),s.bottom>n.bottom&&(n=s)}.bind(this)),{top:t.top,right:e.right,bottom:n.bottom,left:i.left,width:e.right-i.left+1,height:n.bottom-t.top+1,x:e.right-i.left+1,y:n.bottom-t.top+1}}}),MWF.xApplication.MinderEditor.PreviewConverter=new Class({initialize:function(t,i,e,n){this.editor=t,this.minder=i,this.previewer=new Element("div",{styles:{width:e,height:n}}).inject(this.editor.content),this.initPreViewer(),this.draw()},initPreViewer:function(){this.paper=new kity.Paper(this.previewer),this.nodeThumb=this.paper.put(new kity.Path),this.connectionThumb=this.paper.put(new kity.Path),this.pathHandler=this.getPathHandler(this.minder.getTheme())},getPathHandler:function(t){switch(t){case"tianpan":case"tianpan-compact":return function(t,i,e,n,o){var s=n>>1;t.push("M",i,e+s,"a",s,s,0,1,1,0,.01,"z")};default:return function(t,i,e,n,o){t.push("M",i,e,"h",n,"v",o,"h",-n,"z")}}},draw:function(){var t=this.minder.getRenderContainer().getBoundaryBox();this.paper.setViewBox(t.x-30-.5,t.y-30-.5,t.width+60+1,t.height+60+1);var i=[],e=[];this.minder.getRoot().traverse(function(t){var n=t.getLayoutBox();this.pathHandler(i,n.x,n.y,n.width,n.height),t.getConnection()&&t.parent&&t.parent.isExpanded()&&e.push(t.getConnection().getPathData())}.bind(this)),this.paper.setStyle("background",this.minder.getStyle("background")),i.length?this.nodeThumb.fill(this.minder.getStyle("root-background")).setPathData(i):this.nodeThumb.setPathData(null),e.length?this.connectionThumb.stroke(this.minder.getStyle("connect-color"),"0.5%").setPathData(e):this.connectionThumb.setPathData(null)},toPng:function(t,i,e,n,o){var s;this.toCanvas(t,i,function(t){try{var i=t.toDataURL("image/png").split(",")[1];if(!i)return void(s=null);i=window.atob(i);for(var o=new Uint8Array(i.length),a=0;a<i.length;a++)o[a]=i.charCodeAt(a);s=new Blob([o],{type:"image/png"}),e&&e(s)}catch(t){n&&n()}}.bind(this),o)},toCanvas:function(t,i,e,n){this.loadCanvgResource(function(){n||(n=this.previewer.get("html"));var o,s,a,r,d,h,l=this.getSvgCoordinates(),p=Math.abs(l.left),c=Math.abs(l.top),m=l.x,u=l.y;t&&i&&(t>l.x&&i>l.y&&(t>l.x&&(p+=(t-l.x)/2,m=t),i>l.y&&(c+=(i-l.y)/2,u=i)),t<l.x&&(s=t/l.x),i<l.y&&(a=i/l.y),(s||a)&&(m=t,u=i,(s=s||1)>=(a=a||1)?(r=(t-(h=a)*l.x)/2,d=0):(r=0,d=(i-(h=s)*l.y)/2),o=h+" 0 0 "+h+" "+r+" "+d));var g=(n='<svg width="'+m+'" height="'+u+'">'+/<svg.*?>(.*?)<\/svg>/gi.exec(n)[1]+"</svg>").split("</defs>"),f=n.split('<g id="minder_connect_group');n=g[0]+'</defs><g transform="'+(o?"matrix("+o+")":"translate(0.5 0.5)")+'"><g transform="translate('+p+" "+c+')" text-rendering="'+(o?"geometricPrecision":"optimize-speed")+'"><g id="minder_connect_group'+f[1];var v=new Element("canvas",{width:m,height:u,styles:{width:m+"px",height:u+"px"}}).inject(this.editor.node);canvg(v,n,{useCORS:!0,log:!0,renderCallback:function(t){e&&e(v)}})}.bind(this))},loadCanvgResource:function(t){COMMON.AjaxModule.load("../o2_lib/canvg/canvg.js",function(){t&&t()}.bind(this))},getSvgCoordinates:function(){var t={top:0,left:0,right:0,bottom:0},i={top:0,left:0,right:0,bottom:0},e={top:0,left:0,right:0,bottom:0},n={top:0,left:0,right:0,bottom:0};return this.paper.getRoot().traverse(function(o){var s=o.getLayoutBox();s.top<t.top&&(t=s),s.left<i.left&&(i=s),s.right>e.right&&(e=s),s.bottom>n.bottom&&(n=s)}.bind(this)),{top:t.top,right:e.right,bottom:n.bottom,left:i.left,width:e.right-i.left+1,height:n.bottom-t.top+1,x:e.right-i.left+1,y:n.bottom-t.top+1}},destory:function(){this.paper.remove(),this.previewer.destroy()}});