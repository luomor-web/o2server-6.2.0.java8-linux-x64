MWF.xApplication.MinderEditor.MainMenu=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",defaultAction:"openRecentFiles"},initialize:function(t,e,i){this.setOptions(i),this.container=t,this.app=e,this.lp=this.app.lp,this.isHidden=!1,this.path="../x_component_MinderEditor/$MainMenu/",this.cssPath="../x_component_MinderEditor/$MainMenu/"+this.options.style+"/css.wcss",this._loadCss(),this.itemJson=[{text:"新建",action:"openCreate",hasContent:!1},{text:"打开",action:"openRecentFiles",hasContent:!0},{text:"另存为",action:"openSaveAs",hasContent:!0},{text:"共享",action:"openShare",hasContent:!0},{text:"历史版本",action:"openFileVersion",hasContent:!0}],this.load()},load:function(){this.maskNode=new Element("div.maskNode",{styles:this.css.maskNode,events:{mousedown:function(t){this.hide()}.bind(this)}}).inject(this.container),this.node=new Element("div.MainMenu",{styles:this.css.node,events:{mousedown:function(t){t.stopPropagation()}}}).inject(this.container),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node),this.rightContentNode=new Element("div",{styles:this.css.rightContentNode}).inject(this.node),this.loadItems(),this.show(),this.resetNodeSizeFun=this.resetNodeSize.bind(this),this.app.addEvent("resize",this.resetNodeSizeFun)},loadItems:function(){var t=this;this.itemContainer=new Element("div",{styles:this.css.itemContainer}).inject(this.contentNode),this.menuItem={},this.itemJson.each(function(e){var i=new Element("div",{styles:this.css.itemNode,text:e.text}).inject(this.contentNode);i.addEvents({mouseover:function(){t.currentItemNode!=this&&this.setStyles(t.css.itemNode_over)},mouseout:function(){t.currentItemNode!=this&&this.setStyles(t.css.itemNode)},click:function(){t.setCurrentItemNode(this,e.action,e)}}),this.menuItem[e.action]=i,e.action==(this.app.options.menuAction||this.options.defaultAction)&&i.click()}.bind(this))},setCurrentItemNode:function(t,e,i){this.currentItemNode&&i.hasContent&&this.currentItemNode.setStyles(this.css.itemNode),this[e]&&this[e](),i.hasContent&&(this.currentItemNode=t,t.setStyles(this.css.itemNode_current))},trigger:function(){this.isHidden?this.show(!0):this.hide(!0)},hide:function(t){this.maskNode.setStyle("display","none"),this.isHidden=!0,this.node.setStyle("display","none"),this.fireEvent("hide")},show:function(t){t?this.menuItem[t].click():this.currentItemNode&&this.currentItemNode.click(),this.resetNodeSize(),this.maskNode.setStyle("display",""),this.isHidden=!1,this.node.setStyles({display:""}),this.fireEvent("show")},resetNodeSize:function(){var t=this.container.getSize();this.contentNode.setStyle("height",t.y-84),this.rightContentNode.setStyle("height",t.y-86),this.setShareRecordListHeight(),this.setFileVersionListHeight()},setShareRecordListHeight:function(){if(this.shareRecordList){var t=this.container.getSize();this.shareRecordList.setStyle("height",t.y-256)}},setFileVersionListHeight:function(){if(this.fileVersionList){var t=this.container.getSize();this.fileVersionList.setStyle("height",t.y-156)}},getSize:function(){return{x:9,y:0}},empty:function(){this.shareRecordList=null,this.fileVersionList=null,this.rightContentNode.empty()},reload:function(){this.destory()},destory:function(){this.maskNode.destroy(),this.app.removeEvent("resize",this.resetNodeSizeFun),this.node.destory()},openRecentFiles:function(){var t=this;this.empty(),new Element("div.rightTitleNode",{text:"打开",styles:this.css.rightTitleNode}).inject(this.rightContentNode);new Element("div.listTitle",{text:"最近修改的文件",styles:this.css.listTitle}).inject(this.rightContentNode);var e=new Element("div.listArea",{styles:this.css.documentArea}).inject(this.rightContentNode);this.app.restActions.listNextMindWithFilter("(0)",5,{orderField:"updateTime",orderType:"DESC"},function(i){((i.data||[]).each(function(t){var i=new Element("div.documentNode",{styles:this.css.documentNode}).inject(e);i.addEvents({mouseover:function(){i.setStyles(this.css.documentNode_over)}.bind(this),mouseout:function(){i.setStyles(this.css.documentNode)}.bind(this),click:function(){this.openMinder(t),this.hide()}.bind(this)});Element("div.documentIconNode",{styles:this.css.documentIconNode}).inject(i);var s=Element("div.documentRightNode",{styles:this.css.documentRightNode}).inject(i);Element("div.documentTextNode",{text:t.name,styles:this.css.documentTextNode}).inject(s),Element("div.documentMemoNode",{text:"修改于"+t.updateTime,styles:this.css.documentMemoNode}).inject(s)}.bind(this)),i.data&&0!=i.data.length)?new Element("div.listItemActionNode",{text:"打开列表，查看更多文件",styles:this.css.listItemActionNode,events:{mouseover:function(){this.setStyles(t.css.listItemActionNode_over)},mouseout:function(){this.setStyles(t.css.listItemActionNode)},click:function(e){t.openMinderList(e),t.hide()}}}).inject(e).setStyle("margin-top","10px"):new Element("div.listItemTextNode",{text:"没有找到最近修改的文件",styles:this.css.listItemTextNode}).inject(e)}.bind(this));var i=new Element("div.rightActionArea",{styles:this.css.rightActionArea}).inject(this.rightContentNode);this.createActionNode(i,"import","打开本地文件","上传本地脑图文件，并用脑图编辑",function(){this.app.openSaveAsDialog(),this.hide()}.bind(this))},openMinderList:function(t){this.app.desktop.apps.Minder?this.app.desktop.apps.Minder.setCurrent():this.app.desktop.openApplication(null,"Minder",{appId:"Minder"})},openMinder:function(t){var e="MinderEditor"+t.id;this.app.desktop.apps[e]?this.app.desktop.apps[e].setCurrent():this.app.desktop.openApplication(null,"MinderEditor",{appId:e,folderId:t.folderId,id:t.id,isEdited:!0,isNew:!1})},openCreate:function(){this.app.openNewMinderDialog(),this.hide()},openSaveAs:function(){this.empty(),new Element("div.rightTitleNode",{text:"另存为",styles:this.css.rightTitleNode}).inject(this.rightContentNode);var t=new Element("div.rightActionArea",{styles:this.css.rightActionArea}).inject(this.rightContentNode);this.createActionNode(t,"saveas","另存为","保存副本到文件夹",function(){this.app.openSaveAsDialog(),this.hide()}.bind(this)),this.createActionNode(t,"edit","重命名","重命名此文件",function(){this.app.openRenameDialog(),this.hide()}.bind(this)),this.createActionNode(t,"download","导出","导出图片到本地",function(){this.exportAsImage(),this.hide()}.bind(this))},exportAsImage:function(){var t=this.app.minder.getRoot().getText();new MWF.xApplication.MinderEditor.Converter(this.app,this.app.minder,{background:"#ffffff",zoom:2}).toPng(null,null,function(e){var i=this.app.data.id,s=new FormData;s.append("file",e,t+".png"),s.append("site",i),MWF.xDesktop.uploadImageByScale(i,"mindInfo",-1,s,e,function(t){var e=o2.Actions.load("x_file_assemble_control").FileAction.action.actions.downloadStream.uri.replace("{id}",t.data.id);e=o2.filterUrl(o2.Actions.load("x_file_assemble_control").FileAction.action.getAddress()+e),window.open(e)}.bind(this))}.bind(this),function(){this.app.notice("抱歉，脑图中有外网图片，无法导出","error")}.bind(this))},openFileVersion:function(){var t=this;this.empty(),new Element("div.rightTitleNode",{text:"历史版本",styles:this.css.rightTitleNode}).inject(this.rightContentNode);var e=this.fileVersionList=new Element("div.listArea",{styles:this.css.listArea}).inject(this.rightContentNode);this.app.data.id?this.app.restActions.listVersionsWithMindId(this.app.data.id,function(i){(i.data||[]).each(function(i){var s=new Element("div.listItemNode",{styles:this.css.listItemNode}).inject(e);new Element("div.listItemTextNode",{text:i.creator.split("@")[0]+"创建于"+i.createTime,styles:this.css.listItemTextNode}).inject(s),this.app.userName==i.creator&&new Element("div.listItemActionNode",{text:"还原",styles:this.css.listItemActionNode,events:{mouseover:function(){this.setStyles(t.css.listItemActionNode_over)},mouseout:function(){this.setStyles(t.css.listItemActionNode)},click:function(e){t.restoreVersion(e,i)}}}).inject(s),this.setFileVersionListHeight()}.bind(this)),i.data&&0!=i.data.length||new Element("div.listItemTextNode",{text:"没有找到历史版本",styles:this.css.listItemTextNode}).inject(e)}.bind(this)):new Element("div.listItemTextNode",{text:"没有找到历史版本",styles:this.css.listItemTextNode}).inject(e)},restoreVersion:function(t,e){this.app.restActions.viewMindVersionWithId(e.id,function(t){this.app.isMovingCenter=!0,this.app.data.content=t.data.content?JSON.parse(t.data.content):{content:{data:{}}},this.app.minder.importJson(this.app.data.content)}.bind(this))},openShare:function(){this.empty(),new Element("div.rightTitleNode",{text:"共享",styles:this.css.rightTitleNode}).inject(this.rightContentNode);var t=new Element("div.rightActionArea",{styles:this.css.rightActionArea}).inject(this.rightContentNode);this.createActionNode(t,"share","分享","邀请其他人查看文件",function(){this.app.openShareDialog(),this.hide()}.bind(this));new Element("div.listTitle",{text:"分享记录",styles:this.css.listTitle}).inject(this.rightContentNode);this.documentArea=this.shareRecordList=new Element("div.documentArea",{styles:this.css.documentArea}).inject(this.rightContentNode),this.app.data.id?this.loadShareRecordList():new Element("div.listItemTextNode",{text:"没有找到分享记录",styles:this.css.listItemTextNode}).inject(this.documentArea)},loadShareRecordList:function(){var t=this;this.documentArea.empty(),this.app.restActions.listShareRecordsWithMindId(this.app.data.id,function(e){(e.data||[]).each(function(e){var i=new Element("div.documentNode",{styles:this.css.documentNode}).inject(this.documentArea);i.addEvents({mouseover:function(){i.setStyles(this.css.documentNode_over)}.bind(this),mouseout:function(){i.setStyles(this.css.documentNode)}.bind(this)});var s=Element("div.documentRightNode",{styles:this.css.documentRightNode}).inject(i);Element("div.documentTextNode",{text:e.source.split("@")[0]+"分享给"+e.target.split("@")[0],styles:this.css.documentTextNode}).inject(s);var n=Element("div.documentBottomNode",{styles:this.css.documentBottomNode}).inject(s);Element("div.documentMemoNode",{text:"于"+e.createTime,styles:this.css.documentMemoNode}).inject(n),this.app.userName==e.source&&new Element("div.documentActionNode",{text:"取消分享",styles:this.css.documentActionNode,events:{mouseover:function(){this.setStyles(t.css.documentActionNode_over)},mouseout:function(){this.setStyles(t.css.documentActionNode)},click:function(i){t.cancelShare(i,e)}}}).inject(n),this.setShareRecordListHeight()}.bind(this)),e.data&&0!=e.data.length||new Element("div.listItemTextNode",{text:"没有找到分享记录",styles:this.css.listItemTextNode}).inject(this.documentArea)}.bind(this))},cancelShare:function(t,e){var i=this;this.app.confirm("warn",t,"取消分享确认","是否取消对"+e.target.split("@")[0]+"的分享?",350,120,(function(){i.app.restActions.cancelShareMind(e.id,{},(function(){i.loadShareRecordList(),i.app.notice("取消分享成功！")})),this.close()}),(function(){this.close()}))},createActionNode:function(t,e,i,s,n){var o=Element("div.rightActionNode",{styles:this.css.rightActionNode}).inject(t);o.addEvents({mouseover:function(){o.setStyles(this.css.rightActionNode_over)}.bind(this),mouseout:function(){o.setStyles(this.css.rightActionNode)}.bind(this),click:function(){n()}.bind(this)});var d=Element("div.rightActionIconNode",{styles:this.css.rightActionIconNode}).inject(o);e&&d.setStyle("background-image","url("+this.path+this.options.style+"/icon/"+e+".png)");var c=Element("div.rightActionRightNode",{styles:this.css.rightActionRightNode}).inject(o);Element("div.rightActionTextNode",{text:i,styles:this.css.rightActionTextNode}).inject(c),Element("div.rightActionMemoNode",{text:s,styles:this.css.rightActionMemoNode}).inject(c)}});