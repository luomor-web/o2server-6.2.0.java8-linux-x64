MWF.xApplication.MinderEditor.Commands=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{type:"common",style:"default"},initialize:function(t,e){for(var i in this.setOptions(e),this.app=t,this.lp=MWF.xApplication.MinderEditor.LP,this.editor=t,this.minder=t.minder,t.debug||(MWF.xDesktop.requireApp("MinderEditor","Tools",null,!1),MWF.xDesktop.requireApp("MinderEditor","RuntimeInCommon",null,!1),MWF.xDesktop.requireApp("MinderEditor","WidgetInCommon",null,!1),this.editor.debug=new MWF.xApplication.MinderEditor.Debug(!0)),t.fsm||(this.editor.fsm=new MWF.xApplication.MinderEditor.FSM("normal")),t.key||(this.editor.key=new MWF.xApplication.MinderEditor.Key),t.receiver||(this.editor.receiver=new MWF.xApplication.MinderEditor.Receiver(this.editor)),this.fsm=this.editor.fsm,this.receiver=this.editor.receiver,this.history=this.editor.history,this.path="../x_component_MinderEditor/$Commands/",this.cssPath=this.path+this.options.style+"/css.wcss",this.commands={undo:{icon:"undo",locale:"撤销",modle:["edit"],key:"Ctrl + Z",disable:function(){return 0==this.history.hasUndo()}.bind(this),action:function(){0==this.history.hasUndo()||this.history.undo()}.bind(this)},redo:{icon:"redo",locale:"重做",modle:["edit"],key:"Ctrl + Y",disable:function(){return 0==this.history.hasRedo()}.bind(this),action:function(){0==this.history.hasRedo()||this.history.redo()}.bind(this)},appendChild:{icon:"insert_sub",modle:["edit"],locale:"插入下级主题",key:["Tab","Insert"],isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("AppendChildNode")}.bind(this),action:function(){-1===this.minder.queryCommandState("AppendChildNode")||this.minder.execCommand("AppendChildNode")}.bind(this)},appendParent:{icon:"insert_par",modle:["edit"],locale:"插入上级主题",key:"Shit + Tab",disable:function(){return-1===this.minder.queryCommandState("AppendParentNode")}.bind(this),action:function(){-1===this.minder.queryCommandState("AppendParentNode")||this.minder.execCommand("AppendParentNode")}.bind(this)},appendSibling:{icon:"insert_sibling",modle:["edit"],locale:"插入同级主题",key:"Enter",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("AppendSiblingNode")}.bind(this),action:function(){-1===this.minder.queryCommandState("AppendSiblingNode")||this.minder.execCommand("AppendSiblingNode")}.bind(this)},arrangeUp:{icon:"up",modle:["edit"],locale:"上移",key:"Alt + Up",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("ArrangeUp")}.bind(this),action:function(){-1===this.minder.queryCommandState("ArrangeUp")||this.minder.execCommand("ArrangeUp")}.bind(this)},arrangeDown:{icon:"down",modle:["edit"],locale:"下移",key:"Alt + Down",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("ArrangeDown")}.bind(this),action:function(){-1===this.minder.queryCommandState("ArrangeDown")||this.minder.execCommand("ArrangeDown")}.bind(this)},edit:{icon:"edit",modle:["edit"],locale:"编辑",key:"F2",disable:function(){return-1===this.minder.queryCommandState("text")}.bind(this),action:function(){-1===this.minder.queryCommandState("text")||this.editNode()}.bind(this)},remove:{icon:"delete",modle:["edit"],locale:"删除",key:"Delete",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("RemoveNode")}.bind(this),action:function(){-1===this.minder.queryCommandState("RemoveNode")||this.minder.execCommand("RemoveNode")}.bind(this)},hyperLink:{icon:"link",modle:["edit"],locale:"链接",key:"Alt + L",disable:function(){return-1===this.minder.queryCommandState("HyperLink")}.bind(this),action:function(){-1===this.minder.queryCommandState("HyperLink")||this.openHyperLinkForm("hyperLink")}.bind(this)},image:{icon:"image",modle:["edit"],locale:"图片",key:"Alt + M",disable:function(){return-1===this.minder.queryCommandState("Image")}.bind(this),action:function(){-1===this.minder.queryCommandState("Image")||this.openImageForm("image")}.bind(this)},note:{title:"备注",modle:["edit"],disable:function(){return-1===this.minder.queryCommandState("note")}.bind(this),init:function(t,e){this.createNoteEditor(t,"note")}.bind(this),setDisable:function(){this.setNoteDisable()}.bind(this),setNormal:function(){this.setNoteNormal()}.bind(this)},priority:{icon:"priority",modle:["edit"],locale:"优先级",key:"Alt + G",disable:function(){return-1===this.minder.queryCommandState("priority")}.bind(this),keyAction:function(){this.prioritySelector.showTooltip()}.bind(this),init:function(t,e){this.initPriority(t,e)}.bind(this)},progress:{icon:"progress",modle:["edit"],locale:"进度",key:"Alt + P",disable:function(){return-1===this.minder.queryCommandState("progress")}.bind(this),keyAction:function(){this.progressSelector.showTooltip()}.bind(this),init:function(t,e){this.initProgress(t,e)}.bind(this)},resource:{title:"标签",modle:["edit"],disable:function(){return-1===this.minder.queryCommandState("resource")}.bind(this),init:function(t,e){this.initResource(t,e)}.bind(this),setDisable:function(){this.setResourceDisable()}.bind(this),setNormal:function(){this.setResourceNormal()}.bind(this)},template:{icon:"template",modle:["edit","read"],title:"模板",disable:function(){return-1===this.minder.queryCommandState("template")}.bind(this),init:function(t,e){this.initTemplate(t,e)}.bind(this)},theme:{icon:"theme",modle:["edit","read"],title:"主题",disable:function(){return-1===this.minder.queryCommandState("theme")}.bind(this),init:function(t,e){this.initTheme(t,e)}.bind(this)},resetlayout:{icon:"resetlayout",modle:["edit","read"],title:"整理布局",key:"Ctrl + Shift + L",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("resetlayout")}.bind(this),action:function(){-1===this.minder.queryCommandState("resetlayout")||this.minder.execCommand("resetlayout")}.bind(this)},clearstyle:{icon:"clear",modle:["edit"],locale:"清除样式",disable:function(){return-1===this.minder.queryCommandState("clearstyle")}.bind(this),action:function(){-1===this.minder.queryCommandState("clearstyle")||this.minder.execCommand("clearstyle")}.bind(this)},copystyle:{icon:"copystyle",modle:["edit"],locale:"拷贝样式",disable:function(){return-1===this.minder.queryCommandState("copystyle")}.bind(this),action:function(){-1===this.minder.queryCommandState("copystyle")||this.minder.execCommand("copystyle")}.bind(this)},pastestyle:{icon:"pastestyle",modle:["edit"],locale:"粘贴样式",disable:function(){return-1===this.minder.queryCommandState("pastestyle")}.bind(this),action:function(){-1===this.minder.queryCommandState("pastestyle")||this.minder.execCommand("pastestyle")}.bind(this)},fontfamily:{title:"字体",modle:["edit"],disable:function(){return-1===this.minder.queryCommandState("fontfamily")}.bind(this),keyAction:function(){this.fontfamilySelector.showTooltip()}.bind(this),init:function(t,e){this.initFontFamily(t,e)}.bind(this)},fontsize:{title:"字号",modle:["edit"],disable:function(){return-1===this.minder.queryCommandState("fontsize")}.bind(this),keyAction:function(){this.fontsizeSelector.showTooltip()}.bind(this),init:function(t,e){this.initFontSize(t,e)}.bind(this)},italic:{icon:"italic",modle:["edit"],title:"斜体",key:"Ctrl + I",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("italic")}.bind(this),action:function(){-1===this.minder.queryCommandState("italic")||this.minder.execCommand("italic")}.bind(this)},bold:{icon:"bold",modle:["edit"],title:"加粗",key:"Ctrl + B",isDefaultKey:!0,disable:function(){return-1===this.minder.queryCommandState("bold")}.bind(this),action:function(){-1===this.minder.queryCommandState("bold")||this.minder.execCommand("bold")}.bind(this)},forecolor:{icon:"forecolor",modle:["edit"],title:"字体颜色",action:function(){-1===this.minder.queryCommandState("forecolor")||!this.currentForecolor||this.minder.execCommand("forecolor",this.currentForecolor)}.bind(this),disable:function(){return-1===this.minder.queryCommandState("forecolor")}.bind(this),init:function(t,e){this.initFontColor(t,e)}.bind(this)},background:{icon:"background",modle:["edit"],title:"背景颜色",action:function(){-1===this.minder.queryCommandState("background")||!this.currentBackgroundcolor||this.minder.execCommand("background",this.currentBackgroundcolor)}.bind(this),disable:function(){return-1===this.minder.queryCommandState("background")}.bind(this),init:function(t,e){this.initBackground(t,e)}.bind(this)},expandLevel:{icon:"expand",modle:["edit","read"],title:"展开节点",disable:function(){return!1}.bind(this),keyAction:function(){this.expandlevelSelector.showTooltip()}.bind(this),init:function(t,e){this.initExpandLevel(t,e)}.bind(this)},selectAll:{icon:"select",modle:["edit","read"],title:"选择",disable:function(){return!1}.bind(this),keyAction:function(){this.selectallSelector.showTooltip()}.bind(this),init:function(t,e){this.initSelectAll(t,e)}.bind(this)},zoom:{module:["edit","read"],title:"缩放",disable:function(){return!1},init:function(t,e){this.initZoomArea(t,e)}.bind(this)},camera:{icon:"camera",module:["edit","read"],title:"根节点居中",disable:function(){return!1}.bind(this),action:function(){this.minder.execCommand("camera",this.minder.getRoot(),600)}.bind(this)},preview:{icon:"preview",module:["edit","read"],title:"预览",active:!0,disable:function(){return!1}.bind(this),action:function(){this.toggleOpenPreViewer()}.bind(this),setDisable:function(){}.bind(this),setNormal:function(){}.bind(this),init:function(t,e){this.initPreViewer(t)}.bind(this)},move:{icon:"move",module:["edit","read"],title:"允许拖拽",disable:function(){return!1}.bind(this),active:!1,setDisable:function(){}.bind(this),setNormal:function(){}.bind(this),action:function(){this.minder.execCommand("hand")}.bind(this)},search:{icon:"search",module:["edit","read"],title:"搜索",key:"Ctrl + F",active:!1,setDisable:function(){}.bind(this),setNormal:function(){}.bind(this),disable:function(){return!1}.bind(this),action:function(){this.toggerSearch()}.bind(this),init:function(t){this.initSearch(t)}.bind(this)},help:{icon:"help",modle:["edit","read"],title:"帮助",key:"Ctrl + Alt + H",disable:function(){return!1}.bind(this),keyAction:function(){this.helpTootips.load()}.bind(this),init:function(t,e){this.initHelp(t,e)}.bind(this)},save:{icon:"save",modle:["edit"],locale:"保存",key:"Ctrl + S",disable:function(){return!1}.bind(this),action:function(){this.save()}.bind(this),init:function(t,e){this.initSaveTooltip(t,e)}.bind(this)},export:{icon:"export",modle:["edit"],locale:"导出",disable:function(){return!1}.bind(this),init:function(t,e){this.initExportTooltip(t,e)}.bind(this)},menu:{icon:"menu",modle:["edit"],locale:"菜单",disable:function(){return!1}.bind(this),action:function(t,e,i){this.initMainMenu(e,i)}.bind(this),init:function(t,e){this.app.options.menuAction&&this.initMainMenu(t,e)}.bind(this)}},this.commands)this.commands[i].name=i;this.setKeyCommand(),this.tooltipOptions={displayDelay:300,onPostCreate:function(t){t.node.addEvents({mouseenter:function(){var e=t.command;e.disable()?this.setDisableStye(t.target,e):this.setActiveStye(t.target,e)}.bind(this)})}.bind(this),onHide:function(t){var e=t.command;e.disable()?this.setDisableStye(t.target,e):this.setNormalStye(t.target,e)}.bind(this)},this.selectOptions={tooltipsOptions:{displayDelay:300,onPostCreate:function(t){var e=t.selector;t.node.addEvents({mouseenter:function(){var t=e.command;t.disable()?this.setDisableStye(e.container,t):this.setActiveStye(e.container,t)}.bind(this)})}.bind(this),onQueryLoad:function(t){var e=t.selector;e.command&&(t.disable=e.command.disable())}.bind(this),onPostLoad:function(t){var e=t.selector;e.selectArrowNode&&e.selectArrowNode.setStyles(e.css.selectArrowNode_up),this.activeTooltip=t}.bind(this),onHide:function(t){var e=t.selector;this.activeTooltip==t&&(this.activeTooltip=null),e.selectArrowNode&&e.selectArrowNode.setStyles(e.css.selectArrowNode);var i=e.command;i.disable()?this.setDisableStye(e.container,i):this.setNormalStye(e.container,i)}.bind(this),event:"mouseenter"}}},load:function(){this._loadCss(),this.containerObject={},this.cssObject={},this.itemNodeObject={},this.fsm.when("normal -> normal",function(t,e,i,n){"shortcut-handle"==i&&(this.dispatchKey(n)?n.preventDefault():this.minder.dispatchKeyEvent(n))}.bind(this)),this.minder.on("interactchange",function(){this.queryInteractchange()&&(this.activeTooltip&&this.activeTooltip.hide(),this.checkStatus())}.bind(this))},addContainer:function(t,e,i){this.containerObject[t]=e,this.cssObject[t]=i,this.loadItemsByContainer(t)},loadItemsByContainer:function(t){var e=this.containerObject[t],i=this.cssObject[t];e.getElements("[item]").each(function(t){"true"!=t.get("lazyLoading")&&this.loadItemNode(t,i)}.bind(this))},loadItemsByNameList:function(t,e){var i=this.containerObject[e],n=this.cssObject[e];i.getElements("[item]").each(function(e){var i=e.get("item");t.contains(i)&&this.loadItemNode(e,n)}.bind(this))},loadItemByName:function(t,e){var i=this.containerObject[e],n=this.cssObject[e],o=i.getElement("[item='"+t+"']");this.loadItemNode(o,n)},getItemNode:function(t,e){return this.containerObject[e].getElement("[item='"+t+"']")},loadItemNode:function(t,e){var i=this;t.store("css",e);var n=t.get("item"),o=t.get("subtype"),s=t.get("itemevent");if(this.commands[n]){var r=this.commands[n];if(!o||"button"==o){this.itemNodeObject[n]=t,r.active?(t.setStyles(e[t.get("styles")]),this.setActiveStye(t,r),t.store("active",!0)):r.disable()?(t.setStyles(e[t.get("styles")]),this.setDisableStye(t,r)):this.setNormalStye(t,r);var a=r.title||"";t.set("title",a),s&&"mouseover"!=s?t.addEvents({click:function(){t.retrieve("active")?(this.setNormalStye(t,r),t.store("active",!1)):(this.setActiveStye(t,r),t.store("active",!0))}.bind(this)}):t.addEvents({mouseover:function(){r.disable()?this.setDisableStye(t,r):this.setActiveStye(t,r)}.bind(this),mouseleave:function(){r.disable()?this.setDisableStye(t,r):this.setNormalStye(t,r)}.bind(this)});new Element("div",{text:r.locale||null}).inject(t);r.action&&t.addEvent("click",function(e){r.disable()||(r.action(e,t,r),i.fireEvent("postExecCommand",[i,this]))}.bind(n))}o&&"container"!=o||r.init&&(r.init(t,r),!1===r.active&&t.setStyle("display","none"))}},setDisableStye:function(t,e){var i=t.retrieve("css");t.setStyles(i[t.get("styles")+"_disable"]),e.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.options.style+"/icon/"+e.icon+"_disable.png)")},setActiveStye:function(t,e){var i=t.retrieve("css");t.setStyles(i[t.get("styles")+"_over"]),e.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.options.style+"/icon/"+e.icon+"_active.png)")},setNormalStye:function(t,e){var i=t.retrieve("css");t.setStyles(i[t.get("styles")]),e.icon&&t.setStyle("background-image","url(../x_component_MinderEditor/$Main/"+this.options.style+"/icon/"+e.icon+"_normal.png)")},checkStatus:function(){for(var t in this.itemNodeObject){var e=this.itemNodeObject[t];t=e.get("item");if(this.commands[t]){var i=this.commands[t];i.disable()?i.setDisable?i.setDisable():this.setDisableStye(e,i):i.setNormal?i.setNormal():this.setNormalStye(e,i)}}},setKeyCommand:function(){for(var t in this.keyCommands={},this.defaultKeyCommands={},this.commands){var e=this.commands[t];if(e.key){var i=e.isDefaultKey?this.defaultKeyCommands:this.keyCommands;if("array"==typeOf(e.key))for(var n=0;n<e.key.length;n++)i[e.key[n]]=e;else i[e.key]=e}}},getKey:function(t){var e=[];return t.ctrlKey&&e.push("Ctrl"),t.shiftKey&&e.push("Shift"),t.altKey&&e.push("Alt"),[16,17,18].contains(t.keyCode)?e.join(" + "):0==e.length?t.key.capitalize():e.join(" + ")+" + "+t.key.capitalize()},dispatchKey:function(t,e){var i=this.getKey(t),n=this.keyCommands[i];return n&&!n.disable()&&this.itemNodeObject[n.name]?n.action?(n.action(),e&&e(t,!0),!0):n.keyAction?(this.activeTooltip&&this.activeTooltip.hide(),n.keyAction(),e&&e(t,!0),!0):(e&&e(t,!0),!1):(e&&e(t,!1),!1)},save:function(){this.editor.save()},initSelectAll:function(t,e){var i=this.selectallSelector=new MWF.xApplication.MinderEditor.SelectAll(t,Object.merge(Object.clone(this.selectOptions),{onSelectItem:function(t,i){this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load()},initExpandLevel:function(t,e){var i=this.expandlevelSelector=new MWF.xApplication.MinderEditor.ExpandLevel(t,Object.merge(Object.clone(this.selectOptions),{onSelectItem:function(t,i){this.minder.execCommand("ExpandToLevel",i.value),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load()},initBackground:function(t,e){(this.backgroundSelector=new MWF.xApplication.Template.widget.ColorPicker(this.app.node,t,this.app,{},Object.merge(this.tooltipOptions,{onQueryLoad:function(t){t.disable=this.commands.background.disable()}.bind(this),onSelect:function(t){this.currentBackgroundcolor=t,-1===this.minder.queryCommandState("background")||this.minder.execCommand("background",t),this.fireEvent("postExecCommand",[this,e])}.bind(this)}))).command=e},initFontColor:function(t,e){(this.forecolorSelector=new MWF.xApplication.Template.widget.ColorPicker(this.app.node,t,this.app,{},Object.merge(this.tooltipOptions,{onQueryLoad:function(t){t.disable=this.commands.forecolor.disable()}.bind(this),onSelect:function(t){this.currentForecolor=t,-1===this.minder.queryCommandState("forecolor")||this.minder.execCommand("forecolor",t),this.fireEvent("postExecCommand",[this,e])}.bind(this)}))).command=e},initFontFamily:function(t,e){var i=this.fontfamilySelector=new MWF.xApplication.MinderEditor.FontFamily(t,Object.merge(Object.clone(this.selectOptions),{containerIsTarget:!1,onPostLoad:function(t){t.selectValueNode.addEvent("click",function(){t.currentItemData&&(-1===this.minder.queryCommandState("fontfamily")||this.minder.execCommand("fontfamily",t.currentItemData.val))}.bind(this))}.bind(this),onSelectItem:function(t,i){-1===this.minder.queryCommandState("fontfamily")||this.minder.execCommand("fontfamily",i.val),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load()},initFontSize:function(t,e){var i=this.fontsizeSelector=new MWF.xApplication.MinderEditor.FontSize(t,Object.merge(Object.clone(this.selectOptions),{containerIsTarget:!1,onPostLoad:function(t){t.selectValueNode.addEvent("click",function(){t.currentItemData&&(-1===this.minder.queryCommandState("fontsize")||this.minder.execCommand("fontsize",t.currentItemData.value))}.bind(this))}.bind(this),onSelectItem:function(t,i){-1===this.minder.queryCommandState("fontsize")||this.minder.execCommand("fontsize",i.value),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load()},initTheme:function(t,e){var i=this,n=this.themeSelector=new MWF.xApplication.MinderEditor.Theme(t,Object.merge(Object.clone(this.selectOptions),{style:"minderTheme",containerIsTarget:!0,onPostCreateItem:function(t,e){t.setStyles(i.getThemeThumbStyle(e.command))},onSelectItem:function(t,i){-1===this.minder.queryCommandState("theme")||this.minder.execCommand("theme",i.command),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);n.command=e,n.load()},initTemplate:function(t,e){var i=this.templateSelector=new MWF.xApplication.MinderEditor.Template(t,Object.merge(Object.clone(this.selectOptions),{style:"minderTemplate",containerIsTarget:!0,onSelectItem:function(t,i){this.minder.execCommand("template",i.command),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load()},initPriority:function(t,e){var i=this.prioritySelector=new MWF.xApplication.MinderEditor.PriorityImage(t,Object.merge(Object.clone(this.selectOptions),{containerIsTarget:!0,onSelectItem:function(t,i){var n="0"==i.command?null:parseInt(i.command);this.minder.execCommand("priority",n),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load(),this.minder.on("interactchange",function(){if(this.queryInteractchange()&&-1!=this.minder.queryCommandState("priority")){var t=this.minder.queryCommandValue("priority")||"0";i.setValue(t)}}.bind(this))},initProgress:function(t,e){var i=this.progressSelector=new MWF.xApplication.MinderEditor.ProgressImage(t,Object.merge(Object.clone(this.selectOptions),{containerIsTarget:!0,onSelectItem:function(t,i){var n="0"==i.command?null:parseInt(i.command);this.minder.execCommand("progress",n),this.fireEvent("postExecCommand",[this,e])}.bind(this)}),this.app,null,this.app.node);i.command=e,i.load(),this.minder.on("interactchange",function(){if(this.queryInteractchange()&&-1!=this.minder.queryCommandState("progress")){var t=this.minder.queryCommandValue("progress")||"0";i.setValue(t)}}.bind(this))},getThemeThumbStyle:function(t){var e=(this.themeList=this.themeList||kityminder.Minder.getThemeList())[t];if(e){var i={color:e["root-color"],"border-radius":e["root-radius"]/2};return e["root-background"]&&(i.background=e["root-background"].toString()),i}},toggerSearch:function(){this.isSearchbarActive?this.searchBar.hide():this.searchBar.show()},initSearch:function(t){this.minder.on("searchNode",function(){this.itemNodeObject.search.click()}.bind(this)),this.searchBar=new MWF.xApplication.MinderEditor.SearchBar(t,this.minder,this.app,this.css,{onShow:function(){this.setActiveStye(this.itemNodeObject.search,"search"),this.isSearchbarActive=!0}.bind(this),onHide:function(){this.setNormalStye(this.itemNodeObject.search,"search"),this.isSearchbarActive=!1}.bind(this)}),this.isSearchbarActive=!1,this.searchBar.load()},initHelp:function(t,e){this.helpTootips=new MWF.xApplication.MinderEditor.Help(this.app.node,t,this.app,{},this.tooltipOptions),this.helpTootips.commands=this,this.helpTootips.command=e},initSaveTooltip:function(t,e){this.savetooltip=new MWF.xApplication.MinderEditor.SaveTooltips(this.app.node,t,this.app,{},this.tooltipOptions),this.savetooltip.command=e},initExportTooltip:function(t,e){this.exporttooltip=new MWF.xApplication.MinderEditor.ExportTooltips(this.app.node,t,this.app,{},this.tooltipOptions),this.exporttooltip.command=e},initMainMenu:function(t,e){var i=this;this.mainMenu?this.mainMenu.isHidden?this.mainMenu.show():this.mainMenu.hide():(MWF.xDesktop.requireApp("MinderEditor","MainMenu",null,!1),this.mainMenu=new MWF.xApplication.MinderEditor.MainMenu(this.app.content,this.app,{onShow:function(){this.command.disable()?i.setDisableStye(this.container,this.command):i.setActiveStye(this.container,this.command)}.bind({container:t,command:e}),onHide:function(){this.command.disable()?i.setDisableStye(this.container,this.command):i.setNormalStye(this.container,this.command)}.bind({container:t,command:e})}),this.mainMenu.command=e)},setResourceDisable:function(){this.resourceMaskNode?this.resourceMaskNode.setStyle("display",""):this.resourceMaskNode=new Element("div.maskNode",{styles:this.css.resourceMaskNode}).inject(this.resourceNode),this.addResourceInput.placeholder="选择节点编辑标签"},setResourceNormal:function(){this.resourceMaskNode&&this.resourceMaskNode.setStyle("display","none"),this.addResourceInput.placeholder="输入文字添加标签"},initResource:function(t,e){this.resourceNode=new Element("div.resourceNode",{styles:this.css.resourceNode}).inject(t);var i=new Element("div",{styles:{overflow:"hidden"}}).inject(this.resourceNode);this.addResourceInput=new Element("input",{placeholder:"输入文字添加标签",styles:this.css.addResourceInput}).inject(i),this.addResourceBotton=new Element("div",{text:"添加",styles:this.css.addResourceBotton,events:{click:function(){var t=this.addResourceInput.get("value"),i=this.minder.queryCommandValue("resource");t&&/\S/.test(t)&&(-1==i.indexOf(t)&&(i.push(t),this.minder.execCommand("resource",i),this.addResourceCheckbox(t)),this.addResourceInput.set("value",""),this.fireEvent("postExecCommand",[this,e]))}.bind(this)}}).inject(i),this.resourceUsedContainer=new Element("div",{styles:this.css.resourceUsedContainer}).inject(this.resourceNode),this.setScrollBar(this.resourceUsedContainer),this.usedResource=this.minder.getUsedResource()||[],this.usedResource.each(function(t){this.addResourceCheckbox(t)}.bind(this)),this.minder.on("interactchange",function(){this.queryInteractchange()&&this.setResourceCheckbox()}.bind(this)),-1===this.minder.queryCommandState("resource")&&this.setResourceDisable()},setResourceCheckbox:function(){var t=-1!=this.minder.queryCommandState("resource")?this.minder.queryCommandValue("resource"):[];(this.resourceCheckbox||[]).each((function(e){t.contains(e.get("value"))?e.set("checked",!0):e.set("checked",!1)}))},addResourceCheckbox:function(t){this.resourceCheckbox=this.resourceCheckbox||[];var e=new Element("lable",{text:t,styles:{float:"left","margin-right":"5px",padding:"5px","background-color":this.minder.getResourceColor(t).toHEX()}}).inject(this.resourceUsedContainer),i=new Element("input",{type:"checkbox",value:t,checked:!0,events:{change:function(){var e=[];this.resourceCheckbox.each(function(t){t.get("checked")&&e.push(t.get("value"))}.bind({resourceName:t})),this.minder.execCommand("resource",e)}.bind(this)}}).inject(e,"top");this.resourceCheckbox.push(i)},editNode:function(){this.receiver.element.innerText=this.minder.queryCommandValue("text")||"",this.fsm.jump("input","input-request"),this.receiver.selectAll()},openHyperLinkForm:function(t){new MWF.xApplication.MinderEditor.HyperLinkForm(this,{},{},{app:this.app}).edit(),this.fireEvent("postExecCommand",[this,t])},openImageForm:function(t){new MWF.xApplication.MinderEditor.ImageForm(this,{},{},{app:this.app}).edit(),this.fireEvent("postExecCommand",[this,t])},openNoteForm:function(t){new MWF.xApplication.MinderEditor.NoteForm(this,{},{},{app:this.app}).edit(),this.fireEvent("postExecCommand",[this,t])},setNoteDisable:function(){this.noteTextNode&&this.noteTextNode.setStyle("display","")},setNoteNormal:function(){this.noteTextNode&&this.noteTextNode.setStyle("display","none"),this.codeMirrorEditor||this.createNoteEditor()},createNoteEditor:function(t){t?this.noteContainer=t:t=this.noteContainer;var e=this.commands.note;if(!this.noteTextNode){var i=new Element("div",{text:"备注",styles:this.css.noteTitleNode}).inject(t);new Element("a",{text:"支持GFM语法",href:"../x_component_MinderEditor/$Commands/GFMDescription.html",target:"_blank",styles:this.css.noteLinkNode}).inject(i),this.noteTextNode=new Element("div",{text:"请选择节点添加备注",styles:this.css.noteTextNode}).inject(t)}if(-1!==this.minder.queryCommandState("note")){this.noteTextNode.setStyle("display","none");var n=this.noteContentNode=new Element("div",{overflow:"hidden"}).inject(t);this.isNoteEditing=!1,this.editor.loadCodeMirror(function(){this.noteTextarea=new Element("textarea").inject(n),this.codeMirrorEditor=CodeMirror.fromTextArea(this.noteTextarea,{value:-1===this.minder.queryCommandState("note")||this.minder.queryCommandValue("note"),theme:"default",gfm:!0,breaks:!0,lineWrapping:!0,mode:"gfm",dragDrop:!1,lineNumbers:!0}),this.codeMirrorEditor.on("change",function(){var t=-1!=this.minder.queryCommandState("note"),e=this.codeMirrorEditor.getValue();t&&(this.isNoteEditing=!0,this.minder.execCommand("note",e),this.noteTimeout&&clearTimeout(this.noteTimeout),this.noteTimeout=setTimeout(function(){this.isNoteEditing=!1}.bind(this),100))}.bind(this)),this.codeMirrorEditor.setSize("100%",t.getSize().y-30-3),this.minder.on("interactchange",function(){if(this.queryInteractchange()){var t=-1!=this.minder.queryCommandState("note"),e=this.minder.queryCommandValue("note")||"";t&&this.codeMirrorEditor.setValue(e)}}.bind(this))}.bind(this)),this.fireEvent("postExecCommand",[this,e])}},toggleOpenPreViewer:function(){this.previewOpened=!this.previewOpened,this.preview.toggleOpen(this.previewOpened)},initPreViewer:function(t){this.preview=new MWF.xApplication.MinderEditor.Preview(t,this.minder,this.app,this.css),this.preview.load(),this.previewOpened=!0},initZoomArea:function(t){this.editor.contentNode.addEvent("mousewheel",function(t){if(t.wheel>0)this.minder.execCommand("zoomIn"),this.zoompanIndicator&&(e=parseInt(this.zoompanIndicator.getStyle("margin-top")))>0&&this.zoompanIndicator.setStyle("margin-top",e-10+"px");else if(t.wheel<0&&(this.minder.execCommand("zoomOut"),this.zoompanIndicator)){var e,i=parseInt(this.zoompan.getStyle("height"));(e=parseInt(this.zoompanIndicator.getStyle("margin-top")))<i&&this.zoompanIndicator.setStyle("margin-top",e+10+"px")}}.bind(this)),this.zoomIn=new Element("div",{styles:this.css.zoomButton,title:this.lp.zoomin}).inject(t),new Element("div",{styles:this.css.zoominIcon}).inject(this.zoomIn),this.zoomIn.addEvent("click",function(){this.minder.execCommand("zoomIn");var t=parseInt(this.zoompanIndicator.getStyle("margin-top"));t>0&&this.zoompanIndicator.setStyle("margin-top",t-10+"px")}.bind(this)),this.zoompan=new Element("div",{styles:this.css.zoompan}).inject(t),this.zoompanOrigin=new Element("div",{styles:this.css.zoompanOrigin}).inject(this.zoompan),this.zoompanOrigin.addEvent("click",function(){this.minder.execCommand("zoom",100),this.zoompanIndicator.setStyle("margin-top","30px")}.bind(this)),this.zoompanIndicator=new Element("div",{styles:this.css.zoompanIndicator}).inject(this.zoompan),this.zoomout=new Element("div",{styles:this.css.zoomButton,title:this.lp.zoomout}).inject(t),new Element("div",{styles:this.css.zoomoutIcon}).inject(this.zoomout),this.zoomout.addEvent("click",function(){this.minder.execCommand("zoomOut");var t=parseInt(this.zoompan.getStyle("height")),e=parseInt(this.zoompanIndicator.getStyle("margin-top"));e<t&&this.zoompanIndicator.setStyle("margin-top",e+10+"px")}.bind(this))},queryInteractchange:function(){return!this.isNoteEditing},setSizes:function(){this.codeMirrorEditor&&this.noteContainer&&this.codeMirrorEditor.setSize("100%",this.noteContainer.getSize().y-30-3)}});