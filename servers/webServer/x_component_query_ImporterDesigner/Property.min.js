MWF.xDesktop.requireApp("query.ViewDesigner","Property",null,!1),MWF.xApplication.query.ImporterDesigner.Property=new Class({Extends:MWF.FVProperty,Implements:[Options,Events],options:{style:"default",path:"../x_component_query_FormDesigner/property/property.html"},initialize:function(t,e,i,n){this.setOptions(n),this.module=t,this.importer=t.importer||t.view,this.view=t.importer||t.view,this.data=t.json,this.data.vid=this.view.json.id,this.data.vtype=this.view.json.type,this.data.pid=this.view.json.id+this.data.id,this.htmlPath=this.options.path,this.maplists={},this.designer=i,this.propertyNode=e},show:function(){this.propertyContent?this.propertyContent.setStyle("display","block"):this.getHtmlString(function(){this.htmlString&&(this.htmlString=o2.bindJson(this.htmlString,{lp:MWF.xApplication.query.ImporterDesigner.LP.propertyTemplate}),this.JsonTemplate=new MWF.widget.JsonTemplate(this.data,this.htmlString),this.propertyContent=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyNode),this.propertyContent.set("html",this.JsonTemplate.load()),this.setEditNodeEvent(),this.setEditNodeStyles(this.propertyContent),this.loadPropertyTab(),this.loadPersonInput(),this.loadPersonSelectInput(),this.loadViewFilter(),this.loadScriptArea(),this.loadColumnExportEditor(),this.loadJSONArea(),this.loadEventsEditor(),this.loadMaplist(),this.loadSelectField(),this.loadFormSelect())}.bind(this))},loadSelectField:function(){this.propertyContent.getElements(".MWFSelectField").each(function(t){t.empty();var e=new Element("select",{style:"width:200px;"}).inject(t);e.addEvent("change",function(t){this.setSelectValue(t.target.getParent("div").get("name"),e)}.bind(this)),this.setFieldSelectOptions(t,e)}.bind(this))},setFieldSelectOptions:function(t,e){var i=t.get("name");e.empty();new Element("option",{text:"none"}).inject(e);var n=this.data;Array.each(i.split("."),(function(t){n&&(n=n[t])})),(this.view.json.data.columnList||[]).each(function(t){new Element("option",{text:t.displayName+" - "+t.path,value:t.path,selected:n===t.path}).inject(e)}.bind(this)),(this.view.json.data.calculateFieldList||[]).each(function(t){new Element("option",{text:t.displayName+" - "+t.path,value:t.path,selected:n===t.path}).inject(e)}.bind(this))},loadFormSelect:function(){var t=this.propertyContent.getElements(".MWFFormSelect");t.length&&this.getFormList(function(){t.each(function(t){t.empty();var e=new Element("select",{style:"width:200px;"}).inject(t);e.addEvent("change",function(t){this.setValue(t.target.getParent("div").get("name"),t.target.options[t.target.selectedIndex].value)}.bind(this)),this.setFormSelectOptions(t,e),new Element("div",{styles:this.view.css.propertyRefreshFormNode}).inject(t).addEvent("click",function(i){this.getFormList(function(){this.setFormSelectOptions(t,e)}.bind(this),!0)}.bind(this))}.bind(this))}.bind(this),!0)},setFormSelectOptions:function(t,e){var i=t.get("name");e.empty();var n=this.data;if(Array.each(i.split("."),(function(t){n&&(n=n[t])})),this.forms){new Element("option",{text:"none"}).inject(e);this.forms.each(function(t){new Element("option",{text:t.name,value:t.id,selected:n===t.id}).inject(e)}.bind(this))}else new Element("option",{text:this.view.designer.lp.propertyTemplate.selectProcess1,value:""}).inject(e)},getFormList:function(t,e){this.view.json.data.process&&this.view.json.data.process.application&&(!this.forms||e)?o2.Actions.load("x_processplatform_assemble_designer").FormAction.listWithApplication(this.view.json.data.process.application,function(e){this.forms=e.data,t&&t()}.bind(this)):t&&t()},loadPersonSelectInput:function(){var t=this.propertyContent.getElements(".MWFSelectPerson"),e=this.propertyContent.getElements(".MWFSelectIdentity"),i=this.propertyContent.getElements(".MWFSelectUnit"),n=this.propertyContent.getElements(".MWFSelecCMStCategory"),s=this.propertyContent.getElements(".MWFSelecQueryTable"),o=this.propertyContent.getElements(".MWFSelectProcess");MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){i.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"unit",names:this.data.data.where?this.data.data.where.creatorUnitList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),t.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"person",names:this.data.data.where?this.data.data.where.creatorPersonList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),e.each(function(t){new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"identity",names:this.data.data.where?this.data.data.where.creatorIdentityList:[],onChange:function(e){this.savePersonSelectItem(t,e)}.bind(this)})}.bind(this)),n.each(function(t){var e=t.get("count")?t.get("count").toInt():0,i=this.data.data?this.data.data.category:{},n="object"===o2.typeOf(i)?[i]:i;new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"CMSCategory",names:n,count:e,onChange:function(i){this.savePersonSelectItem(t,i,e)}.bind(this)})}.bind(this)),s.each(function(t){var e=t.get("count")?t.get("count").toInt():0,i=this.data.data?this.data.data.dynamicTable:{},n="object"===o2.typeOf(i)?[i]:i;new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"QueryTable",names:n,count:e,onChange:function(i){this.savePersonSelectItem(t,i,e)}.bind(this)})}.bind(this)),o.each(function(t){var e=t.get("count")?t.get("count").toInt():0,i=this.data.data?this.data.data.process:{},n="object"===o2.typeOf(i)?[i]:i;new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(t,this.view.designer,{type:"process",names:n,count:e,onChange:function(i){this.savePersonSelectItem(t,i,e)}.bind(this)})}.bind(this))}.bind(this))},savePersonSelectItem:function(t,e,i){var n=[];e.each(function(t){var e={name:t.data.distinguishedName||t.data.name,id:t.data.id};t.data.application&&(e.application=t.data.application),t.data.applicationName&&(e.applicationName=t.data.applicationName),n.push(e)}.bind(this));for(var s=t.get("name"),o=s.split("."),a=this.data,r=0;r<o.length;r++){if(!a[o[r]]){a=null;break}a=a[o[r]]}var h=this.data,c=o.length-1;o.each(function(t,e){h[t]||(h[t]={}),e<c&&(h=h[t])}.bind(this)),h[o[c]]=1===i?n[0]||{}:n,this.changeData(s,t,a)}});