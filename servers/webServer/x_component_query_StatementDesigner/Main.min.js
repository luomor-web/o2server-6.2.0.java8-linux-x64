MWF.APPDSMD=MWF.xApplication.query.StatementDesigner,MWF.APPDSMD.options={multitask:!0,executable:!1},MWF.xDesktop.requireApp("query.StatementDesigner","Statement",null,!1),MWF.xApplication.query.StatementDesigner.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"query.StatementDesigner",icon:"icon.png",title:MWF.APPDSMD.LP.title,appTitle:MWF.APPDSMD.LP.title,id:"",tooltip:{unCategory:MWF.APPDSMD.LP.unCategory},actions:null,category:null,processData:null},onQueryLoad:function(){this.shortcut=!0,this.status&&(this.options.application=this.status.applicationId,this.application=this.status.application,this.options.id=this.status.id),this.options.id||(this.options.desktopReload=!1,this.options.title=this.options.title+"-"+MWF.APPDSMD.LP.newStatement),this.actions||(this.actions=MWF.Actions.get("x_query_assemble_designer")),this.lp=MWF.xApplication.query.StatementDesigner.LP,this.addEvent("queryClose",function(t){this.explorer&&this.explorer.reload()}.bind(this))},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openStatement((function(){t&&t()})):this.maxSize(function(){this.openStatement((function(){t&&t()}))}.bind(this)),this.options.readMode||this.addKeyboardEvents()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},addKeyboardEvents:function(){this.addEvent("keySave",function(t){this.keySave(t)}.bind(this))},keySave:function(t){this.shortcut&&(this.view.save(),t.preventDefault())},getApplication:function(t){this.application?t&&t():this.actions.getApplication(this.options.application,function(e){this.application={name:e.data.name,id:e.data.id},t&&t()}.bind(this))},openStatement:function(t){this.getApplication(function(){this.loadNodes(),this.loadStatementListNodes(),this.loadContentNode(),this.loadProperty(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadStatement((function(){t&&t()}))}.bind(this))},loadNodes:function(){this.statementListNode=new Element("div",{styles:this.css.statementListNode}).inject(this.node),this.designerNode=new Element("div",{styles:this.css.designerNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node),this.formContentNode=this.contentNode},loadStatementListNodes:function(){this.statementListTitleNode=new Element("div",{styles:this.css.statementListTitleNode,text:this.lp.statement}).inject(this.statementListNode),this.statementListResizeNode=new Element("div",{styles:this.css.statementListResizeNode}).inject(this.statementListNode),this.statementListAreaSccrollNode=new Element("div",{styles:this.css.statementListAreaSccrollNode}).inject(this.statementListNode),this.statementListAreaNode=new Element("div",{styles:this.css.statementListAreaNode}).inject(this.statementListAreaSccrollNode),this.loadStatementListResize(),this.loadStatementList()},loadStatementListResize:function(){this.statementListResize=new Drag(this.statementListResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var s=this.statementListAreaSccrollNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n=this.content.getSize(),s=t.retrieve("position"),o=t.retrieve("initialWidth").toFloat()+(i.toFloat()-s.x.toFloat());o>n.x/2&&(o=n.x/2),o<40&&(o=40),this.contentNode.setStyle("margin-left",o+1),this.statementListNode.setStyle("width",o)}.bind(this)}),this.statementListResizeNode.addEvents({touchstart:function(t){el=t.target;var e="firefox"==Browser.name?t.page.clientX:t.page.x,i="firefox"==Browser.name?t.page.clientY:t.page.y;el.store("position",{x:e,y:i});var n=this.statementListAreaSccrollNode.getSize();el.store("initialWidth",n.x)}.bind(this),touchmove:function(t){el=t.target;var e="firefox"==Browser.name?t.page.clientX:t.page.x,i=this.content.getSize(),n=el.retrieve("position"),s=el.retrieve("initialWidth").toFloat()+(e.toFloat()-n.x.toFloat());s>i.x/2&&(s=i.x/2),s<40&&(s=40),this.contentNode.setStyle("margin-left",s+1),this.statementListNode.setStyle("width",s)}.bind(this)})},loadStatementList:function(){this.actions.listStatement(this.application.id,function(t){t.data.each(function(t){this.createListStatementItem(t)}.bind(this))}.bind(this),null,!1)},createListStatementItem:function(t,e){var i=this,n=new Element("div",{styles:this.css.listStatementItem}).inject(this.statementListAreaNode,e?"top":"bottom");new Element("div",{styles:this.css.listStatementItemIcon}).inject(n),new Element("div",{styles:this.css.listStatementItemText,text:t.name?t.name+" ("+t.alias+")":this.lp.newStatement}).inject(n);n.store("statement",t),n.addEvents({dblclick:function(t){i.loadStatementByData(this,t)},mouseover:function(){i.currentListStatementItem!=this&&this.setStyles(i.css.listStatementItem_over)},mouseout:function(){i.currentListStatementItem!=this&&this.setStyles(i.css.listStatementItem)}})},loadStatementByData:function(t,e){var i=t.retrieve("statement");if(!i.isNewStatement){var n=this,s={appId:"query.StatementDesigner"+i.id,onQueryLoad:function(){this.actions=n.actions,this.category=n,this.options.id=i.id,this.application=n.application,this.explorer=n.explorer}};this.desktop.openApplication(e,"query.StatementDesigner",s)}},loadContentNode:function(){this.contentToolbarNode=new Element("div",{styles:this.css.contentToolbarNode}).inject(this.contentNode),this.options.readMode||this.loadContentToolbar(),this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode),this.loadEditContent()},loadContentToolbar:function(t){this.getFormToolbarHTML(function(e){e.getElements("span").each(function(t,e){var i=t.get("MWFButtonImage");i&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+i)}.bind(this)),$(e).inject(this.contentToolbarNode),MWF.require("MWF.widget.Toolbar",function(){this.toolbar=new MWF.widget.Toolbar(e,{style:"ProcessCategory"},this),this.toolbar.load(),this.statement&&this.statement.checkToolbars&&this.statement.checkToolbars(),t&&t()}.bind(this))}.bind(this))},getFormToolbarHTML:function(t){var e=this.path+this.options.style+"/toolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,i,n,s){var o=e[0];t&&t(o)}.bind(this),onFailure:function(t){this.notice("request processToolbars error: "+t.responseText,"error")}.bind(this)}).send()},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode)},loadProperty:function(){this.designerTitleNode=new Element("div",{styles:this.css.designerTitleNode,text:this.lp.property}).inject(this.designerNode),this.designerResizeBar=new Element("div",{styles:this.css.designerResizeBar}).inject(this.designerNode),this.loadDesignerResize(),this.designerContentNode=new Element("div",{styles:this.css.designerContentNode}).inject(this.designerNode),this.designerStatementArea=new Element("div",{styles:this.css.designerStatementArea}).inject(this.designerContentNode),this.propertyDomArea=this.designerStatementArea,this.designerStatementPercent=.6,this.designerContentResizeNode=new Element("div",{styles:this.css.designerContentResizeNode}).inject(this.designerContentNode),this.designerContentArea=new Element("div",{styles:this.css.designerContentArea}).inject(this.designerContentNode),this.propertyContentArea=this.designerContentArea,this.loadDesignerStatementResize(),this.designerNode.addEvent("keydown",(function(t){t.stopPropagation()}))},loadDesignerResize:function(){this.designerResize=new Drag(this.designerResizeBar,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var s=this.designerNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n=this.content.getSize(),s=t.retrieve("position"),o=t.retrieve("initialWidth").toFloat()+(s.x.toFloat()-i.toFloat());o>n.x/2&&(o=n.x/2),o<40&&(o=40);var a=100*(a=o/this.node.getSize().x);this.contentNode.setStyle("margin-right",a+"%"),this.designerNode.setStyle("width",a+"%")}.bind(this)})},loadDesignerStatementResize:function(){this.designerContentResize=new Drag(this.designerContentResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,n="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:n});var s=this.designerStatementArea.getSize();t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var i=this.designerContentNode.getSize(),n="firefox"==Browser.name?e.event.clientY:e.event.y,s=t.retrieve("position"),o=n.toFloat()-s.y.toFloat(),a=t.retrieve("initialHeight").toFloat()+o;a<40&&(a=40),a>i.y-40&&(a=i.y-40),this.designerStatementPercent=a/i.y,this.setDesignerStatementResize()}.bind(this)})},setDesignerStatementResize:function(){var t=this.designerContentNode.getSize().y;this.designerContentArea.setStyle("height",t+"px")},resizeNode:function(){var t=this.node.getSize();this.contentNode.setStyle("height",t.y+"px"),this.designerNode.setStyle("height",t.y+"px");var e=this.contentToolbarNode.getStyle("margin-top").toFloat(),i=this.contentToolbarNode.getStyle("margin-bottom").toFloat(),n=this.contentToolbarNode.getComputedSize(),s=t.y-n.totalHeight-e-i;if(this.editContentNode.setStyle("height",s+"px"),this.designNode){var o=this.designNode.getStyle("margin-top").toFloat(),a=this.designNode.getStyle("margin-bottom").toFloat();s=t.y-n.totalHeight-e-i-o-a,this.designNode.setStyle("height",s+"px")}titleSize=this.designerTitleNode.getSize(),titleMarginTop=this.designerTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.designerTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.designerTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.designerTitleNode.getStyle("padding-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom,s=t.y-s,this.designerContentNode.setStyle("height",s+"px"),this.designerResizeBar.setStyle("height",s+"px"),this.setDesignerStatementResize(),titleSize=this.statementListTitleNode.getSize(),titleMarginTop=this.statementListTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.statementListTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.statementListTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.statementListTitleNode.getStyle("padding-bottom").toFloat(),nodeMarginTop=this.statementListAreaSccrollNode.getStyle("margin-top").toFloat(),nodeMarginBottom=this.statementListAreaSccrollNode.getStyle("margin-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom,s=t.y-s,this.statementListAreaSccrollNode.setStyle("height",s+"px"),this.statementListResizeNode.setStyle("height",s+"px")},loadStatement:function(){this.getStatementData(this.options.id,function(t){this.setTitle(this.options.appTitle+"-"+t.name),this.taskitem.setText(this.options.appTitle+"-"+t.name),this.options.appTitle=this.options.appTitle+"-"+t.name,this.statement=new MWF.xApplication.query.StatementDesigner.Statement(this,t),this.statement.load()}.bind(this))},getStatementData:function(t,e){this.options.id?this.loadStatementData(t,e):this.loadNewStatementData(e)},loadNewStatementData:function(t){MWF.getJSON("../x_component_query_StatementDesigner/$Statement/statement.json",{onSuccess:function(e){this.actions.getUUID(function(i){e.id=i,e.isNewStatement=!0,e.application=this.application.id,this.createListStatementItem(e,!0),t&&t(e)}.bind(this))}.bind(this),onerror:function(t){this.notice(t,"error")}.bind(this),onRequestFailure:function(t){this.notice(t.responseText,"error")}.bind(this)})},loadStatementData:function(t,e){this.actions.getStatement(t,function(t){if(t){var i=t.data;this.application?e&&e(i):this.actions.getApplication(i.query,function(t){this.application={name:t.data.name,id:t.data.id},e&&e(i)}.bind(this))}}.bind(this))},preview:function(){this.statement.preview()},saveStatement:function(){this.statement.save(function(){var t=this.statement.data.name;this.setTitle(MWF.APPDSMD.LP.title+"-"+t),this.options.desktopReload=!0,this.options.id=this.statement.data.id}.bind(this))},statementHelp:function(){var t=new Element("div",{styles:{margin:"20px"}});t.set("html",this.lp.tableHelp),o2.DL.open({title:"table help",content:t,width:500,height:300,buttonList:[{text:"ok",action:function(){this.close()}}]})},recordStatus:function(){var t=[];t.push(this.statement.data.id);var e=this.statement.data.id;return{id:this.options.id,application:this.application,openViews:t,currentId:e}}});