MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.QueryExplorer=MWF.xApplication.query.QueryExplorer||{},MWF.xDesktop.requireApp("process.ApplicationExplorer","",null,!1),MWF.xApplication.query.QueryExplorer.Main=new Class({Extends:MWF.xApplication.process.ApplicationExplorer.Main,Implements:[Options,Events],options:{style:"default",name:"query.QueryExplorer",mvcStyle:"style.css",icon:"icon.png",width:"1500",height:"760",isResize:!0,isMax:!0,title:MWF.xApplication.query.QueryExplorer.LP.title,maxWidth:840,minWidth:540},onQueryLoad:function(){this.lp=MWF.QueryLP,this.viewPath=this.path+this.options.style+"/view.html",this.restActions=MWF.Actions.get("x_query_assemble_designer"),this.deleteElements=[]},loadControl:function(){this.control={},this.control.canCreate=MWF.AC.isQueryPlatformCreator(),this.control.canManage=!(!MWF.AC.isAdministrator()&&!MWF.AC.isQueryManager())},openFindDesigner:function(){layout.openApplication(null,"FindDesigner",{filter:{moduleList:["query"]}})},createApplicationItem:function(e,t){new MWF.xApplication.query.QueryExplorer.Query(this,e,t).load()},okCreateApplication:function(e){var t=this.applicationCreateFormNode.getElement(".o2_process_AppExp_createApplicationName"),i=this.applicationCreateFormNode.getElement(".o2_process_AppExp_createApplicationAlias"),n=this.applicationCreateFormNode.getElement(".o2_process_AppExp_createApplicationDescription"),o=this.applicationCreateFormNode.getElement(".o2_process_AppExp_createApplicationType"),a={name:t.get("value"),alias:i.get("value"),description:n.get("value"),queryCategory:o.get("value")};a.name?this.restActions.saveApplication(a,function(e){this.applicationCreateMarkNode.destroy(),this.applicationCreateAreaNode.destroy(),this.restActions.getApplication(e.data.id,function(e){e.data.viewList=[],e.data.statList=[],this.createApplicationItem(e.data,"top")}.bind(this)),this.reloadApplicationCategoryList(!0),this.notice(this.lp.application.createApplicationSuccess,"success")}.bind(this)):(t.setStyle("border-color","red"),t.focus(),this.notice(this.lp.application.inputApplicationName,"error"))},importApplication:function(e){MWF.xDesktop.requireApp("query.QueryExplorer","Importer",function(){new MWF.xApplication.query.QueryExplorer.Importer(this,e).load()}.bind(this))},deleteSelectedElements:function(e){var t=this,i=[];this.deleteElements.each((function(e){i.push(e.data.name)}));var n=this.lp.application.deleteElementsConfirm+" ("+i.join("、")+") ",o='<div style=\'display: none\'><br/><br/><input type="checkbox" id="deleteApplicationAllCheckbox" value="yes">'+this.lp.application.deleteApplicationAllConfirm+"</div>";n+=o,this.confirm("infor",e,this.lp.application.deleteElementsTitle,{html:n},530,250,(function(){n=t.lp.application.deleteElementsConfirmAgain+"<br/><br/><font style='color:red; font-size:14px; font-weight: bold'>"+i.join("、")+"</font>";var o=this.content.getElement("#deleteApplicationAllCheckbox"),a=!0;o.checked&&(a=!1,n=t.lp.application.deleteElementsAllConfirmAgain+"<br/><br/><font style='color:red; font-size:14px; font-weight: bold'>"+i.join("、")+"</font>"),this.close(),t.confirm("infor",e,t.lp.application.deleteElementsTitle,{html:n},500,200,(function(){var e=[],i=0,n=t.deleteElements.length,o="",p=function(){i==n&&(t.reloadApplicationCategoryList(!0),o&&t.app.notice(o,"error"))};t.deleteElements.each((function(n){n.delete(a,(function(){e.push(n),i++,t.deleteElements.length==i&&(t.deleteElements=t.deleteElements.filter((function(t,i){return!e.contains(t)})),t.checkDeleteApplication()),p()}),(function(n){o=o?o+"<br/><br/>"+n:n,i++,t.deleteElements.length==i&&(t.deleteElements=t.deleteElements.filter((function(t,i){return!e.contains(t)})),t.checkDeleteApplication()),p()}))})),this.close()}),(function(){this.close()})),this.close()}),(function(){this.close()}))}}),MWF.xApplication.query.QueryExplorer.Query=new Class({Extends:MWF.xApplication.process.ApplicationExplorer.Application,Implements:[Events],loadElements:function(){this.loadElementList("viewList",this.viewListNode,this.openView.bind(this),this.lp.noView,this.createNewView.bind(this)),this.loadElementList("statList",this.statListNode,this.openStat.bind(this),this.lp.noStat,this.createNewStat.bind(this))},createNewView:function(e){this.openApplication(e,0)},createNewStat:function(e){this.openApplication(e,1)},openApplication:function(e,t){var i="query.QueryManager"+this.data.id;this.app.desktop.apps[i]?this.app.desktop.apps[i].setCurrent():this.app.desktop.openApplication(e,"query.QueryManager",{application:this.data,appId:i,onQueryLoad:function(){this.status={navi:t||null}}})},openView:function(e,t){if(e){var i=this,n={appId:"query.ViewDesigner"+e,onQueryLoad:function(){this.actions=i.app.actions,this.options.id=e,this.application=i.data}};this.app.desktop.openApplication(t,"query.ViewDesigner",n)}},openStat:function(e,t){if(e){var i=this,n={appId:"query.StatDesigner"+e,onQueryLoad:function(){this.actions=i.app.actions,this.options.id=e,this.application=i.data}};this.app.desktop.openApplication(t,"query.StatDesigner",n)}},setIconNode:function(){this.data.icon?this.iconNode.setStyle("background-image","url(data:image/png;base64,"+this.data.icon+")"):this.iconNode.setStyle("background-image","url(../x_component_query_QueryExplorer/$Main/default/icon/application.png)"),this.iconNode.makeLnk({par:this._getLnkPar()})},_getLnkPar:function(){var e="../x_component_query_QueryExplorer/$Main/default/lnk.png";this.data.icon&&(e="data:image/png;base64,"+this.data.icon);var t="query.QueryManager"+this.data.id;return{icon:e,title:this.data.name,par:'query.QueryManager#{"application": "'+this.data.id+'", "appId": "'+t+'"}'}},exportApplication:function(){MWF.xDesktop.requireApp("query.QueryExplorer","Exporter",function(){new MWF.xApplication.query.QueryExplorer.Exporter(this.app,this.data).load()}.bind(this))},_deleteElement:function(e,t,i,n){this.app.restActions.deleteApplication(e,i,n)}});