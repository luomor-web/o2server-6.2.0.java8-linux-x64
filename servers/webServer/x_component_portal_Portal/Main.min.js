MWF.xApplication.portal=MWF.xApplication.portal||{},MWF.xApplication.portal.Portal=MWF.xApplication.portal.Portal||{},MWF.xApplication.portal.Portal.options=Object.clone(o2.xApplication.Common.options),MWF.xApplication.portal.Portal.options.multitask=!0,MWF.xApplication.portal.Portal.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"portal.Portal",icon:"icon.png",width:"1200",height:"800",title:"",portalId:"",pageId:"",widgetId:"",isControl:!1,taskObject:null,parameters:"",readonly:!1},onQueryLoad:function(){this.options.title||this.setOptions({title:MWF.xApplication.portal.Portal.LP.title}),this.lp=MWF.xApplication.portal.Portal.LP,this.status&&(this.options.portalId=this.status.portalId,this.options.pageId=this.status.pageId,this.options.widgetId=this.status.widgetId,this.options.parameters=this.status.parameters)},loadApplication:function(t){this.node=new Element("div",{styles:this.css.content}).inject(this.content),this.formNode=new Element("div",{styles:{"min-height":"100%","font-size":"14px"}}).inject(this.node),this.action=MWF.Actions.get("x_portal_assemble_surface"),this.options.isRefresh?this.loadPortal(this.options.parameters,t):this.maxSize(function(){this.loadPortal(this.options.parameters,t)}.bind(this))},toPortal:function(t,a,i,e){this.options.portalId=t,this.options.pageId=a,e||this.doHistory(a,this.options.portalId),this.appForm&&this.appForm.fireEvent("beforeClose"),Object.keys(this.$events).each(function(t){this.removeEvents(t)}.bind(this)),MWF.release(this.appForm),this.appForm=null,this.formNode.empty(),this.loadPortal(i)},doHistory:function(t,a){if(this.inBrowser){var i={page:t,id:a||this.options.portalId};history.pushState(i,"page")}},toPage:function(t,a,i){i||this.doHistory(t,this.portal.id);var e=null,o=!1,s=function(){e&&o&&(this.pageJson=e,layout.sessionPromise.finally(function(){var t,i=e.data.page?e.data.page.name:e.data.name;this.setTitle(this.portal&&this.portal.name?this.portal.name+"-"+i:i),e.data.page?(this.pageDataText=e.data.page.data?MWF.decodeJsonString(e.data.page.data):"",t=this.pageDataText?JSON.decode(this.pageDataText):null,this.relatedFormMap=e.data.relatedWidgetMap,this.relatedScriptMap=e.data.relatedScriptMap,delete e.data.page.data,this.pageInfor=e.data.page):(this.pageDataText=e.data.data?MWF.decodeJsonString(e.data.data):"",t=this.pageDataText?JSON.decode(this.pageDataText):null,delete e.data.data,this.pageInfor=e.data),t&&(this.options.pageId=e.data.id,this.appForm&&this.appForm.fireEvent("beforeClose"),Object.keys(this.$events).each(function(t){this.removeEvents(t)}.bind(this)),MWF.release(this.appForm),this.appForm=null,this.formNode.empty(),this.page=t,this.openPortal(a))}.bind(this)))}.bind(this);if(t){var p=layout.mobile?"getPageByNameMobileV2":"getPageByNameV2";this.action[p](t,this.portal.id,function(t){e=t,s()}.bind(this));MWF.xDesktop.requireApp("process.Xform","$all",(function(){o=!0,s()}))}else if(this.options.pageId){p=layout.mobile?"getPageByNameMobileV2":"getPageByNameV2";this.action[p](this.options.pageId,this.portal.id,function(t){e=t,s()}.bind(this)),MWF.xDesktop.requireApp("process.Xform","$all",(function(){o=!0,s()}))}},loadPortal:function(t,a){this.options.pageId||this.options.widgetId?(this.loadPortalPage(t,a),this.getPageData()):this.getPageData(function(t){this.options.pageId=this.portal.firstPage,this.loadPortalPage()}.bind(this))},openPage:function(t,a,i){var e=t.data.page?t.data.page.name:t.data.name;this.setTitle(this.portal&&this.portal.name?this.portal.name+"-"+e:e),t.data.page?(this.pageDataText=t.data.page.data?MWF.decodeJsonString(t.data.page.data):"",this.page=this.pageDataText?JSON.decode(this.pageDataText):null,this.relatedFormMap=t.data.relatedWidgetMap,this.relatedScriptMap=t.data.relatedScriptMap,delete t.data.page.data,this.pageInfor=t.data.page):(this.pageDataText=t.data.data?MWF.decodeJsonString(t.data.data):"",this.page=this.pageDataText?JSON.decode(this.pageDataText):null,delete t.data.data,this.pageInfor=t.data),this.openPortal(a,i)},loadPortalPage:function(t,a){var i,e=null,o=!1,s=function(){e&&o&&(this.pageJson=e,layout.session&&layout.session.user?this.openPage(e,t,a):layout.sessionPromise&&layout.sessionPromise.then(function(){this.openPage(e,t,a)}.bind(this),function(){this.openPage(e,t,a)}.bind(this)))}.bind(this);i=this.options.widgetId?layout.mobile?"getWidgetByNameMobile":"getWidgetByName":layout.mobile?"getPageByNameMobileV2":"getPageByNameV2",this.action[i](this.options.widgetId||this.options.pageId,this.options.portalId,function(t){e=t,s()}.bind(this)),MWF.xDesktop.requireApp("process.Xform","$all",(function(){o=!0,s()}))},getPageData:function(t){this.portal?t&&t(this.portal):this.action.getApplication(this.options.portalId,function(a){if(this.portal=a.data,this.pageJson){var i=this.pageJson.data.page?this.pageJson.data.page.name:this.pageJson.data.name;this.setTitle(this.portal.name+"-"+i)}this.portal.icon&&this.taskitem&&this.taskitem.iconNode.setStyles({"background-image":"url(data:image/png;base64,"+this.portal.icon+")","background-size":"24px 24px"}),t&&t(a)}.bind(this))},openPortal:function(t,a){this.page&&(this.appForm=new MWF.APPForm(this.formNode,this.page,{macro:"PageContext",parameters:t}),this.appForm.businessData={control:{allowSave:!0},pageInfor:this.pageInfor,data:{}},this.appForm.workAction=this.action,this.appForm.app=this,this.appForm.formDataText=this.pageDataText,this.appForm.load(),a&&a(),this.mask&&this.mask.hide())},recordStatus:function(){return{portalId:this.options.portalId,pageId:this.options.pageId,parameters:this.options.parameters}},onPostClose:function(){this.appForm&&(this.appForm.modules.each((function(t){MWF.release(t)})),MWF.release(this.appForm))}});