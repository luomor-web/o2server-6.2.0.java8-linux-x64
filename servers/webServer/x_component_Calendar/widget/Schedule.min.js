var MWFCalendar=MWF.xApplication.Calendar=MWF.xApplication.Calendar||{};MWF.xDesktop.requireApp("Calendar","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Calendar","Common",null,!1),o2.widget.Schedule=o2.Schedule=new Class({Implements:[Options,Events],Extends:o2.widget.Common,options:{style:"default",weekBegin:0,date:"",title:""},initialize:function(t,e,n){this.setOptions(n),this.container=t,this._app=e,this.path=this.options.path||"../x_component_Calendar/widget/$Schedule/",this.cssPath="../x_component_Calendar/widget/$Schedule/"+this.options.style+"/css.wcss",this._loadCss(),this.fireEvent("init"),this.load()},load:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);var t="";this.options.date&&(t=Date.parse(this.options.date)),this.app={actions:MWF.Actions.get("x_calendar_assemble_control"),lp:MWF.xApplication.Calendar.LP,content:this._app.content},this.calendar=new o2.Schedule.Calendar(this,t)},reload:function(){this.calendar&&this.calendar.reLoadCalendar()},destroy:function(){this.calendar&&this.calendar.destroy(),this.node.destroy()}}),o2.Schedule.Calendar=new Class({Implements:[Events],initialize:function(t,e){this.view=t,this.css=this.view.css,this.container=this.view.node,this.date=e||new Date,this.today=new Date,this.days={},this.app=this.view.app,this.lp=MWF.xApplication.Calendar.LP,this.weekBegin=this.view.options.weekBegin,this.load()},load:function(){this.titleNode=new Element("div",{styles:this.css.calendarTitleNode}).inject(this.container),this.contentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.container),this.leftContentNode=new Element("div",{styles:{float:"left"}}).inject(this.contentNode),this.rightContentNode=new Element("div",{styles:this.css.rightContentNode}).inject(this.contentNode),this.titleTableContainer=new Element("div",{styles:this.css.calendarTitleTableContainer}).inject(this.leftContentNode),this.bodyNode=new Element("div",{styles:this.css.contentNode}).inject(this.leftContentNode),this.setTitleNode(),this.setTitleTableNode(),this.setBodyNode()},resetBodySize:function(){var t=this.view.container.getSize(),e=this.titleNode.getSize(),n=this.titleTable.getSize(),i=t.y-e.y-n.y;this.leftContentNode.setStyle("width",t.x-160+"px"),this.rightContentNode.setStyle("height",t.y-e.y-35+"px"),o2.Schedule.TdHeight=i/6,o2.Schedule.TdWidth=(t.x-160)/7},setTitleNode:function(){this.view.options.title&&new Element("div",{styles:this.css.titleNameNode,text:this.view.options.title}).inject(this.titleNode);var t=this.date.format(this.lp.dateFormatDay);this.titleTextNode=new Element("div",{styles:this.css.calendarTitleTextNode,text:t}).inject(this.titleNode),this.nextMonthNode=new Element("div",{styles:this.css.calendarNextMonthNode}).inject(this.titleNode),this.prevMonthNode=new Element("div",{styles:this.css.calendarPrevMonthNode}).inject(this.titleNode),this.prevMonthNode.addEvents({mouseover:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_over)}.bind(this),mouseout:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode)}.bind(this),mousedown:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_down)}.bind(this),mouseup:function(){this.prevMonthNode.setStyles(this.css.calendarPrevMonthNode_over)}.bind(this),click:function(){this.changeMonthPrev()}.bind(this)}),this.nextMonthNode.addEvents({mouseover:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_over)}.bind(this),mouseout:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode)}.bind(this),mousedown:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_down)}.bind(this),mouseup:function(){this.nextMonthNode.setStyles(this.css.calendarNextMonthNode_over)}.bind(this),click:function(){this.changeMonthNext()}.bind(this)}),this.titleTextNode.addEvents({mouseover:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this),mouseout:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode)}.bind(this),mousedown:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_down)}.bind(this),mouseup:function(){this.titleTextNode.setStyles(this.css.calendarTitleTextNode_over)}.bind(this),click:function(){this.changeMonthSelect()}.bind(this)})},changeMonthPrev:function(){this.date.decrement("month",1);var t=this.date.format(this.lp.dateFormatDay);this.titleTextNode.set("text",t),this.reLoadCalendar()},changeMonthNext:function(){this.date.increment("month",1);var t=this.date.format(this.lp.dateFormatDay);this.titleTextNode.set("text",t),this.reLoadCalendar()},changeMonthSelect:function(){this.monthSelector||this.createMonthSelector(),this.monthSelector.show()},createMonthSelector:function(){this.monthSelector=new o2.Schedule.MonthSelector(this.date,this)},changeMonthTo:function(t){this.date=t;var e=this.date.format(this.lp.dateFormatDay);this.titleTextNode.set("text",e),this.reLoadCalendar()},setTitleTableNode:function(){if("1"==this.weekBegin)var t="<tr><th>"+this.lp.weeksShort.Mon+"</th><th>"+this.lp.weeksShort.Tues+"</th><th>"+this.lp.weeksShort.Wed+"</th><th>"+this.lp.weeksShort.Thur+"</th><th>"+this.lp.weeksShort.Fri+"</th><th>"+this.lp.weeksShort.Sat+"</th><th>"+this.lp.weeksShort.Sun+"</th></tr>";else t="<tr><th>"+this.lp.weeksShort.Sun+"</th><th>"+this.lp.weeksShort.Mon+"</th><th>"+this.lp.weeksShort.Tues+"</th><th>"+this.lp.weeksShort.Wed+"</th><th>"+this.lp.weeksShort.Thur+"</th><th>"+this.lp.weeksShort.Fri+"</th><th>"+this.lp.weeksShort.Sat+"</th></tr>";this.titleTable=new Element("table",{styles:this.css.calendarTable,height:"100%",border:"0",cellPadding:"0",cellSpacing:"0",html:t}).inject(this.titleTableContainer),this.calendarTableTitleTr=this.titleTable.getElement("tr"),this.calendarTableTitleTr.setStyles(this.css.calendarTableTitleTr),this.calendarTableTitleTr.getElements("th").setStyles(this.css.calendarTableTh)},setBodyNode:function(){this.calendarTable=new Element("table",{styles:this.css.calendarTable,height:"100%",border:"0",cellPadding:"0",cellSpacing:"0",html:"<tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>"}).inject(this.bodyNode),this.loadCalendar()},reLoadCalendar:function(){this.loadCalendar()},calculateMonthRange:function(){var t=this.date.clone(),e=new Date(t.get("year"),t.get("month"),1,0,0,0),n=e.getDay();if("1"==this.weekBegin)var i=n-1<0?6:n-1;else i=n;e.decrement("day",i),this.monthStart=e,this.monthStartStr=this.monthStart.format("db");var s=e.clone();s.increment("day",41),this.monthEnd=new Date(s.get("year"),s.get("month"),s.get("date"),23,59,59),this.monthEndStr=this.monthEnd.format("db")},inCurrentMonth:function(t){return t>this.monthStart&&t<this.monthEnd},loadCalendar:function(){this.calculateMonthRange(),this.cancelCurrentTd(),this.loadData(function(){this.resetBodySize(),this._loadCalendar(!1),this.loadDayContent(this.date)}.bind(this))},_loadCalendar:function(t){var e=this.date.clone();e.set("date",1);var n=e.getDay();if("1"==this.weekBegin)var i=n-1<0?6:n-1;else i=n;e.decrement("day",i),this.calendarTable.getElements("td").each(function(n){this.loadDay(n,e,t),e.increment()}.bind(this))},loadData:function(t){this.app.actions.listMyCalendar(function(e){var n=[];e.data.myCalendars.each((function(t){n.push(t.id)})),e.data.unitCalendars.each((function(t){n.push(t.id)})),e.data.followCalendars.each((function(t){n.push(t.id)})),this.app.actions.listEventWithFilter({calendarIds:n,startTime:this.monthStartStr,endTime:this.monthEndStr},function(e){this.wholeDayData=e.data&&e.data.wholeDayEvents?e.data.wholeDayEvents:[],this.wholeDayData.each((function(t){t.start=Date.parse(t.startTimeStr),t.end=Date.parse(t.endTimeStr)})),this.inOneDayEventMap={},(e.data&&e.data.inOneDayEvents?e.data.inOneDayEvents:[]).each(function(t){t.inOneDayEvents&&t.inOneDayEvents.length&&(this.inOneDayEventMap[t.eventDate]=t.inOneDayEvents)}.bind(this)),t&&t()}.bind(this))}.bind(this))},isDateHasData:function(t){var e="string"===typeOf(t)?t:t.format("%Y-%m-%d");if(this.inOneDayEventMap[e]&&this.inOneDayEventMap[e].length)return!0;for(var n=Date.parse(e+" 00:00:00"),i=Date.parse(e+" 23:59:59"),s=0;s<this.wholeDayData.length;s++){var o=this.wholeDayData[s];if(o.start<=n&&o.end>=i)return!0}return!1},getDataByDate:function(t){var e="string"===typeOf(t)?t:t.format("%Y-%m-%d"),n=[];this.inOneDayEventMap[e]&&this.inOneDayEventMap[e].length&&(n=this.inOneDayEventMap[e].clone());var i=Date.parse(e+" 00:00:00"),s=Date.parse(e+" 23:59:59");return this.wholeDayData.each(function(t){t.start<=i&&t.end>=s&&n.push(t)}.bind(this)),n},loadDay:function(t,e,n){var i=this;t.empty();var s="thisMonth",o=e.get("month"),d=e.get("year"),h=e.get("date"),a=this.date.get("month"),l=this.date.get("year"),r=this.date.get("date"),c=this.today.get("month"),m=this.today.get("year"),u=this.today.get("date");s=o==c&&d==m&&h==u?"today":o==a&&d==l?"thisMonth":"otherMonth";var y=this.isDateHasData(e);t.set("align","center"),t.set("height",o2.Schedule.TdHeight),t.setStyles(this.css["calendarTableCell_"+s]),t.store("dateStr",e.format("%Y-%m-%d")),t.store("type",s),t.addEvent("click",function(t){i.setCurrentTd(this.td),i.loadDayContent(this.date)}.bind({td:t,date:e.format("%Y-%m-%d")})),t.addEvent("dblclick",function(t){i.toDay(this.retrieve("dateStr"))}.bind(t));var v=new Element("div",{styles:this.css["dayTitleDay_"+s],text:h}).inject(t);if(t.store("titleDayNode",v),y&&new Element("div",{styles:"today"===s?this.css.dayHasData_today:this.css.dayHasData}).inject(v),"today"===s){var p=Math.min(o2.Schedule.TdHeight,o2.Schedule.TdWidth);p=p>26?26:p,v.setStyles({width:p+"px",height:p+"px","line-height":p+"px"})}else o==a&&d==l&&h==r&&this.setCurrentTd(t)},create:function(t){var e=new MWF.xApplication.Calendar.EventForm(this,{},{startTime:t+" 08:00",endTime:t+" 09:00"},{app:this.app});e.view=this,e.create()},isEditable:function(){return!!MWF.AC.isAdministrator()||(!!(this.data.manageablePersonList||[]).contains(layout.desktop.session.user.distinguishedName)||this.data.createPerson===layout.desktop.session.user.distinguishedName)},openEventForm:function(t){var e=new MWF.xApplication.Calendar.EventForm(this,t,{isFull:!0},{app:this.app});e.view=this.view,this.isEditable(t)?e.edit():e.open()},toDay:function(t){if(layout.desktop.apps.Calendar){var e=layout.desktop.apps.Calendar;e.status={options:{date:t}},e.toMonth(),e.setCurrent()}else{var n={defaultAction:"toMonth",onQueryLoad:function(){this.status={options:{date:t}}}};layout.desktop.openApplication(null,"Calendar",n)}},setCurrentTd:function(t){this.cancelCurrentTd(),"today"!=t.retrieve("type")&&t.retrieve("titleDayNode").setStyles(this.css.dayTitleDay_current),this.currentSelectedTd=t},cancelCurrentTd:function(){if(this.currentSelectedTd){var t=this.currentSelectedTd.retrieve("type");"today"!=t&&this.currentSelectedTd.retrieve("titleDayNode").setStyles(this.css["dayTitleDay_"+t])}this.currentSelectedTd=null},reload:function(){this.view.reload()},destroy:function(){Object.each(this.days,function(t){t.destroy()}.bind(this)),this.container.empty()},loadDayContent:function(t){t="string"===typeOf(t)?t:t.format("%Y-%m-%d");var e=this;this.rightContentNode.empty();var n=Date.parse(t).format(this.lp.dateFormatDay);this.titleTextNode.set("text",n);var i=this.getDataByDate(t);if(0==i.length){var s=new Element("div",{styles:this.css.rightContentTitle}).inject(this.rightContentNode);new Element("div",{styles:this.css.rightContentTitle_text,text:this.lp.schedule.noEvent}).inject(s);var o=new Element("div",{styles:this.css.rightContentItemContainer}).inject(this.rightContentNode)}else{s=new Element("div",{styles:{overflow:"hidden"}}).inject(this.rightContentNode);new Element("div",{styles:this.css.rightContentTitle_text,text:this.lp.schedule.current}).inject(s),new Element("div",{styles:this.css.rightContentTitle_count,text:i.length}).inject(s),new Element("div",{styles:this.css.rightContentTitle_text,text:this.lp.schedule.someEvent}).inject(s);o=new Element("div",{styles:this.css.rightContentItemContainer}).inject(this.rightContentNode);for(var d=0;d<i.length&&d<2;d++){var h=i[d],a=new Element("div",{styles:this.css.rightContentItem}).inject(o);a.addEvent("click",function(){e.openEventForm(this.data)}.bind({data:h})),new Element("div",{styles:this.css.rightContentItemDot}).inject(a),new Element("div",{styles:this.css.rightContentItemText,text:h.title}).inject(a);var l,r=Date.parse(h.startTime),c=Date.parse(h.endTime);l=r.format("%Y-%m-%d")===c.format("%Y-%m-%d")?r.format("%H:%M")+this.lp.to+c.format("%H:%M"):r.format("%m-%d")+this.lp.to+c.format("%m-%d"),new Element("div",{styles:this.css.rightContentItemTime,text:l}).inject(a)}}new Element("div",{styles:this.css.rightToolbar}).inject(this.rightContentNode);new Element("div",{styles:this.css.rightTool_add,text:this.lp.add}).inject(this.rightContentNode).addEvent("click",function(){this.create(t)}.bind(this)),new Element("div",{styles:this.css.rightTool_more,text:this.lp.more}).inject(this.rightContentNode).addEvent("click",function(){this.toDay(t)}.bind(this))}}),o2.Schedule.TdHeight=30,o2.Schedule.TdWidth=40,o2.Schedule.MonthSelector=new Class({Implements:[Events],initialize:function(t,e){this.calendar=e,this.css=this.calendar.css,this.app=this.calendar.app,this.lp=this.app.lp,this.date=t,this.year=this.date.get("year"),this.load()},load:function(){this.monthSelectNode=new Element("div",{styles:this.css.calendarMonthSelectNode}).inject(this.calendar.container),this.monthSelectNode.position({relativeTo:this.calendar.titleTextNode,position:"bottomCenter",edge:"upperCenter"}),this.monthSelectNode.addEvent("mousedown",(function(t){t.stopPropagation()})),this.monthSelectTitleNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNode}).inject(this.monthSelectNode),this.monthSelectPrevYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitlePrevYearNode}).inject(this.monthSelectTitleNode),this.monthSelectNextYearNode=new Element("div",{styles:this.css.calendarMonthSelectTitleNextYearNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode=new Element("div",{styles:this.css.calendarMonthSelectTitleTextNode}).inject(this.monthSelectTitleNode),this.monthSelectTextNode.set("text",this.year);this.monthSelectTable=new Element("table",{styles:{"margin-top":"10px"},height:"200px",width:"90%",align:"center",border:"0",cellPadding:"0",cellSpacing:"0",html:"<tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td></tr>"}).inject(this.monthSelectNode),this.monthSelectBottomNode=new Element("div",{styles:this.css.calendarMonthSelectBottomNode,text:this.lp.today}).inject(this.monthSelectNode),this.setEvent()},loadMonth:function(){this.monthSelectTextNode.set("text",this.year);var t=new Date,e=t.get("year"),n=t.get("month"),i=this.date.get("year"),s=this.date.get("month"),o=this;this.monthSelectTable.getElements("td").each(function(t,d){t.empty(),t.removeEvents("mouseover"),t.removeEvents("mouseout"),t.removeEvents("mousedown"),t.removeEvents("mouseup"),t.removeEvents("click");var h=d+1;t.store("month",h),t.setStyles(this.css.calendarMonthSelectTdNode),t.setStyle("background-color","#FFF"),this.year==e&&d==n?new Element("div",{styles:o.css.calendarMonthSelectTodayNode,text:""+h+this.lp.month}).inject(t):this.year==i&&d==s?new Element("div",{styles:o.css.calendarMonthSelectCurrentNode,text:""+h+this.lp.month}).inject(t):t.set("text",""+h+this.lp.month),t.addEvents({mouseover:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},mouseout:function(){this.setStyles(o.css.calendarMonthSelectTdNode)},mousedown:function(){this.setStyles(o.css.calendarMonthSelectTdNode_down)},mouseup:function(){this.setStyles(o.css.calendarMonthSelectTdNode_over)},click:function(){o.selectedMonth(this)}})}.bind(this))},setEvent:function(){this.monthSelectPrevYearNode.addEvent("click",function(){this.prevYear()}.bind(this)),this.monthSelectNextYearNode.addEvent("click",function(){this.nextYear()}.bind(this)),this.monthSelectBottomNode.addEvents({mouuseover:function(){this.monthSelectBottomNode.setStyles(this.css.calendarMonthSelectBottomNode_over)}.bind(this),mouuseout:function(){this.monthSelectBottomNode.setStyles(this.css.calendarMonthSelectBottomNode)}.bind(this),click:function(){this.todayMonth()}.bind(this)})},prevYear:function(){this.year--,this.year<1900&&(this.year=1900),this.monthSelectTextNode.set("text",this.year),this.loadMonth()},nextYear:function(){this.year++,this.monthSelectTextNode.set("text",this.year),this.loadMonth()},todayMonth:function(){var t=new Date;this.calendar.changeMonthTo(t),this.hide()},selectedMonth:function(t){var e=t.retrieve("month"),n=Date.parse(this.year+"/"+e+"/1");this.calendar.changeMonthTo(n),this.hide()},show:function(){this.date=this.calendar.date,this.year=this.date.get("year"),this.loadMonth(),this.monthSelectNode.setStyle("display","block"),this.hideFun=this.hide.bind(this),document.body.addEvent("mousedown",this.hideFun)},hide:function(){this.monthSelectNode.setStyle("display","none"),document.body.removeEvent("mousedown",this.hideFun)},destroy:function(){}});