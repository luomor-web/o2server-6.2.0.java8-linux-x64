o2.xApplication.ConfigDesigner.options={multitask:!0,executable:!1},o2.xDesktop.requireApp("ConfigDesigner","Script",null,!1),o2.require("o2.xDesktop.UserData",null,!1),o2.xApplication.ConfigDesigner.Main=new Class({Extends:o2.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"ConfigDesigner",icon:"icon.png",title:o2.xApplication.ConfigDesigner.LP.title,appTitle:o2.xApplication.ConfigDesigner.LP.title,id:"node_127.0.0.1.json",actions:null,category:null,portalData:null},onQueryLoad:function(){this.actions=o2.Actions.load("x_program_center"),this.lp=o2.xApplication.ConfigDesigner.LP,this.addEvent("queryClose",function(t){this.explorer&&this.explorer.reload()}.bind(this))},loadApplication:function(t){this.createNode(),this.options.isRefresh?this.openScript():this.maxSize(function(){this.openScript()}.bind(this)),t&&t()},createNode:function(){this.content.setStyle("overflow","hidden"),this.node=new Element("div",{styles:{width:"100%",height:"100%",overflow:"hidden"}}).inject(this.content)},getApplication:function(t){t&&t()},openScript:function(){this.getApplication(function(){this.loadNodes(),this.loadScriptListNodes(),this.loadContentNode(function(){this.loadProperty(),this.resizeNode(),this.addEvent("resize",this.resizeNode.bind(this)),this.loadScript(),this.toolbarContentNode&&(this.setScrollBar(this.toolbarContentNode,null,{V:{x:0,y:0},H:{x:0,y:0}}),this.setScrollBar(this.propertyDomArea,null,{V:{x:0,y:0},H:{x:0,y:0}}))}.bind(this))}.bind(this))},loadNodes:function(){this.scriptListNode=new Element("div",{styles:this.css.scriptListNode}).inject(this.node),this.propertyNode=new Element("div",{styles:this.css.propertyNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node)},loadScriptListNodes:function(){this.scriptListTitleNode=new Element("div",{styles:this.css.scriptListTitleNode,text:o2.xApplication.ConfigDesigner.LP.scriptLibrary}).inject(this.scriptListNode),this.scriptListResizeNode=new Element("div",{styles:this.css.scriptListResizeNode}).inject(this.scriptListNode),this.scriptListAreaSccrollNode=new Element("div",{styles:this.css.scriptListAreaSccrollNode}).inject(this.scriptListNode),this.scriptListAreaNode=new Element("div",{styles:this.css.scriptListAreaNode}).inject(this.scriptListAreaSccrollNode),this.loadScriptListResize(),this.loadScriptList()},setScroll:function(){o2.require("o2.widget.ScrollBar",function(){this.listScrollBar=new o2.widget.ScrollBar(this.scriptListAreaSccrollNode,{style:"xDesktop_Message",where:"before",indent:!1,distance:100,friction:6,axis:{x:!1,y:!0}})}.bind(this))},loadScriptListResize:function(){this.scriptListResize=new Drag(this.scriptListResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.scriptListAreaSccrollNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialWidth").toFloat()+(i.toFloat()-s.x.toFloat());n>o.x/2&&(n=o.x/2),n<40&&(n=40),this.contentNode.setStyle("margin-left",n+1),this.scriptListNode.setStyle("width",n)}.bind(this)})},loadScriptList:function(){this.actions.ConfigAction.getList(function(t){data=t.data;var e=JSON.parse(data.config);for(var i in this.config=e,e)i.indexOf("node_")>-1&&(this.options.id=i),this.createListScriptItem(i,e[i]);this.setScroll()}.bind(this),null,!1)},createListScriptItem:function(t,e){var i=this,o=new Element("div",{styles:this.css.listScriptItem}).inject(this.scriptListAreaNode,"bottom");new Element("div",{styles:this.css.listScriptItemIcon}).inject(o),new Element("div",{styles:this.css.listScriptItemText,text:t.replace(".json","")+" ("+e+")"}).inject(o);o.store("script",{id:t,name:e}),o.addEvents({dblclick:function(t){i.loadScriptByData(this,t)},mouseover:function(){i.currentListScriptItem!=this&&this.setStyles(i.css.listScriptItem_over)},mouseout:function(){i.currentListScriptItem!=this&&this.setStyles(i.css.listScriptItem)}}),this.listScriptItemMove(o)},createScriptListCopy:function(t){var e=t.clone().inject(this.node);e.position({relativeTo:t,position:"upperLeft",edge:"upperLeft"});var i=e.getSize();return e.setStyles({width:i.x+"px",height:i.y+"px","z-index":50001}),e},listDragEnter:function(t,e){var i=e.retrieve("markNode");if(!i){var o=e.getSize();(i=new Element("div",{styles:this.css.dragListItemMark}).inject(this.node)).setStyles({width:o.x+"px",height:o.y+"px",position:"absolute","background-color":"#666","z-index":5e4,opacity:.3}),i.position({relativeTo:e,position:"upperLeft",edge:"upperLeft"});var s=i.getStyle("top").toFloat()-1,n=i.getStyle("left").toFloat()-2;i.setStyles({left:n+"px",top:s+"px"}),e.store("markNode",i)}},listDragLeave:function(t,e){var i=e.retrieve("markNode");i&&i.destroy(),e.eliminate("markNode")},listScriptItemMove:function(t){t.getFirst().addEvent("mousedown",function(e){var i=t.retrieve("script");if(i.id!=this.scriptTab.showPage.script.data.id){var o=this.createScriptListCopy(t),s=[this.designNode,this.propertyDomArea];new Drag.Move(o,{droppables:s,onEnter:function(t,e){this.listDragEnter(t,e)}.bind(this),onLeave:function(t,e){this.listDragLeave(t,e)}.bind(this),onDrag:function(t){}.bind(this),onDrop:function(t,e){e?(this.addIncludeScript(i),this.listDragLeave(t,e),o.destroy()):o.destroy()}.bind(this),onCancel:function(t){o.destroy()}.bind(this)}).start(e)}}.bind(this))},addIncludeScript:function(t){var e=this.scriptTab.showPage.script;-1==e.data.dependScriptList.indexOf(t.name)&&(e.data.dependScriptList.push(t.name),this.addIncludeToList(t.name))},addIncludeToList:function(t){this.actions.getScriptByName(t,this.application.id,function(t){var e=t.data,i=new Element("div",{styles:this.css.includeScriptItem}).inject(this.propertyIncludeListArea),o=new Element("div",{styles:this.css.includeScriptItemAction}).inject(i);new Element("div",{styles:this.css.includeScriptItemText}).inject(i).set("text",e.name+" ("+e.alias+")"),i.store("script",e);var s=this;o.addEvent("click",(function(){var t=this.getParent(),e=t.retrieve("script");e&&s.scriptTab.showPage.script.data.dependScriptList.erase(e.name),t.destroy()}))}.bind(this),function(){this.scriptTab.showPage.script.data.dependScriptList.erase(t)}.bind(this))},loadScriptByData:function(t,e){for(var i=t.retrieve("script"),o=i.name,s=!0,n=0;n<this.scriptTab.pages.length;n++)if(i.id==this.scriptTab.pages[n].script.data.id){this.scriptTab.pages[n].showTabIm(),s=!1;break}s&&this.loadScriptData(i.id,function(t){t.name=o,new o2.xApplication.ConfigDesigner.Script(this,t).load()}.bind(this),!0)},loadContentNode:function(t,e){this.contentToolbarNode=new Element("div#contentToolbarNode",{styles:this.css.contentToolbarNode}).inject(this.contentNode),this.loadContentToolbar(t),this.editContentNode=new Element("div",{styles:this.css.editContentNode}).inject(this.contentNode),this.loadEditContent(function(){this.designNode&&this.designNode.setStyles(this.css.designNode),e&&e()}.bind(this))},loadContentToolbar:function(t){this.getFormToolbarHTML(function(e){e.getElements("span").each(function(t,e){var i=t.get("MWFButtonImage");i&&t.set("MWFButtonImage",this.path+""+this.options.style+"/toolbar/"+i)}.bind(this)),$(e).inject(this.contentToolbarNode),o2.require("o2.widget.Toolbar",function(){this.toolbar=new o2.widget.Toolbar(e,{style:"ProcessCategory"},this),this.toolbar.load();var i=this;this.styleSelectNode=e.getElement("select[MWFnodetype='theme']"),this.styleSelectNode.addEvent("change",(function(){i.changeEditorStyle(this)})),this.fontsizeSelectNode=e.getElement("select[MWFnodetype='fontSize']"),this.fontsizeSelectNode.addEvent("change",(function(){i.changeFontSize(this)})),this.editorSelectNode=e.getElement("select[MWFnodetype='editor']"),this.editorSelectNode.addEvent("change",(function(){i.changeEditor(this)})),this.monacoStyleSelectNode=e.getElement("select[MWFnodetype='monaco-theme']"),this.monacoStyleSelectNode.addEvent("change",(function(){i.changeEditorStyle(this)})),t&&t()}.bind(this))}.bind(this))},changeEditor:function(t){var e=t.selectedIndex,i=t.options[e].value;o2.editorData||(o2.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),o2.editorData.javascriptEditor.editor=i,o2.UD.putData("editor",o2.editorData),this.scriptTab.pages.each(function(t){var e=t.script.editor;e&&e.changeEditor(i)}.bind(this)),"ace"==i?(this.monacoStyleSelectNode.hide(),this.styleSelectNode.show()):(this.monacoStyleSelectNode.show(),this.styleSelectNode.hide())},changeFontSize:function(t){var e=t.selectedIndex,i=t.options[e].value;this.scriptTab.pages.each(function(t){var e=t.script.editor;e&&e.setFontSize(i)}.bind(this)),o2.editorData||(o2.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),o2.editorData.javascriptEditor.fontSize=i,o2.UD.putData("editor",o2.editorData)},changeEditorStyle:function(t){var e=t.selectedIndex,i=t.options[e].value;this.scriptTab.pages.each(function(t){var e=t.script.editor;e&&e.setTheme(i)}.bind(this)),o2.editorData||(o2.editorData={javascriptEditor:{monaco_theme:"vs",theme:"tomorrow",fontSize:"12px"}}),"monaco"===o2.editorData.javascriptEditor.editor?o2.editorData.javascriptEditor.monaco_theme=i:o2.editorData.javascriptEditor.theme=i,o2.UD.putData("editor",o2.editorData)},getFormToolbarHTML:function(t){var e=this.path+this.options.style+"/toolbars.html";new Request.HTML({url:e,method:"get",onSuccess:function(e,i,o,s){var n=e[0];t&&t(n)}.bind(this),onFailure:function(t){this.notice("request portalToolbars error: "+t.responseText,"error")}.bind(this)}).send()},maxOrReturnEditor:function(){this.isMax?(this.isMax=!1,this.designNode.inject(this.editContentNode),this.designNode.setStyles(this.css.designNode),this.designNode.setStyles({position:"static"}),this.resizeNode(),this.scriptTab.pages.each((function(t){t.script.setAreaNodeSize()}))):(this.designNode.inject(this.node),this.designNode.setStyles({position:"absolute",width:"100%",height:"100%",top:"0px",margin:"0px",left:"0px"}),this.scriptTab.pages.each((function(t){t.script.setAreaNodeSize()})),this.isMax=!0)},loadEditContent:function(t){this.designNode=new Element("div",{styles:this.css.designNode}).inject(this.editContentNode),o2.require("o2.widget.Tab",function(){this.scriptTab=new o2.widget.Tab(this.designNode,{style:"script"}),this.scriptTab.load()}.bind(this),!1)},loadProperty:function(){this.propertyTitleNode=new Element("div",{styles:this.css.propertyTitleNode,text:o2.xApplication.ConfigDesigner.LP.property}).inject(this.propertyNode),this.propertyResizeBar=new Element("div",{styles:this.css.propertyResizeBar}).inject(this.propertyNode),this.loadPropertyResize(),this.propertyContentNode=new Element("div",{styles:this.css.propertyContentNode}).inject(this.propertyNode),this.propertyDomArea=new Element("div",{styles:this.css.propertyDomArea}).inject(this.propertyContentNode),this.propertyDomPercent=.3,this.propertyContentResizeNode=new Element("div",{styles:this.css.propertyContentResizeNode}).inject(this.propertyContentNode),this.propertyContentArea=new Element("div",{styles:this.css.propertyContentArea}).inject(this.propertyContentNode),this.loadPropertyContentResize(),this.setPropertyContent(),this.setIncludeNode()},setIncludeNode:function(){this.includeTitleNode=new Element("div",{styles:this.css.includeTitleNode}).inject(this.propertyDomArea),this.includeTitleActionNode=new Element("div",{styles:this.css.includeTitleActionNode}).inject(this.includeTitleNode),this.includeTitleTextNode=new Element("div",{styles:this.css.includeTitleTextNode,text:this.lp.include}).inject(this.includeTitleNode),this.includeTitleActionNode.addEvent("click",function(){this.addInclude()}.bind(this)),this.propertyIncludeListArea=new Element("div",{styles:{overflow:"hidden"}}).inject(this.propertyDomArea)},addInclude:function(){},setPropertyContent:function(){new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.id+":"}).inject(this.propertyContentArea);this.propertyIdNode=new Element("div",{styles:this.css.propertyTextNode,text:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.name+":"}).inject(this.propertyContentArea),this.propertyNameNode=new Element("div",{styles:this.css.propertyTextNode,text:""}).inject(this.propertyContentArea),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.node+":"}).inject(this.propertyContentArea),this.propertyServerNode=new Element("select",{styles:this.css.propertyTextNode}).inject(this.propertyContentArea),o2.Actions.load("x_program_center").CommandAction.getNodeInfoList(function(t){var e=t.data.nodeList;e.length>1&&new Element("option",{value:"*",text:"*"}).inject(this.propertyServerNode),e.each(function(t){new Element("option",{value:t.node.nodeAgentPort,text:t.nodeAddress}).inject(this.propertyServerNode)}.bind(this))}.bind(this),null,!1),new Element("div",{styles:this.css.propertyItemTitleNode,text:this.lp.description+":"}).inject(this.propertyContentArea),this.propertyDescriptionNode=new Element("div",{styles:this.css.propertyTextNode,text:""}).inject(this.propertyContentArea)},loadPropertyResize:function(){this.propertyResize=new Drag(this.propertyResizeBar,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyNode.getSize();t.store("initialWidth",s.x)}.bind(this),onDrag:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o=this.content.getSize(),s=t.retrieve("position"),n=t.retrieve("initialWidth").toFloat()+(s.x.toFloat()-i.toFloat());n>o.x/2&&(n=o.x/2),n<40&&(n=40),this.contentNode.setStyle("margin-right",n+1),this.propertyNode.setStyle("width",n)}.bind(this)})},loadPropertyContentResize:function(){this.propertyContentResize=new Drag(this.propertyContentResizeNode,{snap:1,onStart:function(t,e){var i="firefox"==Browser.name?e.event.clientX:e.event.x,o="firefox"==Browser.name?e.event.clientY:e.event.y;t.store("position",{x:i,y:o});var s=this.propertyDomArea.getSize();t.store("initialHeight",s.y)}.bind(this),onDrag:function(t,e){var i=this.propertyContentNode.getSize(),o="firefox"==Browser.name?e.event.clientY:e.event.y,s=t.retrieve("position"),n=o.toFloat()-s.y.toFloat(),r=t.retrieve("initialHeight").toFloat()+n;r<40&&(r=40),r>i.y-40&&(r=i.y-40),this.propertyDomPercent=r/i.y,this.setPropertyContentResize()}.bind(this)})},setPropertyContentResize:function(){var t=this.propertyContentNode.getSize(),e=this.propertyContentResizeNode.getSize(),i=t.y-e.y,o=this.propertyDomPercent*i,s=i-o;this.propertyDomArea.setStyle("height",o+"px"),this.propertyContentArea.setStyle("height",s+"px")},resizeNode:function(){if(!this.isMax){var t=this.node.getSize();this.contentNode.setStyle("height",t.y+"px"),this.propertyNode.setStyle("height",t.y+"px");var e=this.contentToolbarNode.getStyle("margin-top").toFloat(),i=this.contentToolbarNode.getStyle("margin-bottom").toFloat(),o=this.contentToolbarNode.getComputedSize(),s=t.y-o.totalHeight-e-i;if(this.editContentNode.setStyle("height",s+"px"),this.designNode){var n=this.designNode.getStyle("margin-top").toFloat(),r=this.designNode.getStyle("margin-bottom").toFloat();s=t.y-o.totalHeight-e-i-n-r,this.designNode.setStyle("height",s+"px")}titleSize=this.propertyTitleNode.getSize(),titleMarginTop=this.propertyTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.propertyTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.propertyTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.propertyTitleNode.getStyle("padding-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom,s=t.y-s,this.propertyContentNode.setStyle("height",s+"px"),this.propertyResizeBar.setStyle("height",s+"px"),this.setPropertyContentResize(),titleSize=this.scriptListTitleNode.getSize(),titleMarginTop=this.scriptListTitleNode.getStyle("margin-top").toFloat(),titleMarginBottom=this.scriptListTitleNode.getStyle("margin-bottom").toFloat(),titlePaddingTop=this.scriptListTitleNode.getStyle("padding-top").toFloat(),titlePaddingBottom=this.scriptListTitleNode.getStyle("padding-bottom").toFloat(),nodeMarginTop=this.scriptListAreaSccrollNode.getStyle("margin-top").toFloat(),nodeMarginBottom=this.scriptListAreaSccrollNode.getStyle("margin-bottom").toFloat(),s=titleSize.y+titleMarginTop+titleMarginBottom+titlePaddingTop+titlePaddingBottom+nodeMarginTop+nodeMarginBottom,s=t.y-s,this.scriptListAreaSccrollNode.setStyle("height",s+"px"),this.scriptListResizeNode.setStyle("height",s+"px")}},loadScript:function(){this.getScriptData(this.options.id,function(t){t.name=this.config[this.options.id],this.script=new o2.xApplication.ConfigDesigner.Script(this,t),this.script.load()}.bind(this))},getScriptData:function(t,e){this.loadScriptData(t,e)},loadScriptData:function(t,e,i){this.actions.ConfigAction.open({fileName:t},function(i){if(i){var o=i.data;o.id=t,o.text=o.fileContent,e&&e(o)}}.bind(this))},saveScript:function(){if(this.scriptTab.showPage){var t=this.scriptTab.showPage.script;t.save(function(){if(t==this.script){var e=t.data.name;this.setTitle(o2.xApplication.ConfigDesigner.LP.title+"-"+e),this.options.desktopReload=!0,this.options.id=t.data.id}}.bind(this))}},saveDictionaryAs:function(){this.dictionary.saveAs()},dictionaryExplode:function(){this.dictionary.explode()},dictionaryImplode:function(){this.dictionary.implode()}});