MWF.xApplication=MWF.xApplication||{},MWF.xApplication.portal=MWF.xApplication.portal||{},MWF.xApplication.ConfigDesigner=MWF.xApplication.ConfigDesigner||{},MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("ConfigDesigner","lp."+MWF.language,null,!1),MWF.require("MWF.widget.JavascriptEditor",null,!1),MWF.xApplication.ConfigDesigner.Script=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",showTab:!0},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_portal_ScriptDesigner/$Script/",this.cssPath="../x_component_portal_ScriptDesigner/$Script/"+this.options.style+"/css.wcss",this._loadCss(),this.isChanged=!1,this.designer=t,this.data=e,this.data.text||(this.data.text=""),this.node=this.designer.designNode,this.tab=this.designer.scriptTab,this.areaNode=new Element("div",{styles:{overflow:"hidden",height:"700px"}}),this.propertyIncludeNode=this.designer.propertyDomArea,this.propertyNode=this.designer.propertyContentArea,this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewScript=!this.data.id,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode||(this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFScriptAutoSaveCheck")),this.autoSaveCheckNode&&this.autoSaveCheckNode.get("checked")&&this.isChanged&&this.saveSilence()}.bind(this),6e4)},load:function(){this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.page=this.tab.addTab(this.areaNode,this.data.name||this.designer.lp.newScript,!this.data.isNewScript&&this.data.id!=this.designer.options.id),this.page.script=this,this.page.addEvent("show",function(){this.designer.scriptListAreaNode.getChildren().each(function(t){t.retrieve("script").id==this.data.id&&(this.designer.currentListScriptItem&&this.designer.currentListScriptItem.setStyles(this.designer.css.listScriptItem),t.setStyles(this.designer.css.listScriptItem_current),this.designer.currentListScriptItem=t,this.lisNode=t)}.bind(this)),this.designer.currentScript=this,this.setPropertyContent(),this.editor&&this.editor.focus()}.bind(this)),this.page.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.lisNode&&this.lisNode.setStyles(this.designer.css.listScriptItem)}.bind(this)),this.page.tabNode.addEvent("dblclick",this.designer.maxOrReturnEditor.bind(this.designer)),this.editor=new MWF.widget.JavascriptEditor(this.areaNode,{option:{value:"",mode:"json",lineNumbers:!0}}),this.editor.load(function(){this.data.text&&this.editor.setValue(this.data.text),this.editor.addEditorEvent("change",function(){this.isChanged||(this.isChanged=!0,this.page.textNode.set("text"," * "+this.page.textNode.get("text")))}.bind(this)),this.editor.addEvent("save",function(){this.save()}.bind(this));for(var t=this.designer.styleSelectNode.options,e=0;e<t.length;e++){if((i=t[e]).value==this.editor.theme){i.set("selected",!0);break}}t=this.designer.fontsizeSelectNode.options;for(e=0;e<t.length;e++){if((i=t[e]).value==this.editor.fontSize){i.set("selected",!0);break}}t=this.designer.editorSelectNode.options;for(e=0;e<t.length;e++){if((i=t[e]).value==this.editor.options.type){i.set("selected",!0);break}}t=this.designer.monacoStyleSelectNode.options;for(e=0;e<t.length;e++){var i;if((i=t[e]).value==this.editor.theme){i.set("selected",!0);break}}"ace"==this.editor.options.type?(this.designer.monacoStyleSelectNode.hide(),this.designer.styleSelectNode.show()):(this.designer.monacoStyleSelectNode.show(),this.designer.styleSelectNode.hide())}.bind(this)),this.options.showTab&&this.page.showTabIm()},showReferenceMenu:function(){var t=this.editor.getCursorPixelPosition(),e={page:{}};e.page.x=t.left,e.page.y=t.top,this.scriptReferenceMenu.menu.showIm(e)},setIncludeNode:function(){this.designer.propertyIncludeListArea.empty(),this.data.dependScriptList.each(function(t){this.designer.addIncludeToList(t)}.bind(this))},setPropertyContent:function(){this.designer.propertyIdNode.set("text",this.data.id||""),this.designer.propertyNameNode.set("text",this.data.name||""),this.designer.propertyDescriptionNode.set("text",this.data.description||"")},setAreaNodeSize:function(){var t=this.node.getSize(),e=this.tab.tabNodeContainer.getSize(),i=t.y-e.y;this.areaNode.setStyle("height",i+"px"),this.editor&&this.editor.resize()},addInclude:function(){},save:function(t){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{this.editor.validated();this.data.fileName=this.data.id,this.data.text=this.editor.getValue(),this.data.fileContent=this.editor.getValue(),this.data.nodeName=this.designer.propertyServerNode.getElement("option:selected").get("text"),this.data.nodePort=this.designer.propertyServerNode.getElement("option:selected").get("value"),this.isSave=!0,this.designer.actions.ConfigAction.save(this.data,function(e){this.isSave=!1,this.data.isNewScript=!1,this.isChanged=!1,this.page.textNode.set("text",this.data.name),this.lisNode&&this.lisNode.getLast().set("text",this.data.name),this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"}),t&&t()}.bind(this),function(t,e,i){this.isSave=!1;var s=i+":"+e;t&&(s=t.responseText),MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+s)}.bind(this))}},saveSilence:function(t){if(this.isSave)MWF.xDesktop.notice("info",{x:"right",y:"top"},this.designer.lp.isSave);else{var e=this.editor.validated();if(this.designer.currentScript==this){var i=this.designer.propertyNameNode.get("value"),s=this.designer.propertyAliasNode.get("value"),n=this.designer.propertyDescriptionNode.get("value");if(!i)return this.designer.notice(this.designer.lp.notice.inputName,"error"),!1;this.data.name=i,this.data.alias=s,this.data.description=n,this.data.validated=e}this.data.text=this.editor.getValue(),this.isSave=!0,this.designer.actions.saveScript(this.data,function(e){this.isSave=!1,this.data.isNewScript=!1,this.isChanged=!1,this.page.textNode.set("text",this.data.name),this.lisNode&&this.lisNode.getLast().set("text",this.data.name),this.data.id=e.data.id,t&&t()}.bind(this),function(t,e,i){this.isSave=!1}.bind(this))}},saveAs:function(){},explode:function(){},implode:function(){}});