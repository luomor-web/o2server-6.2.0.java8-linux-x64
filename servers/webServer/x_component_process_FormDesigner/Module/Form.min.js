MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.require("MWF.widget.Common",null,!1),MWF.xApplication.process.FormDesigner.Module.Form=MWF.FCForm=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/Form/form.html",mode:"PC",fields:["Calendar","Checkbox","Datagrid","Datagrid$Title","Datagrid$Data","Datatable","Datatable$Title","Datatable$Data","Datatemplate","Htmleditor","Number","Office","Orgfield","org","Personfield","Radio","Select","Textarea","Textfield"],injectActions:[{name:"top",styles:"injectActionTop",event:"click",action:"injectTop",title:MWF.APPFD.LP.formAction.insertTop},{name:"bottom",styles:"injectActionBottom",event:"click",action:"injectBottom",title:MWF.APPFD.LP.formAction.insertBottom}]},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_process_FormDesigner/Module/Form/",this.cssPath="../x_component_process_FormDesigner/Module/Form/"+this.options.style+"/css.wcss",this._loadCss(),this.container=null,this.form=this,this.moduleType="form",this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.designer=t,this.container=e,this.selectedModules=[]},reload:function(t){this.moduleList.each(function(t){t.property&&t.property.destroy()}.bind(this)),this.property&&this.property.destroy(),this.property=null,this.moduleList=[],this.moduleNodeList=[],this.moduleContainerNodeList=[],this.moduleElementNodeList=[],this.moduleComponentNodeList=[],this.dataTemplate={},this.selectedModules=[],this.container.empty(),this.treeNode&&(this.domTree.empty(),this.domTree.node.destroy(),this.domTree=null,this.treeNode=null),this.currentSelectedModule=null,this.propertyMultiTd=null,this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID),this.load(t),this.selected()},load:function(t){this.data=t,this.json=t.json,this.html=t.html,this.json.mode=this.options.mode,this.json.css||(this.json.css={code:""}),"Mobile"===this.options.mode&&(this.json.defaultTools||(this.json.defaultTools=o2.JSON.get(this.path+"toolbars.json",null,!1)),this.json.tools||(this.json.tools=[])),this.isNewForm=!this.json.id,this.isNewForm&&this.checkUUID(),this.designer.application&&(this.data.json.applicationName=this.designer.application.name),this.designer.application&&(this.data.json.application=this.designer.application.id),this.container.set("html",this.html),this.loadStylesList(function(){var t=this.json.formStyleType;if("object"===typeOf(t)&&"script"===t.type)this.loadCustomTemplateStyles(t,function(t){this._load(t)}.bind(this));else{"object"===typeOf(t)&&(t=t.id);var e="";if(t&&this.stylesList[t]||(this.json.formStyleType="blue-simple",t="blue-simple"),"Mobile"==this.options.mode&&"defaultMobile"!=t){var i=this.stylesList[t];i&&"array"===typeOf(i.mode)&&i.mode.contains("mobile")||(e=t,this.json.formStyleType="defaultMobile",t="defaultMobile")}this.loadTemplateStyles(this.stylesList[t].file,this.stylesList[t].extendFile,function(t){this._load(t,e)}.bind(this))}}.bind(this))},_load:function(t,e){this.templateStyles=t,this.loadDomModules(),this.json.formStyleType&&this.templateStyles&&this.templateStyles.form&&this.setTemplateStyles(this.templateStyles.form),this.setCustomStyles(),this.node.setProperties(this.json.properties),this.setNodeEvents(),"Mobile"==this.options.mode&&e&&this._setEditStyle("formStyleType",null,e),this.selected(),this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this)),this.designer.fireEvent("postFormLoad")},removeStyles:function(t,e){this.json[e]&&Object.each(t,function(t,i){this.json[e][i]&&this.json[e][i]==t&&delete this.json[e][i]}.bind(this))},copyStyles:function(t,e){this.json[e]||(this.json[e]={}),Object.each(t,function(t,i){this.json[e][i]||(this.json[e][i]=t)}.bind(this))},clearTemplateStyles:function(t){t&&(t.styles&&this.removeStyles(t.styles,"styles"),t.properties&&this.removeStyles(t.properties,"properties")),this.json.confirmStyle&&delete this.json.confirmStyle,this.json.dialogStyle&&delete this.json.dialogStyle,this.json.attachmentStyle&&delete this.json.attachmentStyle,this.json.hideModuleIcon&&delete this.json.hideModuleIcon,this.json.nodeStyleWithhideModuleIcon&&delete this.json.nodeStyleWithhideModuleIcon,this.json.confirmIcon&&delete this.json.confirmIcon,this.json.submitedDlgUseNotice&&delete this.json.submitedDlgUseNotice,this.json.submitedDlgStyle&&delete this.json.submitedDlgStyle,this.json.selectorStyle&&delete this.json.selectorStyle,this.json.errorStyle&&delete this.json.errorStyle,this.json.noticeStyle&&delete this.json.noticeStyle,this.json.noticeErrorStyle&&delete this.json.noticeErrorStyle,this.json.noticeSuccessStyle&&delete this.json.noticeSuccessStyle,this.json.noticeOkStyle&&delete this.json.noticeOkStyle,this.json.noticeNoticeStyle&&delete this.json.noticeNoticeStyle},setTemplateStyles:function(t){t.styles&&this.copyStyles(t.styles,"styles"),t.properties&&this.copyStyles(t.properties,"properties")},loadCustomTemplateStyles:function(scriptObject,callback){this.designer.actions.getScriptByName(scriptObject.name,scriptObject.application,function(json){try{var f=eval("(function(){\n return "+json.data.text+"\n})"),j=f();"object"!==typeOf(j)?this.designer.notice(MWF.APPFD.LP.notValidJson,"error"):callback&&callback(j)}catch(t){this.designer.notice(t.message,"error")}}.bind(this),function(t){this.designer.notice(JSON.parse(t.responseText).message,"error"),callback&&callback({})}.bind(this))},loadTemplateStyles:function(t,e,i){t?(this.templateStylesList=this.templateStylesList||{},this.templateStylesList[t]?i&&i(this.templateStylesList[t]):this.loadTemplateStyleFile(t,function(s){this.loadTemplateExtendStyleFile(e,function(e){this.templateStylesList[t]=Object.merge(s,e),i&&i(this.templateStylesList[t])}.bind(this))}.bind(this))):i&&i({})},loadTemplateStyleFile:function(t,e){if(t){var i="../x_component_process_FormDesigner/Module/Form/skin/"+t;MWF.getJSON(i,{onSuccess:function(t){e&&e(t)}.bind(this),onRequestFailure:function(){e&&e({})}.bind(this),onError:function(){e&&e({})}.bind(this)})}else e&&e({})},loadTemplateExtendStyleFile:function(t,e){if(t){var i="../x_component_process_FormDesigner/Module/Form/skin/"+t;MWF.getJSON(i,{onSuccess:function(t){e&&e(t)}.bind(this),onRequestFailure:function(){e&&e({})}.bind(this),onError:function(){e&&e({})}.bind(this)})}else e&&e({})},loadStylesList:function(t){if(this.stylesList)t(this.stylesList);else{MWF.getJSON("../x_component_process_FormDesigner/Module/Form/skin/config.json",{onSuccess:function(e){this.stylesList=e,t&&t(this.stylesList)}.bind(this),onRequestFailure:function(){this.stylesList={},t&&t(this.stylesList)}.bind(this),onError:function(){this.stylesList={},t&&t(this.stylesList)}.bind(this)})}},autoSave:function(){this.autoSaveCheckNode=this.designer.formToolbarNode.getElement("#MWFFormAutoSaveCheck"),this.autoSaveCheckNode&&(this.autoSaveTimerID=window.setInterval(function(){this.autoSaveCheckNode.get("checked")&&this.save()}.bind(this),6e4))},checkUUID:function(){this.designer.actions.getUUID(function(t){this.json.id=t}.bind(this))},loadDomModules:function(){this.node=this.container.getFirst(),this.node.set("id",this.json.id),this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode),this.node.store("module",this);var t=this.json.id.replace(/\-/g,"");(this.node.get("class")||"").split(" ").each(function(t){0===t.indexOf("css")&&35===t.length&&this.node.removeClass(t)}.bind(this)),this.node.addClass("css"+t),this.reloadCss();var e=this.container.getStyle("height");e=e?e.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",e+"px"),this.designer.addEvent("resize",function(){var t=this.container.getStyle("height");t=t?t.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",t+"px")}.bind(this)),this.loadDomTree()},loadDomTree:function(){MWF.require("MWF.widget.Tree",function(){this.domTree=new MWF.widget.Tree(this.designer.propertyDomArea,{style:"domtree"}),this.domTree.load(),this.createFormTreeNode(),this.parseModules(this,this.node)}.bind(this))},createFormTreeNode:function(){var t="<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",e={expand:!0,title:this.json.id,text:"<"+this.json.type+"> "+this.json.name+" ["+this.options.mode+"] ",icon:"Mobile"==this.options.mode?"mobile.png":"pc.png",action:function(){this.module&&this.module.selected()}};this.treeNode=this.domTree.appendChild(e),this.treeNode.setText(t),this.treeNode.module=this},getModuleNodes:function(t,e){for(var i=[],s=t.getFirst();s;){var o=s.get("MWFtype")||s.get("mwftype");if(o){if(e)-1===o.indexOf("$")&&i.push(s);else i.push(s);i=i.concat(this.getModuleNodes(s))}else i=i.concat(this.getModuleNodes(s));s=s.getNext()}return i},parseModules:function(t,e){for(var i=[],s=e.getFirst();s;){if(s.get("MWFtype")){var o=this.getDomjson(s),n=s;i.push({dom:n,json:o})}s=s.getNext()}i.each(function(e){module=this.loadModule(e.json,e.dom,t)}.bind(this))},getDomjson:function(t){switch(t.get("MWFtype")){case"form":return this.json;case"":return null;default:var e=t.get("id");return e?this.json.moduleList[e]:null}},loadModule:function(t,e,i){if(t){if(MWF["FC"+t.type]){o=t.type.capitalize();return this.getTemplateData(o,function(o){var n=Object.clone(o);Object.merge(n,t),Object.merge(t,n),(s=new MWF["FC"+t.type](this)).load(t,e,i)}.bind(this),!1),s}o=t.type.capitalize();return this.getTemplateData(o,function(o){var n=Object.clone(o);Object.merge(n,t),Object.merge(t,n),(s=new MWF.FCDiv(this)).load(t,e,i)}.bind(this),!1),s}var s,o=(e.get("MWFType")||"div").capitalize();return this.getTemplateData(o,function(t){var n=Object.clone(t);n.id=e.get("id"),this.json.moduleList[e.get("id")]=n,(s=new MWF["FC"+o](this)).load(n,e,i)}.bind(this),!1),s},setNodeEvents:function(){this.node.addEvent("click",function(t){this.selected()}.bind(this)),this.designer.content.addEvent("keydown",function(t){this.moveModule&&(t.control?this.moveModule._setControlMode(!0):this.moveModule._setControlMode(!1))}.bind(this)),this.designer.content.addEvent("keyup",function(t){this.moveModule&&(t.control?this.moveModule._setControlMode(!0):this.moveModule._setControlMode(!1))}.bind(this))},createModuleImmediately:function(t,e,i,s,o,n){var l;return this.getTemplateData(t,function(n){var r=Object.clone(n);l=new MWF["PC"+t](this),e&&(l.onDragModule=e,e.Component||(l.inContainer=e),l.parentContainer=e,l.nextModule=null),l.createImmediately(r,i,s,o)}.bind(this),n),l},createModule:function(t,e){this.getTemplateData(t,function(i){var s=Object.clone(i);new MWF["FC"+t](this).create(s,e)}.bind(this))},getTemplateData:function(t,e,i){if(this.dataTemplate[t])e&&e(this.dataTemplate[t]);else{var s="../x_component_process_FormDesigner/Module/"+t+"/template.json";MWF.getJSON(s,function(i,s){this.dataTemplate[t]=i,e&&e(i)}.bind(this),i)}},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this)return!0;this.currentSelectedModule.unSelected()}this.propertyMultiTd&&(this.propertyMultiTd.hide(),this.propertyMultiTd=null),this.unSelectedMulti(),this.currentSelectedModule=this,this.treeNode&&this.treeNode.selectNode(),this.showProperty()},unSelectedMulti:function(){for(;this.selectedModules.length;)this.selectedModules[0].unSelectedMulti();this.multimoduleActionsArea&&this.multimoduleActionsArea.setStyle("display","none")},unSelectAll:function(){},_beginSelectMulti:function(){this.currentSelectedModule&&this.currentSelectedModule.unSelected(),this.unSelectedMulti(),this.noSelected=!0},_completeSelectMulti:function(){this.selectedModules.length<2?this.selectedModules[0].selected():this._showMultiActions()},createMultimoduleActionsArea:function(){this.multimoduleActionsArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999","z-index":10001}}).inject(this.form.container,"after")},_showMultiActions:function(){this.multimoduleActionsArea||this.createMultimoduleActionsArea();var t=this._getFirstMultiSelectedModule();if(t){var e=t.position.y-25,i=t.position.x;this.multimoduleActionsArea.setPosition({x:i,y:e}),this.multimoduleActionsArea.setStyle("display","block")}},_getFirstMultiSelectedModule:function(){var t=null;return this.selectedModules.each((function(e){var i=e.node.getPosition(e.form.node.getOffsetParent());t?(i.y<t.position.y||i.y==t.position.y&&i.x<t.position.x)&&(t={module:e,position:i}):t={module:e,position:i}})),t},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.process.FormDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},unSelected:function(){this.currentSelectedModule=null,this.hideProperty()},_dragIn:function(t){this.Component||(t.inContainer=this),t.parentContainer=this,this.node.setStyles({border:"1px solid #ffa200"}),t._getCopyNode().inject(this.node)},_dragOut:function(t){t.inContainer=null,t.parentContainer=null,this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode),this.node.setStyles(this.json.styles),t._getCopyNode().setStyle("display","none")},_dragDrop:function(t,e){(e||!new Event(event).control)&&(this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode),this.node.setStyles(this.json.styles))},_showInjectAction:function(t){t.moveNode&&t.moveNode.setStyle("display","none"),this.draggingModule=t,this.injectActionArea||this._createInjectAction(),this.injectActionArea.setStyle("display","block"),this._setInjectActionAreaPosition(),this.injectActionEffect=new Fx.Morph(this.injectActionArea,{duration:200,transition:Fx.Transitions.Sine.easeOut}),this.injectActionEffect.start(this.form.css.injectActionArea_to)},_hideInjectAction:function(){this.draggingModule=null,this.injectActionArea&&this.injectActionArea.setStyle("display","none")},_createInjectAction:function(){var t=this.form.css;if(!this.injectActionArea){this.injectActionArea=new Element("div",{styles:t.injectActionArea}).inject(this.form.container,"after"),this.injectActionTopBGNode=new Element("div",{styles:t.injectActionTopBGNode}).inject(this.injectActionArea),this.injectActionLeftBGNode=new Element("div",{styles:t.injectActionLeftBGNode}).inject(this.injectActionArea),this.injectActionRightBGNode=new Element("div",{styles:t.injectActionRightBGNode}).inject(this.injectActionArea),this.injectActionBottomBGNode=new Element("div",{styles:t.injectActionBottomBGNode}).inject(this.injectActionArea);var e={};this.options.injectActions.each((function(t){e[t.name]=t})),e.before&&this._createInjectActionNode(e.before,this.injectActionTopBGNode),e.top&&this._createInjectActionNode(e.top,this.injectActionLeftBGNode),e.bottom&&this._createInjectActionNode(e.bottom,this.injectActionRightBGNode),e.after&&this._createInjectActionNode(e.after,this.injectActionBottomBGNode),new Element("div",{styles:t.injectActionCancelNode,events:{click:function(){this.draggingModule._dragCancel(),this._dragDrop(this.node,!0),this._hideInjectAction()}.bind(this),mouseover:function(){this.setStyles(t.injectActionCancelNode_over)},mouseout:function(){this.setStyles(t.injectActionCancelNode)}}}).inject(this.injectActionArea)}},_createInjectActionNode:function(t,e){var i=new Element("div",{styles:this.css[t.styles],title:t.title}).inject(this.injectActionArea);i.addEvent(t.event,function(e){this[t.action](e)}.bind(this)),i.addEvents({mouseover:function(i){e.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,t.name)}.bind(this),mouseout:function(t){e.setStyle("background","transparent")}.bind(this)}),e.set("title",t.title),e.addEvent(t.event,function(e){this[t.action](e)}.bind(this)),e.setStyle("cursor","pointer"),e.addEvents({mouseenter:function(i){e.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,t.name)}.bind(this),mouseleave:function(t){e.setStyle("background","transparent")}.bind(this)})},_setInjectActionAreaPosition:function(){var t=new Event(event),e=this.node.getOffsetParent().getPosition(),i=t.page.y-e.y-60,s=t.page.x-e.x-60;this.injectActionArea.setPosition({x:s,y:i})},injectBefore:function(t){this.inject("before")},injectAfter:function(t){this.inject("after")},injectTop:function(t){this.inject("top")},injectBottom:function(t){this.inject("bottom")},inject:function(t){this.draggingModule.moveNode&&this.draggingModule.moveNode.setStyle("display",""),this.draggingModule._dragComplete(this.node,t),this._dragDrop(this.node,!0),this._hideInjectAction()},_clearNoId:function(t){for(var e=t.getFirst();e;){var i=e.getNext();e.get("MWFType")?e.get("id")?e&&this._clearNoId(e):e.destroy():e&&this._clearNoId(e),e=i}},_copyFormJson:function(t,e){var i=e||{};return Object.keys(t).each(function(e){if("defaultValue"!=e)switch(typeOf(t[e])){case"object":var s=JSON.stringify(t[e],null,"\t");/((?:\:\s*)((\".+\")|(\d+)|(\[.+\])))/.test(s)&&(i[e]=this._copyFormJson(t[e],i[e]));break;case"boolean":i[e]=t[e];break;default:t[e]&&(i[e]=t[e])}else i[e]=t[e]}.bind(this)),i},_preprocessingModuleData:function(){this.moduleList.each((function(t){t._preprocessingModuleData()}))},_recoveryModuleData:function(){this.moduleList.each((function(t){t.setCustomStyles(),t.setCustomInputStyles&&t.setCustomInputStyles()}))},_getFormData:function(t){this.fireEvent("queryGetFormData"),this._preprocessingModuleData();var e=this.node.clone(!0,!0);e.clearStyles(),this.fireEvent("postGetFormData"),this._clearNoId(e);var i=e.outerHTML;e.destroy(),this.data.json.mode=this.options.mode,this.data.html=i;var s=this._copyFormJson(this.data);if(s.json.styleConfig&&s.json.styleConfig.extendFile){var o="../x_component_process_FormDesigner/Module/Form/skin/"+this.json.styleConfig.extendFile;MWF.getJSON(o,function(e){e&&e.form&&(s.json=Object.merge(s.json,e.form)),t&&t()}.bind(this),!1)}return s.json.$version="5.2",this._recoveryModuleData(),s},_clearNoDomModule:function(){var t={};Object.each(this.moduleList,(function(e){t[e.json.id]=!0})),Object.each(this.data.json.moduleList,function(e,i){t[e.id]||delete this.data.json.moduleList[i]}.bind(this))},preview:function(){MWF.xDesktop.requireApp("process.FormDesigner","Preview",function(){"Mobile"==this.options.mode?this.previewBox=new MWF.xApplication.process.FormDesigner.Preview(this,{size:{x:"400",y:580},mode:"mobile"}):this.previewBox=new MWF.xApplication.process.FormDesigner.Preview(this),this.previewBox.load()}.bind(this))},save:function(t){this.designer.saveForm()},explode:function(){this._getFormData(),MWF.require("MWF.widget.Base64",null,!1);MWF.widget.Base64.encode(JSON.encode(this.data));MWF.require("MWF.widget.Panel",function(){var t=new Element("div"),e=(this.designer.formNode.getSize(),this.designer.formNode.getPosition(this.designer.formNode.getOffsetParent()));new Element("textarea",{styles:{border:"1px solid #999",width:"770px","margin-left":"14px","margin-top":"14px",height:"580px"},text:JSON.encode(this.data)}).inject(t);this.explodePanel=new MWF.widget.Panel(t,{style:"form",isResize:!1,isMax:!1,title:"",width:800,height:660,top:e.y,left:e.x+3,isExpand:!1,target:this.designer.node}),this.explodePanel.load()}.bind(this))},implode:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("O2",this)}.bind(this))},implodeHTML:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("html",this,{type:"process"})}.bind(this))},implodeOffice:function(){MWF.xDesktop.requireApp("portal.PageDesigner","Import",function(){MWF.FormImport.create("office",this)}.bind(this))},showFormVersion:function(){this.versionNode=new Element("div"),this.dlg=o2.DL.open({title:MWF.APPFD.LP.version.title,content:this.versionNode,offset:{y:-100},isMax:!1,width:500,height:300,buttonList:[{type:"cancel",text:MWF.APPFD.LP.version.close,action:function(){this.close()}}],onPostShow:function(){this.loadVersionList()}.bind(this),onPostClose:function(){this.dlg=null}.bind(this)})},loadVersionList:function(){var t="<table width='100%' cellspacing='0' cellpadding='3' style='margin-top: 1px'><tr><th>"+MWF.APPFD.LP.version.no+"</th><th>"+MWF.APPFD.LP.version.updateTime+"</th><th>"+MWF.APPFD.LP.version.op+"</th></tr></table>";this.versionNode.set("html",t),this.versionTable=this.versionNode.getElement("table"),this.action=o2.Actions.load("x_processplatform_assemble_designer"),this.action.FormVersionAction.listWithForm(this.form.json.id,function(t){this.versionList=t.data,this.versionList.each(function(t,e){var i=new Element("tr").inject(this.versionTable),s="<td>"+(e+1)+"</td><td>"+t.updateTime+"</td><td></td>";i.set("html",s);var o=new Element("div",{styles:{width:"60px",padding:"0px 3px","border-radius":"20px",cursor:"pointer",color:"#ffffff","background-color":"#4A90E2",float:"left","margin-right":"2px","text-align":"center","font-weight":"100"}}).inject(i.getLast("td"));o.set("text",MWF.APPFD.LP.version.resume),o.addEvent("click",function(e){var i=this;this.designer.confirm("warn",e,MWF.APPFD.LP.version.resumeConfirm,MWF.APPFD.LP.version.resumeInfo,460,120,(function(){i.resumeForm(t),this.close()}),(function(){this.close()}))}.bind(this))}.bind(this))}.bind(this))},resumeForm:function(t){this.action.FormVersionAction.get(t.id,function(t){var e=JSON.parse(t.data.data);this.designer.notice(MWF.APPFD.LP.version.resumeSuccess),this.reload(JSON.decode(MWF.decodeJsonString(e.data))),this.dlg.close()}.bind(this),null,!1)},deletePropertiesOrStyles:function(t,e){if("styles"==t)try{e&&this.json.styles[e]&&delete this.json.styles[e],this.setCustomStyles()}catch(t){}if("properties"==t)try{this.node.removeProperty(e)}catch(t){}},setPropertiesOrStyles:function(t){"styles"==t&&this.setCustomStyles(),"properties"==t&&this.node.setProperties(this.json.properties)},setCustomStyles:function(){var t=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles("Mobile"===this.options.mode?this.css.formMobileNode:this.css.formNode);var e=this.container.getStyle("height");e=e?e.toInt()-2:this.container.getSize().y-2,this.node.setStyle("min-height",e+"px"),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",t),Object.each(this.json.styles,function(t,e){e.test(/^border\w*/gi)||this.node.setStyle(e,t)}.bind(this))},_setEditStyle:function(t,e,i){if("name"==t){var s=this.json.name||this.json.id;this.treeNode.setText("<"+this.json.type+"> "+s+" ["+this.options.mode+"] ")}if("id"==t&&(this.json.name||this.treeNode.setText("<"+this.json.type+"> "+this.json.id+" ["+this.options.mode+"] "),this.treeNode.setTitle(this.json.id),this.node.set("id",this.json.id)),"formStyleType"==t){var o=function(){var t,e;"object"===typeOf(i)&&"script"===i.type?this.loadCustomTemplateStyles(i,function(t){this.switchTemplateStyles(t)}.bind(this)):("object"===typeOf(i)&&i.id,i&&this.stylesList[i]&&(t=this.stylesList[i].file,e=this.stylesList[i].extendFile),this.loadTemplateStyles(t,e,function(t){this.switchTemplateStyles(t)}.bind(this)))}.bind(this),n=this.json.formStyleType;if("object"===typeOf(n)&&"script"===n.type)this.loadCustomTemplateStyles(n,function(t){this.templateStyles=t,o(),this.json.styleConfig=n}.bind(this));else{"object"===typeOf(n)&&(n=n.id);var l=this.stylesList&&n?this.stylesList[n].file:null,r=this.stylesList&&n?this.stylesList[n].extendFile:null;this.loadTemplateStyles(l,r,function(t){this.templateStyles=t,o(),this.json.styleConfig=this.stylesList&&n?this.stylesList[n]:null}.bind(this))}}"css"===t&&this.reloadCss(),this._setEditStyle_custom(t,e,i)},switchTemplateStyles:function(t){t.form&&this.clearTemplateStyles(t.form),this.templateStyles.form&&this.setTemplateStyles(this.templateStyles.form),this.setAllStyles(),this.moduleList.each(function(e){t[e.moduleName]&&e.clearTemplateStyles(t[e.moduleName]),e.setStyleTemplate(),e.setAllStyles()}.bind(this))},parseCSS:function(t){for(var e,i=/(url\(.*\))/g;null!==(e=i.exec(t));){var s=e[0],o=s.length,n=s.substring(s.length-2,s.length-1),l="'"===n||'"'===n?5:4,r="'"===n||'"'===n?2:1;if(-1!=(s=s.substring(l,s.length-r)).indexOf("x_processplatform_assemble_surface")||-1!=s.indexOf("x_portal_assemble_surface")){MWF.Actions.getHost("x_processplatform_assemble_surface");var d=MWF.Actions.getHost("x_portal_assemble_surface");-1!==s.indexOf("/x_processplatform_assemble_surface")?s=s.replace("/x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface"):-1!==s.indexOf("x_processplatform_assemble_surface")&&(s=s.replace("x_processplatform_assemble_surface",s+"/x_processplatform_assemble_surface")),-1!==s.indexOf("/x_portal_assemble_surface")?s=s.replace("/x_portal_assemble_surface",d+"/x_portal_assemble_surface"):-1!==s.indexOf("x_portal_assemble_surface")&&(s=s.replace("x_portal_assemble_surface",d+"/x_portal_assemble_surface")),s=o2.filterUrl(s)}var c=(s="url('"+s+"')").length;t=t.substring(0,e.index)+s+t.substring(i.lastIndex,t.length),i.lastIndex=i.lastIndex+(c-o)}return t},reloadCss:function(){var t=this.json.css?this.json.css.code:"";if((r=$("style"+this.json.id))&&r.destroy(),t){t=this.parseCSS(t);for(var e,i=new RegExp("(.+)(?=\\{)","g"),s=".css"+this.json.id.replace(/\-/g,"")+" ";null!==(e=i.exec(t));){var o=e[0];if(-1!=o.indexOf(",")){var n=o.split(/\s*,\s*/g),l=(n=n.map((function(t){return s+t}))).join(", ");t=t.substring(0,e.index)+l+t.substring(i.lastIndex,t.length),i.lastIndex=i.lastIndex+s.length*n.length}else{l=s+e[0];t=t.substring(0,e.index)+l+t.substring(i.lastIndex,t.length),i.lastIndex=i.lastIndex+s.length}}var r;if((r=document.createElement("style")).setAttribute("type","text/css"),r.id="style"+this.json.id,r.inject(this.container,"before"),r.styleSheet){var d=function(){r.styleSheet.cssText=t};r.styleSheet.disabled?setTimeout(d,10):d()}else{var c=document.createTextNode(t);r.appendChild(c)}}},setAllStyles:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("properties"),this.reloadMaplist()},reloadMaplist:function(){this.property&&Object.each(this.property.maplists,function(t,e){t.reload(this.json[e])}.bind(this))},_setEditStyle_custom:function(){},saveAsTemplete:function(){},isModuleExited:function(t){for(var e=0;e<this.moduleList.length;e++)if(this.moduleList[e].json.id===t)return!0;return!1},checkModuleId:function(t,e,i){var s=!1,o=!1;if(this.isModuleExited(t))return o=!0,-1==this.options.fields.indexOf(e)&&-1==this.options.fields.indexOf(this.json.moduleList[t].type)||(s=!0),{fieldConflict:s,elementConflict:o};var n=this.getAllSubformJsonObject();return n&&Object.each(n,function(n){i&&i==n.id||n.moduleList[t]&&(o=!0,-1==this.options.fields.indexOf(e)&&-1==this.options.fields.indexOf(n.moduleList[t].type)||(s=!0))}.bind(this)),{fieldConflict:s,elementConflict:o}},_resetTreeNode:function(){},clearSubformList:function(t){this.level1Subformlist&&this.level1Subformlist[t]&&delete this.level1Subformlist[t]},addSubformList:function(t,e){this.level1Subformlist||(this.level1Subformlist={}),this.level1Subformlist[t]||(this.level1Subformlist[t]=[]),this.level1Subformlist[t].push(e)},isSubformUnique:function(t,e,i){if(!this.level1Subformlist)return!0;var s=Object.clone(this.level1Subformlist);for(var o in i&&s[i]&&delete s[i],s)if(o!==e&&s[o].contains(t))return!1;return!0},getAllSubformTiled:function(){var t=function(e,i){e.subformModuleList&&e.subformModuleList.length&&Array.each(e.subformModuleList,function(e){i.push(e),e.subformModule&&t(e.subformModule,i)}.bind(this))},e=[];return t(this,e),e},getAllSubformJsonObject:function(){var t=this.getAllSubformTiled(),e={};return Array.each(t,function(t){t&&t.json.subformSelected&&t.subformData&&t.subformData.json&&(e[t.json.subformSelected]=t.subformData.json)}.bind(this)),e}});