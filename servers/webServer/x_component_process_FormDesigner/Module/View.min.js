MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.xDesktop.requireApp("process.FormDesigner","Module.$Element",null,!1),MWF.xApplication.process.FormDesigner.Module.View=MWF.FCView=new Class({Extends:MWF.FC$Element,Implements:[Options,Events],options:{style:"default",propertyPath:"../x_component_process_FormDesigner/Module/View/view.html"},initialize:function(e,t){this.setOptions(t),this.path="../x_component_process_FormDesigner/Module/View/",this.cssPath="../x_component_process_FormDesigner/Module/View/"+this.options.style+"/css.wcss",this.imagePath_default="../x_component_query_ViewDesigner/$View/",this.imagePath_custom="../x_component_process_FormDesigner/Module/Actionbar/",this._loadCss(),this.moduleType="element",this.moduleName="view",this.form=e,this.container=null,this.containerNode=null},load:function(e,t,i){this.json=e,this.node=t,this.node.store("module",this),this.node.setStyles(this.css.moduleNode),this._loadNodeStyles(),this._initModule(),this._loadTreeNode(i),this.parentContainer=this.treeNode.parentNode.module,this._setEditStyle_custom("id"),this.json.moduleName=this.moduleName},_createMoveNode:function(){this.moveNode=new Element("div",{MWFType:"view",id:this.json.id,styles:this.css.moduleNodeMove,events:{selectstart:function(){return!1}}}).inject(this.form.container)},_initModule:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("properties"),this._checkView(function(){this._setTitleStyles()}.bind(this)),this._setNodeProperty(),this.form.isSubform||this._createIconAction(),this._setNodeEvent()},_createNode:function(){this.node=this.moveNode.clone(!0,!0),this.node.setStyles(this.css.moduleNode),this.node.set("id",this.json.id),this.node.addEvent("selectstart",(function(){return!1})),this.iconNode=new Element("div",{styles:this.css.iconNode}).inject(this.node),new Element("div",{styles:this.css.iconNodeIcon}).inject(this.iconNode),new Element("div",{styles:this.css.iconNodeText,text:"VIEW"}).inject(this.iconNode),this.iconNode.addEvent("click",function(){this._checkView()}.bind(this))},_loadNodeStyles:function(){this.iconNode=this.node.getElement("div").setStyles(this.css.iconNode),this.iconNode.getFirst("div").setStyles(this.css.iconNodeIcon),this.iconNode.getLast("div").setStyles(this.css.iconNodeText),this.viewNode=this.node.getChildren("div")[1],this.viewNode&&(this.node.setStyle("background","transparent"),this.actionbarNode=this.viewNode.getChildren("div")[0],this.actionbarNode&&(this.actionbarNode.destroy(),this.actionbarNode=null),this.viewTable=this.viewNode.getElement("table").setStyles(this.css.viewTitleTableNode),this.viewLine=this.viewTable.getElement("tr").setStyles(this.css.viewTitleLineNode),this.viewSelectCell=this.viewLine.getElement("td"),this.viewSelectCell&&this.viewSelectCell.setStyles(this.css.viewTitleCellNode),this._setViewNodeTitle())},_createViewNode:function(e){this.viewNode||(this.viewNode=new Element("div",{styles:this.css.viewNode}).inject(this.node)),this.actionbarNode||(this.actionbarNode=new Element("div.actionbarNode",{}).inject(this.viewNode,"top")),this.node.setStyle("background","transparent"),this.viewTable=new Element("table",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewNode),this.viewLine=new Element("tr",{styles:this.css.viewTitleLineNode}).inject(this.viewTable),"no"!=this.json.select&&(this.viewSelectCell=new Element("td",{styles:this.css.viewTitleCellNode}).inject(this.viewLine),this.viewSelectCell.setStyle("width","10px")),MWF.Actions.get("x_query_assemble_designer").getView(this.json.queryView.id,function(t){var i=JSON.decode(t.data.data);this.viewData=i,"show"===this.json.actionbar&&(this.actionbarList=[],this._showActionbar()),(i.selectEntryList||i.selectList).each(function(e){if(!e.hideColumn)new Element("td",{styles:this.css.viewTitleCellNode,text:e.displayName}).inject(this.viewLine)}.bind(this)),e&&e()}.bind(this)),this._setViewNodeTitle()},_setViewNodeTitle:function(){this.viewTable&&("no"==this.json.isTitle?this.viewTable.setStyle("opacity",.5):this.viewTable.setStyle("opacity",1))},_setEditStyle:function(e,t,i){if("view"!=e&&"processView"!=e&&"CMSView"!=e&&"queryView"!=e||this.json[e]!=i&&this._checkView(),"select"==e&&this._checkSelect(),"isTitle"==e&&this._checkTitle(),"titleStyles"==e&&this._setTitleStyles(),"name"==e){var s=this.json.name||this.json.id,o=this.json.type.substr(this.json.type.lastIndexOf("$")+1,this.json.type.length);this.treeNode.setText("<"+o+"> "+s)}if("id"==e){if(!this.json.name){o=this.json.type.substr(this.json.type.lastIndexOf("$")+1,this.json.type.length);this.treeNode.setText("<"+o+"> "+this.json.id)}this.treeNode.setTitle(this.json.id),this.node.set("id",this.json.id)}"actionbar"==e&&("show"===this.json.actionbar?this._showActionbar():this._hideActionbar()),this._setEditStyle_custom(e,t,i)},_setTitleStyles:function(){this.viewLine&&(this.viewLine.getElements("td").each(function(e){e.clearStyles(),e.setStyles(this.css.viewTitleCellNode),this.json.titleStyles&&e.setStyles(this.json.titleStyles)}.bind(this)),this.viewSelectCell&&this.viewSelectCell.setStyle("width","10px"),this._checkSelect(),this._checkTitle())},_checkView:function(e){this.json.queryView&&"none"!=this.json.queryView?(this.iconNode.setStyle("display","none"),this.viewNode&&this.viewNode.destroy(),this.viewNode=null,this._createViewNode(function(){e&&e()}.bind(this))):(this.iconNode.setStyle("display","block"),this.viewNode&&this.viewNode.destroy(),this.node.setStyles(this.css.moduleNode),e&&e())},_checkSelect:function(){"no"!=this.json.select?(this.viewSelectCell||(this.viewSelectCell=new Element("td",{styles:this.css.viewTitleCellNode}).inject(this.viewLine,"top"),this.viewSelectCell.setStyle("width","10px")),"single"==this.json.select?this.viewSelectCell.setStyle("background","url(../x_component_process_FormDesigner/Module/View/default/icon/single.png) center center no-repeat"):this.viewSelectCell.setStyle("background","url(../x_component_process_FormDesigner/Module/View/default/icon/multi.png) center center no-repeat")):this.viewSelectCell&&(this.viewSelectCell.destroy(),this.viewSelectCell=null)},_checkTitle:function(){this.json.isTitle||(this.json.isTitle="yes"),this.viewNode&&this._setViewNodeTitle()},_hideActionbar:function(){this.actionbarNode&&this.actionbarNode.hide()},_showActionbar:function(){this.actionbarLoading||this.actionbarNode&&(this.actionbarLoading=!0,MWF.require("MWF.widget.Toolbar",null,!1),this.actionbarNode.show(),this.viewData.actionbarList||(this.viewData.actionbarList=[]),this.actionbarList&&0!=this.actionbarList.length?this.actionbarLoading=!1:(this.actionbarNode.empty(),this.viewData.actionbarList.length?(this.actionbarList||(this.actionbarList=[]),this.viewData.actionbarList.each(function(e){var t=new MWF.widget.Toolbar(this.actionbarNode,{style:e.style},this);e.actionStyles&&(t.css=e.actionStyles),e.hideSystemTools||this.setToolbars(e.defaultTools,this.actionbarNode,e),this.setCustomToolbars(e.tools,this.actionbarNode,e),t.load(),this.actionbarList.push(t),this.actionbarLoading=!1}.bind(this))):this.actionbarLoading=!1))},setToolbars:function(e,t,i){e.each(function(e){var s=new Element("div",{MWFnodetype:e.type,MWFButtonImage:this.imagePath_default+"default/actionbar/"+e.img,title:e.title,MWFButtonAction:e.action,MWFButtonText:e.text}).inject(t);this.json.iconOverStyle&&s.set("MWFButtonImageOver",this.imagePath_default+"default/actionbar/"+i.iconOverStyle+"/"+e.img)}.bind(this))},setCustomToolbars:function(e,t,i){var s="";i.customIconStyle&&(s=i.customIconStyle+"/");e.each(function(e){var o=new Element("div",{MWFnodetype:e.type,MWFButtonImage:this.imagePath_custom+"default/custom/"+s+e.img,title:e.title,MWFButtonAction:e.action,MWFButtonText:e.text}).inject(t);this.json.customIconOverStyle&&o.set("MWFButtonImageOver",this.imagePath_custom+"default/custom/"+i.customIconOverStyle+"/"+e.img)}.bind(this))}});