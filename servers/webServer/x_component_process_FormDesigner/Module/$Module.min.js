MWF.xApplication.process.FormDesigner.Module=MWF.xApplication.process.FormDesigner.Module||{},MWF.require("MWF.widget.Common",null,!1),MWF.xDesktop.requireApp("process.FormDesigner","Property",null,!1),MWF.xApplication.process.FormDesigner.Module.$Module=MWF.FC$Module=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",actions:[{name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPFD.LP.formAction.move},{name:"copy",icon:"copy1.png",event:"mousedown",action:"copy",title:MWF.APPFD.LP.formAction.copy},{name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPFD.LP.formAction.delete}],actionNodeStyles:{width:"16px",height:"16px","margin-left":"2px","margin-right":"2px",float:"left",border:"1px solid #F1F1F1",cursor:"pointer"},injectActions:[{name:"before",styles:"injectActionBefore",event:"click",action:"injectBefore",title:MWF.APPFD.LP.formAction.insertBefore},{name:"after",styles:"injectActionAfter",event:"click",action:"injectAfter",title:MWF.APPFD.LP.formAction.insertAfter}],propertyPath:"../x_component_process_FormDesigner/Module/Label/label.html"},_getNewId:function(e,t){var o="";e&&(o=e+"_"),t||(t=this.moduleName);for(var s=1,i=o+t,n=this.json?this.json.type:this.moduleName.capitalize();this.form.checkModuleId(i,n).elementConflict;)i=o+t+"_"+s,s++;return i},load:function(e,t,o){this.json=e,this.node=t,this.node.store("module",this),this.node.setStyles(this.css.moduleNode),this._loadNodeStyles(),this._loadTreeNode(o),this.parentContainer=this.treeNode.parentNode.module,this._initModule(),this._setEditStyle_custom("id"),this.json.moduleName=this.moduleName},_loadNodeStyles:function(){},_loadNodeCustomStyles:function(){this.setCustomStyles()},_loadTreeNode:function(e){var t=this.json.name||this.json.id,o="";o="Common"===this.json.type?this.json.tagName+"(Common)":this.json.type.substr(this.json.type.lastIndexOf("$")+1,this.json.type.length);var s={expand:!0,title:this.json.id,text:"&lt;"+o+"&gt; "+t,icon:"",action:function(){this.module&&this.module.selected()}};this.nextModule?this.treeNode=this.nextModule.treeNode.insertChild(s):this.treeNode=e.treeNode.appendChild(s),this.treeNode.module=this},copyStyles:function(e,t){this.json[t]||(this.json[t]={}),Object.each(e,function(e,o){this.json[t][o]=e}.bind(this))},removeStyles:function(e,t){this.json[t]&&Object.each(e,function(e,o){this.json[t][o]&&this.json[t][o]==e&&delete this.json[t][o]}.bind(this))},setTemplateStyles:function(e){e.styles&&this.copyStyles(e.styles,"styles"),e.properties&&this.copyStyles(e.properties,"properties")},clearTemplateStyles:function(e){e&&(e.styles&&this.removeStyles(e.styles,"styles"),e.properties&&this.removeStyles(e.properties,"properties"))},setStyleTemplate:function(){this.form.templateStyles&&this.form.templateStyles[this.moduleName]&&this.setTemplateStyles(this.form.templateStyles[this.moduleName])},setAllStyles:function(){this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("inputStyles"),this.setPropertiesOrStyles("properties"),this.reloadMaplist()},_initModule:function(){this.json.isSaved||this.setStyleTemplate(),this._resetModuleDomNode(),this.setPropertiesOrStyles("styles"),this.setPropertiesOrStyles("inputStyles"),this.setPropertiesOrStyles("properties"),this._setNodeProperty(),this.form.isSubform||this._createIconAction(),this._setNodeEvent(),this.json.isSaved=!0},_resetModuleDomNode:function(){},_setNodeProperty:function(){},_createIconAction:function(){this.actionArea||(this.actionArea=new Element("div",{styles:{display:"none",position:"absolute","background-color":"#F1F1F1",padding:"1px","padding-right":"0px",border:"1px solid #AAA","box-shadow":"0px 2px 5px #999",opacity:1,"z-index":100}}).inject(this.form.container,"after"),this.options.actions.each(function(e){var t=new Element("div",{styles:this.options.actionNodeStyles,title:e.title}).inject(this.actionArea);t.setStyle("background","url("+this.path+this.options.style+"/icon/"+e.icon+") no-repeat left center"),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),t.addEvents({mouseover:function(e){e.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(e){e.target.setStyle("border","1px solid #F1F1F1")}.bind(this)})}.bind(this)),this._createCustomIconAction())},_createCustomIconAction:function(){},_setActionAreaPosition:function(){var e=this.node.getPosition(this.form.node.getOffsetParent()),t=e.y-25,o=e.x;this.actionArea.setPosition({x:o,y:t})},_moveTo:function(e){this.parentContainer=e,this.node||this._createNode(),this._resetTreeNode(),this.node.inject(e.node)},move:function(e){this._createMoveNode();var t=this.node.getStyle("display");this.node.store("thisDisplay",t),this.node.setStyle("display","none"),this._setNodeMove(e)},copy:function(e){this.copyTo().move(e)},copyTo:function(e){e||(e=this.form);var t=this.node.clone(!0,!0),o=Object.clone(this.json);t.inject(e.node);var s=this.moduleName.capitalize(),i="page"==this.form.moduleType?"PC":"FC",n=new MWF[i+s](this.form);return n.json=o,o.id=n._getNewId(),t.set("id",o.id),this.form.json.moduleList[o.id]=o,this.form.scriptDesigner&&this.form.scriptDesigner.createModuleScript(o),n.load(o,t,e),n},delete:function(e){var t=this;this.form.designer.shortcut=!1,this.form.designer.confirm("warn",t.node,MWF.APPFD.LP.notice.deleteElementTitle,MWF.APPFD.LP.notice.deleteElement,300,120,(function(){t.form.selected(),t.form.designer.shortcut=!0,t.destroy(),this.close()}),(function(){t.form.designer.shortcut=!0,this.close()}),null)},styleBrush:function(){this.form.styleBrushContent=Object.clone(this.json.styles),this.json.inputStyles&&(this.form.inputStyleBrushContent=Object.clone(this.json.inputStyles))},_setNodeEvent:function(){"subform"!=this.form.moduleType&&"subpage"!=this.form.moduleType&&(this.isSetEvents||(this.node.addEvent("click",function(e){this.form.noSelected||this.selected(),this.form.noSelected=!1,e.stopPropagation()}.bind(this)),this.node.addEvent("mouseover",function(e){this.over(),e.stopPropagation()}.bind(this)),this.node.addEvent("mouseout",function(e){this.unOver(),e.stopPropagation()}.bind(this)),this.node.addEvent("copy",(function(e){this.copyModule(e)})),this._setOtherNodeEvent(),this.isSetEvents=!0))},copyModule:function(e){},_setOtherNodeEvent:function(){},over:function(){this.form.moveModule||this.form.currentSelectedModule!=this&&(this.node.store("normalBorder",this.node.getBorder()),this.node.setStyles({"border-width":"1px","border-color":"#4e73ff"}))},unOver:function(){if(!this.form.moveModule&&this.form.currentSelectedModule!=this){this.node.setStyles({"border-width":"1px","border-color":"#333"});var e=this.node.retrieve("normalBorder");this.node.setStyles(e)}},_showActions:function(){this.actionArea&&this.options.actions.length&&(this._setActionAreaPosition(),this.actionArea.setStyle("display","block"))},_hideActions:function(){this.actionArea&&this.actionArea.setStyle("display","none")},selected:function(){if(this.form&&this.form.node&&this.form.node.focus(),this.form.currentSelectedModule){if(this.form.currentSelectedModule==this)return!0;this.form.currentSelectedModule.unSelected()}this.form.propertyMultiTd&&(this.form.propertyMultiTd.hide(),this.form.propertyMultiTd=null),this.form.unSelectedMulti(),this.node.setStyles({"border-width":"1px","border-color":"red"}),this._showActions(),this.form.currentSelectedModule=this,this.treeNode&&(this.treeNode.selectNode(),new Fx.Scroll(this.form.designer.propertyDomScrollArea).toElement(this.treeNode.node)),this.form.brushStyle&&(this.json.styles=Object.clone(this.form.brushStyle),this.setPropertiesOrStyles("styles"),this.property&&this.property.loadMaplist()),this.form.brushInputStyle&&(this.json.inputStyles=Object.clone(this.form.brushInputStyle),this.setPropertiesOrStyles("inputStyles"),this.property&&this.property.loadMaplist()),this.showProperty()},unSelected:function(){this.node.setStyles({"border-width":"1px","border-color":"#333"});var e=this.node.retrieve("normalBorder");this.node.setStyles(e),this._hideActions(),this.form.currentSelectedModule=null,this.hideProperty()},selectedMulti:function(){-1==this.form.selectedModules.indexOf(this)&&(this.form.selectedModules.push(this),this.node.setStyle("border-color","red"))},unSelectedMulti:function(){-1!=this.form.selectedModules.indexOf(this)&&(this.form.selectedModules.erase(this),this.node.setStyle("border-color","#333"))},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.process.FormDesigner.Property(this,this.form.designer.propertyContentArea,this.form.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},hideProperty:function(){this.property&&this.property.hide()},create:function(e,t){this.json=e,this.json.id=this._getNewId(),this._createMoveNode(),this._setNodeMove(t)},createImmediately:function(e,t,o,s){this.json=e,this.json.id=this._getNewId(),this._createMoveNode(),this._dragComplete(t,o,s)},_createMoveNode:function(){this.moveNode=new Element("div",{MWFType:"label",styles:this.css.moduleNodeMove,text:"Text",events:{selectstart:function(){return!1}}}).inject(this.form.container)},_onEnterOther:function(e,t){},_onLeaveOther:function(e,t){},_onMoveEnter:function(e,t){var o=t.retrieve("module");o&&o._dragIn(this),this._onEnterOther(e,t)},_getDroppableNodes:function(){return[this.form.node].concat(this.form.moduleElementNodeList,this.form.moduleContainerNodeList,this.form.moduleComponentNodeList)},_setNodeMove:function(e){this._setMoveNodePosition(e),this.form.node.focus();var t=this._getDroppableNodes(),o=new Drag.Move(this.moveNode,{droppables:t,onEnter:function(e,t){this._onMoveEnter(e,t)}.bind(this),onLeave:function(e,t){var o=t.retrieve("module");o&&o._dragOut(this),this._onLeaveOther(e,t)}.bind(this),onDrag:function(e){this._nodeDrag(e,o)}.bind(this),onDrop:function(e,t){if(t){var o=t.retrieve("module");o&&o._dragDrop(this),this._nodeDrop(o)}else this._dragCancel(e)}.bind(this),onCancel:function(e){this._dragCancel(e)}.bind(this)});o.start(e),this.form.moveModule=this,this.form.recordCurrentSelectedModule=this.form.currentSelectedModule,this.form.selected()},_setMoveNodePosition:function(e){var t=e.page.x+2,o=e.page.y+2;this.moveNode.positionTo(t,o)},_getCopyNode:function(e){if(this.copyNode||this._createCopyNode(),this.copyNode.setStyles(this.css.moduleNodeShow),this.copyNode.empty(),e)try{var t=e.node.getStyle("display").toString().toLowerCase();if(this.copyNode.setStyle("display",t),"inline"===t||"inline-block"===t){var o=e.node.getSize().y-2;this.copyNode.setStyle("height",o+"px")}}catch(e){}return this.copyNode},_createCopyNode:function(){this.copyNode=this.moveNode.clone(),this.copyNode.setStyles(this.css.moduleNodeShow),this.copyNode.addEvent("selectstart",(function(){return!1}))},_showInjectAction:function(e){e.moveNode&&e.moveNode.setStyle("display","none"),this.draggingModule=e,this.injectActionArea||this._createInjectAction(),this.injectActionArea.setStyle("display","block"),this._setInjectActionAreaPosition(),this.injectActionEffect=new Fx.Morph(this.injectActionArea,{duration:200,transition:Fx.Transitions.Sine.easeOut}),this.injectActionEffect.start(this.form.css.injectActionArea_to)},_hideInjectAction:function(){this.draggingModule=null,this.injectActionArea&&this.injectActionArea.setStyle("display","none")},_createInjectAction:function(){var e=this.form.css;if(!this.injectActionArea){this.injectActionArea=new Element("div",{styles:e.injectActionArea}).inject(this.form.container,"after"),this.injectActionTopBGNode=new Element("div",{styles:e.injectActionTopBGNode}).inject(this.injectActionArea),this.injectActionLeftBGNode=new Element("div",{styles:e.injectActionLeftBGNode}).inject(this.injectActionArea),this.injectActionRightBGNode=new Element("div",{styles:e.injectActionRightBGNode}).inject(this.injectActionArea),this.injectActionBottomBGNode=new Element("div",{styles:e.injectActionBottomBGNode}).inject(this.injectActionArea);var t={};this.options.injectActions.each((function(e){t[e.name]=e})),t.before&&this._createInjectActionNode(t.before,this.injectActionTopBGNode),t.top&&this._createInjectActionNode(t.top,this.injectActionLeftBGNode),t.bottom&&this._createInjectActionNode(t.bottom,this.injectActionRightBGNode),t.after&&this._createInjectActionNode(t.after,this.injectActionBottomBGNode),new Element("div",{styles:e.injectActionCancelNode,events:{click:function(){this.draggingModule._dragCancel(),this._dragDrop(this.node,!0),this._hideInjectAction()}.bind(this),mouseover:function(){this.setStyles(e.injectActionCancelNode_over)},mouseout:function(){this.setStyles(e.injectActionCancelNode)}}}).inject(this.injectActionArea)}},_createInjectActionNode:function(e,t){var o=new Element("div",{styles:this.form.css[e.styles],title:e.title}).inject(this.injectActionArea);o.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),o.addEvents({mouseover:function(o){t.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,e.name)}.bind(this),mouseout:function(e){t.setStyle("background","transparent")}.bind(this)}),t.set("title",e.title),t.addEvent(e.event,function(t){this[e.action](t)}.bind(this)),t.setStyle("cursor","pointer"),t.addEvents({mouseover:function(o){t.setStyle("background","#ddd"),this.draggingModule.copyNode.setStyle("display",""),this.draggingModule.copyNode.inject(this.node,e.name)}.bind(this),mouseout:function(e){t.setStyle("background","transparent")}.bind(this)})},_setInjectActionAreaPosition:function(){var e=new Event(event),t=this.form.node.getOffsetParent().getPosition(),o=e.page.y-t.y,s=e.page.x-t.x;this.injectActionArea.setPosition({x:s,y:o}),o-=60,s-=60,this.form.css.injectActionArea_to.top=o+"px",this.form.css.injectActionArea_to.left=s+"px"},injectBefore:function(e){this.inject("before")},injectAfter:function(e){this.inject("after")},injectTop:function(e){this.inject("top")},injectBottom:function(e){this.inject("bottom")},inject:function(e){this.draggingModule.moveNode&&this.draggingModule.moveNode.setStyle("display",""),this.draggingModule._dragComplete(this.node,e),this._dragDrop(this.node,!0),this._hideInjectAction()},_nodeDrop:function(e){if(this.dragTimeout&&(window.clearTimeout(this.dragTimeout),this.dragTimeout=null),this.parentContainer){var t=!0;this.options.injectActions||(t=!1),e&&["datagrid$Data","datatable$Data"].contains(e.moduleName)&&(t=!1),e.parentContainer&&["datagrid$Data","datatable$Data"].contains(e.parentContainer.moduleName)&&(t=!1);var o=new Event(event);t&&o.control?(this.copyNode&&this.copyNode.setStyle("display","none"),e._showInjectAction(this)):this._dragComplete()}else this._dragCancel()},_dragComplete:function(e,t,o){this.setStyleTemplate(),this.injectNoticeNode&&this.injectNoticeNode.destroy();var s=this.moveNode.retrieve("overflow");s&&(this.moveNode.setStyle("overflow",s),this.moveNode.eliminate("overflow")),this.node||this._createNode(),this._resetTreeNode(),e&&t?this.node.inject(e,t):this.node.inject(this.copyNode,"before"),this._initModule();var i=this.node.retrieve("thisDisplay");i&&this.node.setStyle("display",i),this.copyNode&&this.copyNode.destroy(),this.moveNode&&this.moveNode.destroy(),this.moveNode=null,this.copyNode=null,this.nextModule=null,this.form.moveModule=null,this.form.json.moduleList[this.json.id]=this.json,this.form.scriptDesigner&&this.form.scriptDesigner.createModuleScript(this.json),o||this.selected()},_resetTreeNode:function(){if(this.parentContainer){if(this.treeNode){if(this.treeNode.parentNode)this.treeNode.parentNode.module;this.treeNode.destroy()}this._loadTreeNode(this.parentContainer),this.treeNode.parentNode&&(this.treeNode.parentNode.options.expand||this.treeNode.parentNode.expandOrCollapse()),this._resetSubTreeNode(this.node)}},_resetSubTreeNode:function(e){for(var t=e.getFirst();t;){var o=t.retrieve("module");o&&o._resetTreeNode(),this._resetSubTreeNode(t),t=t.getNext()}},_createNode:function(){this.node=this.moveNode.clone(!0,!0),this.node.clearStyles(!1),this.node.setStyles(this.css.moduleNode),this.node.set("id",this.json.id),this.node.addEvent("selectstart",(function(){return!1}))},_dragCancel:function(){if(this.dragTimeout&&(window.clearTimeout(this.dragTimeout),this.dragTimeout=null),this.node){var e=this.node.retrieve("thisDisplay");e&&this.node.setStyle("display",e),this.selected()}else this.data=null,this.form.recordCurrentSelectedModule&&this.form.recordCurrentSelectedModule.selected();this._hideInjectAction(),this.moveNode&&this.moveNode.destroy(),this.copyNode&&this.copyNode.destroy(),this.copyNode=null,this.moveNode=null,this.form.moveModule=null},_nodeDrag:function(e,t){if(this.dragTimeout||(this.dragTimeout=window.setTimeout(function(){var e=this.moveNode.getStyle("overflow");e&&"visible"!==e&&(this.moveNode.store("overflow",e),this.moveNode.setStyle("overflow","visible")),this.injectNoticeNode=new Element("div",{styles:this.form.css.injectNoticeNode,text:MWF.APPFD.LP.formAction.injectNotice}).inject(this.moveNode)}.bind(this),5e3)),this.inContainer){var o=this.inContainer.node.getCoordinates(),s=t.mouse.now,i=.4*o.height;o.height>200&&(i=100);var n=o.top.toFloat()+i.toFloat();this.inContainer==this.parentContainer?this.parentContainer!=this.form&&s.x>o.left&&s.x<o.right&&s.y<n&&s.y>o.top&&(this.parentContainer.node.setStyles(this.parentContainer.css.moduleNode),this.parentContainer.node.setStyles(this.parentContainer.json.styles),e.control?this.inContainer._dragIn(this):this.parentContainer._dragInLikeElement(this)):s.x>o.left&&s.x<o.right&&s.y<o.bottom&&s.y>n&&(this.parentContainer.node.setStyles(this.parentContainer.css.moduleNode),this.parentContainer.node.setStyles(this.parentContainer.json.styles),this.inContainer._dragIn(this))}},_setControlMode:function(e){this.controlMode!=e&&(this.controlMode=e,this._setControlModeNode())},deletePropertiesOrStyles:function(e,t){if("properties"==e)try{this.node.removeProperty(t)}catch(e){}},setPropertiesOrStyles:function(e){if("styles"==e)try{this.setCustomStyles()}catch(e){}if("properties"==e)try{this.node.setProperties(this.json.properties)}catch(e){}},setCustomNodeStyles:function(e,t){var o=e.getStyle("border");e.clearStyles(),e.setStyle("border",o),Object.each(t,function(t,o){o.test(/^border\w*/gi)||e.setStyle(o,t)}.bind(this))},_preprocessingModuleData:function(){this.node.clearStyles(),this.json.recoveryStyles=Object.clone(this.json.styles),this.json.recoveryStyles&&Object.each(this.json.recoveryStyles,function(e,t){-1!=e.indexOf("x_processplatform_assemble_surface")||-1!=e.indexOf("x_portal_assemble_surface")||(this.node.setStyle(t,e),delete this.json.styles[t])}.bind(this)),this.json.preprocessing="y"},_recoveryModuleData:function(){this.json.recoveryStyles&&(this.json.styles=this.json.recoveryStyles),this.json.recoveryStyles=null},setCustomStyles:function(){this._recoveryModuleData();var e=this.node.getStyle("border");this.node.clearStyles(),this.node.setStyles(this.css.moduleNode),this.initialStyles&&this.node.setStyles(this.initialStyles),this.node.setStyle("border",e),this.json.styles&&Object.each(this.json.styles,function(e,t){if(-1!=e.indexOf("x_processplatform_assemble_surface")||-1!=e.indexOf("x_portal_assemble_surface")){var o=MWF.Actions.getHost("x_processplatform_assemble_surface"),s=MWF.Actions.getHost("x_portal_assemble_surface");-1!==e.indexOf("/x_processplatform_assemble_surface")?e=e.replace("/x_processplatform_assemble_surface",o+"/x_processplatform_assemble_surface"):-1!==e.indexOf("x_processplatform_assemble_surface")&&(e=e.replace("x_processplatform_assemble_surface",o+"/x_processplatform_assemble_surface")),-1!==e.indexOf("/x_portal_assemble_surface")?e=e.replace("/x_portal_assemble_surface",s+"/x_portal_assemble_surface"):-1!==e.indexOf("x_portal_assemble_surface")&&(e=e.replace("x_portal_assemble_surface",s+"/x_portal_assemble_surface")),e=o2.filterUrl(e)}t.test(/^border\w*/gi)||t&&("display"===t.toString().toLowerCase()?"none"===e.toString().toLowerCase()?this.node.setStyle("opacity",.3):(this.node.setStyle("opacity",1),this.node.setStyle(t,e)):this.node.setStyle(t,e))}.bind(this))},_setEditStyle:function(e,t,o){var s="",i="";"name"===e&&(s=this.json.name||this.json.id,i="Common"===this.json.type?i=this.json.tagName+"(Common)":this.json.type.substr(this.json.type.lastIndexOf("$")+1,this.json.type.length),this.treeNode.setText&&this.treeNode.setText("<"+i+"> "+s)),"id"===e&&(s=this.json.name||this.json.id,this.json.name||(i="Common"===this.json.type?i=this.json.tagName+"(Common)":this.json.type.substr(this.json.type.lastIndexOf("$")+1,this.json.type.length),this.treeNode.setText&&this.treeNode.setText("<"+i+"> "+this.json.id)),this.treeNode.setTitle&&this.treeNode.setTitle(this.json.id),this.node.set("id",this.json.id)),this._setEditStyle_custom(e,t,o)},reloadMaplist:function(){this.property&&Object.each(this.property.maplists,function(e,t){e.reload(this.json[t])}.bind(this))},_setEditStyle_custom:function(e,t,o){},getHtml:function(){var e=this.node.clone(!0,!0);e.clearStyles(!0),this.form._clearNoId(e);var t=e.outerHTML;return e.destroy(),t},_getSubModuleJson:function(e,t){for(var o=e.getFirst();o;){var s=o.retrieve("module");s&&(t[s.json.id]=Object.clone(s.json)),this._getSubModuleJson(o,t),o=o.getNext()}},getJson:function(){var e=Object.clone(this.json),t={};return t[e.id]=e,this._getSubModuleJson(this.node,t),t}});