MWF.xApplication.process.FormDesigner.widget=MWF.xApplication.process.FormDesigner.widget||{},MWF.require("MWF.widget.UUID",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.FormDesigner.widget.ScriptIncluder=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",maxObj:document.body},initialize:function(t,e,i){this.setOptions(i),this.node=$(t),this.designer=e,this.path="../x_component_process_FormDesigner/widget/$ScriptIncluder/",this.cssPath="../x_component_process_FormDesigner/widget/$ScriptIncluder/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.designer.lp.scriptIncluder,this.items=[]},load:function(t){this.editorNode=new Element("div",{styles:this.css.editorNode}).inject(this.node),this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node),this.listNode=new Element("div",{styles:this.css.listNode}).inject(this.node),this.loadEditorNode(),this.loadActionNode(),this.loadListNode(t)},loadEditorNode:function(){var t="<table width='100%' border='0' cellpadding='5' cellspacing='0' class='editTable'><tr><td style='width: 60px; '>"+this.lp.asyncLoad+"</td><td align='left'><input type='radio' name='"+(this.designer.appId||"")+"asyncLoadScript' value='true' checked/>"+this.lp.yes+"<input type='radio' name='"+(this.designer.appId||"")+"asyncLoadScript' value='false'/>"+this.lp.no+"</td></tr><tr><td>"+this.lp.selectScript+"</td><td><div class='scriptSelectorArea'></div></td></tr></table>";this.editorNode.set("html",t);this.editorNode.getElements("td").setStyles(this.css.editTableTdValue);this.asyncLoadScript=this.editorNode.getElements("[type='radio']"),this.scriptSelectorArea=this.editorNode.getElement(".scriptSelectorArea"),this.loadScriptSelector()},loadScriptSelector:function(t){MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t||(t=[]),this.scriptSelector=new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(this.scriptSelectorArea,this.designer,{type:"Script",count:0,names:t,onChange:function(t){var e=[];t.each((function(t){var i=t.data;e.push({type:"script",name:i.name,alias:i.alias,id:i.id,appName:i.appName||i.applicationName,appId:i.appId||i.application,appType:i.appType})})),this.currentSelectScripts=e}.bind(this)})}.bind(this))},loadActionNode:function(){this.actionAreaNode=new Element("div",{styles:this.css.actionAreaNode}).inject(this.actionNode),this.addAction=new Element("div",{styles:this.css.addAction,text:this.designer.lp.validation.add}).inject(this.actionAreaNode),this.modifyAction=new Element("div",{styles:this.css.modifyAction_disabled,text:this.designer.lp.validation.modify}).inject(this.actionAreaNode),this.addAction.addEvent("click",function(){this.add()}.bind(this)),this.modifyAction.addEvent("click",function(){this.modify()}.bind(this))},getCurrentData:function(){var t=!0;return this.asyncLoadScript.each((function(e){e.checked&&(t="true"===e.get("value"))})),{async:t,scriptList:this.currentSelectScripts||[]}},add:function(){this.hideErrorNode();var t=this.getCurrentData();if(0===t.scriptList.length)return this.showErrorNode(this.lp.selectScriptNotice),!1;for(var e=0;e<this.items.length;e++)for(var i=this.items[e].data.scriptList,s=0;s<i.length;s++)for(var n=0;n<t.scriptList.length;n++)if(i[s].id===t.scriptList[e].id)return this.showErrorNode(this.lp.repeatAddScriptNotice),!1;var r=new MWF.xApplication.process.FormDesigner.widget.ScriptIncluder.Item(t,this);this.items.push(r),r.selected(),this.empty(),this.fireEvent("change")},empty:function(){this.asyncLoadScript.each((function(t){"true"===t.get("value")&&t.set("checked",!0)})),this.scriptSelector&&this.scriptSelector.setData([]),this.currentSelectScripts=[]},showErrorNode:function(t){this.errorNode=new Element("div",{styles:this.css.errorNode}).inject(this.actionNode,"before"),this.errorTextNode=new Element("div",{styles:this.css.errorTextNode}).inject(this.errorNode),this.errorTextNode.set("text",t),this.errorNode.addEvent("click",function(){this.hideErrorNode()}.bind(this))},hideErrorNode:function(){this.errorNode&&this.errorNode.destroy()},modify:function(){if(this.currentItem){this.hideErrorNode();var t=this.getCurrentData();if(0===t.scriptList.length)return this.showErrorNode(this.lp.selectScriptNotice),!1;for(var e=0;e<this.items.length;e++)if(this.currentItem!==this.items[e])for(var i=this.items[e].data.scriptList,s=0;s<i.length;s++)for(var n=0;n<t.scriptList.length;n++)if(i[s].id===t.scriptList[e].id)return this.showErrorNode(this.lp.repeatAddScriptNotice),!1;this.currentItem.reload(t),this.currentItem.unSelected(),this.disabledModify(),this.empty(),this.fireEvent("change")}},loadListNode:function(t){t&&t.length&&t.each(function(t){var e=new MWF.xApplication.process.FormDesigner.widget.ScriptIncluder.Item(t,this);this.items.push(e)}.bind(this))},enabledModify:function(){this.modifyAction.setStyles(this.css.modifyAction)},disabledModify:function(){this.modifyAction.setStyles(this.css.modifyAction_disabled)},setData:function(t){this.asyncLoadScript.each((function(e){"true"===e.get("value")&&t.async?e.set("checked",!0):"false"!==e.get("value")||t.async||e.set("checked",!0)})),this.scriptSelector?this.scriptSelector.setData(t.scriptList):this.loadScriptSelector(t.scriptList),this.currentSelectScripts=t.scriptList},deleteItem:function(t){this.currentItem==t&&t.unSelected(),this.items.erase(t),t.node.destroy(),MWF.release(t),this.fireEvent("change")},getData:function(){var t=[];return this.items.each((function(e){t.push(e.data)})),t}}),MWF.xApplication.process.FormDesigner.widget.ScriptIncluder.Item=new Class({initialize:function(t,e){this.data=t,this.editor=e,this.container=this.editor.listNode,this.css=this.editor.css,this.lp=this.editor.designer.lp,this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.container),this.deleteNode=new Element("div",{styles:this.css.itemDeleteNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.itemContentNode}).inject(this.node),this.asyncNode=new Element("div",{styles:{}}).inject(this.contentNode),this.asyncNode.set({text:this.data.async?this.lp.scriptIncluder.asyncLoadScript:this.lp.scriptIncluder.syncLoadScript}),this.scriptNode=new Element("div",{styles:this.css.scriptNode}).inject(this.contentNode),this.data.scriptList.each(function(t){new MWF.widget.O2Script(t,this.scriptNode)}.bind(this)),this.contentNode.addEvent("click",function(){this.selected()}.bind(this)),this.deleteNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))},reload:function(t){this.data=t,this.asyncNode.set({text:this.data.async?this.lp.scriptIncluder.asyncLoadScript:this.lp.scriptIncluder.syncLoadScript}),this.scriptNode.empty(),this.data.scriptList.each(function(t){new MWF.widget.O2Script(t,this.scriptNode)}.bind(this))},selected:function(){this.editor.currentItem&&this.editor.currentItem.unSelected(),this.node.setStyles(this.css.itemNode_current),this.editor.currentItem=this,this.editor.setData(this.data),this.editor.enabledModify()},unSelected:function(){this.node.setStyles(this.css.itemNode),this.editor.currentItem=this,this.editor.disabledModify()},deleteItem:function(t){var e=this;this.editor.designer.confirm("warn",t,this.lp.scriptIncluder.delete_title,this.lp.scriptIncluder.delete_text,300,120,(function(){e.destroy(),this.close()}),(function(){this.close()}))},destroy:function(){this.editor.deleteItem(this)}});