MWF.xApplication.process.FormDesigner.widget=MWF.xApplication.process.FormDesigner.widget||{},MWF.require("MWF.widget.UUID",null,!1),MWF.require("MWF.widget.O2Identity",null,!1),MWF.xApplication.process.FormDesigner.widget.DictionaryIncluder=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",maxObj:document.body},initialize:function(t,i,e){this.setOptions(e),this.node=$(t),this.designer=i,this.path="../x_component_process_FormDesigner/widget/$DictionaryIncluder/",this.cssPath="../x_component_process_FormDesigner/widget/$DictionaryIncluder/"+this.options.style+"/css.wcss",this._loadCss(),this.lp=this.designer.lp.dictionaryIncluder,this.items=[]},load:function(t){this.editorNode=new Element("div",{styles:this.css.editorNode}).inject(this.node),this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.node),this.listNode=new Element("div",{styles:this.css.listNode}).inject(this.node),this.loadEditorNode(),this.loadActionNode(),this.loadListNode(t)},loadEditorNode:function(){var t="<table width='100%' border='0' cellpadding='5' cellspacing='0' class='editTable'><tr><td>"+this.lp.selectDictionary+"</td><td><div class='dictionarySelectorArea'></div></td></tr><tr><td>"+this.lp.path+"</td><td><input type='text' style='width:90%'/></td></tr></table>";this.editorNode.set("html",t);this.editorNode.getElements("td").setStyles(this.css.editTableTdValue);this.dictionarySelectorArea=this.editorNode.getElement(".dictionarySelectorArea"),this.pathField=this.editorNode.getElement("input[type='text']"),this.loadDictionarySelector()},loadDictionarySelector:function(t){MWF.xDesktop.requireApp("process.ProcessDesigner","widget.PersonSelector",function(){t||(t=[]),this.dictionarySelector=new MWF.xApplication.process.ProcessDesigner.widget.PersonSelector(this.dictionarySelectorArea,this.designer,{type:"Dictionary",count:1,names:t,onChange:function(t){var i;if(t.length){var e=t[0].data;i={type:"dictionary",name:e.name,alias:e.alias,id:e.id,appName:e.appName||e.applicationName,appId:e.appId||e.application,appAilas:e.appAilas||e.applicationAilas,appType:e.appType}}this.currentSelectDictionary=i}.bind(this)})}.bind(this))},loadActionNode:function(){this.actionAreaNode=new Element("div",{styles:this.css.actionAreaNode}).inject(this.actionNode),this.addAction=new Element("div",{styles:this.css.addAction,text:this.designer.lp.validation.add}).inject(this.actionAreaNode),this.modifyAction=new Element("div",{styles:this.css.modifyAction_disabled,text:this.designer.lp.validation.modify}).inject(this.actionAreaNode),this.addAction.addEvent("click",function(){this.add()}.bind(this)),this.modifyAction.addEvent("click",function(){this.modify()}.bind(this))},getCurrentData:function(){return{path:this.pathField.get("value"),dictionary:this.currentSelectDictionary||null}},add:function(){this.hideErrorNode();var t=this.getCurrentData();if(!t.dictionary)return this.showErrorNode(this.lp.selectDictionaryNotice),!1;for(var i=0;i<this.items.length;i++){var e=this.items[i].data;if(e.dictionary.id===t.dictionary.id){if(e.path===t.path)return this.showErrorNode(this.lp.repeatAddDictionaryNotice),!1;if(!e.path||"root"===e.path)return this.showErrorNode(this.lp.rootDictionaryExistNotice),!1;if(!t.path||"root"===t.path)return this.showErrorNode(this.lp.subDictionaryExistNotice),!1;if(0===e.path.indexOf(t.path+"."))return this.showErrorNode(this.lp.subDictionaryExistNotice),!1;if(0===t.path.indexOf(e.path+"."))return this.showErrorNode(this.lp.parentDictionaryExistNotice),!1}}var s=new MWF.xApplication.process.FormDesigner.widget.DictionaryIncluder.Item(t,this);this.items.push(s),s.selected(),this.empty(),this.fireEvent("change")},empty:function(){this.pathField.set("value",""),this.dictionarySelector&&this.dictionarySelector.setData([]),this.currentSelectDictionary=null},showErrorNode:function(t){this.errorNode=new Element("div",{styles:this.css.errorNode}).inject(this.actionNode,"before"),this.errorTextNode=new Element("div",{styles:this.css.errorTextNode}).inject(this.errorNode),this.errorTextNode.set("text",t),this.errorNode.addEvent("click",function(){this.hideErrorNode()}.bind(this))},hideErrorNode:function(){this.errorNode&&this.errorNode.destroy()},modify:function(){if(this.currentItem){this.hideErrorNode();var t=this.getCurrentData();if(!t.dictionary)return this.showErrorNode(this.lp.selectDictionaryNotice),!1;for(var i=0;i<this.items.length;i++)if(this.items[i]!==this.currentItem){var e=this.items[i].data;if(e.dictionary.id===t.dictionary.id){if(e.path===t.path)return this.showErrorNode(this.lp.repeatAddDictionaryNotice),!1;if(!e.path||"root"===e.path)return this.showErrorNode(this.lp.rootDictionaryExistNotice),!1;if(!t.path||"root"===t.path)return this.showErrorNode(this.lp.subDictionaryExistNotice),!1;if(0===e.path.indexOf(t.path+"."))return this.showErrorNode(this.lp.subDictionaryExistNotice),!1;if(0===t.path.indexOf(e.path+"."))return this.showErrorNode(this.lp.parentDictionaryExistNotice),!1}}this.currentItem.reload(t),this.currentItem.unSelected(),this.disabledModify(),this.empty(),this.fireEvent("change")}},loadListNode:function(t){t&&t.length&&t.each(function(t){var i=new MWF.xApplication.process.FormDesigner.widget.DictionaryIncluder.Item(t,this);this.items.push(i)}.bind(this))},enabledModify:function(){this.modifyAction.setStyles(this.css.modifyAction)},disabledModify:function(){this.modifyAction.setStyles(this.css.modifyAction_disabled)},setData:function(t){this.pathField.set("value",t.path||""),this.dictionarySelector?this.dictionarySelector.setData(t.dictionary?[t.dictionary]:[]):this.loadDictionarySelector(t.dictionary?[t.dictionary]:[]),this.currentSelectDictionary=t.dictionary},deleteItem:function(t){this.currentItem==t&&t.unSelected(),this.items.erase(t),t.node.destroy(),MWF.release(t),this.fireEvent("change")},getData:function(){var t=[];return this.items.each((function(i){t.push(i.data)})),t}}),MWF.xApplication.process.FormDesigner.widget.DictionaryIncluder.Item=new Class({initialize:function(t,i){this.data=t,this.editor=i,this.container=this.editor.listNode,this.css=this.editor.css,this.lp=this.editor.designer.lp,this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.container),this.deleteNode=new Element("div",{styles:this.css.itemDeleteNode}).inject(this.node),this.contentNode=new Element("div",{styles:this.css.itemContentNode}).inject(this.node),this.dictionaryNode=new Element("div",{styles:this.css.dictionaryNode}).inject(this.contentNode),new MWF.widget.O2Dictionary(this.data.dictionary,this.dictionaryNode),this.pathNode=new Element("div",{styles:{"padding-left":"5px","padding-top":"5px"}}).inject(this.contentNode),this.pathNode.set({text:this.lp.dictionaryIncluder.path+(this.data.path||"root")}),this.contentNode.addEvent("click",function(){this.selected()}.bind(this)),this.deleteNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))},reload:function(t){this.data=t,this.pathNode.set({text:this.lp.dictionaryIncluder.path+(this.data.path||"root")}),this.dictionaryNode.empty(),new MWF.widget.O2Dictionary(t.dictionary,this.dictionaryNode)},selected:function(){this.editor.currentItem&&this.editor.currentItem.unSelected(),this.node.setStyles(this.css.itemNode_current),this.editor.currentItem=this,this.editor.setData(this.data),this.editor.enabledModify()},unSelected:function(){this.node.setStyles(this.css.itemNode),this.editor.currentItem=null,this.editor.disabledModify()},deleteItem:function(t){var i=this;this.editor.designer.confirm("warn",t,this.lp.dictionaryIncluder.delete_title,this.lp.dictionaryIncluder.delete_text,300,120,(function(){i.destroy(),this.close()}),(function(){this.close()}))},destroy:function(){this.editor.deleteItem(this)}});