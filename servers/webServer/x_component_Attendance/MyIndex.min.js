MWF.xApplication.Attendance=MWF.xApplication.Attendance||{},MWF.require("MWF.xAction.org.express.RestActions",null,!1),MWF.xDesktop.requireApp("Attendance","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Attendance","Common",null,!1),MWF.xApplication.Attendance.MyIndex=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},statusColor:{normal:"#9acd32",levelAsked:"#4f94cd",late:"#fede03",noSign:"#ee807f",appealSuccess:"#2ac497",abNormalDuty:"#fedcbd"},initialize:function(t,e,i,s){this.setOptions(s),this.app=e,this.lp=e.lp,this.path="../x_component_Attendance/$MyIndex/",this.cssPath="../x_component_Attendance/$MyIndex/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.holidayData={},this.today=new Date,this.setDate(),this.todayDate=this.today.format(this.lp.dateFormatDay),this.todayHloidayName="",this.todayIsWorkDay=!1,this.userName=layout.desktop.session.user.distinguishedName},setDate:function(t){this.date=t||new Date,this.year=this.date.getFullYear().toString();var e=this.date.getMonth()+1;this.month=2==e.toString().length?e:"0"+e,this.getCycleDate()},destroy:function(){this.node.empty()},reload:function(){this.node.empty(),this.load()},load:function(){this.loadTitleNode(),this.loadContent()},loadTitleNode:function(){var t=this.date.format(this.app.lp.dateFormatMonth);this.titleNode=new Element("div.titleNode",{styles:this.css.titleNode}).inject(this.node),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:t}).inject(this.titleNode),this.titleTextNode.setStyles({"margin-left":"30px",cursor:"default"});var e=this.app.lp.cyclText.replace("{start}",this.cycleStartDateString).replace("{end}",this.cycleEndDateString);this.titleCycleTextNode=new Element("div",{styles:this.css.titleCycleTextNode,text:e}).inject(this.titleNode),this.titleScheduleIconNode=new Element("div",{styles:this.css.titleScheduleIconNode,title:this.lp.seeSchedule}).inject(this.titleNode),this.titleScheduleIconNode.addEvents({mouseover:function(){this.titleScheduleIconNode.setStyles(this.css.titleScheduleIconNode_over)}.bind(this),mouseout:function(){this.titleScheduleIconNode.setStyles(this.css.titleScheduleIconNode)}.bind(this),mousedown:function(){this.titleScheduleIconNode.setStyles(this.css.titleScheduleIconNode_down)}.bind(this),mouseup:function(){this.titleScheduleIconNode.setStyles(this.css.titleScheduleIconNode_over)}.bind(this),click:function(){this.showSchedule()}.bind(this)})},changeMonthPrev:function(){this.date.decrement("month",1),this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t),this.reloadContent()},changeMonthNext:function(){this.date.increment("month",1),this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t),this.reloadContent()},changeMonthSelect:function(){this.monthSelector||this.createMonthSelector(),this.monthSelector.show()},createMonthSelector:function(){this.monthSelector=new MWF.xApplication.Attendance.MonthSelector(this.date,this)},changeMonthTo:function(t){this.setDate(t);var e=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",e),this.reloadContent()},getCycleDate:function(){this.actions.getCyclePerson(this.year,this.month,function(t){t.data=t.data||[],this.cycleStartDateString=t.data.cycleStartDateString,this.cycleEndDateString=t.data.cycleEndDateString,this.cycleStartDate=new Date(this.cycleStartDateString),this.cycleEndDate=new Date(this.cycleEndDateString),this.isCrossMonth=this.cycleStartDate.getMonth()!=this.cycleEndDate.getMonth()}.bind(this),null,!1)},getScheduleData:function(t){var e={personList:this.app.getNameFlag(this.userName)};this.app.orgActions.listUnitSupNestedWithPerson(e,function(e){var i=e.data;i.sort((function(t,e){return e.level-t.level}));for(var s=!0,a=0;a<i.length;a++){var n=i[a];if(1==n.level?this.actions.listScheduleByTopUnit(n.distinguishedName,function(e){e.data&&(t&&t(e.data),s=!1)}.bind(this),null,!1):this.actions.listScheduleByUnit(n.distinguishedName,function(e){e.data&&e.data.length>0&&(t&&t(e.data),s=!1)}.bind(this),null,!1),!s)break}}.bind(this),null,!1)},showSchedule:function(){this.scheduleNode?(this.scheduleNode.setStyle("display","block"),this.scheduleNode.position({relativeTo:this.titleScheduleIconNode,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}})):this.getScheduleData(function(t){if(t&&0!=t.length){this.scheduleNode=new Element("div",{styles:this.css.scheduleNode}).inject(this.node),this.scheduleNode.position({relativeTo:this.titleScheduleIconNode,position:"bottomLeft",edge:"upperCenter",offset:{x:-60,y:0}}),this.scheduleNode.addEvent("mousedown",(function(t){t.stopPropagation()})),document.body.addEvent("mousedown",function(){this.scheduleNode.setStyle("display","none")}.bind(this));var e=t[0],i=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.filterTable,class:"filterTable"}).inject(this.scheduleNode),s=new Element("tr").inject(i);new Element("td",{text:this.lp.scheduleTable,styles:this.css.scheduleTdHead,colspan:"2"}).inject(s);s=new Element("tr").inject(i);new Element("td",{text:this.lp.schedule.workTime+"：",styles:this.css.scheduleTdTitle}).inject(s),new Element("td",{text:e.onDutyTime||"",styles:this.css.scheduleTdValue}).inject(s);s=new Element("tr").inject(i);new Element("td",{text:this.lp.schedule.offTime+"：",styles:this.css.scheduleTdTitle}).inject(s),new Element("td",{text:e.offDutyTime||"",styles:this.css.scheduleTdValue}).inject(s);s=new Element("tr").inject(i);new Element("td",{text:this.lp.schedule.lateTime+"：",styles:this.css.scheduleTdTitle}).inject(s),new Element("td",{text:e.lateStartTime||"",styles:this.css.scheduleTdValue}).inject(s);s=new Element("tr").inject(i);new Element("td",{text:this.lp.schedule.leaveEarlyTime+"：",styles:this.css.scheduleTdTitle}).inject(s),new Element("td",{text:e.leaveEarlyStartTime||"",styles:this.css.scheduleTdValue}).inject(s);s=new Element("tr").inject(i);new Element("td",{text:this.lp.schedule.absenteeismTime+"：",styles:this.css.scheduleTdTitle}).inject(s),new Element("td",{text:e.absenceStartTime||"",styles:this.css.scheduleTdValue}).inject(s)}else this.app.notice(this.lp.unfindSchedule,"error")}.bind(this))},reloadContent:function(){this.calendarArea.empty(),this.statusColorArea.empty(),this.pieChartArea.empty(),this.lineChartArea.empty(),this.loadData()},loadContent:function(){this.loadContentNode(),this.loadData(),this.setNodeScroll(),this.setContentSize()},reloadChart:function(){this.pieChartArea.empty(),this.lineChartArea.empty(),this.loadPieChart(),this.loadLineChart()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node),this.app.addEvent("resize",function(){this.setContentSize(),this.reloadChart()}.bind(this)),this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode),this.topContentArea=new Element("div.topContentArea",{styles:this.css.topContentArea}).inject(this.elementContentListNode),this.calendarArea=new Element("div.calendarArea",{styles:this.css.calendarArea}).inject(this.topContentArea),this.statusColorArea=new Element("div.statusColorArea",{styles:this.css.statusColorArea}).inject(this.topContentArea),this.pieChartArea=new Element("div.pieChartArea",{styles:this.css.pieChartArea}).inject(this.topContentArea),this.middleContentArea=new Element("div.middleContentArea",{styles:this.css.middleContentArea}).inject(this.elementContentListNode),this.lineChartArea=new Element("div.lineChartArea",{styles:this.css.lineChartArea}).inject(this.middleContentArea)},loadData:function(){this.listDetailFilterUser(function(t){this.detailData=t||{},this.anaylyseDetail(),this.loadStatusColorNode(),this.loadPieChart(),this.loadLineChart(),this.loadHolidayData(function(){this.loadCalendarContent()}.bind(this))}.bind(this),this.userName,this.year,this.month)},loadHolidayData:function(t){this.holidayData&&this.holidayData[this.year]?t&&t():this.listHolidayFilter(function(e){var i={workdays:[],holidays:[],names:[]};e.each((function(t){i.names.contains(t.configName)||i.names.push(t.configName),i[t.configName]||(i[t.configName]={},i[t.configName].holidays=[],i[t.configName].workdays=[]),"Holiday"==t.configType?(t.configDate==this.todayDate&&(this.todayHloidayName=t.configName),i.holidays.push(t.configDate),i[t.configName].holidays.push(t.configDate)):(t.configDate==this.todayDate&&(this.todayIsWorkDay=!0),i.workdays.push(t.configDate),i[t.configName].workdays.push(t.configDate))})),this.holidayData[this.year]=i,t&&t()}.bind(this),null,this.year)},loadCalendarContent:function(){this.canlendarToolbar=new Element("div.canlendarToolbar",{styles:this.css.canlendarToolbar}).inject(this.calendarArea),this.canlendarToolbarText=new Element("div",{styles:this.css.canlendarToolbarText,text:this.lp.index.attendanceCalendar}).inject(this.canlendarToolbar),this.calendarDate=this.date.clone(),this.isCrossMonth&&(this.calendarRightArrowNode=new Element("div",{styles:this.css.calendarRightArrowNode}).inject(this.canlendarToolbar),this.calendarCurrentMonthNode=new Element("div",{styles:this.css.calendarCurrentMonthNode,text:this.calendarDate.getMonth()+1+this.app.lp.month}).inject(this.canlendarToolbar),this.calendarLeftArrowNode=new Element("div",{styles:this.css.calendarLeftArrowNode}).inject(this.canlendarToolbar),this.calendarLeftArrowNode.addEvents({click:function(){this.changeCalendarMonthPrev()}.bind(this)}),this.calendarRightArrowNode.addEvents({click:function(){this.changeCalendarMonthNext()}.bind(this)}),this.switchCalendarArrow(this.calendarDate)),this.calendarNode=new Element("div.calendarNode",{styles:this.css.calendarNode}).inject(this.calendarArea),this.calendar=new MWF.xApplication.Attendance.Calendar(this.calendarNode,this,{holiday:this.holidayData[this.year],detail:this.detailData,eventData:this.eventData},{date:this.date,cycleStart:this.cycleStartDate,cycleEnd:this.cycleEndDate}),this.calendar.load()},switchCalendarArrow:function(t){new Date(t.getFullYear(),t.getMonth(),1,0,0,0)<=this.cycleStartDate?(this.calendarLeftArrowNode.setStyles(this.css.calendarLeftArrowNode_disable),this.calendarLeftDisable=!0):(this.calendarLeftArrowNode.setStyles(this.css.calendarLeftArrowNode),this.calendarLeftDisable=!1),new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59)>=this.cycleEndDate?(this.calendarRightArrowNode.setStyles(this.css.calendarRightArrowNode_disable),this.calendarRightDisable=!0):(this.calendarRightArrowNode.setStyles(this.css.calendarRightArrowNode),this.calendarRightDisable=!1)},changeCalendarMonthPrev:function(){this.calendarLeftDisable||(jQuery(this.calendarNode).fullCalendar("prev"),this.calendarDate.decrement("month",1),this.calendarCurrentMonthNode.set("text",this.calendarDate.getMonth()+1+this.app.lp.month),this.switchCalendarArrow(this.calendarDate))},changeCalendarMonthNext:function(){this.calendarRightDisable||(jQuery(this.calendarNode).fullCalendar("next"),this.calendarDate.increment("month",1),this.calendarCurrentMonthNode.set("text",this.calendarDate.getMonth()+1+this.app.lp.month),this.switchCalendarArrow(this.calendarDate))},listHolidayFilter:function(t,e,i,s){var a={};e&&(a.q_Name=e),i&&(a.q_Year=i),a.q_Month=s?2==s.toString().length?s:"0"+s:"(0)",this.actions.listHolidayFilter(a,function(e){t&&t(e.data)}.bind(this))},loadHolidayNode:function(){this.holidayAreaNode=new Element("div.holidayAreaNode",{styles:this.css.holidayAreaNode}).inject(this.canlendarToolbar),this.holidayActionNode=new Element("div",{styles:this.css.holidayActionNode}).inject(this.holidayAreaNode),this.holidayActionTextNode=new Element("div",{styles:this.css.holidayActionTextNode,text:this.lp.holiday.holidaySchedule}).inject(this.holidayActionNode),this.holidayActionIconNode=new Element("div",{styles:this.css.holidayActionIconNode}).inject(this.holidayActionNode),this.holidayActionNode.addEvents({mouseover:function(){this.holidayActionIconNode.setStyles(this.css.holidayActionIconNode_over)}.bind(this),mouseout:function(){this.holidayActionIconNode.setStyles(this.css.holidayActionIconNode)}.bind(this),click:function(t){this.switchHoliday(t.target),t.stopPropagation()}.bind(this)})},switchHoliday:function(t){var e=this,i=!1;if(this.holidayListNode&&(this.holidayListNode.retrieve("year")==this.year?i=!0:this.holidayListNode.destroy()),i){var s=t.getParent();this.holidayListNode.inject(s),"block"==this.holidayListNode.getStyle("display")?this.holidayListNode.setStyle("display","none"):this.holidayListNode.setStyle("display","block")}else{var a=this.holidayData[this.year],n=this.holidayListNode=new Element("div",{styles:this.css.holidayListNode});this.holidayListNode.store("year",this.year),this.app.content.addEvent("click",(function(){e.holidayListNode.setStyle("display","none")})),a.names.each(function(t){var i=new Element("div",{text:t,styles:this.css.holidayNode}).inject(n);i.store("holidays",a[t].holidays),i.store("workdays",a[t].workdays),i.addEvents({mouseover:function(){this.setStyles(e.css.holidayNode_over)},mouseout:function(){this.setStyles(e.css.holidayNode)},click:function(t){e.holidayListNode.setStyle("display","none");var i=this.retrieve("holidays"),s=this.retrieve("workdays");this.setStyles(e.css.holidayNode),e.changeMonthTo(new Date((i||s)[0])),t.stopPropagation()}})}.bind(this));s=t.getParent();this.holidayListNode.inject(s)}},loadStatusColorNode:function(){for(var t in this.statusColorTable=new Element("table",{styles:this.css.statusColorTable}).inject(this.statusColorArea),this.statusColor){var e=new Element("tr",{styles:this.css.statusColorTr}).inject(this.statusColorTable);new Element("td",{styles:this.css.statusColorTd}).inject(e).setStyle("background-color",this.statusColor[t]);e=new Element("tr",{styles:this.css.statusTextTr}).inject(this.statusColorTable),new Element("td",{styles:this.css.statusTextTd,text:this.lp[t]+":"+this.totalData[t]+" "+this.app.lp.day+(this.rateData[t]?"("+this.rateData[t]+")":"")}).inject(e)}},loadPieChart:function(){this.pieChartNode=new Element("div.pieChartNode",{styles:this.css.pieChartNode}).inject(this.pieChartArea),this.pieChart=new MWF.xApplication.Attendance.Echarts(this.pieChartNode,this,this.totalData,this.css),this.pieChart.load()},loadLineChart:function(){this.lineChartNode=new Element("div.lineChartNode",{styles:this.css.lineChartNode}).inject(this.lineChartArea),this.lineChart=new MWF.xApplication.Attendance.Echarts(this.lineChartNode,this,this.detailData,{type:"line",date:this.date,cycleStart:new Date(this.cycleStartDate.getFullYear(),this.cycleStartDate.getMonth(),this.cycleStartDate.getDate()),cycleEnd:new Date(this.cycleEndDate.getFullYear(),this.cycleEndDate.getMonth(),this.cycleEndDate.getDate())}),this.lineChart.load()},listDetailFilterUser:function(t,e,i,s){var a={};e&&(a.q_empName=e),i&&(a.cycleYear=i),s&&(a.cycleMonth=2==s.toString().length?s:"0"+s),this.actions.listDetailFilterUser(a,function(e){var i=e.data||[];i.sort((function(t,e){return parseInt(t.recordDateString.replace(/-/g,""))-parseInt(e.recordDateString.replace(/-/g,""))})),t&&t(i)}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},e=this.titleNode?this.titleNode.getSize():{x:0,y:0},i=this.node.getSize(),s=this.elementContentNode.getStyle("padding-top").toFloat(),a=this.elementContentNode.getStyle("padding-bottom").toFloat(),n=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0},o=i.y-t.y-s-a-n.y-e.y;this.elementContentNode.setStyle("height",o+"px")},setNodeScroll:function(){MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){}})}.bind(this))},anaylyseDetail:function(){var t=[],e={levelAsked:0,noSign:0,late:0,appealSuccess:0,abNormalDuty:0,normal:0};this.detailData.each(function(i){if(this.isAskForLevel(i,"am"))t.push({text:this.lp.levelAsked,start:i.recordDateString,backgroundColor:this.statusColor.levelAsked}),e.levelAsked=e.levelAsked+.5;else if(this.isAppealSuccess(i,"am"))t.push({text:this.lp.appealSuccess,start:i.recordDateString,backgroundColor:this.statusColor.appealSuccess}),e.appealSuccess=e.appealSuccess+.5;else if(this.isAbsent(i,"am"))t.push({text:this.lp.noSign,start:i.recordDateString,backgroundColor:this.statusColor.noSign}),e.noSign=e.noSign+.5;else if(this.isLate(i,"am"))t.push({text:this.lp.late+"，"+this.lp.signTime+"："+i.onDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.late}),e.late=e.late+.5;else if(this.isLackOfTime(i,"am"))t.push({text:this.lp.lackOfTime+"，"+this.lp.signTime+"："+i.onDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.lackOfTime}),e.lackOfTime=e.lackOfTime+.5;else if(this.isAbnormalDuty(i,"am"))t.push({text:this.lp.abNormalDuty+"，"+this.lp.signTime+"："+i.onDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.abNormalDuty}),e.abNormalDuty=e.abNormalDuty+.5;else{if(this.isHoliday(i,"am"))return;if(this.isWeekend(i,"am"))return;e.normal=e.normal+.5,t.push({text:this.lp.normal+"，"+this.lp.signTime+"："+i.onDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.normal})}if(this.isAskForLevel(i,"pm"))e.levelAsked=e.levelAsked+.5,t.push({text:this.lp.index.levelAsked,start:i.recordDateString,backgroundColor:this.statusColor.levelAsked});else if(this.isAppealSuccess(i,"pm"))t.push({text:this.lp.appealSuccess,start:i.recordDateString,backgroundColor:this.statusColor.appealSuccess}),e.appealSuccess=e.appealSuccess+.5;else if(this.isAbsent(i,"pm"))e.noSign=e.noSign+.5,t.push({text:this.lp.index.absent,start:i.recordDateString,backgroundColor:this.statusColor.noSign});else if(this.isAbnormalDuty(i,"pm"))t.push({text:this.lp.abNormalDuty+"，"+this.lp.signTime+"："+i.offDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.abNormalDuty}),e.abNormalDuty=e.abNormalDuty+.5;else{if(this.isHoliday(i,"pm"))return;if(this.isWeekend(i,"pm"))return;i.offDutyTime&&(e.normal=e.normal+.5,t.push({text:this.lp.index.offDutyTime+i.offDutyTime,start:i.recordDateString,backgroundColor:this.statusColor.normal}))}}.bind(this)),this.totalData=e;var i=0;for(var s in e)i+=e[s];this.rateData={levelAsked:e.levelAsked&&i?(e.levelAsked/i*100).toFixed(2)+"%":0,noSign:e.noSign&&i?(e.noSign/i*100).toFixed(2)+"%":0,late:e.late&&i?(e.late/i*100).toFixed(2)+"%":0,abNormalDuty:e.abNormalDuty&&i?(e.abNormalDuty/i*100).toFixed(2)+"%":0,normal:e.normal&&i?(e.normal/i*100).toFixed(2)+"%":0,appealSuccess:e.appealSuccess&&i?(e.appealSuccess/i*100).toFixed(2)+"%":0},this.eventData=t},isAppealSuccess:function(t,e){return 9==t.appealStatus},isAskForLevel:function(t,e){return"am"==e?t.isGetSelfHolidays&&["全天","上午",this.app.lp.wholeDay,this.app.lp.am].contains(t.selfHolidayDayTime):t.isGetSelfHolidays&&["全天","下午",this.app.lp.wholeDay,this.app.lp.pm].contains(t.selfHolidayDayTime)},isAbsent:function(t,e){return"am"==e?t.isAbsent&&["全天","上午",this.app.lp.wholeDay,this.app.lp.am].contains(t.absentDayTime):t.isAbsent&&["全天","下午",this.app.lp.wholeDay,this.app.lp.pm].contains(t.absentDayTime)},isLate:function(t,e){return t.isLate},isWorkOvertime:function(t,e){return t.isWorkOvertime},isLackOfTime:function(t,e){return t.isLackOfTime},isAbnormalDuty:function(t,e){return"am"==e?t.isAbnormalDuty&&["全天","上午",this.app.lp.wholeDay,this.app.lp.am].contains(t.abnormalDutyDayTime):t.isAbnormalDuty&&["全天","下午",this.app.lp.wholeDay,this.app.lp.pm].contains(t.abnormalDutyDayTime)},isHoliday:function(t,e){return"am"==e?t.isHoliday&&(!t.onDutyTime||""==t.onDutyTime):t.isHoliday&&(!t.offDutyTime||""==t.offDutyTime)},isWeekend:function(t,e){return!t.isWorkday&&("am"==e?t.isWeekend&&(!t.onDutyTime||""==t.onDutyTime):t.isWeekend&&(!t.offDutyTime||""==t.offDutyTime))},toFixed:function(t,e){if(e||(e=0),-1==(i=t+"").indexOf(".")&&(i+="."),i+=new Array(e+1).join("0"),new RegExp("^(-|\\+)?(\\d+(\\.\\d{0,"+(e+1)+"})?)\\d*$").test(i)){var i="0"+RegExp.$2,s=RegExp.$1,a=RegExp.$3.length,n=!0;if(a==e+2){if(a=i.match(/\d/g),parseInt(a[a.length-1])>4)for(var o=a.length-2;o>=0&&(a[o]=parseInt(a[o])+1,10==a[o]);o--)a[o]=0,n=1!=o;i=a.join("").replace(new RegExp("(\\d+)(\\d{"+e+"})\\d$"),"$1.$2")}return n&&(i=i.substr(1)),(s+i).replace(/\.$/,"")}return this+""}});