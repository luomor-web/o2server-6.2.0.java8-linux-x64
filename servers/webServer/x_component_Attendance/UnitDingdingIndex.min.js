MWF.xApplication.Attendance=MWF.xApplication.Attendance||{},MWF.require("MWF.xAction.org.express.RestActions",null,!1),MWF.xDesktop.requireApp("Attendance","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("Attendance","Common",null,!1),MWF.xApplication.Attendance.UnitDingdingIndex=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},statusColor:{resultNormal:"#9acd32",leaveEarlyTimes:"#4f94cd",lateTimes:"#fede03",notSignedCount:"#ee807f",seriousLateTimes:"#dec674",absenteeismTimes:"#fedcbd"},initialize:function(t,e,i,s){this.setOptions(s),this.app=e,this.lp=e.lp,this.path="../x_component_Attendance/$UnitIndex/",this.cssPath="../x_component_Attendance/$UnitIndex/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.setDate(),this.today=new Date,this.userName=layout.desktop.session.user.distinguishedName,this.data={}},setDate:function(t){this.date=t||new Date,this.year=this.date.getFullYear().toString();var e=this.date.getMonth()+1;this.month=2==e.toString().length?e:"0"+e},reload:function(){this.node.empty(),this.load()},load:function(){this.loadTitleNode(),this.loadContent()},loadTitleNode:function(){var t=this.date.format(this.app.lp.dateFormatMonth);this.titleNode=new Element("div.titleNode",{styles:this.css.titleNode}).inject(this.node),this.titleLeftArrowNode=new Element("div",{styles:this.css.titleLeftArrowNode}).inject(this.titleNode),this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:t}).inject(this.titleNode),this.titleRightArrowNode=new Element("div",{styles:this.css.titleRightArrowNode}).inject(this.titleNode),this.titleLeftArrowNode.addEvents({mouseover:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_over)}.bind(this),mouseout:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode)}.bind(this),mousedown:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_down)}.bind(this),mouseup:function(){this.titleLeftArrowNode.setStyles(this.css.titleLeftArrowNode_over)}.bind(this),click:function(){this.changeMonthPrev()}.bind(this)}),this.titleRightArrowNode.addEvents({mouseover:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_over)}.bind(this),mouseout:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode)}.bind(this),mousedown:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_down)}.bind(this),mouseup:function(){this.titleRightArrowNode.setStyles(this.css.titleRightArrowNode_over)}.bind(this),click:function(){this.changeMonthNext()}.bind(this)}),this.titleTextNode.addEvents({mouseover:function(){this.titleTextNode.setStyles(this.css.titleTextNode_over)}.bind(this),mouseout:function(){this.titleTextNode.setStyles(this.css.titleTextNode)}.bind(this),mousedown:function(){this.titleTextNode.setStyles(this.css.titleTextNode_down)}.bind(this),mouseup:function(){this.titleTextNode.setStyles(this.css.titleTextNode_over)}.bind(this),click:function(){this.changeMonthSelect()}.bind(this)}),this.loadUnitNode()},changeMonthPrev:function(){this.date.decrement("month",1),this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t),this.reloadContent()},changeMonthNext:function(){this.date.increment("month",1),this.setDate(this.date);var t=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",t),this.reloadContent()},changeMonthSelect:function(){this.monthSelector||this.createMonthSelector(),this.monthSelector.show()},createMonthSelector:function(){this.monthSelector=new MWF.xApplication.Attendance.MonthSelector(this.date,this)},changeMonthTo:function(t){this.setDate(t);var e=this.date.format(this.app.lp.dateFormatMonth);this.titleTextNode.set("text",e),this.reloadContent()},changeUnitTo:function(t){this.unit=t,this.titleUnitActionTextNode.set("text",t.split("@")[0]),this.reloadContent()},loadUnitNode:function(){this.listUnitWithPerson(function(t){this.unit=t,this.units=[];if(this.app.isTopUnitManager()){var e={unitList:this.app.getNameFlag(this.app.manageTopUnits)};this.app.orgActions.listUnitSubDirect(function(t){t.data.each(function(t){this.units.push(t.distinguishedName)}.bind(this))}.bind(this),null,e,!1)}else this.app.isUnitManager()&&(this.units=this.app.manageUnits);this.unit=this.units[0]||this.unit,this.units.length>1?(this.titleUnitAreaNode=new Element("div.titleUnitAreaNode",{styles:this.css.titleUnitAreaNode}).inject(this.titleNode),this.titleUnitActionNode=new Element("div",{styles:this.css.titleUnitActionNode}).inject(this.titleUnitAreaNode),this.titleUnitActionTextNode=new Element("div",{styles:this.css.titleUnitActionTextNode,text:this.unit.split("@")[0]}).inject(this.titleUnitActionNode),this.titleUnitActionIconNode=new Element("div",{styles:this.css.titleUnitActionIconNode}).inject(this.titleUnitActionNode),this.titleUnitActionNode.addEvents({mouseover:function(){this.titleUnitActionTextNode.setStyles(this.css.titleUnitActionTextNode_over),this.titleUnitActionIconNode.setStyles(this.css.titleUnitActionIconNode_over)}.bind(this),mouseout:function(){this.titleUnitActionTextNode.setStyles(this.css.titleUnitActionTextNode),this.titleUnitActionIconNode.setStyles(this.css.titleUnitActionIconNode)}.bind(this),click:function(t){this.switchUnit(t.target),t.stopPropagation()}.bind(this)})):this.titleUnitNode=new Element("div",{styles:this.css.titleUnitNode,text:this.unit.split("@")[0]}).inject(this.titleNode)}.bind(this))},listUnitWithPerson:function(t){var e={personList:this.app.getNameFlag(this.userName)};this.app.orgActions.listUnitWithPerson(function(e){e.data.length>0?t&&t(e.data[0].distinguishedName):t&&t()}.bind(this),null,e,!1)},switchUnit:function(t){var e=this,i=this.titleUnitListNode;t.getParent();i?"block"==i.getStyle("display")?i.setStyle("display","none"):(i.setStyle("display","block"),i.position({relativeTo:this.titleUnitActionNode,position:"bottomCenter",edge:"upperCenter"})):(i=this.titleUnitListNode=new Element("div",{styles:this.css.titleUnitListNode}).inject(this.node),this.app.content.addEvent("click",(function(){e.titleUnitListNode.setStyle("display","none")})),this.units.each(function(t){var s=new Element("div",{text:t.split("@")[0],styles:this.css.titleUnitSelectNode}).inject(i);s.store("unit",t),s.addEvents({mouseover:function(){this.setStyles(e.css.titleUnitSelectNode_over)},mouseout:function(){this.setStyles(e.css.titleUnitSelectNode)},click:function(t){e.titleUnitListNode.setStyle("display","none"),this.setStyles(e.css.titleUnitSelectNode),e.changeUnitTo(this.retrieve("unit")),t.stopPropagation()}})}.bind(this)),i.position({relativeTo:this.titleUnitActionNode,position:"bottomCenter",edge:"upperCenter"}))},reloadContent:function(){this.pieChartArea.empty(),this.barChartArea.empty(),this.lineChartArea.empty(),this.loadData(function(){this.loadStatusColorNode(),this.loadPieChart(),this.loadBarChart()}.bind(this)),this.loadDetail()},loadContent:function(){this.loadContentNode(),this.loadData(function(){this.loadStatusColorNode(),this.loadPieChart(),this.loadBarChart()}.bind(this)),this.loadDetail(),this.setNodeScroll(),this.setContentSize()},reloadChart:function(){this.pieChartArea.empty(),this.barChartArea.empty(),this.lineChartArea.empty(),this.loadPieChart(),this.loadBarChart()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node),this.app.addEvent("resize",function(){this.setContentSize(),this.reloadChart()}.bind(this)),this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode),this.topContentArea=new Element("div.topContentArea",{styles:this.css.topContentArea}).inject(this.elementContentListNode),this.pieChartArea=new Element("div.pieChartArea",{styles:this.css.pieChartArea}).inject(this.topContentArea),this.statusColorArea=new Element("div.statusColorArea",{styles:this.css.statusColorArea}).inject(this.topContentArea),this.barChartArea=new Element("div.barChartArea",{styles:this.css.barChartArea}).inject(this.topContentArea),this.middleContentArea=new Element("div.middleContentArea",{styles:this.css.middleContentArea}).inject(this.elementContentListNode),this.lineChartArea=new Element("div.lineChartArea",{styles:this.css.lineChartArea}).inject(this.middleContentArea),this.bottomContentArea=new Element("div.middleContentArea",{styles:this.css.bottomContentArea}).inject(this.elementContentListNode),this.detailArea=new Element("div.lineChartArea",{styles:this.css.detailArea}).inject(this.bottomContentArea)},loadData:function(t,e,i,s,n){(e||(e=this.unit),i||(i=this.year),s||(s=this.month),this.data[e+i+s])?t&&t():o2.Actions.load("x_attendance_assemble_control").DingdingAttendanceStatisticAction.unitMonth(e,i,s,function(n){var o=n.data||{},a=this.data[e+i+s]={},l=a.totalData={resultNormal:o.resultNormal||0,lateTimes:o.lateTimes||0,leaveEarlyTimes:o.leaveEarlyTimes||0,absenteeismTimes:o.absenteeismTimes||0,seriousLateTimes:o.seriousLateTimes||0,notSignedCount:o.notSignedCount||0},h=0;for(var d in l)h+=l[d];a.rateData={resultNormal:l.resultNormal&&h?(l.resultNormal/h*100).toFixed(2)+"%":0,lateTimes:l.lateTimes&&h?(l.lateTimes/h*100).toFixed(2)+"%":0,leaveEarlyTimes:l.leaveEarlyTimes&&h?(l.leaveEarlyTimes/h*100).toFixed(2)+"%":0,absenteeismTimes:l.absenteeismTimes&&h?(l.absenteeismTimes/h*100).toFixed(2)+"%":0,seriousLateTimes:l.seriousLateTimes&&h?(l.seriousLateTimes/h*100).toFixed(2)+"%":0,notSignedCount:l.notSignedCount&&h?(l.notSignedCount/h*100).toFixed(2)+"%":0},t&&t()}.bind(this),null,n)},loadStatusColorNode:function(){this.statusColorArea.empty(),this.statusColorTable=new Element("table",{styles:this.css.statusColorTable}).inject(this.statusColorArea);var t=this.data[this.unit+this.year+this.month].totalData,e=this.data[this.unit+this.year+this.month].rateData;for(var i in this.statusColor){var s=new Element("tr",{styles:this.css.statusColorTr}).inject(this.statusColorTable);new Element("td",{styles:this.css.statusColorTd}).inject(s).setStyle("background-color",this.statusColor[i]);s=new Element("tr",{styles:this.css.statusTextTr}).inject(this.statusColorTable),new Element("td",{styles:this.css.statusTextTd,text:this.lp[i]+t[i]+this.lp.day+"("+e[i]+")"}).inject(s)}},loadPieChart:function(){this.pieChartNode=new Element("div.pieChartNode",{styles:this.css.pieChartNode}).inject(this.pieChartArea);var t=this.data[this.unit+this.year+this.month].totalData;this.pieChart=new MWF.xApplication.Attendance.Echarts(this.pieChartNode,this,t),this.pieChart.loadUnitPieChart()},loadBarChart:function(){this.barChartNode=new Element("div.barChartNode",{styles:this.css.barChartNode}).inject(this.barChartArea);var t=new Date(this.date.getFullYear(),this.date.getMonth(),this.date.getDate());t.decrement("month",1);var e=t.getFullYear().toString(),i=t.format(this.lp.dateFormatOnlyMonth),s=this.data[this.unit+e+i];t.decrement("month",1);var n=t.getFullYear().toString(),o=t.format(this.lp.dateFormatOnlyMonth),a=this.data[this.unit+n+o];s||this.loadData(null,this.unit,e,i,!1),a||this.loadData(null,this.unit,n,o,!1);var l=[{year:n,month:o,data:this.data[this.unit+n+o].totalData},{year:e,month:i,data:this.data[this.unit+e+i].totalData},{year:this.year,month:this.month,data:this.data[this.unit+this.year+this.month].totalData}];this.barChart=new MWF.xApplication.Attendance.Echarts(this.barChartNode,this,l),this.barChart.loadUnitBarChart()},loadDetail:function(){this.detailArea.empty(),this.detailNode=new Element("div",{styles:this.css.detailNode}).inject(this.detailArea),this.detailTitleNode=new Element("div",{styles:this.css.detailTitleNode,text:this.lp.attendanceStatisic}).inject(this.detailNode);var t=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.table,class:"editTable"}).inject(this.detailNode),e=new Element("tr",{styles:this.css.listHeadNode}).inject(t);new Element("td",{styles:this.css.tableTitle,text:this.lp.name}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.onDutyTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.offDutyTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.resultNormal}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.lateTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.seriousLateTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.leaveEarlyTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.absenteeismTimes}).inject(e),new Element("td",{styles:this.css.tableTitle,text:this.lp.notSignedCount}).inject(e);o2.Actions.load("x_attendance_assemble_control").DingdingAttendanceStatisticAction.personMonthWithUnit(this.unit,this.year,this.month,function(e){var i=e.data||[];i.sort((function(t,e){return e.workDayCount-t.workDayCount})),i.each(function(e){var i=new Element("tr").inject(t);new Element("td",{styles:this.css.tableValue,text:e.o2User.split("@")[0]}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.onDutyTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.offDutyTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.resultNormal}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.lateTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.seriousLateTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.leaveEarlyTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.absenteeismTimes}).inject(i),new Element("td",{styles:this.css.tableValue,text:e.notSignedCount}).inject(i)}.bind(this))}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0},e=this.titleNode?this.titleNode.getSize():{x:0,y:0},i=this.node.getSize(),s=this.elementContentNode.getStyle("padding-top").toFloat(),n=this.elementContentNode.getStyle("padding-bottom").toFloat(),o=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0},a=i.y-t.y-s-n-o.y-e.y-10;this.elementContentNode.setStyle("height",a+"px")},setNodeScroll:function(){MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.elementContentNode,{indent:!1,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:!1,y:!0},onScroll:function(t){}})}.bind(this))}});