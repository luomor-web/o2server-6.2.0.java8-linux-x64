MWF.xDesktop.requireApp("Template","MForm",null,!1),MWF.xApplication.Attendance.AppSetting=new Class({Extends:MWF.widget.Common,options:{style:"default"},initialize:function(e,t,i){this.setOptions(i),this.app=e,this.path="../x_component_Attendance/$AppSetting/",this.cssPath="../x_component_Attendance/$AppSetting/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=t,this.load()},load:function(){this.app.restActions.listSetting(function(e){e.data&&e.data.length>0&&(this.data=e.data)}.bind(this),null,!1),this.data||(this.data=[])},decodeData:function(e){var t={};return this.dataJson={},e.each(function(e){t[e.configCode]=e.configValue,this.dataJson[e.configCode]=e}.bind(this)),t},encodeData:function(e,t){var i=[];for(var s in t)if(this.itemTemplate[s]){for(var a=!1,n=0;n<e.length;n++)e[n].configCode==s&&(a=!0,e[n].configValue=t[s],i.push(Object.clone(e[n])));a||i.push({configCode:s,configValue:t[s],configName:this.itemTemplate[s].text})}return i},open:function(e){this.isNew=!1,this.isEdited=!1,this._open()},create:function(){this.isNew=!0,this._open()},edit:function(){this.isEdited=!0,this._open()},_open:function(){this.createMarkNode=new Element("div",{styles:this.css.createMarkNode,events:{mouseover:function(e){e.stopPropagation()},mouseout:function(e){e.stopPropagation()}}}).inject(this.app.content,"after"),this.createAreaNode=new Element("div",{styles:this.css.createAreaNode}),this.createNode(),this.createAreaNode.inject(this.createMarkNode,"after"),this.createAreaNode.fade("in"),this.setCreateNodeSize(),this.setCreateNodeSizeFun=this.setCreateNodeSize.bind(this),this.addEvent("resize",this.setCreateNodeSizeFun)},createNode:function(){this.createNode=new Element("div",{styles:this.css.createNode}).inject(this.createAreaNode),this.createContainerNode=new Element("div",{styles:this.css.createContainerNode}).inject(this.createNode),this.setScrollBar(this.createContainerNode),this.createFormNode=new Element("div",{styles:this.css.createFormNode}).inject(this.createContainerNode),this.createTableContainer=new Element("div",{styles:this.css.createTableContainer}).inject(this.createFormNode),this.createTableArea=new Element("div",{styles:this.css.createTableArea}).inject(this.createTableContainer);new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.editTable,class:"editTable"}).inject(this.createTableArea);var e=this.decodeData(this.data),t=this.app.lp,i="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td colspan='4' styles='formTableHead'>"+t.systemSetting+"</td></tr><tr><td styles='formTableTitle' lable='APPEALABLE'></td>    <td styles='formTableValue' item='APPEALABLE'></td><tr><td styles='formTableTitle' lable='APPEAL_AUDIFLOWTYPE'></td>    <td styles='formTableValue' item='APPEAL_AUDIFLOWTYPE'></td><tr item='AUDITOR_TYPE' style='display:"+("WORKFLOW"==e.APPEAL_AUDIFLOWTYPE?"none":"")+"'><td styles='formTableTitle' lable='APPEAL_AUDITOR_TYPE'></td>    <td styles='formTableValue' item='APPEAL_AUDITOR_TYPE'></td><tr item='valueArea' style='display:"+(e.APPEAL_AUDITOR_TYPE==t.reportTo||"汇报对象"==e.APPEAL_AUDITOR_TYPE||"WORKFLOW"==e.APPEAL_AUDIFLOWTYPE?"none":"")+"' ><td styles='formTableTitle' lable='APPEAL_AUDITOR_VALUE'></td>    <td styles='formTableValue' style='width: 60%' item='APPEAL_AUDITOR_VALUE'></td><tr item='AUDIFLOW' style='display:"+("BUILTIN"==e.APPEAL_AUDIFLOWTYPE?"none":"")+"'><td styles='formTableTitle' lable='APPEAL_AUDIFLOW_ID'></td>    <td styles='formTableValue' style='width: 60%' item='APPEAL_AUDIFLOW_ID'></td></table>";this.createTableArea.set("html",i),this.itemTemplate={APPEALABLE:{text:t.appealEnable,type:"select",value:e.APPEALABLE||"true",selectText:t.appealSelectText,selectValue:["true","false"]},APPEAL_AUDIFLOWTYPE:{text:t.appealAuditFlowType,type:"select",value:e.APPEAL_AUDIFLOWTYPE,selectValue:this.dataJson.APPEAL_AUDIFLOWTYPE.selectContent.split("|"),selectText:t.appealAuditFlowTypeSelectText,event:{change:function(e,t){this.createTableArea.getElement("[item='AUDITOR_TYPE']").setStyle("display","WORKFLOW"==e.getValue()?"none":""),this.createTableArea.getElement("[item='valueArea']").setStyle("display","WORKFLOW"==e.getValue()?"none":""),this.createTableArea.getElement("[item='AUDIFLOW']").setStyle("display","BUILTIN"==e.getValue()?"none":"")}.bind(this)}},APPEAL_AUDITOR_TYPE:{text:t.appealAuditorType,type:"select",value:e.APPEAL_AUDITOR_TYPE,selectValue:this.dataJson.APPEAL_AUDITOR_TYPE.selectContent.split("|"),event:{change:function(e,i){this.createTableArea.getElement("[item='valueArea']").setStyle("display","汇报对象"==e.getValue()||e.getValue()==t.reportTo?"none":"")}.bind(this)}},APPEAL_AUDITOR_VALUE:{text:t.appealAuditorValue,type:"text",value:e.APPEAL_AUDITOR_VALUE,defaultValue:t.directSupervisor},APPEAL_AUDIFLOW_ID:{text:t.appealAuditFlow,type:"org",orgType:["process"],count:1,isEdited:this.isEdited||this.isNew,value:e.APPEAL_AUDIFLOW_ID&&e.APPEAL_AUDIFLOW_ID!=t.none&&"无"!=e.APPEAL_AUDIFLOW_ID?e.APPEAL_AUDIFLOW_ID:"",defaultValue:"",orgWidgetOptions:{onLoadedInfor:function(e){console.log(e)}.bind(this),onComplete:function(e){console.log(e)}.bind(this)}}},this.document=new MForm(this.createTableArea,this.data,{style:"popup",isEdited:this.isEdited||this.isNew,itemTemplate:this.itemTemplate},this.app,this.css),this.document.load(),this.cancelActionNode=new Element("div",{styles:this.css.createCancelActionNode,text:t.cancel}).inject(this.createFormNode),this.cancelActionNode.addEvent("click",function(e){this.cancelCreate(e)}.bind(this)),(this.isNew||this.isEdited)&&(this.createOkActionNode=new Element("div",{styles:this.css.createOkActionNode,text:t.ok}).inject(this.createFormNode),this.createOkActionNode.addEvent("click",function(e){this.okCreate(e)}.bind(this)))},setCreateNodeSize:function(){var e=this.app.node.getSize();this.app.content.getSize();this.createAreaNode.setStyles({width:e.x+"px",height:e.y+"px"});var t=(e.y-"470")/2;this.createNode.setStyles({height:"470px","margin-top":t+"px",width:"600px"}),this.createContainerNode.setStyles({height:"470px"});var i="470"-(this.createIconNode?this.createIconNode.getSize():{x:0,y:0}).y-60;this.createFormNode.setStyles({height:i+"px","margin-top":"60px"})},cancelCreate:function(e){this.createMarkNode.destroy(),this.createAreaNode.destroy()},okCreate:function(e){var t=this.document.getResult(!0,",",!0,!1,!1);if(t){var i=t.APPEAL_AUDIFLOW_ID;i&&i!=this.app.lp.none&&"无"!=i&&""!=i&&this.document.items.APPEAL_AUDIFLOW_ID.orgObject&&(t.APPEAL_AUDIFLOW_ID=this.document.items.APPEAL_AUDIFLOW_ID.orgObject[0].data.id);var s=this.encodeData(this.data,t);this.save(s)}},save:function(e){var t=!0;e.each(function(e){this.app.restActions.saveSetting(e,function(e){"ERROR"==e.type&&(this.app.notice(e.message,"error"),t=!1)}.bind(this),null,!1)}.bind(this)),t&&(this.createMarkNode.destroy(),this.createAreaNode.destroy(),this.app.notice(this.app.lp.saveSuccess,"success"))}});