MWF.xDesktop.requireApp("Attendance","Explorer",null,!1),MWF.xDesktop.requireApp("Template","Explorer",null,!1),o2.require("MWF.widget.UUID",null,!1),MWF.xApplication.Attendance.AddressExplorer=new Class({Extends:MWF.xApplication.Attendance.Explorer,Implements:[Options,Events],initialize:function(t,e,i,n){this.setOptions(n),this.app=e,this.path="../x_component_Attendance/$AddressExplorer/",this.cssPath="../x_component_Attendance/$AddressExplorer/"+this.options.style+"/css.wcss",this._loadCss(),this.actions=i,this.node=$(t),this.initData()},reload:function(){this.node.empty(),this.load()},load:function(){this.loadToolbar(),this.loadContentNode(),this.loadContent(),this.setNodeScroll()},destroy:function(){this.baiduMap&&(this.baiduMap.map.clearOverlays(),this.elementContentNode.destroy()),this.node.empty()},loadContent:function(t){this.elementContentNode.empty(),this.actions.listWorkplace(function(t){t.data=t.data||[],this.wpContent=this.toolbarNode.getElements("[name=wpContent]")[0],this.createList(t.data),this.baiduMap=new MWF.xApplication.Attendance.AddressExplorer.BaiduMap(this.elementContentNode,this.app,this,{}),this.baiduMap.load(t.data),this.setContentSize()}.bind(this))},setBiduAccount:function(){new MWF.xApplication.Attendance.AddressExplorer.BaiduAccountForm(this).edit()},reloadList:function(){this.actions.listWorkplace(function(t){this.wpContent.empty(),this.createList(t.data||[])}.bind(this))},createList:function(t){this.wdList=new Element("div",{styles:this.css.wdList}).inject(this.wpContent),this.wdList.setStyle("width",this.toolbarNode.getSize().x-470+"px"),t.each(function(t){new Element("div",{styles:this.css.toolbarContentItem,text:t.placeName}).inject(this.wdList).addEvent("click",function(t){this.obj.baiduMap.gotoMarker(this.data),t.stopPropagation()}.bind({obj:this,data:t}))}.bind(this)),this.arrow="up",this.wdList.getScrollSize().y>this.wpContent.getSize().y&&(this.wdList.addEvent("click",function(t){"down"!=this.arrow?this.openList(t):this.closeList(t)}.bind(this)),this.arrowNode=new Element("div.arrowNode",{styles:this.css.arrowNode}).inject(this.wpContent,"top"),this.arrowNode.addEvents({mouseover:function(){this.arrowNode.setStyles("down"!=this.categoryArrow?this.css.arrowNode_over:this.css.arrowNode_down_over)}.bind(this),mouseout:function(){this.arrowNode.setStyles("down"!=this.categoryArrow?this.css.arrowNode:this.css.arrowNode_down)}.bind(this),click:function(t){"down"!=this.arrow?this.openList(t):this.closeList(t)}.bind(this)}))},_setContentSize:function(){this.wdList.setStyle("width",this.toolbarNode.getSize().x-370+"px")},openList:function(t){this.arrow="down",this.arrowNode.setStyle("display","none"),this.wdList.setStyles(this.css.wdList_all),window.closeList=this.closeList.bind(this),this.app.content.addEvent("click",window.closeList),t.stopPropagation()},closeList:function(t){this.arrow="up",this.arrowNode.setStyle("display",""),this.wdList.setStyles(this.css.wdList),this.app.content.removeEvent("click",window.closeList),t.stopPropagation()},createDocument:function(){this.baiduMap.createMarker()}}),MWF.xApplication.Attendance.AddressExplorer.BaiduMap=new Class({Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,n){this.container=t,this.explorer=i,this.app=e,this.actions=i.actions,this.setOptions(n),this.markers={},this.markerInfoWindows={}},load:function(t){this.markerData=t,this.mapNode=new Element("div",{styles:{width:"100%",height:"99%"}}).inject(this.container),setTimeout(function(){MWF.UD.getPublicData("baiduAccountKey",function(t){this.loadResource(null,t)}.bind(this))}.bind(this),200)},loadResource:function(t,e){var i;window.BMap_loadScriptTime=(new Date).getTime();var n=e||"Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg";i="https:"===window.location.protocol.toLowerCase()?"https://api.map.baidu.com/getscript?v=2.0&ak="+n+"&services=&t=20161219171637":"http://api.map.baidu.com/getscript?v=2.0&ak="+n+"&services=&t=20161219171637",window.BDMapApiLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.loadDom(i,function(){window.BDMapApiLoaded=!0,window.BDMarkerToolLoaded?(this._loadMap(),t&&t()):COMMON.AjaxModule.load("../x_component_Attendance/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=!0,this._loadMap(),t&&t()}.bind(this))}.bind(this))},_loadMap:function(){if(navigator.geolocation)try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this))}catch(t){this.loadMap()}else this.loadMap()},loadMap:function(t){this.createMap(t),this.addMapControl(),this.markerData&&this.addMarkerArray(this.markerData)},createMap:function(t){var e=null;if(t&&t.coords&&(e=new BMap.Point(t.coords.longitude,t.coords.latitude)),!e)if(this.markerData&&this.markerData.length>0){var i=this.markerData[0];e=new BMap.Point(i.longitude,i.latitude)}else e=new BMap.Point(116.404,39.915);var n=this.map=new BMap.Map(this.mapNode);n.centerAndZoom(e,12),n.enableScrollWheelZoom(!0)},addMapControl:function(){var t=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_RIGHT,type:BMAP_NAVIGATION_CONTROL_LARGE});this.map.addControl(t);var e=new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:1});this.map.addControl(e);var i=new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});this.map.addControl(i),this.addCityListControl()},addCityListControl:function(){this.map.addControl(new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT,offset:new BMap.Size(10,20),onChangeBefore:function(){},onChangeAfter:function(){}}))},getInfoWindowHtml:function(t){t=t||{};var e=[];return e.push("<br/>"),e.push('<table border="0" cellpadding="1" cellspacing="1" id="markerTable" docId="'+(t.id||"")+'" style="font-size:12px;">'),e.push("  <tr>"),e.push('      <td style="width:50px" align="left" class="common">'+this.app.lp.name1+"：</td>"),e.push('      <td style="width: 300px"><input type="text"  size="40" value="'+(t.placeName||"")+'" id="placeName" ></td>'),e.push('\t     <td style="width: 10px" valign="top"><span style="color:#ff0000">*</span></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td  align="left" class="common">'+this.app.lp.alias+"：</td>"),e.push('      <td><input type="text" maxlength="300px" size="40"  value="'+(t.placeAlias||"")+'" id="placeAlias" ></td>'),e.push('\t     <td valign="top"></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td  align="left" class="common">'+this.app.lp.range+"：</td>"),e.push('      <td><input type="text" maxlength="300px" size="40"  value="'+(t.errorRange||"")+'" id="errorRange" ></td>'),e.push('\t     <td valign="top">'+this.app.lp.meter+"</td>"),e.push("  </tr>"),e.push("  <tr>"),e.push('      <td align="left" class="common">'+this.app.lp.description+"：</td>"),e.push('      <td><textarea rows="4" cols="31"  id="description">'+(t.description||"")+"</textarea></td>"),e.push('\t     <td valign="top"></td>'),e.push("  </tr>"),e.push("  <tr>"),e.push('\t     <td  align="center" colspan="3">'),e.push('          <input type="button" name="btnOK"  id="submitPlace" value="'+this.app.lp.save+'">&nbsp;&nbsp;'),t.id&&e.push('\t\t     <input type="button" name="btnMove" id="enableMovePlace" value="'+this.app.lp.enableMove+'">&nbsp;&nbsp;'),e.push('\t\t     <input type="button" name="btnClear" id="cancelPlace" value="'+this.app.lp.delete+'">'),e.push("\t     </td>"),e.push("  </tr>"),e.push("</table>"),e.join("")},createMarker:function(){var t=this,e=new BMapLib.MarkerTool(this.map,{autoClose:!0});e.addEventListener("markend",function(e){var i=new BMap.InfoWindow(this.getInfoWindowHtml(),{offset:new BMap.Size(0,-10)});i.addEventListener("open",function(){var t=document.id("markerTable");t.getElements("[id='submitPlace']").addEvent("click",function(){this.obj.ok(this.mkr,this.table)}.bind({obj:this,mkr:n,table:t})),t.getElements("[id='cancelPlace']").addEvent("click",function(){this.obj.cancel(this.mkr,this.table)}.bind({obj:this,mkr:n,table:t}))}.bind(t));var n=e.marker;n.addEventListener("click",(function(){this.openInfoWindow(i)})),n.addEventListener("dragend",(function(){this.openInfoWindow(i)})),n.openInfoWindow(i)}.bind(this)),e.open();var i=BMapLib.MarkerTool.SYS_ICONS[14];e.setIcon(i)},addMarkerArray:function(t){for(var e=0;e<t.length;e++){var i=t[e];this.addMarker(i)}},addMarker:function(t){var e=this,i=new BMap.Point(t.longitude,t.latitude),n=BMapLib.MarkerTool.SYS_ICONS[8],o=new BMap.Marker(i,{icon:n,enableDragging:!1}),a=new BMap.Label(t.placeName,{offset:new BMap.Size(0,-20)});o.setLabel(a),this.map.addOverlay(o),a.setStyle({borderColor:"#808080",color:"#333",cursor:"pointer"}),function(){var i=new BMap.InfoWindow(this.getInfoWindowHtml(t),{offset:new BMap.Size(0,-10)}),n=o,s=t;n.addEventListener("click",(function(){this.openInfoWindow(i)})),n.addEventListener("dragend",(function(){this.openInfoWindow(i)})),i.addEventListener("open",function(){n.getLabel().hide();var t=document.id("markerTable");t.getElements("[id='enableMovePlace']").addEvent("click",function(){this.obj.enableMove(this.mkr)}.bind({obj:this,mkr:n,table:t,id:s.id})),t.getElements("[id='submitPlace']").addEvent("click",function(){this.obj.ok(this.mkr,this.table,this.id)}.bind({obj:this,mkr:n,table:t,id:s.id})),t.getElements("[id='cancelPlace']").addEvent("click",function(){this.obj.cancel(this.mkr,this.table,this.id)}.bind({obj:this,mkr:n,table:t,id:s.id}))}.bind(e)),i.addEventListener("close",(function(){n.getLabel().show()})),a.addEventListener("click",(function(){n.openInfoWindow(i)})),this.markers[t.id]=o,this.markerInfoWindows[t.id]=i}.bind(this)()},enableMove:function(t){t.closeInfoWindow(),t.enableDragging()},gotoMarker:function(t){var e=this.markers[t.id];this.map.centerAndZoom(e.point,15),e.openInfoWindow(this.markerInfoWindows[t.id])},ok:function(t,e,i){var n=e.getElements("[id='placeName']")[0].get("value");if(""==n.trim())return this.app.notice(this.app.lp.workPlaceEmptyNotice,"error"),!1;var o=e.getElements("[id='placeAlias']")[0].get("value"),a=e.getElements("[id='description']")[0].get("value"),s={placeName:n,placeAlias:o,errorRange:e.getElements("[id='errorRange']")[0].get("value"),description:a,longitude:t.point.lng,latitude:t.point.lat};i&&(s.id=i),this.actions.saveWorkplace(s,function(e){s.id=e.data.message,t.closeInfoWindow(),t.remove(),this.addMarker(s),this.explorer.reloadList()}.bind(this))},cancel:function(t,e,i){if(i)this.actions.deleteWorkplace(i,function(){t.closeInfoWindow();var e=t.getLabel();e&&e.remove(),t.remove(),this.explorer.reloadList()}.bind(this));else{t.closeInfoWindow();var n=t.getLabel();n&&n.remove(),t.remove()}}}),MWF.xApplication.Attendance.AddressExplorer.BaiduAccountForm=new Class({Extends:MWF.xApplication.Attendance.Explorer.PopupForm,_createTableContent:function(){var t=MWF.xApplication.Attendance.LP,e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'><tr><td colspan='2' styles='formTableHead'>"+t.BaiduDeveloperCertification+"</td></tr><tr>    <td styles='formTableValue' colspan='2'>"+t.registerBiaduNotice+"</td></tr><tr>    <td styles='formTableValue' colspan='2'><a href='http://lbsyun.baidu.com/apiconsole/auth' target='_blank'>"+t.openRegisterUrl+"</a></td></tr><tr>    <td styles='formTableTitle' lable='ak'></td>    <td styles='formTableValue' item='ak'></td></tr></table>";this.formTableArea.set("html",e),MWF.UD.getPublicData("baiduAccountKey",function(e){MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,{ak:e||""},{isEdited:!0,itemTemplate:{ak:{text:t.secretKey}}},this.app),this.form.load()}.bind(this),!0)}.bind(this))},_ok:function(t,e){MWF.UD.putPublicData("baiduAccountKey",t.ak,function(t){e&&e(t)}.bind(this))}});