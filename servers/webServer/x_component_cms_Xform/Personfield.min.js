MWF.xDesktop.requireApp("process.Xform","Personfield",null,!1),MWF.xApplication.cms.Xform.Personfield=MWF.CMSPersonfield=new Class({Extends:MWF.APPPersonfield,getSelectRange:function(){if("unit"===this.json.range)return this.getScriptSelectUnit();if("draftUnit"===this.json.range)return this.getNextSelectUnit(this.form.businessData.document.creatorIdentity);if("currentUnit"===this.json.range){if(layout.session.user.identityList.length){var t=[];return layout.session.user.identityList.each((function(e){t.push(e.id)})),this.getNextSelectUnit(t)}return[]}return[]},getSelectRangeDuty:function(){return"duty"===this.json.dutyRange?this.getScriptSelectDuty():[]},clickSelect:function(){var t=this.getInputData(),e=this.json.count?this.json.count:0;this.json.range;var i=this.getSelectRange();if("identity"==this.json.selectType)var s=this.getSelectRangeDuty();if("all"!==this.json.range&&!i.length)return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;if("identity"==this.json.selectType&&this.json.dutyRange&&"all"!==this.json.dutyRange&&(!s||!s.length))return this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange,"error",this.node),!1;var n=[];if(this.json.exclude){var o=this.form.Macro.exec(this.json.exclude.code,this);n="array"===typeOf(o)?o:[o]}var r="simple"===this.json.storeRange,a={type:this.json.selectType,unitType:"all"===this.json.selectUnitType?"":this.json.selectUnitType,values:this.json.isInput?[]:t,count:e,units:i,exclude:n,expandSubEnable:"no"!=this.json.expandSubEnable,dutys:"identity"==this.json.selectType?s:[],onComplete:function(t){var e=[];t.each(function(t){e.push(MWF.org.parseOrgData(t.data,!0,r))}.bind(this)),this.json.isInput?this.addData(e):this.setData(e),this.validationMode(),this.validation(),this.fireEvent("select")}.bind(this),onCancel:function(){this.validation()}.bind(this),onLoad:function(){this.descriptionNode&&this.descriptionNode.setStyle("display","none")}.bind(this),onClose:function(){(o=this._getBusinessData())&&o.length||this.descriptionNode&&this.descriptionNode.setStyle("display","block")}.bind(this)};this.selector&&this.selector.loading||this.selector&&this.selector.selector&&this.selector.selector.active||(this.selector=new MWF.O2Selector(this.form.app.content,a))}});