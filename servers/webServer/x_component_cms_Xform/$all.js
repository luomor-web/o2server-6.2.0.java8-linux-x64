o2.widget = o2.widget || {};
if( !o2.widget.UUID )o2.require("o2.widget.UUID", null, false);
o2.widget.AttachmentController = o2.widget.ATTER  = new Class({
    Extends: o2.widget.Common,
	Implements: [Options, Events],
	options: {
		"style": "default",
        "listStyle": "icon",
        "size": "max",
        "resize": true,
        "attachmentCount": 0,
        "isUpload": true,
        "isDelete": true,
        "isReplace": true,
        "isDownload": true,
        "isPreviewAtt": true,
        "isSizeChange": true,
        "readonly": false,
        "availableListStyles" : ["list","seq","icon","preview"],
        "toolbarGroupHidden" : [], //edit read list view
        "images": ["bmp", "gif", "png", "jpeg", "jpg", "jpe", "ico"],
        "audios": ["mp3", "wav", "wma", "wmv"],
        "videos": ["avi", "mkv", "mov", "ogg", "mp4", "mpa", "mpe", "mpeg", "mpg", "rmvb"],
        "actionShowText" : false
	},
	initialize: function(container, module, options){
		this.setOptions(options);
		this.pages = [];

		this.path = o2.session.path+"/widget/$AttachmentController/";
		this.cssPath = o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/css.wcss";
		this._loadCss();

        var iconUrl = this.options.iconConfigUrl ? this.options.iconConfigUrl : "../x_component_File/$Main/icon.json";
        o2.getJSON(iconUrl, function(json){
            this.icons = json;
        }.bind(this), false, false);

        this.module = module;

        this.actions = [];
        this.attachments = [];
        this.selectedAttachments = [];
		this.container = $(container);
	},
    load: function(){
        // if (!layout.mobile){
            if (this.options.size==="min"){
                this.loadMin();
            }else{
                this.loadMax();
            }
        // }else{
        //     this.loadMobile();
        // }
    },
    reloadAttachments: function(){
        if (this.options.size==="min"){
            this.minContent.empty();
            var atts = this.attachments;
            this.attachments = [];
            while (atts.length){
                var att = atts.shift();
                this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(att.data, this));
            }
        }else{
            this.content.empty();
            var atts = this.attachments;
            this.attachments = [];
            while (atts.length){
                var att = atts.shift();
                this.attachments.push(new o2.widget.AttachmentController.Attachment(att.data, this));
            }
        }
        this.checkActions();
    },
    getAttachmentById: function(attId){
        for( var i=0; i<this.attachments.length; i++ ){
            if( this.attachments[i].data.id === attId ){
                return this.attachments[i];
            }
        }
        return null;
    },
	loadMax: function(){
        if (!this.node) this.node = new Element("div", {"styles": this.css.container});

        this.createTopNode();

        if (!this.contentScrollNode){
            //this.createTopNode();
            this.createContentNode();


            if (this.options.resize){
                this.createBottomNode();
                this.createResizeNode();
            }

            this.node.inject(this.container);

            //if (this.options.readonly) this.setReadonly();
            this.checkActions();

            this.setEvent();
        }else{
            this.contentScrollNode.setStyle("display", "block");
            if (this.bottomNode) this.bottomNode.setStyle("display", "block");
            if (this.titleNode) this.titleNode.setStyle("display", "block");
            //this.topNode.setStyle("display", "block");
            this.content.empty();
        }
        var atts = this.attachments;
        this.attachments = [];
        while (atts.length){
            var att = atts.shift();
            this.attachments.push(new o2.widget.AttachmentController.Attachment(att.data, this));
        }
        this.checkActions();
        //this.attachments = atts;
	},
    loadMin: function(){

        if (!this.node) this.node = new Element("div", {"styles": this.css.container_min});

        if (!this.minActionAreaNode){
            this.minActionAreaNode = new Element("div", {"styles": this.css.minActionAreaNode }).inject(this.node);
            //this.minContent = new Element("div", {"styles": this.css.minContentNode}).inject(this.node);

            this.loadMinActions();

            this.node.inject(this.container);

            //if (this.options.readonly) this.setReadonly();
            //this.checkActions();

            this.setEvent();
        }else{
            this.minActionAreaNode.setStyle("display", "");
            //this.minContent.setStyle("display", "block");
            //this.minContent.empty();
            this.minActionAreaNode.empty();

            this.loadMinActions();

            //this.checkActions();

            this.setEvent();
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        var flag = hiddenGroup.contains("edit") && hiddenGroup.contains("read")  && hiddenGroup.contains("view");

        if( flag )this.minActionAreaNode.setStyle("display","none");

        if( !this.minContent ){

            this.minContent = new Element("div", {"styles":
                layout.mobile ? this.css.minContentNode_mobile : this.css.minContentNode
            }).inject(this.node);
            if( layout.mobile ){
                this.minContent.setStyle("clear","both");
            }
        }else{
            this.minContent.setStyle("display", "block");
            this.minContent.empty();
        }

        //if (!hiddenGroup.contains("edit")){
        //        this.min_uploadAction = this.createAction(this.minActionAreaNode, "upload", o2.LP.widget.upload, function (e, node) {
        //            this.uploadAttachment(e, node);
        //        }.bind(this));
        //
        //        this.min_deleteAction = this.createAction(this.minActionAreaNode, "delete", o2.LP.widget["delete"], function (e, node) {
        //            this.deleteAttachment(e, node);
        //        }.bind(this));
        //
        //        this.min_replaceAction = this.createAction(this.minActionAreaNode, "replace", o2.LP.widget.replace, function (e, node) {
        //            this.replaceAttachment(e, node);
        //        }.bind(this));
        //    }
        //
        //    if (!hiddenGroup.contains("read")){
        //        this.min_downloadAction = this.createAction(this.minActionAreaNode, "download", o2.LP.widget.download, function (e, node) {
        //            this.downloadAttachment(e, node);
        //        }.bind(this));
        //    }
        //
        //    if( !hiddenGroup.contains("edit") || !hiddenGroup.contains("read") ) {
        //        this.createSeparate(this.minActionAreaNode);
        //    }
        //
        //    if( !hiddenGroup.contains("view")){
        //        this.sizeAction = this.createAction(this.minActionAreaNode, "max", o2.LP.widget.min, function(){
        //            this.changeControllerSize();
        //        }.bind(this));
        //    }
        //
        //    this.node.inject(this.container);

        var atts = this.attachments;
        this.attachments = [];
        while (atts.length){
            var att = atts.shift();
            this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(att.data, this));
        }
        this.checkActions();
        //this.attachments = atts;
    },
    loadMobile: function(){

    },


    loadMinActions: function(){
        var hiddenGroup = this.options.toolbarGroupHidden;
        if (!hiddenGroup.contains("edit")) {
            this.min_uploadAction = this.createAction(this.minActionAreaNode, "upload", o2.LP.widget.upload, function (e, node) {
                this.uploadAttachment(e, node);
            }.bind(this));

            this.min_deleteAction = this.createAction(this.minActionAreaNode, "delete", o2.LP.widget["delete"], function (e, node) {
                this.deleteAttachment(e, node);
            }.bind(this));

            if( !this.options.isReplaceHidden ){
                this.min_replaceAction = this.createAction(this.minActionAreaNode, "replace", o2.LP.widget.replace, function (e, node) {
                    this.replaceAttachment(e, node);
                }.bind(this));
            }
        }
        if (!hiddenGroup.contains("read")) {
            this.min_downloadAction = this.createAction(this.minActionAreaNode, "download", o2.LP.widget.download, function (e, node) {
                this.downloadAttachment(e, node);
            }.bind(this));
        }

        if( !hiddenGroup.contains("edit") || !hiddenGroup.contains("read") ) {
            this.createSeparate(this.minActionAreaNode);
        }

        if (this.options.isSizeChange){
            //this.createSeparate(this.minActionAreaNode);
            if( !hiddenGroup.contains("view")) {
                this.sizeAction = this.createAction(this.minActionAreaNode, "max", o2.LP.widget.min, function () {
                    this.changeControllerSize();
                }.bind(this));
            }
        }
    },

    setEvent: function(){
        if (this.contentScrollNode) this.contentScrollNode.addEvents({
            "mousedown": this.unSelectedAttachments.bind(this)
        });
        if (this.minContent) this.minContent.addEvents({
            "mousedown": this.unSelectedAttachments.bind(this)
        });
    },
    resetToolbarGroupHidden : function( hiddenGroup ){
        this.options.toolbarGroupHidden = hiddenGroup;
        if( this.options.size == "max" ){
            this.reloadTopNode();
        }else{
            this.loadMin();
        }
    },
    resetToolbarAvailableListStyle : function( availableListStyle ){
        this.options.availableListStyles = availableListStyle;
        if( this.options.size == "max" ){
            this.reloadTopNode();
        }else{
            this.loadMin();
        }
    },
    createContentNode: function(){
        this.contentScrollNode = new Element("div.contentScrollNode", {"styles": this.css.contentScrollNode}).inject(this.node);
        this.content = new Element("div.content", {"styles": this.css.contentNode}).inject(this.contentScrollNode);

        o2.require("o2.widget.ScrollBar", function(){
            new o2.widget.ScrollBar(this.contentScrollNode, {
                "style":"attachment", "where": "before", "distance": 30, "friction": 4,	"axis": {"x": false, "y": true}
            });
        }.bind(this));
    },
    createBottomNode: function(){
        this.bottomNode = new Element("div", {"styles": this.css.bottomNode}).inject(this.node);
    },
    createResizeNode: function(){
        this.resizeNode = new Element("div", {"styles": this.css.resizeNode}).inject(this.bottomNode);
        this.resizeDrag = new Drag(this.resizeNode, {
            "snap": "2",
            "onStart": function(el, e){
                el.store("startY", e.event.y);
                el.store("nodeHeight", this.node.getSize().y);

                var minHeight = this.node.getStyle("min-height");
                el.store("nodeMinHeight", minHeight ? minHeight.toFloat() : "");

                var contentScrollNodeMinHeight = this.contentScrollNode.getStyle("min-height");
                el.store("contentScrollNodeMinHeight", contentScrollNodeMinHeight ? contentScrollNodeMinHeight.toFloat() : "");

                if (!this.nodeHeight){
                    this.nodeHeight = minHeight.toFloat();
                }
            }.bind(this),
            "onDrag": function(el, e){
                var y = el.retrieve("startY");
                var nodeHeight = el.retrieve("nodeHeight");
                var nodeMinHeight = el.retrieve("nodeMinHeight");
                var contentScrollNodeMinHeight = el.retrieve("contentScrollNodeMinHeight");

                var setY = (e.event.y-y)+nodeHeight;

                if( nodeMinHeight && setY < nodeMinHeight && e.event.y<y)return;

                if (setY<this.nodeHeight) setY = this.nodeHeight;

                var setContentY = setY-81;

                if( contentScrollNodeMinHeight && setContentY < contentScrollNodeMinHeight && e.event.y<y )return;

                this.node.setStyle("height", ""+setY+"px");
                this.contentScrollNode.setStyle("height", ""+setContentY+"px");
            }.bind(this)
        });
    },

    createTopNode: function(){
        if (this.options.title){
            if (!this.titleNode) this.titleNode = new Element("div", {"styles": this.css.titleNode, "text": this.options.title}).inject(this.node);
        }

        if( !this.topNode ){
            this.topNode = new Element("div", {"styles": this.css.topNode}).inject(this.node);
        }else{
            this.topNode.empty();
            this.editActionBoxNode = null;
            this.editActionsGroupNode=null;
            this.topNode.setStyle("display","");
            if( this.isHiddenTop ){
                if( this.oldContentScrollNodeHeight && this.contentScrollNode ){
                    this.contentScrollNode.setStyle("min-height",this.oldContentScrollNodeHeight);
                    this.oldContentScrollNodeHeight = null;
                }
                this.isHiddenTop = false;
            }
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        if( hiddenGroup.contains("edit") && hiddenGroup.contains("read") && hiddenGroup.contains("list") && hiddenGroup.contains("view")){
            if(this.contentScrollNode){
                this.oldContentScrollNodeHeight = this.contentScrollNode.getStyle("min-height");
                this.contentScrollNode.setStyle("min-height",this.node.getStyle("min-height"));
                this.topNode.setStyle("display","none");
            }
            this.isHiddenTop = true;
            return;
        }
        if( !hiddenGroup.contains("edit") )this.createEditGroupActions();
        if( !hiddenGroup.contains("read") )this.createReadGroupActions();
        if( !hiddenGroup.contains("list") )this.createListGroupActions();
        if( !hiddenGroup.contains("view") )this.createViewGroupActions();

        //this.topNode = new Element("div", {"styles": this.css.topNode}).inject(this.node);
        //this.createEditGroupActions();
        //this.createReadGroupActions();
        //this.createListGroupActions();
        //this.createViewGroupActions();

        //this.createConfigGroupActions();
    },
    reloadTopNode : function(){
        this.createTopNode();
    },
    createEditGroupActions: function(){
        if(!this.editActionBoxNode)this.editActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        if(!this.editActionsGroupNode)this.editActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.editActionBoxNode);
        this.uploadAction = this.createAction(this.editActionsGroupNode, "upload", o2.LP.widget.upload, function(e, node){
            this.uploadAttachment(e, node);
        }.bind(this));

        this.deleteAction = this.createAction(this.editActionsGroupNode, "delete", o2.LP.widget["delete"], function(e, node){
            this.deleteAttachment(e, node);
        }.bind(this));

        if( !this.options.isReplaceHidden ){
            this.replaceAction = this.createAction(this.editActionsGroupNode, "replace", o2.LP.widget.replace, function(e, node){
                this.replaceAttachment(e, node);
            }.bind(this));
        }

        // this.officeAction = this.createAction(this.editActionsGroupNode, "office", o2.LP.widget.office, function(e, node){
        //     this.openInOfficeControl(e, node);
        // }.bind(this));

        if( !this.options.toolbarGroupHidden.contains("read") )this.editActionSeparateNode = this.createSeparate(this.editActionsGroupNode);
    },

    createReadGroupActions: function(){
        //this.readActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        //this.readActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.readActionBoxNode);
        if(!this.editActionBoxNode)this.editActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
        if(!this.editActionsGroupNode)this.editActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.editActionBoxNode);
        this.downloadAction = this.createAction(this.editActionsGroupNode, "download", o2.LP.widget.download, function(){
            this.downloadAttachment();
        }.bind(this));

        //this.createAction(this.readActionsGroupNode, "share", o2.LP.widget.share, function(){
        //    this.transAttachment();
        //}.bind(this));

        //this.downloadAllAction = this.createAction(this.editActionsGroupNode, "downloadAll", o2.LP.widget.downloadAll, function(){
        //    this.downloadAllAttachment();
        //}.bind(this));

    },
    createListGroupActions: function(){
        var availableListStyles = this.options.availableListStyles;
        if( availableListStyles && availableListStyles.length > 0 ){
            this.listActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
            this.listActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.listActionBoxNode);

            if( availableListStyles.contains("list") ){
                this.listAction = this.createAction(this.listActionsGroupNode, "list", o2.LP.widget.list, function(){
                    this.changeListStyle("list");
                }.bind(this));
            }

            if( availableListStyles.contains("seq") ) {
                this.sequenceAction = this.createAction(this.listActionsGroupNode, "seq", o2.LP.widget.sequence, function () {
                    this.changeListStyle("sequence");
                }.bind(this));
            }

            if( availableListStyles.contains("icon") ) {
                this.iconAction = this.createAction(this.listActionsGroupNode, "icon", o2.LP.widget.icon, function () {
                    this.changeListStyle("icon");
                }.bind(this));
            }

            if( availableListStyles.contains("preview") ) {
                this.previewAction = this.createAction(this.listActionsGroupNode, "preview", o2.LP.widget.preview, function () {
                    this.changeListStyle("preview");
                }.bind(this));
            }
        }

    },

    createViewGroupActions: function(){
        if (this.options.isSizeChange){
            this.viewActionBoxNode = new Element("div", {"styles": this.css.actionsBoxNode}).inject(this.topNode);
            this.viewActionBoxNode.setStyles({"float": "right", "margin-right": "7px"});
            this.viewActionsGroupNode = new Element("div", {"styles": this.css.actionsGroupNode}).inject(this.viewActionBoxNode);
            this.sizeAction = this.createAction(this.viewActionsGroupNode, "min", o2.LP.widget.min, function(){
                this.changeControllerSize();
            }.bind(this));
        }
    },



    createSeparate: function(groupNode){
        var separateNode = new Element("div.separateNode", {"styles": this.css.separateNode}).inject(groupNode);
        return separateNode;
    },
    createAction: function(groupNode, img, title, click){
        var actionNode = new Element("div", {"styles": this.css.actionNode, "title": title}).inject(groupNode);
        var actionIconNode = new Element("div", {"styles": this.css.actionIconNode}).inject(actionNode);
        actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/icon/"+img+".png)");

        var _self = this;
        actionNode.addEvents({
            "mouseover": function(){
                if (!this.retrieve("disabled")) if (!this.retrieve("selected")) this.setStyle("background", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.options.style+"/overbg.png)");
            },
            "mouseout": function(){
                if (!this.retrieve("disabled")) if (!this.retrieve("selected")) this.setStyle("background", "transparent");
            },
            "click": function(e){
                if (!this.retrieve("disabled")) _self.doAction(e, this, click);
                e.stopPropagation();
            }
        });
        this.actions.push(actionNode);
        return actionNode;
    },
    checkActions: function(){
    //    if (this.options.readonly){
    //        this.setReadonly();
    //    }else{
            this.checkUploadAction();
            this.checkDeleteAction();

            this.checkReplaceAction();

            //this.checkOfficeAction();
            this.checkDownloadAction();
            this.checkSizeAction();

            this.checkListStyleAction();
    //    }
    },
    checkUploadAction: function(){
        if (this.options.readonly){
            this.setActionDisabled(this.uploadAction);
            this.setActionDisabled(this.min_uploadAction);
            return false;
        }
        if (!this.options.isUpload){
            this.setActionDisabled(this.uploadAction);
            this.setActionDisabled(this.min_uploadAction);
        }else{
            if (this.options.attachmentCount!=0){
                if (this.attachments.length>=this.options.attachmentCount){
                    this.setActionDisabled(this.uploadAction);
                    this.setActionDisabled(this.min_uploadAction);
                }else{
                    this.setActionEnabled(this.uploadAction);
                    this.setActionEnabled(this.min_uploadAction);
                }
            }else{
                this.setActionEnabled(this.uploadAction);
                this.setActionEnabled(this.min_uploadAction);
            }
        }
    },
    checkDeleteAction: function(){
        if (this.options.readonly){
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
            this.setAttachmentsAction("delete", false );
            return false;
        }
        if (!this.options.isDelete){
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
            this.setAttachmentsAction("delete", false );
        }else{
            if (this.selectedAttachments.length){
                this.setActionEnabled(this.deleteAction);
                this.setActionEnabled(this.min_deleteAction);
            }else{
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
            this.setAttachmentsAction("delete", true );
        }
    },
    isAttDeleteAvailable : function( att ){
        if (this.options.readonly)return false;
        if( this.options.toolbarGroupHidden.contains("edit") )return false;
        return this.options.isDelete;
    },
    // checkOfficeAction: function(){
    //     if (this.officeAction) this.officeAction.setStyle("display", "none");
    //     if (this.min_officeAction) this.min_officeAction.setStyle("display", "none");
    // },
    checkReplaceAction: function(){
        if( this.options.isReplaceHidden )return;
        if (this.options.readonly){
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
            this.setAttachmentsAction("replace", false );
            return false;
        }
        if (!this.options.isReplace){
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
            this.setAttachmentsAction("replace", false );
        }else{
            if (this.selectedAttachments.length && this.selectedAttachments.length==1){
                this.setActionEnabled(this.replaceAction);
                this.setActionEnabled(this.min_replaceAction);
            }else{
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
            this.setAttachmentsAction("replace", true );
        }
    },
    isAttReplaceAvailable : function( att ){
        if (this.options.readonly)return false;
        if( this.options.toolbarGroupHidden.contains("edit") )return false;
        return this.options.isReplace;
    },
    checkDownloadAction: function(){
        if (!this.options.isDownload){
            this.setActionDisabled(this.downloadAction);
            this.setActionDisabled(this.min_downloadAction);
            this.setActionDisabled(this.downloadAllAction);
            this.setAttachmentsAction("download", false );
        }else{
            if (this.selectedAttachments.length){
                this.setActionEnabled(this.downloadAction);
                this.setActionEnabled(this.min_downloadAction);
            }else{
                this.setActionDisabled(this.downloadAction);
                this.setActionDisabled(this.min_downloadAction);
            }
            this.setActionEnabled(this.downloadAllAction);
            this.setAttachmentsAction("download", true );
        }
    },
    isAttDownloadAvailable : function( att ){
        if( this.options.toolbarGroupHidden.contains("read") )return false;
        return this.options.isDownload;
    },
    checkSizeAction: function(){
        if( this.sizeAction ){
            if (this.options.isSizeChange){
                this.setActionEnabled(this.sizeAction);
            }else{
                this.setActionDisabled(this.sizeAction);
            }
        }
    },
    checkListStyleAction: function(){
        switch (this.options.listStyle){
            case "list":
                this.setActionSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "icon":
                this.setActionUnSelcted(this.listAction);
                this.setActionSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "preview":
                this.setActionUnSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionSelcted(this.previewAction);
                this.setActionUnSelcted(this.sequenceAction);
                break;
            case "sequence":
                this.setActionUnSelcted(this.listAction);
                this.setActionUnSelcted(this.iconAction);
                this.setActionUnSelcted(this.previewAction);
                this.setActionSelcted(this.sequenceAction);
                break;
        }
    },
    setActionSelcted: function(action){
        if (action){
            if (!action.retrieve("selected")){
                action.setStyle("background", "url("+o2.session.path+"/widget/$AttachmentController/"+this.options.style+"/selectedbg.png)");
                action.store("selected", true);
            }
        }

    },
    setActionUnSelcted: function(action){
        if (action){
            if (action.retrieve("selected")){
                action.setStyle("background", "");
                action.store("selected", false);
            }
        }
    },

    setActionEnabled: function(action){
        if (action){
            if (action.retrieve("disabled")){
                var iconNode = action.getFirst();
                var icon = iconNode.getStyle("background-image");
                var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
                icon = icon.substr(0, icon.lastIndexOf("_gray"))+"."+ext;
                iconNode.setStyle("background-image", icon);
                action.store("disabled", false);
            }
        }
    },
    setActionDisabled: function(action){
        if (action){
            if (!action.retrieve("disabled")){
                var iconNode = action.getFirst();
                var icon = iconNode.getStyle("background-image");
                var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
                icon = icon.substr(0, icon.lastIndexOf("."))+"_gray."+ext;
                iconNode.setStyle("background-image", icon);
                action.store("disabled", true);
            }
        }
    },
    setReadonly: function() {
        this.actions.each(function(action){
            this.setActionDisabled(action);
            this.setAttachmentsAction("all", false );
        }.bind(this));
    },
    setAttachmentsAction : function(type, enable){
        this.attachments.each( function( att ){
            this.setAttachmentAction( att, type, enable )
        }.bind(this))
    },
    setAttachmentAction : function(att, type, enable){
        var action;
        if( type === "all" ){
            ( att.actions || [] ).each( function(action){
                att[ enable ? "setActionEnabled" : "setActionDisabled" ](action);
            })
        }else{
            switch( type ){
                case "download" :
                    action = att.downloadAction;
                    break;
                case "config" :
                    action = att.configAction;
                    break;
                case "delete" :
                    action = att.deleteAction;
                    break;
                case "replace" :
                    action = att.replaceAction;
                    break;
            }
            if( !action )return;
            if( type === "config" ){
                var flag = enable;
                if( flag ){
                    var user = layout.session.user.distinguishedName;

                    if( !att.data.person && att.data.creatorUid )att.data.person = att.data.creatorUid;

                    if ((!att.data.control.allowControl ) && att.data.person!==user){ //|| !att.data.control.allowEdit
                        flag = false;
                    }
                }
                att[ flag ? "setActionEnabled" : "setActionDisabled" ](action);
            }else{
                att[ enable ? "setActionEnabled" : "setActionDisabled" ](action);
            }
        }
    },

    doAction: function(e, node, action){
        if (action){
            action.apply(this, [e, node]);
        }
    },

    uploadAttachment: function(e, node){
        if (this.module) this.module.uploadAttachment(e, node);
    },
    doUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery){
        if (FormData.expiredIE){
            this.doInputUploadAttachment(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery);
        }else{
            this.doFormDataUploadAttachment(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery);
        }
    },
    addUploadMessage: function(fileName){
        var contentHTML = "";
        contentHTML = "<div style=\"overflow: hidden\"><div style=\"height: 2px; border:0px solid #999; margin: 3px 0px\">" +
            "<div style=\"height: 2px; background-color: #acdab9; width: 0px;\"></div></div>" +
            "<div style=\"height: 20px; line-height: 20px\">"+o2.LP.desktop.action.uploadTitle+"</div></div>" +
            "<iframe name='o2_upload_iframe' style='display:none'></iframe>" ;
        var msg = {
            "subject": o2.LP.desktop.action.uploadTitle,
            "content": fileName+"<br/>"+contentHTML
        };
        if (layout.desktop.message){
            var messageItem = layout.desktop.message.addMessage(msg);
            messageItem.close = function(callback, e){
                if (!messageItem.completed){

                }else{
                    messageItem.closeItem(callback, e);
                }
            };
        }
        window.setTimeout(function(){
            if (layout.desktop.message) if (!layout.desktop.message.isShow) layout.desktop.message.show();
        }.bind(this), 300);

        return messageItem;
    },
    setMessageTitle: function(messageItem, text){
        if (messageItem) messageItem.subjectNode.set("text", text);
    },
    setMessageText: function(messageItem, text){
        if (messageItem){
            var progressNode = messageItem.contentNode.getFirst("div").getFirst("div");
            var progressPercentNode = progressNode.getFirst("div");
            var progressInforNode = messageItem.contentNode.getFirst("div").getLast("div");
            progressInforNode.set("text", text);
            messageItem.dateNode.set("text", (new Date()).format("db"));
        }

    },
    doInputUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, failureEvery){
        var restActions = action;
        if (typeOf(action)=="string"){
            restActions = o2.Actions.get(action).action;
        }
        restActions.getActions(function(){
            var url = restActions.actions[invokeUrl];
            url = restActions.address+url.uri;

            Object.each(parameter, function(v, k){
                url = url.replace("{"+k+"}", v);
            });

            var maskNode = this.module.content;
            if (!maskNode){
                if (this.module.form){
                    maskNode = this.module.form.app.content;
                }
            }
            if (!maskNode) maskNode = this.node;
            //var maskNode = this.module.content || this.module.node;
            if (maskNode){
                maskNode.mask({
                    "style": {
                        "opacity": 0.7,
                        "background-color": "#999"
                    }
                });
            }

            this.inputUploadAreaNode = new Element("div", {"styles": this.css.inputUploadAreaNode}).inject(this.container);
            this.inputUploadAreaNode.position({
                relativeTo: this.module.content,
                position: "center"
            });

            var messageItem = null;
            document.O2UploadCallbackFun = function(str){
                var json = JSON.decode(str);
                messageItem.completed = true;
                if (json.type==="success"){
                    if (every) every(json.data);
                    this.setMessageTitle(messageItem, o2.LP.desktop.action.uploadComplete);
                    this.setMessageText(messageItem, o2.LP.desktop.action.uploadComplete);
                    if(finish) finish();
                }else{
                    //formNode.unmask();
                    // if(failureEvery)failureEvery(json);
                    this.setMessageTitle(messageItem, o2.LP.desktop.action.sendError);
                    this.setMessageText(messageItem, o2.LP.desktop.action.sendError+": "+json.message);
                    o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                }
            }.bind(this);

            var formNode = new Element("form", {
                "method": "POST",
                "action": url+"/callback/window.frameElement.ownerDocument.O2UploadCallbackFun",
                //"action": url,
                "enctype": "multipart/form-data",
                "target": "o2_upload_iframe"
            }).inject(this.inputUploadAreaNode);

            var titleNode = new Element("div", {"styles": this.css.inputUploadAreaTitleNode, "text": o2.LP.widget.uploadTitle}).inject(formNode);
            var inforNode = new Element("div", {"styles": this.css.inputUploadAreaInforNode, "text": o2.LP.widget.uploadInfor}).inject(formNode);
            var inputAreaNode = new Element("div", {"styles": this.css.inputUploadAreaInputAreaNode}).inject(formNode);
            var inputNode = new Element("input", {"name":"file", "type": "file", "styles": this.css.inputUploadAreaInputNode}).inject(inputAreaNode);
            var inputNameNode = new Element("input", {"type": "hidden", "name": "fileName"}).inject(inputAreaNode);

            Object.each(obj, function(v, k){
                new Element("input", {"type": "hidden", "name": k, "value": v}).inject(inputAreaNode);
            });

            var actionNode = new Element("div", {"styles": this.css.inputUploadActionNode}).inject(formNode);
            var cancelButton = new Element("button", {"styles": this.css.inputUploadCancelButton, "text": o2.LP.widget.cancel}).inject(actionNode);
            var okButton = new Element("input", {"type": "button", "styles": this.css.inputUploadOkButton, "value": o2.LP.widget.ok}).inject(actionNode);

            inputNode.addEvent("change", function(){
                var fileName = inputNode.get("value");
                if (fileName){
                    var tmpv = fileName.replace(/\\/g, "/");
                    var i = tmpv.lastIndexOf("/");
                    var fname = (i===-1) ? tmpv : tmpv.substr(i+1, tmpv.length-i);
                    inputNameNode.set("value", fname);
                }
            }.bind(this));

            cancelButton.addEvent("click", function(){
                if (maskNode) maskNode.unmask();
                this.inputUploadAreaNode.destroy();
            }.bind(this));

            okButton.addEvent("click", function(){
                formNode.mask({
                    "style": {
                        "opacity": 0.7,
                        "background-color": "#999"
                    }
                });

                var isContinue = true;
                if (beforeUpload) isContinue = beforeUpload([inputNameNode.get("value")]);
                if (isContinue){
                    messageItem = this.addUploadMessage(inputNameNode.get("value"));
                    formNode.submit();
                    if (maskNode) maskNode.unmask();
                    if (this.inputUploadAreaNode) this.inputUploadAreaNode.destroy();
                }
            }.bind(this));
        }.bind(this));
    },
    doFormDataUploadAttachment: function(obj, action, invokeUrl, parameter, finish, every, beforeUpload, multiple, accept, size, failureEvery){
        if (!this.uploadFileAreaNode){
            this.uploadFileAreaNode = new Element("div");
            var html = "<input name=\"file\" multiple type=\"file\" accept=\"*/*\"/>";
            this.uploadFileAreaNode.set("html", html);

            this.fileUploadNode = this.uploadFileAreaNode.getFirst();
            this.fileUploadNode.addEvent("change", function(){
                var files = this.fileUploadNode.files;
                if (files.length){
                    var count = files.length;
                    var current = 0;
                    var hasFailUpload = false;

                    var restActions = action;
                    if (typeOf(action)=="string"){
                        restActions = o2.Actions.get(action).action;
                    }
                    //var url = restActions.action.actions[invokeUri];

                    var callback = function(){
                        if (current == count){
                            if(finish) finish( hasFailUpload );
                        }
                    };

                    var isContinue = true;
                    if (beforeUpload) isContinue = beforeUpload(files);
                    debugger;
                    if (isContinue){
                        var accepts = (accept) ? accept.split(o2.splitStr) : null;

                        for (var i = 0; i < files.length; i++) {
                            var file = files.item(i);
                            var ext = file.name.substr(file.name.lastIndexOf("."), file.name.length);
                            ext = ext.toLowerCase();
                            if (accepts && (accepts.indexOf(ext)===-1 && accepts.indexOf("*")===-1 && accepts.indexOf("*/*")===-1)){
                                var msg = {
                                    "subject": o2.LP.widget.refuseUpload,
                                    "content": o2.LP.widget.refuseUploadHTML.replace("{filename}", file.name)
                                };
                                if (layout.desktop.message) layout.desktop.message.addTooltip(msg);
                                if (layout.desktop.message) layout.desktop.message.addMessage(msg);
                                var text = o2.LP.widget.refuseUploadNotice.replace("{filename}", file.name);
                                if (o2 && o2.xDesktop && o2.xDesktop.notice) o2.xDesktop.notice("info", {"x": "right", "y": "top"}, text, this.node);
                            }else if (size && file.size> size*1024*1024){
                                var msg = {
                                    "subject": o2.LP.widget.refuseUpload,
                                    "content": o2.LP.widget.refuseUploadHTML_size.replace("{filename}", file.name).replace("{size}", size)
                                };
                                if (layout.desktop.message) layout.desktop.message.addTooltip(msg);
                                if (layout.desktop.message) layout.desktop.message.addMessage(msg);
                                var text = o2.LP.widget.refuseUploadNotice_size.replace("{filename}", file.name).replace("{size}", size);
                                if (o2 && o2.xDesktop && o2.xDesktop.notice) o2.xDesktop.notice("info", {"x": "right", "y": "top"}, text, this.node);
                            }else{
                                var formData = new FormData();
                                Object.each(obj, function(v, k){
                                    formData.append(k, v)
                                });
                                formData.append('file', file);
                                if(parameter.fileMd5){
                                    o2.load("../o2_lib/CryptoJS/components/spark-md5-min.js", function(){

                                        var fileReader = new FileReader(), box = document.getElementById('box');
                                        var blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice;
                                        var chunkSize = 20971520;
                                        // read in chunks of 20MB
                                        var chunks = Math.ceil(file.size / chunkSize), currentChunk = 0, spark = new SparkMD5();

                                        fileReader.onload = function(e) {
                                            console.log("read chunk nr", currentChunk + 1, "of", chunks);
                                            spark.appendBinary(e.target.result);
                                            currentChunk++;

                                            if (currentChunk < chunks) {
                                                loadNext();
                                            } else {
                                                console.log("finished loading");
                                                var fileMd5 = spark.end();

                                                restActions.invoke({
                                                    "name": "checkFileExist",
                                                    "async": true,
                                                    "parameter": {"fileMd5":fileMd5},
                                                    "success": function(json){
                                                        if(json.data.value){
                                                            var formData2 = new FormData();
                                                            formData2.append("fileMd5",fileMd5);
                                                            formData2.append("fileName",file.name);
                                                            restActions.invoke({
                                                                "name": "addAttachmentMd5",
                                                                "async": true,
                                                                "data": formData2,
                                                                "parameter": parameter,
                                                                "success": function(json){
                                                                    current++;
                                                                    if (every) every(json, current, count);
                                                                    callback();
                                                                },
                                                                "failure": function (xhr) {
                                                                    var json = JSON.decode(xhr.responseText);
                                                                    if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                                                    current++;
                                                                    hasFailUpload = true;
                                                                    if (failureEvery) failureEvery(xhr, current, count);
                                                                    callback();
                                                                }
                                                            });
                                                        }else{
                                                            restActions.invoke({
                                                                "name": invokeUrl,
                                                                "async": true,
                                                                "data": formData,
                                                                "file": file,
                                                                "parameter": parameter,
                                                                "success": function(json){
                                                                    current++;
                                                                    if (every) every(json, current, count);
                                                                    callback();
                                                                },
                                                                "failure": function (xhr) {
                                                                    var json = JSON.decode(xhr.responseText);
                                                                    if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                                                    current++;
                                                                    hasFailUpload = true;
                                                                    if (failureEvery) failureEvery(xhr, current, count);
                                                                    callback();
                                                                }
                                                            });
                                                        }

                                                    }
                                                });
                                                // compute hash
                                            }
                                        };

                                        function loadNext() {
                                            var start = currentChunk * chunkSize, end = start + chunkSize >= file.size ? file.size : start + chunkSize;

                                            fileReader.readAsBinaryString(blobSlice.call(file, start, end));
                                        }

                                        loadNext();
                                    }.bind(this),null,false);

                                }else{
                                    restActions.targetModule = {"module": this, "file": file};
                                    restActions.invoke({
                                        "name": invokeUrl,
                                        "async": true,
                                        "data": formData,
                                        "file": file,
                                        "parameter": parameter,
                                        "success": function(json){
                                            current++;
                                            if (every) every(json, current, count);
                                            callback();
                                        },
                                        "failure": function (xhr) {
                                            var json = JSON.decode(xhr.responseText);
                                            if( json && json.message )o2.xDesktop.notice("error", {x: "right", y:"top"}, json.message);
                                            current++;
                                            hasFailUpload = true;
                                            if (failureEvery) failureEvery(xhr, current, count);
                                            callback();
                                        }
                                    });
                                }

                            }
                        }
                    }
                    this.uploadFileAreaNode.destroy();
                    this.uploadFileAreaNode = null;
                }
            }.bind(this));
        }
        this.fileUploadNode.set("accept", accept || "*/*");
        this.fileUploadNode.set("multiple", (multiple!==false));
        this.fileUploadNode.click();
    },

    addFormDataMessage: function(file){
        return this.addAttachmentMessage(file);
    },

    addAttachmentMessage: function(file){
        var messageItem;
        if (this.options.size=="min"){
            messageItem = new o2.widget.AttachmentController.AttachmentMessageMin(file, this);
        }else{
            messageItem = new o2.widget.AttachmentController.AttachmentMessage(file, this);
        }
        if (!this.messageItemList) this.messageItemList = {};
        this.messageItemList[messageItem.data.id] = messageItem;
        return messageItem;
    },

    openInOfficeControl: function(e, node){},
    deleteAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.deleteAttachments(e, node, this.selectedAttachments);
        }
    },
    replaceAttachment: function(e, node){
        if (this.selectedAttachments.length && this.selectedAttachments.length==1){
            if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
        }
    },
    doReplaceAttachment: function(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size){
        if (FormData.expiredIE){
            this.doInputUploadAttachment(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size);
        }else{
            this.doFormDataUploadAttachment(obj, action, invokeUrl, parameter, callback, multiple, accept, accept, size);
        }
    },
    previewAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.previewAttachment(this.selectedAttachments);
        }
    },
    downloadAttachment: function(e, node){
        if (this.selectedAttachments.length){
            if (this.module) this.module.downloadAttachment(e, node, this.selectedAttachments);
        }
    },

    openAttachment: function(e, node, attachment){
        if( !this.options.isDownload )return;
        if (attachment){
            if (this.module) this.module.openAttachment(e, node, attachment);
        }
    },

    downloadAllAttachment: function(e, node){
        if (this.module) this.module.downloadAttachment(e, node, this.attachments);
    },
    changeListStyle: function(style){
        this.options.listStyle = style;
        this.attachments.each(function(attachment){
            attachment.changeListStyle(style);
        }.bind(this));
        this.checkListStyleAction();
    },
    changeControllerSize: function(e, node){
        if (this.options.size=="max"){
            this.changeControllerSizeToMin();
        }else{
            this.changeControllerSizeToMax();
        }
    },

    changeControllerSizeToMin: function(){
        if (this.options.size!="min"){
            if (this.contentScrollNode) this.contentScrollNode.setStyle("display", "none");
            if (this.bottomNode) this.bottomNode.setStyle("display", "none");
            if (this.topNode) this.topNode.setStyle("display", "none");
            if (this.titleNode) this.titleNode.setStyle("display", "none");

            if (!this.nodeMorph) this.nodeMorph = new Fx.Morph(this.node, {"duration": 100});

            this.nodeMorph.start(this.css.container_min).chain(function(){
                this.options.size = "min";
                this.loadMin();
            }.bind(this));
        }
    },
    changeControllerSizeToMax: function(){
        if (this.options.size!="max") {
            if (this.minActionAreaNode) this.minActionAreaNode.setStyle("display", "none");
            if (this.minContent) this.minContent.setStyle("display", "none");

            if (!this.nodeMorph) this.nodeMorph = new Fx.Morph(this.node, {"duration": 100});

            this.nodeMorph.start(this.css.container).chain(function () {
                this.options.size = "max";
                this.loadMax();
            }.bind(this));
        }
    },

    getAttachmentNames: function(){
        var names = [];
        this.attachments.each(function(attachment){
            names.push(attachment.data.name);
        });
        return names;
    },

    addAttachment: function(data, messageId, isCheckPosition){
        if (this.options.size=="min"){
            this.attachments.push(new o2.widget.AttachmentController.AttachmentMin(data, this, messageId, isCheckPosition));
        }else{
            this.attachments.push(new o2.widget.AttachmentController.Attachment(data, this, messageId, isCheckPosition));
        }
        this.checkActions();
    },
    removeAttachment: function(attachment){
        this.attachments.erase(attachment);
        this.selectedAttachments.erase(attachment);
        attachment.node.destroy();
        delete attachment;
    },

    unSelectedAttachments: function(){
        while (this.selectedAttachments.length){
            var attachment = this.selectedAttachments.shift();
            attachment.unSelected();
        }
        this.checkActions();
    },
    clear: function(){
        this.selectedAttachments = [];
        this.attachments.each(function(att){
            att.node.destroy();
            o2.release(att);
        });
        this.attachments = [];
        var content = (this.minContent || this.content);
        if (content) content.empty();
    }

});

o2.widget.AttachmentController.Attachment = new Class({
	Implements: [Events],
	initialize: function(data, controller, messageId, isCheckPosition){
		this.data = data;

        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.content;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.isCheckPosition = isCheckPosition;
        this.actions = [];

        if (messageId && this.controller.messageItemList) {
            this.message = this.controller.messageItemList[messageId];
        }

        this.load();
	},
    _getLnkPar: function(url){
        return {
            "icon": this.getIcon(),
            "title": this.data.name,
            "par": "@url#"+url
        };
    },
    isNumber : function( d ){
        return parseFloat(d).toString() !== "NaN"
    },
    load: function(){
	    if (this.message){
            this.node = new Element("div").inject(this.message.node, "after");
            this.message.node.destroy();
            delete this.controller.messageItemList[this.message.data.id];
        }else{
            this.node = new Element("div").inject(this.content);
        }
	    if( this.isCheckPosition && this.isNumber(this.data.orderNumber) ){
	        var attList = this.controller.attachments;
            for( var i=0; i<attList.length; i++ ){
                var att = attList[i];
                if( !this.isNumber(att.data.orderNumber) || this.data.orderNumber < att.data.orderNumber ){
                    this.node.inject( att.node, "before" );
                    break;
                }
            }
        }

        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.controller.module.getAttachmentUrl(this, function(url){
            this.node.makeLnk({
                "par": this._getLnkPar(url)
            });
        }.bind(this));

        this.createInforNode(function(){
            if (!Browser.Platform.ios){
                this.tooltip = new mBox.Tooltip({
                    content: this.inforNode,
                    setStyles: {content: {padding: 15, lineHeight: 20}},
                    attach: this.node,
                    transition: 'flyin'
                });
            }
        }.bind(this));

        this.setEvent();
    },
    createInforNode: function(callback){
        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.inforNode = new Element("div", {"styles": this.css.attachmentInforNode});
        var html = "<div style='overflow:hidden; font-weight: bold'>"+this.data.name+"</div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploader+": </div><div style='width:120px; float:left; margin-left:10px'>"+( this.data.person || this.data.creatorUid )+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.createTime+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.modifyTime+": </div><div style='width:120px; float:left; margin-left:10px'>"+this.data.lastUpdateTime+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.uploadActivity+": </div><div style='width:120px; float:left; margin-left:10px'>"+(this.data.activityName || o2.LP.widget.unknow)+"</div></div>";
        html += "<div style='clear: both; overflow:hidden'><div style='width:40px; float:left; font-weight: bold'>"+o2.LP.widget.size+": </div><div style='width:120px; float:left; margin-left:10px'>"+size+"</div></div>";
        this.inforNode.set("html", html);

        if (callback) callback();
    },
    getIcon: function(){
        if (!this.data.extension) this.data.extension="unkonw";

        var iconName = this.controller.icons[this.data.extension.toLowerCase()] || this.controller.icons.unknow;
        var iconFolderUrl = this.controller.options.iconFolderUrl ? this.controller.options.iconFolderUrl : "../x_component_File/$Main/default/file/";
        return iconFolderUrl+iconName;
    },

    loadList: function(){
        this.node.setStyles(this.css.attachmentNode_list);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_list_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode_list}).inject(this.node);
        this.textTitleNode = new Element("div", {"styles": this.css.attachmentTextTitleNode_list}).inject(this.textNode);
        this.textTitleNode.set("text", this.data.name);

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.attachmentTextSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", size);

        this.textUploaderNode = new Element("div", {"styles": this.css.attachmentTextUploaderNode_list}).inject(this.textNode);
        this.textUploaderNode.set("text", o2.name.cn(this.data.person || this.data.creatorUid ));

        this.textTimeNode = new Element("div", {"styles": this.css.attachmentTextTimeNode_list}).inject(this.textNode);
        this.textTimeNode.set("text", this.data.lastUpdateTime);

        this.textActivityNode = new Element("div", {"styles": this.css.attachmentTextActivityNode_list}).inject(this.textNode);
        this.textActivityNode.set("text", this.data.activityName || o2.LP.widget.unknow);

        this.custom_List();
    },
    custom_List: function(){},
    loadSequence: function(){
        this.node.setStyles(this.css.attachmentNode_sequence);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_sequence_selected);

        this.sequenceNode = new Element("div", {"styles": this.css.attachmentSeqNode_sequence, "text": (this.seq || 1)}).inject(this.node);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode_sequence}).inject(this.node);
        this.textTitleNode = new Element("div", {"styles": this.css.attachmentTextTitleNode_list}).inject(this.textNode);
        this.textTitleNode.set("text", this.data.name);

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.attachmentTextSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", size);

        this.textUploaderNode = new Element("div", {"styles": this.css.attachmentTextUploaderNode_list}).inject(this.textNode);
        this.textUploaderNode.set("text", o2.name.cn(this.data.person || this.data.creatorUid));

        this.textTimeNode = new Element("div", {"styles": this.css.attachmentTextTimeNode_list}).inject(this.textNode);
        this.textTimeNode.set("text", this.data.lastUpdateTime);

        this.textActivityNode = new Element("div", {"styles": this.css.attachmentTextActivityNode_list}).inject(this.textNode);
        this.textActivityNode.set("text", this.data.activityName || o2.LP.widget.unknow);

        this.custom_Sequence();
    },
    custom_Sequence: function(){},

    loadIcon: function(){
        this.node.setStyles(this.css.attachmentNode_icon);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_icon_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentIconNode}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentIconImgAreaNode}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentIconImgNode}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.attachmentTextNode}).inject(this.node);
        this.textNode.set("text", this.data.name);
        this.custom_Icon();
    },
    custom_Icon: function(){},

    loadPreview: function(){
        this.node.setStyles(this.css.attachmentNode_preview);
        if (this.isSelected) this.node.setStyles(this.css.attachmentNode_preview_selected);

        this.iconNode = new Element("div", {"styles": this.css.attachmentPreviewIconNode}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.attachmentPreviewIconImgAreaNode}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.attachmentPreviewIconImgNode}).inject(this.iconImgAreaNode);

        var icon = this.getIcon();
        if (this.controller.options.images.indexOf(this.data.extension.toLowerCase())!==-1){
            this.controller.module.getAttachmentUrl(this, function(url){
                icon = url;
                this.getPreviewImgSize(icon, function(size){
                    this.iconImgNode.set({"src": icon, "border": 0});

                    this.iconImgAreaNode.setStyles({
                        "width": ""+size.x+"px",
                        "height": ""+size.y+"px"
                    });
                    this.iconImgNode.setStyles({
                        "width": ""+size.x+"px",
                        "height": ""+size.y+"px",
                        "margin-top": ""+size.top+"px"
                    });

                    window.setTimeout(function(){
                        this.getPreviewImgSize(icon, function(size){
                            if (this.iconImgAreaNode) this.iconImgAreaNode.setStyles({
                                "width": ""+size.x+"px",
                                "height": ""+size.y+"px"
                            });
                            if (this.iconImgNode) this.iconImgNode.setStyles({
                                "width": ""+size.x+"px",
                                "height": ""+size.y+"px",
                                "margin-top": ""+size.top+"px"
                            });
                        }.bind(this))
                    }.bind(this), 100);

                }.bind(this));
            }.bind(this));
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            this.textNode.set("text", this.data.name);
        }else if (this.controller.options.audios.indexOf(this.data.extension.toLowerCase())!==-1){
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            this.textNode.set("text", this.data.name);

            this.controller.module.getAttachmentUrl(this, function(url){
                this.iconImgNode.set({"src": icon, "border": 0});
                this.iconAudioNode = new Element("div", {
                    "styles": this.css.attachmentPreviewAudioNode,
                    "html": "<audio preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+url+"\" type=\"audio/mpeg\"></source></audio>"
                    //"html": "<audio controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+o2.session.path+"/xApplication/File/$Main/qnyh.mp3\"></source></audio>"
                }).inject(this.textNode, "after");
                this.iconAudioNode.addEvent("dblclick", function(e){e.stopPropagation();});
            }.bind(this));
        }else if (this.controller.options.videos.indexOf(this.data.extension.toLowerCase())!==-1){
            this.controller.module.getAttachmentUrl(this, function(url){
                this.iconNode.empty();
                this.iconVideoNode = new Element("div", {
                    "styles": this.css.attachmentPreviewVideoNode,
                    //"html": "<video preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+o2.session.path+"/xApplication/File/$Main/IMG_1615.MOV\"></source></video>"
                    "html": "<video preload=\"metadata\" controls=\"controls\" style=\"width: 100%; height: 100%\"><source src=\""+url+"\"></source></video>"
                }).inject(this.iconNode);
                this.iconVideoNode.addEvent("dblclick", function(e){e.stopPropagation();});

                this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
                this.textNode.set("text", this.data.name);
            }.bind(this));
        }else{
            this.iconImgNode.set({"src": icon, "border": 0});
            this.textNode = new Element("div", {"styles": this.css.attachmentPreviewTextNode}).inject(this.node);
            this.textNode.set("text", this.data.name);
        }
        this.custom_Preview();
    },
    custom_Preview: function(){},

    getPreviewImgSize: function(icon, callback){
        var areaSize = this.iconNode.getSize();
        var img = new Element("img", {"src": icon}).inject($(document.body));
        img.set("src", icon);
        var size = img.getSize();
        img.destroy();
        var x, y;
        var zoom = areaSize.x/size.x;
        var y = size.y*zoom;
        if (y<=areaSize.y){
            x = areaSize.x;
        }else{
            zoom = areaSize.y/size.y;
            x = size.x*zoom;
            y = areaSize.y;
        }
        var size = {"x": x, "y": y, "top": (areaSize.y-y)/2};
        if (callback) callback(size);
    },

    setEvent: function(){
        this.node.addEvents({
            "mouseover": function(){if (!this.isSelected) this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),
            "mouseout": function(){if (!this.isSelected) this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),
            "mousedown": function(e){this.selected(e); e.stopPropagation();}.bind(this),
            "click": function(e){e.stopPropagation();}.bind(this),
            "dblclick": function(e){this.openAttachment(e);}.bind(this)
        });
    },

    selected: function(e){
        if (!e.event.ctrlKey) this.controller.unSelectedAttachments();
        //if (!this.isSelected){
        this.controller.selectedAttachments.push(this);
        this.isSelected = true;
        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]);
        //}
        if (e) e.stopPropagation();
        this.controller.checkActions();
    },

    unSelected: function(){
        this.isSelected = false;
        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
        this.controller.selectedAttachments.erase(this);
    },

    changeListStyle: function(style){
        if (this.listStyle!=style){
            this.node.empty();
            switch (style){
                case "list":
                    this.loadList();
                    break;
                case "icon":
                    this.loadIcon();
                    break;
                case "preview":
                    this.loadPreview();
                    break;
                case "sequence":
                    this.loadSequence();
                    break;
            }
            this.listStyle = style;
        }
    },
    reload: function(){
        var node = new Element("div").inject(this.node, "after");

        this.inforNode.destroy();
        this.inforNode = null;
        if (this.tooltip) this.tooltip.destroy();
        this.tooltip = null;

        this.node.destroy();
        delete this.node;
        this.node = node;

        switch (this.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.createInforNode();
        if (!Browser.Platform.ios){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }


        this.setEvent();
    },
    openAttachment: function(e){
	    if( !this.controller.options.isDownload )return;
        if (this.controller.module) this.controller.module.openAttachment(e, null, [this]);
    },
    setActionEnabled: function(action){
        if (action){
            action.setStyle("display","");
            action.store("disabled", false);
            //if (action.retrieve("disabled")){
            //    var iconNode = action.getFirst();
            //    var icon = iconNode.getStyle("background-image");
            //    var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
            //    icon = icon.substr(0, icon.lastIndexOf("_gray"))+"."+ext;
            //    iconNode.setStyle("background-image", icon);
            //    action.store("disabled", false);
            //}
        }
    },
    setActionDisabled: function(action){
        if (action){
            action.setStyle("display","none");
            action.store("disabled", true);
            //if (!action.retrieve("disabled")){
            //    var iconNode = action.getFirst();
            //    var icon = iconNode.getStyle("background-image");
            //    var ext = icon.substr(icon.lastIndexOf(".")+1, icon.length);
            //    icon = icon.substr(0, icon.lastIndexOf("."))+"_gray."+ext;
            //    iconNode.setStyle("background-image", icon);
            //    action.store("disabled", true);
            //}
        }
    },
    createAction: function(node, img, img_over, title, click, text){

        var actionNode;

        if( this.controller.options.actionShowText ){
            actionNode = new Element("div", {"styles": this.controller.css.minActionNode, "text": text || title, "title" : title }).inject(node);

            var _self = this;
            actionNode.addEvents({
                "mouseover": function( e ){
                    if (!this.actionNode.retrieve("disabled") && _self.controller.css.minActionNode_over){
                        actionNode.setStyles( _self.controller.css.minActionNode_over );
                    }
                }.bind( { actionNode : actionNode } ),
                "mouseout": function(){
                    if (!this.actionNode.retrieve("disabled") && _self.controller.css.minActionNode_over ){
                        actionNode.setStyles( _self.controller.css.minActionNode );
                    }
                }.bind( { actionNode : actionNode } ),
                "click": function(e){
                    if (!this.retrieve("disabled")){
                        click.apply(_self.controller, [e, this]);
                        e.stopPropagation();
                    }
                }
            });
        }else{
            actionNode = new Element("div", {"styles": this.controller.css.minActionNode, "title": title}).inject(node);

            var actionIconNode = new Element("div", {"styles": this.controller.css.minActionIconNode}).inject(actionNode);
            actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+this.controller.options.style+"/icon/"+img+".png)");

            var _self = this;
            actionNode.addEvents({
                "mouseover": function( e ){
                    if (!this.actionNode.retrieve("disabled")){
                        this.actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.controller.options.style+"/icon/"+this.img+".png)");
                    }
                }.bind( { actionNode : actionNode, actionIconNode: actionIconNode, img : img_over } ),
                "mouseout": function(){
                    if (!this.actionNode.retrieve("disabled")){
                        this.actionIconNode.setStyle("background-image", "url("+o2.session.path+"/widget/$AttachmentController/"+_self.controller.options.style+"/icon/"+this.img+".png)");
                    }
                }.bind( { actionNode : actionNode, actionIconNode: actionIconNode,  img : img } ),
                "click": function(e){
                    if (!this.retrieve("disabled")){
                        click.apply(_self.controller, [e, this]);
                        e.stopPropagation();
                    }
                }
            });
        }
        if( !this.actions )this.actions = [];
        this.actions.push(actionNode);
        return actionNode;
    }
});

o2.widget.AttachmentController.AttachmentMin = new Class({
    Extends: o2.widget.AttachmentController.Attachment,

    initialize: function(data, controller, messageId, isCheckPosition){
        this.data = data;

        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.content = this.controller.minContent;
        this.isSelected = false;
        this.isCheckPosition = isCheckPosition;
        this.seq = this.controller.attachments.length+1;

        if (messageId && this.controller.messageItemList) {
            this.message = this.controller.messageItemList[messageId];
        }

        this.load();
    },
    load: function(){
        if (this.message){
            this.node = new Element("div").inject(this.message.node, "after");
            this.message.node.destroy();
            delete this.controller.messageItemList[this.message.data.id];
        }else{
            this.node = new Element("div").inject(this.content);
        }

        if( this.isCheckPosition && this.isNumber(this.data.orderNumber) ){
            var attList = this.controller.attachments;
            for( var i=0; i<attList.length; i++ ){
                var att = attList[i];
                if( !this.isNumber(att.data.orderNumber) || this.data.orderNumber < att.data.orderNumber ){
                    this.node.inject( att.node, "before" );
                    break;
                }
            }
        }

        //this.node = new Element("div").inject(this.content);
        //this.loadList();
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.createInforNode();
        if (!Browser.Platform.ios && !layout.mobile){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.iconImgNode,
                transition: 'flyin'
            });
        }
        this.setEvent();
    },
    loadList: function() {
        debugger;
        this.node.setStyles( layout.mobile ? this.css.minAttachmentNode_list_mobile : this.css.minAttachmentNode_list);

        if( !layout.mobile ){
            this.sepNode = new Element("div", {"styles": this.css.minAttachmentSepNode_list}).inject(this.node);
        }

        this.actionAreaNode = new Element("div", {"styles": this.css.minAttachmentActionAreaNode}).inject(this.node);

        if ( this.controller.isAttDownloadAvailable(this) ) {
            this.downloadAction = this.createAction(this.actionAreaNode, "download_single", "download_single_over", o2.LP.widget.download, function (e, node) {
                this.controller.downloadAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.downloadAction );

        if ( this.controller.isAttDeleteAvailable(this) ) {
            this.deleteAction = this.createAction(this.actionAreaNode, "delete_single", "delete_single_over", o2.LP.widget["delete"], function (e, node) {
                this.controller.deleteAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.deleteAction );

        if (this.controller.configAttachment) {
            if ( this.controller.isAttConfigAvailable(this) ) {
                this.configAction = this.createAction(this.actionAreaNode, "config_single", "config_single_over", o2.LP.widget.configAttachment, function (e, node) {
                    this.controller.configAttachment(e, node);
                }.bind(this), o2.LP.widget.configAttachmentText );
                //this.actions.push( this.configAction );
            }
        }

        if (this.isSelected) this.node.setStyles(this.css.minAttachmentNode_list_selected);

        this.iconNode = new Element("div", {"styles": this.css.minAttachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.minAttachmentTextNode_list}).inject(this.node);
        this.textNode.set("text", this.data.name);

        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.minAttachmentSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", "（"+size+"）");

        this.node.set("title",this.data.name + "（"+size+"）");

    },
    loadSequence: function(){
        this.node.setStyles(this.css.minAttachmentNode_sequence);

        this.actionAreaNode = new Element("div", {"styles":this.css.minAttachmentActionAreaNode}).inject(this.node);

        if ( this.controller.isAttDownloadAvailable(this) ) {
            this.downloadAction = this.createAction(this.actionAreaNode, "download_single", "download_single_over", o2.LP.widget.download, function (e, node) {
                this.controller.downloadAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.downloadAction );

        if ( this.controller.isAttDeleteAvailable(this) ) {
            this.deleteAction = this.createAction(this.actionAreaNode, "delete_single", "delete_single_over", o2.LP.widget["delete"], function (e, node) {
                this.controller.deleteAttachment(e, node);
            }.bind(this));
        }
        //this.actions.push( this.deleteAction );


        if (this.controller.configAttachment) {
            if ( this.controller.isAttConfigAvailable(this) ) {
                this.configAction = this.createAction(this.actionAreaNode, "config_single", "config_single_over", MWF.LP.widget.configAttachment, function (e, node) {
                    this.controller.configAttachment(e, node);
                }.bind(this));
                //this.actions.push( this.configAction );
            }
        }

        if (this.isSelected) this.node.setStyles(this.css.minAttachmentNode_list_selected);

        this.sequenceNode = new Element("div", {"styles": this.css.attachmentSeqNode_sequence, "text": (this.seq || 1)}).inject(this.node);
        this.iconNode = new Element("div", {"styles": this.css.minAttachmentIconNode_list}).inject(this.node);
        this.iconImgAreaNode = new Element("div", {"styles": this.css.minAttachmentIconImgAreaNode_list}).inject(this.iconNode);
        this.iconImgNode = new Element("img", {"styles": this.css.minAttachmentIconImgNode_list}).inject(this.iconImgAreaNode);
        this.iconImgNode.set({"src": this.getIcon(), "border": 0});

        this.textNode = new Element("div", {"styles": this.css.minAttachmentTextNode_list}).inject(this.node);
        this.textNode.set("text", this.data.name);
        var size = "";
        var k = this.data.length/1024;
        if (k>1024){
            var m = k/1024;
            m = Math.round(m*100)/100;
            size = m+"M";
        }else{
            k = Math.round(k*100)/100;
            size = k+"K";
        }
        this.textSizeNode = new Element("div", {"styles": this.css.minAttachmentSizeNode_list}).inject(this.textNode);
        this.textSizeNode.set("text", "（"+size+"）");
    },
    setEvent: function(){
        this.node.addEvents({
            "mouseover": function(){
                if (!this.isSelected){
                    if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
                        this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_over"]);
                    }else{
                        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"]);
                    }
                }
            }.bind(this),
            "mouseout": function(){
                if (!this.isSelected){
                    if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
                        var cssKey = "minAttachmentNode_"+this.controller.options.listStyle + ( layout.mobile ? "_mobile" : "" );
                        this.node.setStyles(this.css[cssKey]);
                    }else{
                        this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
                    }
                }
            }.bind(this),
            "mousedown": function(e){this.selected(e);e.stopPropagation();}.bind(this),
            "click": function(e){e.stopPropagation();}.bind(this),
            "dblclick": function(e){this.openAttachment(e);}.bind(this)
        });
    },

    selected: function(e){
        if (!e.event.ctrlKey) this.controller.unSelectedAttachments();
        //if (!this.isSelected){
        this.controller.selectedAttachments.push(this);
        this.isSelected = true;
        if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
            //this.node.setStyles(this.css["minAttachmentNode_list_selected"]);
            this.node.setStyles(this.css["minAttachmentNode_"+this.controller.options.listStyle+"_selected"]);
        }else{
            this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_selected"]);
            //this.node.setStyles(this.css["minAttachmentNode_list_selected"]);
        }

        //}
        if (e) e.stopPropagation();
        this.controller.checkActions();
    },
    reload: function(){
        var node = new Element("div").inject(this.node, "after");

        this.inforNode.destroy();
        this.inforNode = null;
        if (this.tooltip) this.tooltip.destroy();
        this.tooltip = null;

        this.node.destroy();
        delete this.node;
        this.node = node;

        this.loadList();

        this.createInforNode();
        if (!Browser.Platform.ios){
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }

        this.setEvent();
    },
    unSelected: function(){
        this.isSelected = false;
        //this.node.setStyles(this.css["minAttachmentNode_list"]);
        if (this.controller.options.listStyle==="list" || this.controller.options.listStyle==="sequence"){
            var cssKey = "minAttachmentNode_"+this.controller.options.listStyle + ( layout.mobile ? "_mobile" : "" );
            this.node.setStyles(this.css[cssKey]);
        }else{
            this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle]);
        }

        this.controller.selectedAttachments.erase(this);
    }

});

o2.widget.AttachmentController.AttachmentMessage = new Class({
    Extends: o2.widget.AttachmentController.Attachment,
    Implements: [Events],
    initialize: function(file, controller){
        var d = (new Date).format("db");
        var extension = file.name.substring(file.name.lastIndexOf(".")+1, file.name.length);
        this.file = file;
        this.data = {
            activity: "",
            activityName: "",
            activityToken: "",
            activityType: "manual",
            application: "",
            completed: false,
            control: {allowRead:true, allowEdit:false, allowControl:false},
            controllerIdentityList: [],
            controllerUnitList: [],
            createTime: d,
            deepPath: false,
            divisionList: [],
            editIdentityList: [],
            editUnitList: [],
            extension: extension,
            id: (new o2.widget.UUID()).toString(),
            job: "",
            lastUpdatePerson: (layout) ? layout.session.user.name : "",
            lastUpdateTime: d,
            length: file.size,
            name: file.name,
            person: (layout) ? layout.session.user.name : "",
            process: "",
            readIdentityList: [],
            readUnitList: [],
            site: "$doc",
            storage: file.size,
            type: "",
            updateTime: d,
            workCreateTime: ""
        }


        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.content;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.actions = [];
        this.load();
    },
    load: function(){
        this.node = new Element("div").inject(this.content);
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.setEvent();
        this.loadMessage();
    },
    loadMessage: function(){
        var size = this.node.getSize();
        this.node.setStyle("position", "relative");

        this.messageMaskNode = new Element("div", { "styles": this.css.messageMaskNode }).inject(this.node);
        this.messageMaskNode.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px"
        });


        this.messageNode = new Element("div", { "styles": this.css.messageNode }).inject(this.node);
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                this.messageNode.setStyles({
                    "width": "0px",
                    "height": ""+size.y+"px"
                });
                break;
            case "icon":
            case "preview":
                this.messageNode.setStyles({
                    "width": ""+size.x+"px",
                    "height": ""+size.y+"px"
                });
                break;
        }

        this.messageText = new Element("div", {
            "styles": this.css.messageText,
            "text": "0%"
        }).inject(this.node);
        this.messageText.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px",
            "line-height": ""+size.y+"px"
        });
    },
    updateProgress: function(percent){
        var size = this.node.getSize();
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                var w = size.x*(percent/100);
                this.messageNode.setStyles({
                    "width":""+w+"px"
                });
                break;
            case "icon":
            case "preview":
                var h = size.y*(1-percent/100);
                this.messageNode.setStyle("height", ""+h+"px");
                break;
        }

        var p = (percent*100).toInt()/100;
        this.messageText.set("text", ""+p+"%")
    },
    transferComplete: function(){
        this.messageText.set("text", "loading...")
    }
});
o2.widget.AttachmentController.AttachmentMessageMin = new Class({
    Extends: o2.widget.AttachmentController.AttachmentMin,
    Implements: [Events],
    initialize: function(file, controller){
        var d = (new Date).format("db");
        var extension = file.name.substring(file.name.lastIndexOf(".")+1, file.name.length);
        this.file = file;
        this.data = {
            activity: "",
            activityName: "",
            activityToken: "",
            activityType: "manual",
            application: "",
            completed: false,
            control: {allowRead:true, allowEdit:false, allowControl:false},
            controllerIdentityList: [],
            controllerUnitList: [],
            createTime: d,
            deepPath: false,
            divisionList: [],
            editIdentityList: [],
            editUnitList: [],
            extension: extension,
            id: (new o2.widget.UUID()).toString(),
            job: "",
            lastUpdatePerson: (layout) ? layout.session.user.name : "",
            lastUpdateTime: d,
            length: file.size,
            name: file.name,
            person: (layout) ? layout.session.user.name : "",
            process: "",
            readIdentityList: [],
            readUnitList: [],
            site: "$doc",
            storage: file.size,
            type: "",
            updateTime: d,
            workCreateTime: ""
        }


        if( !this.data.person && this.data.creatorUid )this.data.person = this.data.creatorUid;

        this.controller = controller;
        this.css = this.controller.css;
        this.listStyle = this.controller.options.listStyle;
        this.content = this.controller.minContent;
        this.isSelected = false;
        this.seq = this.controller.attachments.length+1;
        this.actions = [];
        this.load();
    },
    load: function(){
        this.node = new Element("div").inject(this.content);
        switch (this.controller.options.listStyle){
            case "list":
                this.loadList();
                break;
            case "icon":
                this.loadIcon();
                break;
            case "preview":
                this.loadPreview();
                break;
            case "sequence":
                this.loadSequence();
                break;
        }

        this.setEvent();
        this.loadMessage();
    },
    loadMessage: function(){
        var size = this.node.getSize();
        this.node.setStyle("position", "relative");

        this.messageMaskNode = new Element("div", { "styles": this.css.messageMaskNode }).inject(this.node);
        this.messageMaskNode.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px"
        });


        this.messageNode = new Element("div", { "styles": this.css.messageNode }).inject(this.node);
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                this.messageNode.setStyles({
                    "width": "0px",
                    "height": ""+size.y+"px"
                });
                break;
            case "icon":
            case "preview":
                this.messageNode.setStyles({
                    "width": ""+size.x+"px",
                    "height": ""+size.y+"px"
                });
                break;
        }

        this.messageText = new Element("div", {
            "styles": this.css.messageText,
            "text": "0%"
        }).inject(this.node);
        this.messageText.setStyles({
            "width": ""+size.x+"px",
            "height": ""+size.y+"px",
            "line-height": ""+size.y+"px"
        });
    },
    updateProgress: function(percent){
        var size = this.node.getSize();
        switch (this.controller.options.listStyle){
            case "list":
            case "sequence":
                var w = size.x*(percent/100);
                this.messageNode.setStyles({
                    "width":""+w+"px"
                });
                break;
            case "icon":
            case "preview":
                var h = size.y*(1-percent/100);
                this.messageNode.setStyle("height", ""+h+"px");
                break;
        }

        var p = (percent*100).toInt()/100;
        this.messageText.set("text", ""+p+"%")
    },
    transferComplete: function(){
        this.messageText.set("text", "loading...")
    }
});

MWF.xScript = MWF.xScript || {};
MWF.xScript.CMSMacro = MWF.CMSMacro = {
    "swapSpace": {},

    expression: function(code, bind){},
    runEvent: function(code, bind, arg){},

    exec: function(code, bind){
        var returnValue;
        if (!bind) bind = window;
        if (o2.session.isDebugger){
            try {
                var f = eval("(function(){return function(){\n"+code+"\n}})();");
                returnValue = f.apply(bind);
            }catch(e){
                console.log(o2.LP.script.error);
                if (code.length>500){
                    var t = code.substr(0,500)+"\n...\n";
                    console.log(t);
                }else{
                    console.log(code);
                }
                console.log(e);
            }
        }else{
            try {
                var f = eval("(function(){return function(){\n"+code+"\n}})();");
                returnValue = f.apply(bind);
            }catch(e){
                console.log(o2.LP.script.error);
                if (code.length>500){
                    var t = code.substr(0,500)+"\n...\n";
                    console.log(t);
                }else{
                    console.log(code);
                }
                console.log(e);
            }
        }
        return returnValue;
    }
};

MWF.CMSMacro.CMSFormContext = new Class({
    macroFunction: null,
    environment: {},

    initialize: function(form){
        this.form = form;
        var environment = {
            "form": form,
            "forms": form.forms,
            "all": form.all,
            "data": form.businessData.data,
            "document": form.businessData.document,
            "control": form.businessData.control,
            "attachmentList": form.businessData.attachmentList,
            "status": form.businessData.status,
            "formInfor": form.businessData.formInfor,
            "target": null,
            "event": null
        };
        MWF.require("MWF.xScript.CMSEnvironment", null, false);
        this.environment = new MWF.xScript.CMSEnvironment(environment);
    },
    setTarget: function(target){
        if (target){
            this.environment.target = target;
        }else{
            this.environment.target = null;
        }
    },
    setEvent: function(event){
        if (event){
            this.environment.event = event;
        }else{
            this.environment.event = null;
        }
    },
    exec: function(code, target){
        this.setTarget(target);
        var returnValue = MWF.CMSMacro.exec(code, this.environment);
        //this.form.businessData.data = Object.merge(this.form.businessData.data, this.environment.data);

        return returnValue;
        //this.environment.data

    },
    fire: function(code, target, event){
        this.setTarget(target);
        this.setEvent(event);
        return MWF.CMSMacro.exec(code, this.environment);
    }


});

if( !MWF.CMSMacro.ViewContext ){
    MWF.CMSMacro.ViewContext = new Class({
        macroFunction: null,
        environment: {},
        initialize: function(view){
            this.form = view;
            var environment = {
                "view": view,
                "viewInfor": view.viewInfor,
                "target": null,
                "event": null
            };
            MWF.require("MWF.xScript.ViewEnvironment", null, false);
            this.environment = new MWF.xScript.ViewEnvironment(environment);
        },
        setTarget: function(target){
            if (target){
                this.environment.target = target;
            }else{
                this.environment.target = null;
            }
        },
        setEvent: function(event){
            if (event){
                this.environment.event = event;
            }else{
                this.environment.event = null;
            }
        },
        exec: function(code, target){
            this.setTarget(target);
            var returnValue = MWF.CMSMacro.exec(code, this.environment);
            //this.form.businessData.data = Object.merge(this.form.businessData.data, this.environment.data);

            return returnValue;
            //this.environment.data

        },
        fire: function(code, target, event){
            this.setTarget(target);
            this.setEvent(event);
            return MWF.CMSMacro.exec(code, this.environment);
        }
    });
}


JSONObject = function(o){

};
o2.widget = o2.widget || {};
o2.widget.Tab = new Class({
	Implements: [Options, Events],
    Extends: o2.widget.Common,
	options: {
		"style": "default"
	},
	initialize: function(container, options){
		this.setOptions(options);
		this.pages = [];

		this.path = o2.session.path+"/widget/$Tab/";
		this.cssPath = o2.session.path+"/widget/$Tab/"+this.options.style+"/css.wcss";
		this._loadCss();
        this.css = Object.clone(this.css);
		this.showPage = null;

		this.node = $(container);
	},
	load: function(){
		if (this.fireEvent("queryLoad")){

			if (!this.tabNodeContainer) this.tabNodeContainer = new Element("div");
			this.tabNodeContainer.set("styles", this.css.tabNodeContainer);
			this.tabNodeContainer.inject(this.node);

			if (!this.tabNodeContainerRight) this.tabNodeContainerRight = new Element("div.tabNodeContainerRight");
            this.tabNodeContainerRight.set("styles", this.css.tabNodeContainerRight);
            this.tabNodeContainerRight.inject(this.tabNodeContainer);

            if (!this.tabNodeContainerLeft) this.tabNodeContainerLeft = new Element("div.tabNodeContainerLeft");
            this.tabNodeContainerLeft.set("styles", this.css.tabNodeContainerLeft);
            this.tabNodeContainerLeft.inject(this.tabNodeContainer);

            if (!this.tabNodeContainerArea) this.tabNodeContainerArea = new Element("div.tabNodeContainerArea");
            this.tabNodeContainerArea.set("styles", this.css.tabNodeContainerArea);
            this.tabNodeContainerArea.inject(this.tabNodeContainerLeft);


			if (!this.contentNodeContainer) this.contentNodeContainer = new Element("div");
			this.contentNodeContainer.set("name", "MWFcontentNodeContainer");
			this.contentNodeContainer.set("styles", this.css.contentNodeContainer);
			this.contentNodeContainer.inject(this.node);

            this.tabNodeContainerRight.addEvents({
                "mouseover": function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight_over)}.bind(this),
                "mouseout": function(){this.tabNodeContainerRight.setStyles(this.css.tabNodeContainerRight)}.bind(this)
            });

            o2.require("o2.xDesktop.Menu", function(){
                this.tabMenu = new o2.xDesktop.Menu(this.tabNodeContainerRight, {
                    "style": "tab",
                    "event": "click",
                    "container": this.tabNodeContainerRight,
                    "where": {"x": "right", "y": "bottom"},
                    "onQueryShow": function(){
                        this.loadOverMenu();
                    }.bind(this)
                });
                this.tabMenu.load();
            }.bind(this));
            this.tabNodeContainerRight.hide();
			
			this.fireEvent("postLoad");
		}
	},
	rebuildTab: function(contentAreaNode,contentNode, pageNode){

		var tabPage = new o2.widget.TabPage(contentNode, "", this, {"isClose": false});
		
		tabPage.contentNodeArea = contentAreaNode;
		tabPage.tabNode = pageNode;
		tabPage.textNode = pageNode.getFirst();
		tabPage.closeNode = tabPage.textNode.getFirst();
		tabPage.options.title = tabPage.textNode.get("text");
		
		tabPage.load();
		this.pages.push(tabPage);
		return tabPage;
		
	},
	addTab: function(node, title, isclose, pageNode){
		var tabPage = new o2.widget.TabPage(node, title, this, {"isClose": isclose, "tabNode": pageNode});
		tabPage.load();
		this.pages.push(tabPage);
		return tabPage;
	},
    loadOverMenu: function(e){
        this.tabMenu.clearItems();
        var _self = this;
		for (var n=this.showTabIndex; n<this.pages.length; n++){
			var page = this.pages[n];
            var menuItem = this.tabMenu.addMenuItem(page.options.title || page.tabNode.get("text"), "click", function(){
				_self.showOverPage(this);
			});
            menuItem.tabPage = page;
		}
	},
    showOverPage: function(item){
		var page = item.tabPage;
		if (page){
            this.pages.erase(page);
            this.pages.unshift(page);
            page.tabNode.inject(this.tabNodeContainerArea, "top");
            page.showTabIm();
            this.resize();
		}
	},

    resize: function(){
		var size = this.tabNodeContainerLeft.getSize();
		var tabWidth = 0;
        for (var i=0; i<this.pages.length; i++){
            var tabSize = this.pages[i].tabNode.getSize();
            tabWidth += tabSize.x;
            if (tabWidth>size.x) break;
		}
        this.showTabIndex = i;
		if (tabWidth>size.x && i<this.pages.length){
            this.tabNodeContainerRight.show();
		}else{
            this.tabNodeContainerRight.hide();
		}
	}

});

o2.widget.TabPage = new Class({
	Implements: [Options, Events],
	options: {
		"isClose": true,
		"tabNode": null,
		"title": ""
	},

	initialize: function(node, title, tab, options){
		this.setOptions(options);
		this.options.title = title;
		this.tab = tab;
		this.contentNode = $(node);
	},
	load: function(){
		if (!this.contentNodeArea) this.contentNodeArea = new Element("div");
		this.contentNodeArea.set("styles", this.tab.css.contentNodeArea);
		
		if (!this.tabNode) this.tabNode = new Element("div");
		this.tabNode.set("styles", this.tab.css.tabNode);
		this.tabNode.addEvent("mousedown", function(event){event.stop();});
		
		if (!this.textNode) this.textNode = new Element("div").inject(this.tabNode);
		this.textNode.set({
			"styles": this.tab.css.tabTextNode,
			"text": this.options.title
		});
		this.tabNode.addEvent("click", this._showTab.bind(this));

		if (this.options.isClose){
			if (!this.closeNode) this.closeNode = new Element("div").inject(this.tabNode);
			this.closeNode.set({
				"styles": this.tab.css.tabCloseNode
			});
			this.closeNode.addEvent("click", this.closeTab.bind(this));
		}
		
		this.contentNodeArea.inject(this.tab.contentNodeContainer);
		this.tabNode.inject(this.tab.tabNodeContainerArea);
		this.contentNode.inject(this.contentNodeArea);

		this.tab.resize();
	},
	_showTab: function(){
		this.showTabIm();
	},
	showTabIm: function(callback){
		if (!this.isShow){
			// if (!this.tabNode.isIntoView()){
             //    this.tab.pages.erase(this);
             //    this.tab.pages.unshift(this);
             //    this.tabNode.inject(this.tab.tabNodeContainerArea, "top");
             //    this.tab.resize();
			// }
			this.tab.pages.each(function(page){
				if (page.isShow) page.hideIm();
			});
			this.showIm(callback);
		}
	},
	showTab: function(callback){
		if (!this.isShow){
			this.tab.pages.each(function(page){
				if (page.isShow) page.hide();
			});
			this.show(callback);
		}
	},
	showIm: function(callback){
		this.fireEvent("queryShow");
		this.tabNode.setStyle("display","");
		this.tabNode.set("styles", this.tab.css.tabNodeCurrent);
		this.textNode.set("styles", this.tab.css.tabTextNodeCurrent);
		if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNodeCurrent);
		
		this.contentNodeArea.setStyle("display", "block");
		this.contentNodeArea.setStyle("opacity", 1);
		
		this.isShow = true;
		this.tab.showPage = this;
		if (callback) callback();
		this.fireEvent("show");
		this.fireEvent("postShow");
	},
	show: function(callback){
		this.fireEvent("queryShow");
		this.tabNode.setStyle("display","");
		this.tabNode.set("styles", this.tab.css.tabNodeCurrent);
		this.textNode.set("styles", this.tab.css.tabTextNodeCurrent);
		if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNodeCurrent);
		
		this.contentNodeArea.setStyle("display", "block");
		this.contentNodeArea.setStyle("opacity", 1);
		if (!this.morph){
			this.morph = new Fx.Morph(this.contentNodeArea, {duration: 100});
		}
		this.morph.start({
			"opacity": 1
		}).chain(function(){
			this.isShow = true;
			this.tab.showPage = this;
			if (callback) callback();
			this.fireEvent("postShow");
		}.bind(this));
		this.fireEvent("show");
	},
	hideIm: function(){
		if (this.isShow){
			this.fireEvent("queryHide");
			this.tabNode.set("styles", this.tab.css.tabNode);
			this.textNode.set("styles", this.tab.css.tabTextNode);
			if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNode);
		
			this.contentNodeArea.setStyle("display", "none");
			this.contentNodeArea.setStyle("opacity", 0);

			this.isShow = false;
			this.fireEvent("hide");
			this.fireEvent("postHide");
		}
	},
	hide: function(){
		if (this.isShow){
			this.fireEvent("queryHide");
			this.tabNode.set("styles", this.tab.css.tabNode);
			this.textNode.set("styles", this.tab.css.tabTextNode);
			if (this.closeNode) this.closeNode.set("styles", this.tab.css.tabCloseNode);
		
			if (!this.morph){
				this.morph = new Fx.Morph(this.contentNodeArea, {duration: 100});
			}
			this.morph.start({
				"opacity": 0
			}).chain(function(){

				this.contentNodeArea.setStyle("display", "none");
				this.isShow = false;
				this.fireEvent("postHide");
			}.bind(this));
			this.fireEvent("hide");
		}
	},
	enableTab : function( notShow ){
		this.disabled = false;
		if( notShow ){
			this.tabNode.show();
		}else{
			this.showTab();
		}
	},
	disableTab : function( notShowSibling ){
		this.disabled = true;
		this.hideTab( notShowSibling );
	},
	hideTab: function( notShowSibling ){
		this.fireEvent("queryHide");
		this.tabNode.hide();
		this.contentNodeArea.hide();
		var tmp = [];

		if( !notShowSibling ){
			var prevPage = this.getPrevPage();
			if (prevPage && !prevPage.disabled){
				prevPage.showTab();
			}else{
				if (this.tab.pages.length){
					for( var i=0; i<this.tab.pages.length;  i++ ){
						var page = this.tab.pages[i];
						if( !page.disabled ){
							page.showTab();
							break;
						}
					}
					//this.tab.pages[this.tab.pages.length-1].showTab();
				}
			}
		}
		this.isShow = false;
		this.fireEvent("hide");
	},
	closeTab: function(){
        this.fireEvent("queryClose");
		var prevPage = this.getPrevPage();
		this.contentNodeArea.destroy();
		this.tabNode.destroy();
		var tmp = [];
		
		this.tab.pages = this.tab.pages.erase(this);
		
//		this.tab.pages.each(function(item){
//			if (item!=this){
//				tmp.push(item);
//			}
//		});
//		this.tab.pages = tmp;
		
		if (prevPage && !prevPage.disabled){
			prevPage.showTab();
		}else{
			if (this.tab.pages.length){
				for( var i=0; i<this.tab.pages.length;  i++ ){
					var page = this.tab.pages[i];
					if( !page.disabled ){
						page.showTab();
						break;
					}
				}
			}
			//if (this.tab.pages.length) this.tab.pages[this.tab.pages.length-1].showTab();
		}
		this.fireEvent("close");
	},
	getPrevPage: function(){
		var idx = this.tab.pages.indexOf(this);
		var prevIdx = idx-1;
		if (prevIdx<0){
			return null;
		}else{
			return this.tab.pages[prevIdx];
		}
	}
});
o2.widget = o2.widget || {};
o2.require("o2.widget.Common", null, false);
o2.require("o2.xDesktop.Common", null, false);
o2.require("o2.xDesktop.Actions.RestActions", null, false);
o2.widget.O2Identity = new Class({
	Implements: [Options, Events],
	Extends: o2.widget.Common,
	options: {
		"style": "default",
        "canRemove": false,
        "lazy": false,
        "disableInfor" : false
	},
	initialize: function(data, container, options){

		this.setOptions(options);
		this.loadedInfor = false;

		this.path = o2.session.path+"/widget/$O2Identity/";
		this.cssPath = o2.session.path+"/widget/$O2Identity/"+this.options.style+"/css.wcss";
		this._loadCss();

        this.container = $(container);
        this.data = data;
        this.style = this.css;

        this.action = new o2.xDesktop.Actions.RestActions("", "x_organization_assemble_control", "x_component_Org");
        // this.explorer = explorer;
        // this.removeAction = removeAction;
        this.load();

        //o2.widget.O2Identity.iditems.push(this);
	},
    setText: function(){
	    var disply;
	    if( this.data.displayName ){
            disply = this.data.displayName;
        }else{
	        var name = this.data.name || o2.name.cn(this.data.distinguishedName);
	        var unit;
            if(this.data.unitName){
                unit = this.data.unitName;
            }else if( this.data.unitLevelName ){
                var list = this.data.unitLevelName.split("/");
                unit = list[ list.length - 1 ];
            }
            disply = name + (unit ? "("+unit+")" : "")
        }
        this.node.set("text", this.data.displayName || disply );
    },
    load: function(){
        var style = ( layout.mobile && this.style.identityNode_mobile ) ?
            this.style.identityNode_mobile : this.style.identityNode;

        if (!this.options.lazy && !this.options.disableInfor) this.getPersonData();
        this.node = new Element("div", {"styles": style }).inject(this.container);
        this.setText();

        if (this.options.canRemove){
            this.removeNode = new Element("div", {"styles": this.style.identityRemoveNode}).inject(this.node);
            this.removeNode.addEvent("click", function(e){
                this.fireEvent("remove", [this, e]);
                e.stopPropagation();
            }.bind(this));
        }

        if( !this.options.disableInfor && !layout.mobile){
            if (!this.options.lazy ){
                this.createInforNode(function(){
                    this.fireEvent("loadedInfor", [this]);
                }.bind(this));
            }else{
                this.node.addEvents({
                    "mouseover": function(){
                        if (!this.loadedInfor){
                            this.getPersonData();
                            this.createInforNode(function(){
                                this.fireEvent("loadedInfor", [this]);
                            }.bind(this));
                        }
                    }.bind(this)
                });
            }
        }
        this.setEvent();
        if( !layout.mobile ){
            this.node.addEvents({
                "mouseover": function(){

                    // var style_over = ( layout.mobile && this.style.identityNode_over_mobile ) ?
                    //     this.style.identityNode_over_mobile : this.style.identityNode_over;

                    this.node.setStyles( this.style.identityNode_over ); //style_over
                }.bind(this),
                "mouseout": function(){

                    // var style = ( layout.mobile && this.style.identityNode_mobile ) ?
                    //     this.style.identityNode_mobile : this.style.identityNode;

                    this.node.setStyles( this.style.identityNode ); //style
                }.bind(this)
            });
        }
    },
    setEvent: function(){
	    if( this.open ){
            this.node.addEvents({
                "click": function(ev){
                    this.open(ev);
                    ev.stopPropagation();
                }.bind(this)
            });
        }
    },
    getPersonData: function(){
        if (!this.data.dutys){
            var action = o2.Actions.get("x_organization_assemble_control");
            var id = this.data.distinguishedName || this.data.id || this.data.unique;
            if (id) action.listUnitdutyByIdentity(id, function(json){
                this.data.dutys = json.data;
            }.bind(this), null, false);
        }

        if (!this.data.woPerson){
            // var uri = "/jaxrs/person/{flag}";
            // //uri = uri.replace("{flag}", this.data.person);
            // var uriIdentity = "/jaxrs/identity/{id}";
            this.action.actions = {
                "getPerson": {"uri": "/jaxrs/person/{flag}"},
                "getIdentity": {"uri": "/jaxrs/identity/{id}"}
            };
            var woPerson;
            if (this.data.person){
                this.action.invoke({"name": "getPerson", "async": false, "parameter": {"flag": this.data.person}, "success": function(json){
                    this.data.woPerson = woPerson;
                    woPerson = json.data;
                }.bind(this)});
            }else{
                this.action.invoke({"name": "getIdentity", "async": false, "parameter": {"id": this.data.id || this.data.name}, "success": function(json){
                    this.data = json.data;
                    woPerson = json.data.woPerson;
                }.bind(this)});
            }

            return woPerson;
        }else{
            return this.data.woPerson;
        }


        //listDutyNameWithIdentity
    },
    createInforNode: function(callback){
        var person = this.getPersonData();
        if (person){
            this.inforNode = new Element("div", {
                "styles": this.style.identityInforNode
            });
            var nameNode = new Element("div", {
                "styles": this.style.identityInforNameNode
            }).inject(this.inforNode);

            var uri = "/jaxrs/person/{flag}/icon";
            uri = uri.replace("{flag}", person.id || person.unique || person.distinguishedName );
            this.action.getAddress();
            uri = this.action.address+uri;

            uri = o2.filterUrl(uri);

            img = "<img width='50' height='50' border='0' src='"+uri+"' style='border-radius:25px'/>";

            var picNode = new Element("div", {
                "styles": this.style.identityInforPicNode,
                "html": img
            }).inject(nameNode);
            var rightNode = new Element("div", {
                "styles": this.style.identityInforRightTextNode
            }).inject(nameNode);
            var nameTextNode = new Element("div", {
                "styles": this.style.identityInforNameTextNode,
                "text": person.name
            }).inject(rightNode);
            var employeeTextNode = new Element("div", {
                "styles": this.style.identityInforEmployeeTextNode,
                "text": person.employee || ""
            }).inject(rightNode);

            // var phoneNode = new Element("div", {
            //     "styles": this.style.identityInforPhoneNode,
            //     "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.personMobile+": </div><div style='width:90px; float:left; margin-left:10px'>"+(person.mobile || "")+"</div>"
            // }).inject(this.inforNode);
            // var mailNode = new Element("div", {
            //     "styles": this.style.identityInforPhoneNode,
            //     "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.personMail+": </div><div style='width:90px; float:left; margin-left:10px'>"+(person.mail || "")+"</div>"
            // }).inject(this.inforNode);

            var dutys = [];
            if (this.data.dutys && this.data.dutys.length){
                this.data.dutys.each(function(d){
                    var n = d.name+"("+d.woUnit.levelName+")";
                    dutys.push(n);
                });
            }
            var dutyNode = new Element("div", {
                "styles": this.style.identityInforPhoneNode,
                "html": "<div style='width:30px; float:left'>"+o2.LP.desktop.person.duty+": </div><div style='width:160px; float:left; margin-left:10px'>"+(dutys.join(","))+"</div>"
            }).inject(this.inforNode);

            this.loadedInfor = true;
            this.tooltip = new mBox.Tooltip({
                content: this.inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: this.node,
                transition: 'flyin'
            });
        }
        if (callback) callback();
    },
    destroy: function(){
        if (this.tooltip) this.tooltip.destroy();
        this.node.destroy();
        o2.release(this);
    }
});
// o2.widget.Person = new Class({
//     Implements: [Options, Events],
//     Extends: o2.widget.Identity,
//     getPerson: function(callback){
//         if (this.data.name && this.data.id){
//             if (callback) callback({"data": this.data});
//         }else{
//             var key = this.data.name;
//             this.explorer.actions["getPerson"](function(json){
//                 if (callback) callback(json);
//             }, null, key);
//         }
//     }
// });

o2.widget.O2Person = new Class({
    Extends: o2.widget.O2Identity,
    getPersonData: function(){
        if (!this.data.distinguishedName){
            this.action.actions = {"getPerson": {"uri": "/jaxrs/person/{id}"}};
            this.action.invoke({"name": "getPerson", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
                var dutyList = [];
                if( this.data.woIdentityList && this.data.woIdentityList.length ){
                    this.data.woIdentityList.each(function (id) {
                        if(id.woUnitDutyList && id.woUnitDutyList.length)dutyList = dutyList.concat(id.woUnitDutyList);
                    })
                }
                this.data.dutys = dutyList;
            }.bind(this)});
        }
        return this.data;
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    }
});
o2.widget.O2Unit = new Class({
    Extends: o2.widget.O2Identity,
    getPersonData: function(){
        if (!this.data.distinguishedName || !this.data.levelName){
            this.action.actions = {"getUnit": {"uri": "/jaxrs/unit/{id}"}};
            this.action.invoke({"name": "getUnit", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.levelName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    }
});
o2.widget.O2Duty = new Class({
    Extends: o2.widget.O2Identity,
    getPersonData: function(){
        return this.data;
        // if (!this.data.woUnit){
        //     this.action.actions = {"getUnitduty": {"uri": "/jaxrs/unitduty/{id}"}};
        //     this.action.invoke({"name": "getUnitduty", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
        //         this.data = json.data;
        //     }.bind(this)});
        // }
    },
    createInforNode: function(){
        return false;
        // this.inforNode = new Element("div", {
        //     "styles": this.style.identityInforNode
        // });
        // var nameNode = new Element("div", {
        //     "styles": this.style.identityInforNameNode,
        //     "text": this.data.woUnit.levelName
        // }).inject(this.inforNode);
        // this.tooltip = new mBox.Tooltip({
        //     content: this.inforNode,
        //     setStyles: {content: {padding: 15, lineHeight: 20}},
        //     attach: this.node,
        //     transition: 'flyin'
        // });
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    }
});
o2.widget.O2Group = new Class({
    Extends: o2.widget.O2Unit,
    getPersonData: function(){
        if (!this.data.distinguishedName){
            this.action.actions = {"getGroup": {"uri": "/jaxrs/group/{id}"}};
            this.action.invoke({"name": "getGroup", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    setText: function(){
        this.node.set("text", this.data.displayName || this.data.name);
    },
    createInforNode: function(){
        return false;
    }
});
o2.widget.O2Application = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            this.action = new o2.xDesktop.Actions.RestActions("", "x_processplatform_assemble_surface", "");
            this.action.actions = {"getApplication": {"uri": "/jaxrs/application/{id}"}};
            this.action.invoke({"name": "getApplication", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    }
});
o2.widget.O2CMSApplication = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            o2.Actions.get("x_cms_assemble_control").getApplication((this.data.id || this.data.name), function(json){
                this.data = json.data;
            }.bind(this), null, false);
            // this.action = new o2.xDesktop.Actions.RestActions("", "x_cms_assemble_control", "");
            // this.action.actions = {"getApplication": {"uri": "/jaxrs/application/{id}"}};
            // this.action.invoke({"name": "getApplication", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
            //     this.data = json.data;
            // }.bind(this)});
        }
    }
});



o2.widget.O2Process = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            this.action = new o2.xDesktop.Actions.RestActions("", "x_processplatform_assemble_surface", "");
            this.action.actions = {"getProces": {"uri": "/jaxrs/process/{id}/complex"}};
            this.action.invoke({"name": "getProces", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.name || this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        debugger;
        if( this.data.id && this.data.application ){
            var appId = "process.ProcessManager" + this.data.application;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = { "application": {
                    "id": this.data.application,
                     "name": this.data.applicationName || ""
                }};
                layout.desktop.openApplication(e, "process.ProcessManager", options);
            }
        }
    }
});
o2.widget.O2CMSCategory = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.name){
            o2.Actions.get("x_cms_assemble_control").getCategory((this.data.id || this.data.name), function(json){
                this.data = json.data;
            }.bind(this), null, false);
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        debugger;
        if( this.data.id && this.data.appId ){
            // var appId = "cms.ColumnManager" + this.data.id;
            // if (layout.desktop.apps[appId]){
            //     layout.desktop.apps[appId].setCurrent();
            // }else {
                var options = {
                    "navi":"categoryConfig",
                    "column":{
                        "id" : this.data.appId,
                        "appName": this.data.appName || ""
                    },
                    "currentCategoryId":this.data.id
                };
                layout.desktop.openApplication(e, "cms.ColumnManager", options);
            // }
        }
    }
});


o2.widget.O2View = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "styles": this.style.identityInforNameNode,
            "text": this.data.applicationName || this.data.appName || this.data.name
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    }
});
o2.widget.O2CMSView = new Class({
    Extends: o2.widget.O2View
});
o2.widget.O2QueryView = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getViewById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query ){
            var appId = "query.ViewDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id, "application": this.data.query, "appId": appId};
                layout.desktop.openApplication(e, "query.ViewDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryStatement = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.load("x_query_assemble_designer").StatementAction.get(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query ){
            var appId = "query.StatementDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id, "application": this.data.query, "appId": appId};
                layout.desktop.openApplication(e, "query.StatementDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryStat = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getStatById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.StatDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id,"application": this.data.query, "appId": appId};
                layout.desktop.openApplication(e, "query.StatDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryTable = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getTableById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.TableDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id,"application": this.data.query, "appId": appId};
                layout.desktop.openApplication(e, "query.TableDesigner", options);
            }
        }
    }
});

o2.widget.O2QueryImportModel = new Class({
    Extends: o2.widget.O2View,
    getPersonData: function(){
        if (!this.data.query && this.data.id){
            var data = null;
            o2.Actions.get("x_query_assemble_surface").getImportModelById(this.data.id, function(json){
                data = json.data
            }, null, false);
            this.data = data;
            return data;
        }else{
            return this.data;
        }
    },
    open : function (e) {
        if( this.data.id && this.data.query){
            var appId = "query.ImporterDesigner" + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id,"application": this.data.query, "appId": appId};
                layout.desktop.openApplication(e, "query.ImporterDesigner", options);
            }
        }
    }
});

o2.widget.O2FormField = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    }
});
o2.widget.O2Role = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        if (!this.data.distinguishedName){
            this.action.actions = {"getRole": {"uri": "/jaxrs/role/{id}"}};
            this.action.invoke({"name": "getRole", "async": false, "parameter": {"id": (this.data.id || this.data.name)}, "success": function(json){
                this.data = json.data;
            }.bind(this)});
        }
    }
});
o2.widget.O2File = new Class({
    Extends: o2.widget.O2Group,
    createInforNode: function(){
        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var extName = this.data.fileName.substring(this.data.fileName.lastIndexOf(".")+1, this.data.fileName.length).toLowerCase();
        if (["png","jpg","bmp","gif","jpeg","jpe"].indexOf(extName)!==-1){
            var url = (this.data.portal) ? MWF.xDesktop.getPortalFileUr(this.data.id, this.data.portal) : MWF.xDesktop.getProcessFileUr(this.data.id, this.data.application);
            var img = new Element("img", {"src": url, "styles": {"max-width": "280px", "max-height": "140px"}}).inject(this.inforNode);
        }else{
            var nameNode = new Element("div", {
                "styles": this.style.identityInforNameNode,
                "text": this.data.applicationName || this.data.appName || this.data.name
            }).inject(this.inforNode);
        }

        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },

    getPersonData: function(){
        return this.data;
    }
});

o2.widget.O2Script = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    createInforNode: function(){
        if( !this.data.appType )return false;

        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "text": o2.LP[this.data.appType+"Name"]
        }).inject(this.inforNode);
        var nameTextNode = new Element("div", {
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        if( this.data.id && this.data.appId &&  this.data.appType){
            var appName;
            if( this.data.appType === "cms" ){
                appName = "cms.ScriptDesigner";
            }else if( this.data.appType === "portal" ){
                appName = "portal.ScriptDesigner";
            }else if( this.data.appType === "process" ) {
                appName = "process.ScriptDesigner";
            }
            var appId = appName + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id, "appId": appId, "application":this.data.appId};
                layout.desktop.openApplication(e, appName, options);
            }
        }
    }
});

o2.widget.O2FormStyle = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    open : function (e) {
        if( typeOf(this.data)==="object" && this.data.id && this.data.appId && this.data.type === "script"){
            var appName;
            if( this.data.appType === "cms" ){
                appName = "cms.ScriptDesigner";
            }else{
                appName = "process.ScriptDesigner";
            }
            var appId = appName + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id, "appId": appId, "application":this.data.appId};
                layout.desktop.openApplication(e, appName, options);
            }
        }
    }
});

o2.widget.O2Dictionary = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    },
    createInforNode: function(){
        if( !this.data.appType )return false;

        this.inforNode = new Element("div", {
            "styles": this.style.identityInforNode
        });
        var nameNode = new Element("div", {
            "text": o2.LP[this.data.appType+"Name"]
        }).inject(this.inforNode);
        var nameTextNode = new Element("div", {
            "text": this.data.applicationName || this.data.appName
        }).inject(this.inforNode);
        this.tooltip = new mBox.Tooltip({
            content: this.inforNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.node,
            transition: 'flyin'
        });
    },
    open : function (e) {
        if( this.data.id && this.data.appId && this.data.appType){
            var appName;
            if( this.data.appType === "cms" ){
                appName = "cms.DictionaryDesigner";
            }else if( this.data.appType === "process" ) {
                appName = "process.DictionaryDesigner";
            }
            var appId = appName + this.data.id;
            if (layout.desktop.apps[appId]){
                layout.desktop.apps[appId].setCurrent();
            }else {
                var options = {"id": this.data.id, "appId": appId, "application":this.data.appId};
                layout.desktop.openApplication(e, appName, options);
            }
        }
    }
});


o2.widget.O2Other = new Class({
    Extends: o2.widget.O2Group,
    getPersonData: function(){
        return this.data;
    }
});

/**
 * @return {null}
 */
o2.widget.O2Org = function(value, container, options){
    var v = (o2.typeOf(value)==="string") ? {"name": value} : value.distinguishedName;
    var t = v.distinguishedName || v.name || "";
    if (t) {
        var flag = t.substr(t.length - 1, 1);
        switch (flag.toLowerCase()) {
            case "i":
                return new o2.widget.O2Identity(v, container, options);
            case "p":
                return new o2.widget.O2Person(v, container, options);
            case "u":
                return new o2.widget.O2Unit(v, container, options);
            case "g":
                return new o2.widget.O2Group(v, container, options);
            case "r":
                return new o2.widget.O2Role(v, container, options);
            case "d":
                return new o2.widget.O2Duty(v, container, options);
            default:
                return new o2.widget.O2Other(v, container, options);
        }
    }
    return null;
};

// o2.widget.O2Identity.iditems = o2.widget.O2Identity.iditems || [];
// o2.widget.O2Identity.intervalId = window.setInterval(function(){
//     if (o2.widget.O2Identity.iditems && o2.widget.O2Identity.iditems.length){
//         o2.widget.O2Identity.iditems.each(function(item){
//             if (item.tooltip){
//                 debugger;
//                 if (item.tooltip.options.attach){
//
//                 }
//             }
//         });
//     }
// }, 10000);

//MWF.require(["MWF.widget.Common", "MWF.widget.Identity", "MWF.widget.O2Identity"], null, false);
MWF.require(["MWF.widget.Common", "MWF.widget.O2Identity"], null, false);
MWF.xApplication.process = MWF.xApplication.process || {};
MWF.xApplication.process.Xform = MWF.xApplication.process.Xform || {};
MWF.xDesktop.requireApp("process.Xform", "lp." + MWF.language, null, false);
//MWF.xDesktop.requireApp("process.Xform", "Package", null, false);

/** @class Form 流程表单。
 * @o2category FormComponents
 * @o2range {Process}
 * @example
 * //可以在脚本中获取表单
 * //方法1：
 * var form = this.form.getApp().appForm; //获取表单
 * //方法2
 * var form = this.target; //在表单本身的事件脚本中获取
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Form = MWF.APPForm = new Class(
    /** @lends MWF.xApplication.process.Xform.Form# */
{
    Implements: [Options, Events],
    Extends: MWF.widget.Common,
    options: {
        "style": "default",
        "readonly": false,
        "cssPath": "",
        "macro": "FormContext",
        "parameters": null,
        "moduleEvents": [
            /**
             * 表单加载前触发。数据（businessData）、预加载脚本和表单html已经就位。
             * @event MWF.xApplication.process.Xform.Form#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "queryLoad",
            /**
             * 表单加载前触发。如果是流程表单，已提示抢办锁定。
             * @event MWF.xApplication.process.Xform.Form#beforeLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeLoad",
            /**
             * 表单的所有组件加载前触发，此时表单的样式和js head已经加载。
             * @event MWF.xApplication.process.Xform.Form#beforeModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeModulesLoad",
            /**
             * 表单加载后触发。主表单的组件加载完成，但不保证子表单、子页面、部件加载完成。
             * @event MWF.xApplication.process.Xform.Form#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postLoad",
            /**
             * 表单的所有组件加载后触发。表单包含有子表单、子页面、部件时，此事件会在这些组件加载后触发。
             * @event MWF.xApplication.process.Xform.Form#afterModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterModulesLoad",
            /**
             * 表单加载后触发。表单包含有子表单、子页面、部件时，此事件会在这些组件加载后触发。
             * @event MWF.xApplication.process.Xform.Form#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterLoad",
            /**
             * 保存前触发。如果是流程表单，流转前也会触发本事件。
             * @event MWF.xApplication.process.Xform.Form#beforeSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeSave",
            /**
             * 保存后触发。如果是流程表单，流转后也会触发本事件。
             * @event MWF.xApplication.process.Xform.Form#afterSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterSave",
            /**
             * 关闭前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeClose
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeClose",
            /**
             * 弹出提交界面前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeProcessWork
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeProcessWork",
            /**
             * 流转前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeProcess
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeProcess",
            /**
             * 流转后触发。
             * @event MWF.xApplication.process.Xform.Form#afterProcess
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterProcess",
            /**
             * 重置处理人前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReset
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReset",
            /**
             * 重置处理人后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReset
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReset",
            /**
             * 撤回前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeRetract
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeRetract",
            /**
             * 撤回后触发。
             * @event MWF.xApplication.process.Xform.Form#afterRetract
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterRetract",
            /**
             * 调度前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReroute
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReroute",
            /**
             * 调度后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReroute
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReroute",
            /**
             * 删除工作前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeDelete",
            /**
             * 删除工作后触发。
             * @event MWF.xApplication.process.Xform.Form#afterDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterDelete",
            "resize",
            /**
             * 已阅前触发。
             * @event MWF.xApplication.process.Xform.Form#beforeReaded
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeReaded",
            /**
             * 已阅后触发。
             * @event MWF.xApplication.process.Xform.Form#afterReaded
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterReaded"]
    },
    initialize: function (node, data, options) {
        this.setOptions(options);

        /**
         * @summary 表单容器
         * @see https://mootools.net/core/docs/1.6.0/Element/Element
         * @member {Element}
         * @example
         *  //可以在脚本中获取表单容器
         * var formContainer = this.form.getApp().appForm.container;
         */
        this.container = $(node);
        this.container.setStyle("-webkit-user-select", "text");
        if (Browser.firefox) this.container.setStyle("opacity", 0);

        this.data = data;
        //var jsonData = JSON.parse(data)

        /**
         * @summary 表单的配置信息，比如表单名称，提交方式等等.
         * @member {Object}
         * @example
         *  //可以在脚本中获取表单配置信息
         * var json = this.form.getApp().appForm.json; //表单配置信息
         * var name = json.name; //表单名称
         */
        this.json = data.json;
        this.html = data.html;

        this.path = "../x_component_process_Xform/$Form/";
        this.cssPath = this.options.cssPath || "../x_component_process_Xform/$Form/" + this.options.style + "/css.wcss";
        this._loadCss();

        this.sectionListObj = {};

        /**
         * @summary 表单中的所有组件数组.
         * @member {Array}
         * @example
         * //下面的样例对表单组件进行循环，并且判断是输入类型的组件
         * var modules = this.form.getApp().appForm.modules; //获取所有表单组件
         * for( var i=0; i<modules.length; i++ ){ //循环处理组件
         *   //获取组件的类型
            var moduleName = module.json.moduleName;
            if( !moduleName ){
                moduleName = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            }
            if( ["calendar","combox","number","textfield"].contains( moduleName )){ //输入类型框
                //do something
             }
         * }
         */
        this.modules = [];

        /**
         * 该对象的key是组件标识，value是组件对象，可以使用该对象根据组件标识获取组件。<br/>
         * 需要注意的是，在子表单中嵌入不绑定数据的组件（比如div,common,button等等），系统允许重名。<br/>
         * 在打开表单的时候，系统会根据重名情况，自动在组件的标识后跟上 "_1", "_2"。
         * @summary 表单中的所有组件对象.
         * @member {Object}
         * @example
         * var moduleAll = this.form.getApp().appForm.all; //获取组件对象
         * var subjectField = moduleAll["subject"] //获取名称为subject的组件
         */
        this.all = {};
        this.allForName = {};
        this.forms = {};

        //if (!this.personActions) this.personActions = new MWF.xAction.org.express.RestActions();
    },
    parseCSS: function (css) {
        var rex = /(url\(.*\))/g;
        var match;
        while ((match = rex.exec(css)) !== null) {
            var pic = match[0];
            var len = pic.length;
            var s = pic.substring(pic.length - 2, pic.length - 1);
            var n0 = (s === "'" || s === "\"") ? 5 : 4;
            var n1 = (s === "'" || s === "\"") ? 2 : 1;
            pic = pic.substring(n0, pic.length - n1);

            if ((pic.indexOf("x_processplatform_assemble_surface") != -1 || pic.indexOf("x_portal_assemble_surface") != -1)) {
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (pic.indexOf("/x_processplatform_assemble_surface") !== -1) {
                    pic = pic.replace("/x_processplatform_assemble_surface", pic + "/x_processplatform_assemble_surface");
                } else if (pic.indexOf("x_processplatform_assemble_surface") !== -1) {
                    pic = pic.replace("x_processplatform_assemble_surface", pic + "/x_processplatform_assemble_surface");
                }
                if (pic.indexOf("/x_portal_assemble_surface") !== -1) {
                    pic = pic.replace("/x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                } else if (pic.indexOf("x_portal_assemble_surface") !== -1) {
                    pic = pic.replace("x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                }
                pic = o2.filterUrl(pic);
            }
            pic = "url('" + pic + "')";
            var len2 = pic.length;

            css = css.substring(0, match.index) + pic + css.substring(rex.lastIndex, css.length);
            rex.lastIndex = rex.lastIndex + (len2 - len);
        }
        return css;
    },
    loadCss: function () {
        cssText = (this.json.css) ? this.json.css.code : "";
        //var head = (document.head || document.getElementsByTagName("head")[0] || document.documentElement);
        var styleNode = $("style" + this.json.id);
        if (styleNode) styleNode.destroy();
        if (cssText) {
            cssText = this.parseCSS(cssText);

            var rex = new RegExp("(.+)(?=\\{)", "g");
            var match;
            var id = this.json.id.replace(/\-/g, "");
            var prefix = ".css" + id + " ";

            while ((match = rex.exec(cssText)) !== null) {
                var rulesStr = match[0];
                if (rulesStr.indexOf(",") != -1) {
                    var rules = rulesStr.split(/\s*,\s*/g);
                    rules = rules.map(function (r) {
                        return prefix + r;
                    });
                    var rule = rules.join(", ");
                    cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                    rex.lastIndex = rex.lastIndex + (prefix.length * rules.length);

                } else {
                    var rule = prefix + match[0];
                    cssText = cssText.substring(0, match.index) + rule + cssText.substring(rex.lastIndex, cssText.length);
                    rex.lastIndex = rex.lastIndex + prefix.length;
                }
            }

            var styleNode = document.createElement("style");
            styleNode.setAttribute("type", "text/css");
            styleNode.id = "style" + this.json.id;
            styleNode.inject(this.container, "before");

            if (styleNode.styleSheet) {
                var setFunc = function () {
                    styleNode.styleSheet.cssText = cssText;
                };
                if (styleNode.styleSheet.disabled) {
                    setTimeout(setFunc, 10);
                } else {
                    setFunc();
                }
            } else {
                var cssTextNode = document.createTextNode(cssText);
                styleNode.appendChild(cssTextNode);
            }
            return "css" + id;
        }
        return "";
    },
    keyLock: function (async) {
        var lockData = null;
        var key = this.businessData.work.id + "-" + this.businessData.work.activityToken;
        o2.Actions.load("x_processplatform_assemble_surface").KeyLockAction.lock({ "key": key }, function (json) {
            flagData = json.data;
            if (async && flagData.success) this.keyLockTimeoutId = window.setTimeout(function () { this.keyLock(true) }.bind(this), 90000);
            if (async && !flagData.success) this.app.reload();
        }.bind(this), null, !!async);
        return flagData;
    },
    checkLock: function () {
        if (this.businessData.control.allowProcessing && this.businessData.activity.manualMode == "grab") {
            this.app.addEvent("queryClose", function () {
                if (this.keyLockTimeoutId) window.clearTimeout(this.keyLockTimeoutId);
            }.bind(this));
            var lockData = this.keyLock();
            if (lockData.success) {
                this.keyLock(true);
            } else {
                this.businessData.control.allowProcessing = false;
                this.businessData.control.allowSave = false;
                this.businessData.control.allowReset = false;
                this.businessData.control.allowReroute = false;
                this.businessData.control.allowDelete = false;
                this.businessData.control.allowAddSplit = false;
                this.businessData.control.allowRetract = false;
                this.businessData.control.allowRollback = false;
                this.lockDataPerson = lockData.person;
                // var text = MWF.xApplication.process.Xform.LP.keyLockInfor;
                // text = text.replace("{name}", o2.name.cn(lockData.person));
                // var title = MWF.xApplication.process.Xform.LP.keyLockTitle;
                // this.app.alert("info", "center", title, text, 400, 160);

                // o2.DL.open({
                //     "title": title,
                //     "text": text,
                //     "width": 400
                // })
            }
        }
    },
    load: function (callback) {
        this.loadMacro(function () {
            this.loadLanguage(function(flag){
                if (flag && this.formDataText){
                    var data = o2.bindJson(this.formDataText,  {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.data = JSON.parse(data);

                    this.json = this.data.json;
                    this.html = this.data.html;
                }
                this.checkLock();

                this.loadExtendStyle(function () {
                    if (this.app) {
                        if (this.app.formNode) this.app.formNode.setStyles(this.json.styles);
                        if (this.app.addEvent) {
                            this.app.addEvent("resize", function () {
                                this.fireEvent("resize");
                            }.bind(this));
                            this.app.addEvent("queryClose", function () {
                                this.beforeCloseWork();
                            }.bind(this));
                        }
                    }
                    if (!this.businessData.control.allowSave) this.setOptions({ "readonly": true });

                    var cssClass = "";
                    if (this.json.css && this.json.css.code) cssClass = this.loadCss();


                    //this.container.setStyle("opacity", 0);


                    this.container.set("html", this.html);
                    this.node = this.container.getFirst();
                    if (cssClass) this.node.addClass(cssClass);

                    this._loadEvents();

                    this.loadRelatedScript();
                    //this.loadResource( function () {
                    // this.loadDictionaryList(function () {

                    this.fireEvent("queryLoad");
                    if (this.event_resolve) {
                        this.event_resolve(function () {
                            this.loadForm(callback)
                        }.bind(this));
                    } else {
                        this.loadForm(callback);
                    }

                }.bind(this));



                // }.bind(this));

                //}.bind(this));

            }.bind(this));
        }.bind(this));
    },
    loadLanguage: function(callback){
        //formDataText
        if (this.json.languageType!=="script" && this.json.languageType!=="default"){
            if (callback) callback();
            return true;
        }

        var language = MWF.xApplication.process.Xform.LP.form;
        var languageJson = null;

        if (this.json.languageType=="script"){
            if (this.json.languageScript && this.json.languageScript.code){
                languageJson = this.Macro.exec(this.json.languageScript.code, this);
            }
        }else if (this.json.languageType=="default") {
            var name = "lp-"+o2.language;

            if (this.options.macro==="PageContext"){
                var portal = this.app.portal.id;
                languageJson = this.workAction.getScriptByNameV2(portal, name, function(d){
                    return this.Macro.exec(d.data.text, this);
                }.bind(this), function(){});
            }else{
                var application = (this.businessData.work || this.businessData.workCompleted).application;
                var p1 = this.workAction.getDictRoot(name, application, function(d){
                    return d.data;
                }, function(){});
                var p2 = new Promise(function(resolve, reject){
                    this.workAction.getScriptByNameV2(name, application, function(d){
                        if (d.data.text) {
                            resolve(this.Macro.exec(d.data.text, this));
                        }else{
                            reject("");
                        }
                    }.bind(this), function(){reject("");});
                }.bind(this));
                languageJson = Promise.any([p1, p2]);
            }
        }

        if (languageJson){
            if (languageJson.then && o2.typeOf(languageJson.then)=="function"){
                languageJson.then(function(json) {
                    MWF.xApplication.process.Xform.LP.form = Object.merge(MWF.xApplication.process.Xform.LP.form, json);
                    if (callback) callback(true);
                }, function(){
                    if (callback) callback(true);
                })
            }else{
                MWF.xApplication.process.Xform.LP.form = Object.merge(MWF.xApplication.process.Xform.LP.form, languageJson);
                if (callback) callback(true);
            }
        }else{
            if (callback) callback(true);
        }

    },
    loadRelatedScript: function () {

        if (this.json.includeScripts && this.json.includeScripts.length) {
            var includeScriptText = "";
            var includedIds = [];
            this.json.includeScripts.each(function (s) {
                if (this.app.relatedScriptMap && this.app.relatedScriptMap[s.id]) {
                    includeScriptText += "\n" + this.app.relatedScriptMap[s.id].text;
                    includedIds.push(s.id);
                }
            }.bind(this));

            if (includeScriptText) this.Macro.exec(includeScriptText, this);
        }
    },
    //@todo 载入脚本和数据字典
    // loadResource : function( callback ){
    //     var cb = function () {
    //         if( this.syncScriptLoaded && this.asyncScriptLoaded && this.dictionaryLoaded ){
    //             if(callback)callback();
    //         }
    //     }.bind(this);
    //     // this.loadScriptList( cb );
    //     this.loadDictionaryList( cb );
    // },
    // loadDictionaryList: function (callback) {
    //     this.dictionaryLoaded = false;
    //     var loadedCount = 0;
    //     if (this.json.includeDictionaries && this.json.includeDictionaries.length) {
    //         var fun = function () {
    //             loadedCount++;
    //             if (this.json.includeDictionaries.length <= loadedCount) {
    //                 this.dictionaryLoaded = true;
    //                 if (callback) callback();
    //             }
    //         }.bind(this);
    //
    //         this.json.includeDictionaries.map(function (d) {
    //             var action = MWF.Actions.get(d.dictionary.appType === "cms" ? "x_cms_assemble_control" : "x_processplatform_assemble_surface");
    //             if (d.path && d.path !== "root") {
    //                 action["getDictData"](d.dictionary.id, d.dictionary.appId, d.path, function (json) {
    //                     MWF.xScript.addDictToCache(d.dictionary, d.path, json.data);
    //                     fun();
    //                 }.bind(this), function () {
    //                     fun();
    //                 }.bind(this), true);
    //             } else {
    //                 action["getDictRoot"](d.dictionary.id, d.dictionary.appId, function (json) {
    //                     MWF.xScript.addDictToCache(d.dictionary, d.path, json.data);
    //                     fun();
    //                 }.bind(this), function () {
    //                     fun();
    //                 }.bind(this), true);
    //             }
    //         }.bind(this));
    //     } else {
    //         this.dictionaryLoaded = true;
    //         if (callback) callback();
    //     }
    // },
    // loadScriptList : function( callback ){
    //     var asyncList = [];
    //     var syncList = [];
    //
    //     this.syncScriptLoaded = false;
    //     this.asyncScriptLoaded = false;
    //
    //     if( this.json.scripts && this.json.scripts.length ){
    //         for( var i=0; i<this.json.scripts.length; i++ ){
    //             var script = this.json.scripts[i];
    //             script.scriptList.map( function ( s ) {
    //                 s.type = s.appType;
    //                 s.application = s.application || s.appId || s.appName;
    //             });
    //             if( script.async ){
    //                 asyncList = asyncList.concat( script.scriptList );
    //             }else{
    //                 syncList = syncList.concat( script.scriptList );
    //             }
    //         }
    //     }
    //
    //     var loadSyncList = function () {
    //         if( syncList.length === 0 ){
    //             this.syncScriptLoaded = true;
    //             if(callback)callback();
    //         }else{
    //             this.Macro.environment.include(syncList, function(){
    //                 this.syncScriptLoaded = true;
    //                 if(callback)callback();
    //             }.bind(this), false);
    //         }
    //     }.bind(this);
    //
    //     var loadAsyncList = function () {
    //         if( asyncList.length === 0 ){
    //             this.asyncScriptLoaded = true;
    //             if(callback)callback();
    //         }else{
    //             this.Macro.environment.include(asyncList, function(){
    //                 this.asyncScriptLoaded = true;
    //                 if(callback)callback();
    //             }.bind(this), true);
    //         }
    //     }.bind(this);
    //
    //     loadAsyncList();
    //     loadSyncList();
    // },
    loadForm: function (callback) {
        if (this.lockDataPerson) {
            var text = MWF.xApplication.process.Xform.LP.keyLockInfor;
            text = text.replace("{name}", o2.name.cn(this.lockDataPerson));
            var title = MWF.xApplication.process.Xform.LP.keyLockTitle;
            this.app.alert("info", "center", title, text, 400, 160);
        }

        if (this.app) if (this.app.fireEvent) this.app.fireEvent("queryLoad");
        this._loadBusinessData();
        this.fireEvent("beforeLoad");
        if (this.app) if (this.app.fireEvent) this.app.fireEvent("beforeLoad");
        this.loadContent(callback);
    },
    loadExtendStyle: function (callback) {
        if (!this.json.styleConfig || !this.json.styleConfig.extendFile) {
            if (callback) callback();
            return;
        }
        if (this.json["$version"] == "5.2") {
            if (callback) callback();
            return;
        }
        var stylesUrl = "../x_component_process_FormDesigner/Module/Form/skin/" + this.json.styleConfig.extendFile;
        MWF.getJSON(stylesUrl, {
                "onSuccess": function (responseJSON) {
                    if (responseJSON && responseJSON.form) {
                        this.json = Object.merge(this.json, responseJSON.form);
                    }
                    if (callback) callback();
                }.bind(this),
                "onRequestFailure": function () {
                    if (callback) callback();
                }.bind(this),
                "onError": function () {
                    if (callback) callback();
                }.bind(this)
            }
        );
    },
    loadMacro: function (callback) {
        //if (!MWF.Macro[this.options.macro || "FormContext"]){
        MWF.require("MWF.xScript.Macro", function () {
            this.Macro = new MWF.Macro[this.options.macro || "FormContext"](this);
            if (callback) callback();
        }.bind(this));
        // }else{
        //     this.Macro = new MWF.Macro[this.options.macro || "FormContext"](this);
        //     if (callback) callback();
        // }
    },
    loadContent: function (callback) {
        this.subformCount = 0;
        this.subformLoadedCount = 0;
        this.subformLoaded = [this.json.id];

        this.subpageCount = 0;
        this.subpageLoadedCount = 0;
        this.subpageLoaded = [];

        this.widgetCount = 0;
        this.widgetLoadedCount = 0;
        this.widgetLoaded = [];

        this._loadHtml();
        this._loadForm();
        this.fireEvent("beforeModulesLoad");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeModulesLoad");
        this._loadModules(this.node);
        if (Browser.firefox) this.container.setStyle("opacity", 1);

        if (this.json.mode === "Mobile") {
            var node = document.body.getElement(".o2_form_mobile_actions");
            if (node) {
                node.empty();
                this._loadMobileActions(node, callback);
            } else {
                if (callback) callback();
                //console.log("没有找到移动端底部操作栏！")
            }
        } else {
            if (callback) callback();
        }

        this.fireEvent("postLoad");
        if (this.app && this.app.fireEvent) this.app.fireEvent("postLoad");
        this.checkSubformLoaded(true);
    },
    checkSubformLoaded: function (isAllSubformLoaded) {
        if (isAllSubformLoaded) {
            this.isAllSubformLoaded = true;
        }
        if (!this.isAllSubformLoaded) return;
        //console.log( "checkSubformLoaded this.subformCount="+ this.subformCount + " this.subformLoadedCount="+this.subformLoadedCount );
        if ((!this.subformCount || this.subformCount === this.subformLoadedCount) &&
            (!this.subpageCount || this.subpageCount === this.subpageLoadedCount) &&
            (!this.widgetCount || this.widgetCount === this.widgetLoadedCount)
        ) {
            //this.container.setStyle("opacity", 1);
            this.fireEvent("afterModulesLoad");
            if (this.app && this.app.fireEvent) this.app.fireEvent("afterModulesLoad");

            this.fireEvent("afterLoad");
            if (this.app && this.app.fireEvent) this.app.fireEvent("afterLoad");
            this.isLoaded = true;
        }
    },
    _loadMobileDefaultTools: function (callback) {
        if (this.json.defaultTools) {
            if (callback) callback();
        } else {
            this.json.defaultTools = o2.JSON.get("../x_component_process_FormDesigner/Module/Form/toolbars.json", function (json) {
                this.json.defaultTools = json;
                if (callback) callback();
            }.bind(this));
        }
    },

    _loadMobileActions: function (node, callback) {
        var tools = [];
        this._loadMobileDefaultTools(function () {
            if (this.json.defaultTools) {
                var jsonStr = JSON.stringify(this.json.defaultTools);
                jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                this.json.defaultTools = JSON.parse(jsonStr);
                this.json.defaultTools.each(function (tool) {
                    var flag = this._checkDefaultMobileActionItem(tool, this.options.readonly);
                    if (flag) tools.push(tool);
                }.bind(this));
            }
            if (this.json.tools) {
                var jsonStr = JSON.stringify(this.json.tools);
                jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                this.json.tools = JSON.parse(jsonStr);
                this.json.tools.each(function (tool) {
                    var flag = this._checkCustomMobileActionItem(tool, this.options.readonly);
                    if (flag) tools.push(tool);
                }.bind(this));
            }
            this.mobileTools = tools;
            //app上用原来的按钮样式
            if (window.o2android) {
                if (tools.length) if (node) this._createMobileActions(node, tools);
            } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.o2mLog) {
                if (tools.length) if (node) this._createMobileActions(node, tools);
            } else {
                //钉钉 企业微信用新的样式
                if (tools.length) if (node) this._createMobileActionsDingdingStyle(node, tools);
            }
            if (callback) callback();
        }.bind(this));
    },
    // 修改成钉钉 button
    _createMobileActionsDingdingStyle: function (node, tools) {
        node.show();
        var count = tools.length;
        if (count <= 2) {
            //左边 间隔
            var dingdingSplitLeft = new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            var splitSize = dingdingSplitLeft.getSize();
            var size = document.body.getSize();
            var buttonWidth = (size.x - splitSize.x * (count + 1) - (count * 2)) / count;
            tools.each(function (tool) {
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                if (tool.text === "继续流转" || tool.text === "撤回" || tool.id === "action_processWork" || tool.id === "action_retract") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                } else if (tool.text === "删除文件" || tool.id === "action_delete") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                actionStyle.width = buttonWidth + "px";
                var action = new Element("div", { "styles": actionStyle, "text": tool.text }).inject(node);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var clickFun = function () {
                        var t = e.target.retrieve("tool");
                        e.setDisable = function () { };
                        if (t.actionScript) {
                            this._runCustomAction(t.actionScript);
                        } else {
                            if (this[t.action]) this[t.action](e);
                        }
                    }.bind(this);
                    if (tool.text === "继续流转" || tool.id === "action_processWork") {
                        //输入法激活的时候，需要一段时间等待输入法关闭
                        window.setTimeout(clickFun, 100)
                    } else {
                        clickFun();
                    }
                }.bind(this));
                new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            }.bind(this));
        } else {
            //左边 间隔
            var dingdingSplitLeft = new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            var splitSize = dingdingSplitLeft.getSize();
            var size = document.body.getSize();
            var buttonWidth = (size.x - splitSize.x * 4 - 6) / 5;
            for (var i = 0; i < 3; i++) {
                tool = tools[i];
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                if (tool.text === "继续流转" || tool.text === "撤回") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                } else if (tool.text === "删除文件") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                if (i == 2) {
                    this.css.html5ActionButtonDingdingMore.width = buttonWidth + "px";
                    var action = new Element("div", { "styles": this.css.html5ActionButtonDingdingMore, "text": "…" }).inject(node);
                    action.addEvent("click", function (e) {
                        this._loadMoreMobileActionsDingdingStyle(tools, 2, node);
                    }.bind(this));
                } else {
                    actionStyle.width = (buttonWidth * 2) + "px";
                    var action = new Element("div", { "styles": actionStyle, "text": tool.text }).inject(node);
                    action.store("tool", tool);
                    action.addEvent("click", function (e) {
                        var t = e.target.retrieve("tool");
                        e.setDisable = function () { }
                        if (t.actionScript) {
                            this._runCustomAction(t.actionScript);
                        } else {
                            if (this[t.action]) this[t.action](e);
                        }
                    }.bind(this));
                }
                new Element("div", { "styles": this.css.html5ActionButtonDingdingSplit, "text": " " }).inject(node);
            }
        }
    },
    _loadMoreMobileActionsDingdingStyle: function (tools, n, node) {
        document.body.mask({
            "style": {
                "background-color": "#cccccc",
                "opacity": 0.6
            },
            "hideOnClick": true,
            "onHide": function () {
                this.actionMoreArea.setStyle("display", "none");
            }.bind(this)
        });
        if (this.actionMoreArea) {
            this.actionMoreArea.setStyle("display", "block");
        } else {
            var size = document.body.getSize();
            this.actionMoreArea = new Element("div", { "styles": this.css.html5ActionOtherArea }).inject(document.body);
            var pl = this.actionMoreArea.getStyle("padding-left").toInt();
            var pr = this.actionMoreArea.getStyle("padding-right").toInt();
            var w = size.x - pl - pr;
            this.actionMoreArea.setStyle("width", "" + w + "px");
            for (var i = n; i < tools.length; i++) {
                tool = tools[i];
                var actionStyle = this.css.html5ActionButtonDingdingNormal;
                if (tool.text === "继续流转" || tool.text === "撤回") {
                    actionStyle = this.css.html5ActionButtonDingdingPrimary;
                } else if (tool.text === "删除文件") {
                    actionStyle = this.css.html5ActionButtonDingdingDanger;
                }
                actionStyle.width = "100%";
                var action = new Element("div", { "styles": actionStyle, "text": tool.text }).inject(this.actionMoreArea);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
            }
        }
    },

    _createMobileActions: function (node, tools) {
        node.show();
        var count = tools.length;
        if (count <= 2) {
            this.css.html5ActionButton.width = "100%";
            if (count == 2) this.css.html5ActionButton.width = "49%";
            tools.each(function (tool) {

                var action = new Element("div", { "styles": this.css.html5ActionButton, "text": tool.text }).inject(node);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }.bind(this));
            if (count == 2) new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node.getLast(), "before");
        } else {
            this.css.html5ActionButton.width = "38%"
            for (var i = 0; i < 2; i++) {
                tool = tools[i];
                var action = new Element("div", { "styles": this.css.html5ActionButton, "text": tool.text }).inject(node);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }
            new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node.getLast(), "before");
            new Element("div", { "styles": this.css.html5ActionButtonSplit }).inject(node);
            this.css.html5ActionButton.width = "23%"
            var action = new Element("div", { "styles": this.css.html5ActionButton, "text": "…" }).inject(node);
            action.addEvent("click", function (e) {
                this._loadMoreMobileActions(tools, 2, node);
            }.bind(this));
            this._setMobileBottonStyle(action);
        }
    },
    _loadMoreMobileActions: function (tools, n, node) {
        document.body.mask({
            "style": {
                "background-color": "#cccccc",
                "opacity": 0.6
            },
            "hideOnClick": true,
            "onHide": function () {
                this.actionMoreArea.setStyle("display", "none");
            }.bind(this)
        });
        if (this.actionMoreArea) {
            this.actionMoreArea.setStyle("display", "block");
        } else {

            var size = document.body.getSize();
            this.actionMoreArea = new Element("div", { "styles": this.css.html5ActionOtherArea }).inject(document.body);
            var pl = this.actionMoreArea.getStyle("padding-left").toInt();
            var pr = this.actionMoreArea.getStyle("padding-right").toInt();
            var w = size.x - pl - pr;
            this.actionMoreArea.setStyle("width", "" + w + "px");
            for (var i = n; i < tools.length; i++) {
                tool = tools[i];
                var action = new Element("div", { "styles": this.css.html5ActionOtherButton, "text": tool.text }).inject(this.actionMoreArea);
                action.store("tool", tool);
                action.addEvent("click", function (e) {
                    var t = e.target.retrieve("tool");
                    e.setDisable = function () { }
                    if (t.actionScript) {
                        this._runCustomAction(t.actionScript);
                    } else {
                        if (this[t.action]) this[t.action](e);
                    }
                }.bind(this));
                this._setMobileBottonStyle(action);
            }
        }

        // actionArea.position({
        //     relativeTo: node,
        //     position: 'topCenter',
        //     edge: 'bottomCenter'
        // });
    },
    _setMobileBottonStyle: function (action) {
        var _self = this;
        action.addEvents({
            "mouseover": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "mouseout": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "mousedown": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "mouseup": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchstart": function (e) { this.setStyles(_self.css.html5ActionButton_over) },
            "touchcancel": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchend": function (e) { this.setStyles(_self.css.html5ActionButton_up) },
            "touchmove": function (e) { this.setStyles(_self.css.html5ActionButton_over) }
        });
    },
    _runCustomAction: function (actionScript) {
        //var script = bt.node.retrieve("script");
        this.Macro.exec(actionScript, this);
    },
    _checkCustomMobileActionItem: function (tool, readonly) {
        var flag = true;
        if (readonly) {
            flag = tool.readShow;
        } else {
            flag = tool.editShow;
        }
        if (flag) {
            flag = true;
            if (tool.control) {
                flag = this.form.businessData.control[tool.control]
            }
            if (tool.condition) {
                var hideFlag = this.Macro.exec(tool.condition, this);
                flag = !hideFlag;
            }
        }
        return flag;
    },
    _checkDefaultMobileActionItem: function (tool, readonly, noCondition) {
        var flag = true;
        if (tool.control) {
            flag = this.businessData.control[tool.control]
        }
        if (!noCondition) if (tool.condition) {
            var hideFlag = this.Macro.exec(tool.condition, this);
            flag = flag && (!hideFlag);
        }
        if (tool.id == "action_processWork") {
            if (!this.businessData.task && this.businessData.work.startTime) {
                flag = false;
            }
        }
        if (tool.id == "action_rollback") tool.read = true;
        if (readonly) if (!tool.read) flag = false;
        return flag;
    },
    _loadBusinessData: function () {
        if (!this.businessData) {
            this.businessData = {};
            // this.businessData = {
            //     "data": {
            //         "select": "222",
            //         "radio": "bbb",
            //         "checkbox": ["check1", "check3"],
            //         "orderData": [
            //             {
            //                 "orderName": {"namefield": "电脑"},
            //                 "orderCount": {"countField": "3"},
            //                 "priceCount": {"priceField": "9000"}
            //             },
            //             {
            //                 "orderName": {"namefield": "路由器"},
            //                 "orderCount": {"countField": "2"},
            //                 "priceCount": {"priceField": "1000"}
            //             },
            //             {
            //                 "orderName": {"namefield": "网线"},
            //                 "orderCount": {"countField": "10"},
            //                 "priceCount": {"priceField": "200"}
            //             }
            //         ]
            //
            //     }
            // };
        }
    },

    _loadHtml: function () {
        // this.container.set("html", this.html);
        // this.node = this.container.getFirst();
        //this.node.setStyle("overflow", "hidden");
        this.node.addEvent("selectstart", function (e) {
            var select = "text";
            if (e.target.getStyle("-webkit-user-select")) {
                select = e.target.getStyle("-webkit-user-select").toString().toLowerCase();
            }

            if (select !== "text" && select !== "auto") e.preventDefault();
        });
    },

    _loadForm: function () {
        this._loadStyles();
        this._loadCssLinks();
        this._loadScriptSrc();
        this._loadJsheader();
        //this._loadEvents();
    },
    _loadStyles: function () {
        if (this.json.styles) Object.each(this.json.styles, function (value, key) {
            if ((value.indexOf("x_processplatform_assemble_surface") != -1 || value.indexOf("x_portal_assemble_surface") != -1)) {
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface") !== -1) {
                    value = value.replace("/x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                } else if (value.indexOf("x_processplatform_assemble_surface") !== -1) {
                    value = value.replace("x_processplatform_assemble_surface", host1 + "/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface") !== -1) {
                    value = value.replace("/x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                } else if (value.indexOf("x_portal_assemble_surface") !== -1) {
                    value = value.replace("x_portal_assemble_surface", host2 + "/x_portal_assemble_surface");
                }
            }
            value = o2.filterUrl(value);
            this.node.setStyle(key, value);
        }.bind(this));
        //this.node.setStyles(this.json.styles);
    },
    _loadCssLinks: function () {
        var urls = this.json.cssLinks;
        urls.each(function (url) {
            new Element("link", {
                "rel": "stylesheet",
                "type": "text/css",
                "href": url
            }).inject($(document.head));
        });
    },
    _loadScriptSrc: function () {
        var urls = this.json.scriptSrc;
        urls.each(function (url) {
            new Element("script", {
                "src": url
            }).inject($(document.head));
        });
    },
    _loadJsheader: function () {
        var code = (this.json.jsheader) ? this.json.jsheader.code : "";
        if (code) Browser.exec(code);
    },
    _loadEvents: function () {
        Object.each(this.json.events, function (e, key) {
            if (e.code) {
                if (this.options.moduleEvents.indexOf(key) !== -1) {
                    this.addEvent(key, function (event) {
                        return this.Macro.fire(e.code, this, event);
                    }.bind(this));
                } else {
                    if (key === "load") {
                        this.addEvent("postLoad", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else if (key === "submit") {
                        this.addEvent("beforeProcess", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else {
                        this.node.addEvent(key, function (event) {
                            return this.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }
                }
            }
        }.bind(this));
    },
    addModuleEvent: function (key, fun) {
        if (this.options.moduleEvents.indexOf(key) !== -1) {
            this.addEvent(key, function (event) {
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        } else {
            if (key === "load") {
                this.addEvent("postLoad", function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            } else if (key === "submit") {
                this.addEvent("beforeProcess", function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            } else {
                this.node.addEvent(key, function (event) {
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }
        }
    },

    _getDomjson: function (dom) {
        var mwfType = dom.get("MWFtype") || dom.get("mwftype");
        switch (mwfType) {
            case "form":
                return this.json;
            case "":
                return null;
            default:
                var id = dom.get("id");
                if (!id) id = dom.get("MWFId");
                if (id) {
                    return this.json.moduleList[id];
                } else {
                    return null;
                }
        }
    },
    _getModuleNodes: function (dom, dollarFlag ) {
        var moduleNodes = [];
        var subDom = dom.getFirst();
        while (subDom) {
            var mwftype = subDom.get("MWFtype") || subDom.get("mwftype");
            if (mwftype) {
                var type = mwftype;
                if (type.indexOf("$") === -1 || dollarFlag===true) {
                    moduleNodes.push(subDom);
                }
                // && mwftype !== "tab$Content"
                if (mwftype !== "datagrid" && mwftype !== "datatable" && mwftype !== "subSource" && mwftype !== "tab$Content" && mwftype !== "datatemplate") {
                    moduleNodes = moduleNodes.concat(this._getModuleNodes(subDom, dollarFlag));
                }
            } else {
                moduleNodes = moduleNodes.concat(this._getModuleNodes(subDom, dollarFlag));
            }
            subDom = subDom.getNext();
        }
        return moduleNodes;
    },

    _loadModules: function (dom) {
        //var subDom = this.node.getFirst();
        //while (subDom){
        //    if (subDom.get("MWFtype")){
        //        var json = this._getDomjson(subDom);
        //        var module = this._loadModule(json, subDom);
        //        this.modules.push(module);
        //    }
        //    subDom = subDom.getNext();
        //}
        var moduleNodes = this._getModuleNodes(dom);
        //alert(moduleNodes.length);

        moduleNodes.each(function (node) {
            var json = this._getDomjson(node);
            //if( json.type === "Subform" || json.moduleName === "subform" )this.subformCount++;
            //if( json.type === "Subpage" || json.moduleName === "subpage" )this.subpageCount++;
            var module = this._loadModule(json, node);
            this.modules.push(module);
        }.bind(this));
    },
    _loadModule: function (json, node, beforeLoad) {
        //console.log( json.id );
        if (json.type === "Subform" || json.moduleName === "subform") this.subformCount++;
        //if( json.type === "Subform" || json.moduleName === "subform" ){
        //    console.log( "add subformcount ， this.subformCount = " + this.subformCount );
        //}
        if (json.type === "Subpage" || json.moduleName === "subpage") this.subpageCount++;
        if (json.type === "Widget" || json.moduleName === "widget") this.widgetCount++;
        if (!MWF["APP" + json.type]) {
            MWF.xDesktop.requireApp("process.Xform", json.type, null, false);
        }
        var module = new MWF["APP" + json.type](node, json, this);
        if (beforeLoad) beforeLoad.apply(module);
        if (!this.all[json.id]) this.all[json.id] = module;

        if (json.name) {
            if (this.allForName[json.name]) {
                var item = this.allForName[json.name];
                typeOf(item) === "array" ? item.push(module) : this.allForName[json.name] = [item, module];
            } else {
                this.allForName[json.name] = module;
            }
        }

        if (module.field) {
            if (!this.forms[json.id]) this.forms[json.id] = module;
        }
        module.readonly = this.options.readonly;
        module.load();
        return module;
    },
    saveOpinion: function (module) {
        var op = module._getBusinessSectionDataByPerson();
        MWF.UD.getDataJson("userOpinion", function (json) {
            if (!json) json = [];
            var idx = json.indexOf(op);
            if (idx == -1) {
                if (json.length >= 50) json.shift();

            } else {
                json.splice(idx, 1);
            }
            json.push(op);
            MWF.UD.putData("userOpinion", json);
        }.bind(this), false);
    },
    loadPathData: function (path) {
        var data = null;
        this.workAction.getJobDataByPath(this.businessData.work.job, path, function (json) {
            data = json.data || null;
        }, null, false);
        return data;
    },
    /**
     * @summary 获取表单的所有数据.
     * @example
     * var data = this.form.getApp().appForm.getData();
     * @return {Object}
     */
    getData: function (issubmit) {
        //var data = Object.clone(this.businessData.data);
        var data = this.businessData.data;
        Object.each(this.forms, function (module, id) {

            //对id类似于 xx..0..xx 的字段 不处理
            if( id.indexOf("..") > 0 )return;

            if (module.json.type === "Opinion") {

                if (issubmit) {
                    this.saveOpinion(module);

                    var key = layout.desktop.session.user.id;
                    if (typeOf(data[id]) === "object" && typeOf(data[id][key]) === "string") {
                        data[id][key] = "";
                    } else if (typeOf(data[id]) === "string") {
                        data[id] = "";
                    }
                    // delete data[id];
                } else {
                    var v = module.getData();
                    // var d = this.loadPathData(id);
                    // if (d) data[id] = d;
                    data[id] = this.getSectionDataByPerson(v, data[id]);
                }
            } else {
                if (module.json.section === "yes") {
                    //     var d = this.loadPathData(id);
                    //     if (d) data[id] = d;
                    var v = this.getSectionData(module, data[id]);
                    //if (o2.typeOf(v)==="string") v = o2.txt(v);
                    data[id] = v
                } else {
                    var v = module.getData();
                    //if (o2.typeOf(v)==="string") v = o2.txt(v);
                    data[id] = v;
                }
            }
        }.bind(this));

        this.businessData.data = data;
        this.Macro.environment.setData(this.businessData.data);
        return data;
    },
    getSectionData: function (module, obj) {
        var v = module.getData();
        switch (module.json.sectionBy) {
            case "person":
                return this.getSectionDataByPerson(v, obj);
            case "unit":
                return this.getSectionDataByUnit(v, obj);
            case "activity":
                return this.getSectionDataByPActivity(v, obj);
            case "splitValue":
                return this.getSectionDataBySplitValue(v, obj);
            case "script":
                return this.getSectionDataByScript(module.json.sectionByScript.code, v, obj);
            default:
                return v;
        }
    },
    getSectionDataByPerson: function (v, obj) {
        var key = layout.desktop.session.user.id;
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        obj[key] = v;
        return obj;
    },
    getSectionDataByUnit: function (v, obj) {
        var key = (this.businessData.task) ? this.businessData.task.unit : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },
    getSectionDataByPActivity: function (v, obj) {
        var key = (this.businessData.work) ? this.businessData.work.activity : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },
    getSectionDataBySplitValue: function (v, obj) {
        var key = (this.businessData.work) ? this.businessData.work.splitValue : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },

    getSectionDataByScript: function (code, v, obj) {
        var key = this.Macro.exec(code, this);
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        if (key) obj[key] = v;
        return obj;
    },

    setSection: function (json, data) {
        var obj = data[json.name];
        switch (json.sectionBy) {
            case "person":
                return this.setSectionByPerson(obj, json.name);
            case "unit":
                return this.setSectionByUnit(obj, json.name);
            case "activity":
                return this.setSectionByPActivity(obj, json.name);
            case "splitValue":
                return this.setSectionBySplitValue(obj, json.name);
            case "script":
                return this.setSectionByScript(json.sectionByScript.code, obj, json.name);
            default:
                return v;
        }
    },
    setSectionByPerson: function (obj, name) {
        var key = layout.desktop.session.user.id;
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        //obj[key] = v;
        this.sectionListObj[name] = key;
        return obj;
    },
    setSectionByUnit: function (obj, name) {
        var key = (this.businessData.task) ? this.businessData.task.unit : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    setSectionByPActivity: function (obj, name) {
        var key = (this.businessData.work) ? this.businessData.work.activity : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    setSectionBySplitValue: function (obj, name) {
        var key = (this.businessData.work) ? this.businessData.work.splitValue : "";
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },

    setSectionByScript: function (code, obj, name) {
        var key = this.Macro.exec(code, this);
        if (!obj || (typeOf(obj) !== "object")) obj = {};
        this.sectionListObj[name] = key || "";
        //if (key) obj[key] = v;
        return obj;
    },
    saveWork: function (callback, silent) {

        if (this.businessData.control["allowSave"]) {
            this.fireEvent("beforeSave");
            this.fireEvent("beforeSaveWork");

            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeSave");
            this.saveFormData(function (json) {
                if (this.app && !silent) this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved, "success");
                if (callback && typeOf(callback) === "function") callback();
                this.fireEvent("afterSave");
                this.fireEvent("afterSaveWork");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterSave");
            }.bind(this));

        } else {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            //if (failure) failure(null, "Permission Denied", "");
        }
    },

    getSectionList: function () {
        return Object.keys(this.sectionListObj).map(function (p) {
            var o = { "path": p };
            if (this.sectionListObj[p]) o.key = this.sectionListObj[p];
            return o;
        }.bind(this));
    },


    setModifedDataByPathList: function (data, pathList) {
        var d = this.modifedData;
        for (var i = 0; i < pathList.length; i++) {
            if (i === pathList.length - 1) {
                d[pathList[i]] = data;
            } else {
                if (typeOf(d[pathList[i]]) === "object" || typeOf(d[pathList[i]]) === "array") {
                    d = d[pathList[i]]
                } else if (typeOf(pathList[i]) === "number") {
                    d = d[pathList[i]] = [];
                } else {
                    d = d[pathList[i]] = {};
                }
            }
        }
    },
    getOrigianlPathData: function (pathList) {
        var d = this.businessData.originalData;
        for (var i = 0; i < pathList.length; i++) {
            if (i === pathList.length - 1) {
                d = d[pathList[i]];
            } else {
                if (typeOf(d[pathList[i]]) === "object" || typeOf(d[pathList[i]]) === "array") {
                    d = d[pathList[i]];
                } else {
                    return null;
                }
            }
        }
        return d;
    },
    setModifedData: function (data, pathList) {
        pathList = pathList || [];
        if (typeOf(data) === "object") {
            for (var key in data) {
                var pList = Array.clone(pathList);
                pList.push(key);
                this.setModifedData(data[key], pList);
            }
        } else if (typeOf(data) === "array") {
            var od = this.getOrigianlPathData(pathList);
            // if (typeOf(od) !== "array" || od.length !== data.length || JSON.stringify(od) !== JSON.stringify(data)) {
            if (typeOf(od) !== "array" || od.length !== data.length || !this.compareObjects( od, data ) ) {
                this.setModifedDataByPathList(data, pathList);
            }
            //}else{
            //    for( var i=0; i<data.length; i++ ){
            //        this.setModifedData(data[i], pathList.push(i));
            //    }
            //}
        } else if (typeOf(data) !== "null") { //后台对null是忽略处理的，认为值没有变化
            var od = this.getOrigianlPathData(pathList);
            if (typeOf(data) !== typeOf(od) || data !== od) {
                this.setModifedDataByPathList(data, pathList);
            }
        }
    },
    compareObjects: function(o, p, deep){
        if( !deep )deep = 0;
        if( deep > 15 )return false; //最大层数，避免相互嵌套
        var type1 = typeOf( o ), type2 = typeOf( p );
        if( type1 !== type2 )return false;

        if( type1 === "object" ){
            for( var k in o ){
                if( o[k] === null || o[k] === undefined )delete o[k]
            }
            for( var k in p ){
                if( p[k] === null || p[k] === undefined )delete p[k]
            }
        }
        switch (type1) {
            case "object":
            case "array":
                var i, keysO = Object.keys(o), keysP = Object.keys(p);
                if (keysO.length !== keysP.length){
                    return false;
                }
                keysO.sort();
                keysP.sort();
                for ( i=0; i<keysO.length; i++ ){
                    var key = keysO[i];
                    if( type1 === "array" )key = key.toInt();
                    var valueO = o[key], valueP = p[key];
                    if( this.compareObjects( valueO, valueP, deep++ ) === false ){
                        return false;
                    }
                }
                break;
            case "function":
               break;
            default:
                if  (o!==p){
                    return false;
                }
        }
        return true;
    },

    saveFormData: function (callback, failure, history, data, issubmit, isstart) {
        if (this.businessData.work.startTime) {
            this.saveFormDataInstance(callback, failure, history, data, issubmit);
        } else {
            this.saveFormDataDraft(callback, failure, history, data, issubmit, isstart);
        }
    },
    saveFormDataInstance: function (callback, failure, history, data, issubmit) {
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save(history);
            });
        }
        var data = data || this.getData(issubmit);

        this.modifedData = {};
        this.setModifedData(data);

        if (this.toWordSaveList && this.toWordSaveList.length){
            var p = [];
            this.toWordSaveList.each(function(editor){
                if (editor.docToWord) p.push(new Promise(function(resolve){ editor.docToWord(resolve) }));
            });
            Promise.all(p).then(function(){
                this.workAction.saveData(function () {
                    this.businessData.originalData = null;
                    this.businessData.originalData = Object.clone(data);
                    if(callback)callback();
                }.bind(this), failure, this.businessData.work.id, this.modifedData);
            }.bind(this));
        }else{
            this.workAction.saveData(function () {
                this.businessData.originalData = null;
                this.businessData.originalData = Object.clone(data);
                if(callback)callback();
            }.bind(this), failure, this.businessData.work.id, this.modifedData);
        }
    },
    saveFormDataDraft: function (callback, failure, history, data, issubmit, isstart) {
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save(history);
            });
        }
        var data = data || this.getData(issubmit);
        var draft = {
            "data": data,
            "work": this.businessData.work,
            "identity": this.businessData.work.creatorIdentityDn
        }
        this.workAction.saveDraft(draft, function (json) {

            this.businessData.originalData = null;
            this.businessData.originalData = Object.clone(data);

            this.workAction.getDraft(json.data.id, function (json) {
                this.businessData.work = json.data.work;
                this.app.options.draftId = json.data.work.id;

                if (layout.app && layout.app.inBrowser) {
                    if (layout.app) layout.app.$openWithSelf = true;
                    if (callback) callback();
                    if (!isstart) layout.desktop.openApplication(null, "process.Work", { "draftId": this.app.options.draftId });
                } else {
                    this.app.options.desktopReload = true;

                    this.app.appId = "process.Work" + json.data.work.id;
                    if (layout.desktop.apps) {
                        delete layout.desktop.apps[this.app.options.appId];
                    } else {
                        layout.desktop.apps = {};
                    }
                    layout.desktop.apps[this.app.appId] = this.app;

                    if (callback) callback();

                    if (!isstart) this.app.reload();
                }

            }.bind(this));
        }.bind(this), failure);
    },
    setProcessorSectionOrgList: function (data) {
        if (!this.routeDataList) this.getRouteDataList();
        var routeList = this.routeDataList;
        //var processorSectionOrg = [];
        for (var i = 0; i < routeList.length; i++) {
            (routeList[i].selectConfigList || []).each(function (config, j) {
                if (config.section == "yes") {
                    this.setSection(config, data);
                }
            }.bind(this))
        }
    },

    /**
     * @summary 获取当前工作的路由配置数据.
     * @example
     * this.form.getApp().appForm.getRouteDataList();
     * @return {Object[]}
     */
    getRouteDataList: function () {
        if (!this.routeDataList) {
            o2.Actions.get("x_processplatform_assemble_surface").listRoute({ "valueList": this.businessData.task.routeList }, function (json) {
                json.data.each(function (d) {
                    d.selectConfigList = JSON.parse(d.selectConfig || "[]");
                }.bind(this));
                this.routeDataList = json.data;
            }.bind(this), null, false);
        }
        return this.routeDataList;
    },

    beforeCloseWork: function () {
        this.fireEvent("beforeClose");
        if (this.app && this.app.fireEvent) {
            this.app.fireEvent("beforeClose");
            //    this.fireEvent("afterClose");
        }
        if (!this.options.readonly) {
            if (this.businessData.work && this.businessData.work.id) {
                if (!this.isSendBeacon) {
                    if (this.app.inBrowser && navigator.sendBeacon) {
                        var obj = this.workAction.action.actions["checkDraft"];
                        var url = this.workAction.action.address + obj.uri;
                        url = url.replace("{id}", this.businessData.work.id);
                        navigator.sendBeacon(url);
                    } else {
                        this.workAction.checkDraft(this.businessData.work.id, function () {
                            if (layout.desktop.apps) {
                                if (layout.desktop.apps["TaskCenter"] && layout.desktop.apps["TaskCenter"].window) {
                                    layout.desktop.apps["TaskCenter"].content.unmask();
                                    layout.desktop.apps["TaskCenter"].refreshAll();
                                }
                            }
                        }.bind(this), null, false);
                    }
                    this.isSendBeacon = true;
                }
            }
        } else {
            this.app.refreshTaskCenter();
        }
    },
    closeWork: function () {
        // this.fireEvent("beforeClose");
        // if (this.app && this.app.fireEvent){
        //     this.app.fireEvent("beforeClose");
        // //    this.fireEvent("afterClose");
        // }
        // debugger;
        // if (!this.options.readonly)
        //     if (this.businessData.work) this.workAction.checkDraft(this.businessData.work.id);

        this.app.close();
    },
    getMessageContent: function (data, maxLength, titlelp) {
        var content = "";
        if (data.completed) {
            content += MWF.xApplication.process.Xform.LP.workCompleted;
        } else {
            if (data.occurSignalStack) {
                if (data.signalStack && data.signalStack.length) {
                    var activityUsers = [];
                    data.signalStack.each(function (stack) {
                        var idList = [];
                        if (stack.splitExecute) {
                            idList = stack.splitExecute.splitValueList || [];
                        }
                        if (stack.manualExecute) {
                            idList = stack.manualExecute.identities || [];
                        }
                        var count = 0;
                        var ids = [];
                        idList.each( function(i){
                            var cn = o2.name.cn(i);
                            if( !ids.contains( cn ) ){
                                ids.push(cn)
                            }
                        });
                        if (ids.length > 8) {
                            count = ids.length;
                            ids = ids.slice(0, 8);
                        }
                        ids = o2.name.cns(ids);
                        var lp = MWF.xApplication.process.Xform.LP;
                        var t = "<b>" + lp.nextActivity + "</b><span style='color: #ea621f'>" + stack.name + "</span>；<b>" + lp.nextUser + "</b><span style='color: #ea621f'>" + ids.join(",") + "</span> <b>" + ((count) ? "," + lp.next_etc.replace("{count}", count) : "") + "</b>";
                        activityUsers.push(t);
                    }.bind(this));
                    content += activityUsers.join("<br>");
                } else {
                    content += MWF.xApplication.process.Xform.LP.taskCompleted;
                }
            } else {
                if (data.properties.nextManualList && data.properties.nextManualList.length) {
                    var activityUsers = [];
                    data.properties.nextManualList.each(function (a) {
                        var ids = [];
                        a.taskIdentityList.each(function (i) {
                            var cn = o2.name.cn(i);
                            if( !ids.contains( cn ) ){
                                ids.push(cn)
                            }
                        });
                        var t = "<b>" + MWF.xApplication.process.Xform.LP.nextActivity + "</b><span style='color: #ea621f'>" + a.activityName + "</span>；<b>" + MWF.xApplication.process.Xform.LP.nextUser + "</b><span style='color: #ea621f'>" + ids.join(",") + "</span>";
                        activityUsers.push(t);
                    });
                    content += activityUsers.join("<br>");
                } else {
                    if (data.arrivedActivityName) {
                        content += MWF.xApplication.process.Xform.LP.arrivedActivity + data.arrivedActivityName;
                    } else {
                        content += MWF.xApplication.process.Xform.LP.taskCompleted;
                    }

                }
            }
        }
        var title = this.businessData.data.title || this.businessData.data.subject || this.businessData.work.title
        if (maxLength && title.length > maxLength) {
            title = title.substr(0, maxLength) + "..."
        }
        return "<div>" + (titlelp || MWF.xApplication.process.Xform.LP.taskProcessedMessage) + "“" + title + "”</div>" + content;
    },
    addMessage: function (data, notShowBrowserDkg) {
        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.taskProcessed,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.taskProcessedMessage)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser && !notShowBrowserDkg) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.taskProcessedMessage));
            }
        }
    },
    formValidation: function (routeName, opinion, medias) {
        if (this.options.readonly) return true;
        this.Macro.environment.form.currentRouteName = routeName;
        this.Macro.environment.form.opinion = opinion;
        this.Macro.environment.form.medias = medias;

        var flag = true;
        //flag = this.validation();
        Object.each(this.forms, function (field, key) {
            field.validationMode();
            if (!field.validation(routeName, opinion, medias)) flag = false;
        }.bind(this));
        return flag;
    },
    validation: function (routeName, opinion, processor, medias) {
        this.Macro.environment.form.currentRouteName = routeName;
        this.Macro.environment.form.opinion = opinion;
        this.Macro.environment.form.medias = medias;
        var routeFlag = this.validationRoute(processor);
        var opinionFlag = this.validationOpinion(processor);
        return routeFlag && opinionFlag;
    },
    validationRoute: function (processor) {
        if (!this.json.validationRoute) return true;
        if (!this.json.validationRoute.code) return true;
        var flag = this.Macro.exec(this.json.validationRoute.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationRouteMode(flag, processor);
            return false;
        }
        return true;
    },
    validationOpinion: function (processor) {
        if (!this.json.validationOpinion) return true;
        if (!this.json.validationOpinion.code) return true;
        var flag = this.Macro.exec(this.json.validationOpinion.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationOpinionMode(flag, processor);
            return false;
        }
        return true;
    },
    formCustomValidation: function () {
        if (!this.json.validationFormCustom) return true;
        if (!this.json.validationFormCustom.code) return true;
        var flag = this.Macro.exec(this.json.validationFormCustom.code, this);
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationOpinionMode(flag);
            return false;
        }
        return true;
    },
    notValidationRouteMode: function (flag, processor) {
        if (processor) processor.routeSelectorArea.setStyle("background-color", "#ffe9e9");
        MWF.xDesktop.notice(
            "error",
            { "x": "center", "y": "top" },
            flag,
            (processor) ? processor.routeSelectorArea : this.app.content,
            null,  //{"x": 0, "y": 30}
            { "closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000 }
        );
        //new mBox.Notice({
        //    type: "error",
        //    position: {"x": "center", "y": "top"},
        //    move: false,
        //    target: (processor) ? processor.routeSelectorArea : this.app.content,
        //    delayClose: 6000,
        //    content: flag
        //});
    },
    notValidationOpinionMode: function (flag, processor) {
        if (processor) processor.inputTextarea.setStyle("background-color", "#ffe9e9");
        MWF.xDesktop.notice(
            "error",
            (processor) ? { "x": "center", "y": "top" } : { "x": "right", "y": "top" },
            flag,
            (processor) ? processor.inputTextarea : this.app.content,
            null,  //{"x": 0, "y": 30}
            { "closeOnBoxClick": true, "closeOnBodyClick": true, "fixed": true, "delayClose": 6000 }
        );
        //new mBox.Notice({
        //    type: "error",
        //    position: (processor) ? {"x": "center", "y": "top"} : {"x": "right", "y": "top"},
        //    move: false,
        //    target: (processor) ? processor.inputTextarea : this.app.content,
        //    delayClose: 6000,
        //    content: flag
        //});
    },


    //fireRtEvent: function(type, args, delay){
    //    type = removeOn(type);
    //    var events = this.$events[type];
    //    if (!events) return this;
    //    if (!events.length) return this;
    //    var event = events[events.length-1];
    //    args = Array.from(args);
    //    if (delay) fn.delay(delay, this, args);
    //    else return fn.apply(this, args);
    //    return this;
    //},
    getIgnoreImpowerIdentity: function (processorOrgList) {

        var list = [];
        var check = function (org, isProcessOrg) {
            var moduleData = isProcessOrg ? org.getValue() : org.getData();
            var flag = false;
            if (typeOf(moduleData) === "array" && moduleData.length) {
                moduleData.each(function (d) {
                    if (d.ignoreEmpower) {
                        list.push(d.distinguishedName || d.unique || d.id);
                        d.ignoredEmpower = true;
                        delete d.ignoreEmpower;
                        flag = true;
                    }
                })
            }
            if (flag) org.setData(moduleData);
        }

        var modules = this.modules;
        for (var i = 0; i < modules.length; i++) {
            var module = modules[i];
            var moduleName = module.json.moduleName;
            if (!moduleName) moduleName = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            if (moduleName === "org") {
                check(module)
            }
        }
        if (processorOrgList && processorOrgList.length > 0) {
            for (var i = 0; i < processorOrgList.length; i++) {
                check(processorOrgList[i], true)
            }
        }

        return list;
    },
    //saveDocumentEditor
    submitWork: function (routeName, opinion, medias, callback, processor, data, appendTaskIdentityList, processorOrgList, callbackBeforeSave) {
        if (!this.businessData.control["allowProcessing"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            this.app.content.unmask();
            if (processor && processor.node) processor.node.unmask();
            return false;
        }

        if (!this.formValidation(routeName, opinion, medias)) {
            this.app.content.unmask();
            //this.app.notice("", "error", target, where, offset);
            if (callback) callback();
            return false;
        }
        if (!this.validation(routeName, opinion, processor, medias)) {
            //this.app.content.unmask();
            if (processor && processor.node) processor.node.unmask();
            //if (callback) callback();
            return false;
        }
        if (!opinion) {
            var idx = this.businessData.task.routeNameList.indexOf(routeName);
            if (this.businessData.task.routeOpinionList[idx]) {
                opinion = this.businessData.task.routeOpinionList[idx];
            }
            // else{
            //     opinion = routeName;
            // }
        }
        this.fireEvent("beforeProcess");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcess");
        // if (this.documenteditorList) {
        //     this.documenteditorList.each(function (module) {
        //         module.save(history);
        //     });
        // }

        //处理忽略授权
        var ignoreEmpowerIdentityList = this.getIgnoreImpowerIdentity(processorOrgList);

        var _self = this;
        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            if (callbackBeforeSave) callbackBeforeSave();
            this.fireEvent("beforeSave");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeSave");
            this.saveFormData(function (json) {
                this.businessData.task.routeName = routeName;
                this.businessData.task.opinion = opinion || "";

                var mediaIds = [];
                if (medias && medias.length) {
                    medias.each(function (file) {
                        var formData = new FormData();
                        formData.append("file", file);
                        formData.append("site", "$mediaOpinion");
                        this.workAction.uploadAttachment(this.businessData.work.id, formData, file, function (json) {
                            mediaIds.push(json.data.id);
                        }.bind(this), null, false);
                    }.bind(this));
                }
                if (mediaIds.length) this.businessData.task.mediaOpinion = mediaIds.join(",");

                if (appendTaskIdentityList && appendTaskIdentityList.length) {
                    var list = [];
                    appendTaskIdentityList.each(function (identity) {
                        if (typeOf(identity) === "object") {
                            list.push(identity.distinguishedName || identity.unique || identity.id)
                        } else {
                            list.push(identity);
                        }
                    }.bind(this));
                    this.businessData.task.appendTaskIdentityList = list;
                }

                this.businessData.task.ignoreEmpowerIdentityList = ignoreEmpowerIdentityList;

                this.fireEvent("afterSave");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterSave");

                // var promiseList = [];
                // if (this.documenteditorList && this.documenteditorList.length) {
                //     var promiseList = [];
                //     this.documenteditorList.each(function (module) {
                //         promiseList.push(module.checkSaveNewHistroy());
                //     });
                // }
                // Promise.all(promiseList).then(function(){
                    this.workAction.processTask(function (json) {
                        //if (processor) processor.destroy();
                        //if (processNode) processNode.destroy();
                        if (callback) callback(json);

                        this.taskList = json.data;
                        this.fireEvent("afterProcess");
                        if (this.app && this.app.fireEvent) this.app.fireEvent("afterProcess");
                        //    this.notice(MWF.xApplication.process.Xform.LP.taskProcessed, "success");
                        this.addMessage(json.data, true);

                        if (this.app.taskObject) this.app.taskObject.destroy();

                        if (this.closeImmediatelyOnProcess) {
                            this.app.close();
                        } else if (typeOf(this.showCustomSubmitedDialog) === "function") {
                            this.showCustomSubmitedDialog(json.data);
                        } else if (layout.mobile) {
                            //移动端页面关闭
                            _self.finishOnMobile()
                        } else {
                            if (this.app.inBrowser) {
                                if (this.mask) this.mask.hide();
                                if (this.json.isPrompt !== false) {
                                    this.showSubmitedDialog(json.data);
                                } else {
                                    if (this.json.afterProcessAction == "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
                                        var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
                                        (new URI(url)).go();
                                    } else {
                                        this.app.close();
                                    }
                                }
                                //}

                            } else {
                                this.app.close();
                            }
                        }
                        //window.setTimeout(function(){this.app.close();}.bind(this), 2000);
                    }.bind(this), null, this.businessData.task.id, this.businessData.task);
                // }.bind(this), function(){});

            }.bind(this), null, true, data, true);

        }.bind(this));
    },
    showSubmitedDialog: function (data) {
        var content = this.getMessageContent(data, this.json.submitedDlgStyle ? this.json.submitedDlgStyle.maxTitleLength : 60);
        //if( this.json.submitedDlgUseNotice ){
        //    MWF.xDesktop.notice("success", {x: "right", y:"top"}, content);
        //    if (this.json.isPrompt!==false){
        //        if (this.json.promptCloseTime!=0){
        //            var t = this.json.promptCloseTime || 2;
        //            t = t.toInt()*1000;
        //            var _work = this;
        //            window.setTimeout(function(){ _work.app.close();}, t);
        //        }
        //    }else{
        //        this.app.close();
        //    }
        //}else{
        var div = new Element("div", { "styles": { "margin": "10px 10px 0px 10px", "padding": "5px", "overflow": "hidden", "width": "270px" } }).inject(this.app.content);
        div.set("html", content);
        var timerNode = new Element("div", { "styles": { "margin-top": "5px" } }).inject(div);
        var options = {
            "content": div,
            "isTitle": false,
            "width": 350,
            "height": 180,
            "buttonList": [
                {
                    "text": this.app.lp.closePage,
                    "action": function () {
                        dlg.close();
                        if (this.json.afterProcessAction == "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
                            var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
                            (new URI(url)).go();
                        } else {
                            this.app.close();
                        }
                    }.bind(this)
                }
            ]
        };
        if (this.json.submitedDlgStyle) {
            options = Object.merge(options, this.json.submitedDlgStyle);
            if (this.json.submitedDlgStyle.contentStyle) {
                div.setStyles(this.json.submitedDlgStyle.contentStyle);
                delete options.contentStyle;
            }
        }
        var size = this.app.content.getSize();
        switch (options.promptPosition || this.json.promptPosition || "righttop") {
            case "lefttop":
                options.top = 10;
                options.left = 10;
                options.fromTop = 10;
                options.fromLeft = 10;
                break;
            case "righttop":
                options.top = 10;
                options.left = size.x - options.width - 10;
                options.fromTop = 10;
                options.fromLeft = size.x - 10;
                break;
            case "leftbottom":
                options.top = size.y - options.height - 10;
                options.left = 10;
                options.fromTop = size.y - 10;
                options.fromLeft = 10;
                break;
            case "rightbottom":
                options.top = size.y - options.height - 10;
                options.left = size.x - options.width - 10;
                options.fromTop = size.y - 10;
                options.fromLeft = size.x - 10;
                break;
            default:
                delete options.top;
                delete options.left;
                delete options.fromTop;
                delete options.fromLeft;
        }
        var _work = this;
        options.onPostLoad = function () {

            var dialog = this;
            dialog.node.setStyle("display", "block");
            var nodeSize = div.getSize();
            dialog.content.setStyles({
                //"width" : nodeSize.x,
                "height": nodeSize.y
            });
            dialog.setContentSize();

            if ((options.promptCloseTime || _work.json.promptCloseTime) != 0) {
                var t = options.promptCloseTime || _work.json.promptCloseTime || 2;
                t = t.toInt() * 1000;

                if (options.isCountDown) {
                    timerNode.set("text", _work.app.lp.closePageCountDownText.replace("{second}", Math.ceil(t / 1000).toString()));
                    t = t - 1000;

                    var countDown = function () {
                        if (t > 0) {
                            timerNode.set("text", _work.app.lp.closePageCountDownText.replace("{second}", Math.ceil(t / 1000).toString()));
                            t = t - 1000;
                            window.setTimeout(countDown, 1000);
                        } else {
                            dlg.close();

                            if (_work.json.afterProcessAction == "redirect" && _work.json.afterProcessRedirectScript && _work.json.afterProcessRedirectScript.code) {
                                var url = _work.Macro.exec(_work.json.afterProcessRedirectScript.code, _work);
                                (new URI(url)).go();
                            } else {
                                _work.app.close();
                            }
                        }
                    };
                    window.setTimeout(countDown, 1000);
                } else {
                    window.setTimeout(function () {
                        if (_work.json.afterProcessAction == "redirect" && _work.json.afterProcessRedirectScript && _work.json.afterProcessRedirectScript.code) {
                            var url = _work.Macro.exec(_work.json.afterProcessRedirectScript.code, _work);
                            (new URI(url)).go();
                        } else {
                            _work.app.close();
                        }
                    }, t);
                }
            }
        };
        var dlg = o2.DL.open(options);

    },
    startDraftProcess: function () {
        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        this.saveFormData(function () {
            this.workAction.startDraft(this.businessData.work.id, function (json) {
                this.app.options.workId = json.data[0].work;
                if (layout.mobile || !layout.desktop.message) {
                    if (layout.notice) {
                        layout.notice(MWF.xApplication.process.Xform.LP.processStartedMessage + "“[" + json.data[0].processName + "]" + (this.businessData.data.title || this.businessData.data.subject));
                    }
                } else {
                    if (layout.desktop.message) {
                        var msg = {
                            "subject": MWF.xApplication.process.Xform.LP.processStarted,
                            "content": "<div>" + MWF.xApplication.process.Xform.LP.processStartedMessage + "“[" + json.data[0].processName + "]" + (this.businessData.data.title || this.businessData.data.subject) + "”</div>"
                        };

                        var tooltip = layout.desktop.message.addTooltip(msg);
                        var item = layout.desktop.message.addMessage(msg);
                    }
                }
                if (layout.app && layout.app.inBrowser) {
                    if (layout.app) layout.app.$openWithSelf = true;
                    layout.desktop.openApplication(null, "process.Work", { "workId": this.app.options.workId, "action": "processTask" });
                }
                this.app.options.action = "processTask";
                this.app.reload();

                //this.app.notice(MWF.xApplication.process.Xform.LP.dataSaved, "success");
                //草稿模式暂时不能上传附件，不能直接流转文件
                // o2.Actions.invokeAsync([
                //     {"action": this.workAction, "name": "loadWork"},
                //     {"action": this.workAction, "name": "getWorkControl"},
                //     {"action": this.workAction, "name": "getWorkLog"},
                //     {"action": this.workAction, "name": "getRecordLog"},
                //     {"action": this.workAction, "name": "listAttachments"}
                // ], {"success": function(json_work, json_control, json_log, json_record, json_att){
                //     if (json_work && json_control && json_log && json_att){
                //         this.app.parseData(json_work.data, json_control.data, null, json_log.data, json_record.data, json_att.data);
                //         var workData = json_work.data;
                //         this.businessData.activity = workData.activity;
                //         this.businessData.originalData = Object.clone( this.businessData.data );
                //         this.businessData.taskList = workData.taskList;
                //         this.businessData.task = this.getCurrentTaskData(workData);
                //         this.businessData.taskList = workData.taskList;
                //         this.businessData.readList = workData.readList;
                //         this.businessData.work = workData.work;
                //         this.businessData.workCompleted = (workData.work.completedTime) ? workData.work : null;
                //
                //         this.businessData.workLogList = json_log.data;
                //         this.businessData.recordList = json_record.data;
                //         this.businessData.attachmentList = json_att.data;
                //         this.businessData.control = json_control.data;
                //
                //         if (this.businessData.task){
                //             this.processWork();
                //         }else{
                //             this.app.options.workId = json.data[0].work;
                //             this.app.reload();
                //         }
                //     }
                // }.bind(this), "failure": function(){}}, json.data[0].work);

            }.bind(this));
        }.bind(this), null, false, null, false, true)
    },
    getCurrentTaskData: function (data) {
        if ((data.currentTaskIndex || data.currentTaskIndex === 0) && data.currentTaskIndex != -1) {
            this.app.options.taskId = this.businessData.taskList[data.currentTaskIndex].id;
            return this.businessData.taskList[data.currentTaskIndex];
        }
        return null;
    },

    processWork: function () {
        var _self = this;

        if (!this.businessData.work.startTime) {
            this.startDraftProcess();
        } else if (this.json.submitFormType === "select") {
            this.processWork_custom();
        } else if (this.json.submitFormType === "script") {
            this.processWork_custom();
        } else {
            if (this.json.mode == "Mobile") {
                setTimeout(function () {
                    this.processWork_mobile();
                }.bind(this), 100);
            } else {
                this.processWork_pc();
            }
        }
    },
    processWork_custom: function () {
        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }


        if (!this.submitFormModule) {
            if (!MWF["APPSubmitform"]) {
                MWF.xDesktop.requireApp("process.Xform", "Subform", null, false);
            }
            var submitFormContainer = new Element("div").inject(layout.mobile ? $(document.body) : this.app.content);
            this.submitFormModule = new MWF["APPSubmitform"](submitFormContainer, this.json, this);
            this.submitFormModule.addEvent("afterModulesLoad", function () {
                this.submitFormModule.show();
            }.bind(this))
            this.submitFormModule.load();
        } else {
            this.submitFormModule.show();
        }
    },
    processWork_pc: function () {
        var _self = this;
        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        // MWF.require("MWF.widget.Mask", function() {
        //     this.mask = new MWF.widget.Mask({"style": "desktop", "zIndex": 50000});
        //     this.mask.loadNode(this.app.content);

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        var setSize = function (notRecenter) {

            var dlg = this;
            if (!dlg || !dlg.node) return;
            dlg.node.setStyle("display", "block");
            var size = processNode.getSize();
            dlg.content.setStyles({
                "height": size.y,
                "width": size.x
            });

            var s = dlg.setContentSize();
            // if ( dlg.content.getStyle("overflow-y") === "auto" && dlg.content.getStyle("overflow-x") !== "auto" ) {
            //     var paddingRight = (dlg.content.getStyle("padding-right").toInt() || 0 );
            //     if( paddingRight < 20 ){
            //         dlg.node.setStyle("width", dlg.node.getStyle("width").toInt() + 20 + "px");
            //         dlg.content.setStyle("width", dlg.content.getStyle("width").toInt() + 20 + "px");
            //     }
            // }
            if (!notRecenter) dlg.reCenter();
        }

        //var node = new Element("div", {"styles": this.css.rollbackAreaNode});
        var processNode = new Element("div", { "styles": this.app.css.processNode_Area }).inject(this.node);
        this.setProcessNode(processNode, "process", function (processor) {
            this.processDlg = o2.DL.open({
                "title": this.app.lp.process,
                "style": this.json.dialogStyle || "user",
                "isResize": false,
                "content": processNode,
                "maskNode": this.app.content,
                "positionHeight": 800,
                "maxHeight": 800,
                "maxHeightPercent": "98%",
                "minTop": 5,
                "width": "auto", //processNode.retrieve("width") || 1000, //600,
                "height": "auto", //processNode.retrieve("height") || 401,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            if (this.processor) this.processor.okButton.click();
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () {
                            this.processDlg.close();
                            if (this.processor) this.processor.destroy();
                        }.bind(this)
                    }
                ],
                "onPostLoad": function () {
                    processor.options.mediaNode = this.content;
                    setSize.call(this)
                }
            });

        }.bind(this), function () {
            if (this.processDlg) setSize.call(this.processDlg, true)
        }.bind(this));
    },
    processWork_mobile: function () {
        if (this.app.inBrowser) {
            this.app.content.setStyle("height", document.body.getSize().y);
        }

        this.fireEvent("beforeProcessWork");
        if (this.app && this.app.fireEvent) this.app.fireEvent("beforeProcessWork");
        var position = this.app.content.getPosition(this.app.content.getOffsetParent());

        if (this.json.mode != "Mobile") {
            this.app.content.mask({
                "destroyOnHide": true,
                "style": this.app.css.maskNode,
                "useIframeShim": true,
                "iframeShimOptions": { "browsers": true },
                "onShow": function () {
                    this.shim.shim.setStyles({
                        "opacity": 0,
                        "top": "" + position.y + "px",
                        "left": "" + position.x + "px"
                    });
                }
            });
        }

        if (!this.formCustomValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }
        // MWF.require("MWF.widget.Mask", function() {
        //     this.mask = new MWF.widget.Mask({"style": "desktop", "zIndex": 50000});
        //     this.mask.loadNode(this.app.content);

        if (!this.formValidation("", "")) {
            this.app.content.unmask();
            //    if (callback) callback();
            return false;
        }

        var processNode = this.createProcessNode();

        //this.setProcessNode(processNode);
        this.setProcessNode(processNode);

        this.showProcessNode(processNode);
        processNode.setStyle("overflow", "auto");
        //}.bind(this));
    },

    createProcessNode: function () {
        var fromCss = this.app.css.processNode_from;
        var css = this.app.css.processNode;
        if (layout.mobile) {
            fromCss = this.app.css.processNodeMobile_from;
            css = this.app.css.processNodeMobile;

            // var contentSize = this.app.content.getSize();
            fromCss.width = "100%";
            css.width = "100%";
            fromCss.height = "100%";
            css.height = "100%";
        }

        if (this.json.mode == "Mobile") {
            var processNode = new Element("div", { "styles": fromCss }).inject(document.body);
        } else {
            var processNode = new Element("div", { "styles": fromCss }).inject(this.app.content);
        }


        processNode.position({
            relativeTo: this.app.content,
            position: "topcenter",
            edge: "topcenter"
        });
        return processNode;
    },
    getOpinion: function () {
        var opinion = "";
        var medias = [];
        Object.each(this.forms, function (m, id) {
            if (m.json.type === "Opinion") if (this.businessData.data[id]) opinion += " " + m._getBusinessSectionDataByPerson();
            if (m.handwritingFile) if (m.handwritingFile[layout.session.user.distinguishedName]) medias.push(m.handwritingFile[layout.session.user.distinguishedName]);
            if (m.soundFile) if (m.soundFile[layout.session.user.distinguishedName]) medias.push(m.soundFile[layout.session.user.distinguishedName]);
            if (m.videoFile) if (m.videoFile[layout.session.user.distinguishedName]) medias.push(m.videoFile[layout.session.user.distinguishedName]);
        }.bind(this));
        return { "opinion": opinion.trim(), "medias": medias };
    },
    setProcessNode: function (processNode, style, postLoadFun, resizeFun) {
        var _self = this;
        MWF.xDesktop.requireApp("process.Work", "Processor", function () {
            var op = this.getOpinion();
            var mds = op.medias;

            var innerNode;
            if (layout.mobile) {
                innerNode = new Element("div").inject(processNode);
            }

            this.processor = new MWF.xApplication.process.Work.Processor(innerNode || processNode, this.businessData.task, {
                "style": (layout.mobile) ? "mobile" : (style || "default"),
                "opinion": op.opinion,
                "tabletWidth": this.json.tabletWidth || 0,
                "tabletHeight": this.json.tabletHeight || 0,
                "onPostLoad": function () {
                    if (postLoadFun) postLoadFun(this);
                },
                "onResize": function () {
                    if (resizeFun) resizeFun();
                },
                "onCancel": function () {
                    processNode.destroy();
                    _self.app.content.unmask();
                    delete this;
                },
                "onSubmit": function (routeName, opinion, medias, appendTaskIdentityList, processorOrgList, callbackBeforeSave) {
                    if (!medias || !medias.length) {
                        medias = mds;
                    } else {
                        medias = medias.concat(mds)
                    }

                    var promise;
                    if (this.toWordSubmitList && this.toWordSubmitList.length){
                        var p = [];
                        this.toWordSubmitList.each(function(editor){
                            if (editor.docToWord) p.push(new Promise(function(resolve){ editor.docToWord(resolve) }));
                        });
                        Promise.all(p).then(function(){
                            _self.submitWork(routeName, opinion, medias, function () {
                                this.destroy();
                                processNode.destroy();
                                if (_self.processDlg) _self.processDlg.close();
                                delete this;
                            }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                        }.bind(this));
                    }else{
                        _self.submitWork(routeName, opinion, medias, function () {
                            this.destroy();
                            processNode.destroy();
                            if (_self.processDlg) _self.processDlg.close();
                            delete this;
                        }.bind(this), this, null, appendTaskIdentityList, processorOrgList, callbackBeforeSave);
                    }
                }
            }, this);
        }.bind(this));
    },
    showProcessNode: function (processNode) {
        if (layout.mobile) {
            processNode.setStyles(this.app.css.processNodeMobile)
        } else {
            var size = this.app.content.getSize();
            var nodeSize = processNode.getSize();

            var top = size.y / 2 - nodeSize.y / 2 - 20;
            var left = size.x / 2 - nodeSize.x / 2;
            if (top < 0) top = 0;

            this.app.css.processNode.top = "" + top + "px";
            this.app.css.processNode.left = "" + left + "px";

            var morph = new Fx.Morph(processNode, {
                "duration": 300,
                "transition": Fx.Transitions.Expo.easeOut
            });
            morph.start(this.app.css.processNode);
        }

    },


    confirm: function (type, e, title, text, width, height, ok, cancel, callback, mask, style) {
        MWF.require("MWF.xDesktop.Dialog", function () {
            var size = this.container.getSize();
            var x = 0;
            var y = 0;

            if (typeOf(e) === "element") {
                var position = e.getPosition(this.app.content);
                x = position.x;
                y = position.y;
            } else {
                if (Browser.name == "firefox") {
                    x = parseFloat(e.event.clientX || e.event.x);
                    y = parseFloat(e.event.clientY || e.event.y);
                } else {
                    x = parseFloat(e.event.x);
                    y = parseFloat(e.event.y);
                }

                if (e.target) {
                    var position = e.target.getPosition(this.app.content);
                    //var position =  e.target.getPosition();
                    x = position.x;
                    y = position.y;
                }
            }

            // if (Browser.Platform.ios){
            //     $("textdiv").set("text", "$(document.body).getScroll().y: "+$(document.body).getScroll().y);
            //     y = y-$(document.body).getScroll().y;
            // }

            if (x + parseFloat(width) > size.x) {
                x = x - parseFloat(width);
            }
            if (x < 0) x = 10;
            if (y + parseFloat(height) > size.y) {
                y = y - parseFloat(height);
            }
            if (y < 0) y = 10;

            //var x = parseFloat((Browser.name==="firefox") ? e.event.clientX : e.event.x);
            //var y = parseFloat((Browser.name==="firefox") ? e.event.clientY : e.event.y);

            // if (x+parseFloat(width)>size.x){
            //     x = x-parseFloat(width);
            // }
            if (x < 0) x = 20;
            if (!layout.mobile) { // pc上鼠标位置偏移20
                x = x - 20
            }
            var dlg = new MWF.xDesktop.Dialog({
                "title": title,
                "style": style || "o2",
                "top": y,
                "left": x,
                "fromTop": e.event.y,
                "fromLeft": (Browser.name === "firefox") ? e.event.clientX - 20 : e.event.x - 20,
                "width": width,
                "height": height,
                "text": text,
                "container": this.app.content,
                "maskNode": mask || this.app.content,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": ok
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": cancel
                    }
                ]
            });

            switch (type.toLowerCase()) {
                case "success":
                    if (this.json.confirmIcon && this.json.confirmIcon.success) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.success + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAB1hJREFUeNqsWGtsVEUUPnMf+y6rLcW2tDxUKARaikqgiWh8BlH8IwYkaozhh4nhB1FMTKkxQtQYQzRGE2JEfMRHYhQSVChgFYIGqLSUtoKUQmlp2b53u233de94zuzcZbfdbhdwkpPZmbl3zjffnHPuOcue/WgxZNnc3OT3cQ4rGIMlwNg8BjATGEwDDgHOeZdpQis3eKMR5Sd62kaO/PHp5QDub2ba9OtNTYnf2lQIcOO5igpr8eeT3kL9XneuCi6vAvYcFWxOBqrO6BlvZIx7w8PGwlG/uWZkwADNzo4//e7CfQMdYz/88t6F8/i+icB4Jl0sEzPIxEbsXiwotVd6C3TwTFezZRGCfQb4r0bhSnPo78io8dWP1ed24nRkPFNTMoMnnYNsbGYK2zR/pYsRGxJc1mDcuQqKHbwF2t3/Hh29a+3bC8oHOkM7UPk5UpGOpQQzFsINHyxahDaxdeYix/r8223AFLjpxpGL3rYIXDw5um+gc+ydwx9fqsPpKC0lP6eWr54hfjT+2gPP7Fg0R1HgreIyx/rpc2zxjfjNCzXXrSo4PMr8sWFecEuRo6mjMdBPdpQMJuWa6GoKF9jX55bo13UlE5jg8szobshyotG+RtT1OJrBAA43o/hRYhOYKVuVvxFtZPusCie7GUbQvcnmIBbh4noEoqR15zQV/N1GeXFZzvD5Y4P1ydclwJD7om1sn3uPs0S3x1++ESHlJgJB74FiXgkD4XZQLGr4NQtBh2DDvWa+3aOd7D4b7CGDFjcjr2dt3mxbpQNjB53sRsTA7YiN0IgBRWYlrJz2suhpTPO0bj1LegpKHWWFpZ6nUL0ngYOAUkBz34JAYjytEO1GJN5Pth4LmRAajkGxuQJWFb0CLpdL9DSmeVpPfp/0uXP1B2+b5y5A/cJbVLSVh9252uu5M/WM1BMYSLKBdFczS6mEx0peBbfbDU6nE1RVhdnOZdDj78AruyyvLP6+ZmMQDQMCYc3tp/xnKSAq9K2xuxmYBp8oeIJY2ITwSAxm8uWip7E43bj1ErYCHpsVB0KsOBwO0dOY5mdrlXhdSe+ikN6cPNtSeTsqgV2iOxRchFRBh4uGOSpCY8QTP5C/SfQ0pnkjmrq+es6WBBBN0wQrNpsNvF4vFBYWwgvL3ofFeY/EmZQ6SK/do5YiECeFGYW+vprGUu0AaY/iHYeDceqfmLtFKKGexjRP15K8ngxEUa6FbfpNwH5qfQua+w8lGCUhvbpDLZE2g8xgGkAhP4WRCJ3YhFk6KrozrignJ0f0NKb50LCRsp4OCJNu/X3LG3Cm92Dcm5LYJ71oO9MtMJrIRyguGzwRPelu5zoqYc28a4rodLqui2eexPk9/3DRTwXku6ZqaOo7KOw2bdqgMLf8EigaJUaxCHgT+yCY8hmPwrrFb4oNLbEUkGITj7iuoloozwTk28ZqONMzOZA4U3w07mLANMrQ0CO85GpWO+M7iKsMNlRsk2zxxP2TYo/HIwBZ43RAvmmohkZfzaRAqIlgGDH7rEChUaqIXrFQUVPfauiqEcifvWubUJAMiLwkLeUSyNenEMjVzECokTdGQman/FiaGuWs6DlrdNvENxs6DwCuw3PLtqcAygTkq5Nb4XT31EAEGIragVgrBTz6PmmUPBNdppH+hfrOGhEbnl8+OSALyJfHtwpGswFiXdNgV6jFAqPm3+7yOb36A5pdKaY906UF3f4LcNXfDhUlDyUUjwey+6+qOPAs0w8KH0NXI00nvu/aFQoaPnxtWKFyAhHui4Yw/0B20goyU3+5BnYfq0oASPYymqd1em7SPcYJ6fP7wn8OdYcp0RoRzFBiHPCFexRdqdR0VsRkzjpBiKGhC+BDhpbOfijBzOdHq+BU+4H4ic3sJIYRPtAbbWk+1Pv54JXQRdxmiExI+CTVNVROjI2YPGPeggrrLh2AXUeqBCvU09jk15f7kJ6+S6P7244PUT0VkDYTz/QoGf+ntr9h/srcIs2mLFVY5oyua7AVfIF2qGvbn5rFZSHESn9HaG/Nhxc/wxmylUErDxbMyBomQnVNcDC2Lyq9a1LB051o3T/hWzOV0L6D3eHalsN936K+PgkkYiWkyVWR+dsnl85RXRP0R3+OxbioEP4vof2GfOHac0f6v7h4cqhZghlNLldS6iZCiA/6qK7RnapLtSvlwCm43ES1QFdjco6s722q6d2NFcFp1NMjbSWWsdbGypIshj7POatfu+MlT55tnd2lljHOso1l18yIYYIeNFrIWGt3tv8o2SAZJu8h80iutRPMWE0aNFEXobqGygk0ar+iM5eqswIrqE0w3ASAeD8WjDX1d4ztIfet3+v7XRprL/0nQIxYtba8kan/hUDUikx8PJTFl96fdx/lrJQqUoZGiRHlI5QG0NeXPnr0raEQf7a2r04GtICU4FT/QmTDPJOGTqAcMnl2yrFNJkZWMIhJ7yAZk5E1JMfm+EI/naLraQRKlQBUKUoSGFNWh4YEZowv7jO1/wQYAIxJoZGb/Cz/AAAAAElFTkSuQmCC)");
                    }
                    break;
                case "error":
                    if (this.json.confirmIcon && this.json.confirmIcon.error) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.error + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABsVJREFUeNqkWFtsFGUU/nZn2r21IqX3llp6AQmkWDVGAgIlGI0EeMAHffAFa998MCQaE8JDxZCgSHzQKIm3qPHFGC7GW0xqkIgIKhhEwFJaKSDQUtplu73s7vidmX/q32F2uw2TnOzMv2fO+f5z/8fci7yvWAZYRXo4CCwLAM1cq+HvXRYwQrrM/7rTwB+TwC/dwKG3uU75mVxCO7T7wExgKHiBATzJ2411wMoy3pSQ5gg6UiFpgpQgDZNukK6TLgBHuf7lAPD5q8DfXMpQl5U3mA4P4ztAO3+2tADLCQSV+VsR/5L+If0G/EqgH78EvKtwT1lqr0en6SfoLaCe1niB7nj+CQIuV+uZWYApV8RNPPAVcP/rQMtF4I03gbNcpjdvt5KxQXs4SKKflxBI54PAs20EElNvZTQJucjLFyUtpZwioJVurFtMD/4MXBXWDUqnL5jHHYt0PgQ8da/4UFMwThpTz0HF7wfEj0/kSKwVAwsZU5U1wKkTwOBBj7GD08xE17QSSJPanVCKlCSNkM5s2mT/JtV6epZ8InclsH4R9TjYRKWPZQixnch2POJsZNpOb5HOb9yIi5s3I5XJIHb2rL2LoBZL+fBZKhOZaS3LgPgh4HcnYZ34scFI+goQxsj8iA+QHipItrejrKwMiaVLMZJIIEpFAaUkH76AFrEVfLxEzzEej/0FXFOGc8CQ8bmFTOE6DciEUnCBCsapoLGxETU1NYhGo7i+YAHiSlFauWMmvqAGKOzcVzDlh2mdo2o/loCJkeEVRnldSMsGUdCrKaiqqkJxcTEikQgKCgpsRbJzk4oukm8iB1+CfEUKkLtZub/CZOsFvht0Qi1lrAfW0WwvN3gyI7J1K+7ZswfNzc0oLS1FKBRCMBiEaZoIh8OOovp6jI6NYXLLFjQ1NdlAxCKGYaCwsBAlJSWoJ08lwQZTKaSPHJmSL9YZZWZx438eZ8yLMwwWtWeYaqvv9oBJ8UWDyovWrUMgEPi/ZPPeBWT/rlhhx0h1dbUNRABPpSrvBVhixw4kd+26rRyMOq3jCl31kzya0vSiKgW91/DOnbZJ53V22iAsy5pSIopra2vtNflP3KIDcTcwuH074pQT8JEvelkMF4kjpBuY0n1Dbjj7XDcpSCCU+gCKxWK+77hABghkOAsQuUIOivmq3xrSm2qMLJZxrwEKlGJQ5QGUC8gVBSSYQ67hoCidAiPzSCCHZSxVlXopeHhiAk30v8RBtivFQO3etg1Du3fbbihQKe0L3MmqmGrYwaAMRuPKMl6aVCkeJ11jRvSuWYO+vj4kk0lf4bIu/wuf8MfV+5NZ5I87RhhVuAKmTGhsbHPCWSwiwoYoOMQ60tDQgPLycjvNfWOA6/J/Op3GefJzsMLcAwfs6PSz0JhTXAfcBDNlVCS0xaYHSEql3jCBRLSC5k3faV1XZZnwySWABmUqJKCo8oUOaNTZbL9SlzE4Niwh8lURLf/TyoQzAZFgdcmvDklhjKsKXKAqsF5rZEztAboOAz+KA4xHmeo0+tNFqky7VMkKfJ+nAnuV2rtn1pS0td32n16B67kpRjZuqQrs6pB5mW37s5OswoLNaOTUdRfQRjPWGhrqOF80aYVSTwXWgfQQSL8URiqa6wGkV+B+ZuAlTwUWF/VxyPoUeD/uTH5x4xhjiNapoHXWhj3l+ubhw0hTkbtz3SXdBNJHIJgFn+Vx0Tlg37eOi+RAkTTk+MDueY1WWc64qQ5oZpSXhpSiedrOz1HBBVWZZ8Pn0phzcjj9DfBBvz1r4aYkrz3PvEhZq9lIyfgY3RXwzrY3lKKytWtxhgp6fHaaL5+AoU8stulPvgB+UFZJuPOMPaF/D5wgoGq6q9XMosianER3FiD58iWcDNr/GvCegwtDbjeywShAGQ5Y3aYzZC00PELsDkxFmOGokosv6cy/XV8DHyr3XFfL1rSBnL/WNqKUcw3rQWWhD6A7oaSTPV1dwEecX07CmX1v6W3Re4iz5IAl5xqCiTIMW0zJ5DsAkXKOLxbHy/1iEQ3IiHdYmAbGdZccsBhDXXKcoMAyWqjCynJwywVCqjgbz2kJVokR5RoXyKRkctYTpQ5Iepica+Q4QesMU0GUoCozPjGS0QZ5t9uzJ51ioO6T9FVZc1XFiLgm5X6ROJjvJ5EOZ4iXwaeIs2Elz1WreExtlVFRJjQZjGQekTFAuq80PRazbp6JTtOyxy87FX9EkYCY8H6v6fDMNzNdagayQYXVZ5mIei7UmrHrnQlFSZXJY9qnECuXIjMPMJZ2lHIPj6aaGg0FNOD5CJHWjtl5f0n5T4ABAFHaXG6UVjGNAAAAAElFTkSuQmCC)");
                    }
                    break;
                case "info":
                    if (this.json.confirmIcon && this.json.confirmIcon.info) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.info + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABvBJREFUeNqsWF1sFFUUPndm9n+3W5aWLi2VGgJtgy3UEn6MQGI0GgmC0UgfTEjEBxPDA29qYqLGGOODifGBGGOUYOKDPIg2QgykWgUtP1WgLT+lFKFCf9l2uz+z83c9Z3p3u1u6u4Pxpqczd+7MPd8999xzvrPskb2fgsMW4NzaBpxvBsbWMWCrgUEdAKsA4HHO+R2wrOucmxe5qZ9Jjt3ovtX1eRznt0pN2ndof+5eKYcAJ34YJPlFvH3OFV7+uOyPgOQLg+wJAXP5gMkueifM9XTYzMw2W+mZnWbqHjDF09Pc8WFneur2kaHOjwbxewuB8VK6WCnLoCVexcsrnmWNW1zhKMiBKqdWBDM5CfrMKKh3+8+bWurw1W/f/gwfawstVdYyuNIGtMYBxqT9/lVbmRyIZMFlUeKfCdyiPi0WN02ScPdkvGX2KxJa0IOiVETbU0O/Ptr00getamzkY1R+lbAuZiV52fpnC4FY5lqQpPe80bX7/A2bmIRbQcpzggAQLFhaGiw1aV+5nqEPEQcjWDnAJJLLC57q1Ux2+9tATzwUXN40PH3j7Nj4hWMW6cbr4mDmLIJAals63Esbsk8LhFsGAkjBY3UaPN8M8HKbBGsiHBRmwK1pEy0kC+Pkf4eK/EtA8gTX8Mxs1Lukti9+6+IUAco3ROE24dZ4apo6XEvq57dkQbPQKtsQ575NleB1z30erQbYsMoApScJ3bd1kMRWLWw0r9/Ud+Ci72H3AMoMinGfZchZ0Ufe961Yz/LNvFBoi/ZuDMKaukoIBAIQDofB7XaD1+MGl8Thl6EMWkYq+r3srQAzfrc1VN8yG7t26k/UpGfNJ+WOL54ab30746TQMkuIBVuaaiAUCoHf7wdFUewr9ek5jZf8HucnPe7Q0j3R9t0tqNdtn4AsGIoj7sjKLbI3ZDtiKSEnvTyqgSzLhScB+/ScxsvNQXq8NY0twdrGF/DTYBYH/QtQQJN9lbZzlhOa7MRADHRDnB4h1KfnNO5kHtLnCkSeCERXR4V1QK5e98yTij/ypquyrug+Fwhu7+BoGsbjGngVCaoq3NA7PAuHT4/BjxdjUMrf8oUpqN/IRNGO/TM3e69QQFQo1zB3wN7PMokht+802Q/nUij/5MVyNnesJTnrAmUb6UXfacPb71ESCiU9CkxQBsxcfFHB0tXFjz2CkRQP5iw/AlIcgSG9sjfYiLc+CjMKZV8mk4GM0mBw/MDTUdjc4ANVVUHXdftk5AIWnqozf6tw8FQc44yz/EV6ZZe3XvgM9ogGUFwoYxmav7IyAitXLgNN0yCRSNiAcgHN5YJdyyU42N2LSzYdopHId6rmwdh8BBz4DMA7Ry7D71fG4d2OFjvQFVqOg2EY837lsGGADIhMIFGojIOpoWUMB2LCsd4RSGdKbKmjeYSgXgSeEoZnCjE0y8iEMa06Wgk3DQxOJiZvdFhJWsTRnVuGIxjL0CazGVWxqaKeaba5iLMZcoGu2Dg4BYPUA0/niEiWlkKc1TLUnXYQcjKBZZQd55azhaFeMNLx6xTwiHApRJ65oTleTdn3rAewDOpVY3cGcmCIxQfrPD3I6DYRuS5vGbPsuBOfISqiJyb7Jge6zmE3TVslUTmBCDs5miy3qqJCJ6CMItPMnbxSQvoyM2OnM9N3iWglbcsQW6dyAq2yW5Hk9rncUiQ3oSKT9hnjCTkwRd15DKb93DRwkQwToVw8R5Hl0CoDscE/TmI3jqLSBttnk+oaKiesTJIT4V5MuGHY5Ht7cxWk00jGrcL8RH16TuM2STcMKDYX6UlN3Dw+PdQzKMBoOdpJDH1qoOuvSOPWWklxt9krWkg3cTVv7NkAr+3aaFNNsko+n6G+z+eDra0PQU2lD37rv7MonSBfUaduHx0+/skXODqGEsvyYNsyoobRqK4xUrFOCkZ2vMgThqYPBUMQDAbtYJcPJCv0nMbpPXp/4Rw0L/pI12T/yW9Q36QAomU5cEFFiQWW0vDU6xu9kRVvuXwVO+wE+n81pB2Z+HjX1JXuQ1NzJ2i0aHVADbeLU4FFdY3s9vkll6eVAWcLa6cHFeQ/XL03cnTi0k9fYUVwgVQJXzGKVpTCfywqsBB9F5UTyDmq8aTVsP8Cgk5ZJjGQHL32NfkIBrjhPCA6uUfRijIfEO0l1TWKJ3gWnXoG61w/U1zRnFPC/VVjlvFRM9REH4aM7yYunfhy7PzRn4WzThC9pOFsrZ0PpuSvEOhDkiA+QWLxS5u2byPOSlSRGBoRI+IjRAMo+1LSo1xDIZ4iqwhocSGJcr9COCGITJw6AuUVpY1P9N2CGDFhHkOcDk2E+KQIaNS3Ck24uKIHaQRKFgBkIVIeGFJoCjHE1XI6+b8CDABnZtjY0mkIGQAAAABJRU5ErkJggg==)");
                    }
                    break;
                case "warn":
                    if (this.json.confirmIcon && this.json.confirmIcon.warn) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.warn + ")");
                    } else {
                        dlg.content.setStyle("background-image", "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAjCAYAAAAe2bNZAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABgtJREFUeNqsWG2IlFUUft6vmdlZd539GFdTY5VMomy1oBJUSPLXkmQt5I8gCIMK+iH0K4ooEvtTRP7JX9JKWCC1mUUkIkQKSoaZH60t2pboOK37Mc6Ozsw779t57t5xx5ndnTvhC4d373nnnnPuOeee85y1Jr+G6dNcCrBB6AnbQo9tY4UFLLYstIYhMsK/IjRULOF0voATx87jp60fICPygzmFbpn+26pnzK0ilrk2+kTp5kgC6+w4YDfJxpiQJ+QAYUmoKHQLCG4K5YDsCI7fzOPgcBr7172BP0VUILrC/22MnHSbvF6KLcRap1WMmGfsRQRZ2Z8BJv7BybEs9t6/DbuFXaj2VKUx7ize6BZvbHcdvB67D5bdrD/ocwUiruiLZPFGSbziiHci4iVPpEn41MM9pPZWPBofwiOX9uDh05fwkSgf5Dln8lKNZwo+HnRsvBVbjK1eJ39RdWIxJCfhGB0HxjNTBtGQhHiuPQHEY9MG3X5EbXEESA3i4KmL2Ln5Xfwi3CINmjVM9IjnYGeTGOJ2zOx+SU5cE8Hp/DMIopvgxFejlDsFO38IC6ID6JIDRCMz7/WvA1cG8d2PJ/H2y5/gLA2a9ndVmBia2CIxpL3yJ1XG5MUzTh8S3e/B9Zo09x74xSeRS7vyfT+i3sx7KXfRCvSuz2NUltuFJmhj+btdmazMEa+NsZidfIYlsQXzE51oa2tDV1eXenNNPr/PtZ/ylybxwtEP8Ypw4pU22OXrq27NvZIh4dzCeI07lvQiHo8jFovBdV315pp8fp9rP+VTT/cCPL/jRawSTqScma4OT1+sA2vtqN4w552V03meMsKyprLblowlj2s/qC+DepJLsWpjD56T5aDOnRI908yC5jTVOVEl1THWhKhPwrVx/UNYqL0DmyU+0iyVNWooKKxjTGgmh/o6k+h5tRcbhBNTDla9JtKAV+6SZ5RBondZF9YwOkKOq5qeZ6CkUpmJMQYP9Xa0YqX8ySRxXdV9bXMBloShnLg134RvhQ3IEr2tTViqc8ZxNQwwFuCJANsqiOJ4jSHke40cTPQ2RdFZNsYmHrEaiHVEmqI/drTGO+paC5/fTWVRghTaZl1ibJvAqG6hqqygIsG+/iXCID8VFk1ck+9Z5rKoV8BYThc9yyVCE2A0nyDJKOmEoiP98GV7mNwKO7EOwfjPwL9fKL7q2CUzWTRGANiILgghjRkKfTwAyxw4cWt4pR+F4X72NAn2FIxQzg4aECMtcmISl3WzDFxi1sDH046hZ4JQ45kbgmeyFXhGUGB7i8YzhgcTvbg2jiHCKPrTJXgmE56ZgKIoH5XGn/YEz3QLnpm/GrcmTiE9dkiOOaBuU9QzN+bsMM7dNoYo/qk1OC597vEahDbDU5BtuVbBMysr8ExS45lBV74LnjHwMhFjahRndn2rUN9NhsrmOEEUX/LNbgB/F13yLBJtyTvwDNfkNyLnj8s4dv5vBbQmVdcmWuc4IYl0MjC44jz0guWb0NLSojAMoQTfXJPvGNQs6hGvnNt7GIeFkyGk4hcVGM41HCcEZIV1ix53jJ+QieDOWKi18CN2fWOo58QF/PD5ETVPZXTO3IZ8Aeea9Dj2FOt4R7WDq1L0SlVFT9bke3WMofzf/8I3fTvwlXAYomy5IChj9AxT4FyTmsBBPyyXoVpSRe9qP8LfXkNw7ZAaIfnmmnwbs++l3AspHPl4APuEw2I3pr0S1owqMsO4B97BYz3L8eaiFvR6uHsPceWFNI7s/h6f7TqgblBq1umgPCRwwOJcc3EEe3NsOXN4yYRUkRQ5vw5j4P19+FQbkha6Ud04aiZK8Y6lS2ALxwmi+GQcqxyGKDT3RCBSSkKpLM4xWXWOjGi6UXeirDKI1yXOcYIonuC5s1lQoTbKKlPZCdYUBZpSGZxhHeH11bdmVOdIrnLWNv4vhPzQ1sBnHlE8wTMxK6EiERqBEfEIYQC7L5seew1LPCurLmgZTdl6/4UwaWmWzq2IRvHNGrNGNLmYdpCvb0dBl/hJXdAKJrOF1eClsHX4XP12NM+qGFJKmnz9NgYV/wkwAMYATK0QLuhAAAAAAElFTkSuQmCC)");
                    }
                    break;
                default:
                    if (this.json.confirmIcon && this.json.confirmIcon.warn) {
                        dlg.content.setStyle("background-image", "url(" + this.json.confirmIcon.warn + ")");
                    }
                    break;
            }
            dlg.show();
        }.bind(this));
    },
    alert: function (type, title, text, width, height) {
        this.app.alert(type, "center", title, text, width, height);
    },
    notice: function (content, type, target, where, offset, option) {
        if (!where) where = { "x": "right", "y": "top" };
        //if (!target) target = this.node;
        if (!type) type = "ok";
        var noticeTarget = target || this.app.window.content;
        var off = offset;
        if (!off) {
            off = {
                x: 10,
                y: where.y.toString().toLowerCase() == "bottom" ? 10 : 10
            };
        }
        var options = {
            type: type,
            position: where,
            move: false,
            target: noticeTarget,
            delayClose: (type === "error") ? 10000 : 5000,
            //delayClose: 20000000,
            offset: off,
            content: content
        }
        if (this.json.noticeStyle) {
            options = Object.merge(options, this.json.noticeStyle);
        }
        if (this.json["notice" + type.capitalize() + "Style"]) {
            options = Object.merge(options, this.json["notice" + type.capitalize() + "Style"]);
        }
        if (option && typeOf(option) === "object") {
            options = Object.merge(options, option);
        }
        new mBox.Notice(options);
    },
    addSplit: function () {
        if (!this.businessData.control["allowAddSplit"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 600;
            var height = 230;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.app.lp.addSplit,
                //"style": "work","
                "style": this.json.dialogStyle || "user",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "split.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            //this.doResetWork(dlg);
                            var input = dlg.content.getElement("input");
                            var checks = dlg.content.getElements(".o2_addSplit_radio");
                            var value = input.get("value");
                            var trimExist = true;
                            if (checks[1].checked) trimExist = false;
                            _self.doAddSplit(dlg, value, trimExist);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    //var okButton = dlg.content.getElement(".o2_addSplit_okButton");
                    //var cancelButton = dlg.content.getElement(".o2_addSplit_cancelButton");
                    var selectButton = dlg.content.getElement(".o2_addSplit_selector");
                    var input = dlg.content.getElement("input");
                    var checks = dlg.content.getElements(".o2_addSplit_radio");

                    //okButton.addEvent("click", function(){
                    //    var value = input.get("value");
                    //    var trimExist = true;
                    //    if (checks[1].checked) trimExist = false;
                    //    _self.doAddSplit(this, value, trimExist);
                    //}.bind(this));
                    //cancelButton.addEvent("click", function(){
                    //    this.close();
                    //}.bind(this));
                    selectButton.addEvent("click", function () {
                        var value = input.get("value");
                        MWF.xDesktop.requireApp("Selector", "package", function () {
                            new o2.O2Selector(_self.app.content, {
                                "type": "",
                                "count": 0,
                                "values": (value) ? value.split(o2.splitStr) : [],
                                "types": ["unit", "identity", "group", "role"],
                                "onComplete": function (items) {
                                    var v = [];
                                    items.each(function (item) {
                                        v.push(item.data.distinguishedName);
                                    });
                                    input.set("value", v.join(", "));
                                }
                            });
                        }.bind(this));
                        //_self.selectSplitUnit(this);
                    }.bind(this));
                }
            });
            dlg.show();
        }.bind(this));
    },
    doAddSplit: function (dlg, splitValues, trimExist) {
        if (!splitValues) {
            this.app.notice(MWF.xApplication.process.Xform.LP.inputSplitValue, "error", dlg.node);
            return false;
        }
        MWF.require("MWF.widget.Mask", function () {
            var splitValue = splitValues.split(o2.splitStr);
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeAddSplit");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeAddSplit");

            this.addSplitWork(splitValue, trimExist, function (json) {
                this.fireEvent("afterAddSplit");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddSplit");
                this.addAddSplitMessage(json.data);
                // this.workAction.loadWork(function(workJson){
                //     this.fireEvent("afterAddSplit");
                //     if (this.app && this.app.fireEvent) this.app.fireEvent("afterAddSplit");
                //     this.addAddSplitMessage(workJson.data);
                // }.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));
    },
    addSplitWork: function (splitValue, trimExist, success, failure) {
        var data = { "splitValueList": splitValue, "trimExist": trimExist };
        if (this.options.readonly) {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id, data, function (json) {
                if (success) success(json);
            }.bind(this),
                function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                });
            // this.workAction.addSplit(
            //     function (json) {
            //         if (success) success(json);
            //     }.bind(this),
            //     function (xhr, text, error) {
            //         if (failure) failure(xhr, text, error);
            //     },
            //     this.businessData.work.id, data
            // );
        } else {
            this.saveFormData(
                function (json) {
                    o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2AddSplit(this.businessData.work.id, data, function (json) {
                        if (success) success(json);
                    }.bind(this),
                        function (xhr, text, error) {
                            if (failure) failure(xhr, text, error);
                        });
                    // this.workAction.addSplit(
                    //     function (json) {
                    //         if (success) success(json);
                    //     }.bind(this),
                    //     function (xhr, text, error) {
                    //         if (failure) failure(xhr, text, error);
                    //     },
                    //     this.businessData.work.id, data
                    // );
                }.bind(this),
                function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                }, true, null, true
            );
        }

    },
    setRollBackChecked: function (item) {
        item.store("isSelected", true);
        item.setStyles(this.css.rollbackItemNode_current);

        item.getFirst().setStyles(this.css.rollbackItemIconNode_current);

        var node = item.getLast().getFirst();
        node.getFirst().setStyles(this.css.rollbackItemActivityNode_current);
        node.getLast().setStyles(this.css.rollbackItemTimeNode_current);

        node = item.getLast().getLast();
        node.getFirst().setStyles(this.css.rollbackItemTaskTitleNode_current);
        node.getLast().setStyles(this.css.rollbackItemTaskNode_current);

        var checkeds = item.getElements("input");
        if (checkeds) checkeds.set("checked", true);
    },
    setRollBackUnchecked: function (item) {
        item.store("isSelected", false);
        item.setStyles(this.css.rollbackItemNode);

        item.getFirst().setStyles(this.css.rollbackItemIconNode);

        var node = item.getLast().getFirst();
        node.getFirst().setStyles(this.css.rollbackItemActivityNode);
        node.getLast().setStyles(this.css.rollbackItemTimeNode);

        node = item.getLast().getLast();
        node.getFirst().setStyles(this.css.rollbackItemTaskTitleNode);
        node.getLast().setStyles(this.css.rollbackItemTaskNode);

        var checkeds = item.getElements("input");
        if (checkeds) checkeds.set("checked", false);
    },
    getRollbackLogs: function (rollbackItemNode) {
        var _self = this;
        o2.Actions.load("x_processplatform_assemble_surface").WorkLogAction.listRollbackWithWorkOrWorkCompleted(this.businessData.work.id, function (json) {

            json.data.each(function (log) {
                //if (!log.splitting && log.connected && (log.taskCompletedList.length || log.readList.length || log.readCompletedList.length)) {
                if (!log.splitting && log.connected) {
                    var node = new Element("div", { "styles": this.css.rollbackItemNode }).inject(rollbackItemNode);
                    node.store("log", log);
                    var iconNode = new Element("div", { "styles": this.css.rollbackItemIconNode }).inject(node);
                    var contentNode = new Element("div", { "styles": this.css.rollbackItemContentNode }).inject(node);

                    var div = new Element("div", { "styles": { "overflow": "hidden" } }).inject(contentNode);
                    var activityNode = new Element("div", { "styles": this.css.rollbackItemActivityNode, "text": log.fromActivityName }).inject(div);
                    var timeNode = new Element("div", { "styles": this.css.rollbackItemTimeNode, "text": log.arrivedTime }).inject(div);
                    div = new Element("div", { "styles": { "overflow": "hidden" } }).inject(contentNode);
                    var taskTitleNode = new Element("div", { "styles": this.css.rollbackItemTaskTitleNode, "text": this.app.lp.taskCompletedPerson + ": " }).inject(div);

                    if (log.taskCompletedList.length) {
                        log.taskCompletedList.each(function (o) {
                            var text = o2.name.cn(o.person) + "(" + o.completedTime + ")";
                            var check = new Element("input", {
                                "value": o.identity,
                                "type": "checkbox",
                                "styles": this.css.rollbackItemTaskCheckNode
                            }).inject(div);
                            check.addEvent("click", function (e) {
                                e.stopPropagation();
                            });
                            var taskNode = new Element("div", { "styles": this.css.rollbackItemTaskNode, "text": text }).inject(div);
                        }.bind(this));
                    } else {
                        var text = this.app.lp.systemFlow;
                        var taskNode = new Element("div", { "styles": this.css.rollbackItemTaskNode, "text": text }).inject(div);
                    }



                    node.addEvents({
                        "mouseover": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (!isSelected) this.setStyles(_self.css.rollbackItemNode_over);
                        },
                        "mouseout": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (!isSelected) this.setStyles(_self.css.rollbackItemNode)
                        },
                        "click": function () {
                            var isSelected = this.retrieve("isSelected");
                            if (isSelected) {
                                _self.setRollBackUnchecked(this);
                            } else {
                                var items = rollbackItemNode.getChildren();
                                items.each(function (item) {
                                    _self.setRollBackUnchecked(item);
                                });
                                _self.setRollBackChecked(this);
                            }
                        }
                    });
                }
            }.bind(this));

        }.bind(this), null, false);

    },
    rollback: function () {
        if (!this.businessData.control["allowRollback"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        var lp = MWF.xApplication.process.Xform.LP;
        var node = new Element("div", { "styles": this.css.rollbackAreaNode });
        var html = "<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:left;\">"+lp.selectRollbackActivity+"</div>";
        html += "<div style=\"line-height: 30px; height: 30px; color: #333333; overflow: hidden;float:right;\"><input class='rollback_flowOption' checked type='checkbox' />"+lp.tryToProcess+"</div>";
        html += "<div style=\"clear:both; max-height: 300px; margin-bottom:10px; margin-top:10px; overflow-y:auto;\"></div>";
        node.set("html", html);
        var rollbackItemNode = node.getLast();
        this.getRollbackLogs(rollbackItemNode);
        node.inject(this.app.content);

        var dlg = o2.DL.open({
            "title": this.app.lp.rollback,
            "style": this.json.dialogStyle || "user",
            "isResize": false,
            "content": node,
            "width": 600,
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function (d, e) {
                        this.doRollback(node, e, dlg);
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () { dlg.close(); }
                }
            ]
        });
    },
    doRollback: function (node, e, dlg) {
        var rollbackItemNode = node.getLast();
        var items = rollbackItemNode.getChildren();
        var flowOption = (node.getElement(".rollback_flowOption").checked);
        var _self = this;
        for (var i = 0; i < items.length; i++) {
            if (items[i].retrieve("isSelected")) {
                var text = this.app.lp.rollbackConfirmContent;
                var log = items[i].retrieve("log");
                var checks = items[i].getElements("input:checked");
                var idList = [];
                checks.each(function (check) {
                    var id = check.get("value");
                    if (idList.indexOf(id) == -1) idList.push(id);
                });

                text = text.replace("{log}", log.fromActivityName + "(" + log.arrivedTime + ")");
                this.app.confirm("infor", e, this.app.lp.rollbackConfirmTitle, text, 450, 120, function () {
                    _self.doRollbackAction(log.id, flowOption, dlg, idList);

                    dlg.close();

                    this.close();
                }, function () {
                    this.close();
                }, null, null, this.json.confirmStyle);
                break;
            }
        }
    },

    doRollbackAction: function (log, flowOption, dlg, idList) {
        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeRollback");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeRollback");

            this.doRollbackActionInvoke(log, flowOption, idList, function (json) {
                if (json.data.properties) {
                    if (this.app && this.app.fireEvent) this.app.fireEvent("afterRollback");
                    this.addRollbackMessage(json.data);

                } else {
                    var id = json.data.id;
                    this.workAction.listTaskByWork(function (workJson) {
                        this.fireEvent("afterRollback");
                        if (this.app && this.app.fireEvent) this.app.fireEvent("afterRollback");
                        this.addRollbackMessage_old(workJson.data);
                        //this.app.notice(MWF.xApplication.process.Xform.LP.rollbackOk+": "+MWF.name.cns(names).join(", "), "success");
                        //if (!this.app.inBrowser) this.app.close();
                    }.bind(this), null, id);
                }
                if (!this.app.inBrowser) this.app.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error");
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));
    },
    doRollbackActionInvoke: function (id, flowOption, idList, success, failure) {
        if (this.businessData.work.completedTime) {
            var method = "rollbackWorkcompleted";
            o2.Actions.get("x_processplatform_assemble_surface")[method](this.businessData.work.id, { "workLog": id }, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error)
            }.bind(this));
        } else {
            var body = {
                "workLog": id,
                "taskCompletedIdentityList": idList,
                "processing": !!flowOption
            }
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Rollback(this.businessData.work.id, body, function (json) {
                //o2.Actions.get("x_processplatform_assemble_surface")[method](this.businessData.work.id, { "workLog": id }, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error)
            }.bind(this));
        }

    },

    inBrowserDkg: function (content) {
        if (this.mask) this.mask.hide();

        if (this.json.submitedDlgUseNotice) {
            MWF.xDesktop.notice("success", { x: "right", y: "top" }, content);
            if (this.json.isPrompt !== false) {
                if (this.json.promptCloseTime != 0) {
                    var t = this.json.promptCloseTime || 2;
                    t = t.toInt() * 1000;
                    var _work = this;
                    window.setTimeout(function () { _work.app.close(); }, t);
                }
            } else {
                this.app.close();
            }
        } else {
            var div = new Element("div", { "styles": { "margin": "10px 10px 0px 10px", "padding": "5px", "overflow": "hidden" } }).inject(this.app.content);
            div.set("html", content);

            if (this.json.isPrompt !== false) {
                var options = {
                    "content": div,
                    "isTitle": false,
                    "width": 350,
                    "height": 180,
                    "buttonList": [
                        {
                            "text": MWF.xApplication.process.Xform.LP.ok,
                            "action": function () { dlg.close(); this.app.close(); }.bind(this)
                        }
                    ]
                }
                var size = this.app.content.getSize();
                switch (this.json.promptPosition || "righttop") {
                    case "lefttop":
                        options.top = 10;
                        options.left = 10;
                        options.fromTop = 10;
                        options.fromLeft = 10;
                        break;
                    case "righttop":
                        options.top = 10;
                        options.left = size.x - 360;
                        options.fromTop = 10;
                        options.fromLeft = size.x - 10;
                        break;
                    case "leftbottom":
                        options.top = size.y - 190;
                        options.left = 10;
                        options.fromTop = size.y - 10;
                        options.fromLeft = 10;
                        break;
                    case "rightbottom":
                        options.top = size.y - 190;
                        options.left = size.x - 360;
                        options.fromTop = size.y - 10;
                        options.fromLeft = size.x - 10;
                        break;
                    default:
                        delete options.top;
                        delete options.left;
                        delete options.fromTop;
                        delete options.fromLeft;
                }
                var dlg = o2.DL.open(options);
                if (this.json.promptCloseTime != 0) {
                    var t = this.json.promptCloseTime || 2;
                    t = t.toInt() * 1000;
                    var _work = this;
                    window.setTimeout(function () { dlg.close(); _work.app.close(); }, t);
                }
            } else {
                this.app.close();
            }
        }
    },
    addRollbackMessage_old: function (data) {
        var users = [];
        data.each(function (task) {
            users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        }.bind(this));
        var content = "<div><b>" + MWF.xApplication.process.Xform.LP.currentActivity + "<font style=\"color: #ea621f\">" + data[0].activityName + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";


        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRollback,
                "content": "<div>" + MWF.xApplication.process.Xform.LP.rollbackWorkInfor + "“" + this.businessData.work.title + "”</div>" + content
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg("<div>" + MWF.xApplication.process.Xform.LP.rollbackWorkInfor + "“" + this.businessData.work.title + "”</div>" + content);
            }
        }
    },

    addRollbackMessage: function (data) {


        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRollback,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rollbackWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rollbackWorkInfor));
            }
        }
    },

    /**
     * 需要判断权限
     * @summary 给待办人发送提醒(催促办理).
     * @example
     * if( this.workContext.getControl().allowPress ){ //判断流程节点是否设置了催办并且当前人员是否有催办权限
     *     this.form.getApp().appForm.pressWork();
     * }
     */
    pressWork: function (e) {
        if (e && e.setDisable) e.setDisable(true);
        o2.Actions.get("x_processplatform_assemble_surface").press(this.businessData.work.id, function (json) {
            var users = o2.name.cns(json.data.valueList).join(", ");
            this.app.notice(MWF.xApplication.process.Xform.LP.sendTaskNotice.replace("{users}", users), "success");
            if (e && e.setDisable) e.setDisable(false);
        }.bind(this), function (xhr, text, error) {
            //e.setDisable(false);
            if (xhr.status != 0) {
                var errorText = error;
                if (xhr) {
                    var json = JSON.decode(xhr.responseText);
                    if (json) {
                        errorText = json.message.trim() || "request json error";
                    } else {
                        errorText = "request json error: " + xhr.responseText;
                    }
                }
                MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
            }
        });
    },

    /**
     * @summary 将待办设置为挂起状态，不计算工作时长.
     * @example
     * this.form.getApp().appForm.pauseTask();
     */
    pauseTask: function (e) {
        if (!this.businessData.control["allowPause"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }

        if (this.businessData.task){
            if (e && e.disable) e.disable(true);
            return o2.Actions.get("x_processplatform_assemble_surface").pauseTask(this.businessData.task.id, function (json) {
                this.app.notice(MWF.xApplication.process.Xform.LP.pauseWork, "success");
                this.businessData.control["allowResume"] = true;
                if (e && e.enable) e.enable(false);
            }.bind(this), function (xhr, text, error) {
                //e.setDisable(false);
                if (xhr.status != 0) {
                    var errorText = error;
                    if (xhr) {
                        var json = JSON.decode(xhr.responseText);
                        if (json) {
                            errorText = json.message.trim() || "request json error";
                        } else {
                            errorText = "request json error: " + xhr.responseText;
                        }
                    }
                    MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
                }
            });
        }
    },

    /**
     * @summary 将待办从挂起状态恢复为正常状态.
     * @example
     * this.form.getApp().appForm.resumeTask();
     */
    resumeTask: function (e) {
        if (!this.businessData.control["allowResume"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        if (this.businessData.task){
            if (e && e.disable) e.disable(true);
            return o2.Actions.get("x_processplatform_assemble_surface").resumeTask(this.businessData.task.id, function (json) {
                this.app.notice(MWF.xApplication.process.Xform.LP.resumeWork, "success");
                this.businessData.control["allowPause"] = true;
                if (e && e.enable) e.enable(false);
            }.bind(this), function (xhr, text, error) {
                //e.setDisable(false);
                if (xhr.status != 0) {
                    var errorText = error;
                    if (xhr) {
                        var json = JSON.decode(xhr.responseText);
                        if (json) {
                            errorText = json.message.trim() || "request json error";
                        } else {
                            errorText = "request json error: " + xhr.responseText;
                        }
                    }
                    MWF.xDesktop.notice("error", { x: "right", y: "top" }, errorText);
                }
            });
        }
    },

    downloadAll: function () {
        var htmlFormId = "";
        o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.uploadWorkInfo(this.businessData.work.id, "pdf", {
            "workHtml": this.app.content.get("html"),
            "pageWidth": 1000
        }, function (json) {
            htmlFormId = json.data.id;
        }.bind(this), null, false);
        htmlFormId = htmlFormId.replace("#", "%23");
        var url = "/x_processplatform_assemble_surface/jaxrs/attachment/batch/download/work/" + this.businessData.work.id + "/site/(0)/stream";
        url = o2.filterUrl(o2.Actions.getHost("x_processplatform_assemble_surface") + url);
        window.open(o2.filterUrl(url + "?fileName=&flag=" + htmlFormId));
    },
    resetWork: function () {
        if (!this.businessData.control["allowReset"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 680;
            var height = 300;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.app.lp.reset,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "reset.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            this.doResetWork(dlg);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    //$("resetWork_okButton").addEvent("click", function(){
                    //    _self.doResetWork(this);
                    //}.bind(this));
                    //$("resetWork_cancelButton").addEvent("click", function(){
                    //    this.close();
                    //}.bind(this));

                    $("resetWork_selPeopleButton").addEvent("click", function () {
                        _self.selectPeople(this);
                    }.bind(this));
                }
            });
            dlg.show();
        }.bind(this));
    },
    selectPeople: function (dlg) {
        var range = this.businessData.activity.resetRange || "department";
        var count = this.businessData.activity.resetCount || 0;
        switch (range) {
            case "unit":
                this.selectPeopleUnit(dlg, this.businessData.task.unit, count);
                // this.personActions.getDepartmentByIdentity(function(json){
                //     this.selectPeopleDepartment(dlg, json.data, count);
                // }.bind(this), null, this.businessData.task.identity);
                break;
            case "topUnit":
                MWF.require("MWF.xScript.Actions.UnitActions", function () {
                    orgActions = new MWF.xScript.Actions.UnitActions();
                    var data = { "unitList": [this.businessData.task.unit] };
                    orgActions.listUnitSupNested(data, function (json) {
                        v = json.data[0];
                        this.selectPeopleUnit(dlg, v, count);
                    }.bind(this));
                }.bind(this));
                // this.personActions.getCompanyByIdentity(function(json){
                //     this.selectPeopleCompany(dlg, json.data, count)
                // }.bind(this), null, this.businessData.task.identity);
                break;
            case "script":
                o2.Actions.load("x_processplatform_assemble_surface").ProcessAction.getActivity(this.businessData.work.activity, "manual", function (activityJson) {
                    var scriptText = activityJson.data.activity.resetRangeScriptText;
                    if (!scriptText) return;
                    var resetRange = this.Macro.exec(activityJson.data.activity.resetRangeScriptText, this);
                    this.selectPeopleUnit(dlg, "", count, resetRange);
                }.bind(this))
                break;
            default:
                this.selectPeopleAll(dlg, count);
        }
    },
    selectPeopleUnit: function (dlg, unit, count, include) {
        var names = dlg.identityList || [];
        var areaNode = $("resetWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": count,
            "units": (unit) ? [unit] : [],
            "title": this.app.lp.reset,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        if (include) {
            options.noUnit = true;
            options.include = typeOf(include) === "array" ? include : [include];
        }
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));

    },
    selectPeopleAll: function (dlg, count) {
        var names = dlg.identityList || [];
        var areaNode = $("resetWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": count,
            "title": this.app.lp.reset,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));

    },


    doResetWork: function (dlg) {
        var names = dlg.identityList || [];
        if (!names.length) {
            this.app.notice(MWF.xApplication.process.Xform.LP.inputResetPeople, "error", dlg.node);
            return false;
        }
        var opinion = $("resetWork_opinion").get("value");
        var checkbox = dlg.content.getElement(".resetWork_keepOption");
        var keep = (checkbox.checked);

        var nameText = [];
        names.each(function (n) { nameText.push(MWF.name.cn(n)); });
        if (!opinion) {
            opinion = MWF.xApplication.process.Xform.LP.resetTo + ": " + nameText.join(", ");
        }

        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeReset");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeReset");

            this.resetWorkToPeson(names, opinion, keep, function (workJson) {
                //this.workAction.loadWork(function (workJson) {
                this.fireEvent("afterReset");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterReset");
                this.addResetMessage(workJson.data);
                //this.app.notice(MWF.xApplication.process.Xform.LP.resetOk + ": " + MWF.name.cns(names).join(", "), "success");
                if (!this.app.inBrowser) this.app.close();
                //}.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));

        //var data = {
        //    "opinion": opinion,
        //    "routeName": MWF.xApplication.process.Xform.LP.reset,
        //    "identityList": names
        //}
        //
        //this.workAction.resetWork(function(json){
        //
        //}.bind(this), null, this.businessData.task.id, data);
    },
    resetWorkToPeson: function (identityList, opinion, keep, success, failure) {
        var data = {
            "opinion": opinion,
            "routeName": MWF.xApplication.process.Xform.LP.reset,
            "identityList": identityList,
            "keep": !!keep
        };
        this.saveFormData(
            function (json) {
                o2.Actions.load("x_processplatform_assemble_surface").TaskAction.V2Reset(
                    //this.workAction.resetWork(
                    function (json) {
                        if (success) success(json);
                    }.bind(this),
                    function (xhr, text, error) {
                        if (failure) failure(xhr, text, error);
                    },
                    this.businessData.task.id, data
                );
            }.bind(this),
            function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            }, true, null, true
        );


    },
    addAddSplitMessage: function (data) {
        // var content = "";
        // if (data && data.length) {
        //     data.each(function (work) {
        //         var users = [];
        //         work.taskList.each(function (task) {
        //             users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        //         }.bind(this));
        //         content += "<div><b>" + MWF.xApplication.process.Xform.LP.nextActivity + "<font style=\"color: #ea621f\">" + work.activityName + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";
        //     }.bind(this));
        // } else {
        //     content += MWF.xApplication.process.Xform.LP.workCompleted;
        // }

        if (layout.desktop.message) {
            //var content = "<div><b>"+MWF.xApplication.process.Xform.LP.currentActivity+"<font style=\"color: #ea621f\">"+data.work.activityName+"</font>, "+MWF.xApplication.process.Xform.LP.nextUser+"<font style=\"color: #ea621f\">"+users.join(", ")+"</font></b></div>";
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.addSplitWork,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.addSplitWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.addSplitWorkInfor));
            }
        }
    },
    addResetMessage: function (data) {
        // var content = "";
        // if (data.completed){
        //     content += MWF.xApplication.process.Xform.LP.workCompleted;
        // }else{
        //     if (data.properties.nextManualList && data.properties.nextManualList.length){
        //         var activityUsers = [];
        //         data.properties.nextManualList.each(function(a){
        //             var ids = [];
        //             a.taskIdentityList.each(function(i){
        //                 ids.push(o2.name.cn(i))
        //             });
        //             var t = "<b>"+MWF.xApplication.process.Xform.LP.nextActivity + "</b><span style='color: #ea621f'>"+a.activityName+"</span>；<b>"+ MWF.xApplication.process.Xform.LP.nextUser+ "</b><span style='color: #ea621f'>"+ids.join(",")+"</span>";
        //             activityUsers.push(t);
        //         });
        //         content += activityUsers.join("<br>");
        //     }else{
        //         content += MWF.xApplication.process.Xform.LP.taskCompleted;
        //     }
        // }

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workReset,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.resetWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.resetWorkInfor));
            }
        }
    },

    retractWork: function (e, ev) {
        var _self = this;
        if (this.json.mode == "Mobile") {
            //window.confirm 在ios移动端不可用 ??
            // if (window.confirm(MWF.xApplication.process.Xform.LP.retractText)) {

            var p = MWF.getCenterPosition(document.body, 300, 150);
            console.log("position x:" + p.x + " , y:" + p.y);
            var x = p.x;
            if (p.x < 20) {
                x = 20;
            } else {
                x = p.x;
            }
            var event = {
                "event": {
                    "x": x,
                    "y": p.y - 200,
                    "clientX": x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.retractTitle, MWF.xApplication.process.Xform.LP.retractText, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });

                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.fireEvent("beforeRetract");
                    if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeRetract");

                    _self.doRetractWork(function () {
                        //_self.workAction.getJobByWork(function(workJson){
                        _self.fireEvent("afterRetract");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterRetract");
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workRetract, "success");
                        _self.app.content.unmask();
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }

                        _self.finishOnMobile()
                    }.bind(this), function (xhr, text, error) {
                        _self.app.content.unmask();
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                    });
                }.bind(this));
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);





        } else {
            var p = MWF.getCenterPosition(this.app.content, 300, 150);
            var event = {
                "event": {
                    "x": p.x,
                    "y": p.y - 200,
                    "clientX": p.x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.retractTitle, MWF.xApplication.process.Xform.LP.retractText, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });

                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.fireEvent("beforeRetract");
                    if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeRetract");

                    _self.doRetractWork(function (json) {
                        //_self.workAction.getJobByWork(function(workJson){
                        _self.fireEvent("afterRetract");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterRetract");
                        //_self.addRetractMessage(json.data);
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workRetract, "success");
                        _self.app.content.unmask();
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                        _self.app.reload();
                        //}, null, _self.businessData.work.id);
                        this.close();
                    }.bind(this), function (xhr, text, error) {
                        _self.app.content.unmask();
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) { _self.mask.hide(); _self.mask = null; }
                    });
                }.bind(this));

                //this.close();
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);
        }
    },
    doRetractWork: function (success, failure) {
        if (this.businessData.control["allowRetract"]) {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Retract(this.businessData.work.id, null, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });
            // this.workAction.retractWork(function (json) {
            //     if (success) success();
            // }.bind(this), function (xhr, text, error) {
            //     if (failure) failure(xhr, text, error);
            // }, this.businessData.work.id);
        } else {
            if (failure) failure(null, "Permission Denied", "");
        }
    },
    addRetractMessage: function (data) {
        // var users = [];
        // data.taskList.each(function (task) {
        //     users.push(MWF.name.cn(task.person) + "(" + MWF.name.cn(task.unit) + ")");
        // }.bind(this));
        // var content = "<div><b>" + MWF.xApplication.process.Xform.LP.currentActivity + "<font style=\"color: #ea621f\">" + data.work.activityName + "</font>, " + MWF.xApplication.process.Xform.LP.nextUser + "<font style=\"color: #ea621f\">" + users.join(", ") + "</font></b></div>";

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workRetract,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.retractWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.retractWorkInfor));
            }
        }
    },
    /**
     * 如果当前人员没有调度权限或者流程节点未配置调度，则提醒Permission Denied.
     * @summary 弹出调度界面
     * @example
     * this.form.getApp().appForm.rerouteWork();
     */
    rerouteWork: function (e, ev) {
        if (!this.businessData.control["allowReroute"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 560;
            var height = 260;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
            var dlg = new MWF.xDesktop.Dialog({
                "title": this.app.lp.reroute,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "reroute.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            _self.doRerouteWork(dlg);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostShow": function () {
                    //$("rerouteWork_okButton").addEvent("click", function(){
                    //    _self.doRerouteWork(this);
                    //}.bind(this));
                    //$("rerouteWork_cancelButton").addEvent("click", function(){
                    //    this.close();
                    //}.bind(this));

                    var select = $("rerouteWork_selectActivity");
                    _self.workAction.getRerouteTo(_self.businessData.work.process, function (json) {
                        json.data.agentList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#agent",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.cancelList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#cancel",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.choiceList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#choice",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        // json.data.controllerList.each(function(activity){
                        //     new Element("option", {
                        //         "value": activity.id+"#condition",
                        //         "text": activity.name
                        //     }).inject(select);
                        // }.bind(_self));

                        json.data.delayList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#delay",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.embedList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#embed",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.endList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#end",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.invokeList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#invoke",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.manualList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#manual",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.mergeList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#merge",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.messageList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#message",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.parallelList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#parallel",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.serviceList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#service",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));

                        json.data.splitList.each(function (activity) {
                            new Element("option", {
                                "value": activity.id + "#split",
                                "text": activity.name
                            }).inject(select);
                        }.bind(_self));
                    }.bind(_self));

                    var selPeopleButton = this.content.getElement(".rerouteWork_selPeopleButton");
                    selPeopleButton.addEvent("click", function () {
                        _self.selectReroutePeople(this);
                    }.bind(this));
                }
            });
            dlg.show();
        }.bind(this));
    },
    selectReroutePeople: function (dlg) {
        var names = dlg.identityList || [];
        var areaNode = dlg.content.getElement(".rerouteWork_selPeopleArea");
        var options = {
            "values": names,
            "type": "identity",
            "count": 0,
            "title": this.app.lp.reroute,
            "onComplete": function (items) {
                areaNode.empty();
                var identityList = [];
                items.each(function (item) {
                    new MWF.widget.O2Identity(item.data, areaNode, { "style": "reset" });
                    identityList.push(item.data.distinguishedName);
                }.bind(this));
                dlg.identityList = identityList;
            }.bind(this)
        };
        MWF.xDesktop.requireApp("Selector", "package", function () {
            var selector = new MWF.O2Selector(this.app.content, options);
        }.bind(this));
    },
    doRerouteWork: function (dlg) {
        var opinion = $("rerouteWork_opinion").get("value");
        var select = $("rerouteWork_selectActivity");
        var activity = select.options[select.selectedIndex].get("value");
        var activityName = select.options[select.selectedIndex].get("text");
        var tmp = activity.split("#");
        activity = tmp[0];
        var type = tmp[1];

        var nameArr = [];
        var names = dlg.identityList || [];
        names.each(function (n) { nameArr.push(n); });
        //var nameText = nameArr.join(", ");
        // if (!opinion) {
        //     opinion = MWF.xApplication.process.Xform.LP.resetTo + ": " + nameText.join(", ");
        // }

        MWF.require("MWF.widget.Mask", function () {
            this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
            this.mask.loadNode(this.app.content);

            this.fireEvent("beforeReroute");
            if (this.app && this.app.fireEvent) this.app.fireEvent("afterRetract");

            this.rerouteWorkToActivity(activity, type, opinion, nameArr, function (workJson) {
                //this.workAction.loadWork(function (workJson) {
                this.fireEvent("afterReroute");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterReroute");
                this.addRerouteMessage(workJson.data);
                this.app.notice(MWF.xApplication.process.Xform.LP.rerouteOk + ": " + activityName, "success");
                if (!this.app.inBrowser) this.app.close();
                //}.bind(this), null, this.businessData.work.id);
                dlg.close();
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this), function (xhr, text, error) {
                var errorText = error + ":" + text;
                if (xhr) errorText = xhr.responseText;
                this.app.notice("request json error: " + errorText, "error", dlg.node);
                if (this.mask) { this.mask.hide(); this.mask = null; }
            }.bind(this));
        }.bind(this));
    },
    rerouteWorkToActivity: function (activity, type, opinion, nameArr, success, failure) {
        var body = {
            "activity": activity,
            "activityType": type,
            "mergeWork": false,
            "manualForceTaskIdentityList": nameArr
        };
        if (this.businessData.task) {
            this.saveFormData(function (json) {
                o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id, body, function (json) {
                    if (success) success(json);
                }.bind(this), function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                });
                // this.workAction.rerouteWork(function (json) {
                //     if (success) success();
                // }.bind(this), function (xhr, text, error) {
                //     if (failure) failure(xhr, text, error);
                // }, this.businessData.work.id, activity, type);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            }, true, null, true);
        } else {
            o2.Actions.load("x_processplatform_assemble_surface").WorkAction.V2Reroute(this.businessData.work.id, body, function (json) {
                if (success) success(json);
            }.bind(this), function (xhr, text, error) {
                if (failure) failure(xhr, text, error);
            });

            // this.workAction.rerouteWork(function (json) {
            //     if (success) success();
            // }.bind(this), function (xhr, text, error) {
            //     if (failure) failure(xhr, text, error);
            // }, this.businessData.work.id, activity, type);
        }
    },
    addRerouteMessage: function (data) {

        if (layout.desktop.message) {
            var msg = {
                "subject": MWF.xApplication.process.Xform.LP.workReroute,
                "content": this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rerouteWorkInfor)
            };
            layout.desktop.message.addTooltip(msg);
            return layout.desktop.message.addMessage(msg);
        } else {
            if (this.app.inBrowser) {
                this.inBrowserDkg(this.getMessageContent(data, 0, MWF.xApplication.process.Xform.LP.rerouteWorkInfor));
            }
        }
    },

    deleteDraftWork: function () {
        var _self = this;
        if (this.json.mode === "Mobile") {
            var p = MWF.getCenterPosition(document.body, 300, 150);
            console.log("position x:" + p.x + " , y:" + p.y);
            var x = p.x;
            if (p.x < 20) {
                x = 20;
            } else {
                x = p.x;
            }
            var event = {
                "event": {
                    "x": x,
                    "y": p.y - 200,
                    "clientX": x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText.text, 300, 120, function () {
                _self.app.content.mask({
                    "style": {
                        "background-color": "#999",
                        "opacity": 0.6
                    }
                });
                // if (window.confirm(MWF.xApplication.process.Xform.LP.deleteWorkText.text)) {
                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.doDeleteWork(function () {
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + _self.businessData.work.title + "”", "success");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                        _self.finishOnMobile()
                    }.bind(this), function (xhr, text, error) {
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this));
                }.bind(this));
            }, function () {
                this.close();
            }, null, null, this.json.confirmStyle);
        } else {
            var p = MWF.getCenterPosition(this.app.content, 380, 150);
            var event = {
                "event": {
                    "x": p.x,
                    "y": p.y - 200,
                    "clientX": p.x,
                    "clientY": p.y - 200
                }
            };
            this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText, 380, 120, function () {
                MWF.require("MWF.widget.Mask", function () {
                    _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                    _self.mask.loadNode(_self.app.content);

                    _self.doDeleteWork(function () {
                        _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + _self.businessData.work.title + "”", "success");
                        _self.app.close();
                        this.close();
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this), function (xhr, text, error) {
                        var errorText = error + ":" + text;
                        if (xhr) errorText = xhr.responseText;
                        _self.app.notice("request json error: " + errorText, "error");
                        if (_self.mask) {
                            _self.mask.hide();
                            _self.mask = null;
                        }
                    }.bind(this));
                }.bind(this));
            }, function () {
                this.close();
            }, null, this.app.content, this.json.confirmStyle);
        }
    },
    deleteWork: function () {
        if (!this.businessData.work.startTime) {
            this.deleteDraftWork();
        } else {
            var _self = this;
            if (this.json.mode === "Mobile") {
                var p = MWF.getCenterPosition(document.body, 300, 150);
                console.log("position x:" + p.x + " , y:" + p.y);
                var x = p.x;
                if (p.x < 20) {
                    x = 20;
                } else {
                    x = p.x;
                }
                var event = {
                    "event": {
                        "x": x,
                        "y": p.y - 200,
                        "clientX": x,
                        "clientY": p.y - 200
                    }
                };
                this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText.text, 300, 120, function () {
                    _self.app.content.mask({
                        "style": {
                            "background-color": "#999",
                            "opacity": 0.6
                        }
                    });
                    // if (window.confirm(MWF.xApplication.process.Xform.LP.deleteWorkText.text)) {
                    MWF.require("MWF.widget.Mask", function () {
                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        _self.mask.loadNode(_self.app.content);

                        _self.fireEvent("beforeDelete");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeDelete");

                        _self.doDeleteWork(function () {
                            _self.fireEvent("afterDelete");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterDelete");
                            _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + _self.businessData.work.title + "”", "success");
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                            _self.finishOnMobile()
                        }.bind(this), function (xhr, text, error) {
                            var errorText = error + ":" + text;
                            if (xhr) errorText = xhr.responseText;
                            _self.app.notice("request json error: " + errorText, "error", dlg.node);
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this));
                    }.bind(this));
                }, function () {
                    this.close();
                }, null, this.app.content, this.json.confirmStyle);
            } else {
                var p = MWF.getCenterPosition(this.app.content, 380, 150);
                var event = {
                    "event": {
                        "x": p.x,
                        "y": p.y - 200,
                        "clientX": p.x,
                        "clientY": p.y - 200
                    }
                };
                this.app.confirm("infor", event, MWF.xApplication.process.Xform.LP.deleteWorkTitle, MWF.xApplication.process.Xform.LP.deleteWorkText, 380, 120, function () {
                    // _self.app.content.mask({
                    //    "style": {
                    //        "background-color": "#999",
                    //        "opacity": 0.6
                    //    }
                    // });


                    MWF.require("MWF.widget.Mask", function () {
                        _self.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                        _self.mask.loadNode(_self.app.content);

                        _self.fireEvent("beforeDelete");
                        if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeDelete");

                        _self.doDeleteWork(function () {
                            _self.fireEvent("afterDelete");
                            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterDelete");
                            _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete + ": “" + _self.businessData.work.title + "”", "success");
                            _self.app.close();
                            this.close();
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this), function (xhr, text, error) {
                            var errorText = error + ":" + text;
                            if (xhr) errorText = xhr.responseText;
                            _self.app.notice("request json error: " + errorText, "error", dlg.node);
                            if (_self.mask) {
                                _self.mask.hide();
                                _self.mask = null;
                            }
                        }.bind(this));
                    }.bind(this));


                    //_self.workAction.deleteWork(function(json){
                    //    _self.app.notice(MWF.xApplication.process.Xform.LP.workDelete+": “"+_self.businessData.work.title+"”", "success");
                    //    _self.app.close();
                    //    this.close();
                    //}.bind(this), null, _self.businessData.work.id);
                    //this.close();
                }, function () {
                    this.close();
                }, null, this.app.content, this.json.confirmStyle);
            }
        }
    },
    doDeleteDraftWork: function (success, failure) {
        this.workAction.deleteDraftWork(function (json) {
            if (success) success(json);
        }.bind(this), function (xhr, text, error) {
            if (failure) failure(xhr, text, error);
        }, this.businessData.work.id);
    },
    doDeleteWork: function (success, failure) {
        if (!this.businessData.work.startTime) {
            this.doDeleteDraftWork(success, failure);
        } else {
            if (this.businessData.control["allowDelete"]) {
                //this.workAction.deleteWork(function (json) {
                this.workAction.abandoned(function (json) {
                    if (success) success(json);
                }.bind(this), function (xhr, text, error) {
                    if (failure) failure(xhr, text, error);
                }, this.businessData.work.id);
            //}
            }else {
                if (failure) failure(null, "Permission Denied", "");
            }
        }
    },

    //printWork: function(){
    //    var form = this.json.id;
    //    if (this.json.printForm){
    //        form = this.json.printForm;
    //    }
    //    window.open("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+form);
    //},
    printWork: function (app, form) {
        var application = app || (this.businessData.work) ? this.businessData.work.application : this.businessData.workCompleted.application;
        var form = form;
        if (!form) {
            form = this.json.id;
            if (this.json.printForm) form = this.json.printForm;
        }
        if (this.businessData.workCompleted) {
            var application = app || this.businessData.workCompleted.application;
            window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId=" + this.businessData.workCompleted.id + "&app=" + application + "&form=" + form));
        } else {
            var application = app || this.businessData.work.application;
            window.open(o2.filterUrl("../x_desktop/printWork.html?workid=" + this.businessData.work.id + "&app=" + application + "&form=" + form));
        }
    },
    /**
     * @summary 将当前处理人的待阅设置为已阅.
     * @param {Event|Element} [e] - Event 或者Mootools Element，指定提示框弹出的位置
     * @example
     * if( this.workContext.getControl().allowReadProcessing ){ //是否有待阅
     *     this.form.getApp().appForm.readedWork();
     * }
     */
    readedWork: function (e) {
        if (!this.businessData.control["allowReadProcessing"]) {
            MWF.xDesktop.notice("error", { x: "right", y: "top" }, "Permission Denied");
            return false;
        }
        MWF.require("MWF.xDesktop.Dialog", function () {
            var width = 680;
            var height = 300;
            var p = MWF.getCenterPosition(this.app.content, width, height);

            var _self = this;
debugger;
            //"您确定要将“" + title + "”标记为已阅吗？";
            var title = this.businessData.work.title;
            var text = MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",title);
            MWF.xApplication.process.Xform.LP.form.setReadedConfirmInfo = text;

            var dlg = new MWF.xDesktop.Dialog({
                "title": MWF.xApplication.process.Xform.LP.setReadedConfirmTitle,
                "style": this.json.dialogStyle || "user", //|| "work",
                "top": p.y - 100,
                "left": p.x,
                "fromTop": p.y - 100,
                "fromLeft": p.x,
                "width": width,
                "height": height,
                "url": this.app.path + "readed.html",
                "lp": MWF.xApplication.process.Xform.LP.form,
                "container": this.app.content,
                "isClose": true,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function (d, e) {
                            this.doReadedWork(dlg);
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ]
            });
            dlg.show();
        }.bind(this));

        // if( !e )e = new Event(event);
        // this.fireEvent("beforeReaded");
        // var _self = this;
        // var title = this.businessData.work.title;
        // if (title.length > 75) {
        //     title = title.substr(0, 74) + "..."
        // }
        // //"您确定要将“" + title + "”标记为已阅吗？";
        // var text = MWF.xApplication.process.Xform.LP.setReadedConfirmContent.replace("{title}",title);
        //
        // this.app.confirm("infor", e,  MWF.xApplication.process.Xform.LP.setReadedConfirmTitle, text, 300, 120, function () {
        //     var confirmDlg = this;
        //     var read = null;
        //     for (var i = 0; i < _self.businessData.readList.length; i++) {
        //         if (_self.businessData.readList[i].person === layout.session.user.distinguishedName) {
        //             read = _self.businessData.readList[i];
        //             break;
        //         }
        //     }
        //
        //     if (read) {
        //         _self.app.action.setReaded(function () {
        //             _self.fireEvent("afterReaded");
        //             _self.app.reload();
        //             if (layout.mobile) {
        //
        //                 //移动端页面关闭
        //                 _self.finishOnMobile()
        //             } else {
        //                 confirmDlg.close();
        //             }
        //         }, null, read.id, read);
        //     } else {
        //         _self.app.reload();
        //         if (layout.mobile) {
        //
        //             //移动端页面关闭
        //             _self.finishOnMobile()
        //         } else {
        //             confirmDlg.close();
        //         }
        //     }
        //
        // }, function () {
        //     this.close();
        // }, null, this.app.content, this.json.confirmStyle);
    },
    doReadedWork: function(dlg){
        var opinion = dlg.content.getElement(".readedWork_opinion").get("value");

        var read = null;
        for (var i = 0; i < this.businessData.readList.length; i++) {
            if (this.businessData.readList[i].person === layout.session.user.distinguishedName) {
                read = this.businessData.readList[i];
                break;
            }
        }

        var _self = this;
        if (read) {
            MWF.require("MWF.widget.Mask", function () {
                this.mask = new MWF.widget.Mask({ "style": "desktop", "zIndex": 50000 });
                this.mask.loadNode(this.app.content);

                read.opinion = opinion;
                this.app.action.setReaded(function () {
                    if (_self.mask) { _self.mask.hide(); _self.mask = null; }

                    _self.fireEvent("afterReaded");
                    _self.app.reload();

                    if (layout.mobile) {
                        _self.finishOnMobile()
                    } else {
                        dlg.close();
                    }
                }, null, read.id, read);
            }.bind(this));
        } else {


            _self.app.reload();
            if (layout.mobile) {
                _self.finishOnMobile()
            } else {
                dlg.close();
            }
        }
    },

    openWindow: function (form, app) {
        //var application = app || (this.businessData.work) ? this.businessData.work.application : this.businessData.workCompleted.application;
        var form = form;
        if (!form) {
            form = this.json.id;
            //if (this.json.printForm) form = this.json.printForm;
        }
        if (this.businessData.workCompleted) {
            var application = app || this.businessData.workCompleted.application;
            window.open(o2.filterUrl("../x_desktop/printWork.html?workCompletedId=" + this.businessData.workCompleted.id + "&app=" + application + "&form=" + form));
        } else {
            var application = app || this.businessData.work.application;
            window.open(o2.filterUrl("../x_desktop/printWork.html?workid=" + this.businessData.work.id + "&app=" + application + "&form=" + form));
        }
        //window.open("../x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+form);
    },
    /**
     * @summary 将新上传的附件在指定的附件组件中展现.
     * @param {String} site - 附件组件的标识
     * @param {String} id - 新上传的附件id
     * @example
     * this.form.getApp().appForm.uploadedAttachment(site, id);
     */
    uploadedAttachment: function (site, id) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {
            var att = this.all[site];
            if (att) {
                if (json.data) att.attachmentController.addAttachment(json.data);
                att.attachmentController.checkActions();
                att.fireEvent("upload", [json.data]);
            }
        }.bind(this));
    },
    replacedAttachment: function (site, id) {
        this.workAction.getAttachment(id, this.businessData.work.id, function (json) {

            var att = this.all[site];
            if (att) {
                var attachmentController = att.attachmentController;
                var attachment = null;
                for (var i = 0; i < attachmentController.attachments.length; i++) {
                    if (attachmentController.attachments[i].data.id === id) {
                        attachment = attachmentController.attachments[i];
                        break;
                    }
                }
                attachment.data = json.data;
                attachment.reload();
                attachmentController.checkActions();
            }
        }.bind(this))
    },
    //移动端页面 工作处理完成后 
    finishOnMobile: function () {
        var _self = this;
        //新建检查
        // if (this.json.checkDraft){
        //     this.workAction.checkDraft(this.businessData.work.id, function (json) {
        //         // var str = JSON.stringify(json);
        //         _self.finishOnMobileReal();
        //     }.bind(this), function () {
        //         _self.finishOnMobileReal();
        //     }, false);
        // }else {
        //     _self.finishOnMobileReal();
        // }
        this.workAction.checkDraft(this.businessData.work.id, function (json) {
            // var str = JSON.stringify(json);
            _self.finishOnMobileReal();
        }.bind(this), function () {
            _self.finishOnMobileReal();
        }, false);
    },

    finishOnMobileReal: function () {
        if (window.o2android && window.o2android.closeWork) {
            window.o2android.closeWork("");
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.closeWork) {
            window.webkit.messageHandlers.closeWork.postMessage("");
        } else if (window.wx && window.__wxjs_environment === 'miniprogram') { //微信小程序 关闭页面
            wx.miniProgram.navigateBack({ delta: 1 });
        } else if (window.uni && window.uni.navigateBack) { // uniapp 关闭页面
            window.uni.navigateBack();
        } else if (this.json.afterProcessAction === "redirect" && this.json.afterProcessRedirectScript && this.json.afterProcessRedirectScript.code) {
            var url = this.Macro.exec(this.json.afterProcessRedirectScript.code, this);
            (new URI(url)).go();
        } else {
            var len = window.history.length;
            if (len > 1) {
                history.back();
            } else {
                var uri = new URI(window.location.href);
                var redirectlink = uri.getData("redirectlink");
                if (redirectlink) {
                    history.replaceState(null, "work", redirectlink);
                    redirectlink.toURI().go();
                } else {
                    window.location = o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter");
                    history.replaceState(null, "work", o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter"));
                    o2.filterUrl("../x_desktop/appMobile.html?app=process.TaskCenter").toURI().go();
                }
            }
        }
    },
    /**
     * @summary 获取组件的类型(小写).
     * @param {Object|String} module - 组件或组件Id
     * @return {String} 组件类型（小写）
     * @example
     * //假设有一个文本输入组件id为subject
     * var module = this.form.get("subject");
     * //moduleType 为 textfield;
     * var moduleType = this.form.getApp().appForm.getModuleType();
     * @example
     * //假设有一个附件组件id为att,
     * var moduleType = this.form.getApp().appForm.getModuleType("att");
     * //moduleType 为 attachment;
     */
    getModuleType : function (module) {
        if( typeOf(module) === "string" )module = this.all[module];
        if( module ){
            var moduleType = module.json.moduleName || "";
            if( !moduleType ){
                moduleType = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            }
            return moduleType.toLowerCase();
        }else{
            return "";
        }
    }

});


/**
 * @class PortalPage 门户页面。
 * @alias PortalPage
 * @o2category FormComponents
 * @o2range {Portal}
 * @extends MWF.xApplication.process.Xform.Form
 * @example
 * //可以在脚本中获取页面
 * //方法1：
 * var page = this.form.getApp().appForm; //获取页面
 * //方法2
 * var page = this.target; //在页面本身的事件脚本中获取
 * @hideconstructor
 */
var PortalPage="";

/**
 * @event PortalPage#beforeProcessWork
 * @ignore
 */
/**
 * @event PortalPage#beforeProcess
 * @ignore
 */
/**
 * @event PortalPage#afterProcess
 * @ignore
 */
/**
 * @event PortalPage#beforeReset
 * @ignore
 */
/**
 * @event PortalPage#afterReset
 * @ignore
 */
/**
 * @event PortalPage#beforeRetract
 * @ignore
 */
/**
 * @event PortalPage#afterRetract
 * @ignore
 */
/**
 * @event PortalPage#beforeReroute
 * @ignore
 */
/**
 * @event PortalPage#afterReroute
 * @ignore
 */
/**
 *  @event PortalPage#beforeDelete
 * @ignore
 */
/**
 * @event PortalPage#afterDelete
 * @ignore
 */
/**
 *  @event PortalPage#beforeReaded
 * @ignore
 */
/**
 * @event PortalPage#afterReaded
 * @ignore
 */
/**
 * @method PortalPage#getRouteDataList
 * @ignore
 */
/**
 * @method PortalPage#pressWork
 * @ignore
 */
/**
 * @method PortalPage#rerouteWork
 * @ignore
 */
/**
 * @method PortalPage#readedWork
 * @ignore
 */
/**
 * @method PortalPage#uploadedAttachment
 * @ignore
 */
/**
 * @method PortalPage#pauseTask
 * @ignore
 */
/**
 * @method PortalPage#resumeTask
 * @ignore
 */


MWF.require("MWF.widget.Common", null, false);
/** @classdesc $Module 组件类，此类为所有组件的父类。
 * @class
 * @o2category FormComponents
 * @hideconstructor
 * */
MWF.xApplication.process.Xform.$Module = MWF.APP$Module =  new Class(
    /** @lends MWF.xApplication.process.Xform.$Module# */
    {
    Implements: [Events],
    options: {
        /**
         * 组件加载前触发。
         * @event MWF.xApplication.process.Xform.$Module#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载时触发.
         * @event MWF.xApplication.process.Xform.$Module#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.$Module#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad"]
    },
    initialize: function(node, json, form, options){
        /**
         * @summary 组件的节点，mootools封装过的Dom对象，可以直接使用原生的js和moootools方法访问和操作该对象。
         * @see https://mootools.net/core/docs/1.6.0/Element/Element
         * @member {Element}
         * @example
         *  //可以在脚本中获取该组件
         * var field = this.form.get("fieldId"); //获取组件对象
         * field.node.setStyle("font-size","12px"); //给节点设置样式
         */
        this.node = $(node);
        this.node.store("module", this);

        /**
         * @summary 组件的配置信息，比如id,类型,是否只读等等。可以在组件的queryLoad事件里修改该配置来对组件做一些改变。
         * @member {JsonObject}
         * @example
         *  //可以在脚本中获取该组件
         * var json = this.form.get("fieldId").json; //获取组件对象
         * var id = json.id; //获取组件的id
         * var type = json.type; //获取组件的类型，如Textfield 为文本输入组件，Select为下拉组件
         * json.isReadonly = true; //设置组件为只读。
         */
        this.json = json;

        /**
         * @summary 组件的所在表单对象.
         * @member {MWF.xApplication.process.Xform.Form}
         * @example
         * var form = this.form.get("fieldId").form; //获取组件所在表单对象
         * var container = form.container; //获取表单容器
         */
        this.form = form;
    },
    _getSource: function(){
        var parent = this.node.getParent();
        while(parent && (
            parent.get("MWFtype")!="source" &&
            parent.get("MWFtype")!="subSource" &&
            parent.get("MWFtype")!="subSourceItem"
        )) parent = parent.getParent();
        return (parent) ? parent.retrieve("module") : null;
    },
    /**
     * @summary 隐藏组件.
     * @example
     * this.form.get("fieldId").hide(); //隐藏组件
     */
    hide: function(){
        var dsp = this.node.getStyle("display");
        if (dsp!=="none") this.node.store("mwf_display", dsp);
        this.node.setStyle("display", "none");
        if (this.iconNode) this.iconNode.setStyle("display", "none");
    },
    /**
     * @summary 显示组件.
     * @example
     * this.form.get("fieldId").show(); //显示组件
     */
    show: function(){
        var dsp = this.node.retrieve("mwf_display", dsp);
        this.node.setStyle("display", dsp);
        if (this.iconNode) this.iconNode.setStyle("display", "block");
    },
    load: function(){
        this._loadModuleEvents();
        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            this._loadDomEvents();
            //this._loadEvents();

            this._afterLoaded();
            this.fireEvent("postLoad");
            this.fireEvent("load");
        }
    },
    _loadUserInterface: function(){
        //	this.node = this.node;
    },

    _loadStyles: function(){
        if (this.json.styles) Object.each(this.json.styles, function(value, key){
            if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1)){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                if (value.indexOf("/x_cms_assemble_control")!==-1){
                    value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }else if (value.indexOf("x_cms_assemble_control")!==-1){
                    value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }
                value = o2.filterUrl(value);
            }
            this.node.setStyle(key, value);
        }.bind(this));

        // if (["x_processplatform_assemble_surface", "x_portal_assemble_surface"].indexOf(root.toLowerCase())!==-1){
        //     var host = MWF.Actions.getHost(root);
        //     return (flag==="/") ? host+this.json.template : host+"/"+this.json.template
        // }
        //if (this.json.styles) this.node.setStyles(this.json.styles);
    },
    _loadModuleEvents : function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            this.node.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },
    _getBusinessData: function(){
        var v;
        if (this.json.section=="yes"){
            v = this._getBusinessSectionData();
        }else {
            if (this.json.type==="Opinion"){
                v = this._getBusinessSectionDataByPerson();
            }else{
                // return this.form.businessData.data[this.json.id] || "";
                return this.getBusinessDataById() || "";
            }
        }
        //if (o2.typeOf(v)==="string") v = o2.dtxt(v);
        return v;
    },
    _getBusinessSectionData: function(){
        switch (this.json.sectionBy){
            case "person":
                return this._getBusinessSectionDataByPerson();
            case "unit":
                return this._getBusinessSectionDataByUnit();
            case "activity":
                return this._getBusinessSectionDataByActivity();
            case "splitValue":
                return this._getBusinessSectionDataBySplitValue();
            case "script":
                return this._getBusinessSectionDataByScript(((this.json.sectionByScript) ? this.json.sectionByScript.code : ""));
            default:
                // return this.form.businessData.data[this.json.id] || "";
                return this.getBusinessDataById() || "";
        }
    },
    _getBusinessSectionDataByPerson: function(){
        this.form.sectionListObj[this.json.id] = layout.desktop.session.user.id;
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        return (dataObj) ? (dataObj[layout.desktop.session.user.id] || "") : "";
    },
    _getBusinessSectionDataByUnit: function(){
        this.form.sectionListObj[this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        if (!dataObj) return "";
        var key = (this.form.businessData.task) ? this.form.businessData.task.unit : "";
        if (key) this.form.sectionListObj[this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataByActivity: function(){
        this.form.sectionListObj[this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        if (!dataObj) return "";
        var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";
        if (key) this.form.sectionListObj[this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataBySplitValue: function(){
        this.form.sectionListObj[this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        if (!dataObj) return "";
        var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";
        if (key) this.form.sectionListObj[this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },
    _getBusinessSectionDataByScript: function(code){
        this.form.sectionListObj[this.json.id] = "";
        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        if (!dataObj) return "";
        var key = this.form.Macro.exec(code, this);
        if (key) this.form.sectionListObj[this.json.id] = key;
        return (key) ? (dataObj[key] || "") : "";
    },

    _setBusinessData: function(v){
        //if (o2.typeOf(v)==="string") v = o2.txt(v);
        if (this.json.section=="yes"){
            this._setBusinessSectionData(v);
        }else {
            if (this.json.type==="Opinion"){
                this._setBusinessSectionDataByPerson(v);
            }else{
                if (this.form.businessData.data[this.json.id]){
                    // this.form.businessData.data[this.json.id] = v;
                    this.setBusinessDataById(v);
                }else{
                    // this.form.businessData.data[this.json.id] = v;
                    this.setBusinessDataById(v);
                    this.form.Macro.environment.setData(this.form.businessData.data);
                }
                if (this.json.isTitle) this.form.businessData.work.title = v;
            }
        }
    },
    _setBusinessSectionData: function(v){
        switch (this.json.sectionBy){
            case "person":
                this._setBusinessSectionDataByPerson(v);
                break;
            case "unit":
                this._setBusinessSectionDataByUnit(v);
                break;
            case "activity":
                this._setBusinessSectionDataByActivity(v);
                break;
            case "splitValue":
                this._setBusinessSectionDataBySplitValue(v);
                break;
            case "script":
                this._setBusinessSectionDataByScript(this.json.sectionByScript.code, v);
                break;
            default:
                if (this.form.businessData.data[this.json.id]){
                    // this.form.businessData.data[this.json.id] = v;
                    this.setBusinessDataById(v)
                }else{
                    // this.form.businessData.data[this.json.id] = v;
                    this.setBusinessDataById(v);
                    this.form.Macro.environment.setData(this.form.businessData.data);
                }
        }
    },
    _setBusinessSectionDataByPerson: function(v){
        var resetData = false;
        var key = layout.desktop.session.user.id;

        // var dataObj = this.form.businessData.data[this.json.id];
        var dataObj = this.getBusinessDataById();
        if (!dataObj){
            dataObj = {};
            // this.form.businessData.data[this.json.id] = dataObj;
            this.setBusinessDataById(dataObj);
            resetData = true;
        }
        if (!dataObj[key]) resetData = true;
        dataObj[key] = v;

        if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
    },
    _setBusinessSectionDataByUnit: function(v){
        var resetData = false;
        var key = (this.form.businessData.task) ? this.form.businessData.task.unit : "";

        if (key){
            // var dataObj = this.form.businessData.data[this.json.id];
            var dataObj = this.getBusinessDataById();
            if (!dataObj){
                dataObj = {};
                // this.form.businessData.data[this.json.id] = dataObj;
                this.setBusinessDataById(dataObj);
                resetData = true;
            }
            if (!dataObj[key]) resetData = true;
            dataObj[key] = v;
        }

        if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
    },
    _setBusinessSectionDataByActivity: function(v){
        var resetData = false;
        var key = (this.form.businessData.work) ? this.form.businessData.work.activity : "";

        if (key){
            // var dataObj = this.form.businessData.data[this.json.id];
            var dataObj = this.getBusinessDataById();
            if (!dataObj){
                dataObj = {};
                // this.form.businessData.data[this.json.id] = dataObj;
                this.setBusinessDataById(dataObj);
                resetData = true;
            }
            if (!dataObj[key]) resetData = true;
            dataObj[key] = v;
        }

        if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
    },
    _setBusinessSectionDataBySplitValue: function(v){
        var resetData = false;
        var key = (this.form.businessData.work) ? this.form.businessData.work.splitValue : "";

        if (key){
            // var dataObj = this.form.businessData.data[this.json.id];
            var dataObj = this.getBusinessDataById();
            if (!dataObj){
                dataObj = {};
                // this.form.businessData.data[this.json.id] = dataObj;
                this.setBusinessDataById(dataObj);
                resetData = true;
            }
            if (!dataObj[key]) resetData = true;
            dataObj[key] = v;
        }

        if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
    },

    _setBusinessSectionDataByScript: function(code, v){
        var resetData = false;
        var key = this.form.Macro.exec(code, this);

        if (key){
            // var dataObj = this.form.businessData.data[this.json.id];
            var dataObj = this.getBusinessDataById();
            if (!dataObj){
                dataObj = {};
                // this.form.businessData.data[this.json.id] = dataObj;
                this.setBusinessDataById(dataObj);
                resetData = true;
            }
            if (!dataObj[key]) resetData = true;
            dataObj[key] = v;
        }

        if (resetData) this.form.Macro.environment.setData(this.form.businessData.data);
    },
    getBusinessDataById: function(){
        //对id类似于 xx..0..xx 的字段进行拆分
        if(this.json.id.indexOf("..") < 1){
            return this.form.businessData.data[this.json.id];
        }else{
            var idList = this.json.id.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            var data = this.form.businessData.data;
            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){
                var id = idList[i];
                if( !id && id !== 0 )return null;
                if( ["object","array"].contains(o2.typeOf(data)) ){
                    if( i === lastIndex ){
                        return data[id];
                    }else{
                        data = data[id];
                    }
                }else{
                    return null;
                }
            }
        }
    },
    setBusinessDataById: function(v){
        //对id类似于 xx..0..xx 的字段进行拆分
        if(this.json.id.indexOf("..") < 1){
            this.form.businessData.data[this.json.id] = v;
        }else{
            var idList = this.json.id.split("..");
            idList = idList.map( function(d){ return d.test(/^\d+$/) ? d.toInt() : d; });

            var data = this.form.businessData.data;
            var lastIndex = idList.length - 1;

            for(var i=0; i<=lastIndex; i++){
                var id = idList[i];
                if( !id && id !== 0 )return;

                if( i === lastIndex ){
                    data[id] = v;
                }else{
                    var nexId = idList[i+1];
                    if(o2.typeOf(nexId) === "number"){ //下一个ID是数字
                        if( !data[id] && o2.typeOf(data[id]) !== "array" )data[id] = [];
                        if( nexId > data[id].length ){ //超过了最大下标，丢弃
                            return;
                        }
                    }else{ //下一个ID是字符串
                        if( !data[id] || o2.typeOf(data[id]) !== "object")data[id] = {};
                    }
                    data = data[id];
                }
            }
        }
    },

    _queryLoaded: function(){},
    _afterLoaded: function(){},

    setValue: function(){
    },
    focus: function(){
        this.node.focus();
    },

    _getModuleByPath: function( path ){
        /*
        注: 系统的数据中允许多层路径，id上通过..来区分层次：
        1、单层或者是最外层，填"fieldId"，表示表单上的直接组件。
        2、如果有多层数据模板，"./fieldId"表示和当前组件id同层次的组件，"../fieldId"表示和上一层组件同层次的组件，以此类推。
        3、如果有多层数据模板，也可通过"datatemplateId.*.datatemplateId2.*.fieldId"来表示全层次路径。datatemplateId表示第一层数据模板的id，datatemplateId2表示第二层的id。
         */
        if(!path)return;
        var idList = this.json.id.split("..");
        if( path.contains("*") ){ //允许path中包含*，替代当前path的层次
            var paths = path.split(".");
            for( var i=0; i<paths.length; i++ ){
                if( paths[i].contains("*") && idList[i] ){
                    var key = paths[i].replace("*", idList[i]);
                    key = this.form.Macro.exec("return "+key, this);
                    paths[i] = (key||"").toString();
                }
            }
            path = paths.join("..");
        }else if( path.contains("./") ){

            var lastName = path.substring(path.indexOf("./")+2, path.length);
            var level = (path.substring(0, path.indexOf("./"))+".").split(".").length-1; // /前面有几个.

            var idList_copy = Array.clone(idList);
            if( idList_copy.length > level*2 ){
                for( var i=0; i<level; i++ ){
                    idList_copy.pop();
                    if( i > 0)idList_copy.pop();
                }
                path = idList_copy.join("..")+".."+lastName;
            }else{
                idList_copy[idList_copy.length-1] = lastName;
                path = idList_copy.join("..")
            }
        }

        return this.form.all[path];
    }

});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class $Input 组件类，此类为所有输入组件的父类
 * @hideconstructor
 * @o2category FormComponents
* @extends MWF.xApplication.process.Xform.$Module
 * @abstract
 */
MWF.xApplication.process.Xform.$Input = MWF.APP$Input =  new Class(
    /** @lends MWF.xApplication.process.Xform.$Input# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
	iconStyle: "personfieldIcon",
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },
	
	_loadUserInterface: function(){
		this._loadNode();
        if (this.json.compute === "show"){
            this._setValue(this._computeValue());
        }else{
            this._loadValue();
        }
	},
    _loadDomEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)===-1){
                    (this.node.getFirst() || this.node).addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!==-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    (this.node.getFirst() || this.node).addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            (this.node.getFirst() || this.node).addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }
    },

    _loadNode: function(){
        if (this.readonly){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
    },
    loadDescription: function(){
        if (this.readonly || this.json.isReadonly)return;
        var v = this._getBusinessData();
        if (!v){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ){
                    if (COMMON.Browser.safari) w = w-20;
                }

                /**
                 * @summary 描述信息节点，允许用户手工输入的组件才有此节点，只读情况下无此节点.
                 * @member {Element}
                 */
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function(){
                    this.descriptionNode.setStyle("display", "none");
                    this.clickSelect();
                }.bind(this)
            });
            this.node.getFirst().addEvents({
                "focus": function(){
                    if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    },
    checkDescription: function(){
        if (!this.node.getFirst().get("value")){
            if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
        }else{
            if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
        }
    },
    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            },
            "readonly": true
        });

        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
	    if (!this.json.preprocessing) this._resetNodeEdit();
	    var input = this.node.getFirst();
        input.set(this.json.properties);
		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"readonly": true,
			"events": {
				"click": this.clickSelect.bind(this)
			}
		});
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon ){
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()) {
                this._setBusinessData(this.getInputData("change"));
                this.fireEvent("change");
            }
        }.bind(this));
	},
    _loadStyles: function(){
        if (this.json.styles) this.node.setStyles(this.json.styles);
        if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
        if (this.iconNode && this.iconNode.offsetParent !== null){
            var size = this.node.getSize();
            //if (!size.y){
            //    var y1 = this.node.getStyle("height");
            //    var y2 = this.node.getFirst().getStyle("height");
            //    alert(y1+"," +y2);
            //    var y = ((y1!="auto" && y1>y2) || y2=="auto") ? y1 : y2;
            //    size.y = (y=="auto") ? "auto" : y.toInt();
            //    //alert(size.y)
            //}
            this.iconNode.setStyle("height", ""+size.y+"px");
            //alert(this.iconNode.getStyle("height"))
        }
    },
    _computeValue: function(value){
        return (this.json.defaultValue && this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },
	getValue: function(){
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if (!value) value = this._computeValue();
		return value || "";
	},
    _setValue: function(value){
	    // if (value && value.isAG){
	    //     var ag = o2.AG.all(value).then(function(v){
	    //         if (o2.typeOf(v)=="array") v = v[0];
        //         this.__setValue(v);
        //     }.bind(this));
        //     this.moduleValueAG = ag;
	    //     ag.then(function(){
        //         this.moduleValueAG = null;
        //     }.bind(this));
        // }else {
        if (!!value && o2.typeOf(value.then)=="function"){
            var p = o2.promiseAll(value).then(function(v){
                this.__setValue(v);
            }.bind(this), function(){});
            this.moduleValueAG = p;
            p.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this.moduleValueAG = null;
            this.__setValue(value);
        }

            //this.__setValue(value);
        // }

    },
    __setValue: function(value){
        this._setBusinessData(value);
        if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
        if (this.readonly || this.json.isReadonly) this.node.set("text", value);
        this.moduleValueAG = null;
        return value;
    },

	_loadValue: function(){
        this._setValue(this.getValue());
	},
	clickSelect: function(){
	},
	_afterLoaded: function(){
//		if (this.iconNode){
////			var p = this.node.getPosition();
////			var s = this.node.getSize();
////			var is = this.iconNode.getSize();
////
////			var y = p.y;
////			var x = p.x+s.x-is.x;
//			this.iconNode.setStyles({
//				"top": "5px",
//				"left": "-18px"
//			});
//		}
        if (!this.readonly && !this.json.isReadonly ){
            this.loadDescription();
        }
	},
    /**
     * @summary 判断组件是否只读.
     * @example
     * var readonly = this.form.get('subject').isReadonly();
     * @return {Boolean} 是否只读.
     */
	isReadonly : function(){
        return !!(this.readonly || this.json.isReadonly);
    },
	getTextData: function(){
		//var value = this.node.get("value");
		//var text = this.node.get("text");
        var value = (this.node.getFirst()) ? this.node.getFirst().get("value") : this.node.get("text");
        var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
		return {"value": [value || ""] , "text": [text || value || ""]};
	},
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('subject').isEmpty() ){
     *     this.form.notice('标题不能为空', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
	    var data = this.getData();
	    return !data || !data.trim();
    },
    /**
     * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
     * 区别如下：<br/>
     * 1、当使用Promise的时候<br/>
     * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
     * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
     * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
     * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取组件值。
     * @example
     * var data = this.form.get('fieldId').getData(); //没有使用promise的情况、
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     * @example
     *  //使用Promise的情况
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  promise.then( function(){
     *      var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获取到了数据字典的值
     *  })
     *  field.setData( promise );
     * @return 组件的数据.
     */
	getData: function(when){
        if (this.json.compute == "save") this._setValue(this._computeValue());
        return this.getInputData();
	},
    getInputData: function(){
        if (this.node.getFirst()){
            return this.node.getFirst().get("value");
        }else{
            return this._getBusinessData();
        }
    },
    /**
     * @summary 重置组件的值为默认值或置空。
     *  @example
     * this.form.get('subject').resetData();
     */
    resetData: function(){
        this.setData(this.getValue());
    },
    /**当参数为Promise的时候，请参考文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为组件赋值。
     * @param data{String|Promise} .
     * @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     * @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  field.setData( promise );
     */
	setData: function(data){
        // if (data && data.isAG){
        //     var ag = o2.AG.all(data).then(function(v){
        //         if (o2.typeOf(v)=="array") v = v[0];
        //         this.__setData(v);
        //     }.bind(this));
        //     this.moduleValueAG = ag;
        //     ag.then(function(){
        //         this.moduleValueAG = null;
        //     }.bind(this));
        // }else{
        if (!!data && o2.typeOf(data.then)=="function"){
            var p = o2.promiseAll(data).then(function(v){
                this.__setData(v);
                // if (this.node.getFirst() && !this.readonly && !this.json.isReadonly) {
                //     this.checkDescription();
                //     this.validationMode();
                // }
            }.bind(this), function(){});
            this.moduleValueAG = p;
            p.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this.moduleValueAG = null;
            this.__setData(data);
            // if (this.node.getFirst() && !this.readonly && !this.json.isReadonly) {
            //     this.checkDescription();
            //     this.validationMode();
            // }
        }
            //this.__setData(data);
        //}
	},
    __setData: function(data){
        this._setBusinessData(data);
        if (this.node.getFirst()){
            this.node.getFirst().set("value", data);
            this.checkDescription();
            this.validationMode();
        }else{
            this.node.set("text", data);
        }
        this.moduleValueAG = null;
    },


    createErrorNode: function(text){

        //var size = this.node.getFirst().getSize();
        //var w = size.x-3;
        //if (COMMON.Browser.safari) w = w-20;
        //node.setStyles({
        //    "width": ""+w+"px",
        //    "height": ""+size.y+"px",
        //    "line-height": ""+size.y+"px",
        //    "position": "absolute",
        //    "top": "0px"
        //});
        var node;
        if( this.form.json.errorStyle ){
            if( this.form.json.errorStyle.type === "notice" ){
                if( !this.form.errorNoticing ){ //如果是弹出
                    this.form.errorNoticing = true;
                    this.form.notice(text, "error", this.node, null, null, {
                        onClose : function () {
                            this.form.errorNoticing = false;
                        }.bind(this)
                    });
                }
            }else{
                node = new Element("div",{
                    "styles" : this.form.json.errorStyle.node,
                    "text": text
                });
                if( this.form.json.errorStyle.close ){
                    var closeNode = new Element("div",{
                        "styles" : this.form.json.errorStyle.close ,
                        "events": {
                            "click" : function(){
                                this.destroy();
                            }.bind(node)
                        }
                    }).inject(node);
                }
            }
        }else{
            node = new Element("div");
            var iconNode = new Element("div", {
                "styles": {
                    "width": "20px",
                    "height": "20px",
                    "float": "left",
                    "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
                }
            }).inject(node);
            var textNode = new Element("div", {
                "styles": {
                    "height": "20px",
                    "line-height": "20px",
                    "margin-left": "20px",
                    "color": "red",
                    "word-break": "keep-all"
                },
                "text": text
            }).inject(node);
        }
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border-color", "red");

            this.errNode = this.createErrorNode(text);
            //if (this.iconNode){
            //    this.errNode.inject(this.iconNode, "after");
            //}else{
                this.errNode.inject(this.node, "after");
            //}
            this.showNotValidationMode(this.node);

            var parentNode = this.node;
            while( parentNode.offsetParent === null ){
                parentNode = parentNode.getParent();
            }

            if (!parentNode.isIntoView()) parentNode.scrollIntoView();
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            var mwftype = p.get("MWFtype") || p.get("mwftype");
            if (mwftype == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status==="all") ? true: (routeName === data.decision);
        if (flag){
            var n = this.getInputData();
            var v = (data.valueType==="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validation() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validation: function(routeName, opinion){
        if (!this.readonly && !this.json.isReadonly){
            if (!this.validationConfig(routeName, opinion))  return false;

            if (!this.json.validation) return true;
            if (!this.json.validation.code) return true;

            this.currentRouteName = routeName;
            var flag = this.form.Macro.exec(this.json.validation.code, this);
            this.currentRouteName = "";

            if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
            if (flag.toString()!="true"){
                this.notValidationMode(flag);
                return false;
            }
        }
        return true;
    }
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Div 容器组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var div = this.form.get("name"); //获取组件
 * //方法2
 * var div = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Div = MWF.APPDiv =  new Class({
    Extends: MWF.APP$Module
});
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatagridMobile 数据网格组件（移动端）。从v6.2开始建议用数据表格(Datatable)代替。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datagrid = this.form.get("name"); //获取组件
 * //方法2
 * var datagrid = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @deprecated
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatagridMobile = new Class(
/** @lends MWF.xApplication.process.Xform.DatagridMobile# */
{
    Implements: [Events],
    Extends: MWF.APP$Module,
    isEdit: false,
    options: {
        /**
         * 当前条目编辑完成时触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#completeLineEdit
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 添加条目时触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#addLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除条目前触发。通过this.event可以获取对应的table。
         * @event MWF.xApplication.process.Xform.DatagridMobile#deleteLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除条目后触发。
         * @event MWF.xApplication.process.Xform.DatagridMobile#afterDeleteLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 编辑条目时触发。
         * @event MWF.xApplication.process.Xform.DatagridMobile#editLine
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["queryLoad","postLoad","load","completeLineEdit", "addLine", "deleteLine", "afterDeleteLine","editLine"]
    },

    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },

    _loadUserInterface: function(){
        this.fireEvent("queryLoad");

        this.editModules = [];
        this.node.setStyle("overflow-x", "hidden");
        this.node.setStyle("overflow-y", "hidden");
        this.table = this.node.getElement("table");

        this.createMobileTable();


        this.editable = (!this.readonly);
        if (this.editable && this.json.editableScript && this.json.editableScript.code){
            this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
        }
        //this.editable = false;

        this.deleteable = this.json.deleteable !== "no";
        this.addable = this.json.addable !== "no";

        this.gridData = this._getValue();

        this.totalModules = [];
        this._loadDatagridTitleModules();

        if (this.editable!=false){
            this._loadDatagridDataModules();
            //this._addTitleActionColumn();
            // this._loadEditDatagrid();
            // //this._loadReadDatagrid();
            // this.fireEvent("postLoad");
            // this.fireEvent("load");
            this._loadEditDatagrid(function(){
                this.fireEvent("postLoad");
                this.fireEvent("load");
            }.bind(this));
        }else{
            this._loadDatagridDataModules();
            this._loadReadDatagrid(function(){
                this.fireEvent("postLoad");
                this.fireEvent("load");
            }.bind(this));

            // this._loadReadDatagrid();
            // this.fireEvent("postLoad");
            // this.fireEvent("load");
        }
    },
    createMobileTable: function(){
        var mobileTable = new Element("table").inject(this.node);
        mobileTable.set(this.json.properties);
        //mobileTable.setStyle("display", "none");
        //mobileTable.setStyle("margin-bottom", "10px");
        var trs = this.table.getElements("tr");
        var titleTds = trs[0].getElements("th");
        var contentTds = trs[1].getElements("td");
        titleTds.each(function(titleTd, i){
            var mobileTr = mobileTable.insertRow();
            //var mobileTr = new Element("tr").inject(mobileTable);
            var th = new Element("th").inject(mobileTr);
            th.set({
                "html": titleTd.get("html"),
                "id": titleTd.get("id"),
                "mwftype": titleTd.get("mwftype")
            });
            var td = new Element("td").inject(mobileTr);
            td.set({
                "html": contentTds[i].get("html"),
                "id": contentTds[i].get("id"),
                "mwftype": contentTds[i].get("mwftype")
            });

            var json = this.form._getDomjson(titleTd);
            if( json && json.isShow === false )mobileTr.hide();
        }.bind(this));
        this.table.destroy();
        this.table = null;
        this.table = mobileTable;
    },

    _loadStyles: function(){
        //this.table.setStyles(this.json.tableStyles);
        this.node.setStyles(this.json.styles);
        var tables = this.node.getElements("table");
        tables.each(function(table){
            table.setStyles(this.json.tableStyles);
        }.bind(this));

    },
    _getValue: function(){
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = [];
        value = this._getBusinessData();
        if (!value){
            if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
            if (!value.isAG) if (o2.typeOf(value)=="array") value = {"data": value || []};
        }
        return value || [];
    },
    getValue: function(){
        return this._getValue();
    },

    _getValueText: function(idx, value){
        var module = this.editModules[idx];
        if (module){
            switch (module.json.type){
                case "Select":
                    for (var i=0; i<module.json.itemValues.length; i++){
                        var itemv = module.json.itemValues[i];
                        var arr = itemv.split(/\|/);
                        var text = arr[0];
                        var v = (arr.length>1) ? arr[1] : arr[0];
                        if (value===v) return text;
                    }

                    // var ops = module.node.getElements("option");
                    // for (var i=0; i<ops.length; i++){
                    // 	if (ops[i].value == value){
                    // 		return ops[i].get("text");
                    // 	}
                    // }
                    break;
                case "Radio":
                    var ops = module.node.getElements("input");
                    for (var i=0; i<ops.length; i++){
                        if (ops[i].value == value){
                            return ops[i].get("showText");
                        }
                    }
                    break;
                case "Checkbox":
                    var ops = module.node.getElements("input");
                    var texts = [];
                    for (var i=0; i<ops.length; i++){
                        if (value.indexOf(ops[i].value) != -1) texts.push(ops[i].get("showText"));
                    }
                    if (texts.length) return texts.join(", ");
                    break;
                case "Orgfield":
                case "Personfield":
                case "Org":
                    //var v = module.getTextData();
                    //return v.text[0];

                    if (typeOf(value)==="array"){
                        var textArray = [];
                        value.each( function( item ){
                            if (typeOf(item)==="object"){
                                textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
                            }else{
                                textArray.push(item);
                            }
                        }.bind(this));
                        return textArray.join(", ");
                    }else if (typeOf(value)==="object"){
                        return value.name+((value.unitName) ? "("+value.unitName+")" : "");
                    }else{
                        return value;
                    }
                    break;
                case "Textarea":
                    var reg = new RegExp("\n","g");
                    var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
                    var reg3 = new RegExp("\u003e","g");
                    value = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
                    break;
            }
        }
        return value;
    },

    editValidation: function(){
        var flag = true;
        this.editModules.each(function(field, key){
            if (field.json.type!="sequence"){
                field.validationMode();
                if (!field.validation()) flag = false;
            }
        }.bind(this));
        return flag;
    },

    _loadReadDatagrid: function(callback){
        var p = o2.promiseAll(this.gridData).then(function(v){
            this.gridData = v;
            if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
            this.__loadReadDatagrid(callback);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){});
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // if (this.gridData && this.gridData.isAG){
        //     this.moduleValueAG = this.gridData;
        //     this.gridData.addResolve(function(v){
        //         this.gridData = v;
        //         this._loadReadDatagrid(callback);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
        //     this.__loadReadDatagrid(callback);
        //     this.moduleValueAG = null;
        // }
    },

    __loadReadDatagrid: function(callback){
        //this.gridData = this._getValue();


        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");

        if (this.gridData.data){
            this.gridData.data.each(function(data, idx){
                var dataDiv = new Element("div.dataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}); //.inject(this.node);

                if (this.totalDiv){
                    dataDiv.inject(this.totalDiv, "before");
                }else{
                    dataDiv.inject(this.node);
                }

                this._createItemTitleNode(dataDiv, idx);

                var tableDiv = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(dataDiv);
                var table = new Element("table").inject(tableDiv);
                table.set(this.json.properties);
                table.store("data", data);
                //table.setStyle("margin-bottom", "10px");
                titleHeaders.each(function(th, index){
                    var tr = table.insertRow(index);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    var cell = tr.insertCell(1);
                    cell.set("MWFId", tds[index].get("id"));

                    var cellData = data[th.get("id")];

                    if( typeOf( cellData ) !== "array" ) {
                        if (cellData) {
                            for (key in cellData) {
                                var v = cellData[key];

                                var module = this.editModules[index];
                                if (module && module.json.type == "ImageClipper") {
                                    this._createImage(cell, module, v);
                                } else if (module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg")) {
                                    this._createAttachment(cell, module, v);
                                } else {
                                    text = this._getValueText(index, v);
                                    if (module && module.json.type == "Textarea") {
                                        cell.set("html", text);
                                    } else {
                                        cell.set("text", text);
                                    }
                                    //cell.set("text", text);
                                }


                                // if (typeOf(v)==="array"){
                                //     var textArray = [];
                                //     v.each( function( item ){
                                //         if (typeOf(item)==="object"){
                                //             textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
                                //         }else{
                                //             textArray.push(item);
                                //         }
                                //     }.bind(this));
                                //     cell.set("text", textArray.join(", "));
                                // }else if (typeOf(v)==="object"){
                                //     cell.set("text", v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                                // }else{
                                //     cell.set("text", v);
                                // }
                                break;
                                //
                                // cell.set("text", cellData[key]);
                                // break;
                            }
                        } else { //Sequence
                            cell.setStyle("text-align", "left");
                            cell.set("text", idx + 1);
                        }
                    }

                    var json = this.form._getDomjson(th);
                    if( json && json.isShow === false )tr.hide();

                }.bind(this));
            }.bind(this));
        }
        if (callback) callback();
        //this._loadTotal();
    },

    _loadEditDatagrid: function(callback){
        var p = o2.promiseAll(this.gridData).then(function(v){
            this.gridData = v;
            if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
            this.__loadEditDatagrid(callback);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));


        // if (this.gridData && this.gridData.isAG){
        //     this.moduleValueAG = this.gridData;
        //     this.gridData.addResolve(function(v){
        //         this.gridData = v;
        //         this._loadEditDatagrid(callback);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
        //     this.__loadEditDatagrid(callback);
        //     this.moduleValueAG = null;
        // }
    },
    __loadEditDatagrid: function(callback){
        //this._createHelpNode();

        //this.gridData = this._getValue();

        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");

        var _self = this;

        if (this.gridData.data.length){
            if( this.addAction )this.addAction.setStyle("display","none");
            this.gridData.data.each(function(data, idx){
                var dataDiv = new Element("div.dataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}); //.inject(this.node);

                if (this.totalDiv){
                    dataDiv.inject(this.totalDiv, "before");
                }else{
                    dataDiv.inject(this.node);
                }

                this._createItemTitleNode(dataDiv, idx);

                var tableDiv = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(dataDiv);
                var table = new Element("table").inject(tableDiv);
                table.set(this.json.properties);
                table.store("data", data);
                //table.setStyle("margin-bottom", "10px");
                titleHeaders.each(function(th, index){
                    var tr = table.insertRow(index);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    var cell = tr.insertCell(1);
                    cell.set("MWFId", tds[index].get("id"));

                    var cellData = data[th.get("id")];
                    if( typeOf( cellData ) !== "array" ){
                        if ( cellData ){
                            for (key in cellData){
                                var v = cellData[key];

                                var module = this.editModules[index];
                                if( module && module.json.type == "ImageClipper" ){
                                    this._createImage( cell, module, v )
                                }else if( module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg") ){
                                    this._createAttachment( cell, module, v );
                                }else{
                                    text = this._getValueText(index, v);
                                    if( module && module.json.type == "Textarea" ){
                                        cell.set("html", text);
                                    }else{
                                        cell.set("text", text);
                                    }
                                    //cell.set("text", text);
                                }

                                // if (typeOf(v)==="object"){
                                //     cell.set("text", v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                                // }else{
                                //     cell.set("text", v);
                                // }
                                break;
                                //
                                // cell.set("text", cellData[key]);
                                // break;
                            }
                        }else{ //Sequence
                            cell.setStyle("text-align", "left");
                            cell.set("text", idx+1);
                        }
                    }

                    var json = this.form._getDomjson(th);
                    if( json && json.isShow === false )tr.hide();
                }.bind(this));
                var size = dataDiv.getSize();
                //dataDiv.setStyle("height", ""+size.y+"px");

                //dataDiv.addEvent("touchstart", function(e){_self.actionTouchstart(this, e);});
                //dataDiv.addEvent("touchmove", function(e){_self.actionTouchmove(this, e);});
                //dataDiv.addEvent("touchend", function(e){_self.actionTouchend(this, e);});
                //dataDiv.addEvent("touchcancel", function(e){_self.actionTouchcancel(this, e);});
                //
                //dataDiv.addEvent("mousedown", function(e){_self._actionMousedown(this, e);});
                //dataDiv.addEvent("mouseup", function(e){_self._actionMouseup(this, e);});

                //this.showMoveAction(dataDiv, 60);
                //this.showEndMoveAction(dataDiv);
            }.bind(this));
        }else{
            if (this.addAction){
                if( this.addable )this.addAction.setStyle("display", "block");
            }else{
                if( this.addable )this._loadAddAction();
            }
            // this._loadAddAction();
        }
        if (callback) callback();
        //this._loadTotal();
    },
    _loadActions: function(titleDiv){
        var actionNode = new Element("div", {
            "styles": this.form.css.mobileDatagridActionNode
        }).inject(titleDiv);

        var delAction = new Element("div", {
            "styles": this.form.css.mobileDatagridDelActionNode,
            "text": MWF.xApplication.process.Xform.LP["delete"]
        }).inject(actionNode);
        if( !this.deleteable )delAction.hide();

        var editAction = new Element("div", {
            "styles": this.form.css.mobileDatagridEditActionNode,
            "text": MWF.xApplication.process.Xform.LP.edit
        }).inject(actionNode);

        var addAction = new Element("div", {
            "styles": this.form.css.mobileDatagridAddActionNode,
            "text": MWF.xApplication.process.Xform.LP.add
        }).inject(actionNode);
        if( !this.addable )addAction.hide();

        var cancelAction = new Element("div", {
            "styles": this.form.css.mobileDatagridCancelActionNode,
            "text": MWF.xApplication.process.Xform.LP.cancelEdit
        }).inject(actionNode);
        var completeAction = new Element("div", {
            "styles": this.form.css.mobileDatagridCompleteActionNode,
            "text": MWF.xApplication.process.Xform.LP.completedEdit
        }).inject(actionNode);


        var _self = this;
        if( this.deleteable )delAction.addEvent("click", function(e){
            _self._deleteLine(this.getParent().getParent().getParent(), e);
        });
        editAction.addEvent("click", function(e){
            _self._editLine(this.getParent().getParent().getParent(), e);
        });
        completeAction.addEvent("click", function(e){
            _self._completeLineEdit();
        });
        cancelAction.addEvent("click", function(e){
            _self._cancelLineEdit(e);
        });
        if( this.addable )addAction.addEvent("click", function(e){
            _self._addLine();
        });
    },
    _createImage : function( cell, module, data ){
        cell.empty();
        if( !data )return;
        var img = new Element("img",{
            src : MWF.xDesktop.getImageSrc( data )
        }).inject( cell, "top" );
        img.setStyles({
            "max-width": "90%"
        })
    },
    _createAttachment: function ( cell, module, data ){
        cell.empty();
        var options = {
            "style": module.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": module.json.dg_listStyle || "icon",
            "size": module.json.dg_size || "min",
            "resize": (module.json.dg_resize === "y" || this.json.dg_resize === "true"),
            "attachmentCount": 0,
            "isUpload": false,
            "isDelete": false,
            "isReplace": false,
            "isDownload": true,
            "isSizeChange": (module.json.dg_isSizeChange === "y" || module.json.dg_isSizeChange === "true"),
            "readonly": true,
            "availableListStyles": module.json.dg_availableListStyles ? module.json.dg_availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": "n",
            "isReplaceOption": "n",
            "toolbarGroupHidden": module.json.dg_toolbarGroupHidden || []
        };
        if (this.readonly) options.readonly = true;
        if(!this.editable && !this.addable)options.readonly = true;

        var atts = [];
        data.each(function(d){
            var att = module.attachmentController.attachments.find(function(a){
                return d.id == a.data.id;
            });
            if (att) module.attachmentController.removeAttachment(att);
        });
        module.setAttachmentBusinessData();


        var attachmentController = new MWF.xApplication.process.Xform.AttachmentController(cell, module, options);
        attachmentController.load();

        data.each(function (att) {
            var attachment = this.form.businessData.attachmentList.find(function(a){
                return a.id==att.id;
            });
            var attData = attachment || att;
            //if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
            attachmentController.addAttachment(attData);
        }.bind(this));
    },
    _createItemTitleNode: function(node, idx){
        var n = idx+1;
        var titleDiv = new Element("div", {"styles": this.json.itemTitleStyles}).inject(node);
        titleDiv.setStyle("overflow", "hidden");
        var textNode = new Element("div.sequenceDiv", {
            "styles": {"float": "left"},
            "text": MWF.xApplication.process.Xform.LP.item+n
        }).inject(titleDiv);
        //if (idx==0){
        if( this.editable != false ){
            this._loadActions(titleDiv);
        }

        //}
    },
    _createHelpNode: function(){
        this.helpNode = new Element("div", {"styles": this.form.css.mobileGridHelpNode}).inject(this.node, "top");
        this.helpContentNode = new Element("div", {"styles": this.form.css.mobileGridHelpContentNode}).inject(this.helpNode);
        this.helpContentNode.set("html", MWF.xApplication.process.Xform.LP.mobileGridHelp);
        new mBox.Tooltip({
            content: this.helpContentNode,
            setStyles: {content: {padding: 15, lineHeight: 20}},
            attach: this.helpNode,
            transition: 'flyin',
            position: {
                x: ['right'],
                y: ['center']
            },
            event: 'click'
        });
    },
    _editLine:function(node){
        if (this.isEdit){
            if (!this._completeLineEdit()) return false;
        }

        this.currentEditLine = node;
        var currentEditTable = node.getElement("table");
        if (this.currentEditLine){
            this.table.setStyles({
                "background-color": "#fffeb5",
                "display": "table"
            });
            this.table.inject(currentEditTable, "after");
            //this.currentEditLine.setStyle("display", "none");
            currentEditTable.setStyle("display", "none");

            var actions = this.currentEditLine.getFirst("div").getLast("div").getElements("div");
            if (actions[0]) actions[0].setStyle("display", "none");
            if (actions[1]) actions[1].setStyle("display", "none");
            if (actions[2]) actions[2].setStyle("display", "none");
            if (actions[3]) actions[3].setStyle("display", "block");
            if (actions[4]) actions[4].setStyle("display", "block");

            //this.addAction.inject(this.table, "after");
            //this.addAction.set("text", MWF.xApplication.process.Xform.LP.completedEdit);
            //this.addAction.removeEvents("click");
            //this.addAction.addEvent("click", function(){
            //    this._completeLineEdit();
            //}.bind(this));


            var data = this.currentEditLine.getElement("table").retrieve("data");
            var titleThs = this.table.getElements("th");
            titleThs.each(function(th, idx){
                var id = th.get("id");
                var module = this.editModules[idx];
                if (module){
                    if (module.json.type=="sequence"){
                        module.node.set("text", this.currentEditLine.getElement("table").getElements("tr")[idx].getElement("td").get("text"));
                    }else {
                        if (data[id]) {
                            module.setData(data[id][module.json.id]);
                        } else {
                            module.setData(null);
                        }
                    }
                }
            }.bind(this));

            //var cellIdx = this.currentEditLine.getElements("td").indexOf(td);
            //var module = this.editModules[cellIdx-1];
            //if (module) module.focus();

            this.fireEvent("editLine");

            this.isEdit =true;
        }
        this.validationMode();
    },
    _loadAddAction: function(){
        if( !this.addAction ){
            this.addAction = new Element("div", {"styles": this.form.css.gridMobileActionNode}).inject(this.node, "top");
            this.addAction.set("text", MWF.xApplication.process.Xform.LP.addLine);
            this.addAction.addEvent("click", function(){
                this._addLine();
            }.bind(this));
        }
    },
    _addLine: function(){
        if (this.isEdit){
            if (!this._completeLineEdit()) return false;
        }
        if (this.addAction) this.addAction.setStyle("display", "none");

        var tables = this.node.getElements("table");
        var idx;
        var dataDiv = new Element("div.datagridDataDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}});
        if (this.totalDiv){
            idx = tables.length-2;
            dataDiv.inject(this.totalDiv, "before");
        }else{
            idx = tables.length-1;
            dataDiv.inject(this.node);
        }
        this._createItemTitleNode(dataDiv, idx);

        var tableDiv = new Element("div", {"styles":  this.form.css.gridMobileTableNode }).inject(dataDiv);

        this.table.setStyles({
            "background-color": "#fffeb5",
            "display": "table"
        });

        this.currentEditLine = null;
        this.table.inject(tableDiv);
        this.isEdit = true;

        var actions = dataDiv.getFirst("div").getLast("div").getElements("div");
        if (actions[0]) actions[0].setStyle("display", "none");
        if (actions[1]) actions[1].setStyle("display", "none");
        if (actions[2]) actions[2].setStyle("display", "none");
        if (actions[3]) actions[3].setStyle("display", "block");
        if (actions[4]) actions[4].setStyle("display", "block");

        if (!dataDiv.isIntoView()) dataDiv.scrollIntoView(true);

        //this.addAction.set("text", MWF.xApplication.process.Xform.LP.completedEdit);
        //this.addAction.removeEvents("click");
        //this.addAction.addEvent("click", function(){
        //    this._completeLineEdit();
        //}.bind(this));

        this.validationMode();
        this.fireEvent("addLine", [this.table]);
    },
    _cancelLineEdit : function(e){
        var datagrid = this;
        var _self = this;
        this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle, MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit, 300, 120, function(){

            datagrid.isEdit = false;

            if (datagrid.currentEditLine) {
                // datagrid.currentEditLine.setStyle("display", "table-row");

                var currentEditTable = datagrid.currentEditLine.getElement("table");
                currentEditTable.setStyle("display", "table");

                var actions = datagrid.currentEditLine.getFirst("div").getLast("div").getElements("div");
                if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
                if (actions[1] ) actions[1].setStyle("display", "block");
                if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
                if (actions[3]) actions[3].setStyle("display", "none");
                if (actions[4]) actions[4].setStyle("display", "none");

                datagrid._editorTrGoBack();
            }else{
                var datagridDataDiv = e.target.getParent(".datagridDataDiv");
                datagrid._editorTrGoBack();
                if(datagridDataDiv)datagridDataDiv.destroy();
            }

            datagrid.editModules.each(function(module){
                if (module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
                    module.attachmentController.attachments.each(function(att){
                        datagrid.form.workAction.deleteAttachment(att.data.id, datagrid.form.businessData.work.id);
                    });
                    module.attachmentController.clear();
                }
            });

            datagrid.currentEditLine = null;

            if (!_self.gridData.data.length){
                if (_self.addAction){
                    if( _self.addable )_self.addAction.setStyle("display", "block");
                }else{
                    if( _self.addable )_self._loadAddAction();
                }
            }

            this.close();

            datagrid.fireEvent("cancelLineEdit");
        }, function(){
            // var color = currentTr.retrieve("bgcolor");
            // currentTr.tween("background", color);
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    _completeLineEdit: function( ev ){
        if (!this.editValidation()){
            return false;
        }

        this.isEdit = false;
        var saveFlag = false;
        //var flag = true;

        var griddata = {};
        var dataNode = null;
        var table;

        if (this.currentEditLine){
            dataNode = this.currentEditLine;
            griddata = dataNode.getElement("table").retrieve("data");
            this.currentEditLine.getElement("table").setStyle("display", "table");
            table = dataNode.getElement("table");

            var actions = this.currentEditLine.getFirst("div").getLast("div").getElements("div");
            if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
            if (actions[1]) actions[1].setStyle("display", "block");
            if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
            if (actions[3]) actions[3].setStyle("display", "none");
            if (actions[4]) actions[4].setStyle("display", "none");
        }else{
            //dataNode = new Element("div", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.table, "before");
            //var tableDiv = new Element("div", {"styles": {"overflow": "hidden"}}).inject(dataNode);

            var dataDiv = this.table.getParent(".datagridDataDiv");
            if(dataDiv){
                dataDiv.removeClass("datagridDataDiv").addClass("dataDiv");
            }

            var actions = this.table.getParent().getPrevious("div").getLast("div").getElements("div");
            if (actions[0] && this.deleteable ) actions[0].setStyle("display", "block");
            if (actions[1]) actions[1].setStyle("display", "block");
            if (actions[2] && this.addable ) actions[2].setStyle("display", "block");
            if (actions[3]) actions[3].setStyle("display", "none");
            if (actions[4]) actions[4].setStyle("display", "none");

            table = new Element("table", {
                styles : this.json.tableStyles
            }).inject(this.table, "before");
            table.set(this.json.properties);
            griddata = {};

            //dataNode.addEvent("touchstart", function(e){_self.actionTouchstart(this, e);});
            //dataNode.addEvent("touchmove", function(e){_self.actionTouchmove(this, e);});
            //dataNode.addEvent("touchend", function(e){_self.actionTouchend(this, e);});
            //dataNode.addEvent("touchcancel", function(e){_self.actionTouchcancel(this, e);});
        }

        var tables = this.node.getElements("table");
        var titleHeaders = this.table.getElements("th");
        var tds = this.table.getElements("td");
        var dataRows = table.getElements("tr");

        titleHeaders.each(function(th, idx){
            var dataRow = dataRows[idx];
            var id = th.get("id");
            var module = this.editModules[idx];
            if (module){
                var data;
                if (module.json.type=="sequence"){
                    var i;
                    if (!this.currentEditLine){
                        i = tables.length-1;
                        if (this.totalTable) i = tables.length-2;
                    }else{
                        i = this.currentEditLine.getElement("table").getElements("tr")[idx].getElement("td").get("text");
                    }
                    data = {"value": [i], "text": [i]};
                }else if( module.json.type=="Attachment" || module.json.type == "AttachmentDg" ) {
                    saveFlag = true;
                    var data = module.getTextData();
                    //data.site = module.json.site;
                    if (!griddata[id]) griddata[id] = {};
                    griddata[id][module.json.id] = data;
                // }else if( ["Orgfield","Personfield","Org","Address"].contains(module.json.type) ){
                //     data = module.getTextData();
                //     if (!griddata[id]) griddata[id] = {};
                //     griddata[id][module.json.id] = data.value;
                }else{
                    data = module.getTextData();
                    //if (data.value[0]) flag = false;
                    if (data.value.length<2){
                        if (!griddata[id]) griddata[id] = {};
                        griddata[id][module.json.id] = data.value[0];
                    }else{
                        if (!griddata[id]) griddata[id] = {};
                        griddata[id][module.json.id] = data.value;
                    }
                }

                var cell;
                // var text = this._getValueText(idx, data.text.join(", "));

                if (dataRow){
                    cell = dataRow.getElement("td");
                    if( module.json.type == "ImageClipper" ){
                        this._createImage( cell, module, data.text );
                    }else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
                        this._createAttachment( cell, module, data );
                    }else{
                        var text = this._getValueText(idx, data.text.join(", "));
                        if( module && module.json.type == "Textarea" ){
                            cell.set("html", text);
                        }else{
                            cell.set("text", text);
                        }
                        //cell.set("text", data.text.join(", "));
                    }
                }else{
                    dataRow = table.insertRow(idx);
                    var datath = new Element("th").inject(dataRow);
                    datath.set("text", th.get("text"));
                    datath.setStyle("width", "30%");

                    cell = dataRow.insertCell(1);
                    cell.set("MWFId", tds[idx].get("id"));

                    var cellData = data[th.get("id")];
                    if( module.json.type == "ImageClipper" ){
                        this._createImage( cell, module, data.text );
                    }else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
                        this._createAttachment( cell, module, data );
                    }else{
                        var text = this._getValueText(idx, data.text.join(", "));
                        if( module && module.json.type == "Textarea" ){
                            cell.set("html", text);
                        }else{
                            cell.set("text", text);
                        }
                        //cell.set("text", data.text.join(", "));
                    }
                }
            }else{
                if (!dataRow) {
                    dataRow = table.insertRow(idx);
                    var datath1 = new Element("th").inject(dataRow);
                    datath1.set("text", th.get("text"));
                    datath1.setStyle("width", "30%");
                    cell = dataRow.insertCell(1);
                }
            }

            var json = this.form._getDomjson(th);
            if( json && json.isShow === false )dataRow.hide();

            module = null;
        }.bind(this));

        table.store("data", griddata);
        table.setStyle("display", "table");

        //if (flag){
        //    newTr.destroy();
        //}
        this.currentEditLine = null;

        this._editorTrGoBack();

        this.getData();
        this._loadDatagridStyle();

        this.validationMode();
        this.fireEvent("completeLineEdit", [table]);

        if (this.addAction){
            this.addAction.set("text", MWF.xApplication.process.Xform.LP.addLine);
            this.addAction.removeEvents("click");
            this.addAction.addEvent("click", function(){
                this._addLine();
            }.bind(this));
        }

        if(saveFlag){
            this.form.saveFormData();
        }
        return true;
    },
    _editorTrGoBack: function(){
        this.table.setStyle("display", "none");
        this.table.inject(this.node, "top");

        //if (this.totalDiv){
        //    this.addAction.inject(this.totalDiv, "before");
        //}else{
        //    this.addAction.inject(this.node);
        //}

//		this.editTr.removeEvents("blur");
//        if (this.totalTr){
//            this.editorTr.inject(this.totalTr, "before");
//        }else{
//            var lastTrs = this.table.getElements("tr");
//            var lastTr = lastTrs[lastTrs.length-1];
//            this.editorTr.inject(lastTr, "after");
//        }
    },

    _actionMousedown: function(node, e){
        var status = node.retrieve("editStatus");
        if (!status){
            node.store("editStatus", new Date());
        }
        this._checkMouseDown(node);
    },
    _checkMouseDown: function(node){
        var status = node.retrieve("editStatus");
        if (status){
            var d = (new Date()).getTime();
            if (d-status.getTime()>1000){
                this._editLine(node);
                node.eliminate("editStatus");
            }else{
                window.setTimeout(function(){
                    this._checkMouseDown(node);
                }.bind(this), 1000)
            }
        }
    },
    _actionMouseup: function(node, e){
        node.eliminate("editStatus");
    },

    actionTouchstart: function(node, e){
        var p = {"x": e.touches[0].pageX, "y": e.touches[0].pageY};
        //node.store("start", p);
        var action = node.retrieve("action");
        if (action){
            node.store("touchStatus", {"p": p, "status": "hide", "isHide": false});
        }else{
            node.store("touchStatus", {"p": p, "status": "show"});
        }
        this._actionMousedown(node, e);
        //e.preventDefault();
    },
    actionTouchmove: function(node, e){
        var touchStatus = node.retrieve("touchStatus");
        var p = touchStatus.p;
        var status = touchStatus.status;
        var x = e.touches[0].pageX;
        var y = e.touches[0].pageY;

        if (Math.abs(p.x-x)>10 || Math.abs(p.y-y)>10){
            this._actionMouseup(node);
        }
        if (status=="show"){
            if ((p.x-x > 20) && Math.abs(p.y-y)<40){
                this.showMoveAction(node, p.x-x);
                e.preventDefault();
            }
        }else{
            if ((x-p.x > 20) && Math.abs(p.y-y)<40){
                touchStatus.isHide = true;
                this.hideMoveAction(node, x- p.x);
                e.preventDefault();
            }
        }

    },
    actionTouchend: function(node, e){
        var touchStatus = node.retrieve("touchStatus");
        var p = touchStatus.p;
        var status = touchStatus.status;
        if (status=="show"){
            var action = node.retrieve("action");
            if (action) this.showEndMoveAction(node);
        }else{
            if (touchStatus.isHide) this.hideEndMoveAction(node);
        }
    },
    actionTouchcancel: function(node, e){
        this._actionMouseup(node);
    },
    showEndMoveAction: function(node){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        new Fx.Tween(action, {"duration": 100}).start("width", "60px");
        new Fx.Tween(tableNode, {"duration": 100}).start("margin-right", "60px");

        var _self = this;
        action.addEvent("click", function(e){
            _self._deleteLine(node, e);
        });
    },
    _deleteLine: function(node, e){
        var saveFlag = false;
        var currentTable = node.getElement("table");
        if (currentTable){

            var datagrid = this;
            var _self = this;
            this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
                _self.fireEvent("deleteLine", [currentTable]);

                var data = currentTable.retrieve("data");

                //var attKeys = [];

                var titleThs = _self.table.getElements("th");
                titleThs.each(function(th, i){
                    var key = th.get("id");
                    var module = _self.editModules[i];
                    if (key && module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
                        saveFlag = true;
                        data[key][module.json.id].each(function(d){
                            _self.form.workAction.deleteAttachment(d.id, _self.form.businessData.work.id);
                        });
                    }
                });

                node.destroy();
                //datagrid._loadZebraStyle();
                datagrid._loadSequence();
                datagrid._loadTotal();
                datagrid.getData();

                if (!_self.gridData.data.length){
                    if (_self.addAction){
                        if( _self.addable )_self.addAction.setStyle("display", "block");
                    }else{
                        if( _self.addable )_self._loadAddAction();
                    }
                }
                this.close();

                _self.fireEvent("afterDeleteLine");

                if(saveFlag){
                    _self.form.saveFormData();
                }

            }, function(){
                //var color = currentTr.retrieve("bgcolor");
                //currentTr.tween("background-color", color);
                this.close();
            }, null, null, this.form.json.confirmStyle);
        }
        this.validationMode();
    },
    hideEndMoveAction: function(node){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");

        new Fx.Tween(action, {"duration": 100}).start("width", "0px");
        new Fx.Tween(tableNode, {"duration": 100}).start("margin-right", "0px").chain(function(){
            action.destroy();
            node.eliminate("action");
        });

    },
    showMoveAction: function(node, length){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        if (!action){
            var size = node.getSize();
            action = new Element("div", {
                "styles": this.form.css.gridMobileDeleteActionAreaNode
            }).inject(node, "top");
            var button = new Element("div", {
                "styles": this.form.css.gridMobileDeleteActionNode,
                "text": MWF.xApplication.process.Xform.LP["delete"]
            }).inject(action);

            action.setStyle("height",""+size.y+"px");
            action.setStyle("line-height",""+size.y+"px");
            node.store("action", action);
        }
        if (length>60) length = 60;
        action.setStyle("width", ""+length+"px");
        tableNode.setStyle("margin-right", ""+length+"px");
    },
    hideMoveAction: function(node, length){
        var action = node.retrieve("action");
        var tableNode = node.getLast("div");
        var width = 60-length;
        if (width<0) width=0;
        if (action) action.setStyle("width", ""+width+"px");
        tableNode.setStyle("margin-right", ""+width+"px");
    },

    _loadDatagridStyle: function(){
        //var ths = this.node.getElements("th");
        //ths.setStyles(this.form.css.datagridTitle);

        this.loadGridTitleStyle();
        this.loadGridContentStyle();
        //this.loadGridActionStyle();
        this.loadGridEditStyle();

        this._loadTotal();
        this._loadBorderStyle();
        this._loadZebraStyle();
        this._loadSequence();
    },

    loadGridEditStyle: function(){
        if (this.table){
            if (this.json.editStyles){
                var tds = this.table.getElements("td");
                tds.setStyles(this.json.editStyles);
            }
        }
    },
    //loadGridActionStyle: function(){
    //    if (this.editable!=false){
    //        if (this.json.actionStyles){
    //            var trs = this.table.getElements("tr");
    //            trs.each(function(tr, idx){
    //                if (idx != 0) tr.getFirst().setStyles(this.json.actionStyles);
    //            }.bind(this));
    //        }
    //    }
    //},
    loadGridTitleStyle: function(){
        if (this.json.titleStyles){
            var ths = this.node.getElements("th");
            ths.setStyles(this.json.titleStyles);
        }
    },
    loadGridContentStyle: function(){
        if (this.json.contentStyles){
            var tds = this.node.getElements("td");
            tds.setStyles(this.json.contentStyles);
        }
    },

    _loadZebraStyle: function(){
        if (this.json.zebraColor || this.json.backgroundColor){
            var tables = this.node.getElements("table");
            tables.each(function(table){
                this._loadTableZebraStyle(table);
            }.bind(this));
        }
    },
    _loadTableZebraStyle: function(table){
        var trs = table.getElements("tr");
        for (var i=0; i<trs.length; i++){
            if (this.json.backgroundColor) trs[i].setStyle("background-color", this.json.backgroundColor);
            if ((i%2)==0){
                if (this.json.zebraColor) trs[i].setStyle("background-color", this.json.zebraColor);
            }
        }
    },

    createTotalDiv: function(){
        this.totalDiv = new Element("div.totalDiv", {"styles": {"overflow": "hidden", "margin-bottom": "10px"}}).inject(this.node);
        var titleNode = new Element("div", {"styles": this.json.itemTitleStyles}).inject(this.totalDiv);
        titleNode.set("text", MWF.xApplication.process.Xform.LP.amount);
        var tableNode = new Element("div", {"styles": this.form.css.gridMobileTableNode }).inject(this.totalDiv);
        this.totalTable = new Element("table", {
            styles : this.json.tableStyles
        }).inject(tableNode);
        this.totalTable.set(this.json.properties);
    },

    _loadTotal: function(){
        var data = {};
        this.totalResaults = {};
        if (this.totalModules.length){
            if (!this.totalDiv){
                this.createTotalDiv();
            }
            var totalResaults = [];
            //this.totalModules.each(function(m. i){
            //    totalResaults.push(0);
            //}.bind(this));
            var tables = this.node.getElements("table");
            //var totalTds = this.totalTr.getElements("td");
            for (var i=1; i<tables.length-1; i++){

                var cells = tables[i].getElements("td");
                this.totalModules.each(function(m, idx){
                    if (!totalResaults[idx]) totalResaults.push(0);
                    var tmpV = new Decimal(totalResaults[idx]);
                    if (m.type=="number"){
                        var cell = cells[m.index];
                        var addv = cell.get("text").toFloat();
                        tmpV = tmpV.plus(addv||0);
                        //tmpV = tmpV + addv;
                    }
                    if (m.type=="count"){
                        tmpV = tmpV.plus(1);
                        //tmpV = tmpV+1;
                    }
                    totalResaults[idx] = tmpV.toString();
                    data[m.module.json.id] = totalResaults[idx];
                }.bind(this));
            }

            var trs = this.totalTable.getElements("tr");
            this.totalModules.each(function(m, i){
                var tr = trs[i];
                if (!tr){
                    tr = this.totalTable.insertRow(i);
                    var datath = new Element("th").inject(tr);
                    datath.set("text", m.module.node.get("text"));
                    //    datath.setStyle("width", "30%");
                    datath.setStyles(this.json.titleStyles);
                    tr.insertCell(1).setStyles(this.json.amountStyles).set("text", totalResaults[i] || "");
                }else{
                    tr.getElement("td").set("text", totalResaults[i] || "");
                }

                if( m.isShow === false )tr.hide();

                this.totalResaults[m.module.json.id] = totalResaults[i];
            }.bind(this));
            if (this.totalTable){
                var ths = this.totalTable.getElements("th");
                ths.setStyles(this.json.titleStyles);
                //if (this.json.border) this._loadTableBorderStyle(this.totalTable);
                //if (this.json.zebraColor || this.json.backgroundColor) this._loadTableZebraStyle(this.totalTable);
            }
        }
        return data;
    },
    _loadSequence: function(){
        var tables = this.node.getElements("table");
        tables.each(function(table, idx){
            var cells = table.getElements("td");
            cells.each(function(cell){
                var module = cell.retrieve("module");
                if (module){
                    if (module.json.cellType=="sequence"){
                        cell.set("text", idx)
                    }
                }
            }.bind(this));
        }.bind(this));

        var sequenceDivs = this.node.getElements(".sequenceDiv");
        sequenceDivs.each( function(div, index){
            div.set("text", MWF.xApplication.process.Xform.LP.item+(index+1))
        })
    },

    _loadBorderStyle: function(){
        if (this.json.border){
            var tables = this.node.getElements("table");
            tables.each(function(table){
                this._loadTableBorderStyle(table)
            }.bind(this));
        }
    },
    _loadTableBorderStyle: function(table){
        table.setStyles({
            "border-top": this.json.border,
            "border-left": this.json.border
        });
        var ths = table.getElements("th");
        ths.setStyles({
            "border-bottom": this.json.border,
            "border-right": this.json.border
        });
        var tds = table.getElements("td");
        tds.setStyles({
            "border-bottom": this.json.border,
            "border-right": this.json.border,
            "background": "transparent"
        });
    },
    _loadDatagridTitleModules: function(){
        var ths = this.node.getElements("th");
        ths.each(function(th){
            var json = this.form._getDomjson(th);
            th.store("dataGrid", this);
            if (json){
                var module = this.form._loadModule(json, th);
                this.form.modules.push(module);
            }
        }.bind(this));
    },
    _loadDatagridDataModules: function(){
        var tds = this.node.getElements("td");
        tds.each(function(td){
            var json = this.form._getDomjson(td);
            td.store("dataGrid", this);
            if (json){
                var isField = false;
                var module = this.form._loadModule(json, td, function(){
                    isField = this.field;
                    this.field = false;
                });
                if( isField ){
                    module.node.setStyle("padding-right","0px");
                }
                td.store("module", module);
                this.form.modules.push(module);
            }
        }.bind(this));
    },
    _afterLoaded: function(){
        if (this.moduleValueAG){
            this.moduleValueAG.then(function(){
                this._loadDatagridStyle();
                if (this.table) this.table.setStyle("display", "none");
            }.bind(this));
        }else{
            this._loadDatagridStyle();
            if (this.table) this.table.setStyle("display", "none");
        }
    },
    /**
     * @summary 重置数据网格的值为默认值或置空。
     *  @example
     * this.form.get('fieldId').resetData();
     */
    resetData: function(){
        this.setData(this._getValue());
    },
    /**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为数据网格赋值。
     * @param data{DatagridData|Promise|Array} 必选，数组或Promise.
     * @example
     *  this.form.get("fieldId").setData([]); //赋空值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     *@example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var promise = new Promise(function(resolve, reject){ //发起异步请求
     *    var oReq = new XMLHttpRequest();
     *    oReq.addEventListener("load", function(){ //绑定load事件
     *      resolve(oReq.responseText);
     *    });
     *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
     *    oReq.send();
     *  });
     *  promise.then( function(){
     *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
     * })
     *  field.setData( promise );
     */
    setData: function(data){
        if (!data){
            data = this._getValue();
        }
        this._setData(data);
    },
    _setData: function(data){
        var p = o2.promiseAll(this.data).then(function(v){
            this.gridData = v;
            if (o2.typeOf(data)=="array") data = {"data": data};
            this.__setData(data);
            this.moduleValueAG = null;
            return v;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));
        this.moduleValueAG = p;
        if (this.moduleValueAG) this.moduleValueAG.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // if (data && data.isAG){
        //     this.moduleValueAG = data;
        //     data.addResolve(function(v){
        //         this._setData(v);
        //     }.bind(this));
        // }else{
        //     if (o2.typeOf(data)=="array") data = {"data": data};
        //     this.__setData(data);
        //     this.moduleValueAG = null;
        // }
    },
    __setData: function(data){
        // if( typeOf( data ) === "object" && typeOf(data.data) === "array"  ){
        // if (data){
        //     this._setBusinessData(data);
        //     this.gridData = data;
        // }else{
        //     this.gridData = this._getValue();
        // }
        this._setBusinessData(data);
        this.gridData = data;

        // if (this.isEdit) this._completeLineEdit();
        if( this.isEdit ){
            this.isEdit = false;
            if (this.currentEditLine) {
                this._editorTrGoBack();
                this.currentEditLine.destroy()
            }else{
                var datagridDataDiv = this.node.getElement(".datagridDataDiv");
                this._editorTrGoBack();
                if(datagridDataDiv)datagridDataDiv.destroy();
            }
            this.currentEditLine = null;
        }

        if (this.gridData){

            var divs = this.node.getElements(".dataDiv");
            for (var i=0; i<divs.length; i++){
                var table = divs[i].getElement("table");
                var tds = table.getElements("td");
                for (var j=0; j<tds.length; j++){
                    var td = tds[j];
                    var moduleTd = td.retrieve("module");
                    if (moduleTd){
                        this.form.modules.erase(moduleTd);
                        moduleTd = null;
                    }
                }
                var ths = table.getElements("th");
                for (var k=0; k<ths.length; k++){
                    var th = ths[k];
                    var moduleTh = th.retrieve("module");
                    if (moduleTh){
                        this.form.modules.erase(moduleTh);
                        moduleTh = null;
                    }
                }
            }
            for( var i=0; i<divs.length; i++ ){
                divs[i].destroy();
            }

            // var tables = this.node.getElements("table");
            // for (var i=1; i<tables.length-1; i++){
            //     var table = tables[i];
            //     var tds = table.getElements("td");
            //     for (var j=0; j<tds.length; j++){
            //         var td = tds[j];
            //         var moduleTd = td.retrieve("module");
            //         if (moduleTd){
            //             this.form.modules.erase(moduleTd);
            //             delete moduleTd;
            //         }
            //     }
            //     var ths = table.getElements("th");
            //     for (var k=0; k<ths.length; k++){
            //         var th = ths[k];
            //         var moduleTh = th.retrieve("module");
            //         if (moduleTh){
            //             this.form.modules.erase(moduleTh);
            //             delete moduleTh;
            //         }
            //     }
            // }
            //
            // while (tables.length>2){
            //     tables[1].destroy();
            //     tables = this.node.getElements("table");
            // }
            if (this.editable!=false){
                this._loadEditDatagrid();
                //this._loadReadDatagrid();
            }else{
                this._loadReadDatagrid();
            }
            this._loadDatagridStyle();
        }


    },
    /**
     * @summary 获取总计数据.
     * @example
     * var totalObject = this.form.get('fieldId').getTotal();
     * @return {Object} 总计数据
     */
    getTotal: function(){
        this._loadTotal();
        return this.totalResaults;
    },
    /**
     * @summary 判断数据网格是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('至少需要添加一条数据', 'warn');
     * }
     * @return {Boolean} 是否为空
     */
    isEmpty: function(){
        var data = this.getData();
        if( !data )return true;
        if( typeOf( data ) === "object" ){
            if( typeOf( data.data ) !== "array" )return true;
            if( data.data.length === 0 )return true;
        }
        return false;
    },
    /**
     * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
     * 区别如下：<br/>
     * 1、当使用Promise的时候<br/>
     * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
     * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
     * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
     * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取数据网格数据.
     * @example
     * var data = this.form.get('fieldId').getData();
     *@example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     *  @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var promise = new Promise(function(resolve, reject){ //发起异步请求
     *    var oReq = new XMLHttpRequest();
     *    oReq.addEventListener("load", function(){ //绑定load事件
     *      resolve(oReq.responseText);
     *    });
     *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
     *    oReq.send();
     *  });
     *  promise.then( function(){
     *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
     * })
     *  field.setData( promise );
     * @return {DatagridData}
     */
    getData: function(){
        if (this.editable!=false){
            if (this.isEdit) this._completeLineEdit();
            var data = [];

            var tables = this.node.getElements("table");
            for (var i=1; i<((this.totalTable) ? tables.length-1 : tables.length); i++){
                var table = tables[i];
                var d = table.retrieve("data");
                if (d) data.push(d);
            }
            this.gridData = {};
            this.gridData.data = data;

            this._loadTotal();
            this.gridData.total = this.totalResaults;

            this._setBusinessData(this.gridData);

            return (this.gridData.data.length) ? this.gridData : {data:[]};
        }else{
            return this._getBusinessData();
        }
    },
    getAmount: function(){
        return this._loadTotal();
    },
    createErrorNode: function(text){
        var node = new Element("div");
        var iconNode = new Element("div", {
            "styles": {
                "width": "20px",
                "height": "20px",
                "float": "left",
                "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "line-height": "20px",
                "margin-left": "20px",
                "text-align": "left",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            if( typeOf(n)==="object" && JSON.stringify(n) === JSON.stringify({data:[]}) )n = "";
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validation() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validation: function(routeName, opinion){
        if (this.isEdit){
            if (!this.editValidation()){
                return false;
            }
        }
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }

});

MWF.xApplication.process.Xform.DatagridMobile$Title =  new Class({
    Extends: MWF.APP$Module,
    _afterLoaded: function(){
        this.dataGrid = this.node.retrieve("dataGrid");
        if ((this.json.total == "number") || (this.json.total == "count")){
            this.dataGrid.totalModules.push({
                "module": this,
                "index": this.node.getParent("tr").rowIndex,
                "type": this.json.total,
                "isShow": this.json.isShow
            })
        }
        //	this.form._loadModules(this.node);
    }
});
MWF.xApplication.process.Xform.DatagridMobile$Data =  new Class({
    Extends: MWF.APP$Module,
    _afterLoaded: function(){
        //this.form._loadModules(this.node);
        this.dataGrid = this.node.retrieve("dataGrid");

        var td = this.node;
        if (this.json.cellType == "sequence"){
            var flag = true;
            for (var i=0; i<this.dataGrid.editModules.length; i++){
                if (this.dataGrid.editModules[i].json.id == this.json.id){
                    flag = false;
                    break;
                }
            }
            if (flag){
                this.dataGrid.editModules.push({
                    "json": {"type": "sequence", "id": this.json.id},
                    "node": td  ,
                    "focus": function(){}
                });
            }
            td.empty();
        }else{
            var moduleNodes = this.form._getModuleNodes(this.node);
            moduleNodes.each(function(node){
                var json = this.form._getDomjson(node);
                var isField = false;

                if (json.type=="Attachment" || json.type=="AttachmentDg" ){
                    json.type = "AttachmentDg";
                    //json.site = this.dataGrid.getAttachmentRandomSite();
                    //json.id = json.site;
                }

                var module = this.form._loadModule(json, node, function(){
                    isField = this.field;
                    this.field = false;
                });
                if( isField ){
                    module.node.setStyle("padding-right","0px");
                }
                module.dataModule = this;
                this.dataGrid.editModules.push(module);
            }.bind(this));
        }
    }
});

/**
 * 数据网格数据结构.
 * @typedef {Object} DatagridData
 * @property {Array} data - 数据网格列表数据
 * @property {Object} total - 统计数据
 * @example
 * 	{
	  "data": [ //数据网格条目
		{
		  "datagrid_datagrid$Title": { //数据网格第1列title标识
			"org_20": {  //数据网格第1列字段标识，人员组件单个对象，存的是对象
			  "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "张三",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			}
		  },
		  "datagrid_datagrid$Title1": { //数据网格第2列title标识
			"org_21": [{  //数据网格第2列字段标识，人员组件多个对象，存的是数组
			  "distinguishedName": "张三@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "张三",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			},{
			  "distinguishedName": "李四@bf007525-99a3-4178-a474-32865bdddec8@I",
			  "id": "bf007525-99a3-4178-a474-32865bdddec8",
			  "name": "李四",
			  "person": "0c828550-d8ab-479e-9880-09a59332f1ed",
			  "unit": "9e6ce205-86f6-4d84-96e1-83147567aa8d",
			  "unitLevelName": "兰德纵横/市场营销部",
			  "unitName": "市场营销部"
			}]
		  },
		  "datagrid_datagrid$Title_2": { //数据网格第2列title标识
			"number": "111" //数据网格第3列字段标识和值
		  },
		  "datagrid_datagrid$Title_3": { //数据网格第3列title标识
			"textfield_2": "杭州" //数据网格第4列字段标识和值
		  },
		  "datagrid_datagrid$Title_4": { //数据网格第4列title标识
			"attachment_1": [  //数据网格第5列字段标识
			  {
				"activityName": "拟稿",
				"extension": "jpg",
				"id": "9514758e-9e28-4bfe-87d7-824f2811f173",
				"lastUpdateTime": "2020-12-09 21:48:03",
				"length": 452863.0,
				"name": "111.jpg",
				"person": "李四@lisi@P"
			  }
			]
		  }
		},
		...
	  ],
	  "total": {  //统计数据，列title设置了总计
		"datagrid_datagrid$Title_2": "333", //总计列2
		"datagrid_datagrid$Title_3": "2" //总计列3
	  }
	}
 */
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class DatagridPC 数据网格组件（PC端）。从v6.2开始建议用数据表格(Datatable)代替。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var datagrid = this.form.get("name"); //获取组件
 * //方法2
 * var datagrid = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.DatagridPC = new Class(
	/** @lends MWF.xApplication.process.Xform.DatagridPC# */
	{
		Implements: [Events],
		Extends: MWF.APP$Module,
		isEdit: false,
		options: {
			/**
			 * 当前条目编辑完成时触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#completeLineEdit
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 添加条目时触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#addLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目前触发。通过this.event可以获取对应的tr。
			 * @event MWF.xApplication.process.Xform.DatagridPC#deleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 删除条目后触发。
			 * @event MWF.xApplication.process.Xform.DatagridPC#afterDeleteLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 编辑条目时触发。
			 * @event MWF.xApplication.process.Xform.DatagridPC#editLine
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			/**
			 * 导出excel的时候触发，this.event指向导出的数据，您可以通过修改this.event来修改数据。
			 * @event MWF.xApplication.process.Xform.DatagridPC#export
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *   		["姓名","性别","学历","专业","出生日期","毕业日期"], //标题
			 *  		[ "张三","男","大学本科","计算机","2001-1-2","2019-9-2" ], //第一行数据
			 *  		[ "李四","男","大学专科","数学","1998-1-2","2018-9-2" ]  //第二行数据
			 * 	], //导出的数据
			 *     colWidthArray : [100, 50, 100, 200, 150, 150], //每列宽度
			 *     title : "xxxx" //导出的excel文件标题
			 * }
			 */
			/**
			 * 在导入excel，进行数据校验后触发，this.event指向导入的数据。
			 * @event MWF.xApplication.process.Xform.DatagridPC#validImport
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 * @example
			 * <caption>this.event数据格式如下：</caption>
			 * {
			 *  	data : [
			 *  	   {
			 *  	 	"姓名" : "张三",
			 *  	 	"性别" : "男",
			 *  	 	"学历" ： "大学本科",
			 *  	    "专业" : "计算机",
			 *  	    "出生日期" : "aa01-1-2",
			 *  	 	"毕业日期" : "2019-9-2",
			 *  	 	"errorTextList" : [
			 *  	 	    "第5列：aa01-1-2不是正确的日期格式。"
			 *  	 	] //校验出的错误信息，如果改行数据正确，则无该字段
			 *  	 }
			 *  	 ...
			 *     ], //导入的数据
			 *     "validted" : true  //是否校验通过，可以在本事件中修改该参数，确定是否强制导入
			 * }
			 */
			/**
			 * 在导入excel，数据校验成功将要设置回数据网格的时候触发，this.event指向整理过的导入数据，格式见{@link DatagridData}。
			 * @event MWF.xApplication.process.Xform.DatagridPC#import
			 * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
			 */
			"moduleEvents": ["queryLoad","postLoad","load","completeLineEdit", "addLine", "deleteLine", "afterDeleteLine","editLine", "export", "import", "validImport"]
		},

		initialize: function(node, json, form, options){
			this.node = $(node);
			this.node.store("module", this);
			this.json = json;
			this.form = form;
			this.field = true;
		},

		_loadUserInterface: function(){
			this.fireEvent("queryLoad");

			this.editModules = [];
			this.node.setStyle("overflow-x", "auto");
			this.node.setStyle("overflow-y", "hidden");
			this.table = this.node.getElement("table");

			this.editable = (this.readonly || this.json.isReadonly === true ) ? false : true;
			if (this.editable && this.json.editableScript && this.json.editableScript.code){
				this.editable = this.form.Macro.exec(((this.json.editableScript) ? this.json.editableScript.code : ""), this);
			}

			this.deleteable = this.json.deleteable !== "no";
			this.addable = this.json.addable !== "no";

			//允许导入
			this.importenable  = this.editable && (this.json.impexpType === "impexp" || this.json.impexpType === "imp");
			//允许导出
			this.exportenable  = this.json.impexpType === "impexp" || this.json.impexpType === "exp";

			this.gridData = this._getValue();

			this.totalModules = [];
			this._loadDatagridTitleModules();

			if (this.editable!=false){
				this._loadDatagridDataModules();
				this._addTitleActionColumn();

				this._loadEditDatagrid(function(){
					this._loadImportExportAction();
					this.fireEvent("postLoad");
					this.fireEvent("load");
				}.bind(this));
				//this._loadReadDatagrid();
			}else{
				this._loadDatagridDataModules();
				this._getDatagridEditorTr();
				this._loadReadDatagrid(function(){
					if(this.editorTr)this.editorTr.setStyle("display", "none");
					this._loadImportExportAction();
					this.fireEvent("postLoad");
					this.fireEvent("load");
				}.bind(this));

			}
		},
		_loadStyles: function(){
			this.table.setStyles(this.json.tableStyles);
			this.node.setStyles(this.json.styles);
		},
		_getValue: function(){
			if (this.moduleValueAG) return this.moduleValueAG;
			var value = [];
			value = this._getBusinessData();
			if (!value){
				if (this.json.defaultData && this.json.defaultData.code) value = this.form.Macro.exec(this.json.defaultData.code, this);
				if (!value.then) if (o2.typeOf(value)=="array") value = {"data": value || []};
			}
			return value || {};
		},
		getValue: function(){
			return this._getValue();
		},
		_getDatagridTr: function(){
			this._getDatagridTitleTr();
			this._getDatagridEditorTr();
		},
		_getDatagridTitleTr: function(){
			this.titleTr = this.table.getElement("tr");
			return this.titleTr;
		},
		_getDatagridEditorTr: function(){
			var trs = this.table.getElements("tr");
			this.editorTr = trs[trs.length-1];
			this.editorTr.addClass("datagridEditorTr");

			return this.editorTr;
		},
		_addTitleActionColumn: function(){
			if (!this.titleTr) this._getDatagridTitleTr();
			if (!this.editorTr) this._getDatagridEditorTr();

			var actionTh = new Element("th", {"styles": {"width": "46px"}}).inject(this.titleTr, "top");
			new Element("th").inject(this.titleTr, "bottom");
			if( this.addable ){
				this._createAddLineAction(actionTh);
			}
			//this._createDelLineAction(actionTh);

			var actionEditTd = new Element("td").inject(this.editorTr, "top");
			this._createCompleteAction(actionEditTd);
			if( this.deleteable ){
				this._createCancelAction(actionEditTd);
			}

			new Element("td").inject(this.editorTr, "bottom");

			//if (this.totalTr){
			//    new Element("td").inject(this.totalTr, "top");
			//    new Element("td").inject(this.totalTr, "bottom");
			//    this.totalModules.each(function(m){
			//        m.index = m.index+1;
			//    });
			//}
		},

		_loadEditDatagrid: function(callback){
			var p = o2.promiseAll(this.gridData).then(function(v){
				this.gridData = v;
				if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
				this.__loadEditDatagrid(callback);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			// if (this.gridData && this.gridData.isAG){
			// 	this.moduleValueAG = this.gridData;
			// 	this.gridData.addResolve(function(v){
			// 		this.gridData = v;
			// 		this._loadEditDatagrid(callback);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
			// 	this.__loadEditDatagrid(callback);
			// 	this.moduleValueAG = null;
			// }
		},
		__loadEditDatagrid: function(callback){
			var titleThs = this.titleTr.getElements("th");
			var editorTds = this.editorTr.getElements("td");

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var tr = $(this.table.insertRow(idx+1));
					tr.store("data", data);
					titleThs.each(function(th, index){
						var cellData = data[th.get("id")];
						var text = "";
						if( typeOf( cellData ) !== "array" ) {
							for (key in cellData) {
								var value = cellData[key];
								text = this._getValueText(index - 1, value);
								break;
							}
						}
						this._createNewEditTd(tr, index, editorTds[index].get("id"), text, titleThs.length-1, idx);
					}.bind(this));
				}.bind(this));
			}
			this.editorTr.setStyle("display", "none");
			if (callback) callback();
		},


		_getValueText: function(idx, value){

			var module = this.editModules[idx];
			if (module){
				switch (module.json.type){
					case "Select":
						for (var i=0; i<module.json.itemValues.length; i++){
							var itemv = module.json.itemValues[i];
							var arr = itemv.split(/\|/);
							var text = arr[0];
							var v = (arr.length>1) ? arr[1] : arr[0];
							if (value===v) return text;
						}
						// var ops = module.node.getElements("option");
						// for (var i=0; i<ops.length; i++){
						// 	if (ops[i].value == value){
						// 		return ops[i].get("text");
						// 		break;
						// 	}
						// }
						break;
					case "Radio":
						var ops = module.node.getElements("input");
						for (var i=0; i<ops.length; i++){
							if (ops[i].value == value){
								return ops[i].get("showText");
								break;
							}
						}
						break;
					case "Checkbox":
						var ops = module.node.getElements("input");
						var texts = [];
						for (var i=0; i<ops.length; i++){
							if (value.indexOf(ops[i].value) != -1) texts.push(ops[i].get("showText"));
						}
						if (texts.length) return texts.join(", ");
						break;
					case "Orgfield":
					case "Personfield":
					case "Org":
						//var v = module.getTextData();
						//return v.text[0];

						if (typeOf(value)==="array"){
							var textArray = [];
							value.each( function( item ){
								if (typeOf(item)==="object"){
									textArray.push( item.name+((item.unitName) ? "("+item.unitName+")" : "") );
								}else{
									textArray.push(item);
								}
							}.bind(this));
							return textArray.join(", ");
						}else if (typeOf(value)==="object"){
							return value.name+((value.unitName) ? "("+value.unitName+")" : "");
						}else{
							return value;
						}

						break;
					case "Textarea":
						var reg = new RegExp("\n","g");
						var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
						var reg3 = new RegExp("\u003e","g");
						value = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
						break;
					// case "address":
					// 	if (typeOf(value)==="array"){
					//
					// 	}
					// 	break;
				}
			}
			return value;
		},

		_createNewEditTd: function(tr, idx, id, text, lastIdx, rowIndex){
			var cell = $(tr.insertCell(idx));
			if (idx==0){
				cell.setStyles(this.form.css.gridLineActionCell);
				if( this.addable )this._createAddLineAction(cell);
				if( this.deleteable )this._createDelLineAction(cell);
			}else if (idx == lastIdx){
				cell.setStyles(this.form.css.gridMoveActionCell);
				this._createMoveLineAction(cell);
			}else{
				cell.set("MWFId", id);

				var module = this.editModules[idx-1];
				if( module && module.json.type == "ImageClipper" ){
					this._createImage( cell, module, text )
				}else if( module && module.json.type == "Image" ) {
					this._createImg(cell, module, rowIndex);
				}else if( module && module.json.type == "Button" ) {
					this._createButton(cell, module, rowIndex);
				}else if( module && module.json.type == "Label" ) {
					this._createLabel(cell, module, rowIndex);
				}else if( module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg") ){
					this._createAttachment( cell, module, text );
				}else{
					if( module && module.json.type == "Textarea" ){
						cell.set("html", text);
					}else{
						cell.set("text", text);
					}
					// /cell.set("text", text);
				}
				if( !module ||  !["Button"].contains( module.json.type ) ){
					cell.addEvent("click", function(e){
						this._editLine(e.target);
					}.bind(this));
				}
			}
			var json = this.form._getDomjson(cell);

			if (json){
				cell.store("dataGrid", this);
				var module = this.form._loadModule(json, cell);
				cell.store("module", module);
				this.form.modules.push(module);
				if( json.isShow === false )cell.hide();
			}

		},

		_createAddLineAction: function(td){
			var addLineAction = new Element("div", {
				"styles": this.form.css.addLineAction,
				"events": {
					"click": function(e){
						this._addLine(e.target);
					}.bind(this)
				}
			});
			addLineAction.inject(td);
		},
		_createDelLineAction: function(td){
			var delLineAction = new Element("div", {
				"styles": this.form.css.delLineAction,
				"events": {
					"click": function(e){
						this._deleteLine(e);
					}.bind(this)
				}
			});
			delLineAction.inject(td);
		},
		_createCompleteAction: function(td){
			var completeAction = new Element("div", {
				"styles": this.form.css.completeLineAction,
				"events": {
					"click": function(e){
						this._completeLineEdit(e);
					}.bind(this)
				}
			});
			completeAction.inject(td);
		},
		_createCancelAction: function(td){
			var cancelAction = new Element("div", {
				"styles": this.form.css.delLineAction,
				"events": {
					"click": function(e){
						this._cancelLineEdit(e);
					}.bind(this)
				}
			});
			cancelAction.inject(td);
		},

		_editLine:function(td){
			if (this.isEdit){
				if (!this._completeLineEdit()) return false;
			}

			this.currentEditLine = td.getParent("tr");
			if (this.currentEditLine){
				this.editorTr.setStyles({
					//"background-color": "#fffeb5",
					"display": "table-row"
				});
				this.editorTr.inject(this.currentEditLine, "before");
				this.currentEditLine.setStyle("display", "none");

				var data = this.currentEditLine.retrieve("data");
				var titleThs = this.titleTr.getElements("th");
				titleThs.each(function(th, idx){
					var id = th.get("id");
					var module = this.editModules[idx-1];
					if (module){
						if (module.json.type=="sequence"){
							module.node.set("text", module.node.getParent("tr").rowIndex);
						}else if( module.setData ){

							if (data[id]) {
								module.setData(data[id][module.json.id]);
							} else {
								module.setData(null);
							}
						}
					}
				}.bind(this));



				var cellIdx = this.currentEditLine.getElements("td").indexOf(td);
				var module = this.editModules[cellIdx-1];
				if (module) module.focus();


				this.fireEvent("editLine");

				this.isEdit =true;
			}
			this.validationMode();
		},
		editValidation: function(){
			var flag = true;
			this.editModules.each(function(field, key){
				if (field.json.type!="sequence" && field.validationMode ){
					field.validationMode();
					if (!field.validation()) flag = false;
				}
			}.bind(this));
			return flag;
		},

		// _cancelLineEdit: function(e){
		// 	this.isEdit = false;
		//
		// 	var flag = true;
		//
		// 	var griddata = {};
		// 	var newTr = null;
		//
		// 	if (this.currentEditLine){
		// 		newTr = this.currentEditLine;
		// 		griddata = this.currentEditLine.retrieve("data");
		// 	}else{
		// 		newTr = new Element("tr").inject(this.editorTr, "before");
		// 		griddata = {};
		// 	}
		//
		// 	if (flag){
		// 		newTr.destroy();
		// 	}
		// 	this.currentEditLine = null;
		//
		// 	this._editorTrGoBack();
		//
		// 	// if (this.json.contentStyles){
		// 	// 	var tds = newTr.getElements("td");
		// 	// 	tds.setStyles(this.json.contentStyles);
		// 	// }
		// 	// if (this.json.actionStyles){
		// 	// 	newTr.getFirst().setStyles(this.json.actionStyles);
		// 	// }
		//
		// 	// this._loadBorderStyle();
		// 	// this._loadZebraStyle();
		// 	// this._loadSequence();
		//
		// 	this.fireEvent("cancelLineEdit");
		// },
		_cancelLineEdit: function(e){

			var datagrid = this;
			this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.cancelDatagridLineEditTitle, MWF.xApplication.process.Xform.LP.cancelDatagridLineEdit, 300, 120, function(){
				if (datagrid.currentEditLine) {
					datagrid.currentEditLine.setStyle("display", "table-row");
				}

				datagrid.editModules.each(function(module){
					if (module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
						module.attachmentController.attachments.each(function(att){
							datagrid.form.workAction.deleteAttachment(att.data.id, datagrid.form.businessData.work.id);
						});
						module.attachmentController.clear();
					}
				});

				datagrid.isEdit = false;
				datagrid.currentEditLine = null;

				datagrid._editorTrGoBack();

				// this._loadBorderStyle();
				// this._loadZebraStyle();
				// this._loadSequence();
				// this.getData();

				// datagrid._loadZebraStyle();
				// datagrid._loadSequence();
				// datagrid._loadTotal();
				// datagrid.getData();
				this.close();

				datagrid.fireEvent("cancelLineEdit");
			}, function(){
				// var color = currentTr.retrieve("bgcolor");
				// currentTr.tween("background", color);
				this.close();
			}, null, null, this.form.json.confirmStyle);

		},
		_completeLineEdit: function( ev ){

			debugger;

			//this.currentEditLine.getElemets(td);
			if (!this.editValidation()){
				return false;
			}

			this.isEdit = false;

			var flag = true;
			var saveFlag = false;

			var griddata = {};
			var newTr = null;

			if (this.currentEditLine){
				newTr = this.currentEditLine;
				griddata = this.currentEditLine.retrieve("data");
			}else{
				newTr = new Element("tr").inject(this.editorTr, "before");
				griddata = {};
			}

			var titleThs = this.titleTr.getElements("th");
			var editorTds = this.editorTr.getElements("td");
			var cells = newTr.getElements("td");
			titleThs.each(function(th, idx){
				var cell = cells[idx];
				var id = th.get("id");
				var module = this.editModules[idx-1];
				if (module){
					if (module.json.type=="sequence"){
						flag = false;
						var i = newTr.rowIndex;
						var data = {"value": [i], "text": [i]};
					}else if (module.json.type=="Attachment" || module.json.type == "AttachmentDg"){
						saveFlag = true;
						flag = false;
						var data = module.getTextData();
						//data.site = module.json.site;
						if (!griddata[id]) griddata[id] = {};
						griddata[id][module.json.id] = data;
						// }else if( ["Orgfield","Personfield","Org","Address"].contains(module.json.type) ){
						// 	data = module.getTextData();
						// 	if( data.value && data.value.length )flag = false;
						// 	if (!griddata[id]) griddata[id] = {};
						// 	griddata[id][module.json.id] = data.value;
					}else if( module.getTextData ){
						var data = module.getTextData();
						if (data.value[0]) flag = false;
						if (data.value.length<2){
							if (!griddata[id]) griddata[id] = {};
							griddata[id][module.json.id] = data.value[0];
						}else{
							if (!griddata[id]) griddata[id] = {};
							griddata[id][module.json.id] = data.value;
						}
					}

					if( data ){
						if (cell){
							if( module.json.type == "ImageClipper" ){
								this._createImage( cell, module, data.text[0] );
							}else if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
								this._createAttachment( cell, module, data );
							}else{
								var text = this._getValueText(idx-1, data.text.join(", "));
								if( module.json.type == "Textarea"){
									cell.set("html", text);
								}else{
									cell.set("text", data.text.join(", "));
								}
							}
						}else{
							if( module.json.type == "Attachment" || module.json.type == "AttachmentDg" ){
								this._createNewEditTd(newTr, idx, editorTds[idx].get("id"), data, titleThs.length-1);
							}else{
								var text = this._getValueText(idx-1, data.text.join(", "));
								this._createNewEditTd(newTr, idx, editorTds[idx].get("id"), text, titleThs.length-1);
							}
						}
					}else{
						if (!cell) this._createNewEditTd(newTr, idx, id, "", titleThs.length-1);
					}
				}else{
					if (!cell) this._createNewEditTd(newTr, idx, id, "", titleThs.length-1);
				}
				module = null;
			}.bind(this));

			newTr.store("data", griddata);
			newTr.setStyle("display", "table-row");

			if (flag){
				newTr.destroy();
			}
			this.currentEditLine = null;

			this._editorTrGoBack();

			if (this.json.contentStyles){
				var tds = newTr.getElements("td");
				tds.setStyles(this.json.contentStyles);
			}
			if (this.json.actionStyles){
				newTr.getFirst().setStyles(this.json.actionStyles);
			}

			this._loadBorderStyle();
			this._loadZebraStyle();
			this._loadSequence();
			this.getData();
			this.validationMode();
			this.fireEvent("completeLineEdit", [newTr]);

			if( saveFlag ){
				this.form.saveFormData();
			}

			return true;
		},
		// _createImg : function(cell, module, idx){
		// 	cell.empty();
		// 	if( module.node ){
		// 		var node = module.node.clone();
		// 		node.set("id", module.json ? (module.json.id +"_"+idx) : "" );
		// 		node.inject(cell);
		// 	}
		// },
		_createImg : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_createLabel : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_createButton : function(cell, module, idx){
			this._cloneModule(cell, module, idx);
		},
		_cloneModule : function(cell, module, idx){
			debugger;
			cell.empty();
			if( module.node && module.json ){
				var json = Object.clone( module.json );
				json.id = json.id +"_"+idx;

				var node = module.node.clone();
				node.set("id", json.id);
				node.inject(cell);

				this.form._loadModule(json, node)
			}
		},
		_createImage : function( cell, module, data ){
			cell.empty();
			if( !data )return;
			var img = new Element("img",{
				src : MWF.xDesktop.getImageSrc( data )
			}).inject( cell, "top" );
			if( module.json.clipperType == "size" ){
				var width = module.json.imageWidth;
				var height = module.json.imageHeight;
				if (width && height) {
					img.setStyles({
						width: width + "px",
						height: height + "px"
					})
				}
			}
		},
		_createAttachment: function ( cell, module, data ){
			cell.empty();
			var options = {
				"style": module.json.style || "default",
				"title": MWF.xApplication.process.Xform.LP.attachmentArea,
				"listStyle": module.json.dg_listStyle || "icon",
				"size": module.json.dg_size || "min",
				"resize": (module.json.dg_resize === "y" || this.json.dg_resize === "true"),
				"attachmentCount": 0,
				"isUpload": false,
				"isDelete": false,
				"isReplace": false,
				"isDownload": true,
				"isSizeChange": (module.json.dg_isSizeChange === "y" || module.json.dg_isSizeChange === "true"),
				"readonly": true,
				"availableListStyles": module.json.dg_availableListStyles ? module.json.dg_availableListStyles : ["list", "seq", "icon", "preview"],
				"isDeleteOption": "n",
				"isReplaceOption": "n",
				"toolbarGroupHidden": module.json.dg_toolbarGroupHidden || []
			};
			if (this.readonly) options.readonly = true;
			if(!this.editable && !this.addable)options.readonly = true;

			var atts = [];
			( data || [] ).each(function(d){
				var att = module.attachmentController.attachments.find(function(a){
					return d.id == a.data.id;
				});
				if (att) module.attachmentController.removeAttachment(att);
			});
			module.setAttachmentBusinessData();


			var attachmentController = new MWF.xApplication.process.Xform.AttachmentController(cell, module, options);
			attachmentController.load();

			( data || [] ).each(function (att) {
				var attachment = this.form.businessData.attachmentList.find(function(a){
					return a.id==att.id;
				});
				var attData = attachment || att;
				//if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
				attachmentController.addAttachment(attData);
			}.bind(this));
		},
		_editorTrGoBack: function(){
			this.editorTr.setStyle("display", "none");
//		this.editTr.removeEvents("blur");
			if (this.totalTr){
				this.editorTr.inject(this.totalTr, "before");
			}else{
				var lastTrs = this.table.getElements("tr");
				var lastTr = lastTrs[lastTrs.length-1];
				this.editorTr.inject(lastTr, "after");
			}
		},
		_addLine: function(node){
			if (this.isEdit){
				if (!this._completeLineEdit()) return false;
			}
			this.editorTr.setStyles({
				//"background-color": "#fffeb5",
				"display": "table-row"
			});
			this.currentEditLine = null;
			var currentTr = node.getParent("tr");
			if (currentTr){
				this.editorTr.inject(currentTr, "after");
			}
			this.isEdit =true;
			this.validationMode();
			this.fireEvent("addLine",[this.editorTr]);
//		newTr.addEvent("blur", function(e){
//			this._completeLineEdit();
//		}.bind(this));
		},
		_deleteLine: function(e){
			var saveFlag = false;
			var currentTr = e.target.getParent("tr");
			if (currentTr){
				var color = currentTr.getStyle("background");
				currentTr.store("bgcolor", color);
				currentTr.tween("background-color", "#ffd4d4");
				var datagrid = this;
				var _self = this;
				this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteDatagridLineTitle, MWF.xApplication.process.Xform.LP.deleteDatagridLine, 300, 120, function(){
					_self.fireEvent("deleteLine", [currentTr]);

					var data = currentTr.retrieve("data");

					//var attKeys = [];
					var titleThs = _self.titleTr.getElements("th");
					titleThs.each(function(th, i){
						var key = th.get("id");
						var module = (i>0) ? _self.editModules[i-1] : null;
						if (key && module && (module.json.type=="Attachment" || module.json.type=="AttachmentDg")){
							data[key][module.json.id].each(function(d){
								_self.form.workAction.deleteAttachment(d.id, _self.form.businessData.work.id);
							});
							saveFlag = true;
						}
					});

					currentTr.destroy();
					datagrid._loadZebraStyle();
					datagrid._loadSequence();
					datagrid._loadTotal();
					datagrid.getData();
					this.close();

					_self.fireEvent("afterDeleteLine");

					if(saveFlag){
						_self.form.saveFormData();
					}
				}, function(){
					var color = currentTr.retrieve("bgcolor");
					currentTr.tween("background", color);
					this.close();
				}, null, null, this.form.json.confirmStyle);
			}
			this.validationMode();
		},
		_createMoveLineAction: function(td){
			var moveLineAction = new Element("div", {
				"styles": this.form.css.moveLineAction,
				"events": {
					"mousedown": function(e){
						this._moveLine(e);
					}.bind(this)
				}
			});
			moveLineAction.inject(td);
		},
		_getMoveDragNode: function(tr){
			var table = tr.getParent("table");
			var div = table.getParent("div");
			var size = div.getSize();
			var dragNode = div.clone().setStyle("width", size.x).inject(document.body);
			var dragtable = dragNode.getElement("table");
			dragtable.empty();

			var clone = tr.clone().setStyles(this.form.css.gridMoveLineDragNodeTr).inject(dragtable);
			var tds = tr.getElements("td");
			var clonetds = clone.getElements("td");
			tds.each(function(td, idx){
				var size = td.getComputedSize();
				clonetds[idx].setStyle("width", size.width+1);
			});

			var coordinates = tr.getCoordinates();
			dragNode.setStyles(this.form.css.gridMoveLineDragNode);
			dragNode.setStyles(coordinates);

			return dragNode;
		},
		_moveLine: function(e){
			var trs = this.table.getElements("tr");
			var div = e.target;
			var tr = div.getParent("tr");

			var dragNode = this._getMoveDragNode(tr);
			coordinates = dragNode.getCoordinates();
			var dragTr = dragNode.getElement("tr");
			var dragTable = dragNode.getElement("table");

			var color = tr.getStyle("background");
			tr.store("bgcolor", color);
			//tr.tween('background-color', '#f3f1ad');
			tr.tween('background-color', '#e4f6e9');


			var drag = new Drag.Move(dragNode, {
				"droppables": trs.erase(tr),
				"limit": {"x": [coordinates.left, coordinates.left]},
				onDrop: function(dragging, droppable){
					dragging.destroy();
					//debugger;
					var color = tr.retrieve("bgcolor");
					if (color){
						tr.tween("background", color);
					}else{
						tr.tween("background", "transparent");
					}
					//if (droppable){
					//    color = droppable.retrieve("bgcolor");
					//    if (color){
					//        droppable.tween("background", color);
					//    }else{
					//        droppable.tween("background", "transparent");
					//    }
					//}

					tr.setStyle("display", "table-row");
					if (droppable != null){
						tr.inject(dragTr, "after");
						dragTr.destroy();
						//this._loadZebraStyle();
						//this._loadSequence();
						//this._loadTotal();
						this._loadDatagridStyle();
						this.getData();
					}

				}.bind(this),
				"onEnter": function(dragging, drop){
					//var color = drop.getStyle("background");
					//if (color.toUpperCase()!='#d1eaf3') drop.store("bgcolor", color);
					//drop.tween("background-color", "#d1eaf3");
					dragNode.setStyle("display", "none");
					dragTr.inject(drop, "after");
				},
				"onLeave": function(dragging, drop){
					//var color = drop.retrieve("bgcolor");
					//if (color){
					//	drop.tween("background", color);
					//}else{
					//	drop.tween("background", "transparent");
					//}
					dragTr.inject(dragTable);
					dragNode.setStyle("display", "block");
//				tr.setStyle("display", "table-row");
				},
				"ondrag": function(){
					this.table.setStyle("cursor", "move");
					dragNode.setStyle("cursor", "move");
				},
				"onCancel": function(dragging){
					dragging.destroy();
					var color = tr.retrieve("bgcolor");
					if (color){
						tr.tween("background", color);
					}else{
						tr.tween("background", "transparent");
					}
					tr.setStyle("display", "table-row");
				}
			});
			drag.start(e);
			tr.setStyle("display", "none");
		},
		_loadReadDatagrid: function(callback){
			var p = o2.promiseAll(this.gridData).then(function(v){
				this.gridData = v;
				if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
				this.__loadReadDatagrid(callback);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));

			// if (this.gridData && this.gridData.isAG){
			// 	this.moduleValueAG = this.gridData;
			// 	this.gridData.addResolve(function(v){
			// 		this.gridData = v;
			// 		this._loadReadDatagrid(callback);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(this.gridData)=="array") this.gridData = {"data": this.gridData};
			// 	this.__loadReadDatagrid(callback);
			// 	this.moduleValueAG = null;
			// }
		},

		__loadReadDatagrid: function(callback){
			//this.gridData = this._getValue();
			if (!this.titleTr) this._getDatagridTitleTr();
			//var titleTr = this.table.getElement("tr");
			var titleHeaders = this.titleTr.getElements("th");

			var lastTrs = this.table.getElements("tr");
			var lastTr = lastTrs[lastTrs.length-1];
			//var tds = lastTr.getElements("td");

			debugger;

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var tr = this.table.insertRow(idx+1);
					tr.store("data", data);

					titleHeaders.each(function(th, index){
						var cell = tr.insertCell(index);
						// cell.set("MWFId", tds[index].get("id"));
						var cellData = data[th.get("id")];

						var module = this.editModules[index];
						if( typeOf( cellData ) !== "array" ){
							if (cellData) {
								for (key in cellData) {
									var v = cellData[key];
									if (module && module.json.type == "ImageClipper") {
										this._createImage(cell, module, v);
									} else if (module && (module.json.type == "Attachment" || module.json.type == "AttachmentDg")) {
										this._createAttachment(cell, module, v);
									} else {
										var text = this._getValueText(index, v);
										if (module && module.json.type == "Textarea") {
											cell.set("html", text);
										} else {
											cell.set("text", text);
										}
									}
									break;
								}
							}else if( module && module.json.type == "Image" ) {
								this._createImg(cell, module, idx);
							}else if( module && module.json.type == "Button" ) {
								this._createButton(cell, module, idx);
							}else if( module && module.json.type == "Label" ) {
								this._createLabel(cell, module, idx);
							}else if( module && module.json.type == "sequence" ){ //Sequence
								cell.setStyle("text-align", "center");
								cell.set("text", tr.rowIndex);
							}
						}


						var json = this.form._getDomjson(th);
						if( json && json.isShow === false )cell.hide();
					}.bind(this));
				}.bind(this));
			}
			this._loadTotal();

			if (callback) callback();
		},

		_loadImportExportAction: function(){
			debugger;
			this.impexpNode = this.node.getElement("div.impexpNode");
			if( this.impexpNode )this.impexpNode.destroy();
			this.impexpNode = null;

			if( !this.exportenable && !this.importenable )return;

			var position = ["leftTop","centerTop","rightTop"].contains( this.json.impexpPosition || "" ) ? "top" : "bottom";
			var container = new Element("div").inject(this.node, position);

			this.importExportAreaNode = new Element("div").inject( container );
			if( ["leftTop","leftBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "left" })
			}else if( ["rightTop","rightBottom"].contains( this.json.impexpPosition || "" ) ){
				this.importExportAreaNode.setStyles({ "float" : "right" })
			}else{
				this.importExportAreaNode.setStyles({ "margin" : "0px auto" })
			}

			if( this.exportenable ){
				this.exportActionNode = new Element("div", {
					text : this.json.exportActionText || MWF.xApplication.process.Xform.LP.datagridExport
				}).inject(this.importExportAreaNode);
				var styles;
				if( this.json.exportActionStyles ){
					styles = this.json.exportActionStyles
				}else{
					styles = this.form.css.gridExportActionStyles;
				}
				this.exportActionNode.setStyles(styles);

				this.exportActionNode.addEvent("click", function () {
					this.exportToExcel();
				}.bind(this))
			}

			if( this.importenable ){
				this.importActionNode = new Element("div", {
					text : this.json.importActionText || MWF.xApplication.process.Xform.LP.datagridImport
				}).inject(this.importExportAreaNode);
				var styles;
				if( this.json.importActionStyles ){
					styles = this.json.importActionStyles;
				}else{
					styles = this.form.css.gridImportActionStyles;
				}
				this.importActionNode.setStyles(styles);

				this.importActionNode.addEvent("click", function () {
					this.importFromExcel();
				}.bind(this))
			}

			if( ["centerTop","centerBottom"].contains( this.json.impexpPosition ) ){
				var width = 2;

				if( this.exportActionNode ){
					width = width + this.exportActionNode.getSize().x +
						this.exportActionNode.getStyle("padding-left").toFloat() +
						+ this.exportActionNode.getStyle("padding-right").toFloat() +
						+ this.exportActionNode.getStyle("margin-left").toFloat() +
						+ this.exportActionNode.getStyle("margin-right").toFloat()
				}

				if( this.importActionNode ){
					width = width + this.importActionNode.getSize().x +
						this.importActionNode.getStyle("padding-left").toFloat() +
						+ this.importActionNode.getStyle("padding-right").toFloat() +
						+ this.importActionNode.getStyle("margin-left").toFloat() +
						+ this.importActionNode.getStyle("margin-right").toFloat()
				}

				this.importExportAreaNode.setStyle( "width", width+"px" );
			}
		},

		_loadDatagridStyle: function(){
			//var ths = this.titleTr.getElements("th");
			//ths.setStyles(this.form.css.datagridTitle);
			this.loadGridTitleStyle();
			this.loadGridContentStyle();
			this.loadGridActionStyle();
			this.loadGridEditStyle();

			this._loadTotal();
			this._loadBorderStyle();
			this._loadZebraStyle();
			this._loadSequence();
		},
		loadGridEditStyle: function(){
			if (this.editorTr){
				if (this.json.editStyles){
					var tds = this.editorTr.getElements("td");
					tds.setStyles(this.json.editStyles);
				}
			}
		},
		loadGridActionStyle: function(){
			if (this.editable!=false){
				if (this.json.actionStyles){
					var trs = this.table.getElements("tr");
					trs.each(function(tr, idx){
						if (idx != 0) tr.getFirst().setStyles(this.json.actionStyles);
					}.bind(this));
				}
			}
		},
		loadGridTitleStyle: function(){
			if (this.json.titleStyles){
				var ths = this.titleTr.getElements("th");
				ths.setStyles(this.json.titleStyles);
			}
		},
		loadGridContentStyle: function(){
			if (this.json.contentStyles){
				var tds = this.table.getElements("td");
				tds.setStyles(this.json.contentStyles);
			}
		},

		_loadZebraStyle: function(){
			var trs = this.table.getElements("tr");
			for (var i=1; i<trs.length; i++){
				if (!trs[i].hasClass("datagridTotalTr")){
					if (this.json.backgroundColor) trs[i].setStyle("background-color", this.json.backgroundColor);
					if ((i%2)==0){
						if (this.json.zebraColor) trs[i].setStyle("background-color", this.json.zebraColor);
					}
				}
			}
		},
		createTotalTr: function(){
			var trs = this.node.getElements("tr");
			var lastTr = trs[trs.length-1];
			this.totalTr = new Element("tr.datagridTotalTr", {"styles": this.form.css.datagridTotalTr}).inject(lastTr, "after");
			var ths = this.node.getElements("th");
			ths.each(function(th, idx){
				var td = new Element("td", {"text": "", "styles": this.form.css.datagridTotalTd}).inject(this.totalTr);
				if (this.json.amountStyles) td.setStyles(this.json.amountStyles);

				var json = this.form._getDomjson(th);
				if( json && json.isShow === false )td.hide();
			}.bind(this));
		},
		_loadTotal: function(){
			var data = {};
			this.totalResaults = {};
			if (this.totalModules.length){
				if (!this.totalTr){
					this.createTotalTr();
				}

				var totalResaults = [];
				//this.totalModules.each(function(m. i){
				//    totalResaults.push(0);
				//}.bind(this));

				var trs = this.table.getElements("tr");
				var totalTds = this.totalTr.getElements("td");

				for (var i=1; i<trs.length; i++){
					if (!trs[i].hasClass("datagridTotalTr") && (!trs[i].hasClass("datagridEditorTr"))){
						var cells = trs[i].getElements("td");

						this.totalModules.each(function(m, i){
							if (!totalResaults[i]) totalResaults.push(0);
							var tmpV = new Decimal(totalResaults[i]);
							if (m.type=="number"){
								var cell = cells[m.index];
								var addv = cell.get("text").toFloat();
								tmpV = tmpV.plus(addv||0);
								//tmpV = tmpV + addv;
							}
							if (m.type=="count"){
								tmpV = tmpV.plus(1);
								//tmpV = tmpV+1;
							}
							totalResaults[i] = tmpV.toString();
							data[m.module.json.id] = totalResaults[i];

						}.bind(this));
					}
				}

				this.totalModules.each(function(m, i){
					this.totalResaults[m.module.json.id] = totalResaults[i];
					var td = totalTds[m.index];
					td.set("text", isNaN( totalResaults[i] ) ? "" : totalResaults[i] );
				}.bind(this));
			}
			return data;
		},
		_loadSequence: function(){
			var trs = this.table.getElements("tr");
			for (var i=1; i<trs.length; i++){
				var cells = trs[i].getElements("td");
				cells.each(function(cell){
					var module = cell.retrieve("module");
					if (module){
						if (module.json.cellType=="sequence"){
							cell.set("text", i)
						}
					}
				}.bind(this));
			}
		},

		_loadBorderStyle: function(){
			if (this.json.border){
				this.table.setStyles({
					"border-top": this.json.border,
					"border-left": this.json.border
				});
				var ths = this.table.getElements("th");
				ths.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border
				});
				var tds = this.table.getElements("td");
				tds.setStyles({
					"border-bottom": this.json.border,
					"border-right": this.json.border,
					"background": "transparent"
				});
			}
		},
		_loadDatagridTitleModules: function(){
			var ths = this.node.getElements("th");
			ths.each(function(th){
				var json = this.form._getDomjson(th);
				th.store("dataGrid", this);
				if (json){
					var module = this.form._loadModule(json, th);
					this.form.modules.push(module);
					if( json.isShow === false )th.hide();
				}
			}.bind(this));
		},
		_loadDatagridDataModules: function(){
			var tds = this.node.getElements("td");
			tds.each(function(td){
				var json = this.form._getDomjson(td);
				td.store("dataGrid", this);
				if (json){
					var isField = false;
					var module = this.form._loadModule(json, td, function(){
						isField = this.field;
						this.field = false;
					});
					if( isField ){
						module.node.setStyle("padding-right","0px");
					}
					td.store("module", module);
					this.form.modules.push(module);
					if( json.isShow === false )td.hide();
				}
			}.bind(this));
		},
		_afterLoaded: function(){
			if (this.moduleValueAG){
				this.moduleValueAG.then(function(){
					this._loadDatagridStyle();
				}.bind(this));
			}else{
				this._loadDatagridStyle();
			}
		},
		/**
		 * @summary 重置数据网格的值为默认值或置空。
		 *  @example
		 * this.form.get('fieldId').resetData();
		 */
		resetData: function(){
			this.setData(this._getValue());
		},
		/**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
		 * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
		 * @summary 为数据网格赋值。
		 * @param data{DatagridData|Promise|Array} 必选，数组或Promise.
		 * @example
		 *  this.form.get("fieldId").setData([]); //赋空值
		 * @example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      this.form.get('fieldId').setData( data );
		 *  }else{
		 *      this.data['fieldId'] = data;
		 *  }
		 *@example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 */
		setData: function(data){
			if (!data){
				data = this._getValue();
			}
			this._setData(data);
		},
		_setData: function(data){
			var p = o2.promiseAll(this.data).then(function(v){
				this.gridData = v;
				if (o2.typeOf(data)=="array") data = {"data": data};
				this.__setData(data);
				this.moduleValueAG = null;
				return v;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));

			// if (data && data.isAG){
			// 	this.moduleValueAG = data;
			// 	data.addResolve(function(v){
			// 		this._setData(v);
			// 	}.bind(this));
			// }else{
			// 	if (o2.typeOf(data)=="array") data = {"data": data};
			// 	this.__setData(data);
			// 	this.moduleValueAG = null;
			// }
		},
		__setData: function(data){
			// if( typeOf( data ) === "object" && typeOf(data.data) === "array"  ){
			this._setBusinessData(data);
			this.gridData = data;

			// if (this.isEdit) this._completeLineEdit();
			if( this.isEdit ){ //如果有在编辑的，取消编辑行
				if (this.currentEditLine) {
					this.currentEditLine.setStyle("display", "table-row");
				}
				this.isEdit = false;
				this.currentEditLine = null;
				this._editorTrGoBack();
			}

			if (this.gridData){
				var trs = this.table.getElements("tr");
				for (var i=1; i<trs.length-1; i++){
					var tr = trs[i];
					if( tr.hasClass("datagridEditorTr") )continue;
					var tds = tr.getElements("td");
					for (var j=0; j<tds.length; j++){
						var td = tds[j];
						var module = td.retrieve("module");
						if (module){
							this.form.modules.erase(module);
							module = null;
						}
					}
				}
				for (var i=1; i<trs.length-1; i++){
					if( trs[i].hasClass("datagridTotalTr") )continue;
					if( trs[i].hasClass("datagridEditorTr") )continue;
					trs[i].destroy();
				}
				//while (this.table.rows.length>2){
				//this.table.rows[1].destroy();
				//}
				if (this.editable!=false){
					this._loadEditDatagrid();
					//this._loadReadDatagrid();
				}else{
					this._loadReadDatagrid();
				}
				this._loadDatagridStyle();
			}
		},
		/**
		 * @summary 获取总计数据.
		 * @example
		 * var totalObject = this.form.get('fieldId').getTotal();
		 * @return {Object} 总计数据
		 */
		getTotal: function(){
			this._loadTotal();
			return this.totalResaults;
		},
		/**
		 * @summary 判断数据网格是否为空.
		 * @example
		 * if( this.form.get('fieldId').isEmpty() ){
		 *     this.form.notice('至少需要添加一条数据', 'warn');
		 * }
		 * @return {Boolean} 是否为空
		 */
		isEmpty: function(){
			var data = this.getData();
			if( !data )return true;
			if( typeOf( data ) === "object" ){
				if( typeOf( data.data ) !== "array" )return true;
				if( data.data.length === 0 )return true;
			}
			return false;
		},

		/**
		 * 在脚本中使用 this.data[fieldId] 也可以获取组件值。
		 * 区别如下：<br/>
		 * 1、当使用Promise的时候<br/>
		 * 使用异步函数生成器（Promise）为组件赋值的时候，用getData方法立即获取数据，可能返回修改前的值，当Promise执行完成以后，会返回修改后的值。<br/>
		 * this.data[fieldId] 立即获取数据，可能获取到异步函数生成器，当Promise执行完成以后，会返回修改后的值。<br/>
		 * {@link https://www.yuque.com/o2oa/ixsnyt/ws07m0#EggIl|具体差异请查看链接}<br/>
		 * 2、当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
		 * @summary 获取数据网格数据.
		 * @example
		 * var data = this.form.get('fieldId').getData();
		 *@example
		 *  //如果无法确定表单上是否有组件，需要判断
		 *  var data;
		 *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
		 *      data = this.form.get('fieldId').getData();
		 *  }else{
		 *      data = this.data['fieldId']; //直接从数据中获取字段值
		 *  }
		 *  @example
		 *  //使用Promise
		 *  var field = this.form.get("fieldId");
		 *  var promise = new Promise(function(resolve, reject){ //发起异步请求
		 *    var oReq = new XMLHttpRequest();
		 *    oReq.addEventListener("load", function(){ //绑定load事件
		 *      resolve(oReq.responseText);
		 *    });
		 *    oReq.open("GET", "/data.json"); //假设数据存放在data.json
		 *    oReq.send();
		 *  });
		 *  promise.then( function(){
		 *    var data = field.getData(); //此时由于异步请求已经执行完毕，getData方法获得data.json的值
		 * })
		 *  field.setData( promise );
		 * @return {DatagridData}
		 */
		getData: function(){
			if (this.editable!=false){
				if (this.isEdit) this._completeLineEdit();
				var data = [];
				var trs = this.table.getElements("tr");
				for (var i=1; i<trs.length-1; i++){
					var tr = trs[i];
					var d = tr.retrieve("data");
					if (d) data.push(d);
				}

				this.gridData = {};
				this.gridData.data = data;

				this._loadTotal();
				this.gridData.total = this.totalResaults;

				this._setBusinessData(this.gridData);

				return (this.gridData.data.length) ? this.gridData : {data:[]};
			}else{
				return this._getBusinessData();
			}
		},
		getAmount: function(){
			return this._loadTotal();
		},
		createErrorNode: function(text){
			var node = new Element("div");
			var iconNode = new Element("div", {
				"styles": {
					"width": "20px",
					"height": "20px",
					"float": "left",
					"background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
				}
			}).inject(node);
			var textNode = new Element("div", {
				"styles": {
					"line-height": "20px",
					"margin-left": "20px",
					"color": "red",
					"word-break": "keep-all"
				},
				"text": text
			}).inject(node);
			return node;
		},
		notValidationMode: function(text){
			if (!this.isNotValidationMode){
				this.isNotValidationMode = true;
				this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
				this.node.setStyle("border", "1px solid red");

				this.errNode = this.createErrorNode(text).inject(this.node, "after");
				this.showNotValidationMode(this.node);
			}
		},
		showNotValidationMode: function(node){
			var p = node.getParent("div");
			if (p){
				if (p.get("MWFtype") == "tab$Content"){
					if (p.getParent("div").getStyle("display")=="none"){
						var contentAreaNode = p.getParent("div").getParent("div");
						var tabAreaNode = contentAreaNode.getPrevious("div");
						var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
						var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
						tabNode.click();
						p = tabAreaNode.getParent("div");
					}
				}
				this.showNotValidationMode(p);
			}
		},
		validationMode: function(){
			if (this.isNotValidationMode){
				this.isNotValidationMode = false;
				this.node.setStyles(this.node.retrieve("borderStyle"));
				if (this.errNode){
					this.errNode.destroy();
					this.errNode = null;
				}
			}
		},

		validationConfigItem: function(routeName, data){
			var flag = (data.status=="all") ? true: (routeName == data.decision);
			if (flag){
				var n = this.getData();
				if( typeOf(n)==="object" && JSON.stringify(n) === JSON.stringify({data:[]}) )n = "";
				var v = (data.valueType=="value") ? n : n.length;
				switch (data.operateor){
					case "isnull":
						if (!v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notnull":
						if (v){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "gt":
						if (v>data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "lt":
						if (v<data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "equal":
						if (v==data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "neq":
						if (v!=data.value){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "contain":
						if (v.indexOf(data.value)!=-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
					case "notcontain":
						if (v.indexOf(data.value)==-1){
							this.notValidationMode(data.prompt);
							return false;
						}
						break;
				}
			}
			return true;
		},
		validationConfig: function(routeName, opinion){
			if (this.json.validationConfig){
				if (this.json.validationConfig.length){
					for (var i=0; i<this.json.validationConfig.length; i++) {
						var data = this.json.validationConfig[i];
						if (!this.validationConfigItem(routeName, data)) return false;
					}
				}
				return true;
			}
			return true;
		},
		/**
		 * @summary 根据组件的校验设置进行校验。
		 *  @param {String} [routeName] - 可选，路由名称.
		 *  @example
		 *  if( !this.form.get('fieldId').validation() ){
		 *      return false;
		 *  }
		 *  @return {Boolean} 是否通过校验
		 */
		validation: function(routeName, opinion){
			if (this.isEdit){
				if (!this.editValidation()){
					return false;
				}
			}
			if (!this.validationConfig(routeName, opinion))  return false;

			if (!this.json.validation) return true;
			if (!this.json.validation.code) return true;

			this.currentRouteName = routeName;
			var flag = this.form.Macro.exec(this.json.validation.code, this);
			this.currentRouteName = "";

			if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
			if (flag.toString()!="true"){
				this.notValidationMode(flag);
				return false;
			}
			return true;
		},
		getAttachmentRandomSite: function(){
			var i = (new Date()).getTime();
			return this.json.id+i;
		},


		isAvaliableImpExpColumn : function(thJson, module, type){
			if (thJson && ( thJson.isShow === false || thJson.isImpExp === false ))return false; //隐藏列，不允许导入导出
			if (module && (module.json.type == "sequence" || module.json.cellType == "sequence") )return false; //序号列
			if (module && ["Image","Button","ImageClipper","Attachment","AttachmentDg","Label"].contains(module.json.type) )return false; //图片，附件,Label列不导入导出
			// if (type==="import" && module && ["Label"].contains(module.json.type))return false; //Label 不导入
			return true;
		},
		getExportColWidthArray : function(){
			var titleThs = this.titleTr.getElements("th");
			var colWidthArr = [];
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列

				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
					if (module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)) {
						colWidthArr.push(340);
					} else if (module && module.json.type === "Address") {
						colWidthArr.push(170);
					} else if (module && module.json.type === "Textarea") {
						colWidthArr.push(260);
					} else if (module && module.json.type === "Htmleditor") {
						colWidthArr.push(500);
					} else if (module && module.json.type === "Calendar") {
						colWidthArr.push(150);
					} else {
						colWidthArr.push(150);
					}
				}
			}.bind(this));
			return colWidthArr;
		},
		getExportDateIndexArray : function(){
			var titleThs = this.titleTr.getElements("th");
			var dateIndexArr = []; //日期格式列下标
			var idx=0;
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
					if (module && module.json.type === "Calendar") {
						dateIndexArr.push(idx);
					}
					idx++;
				}
			}.bind(this));
			return dateIndexArr;
		},
		getExportTitleArray : function( type ){
			var titleThs = this.titleTr.getElements("th");
			var titleArr = [];
			titleThs.each(function(th, index){
				if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
				var thJson = this.form._getDomjson( th );
				var module = this.editModules[this.editable ? (index-1) : index];
				if ( this.isAvaliableImpExpColumn( thJson, module, type ) ) {
					titleArr.push(th.get("text"));
				}
			}.bind(this));
			return titleArr;
		},

		exportToExcel : function () {
			debugger;
			var titleThs = this.titleTr.getElements("th");
			// var editorTds = this.editorTr.getElements("td");

			var resultArr = [];

			var titleArr = this.getExportTitleArray();
			var colWidthArr = this.getExportColWidthArray();
			var dateIndexArr = this.getExportDateIndexArray(); //日期格式列下标

			// var idx=0;
			// titleThs.each(function(th, index){
			// 	if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列
			//
			// 	var thJson = this.form._getDomjson( th );
			// 	var module = this.editModules[this.editable ? (index-1) : index];
			// 	if ( this.isAvaliableImpExpColumn( thJson, module ) ) {
			// 		if (module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)) {
			// 			colWidthArr.push(340);
			// 		} else if (module && module.json.type === "Address") {
			// 			colWidthArr.push(170);
			// 		} else if (module && module.json.type === "Textarea") {
			// 			colWidthArr.push(260);
			// 		} else if (module && module.json.type === "Htmleditor") {
			// 			colWidthArr.push(500);
			// 		} else if (module && module.json.type === "Calendar") {
			// 			colWidthArr.push(150);
			// 			dateIndexArr.push(idx);
			// 		} else {
			// 			colWidthArr.push(150);
			// 		}
			// 		idx++;
			// 		titleArr.push(th.get("text"));
			// 	}
			// }.bind(this));

			resultArr.push( titleArr );

			if (this.gridData.data){
				this.gridData.data.each(function(data, idx){
					var array = [];

					titleThs.each(function(th, index){
						if ( this.editable && (index===0 || index === titleThs.length-1) )return; //第一列操作列和最后一列排序列

						var module = this.editModules[ this.editable ? (index-1) : index];
						var thJson = this.form._getDomjson( th );

						if ( this.isAvaliableImpExpColumn( thJson, module ) ) {

							var cellData = data[th.get("id")];
							var text = "";

							if( cellData ) {
								if (typeOf(cellData) !== "array") { //序号
									for (key in cellData) {
										var value = cellData[key];
										if (module && ["Org", "Reader", "Author", "Personfield", "Orgfield"].contains(module.json.type)) {
											if (typeOf(value) === "array") {
												var textArray = [];
												value.each(function (item) {
													if (typeOf(item) === "object") {
														textArray.push(item.distinguishedName);
													} else {
														textArray.push(item);
													}
												}.bind(this));
												text = textArray.join(", \n");
											} else if (typeOf(value) === "object") {
												text = value.distinguishedName;
											} else {
												text = value;
											}
										} else if (module && module.json.type === "Textarea") {
											text = value;
										} else {
											text = this._getValueText(this.editable ? (index - 1) : index, value);
										}
										break;
									}
								}
							} else if (module && module.json.type === "Label" && module.node) {
								text = module.node.get("text");
							}

							if( !text && typeOf(text) !== "number" ){
								text = "";
							}

							array.push( text );
						}


					}.bind(this));

					resultArr.push( array );

				}.bind(this));
			}

			var title;
			if( this.json.excelName && this.json.excelName.code ){
				title = this.form.Macro.exec(this.json.excelName.code, this);
			}else{
				title = MWF.xApplication.process.Xform.LP.exportDefaultName;
			}
			var titleA = title.split(".");
			if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
				titleA.splice( titleA.length-1 );
			}
			title = titleA.join(".");

			var arg = { data : resultArr, colWidthArray : colWidthArr, title : title };
			this.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel( resultArr, arg.title || title, colWidthArr, dateIndexArr );
		},
		importFromExcel : function () {
			debugger;
			var columnList = [];

			var dateColArray = []; //日期列
			var titleThs = this.titleTr.getElements("th");

			var idx = 1;
			var orgTitleList = [];
			titleThs.each(function(th, index){
				if (this.editable && (index===0 || index === titleThs.length-1 ))return; //第一列操作列和最后一列排序列
				var module = this.editModules[this.editable ? (index-1) : index];
				var thJson = this.form._getDomjson( th );
				if ( this.isAvaliableImpExpColumn( thJson, module, "import" )){
					columnList.push({
						text : th.get("text").trim(),
						index: idx,
						thJson: thJson,
						module: module
					});
					idx++;
					if (module && module.json.type === "Calendar"){
						dateColArray.push(idx);
					}else if( module && ["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type) ){
						orgTitleList.push(th.get("text"));
					}
				}
			}.bind(this));


			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).upload( dateColArray, function (importedData) {

				var checkAndImport = function () {
					if( !this.checkImportedData( columnList, importedData ) ){
						this.openImportedErrorDlg( columnList, importedData );
					}else{
						this.setImportData( columnList, importedData )
					}
				}.bind(this);

				if( orgTitleList.length > 0 ){
					this.listImportAllOrgData( orgTitleList, importedData, function () {
						checkAndImport();
					}.bind(this));
				}else{
					checkAndImport();
				}


			}.bind(this));
		},
		parseImportedData: function(columnList, importedData){
			var data = {
				"data" : []
			};

			importedData.each( function( importedLineData, lineIndex ){

				var lineData = {};

				columnList.each( function (obj, i) {
					var index = obj.index;
					var module = obj.module;
					var thJson = obj.thJson;
					var text = obj.text;

					var d = importedLineData[text] || "";

					var value;
					switch (module.json.type) {
						case "Org":
						case "Reader":
						case "Author":
						case "Personfield":
						case "Orgfield":
							if( !d ){
								value = [];
							}else{
								var arr = d.split(/\s*,\s*/g ); //空格,空格
								// if( arr.length === 0 ){
								// 	value = this.getImportOrgData( d );
								// }else{
								value = [];
								arr.each( function(d, idx){
									var obj = this.getImportOrgData( d );
									value.push( obj );
								}.bind(this));
								// }
							}
							break;
						case "Combox":
						case "Address":
							arr = d.split(/\s*,\s*/g ); //空格,空格
							value = arr; //arr.length === 1  ? arr[0] : arr;
							break;
						case "Checkbox":
							arr = d.split(/\s*,\s*/g ); //空格,空格
							var options = module.getOptionsObj();
							arr.each( function( a, i ){
								var idx = options.textList.indexOf( a );
								arr[ i ] = idx > -1 ? options.valueList[ idx ] : "";
							});
							value = arr.length === 1  ? arr[0] : arr;
							break;
						case "Radio":
						case "Select":
							value = d.replace(/&#10;/g,""); //换行符&#10;
							var options = module.getOptionsObj();
							var idx = options.textList.indexOf( value );
							value = idx > -1 ? options.valueList[ idx ] : "";
							break;
						case "Textarea":
							value = d.replace(/&#10;/g,"\n"); //换行符&#10;
							break;
						case "Calendar":
							value = d.replace(/&#10;/g,""); //换行符&#10;
							if( value ){
								var format;
								if (!module.json.format){
									if (module.json.selectType==="datetime" || module.json.selectType==="time"){
										format = (module.json.selectType === "time") ? "%H:%M" : (Locale.get("Date").shortDate + " " + "%H:%M")
									}else{
										format = Locale.get("Date").shortDate;
									}
								}else{
									format = module.json.format;
								}
								value = Date.parse( value ).format( format );
							}
							break;
						default:
							value = d.replace(/&#10;/g,""); //换行符&#10;
							break;
					}

					lineData[ thJson.id ] = {};
					lineData[ thJson.id ][ module.json.id ] = value;

				}.bind(this));

				data.data.push( lineData );
			}.bind(this));
			return data;
		},
		setImportData: function(columnList, importedData){

			var data = this.parseImportedData( columnList, importedData );

			this.fireEvent("import", [data] );

			this.setData( data );
			this.form.notice( MWF.xApplication.process.Xform.LP.importSuccess );

		},
		openImportedErrorDlg : function( columnList, tableData ){
			var _self = this;

			var objectToString = function (obj, type) {
				if(!obj)return "";
				var arr = [];
				Object.each(obj,  function (value, key) {
					if( type === "style" ){
						arr.push( key + ":"+ value +";" )
					}else{
						arr.push( key + "='"+ value +"'" )
					}
				})
				return arr.join( " " )
			}

			var htmlArray = ["<table "+ objectToString( this.json.properties ) +" style='"+objectToString( this.json.tableStyles, "style" )+"'>"];

			var titleStyle = objectToString( this.json.titleStyles, "style" );
			htmlArray.push( "<tr>" );
			columnList.each( function (obj, i) {
				htmlArray.push( "<th style='"+titleStyle+"'>"+obj.text+"</th>" );
			});
			htmlArray.push( "<th style='"+titleStyle+"'> "+MWF.xApplication.process.Xform.LP.validationInfor +"</th>" );
			htmlArray.push( "</tr>" );

			var contentStyles = Object.clone( this.json.contentStyles );
			if( !contentStyles[ "border-bottom" ] && !contentStyles[ "border" ] )contentStyles[ "border-bottom" ] = "1px solid #eee";
			var contentStyle = objectToString( Object.merge( contentStyles, {"text-align":"left"}) , "style" );

			tableData.each( function( lineData, lineIndex ){

				htmlArray.push( "<tr>" );
				columnList.each( function (obj, i) {
					htmlArray.push( "<td style='"+contentStyle+"'>"+ ( lineData[ obj.text ] || '' ).replace(/&#10;/g,"<br/>") +"</td>" ); //换行符&#10;
				});
				htmlArray.push( "<td style='"+contentStyle+"'>"+( lineData.errorTextList ? lineData.errorTextList.join("<br/>") : "" )+"</td>" );
				htmlArray.push( "</tr>" );

			}.bind(this));
			htmlArray.push( "</table>" );

			var div = new Element("div", { style : "padding:10px;", html : htmlArray.join("") });
			var dlg = o2.DL.open({
				"style" : this.form.json.dialogStyle || "user",
				"title": MWF.xApplication.process.Xform.LP.importFail,
				"content": div,
				"offset": {"y": 0},
				"isMax": true,
				"width": 1000,
				"height": 700,
				"buttonList": [
					{
						"type": "exportWithError",
						"text": MWF.xApplication.process.Xform.LP.datagridExport,
						"action": function () { _self.exportWithImportDataToExcel(columnList, tableData); }
					},
					{
						"type": "cancel",
						"text": MWF.LP.process.button.cancel,
						"action": function () { dlg.close(); }
					}
				],
				"onPostClose": function(){
					dlg = null;
				}.bind(this)
			});

		},
		exportWithImportDataToExcel : function ( columnList, importedData ) {
			debugger;
			var titleThs = this.titleTr.getElements("th");
			// var editorTds = this.editorTr.getElements("td");

			var resultArr = [];

			var colWidthArr = this.getExportColWidthArray();
			colWidthArr.push( 220 );

			var dateIndexArr = this.getExportDateIndexArray(); //日期格式列下标

			var titleArr = this.getExportTitleArray("import");
			titleArr.push( MWF.xApplication.process.Xform.LP.validationInfor );
			resultArr.push( titleArr );

			importedData.each( function( lineData, lineIndex ){
				var array = [];
				columnList.each( function (obj, i) {
					array.push( ( lineData[ obj.text ] || '' ).replace(/&#10;/g, "\n") );
				});
				array.push( lineData.errorTextListExcel ? lineData.errorTextListExcel.join("\n") : ""  );

				resultArr.push( array );
			}.bind(this));

			var title;
			if( this.json.excelName && this.json.excelName.code ){
				title = this.form.Macro.exec(this.json.excelName.code, this);
			}else{
				title = MWF.xApplication.process.Xform.LP.exportDefaultName;
			}
			var titleA = title.split(".");
			if( ["xls","xlst"].contains( titleA[titleA.length-1].toLowerCase() ) ){
				titleA.splice( titleA.length-1 );
			}
			title = titleA.join(".");

			var arg = { data : resultArr, colWidthArray : colWidthArr, title : title, withError : true };
			this.fireEvent("export", [arg]);

			new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this).exportToExcel( resultArr, arg.title || title, colWidthArr, dateIndexArr );
		},
		checkImportedData : function( columnList, tableData ){
			var flag = true;

			var parsedData = this.parseImportedData(columnList, tableData);

			var lp = MWF.xApplication.process.Xform.LP;
			var columnText =  lp.importValidationColumnText;
			var columnTextExcel = lp.importValidationColumnTextExcel;
			var excelUtil = new MWF.xApplication.process.Xform.DatagridPC.ExcelUtils(this);

			tableData.each( function(lineData, lineIndex){

				var parsedLineData = (parsedData && parsedData.data) ? parsedData.data[lineIndex] : {};

				var errorTextList = [];
				var errorTextListExcel = [];

				columnList.each( function (obj, i) {
					var index = obj.index;
					var module = obj.module;
					var thJson = obj.thJson;
					var text = obj.text;

					var colInfor = columnText.replace( "{n}", index );
					var colInforExcel = columnTextExcel.replace( "{n}", excelUtil.index2ColName( index-1 ) );

					var d = lineData[text] || "";

					var parsedD = "";
					var ptd = parsedLineData[thJson.id];
					if( typeOf(ptd) === "object")parsedD = ptd[module.json.id];

					if( d ){
						switch (module.json.type) {
							case "Org":
							case "Reader":
							case "Author":
							case "Personfield":
							case "Orgfield":
								var arr = d.split(/\s*,\s*/g ); //空格,空格
								arr.each( function(d, idx){
									var obj = this.getImportOrgData( d );
									if( obj.errorText ){
										errorTextList.push( colInfor + obj.errorText + lp.fullstop );
										errorTextListExcel.push( colInforExcel + obj.errorText + lp.fullstop );
									}
								}.bind(this));
								break;
							case "Number":
								if (isNaN(d)){
									errorTextList.push( colInfor + d + lp.notValidNumber + lp.fullstop );
									errorTextListExcel.push( colInforExcel + d + lp.notValidNumber + lp.fullstop );
								}
								break;
							case "Calendar":
								if( !( isNaN(d) && !isNaN(Date.parse(d) ))){
									errorTextList.push(colInfor + d + lp.notValidDate + lp.fullstop );
									errorTextListExcel.push( colInforExcel + d + lp.notValidDate + lp.fullstop );
								}
								break;
							default:
								break;
						}
					}
					if (module.json.type!="sequence" && module.setData && module.json.type!=="Address"){
						var hasError = false;
						if(["Org","Reader","Author","Personfield","Orgfield"].contains(module.json.type)){
							if(o2.typeOf(parsedD)==="array" && parsedD.length){
								hasError = parsedD.some(function (item) { return item.errorText; })
							}
						}
						if( !hasError ){
							module.setData(parsedD);
							module.validationMode();
							if (!module.validation() && module.errNode){
								errorTextList.push(colInfor + module.errNode.get("text"));
								errorTextListExcel.push( colInforExcel + module.errNode.get("text"));
								module.errNode.destroy();
							}
						}
					}
				}.bind(this));

				if(errorTextList.length>0){
					lineData.errorTextList = errorTextList;
					lineData.errorTextListExcel = errorTextListExcel;
					flag = false;
				}

				debugger;

			}.bind(this));

			var arg = {
				validted : flag,
				data : tableData
			};
			this.fireEvent( "validImport", [arg] );

			return arg.validted;
		},
		getImportOrgData : function( str ){
			str = str.trim();
			var flag = str.substr(str.length-2, 2);
			switch (flag.toLowerCase()){
				case "@i":
					return this.identityMapImported[str] || {"errorText": str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@p":
					return this.personMapImported[str] || {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@u":
					return this.unitMapImported[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				case "@g":
					return this.groupMapImported[str] ||  {"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };
				default:
					return this.identityMapImported[str] ||
						this.personMapImported[str] ||
						this.unitMapImported[str] ||
						this.groupMapImported[str] ||
						{"errorText":  str + MWF.xApplication.process.Xform.LP.notExistInSystem };

			}
		},
		listImportAllOrgData : function (orgTitleList, tableData, callback) {
			var identityList = [], personList = [], unitList = [], groupList = [];
			if( orgTitleList.length > 0 ){
				tableData.each( function( lineData, lineIndex ){
					// if( lineIndex === 0 )return;

					orgTitleList.each( function (title, index) {

						if( !lineData[title] )return;

						var arr = lineData[title].split(/\s*,\s*/g );
						arr.each( function( a ){
							a = a.trim();
							var flag = a.substr(a.length-2, 2);
							switch (flag.toLowerCase()){
								case "@i":
									identityList.push( a ); break;
								case "@p":
									personList.push( a ); break;
								case "@u":
									unitList.push( a ); break;
								case "@g":
									groupList.push( a ); break;
								default:
									identityList.push( a );
									personList.push( a );
									unitList.push( a );
									groupList.push( a );
									break;
							}
						})
					})
				});
				var identityLoaded, personLoaded, unitLoaded, groupLoaded;
				var check = function () {
					if( identityLoaded && personLoaded && unitLoaded && groupLoaded ){
						if(callback)callback();
					}
				};

				this.identityMapImported = {};
				if( identityList.length ){
					o2.Actions.load("x_organization_assemble_express").IdentityAction.listObject({ identityList : identityList }, function (json) {
						json.data.each( function (d) { this.identityMapImported[ d.matchKey ] = d; }.bind(this));
						identityLoaded = true;
						check();
					}.bind(this))
				}else{
					identityLoaded = true;
					check();
				}

				this.personMapImported = {};
				if( personList.length ){
					o2.Actions.load("x_organization_assemble_express").PersonAction.listObject({ personList : personList }, function (json) {
						json.data.each( function (d) { this.personMapImported[ d.matchKey ] = d; }.bind(this));
						personLoaded = true;
						check();
					}.bind(this))
				}else{
					personLoaded = true;
					check();
				}

				this.unitMapImported = {};
				if( unitList.length ){
					o2.Actions.load("x_organization_assemble_express").UnitAction.listObject({ unitList : unitList }, function (json) {
						json.data.each( function (d) { this.unitMapImported[ d.matchKey ] = d; }.bind(this));
						unitLoaded = true;
						check();
					}.bind(this))
				}else{
					unitLoaded = true;
					check();
				}

				this.groupMapImported = {};
				if( groupList.length ){
					o2.Actions.load("x_organization_assemble_express").GroupAction.listObject({ groupList : groupList }, function (json) {
						json.data.each( function (d) { this.groupMapImported[ d.matchKey ] = d; }.bind(this));
						groupLoaded = true;
						check();
					}.bind(this))
				}else{
					groupLoaded = true;
					check();
				}
			}
		}

	});

MWF.xApplication.process.Xform.DatagridPC$Title =  new Class({
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
		this.dataGrid = this.node.retrieve("dataGrid");
		if ((this.json.total == "number") || (this.json.total == "count")){
			this.dataGrid.totalModules.push({
				"module": this,
				"index": (this.dataGrid.editable!=false) ? this.node.cellIndex+1 : this.node.cellIndex,
				"type": this.json.total
			})
		}
		//	this.form._loadModules(this.node);
	}
});
MWF.xApplication.process.Xform.DatagridPC$Data =  new Class({
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
		//this.form._loadModules(this.node);
		this.dataGrid = this.node.retrieve("dataGrid");

		var td = this.node;

		if (this.json.cellType == "sequence"){
			var flag = true;
			for (var i=0; i<this.dataGrid.editModules.length; i++){
				if (this.dataGrid.editModules[i].json.id == this.json.id){
					flag = false;
					break;
				}
			}
			if (flag){
				this.dataGrid.editModules.push({
					"json": {"type": "sequence", "id": this.json.id},
					"node": td  ,
					"focus": function(){}
				});
			}
		}else{
			var moduleNodes = this.form._getModuleNodes(this.node);
			moduleNodes.each(function(node){
				var json = this.form._getDomjson(node);
				if( json ){
					var isField = false;
					if (json.type=="Attachment" || json.type=="AttachmentDg" ){
						json.type = "AttachmentDg";
						//json.site = this.dataGrid.getAttachmentRandomSite();
						//json.id = json.site;
					}
					var module = this.form._loadModule(json, node, function(){
						isField = this.field;
						this.field = false;
					});
					if( isField ){
						module.node.setStyle("padding-right","0px");
					}
					module.dataModule = this;
					this.dataGrid.editModules.push(module);
				}
			}.bind(this));
		}
	}
});

MWF.xApplication.process.Xform.DatagridPC.ExcelUtils = new Class({
	initialize: function( datagrid ){
		this.datagrid = datagrid;
		this.form = datagrid.form;
		if (!FileReader.prototype.readAsBinaryString) {
			FileReader.prototype.readAsBinaryString = function (fileData) {
				var binary = "";
				var pt = this;
				var reader = new FileReader();
				reader.onload = function (e) {
					var bytes = new Uint8Array(reader.result);
					var length = bytes.byteLength;
					for (var i = 0; i < length; i++) {
						binary += String.fromCharCode(bytes[i]);
					}
					//pt.result  - readonly so assign binary
					pt.content = binary;
					pt.onload();
				};
				reader.readAsArrayBuffer(fileData);
			}
		}
	},
	_loadResource : function( callback ){
		if( !window.XLSX || !window.xlsxUtils ){
			var uri = "../x_component_Template/framework/xlsx/xlsx.full.js";
			var uri2 = "../x_component_Template/framework/xlsx/xlsxUtils.js";
			COMMON.AjaxModule.load(uri, function(){
				COMMON.AjaxModule.load(uri2, function(){
					callback();
				}.bind(this))
			}.bind(this))
		}else{
			callback();
		}
	},
	_openDownloadDialog: function(url, saveName){
		/**
		 * 通用的打开下载对话框方法，没有测试过具体兼容性
		 * @param url 下载地址，也可以是一个blob对象，必选
		 * @param saveName 保存文件名，可选
		 */
		if( Browser.name !== 'ie' ){
			if(typeof url == 'object' && url instanceof Blob){
				url = URL.createObjectURL(url); // 创建blob地址
			}
			var aLink = document.createElement('a');
			aLink.href = url;
			aLink.download = saveName || ''; // HTML5新增的属性，指定保存文件名，可以不要后缀，注意，file:///模式下不会生效
			var event;
			if(window.MouseEvent && typeOf( window.MouseEvent ) == "function" ) event = new MouseEvent('click');
			else
			{
				event = document.createEvent('MouseEvents');
				event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			}
			aLink.dispatchEvent(event);
		}else{
			window.navigator.msSaveBlob( url, saveName);
		}
	},

	index2ColName : function( index ){
		if (index < 0) {
			return null;
		}
		var num = 65;// A的Unicode码
		var colName = "";
		do {
			if (colName.length > 0)index--;
			var remainder = index % 26;
			colName =  String.fromCharCode(remainder + num) + colName;
			index = (index - remainder) / 26;
		} while (index > 0);
		return colName;
	},

	upload : function ( dateColIndexArray, callback ) {
		var dateColArray = [];
		dateColIndexArray.each( function (idx) {
			dateColArray.push( this.index2ColName( idx ));
		}.bind(this))


		var uploadFileAreaNode = new Element("div");
		var html = "<input name=\"file\" type=\"file\" accept=\"csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel\" />";
		uploadFileAreaNode.set("html", html);

		var fileUploadNode = uploadFileAreaNode.getFirst();
		fileUploadNode.addEvent("change", function () {
			var files = fileNode.files;
			if (files.length) {
				var file = files.item(0);
				if( file.name.indexOf(" ") > -1 ){
					this.form.notice( MWF.xApplication.process.Xform.LP.uploadedFilesCannotHaveSpaces, "error");
					return false;
				}

				//第三个参数是日期的列
				this.importFromExcel( file, function(json){
					//json为导入的结果
					if(callback)callback(json);
					uploadFileAreaNode.destroy();
				}.bind(this), dateColArray ); //["E","F"]

			}
		}.bind(this));
		var fileNode = uploadFileAreaNode.getFirst();
		fileNode.click();
	},
	exportToExcel : function(array, fileName, colWidthArr, dateIndexArray){
		// var array = [["姓名","性别","学历","专业","出生日期","毕业日期"]];
		// array.push([ "张三","男","大学本科","计算机","2001-1-2","2019-9-2" ]);
		// array.push([ "李四","男","大学专科","数学","1998-1-2","2018-9-2" ]);
		// this.exportToExcel(array, "导出数据"+(new Date).format("db"));
		this._loadResource( function(){
			var data = window.xlsxUtils.format2Sheet(array, 0, 0, null);//偏移3行按keyMap顺序转换
			var wb = window.xlsxUtils.format2WB(data, "sheet1", undefined);
			var wopts = { bookType: 'xlsx', bookSST: false, type: 'binary' };
			var dataInfo = wb.Sheets[wb.SheetNames[0]];

			var widthArray = [];
			array[0].each( function( v, i ){ //设置标题行样式

				if( !colWidthArr )widthArray.push( {wpx: 100} );

				var at = String.fromCharCode(97 + i).toUpperCase();
				var di = dataInfo[at+"1"];
				// di.v = v;
				// di.t = "s";
				di.s = {  //设置副标题样式
					font: {
						//name: '宋体',
						sz: 12,
						color: {rgb: "#FFFF0000"},
						bold: true,
						italic: false,
						underline: false
					},
					alignment: {
						horizontal: "center" ,
						vertical: "center"
					}
				};
			}.bind(this));

			if( dateIndexArray && dateIndexArray.length ){
				dateIndexArray.each( function( value, index ){
					dateIndexArray[ index ] = this.index2ColName(value);
				}.bind(this))
			}

			for( var key in dataInfo ){
				//设置所有样式，wrapText=true 后 /n会被换行
				if( key.substr(0, 1) !== "!" ){
					var di = dataInfo[key];
					if( !di.s )di.s = {};
					if( !di.s.alignment )di.s.alignment = {};
					di.s.alignment.wrapText = true;

					debugger;

					if( dateIndexArray && dateIndexArray.length ){
						var colName = key.replace(/\d+/g,''); //清除数字
						var rowNum = key.replace( colName, '');
						if( rowNum > 1 && dateIndexArray.contains( colName ) ){
							//di.s.numFmt = "yyyy-mm-dd HH:MM:SS"; //日期列 两种方式都可以
							di.z = 'yyyy-mm-dd HH:MM:SS'; //日期列
						}
					}
				}

			}

			if( colWidthArr ){
				colWidthArr.each( function (w) {
					widthArray.push( {wpx: w} );
				})
			}
			dataInfo['!cols'] = widthArray; //列宽度

			this._openDownloadDialog(window.xlsxUtils.format2Blob(wb), fileName +".xlsx");
		}.bind(this))
	},
	importFromExcel : function( file, callback, dateColArray ){
		this._loadResource( function(){
			var reader = new FileReader();
			var workbook, data;
			reader.onload = function (e) {
				//var data = data.content;
				if (!e) {
					data = reader.content;
				}else {
					data = e.target.result;
				}
				workbook = window.XLSX.read(data, { type: 'binary' });
				//wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
				//wb.Sheets[Sheet名]获取第一个Sheet的数据
				var sheet = workbook.SheetNames[0];
				if (workbook.Sheets.hasOwnProperty(sheet)) {
					// fromTo = workbook.Sheets[sheet]['!ref'];
					// console.log(fromTo);
					debugger;
					var worksheet = workbook.Sheets[sheet];

					if( dateColArray && typeOf(dateColArray) == "array" && dateColArray.length ){
						var rowCount;
						if( worksheet['!range'] ){
							rowCount = worksheet['!range'].e.r;
						}else{
							var ref = worksheet['!ref'];
							var arr = ref.split(":");
							if(arr.length === 2){
								rowCount = parseInt( arr[1].replace(/[^0-9]/ig,"") );
							}
						}
						if( rowCount ){
							for( var i=0; i<dateColArray.length; i++ ){
								for( var j=1; j<=rowCount; j++ ){
									var cell = worksheet[ dateColArray[i]+j ];
									if( cell ){
										delete cell.w; // remove old formatted text
										cell.z = 'yyyy-mm-dd'; // set cell format
										window.XLSX.utils.format_cell(cell); // this refreshes the formatted text.
									}
								}
							}
						}
					}

					var json = window.XLSX.utils.sheet_to_json( worksheet );
					//var data = window.XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheet], {dateNF:'YYYY-MM-DD'});
					if(callback)callback(json);
					// console.log(JSON.stringify(json));
					// break; // 如果只取第一张表，就取消注释这行
				}
				// for (var sheet in workbook.Sheets) {
				//     if (workbook.Sheets.hasOwnProperty(sheet)) {
				//         fromTo = workbook.Sheets[sheet]['!ref'];
				//         console.log(fromTo);
				//         var json = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheet]);
				//         console.log(JSON.stringify(json));
				//         // break; // 如果只取第一张表，就取消注释这行
				//     }
				// }
			};
			reader.readAsBinaryString(file);
		})
	}
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Textfield 文本输入框。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Textfield = MWF.APPTextfield =  new Class({
	Implements: [Events],
	Extends: MWF.APP$Input,
	iconStyle: "textFieldIcon",
	
	_loadUserInterface: function(){
		this._loadNode();
        if (this.json.compute === "show"){
            this._setValue(this._computeValue());
        }else{
            this._loadValue();
        }
	},
    _loadNode: function(){
        if (this.readonly || this.json.isReadonly){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    loadDescription: function(){
        if (this.readonly || this.json.isReadonly)return;
        var v = this._getBusinessData();
        if (!v){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ){
                    if (COMMON.Browser.safari) w = w-20;
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            if (COMMON.Browser.Platform.name==="ios"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }else if (COMMON.Browser.Platform.name==="android"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }else{
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                        this.node.getFirst().fireEvent("click");
                    }.bind(this)
                });
            }

            this.node.getFirst().addEvents({
                "focus": function(){
                    this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
    },

    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "display": "block",
                "border": "0px"
            }
        });

        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },

    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon){
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle]
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon);
        }

        this.node.getFirst().addEvent("change", function(){
            var v = this.getInputData("change");
            this._setBusinessData(v);
            this.validationMode();
            if (this.validation()) {
                this._setBusinessData(v);
                this.fireEvent("change");
            }
        }.bind(this));
        if (this.json.ANNModel){
            this.node.getFirst().addEvent("focus", function(){
                o2.Actions.get("x_query_assemble_surface").calculateNeural(this.json.ANNModel, this.form.businessData.work.id, function(json){
                    var arr = json.data.filter(function(d){
                        var value = this.node.getFirst().get("value");
                        return d.score>0.1 && (value.indexOf(d.value)===-1)
                    }.bind(this));
                    if (arr.length){
                        if (!this.modelNode) this.createModelNode();
                        this.modelNode.getLast().empty();
                        this.modelNode.show();
                        this.modelNode.position({ "relativeTo": this.node, "position": "bottomLeft", "edge": 'upperLeft' });

                        arr.each(function(v){
                            var node = new Element("div", {"text": v.value, "styles": this.form.css.modelItemNode}).inject(this.modelNode.getLast());
                            node.addEvents({
                                "mouseover": function(){this.setStyle("color", "#0000ff");},
                                "mouseout": function(){this.setStyle("color", "#a31515");},
                                "mousedown": function(e){
                                    var str = this.node.getFirst().get("value")
                                    this.node.getFirst().set("value", ((str) ? str+", "+e.target.get("text") : e.target.get("text")));
                                    this.modelNode.hide();
                                }.bind(this)
                            });
                        }.bind(this));
                    }
                }.bind(this));
            }.bind(this));

            this.node.getFirst().addEvent("blur", function(){
                if (this.modelNode) this.modelNode.hide();
            }.bind(this));
        }

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
	},
    createModelNode: function(){
        this.modelNode = new Element("div", {"styles": this.form.css.modelNode}).inject(this.node, "after");
        new Element("div", {"styles": this.form.css.modelNodeTitle, "text": MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode);
        new Element("div", {"styles": this.form.css.modelNodeContent, "text": MWF.xApplication.process.Xform.LP.ANNInput}).inject(this.modelNode);
    },


    getInputData: function(){
        if (this.node.getFirst()){
            var v = this.node.getElement("input").get("value");
            if (this.json.dataType=="number"){
                var n = v.toFloat();
                return (isNaN(n)) ? 0 : n;
            }
        }else{
            return this._getBusinessData();
        }
        return v;
    }

}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Button 按钮组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var button = this.form.get("name"); //获取组件
 * //方法2
 * var button = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Button = MWF.APPButton =  new Class({
    Implements: [Events],
    Extends: MWF.APP$Module,
    iconStyle: "personfieldIcon",

    _loadUserInterface: function(){
        // var button = new Element("button");
        // button.inject(this.node, "after");
        // this.node.destroy();
        // this.node = button;

        var button = this.node.getElement("button");
        if (!button) button = new Element("button");
            button.inject(this.node, "after");
        this.node.destroy();
        this.node = button;

        this.node.set({
            "id": this.json.id,
            "text": this.json.name || this.json.id,
            "MWFType": this.json.type
        });
        if (!this.json.preprocessing) this.node.setStyles(this.form.css.buttonStyles);

    }

}); 

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.xDesktop.requireApp("Selector", "package", null, false);
MWF.require("MWF.widget.O2Identity", null, false);
/** @class Org 人员组织组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Org = MWF.APPOrg =  new Class(
    /** @lends MWF.xApplication.process.Xform.Org# */
    {
    Implements: [Events],
    Extends: MWF.APP$Input,
    options: {
        /**
         * 组件加载前触发。
         * @event MWF.xApplication.process.Xform.Org#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载时触发.
         * @event MWF.xApplication.process.Xform.Org#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 组件加载后触发.
         * @event MWF.xApplication.process.Xform.Org#postLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 当组件值改变时触发。
         * @event MWF.xApplication.process.Xform.Org#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 当组件不允许输入（使用人员选择框）时，完成选择人员，并且给组件赋值后执行。
         * @event MWF.xApplication.process.Xform.Org#select
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["load", "queryLoad", "postLoad", "change", "select"],
        /**
         * 人员选择框事件：加载前执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadSelector
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载后执行，由于选择项为异步加载，此时选择项并未加载完成。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadSelector
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择框容器节点前执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择框容器节点后执行。this.target指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadContent
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */

        /**
         * 人员选择框事件：加载分类前执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：选择分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#selectCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：取消选择分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#unselectCategory
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：展开分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#expand
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：折叠分类后执行。this.target指向分类，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#collapse
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */

        /**
         * 人员选择框事件：加载选择项前执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#queryLoadItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：加载选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#postLoadItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：选择选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#selectItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 人员选择框事件：取消选择选择项后执行。this.target指向选择项，this.target.selector指向人员选择框。
         * @event MWF.xApplication.process.Xform.Org#unselectItem
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "selectorEvents" : ["queryLoadSelector","postLoadSelector","queryLoadContent","postLoadContent","queryLoadCategory","postLoadCategory",
            "selectCategory", "unselectCategory","queryLoadItem","postLoadItem","selectItem", "unselectItem","change","expand","collapse"],
        "readonly": true
    },

    iconStyle: "orgIcon",

    getTextData: function(){
        //var value = this.node.get("value");
        //var text = this.node.get("text");
        var value = this.getValue();
        //var text = (this.node.getFirst()) ? this.node.getFirst().get("text") : this.node.get("text");
        var text = [];
        if( typeOf( value ) === "object" )value = [value];
        if( typeOf( value ) === "array" ){
            value.each(function(v){
                if( typeOf(v) === "string" ){
                    text.push(v);
                }else{
                    text.push(v.name+((v.unitName) ? "("+v.unitName+")" : ""));
                }
            }.bind(this));
            return {"value": value || "", "text": [text.join(",")]};
        }else{
            return {"value": [""], "text": [""]};
        }
    },

    loadDescription: function(){
        if (this.readonly || this.json.isReadonly)return;
        var v = this._getBusinessData();
        if (!v || !v.length){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ) {
                    if (COMMON.Browser.safari) w = w - 20;
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function( ev ){
                    this.descriptionNode.setStyle("display", "none");
                    this.clickSelect( ev );
                }.bind(this)
            });
        }
    },
    _loadNode: function(){
        this.field = true;
        if (this.readonly || this.json.isReadonly){
            this._loadNodeRead();
        }else{
            this._getOrgOptions();
            if (this.json.isInput){
                this._loadNodeInputEdit();
            }else{
                this._loadNodeEdit();
            }

        }
    },
    _getOrgOptions: function(){
        this.selectTypeList = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
        if( this.selectTypeList.contains( "identity" ) ) {
            this.identityOptions = new MWF.APPOrg.IdentityOptions(this.form, this.json);
        }
        if( this.selectTypeList.contains( "unit" ) ) {
            this.unitOptions = new MWF.APPOrg.UnitOptions(this.form, this.json);
        }
        if( this.selectTypeList.contains( "group" ) ){
            this.groupOptions = new MWF.APPOrg.GroupOptions( this.form, this.json );
        }

        //this.selectUnits = this.getSelectRange();
        //if (this.json.selectType=="identity"){
        //    this.selectDutys = this.getSelectRangeDuty();
        //}
    },

    _valueMerge: function(values, v){
        if (o2.typeOf(v)=="function"){
            return v.then(function(re){
                this._valueMerge(values, re)
            }.bind(this), function(){});
        }else{
            return values.concat(v);
        }
    },
    _computeValue: function(){

        var simple = this.json.storeRange === "simple";
        var values = [];
        if (this.json.identityValue) {
            this.json.identityValue.each(function(v){
                if (v) values.push(MWF.org.parseOrgData(v, true, simple))
            });
        }
        if (this.json.unitValue) {
            this.json.unitValue.each(function(v){ if (v) values.push(MWF.org.parseOrgData(v, true, simple))});
        }
        if (this.json.dutyValue) {
            var dutys = JSON.decode(this.json.dutyValue);
            var par;
            if (dutys.length){
                dutys.each(function(duty){
                    if (duty.code) par = this.form.Macro.exec(duty.code, this);
                    if (par){
                        var pars = (o2.typeOf(par)=="array") ? par : [par];
                        var promise = Promise.all(pars).then(function(p){
                            var uName = p.distinguishedName || p;
                            if (o2.typeOf(p)=="array") uName = p[0].distinguishedName || p[0];
                            var code = "return this.org.getDuty(\""+duty.name+"\", \""+uName+"\", true)";
                            var r = (!!uName) ? this.form.Macro.exec(code, this) : "";

                            var m = (o2.typeOf(r)=="array") ? "all" : "resolve";
                            return Promise[m](r).then(function(d){
                                if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                                var arr = [];
                                d.each(function(dd){
                                    if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                                });
                                return arr;
                            }.bind(this)).catch(function(){
                                console.log("catch error : can not get duty : " + duty.name, + "-" + uName);
                            });
                        }.bind(this), function(){});
                        values.push(promise);
                    }
                }.bind(this));
            }
        }
        if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);
            if (o2.typeOf(fd)=="array"){
                fd.each(function(v){values.push(v);});
            }else{
                values.push(fd);
            }

            // if (fd && fd.isAG){
            //     values.push(fd);
            // }else{
            //     if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
            //     fd.each(function(fdd){
            //         if (fdd){
            //             if (typeOf(fdd)==="string"){
            //                 var data;
            //                 this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, fdd, false);
            //                 values.push(data);
            //             }else{
            //                 values.push(fdd);
            //             }
            //         }
            //     }.bind(this));
            // }
        }
        // if (this.json.count>0){
        //     return values.slice(0, this.json.count);
        // }
        return values;
        //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },
    __computeValue: function(){
        var simple = this.json.storeRange === "simple";
        var values = [];
        if (this.json.identityValue) {
            this.json.identityValue.each(function(v){
                if (v) values.push(MWF.org.parseOrgData(v, true, simple))
            });
        }
        if (this.json.unitValue) {
            this.json.unitValue.each(function(v){ if (v) values.push(MWF.org.parseOrgData(v, true, simple))});
        }
        if (this.json.dutyValue) {
            var dutys = JSON.decode(this.json.dutyValue);
            var par;
            if (dutys.length){
                dutys.each(function(duty){
                    if (duty.code) par = this.form.Macro.exec(duty.code, this);
                    if (par && par.isAG){
                        var ag = o2.AG.all(par).then(function(p){
                            var uName = "";
                            if (p && p.length) uName = p[0].distinguishedName || p[0];
                            var code = "return this.org.getDuty(\""+duty.name+"\", \""+uName+"\", true)";
                            var r = this.form.Macro.exec(code, this);

                            o2.AG.all(r).then(function(d) {
                                //var d = rd[0];
                                if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                                var arr = [];
                                d.each(function(dd){
                                    if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                                });
                                return arr;
                            }.bind(this));
                        }.bind(this));
                        values.push(ag);
                    }else{
                        var code = "return this.org.getDuty(\""+duty.name+"\", \""+par+"\", true)";
                        var r = this.form.Macro.exec(code, this);
                        var ag = o2.AG.all(r).then(function(d) {
                            //var d = rd[0];
                            if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                            var arr = [];
                            d.each(function(dd){
                                if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
                            });
                            return arr;
                        }.bind(this));
                        values.push(ag);

                        // if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
                        // d.each(function(dd){if (dd) values.push(MWF.org.parseOrgData(dd, true, simple));});
                    }

                }.bind(this));
            }
        }
        if (this.json.defaultValue && this.json.defaultValue.code){
            var fd = this.form.Macro.exec(this.json.defaultValue.code, this);

            if (fd && fd.isAG){
                // value.addResolve(function(v){
                //     this._setBusinessData(v);
                //     if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
                //     if (this.readonly || this.json.isReadonly) this.node.set("text", v);
                // }.bind(this));
                values.push(fd);
                // fd.then(function(v){
                //     return this._valueMerge(values, v);
                // }.bind(this));
                // return fd;
            }else{
                if (typeOf(fd)!=="array") fd = (fd) ? [fd] : [];
                fd.each(function(fdd){
                    if (fdd){
                        if (typeOf(fdd)==="string"){
                            var data;
                            this.getOrgAction()[this.getValueMethod(fdd)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, fdd, false);
                            values.push(data);
                        }else{
                            values.push(fdd);
                        }
                    }
                }.bind(this));
            }
        }
        if (this.json.count>0){
            return values.slice(0, this.json.count);
        }
        return values;
        //return (this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "");
    },

    getOrgAction: function(){
        if (!this.orgAction) this.orgAction = MWF.Actions.get("x_organization_assemble_control");
        //if (!this.orgAction) this.orgAction = new MWF.xApplication.Selector.Actions.RestActions();
        return this.orgAction;
    },

    getOptions: function(){

        var _self = this;

        if( this.selectTypeList.length === 0 )return false;

        var values = this.getInputData() || [];

        var exclude = [];
        if( this.json.exclude ){
            var v = this.form.Macro.exec(this.json.exclude.code, this);
            exclude = typeOf(v)==="array" ? v : [v];
        }

        //var count = (this.json.count) ? this.json.count : 0;

        var identityOpt;
        if( this.identityOptions ){
            identityOpt = this.identityOptions.getOptions();
            if (this.json.identityRange!=="all"){
                if ( !identityOpt.noUnit && (!identityOpt.units || !identityOpt.units.length) ){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange, "error", this.node);
                    identityOpt.disabled = true;
                    // return false;
                }
            }
            if ( !identityOpt.noUnit && this.json.dutyRange && this.json.dutyRange!=="all"){
                if (!identityOpt.dutys || !identityOpt.dutys.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange, "error", this.node);
                    identityOpt.disabled = true;
                    // return false;
                }
            }
            identityOpt.values = (this.json.isInput) ? [] : values;
            identityOpt.exclude = exclude;
            if( this.form.json.selectorStyle )identityOpt = Object.merge( identityOpt, this.form.json.selectorStyle );
        }

        var unitOpt;
        if( this.unitOptions ){
            unitOpt = this.unitOptions.getOptions();
            if (this.json.unitRange!=="all"){
                if ( !unitOpt.units || !unitOpt.units.length){
                    this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange, "error", this.node);
                    unitOpt.disabled = true;
                    // return false;
                }
            }
            unitOpt.values = (this.json.isInput) ? [] : values;
            unitOpt.exclude = exclude;
            if( this.form.json.selectorStyle )unitOpt = Object.merge( unitOpt, this.form.json.selectorStyle );
        }

        var groupOpt;
        if( this.groupOptions ){
            groupOpt = this.groupOptions.getOptions();
            groupOpt.values = (this.json.isInput) ? [] : values;
            groupOpt.exclude = exclude;
            if( this.form.json.selectorStyle )groupOpt = Object.merge( groupOpt, this.form.json.selectorStyle );
        }

        //var selectUnits = this.getSelectRange();
        //if (this.json.selectType=="identity"){
        //    var selectDutys = this.getSelectRangeDuty();
        //}

        //if (this.json.range!=="all"){
        //    if (!selectUnits.length){
        //        this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
        //        return false;
        //    }
        //}
        //if (this.json.selectType=="identity"){
        //    if ((this.json.dutyRange) && this.json.dutyRange!=="all"){
        //        if (!selectDutys || !selectDutys.length){
        //            this.form.notice(MWF.xApplication.process.Xform.LP.noSelectRange, "error", this.node);
        //            return false;
        //        }
        //    }
        //}

        var defaultOpt = {};

        if( this.json.events && typeOf(this.json.events) === "object" ){
            Object.each(this.json.events, function(e, key){
                if (e.code){
                    if (this.options.selectorEvents.indexOf(key)!==-1){
                        if( key === "postLoadSelector" ) {
                            this.addEvent("loadSelector", function (selector) {
                                return this.form.Macro.fire(e.code, selector);
                            }.bind(this))
                        }else if( key === "queryLoadSelector"){
                            defaultOpt["onQueryLoad"] = function(target){
                                return this.form.Macro.fire(e.code, target);
                            }.bind(this)
                        }else{
                            defaultOpt["on"+key.capitalize()] = function(target){
                                return this.form.Macro.fire(e.code, target);
                            }.bind(this)
                        }
                    }
                }
            }.bind(this));
        }

        if( this.selectTypeList.length === 1 ){
            return Object.merge( {
                "type": this.selectTypeList[0],
                "onComplete": function(items){
                    this.selectOnComplete(items);
                }.bind(this),
                "onCancel": this.selectOnCancel.bind(this),
                // "onLoad": this.selectOnLoad.bind(this),
                "onLoad": function(){
                    //this 为 selector
                    _self.selectOnLoad(this, this.selector );
                },
                "onClose": this.selectOnClose.bind(this)
            }, defaultOpt, identityOpt || unitOpt || groupOpt )
        }else if( this.selectTypeList.length > 1 ){
            var options = {
                "type" : "",
                "types" : this.selectTypeList,
                "onComplete": function(items){
                    this.selectOnComplete(items);
                }.bind(this),
                "onCancel": this.selectOnCancel.bind(this),
                // "onLoad": this.selectOnLoad.bind(this),
                "onLoad": function(){
                    //this 为 selector
                    _self.selectOnLoad(this)
                },
                "onClose": this.selectOnClose.bind(this)
            };
            if( this.form.json.selectorStyle ){
                options = Object.merge( options, this.form.json.selectorStyle );
            }
            if( identityOpt )options.identityOptions = Object.merge( {}, defaultOpt, identityOpt );
            if( unitOpt )options.unitOptions =  Object.merge( {}, defaultOpt, unitOpt );
            if( groupOpt )options.groupOptions = Object.merge( {}, defaultOpt, groupOpt );
            return options;
        }

        //return {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "values": (this.json.isInput) ? [] : values,
        //    "count": count,
        //    "units": selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? selectDutys : [],
        //    "exclude" : exclude,
        //    "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
        //    "categoryType": this.json.categoryType || "unit",
        //    "onComplete": function(items){
        //        this.selectOnComplete(items);
        //    }.bind(this),
        //    "onCancel": this.selectOnCancel.bind(this),
        //    "onLoad": this.selectOnLoad.bind(this),
        //    "onClose": this.selectOnClose.bind(this)
        //};
    },
    selectOnComplete: function(items){
        var array = [];
        items.each(function(item){
            array.push(item.data);
        }.bind(this));

        var simple = this.json.storeRange === "simple";

        this.checkEmpower( array, function( data ){
            var values = [];
            data.each(function(d){
                values.push(MWF.org.parseOrgData(d, true, simple));
            }.bind(this));

            if (this.json.isInput){
                this.addData(values);
            }else{
                this.setData(values);
            }
            //this._setBusinessData(values);
            this.validationMode();
            this.validation();
            var p = this.getValue();
            if (p.then){
                p.then(function(){
                    this.fireEvent("select");
                }.bind(this), function(){});
            }else{
                this.fireEvent("select");
            }

        }.bind(this))
    },
    selectOnCancel: function(){
        this.validation();
    },
    selectOnLoad: function( selector ){
        if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
        this.fireEvent("loadSelector", [selector])
    },
    selectOnClose: function(){
        v = this._getBusinessData();
        if (!v || !v.length) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
    },

    /**
     * @summary 弹出选择界面.
     * @example
     * this.form.get('org').clickSelect();
     */
    clickSelect: function( ev ){
        if (this.readonly)return;
        if( layout.mobile ){
            setTimeout( function(){ //如果有输入法界面，这个时候页面的计算不对，所以等100毫秒
                var options = this.getOptions();
                if(options){
                    if( this.selector && this.selector.loading ) {
                    }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                    }else{
                        /**
                         * @summary 人员选择框package的对象
                         * @member {o2.O2Selector}
                         * @example
                         *  //可以在脚本中获取该组件
                         * var selector = this.form.get("fieldId").selector.selector; //获取人员选择框对象
                         * var options = selector.options; //获取人员选择框的选项
                         */
                        this.selector = new MWF.O2Selector(this.form.app.content, options);
                    }
                }
            }.bind(this), 100 )
        }else{
            var options = this.getOptions();
            if(options){
                if( this.selector && this.selector.loading ) {
                }else if( this.selector && this.selector.selector && this.selector.selector.active ){
                }else {
                    this.selector = new MWF.O2Selector(this.form.app.content, options);
                }
            }
        }
    },
    resetData: function(){

        var v = this.getValue();
        //this.setData((v) ? v.join(", ") : "");
        this.setData(v);
    },
    isEmpty: function(){
        var data = this.getData();
        if( typeOf(data) !== "array" )return true;
        if( data.length === 0 )return true;
        return false;
    },

    getInputData: function(){
        if (this.json.isInput){
            if (this.combox)return this.combox.getData();
            //return this._getBusinessData();
            return this.node.retrieve("data");
        }else{
            //return this._getBusinessData();
            return this.node.retrieve("data");
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        var node = new Element("div").inject(this.node);
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
    },
    _searchConfirmPerson: function(item){
        var inforNode = item.inforNode || new Element("div");

        var simple = this.json.storeRange === "simple";

        if (item.data){

            var data = item.data;
            if( this.selectTypeList.contains("identity") && this.json.identityResultType === "person"){
                var dn = data.distinguishedName || data;
                if( dn.substr( dn.length-1, 1).toLowerCase() === "i" ){
                    MWF.Actions.get("x_organization_assemble_express").listPersonWithIdentity({
                        identityList : [dn]
                    }, function(json){
                        if( json.data.length > 0 ){
                            if( data["person"] )json.data[0].id = data["person"];
                            item.data = MWF.org.parseOrgData( json.data[0], true, simple );
                            item.value = this.getDataText( item.data );
                            if(item.node)item.node.set("text", item.value);
                        }
                    }.bind(this), null, false)
                }
            }
            if( item.data && ( item.data.createTime || item.data.updateTime ) ){
                item.data = MWF.org.parseOrgData( item.data, true, simple );
            }

            var text = "";
            var flag = item.data.distinguishedName.substr(item.data.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = item.data.name+"("+item.data.unitName+")";
                    break;
                case "@p":
                    text = item.data.name+(item.data.employee ? "("+item.data.employee+")" : "");
                    break;
                case "@u":
                    text = item.data.levelName;
                    break;
                case "@g":
                    text = item.data.name;
                    break;
                default:
                    text = item.data.name;
            }
            inforNode.set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });
        }else{
            inforNode.set({
                "styles": {"font-size": "14px", "color": "#bd0000"},
                "text": MWF.xApplication.process.Xform.LP.noOrgObject
            });
        }
        if (!item.inforNode){
            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: item.node,
                transition: 'flyin'
            });
            item.inforNode = inforNode;
        }

    },
    getSearchOptions: function(){

        if( this.selectTypeList.length === 0 )return false;

        var identityOpt;
        if( this.identityOptions ){
            identityOpt = this.identityOptions.getSearchOptions();
            //if (this.json.identityRange!=="all"){
            //    if ( !identityOpt.units || !identityOpt.units.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentitySelectRange, "error", this.node);
            //        return false;
            //    }
            //}
            //if ((this.json.dutyRange) && this.json.dutyRange!=="all"){
            //    if (!identityOpt.dutys || !identityOpt.dutys.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noIdentityDutySelectRange, "error", this.node);
            //        return false;
            //    }
            //}
        }

        var unitOpt;
        if( this.unitOptions ){
            unitOpt = this.unitOptions.getSearchOptions();
            //if (this.json.unitRange!=="all"){
            //    if ( !unitOpt.units || !unitOpt.units.length){
            //        this.form.notice(MWF.xApplication.process.Xform.LP.noUnitSelectRange, "error", this.node);
            //        return false;
            //    }
            //}
        }

        var groupOpt;
        if( this.groupOptions ){
            groupOpt = this.groupOptions.getOptions();
        }

        if( this.selectTypeList.length === 1 ){
            return Object.merge( {
                "type": this.selectTypeList[0]
            }, identityOpt || unitOpt || groupOpt )
        }else if( this.selectTypeList.length > 1 ){
            var options = {
                "type" : "",
                "types" : this.selectTypeList
            };
            if( identityOpt )options.identityOptions = identityOpt;
            if( unitOpt )options.unitOptions = unitOpt;
            if( groupOpt )options.groupOptions = groupOpt;
            return options;
        }

        //return {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "values": (this.json.isInput) ? [] : values,
        //    "count": count,
        //    "units": selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? selectDutys : [],
        //    "exclude" : exclude,
        //    "expandSubEnable" : (this.json.expandSubEnable=="no") ? false : true,
        //    "categoryType": this.json.categoryType || "unit",
        //    "onComplete": function(items){
        //        this.selectOnComplete(items);
        //    }.bind(this),
        //    "onCancel": this.selectOnCancel.bind(this),
        //    "onLoad": this.selectOnLoad.bind(this),
        //    "onClose": this.selectOnClose.bind(this)
        //};
    },
    _searchOptions: function(value, callback){
        //var options = {
        //    "type": this.json.selectType,
        //    "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
        //    "units": this.selectUnits,
        //    "dutys": (this.json.selectType=="identity") ? this.selectDutys : []
        //};
        var options = this.getSearchOptions();
        if (!this.comboxFilter) this.comboxFilter = new MWF.O2SelectorFilter(value, options);
        this.comboxFilter.filter(value, function(data){
            data.map(function(d){
                var value = Object.clone(d);
                d.value = value;
                var flag = d.distinguishedName.substr(d.distinguishedName.length-2, 2);
                switch (flag.toLowerCase()){
                    case "@i":
                        d.text = d.name+"("+d.unitName+")";
                        break;
                    case "@p":
                        d.text = d.name+(d.employee ? "("+d.employee+")" : "");
                        break;
                    case "@u":
                        d.text = d.name;
                        break;
                    case "@g":
                        d.text = d.name;
                        break;
                    default:
                        d.text = d.name;
                }
            });
            if (callback) callback(data);
        });
    },

    _resetNodeInputEdit: function(){
        var node = new Element("div", {
            "styles": {
                "overflow": "hidden",
                //"position": "relative",
                "margin-right": "20px"
            }
        }).inject(this.node, "after");
        this.node.destroy();
        this.node = node;
    },
    _loadNodeInputEdit: function(){

        this.node.setStyle("overflow","visible");
        var input=null;
        MWF.require("MWF.widget.Combox", function(){
            this.combox = input = new MWF.widget.Combox({
                "count": this.json.count || 0,
                "splitShow": this.json.splitShow || ", ",
                "onCommitInput": function(item){
                    this._searchConfirmPerson(item);
                    //this.fireEvent("change");
                }.bind(this),
                "onChange": function(){
                    this.node.store("data", this.getInputData());
                    this._setBusinessData(this.getInputData());
                    this.fireEvent("change");
                }.bind(this),
                "optionsMethod": this._searchOptions.bind(this)

            });
        }.bind(this), false);
        input.setStyles({
            "background": "transparent",
            "border": "0px"
        });
        input.set(this.json.properties);

        if (!this.json.preprocessing) this._resetNodeInputEdit();

        this.node.empty();
        input.inject(this.node);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect(ev);
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.combox.addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                this.node.store("data", this.getInputData());
                this._setBusinessData(this.getInputData("change"));
            }
        }.bind(this));
    },

    _resetNodeEdit: function(){
        var input = new Element("div", {
            "styles": {
                "background": "transparent",
                "border": "0px",
                "min-height": "24px"
            }
        });
        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "min-height": "24px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);
        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": function (ev) {
                    this.clickSelect(ev);
                }.bind(this)
                //this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle],
                "events": {
                    "click": function (ev) {
                        this.clickSelect(ev);
                    }.bind(this)
                    //this.clickSelect.bind(this)
                }
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().setStyle("height", "auto");
        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()){
                this.node.store("data", this.getInputData());
                this._setBusinessData(this.getInputData("change"));
            }
        }.bind(this));
    },
    getDataText: function(data){
        if (typeOf(data)=="string") return data;
        var text = "";
        var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
        switch (flag.toLowerCase()){
            case "@i":
                text = data.name+"("+data.unitName+")";
                break;
            case "@p":
                text = data.name+ (data.employee ? ("("+data.employee+")") : "");
                break;
            case "@u":
                text = data.name;
                break;
            case "@g":
                text = data.name;
                break;
            default:
                text = data.name;
        }
        return text;
    },
    addData: function(value){
        if (!value) return false;
        var simple = this.json.storeRange === "simple";
        value.each(function(v){
            var vtype = typeOf(v);
            if (vtype==="string"){
                var data;
                this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), null, v, false);
                if (data) this.combox.addNewValue(this.getDataText(data), data);
            }
            if (vtype==="object"){
                var d = MWF.org.parseOrgData(v, true, simple);
                this.combox.addNewValue(this.getDataText(d), d);
            }
        }.bind(this));
    },
    checkChange: function(oldValues, values){
        var change = false;
        if (!values) values = [];
        if (oldValues.length && (values && values.length)){
            if (oldValues.length === values.length){
                for (var i=0; i<oldValues.length; i++){
                    if ((oldValues[i].distinguishedName!==values[i].distinguishedName) || (oldValues[i].name!==values[i].name) || (oldValues[i].unique!==values[i].unique)){
                        change = true;
                        break;
                    }
                }
            }else{
                change = true;
            }
        }else if (values.length || oldValues.length) {
            change = true;
        }
        if (change) this.fireEvent("change");
    },
    setData: function(value){
        if (!value) return false;
        var oldValues = this.getData();
        if (value.length==1 && !(value[0])) value=[];

        var promise = this._setValue(value);
        promise.then(function(values){
            o2.promiseAll(values).then(function(v){
                this.checkChange(oldValues, v)
            }.bind(this), function(){});

            // if (values && values.isAG){
            //     values.then(function(v){
            //         this.checkChange(oldValues, v)
            //     }.bind(this));
            // }else{
            //     this.checkChange(oldValues, values)
            // }
        }.bind(this), function(){});
    },
    // __setData: function(value){
    //     if (!value) return false;
    //     var oldValues = this.getData();
    //     var values = [];
    //     var comboxValues = [];
    //
    //     var simple = this.json.storeRange === "simple";
    //
    //     var type = typeOf(value);
    //     if (type==="array"){
    //         value.each(function(v){
    //             var vtype = typeOf(v);
    //             var data = null;
    //             if (vtype==="string"){
    //                 var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
    //                 this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, v, false);
    //             }
    //             if (vtype==="object") {
    //                 data = MWF.org.parseOrgData(v, true, simple);
    //                 if(data.woPerson)delete data.woPerson;
    //             }
    //             if (data){
    //                 values.push(data);
    //                 comboxValues.push({"text": this.getDataText(data),"value": data});
    //             }
    //         }.bind(this));
    //     }
    //     if (type==="string"){
    //         var vData;
    //         var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
    //         this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, value, false);
    //         if (vData){
    //             values.push(vData);
    //             comboxValues.push({"text": this.getDataText(vData),"value": vData});
    //         }
    //     }
    //     if (type==="object"){
    //         var vData = MWF.org.parseOrgData(value, true, simple);
    //         if(vData.woPerson)delete vData.woPerson;
    //         values.push( vData );
    //         comboxValues.push({"text": this.getDataText(value),"value": vData});
    //     }
    //
    //     var change = false;
    //     if (oldValues.length && values.length){
    //         if (oldValues.length === values.length){
    //             for (var i=0; i<oldValues.length; i++){
    //                 if ((oldValues[i].distinguishedName!==values[i].distinguishedName) || (oldValues[i].name!==values[i].name) || (oldValues[i].unique!==values[i].unique)){
    //                     change = true;
    //                     break;
    //                 }
    //             }
    //         }else{
    //             change = true;
    //         }
    //     }else if (values.length || oldValues.length) {
    //         change = true;
    //     }
    //     this._setBusinessData(values);
    //     if (change) this.fireEvent("change");
    //
    //     if (this.json.isInput){
    //         if (this.combox){
    //             this.combox.clear();
    //             this.combox.addNewValues(comboxValues);
    //         }else{
    //             var node = this.node.getFirst();
    //             if (node){
    //                 node.empty();
    //                 comboxValues.each(function(v, i){
    //                     this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
    //                 }.bind(this));
    //             }
    //         }
    //     }else{
    //         if (this.node.getFirst()){
    //             var node = this.node.getFirst();
    //             node.empty();
    //             this.loadOrgWidget(values, node)
    //         }else{
    //             this.node.empty();
    //             this.loadOrgWidget(values, this.node);
    //         }
    //     }
    // },
    creteShowNode: function(data, islast){
        var nodeText = (data.text) ?  data.text : data;
        if (!islast) nodeText = nodeText + (this.json.splitShow || ", ");

        var node = new Element("div", {
            "styles": {
                "float": "left",
                "margin-right": "5px"
            },
            "text": nodeText
        });
        var text = "";
        if (data.value){
            var flag = data.value.distinguishedName.substr(data.value.distinguishedName.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    text = data.value.name+"("+data.value.unitName+")";
                    break;
                case "@p":
                    text = data.value.name+ (data.value.employee ? "("+data.value.employee+")" : "");
                    break;
                case "@u":
                    text = data.value.levelName;
                    break;
                case "@g":
                    text = data.value.name;
                    break;
                default:
                    text = data.value.name;
            }
            var inforNode = new Element("div").set({
                "styles": {"font-size": "14px", "color": ""},
                "text": text
            });

            new mBox.Tooltip({
                content: inforNode,
                setStyles: {content: {padding: 15, lineHeight: 20}},
                attach: node,
                transition: 'flyin'
            });
        }
        return node;
    },
    _setValue: function(value){
        var values = [];
        var ags = [];
        var simple = this.json.storeRange === "simple";
        var flag = false;
        if (typeOf(value)!=="array") value = (!!value) ? [value] : [];
        //value = (value.flat) ? value.flat() : value.flatten();

        var p = o2.promiseAll(value).then(function(d){
            if (typeOf(d)!=="array") d = (!!d) ? [d] : [];
            d.each(function(da){
                if (typeOf(da)!=="array") da = (!!da) ? [da] : [];
                da.each(function(dd){
                    if (dd){
                        if (typeOf(dd)==="string"){
                            var pp = this.getOrgAction()[this.getValueMethod(dd)](function(json){
                                return MWF.org.parseOrgData(json.data, true, simple);
                            }.bind(this), null, dd, true).catch(function(e){
                                console.log("error:" + e);
                                console.log(e);
                            });
                            ags.push(pp);
                        }else{
                            values.push(dd);
                        }
                    }
                }.bind(this));
            }.bind(this));
            if (ags.length){
                return o2.promiseAll(ags).then(function(data){
                    values = values.concat(data);
                    flag = true;
                    this.__setValue(values);
                    return values;
                }.bind(this), function(){});
            }else{
                flag = true;
                this.__setValue(values);
                return values
            }
        }.bind(this), function(){});

        this.moduleValueAG = p;
        if (p && p.then) p.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));
        return p;

        // var ag = o2.AG.all(value).then(function(d) {
        //     if (typeOf(d)!=="array") d = (d) ? [d.toString()] : [];
        //
        //     d.each(function(dd){
        //         //if (dd) arr.push(MWF.org.parseOrgData(dd, true, simple));
        //         if (dd){
        //             if (typeOf(dd)==="string"){
        //                 ags.push(this.getOrgAction()[this.getValueMethod(dd)](function(json){
        //                     return MWF.org.parseOrgData(json.data, true, simple);
        //                 }.bind(this).ag(), null, dd, true));
        //             }else{
        //                 values.push(dd);
        //             }
        //         }
        //     }.bind(this));
        //     if (ags.length){
        //         return o2.AG.all(ags).then(function(data){
        //             values = values.concat(data);
        //             flag = true;
        //             this.__setValue(values);
        //             return values;
        //         }.bind(this));
        //     }else{
        //         flag = true;
        //         this.__setValue(values);
        //         return values
        //     }
        // }.bind(this));
        //
        // this.moduleValueAG = ag;
        // if (ag) ag.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));
        // return ag;
    },
    __setValue: function(value){
        this.moduleValueAG = null;
        if (value.length==1 && !(value[0])) value=[];

        if (this.json.count>0){
            value = value.slice(0, this.json.count);
        }

        var values = [];
        var comboxValues = [];
        var type = typeOf(value);
        var simple = this.json.storeRange === "simple";
        if (type==="array"){
            value.each(function(v){
                var data=null;
                var vtype = typeOf(v);
                if (vtype==="string"){
                    var error = (this.json.isInput) ? function(){ comboxValues.push(v); } : null;
                    this.getOrgAction()[this.getValueMethod(v)](function(json){ data = MWF.org.parseOrgData(json.data, true, simple); }.bind(this), error, v, false);
                }
                if (vtype==="object") data = v;
                if (data){
                    var d = MWF.org.parseOrgData(data, true, simple)
                    values.push(d);
                    comboxValues.push({"text": this.getDataText(d),"value": d});
                }
            }.bind(this));
        }
        if (type==="string"){
            var vData;
            var error = (this.json.isInput) ? function(){ comboxValues.push(value); } : null;
            this.getOrgAction()[this.getValueMethod(value)](function(json){ vData = MWF.org.parseOrgData(json.data, true,simple); }.bind(this), error, value, false);
            if (vData){
                values.push(vData);
                comboxValues.push({"text": this.getDataText(vData),"value": vData});
            }
        }
        if (type==="object"){
            var v = MWF.org.parseOrgData(value, true, simple)
            values.push(v);
            comboxValues.push({"text": this.getDataText(v),"value": v});
        }

        this.node.store("data", values);
        this._setBusinessData(values);

        if (this.json.isInput){

            if (this.combox){
                this.combox.clear();
                this.combox.addNewValues(comboxValues);

                // values.each(function(v){
                //     if (typeOf(v)=="string"){
                //         this.combox.addNewValue(v);
                //     }else{
                //         this.combox.addNewValue(this.getDataText(v), v);
                //     }
                // }.bind(this));
            }else{
                var node = this.node.getFirst();
                if (node){
                    node.empty();
                    comboxValues.each(function(v, i){
                        this.creteShowNode(v, (i===comboxValues.length-1)).inject(node);
                    }.bind(this));
                }
            }

        }else{
            if (this.node.getFirst()){
                var node = this.node.getFirst();
                node.empty();
                this.loadOrgWidget(values, node)
            }else{
                this.node.empty();
                this.loadOrgWidget(values, this.node);
            }
        }

        //if (this.readonly) this.loadOrgWidget(values, this.node)
        //this.node.set("text", value);
    },
    getValueMethod: function(value){
        if (value){
            var flag = value.substr(value.length-2, 2);
            switch (flag.toLowerCase()){
                case "@i":
                    return "getIdentity";
                case "@p":
                    return "getPerson";
                case "@u":
                    return "getUnit";
                case "@g":
                    return "getGroup";
                default:
                    return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
            }
        }
        return (this.json.selectType==="unit") ? "getUnit" : "getIdentity";
    },
    loadOrgWidget: function(value, node){
        var disableInfor = layout.mobile ? true : false;
        if( this.json.showCard === "no" )disableInfor = true;
        var height = node.getStyle("height").toInt();
        if (node.getStyle("overflow")==="visible" && !height) node.setStyle("overflow", "hidden");
        if (value && value.length){
            value.each(function(data){
                var flag = data.distinguishedName.substr(data.distinguishedName.length-2, 2);
                var copyData = Object.clone(data);
                if( this.json.displayTextScript && this.json.displayTextScript.code ){
                    this.currentData = copyData;
                    var displayName = this.form.Macro.exec(this.json.displayTextScript.code, this);
                    if( displayName ){
                        copyData.displayName = displayName;
                    }
                    this.currentData = null;
                }

                var widget;
                switch (flag.toLowerCase()){
                    case "@i":
                        widget = new MWF.widget.O2Identity(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@p":
                        widget = new MWF.widget.O2Person(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@u":
                        widget = new MWF.widget.O2Unit(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    case "@g":
                        widget = new MWF.widget.O2Group(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                        break;
                    default:
                        widget = new MWF.widget.O2Other(copyData, node, {"style": "xform","lazy":true,"disableInfor" : disableInfor});
                }
                widget.field = this;
                if( layout.mobile ){
                    widget.node.setStyles({
                        "float" : "none"
                    })
                }
            }.bind(this));
        }
    },
    _loadStyles: function(){
        if (this.readonly || this.json.isReadonly){
            if (this.json.styles) this.node.setStyles(this.json.styles);
        }else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
            if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
            if (this.iconNode && this.iconNode.offsetParent !== null ){
                var size = this.node.getSize();
                this.iconNode.setStyle("height", ""+size.y+"px");
            }
        }
    },

    checkEmpower : function( data, callback ){
        if( typeOf(data)==="array" && this.identityOptions && this.json.isCheckEmpower && this.json.identityResultType === "identity" ) {
            var empowerChecker = new MWF.APPOrg.EmpowerChecker(this.form, this.json);
            empowerChecker.load(data, callback);
        }else{
            if( callback )callback( data );
        }
    }

});

MWF.APPOrg.EmpowerChecker = new Class({
    Implements: [Events],
    initialize: function (form, json) {
        this.form = form;
        this.json = json;
        this.css = this.form.css;
        this.checkedAllItems = true;
    },
    load : function( data, callback, container ){
        if( typeOf(data)==="array" && this.json.isCheckEmpower && this.json.identityResultType === "identity" ){
            var array = [];
            data.each( function( d ){
                if( d.distinguishedName ){
                    var flag = d.distinguishedName.substr(d.distinguishedName.length-1, 1).toLowerCase();
                    if( flag === "i" ){
                        array.push( d.distinguishedName )
                    }
                }
            }.bind(this));
            if( array.length > 0 ){
                o2.Actions.get("x_organization_assemble_express").listEmpowerWithIdentity({
                    "application" : (this.form.businessData.work || this.form.businessData.workCompleted).application,
                    "process" : (this.form.businessData.work || this.form.businessData.workCompleted).process,
                    "work" : (this.form.businessData.work || this.form.businessData.workCompleted).id,
                    "identityList" : array
                }, function( json ){
                    var arr = [];
                    json.data.each( function(d){
                        if(d.fromIdentity !== d.toIdentity )arr.push(d);
                    });
                    if( arr.length > 0 ){
                        this.openSelectEmpowerDlg( arr, data, callback, container );
                    }else{
                        if( callback )callback( data );
                    }
                }.bind(this), function(){
                    if( callback )callback( data );
                }.bind(this))
            }else{
                if( callback )callback( data );
            }
        }else{
            if( callback )callback( data );
        }
    },
    getIgnoreEmpowerArray : function( callback ){
        var array = [];
        if( this.empowerSelectNodes && this.empowerSelectNodes.length ){
            this.empowerSelectNodes.each(function(node){
                if( !node.retrieve("isSelected") ){
                    var d = node.retrieve("data");
                    array.push( d.fromIdentity );
                }
            }.bind(this));
        }
        if( callback )callback( array );
        return array;
    },
    setIgnoreEmpowerFlag : function(data, callback){

        var ignoreList = this.getIgnoreEmpowerArray();
        for( var i=0; i<data.length; i++ ){
            var d = data[i];
            if( ignoreList.indexOf( d.distinguishedName ) > -1 ){
                d.ignoreEmpower = true;
            }else if( d.ignoreEmpower ){
                delete  d.ignoreEmpower;
            }
        }
        if( callback )callback( data );
    },
    replaceEmpowerIdentity : function(data, callback){

        var empowerData = {};
        this.empowerSelectNodes.each(function(node){
            if( node.retrieve("isSelected") ){
                var d = node.retrieve("data");
                empowerData[ d.fromIdentity ] = d;
            }
        }.bind(this));

        if( Object.keys(empowerData).length === 0 ){
            callback( data );
        }else{
            var identityList = [];
            for( var key in empowerData ){
                identityList.push( empowerData[key].toIdentity );
            }
            o2.Actions.get("x_organization_assemble_express").listIdentity({ "identityList" : identityList }, function(json){
                var newData = data.clone();
                var d = {};
                json.data.each( function(j){
                    d[j.distinguishedName] = j;
                });
                for( var i=0; i<newData.length; i++ ){
                    var nd = newData[i];
                    if( nd.distinguishedName && empowerData[nd.distinguishedName]){
                        if( d[empowerData[nd.distinguishedName].toIdentity] ){
                            newData[i] = d[empowerData[nd.distinguishedName].toIdentity]
                        }
                    }
                }
                callback( newData );
            },function(){
                callback( data );
            });
        }
    },
    openSelectEmpowerDlg : function( data, orginData, callback, container ){
        if( layout.mobile ){
            this.openSelectEmpowerDlg_mobile(data, orginData, callback, container);
        }else{
            this.openSelectEmpowerDlg_pc(data, orginData, callback, container);
        }
    },
    openSelectEmpowerDlg_mobile : function( data, orginData, callback, container ){



        var that = this;

        //处理json
        var subItemList = [];
        // var empowerMap = {};

        // var selectableItems = [];
        var valueList = [];

        data.each( function( d ){
            subItemList.push({
                "name" : d.fromIdentity.split("@")[0] + " "+MWF.xApplication.process.Xform.LP.empowerTo+" " + d.toIdentity.split("@")[0],
                "id" : d.fromIdentity + "#" + d.toIdentity
            })
            valueList.push({
                "name" : d.fromIdentity.split("@")[0] + " "+MWF.xApplication.process.Xform.LP.empowerTo+" " + d.toIdentity.split("@")[0],
                "id" : d.fromIdentity + "#" + d.toIdentity
            })
            // empowerMap[ d.fromIdentity ] = d.toIdentity;
        }.bind(this));

        if( subItemList.length === 0 ){
            callback();
            return;
        }
        var empowerList = Array.clone(subItemList);

        // selectableItems.push({
        //     "empowerMap" : empowerMap,
        //     "subItemList" : subItemList
        // });

        // if( selectableItems.length === 0 ){
        //     callback();
        //     return;
        // }
        // var empowerList = Array.clone(selectableItems);
        o2.xDesktop.requireApp("Template", "Selector.Custom", function () {
            var options = {
                "count": 0,
                "title": MWF.xApplication.process.Xform.LP.selectEmpower,
                "selectAllEnable" : true,
                "selectableItems": subItemList,
                "expand": false,
                "category": false,
                "values": valueList,
                "zIndex" : 3001,
                "closeOnclickOk" : true,
                "onComplete": function (items) {

                    var arr = [];
                    items.each(function (item) {
                        arr.push( item.data.id )
                    }.bind(this));

                    var ignoreList = [];
                    empowerList.each( function (obj) {
                        if( arr.indexOf( obj.id ) === -1 )ignoreList.push( obj.id.split("#")[0] )
                    });

                    for( var i=0; i<orginData.length; i++ ){
                        var d = orginData[i];
                        if( ignoreList.indexOf( d.distinguishedName ) > -1 ){
                            d.ignoreEmpower = true;
                        }else if( d.ignoreEmpower ){
                            delete  d.ignoreEmpower;
                        }
                    }
                    if( callback )callback( orginData );

                    // empowerList.each( function(obj){
                    // var list = obj.subItemList.filter(function(item, index){
                    //     return !arr.contains( item.id );
                    // }.bind(this));
                    // ignoreList = ignoreList.map(function(item,index){
                    //     return item.id.split("#")[1];
                    // })
                    // });

                    // empowerList.each( function(obj){
                    //     var org = that.orgItemsObject[obj.orgId];
                    //     // if( obj.ignoreList.length > 0 ){
                    //     var data = org.getData();
                    //     for( var i=0; i<data.length; i++ ){
                    //         var d = data[i];
                    //         if( obj.ignoreList.indexOf( d.distinguishedName ) > -1 ){
                    //             d.ignoreEmpower = true;
                    //         }else if( d.ignoreEmpower ){
                    //             delete d.ignoreEmpower;
                    //         }
                    //     }
                    //     org.setData( data );
                        // }

                        // if( obj.empowerMap ){
                        //     var data = org.getValue();
                        //     for( var i=0; i<data.length; i++ ){
                        //         var d = data[i];
                        //         if( obj.empowerMap[ d.distinguishedName ] ){
                        //             d.empowerToIdentity = obj.empowerMap[ d.distinguishedName ];
                        //         }
                        //     }
                        //     org.empowerData = Array.clone(data);
                        // }

                        // if(callback)callback();
                    // })
                }.bind(this)
            };
            if( this.form.json.selectorStyle ){
                Object.merge(options, this.form.json.selectorStyle );
            }
            options.flatCategory = false;
            var selector = new o2.xApplication.Template.Selector.Custom($(document.body), options);
            selector.load();
        }.bind(this))
    },
    openSelectEmpowerDlg_pc : function( data, orginData, callback, container ){
        var node = new Element("div", {"styles": this.css.empowerAreaNode});
        var html = "<div style=\"line-height: 20px; color: #333333; overflow: hidden\">"+MWF.xApplication.process.Xform.LP.empowerDlgText+"</div>";
        html += "<div style=\"margin-bottom:10px; margin-top:10px; overflow-y:auto;\"></div>";
        node.set("html", html);
        var itemNode = node.getLast();
        this.getEmpowerItems(itemNode, data);
        node.inject( container || this.form.app.content);

        var dlg = o2.DL.open({
            "title": MWF.xApplication.process.Xform.LP.selectEmpower,
            "style": this.form.json.dialogStyle || "user",
            "isResize": true,
            "content": node,
            "width": 630,
            //"height" : 500,
            "buttonList": [
                {
                    "type" : "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function(d, e){
                        //this.replaceEmpowerIdentity( orginData, callback ); //直接替换已授权的人，已废弃
                        this.setIgnoreEmpowerFlag( orginData, callback ); //然后设置忽略的人的标志
                        dlg.close();
                    }.bind(this)
                },
                {
                    "type" : "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function(){dlg.close();}
                }
            ],
            "onPostShow": function(){
                var selectNode = this.createSelectAllEmpowerNode();
                selectNode.inject( dlg.button );
                if( layout.mobile ){
                    dlg.node.inject( $(document.body) );
                    dlg.node.setStyles({
                        "width":"100%",
                        "height": "100%",
                        "top" : "0px",
                        "left" : "0px"
                    });
                    var y = dlg.node.getSize().y - 190;
                    itemNode.setStyle("height",y+"px");

                    dlg.options.contentHeight = dlg.node.getSize().y - 100 ; //+100;
                    dlg.setContentSize();
                }else{
                    dlg.content.setStyle("overflow","hidden");

                    var y = Math.min(300, itemNode.getSize().y);
                    var marginTop = itemNode.getStyle("margin-top");
                    var marginBottom = itemNode.getStyle("margin-bottom");
                    itemNode.setStyle("height",y+"px");

                    dlg.options.contentHeight = y + 30 + 20 ; //+100;
                    dlg.setContentSize();
                    dlg.node.setStyles({
                        "height": ""+(dlg.options.height) +"px"
                    });
                    dlg.reCenter();
                }

            }.bind(this)
        });
    },
    getEmpowerItems: function(itemNode, data){
        var _self = this;
        this.empowerSelectNodes = [];
        var count = 1;
        var node;
        data.each(function( d ){
            if(d.fromIdentity == d.toIdentity )return;
            if( count % 2 === 1 ){
                node = new Element("div", {"styles": this.css.empowerItemOddNode}).inject(itemNode);
                node.store("nodeType","Odd");
                //node.setStyle("margin-right","10px");
            }else{
                node = new Element("div", {"styles": this.css.empowerItemEvenNode}).inject(itemNode);
                node.store("nodeType","Even");
            }
            count++;
            this.empowerSelectNodes.push( node );
            node.store("data", d);
            var iconNode = new Element("div.empowerItemIconNode", {"styles": this.css.empowerItemIconNode}).inject(node);
            node.store("iconNode",iconNode);
            var contentNode = new Element("div.empowerItemContentNode", {"styles": this.css.empowerItemContentNode}).inject(node);

            var formIdentityNode = new Element("div.empowerItemPersonNode", {"styles": this.css.empowerItemPersonNode, text : d.fromIdentity.split("@")[0] }).inject(contentNode);
            var titleNode = new Element("div.empowerItemTitleNode", {"styles": this.css.empowerItemTitleNode, text : MWF.xApplication.process.Xform.LP.empowerTo }).inject(contentNode);
            var toIdentityNode = new Element("div.empowerItemPersonNode", {"styles": this.css.empowerItemPersonNode, text : d.toIdentity.split("@")[0] }).inject(contentNode);

            node.addEvents({
                "mouseover": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (!isSelected){
                        this.setStyles(_self.css[ "empowerItem"+this.retrieve("nodeType")+"Node_over" ]);
                        if( _self.css.empowerItemIconNode_over ){
                            var iconNode = this.retrieve("iconNode");
                            if(iconNode)iconNode.setStyles(_self.css.empowerItemIconNode_over);
                        }
                    }
                },
                "mouseout": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (!isSelected){
                        this.setStyles(_self.css[ "empowerItem"+this.retrieve("nodeType")+"Node" ])
                        if( _self.css.empowerItemIconNode_over ){
                            var iconNode = this.retrieve("iconNode");
                            if(iconNode)iconNode.setStyles(_self.css.empowerItemIconNode);
                        }
                    }
                },
                "click": function(){
                    var isSelected = this.retrieve("isSelected");
                    if (isSelected){
                        _self.unselectEmpowerItem( this)
                    }else{
                        _self.selectEmpowerItem(this)
                    }
                }
            });
            if( this.checkedAllItems )node.click();
        }.bind(this));
    },
    unselectEmpowerItem : function( itemNode ){
        itemNode.store("isSelected", false);
        itemNode.setStyles( this.css[ "empowerItem"+itemNode.retrieve("nodeType")+"Node" ] );
        itemNode.getElements("div").each( function( div ){
            var className = div.get("class");
            if( className && this.css[className] )div.setStyles( this.css[className] )
        }.bind(this))
    },
    selectEmpowerItem : function( itemNode ){
        itemNode.store("isSelected", true);
        itemNode.setStyles( this.css[ "empowerItem"+itemNode.retrieve("nodeType")+"Node_selected" ] );
        itemNode.getElements("div").each( function( div ){
            var className = div.get("class");
            if( className && this.css[className+"_selected"] )div.setStyles( this.css[className+"_selected"] )
        }.bind(this))
    },
    createSelectAllEmpowerNode : function(){
        var _self = this;
        var node = new Element("div", {
            styles : this.css.empowerSelectAllItemNode,
            text : MWF.xApplication.process.Xform.LP.selectAll
        });
        node.addEvents({
            "mouseover": function(){
                var isSelected = this.retrieve("isSelected");
                if (!isSelected) this.setStyles(_self.css.empowerSelectAllItemNode_over);
            },
            "mouseout": function(){
                var isSelected = this.retrieve("isSelected");
                if (!isSelected) this.setStyles(_self.css.empowerSelectAllItemNode)
            },
            "click": function(){
                var isSelected = this.retrieve("isSelected");
                if (isSelected){
                    this.store("isSelected", false);
                    this.setStyles( _self.css.empowerSelectAllItemNode );
                    _self.empowerSelectNodes.each( function(itemNode){
                        _self.unselectEmpowerItem(itemNode)
                    }.bind(this))
                }else{
                    this.store("isSelected", true);
                    this.setStyles( _self.css.empowerSelectAllItemNode_selected );
                    _self.empowerSelectNodes.each( function(itemNode){
                        _self.selectEmpowerItem(itemNode)
                    }.bind(this))
                }
            }
        });
        if( this.checkedAllItems ){
            node.store("isSelected", true);
            node.setStyles( _self.css.empowerSelectAllItemNode_selected );
        }
        return node;
    }
});

MWF.APPOrg.GroupOptions = new Class({
    Implements: [Events],
    initialize: function (form, json) {
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){
        var count = (this.json.groupCount) ? this.json.groupCount : 0;
        if( this.json.groupRange==="group" ){
            return {
                "count": count,
                "storeRange" : this.json.storeRange,
                "include": this.getSelectRange( true )
            }
        }else{
            return {
                "count": count,
                "storeRange" : this.json.storeRange
            }
        }
    },
    getSearchOptions : function(){
        return {};
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getSelectRange : function(){
        var rangeValues = [];
        if (this.json.groupRangeKey && this.json.groupRangeKey.code){
            var v = this.form.Macro.exec(this.json.groupRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            rangeValues = v;
            //v.each(function(d){
            //    if (d){
            //        if (typeOf(d)==="string"){
            //            var data;
            //            this.orgAction.getGroup(function(json){ data = json.data }.bind(this), null, d, false);
            //            rangeValues.push(data);
            //        }else{
            //            rangeValues.push(d);
            //        }
            //    }
            //}.bind(this));
        }
        return rangeValues;
    }
});

MWF.APPOrg.UnitOptions = new Class({
    Implements: [Events],
    initialize : function( form, json  ){
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){

        var count = (this.json.unitCount) ? this.json.unitCount : 0;
        var selectUnits = this.getSelectRange( true );

        return {
            "count": count,
            "units": selectUnits,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType,
            "storeRange" : this.json.storeRange,
            "expandSubEnable" : (this.json.unitExpandSubEnable=="no") ? false : true
        };
    },
    getSearchOptions : function(){
        var selectUnits = this.getSelectRange( true );
        return {
            "units": selectUnits,
            "unitType": (this.json.selectUnitType==="all") ? "" : this.json.selectUnitType
        };
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getSelectRange : function(){
        if (this.json.unitRange==="unit"){
            return this.getScriptSelectUnit();
        }
        if (this.json.unitRange==="draftUnit"){
            var dn = (this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn;
            if (!dn){
                if ( layout.session.user.identityList && layout.session.user.identityList.length){
                    var ids = [];
                    layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                    return this.getNextSelectUnit(ids);
                }else{
                    return [];
                }
            }else{
                return this.getNextSelectUnit((this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn);
            }
        }
        if (this.json.unitRange==="currentUnit"){
            if (this.form.app.currentTask){
                return this.getNextSelectUnit(this.form.app.currentTask.identityDn);
            }else{
                if (this.form.app.taskList && this.form.app.taskList.length){
                    var ids = [];
                    this.form.app.taskList.each(function(task){ ids.push(task.identity); });
                    return this.getNextSelectUnit(ids);
                }else{
                    if ( layout.session.user.identityList && layout.session.user.identityList.length){
                        var ids = [];
                        layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                        return this.getNextSelectUnit(ids);
                    }else{
                        return [];
                    }
                }
            }
        }
        return [];
    },
    getScriptSelectUnit: function(){
        var rangeValues = [];
        if (this.json.unitRangeUnit && this.json.unitRangeUnit.length){
            this.json.unitRangeUnit.each(function(unit){
                //var unitFlag = unit.distinguishedName || unit.id || unit.unique || unit.levelName;
                //if (unitFlag) rangeValues.push(unitFlag);
                rangeValues.push(unit);
            }.bind(this));
        }
        if (this.json.unitRangeField && this.json.unitRangeField.length){
            this.json.unitRangeField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d){
                        // if (typeOf(d)==="string"){
                        //     var data;
                        //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                        //     rangeValues.push(data);
                        // }else{
                            rangeValues.push(d);
                        // }
                    }
                }.bind(this));
            }.bind(this));
        }
        if (this.json.unitRangeKey && this.json.unitRangeKey.code){
            var v = this.form.Macro.exec(this.json.unitRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d){
                    // if (typeOf(d)==="string"){
                    //     var data;
                    //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                    //     rangeValues.push(data);
                    // }else{
                        rangeValues.push(d);
                    // }
                }
            }.bind(this));
        }
        return rangeValues;
    },
    getNextSelectUnit: function(id){
        var ids = typeOf(id)==="array" ? id : [id];
        var data;
        var units = [];
        ids.each( function(i){
            if (this.json.unitRangeNext === "direct"){
                this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
                if (data && data.woUnit) units.push(data.woUnit);
            }else if(this.json.unitRangeNext==="level"){
                this.orgAction.getUnitWithIdentityWithLevel(i, this.json.unitRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                if (data) units.push(data);
            }else if (this.json.unitRangeNext==="type"){
                if (this.json.unitRangeNextUnitType==="all"){
                    this.orgAction.getUnitWithIdentityWithLevel(i, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }else{
                    this.orgAction.getUnitWithIdentityWithType(i, this.json.unitRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }
                if (data) units.push(data);
            }
            data = null;
        }.bind(this));
        return units;
        //if (this.json.unitRangeNext === "direct"){
        //    if (typeOf(id)==="array"){
        //        var units = [];
        //        id.each(function(i){
        //            this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
        //            if (data && data.woUnit) units.push(data.woUnit);
        //            data = null;
        //        }.bind(this));
        //        return units;
        //    }else{
        //        this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, id, false);
        //        return (data.woUnit) ? [data.woUnit] : [];
        //    }
        //}
        //if (this.json.unitRangeNext==="level"){
        //    this.orgAction.getUnitWithIdentityWithLevel(id, this.json.unitRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    //this.json.rangeNextLevel
        //    return (data) ? [data] : [];
        //}
        //if (this.json.unitRangeNext==="type"){
        //    if (this.json.unitRangeNextUnitType==="all"){
        //        this.orgAction.getUnitWithIdentityWithLevel(id, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }else{
        //        this.orgAction.getUnitWithIdentityWithType(id, this.json.unitRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }
        //
        //    return (data) ? [data] : [];
        //}

    }
});

MWF.APPOrg.IdentityOptions = new Class({
    Implements: [Events],
    initialize : function( form, json  ){
        this.form = form;
        this.json = json;
        this.orgAction = MWF.Actions.get("x_organization_assemble_control");
    },
    getOptions: function(){
        var count = (this.json.identityCount) ? this.json.identityCount : 0;
        if( this.json.identityOnlyUseInclude ){
            return {
                "noUnit" : true,
                "count": count,
                "resultType" : this.json.identityResultType,
                "storeRange" : this.json.storeRange,
                "include" : this._getInclude()
            };
        }else{
            var selectUnits = this.getSelectRange( true );
            var selectDutys = this.getSelectRangeDuty( true );
            return {
                "count": count,
                "units": selectUnits,
                "dutys": selectDutys,
                "expandSubEnable" : (this.json.identityExpandSubEnable=="no") ? false : true,
                "resultType" : this.json.identityResultType,
                "categoryType": this.json.categoryType || "unit",
                "dutyUnitLevelBy" : this.json.dutyUnitLevelBy || "duty",
                "storeRange" : this.json.storeRange,
                "include" : this._getInclude()
            };
        }
    },
    getSearchOptions : function(){
        var selectUnits = this.getSelectRange( true );
        var selectDutys = this.getSelectRangeDuty( true );
        return {
            "units": selectUnits,
            "dutys": selectDutys,
            "resultType" : this.json.identityResultType
        };
    },
    getSelectRange : function( refresh ){
        if( !this.selectRange || refresh ){
            this.selectRange = this._getSelectRange();
        }
        return this.selectRange;
    },
    _getInclude : function(){
        var include = [];
        if( this.json.identityIncludeKey ){
            var v = this.form.Macro.exec(this.json.identityIncludeKey.code, this);
            if( v )include = typeOf(v)==="array" ? v : [v];
        }
        return include;
    },
    _getSelectRange : function(){
        if (this.json.identityRange==="unit"){
            return this.getScriptSelectUnit();
        }
        if (this.json.identityRange==="draftUnit"){
            var dn = (this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn;
            if (!dn){
                if ( layout.session.user.identityList && layout.session.user.identityList.length){
                    var ids = [];
                    layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                    return this.getNextSelectUnit(ids);
                }else{
                    return [];
                }
            }else{
                return this.getNextSelectUnit((this.form.businessData.work || this.form.businessData.workCompleted).creatorIdentityDn);
            }
        }
        if (this.json.identityRange==="currentUnit"){
            if (this.form.app.currentTask){
                return this.getNextSelectUnit(this.form.app.currentTask.identityDn);
            }else{
                if (this.form.app.taskList && this.form.app.taskList.length){
                    var ids = [];
                    this.form.app.taskList.each(function(task){ ids.push(task.identity); });
                    return this.getNextSelectUnit(ids);
                }else{
                    if ( layout.session.user.identityList && layout.session.user.identityList.length){
                        var ids = [];
                        layout.session.user.identityList.each(function(id){ ids.push(id.id); });
                        return this.getNextSelectUnit(ids);
                    }else{
                        return [];
                    }
                }
            }
        }
        return [];
    },
    getScriptSelectUnit: function(){
        var rangeValues = [];
        if (this.json.identityRangeUnit && this.json.identityRangeUnit.length){
            this.json.identityRangeUnit.each(function(unit){
                //var unitFlag = unit.distinguishedName || unit.id || unit.unique || unit.levelName ;
                //if (unitFlag) rangeValues.push(unitFlag);
                rangeValues.push(unit);
            }.bind(this));
        }
        if (this.json.identityRangeField && this.json.identityRangeField.length){
            this.json.identityRangeField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d){
                        // if (typeOf(d)==="string"){
                        //     var data;
                        //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                        //     rangeValues.push(data);
                        // }else{
                            rangeValues.push(d);
                        // }
                    }
                }.bind(this));
            }.bind(this));
        }
        if (this.json.identityRangeKey && this.json.identityRangeKey.code){
            var v = this.form.Macro.exec(this.json.identityRangeKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d){
                    // if (typeOf(d)==="string"){
                    //     var data;
                    //     this.orgAction.getUnit(function(json){ data = json.data }.bind(this), null, d, false);
                    //     rangeValues.push(data);
                    // }else{
                        rangeValues.push(d);
                    // }
                }
            }.bind(this));
        }
        return rangeValues;
    },
    getNextSelectUnit: function(id){
        var ids = typeOf(id)==="array" ? id : [id];
        var data;
        var units = [];
        ids.each(function(i){
            if (this.json.identityRangeNext === "direct"){
                this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
                if (data && data.woUnit) units.push(data.woUnit);
            }else if (this.json.identityRangeNext==="level"){
                this.orgAction.getUnitWithIdentityWithLevel(i, this.json.identityRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                if (data) units.push(data);
            }else if (this.json.identityRangeNext==="type"){
                if (this.json.identityRangeNextUnitType==="all"){
                    this.orgAction.getUnitWithIdentityWithLevel(i, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }else{
                    this.orgAction.getUnitWithIdentityWithType(i, this.json.identityRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
                }
                if (data) units.push(data);
            }
            data = null;
        }.bind(this));
        return units;

        //if (this.json.identityRangeNext === "direct"){
        //if (typeOf(id)==="array"){
        //    var units = [];
        //    id.each(function(i){
        //        this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, i, false);
        //        if (data && data.woUnit) units.push(data.woUnit);
        //        data = null;
        //    }.bind(this));
        //    return units;
        //}else{
        //    this.orgAction.getIdentity(function(json){ data = json.data }.bind(this), function(){data={"woUnit": null}}, id, false);
        //    return (data.woUnit) ? [data.woUnit] : [];
        //}
        //}
        //if (this.json.identityRangeNext==="level"){
        //    this.orgAction.getUnitWithIdentityWithLevel(id, this.json.identityRangeNextLevel, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    return (data) ? [data] : [];
        //    //this.json.rangeNextLevel
        //}
        //if (this.json.identityRangeNext==="type"){
        //    if (this.json.identityRangeNextUnitType==="all"){
        //        this.orgAction.getUnitWithIdentityWithLevel(id, 1, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }else{
        //        this.orgAction.getUnitWithIdentityWithType(id, this.json.identityRangeNextUnitType, function(json){ data = json.data }.bind(this), function(){data=null;}, false);
        //    }
        //    return (data) ? [data] : [];
        //}

    },

    getSelectRangeDuty: function( refresh ){
        if( !this.selectRangeDuty || refresh ){
            this.selectRangeDuty = this._getSelectRangeDuty();
        }
        return this.selectRangeDuty;
    },
    _getSelectRangeDuty: function(){
        if (this.json.dutyRange==="duty"){
            return this.getScriptSelectDuty();
        }
        return [];
    },
    getScriptSelectDuty: function(){
        var rangeValues = [];
        if( this.json.rangeDuty && this.json.rangeDuty.length ){
            var rangeDuty = this.json.rangeDuty;
            if( typeOf(rangeDuty) === "string" ){
                rangeDuty = JSON.parse( rangeDuty );
            }
            if( typeOf(rangeDuty) === "array" ){
                rangeDuty.each(function(unit){
                    var unitFlag = typeOf(unit) === "string" ? unit : (unit.id || unit.name);
                    if (unitFlag) rangeValues.push(unitFlag);
                }.bind(this));
            }
        }
        //if (this.json.rangeDuty && this.json.rangeDuty.length){
        //    this.json.rangeDuty.each(function(unit){
        //        var unitFlag = unit.id || unit.name;
        //        if (unitFlag) rangeValues.push(unitFlag);
        //    }.bind(this));
        //}
        if (this.json.rangeDutyField && this.json.rangeDutyField.length){
            this.json.rangeDutyField.each(function(field){
                var n = (typeOf(field)=="object") ? field.name : field;
                var v = this.form.businessData.data[n];
                if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
                v.each(function(d){
                    if (d) rangeValues.push(d);
                }.bind(this));
            }.bind(this));
        }
        if (this.json.rangeDutyKey && this.json.rangeDutyKey.code){
            var v = this.form.Macro.exec(this.json.rangeDutyKey.code, this);
            if (typeOf(v)!=="array") v = (v) ? [v.toString()] : [];
            v.each(function(d){
                if (d) rangeValues.push(d);
            }.bind(this));
        }
        return rangeValues;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
//MWF.require("MWF.widget.Tree", null, false);
//MWF.require("MWF.widget.Toolbar", null, false);

/** @class Actionbar 操作条组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var actionbar = this.form.get("name"); //获取操作条
 * //方法2
 * var actionbar = this.target; //在操作条和操作本身的事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Actionbar = MWF.APPActionbar =  new Class(
    /** @lends MWF.xApplication.process.Xform.Actionbar# */
    {
        Extends: MWF.APP$Module,
        options: {
            /**
             * 组件加载前触发。
             * @event MWF.xApplication.process.Xform.Actionbar#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载时触发。
             * @event MWF.xApplication.process.Xform.Actionbar#load
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件.由于加载过程中有异步处理，这个时候操作条有可能还未生成。
             * @event MWF.xApplication.process.Xform.Actionbar#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            /**
             * 组件加载后事件。这个时候操作条已生成
             * @event MWF.xApplication.process.Xform.Actionbar#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "moduleEvents": ["load", "queryLoad", "postLoad", "afterLoad"]
        },
        /**
         * @summary 重新加载操作条.
         * @example
         * this.form.get("name").reload(); //显示操作条
         */
        reload : function(){
            this._loadUserInterface();
        },
        _loadUserInterface: function(){
            // if (this.form.json.mode == "Mobile"){
            //     this.node.empty();
            // }else if (COMMON.Browser.Platform.isMobile){
            //     this.node.empty();
            // }else{
            this.toolbarNode = this.node.getFirst("div");
            if(!this.toolbarNode)return;

            this.toolbarNode.empty();

            MWF.require("MWF.widget.Toolbar", function(){
                /**
                 * @summary Toolbar组件，平台使用该组件生成操作条。
                 * @member {o2.widget.Toolbar}
                 * @example
                 *  //可以在脚本中获取该组件
                 * var toolbarWidget = this.form.get("fieldId").toolbarWidget; //获取组件对象
                 */
                this.toolbarWidget = new MWF.widget.Toolbar(this.toolbarNode, {
                    "style": this.json.style,
                    "onPostLoad" : function(){
                        this.fireEvent("afterLoad");
                    }.bind(this)
                }, this);
                if (this.json.actionStyles) this.toolbarWidget.css = this.json.actionStyles;
                //alert(this.readonly)

                if( this.json.multiTools ){ //自定义操作和系统操作混合的情况，用 system : true 来区分系统和自定义
                    var addReadActionFlag = !this.json.hideSystemTools && !this.json.hideReadedAction; //是否需要增加已阅
                    var jsonStr = JSON.stringify(this.json.multiTools);
                    jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.process.Xform.LP.form});
                    this.json.multiTools = JSON.parse(jsonStr);
                    this.json.multiTools.each( function (tool) {
                        if( tool.system ){
                            if( !this.json.hideSystemTools ){
                                if( tool.id === "action_readed" )addReadActionFlag = false;
                                this.setToolbars([tool], this.toolbarNode, this.readonly);
                            }
                        }else{
                            this.setCustomToolbars([tool], this.toolbarNode);
                        }
                    }.bind(this));
                    if( addReadActionFlag ){
                        var addActions = [
                            {
                                "type": "MWFToolBarButton",
                                "img": "read.png",
                                "title": MWF.xApplication.process.Xform.LP.setReaded,
                                "action": "readedWork",
                                "text": MWF.xApplication.process.Xform.LP.readed,
                                "id": "action_readed",
                                "control": "allowReadProcessing",
                                "condition": "",
                                "read": true
                            }
                        ];
                        this.setToolbars(addActions, this.toolbarNode, this.readonly);
                    }
                    this.toolbarWidget.load();
                }else{
                    if (this.json.hideSystemTools){
                        this.setCustomToolbars(this.json.tools, this.toolbarNode);
                        this.toolbarWidget.load();
                    }else{
                        if (this.json.defaultTools){
                            var addActions = [
                                {
                                    "type": "MWFToolBarButton",
                                    "img": "read.png",
                                    "title": MWF.xApplication.process.Xform.LP.setReaded,
                                    "action": "readedWork",
                                    "text": MWF.xApplication.process.Xform.LP.readed,
                                    "id": "action_readed",
                                    "control": "allowReadProcessing",
                                    "condition": "",
                                    "read": true
                                }
                            ];
                            //this.form.businessData.control.allowReflow =

                            //this.json.defaultTools.push(o);
                            this.setToolbars(this.json.defaultTools, this.toolbarNode, this.readonly);
                            if( !this.json.hideReadedAction ){
                                this.setToolbars(addActions, this.toolbarNode, this.readonly);
                            }

                            this.setCustomToolbars(this.json.tools, this.toolbarNode);
                            this.toolbarWidget.load();
                        }else{
                            MWF.getJSON(this.form.path+"toolbars.json", function(json){
                                this.setToolbars(json, this.toolbarNode, this.readonly, true);
                                this.setCustomToolbars(this.json.tools, this.toolbarNode);
                                this.toolbarWidget.load();
                            }.bind(this), null);
                        }
                    }
                }
            }.bind(this));
            // }
        },

        setCustomToolbars: function(tools, node){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            var iconPath = "";
            if( this.json.customIconStyle ){
                iconPath = this.json.customIconStyle+"/";
            }
            tools.each(function(tool){
                var flag = true;
                if (this.readonly){
                    flag = tool.readShow;
                }else{
                    flag = tool.editShow;
                }
                if (flag){
                    flag = true;
                    if (tool.control){
                        flag = this.form.businessData.control[tool.control]
                    }
                    if (tool.condition){
                        var hideFlag = this.form.Macro.exec(tool.condition, this);
                        flag = !hideFlag;
                    }
                    if (flag){
                        var actionNode = new Element("div", {
                            "id": tool.id,
                            "MWFnodetype": tool.type,
                            "MWFButtonImage": path+""+this.form.options.style+"/custom/"+iconPath+tool.img,
                            "title": tool.title,
                            "MWFButtonAction": "runCustomAction",
                            "MWFButtonText": tool.text
                        }).inject(node);
                        if( this.json.customIconOverStyle ){
                            actionNode.set("MWFButtonImageOver" , path+""+this.form.options.style +"/custom/"+this.json.customIconOverStyle+ "/" +tool.img );
                        }
                        if( tool.properties ){
                            actionNode.set(tool.properties);
                        }
                        if (tool.actionScript){
                            actionNode.store("script", tool.actionScript);
                        }
                        if (tool.sub){
                            var subNode = node.getLast();
                            this.setCustomToolbars(tool.sub, subNode);
                        }
                    }
                }
            }.bind(this));
        },

        setToolbarItem: function(tool, node, readonly, noCondition){
            var path = "../x_component_process_FormDesigner/Module/Actionbar/";
            var flag = true;
            if (tool.control){
                flag = this.form.businessData.control[tool.control]
            }
            if (!noCondition) if (tool.condition){
                var hideFlag = this.form.Macro.exec(tool.condition, this);
                flag = flag && (!hideFlag);
            }
            // if (tool.id == "action_processWork"){
            //     if (!this.form.businessData.task){
            //         flag = false;
            //     }
            // }
            if (tool.id == "action_downloadAll" || tool.id == "action_print"){
                if (!this.form.businessData.work.startTime){
                    flag = false;
                }
            }
            if (tool.id == "action_delete"){
                if (!this.form.businessData.work || !this.form.businessData.work.id){
                    flag = false;
                }
            }


            if (tool.id == "action_rollback") tool.read = true;
            if (readonly) if (!tool.read) flag = false;
            if (flag){
                var actionNode = new Element("div", {
                    "id": tool.id,
                    "MWFnodetype": tool.type,
                    //"MWFButtonImage": this.form.path+""+this.form.options.style+"/actionbar/"+tool.img,
                    "MWFButtonImage": path+(this.options.style||"default") +"/tools/"+ (this.json.style || "default") +"/"+tool.img,
                    "title": tool.title,
                    "MWFButtonAction": tool.action,
                    "MWFButtonText": tool.text
                }).inject(node);
                if( this.json.iconOverStyle ){
                    actionNode.set("MWFButtonImageOver" , path+""+(this.options.style||"default")+"/tools/"+( this.json.iconOverStyle || "default" )+"/"+tool.img );
                }
                if( tool.properties ){
                    actionNode.set(tool.properties);
                }
                if (tool.sub){
                    var subNode = node.getLast();
                    this.setToolbars(tool.sub, subNode, readonly, noCondition);
                }
            }
        },
        /**
         * @summary 根据操作id获取操作，该方法在操作条的afterLoad事件中有效，操作的操作脚本有效。
         *  @param {String} id - 必选，操作id.
         *  @return {o2.widget.ToolbarButton} 操作
         *  @example
         *  var actionbar = this.form.get("name"); //获取操作条
         *  var item = actionbar.getItem( "action_delete" ); //获取删除操作
         *  item.node.hide(); //隐藏删除操作的节点
         *  item.node.click(); //触发操作的click事件
         */
        getItem : function( id ){
            if( this.toolbarWidget && id ){
                return this.toolbarWidget.items[id]
            }
        },
        /**
         * @summary 获取所有操作，该方法在操作条的afterLoad事件中有效，操作的操作脚本有效。
         *  @return {Array} 操作数组
         *  @example
         *  var actionbar = this.form.get("name"); //获取操作条
         *  var itemList = actionbar.getAllItem(); //获取操作数组
         *  itemList[1].node.hide(); //隐藏第一个操作
         */
        getAllItem : function(){
            return this.toolbarWidget ? this.toolbarWidget.childrenButton : [];
        },
        setToolbars: function(tools, node, readonly, noCondition){
            tools.each(function(tool){
                this.setToolbarItem(tool, node, readonly, noCondition);
            }.bind(this));
        },
        runCustomAction: function(bt){
            var script = bt.node.retrieve("script");
            this.form.Macro.exec(script, this);
        },
        saveWork: function(){
            debugger;
            this.form.saveWork();
        },
        closeWork: function(){
            this.form.closeWork();
        },
        processWork: function(){
            this.form.processWork();
        },
        resetWork: function(){
            this.form.resetWork();
        },
        retractWork: function(e, ev){
            this.form.retractWork(e, ev);
        },
        rerouteWork: function(e, ev){
            this.form.rerouteWork(e, ev);
        },
        deleteWork: function(){
            this.form.deleteWork();
        },
        printWork: function(){
            this.form.printWork();
        },
        readedWork: function(b,e){
            this.form.readedWork(e);
        },
        addSplit: function(e){
            this.form.addSplit(e);
        },
        rollback: function(e){
            this.form.rollback(e);
        },
        downloadAll: function(e){
            this.form.downloadAll(e);
        },
        pressWork: function(e){
            this.form.pressWork(e);
        },
        pauseTask: function(e){
            var p = this.form.pauseTask(e);
            if (p){
                p.then(function(){
                    e.setText(MWF.xApplication.process.Xform.LP.resume);
                    e.options.action = "resumeTask";

                    var img = e.picNode.getElement("img");
                    var src = img.get("src");
                    src = src.substr(0, src.lastIndexOf("/"));
                    src = src+"/resume.png";
                    img.set("src", src);

                }.bind(this), function(){});
            }
        },
        resumeTask: function(e){
            var p = this.form.resumeTask(e);
            if (p){
                p.then(function(){
                    e.setText( MWF.xApplication.process.Xform.LP.pause);
                    e.options.action = "pauseTask";

                    var img = e.picNode.getElement("img");
                    var src = img.get("src");
                    src = src.substr(0, src.lastIndexOf("/"));
                    src = src+"/pause.png";
                    img.set("src", src);

                }.bind(this), function(){});
            }
        }

    });

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.require("MWF.widget.AttachmentController", null, false);
MWF.xApplication.process.Xform.AttachmentController = new Class({
    Extends: MWF.widget.ATTER,
    "options": {
        "officeFiles": ["doc", "docx", "dotx", "dot", "xls", "xlsx", "xlsm", "xlt", "xltx", "pptx", "ppt", "pot", "potx", "potm", "pdf"],
        "allowPreviewExtension" : ["zip","pdf", "ofd", "png", "jpg", "bmp", "jpeg", "gif", "js", "css", "java", "json", "xml", "php", "html", "htm", "xhtml", "log", "md", "txt"],
        "checkTextEnable": true
    },
    checkAttachmentDeleteAction: function () {
        if (this.options.readonly) {
            this.setAttachmentsAction("delete", false);
            return false;
        }
        if (this.options.isDeleteOption !== "n") {
            if (this.attachments.length) {
                var user = layout.session.user.distinguishedName;

                for (var i = 0; i < this.attachments.length; i++) {
                    var flag = true;
                    var att = this.attachments[i];
                    if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                    if (this.options.isDeleteOption === "o") {

                        if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
                        if (att.data.person !== layout.desktop.session.user.distinguishedName) flag = false;

                    } else if (this.options.isDeleteOption === "a") {

                        if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
                        if (att.data.activity !== this.module.form.businessData.activity.id) flag = false;

                    } else if (this.options.isDeleteOption === "ao") {

                        if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
                        if ((att.data.activity !== this.module.form.businessData.activity.id) || (att.data.person !== layout.desktop.session.user.distinguishedName)) flag = false;

                    } else {
                        if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
                    }

                    if (flag) {
                        this.setAttachmentAction(att, "delete", true);
                    } else {
                        this.setAttachmentAction(att, "delete", false);
                    }
                }
            }

        } else {
            this.setAttachmentsAction("delete", false);
        }
    },
    checkDeleteAction: function () {

        this.checkAttachmentDeleteAction();

        if (this.options.readonly) {
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
            return false;
        }
        if (this.options.isDeleteOption !== "n") {
            if (this.selectedAttachments.length) {
                var user = layout.session.user.distinguishedName;
                var flag = true;
                if (this.options.isDeleteOption === "o") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if (att.data.person !== layout.desktop.session.user.distinguishedName) {
                            flag = false;
                            break;
                        }
                    }
                } else if (this.options.isDeleteOption === "a") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if (att.data.activity !== this.module.form.businessData.activity.id) {
                            flag = false;
                            break;
                        }
                    }
                } else if (this.options.isDeleteOption === "ao") {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                        if ((att.data.activity !== this.module.form.businessData.activity.id) || (att.data.person !== layout.desktop.session.user.distinguishedName)) {
                            flag = false;
                            break;
                        }
                    }
                } else {
                    for (var i = 0; i < this.selectedAttachments.length; i++) {
                        var att = this.selectedAttachments[i];
                        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                        if (!att.data.control.allowEdit && att.data.person !== user) {
                            flag = false;
                            break;
                        }
                    }
                }

                if (flag) {
                    this.setActionEnabled(this.deleteAction);
                    this.setActionEnabled(this.min_deleteAction);
                } else {
                    this.setActionDisabled(this.deleteAction);
                    this.setActionDisabled(this.min_deleteAction);
                }
            } else {
                this.setActionDisabled(this.deleteAction);
                this.setActionDisabled(this.min_deleteAction);
            }
        } else {
            // if (!this.options.isDelete){
            this.setActionDisabled(this.deleteAction);
            this.setActionDisabled(this.min_deleteAction);
            // }else{
            //     if (this.selectedAttachments.length){
            //         this.setActionEnabled(this.deleteAction);
            //         this.setActionEnabled(this.min_deleteAction);
            //     }else{
            //         this.setActionDisabled(this.deleteAction);
            //         this.setActionDisabled(this.min_deleteAction);
            //     }
            // }
        }
    },
    checkPreviewAttAction: function () {
        if (!this.options.isPreviewAtt){
            this.setActionDisabled(this.previewAttAction);
            //this.setActionDisabled(this.min_downloadAction);
        }else{
            if (this.selectedAttachments.length){
                var flag = false;
                for (var i = 0; i < this.selectedAttachments.length; i++) {
                    var att = this.selectedAttachments[i];
                    if (this.options.allowPreviewExtension.contains(att.data.extension)) {
                        flag = true;
                        break;
                    }
                }
                if(flag){
                    this.setActionEnabled(this.previewAttAction);
                    //this.setActionEnabled(this.min_downloadAction);
                }

            }else{
                this.setActionDisabled(this.previewAttAction);
                //this.setActionDisabled(this.min_downloadAction);
            }
        }
    },
    isAttDeleteAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("edit")) return false;
        if (this.options.isDeleteOption === "n") return false;

        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (this.options.isDeleteOption === "o") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if (att.data.person !== layout.desktop.session.user.distinguishedName) flag = false;

        } else if (this.options.isDeleteOption === "a") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if (att.data.activity !== this.module.form.businessData.activity.id) flag = false;

        } else if (this.options.isDeleteOption === "ao") {

            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
            if ((att.data.activity !== this.module.form.businessData.activity.id) || (att.data.person !== layout.desktop.session.user.distinguishedName)) flag = false;

        } else {
            if (!att.data.control.allowEdit && att.data.person !== user) flag = false;
        }

        return flag;
    },
    openInOfficeControl: function (att, office) {
        if (office) {
            if (!office.openedAttachment || office.openedAttachment.id !== att.id) {
                office.save();
                if (this.module.form.businessData.workCompleted) {
                    MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentWorkcompletedUrl(att.id, this.module.form.businessData.workCompleted.id, function (url) {
                        office.openedAttachment = { "id": att.id, "site": this.module.json.name, "name": att.name };
                        office.officeOCX.BeginOpenFromURL(url, true, this.readonly);
                    }.bind(this));
                } else {
                    MWF.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(att.id, this.module.form.businessData.work.id, function (url) {
                        office.openedAttachment = { "id": att.id, "site": this.module.json.name, "name": att.name };
                        office.officeOCX.BeginOpenFromURL(url, true, this.readonly);
                    }.bind(this));
                }
            }
        }
    },

    checkReplaceAction: function () {
        if (this.options.isReplaceHidden) return;
        if (this.options.readonly) {
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
            return false;
        }

        if (this.options.isReplaceOption !== "n") {
            if (this.selectedAttachments.length && this.selectedAttachments.length === 1) {

                var att = this.selectedAttachments[0];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

                var user = layout.session.user.distinguishedName;
                var flag = true;

                if (this.options.isReplaceOption === "o") {
                    flag = att.data.person === layout.desktop.session.user.distinguishedName;
                }
                if (this.options.isReplaceOption === "a") {
                    flag = att.data.activity === this.module.form.businessData.activity.id;
                }
                if (this.options.isReplaceOption === "ao") {
                    flag = (att.data.person === layout.desktop.session.user.distinguishedName && att.data.activity === this.module.form.businessData.activity.id);
                }
                if (flag && !att.data.control.allowEdit && att.data.person !== user) {
                    flag = false;
                }

                if (flag) {
                    this.setActionEnabled(this.replaceAction);
                    this.setActionEnabled(this.min_replaceAction);
                } else {
                    this.setActionDisabled(this.replaceAction);
                    this.setActionDisabled(this.min_replaceAction);
                }
            } else {
                this.setActionDisabled(this.replaceAction);
                this.setActionDisabled(this.min_replaceAction);
            }
        } else {
            // if (!this.options.isReplace){
            this.setActionDisabled(this.replaceAction);
            this.setActionDisabled(this.min_replaceAction);
            // }else{
            //     if (this.selectedAttachments.length && this.selectedAttachments.length===1){
            //         this.setActionEnabled(this.replaceAction);
            //         this.setActionEnabled(this.min_replaceAction);
            //     }else{
            //         this.setActionDisabled(this.replaceAction);
            //         this.setActionDisabled(this.min_replaceAction);
            //     }
            // }
        }
    },
    replaceAttachment: function (e, node) {
        var att = this.selectedAttachments[0].data;

        if (this.module.json.isOpenInOffice && this.module.json.officeControlName && (this.options.officeFiles.indexOf(att.extension) !== -1)) {
            var office = this.module.form.all[this.module.json.officeControlName];
            if (office) {
                if (this.min_closeOfficeAction) this.setActionEnabled(this.min_closeOfficeAction);
                if (this.closeOfficeAction) this.setActionEnabled(this.closeOfficeAction);
                this.openInOfficeControl(att, office);
            } else {
                if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
                    if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
                }
            }
        } else {
            if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
                if (this.module) this.module.replaceAttachment(e, node, this.selectedAttachments[0]);
            }
        }
    },
    isAttReplaceAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("edit")) return false;

        if (this.options.isReplaceOption === "n") return false;

        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (this.options.isReplaceOption === "o") {
            flag = att.data.person === layout.desktop.session.user.distinguishedName;
        }
        if (this.options.isReplaceOption === "a") {
            flag = att.data.activity === this.module.form.businessData.activity.id;
        }
        if (this.options.isReplaceOption === "ao") {
            flag = (att.data.person === layout.desktop.session.user.distinguishedName && att.data.activity === this.module.form.businessData.activity.id);
        }
        if (flag && !att.data.control.allowEdit && att.data.person !== user) {
            flag = false;
        }

        return flag;
    },


    //checkAttachmentOrderAction : function(){
    //    if (this.options.readonly){
    //        this.setAttachmentsAction("order", false );
    //        return false;
    //    }
    //    if (this.attachments.length){
    //        var user = layout.session.user.distinguishedName;
    //        for (var i=0; i<this.attachments.length; i++){
    //            var flag = true;
    //
    //            var att = this.attachments[i];
    //            if( !att.data.person && att.data.creatorUid )att.data.person = att.data.creatorUid;
    //
    //            if ((!att.data.control.allowControl || !att.data.control.allowEdit) && att.data.person!==user){
    //                flag = false;
    //            }
    //            if (flag){
    //                this.setAttachmentAction(att, "order", true );
    //            }else{
    //                this.setAttachmentAction(att, "order", false );
    //            }
    //        }
    //    }
    //},
    checkOrderAction: function () {
        //this.checkAttachmentOrderAction();
        if (this.options.readonly) {
            this.setActionDisabled(this.orderAction);
            this.setActionDisabled(this.min_orderAction);
            return false;
        }
        if (this.attachments.length && this.attachments.length > 1) {
            var flag = true;
            var user = layout.session.user.distinguishedName;
            for (var i = 0; i < this.attachments.length; i++) {
                var att = this.attachments[i];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                if ((!att.data.control.allowControl && !att.data.control.allowEdit) && att.data.person !== user) { //|| !att.data.control.allowEdit
                    flag = false;
                    break;
                }
            }
            if (flag) {
                this.setActionEnabled(this.orderAction);
                this.setActionEnabled(this.min_orderAction);
            } else {
                this.setActionDisabled(this.orderAction);
                this.setActionDisabled(this.min_orderAction);
            }
            //this.setActionEnabled(this.min_deleteAction);
        } else {
            this.setActionDisabled(this.orderAction);
            this.setActionDisabled(this.min_orderAction);
            //this.setActionDisabled(this.min_deleteAction);
        }
    },
    isAttOrderAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("config")) return false;
        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if ((!att.data.control.allowControl || !att.data.control.allowEdit) && att.data.person !== user) {
            flag = false;
        }
        return flag;
    },

    createTopNode: function () {
        if (this.options.title) {
            if (!this.titleNode) this.titleNode = new Element("div", { "styles": this.css.titleNode, "text": this.options.title }).inject(this.node);
        }
        if (!this.topNode) {
            this.topNode = new Element("div", { "styles": this.css.topNode }).inject(this.node);
        } else {
            this.topNode.empty();
            this.editActionBoxNode = null;
            this.editActionsGroupNode = null;
            this.topNode.setStyle("display", "");
            if (this.isHiddenTop) {
                //this.container.setStyle("height", this.container.getSize().y + 45 );
                //this.node.setStyle("height", this.node.getSize().y + 45 );
                if (this.oldContentScrollNodeHeight && this.contentScrollNode) {
                    this.contentScrollNode.setStyle("min-height", this.oldContentScrollNodeHeight);
                    this.oldContentScrollNodeHeight = null;
                }
                this.isHiddenTop = false;
            }
        }
        var hiddenGroup = this.options.toolbarGroupHidden;
        if (hiddenGroup.contains("edit") && hiddenGroup.contains("read") && hiddenGroup.contains("list") &&
            hiddenGroup.contains("view") && hiddenGroup.contains("config") &&
            !(this.module.json.isOpenInOffice && this.module.json.officeControlName)
        ) {
            if (this.contentScrollNode) {
                this.oldContentScrollNodeHeight = this.contentScrollNode.getStyle("min-height");
                this.contentScrollNode.setStyle("min-height", this.node.getStyle("min-height"));
                this.topNode.setStyle("display", "none");
            }
            this.isHiddenTop = true;
        }
        if (!hiddenGroup.contains("edit")) this.createEditGroupActions();
        if (!hiddenGroup.contains("read")) this.createReadGroupActions();
        if (!hiddenGroup.contains("list")) this.createListGroupActions();
        if (this.module.json.isOpenInOffice && this.module.json.officeControlName) this.createOfficeGroupActions();

        if (!hiddenGroup.contains("config")) this.createConfigGroupActions();

        if (!hiddenGroup.contains("view")) this.createViewGroupActions();
        this.checkActions();
    },
    checkActions: function () {
        //    if (this.options.readonly){
        //        this.setReadonly();
        //    }else{
        this.checkUploadAction();
        this.checkDeleteAction();
        this.checkReplaceAction();
        this.checkPreviewAttAction();
        //this.checkOfficeAction();
        this.checkDownloadAction();
        this.checkSizeAction();

        this.checkConfigAction();
        this.checkOrderAction();

        this.checkListStyleAction();
        //    }
    },

    checkAttachmentConfigAction: function () {
        if (this.options.readonly) {
            this.setAttachmentsAction("config", false);
            return false;
        }
        if (this.attachments.length) {
            var user = layout.session.user.distinguishedName;
            for (var i = 0; i < this.attachments.length; i++) {
                var flag = true;

                var att = this.attachments[i];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

                if ((!att.data.control.allowControl) && att.data.person !== user) { // || !att.data.control.allowEdit
                    flag = false;
                }
                if (flag) {
                    this.setAttachmentAction(att, "config", true);
                } else {
                    this.setAttachmentAction(att, "config", false);
                }
            }
        }
    },
    checkConfigAction: function () {
        this.checkAttachmentConfigAction();
        if (this.options.readonly) {
            this.setActionDisabled(this.configAction);
            if (this.checkTextAction) this.setActionDisabled(this.checkTextAction);
            return false;
        }
        if (this.selectedAttachments.length) {
            var flag = true;
            var user = layout.session.user.distinguishedName;
            for (var i = 0; i < this.selectedAttachments.length; i++) {
                var att = this.selectedAttachments[i];
                if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;
                if ((!att.data.control.allowControl) && att.data.person !== user) { //|| !att.data.control.allowEdit
                    flag = false;
                    break;
                }
            }
            if (flag) {
                this.setActionEnabled(this.configAction);
            } else {
                this.setActionDisabled(this.configAction);
            }
            //this.setActionEnabled(this.min_deleteAction);
        } else {
            this.setActionDisabled(this.configAction);
            //this.setActionDisabled(this.min_deleteAction);
        }

        if (this.checkTextAction) {
            this.setActionDisabled(this.checkTextAction);
            if (this.selectedAttachments.length && this.selectedAttachments.length === 1) {
                var att = this.selectedAttachments[0];
                if (this.options.images.indexOf(att.data.extension.toLowerCase()) !== -1) {
                    this.setActionEnabled(this.checkTextAction);
                }
            }
        }
    },
    isAttConfigAvailable: function (att) {
        if (this.options.readonly) return false;
        if (this.options.toolbarGroupHidden.contains("config")) return false;
        var user = layout.session.user.distinguishedName;
        var flag = true;

        if (!att.data.person && att.data.creatorUid) att.data.person = att.data.creatorUid;

        if (!att.data.control.allowControl && att.data.person !== user) {
            flag = false;
        }
        return flag;
    },

    createEditGroupActions: function () {
        if (!this.editActionBoxNode) this.editActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        if (!this.editActionsGroupNode) this.editActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.editActionBoxNode);
        this.uploadAction = this.createAction(this.editActionsGroupNode, "upload", o2.LP.widget.upload, function (e, node) {
            this.uploadAttachment(e, node);
        }.bind(this));

        this.deleteAction = this.createAction(this.editActionsGroupNode, "delete", o2.LP.widget["delete"], function (e, node) {
            this.deleteAttachment(e, node);
        }.bind(this));
        this.previewAttAction = this.createAction(this.editActionsGroupNode, "previewAtt", o2.LP.widget["previewAtt"], function (e, node) {
            this.previewAttachment(e, node);
        }.bind(this));
        if (!this.options.isReplaceHidden) {
            this.replaceAction = this.createAction(this.editActionsGroupNode, "replace", o2.LP.widget.replace, function (e, node) {
                this.replaceAttachment(e, node);
            }.bind(this));
        }

        // this.officeAction = this.createAction(this.editActionsGroupNode, "office", o2.LP.widget.office, function(e, node){
        //     this.openInOfficeControl(e, node);
        // }.bind(this));

        if (!this.options.toolbarGroupHidden.contains("read")) this.editActionSeparateNode = this.createSeparate(this.editActionsGroupNode);
    },

    createConfigGroupActions: function () {
        this.configActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        this.configActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.configActionBoxNode);

        this.configAction = this.createAction(this.configActionsGroupNode, "config", MWF.LP.widget.configAttachment, function (e, node) {
            this.configAttachment(e, node);
        }.bind(this));

        if (this.options.checkTextEnable) {
            this.checkTextAction = this.createAction(this.configActionsGroupNode, "check", MWF.LP.widget.checkOcrText, function (e, node) {
                this.checkImageTex(e, node);
            }.bind(this));
        }
        this.createSeparate(this.configActionsGroupNode);

        this.orderAction = this.createAction(this.configActionsGroupNode, "order", MWF.LP.widget.order, function (e, node) {
            this.orderAttachment(e, node);
        }.bind(this));

        if (this.configAction) this.setActionDisabled(this.configAction);
        if (this.checkTextAction) this.setActionDisabled(this.checkTextAction);
    },

    createOfficeGroupActions: function () {
        this.officeActionBoxNode = new Element("div", { "styles": this.css.actionsBoxNode }).inject(this.topNode);
        this.officeActionsGroupNode = new Element("div", { "styles": this.css.actionsGroupNode }).inject(this.officeActionBoxNode);

        this.closeOfficeAction = this.createAction(this.officeActionsGroupNode, "closeOffice", MWF.LP.widget.closeOffice, function (e, node) {
            this.closeAttachmentOffice(e, node);
        }.bind(this));
        if (this.closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
    },
    loadMinActions: function () {
        var hiddenGroup = this.options.toolbarGroupHidden;
        if (!hiddenGroup.contains("edit")) {
            this.min_uploadAction = this.createAction(this.minActionAreaNode, "upload", MWF.LP.widget.upload, function (e, node) {
                this.uploadAttachment(e, node);
            }.bind(this));

            this.min_deleteAction = this.createAction(this.minActionAreaNode, "delete", MWF.LP.widget["delete"], function (e, node) {
                this.deleteAttachment(e, node);
            }.bind(this));

            if (!this.options.isReplaceHidden) {
                this.min_replaceAction = this.createAction(this.minActionAreaNode, "replace", MWF.LP.widget.replace, function (e, node) {
                    this.replaceAttachment(e, node);
                }.bind(this));
            }
        }
        if (!hiddenGroup.contains("read")) {
            this.min_downloadAction = this.createAction(this.minActionAreaNode, "download", MWF.LP.widget.download
                , function (e, node) {
                    this.downloadAttachment(e, node);
                }.bind(this));
        }
        if (!hiddenGroup.contains("config")) {
            this.min_orderAction = this.createAction(this.minActionAreaNode, "order", MWF.LP.widget.order, function (e, node) {
                this.orderAttachment(e, node);
            }.bind(this));
        }

        if (this.module.json.isOpenInOffice && this.module.json.officeControlName) {
            this.min_closeOfficeAction = this.createAction(this.minActionAreaNode, "closeOffice", MWF.LP.widget.closeOffice, function (e, node) {
                this.closeAttachmentOffice(e, node);
            }.bind(this));
            if (this.min_closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
        }


        if (!hiddenGroup.contains("edit") || !hiddenGroup.contains("read")) {
            this.createSeparate(this.minActionAreaNode);
        }

        //this.createSeparate(this.configActionsGroupNode);

        if (this.options.isSizeChange) {
            //this.createSeparate(this.minActionAreaNode);
            if (!hiddenGroup.contains("view")) {
                this.sizeAction = this.createAction(this.minActionAreaNode, "max", MWF.LP.widget.min, function () {
                    this.changeControllerSize();
                }.bind(this));
            }
        }
    },
    closeAttachmentOffice: function () {
        var office = this.module.form.all[this.module.json.officeControlName];
        if (office) {
            office.openFile();
            if (this.min_closeOfficeAction) this.setActionDisabled(this.min_closeOfficeAction);
            if (this.closeOfficeAction) this.setActionDisabled(this.closeOfficeAction);
        }
    },
    configAttachment: function () {
        //this.fireEvent("delete", [attachment.data]);

        var lp = MWF.xApplication.process.Xform.LP;
        var css = this.module.form.css;
        var node = new Element("div", { "styles": css.attachmentPermissionNode }).inject(this.node);
        var attNames = new Element("div", { "styles": css.attachmentPermissionNamesNode }).inject(node);
        var attNamesTitle = new Element("div", { "styles": css.attachmentPermissionNamesTitleNode, "text": lp.attachmentPermissionInfo }).inject(attNames);
        var attNamesArea = new Element("div", { "styles": css.attachmentPermissionNamesAreaNode }).inject(attNames);

        if (this.selectedAttachments.length) {
            this.selectedAttachments.each(function (att) {
                var attNode = new Element("div", { "styles": css.attachmentPermissionAttNode, "text": att.data.name }).inject(attNamesArea);
            }.bind(this));
        }

        var editArea = new Element("div", { "styles": css.attachmentPermissionEditAreaNode }).inject(node);
        var title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentRead }).inject(editArea);
        var readInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentEdit }).inject(editArea);
        var editInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        title = new Element("div", { "styles": css.attachmentPermissionTitleNode, "text": lp.attachmentController }).inject(editArea);
        var controllerInput = new Element("div", { "styles": css.attachmentPermissionInputNode }).inject(editArea);

        var dlg = o2.DL.open(Object.merge({
            "title": lp.attachmentPermission,
            "style": this.module.form.json.dialogStyle || "user",
            "isResize": false,
            "content": node,
            "buttonList": [
                {
                    "type": "ok",
                    "text": MWF.LP.process.button.ok,
                    "action": function () {
                        this.setAttachmentConfig(readInput, editInput, controllerInput);
                        dlg.close();
                    }.bind(this)
                },
                {
                    "type": "cancel",
                    "text": MWF.LP.process.button.cancel,
                    "action": function () { dlg.close(); }
                }
            ]
        }, (this.module.form.json.dialogOptions||{})));

        if (this.selectedAttachments.length === 1) {
            var data = this.selectedAttachments[0].data;

            var readUnitList = (data.readUnitList) || [];
            var readIdentityList = (data.readIdentityList) || [];
            var editUnitList = (data.editUnitList) || [];
            var editIdentityList = (data.editIdentityList) || [];
            var controllerUnitList = (data.controllerUnitList) || [];
            var controllerIdentityList = (data.controllerIdentityList) || [];

            readInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": readUnitList.concat(readIdentityList).trim()
            }));
            editInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": editUnitList.concat(editIdentityList).trim()
            }));
            controllerInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"],
                "values": controllerUnitList.concat(controllerIdentityList).trim()
            }));
        } else {
            readInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
            editInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
            controllerInput.setSelectPerson(this.module.form.app.content, Object.merge(Object.clone(this.module.form.json.selectorStyle || {}), {
                "types": ["unit", "identity"]
            }));
        }
    },
    setAttachmentConfig: function (readInput, editInput, controllerInput) {
        if (this.selectedAttachments.length) {
            var readList = readInput.retrieve("data-value");
            var editList = editInput.retrieve("data-value");
            var controllerList = controllerInput.retrieve("data-value");

            var readUnitList = [];
            var readIdentityList = [];
            var editUnitList = [];
            var editIdentityList = [];
            var controllerUnitList = [];
            var controllerIdentityList = [];

            if (readList) {
                readList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") readUnitList.push(vName);
                    if (flag === "I") readIdentityList.push(vName);
                });
            }
            if (editList) {
                editList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") editUnitList.push(vName);
                    if (flag === "I") editIdentityList.push(vName);
                });
            }
            if (controllerList) {
                controllerList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") controllerUnitList.push(vName);
                    if (flag === "I") controllerIdentityList.push(vName);
                });
            }

            var loadedCount = 0;
            this.selectedAttachments.each(function (att) {
                att.data.readUnitList = readUnitList;
                att.data.readIdentityList = readIdentityList;
                att.data.editUnitList = editUnitList;
                att.data.editIdentityList = editIdentityList;
                att.data.controllerUnitList = controllerUnitList;
                att.data.controllerIdentityList = controllerIdentityList;

                o2.Actions.get("x_processplatform_assemble_surface").configAttachment(att.data.id, this.module.form.businessData.work.id, att.data, function () {
                    //刷新附件权限，以后要加一个刷新附件的功能
                    o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.getWithWorkOrWorkCompleted(att.data.id, this.module.form.businessData.work.id, function (json) {
                        var attachment = this.getAttachmentById( att.data.id );
                        if( attachment ){
                            attachment.data = json.data;

                            if( attachment.deleteAction && !this.isAttDeleteAvailable(attachment) ){
                                attachment.deleteAction.setStyle("display","none");
                            }

                            if( attachment.configAction && !this.isAttConfigAvailable(attachment) ){
                                attachment.configAction.setStyle("display","none");
                            }
                        }
                        loadedCount++;
                        if( loadedCount === this.selectedAttachments.length ){
                            this.checkActions();
                        }
                    }.bind(this))
                }.bind(this));
            }.bind(this));
        }
    },

    checkImageTex: function () {
        if (this.selectedAttachments.length && this.selectedAttachments.length == 1) {
            var att = this.selectedAttachments[0];
            var lp = MWF.xApplication.process.Xform.LP;
            var css = this.module.form.css;

            var node = new Element("div", { "styles": css.attachmentOCRNode }).inject(this.node);
            var previewNode = new Element("div", { "styles": css.attachmentOCRImageAreaNode }).inject(node);
            var imgNode = new Element("img", { "styles": css.attachmentOCRImageNode }).inject(previewNode);

            o2.Actions.get("x_processplatform_assemble_surface").getAttachmentUrl(att.data.id, this.module.form.businessData.work.id, function (url) {
                imgNode.set("src", o2.filterUrl(url));
            });

            var areaNode = new Element("div", { "styles": css.attachmentOCRInputAreaNode }).inject(node);
            var inputNode = new Element("textarea", { "styles": css.attachmentOCRInputNode }).inject(areaNode);

            var dlg = o2.DL.open({
                "title": lp.attachmentOCRTitle,
                "style": this.module.form.json.dialogStyle || "user",
                "isResize": false,
                "content": node,
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function () {
                            this.setAttachmentOCR(inputNode, att);
                            dlg.close();
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ]
            });
            if (att.data.ocr) {
                inputNode.set("text", att.data.ocr.text || "");
            } else {
                o2.Actions.get("x_processplatform_assemble_surface").getAttachmentOCR(att.data.id, this.module.form.businessData.work.id, function (json) {
                    att.data.ocr = json.data;
                    inputNode.set("text", json.data.text || "");
                }.bind(this))
            }

        }
    },
    setAttachmentOCR: function (inputNode, att) {
        var data = inputNode.get("text");
        if (!att.data.ocr) att.data.ocr = {};
        att.data.ocr.text = data;
        o2.Actions.get("x_processplatform_assemble_surface").setAttachmentOCR(att.data.id, this.module.form.businessData.work.id, {
            "text": data
        }, function () {
            this.module.form.app.notice("success", lp.attachmentOCR_saved, this.node);
        }.bind(this));
    },
    checkMoveAction: function (item) {
        if (item) {
            var actionArea = item.getFirst().getNext();
            var actionup = actionArea.getFirst().show();
            var actiondown = actionArea.getLast().show();

            tmp = item.getPrevious();
            if (!tmp) actionup.hide();

            tmp = item.getNext();
            if (!tmp) actiondown.hide();
        }
    },
    sortByNumber: function( attachments ){
        return attachments.sort(function (a1, a2) {
            if (!a2.data.orderNumber) return 1;
            if (!a1.data.orderNumber) return -1;
            return a1.data.orderNumber - a2.data.orderNumber;
        }.bind(this));
    },
    orderAttachment: function () {
        if (this.attachments.length) {
            // this.attachments = this.attachments.sort(function (a1, a2) {
            //     if (!a2.data.orderNumber) return 1;
            //     if (!a1.data.orderNumber) return -1;
            //     return a1.data.orderNumber - a2.data.orderNumber;
            // }.bind(this));
            this.attachments = this.sortByNumber(this.attachments);

            var lp = MWF.xApplication.process.Xform.LP;
            var css = this.module.form.css;
            var node = new Element("div", { "styles": css.attachmentOrderNode });
            var infoNode = new Element("div", { "styles": css.attachmentOrderInforNode, "text": lp.attachmentOrderInfo }).inject(node);
            var attrchmentsNode = new Element("div", { "styles": css.attachmentOrderAreaNode }).inject(node);

            var iconUrl = "../x_component_File/$Main/icon.json";
            var icons = null;
            o2.getJSON(iconUrl, function (json) {
                icons = json;
            }.bind(this), false, false);

            this.attachments.each(function (att, idx) {
                var iconName = icons[att.data.extension.toLowerCase()] || icons.unknow;
                var iconFolderUrl = "../x_component_File/$Main/default/file/" + iconName;

                var itemNode = new Element("div", { "styles": css.attachmentOrderItemNode }).inject(attrchmentsNode);
                itemNode.store("att", att);
                var icon = new Element("div", { "styles": css.attachmentOrderItemIconNode }).inject(itemNode);
                icon.setStyle("background-image", "url('" + iconFolderUrl + "')");

                var actionArea = new Element("div", { "styles": css.attachmentOrderItemActionNode }).inject(itemNode);
                var text = new Element("div", { "styles": css.attachmentOrderItemTextNode, "text": att.data.name }).inject(itemNode);

                var actionUp = new Element("div", { "styles": css.attachmentOrderItemActionUpNode, "text": lp.attachmentOrderUp }).inject(actionArea);
                var actionDown = new Element("div", { "styles": css.attachmentOrderItemActionDownNode, "text": lp.attachmentOrderDown }).inject(actionArea);
                if (idx == 0) actionUp.hide();
                if (idx == this.attachments.length - 1) actionDown.hide();

                actionUp.addEvent("click", function (e) {
                    var itemNode = e.target.getParent().getParent();
                    var upNode = itemNode.getPrevious();
                    if (upNode) {
                        itemNode.inject(upNode, "before");
                        this.checkMoveAction(upNode);
                    }
                    this.checkMoveAction(itemNode);
                    itemNode.highlight();
                    //itemNode.setStyle("background-color", "#faf9f1");
                }.bind(this));

                actionDown.addEvent("click", function (e) {
                    var itemNode = e.target.getParent().getParent();
                    var downNode = itemNode.getNext();
                    if (downNode) {
                        itemNode.inject(downNode, "after");
                        this.checkMoveAction(downNode);
                    }
                    this.checkMoveAction(itemNode);
                    itemNode.highlight();
                    // /itemNode.setStyle("background-color", "#faf9f1");
                }.bind(this));

                itemNode.addEvents({
                    "mouseover": function (e) { this.setStyle("background-color", "#f1f6fa"); },
                    "mouseout": function (e) { this.setStyle("background-color", "#ffffff"); }
                });

                //var droppables = attrchmentsNode.getChildren();

                new Drag(itemNode, {
                    "handle": icon,
                    "snap": 5,
                    "stopPropagation": true,
                    "preventDefault": true,
                    onStart: function (el, e) {
                        var itemNode = el;
                        itemNode.setStyle("background-color", "#f1f6fa");
                        var moveNode = itemNode.clone(true).setStyles(css.attachmentOrderItemNode).setStyles({
                            "background-color": "#faf9f1",
                            "opacity": 0.8,
                            "border": "1px dotted #333333"
                        }).inject(node);
                        moveNode.position({
                            "relativeTo": itemNode,
                            "position": 'upperLeft',
                            "edge": 'upperLeft'
                        });
                        moveNode.owner = itemNode;

                        var move = new Drag.Move(moveNode, {
                            "container": node,
                            "droppables": attrchmentsNode.getChildren(),
                            "onEnter": function (el, drop) {
                                moveNode.flagNode = new Element("div", { "styles": css.attachmentOrderFlagNode }).inject(drop, "before");
                            },
                            "onLeave": function (el, drop) {
                                if (moveNode.flagNode) moveNode.flagNode.destroy();
                            },
                            "onDrop": function (el, drop) {
                                if (moveNode.flagNode) {
                                    moveNode.owner.inject(moveNode.flagNode, "after");
                                    moveNode.flagNode.destroy();
                                    moveNode.owner.highlight();
                                    this.checkMoveAction(moveNode.owner);
                                    this.checkMoveAction(drop);
                                    this.checkMoveAction(attrchmentsNode.getLast());
                                    moveNode.destroy()
                                }
                            }.bind(this)
                        });
                        move.start(e);


                    }.bind(this),
                    enter: function (el) {
                        el.removeClass('dragging');
                    }
                });
                //itemNode.dragMove


            }.bind(this));

            var dlg = o2.DL.open(Object.merge({
                "title": lp.attachmentOrderTitle,
                "style": this.module.form.json.dialogStyle || "user",
                "isResize": false,
                "content": node,
                "width": "auto",
                "height": "auto",
                "buttonList": [
                    {
                        "type": "ok",
                        "text": MWF.LP.process.button.ok,
                        "action": function () {
                            this.sortAttachment(attrchmentsNode);
                            dlg.close();
                        }.bind(this)
                    },
                    {
                        "type": "cancel",
                        "text": MWF.LP.process.button.cancel,
                        "action": function () { dlg.close(); }
                    }
                ],
                "onPostLoad": function () {
                    var dlg = this;
                    dlg.node.setStyle("display", "block");

                    var size = {};
                    if (css.attachmentOrderNode) {
                        if (parseFloat(css.attachmentOrderNode.width).toString() !== "NaN") {
                            size.x = parseInt(css.attachmentOrderNode.width)
                        }
                        if (parseFloat(css.attachmentOrderNode.height).toString() !== "NaN") {
                            size.y = parseInt(css.attachmentOrderNode.height)
                        }
                    }

                    node.show();
                    var nodeSize = node.getSize();
                    dlg.content.setStyles({
                        "width": size.x || nodeSize.x,
                        "height": size.y || nodeSize.y
                    });
                    dlg.setContentSize();
                }
            },  (this.module.form.json.dialogOptions||{})));
        }
    },
    sortAttachment: function (node) {
        var nodes = node.getChildren();
        nodes.each(function (item, idx) {
            var att = item.retrieve("att", null);
            if (att) {
                att.data.orderNumber = idx;
                o2.Actions.load("x_processplatform_assemble_surface").AttachmentAction.changeOrderNumber(att.data.id, this.module.form.businessData.work.id, idx);
            }
        }.bind(this));
        this.attachments = this.attachments.sort(function (a1, a2) {
            if (!a2.data.orderNumber) return 1;
            if (!a1.data.orderNumber) return -1;
            return a1.data.orderNumber - a2.data.orderNumber;
        }.bind(this));

        this.reloadAttachments();
        this.fireEvent("order");
    }

});


/** @class Attachment 附件组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var attachment = this.form.get("name"); //获取组件
 * //方法2
 * var attachment = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Attachment = MWF.APPAttachment = new Class(
    /** @lends MWF.xApplication.process.Xform.Attachment# */
{
    Extends: MWF.APP$Module,
    options: {
        /**
         * @event MWF.xApplication.process.Xform.Attachment#postLoad
         * @ignore
         */
        /**附件组件（this.target）加载前触发。
         * @event MWF.xApplication.process.Xform.Attachment#queryLoad
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**附件容器（this.target.attachmentController）初始化之前触发，可以通过this.event获取附件容器的选项。
         * @event MWF.xApplication.process.Xform.Attachment#queryLoadController
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**附件容器（this.target.attachmentController）初始化之后，加载之前触发。
         * @event MWF.xApplication.process.Xform.Attachment#loadController
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**附件容器（this.target.attachmentController）加载之后触发，但这时还未加载具体的附件。
         * @event MWF.xApplication.process.Xform.Attachment#postLoadController
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 附件组件（this.target）加载完成后触发。这时候附件容器和每个附件都已加载完成。
         * @event MWF.xApplication.process.Xform.Attachment#load
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 附件上传后触发。本事件中可以通过this.event获取上传附件的数据
         * @event MWF.xApplication.process.Xform.Attachment#upload
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除附件前触发。本事件中可以通过this.event获取被删附件的数据
         * @event MWF.xApplication.process.Xform.Attachment#delete
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 删除附件后触发。本事件中可以通过this.event获取被删附件的数据
         * @event MWF.xApplication.process.Xform.Attachment#afterDelete
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 附件有变化的时候会被触发，包括上传、删除、排序
         * @event MWF.xApplication.process.Xform.Attachment#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 下载附件后触发。本事件中可以通过this.event获取被下载附件对象
         * @event MWF.xApplication.process.Xform.Attachment#download
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 打开附件后触发。本事件中可以通过this.event获取被打开附件对象
         * @event MWF.xApplication.process.Xform.Attachment#open
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["upload", "delete", "afterDelete", "load", "change","download","open", "queryLoad", "queryLoadController", "loadController", "postLoadController"]
    },

    initialize: function (node, json, form, options) {
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },

    _loadUserInterface: function () {
        this.node.empty();
        if (this.form.businessData.work.startTime){
            this.fireEvent("queryLoad");
            this.loadAttachmentController();
            this.fireEvent("load");
        }
    },
    reload: function(){
        this.node.empty();
        if (this.form.businessData.work.startTime){
            this.loadAttachmentController();
        }
    },
    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": (this.json.resize === "y" || this.json.resize === "true"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": (this.json.isUpload === "y" || this.json.isUpload === "true"),
            "isDelete": (this.json.isDelete === "y" || this.json.isDelete === "true"),
            "isReplace": (this.json.isReplace === "y" || this.json.isReplace === "true"),
            "isDownload": (this.json.isDownload === "y" || this.json.isDownload === "true"),
            "isPreviewAtt": (this.json.isPreviewAtt === "y" || this.json.isPreviewAtt === "true"),
            "isSizeChange": (this.json.isSizeChange === "y" || this.json.isSizeChange === "true"),
            "readonly": (this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly ),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "onOrder": function () {
                this.fireEvent("change");
            }.bind(this)
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }
        //this.attachmentController = new MWF.widget.ATTER(this.node, this, options);

        this.fireEvent("queryLoadController", [options]);

        /**
         * @summary 附件容器.
         * @member {MWF.xApplication.process.Xform.AttachmentController}
         * @example
         * var attachmentController = this.form.get("fieldId").attachmentController; //获取附件容器
         * var attachmentList = attachmentController.attachments; //获取所有的附件
         * var attachmentData = attachmentList[0].data; //获取第一个附件的数据
         */

        this.attachmentController = new MWF.xApplication.process.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        this.form.businessData.attachmentList.each(function (att) {
            //if (att.site===this.json.id || (this.json.isOpenInOffice && this.json.officeControlName===att.site)) this.attachmentController.addAttachment(att);
            if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
        }.bind(this));
        this.setAttachmentBusinessData();
        //}.bind(this));
    },
    setAttachmentBusinessData: function () {
        if (this.attachmentController) {
            if (this.attachmentController.attachments.length) {
                var values = this.attachmentController.attachments.map(function (d) {
                    return d.data.name;
                });
                this._setBusinessData(values);
            } else {
                this._setBusinessData([]);
            }
        }
    },

    _loadEvents: function (editorConfig) {
        Object.each(this.json.events, function (e, key) {
            if (e.code) {
                if (this.options.moduleEvents.indexOf(key) !== -1) {
                    this.addEvent(key, function (event) {
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                } else {
                    this.node.addEvent(key, function (event) {
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));

    },
    isEmpty : function(){
        var data = this.getData();
        if( typeOf(data) === "array" ){
            return data.length == 0
        }else{
            return !data;
        }
    },
    /**
     * @summary 获取当前组件所有附件的标题.如果没有附件返回null
     * @example
     * var getAttachmentNames = this.form.get("name").getData();
     * @return {StringArray|Null} 附件标题.
     */
    getData: function () {
        return (this.attachmentController) ? this.attachmentController.getAttachmentNames() : null;
    },
    createUploadFileNode: function () {
        debugger;
        var accept = "*";
        if (!this.json.attachmentExtType || (this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType)) {
        } else {
            accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            }.bind(this));
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        this.attachmentController.doUploadAttachment({ "site": (this.json.site || this.json.id) }, this.form.workAction.action, "uploadAttachment", { "id": this.form.businessData.work.id }, null, function (o) {
            if (o.id) {
                this.form.workAction.getAttachment(o.id, this.form.businessData.work.id, function (json) {
                    if (json.data) {
                        if (!json.data.control) json.data.control = {};

                        this.form.businessData.attachmentList.push(json.data);

                        this.attachmentController.addAttachment(json.data, o.messageId);
                    }
                    this.attachmentController.checkActions();

                    this.setAttachmentBusinessData();
                    this.fireEvent("upload", [json.data]);
                    this.fireEvent("change");
                }.bind(this))
            }
            this.attachmentController.checkActions();
        }.bind(this), function (files) {
            if (files.length) {
                if ((files.length + this.attachmentController.attachments.length > this.attachmentController.options.attachmentCount) && this.attachmentController.options.attachmentCount > 0) {
                    var content = MWF.xApplication.process.Xform.LP.uploadMore;
                    content = content.replace("{n}", this.attachmentController.options.attachmentCount);
                    this.form.notice(content, "error");
                    return false;
                }
            }
            return true;
        }.bind(this), true, accept, size, function (o) { //错误的回调
            if (o.messageId && this.attachmentController.messageItemList) {
                var message = this.attachmentController.messageItemList[o.messageId];
                if( message && message.node )message.node.destroy();
            }
        }.bind(this));


        // this.uploadFileAreaNode = new Element("div");
        // var html = "<input name=\"file\" type=\"file\" multiple/>";
        // this.uploadFileAreaNode.set("html", html);
        //
        // this.fileUploadNode = this.uploadFileAreaNode.getFirst();
        // this.fileUploadNode.addEvent("change", function(){
        //
        //     var files = this.fileUploadNode.files;
        //     if (files.length){
        //         if ((files.length+this.attachmentController.attachments.length > this.attachmentController.options.attachmentCount) && this.attachmentController.options.attachmentCount>0){
        //             var content = MWF.xApplication.process.Xform.LP.uploadMore;
        //             content = content.replace("{n}", this.attachmentController.options.attachmentCount);
        //             this.form.notice(content, "error");
        //         }else{
        //             for (var i = 0; i < files.length; i++) {
        //                 var file = files.item(i);
        //
        //                 var formData = new FormData();
        //                 formData.append('site', this.json.id);
        //                 formData.append('file', file);
        //
        //                 //formData.append('folder', folderId);
        //
        //                 this.form.workAction.uploadAttachment(this.form.businessData.work.id ,function(o, text){
        //                     if (o.id){
        //                         this.form.workAction.getAttachment(o.id, this.form.businessData.work.id, function(json){
        //                             if (json.data) this.attachmentController.addAttachment(json.data);
        //                             this.attachmentController.checkActions();
        //
        //                             this.fireEvent("upload", [json.data]);
        //                         }.bind(this))
        //                     }
        //                     this.attachmentController.checkActions();
        //                 }.bind(this), null, formData, file);
        //             }
        //         }
        //     }
        // }.bind(this));
    },
    uploadAttachment: function (e, node) {
        if (window.o2android && window.o2android.uploadAttachment) {
            window.o2android.uploadAttachment((this.json.site || this.json.id));
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.uploadAttachment) {
            window.webkit.messageHandlers.uploadAttachment.postMessage({ "site": (this.json.site || this.json.id) });
        } else {
            // if (!this.uploadFileAreaNode){
            this.createUploadFileNode();
            // }
            // this.fileUploadNode.click();
        }
    },
    deleteAttachments: function (e, node, attachments) {
        var names = [];
        attachments.each(function (attachment) {
            names.push(attachment.data.name);
        }.bind(this));

        // if ((window.o2 && window.o2.replaceAttachment) || (window.webkit && window.webkit.messageHandlers)){
        //     if (window.confirm(MWF.xApplication.process.Xform.LP.deleteAttachment+"( "+names.join(", ")+" )")){
        //         while (attachments.length){
        //             attachment = attachments.shift();
        //             this.deleteAttachment(attachment);
        //         }
        //     }
        // }else {
        // var tmpNode = new Element("div", {
        //     "styles": {
        //         "background-color": "#0000ff",
        //         "border-style": "solid",
        //         "border-color": "#fff",
        //         "border-width": "1",
        //         "box-shadow": "0px 0px 20px #999",
        //         "z-index": "20000",
        //         "overflow": "hidden",
        //         "font-size": "14px",
        //         "height": "160px",
        //         "padding": "0px",
        //         "width": "300px",
        //         "position": "absolute",
        //         "top": "50px",
        //         "left": "20px",
        //         "opacity": 1,
        //         "border-radius": "5px"
        //     }
        // }).inject(this.form.app.content);

        var _self = this;
        this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.deleteAttachmentTitle, MWF.xApplication.process.Xform.LP.deleteAttachment + "( " + names.join(", ") + " )", 300, 120, function () {
            while (attachments.length) {
                var attachment = attachments.shift();
                _self.deleteAttachment(attachment);
            }
            this.close();
        }, function () {
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    previewAttachment: function (attachments) {
        var att = attachments[0];
        new MWF.xApplication.process.Xform.AttachmenPreview(att,this);
    },
    deleteAttachment: function (attachment) {
        this.fireEvent("delete", [attachment.data]);
        var id = attachment.data.id;
        this.form.workAction.deleteAttachment(attachment.data.id, this.form.businessData.work.id, function (josn) {
            this.attachmentController.removeAttachment(attachment);
            this.attachmentController.checkActions();

            for( var i=0; i<this.form.businessData.attachmentList.length; i++ ){
                var attData = this.form.businessData.attachmentList[i];
                if( attData.id === id ){
                    this.form.businessData.attachmentList.erase(attData);
                    break;
                }
            }

            if (this.form.officeList) {
                this.form.officeList.each(function (office) {
                    if (office.openedAttachment) {
                        if (office.openedAttachment.id == id) {
                            office.loadOfficeEdit();
                        }
                    }
                }.bind(this));
            }
            this.setAttachmentBusinessData();
            this.fireEvent("afterDelete", [attachment.data]);
            this.fireEvent("change");
        }.bind(this));
    },

    replaceAttachment: function (e, node, attachment) {
        if (window.o2android && window.o2android.replaceAttachment) {
            window.o2android.replaceAttachment(attachment.data.id, (this.json.site || this.json.id));
        } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.replaceAttachment) {
            window.webkit.messageHandlers.replaceAttachment.postMessage({ "id": attachment.data.id, "site": (this.json.site || this.json.id) });
        } else {
            var _self = this;
            this.form.confirm("warn", e, MWF.xApplication.process.Xform.LP.replaceAttachmentTitle, MWF.xApplication.process.Xform.LP.replaceAttachment + "( " + attachment.data.name + " )", 350, 120, function () {
                _self.replaceAttachmentFile(attachment);
                this.close();
            }, function () {
                this.close();
            }, null, null, this.form.json.confirmStyle);
        }
    },

    createReplaceFileNode: function (attachment) {
        var accept = "*";
        if (!this.json.attachmentExtType || this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType) {
        } else {
            accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            });
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        this.attachmentController.doUploadAttachment({ "site": (this.json.site || this.json.id) }, this.form.workAction.action, "replaceAttachment",
            { "id": attachment.data.id, "workid": this.form.businessData.work.id }, null, function (o) {
                this.form.workAction.getAttachment(attachment.data.id, this.form.businessData.work.id, function (json) {
                    attachment.data = json.data;
                    attachment.reload();

                    if (o.messageId && this.attachmentController.messageItemList) {
                        var message = this.attachmentController.messageItemList[o.messageId];
                        if( message && message.node )message.node.destroy();
                    }

                    this.attachmentController.checkActions();
                }.bind(this))
            }.bind(this), null, true, accept, size, function (o) { //错误的回调
                if (o.messageId && this.attachmentController.messageItemList) {
                    var message = this.attachmentController.messageItemList[o.messageId];
                    if( message && message.node )message.node.destroy();
                }
            }.bind(this));

        // this.replaceFileAreaNode = new Element("div");
        // var html = "<input name=\"file\" type=\"file\" multiple/>";
        // this.replaceFileAreaNode.set("html", html);
        //
        // this.fileReplaceNode = this.replaceFileAreaNode.getFirst();
        // this.fileReplaceNode.addEvent("change", function(){
        //
        //     var files = this.fileReplaceNode.files;
        //     if (files.length){
        //         for (var i = 0; i < files.length; i++) {
        //             var file = files.item(i);
        //
        //             var formData = new FormData();
        //             formData.append('file', file);
        //         //    formData.append('site', this.json.id);
        //
        //             this.form.workAction.replaceAttachment(attachment.data.id, this.form.businessData.work.id ,function(o, text){
        //                 this.form.workAction.getAttachment(attachment.data.id, this.form.businessData.work.id, function(json){
        //                     attachment.data = json.data;
        //                     attachment.reload();
        //                     this.attachmentController.checkActions();
        //                 }.bind(this))
        //             }.bind(this), null, formData, file);
        //         }
        //     }
        // }.bind(this));
    },

    replaceAttachmentFile: function (attachment) {
        //if (!this.replaceFileAreaNode){
        this.createReplaceFileNode(attachment);
        // }
        // this.fileReplaceNode.click();
    },
    queryDownload : function( att ){
        if( this.json.events && this.json.events.queryDownload && this.json.events.queryDownload.code ){
            var flag = this.form.Macro.exec(this.json.events.queryDownload.code, att );
            if( flag === false ){
                return false
            }else{
                return true;
            }
        }else{
            return true;
        }
    },
    queryOpen : function( att ){
        if( this.json.events && this.json.events.queryOpen && this.json.events.queryOpen.code ){
            var flag = this.form.Macro.exec(this.json.events.queryOpen.code, att );
            if( flag === false ){
                return false
            }else{
                return true;
            }
        }else{
            return true;
        }
    },
    //小程序文件是否支持打开
    checkMiniProgramFile: function(ext) {
        var exts = ["doc", "docx", "xls", "xlsx", "ppt", "pptx", "pdf"];
        for(var i = 0; i < exts.length; i++){
            if(ext === exts[i]){
                return true;
            }
        }
        return false;
    },
    downloadAttachment: function (e, node, attachments) {
        if (this.form.businessData.work && !this.form.businessData.work.completedTime) {
            attachments.each(function (att) {
                if( !this.queryDownload( att ) )return;
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({
                        url: '../file/download?attId=' + att.data.id + '&type=work&work=' + this.form.businessData.work.id
                    });
                } else {
                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.workAction.getAttachmentUrl(att.data.id, this.form.businessData.work.id, function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.workAction.getAttachmentStream(att.data.id, this.form.businessData.work.id);
                    }
                }
                this.fireEvent("download",[att])
            }.bind(this));
        } else {
            attachments.each(function (att) {
                if( !this.queryDownload( att ) )return;
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({
                        url: '../file/download?attId=' + att.data.id + '&type=work&workCompleted=' + this.form.businessData.workCompleted.id
                    });
                } else {
                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.workAction.getAttachmentWorkcompletedUrl(att.data.id, this.form.businessData.workCompleted.id, function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.workAction.getWorkcompletedAttachmentStream(att.data.id, this.form.businessData.workCompleted.id);
                    }
                }
                this.fireEvent("download",[att])
            }.bind(this));
        }
    },
    openAttachment: function (e, node, attachments) {
        if (this.form.businessData.work && !this.form.businessData.work.completedTime) {
            attachments.each(function (att) {
                if( !this.queryOpen( att ) )return;
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({
                        url: '../file/download?attId=' + att.data.id + '&type=work&work=' + this.form.businessData.work.id
                    });
                } else {
                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.workAction.getAttachmentUrl(att.data.id, this.form.businessData.work.id, function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.workAction.getAttachmentData(att.data.id, this.form.businessData.work.id);
                    }

                }
                this.fireEvent("open",[att])
            }.bind(this));
        } else {
            attachments.each(function (att) {
                if( !this.queryOpen( att ) )return;
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": (this.json.site || this.json.id) });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({
                        url: '../file/download?attId=' + att.data.id + '&type=work&workCompleted=' + this.form.businessData.workCompleted.id
                    });
                } else {

                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.workAction.getAttachmentWorkcompletedUrl(att.data.id, ((this.form.businessData.workCompleted) ? this.form.businessData.workCompleted.id : this.form.businessData.work.id), function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.workAction.getWorkcompletedAttachmentData(att.data.id, ((this.form.businessData.workCompleted) ? this.form.businessData.workCompleted.id : this.form.businessData.work.id));
                    }
                }
                this.fireEvent("open",[att])
            }.bind(this));
        }
        //this.downloadAttachment(e, node, attachment);
    },
    getAttachmentUrl: function (attachment, callback) {
        if (this.form.businessData.work && !this.form.businessData.work.completedTime) {
            this.form.workAction.getAttachmentUrl(attachment.data.id, this.form.businessData.work.id, callback);
        } else {
            this.form.workAction.getAttachmentWorkcompletedUrl(attachment.data.id, this.form.businessData.workCompleted.id, callback);
        }
    },
    getTextData: function(){
        var data = [];
        this.attachmentController.attachments.each(function(att){
            var o = {
                "id": att.data.id,
                "person": att.data.person,
                "creatorUid": att.data.creatorUid,
                "name": att.data.name,
                "orderNumber": att.data.orderNumber,
                "length": att.data.length,
                "extension": att.data.extension,
                "lastUpdateTime": att.data.lastUpdateTime,
                "activityName": att.data.activityName,
                "control" : att.data.control
            }
            data.push(o);
        });
        return data;
    },
    /**
     * @summary 为组件重新设置附件，该附件必须已经上传。
     *  @param data {Array}.
     *  <pre><code class='language-js'>[{
     *     "id": "56c4e86f-a4c8-4cc2-a150-1a0d2c5febcb",   //附件ID
     *     "name": "133203a2-92e6-4653-9954-161b72ddb7f9.png", //附件名称
     *     "extension": "png",                             //附件扩展名
     *     "length": 43864,                                //附件大小
     *     "person": "xx@huqi@P",                          //附件上传人
     *     "lastUpdateTime": "2018-09-27 15:50:34",        //最后的修改时间
     *     "lastUpdatePerson": "xx@huqi@P",                //最后的修改人
     *     "activity": "e31ad938-c495-45a6-8d77-b8a9b61a165b", //附件上传的活动ID
     *     "activityName": "申请人",                           //附件上传的活动名称
     *     "activityType": "manual",                           //附件上传的活动类型
     *     "site": "$mediaOpinion",                        //附件存储位置（一般用于区分附件在哪个表单元素中显示）
     *     "type": "image/png",                             //附件类型（contentType）
     *     "control": {}
     * }]</code></pre>
     */
    setData: function(data){
        this.attachmentController.clear();
        ( data || [] ).each(function (att) {
            var attachment = this.form.businessData.attachmentList.find(function(a){
                return a.id==att.id;
            });
            var attData = attachment || att;

            this.attachmentController.addAttachment(attData);
        }.bind(this));
        this.setAttachmentBusinessData();
    },
    createErrorNode: function (text) {
        var node = new Element("div");
        var iconNode = new Element("div", {
            "styles": {
                "width": "20px",
                "height": "20px",
                "float": "left",
                "background": "url(" + "../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "line-height": "20px",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function (text) {
        if (!this.isNotValidationMode) {
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
        }
    },
    showNotValidationMode: function (node) {
        var p = node.getParent("div");
        if (p) {
            if (p.get("MWFtype") == "tab$Content") {
                if (p.getParent("div").getStyle("display") == "none") {
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function () {
        if (this.isNotValidationMode) {
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode) {
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function (routeName, data) {
        var flag = (data.status == "all") ? true : (routeName == data.decision);
        if (flag) {
            var n = this.getData() || [];
            var v = (data.valueType == "value") ? n : n.length;
            switch (data.operateor) {
                case "isnull":
                    if (!v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v > data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v < data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v == data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v != data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value) != -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value) == -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function (routeName, opinion) {
        if (this.json.validationConfig) {
            if (this.json.validationConfig.length) {
                for (var i = 0; i < this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validation() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validation: function (routeName, opinion) {
        if (!this.validationConfig(routeName, opinion)) return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString() != "true") {
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }

});
MWF.xApplication.process.Xform.AttachmenPreview = new Class({
    Implements: [Options, Events],

    initialize : function(att,app ){
        this.att = att;
        this.app = app;
        this.load();
    },
    load:function(){

        var extension = this.att.data.extension;
        if(extension === "ofd"){
            //ofd预览暂时屏蔽ie，等兼容性改好了开启
            if(Browser.name!=="ie"){
                this.previewOfd();
            }
        }
        if(extension === "zip"){
            this.previewZip();
        }
        if(extension === "pdf"){
            this.previewPdf();
        }
        if(["png","jpg","bmp","jpeg","gif"].contains(extension)){
            this.previewImage();
        }
        if(extension === "js"){
            this.previewAce("javascript");
        }
        if(extension === "css"){
            this.previewAce("css");
        }
        if(extension === "java"){
            this.previewAce("java");
        }
        if(extension === "json"){
            this.previewAce("json");
        }
        if(extension === "xml"){
            this.previewAce("xml");
        }
        if(extension === "php"){
            this.previewAce("php");
        }
        if(["html","htm","xhtml"].contains(extension)){
            this.previewAce("html");
        }
        if(["log","md","txt"].contains(extension)){
            this.previewAce("text");
        }
    },
    previewZip: function () {
        debugger
        //zip压缩包预览
        var _self = this;
        var zipViewNode = new Element("div",{"text":"loadding..."});
        o2.load(["../o2_lib/jszip/jszip.min.js", "../o2_lib/jszip/jszip-utils.min.js"], function () {
            this.app.getAttachmentUrl(this.att, function (url) {
                o2.require("MWF.widget.Tree", function(){
                    var dlg = o2.DL.open({
                        "title": _self.att.data.name,
                        "width": "660px",
                        "height": "510px",
                        "mask": true,
                        "content": zipViewNode,
                        "container": null,
                        "positionNode": document.body,
                        "onQueryClose": function () {
                            zipViewNode.destroy();
                        },
                        "buttonList": [
                            {
                                "text": "关闭",
                                "action": function () {
                                    dlg.close();
                                }
                            }
                        ],
                        "onPostShow": function () {
                            dlg.reCenter();
                        },
                        "onPostLoad" : function(){

                        }
                    });
                }.bind(this));
                zipViewNode.empty();
                JSZipUtils.getBinaryContent(url, function (err, data) {
                    JSZip.loadAsync(data).then(function (zip) {
                        var nodeList = [];
                        zip.forEach(function (relativePath, zipEntry) {
                            nodeList.push(zipEntry.name);
                        });
                        var tree = new MWF.widget.Tree(zipViewNode, {"style":"form"});
                        var treeData = _pathToTree(nodeList);
                        tree.load(treeData);


                    });
                });

            }.bind(this));
        }.bind(this));
        function _pathToTree(pathList) {
            var pathJsonList = [];
            for (var i = 0; i < pathList.length; i++) {
                var chain = pathList[i].split("/");
                var currentNode = pathJsonList;
                for (var j = 0; j < chain.length; j++) {
                    if (chain[j] === "") {
                        break;
                    }
                    var wantedNode = chain[j];
                    var lastNode = currentNode;
                    for (var k = 0; k < currentNode.length; k++) {
                        if (currentNode[k].name == wantedNode) {
                            currentNode = currentNode[k].sub;
                            break;
                        }
                    }
                    if (lastNode == currentNode) {
                        var obj = {
                            key: pathList[i],
                            name: wantedNode,
                            title:wantedNode,
                            text:wantedNode,
                            sub: []
                        };
                        var newNode = (currentNode[k] = obj);
                        if (wantedNode.indexOf(".") > -1) {
                            obj.dir = false;
                            obj.icon = "file.png";
                            delete obj.sub;
                        } else {
                            obj.dir = true;
                            obj.expand = false;
                            currentNode = newNode.sub;
                            //delete obj.sub;
                        }
                    } else {
                        delete currentNode.sub;
                    }
                }
            }
            var nodes = [];

            var folder = {
                "title" : _self.att.name,
                "text" : _self.att.name,
                "sub" : []
            };
            pathJsonList.each(function(path){
                folder.sub.push(path);
            })
            _sortPath(folder, nodes);
            return nodes;
        }
        function _sortPath(pathJsonList, nodes) {
            var folderList = [];
            pathJsonList.sub.each(function (file) {
                if (file.dir) {
                    folderList.push(file);
                }
            });
            pathJsonList.sub.each(function (file) {
                if (!file.dir) {
                    folderList.push(file);
                }
            });
            folderList.each(function (file) {
                var node = {
                    text: file.name,
                    title: file.name,
                    expand : false
                };
                if (!file.dir) {
                    node.icon = "file.png";
                }
                nodes.push(node);
                if(file.sub && file.sub.length>0){
                    node.sub = [];
                    _sortPath(file,node.sub);
                }

            })
        }
    },
    previewPdf : function(){
        this.app.getAttachmentUrl(this.att, function (url) {
            window.open("../o2_lib/pdfjs/web/viewer.html?file=" + url)
        });
    },
    previewOfd : function(){
        this.app.getAttachmentUrl(this.att,  function (url) {
            window.open("../o2_lib/ofdjs/index.html?file=" + url)
        });
    },
    previewImage : function(){
        this.app.getAttachmentUrl(this.att, function (url) {
            var imgNode = new Element("img",{"src":url,"alt":this.att.name}).inject(document.body).hide();
            o2.loadCss("../o2_lib/viewer/viewer.css", document.body,function(){
                o2.load("../o2_lib/viewer/viewer.js", function(){
                    this.viewer = new Viewer(imgNode,{
                        navbar : false,
                        toolbar : false,
                        hidden : function(){
                            imgNode.destroy();
                            this.viewer.destroy();
                        }.bind(this)
                    });
                    this.viewer.show();
                }.bind(this));
            }.bind(this));
        }.bind(this));
    },
    previewAce:function(type){
        debugger
        this.app.getAttachmentUrl(this.att,  function (url) {
            o2.require("o2.widget.ace", null, false);
            var fileRequest = new Request({
                url: url,
                method: 'get',
                withCredentials: true,
                onSuccess: function(responseText){
                    var editorNode = new Element("div",{"style":"padding:10px"});
                    editorNode.set("text",responseText);

                    o2.widget.ace.load(function(){
                        o2.load("../o2_lib/ace/src-min-noconflict/ext-static_highlight.js", function(){
                            var highlight = ace.require("ace/ext/static_highlight");
                            highlight(editorNode, {mode: "ace/mode/"+ type , theme: "ace/theme/tomorrow", "fontSize": 30,"showLineNumbers":true});
                        }.bind(this));

                    }.bind(this));
                    var dlg = o2.DL.open({
                        "title": this.att.data.name,
                        "width": "960px",
                        "height": "610px",
                        "mask": true,
                        "content": editorNode,
                        "container": null,
                        "positionNode": document.body,
                        "onQueryClose": function () {
                            editorNode.destroy();
                        }.bind(this),
                        "buttonList": [
                            {
                                "text": "关闭",
                                "action": function () {
                                    dlg.close();
                                }.bind(this)
                            }
                        ],
                        "onPostShow": function () {
                            dlg.reCenter();
                        }.bind(this)
                    });
                }.bind(this),
                onFailure: function(){
                    console.log('text', 'Sorry, your request failed :(');
                }
            });
            fileRequest.send();
        }.bind(this));

    },
});
MWF.xApplication.process.Xform.AttachmentDg = MWF.APPAttachmentDg = new Class({
    Extends: MWF.APPAttachment,
    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": (this.json.resize === "y" || this.json.resize === "true"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": (this.json.isUpload === "y" || this.json.isUpload === "true"),
            "isDelete": (this.json.isDelete === "y" || this.json.isDelete === "true"),
            "isReplace": (this.json.isReplace === "y" || this.json.isReplace === "true"),
            "isDownload": (this.json.isDownload === "y" || this.json.isDownload === "true"),
            "isSizeChange": (this.json.isSizeChange === "y" || this.json.isSizeChange === "true"),
            "readonly": (this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "ignoreSite": this.json.ignoreSite,
            "onOrder": function () {
                this.fireEvent("change");
            }.bind(this)
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }

        this.fireEvent("queryLoadController", [options]);

        this.attachmentController = new MWF.xApplication.process.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        // var d = this._getBusinessData();
        // if (d) d.each(function (att) {
        //     this.attachmentController.addAttachment(att);
        // }.bind(this));
        if(this.json.ignoreSite) {
            ( this._getBusinessData() || [] ).each(function (att) {
                var flag = this.form.businessData.attachmentList.some(function (attData) {
                    return att.id === attData.id;
                }.bind(this));
                if(flag)this.attachmentController.addAttachment(att);
            }.bind(this));
        }else{
            this.form.businessData.attachmentList.each(function (att) {
                if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
            }.bind(this));
        }
        this.setAttachmentBusinessData();
    },
    setAttachmentBusinessData: function(){
        if (this.attachmentController) {
            if (this.attachmentController.attachments.length) {
                var values = this.attachmentController.attachments.map(function (d) {
                    return {
                        "control": d.data.control,
                        "name": d.data.name,
                        "id": d.data.id,
                        "person": d.data.person,
                        "creatorUid": d.data.creatorUid,
                        "orderNumber": d.data.orderNumber,
                        "length": d.data.length,
                        "extension": d.data.extension,
                        "lastUpdateTime": d.data.lastUpdateTime,
                        "activityName": d.data.activityName
                    };
                });
                this._setBusinessData(values);
            } else {
                this._setBusinessData([]);
            }
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Calendar 日期组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Calendar = MWF.APPCalendar =  new Class(
    /** @lends MWF.xApplication.process.Xform.Calendar# */
{
	Implements: [Events],
	Extends: MWF.APP$Input,
	iconStyle: "calendarIcon",
    options: {
        /**
         * 日期选择完成时触发.
         * @event MWF.xApplication.process.Xform.Calendar#complete
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 日期选择器上点清空时触发.
         * @event MWF.xApplication.process.Xform.Calendar#clear
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 值改变时触发.
         * @event MWF.xApplication.process.Xform.Calendar#change
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 显示日期选择器时触发.
         * @event MWF.xApplication.process.Xform.Calendar#show
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        /**
         * 隐藏日期选择器时触发.
         * @event MWF.xApplication.process.Xform.Calendar#hide
         * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
         */
        "moduleEvents": ["queryLoad","postLoad","load","complete", "clear", "change","show","hide"]
    },
    _loadNode: function(){
        if (this.readonly || this.json.isReadonly){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
            var input = this.node.getFirst();
            input.set("readonly", true);
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            this.descriptionNode.addEvents({
                "mousedown": function(){
                    this.descriptionNode.setStyle("display", "none");
                    //this.clickSelect();
                }.bind(this)
            });
        }
    },
    _getValueAg: function(value,isDate){
        if (value && value.isAG){
            return value.then(function(v){
                this._getValueAg(v, isDate);
            }.bind(this), function(){});
        }else{
            var d = (!!value) ? Date.parse(value) : "";
            if (isDate){
                return d || null;
            }else{
                return (d) ? d.format(this.json.format) : "";
            }
        }
    },
    getValue: function(isDate){
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if( value && !isDate)return value;
        if (!value) value = this._computeValue();
        if (value.then) return value;

        var d = (!!value) ? Date.parse(value) : "";
        if (isDate){
            return d || null;
        }else{
            //if (d) value = Date.parse(value).format(this.json.format);
            return (d) ? d.format(this.json.format) : "";
        }

        return value || "";
    },
    getValueStr : function(){
        var value = this._getBusinessData();
        if (!value) value = this._computeValue();
        return value;
    },

    __setValue: function(value){
        var v;
        if( typeOf( value ) === "date" ){
            v = (value) ? ( Date.parse(value)).format(this.json.format) : "";
        }else{
            v = value;
        }
        this._setBusinessData(value);
        if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
        if (this.readonly || this.json.isReadonly) this.node.set("text", v);
        this.moduleValueAG = null;
        return value;
    },

	clickSelect: function(){

        var _self = this;
        if (!this.calendar){
            MWF.require("MWF.widget.Calendar", function(){
                var defaultView = "day";
                if( this.json.selectType === "month" )defaultView = "month";
                if( this.json.selectType === "year" )defaultView = "year";
                var options = {
                    "style": layout.mobile ? "xform_mobile" : "xform",
                    "secondEnable" : this.json.isSelectSecond,
                    "isTime": (this.json.selectType==="datetime" || this.json.selectType==="time"),
                    "timeOnly": (this.json.selectType === "time"),
                    "monthOnly" : (this.json.selectType === "month"),
                    "yearOnly" : (this.json.selectType === "year"),
                    "defaultView" : defaultView,
                    //"target": this.form.node,
                    "target": layout.mobile ? $(document.body) : this.form.app.content,
                    "format": this.json.format,
                    "onComplate": function(formateDate, date){
                        this.validationMode();
                        if(this.validation())this._setBusinessData(this.getInputData("change"));
                        this.fireEvent("complete");
                    }.bind(this),
                    "onChange": function(){
                        this.fireEvent("change");
                    }.bind(this),
                    "onClear": function(){
                        this.validationMode();
                        if(this.validation())this._setBusinessData(this.getInputData("change"));
                        this.fireEvent("clear");
                        if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                    }.bind(this),
                    "onShow": function(){
                        if (_self.descriptionNode) _self.descriptionNode.setStyle("display", "none");

                        if( layout.mobile ){
                            this.container.position({
                                relativeTo: $(document.body),
                                position: 'leftCenter',
                                edge: 'leftCenter'
                                //offset : { y : -25 }
                            });
                        }else{
                            var parent = _self.node.getParent();
                            while( parent ){
                                var overflow = parent.getStyle("overflow");
                                var overflowY = parent.getStyle("overflow-y");
                                if(  overflow === "auto" || overflow === "scroll" || overflowY === "auto" || overflowY === "scroll" ){
                                    _self.scrollFun = function( e ){
                                        if (this.container.position ) {
                                            this.container.position({
                                                relativeTo: this.node,
                                                position: 'bottomLeft',
                                                edge: 'upperLeft',
                                                allowNegative : true
                                            });
                                        }
                                    }.bind(this);
                                    _self.scrollParentNode = parent;
                                    parent.addEvent( "scroll", _self.scrollFun );
                                    parent = null;
                                }else{
                                    parent = parent.getParent();
                                }
                            }
                        }
                        _self.fireEvent("show");
                    },
                    "onHide": function(){
                        if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
                        if( _self.scrollParentNode && _self.scrollFun ){
                            _self.scrollParentNode.removeEvent("scroll", _self.scrollFun);
                        }
                        _self.fireEvent("hide");
                    }.bind(this)
                };
                options.baseDate = this.getBaseDate();
                /**
                 * @summary 日期弹出选择界面，只读情况下无此成员.
                 * @member {MWF.widget.Calendar}
                 * @example
                 * var calendar = this.form.get("fieldId").calendar; //获取组件
                 * if(calendar)calendar.show(); //弹出选择组件
                 */
                this.calendar = new MWF.widget.Calendar(this.node.getFirst(), options);
                if( this.form.json && this.form.json.canlendarStyle && typeOf( this.form.json.canlendarStyle.zIndex ) !== "null" && typeOf( this.form.json.canlendarStyle.zIndex ) !== "undefined" ){
                    this.calendar.container.setStyle("z-index", this.form.json.canlendarStyle.zIndex );
                }
                this.calendar.show();
            }.bind(this));
        }else{
            var options = {};
            options.baseDate = this.getBaseDate();
            this.calendar.setOptions(options);
            //this.calendar.show();
            this.node.getFirst().focus();
        }
	},
    getBaseDate : function(){
	    debugger;
        var d;
        var value = this.getValue(true);
        if( value && value.getTime() > 10000 ){
            d = value;
        }else{
            var ud = Date.parse( this.unformatDate( this.getValueStr() ) );
            if( ud && ud.getTime() > 10000 ){
                d = ud;
            }else{
                d = new Date();
            }
        }
        return d;
    },
    unformatDate : function( dateStr ){
        var formatStr = this.json.format;
        var matchArr = [ "%Y", "%m", "%d", "%H", "%M", "%S", "%z", "%Z" ];
        var lengthArr = [ 4, 2, 2, 2, 2, 2, 5, 3];
        var indexArr = [ formatStr.indexOf("%Y"), formatStr.indexOf("%m"), formatStr.indexOf("%d"), formatStr.indexOf("%H"), formatStr.indexOf("%M"), formatStr.indexOf("%S"), formatStr.indexOf("%z"), formatStr.indexOf("%Z") ];
        var resultArr = [ null, null, null, null, null, null, null, null ];
        for( var i=0; i<matchArr.length; i++ ){
            if( indexArr[i] === -1 )continue;
            var leftLength = 0;
            var leftUnitLength = 0;
            Array.each( indexArr, function( n, k ){
                if( n === -1 )return;
                if( indexArr[i] > n ){
                    leftLength += lengthArr[k];
                    leftUnitLength += matchArr[k].length;
                }
            });
            resultArr[i] = dateStr.substr( indexArr[i] - leftUnitLength + leftLength, lengthArr[i] );
        }
        var now = new Date();
        for( var i=0; i < resultArr.length; i++ ){
            if( !resultArr[i] ){
                switch ( matchArr[i] ){
                    case "%Y":
                    case "%m":
                    case "%d":
                        resultArr[i] = now.format( matchArr[i] );
                        break;
                    case "%H":
                    case "%M":
                    case "%S":
                        resultArr[i] = "00";
                        break;
                    case "%z":
                    case "%Z":
                    default:
                        break;
                }
            }
        }
        return resultArr[0] + "-" + resultArr[1] + "-" + resultArr[2] + " " + resultArr[3]+":"+resultArr[4]+":"+resultArr[5];
    }
}); 

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.require("MWF.widget.UUID", null, false);
/** @class Calendar 多选按钮组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Checkbox = MWF.APPCheckbox =  new Class(
    /** @lends MWF.xApplication.process.Xform.Checkbox# */
    {
	Implements: [Events],
	Extends: MWF.APP$Input,

    loadDescription: function(){},
    _loadNode: function(){
        if (this.readonly || this.json.isReadonly ){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var radioValues = this.getOptions();
        var value = this.getValue();
        if (value){
            var texts = [];
            radioValues.each(function(item){
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (value.indexOf(v)!=-1){
                    texts.push(t);
                }
            });
            this.node.set("text", texts.join(", "));
        }
    },
    _resetNodeEdit: function(){
        var div = new Element("div");
        div.set(this.json.properties);
        div.inject(this.node, "after");

        this.node.destroy();
        this.node = div;
    },
    _loadNodeEdit: function(){
		//this.container = new Element("select");
        if (!this.json.preprocessing) this._resetNodeEdit();
		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"styles": {
				"display": "inline"
			}
		});
		this.setOptions();
	},
    _loadDomEvents: function(){
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!=-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    //this.node.addEvent(key, function(event){
                    //    return this.form.Macro.fire(e.code, this, event);
                    //}.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            var inputs = this.node.getElements("input");
            inputs.each(function(input){
                input.addEvent(key, function(event){
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }.bind(this));
        }
    },
    /**
     * @summary 重新计算下拉选项，该功能通常用在下拉选项为动态计算的情况.
     * @example
     * this.form.get('fieldId').resetOption();
     */
    resetOption: function(){
        this.node.empty();
        this.setOptions();
    },
        /**
         * @summary 获取选择项。
         * @return {Array} 返回选择项数组，如果使用选择项脚本，根据脚本返回决定，如：<pre><code class='language-js'>[
         *  "女|female",
         *  "男|male"
         * ]</code></pre>
         * @example
         * this.form.get('fieldId').getOptions();
         */
	getOptions: function(){
		if (this.json.itemType == "values"){
			return this.json.itemValues;
		}else{
			return this.form.Macro.exec(((this.json.itemScript) ? this.json.itemScript.code : ""), this);
		}
		//return [];
	},

    /**
     * @summary 获取整理后的选择项。
     * @return {Object} 返回整理后的选择项，如：
     * <pre><code class='language-js'>{"valueList": ["","female","male"], "textList": ["","女","男"]}
     * </code></pre>
     * @example
     * var optionData = this.form.get('fieldId').getOptionsObj();
     */
    getOptionsObj : function(){
        var textList = [];
        var valueList = [];
        var optionItems = this.getOptions();
        if (!optionItems) optionItems = [];
        if (o2.typeOf(optionItems)==="array"){
            optionItems.each(function(item){
                var tmps = item.split("|");
                textList.push( tmps[0] );
                valueList.push( tmps[1] || tmps[0] );
            }.bind(this));
        }
        return { textList : textList, valueList : valueList };
    },

    setOptions: function(){
        var optionItems = this.getOptions();
        this._setOptions(optionItems);
    },

    _setOptions: function(optionItems){
        var p = o2.promiseAll(optionItems).then(function(radioValues){
            this.moduleSelectAG = null;
            if (!radioValues) radioValues = [];
            if (o2.typeOf(radioValues)==="array"){
                var flag = (new MWF.widget.UUID).toString();
                radioValues.each(function(item){
                    var tmps = item.split("|");
                    var text = tmps[0];
                    var value = tmps[1] || text;

                    var radio = new Element("input", {
                        "type": "checkbox",
                        "name": ((this.json.properties) ? this.json.properties.name : null) || flag+this.json.id,
                        "value": value,
                        "showText": text,
                        "styles": this.json.buttonStyles
                    }).inject(this.node);
                    //radio.appendText(text, "after");

                    var textNode = new Element( "span", {
                        "text" : text,
                        "styles" : { "cursor" : "default" }
                    }).inject(this.node);
                    textNode.addEvent("click", function( ev ){
                        if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
                        this.radio.checked = ! this.radio.checked;
                        this.radio.fireEvent("change");
                        this.radio.fireEvent("click");
                    }.bind( {radio : radio} ) );

                    radio.addEvent("click", function(){
                        this.validationMode();
                        if (this.validation()) {
                            this._setBusinessData(this.getInputData("change") || []);
                            this.fireEvent("change");
                        }
                    }.bind(this));

                    Object.each(this.json.events, function(e, key){
                        if (e.code){
                            if (this.options.moduleEvents.indexOf(key)!=-1){
                            }else{
                                radio.addEvent(key, function(event){
                                    return this.form.Macro.fire(e.code, this, event);
                                }.bind(this));
                            }
                        }
                    }.bind(this));

                }.bind(this));
            }
        }.bind(this), function(){});
        this.moduleSelectAG = p;
        if (p) p.then(function(){
            this.moduleSelectAG = null;
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));
	},

    _setValue: function(value, m){
        var mothed = m || "__setValue";
	    if (!!value){
            var p = o2.promiseAll(value).then(function(v){
                //if (o2.typeOf(v)=="array") v = v[0];
                if (this.moduleSelectAG){
                    this.moduleValueAG = this.moduleSelectAG;
                    this.moduleSelectAG.then(function(){
                        this[mothed](v);
                        return v;
                    }.bind(this), function(){});
                }else{
                    this[mothed](v)
                }
                return v;
            }.bind(this), function(){});
            this.moduleValueAG = p;
            if (this.moduleValueAG) this.moduleValueAG.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this[mothed](value);
        }


        // this.moduleValueAG = o2.AG.all(value).then(function(v){
        //     if (this.moduleSelectAG){
        //         this.moduleValueAG = this.moduleSelectAG;
        //         this.moduleSelectAG.then(function(){
        //             this.moduleValueAG = null;
        //             this.__setValue(v);
        //         }.bind(this));
        //     }else{
        //         this.moduleValueAG = null;
        //         this.__setValue(v);
        //     }
        //     return v;
        // }.bind(this));
        //
        // if (this.moduleValueAG) this.moduleValueAG.then(function(){
        //     this.moduleValueAG = "";
        // }.bind(this));
    },

    __setValue: function(value){
        this._setBusinessData(value);
        var radios = this.node.getElements("input");
        for (var i=0; i<radios.length; i++){
            var radio = radios[i];
            radio.checked = value.indexOf(radio.value) != -1;
        }
    },
    /**
     * @summary 获取选中的值和文本.
     * @example
     * var array = this.form.get('fieldId').getTextData();
     * @return {Object} 返回选中项值和文本，格式为 { 'value' : value, 'text' : text }.
     */
	getTextData: function(){
		var inputs = this.node.getElements("input");
		var value = [];
		var text = [];
		if (inputs.length){
			inputs.each(function(input){
				if (input.checked){
					var v = input.get("value");
					var t = input.get("showText");
					value.push(v || "");
					text.push(t || v || "");
				}
			});
		}
		if (!value.length) value = [""];
		if (!text.length) text = [""];
		return {"value": value, "text": text};
	},
    //getData: function(){
		//var inputs = this.node.getElements("input");
		//var value = [];
		//if (inputs.length){
		//	inputs.each(function(input){
		//		if (input.checked){
		//			var v = input.get("value");
		//			if (v) value.push(v || "");
		//		}
		//	});
		//}
		//return (value.length==1) ? value[0] : value;
    //},
    isEmpty: function(){
        var data = this.getData();
        if( typeOf(data) !== "array" )return true;
        if( data.length === 0 )return true;
        return false;
    },
    getInputData: function(){
        if (this.readonly || this.json.isReadonly ){
            return this._getBusinessData();
        }else{
            var inputs = this.node.getElements("input");
            var value = [];
            if (inputs.length){
                inputs.each(function(input){
                    if (input.checked){
                        var v = input.get("value");
                        if (v) value.push(v || "");
                    }
                });
            }
            return (value.length) ? value : [];
        }
    },
    resetData: function(){
        this.setData(this.getValue());
    },
    /**当参数为Promise的时候，请查看文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}
     * @summary 为字段赋值，并且使值对应的选项选中。
     *  @param data{String|Promise} .
     *  @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     *  @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  field.setData( promise );
     */
    setData: function(data){
	    return this._setValue(data, "__setData");
        // if (data && data.isAG){
        //     this.moduleValueAG = data;
        //     data.addResolve(function(v){
        //         this.setData(v);
        //     }.bind(this));
        // }else{
        //     this.__setData(data);
        //     this.moduleValueAG = null;
        // }
    },

    __setData: function(data){
        this._setBusinessData(data);

		var inputs = this.node.getElements("input");
		if (inputs.length){
			inputs.each(function(input){
				if (typeOf(data)=="array"){
					if (data.indexOf(input.get("value"))!=-1){
						input.set("checked", true);
					}else{
						input.set("checked", false);
					}
				}else{
					if (data == input.get("value")){
						input.set("checked", true);
					}else{
						input.set("checked", false);
					}
				}
			});
            this.validationMode();
		}
        this.fireEvent("setData");
	},

    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("background", this.node.getStyles("background"));
            this.node.setStyle("background", "#ffdcdc");

            this.errNode = this.createErrorNode(text);
            if (this.iconNode){
                this.errNode.inject(this.iconNode, "after");
            }else{
                this.errNode.inject(this.node, "after");
            }
            this.showNotValidationMode(this.node);

            if (!this.node.isIntoView()) this.node.scrollIntoView();
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("background"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status==="all") ? true: (routeName === data.decision);
        if (flag){
            var n = this.getInputData();
            if( typeOf(n)==="array" && n.length === 0 )n = "";
            var v = (data.valueType==="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatagridPC", null, false);
MWF.xDesktop.requireApp("process.Xform", "DatagridMobile", null, false);
//if (COMMON.Browser.Platform.isMobile){
if (layout.mobile || COMMON.Browser.Platform.isMobile){
    MWF.xApplication.process.Xform.Datagrid = MWF.APPDatagrid = MWF.xApplication.process.Xform.DatagridMobile;
    MWF.xApplication.process.Xform.Datagrid$Title = MWF.APPDatagrid$Title = MWF.xApplication.process.Xform.DatagridMobile$Title;
    MWF.xApplication.process.Xform.Datagrid$Data = MWF.APPDatagrid$Data = MWF.xApplication.process.Xform.DatagridMobile$Data;
}else{
    MWF.xApplication.process.Xform.Datagrid = MWF.APPDatagrid = MWF.xApplication.process.Xform.DatagridPC;
    MWF.xApplication.process.Xform.Datagrid$Title = MWF.APPDatagrid$Title = MWF.xApplication.process.Xform.DatagridPC$Title;
    MWF.xApplication.process.Xform.Datagrid$Data = MWF.APPDatagrid$Data = MWF.xApplication.process.Xform.DatagridPC$Data;
}

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Htmleditor HTML编辑器。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var htmlEditor = this.form.get("name"); //获取组件
 * //方法2
 * var htmlEditor = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Htmleditor = MWF.APPHtmleditor =  new Class(
    /** @lends MWF.xApplication.process.Xform.Htmleditor# */
    {
	Extends: MWF.APP$Module,
    options: {
        "moduleEvents": ["load", "postLoad", "afterLoad"]
    },
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },
    load: function(){

        if (this.fireEvent("queryLoad")){
            this._queryLoaded();
            this._loadUserInterface();
            this._loadStyles();
            //this._loadEvents();

            this._afterLoaded();
            this.fireEvent("postLoad");
            this.fireEvent("load");
        }
    },

	_loadUserInterface: function(){
		this.node.empty();
        if (this.readonly){
            this.node.set("html", this._getBusinessData());
            this.node.setStyles({
                "-webkit-user-select": "text",
                "-moz-user-select": "text"
            });
            //移动端设置图片宽度为100%
            if( layout.mobile ){
                this.node.getElements("img").each( function( img ){
                    //if( img.height )img.erase("height");
                    img.setStyles({
                        "height": "auto",
                        "max-width" : "100%"
                    });
                }.bind(this))
            }
        }else{
            var config = Object.clone(this.json.editorProperties);
            if (this.json.config){
                if (this.json.config.code){
                    var obj = this.form.Macro.exec(this.json.config.code, this);
                    Object.each(obj, function(v, k){
                        config[k] = v;
                    });
                }
            }
            this.loadCkeditor(config);
        }
    //    this._loadValue();
	},
    loadCkeditor: function(config){
        COMMON.AjaxModule.loadDom("ckeditor", function(){
            CKEDITOR.disableAutoInline = true;
            var editorDiv = new Element("div").inject(this.node);
            var htmlData = this._getBusinessData();
            if (htmlData){
                editorDiv.set("html", htmlData);
            }else if (this.json.templateCode){
                editorDiv.set("html", this.json.templateCode);
            }
            var height = this.node.getSize().y;
            var editorConfig = config || {};

            if (this.form.json.mode==="Mobile"){
                if (!editorConfig.toolbar && !editorConfig.toolbarGroups){
                    editorConfig.toolbar = [
                        { name: 'paragraph',   items: [ 'Bold', 'Italic', "-" , 'TextColor', "BGColor", 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', "-", 'Undo', 'Redo' ] },
                        { name: 'basicstyles', items: [ 'Styles', 'FontSize']},
                        { name: 'insert', items : [ 'Image' ] }
                    ];
                }
            }

            editorConfig.base64Encode = (this.json.base64Encode === "y");
            editorConfig.localImageMaxWidth = 800;
            editorConfig.reference = this.form.businessData.work.job;
            editorConfig.referenceType = "processPlatformJob";
            if( editorConfig && editorConfig.extraPlugins ){
                var extraPlugins = editorConfig.extraPlugins;
                extraPlugins = typeOf( extraPlugins ) === "array" ? extraPlugins : extraPlugins.split(",");
                extraPlugins.push( 'pagebreak' );
                editorConfig.extraPlugins = extraPlugins;
            }else{
                editorConfig.extraPlugins = ['pagebreak'];
            }
            
            // CKEDITOR.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/";
            // CKEDITOR.plugins.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/plugins/";
            this.editor = CKEDITOR.replace(editorDiv, editorConfig);

            this.editor.addCommand("ecnet", {
                exec:function(editor){
                    this.ecnet();
                }.bind(this)
            });
            this.editor.ui.add('ecnet', CKEDITOR.UI_BUTTON, {
                label:MWF.xApplication.process.Xform.LP.intelligentCorrection,
                icon: '../x_component_process_Xform/$Form/default/icon/ecnet.png',
                command:"ecnet"
            });

            this._loadEvents();
            //this.editor.on("loaded", function(){
            //    this._loadEvents();
            //}.bind(this));

            //this.setData(data)

            this.editor.on("change", function(){
                //this._setBusinessData(this.getData());
            }.bind(this));

            if (this.json.ecnet==="y"){
                // this.editor.on( "key", function( evt ) {
                //     // var char = evt.data.domEvent.$.char;
                //     // if ([".", ",", "?", ";", "'", " "].indexOf(char)!==-1){
                //     //     this.ecnet(evt.editor.getData());
                //     // }
                // }.bind(this));
                // this.editor.on("blur", function(){
                //     if (!this.notEcnetFlag) this.ecnet(this.getData());
                // }.bind(this));
            }


            //    this._loadEvents();
        }.bind(this));
    },
    getEcnetString: function(node, nodes){
        for (var i=0; i<node.childNodes.length; i++){
            if (node.childNodes[i].nodeType===Node.TEXT_NODE){
                var s = this.ecnetString.length;
                this.ecnetString += node.childNodes[i].nodeValue;
                var e = this.ecnetString.length;

                nodes.push({
                    "pnode": node,
                    "node": node.childNodes[i],
                    "start": s, "end": e
                });
            }else{
                this.getEcnetString(node.childNodes[i], nodes);
            }
        }
    },
    createEcnetNode: function(node){
        var newNode = node.node.ownerDocument.createElement("span");

        var increment = 0;
        var html = node.node.nodeValue;;
        node.ecnets.each(function(ecnet){
            var s = ecnet.begin+increment-node.start;
            var e = ecnet.end+increment-node.start;
            if (s<0) s=0;
            if (e>node.end+increment) e = node.end+increment;
            var length = html.length;

            var left = html.substring(0, s);
            var ecnetStr = html.substring(s, e);
            var right = html.substring(e, html.length);

            html = left+"<span class='o2_ecnet_item' style='color: red'><u>"+ecnetStr+"</u></span>"+right;
            increment += (html.length-length);

        }.bind(this));
        newNode.innerHTML = html;
        node.pnode.replaceChild(newNode, node.node);
        node.pnode.textNode = node.node;
        node.pnode.ecnetNode = newNode;

        var _self = this;
        var editorFrame = this.editor.document.$.defaultView.frameElement;
        var spans = newNode.getElementsByTagName("span");
        if (spans.length){
            for (var i = 0; i<spans.length; i++){
                var span = spans[i];
                if (span.className==="o2_ecnet_item"){
                    var ecnetNode = new Element("div", {"styles": {
                        "border": "1px solid #999999",
                        "box-shadow": "0px 0px 5px #999999",
                        "background-color": "#ffffff",
                        "position": "fixed",
                        "display": "none"
                    }}).inject(editorFrame, "after");
                    var correctNode = new Element("div", {
                        "styles": {
                            "padding": "3px 10px",
                            "font-weight": "bold",
                            "font-size": "12px",
                            "cursor": "pointer"
                        },
                        "text": node.ecnets[i].origin+"->"+node.ecnets[i].correct,
                        "events": {
                            "mouseover": function(){this.setStyle("background-color", "#dddddd")},
                            "mouseout": function(){this.setStyle("background-color", "#ffffff")},
                            "mousedown": function(){
                                var ecnetNode = this.getParent();
                                var node = ecnetNode.node;
                                var item = ecnetNode.node.ecnets[ecnetNode.idx];
                                var textNode = node.node.ownerDocument.createTextNode(item.correct);
                                ecnetNode.span.parentNode.replaceChild(textNode, ecnetNode.span);
                                ecnetNode.destroy();
                                node.node.nodeValue = node.pnode.ecnetNode.innerText;

                                node.ecnets.erase(item);
                                if (!node.ecnets.length){
                                    _self.ecnetNodes.erase(node);
                                }
                            }
                        }
                    }).inject(ecnetNode);
                    var ignoreNode = new Element("div", {
                        "styles": {
                            "padding": "3px 10px",
                            "font-size": "12px",
                            "cursor": "pointer"
                        },
                        "text": MWF.xApplication.process.Xform.LP.ignore,
                        "events": {
                            "mouseover": function(){this.setStyle("background-color", "#dddddd")},
                            "mouseout": function(){this.setStyle("background-color", "#ffffff")},
                            "mousedown": function(){
                                var ecnetNode = this.getParent();
                                var node = ecnetNode.node;
                                var item = ecnetNode.node.ecnets[ecnetNode.idx];
                                var textNode = node.node.ownerDocument.createTextNode(ecnetNode.span.innerText);
                                ecnetNode.span.parentNode.replaceChild(textNode, ecnetNode.span);
                                ecnetNode.destroy();
                                node.node.nodeValue = node.pnode.ecnetNode.innerText;

                                node.ecnets.erase(item);
                                if (!node.ecnets.length){
                                    _self.ecnetNodes.erase(node);
                                }
                            }
                        }
                    }).inject(ecnetNode);
                    ecnetNode.node = node;
                    ecnetNode.idx = i;

                    span.ecnetNode = ecnetNode;
                    ecnetNode.span = span;
                    span.addEventListener("click", function(){
                        var ecnetNode = this.ecnetNode;
                        ecnetNode.show();
                        var y = this.offsetTop;
                        var x = this.offsetLeft;
                        var w = this.offsetWidth;
                        var h = this.offsetHeight;
                        var p = editorFrame.getPosition();
                        var s = ecnetNode.getSize();
                        var top = y+p.y+h+5;
                        var left = x+p.x-((s.x-w)/2);

                        ecnetNode.style.left = ""+left+"px";
                        ecnetNode.style.top = ""+top+"px";

                        var _span = this;
                        var hideEcnetNode = function(){
                            ecnetNode.hide();
                            _span.ownerDocument.removeEventListener("mousedown", hideEcnetNode);
                        };
                        this.ownerDocument.addEventListener("mousedown", hideEcnetNode);

                    });

                }
            }
        }

        //node.pnode.ecnetInforNode = ecnetNode;

        // var spans = newNode.getElementsByTagName("span");
        // if (spans.length){
        //     var span = spans[0];
        //     span.addEventListener("click", function(){
        //         ecnetNode.style.display = "block";
        //         var y = span.offsetTop;
        //         var x = span.offsetLeft;
        //         var w = span.offsetWidth;
        //         var h = span.offsetHeight;
        //         var p = editorFrame.getPosition();
        //         var s = ecnetNode.getSize();
        //         var top = y+p.y+h+5;
        //         var left = x+p.x-((s.x-w)/2);
        //
        //         ecnetNode.style.left = ""+left+"px";
        //         ecnetNode.style.top = ""+top+"px";
        //     });
        //     span.addEventListener("mouseout", function(){});
        // }

    },
    clearEcnetNodes: function(){
        if (this.ecnetNodes && this.ecnetNodes.length){
            this.ecnetNodes.each(function(node){
                if (node.pnode.ecnetNode){
                    if (node.pnode.ecnetInforNode) node.pnode.ecnetInforNode.destroy();
                    node.pnode.ecnetInforNode = null;
                    node.pnode.replaceChild(node.pnode.textNode, node.pnode.ecnetNode);
                }
            }.bind(this));
            this.ecnetNodes = [];
        }
    },
    ecnet: function(data){
        //this.editor.document.$.body.innerText
        var editorFrame = this.editor.document.$.defaultView.frameElement;
        //var data = this.editor.getData();
        var body = this.editor.document.$.body;

        if (!this.ecnetNodes) this.ecnetNodes = [];
        if (this.ecnetNodes.length) this.clearEcnetNodes();

        var nodes = [];
        this.ecnetString = "";
        this.getEcnetString(body, nodes);

        MWF.Actions.get("x_general_assemble_control").ecnetCheck({"value": this.ecnetString}, function(json){
            if (json.data.itemList && json.data.itemList.length){

                nodes.each(function(node){
                    var items = [];
                    json.data.itemList.each(function(item){
                        if ((node.end<=item.end && node.end>item.begin) || (node.start>=item.begin && node.start<item.end) || (node.start<=item.begin && node.end>item.end)){
                            items.push(item);
                        }
                    }.bind(this));
                    if (items.length){
                        node.ecnets = items;
                        this.ecnetNodes.push(node);
                    }
                }.bind(this));


                this.ecnetNodes.each(function(node){
                    this.createEcnetNode(node);
                }.bind(this));


                // var item = json.data.itemList[0];
                // var left = data.substring(0, item.begin);
                // var ecnetStr = data.substring(item.begin, item.end);
                // var right = data.substring(item.end, data.length);
                //
                // var newData = left+"<span class='o2_ecnet_item' style='color:red' title='"+item.origin+"->"+item.correc+"'><u>"+ecnetStr+"</u></span>"+right;
                //this.editor.document.$.body.setSelectionRange(item.begin, item.end);
                //this.editor.setData(newData);

                // var iframe = editorFrame.clone();
                // iframe.inject(this.node);
                // iframe.position({
                //     "relativeTo": editorFrame,
                //     "position": 'upperLeft',
                //     "edge": 'upperLeft'
                // });
                // iframe.contentWindow.document.body.set("html", newData);
            }else{
                body = null;
                nodes = null;
            }
        }.bind(this));
    },
    _loadEvents: function(editorConfig){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                this.editor.on(key, function(event){
                    return this.form.Macro.fire(e.code, this, event);
                }.bind(this), this);
            }
        }.bind(this));

    },
    addModuleEvent: function(key, fun){
        this.editor.on(key, function(event){
            return (fun) ? fun(this, event) : null;
        }.bind(this), this);
    },
    _loadValue: function(){
        var data = this._getBusinessData();
    },
    /**
     * @summary 重置组件的值为默认值或置空。
     *  @example
     * this.form.get('fieldId').resetData();
     */
    resetData: function(){
        this.setData(this._getBusinessData());
    },
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('HTML编辑器不能为空', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
        return !this.getData().trim();
    },
    /**
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId]获取值，但是this.form.get('fieldId')无法获取到组件。
     * @summary 获取组件值。
     * @example
     * var data = this.form.get('fieldId').getData();
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  var data;
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      data = this.form.get('fieldId').getData();
     *  }else{
     *      data = this.data['fieldId']; //直接从数据中获取字段值
     *  }
     * @return 组件的数据.
     */
    getData: function(){
        this.clearEcnetNodes();
        return this.editor ? this.editor.getData() : "";
    },
    /**
     * 当表单上没有对应组件的时候，可以使用this.data[fieldId] = data赋值。
     * @summary 为组件赋值。
     * @param data{String} .
     * @example
     *  this.form.get("fieldId").setData("test"); //赋文本值
     * @example
     *  //如果无法确定表单上是否有组件，需要判断
     *  if( this.form.get('fieldId') ){ //判断表单是否有无对应组件
     *      this.form.get('fieldId').setData( data );
     *  }else{
     *      this.data['fieldId'] = data;
     *  }
     */
    setData: function(data){
        this._setBusinessData(data);
        if (this.editor) this.editor.setData(data);
    },
    createErrorNode: function(text){
        var node = new Element("div");
        var iconNode = new Element("div", {
            "styles": {
                "width": "20px",
                "height": "20px",
                "float": "left",
                "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "line-height": "20px",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
            if (!this.node.isIntoView()) this.node.scrollIntoView();
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },

    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validation() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validation: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;

        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";

        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }
}); 
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Label 文本组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var label = this.form.get("name"); //获取组件
 * //方法2
 * var label = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Label = MWF.APPLabel =  new Class(
    /** @lends MWF.xApplication.process.Xform.Label# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
	
	_loadUserInterface: function(){
		if (this.json.valueType == "text"){
			this.node.set("text", this.json.text || "");
		}
		if (this.json.valueType == "script"){
			var code = (this.json.script) ? this.json.script.code : "";
			if (code){
			    var value = this.form.Macro.exec(code, this);
			    this._setNodeText(value);
				//this.node.set("text", this.form.Macro.exec(code, this) || "");
			} 
		}
		if (this.json.prefixIcon || this.json.suffixIcon){
            var text = this.node.get("text");
            this.node.empty();

            var tNode = new Element("div", {"styles": {
            	"margin-left": (this.json.prefixIcon) ? "20px" : "0px",
                "margin-right": (this.json.suffixIcon) ? "20px" : "0px",
                "height": "100%"
			}, "text": text}).inject(this.node);

            if (this.json.prefixIcon){
                var node = new Element("div", {"styles": {
                    "float": "left",
                    "width": "20px",
                    "height": ""+this.node.getSize().y+"px",
                    "background": "url("+this.json.prefixIcon+") center center no-repeat"
                }}).inject(tNode, "before");
            }
            if (this.json.suffixIcon){
                var node = new Element("div", {"styles": {
                    "float": "right",
                    "width": "20px",
                    "height": ""+this.node.getSize().y+"px",
                    "background": "url("+this.json.suffixIcon+") center center no-repeat"
                }}).inject(tNode, "before");
            }
		}
	},
    _setNodeText: function(value){
        if (value && value.isAG){
            value.addResolve(function(v){
                this._setNodeText(v);
            }.bind(this));
        }else{
            o2.promiseAll(value).then(function(v){
                this.node.set("text", v || "");
            }.bind(this), function(){});
            //this.node.set("text", value || "");
        }
    },
    /**当参数为Promise的时候，请参考文档: {@link  https://www.yuque.com/o2oa/ixsnyt/ws07m0|使用Promise处理表单异步}<br/>
     * @summary 为组件设置文本，该文本不会被保存到后台。
     * @param text{String|Promise} .
     * @example
     *  this.form.get("fieldId").setText("test"); //赋文本值
     * @example
     *  //使用Promise
     *  var field = this.form.get("fieldId");
     *  var dict = new this.Dict("test"); //test为数据字典名称
     *  var promise = dict.get("tools", true); //异步使用数据字典的get方法时返回Promise，参数true表示异步
     *  field.setText( promise );
     */
    setText: function(text){
	    if (!!text){
            o2.promiseAll(text).then(function(v){
                this.node.set("text", v || "");
            }.bind(this), function(){});
        }else{
            this.node.set("text", v || "");
        }
        //this.node.set("text", text);
    }
});

MWF.xDesktop.requireApp("process.Xform", "Textfield", null, false);
/** @class Number 数字输入组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("name"); //获取组件
 * //方法2
 * var field = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.Textfield
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Number = MWF.APPNumber =  new Class({
    Implements: [Events],
    Extends: MWF.APPTextfield,
    iconStyle: "numberIcon",
    isEmpty : function(){
        return !this.getData();
    },
    getInputData: function(){
        if (this.node.getFirst()){
            var v = this.node.getElement("input").get("value");
            var n = v.toFloat();
            return (isNaN(n)) ? 0 : n;
        }else{
            return this._getBusinessData();
        }
        return v;
    },
    // getInputData: function(){
    //     var n = this.node.getElement("input").get("value").toFloat();
    //     if ((isNaN(n))) {this.setData('0')};
    //     return (isNaN(n)) ? 0 : n;
    // },

    formatNumber: function(str){
        var v = str.toFloat();
        if (v){
            if (this.json.decimals && (this.json.decimals!="*")){

                var decimals = this.json.decimals.toInt();

                var p = Math.pow(10,decimals);
                var f_x = Math.round(v*p)/p;
                str = f_x.toString();

                if (decimals>0){
                    var pos_decimal = str.indexOf('.');
                    if (pos_decimal < 0){
                        pos_decimal = str.length;
                        str += '.';
                    }
                    decimalStr = (str).substr(pos_decimal+1, (str).length);
                    while (decimalStr.length < decimals){
                        str += '0';
                        decimalStr += 0;
                    }
                }
            }
        }
        return str;
    },

    validationFormat: function(){
debugger;
        if( !this.node.getElement("input") )return true;
        var n = this.node.getElement("input").get("value");
        if (isNaN(n)) {
            this.notValidationMode(MWF.xApplication.process.Xform.LP.notValidation_number);
            return false;
        }

        this.node.getFirst().set("value", this.formatNumber(n));

        // var v = n.toFloat();
        // if (v){
        //     if (this.json.decimals && (this.json.decimals!="*")){
        //
        //         var decimals = this.json.decimals.toInt();
        //
        //         var p = Math.pow(10,decimals);
        //         var f_x = Math.round(v*p)/p;
        //         var s_x = f_x.toString();
        //
        //         if (decimals>0){
        //             var pos_decimal = s_x.indexOf('.');
        //             if (pos_decimal < 0){
        //                 pos_decimal = s_x.length;
        //                 s_x += '.';
        //             }
        //             decimalStr = (s_x).substr(pos_decimal+1, (s_x).length);
        //             while (decimalStr.length < decimals){
        //                 s_x += '0';
        //                 decimalStr += 0;
        //             }
        //         }
        //
        //         this.node.getFirst().set("value", s_x);
        //     }
        // }
        return true;
    },
    validationConfigItem: function(routeName, data){

        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getInputData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v && v.toString()!=='0'){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },

    validation: function(routeName, opinion){
        if (!this.readonly && !this.json.isReadonly){
            if (!this.validationFormat()) return false;
            if (!this.validationConfig(routeName, opinion)) return false;

            if (!this.json.validation) return true;
            if (!this.json.validation.code) return true;
            this.currentRouteName = routeName;
            var flag = this.form.Macro.exec(this.json.validation.code, this);
            this.currentRouteName = "";
            if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
            if (flag.toString() != "true") {
                this.notValidationMode(flag);
                return false;
            }
        }
        return true;
    },

    _resetNodeEdit: function(){
        var input = new Element("input", {
            "styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            }
        });

        var node = new Element("div", {"styles": {
                "overflow": "hidden",
                "position": "relative",
                "margin-right": "20px",
                "padding-right": "4px"
            }}).inject(this.node, "after");
        input.inject(node);

        this.node.destroy();
        this.node = node;
    },

    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);

        this.node.set({
            "id": this.json.id,
            "MWFType": this.json.type,
            "events": {
                "click": this.clickSelect.bind(this)
            }
        });
        if (this.json.showIcon!='no' && !this.form.json.hideModuleIcon) {
            this.iconNode = new Element("div", {
                "styles": this.form.css[this.iconStyle]
            }).inject(this.node, "before");
        }else if( this.form.json.nodeStyleWithhideModuleIcon ){
            this.node.setStyles(this.form.json.nodeStyleWithhideModuleIcon)
        }

        this.node.getFirst().addEvent("change", function(){
            this.validationMode();
            if (this.validation()) {
                this._setBusinessData(this.getInputData("change"));
                this.fireEvent("change");
            }
        }.bind(this));

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
    },
    _computeValue: function(value){
        return (this.json.defaultValue && this.json.defaultValue.code) ? this.form.Macro.exec(this.json.defaultValue.code, this): (value || "0");
    },
    getValue: function(){
        if (this.moduleValueAG) return this.moduleValueAG;
        var value = this._getBusinessData();
        if (!value) value = this._computeValue();
        value = this.formatNumber(value);
        return value || "0";
    },
    __setValue: function(value){
        this._setBusinessData(value);
        if (this.node.getFirst()) this.node.getFirst().set("value", value || "0");
        if (this.readonly || this.json.isReadonly) this.node.set("text", value);
        this.moduleValueAG = null;
        return value;
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Common 通用组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var el = this.form.get("name"); //获取组件
 * //方法2
 * var el = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Common = MWF.APPCommon =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        if (this.json.innerHTML){
            var nodes = this.node.childNodes;
            for (var i=0; i<nodes.length; i++){
                if (nodes[i].nodeType===Node.ELEMENT_NODE){
                    if (!nodes[i].get("MWFtype")){
                        nodes[i].destroy();
                        i--;
                    }
                }else{
                    if (nodes[i].removeNode){
                        nodes[i].removeNode();
                    }else{
                        nodes[i].parentNode.removeChild(nodes[i]);
                    }
                    i--;
                    //nodes[i]
                }
            }
            this.node.appendHTML(this.json.innerHTML);

            // if (this.node.get("html") !== this.json.innerHTML){
            //this.node.appendHTML(this.json.innerHTML);
            // }
        }
        this.node.setProperties(this.json.properties);
    }
});
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Image 图片。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var img = this.form.get("name"); //获取组件
 * //方法2
 * var img = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Image = MWF.APPImage =  new Class(
    {
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        if (this.json.properties && this.json.properties["src"]){
            var value = this.json.properties["src"];
            if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1)){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                if (value.indexOf("/x_cms_assemble_control")!==-1){
                    value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }else if (value.indexOf("x_cms_assemble_control")!==-1){
                    value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
                }
                value = o2.filterUrl(value);
            }
            try{
                this.node.set("src", value);
            }catch(e){}
        }else if (this.json.srcfile && this.json.srcfile!="none"){
            value = this.json.srcfile;
            if (typeOf(value)==="object"){
                var url = (value.portal) ? MWF.xDesktop.getPortalFileUr(value.id, value.portal) : MWF.xDesktop.getProcessFileUr(value.id, value.application);
                url = o2.filterUrl(url);
                this.node.set("src", url);
            }else{
                var host = MWF.Actions.getHost("x_portal_assemble_surface");
                var action = MWF.Actions.get("x_portal_assemble_surface");
                var uri = action.action.actions.readFile.uri;
                uri = uri.replace("{flag}", value);
                uri = uri.replace("{applicationFlag}", this.form.json.application);
                value = host+"/x_portal_assemble_surface"+uri;
                value = o2.filterUrl(value);
                this.node.set("src", value);
            }
        }else if (typeOf(this.json.src)=="object"){
            var src = MWF.xDesktop.getImageSrc( this.json.src.imageId );
            this.node.set("src", src);
        }
    },
    reset: function(){
        this._loadUserInterface();
    }
});
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class ImageClipper 图片编辑组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var imageClipper = this.form.get("name"); //获取组件
 * //方法2
 * var imageClipper = this.target; //在组件事件脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.ImageClipper = MWF.APPImageClipper =  new Class(
    /** @lends MWF.xApplication.process.Xform.ImageClipper# */
    {
	Implements: [Events],
	Extends: MWF.APP$Module,
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },
    _loadUserInterface: function(){
	    debugger;
        this.field = true;
        this.node.empty();
        var data = this._getBusinessData();
        if( data ){
            var img = new Element("img",{
                src : MWF.xDesktop.getImageSrc( data )
            });
            if (layout.mobile || COMMON.Browser.Platform.isMobile) {
                img.setStyles({
                    "max-width": "90%"
                })
            }else if( this.json.clipperType == "size" ){
                var width = this.json.imageWidth.toInt();
                var height = this.json.imageHeight.toInt();
                if( width && height ){
                    img.setStyles({
                        width : width+"px",
                        height : height+"px"
                    })
                }
            }
            img.inject( this.node );
        }
        if( this.readonly || this.json.isReadonly )return;

        var divBottom = new Element("div").inject( this.node );
        var button = new Element("button").inject(divBottom);
        button.set({
			//"id": this.json.id,
			"text": this.json.name || this.json.id,
			"styles": this.form.css.buttonStyles,
			"MWFType": this.json.type
        });
        button.addEvent("click", function(){
            this.validationMode();
            var d = this._getBusinessData();
            if (layout.mobile){
                o2.imageClipperCallback = function( str ){
                    var data = JSON.parse( str );
                    this.setData( data ? data.fileId : "" );
                    this.validation();
                    o2.imageClipperCallback = null;
                }.bind(this);
                // 兼容cms编辑表单
                var referencetype = "processPlatformJob";
                if(this.form.businessData.work && this.form.businessData.work.referencetype) {
                    referencetype = this.form.businessData.work.referencetype
                }
                var jsonString = JSON.stringify({
                    "mwfId" : this.json.id,
                    "callback" : "o2.imageClipperCallback",
                    "referencetype": referencetype,
                    "reference": this.form.businessData.work.job
                });
                if( window.o2android && window.o2android.uploadImage2FileStorage ){
                    window.o2android.uploadImage2FileStorage(jsonString)
                }else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.uploadImage2FileStorage){
                    window.webkit.messageHandlers.uploadImage2FileStorage.postMessage(jsonString);
                }else {
                    this.selectImage( d, function(data){
                        this.setData( data ? data.id : "" );
                        this.validation();
                    }.bind(this));
                }
            }else{
                this.selectImage( d, function(data){
                    this.setData( data ? data.id : "" );
                    this.validation();
                }.bind(this));
            }
        }.bind(this));
	},
    getTextData : function(){
        var value = this._getBusinessData() || "";
        return {"value": [value], "text": [value]};
    },
    /**
     * @summary 判断组件值是否为空.
     * @example
     * if( this.form.get('fieldId').isEmpty() ){
     *     this.form.notice('请上传图片', 'warn');
     * }
     * @return {Boolean} 值是否为空.
     */
    isEmpty : function(){
        return !this.getData();
    },
    /**
     * 获取上传的图片ID。
     * @summary 获取上传的图片ID。
     * @example
     * var id = this.form.get('fieldId').getData(); //获取上传的图片id
     * var url = MWF.xDesktop.getImageSrc( id ); //获取图片的url
     */
    getData: function( data ){
        return this._getBusinessData() || "";
    },
    setData: function( data ){
        this._setBusinessData(data);
        var img = this.node.getElements("img");
        if( img && img.length )img.destroy();
        if( !data )return;
        var img = new Element("img",{
            src : MWF.xDesktop.getImageSrc( data )
        }).inject( this.node, "top" );
        if (layout.mobile || COMMON.Browser.Platform.isMobile) {
            img.setStyles({
                "max-width": "90%"
            })
        }else if( this.json.clipperType == "size" ){
            var width = this.json.imageWidth.toInt();
            var height = this.json.imageHeight.toInt();
            if (width && height) {
                img.setStyles({
                    width: width + "px",
                    height: height + "px"
                })
            }
        }
    },

    selectImage: function(d, callback){
        var clipperType = this.json.clipperType || "unrestricted";
        var ratio = 1;
        var description = "";
        var maxSize = 800;
        if( clipperType == "unrestricted" ){
            ratio = 0;
        }else if( clipperType == "size" ){
            var width = (this.json.imageWidth) ? this.json.imageWidth.toInt() : 600;
            var height = (this.json.imageHeight) ? this.json.imageHeight.toInt() : 500;
            ratio = width / height;
            maxSize = Math.max( width, height );
            if( !isNaN( width ) && !isNaN( height )  ){
                description = MWF.LP.widget.pictureSize.replace(/{width}/g, width).replace(/{height}/g, height);
            }
        }else if( clipperType == "ratio" ){
            ratio = this.json.imageRatio || 1;
            description = MWF.LP.widget.pictureRatio.replace(/{ratio}/g, ratio);
        }
        MWF.xDesktop.requireApp("process.Xform", "widget.ImageClipper", function(){
            this.imageClipper = new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app, {
                "style": "default",
                "aspectRatio" : ratio,
                "description" : description,
                "imageUrl" : d ? MWF.xDesktop.getImageSrc( d ) : "",
                "reference" : this.form.businessData.work.job,
                "referenceType": "processPlatformJob",
                "resultMaxSize" : maxSize,
                "onChange" : function(){
                    callback( { src : this.imageClipper.imageSrc, id : this.imageClipper.imageId } );
                }.bind(this)
            });
            this.imageClipper.load();
        }.bind(this));
    },
    createErrorNode: function(text){
        var node = new Element("div");
        var iconNode = new Element("div", {
            "styles": {
                "width": "20px",
                "height": "20px",
                "float": "left",
                "background": "url("+"../x_component_process_Xform/$Form/default/icon/error.png) center center no-repeat"
            }
        }).inject(node);
        var textNode = new Element("div", {
            "styles": {
                "line-height": "20px",
                "margin-left": "20px",
                "color": "red",
                "word-break": "keep-all"
            },
            "text": text
        }).inject(node);
        return node;
    },
    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("borderStyle", this.node.getStyles("border-left", "border-right", "border-top", "border-bottom"));
            this.node.setStyle("border", "1px solid red");

            this.errNode = this.createErrorNode(text).inject(this.node, "after");
            this.showNotValidationMode(this.node);
            if (!this.node.isIntoView()) this.node.scrollIntoView();
        }
    },
    showNotValidationMode: function(node){
        var p = node.getParent("div");
        if (p){
            if (p.get("MWFtype") == "tab$Content"){
                if (p.getParent("div").getStyle("display")=="none"){
                    var contentAreaNode = p.getParent("div").getParent("div");
                    var tabAreaNode = contentAreaNode.getPrevious("div");
                    var idx = contentAreaNode.getChildren().indexOf(p.getParent("div"));
                    var tabNode = tabAreaNode.getLast().getFirst().getChildren()[idx];
                    tabNode.click();
                    p = tabAreaNode.getParent("div");
                }
            }
            this.showNotValidationMode(p);
        }
    },
    validationMode: function(){
        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("borderStyle"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == data.decision);
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    },
    validationConfig: function(routeName, opinion){
        if (this.json.validationConfig){
            if (this.json.validationConfig.length){
                for (var i=0; i<this.json.validationConfig.length; i++) {
                    var data = this.json.validationConfig[i];
                    if (!this.validationConfigItem(routeName, data)) return false;
                }
            }
            return true;
        }
        return true;
    },
    /**
     * @summary 根据组件的校验设置进行校验。
     *  @param {String} [routeName] - 可选，路由名称.
     *  @example
     *  if( !this.form.get('fieldId').validation() ){
     *      return false;
     *  }
     *  @return {Boolean} 是否通过校验
     */
    validation: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (!this.json.validation) return true;
        if (!this.json.validation.code) return true;
        this.currentRouteName = routeName;
        var flag = this.form.Macro.exec(this.json.validation.code, this);
        this.currentRouteName = "";
        if (!flag) flag = MWF.xApplication.process.Xform.LP.notValidation;
        if (flag.toString()!="true"){
            this.notValidationMode(flag);
            return false;
        }
        return true;
    }
	
}); 
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xApplication.process.Xform.Html = MWF.APPHtml =  new Class({
    Extends: MWF.APP$Module,
    load: function(){
        this.node.insertAdjacentHTML("beforebegin", this.json.text);
        this.node.destroy();
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
MWF.require("MWF.widget.UUID", null, false);
/** @class Radio 单选按钮。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Radio = MWF.APPRadio =  new Class(
    /** @lends MWF.xApplication.process.Xform.Radio# */
    {
	Implements: [Events],
	Extends: MWF.APP$Input,
    /**
     * @ignore
     * @member {Element} descriptionNode
     * @memberOf MWF.xApplication.process.Xform.Radio#
     */
    loadDescription: function(){},
    _loadNode: function(){
        if (this.readonly || this.json.isReadonly ){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
        var radioValues = this.getOptions();
        var value = this.getValue();
        if (value){
            var texts = "";
            for (var i=0; i<radioValues.length; i++){
                var item = radioValues[i];
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                // if (value.indexOf(v)!=-1){
                //     texts = t;
                //     break;
                // }
                if (value == v){
                    texts = t;
                    break;
                }
            }
            this.node.set("text", texts);
        }
    },
    _resetNodeEdit: function(){
        var div = new Element("div");
        div.set(this.json.properties);
        div.inject(this.node, "after");

        this.node.destroy();
        this.node = div;
    },
    _loadNodeEdit: function(){
		//this.container = new Element("select");
        if (!this.json.preprocessing) this._resetNodeEdit();

		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"styles": {
				"display": "inline"
			}
		});
		this.setOptions();
	},
    _loadDomEvents: function(){
    },
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!=-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    //this.node.addEvent(key, function(event){
                    //    return this.form.Macro.fire(e.code, this, event);
                    //}.bind(this));
                }
            }
        }.bind(this));
    },
    addModuleEvent: function(key, fun){
        if (this.options.moduleEvents.indexOf(key)!==-1){
            this.addEvent(key, function(event){
                return (fun) ? fun(this, event) : null;
            }.bind(this));
        }else{
            var inputs = this.node.getElements("input");
            inputs.each(function(input){
                input.addEvent(key, function(event){
                    return (fun) ? fun(this, event) : null;
                }.bind(this));
            }.bind(this));
        }
    },
    /**
     * @summary 刷新选择项，如果选择项是脚本，重新计算。
     * @example
     * this.form.get('fieldId').resetOption();
     */
    resetOption: function(){
        this.node.empty();
        this.setOptions();
    },
        /**
         * @summary 获取选择项。
         * @return {Array} 返回选择项数组，如果使用选择项脚本，根据脚本返回决定，如：<pre><code class='language-js'>[
         *  "女|female",
         *  "男|male"
         * ]</code></pre>
         * @example
         * this.form.get('fieldId').getOptions();
         */
	getOptions: function(){
		if (this.json.itemType == "values"){
			return this.json.itemValues;
		}else{
			return this.form.Macro.exec(this.json.itemScript.code, this);
		}
		return [];
	},

    /**
     * @summary 获取整理后的选择项。
     * @return {Object} 返回整理后的选择项，如：
     * <pre><code class='language-js'>{"valueList": ["","female","male"], "textList": ["","女","男"]}
     * </code></pre>
     * @example
     * var optionData = this.form.get('fieldId').getOptionsObj();
     */
    getOptionsObj : function(){
        var textList = [];
        var valueList = [];
        var optionItems = this.getOptions();
        if (!optionItems) optionItems = [];
        if (o2.typeOf(optionItems)==="array"){
            optionItems.each(function(item){
                var tmps = item.split("|");
                textList.push( tmps[0] );
                valueList.push( tmps[1] || tmps[0] );
            }.bind(this));
        }
        return { textList : textList, valueList : valueList };
    },

    setOptions: function(){
        var optionItems = this.getOptions();
        this._setOptions(optionItems);
    },

	_setOptions: function(optionItems){
        var p = o2.promiseAll(optionItems).then(function(radioValues){
            this.moduleSelectAG = null;

            if (!radioValues) radioValues = [];
            if (o2.typeOf(radioValues)==="array"){
                var flag = (new MWF.widget.UUID).toString();
                radioValues.each(function(item){
                    var tmps = item.split("|");
                    var text = tmps[0];
                    var value = tmps[1] || text;

                    var radio = new Element("input", {
                        "type": "radio",
                        "name": (this.json.properties && this.json.properties.name) ? this.json.properties.name : flag+this.json.id,
                        "value": value,
                        "showText": text,
                        "styles": this.json.buttonStyles
                    }).inject(this.node);
                    //radio.appendText(text, "after");

                    var textNode = new Element( "span", {
                        "text" : text,
                        "styles" : { "cursor" : "default" }
                    }).inject(this.node);
                    textNode.addEvent("click", function( ev ){
                        if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
                        this.radio.checked = true;
                        this.radio.fireEvent("change");
                        this.radio.fireEvent("click");
                    }.bind( {radio : radio} ) );

                    radio.addEvent("click", function(){
                        this.validationMode();
                        if (this.validation()) {
                            this._setBusinessData(this.getInputData("change"));
                            this.fireEvent("change");
                        }
                    }.bind(this));

                    Object.each(this.json.events, function(e, key){
                        if (e.code){
                            if (this.options.moduleEvents.indexOf(key)!=-1){
                            }else{
                                radio.addEvent(key, function(event){
                                    return this.form.Macro.fire(e.code, this, event);
                                }.bind(this));
                            }
                        }
                    }.bind(this));
                }.bind(this));
            }
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));
        this.moduleSelectAG = p;
        if (p) p.then(function(){
            this.moduleSelectAG = null;
        }.bind(this), function(){
            this.moduleSelectAG = null;
        }.bind(this));

        // this.moduleSelectAG = o2.AG.all(optionItems).then(function(radioValues){
        //     this.moduleSelectAG = null;
        //
        //     if (!radioValues) radioValues = [];
        //     if (o2.typeOf(radioValues)==="array"){
        //         var flag = (new MWF.widget.UUID).toString();
        //         radioValues.each(function(item){
        //             var tmps = item.split("|");
        //             var text = tmps[0];
        //             var value = tmps[1] || text;
        //
        //             var radio = new Element("input", {
        //                 "type": "radio",
        //                 "name": (this.json.properties && this.json.properties.name) ? this.json.properties.name : flag+this.json.id,
        //                 "value": value,
        //                 "showText": text,
        //                 "styles": this.json.buttonStyles
        //             }).inject(this.node);
        //             //radio.appendText(text, "after");
        //
        //             var textNode = new Element( "span", {
        //                 "text" : text,
        //                 "styles" : { "cursor" : "default" }
        //             }).inject(this.node);
        //             textNode.addEvent("click", function( ev ){
        //                 if( this.radio.get("disabled") === true || this.radio.get("disabled") === "true" )return;
        //                 this.radio.checked = true;
        //                 this.radio.fireEvent("change");
        //                 this.radio.fireEvent("click");
        //             }.bind( {radio : radio} ) );
        //
        //             radio.addEvent("click", function(){
        //                 this.validationMode();
        //                 if (this.validation()) this._setBusinessData(this.getInputData("change"));
        //             }.bind(this));
        //
        //             Object.each(this.json.events, function(e, key){
        //                 if (e.code){
        //                     if (this.options.moduleEvents.indexOf(key)!=-1){
        //                     }else{
        //                         radio.addEvent(key, function(event){
        //                             return this.form.Macro.fire(e.code, this, event);
        //                         }.bind(this));
        //                     }
        //                 }
        //             }.bind(this));
        //         }.bind(this));
        //     }
        // }.bind(this))
        // if (this.moduleSelectAG) this.moduleSelectAG.then(function(){
        //     this.moduleSelectAG = null;
        // }.bind(this));
	},

    _setValue: function(value, m){
        var mothed = m || "__setValue";
	    if (!!value){
            var p = o2.promiseAll(value).then(function(v){
                if (o2.typeOf(v)=="array") v = v[0];
                if (this.moduleSelectAG){
                    this.moduleValueAG = this.moduleSelectAG;
                    this.moduleSelectAG.then(function(){
                        this[mothed](v);
                        return v;
                    }.bind(this), function(){});
                }else{
                    this[mothed](v)
                }
                return v;
            }.bind(this), function(){});

            this.moduleValueAG = p;
            if (this.moduleValueAG) this.moduleValueAG.then(function(){
                this.moduleValueAG = null;
            }.bind(this), function(){
                this.moduleValueAG = null;
            }.bind(this));
        }else{
            this[mothed](value);
        }


        // this.moduleValueAG = o2.AG.all(value).then(function(v){
        //     if (o2.typeOf(v)=="array") v = v[0];
        //     if (this.moduleSelectAG){
        //         this.moduleValueAG = this.moduleSelectAG;
        //         this.moduleSelectAG.then(function(){
        //             this.__setValue(v);
        //         }.bind(this));
        //     }else{
        //         this.__setValue(v)
        //     }
        //     return v;
        // }.bind(this));
        //
        // if (this.moduleValueAG) this.moduleValueAG.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));
    },

    __setValue: function(value){
        this._setBusinessData(value);
		var radios = this.node.getElements("input");
		for (var i=0; i<radios.length; i++){
			var radio = radios[i];
			if (radio.value==value){
				radio.checked = true;
				break;
			}
		}
	},
    /**
     * @summary 获取选中项的value和text。
     * @return {Object} 返回选中项的value和text，如：
     * <pre><code class='language-js'>{"value": ["male"], "text": ["男"]}
     * {"value": [""], "text": [""]}
     * </code></pre>
     * @example
     * var data = this.form.get('fieldId').getTextData();
     * var text = data.text[0] //获取选中项的文本
     */
	getTextData: function(){
		var inputs = this.node.getElements("input");
		var value = "";
		var text = "";
		if (inputs.length){
			for (var i=0; i<inputs.length; i++){
				var input = inputs[i];
				if (input.checked){
					value = input.get("value");
					text = input.get("showText");
					break;
				}
			}
		}
		return {"value": [value] || "", "text": [text || value || ""]};
	},
    getInputData: function(){
        if (this.readonly || this.json.isReadonly ){
            return this._getBusinessData();
        }else{
            var inputs = this.node.getElements("input");
            var value = "";
            if (inputs.length){
                for (var i=0; i<inputs.length; i++){
                    var input = inputs[i];
                    if (input.checked){
                        value = input.get("value");
                        break;
                    }
                }
            }
            return value;
        }
	},
    resetData: function(){
        this.setData(this.getValue());
    },

    /**
     * @summary 获取选中的Dom对象。
     * @return {Element} 返回选中的Dom对象
     * @example
     * var input = this.form.get('fieldId').getSelectedInput();
     */
    getSelectedInput: function(){
        var inputs = this.node.getElements("input");
        if (inputs.length){
            for (var i=0; i<inputs.length; i++){
                if (inputs[i].checked) return inputs[i];
            }
        }
        return null;
    },

    setData: function(data){
        return this._setValue(data, "__setData");
        // if (data && data.isAG){
        //     this.moduleValueAG = o2.AG.all(data).then(function(v){
        //         if (o2.typeOf(v)=="array") v = v[0];
        //         this.__setData(v);
        //     }.bind(this));
        // }else{
        //     this.__setData(data);
        // }

        // if (data && data.isAG){
        //     this.moduleValueAG = data;
        //     data.addResolve(function(v){
        //         this.setData(v);
        //     }.bind(this));
        // }else{
        //     this.__setData(data);
        //     this.moduleValueAG = null;
        // }
    },

    __setData: function(data){
        this._setBusinessData(data);
		var inputs = this.node.getElements("input");
		
		if (inputs.length){
			for (var i=0; i<inputs.length; i++){
				if (data==inputs[i].get("value")){
					inputs[i].set("checked", true);
				}else{
					inputs[i].set("checked", false);
				}
			}
            this.validationMode();
		}
        this.fireEvent("setData");
	},

    notValidationMode: function(text){
        if (!this.isNotValidationMode){
            this.isNotValidationMode = true;
            this.node.store("background", this.node.getStyles("background"));
            this.node.setStyle("background", "#ffdcdc");

            this.errNode = this.createErrorNode(text);
            if (this.iconNode){
                this.errNode.inject(this.iconNode, "after");
            }else{
                this.errNode.inject(this.node, "after");
            }
            this.showNotValidationMode(this.node);

            if (!this.node.isIntoView()) this.node.scrollIntoView();
        }
    },

    validationMode: function(routeName, opinion){
        if (!this.validationConfig(routeName, opinion))  return false;

        if (this.isNotValidationMode){
            this.isNotValidationMode = false;
            this.node.setStyles(this.node.retrieve("background"));
            if (this.errNode){
                this.errNode.destroy();
                this.errNode = null;
            }
        }
    }
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Select 下拉选择组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Select = MWF.APPSelect =  new Class(
	/** @lends MWF.xApplication.process.Xform.Select# */
	{
	Implements: [Events],
	Extends: MWF.APP$Input,
	iconStyle: "selectIcon",

	/**
	 * @ignore
	 * @member {Element} descriptionNode
	 * @memberOf MWF.xApplication.process.Xform.Select#
	 */
    initialize: function(node, json, form, options){
        this.node = $(node);
        this.node.store("module", this);
        this.json = json;
        this.form = form;
        this.field = true;
    },
    _loadNode: function(){
        if (this.readonly|| this.json.isReadonly){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
		this.node.set({
			"nodeId": this.json.id,
			"MWFType": this.json.type
		});
        var optionItems = this.getOptions();
        var value = this.getValue();
        if (value){
            if (typeOf(value)!=="array") value = [value];
            var texts = [];
            optionItems.each(function(item){
                var tmps = item.split("|");
                var t = tmps[0];
                var v = tmps[1] || t;

                if (v){

                    if (value.indexOf(v)!=-1){
                        texts.push(t);
                    }
                }

            });
            this.node.set("text", texts.join(", "));
        }
    },
	_loadDomEvents: function(){
		Object.each(this.json.events, function(e, key){
			if (e.code){
				if (this.options.moduleEvents.indexOf(key)===-1){
					this.node.addEvent(key, function(event){
						return this.form.Macro.fire(e.code, this, event);
					}.bind(this));
				}
			}
		}.bind(this));
	},
    _loadEvents: function(){
        Object.each(this.json.events, function(e, key){
            if (e.code){
                if (this.options.moduleEvents.indexOf(key)!=-1){
                    this.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }else{
                    this.node.addEvent(key, function(event){
                        return this.form.Macro.fire(e.code, this, event);
                    }.bind(this));
                }
            }
        }.bind(this));
    },
	addModuleEvent: function(key, fun){
		if (this.options.moduleEvents.indexOf(key)!==-1){
			this.addEvent(key, function(event){
				return (fun) ? fun(this, event) : null;
			}.bind(this));
		}else{
			this.node.addEvent(key, function(event){
				return (fun) ? fun(this, event) : null;
			}.bind(this));
		}
	},
    _loadStyles: function(){
    	if (this.areaNode){
            if (this.json.styles) if (this.areaNode) this.areaNode.setStyles(this.json.styles);
            if (this.json.inputStyles) this.node.setStyles(this.json.inputStyles);
		}else{
            if (this.json.styles) this.node.setStyles(this.json.styles);
		}
    },
	_resetNodeEdit: function(){
		this.node.empty();
		var select = new Element("select");
		select.set(this.json.properties);
		select.inject(this.node);
	},
    _loadNodeEdit: function(){
		if (!this.json.preprocessing) this._resetNodeEdit();

		var select = this.node.getFirst();
		this.areaNode = this.node;
		this.node = select;

		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type,
			"styles": {
				"margin-right": "12px"
			}
		});
		
		this.setOptions();
        this.node.addEvent("change", function(){
			var v = this.getInputData("change");
			this._setBusinessData(v);
            this.validationMode();
            if (this.validation()) {
				this._setBusinessData(v);
				this.fireEvent("change");
			}
        }.bind(this));

	},
	/**
	 * @summary 刷新选择项，如果选择项是脚本，重新计算。
	 * @example
	 * this.form.get('fieldId').resetOption();
	 */
    resetOption: function(){
        this.node.empty();
        this.setOptions();
		this.fireEvent("resetOption")
    },
	/**
	 * @summary 获取选择项。
	 * @return {Array} 返回选择项数组，如果使用选择项脚本，根据脚本返回决定，如：<pre><code class='language-js'>[
	 *  "女|female",
	 *  "男|male"
	 * ]</code></pre>
	 * @example
	 * this.form.get('fieldId').getOptions();
	 */
	getOptions: function(){
		if (this.json.itemType == "values"){
			return this.json.itemValues;
		}else{
			return this.form.Macro.exec(((this.json.itemScript) ? this.json.itemScript.code : ""), this);
		}
		return [];
	},

	/**
	 * @summary 获取整理后的选择项。
	 * @return {Object} 返回整理后的选择项，如：
	 * <pre><code class='language-js'>{"valueList": ["","female","male"], "textList": ["","女","男"]}
	 * </code></pre>
	 * @example
	 * var optionData = this.form.get('fieldId').getOptionsObj();
	 */
	getOptionsObj : function(){
		var textList = [];
		var valueList = [];
		var optionItems = this.getOptions();
		if (!optionItems) optionItems = [];
		if (o2.typeOf(optionItems)==="array"){
			optionItems.each(function(item){
				var tmps = item.split("|");
				textList.push( tmps[0] );
				valueList.push( tmps[1] || tmps[0] );
			}.bind(this));
		}
		return { textList : textList, valueList : valueList };
	},

	setOptions: function(){
		var optionItems = this.getOptions();
		this._setOptions(optionItems);
	},
	_setOptions: function(optionItems){
		var p = o2.promiseAll(optionItems).then(function(options){
			this.moduleSelectAG = null;
			if (!options) options = [];
			if (o2.typeOf(options)==="array"){
				options.each(function(item){
					var tmps = item.split("|");
					var text = tmps[0];
					var value = tmps[1] || text;

					var option = new Element("option", {
						"value": value,
						"text": text
					}).inject(this.node);
				}.bind(this));
				this.fireEvent("setOptions", [options])
			}
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));
		this.moduleSelectAG = p;
		if (p) p.then(function(){
			this.moduleSelectAG = null;
		}.bind(this), function(){
			this.moduleSelectAG = null;
		}.bind(this));

		// this.moduleSelectAG = o2.AG.all(optionItems).then(function(options){
		// 	this.moduleSelectAG = null;
		// 	if (!options) options = [];
		// 	if (o2.typeOf(options)==="array"){
		// 		options.each(function(item){
		// 			var tmps = item.split("|");
		// 			var text = tmps[0];
		// 			var value = tmps[1] || text;
		//
		// 			var option = new Element("option", {
		// 				"value": value,
		// 				"text": text
		// 			}).inject(this.node);
		// 		}.bind(this));
		// 		this.fireEvent("setOptions", [options])
		// 	}
		// }.bind(this));
		// if (this.moduleSelectAG) this.moduleSelectAG.then(function(){
		// 	this.moduleSelectAG = null;
		// }.bind(this));
	},
	// __setOptions: function(){
	// 	var optionItems = this.getOptions();
    //     if (!optionItems) optionItems = [];
    //     if (o2.typeOf(optionItems)==="array"){
	// 		optionItems.each(function(item){
	// 			var tmps = item.split("|");
	// 			var text = tmps[0];
	// 			var value = tmps[1] || text;
	//
	// 			var option = new Element("option", {
	// 				"value": value,
	// 				"text": text
	// 			}).inject(this.node);
	// 		}.bind(this));
	// 		this.fireEvent("setOptions", [optionItems])
	// 	}
	// },
	addOption: function(text, value){
        var option = new Element("option", {
            "value": value || text,
            "text": text
        }).inject(this.node);
		this.fireEvent("addOption", [text, value])
	},

	_setValue: function(value, m){
		var mothed = m || "__setValue";
		if (!!value){
			var p = o2.promiseAll(value).then(function(v){
				if (o2.typeOf(v)=="array") v = v[0];
				if (this.moduleSelectAG){
					this.moduleValueAG = this.moduleSelectAG;
					this.moduleSelectAG.then(function(){
						this[mothed](v);
						return v;
					}.bind(this), function(){});
				}else{
					this[mothed](v)
				}
				return v;
			}.bind(this), function(){});

			this.moduleValueAG = p;
			if (this.moduleValueAG) this.moduleValueAG.then(function(){
				this.moduleValueAG = null;
			}.bind(this), function(){
				this.moduleValueAG = null;
			}.bind(this));
		}else{
			this[mothed](value);
		}


		// this.moduleValueAG = o2.AG.all(value).then(function(v){
		// 	if (o2.typeOf(v)=="array") v = v[0];
		// 	if (this.moduleSelectAG){
		// 		this.moduleValueAG = this.moduleSelectAG;
		// 		this.moduleSelectAG.then(function(){
		// 			this.__setValue(v);
		// 		}.bind(this));
		// 	}else{
		// 		this.__setValue(v)
		// 	}
		// 	return v;
		// }.bind(this));

		// if (value && value.isAG){
		// 	this.moduleValueAG = o2.AG.all(value),then(function(v){
		// 		this._setValue(v);
		// 	}.bind(this));
		// 	// this.moduleValueAG = value;
		// 	// value.addResolve(function(v){
		// 	// 	this._setValue(v);
		// 	// }.bind(this));
		// }else{
		//
		// }
	},
	__setValue: function(value){
		if (!this.readonly && !this.json.isReadonly ) {
			this._setBusinessData(value);

			var ops = this.node.getElements("option");
			for (var i=0; i<ops.length; i++){
				var option = ops[i];
				if (option.value==value){
					option.selected = true;
					//	break;
				}else{
					option.selected = false;
				}
			}
		}
		this.moduleValueAG = null;
	},

	// _setValue: function(value){
	// 	if (!this.readonly && !this.json.isReadonly ) {
    //         this._setBusinessData(value);
    //         for (var i=0; i<this.node.options.length; i++){
    //             var option = this.node.options[i];
    //             if (option.value==value){
    //                 option.selected = true;
    //                 //	break;
    //             }else{
    //                 option.selected = false;
    //             }
    //         }
    //     }
	// 	//this.node.set("value", value);
	// },

	/**
	 * @summary 获取选中项的value和text。
	 * @return {Object} 返回选中项的value和text，如：
	 * <pre><code class='language-js'>{"value": ["male"], "text": ["男"]}
	 * {"value": [""], "text": [""]}
	 * </code></pre>
	 * @example
	 * var data = this.form.get('fieldId').getTextData();
	 * var text = data.text[0] //获取选中项的文本
	 */
	getTextData: function(){
		var value = [];
		var text = [];
		if (this.readonly|| this.json.isReadonly){
			var ops = this.getOptionsObj();
			var data = this._getBusinessData();
			var d = typeOf(data) === "array" ? data : [data];
			d.each( function (v) {
				var idx = ops.valueList.indexOf( v );
				value.push( v || "" );
				text.push( idx > -1 ? ops.textList[idx] : (v || "") );
			});
		}else{
			var ops = this.node.getElements("option");
			ops.each(function(op){
				if (op.selected){
					var v = op.get("value");
					var t = op.get("text");
					value.push(v || "");
					text.push(t || v || "");
				}
			});
		}
		if (!value.length) value = [""];
		if (!text.length) text = [""];
		return {"value": value, "text": text};
	},
    getInputData: function(){
		if( this.readonly || this.json.isReadonly ){
			return this._getBusinessData();
		}else{
			var ops = this.node.getElements("option");
			var value = [];
			ops.each(function(op){
				if (op.selected){
					var v = op.get("value");
					if (v) value.push(v);
				}
			});
			if (!value.length) return null;
			return (value.length==1) ? value[0] : value;
		}
	},
    resetData: function(){

        this.setData(this.getValue());
    },

	setData: function(data){
		return this._setValue(data, "__setData");
		// if (data && data.isAG){
		// 	this.moduleValueAG = o2.AG.all(data).then(function(v){
		// 		if (o2.typeOf(v)=="array") v = v[0];
		// 		this.__setData(v);
		// 	}.bind(this));
		// }else{
		// 	this.__setData(data);
		// }
		// if (data && data.isAG){
		// 	this.moduleValueAG = data;
		// 	data.addResolve(function(v){
		// 		this.setData(v);
		// 	}.bind(this));
		// }else{
		// 	this.__setData(data);
		// 	this.moduleValueAG = null;
		// }
	},

	__setData: function(data){
        this._setBusinessData(data);
		if (this.readonly|| this.json.isReadonly){
			var d = typeOf(data) === "array" ? data : [data];
			var ops = this.getOptionsObj();
			var result = [];
			d.each( function (v) {
				var idx = ops.valueList.indexOf( v );
				result.push( idx > -1 ? ops.textList[idx] : v);
			})
			this.node.set("text", result.join(","));
		}else{
			var ops = this.node.getElements("option");
			ops.each(function(op){
				if (typeOf(data)=="array"){
					if (data.indexOf(op.get("value"))!=-1){
						op.set("selected", true);
					}else{
						op.set("selected", false);
					}
				}else{
					if (data == op.get("value")){
						op.set("selected", true);
					}else{
						op.set("selected", false);
					}
				}
			});
			this.validationMode();
		}
		this.fireEvent("setData", [data]);
	}
	
}); 

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.require("MWF.widget.Tab", null, false);
/** @class Tab 分页组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var tab = this.form.get("fieldId"); //获取组件
 * //方法2
 * var tab = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Tab = MWF.APPTab =  new Class(
    /** @lends MWF.xApplication.process.Xform.Tab# */
{
	Extends: MWF.APP$Module,

	_loadUserInterface: function(){
        this.elements = [];
        this.containers = [];

        var style = "form";
        if (layout.mobile) style = "mobileForm";

        /**
         * @summary tab组件，平台使用该组件实现分页组件的功能
         * @member {MWF.widget.Tab}
         * @example
         *  //可以在脚本中获取该组件
         * var tab = this.form.get("fieldId").tab; //获取组件对象
         * var pages = tab.pages //获取每个分页
         * pages[1].addEvent("queryShow", function(){
         *     //添加显示分页前事件
         * })
         * pages[1].addEvent("postShow", function(){
         *     //添加显示分页后事件
         * })
         * pages[1]._showTab(); //显示第2个分页
         */
		this.tab = new MWF.widget.Tab(this.node, {"style": style});
		
		this._setTabWidgetStyles();

		this.tab.tabNodeContainer = this.node.getFirst("div");
		this.tab.contentNodeContainer = this.tab.tabNodeContainer.getNext("div");

		var lastNode = this.tab.tabNodeContainer.getLast();
		var tabs;
		if (lastNode && lastNode.hasClass("tabNodeContainerLeft")){
            this.tab.tabNodeContainerRight = this.tab.tabNodeContainer.getFirst();
            this.tab.tabNodeContainerLeft = lastNode;
            this.tab.tabNodeContainerArea = lastNode.getFirst();

            var menuNode = this.node.getElement(".MWFMenu");
            if (menuNode) menuNode.destroy();
            this.tab.load();
            tabs = this.tab.tabNodeContainerArea.getChildren("div");
        }else{
            tabs = this.tab.tabNodeContainer.getChildren("div");
            this.tab.load();
        }

		var contents = this.tab.contentNodeContainer.getChildren("div");
		tabs.each(function(tab, idx){
			this.tab.rebuildTab(contents[idx], contents[idx].getFirst(), tab);
		}.bind(this));
		
		this.tab.pages[0]._showTab();
        this.loadSubModule();
	},
    loadSubModule: function(){
        this.tab.pages.each(function(page){
            var node = page.tabNode;
            var json = this.form._getDomjson(node);
            var tab = this;
            var module = this.form._loadModule(json, node, function(){
                this.tab = tab;
            });
            this.elements.push(module);
            this.form.modules.push(module);

            if (page.isShow){
                this.showContentModule.call(page, this);
            }else{
                if (this.json.isDelay){
                    var _self = this;
                    page.showContentModuleFun = function(){_self.showContentModule.call(page, _self)};
                    page.addEvent("show", page.showContentModuleFun);
                }else{
                    this.showContentModule.call(page, this);
                }
            }
        }.bind(this));
    },
    showContentModule: function(_self){
        var node = this.contentNode;
        node.isLoadModule = true;
        json = _self.form._getDomjson(node);
        tab = _self;
        module = _self.form._loadModule(json, node, function(){
            this.tab = tab;
        });
        _self.containers.push(module);
        _self.form.modules.push(module);

        if (this.showContentModuleFun) this.removeEvent("show", this.showContentModuleFun);
    },

	_setTabWidgetStyles: function(){
        if (this.json.tabNodeContainer) this.tab.css.tabNodeContainer = Object.clone(this.json.tabNodeContainer);
        if (this.json.contentNodeContainer) this.tab.css.contentNodeContainer = Object.clone(this.json.contentNodeContainer);
		this.tab.css.tabNode = Object.clone(this.json.tabStyles);
		this.tab.css.tabTextNode = Object.clone(this.json.tabTextStyles);
		this.tab.css.tabNodeCurrent = Object.clone(this.json.tabCurrentStyles);
		this.tab.css.tabTextNodeCurrent = Object.clone(this.json.tabTextCurrentStyles);
	}
});
MWF.xApplication.process.Xform.tab$Page = MWF.APPTab$Page =  new Class({
    Extends: MWF.APP$Module
});
MWF.xApplication.process.Xform.tab$Content = MWF.APPTab$Content =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        this.form._loadModules(this.node);
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
/** @class Table 表格组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var table = this.form.get("fieldId"); //获取组件
 * //方法2
 * var table = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Table = MWF.APPTable =  new Class(
    /** @lends MWF.xApplication.process.Xform.Table# */
{
	Extends: MWF.APP$Module,
	_afterLoaded: function(){
        /**
         * @summary table，DOM对象
         * @member {Element} table
         * @memberOf MWF.xApplication.process.Xform.Table#
         * @example
         *  //可以在脚本中获取该组件
         * var table = this.form.get("fieldId").table; //获取组件对象
         */
        if (!this.table) this.table = this.node.getElement("table");
		//var tds = this.node.getElements("td");
		var rows = this.table.rows;
		for (var i=0; i<rows.length; i++){
		    var row = rows[i];
            for (var j=0; j<row.cells.length; j++){
                var td = row.cells[j];

                var json = this.form._getDomjson(td);
                if (json){
                    var table = this;
                    var module = this.form._loadModule(json, td, function(){
                        this.table = table;
                    });
                }


                this.form.modules.push(module);
            }
        }

        // this.table.rows.each(function(row){
        //     row.cells.each(function(td){
        //         var json = this.form._getDomjson(td);
        //         var table = this;
        //         var module = this.form._loadModule(json, td, function(){
        //             this.table = table;
        //         });
        //
        //         this.form.modules.push(module);
        //     }.bind(this));
        // }.bind(this));


		// tds.each(function(td){
		// 	var json = this.form._getDomjson(td);
         //    var table = this;
		// 	var module = this.form._loadModule(json, td, function(){
         //        this.table = table;
         //    });
        //
		// 	this.form.modules.push(module);
		// }.bind(this));
	},
    _loadBorderStyle: function(){
        if (this.json.styles && this.json.styles.border){
            if (!this.table) this.table = this.node.getElement("table");
            if( this.json.styles["table-layout"] ){
                this.table.setStyle("table-layout",this.json.styles["table-layout"]);
            }
            this.table.set("cellspacing", "0");
            this.table.setStyles({
                "border-top": this.json.styles.border,
                "border-left": this.json.styles.border
            });
            var ths = this.table.getElements("th");
            ths.setStyles({
                "border-bottom": this.json.styles.border,
                "border-right": this.json.styles.border
            });
            var tds = this.table.getElements("td");
            tds.setStyles({
                "border-bottom": this.json.styles.border,
                "border-right": this.json.styles.border,
                //"background": "transparent"
            });
        }
    },
    _loadStyles: function(){
        Object.each(this.json.styles, function(value, key){
            var reg = /^border\w*/ig;
            if (!key.test(reg)){
                this.node.setStyle(key, value);
            }
        }.bind(this));
        if (this.form.json["$version"]!=="5.2") this._loadBorderStyle();
    }
});
/** @class Table$Td 单元格组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var td = this.form.get("fieldId"); //获取组件
 * //方法2
 * var td = this.target; //在组件本身的脚本中获取
 * @extends MWF.xApplication.process.Xform.$Module
 * @o2category FormComponents
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Table$Td = MWF.APPTable$Td =  new Class({
	Extends: MWF.APP$Module,
    _queryLoaded: function(){

    },
    _afterLoaded: function(){
        //this.form._loadModules(this.node);
    },
    _loadStyles: function(){

        var addStyles = {};
        if (this.json.cellType=="title"){
            addStyles = this.table.json.titleTdStyles;
        }
        if (this.json.cellType=="content"){
            addStyles = this.table.json.contentTdStyles;
        }
        if (this.json.cellType=="layout"){
            addStyles = this.table.json.layoutTdStyles;
        }
        Object.each(addStyles, function(value, key){
            if ((value.indexOf("x_processplatform_assemble_surface")!==-1 || value.indexOf("x_portal_assemble_surface")!==-1)){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                value = o2.filterUrl(value);
                this.node.setStyle(key, value);
            }else{
                if (!this.json.preprocessing) this.node.setStyle(key, value);
            }

        }.bind(this));

        Object.each(this.json.styles, function(value, key){
            if ((value.indexOf("x_processplatform_assemble_surface")!==-1 || value.indexOf("x_portal_assemble_surface")!==-1)){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
                value = o2.filterUrl(value);
            }
            this.node.setStyle(key, value);
        }.bind(this));

        if (this.json.cellType=="content"){
            this.form.addEvent("postLoad", function(){
                var inputs = this.node.getElements("input");
                inputs.each(function(input){
                    var inputType = input.get("type").toLowerCase();
                    if (inputType!="radio" && inputType!="checkbox" && inputType!="submit" && inputType!="buttom" && inputType!="image"){
                        input.setStyle("width", "100%");
                    }
                }.bind(this));
                var textareas = this.node.getElements("textarea");
                textareas.each(function(textarea){
                    textarea.setStyle("width", "100%");
                }.bind(this));

            }.bind(this))
        }
    }
});

MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);
/** @class Textarea 多行文本组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.$Input
 * @o2category FormComponents
 * @o2range {Process|CMS|Portal}
 * @hideconstructor
 */
MWF.xApplication.process.Xform.Textarea = MWF.APPTextarea =  new Class({
	Implements: [Events],
	Extends: MWF.APP$Input,
	
	_loadUserInterface: function(){
		this._loadNode();
        if (this.json.compute == "show"){
            this._setValue(this._computeValue());
        }else{
            this._loadValue();
        }
	},
    _loadNode: function(){
        if (this.readonly || this.json.isReadonly){
            this._loadNodeRead();
        }else{
            this._loadNodeEdit();
        }
    },
    _loadNodeRead: function(){
        this.node.empty();
        this.node.set({
            "nodeId": this.json.id,
            "MWFType": this.json.type
        });
    },


    _setValue: function(value){
	    if (!value) value = "";
        var p = o2.promiseAll(value).then(function(v){
            if (o2.typeOf(v)=="array") v = v[0];
            this._setBusinessData(v);
            if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
            if (this.readonly || this.json.isReadonly){
                var reg = new RegExp("\n","g");
                var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
                var reg3 = new RegExp("\u003e","g");
                var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
                this.node.set("html", text);
            }
            //this.__setValue(v);
        }.bind(this), function(){});
        this.moduleValueAG = p;
        p.then(function(){
            this.moduleValueAG = null;
        }.bind(this), function(){
            this.moduleValueAG = null;
        }.bind(this));

        // this.moduleValueAG = o2.AG.all(value).then(function(v){
        //     this.moduleValueAG = null;
        //     if (o2.typeOf(v)=="array") v = v[0];
        //     this._setBusinessData(v);
        //     if (this.node.getFirst()) this.node.getFirst().set("value", v || "");
        //     if (this.readonly || this.json.isReadonly){
        //         var reg = new RegExp("\n","g");
        //         var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
        //         var reg3 = new RegExp("\u003e","g");
        //         var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
        //         this.node.set("html", text);
        //     }
        // }.bind(this));
        //
        // if (this.moduleValueAG) this.moduleValueAG.then(function(){
        //     this.moduleValueAG = null;
        // }.bind(this));

        return value;

        // if (value && value.isAG){
        //     this.moduleValueAG = value;
        //     value.addResolve(function(v){
        //         this._setValue(v);
        //     }.bind(this));
        // }else{
        //     this._setBusinessData(value);
        //     if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
        //     if (this.readonly || this.json.isReadonly){
        //         var reg = new RegExp("\n","g");
        //         var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
        //         var reg3 = new RegExp("\u003e","g");
        //         var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
        //         this.node.set("html", text);
        //     }
        //     return value;
        // }
    },

    // _setValue: function(value){
    //     this._setBusinessData(value);
    //     if (this.node.getFirst()) this.node.getFirst().set("value", value || "");
    //     if (this.readonly || this.json.isReadonly){
    //             var reg = new RegExp("\n","g");
    //             var reg2 = new RegExp("\u003c","g"); //尖括号转义，否则内容会截断
    //             var reg3 = new RegExp("\u003e","g");
    //             var text = value.replace(reg2,"&lt").replace(reg3,"&gt").replace(reg,"<br/>");
    //             this.node.set("html", text);
    //     }
    // },
    _resetNodeEdit: function(){
        var input = new Element("textarea", {"styles": {
                "background": "transparent",
                "width": "100%",
                "border": "0px"
            }});
        var node = new Element("div", {"styles": {
                "ovwrflow": "hidden",
                "position": "relative",
                "padding-right": "2px"
            }}).inject(this.node, "after");
        input.inject(node);
        this.node.destroy();
        this.node = node;
    },
    _loadNodeEdit: function(){
        if (!this.json.preprocessing) this._resetNodeEdit();
        var input = this.node.getFirst();
        input.set(this.json.properties);

        if( this.form.json.textareaDisableResize )input.setStyle("resize","none");

		this.node.set({
			"id": this.json.id,
			"MWFType": this.json.type
		});
        this.node.addEvent("change", function(){
            this._setBusinessData(this.getInputData());
            this.fireEvent("change");
        }.bind(this));

        this.node.getFirst().addEvent("blur", function(){
            this.validation();
        }.bind(this));
        this.node.getFirst().addEvent("keyup", function(){
            this.validationMode();
        }.bind(this));
	},
	_afterLoaded: function(){
        if (!this.readonly){
            this.loadDescription();
        }
	},
    loadDescription: function(){
        if (this.readonly || this.json.isReadonly)return;
        var v = this._getBusinessData();
        if (!v){
            if (this.json.description){
                var size = this.node.getFirst().getSize();
                var w = size.x-3;
                if( this.json.showIcon!='no' && !this.form.json.hideModuleIcon ){
                    w = size.x-23;
                }
                this.descriptionNode = new Element("div", {"styles": this.form.css.descriptionNode, "text": this.json.description}).inject(this.node);
                this.descriptionNode.setStyles({
                    "width": ""+w+"px",
                    "height": ""+size.y+"px",
                    "line-height": ""+size.y+"px"
                });
                this.setDescriptionEvent();
            }
        }
    },
    setDescriptionEvent: function(){
        if (this.descriptionNode){
            if (COMMON.Browser.Platform.name==="ios"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }else if (COMMON.Browser.Platform.name==="android"){
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }else{
                this.descriptionNode.addEvents({
                    "click": function(){
                        this.descriptionNode.setStyle("display", "none");
                        this.node.getFirst().focus();
                    }.bind(this)
                });
            }
            this.node.getFirst().addEvents({
                "focus": function(){
                    this.descriptionNode.setStyle("display", "none");
                }.bind(this),
                "blur": function(){
                    if (!this.node.getFirst().get("value")) this.descriptionNode.setStyle("display", "block");
                }.bind(this)
            });
        }
    }
	
}); 

o2.widget.SimpleToolbar = new Class({
	Extends: o2.widget.Common,
	Implements: [Options, Events],
	options: {
		"style": "default"
	},
	initialize: function(container, options, bindObject){
		this.setOptions(options);
		this.bindObject = bindObject;

		this.items = [];
		this.children = [];
		this.childrenButton = [];
		this.childrenMenu = [];

		this.path = o2.session.path+"/widget/$SimpleToolbar/";
		this.cssPath = o2.session.path+"/widget/$SimpleToolbar/"+this.options.style+"/css.wcss";

		this._loadCss();

		this.node = $(container);
		this.node.onselectstart = function (){return false;};
		this.node.oncontextmenu = function (){return false;};

	},
	load: function(){
		if (this.fireEvent("queryLoad")){

			this.node.set("styles", this.css.container);

			this._loadToolbarItemNode();
			this._loadToolbarItems();
			this.fireEvent("postLoad");
		}
	},
	_loadToolbarItemNode: function(){
		var subNodes = this.node.getChildren();
		subNodes.each(function(node, idx){
			var type = node.get("MWFnodetype");
			if (type){
				if (typeOf(this[type])=="array"){
					this[type].push(node);
				}else{
					this[type] = [];
					this[type].push(node);
				}
			}
		}.bind(this));
	},
	_loadToolbarItems: function(){
		//this._loadToolBarSeparator(this.MWFToolBarSeparator);
		this._loadToolBarButton(this.MWFToolBarButton);
		//this._loadToolBarMenu(this.MWFToolBarMenu);
	},
	_loadToolBarButton: function(nodes){
		if (nodes) {
			nodes.each(function(node, idx){
				var btn =  new o2.widget.SimpleToolbarButton(node, this, this.options);
				btn.load();
				this.fireEvent("buttonLoad", [btn]);
				if (btn.buttonID){
					this.items[btn.buttonID] = btn;
				}
				this.children.push(btn);
				this.childrenButton.push(btn);
			}.bind(this));
		}
	}

});

o2.widget.SimpleToolbarButton = new Class({
	Implements: [Options, Events],
	options: {
		"text": "",
		"title": "",
		"pic": "",
		"pic_over": "",
		"action": "",
        "actionScript": "",
		"disable": false
	},
	initialize: function(node, toolbar, options){
		this.setOptions(options);
		this.node = $(node);
		this.toolbar = toolbar;
		this.buttonID = this.node.MWFnodeid || this.node.id;		

		if (!this.node){
			this.node = new Element("div").inject(this.toolbar.node);
		}else{
			var buttonText = this.node.get("MWFButtonText");
			if (buttonText) this.options.text = buttonText;
			
			var title = this.node.get("title");
			if (title) this.options.title = title;
			
			var buttonImage = this.node.get("MWFButtonImage");
			if (buttonImage) this.options.pic = buttonImage;

			var buttonImageOver = this.node.get("MWFButtonImageOver");
			if (buttonImageOver) this.options.pic_over = buttonImageOver;

			var buttonDisable = this.node.get("MWFButtonDisable");
			if (buttonDisable) this.options.disable = true;
			
			var buttonAction = this.node.get("MWFButtonAction");
			if (buttonAction) this.options.action = buttonAction;

            //var buttonActionScript = this.node.get("MWFButtonActionScript");
            //if (buttonActionScript) this.options.actionScript = buttonActionScript;
		}

		this.modifiyStyle = true;
	},
	load: function(){
		this._addButtonEvent();
		this.node.title = this.options.title;
		this.node.set("styles", this.toolbar.css.button);

		if (this.options.pic) this.picNode = this._createImageNode(this.options.pic);
		if (this.options.text) this.textNode = this._createTextNode(this.options.text);

		this.setDisable(this.options.disable);

	},
	enable: function(){
		if (this.options.disable){
			this.setDisable(false);
			this.options.disable = false;
		}
	},
	disable: function(){
		if (!this.options.disable){
			this.setDisable(true);
			this.options.disable = true;
		}
	},
	setDisable: function(flag){
		if (flag){
			this.node.set("styles", this.toolbar.css.buttonDisable);
			if (this.picNode){
				this.picNode.set("styles", this.toolbar.css.buttonImgDivDisable);
				var img = this.picNode.getElement("img");
				var src = img.get("src");
				var ext = src.substr(src.lastIndexOf("."), src.length);
				src = src.substr(0, src.lastIndexOf("."));
				src = src+"_gray"+ext;
				this.src_gray = src;
				img.set("src", src);
			}
			if (this.textNode) this.textNode.set("styles", this.toolbar.css.buttonTextDivDisable);
		}else{
			this.node.set("styles", this.toolbar.css.button);
			if (this.picNode){
				this.picNode.set("styles", this.toolbar.css.buttonImgDiv);
				var img = this.picNode.getElement("img");
				var src = img.get("src");
				src = src.replace("_gray", "");
				this.src_gray = src;
				img.set("src", src);
			}
			if (this.textNode) this.textNode.set("styles", this.toolbar.css.buttonTextDiv);
		}
	},
	_createImageNode: function(src){
		if (src){
			var div = new Element("span", {"styles": this.toolbar.css.buttonImgDiv}).inject(this.node);
			var img = this.img = new Element("img", {
				"styles": this.toolbar.css.buttonImg,
				"src": src
			}).inject(div);
			return div;
		}else{
			return null;
		}
	},
	_createTextNode: function(text){
		if (text){
			var div = new Element("span", {
				"styles": this.toolbar.css.buttonTextDiv,
				"text": text
			}).inject(this.node);
			return div;
		}else{
			return null;
		}
	},

	_addButtonEvent: function(){
		this.node.addEvent("mouseover", this._buttonMouseOver.bind(this));
		this.node.addEvent("mouseout", this._buttonMouseOut.bind(this));
		this.node.addEvent("mousedown", this._buttonMouseDown.bind(this));
		this.node.addEvent("mouseup", this._buttonMouseUp.bind(this));
		this.node.addEvent("click", this._buttonClick.bind(this));
	},
	_buttonMouseOver: function(){
		if (this.modifiyStyle) if (!this.options.disable){
			if(this.options.pic_over)this.img.set("src",this.options.pic_over)
			this.node.set("styles", this.toolbar.css.buttonOver);
		};
	},
	_buttonMouseOut: function(){
		if (this.modifiyStyle) if (!this.options.disable){
			this.img.set("src",this.options.pic)
			this.node.set("styles", this.toolbar.css.buttonOut);
		};
	},
	_buttonMouseDown: function(){
		if (this.modifiyStyle) if (!this.options.disable){this.node.set("styles", this.toolbar.css.buttonDown);};
	},
	_buttonMouseUp: function(){
		if (this.modifiyStyle) if (!this.options.disable){this.node.set("styles", this.toolbar.css.buttonUp);};
	},
	_buttonClick: function(e){
		if (!this.options.disable){
			if (this.options.action){
				var tmparr = this.options.action.split(":");
				var action = tmparr.shift();
				var bindObj = (this.toolbar.bindObject) ? this.toolbar.bindObject : window;

				if (bindObj[action]){
					tmparr.push(this);
                    tmparr.push(e);
					bindObj[action].apply(bindObj,tmparr);
				}else{
					if (window[action]){
						window[action].apply(this,tmparr);
					}
				}
			}
		}
	}
});
MWF.xDesktop.requireApp("process.Xform", "$Input", null, false);

if( !MWF.CMS$Input_Process ){
    MWF.CMS$Input_Process = {
        validationConfigItem : MWF.xApplication.process.Xform.$Input.prototype.validationConfigItem.$origin,
        _loadStyles : MWF.xApplication.process.Xform.$Input.prototype._loadStyles.$origin

    };

    MWF.xApplication.process.Xform.$Input.implement({
        _loadStyles: function(){
            //var isCMS = layout.desktop.currentApp.options.name.toLowerCase().contains("cms");
            var isCMS = this.form.app.options.name.toLowerCase().contains("cms");
            if( isCMS ){
                return this._loadStyles_CMS();
            }else{
                return this._loadStyles_Process();
            }
        },
        _loadStyles_Process : MWF.CMS$Input_Process._loadStyles,
        _loadStyles_CMS: function(){
            if (this.json.styles) this.node.setStyles(this.json.styles);
            if( this.readonly ){
                var parent = this.node.parentNode;
                if( parent.tagName.toLowerCase() == "td" ){
                    var border = parent.getStyle("borderBottomWidth");
                    if( border.toInt() > 0 ){
                        this.node.setStyle("border","0px");
                    }
                }
            }
            if (this.json.inputStyles) if (this.node.getFirst()) this.node.getFirst().setStyles(this.json.inputStyles);
            if (this.iconNode && this.iconNode.offsetParent !== null  ){
                var size = this.node.getSize();
                this.iconNode.setStyle("height", ""+size.y+"px");
            }
        },
        validationConfigItem: function(routeName, data){
            //var isCMS = layout.desktop.currentApp.options.name.toLowerCase().contains("cms");
            var isCMS = this.form.app.options.name.toLowerCase().contains("cms");
            if( isCMS ){
                return this.validationConfigItem_CMS( routeName, data );
            }else{
                return this.validationConfigItem_Process( routeName, data );
            }
        },
        validationConfigItem_Process : MWF.CMS$Input_Process.validationConfigItem,
        validationConfigItem_CMS: function(routeName, data){
            var flag = (data.status=="all") ? true: ( routeName == "publish");
            if (flag){
                var n = this.getInputData();
                var v = (data.valueType=="value") ? n : n.length;
                switch (data.operateor){
                    case "isnull":
                        if (!v){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notnull":
                        if (v){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "gt":
                        if (v>data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "lt":
                        if (v<data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "equal":
                        if (v==data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "neq":
                        if (v!=data.value){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "contain":
                        if (v.indexOf(data.value)!=-1){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                    case "notcontain":
                        if (v.indexOf(data.value)==-1){
                            this.notValidationMode(data.prompt);
                            return false;
                        }
                        break;
                }
            }
            return true;
        }
    });

}

MWF.xApplication.cms = MWF.xApplication.cms || {};
MWF.xApplication.cms.Xform = MWF.xApplication.cms.Xform || {};
MWF.xApplication.cms.Xform.ModuleImplements = {};
MWF.xApplication.process.Xform = MWF.xApplication.process.Xform || {};
MWF.xApplication.cms.Xform = MWF.xApplication.cms.Xform || {};
MWF.require("MWF.xScript.CMSMacro", null, false);
MWF.xDesktop.requireApp("process.Xform", "$Module", null, false);
MWF.xDesktop.requireApp("cms.Xform", "ModuleImplements", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Label", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Textfield", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Number", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Personfield", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Orgfield", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Readerfield", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Authorfield", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Calendar", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Textarea", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Select", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Radio", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Checkbox", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Button", null, false);

MWF.xDesktop.requireApp("process.Xform", "Div", null, false);
MWF.xApplication.cms.Xform.Div = MWF.CMSDiv = new Class({
	Extends: MWF.APPDiv
});

MWF.xDesktop.requireApp("process.Xform", "Common", null, false);
MWF.xApplication.cms.Xform.Common = MWF.CMSCommon =  new Class({
    Extends: MWF.APPCommon
});

//MWF.xApplication.cms.Xform.Image = MWF.CMSImage = new Class({
//	Extends: MWF.APPImage
//});

MWF.xDesktop.requireApp("process.Xform", "Image", null, false);
MWF.xApplication.cms.Xform.Image = MWF.CMSImage =  new Class({
    Extends: MWF.APP$Module,
    _loadUserInterface: function(){
        if (this.json.properties && this.json.properties["src"]){
            var value = this.json.properties["src"];
            if ((value.indexOf("x_processplatform_assemble_surface")!=-1 || value.indexOf("x_portal_assemble_surface")!=-1 || value.indexOf("x_cms_assemble_control")!=-1)){
                var host1 = MWF.Actions.getHost("x_processplatform_assemble_surface");
                var host2 = MWF.Actions.getHost("x_portal_assemble_surface");
				var host3 = MWF.Actions.getHost("x_cms_assemble_control");
                if (value.indexOf("/x_processplatform_assemble_surface")!==-1){
                    value = value.replace("/x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }else if (value.indexOf("x_processplatform_assemble_surface")!==-1){
                    value = value.replace("x_processplatform_assemble_surface", host1+"/x_processplatform_assemble_surface");
                }
                if (value.indexOf("/x_portal_assemble_surface")!==-1){
                    value = value.replace("/x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }else if (value.indexOf("x_portal_assemble_surface")!==-1){
                    value = value.replace("x_portal_assemble_surface", host2+"/x_portal_assemble_surface");
                }
				if (value.indexOf("/x_cms_assemble_control")!==-1){
					value = value.replace("/x_cms_assemble_control", host3+"/x_cms_assemble_control");
				}else if (value.indexOf("x_cms_assemble_control")!==-1){
					value = value.replace("x_cms_assemble_control", host3+"/x_cms_assemble_control");
				}
                value = o2.filterUrl(value);
            }
            try{
                this.node.set("src", value);
            }catch(e){}
        }else if (this.json.srcfile && this.json.srcfile!="none"){
            value = this.json.srcfile;
            if (typeOf(value)==="object"){
                var url = (value.portal) ? MWF.xDesktop.getPortalFileUr(value.id, value.portal) : MWF.xDesktop.getProcessFileUr(value.id, value.application);
                url = o2.filterUrl(url);
                this.node.set("src", url);
            }else{
                var host = MWF.Actions.getHost("x_portal_assemble_surface");
                var action = MWF.Actions.get("x_portal_assemble_surface");
                var uri = action.action.actions.readFile.uri;
                uri = uri.replace("{flag}", value);
                uri = uri.replace("{applicationFlag}", this.form.json.application);
                value = host+"/x_portal_assemble_surface"+uri;
                value = o2.filterUrl(value);
                this.node.set("src", value);
            }
        }else if (typeOf(this.json.src)=="object"){
            var src = MWF.xDesktop.getImageSrc( this.json.src.imageId );
            this.node.set("src", src);
        }
    }
});

//MWF.xDesktop.requireApp("cms.Xform", "ImageClipper", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Table", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Datagrid", null, false);

MWF.xDesktop.requireApp("process.Xform", "Html", null, false);
MWF.xApplication.cms.Xform.Html = MWF.CMSHtml =  new Class({
	Extends: MWF.APPHtml
});

//MWF.xDesktop.requireApp("cms.Xform", "Tab", null, false);

//MWF.xApplication.cms.Xform.tab$Page = MWF.CMSTab$Page = new Class({
//	Extends: MWF.APPTab$Page
//});
//MWF.xApplication.cms.Xform.tab$Content = MWF.CMSTab$Content = new Class({
//	Extends: MWF.APPTab$Content
//});

//MWF.xDesktop.requireApp("cms.Xform", "Tree", null, false);

//MWF.xDesktop.requireApp("cms.Xform", "Iframe", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Htmleditor", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Office", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Attachment", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Actionbar", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Log", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "View", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "ViewSelector", null, false);
//MWF.xDesktop.requireApp("cms.Xform", "Stat", null, false);

MWF.xApplication.cms.Xform.Package = {};
MWF.xApplication.cms = MWF.xApplication.cms || {};
MWF.xApplication.cms.Xform = MWF.xApplication.cms.Xform || {};

MWF.require("MWF.widget.Common", null, false);
// MWF.require("MWF.xAction.org.express.RestActions", null, false);
MWF.xDesktop.requireApp("Selector", "package", null, false);
MWF.xDesktop.requireApp("process.Xform", "Form", null, false);
MWF.require("MWF.widget.O2Identity", null, false);

MWF.xDesktop.requireApp("cms.Xform", "Package", null, false);

/** @class CMSForm 内容管理表单。
 * @o2category FormComponents
 * @o2range {CMS}
 * @alias CMSForm
 * @example
 * //可以在脚本中获取表单
 * //方法1：
 * var form = this.form.getApp().appForm; //获取表单
 * //方法2
 * var form = this.target; //在表单本身的事件脚本中获取
 * @hideconstructor
 */
MWF.xApplication.cms.Xform.Form = MWF.CMSForm = new Class(
    /** @lends CMSForm# */
{
    Implements: [Options, Events],
    Extends: MWF.APPForm,
    options: {
        "style": "default",
        "readonly": false,
        "cssPath": "",
        "autoSave": false,
        "saveOnClose": false,
        "showAttachment": true,
        "moduleEvents": [
             /**
             * 表单加载前触发。表单html已经就位。
             * @event CMSForm#queryLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "queryLoad",
             /**
             * 表单加载前触发。数据(businessData)已经就绪。
             * @event CMSForm#beforeLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeLoad",
            /**
             * 表单的所有组件加载前触发，此时表单的样式和js head已经加载。
             * @event CMSForm#beforeModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeModulesLoad",
            /**
             * 表单加载后触发。
             * @event CMSForm#postLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postLoad",
            /**
             * 表单的所有组件加载后触发。
             * @event CMSForm#afterModulesLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterModulesLoad",
            /**
             * 表单加载后触发。
             * @event CMSForm#afterLoad
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterLoad",
            /**
             * 保存前触发。
             * @event CMSForm#beforeSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeSave",
            /**
             * 数据已经整理完成，但还未保存到后台时触发。this.event指向整理完成的数据
             * @event CMSForm#afterSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postSave",
            /**
             * 数据保存到后台后触发。
             * @event CMSForm#afterSave
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterSave",
            /**
             * 关闭前触发。
             * @event CMSForm#beforeClose
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeClose",
            /**
             * 发布前触发。
             * @event CMSForm#beforePublish
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforePublish",
            /**
             * 数据已经整理完成，但还未调用服务发布触发。this.event指向整理完成的数据
             * @event CMSForm#postPublish
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "postPublish",
            /**
             * 执行后台服务发布后触发。
             * @event CMSForm#afterPublish
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterPublish",
            /**
             * 删除前触发。
             * @event CMSForm#beforeDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "beforeDelete",
            /**
             * 删除后触发。
             * @event CMSForm#afterDelete
             * @see {@link https://www.yuque.com/o2oa/ixsnyt/hm5uft#i0zTS|组件事件说明}
             */
            "afterDelete",
            "resize"
        ]
    },
    /**
     * @summary 获取表单的所有数据.
     * @method getData
     * @memberof CMSForm
     * @example
     * var data = this.form.getApp().appForm.getData();
     * @return {Object}
     */
    initialize: function (node, data, options) {
        this.setOptions(options);

        /**
         * @summary 表单容器
         * @see https://mootools.net/core/docs/1.6.0/Element/Element
         * @member {Element}
         * @example
         *  //可以在脚本中获取表单容器
         * var formContainer = this.form.getApp().appForm.container;
         */
        this.container = $(node);
        this.container.setStyle("-webkit-user-select", "text");
        this.data = data;

        /**
         * @summary 表单的配置信息，比如表单名称等等.
         * @member {Object}
         * @example
         *  //可以在脚本中获取表单配置信息
         * var json = this.form.getApp().appForm.json; //表单配置信息
         * var name = json.name; //表单名称
         */
        this.json = data.json;
        this.html = data.html;

        this.path = "../x_component_cms_Xform/$Form/";
        this.cssPath = this.options.cssPath || "../x_component_cms_Xform/$Form/" + this.options.style + "/css.wcss";
        this._loadCss();

        /**
         * @summary 表单中的所有组件数组.
         * @member {Array}
         * @example
         * //下面的样例对表单组件进行循环，并且判断是输入类型的组件
         * var modules = this.form.getApp().appForm.modules; //获取所有表单组件
         * for( var i=0; i<modules.length; i++ ){ //循环处理组件
         *   //获取组件的类型
            var moduleName = module.json.moduleName;
            if( !moduleName ){
                moduleName = typeOf(module.json.type) === "string" ? module.json.type.toLowerCase() : "";
            }
            if( ["calendar","combox","number","textfield"].contains( moduleName )){ //输入类型框
                //do something
             }
         * }
         */
        this.modules = [];

        /**
         * 该对象的key是组件标识，value是组件对象，可以使用该对象根据组件标识获取组件。<br/>
         * 需要注意的是，在子表单中嵌入不绑定数据的组件（比如div,common,button等等），系统允许重名。<br/>
         * 在打开表单的时候，系统会根据重名情况，自动在组件的标识后跟上 "_1", "_2"。
         * @summary 表单中的所有组件对象.
         * @member {Object}
         * @example
         * var moduleAll = this.form.getApp().appForm.all; //获取组件对象
         * var subjectField = moduleAll["subject"] //获取名称为subject的组件
         */
        this.all = {};
        this.forms = {};

        //if (!this.personActions) this.personActions = new MWF.xAction.org.express.RestActions();
    },
    load: function (callback) {
        if (this.app) {
            if (this.app.formNode) this.app.formNode.setStyles(this.json.styles);
            if (this.app.addEvent) this.app.addEvent("resize", function () {
                this.fireEvent("resize");
            }.bind(this))
        }
        //if (!this.businessData.control.allowSave) this.setOptions({"readonly": true});

        this.Macro = new MWF.CMSMacro.CMSFormContext(this);


        this.loadLanguage(function(flag) {
            if (flag && this.formDataText) {
                var data = o2.bindJson(this.formDataText, {"lp": MWF.xApplication.cms.Xform.LP.form});
                this.data = JSON.parse(data);

                this.json = this.data.json;
                this.html = this.data.html;
            }

            this.container.set("html", this.html);
            this.node = this.container.getFirst();

            this._loadEvents();
            this.loadRelatedScript();

            if (this.fireEvent("queryLoad")) {
                // MWF.xDesktop.requireApp("cms.Xform", "lp." + MWF.language, null, false);

                //		this.container.setStyles(this.css.container);
                this._loadBusinessData();
                this.fireEvent("beforeLoad");
                if (this.app) if (this.app.fireEvent) this.app.fireEvent("beforeLoad");

                this.loadContent(callback)
            }

        }.bind(this));
    },
    loadLanguage: function(callback){
        MWF.xDesktop.requireApp("cms.Xform", "lp." + MWF.language, null, false);

        //formDataText
        if (this.json.languageType!=="script" && this.json.languageType!=="default"){
            if (callback) callback();
            return true;
        }

        var language = MWF.xApplication.cms.Xform.LP.form;
        var languageJson = null;

        if (this.json.languageType=="script"){
            if (this.json.languageScript && this.json.languageScript.code){
                languageJson = this.Macro.exec(this.json.languageScript.code, this);
            }
        }else if (this.json.languageType=="default") {
            var name = "lp-"+o2.language;
            var application = this.businessData.document.appId;

            var p1 = this.documentAction.getDictRoot(name, application, function(d){
                return d.data;
            }, function(){});
            var p2 = this.documentAction.getScriptByNameV2(name, application, function(d){
                return this.Macro.exec(d.data.text, this);
            }.bind(this), function(){});
            languageJson = Promise.any([p1, p2]);
        }

        if (languageJson){
            if (languageJson.then && o2.typeOf(languageJson.then)=="function"){
                languageJson.then(function(json) {
                    MWF.xApplication.cms.Xform.LP.form = Object.merge(MWF.xApplication.cms.Xform.LP.form, json);
                    if (callback) callback(true);
                }, function(){
                    if (callback) callback(true);
                })
            }else{
                MWF.xApplication.cms.Xform.LP.form = Object.merge(MWF.xApplication.cms.Xform.LP.form, languageJson);
                if (callback) callback(true);
            }
        }else{
            if (callback) callback(true);
        }

    },
    loadRelatedScript: function () {
        if (this.json.includeScripts && this.json.includeScripts.length) {
            var includeScriptText = "";
            var includedIds = [];
            this.json.includeScripts.each(function (s) {
                if (this.app.relatedScriptMap && this.app.relatedScriptMap[s.id]) {
                    includeScriptText += "\n" + this.app.relatedScriptMap[s.id].text;
                    includedIds.push(s.id);
                }
            }.bind(this));

            if (includeScriptText) this.Macro.exec(includeScriptText, this);
        }
    },
    loadContent: function (callback) {
        this.subformCount = 0;
        this.subformLoadedCount = 0;
        this.subformLoaded = [this.json.id];

        this._loadHtml();
        this._loadForm();
        this.fireEvent("beforeModulesLoad");
        this._loadModules(this.node);

        if (!this.options.readonly) {
            if (this.options.autoSave) this.autoSave();
            this.app.addEvent("queryClose", function () {
                if (this.options.saveOnClose && this.businessData.document.docStatus == "draft") this.saveDocument(null, true);
                //if (this.autoSaveTimerID) window.clearInterval(this.autoSaveTimerID);
                Object.each(this.forms, function (module, id) {
                    if (module.json.type == "Htmleditor" && module.editor) {
                        //if(CKEDITOR.currentImageDialog)CKEDITOR.currentImageDialog.destroy();
                        //CKEDITOR.currentImageDialog = null;
                        CKEDITOR.remove(module.editor);
                        delete module.editor
                    }
                });
            }.bind(this));
        }
        this.fireEvent("afterModulesLoad");
        this.fireEvent("postLoad");
        this.fireEvent("afterLoad");
        if (this.app && this.app.fireEvent) {
            this.app.fireEvent("afterModulesLoad");
            this.app.fireEvent("postLoad");
            this.app.fireEvent("afterLoad");
        }
        // 告诉移动端表单加载完成
        if (this.app && this.app.mobile) {
            if (callback) callback();
        }
    },
    autoSave: function () {
        //this.autoSaveTimerID = window.setInterval(function(){
        //    this.saveDocument();
        //}.bind(this), 300000);
    },
    _loadBusinessData: function () {
        if (!this.businessData) {
            this.businessData = {
                "data": {}
            };
        }
    },

    _loadEvents: function () {
        Object.each(this.json.events, function (e, key) {
            if (e.code) {
                if (this.options.moduleEvents.indexOf(key) != -1) {
                    this.addEvent(key, function (event) {
                        return this.Macro.fire(e.code, this, event);
                    }.bind(this));
                } else {
                    if (key == "load") {
                        this.addEvent("postLoad", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else if (key == "submit") {
                        this.addEvent("beforePublish", function () {
                            return this.Macro.fire(e.code, this);
                        }.bind(this));
                    } else {
                        this.node.addEvent(key, function (event) {
                            return this.Macro.fire(e.code, this, event);
                        }.bind(this));
                    }
                }
            }
        }.bind(this));
    },



    _loadModules: function (dom) {
        //var subDom = this.node.getFirst();
        //while (subDom){
        //    if (subDom.get("MWFtype")){
        //        var json = this._getDomjson(subDom);
        //        var module = this._loadModule(json, subDom);
        //        this.modules.push(module);
        //    }
        //    subDom = subDom.getNext();
        //}

        var moduleNodes = this._getModuleNodes(dom);

        moduleNodes.each(function (node) {
            var json = this._getDomjson(node);
            if (!this.options.showAttachment && json.type == "Attachment") {
                return;
            }
            //移动端去掉操作栏
            if (this.app.mobile && json.type === "Actionbar") {
                return;
            }
            var module = this._loadModule(json, node);
            this.modules.push(module);
        }.bind(this));
    },
    _loadModule: function (json, node, beforeLoad) {
        if (!json) return;
        if (!MWF["CMS" + json.type]) {
            MWF.xDesktop.requireApp("cms.Xform", json.type, null, false);
        }
        var module = new MWF["CMS" + json.type](node, json, this);
        if (beforeLoad) beforeLoad.apply(module);
        if (!this.all[json.id]) this.all[json.id] = module;
        if (module.field) {
            if (!this.forms[json.id]) this.forms[json.id] = module;
        }
        module.readonly = this.options.readonly;
        module.load();
        return module;
    },
    //getData: function(){
    //    var data= Object.clone(this.businessData.data);
    //    Object.each(this.forms, function(module, id){
    //        debugger;
    //        if (module.json.section=="yes"){
    //            data[id] = this.getSectionData(module, data[id]);
    //        }else{
    //            data[id] = module.getData();
    //        }
    //    }.bind(this));
    //
    //    this.businessData.data = data;
    //    this.Macro.environment.setData(this.businessData.data);
    //    return data;
    //},
    trim: function (array) {
        var arr = [];
        array.each(function (v) {
            if (v) arr.push(v);
        });
        return arr;
    },
    transportPermissionData: function (array, t) {
        var result = [];
        array.each(function (data) {
            var dn = typeOf(data) === "string" ? data : data.distinguishedName;
            if (dn) {
                var flag = dn.substr(dn.length - 1, 1);
                var type;
                switch (flag.toLowerCase()) {
                    case "i":
                        type = "人员"; //"身份";
                        break;
                    case "p":
                        type = "人员";
                        break;
                    case "u":
                        type = "组织";
                        break;
                    case "g":
                        type = "群组";
                        break;
                    case "r":
                        type = "角色";
                        break;
                    default:
                        type = "";
                    //result.push( data );
                }
                if (type) {
                    var name;
                    if( typeOf(data) === "object" && data.name ){
                        name = data.name;
                    }else if( MWF.name && MWF.name.cn ){
                        name = MWF.name.cn( dn );
                    }else{
                        name = dn.split("@")[0];
                    }
                    result.push({
                        permission: t == "author" ? "作者" : "阅读",
                        permissionObjectType: type,
                        permissionObjectName: name,
                        permissionObjectCode: dn
                    })
                }
            }
        });
        return result.length > 0 ? result : null;
    },
    getSpecialData: function () {
        var data = this.businessData.data;
        var readers = [];
        var authors = [];
        var pictures = [];
        var cloudPictures = [];
        var summary = "";
        Object.each(this.forms, function (module, id) {
            if (module.json.type == "Readerfield" || module.json.type == "Reader") {
                if (module.json.section == "yes") {
                    readers = readers.concat(this.getSectionData(module, data[id]));
                } else {
                    readers = readers.concat(module.getData());
                }
            }
            if (module.json.type == "Authorfield" || module.json.type == "Author") {
                if (module.json.section == "yes") {
                    authors = authors.concat(this.getSectionData(module, data[id]));
                } else {
                    authors = authors.concat(module.getData());
                }
            }
            if (module.json.type == "ImageClipper") {
                var d = module.getData();
                if (d) pictures.push(d);
            }
            if (module.json.type == "Htmleditor") {
                var text = module.getText();
                summary = text.substr(0, 80);

                cloudPictures = cloudPictures.concat(module.getImageIds());
            }
        });
        if (data.processOwnerList && typeOf(data.processOwnerList) == "array") { //如果是流程中发布的
            var owner = { personValue: [] };
            data.processOwnerList.each(function (p) {
                owner.personValue.push({
                    name: p,
                    type: "person"
                });
            });
            readers = readers.concat(owner);
        }
        return {
            readers: this.transportPermissionData(readers, "reader"),
            authors: this.transportPermissionData(authors, "author"),
            pictures: pictures,
            summary: summary,
            cloudPictures: cloudPictures
        };
    },
    getDocumentData: function (formData) {
        var data = Object.clone(this.businessData.document);
        if (formData.subject) {
            data.title = formData.subject;
            data.subject = formData.subject;
            this.businessData.document.title = formData.subject;
            this.businessData.document.subject = formData.subject;
        }
        data.isNewDocument = false;
        return data;
    },
    saveDocument: function (callback, sync) {
        this.fireEvent("beforeSave");
        if (this.businessData.document.docStatus == "published") {
            if (!this.formValidation("publish")) {
                this.app.content.unmask();
                //if (callback) callback();
                return false;
            }
        }
        if (!this.formSaveValidation()) {
            this.app.content.unmask();
            if (callback) callback();
            return false;
        }
        var data = this.getData();
        var specialData = this.getSpecialData();
        var documentData = this.getDocumentData(data);
        documentData.readerList = specialData.readers;
        documentData.authorList = specialData.authors;
        documentData.pictureList = specialData.pictures;
        documentData.summary = specialData.summary;
        documentData.cloudPictures = specialData.cloudPictures;
        documentData.docData = data;
        delete documentData.attachmentList;
        this.fireEvent("postSave", [documentData]);
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save();
            });
        }
        this.documentAction.saveDocument(documentData, function () {
            //this.documentAction.saveData(function(json){
            this.app.notice(MWF.xApplication.cms.Xform.LP.dataSaved, "success");
            this.businessData.data.isNew = false;
            this.fireEvent("afterSave");
            if (callback) callback();
            //}.bind(this), null, this.businessData.document.id, data, !sync );
        }.bind(this), null, !sync);
    },
    closeDocument: function () {
        this.fireEvent("beforeClose");
        if (this.app) {
            this.app.close();
        }
    },
    printDocument: function (form) {
        var form = form;
        if (!form) {
            form = this.json.id;
            if (this.json.printForm && this.json.printForm !== "none") form = this.json.printForm;
        }
        window.open(o2.filterUrl("../x_desktop/printcmsdoc.html?documentid=" + this.businessData.document.id + "&form=" + form));
    },

    formValidation: function (status) {
        if (this.options.readonly) return true;
        var flag = true;
        //flag = this.validation();
        Object.each(this.forms, function (field, key) {
            field.validationMode();
            if (!field.validation(status)) {
                flag = false;
            }
        }.bind(this));
        return flag;
    },
    formSaveValidation: function () {
        if (!this.json.validationSave) return true;
        if (!this.json.validationSave.code) return true;
        var flag = this.Macro.exec(this.json.validationSave.code, this);
        if (!flag) flag = MWF.xApplication.cms.Xform.LP.notValidation;
        if (typeOf(flag) === "string") {
            if (flag !== "true") {
                this.app.notice(flag, "error");
                return false;
            }
        } else if (flag.toString() != "true") {
            return false;
        }
        return true;
    },
    formPublishValidation: function () {
        if (!this.json.validationPublish) return true;
        if (!this.json.validationPublish.code) return true;
        var flag = this.Macro.exec(this.json.validationPublish.code, this);
        if (!flag) flag = MWF.xApplication.cms.Xform.LP.notValidation;
        if (typeOf(flag) === "string") {
            if (flag !== "true") {
                this.app.notice(flag, "error");
                return false;
            }
        } else if (flag.toString() != "true") {
            return false;
        }
        return true;
    },
    publishDocument: function (callback) {
        this.fireEvent("beforePublish");
        this.app.content.mask({
            "destroyOnHide": true,
            "style": this.app.css.maskNode
        });
        if (!this.formValidation("publish")) {
            this.app.content.unmask();
            //if (callback) callback();
            return false;
        }
        if (!this.formPublishValidation()) {
            this.app.content.unmask();
            if (callback) callback();
            return false;
        }

        var data = this.getData();
        var specialData = this.getSpecialData();
        //this.documentAction.saveData(function(json){
        var documentData = this.getDocumentData(data);
        documentData.readerList = specialData.readers;
        documentData.authorList = specialData.authors;
        documentData.pictureList = specialData.pictures;
        documentData.summary = specialData.summary;
        documentData.cloudPictures = specialData.cloudPictures;
        documentData.docData = data;
        delete documentData.attachmentList;
        //this.documentAction.saveDocument(documentData, function(){
        this.fireEvent("postPublish", [documentData]);
        if (this.app) if (this.app.fireEvent) this.app.fireEvent("postPublish",[documentData]);
        if (this.officeList) {
            this.officeList.each(function (module) {
                module.save();
            });
        }
        this.documentAction.publishDocumentComplex(documentData, function (json) {
            this.businessData.data.isNew = false;
            this.fireEvent("afterPublish", [this, json.data]);
            if (this.app) if (this.app.fireEvent) this.app.fireEvent("afterPublish",[this, json.data]);
            if (callback) callback();
            if (this.app.mobile) {
                this.app.content.unmask();
                // console.log('这里是移动端');
            } else {
                if (this.businessData.document.title) {
                    this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished + ": “" + this.businessData.document.title + "”", "success");
                } else {
                    this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished, "success");
                }
                this.options.saveOnClose = false;
            }
            debugger;
            if( layout.inBrowser ){
                try{
                    if( window.opener && window.opener.o2RefreshCMSView ){
                        window.opener.o2RefreshCMSView();
                    }
                }catch (e) {}
                window.setTimeout(function () {
                    this.app.close();
                }.bind(this), 1500)
            }else{
                this.app.close();
            }
        }.bind(this));

        //}.bind(this))
        //}.bind(this), null, this.businessData.document.id, data);
    },
    //publishDocument_bak: function(callback){
    //    this.fireEvent("beforePublish");
    //    this.app.content.mask({
    //        "destroyOnHide": true,
    //        "style": this.app.css.maskNode
    //    });
    //    if (!this.formValidation("publish")){
    //        this.app.content.unmask();
    //        if (callback) callback();
    //        return false;
    //    }
    //
    //    var data = this.getData();
    //    var specialData = this.getSpecialData();
    //    this.documentAction.saveData(function(json){
    //        this.businessData.data.isNew = false;
    //        var documentData = this.getDocumentData(data);
    //        documentData.permissionList = specialData.readers;
    //        documentData.pictureList = specialData.pictures;
    //        documentData.summary = specialData.summary;
    //        delete documentData.attachmentList;
    //        this.documentAction.saveDocument(documentData, function(){
    //            this.documentAction.publishDocument(documentData, function(json){
    //                this.fireEvent("afterPublish");
    //                this.fireEvent("postPublish");
    //                if (callback) callback();
    //                this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished+": “"+this.businessData.document.title+"”", "success");
    //                this.options.saveOnClose = false;
    //                this.app.close();
    //                //this.close();
    //            }.bind(this) );
    //        }.bind(this))
    //    }.bind(this), null, this.businessData.document.id, data);
    //},

    deleteDocumentForMobile: function () {
        if (this.app.mobile) {
            this.app.content.mask({
                "style": {
                    "background-color": "#999",
                    "opacity": 0.6
                }
            });

            this.fireEvent("beforeDelete");
            if (this.app && this.app.fireEvent) this.app.fireEvent("beforeDelete");

            this.documentAction.removeDocument(this.businessData.document.id, function (json) {
                this.fireEvent("afterDelete");
                if (this.app && this.app.fireEvent) this.app.fireEvent("afterDelete");
                this.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete + ": “" + this.businessData.document.title + "”", "success");
                this.options.autoSave = false;
                this.options.saveOnClose = false;
                this.fireEvent("postDelete");
                this.app.close();
            }.bind(this));
        }
    },

    /**
     * @summary 弹出删除文档确认框.
     * @method deleteDocument
     * @memberof CMSForm
     * @example
     * this.form.getApp().appForm.deleteDocument();
     */
    deleteDocument: function () {
        var _self = this;
        var p = MWF.getCenterPosition(this.app.content, 380, 150);
        var event = {
            "event": {
                "x": p.x,
                "y": p.y - 200,
                "clientX": p.x,
                "clientY": p.y - 200
            }
        };
        this.app.confirm("infor", event, MWF.xApplication.cms.Xform.LP.deleteDocumentTitle, MWF.xApplication.cms.Xform.LP.deleteDocumentText, 380, 120, function () {
            _self.app.content.mask({
                "style": {
                    "background-color": "#999",
                    "opacity": 0.6
                }
            });

            _self.fireEvent("beforeDelete");
            if (_self.app && _self.app.fireEvent) _self.app.fireEvent("beforeDelete");

            _self.documentAction.removeDocument(_self.businessData.document.id, function (json) {
                _self.fireEvent("afterDelete");
                if (_self.app && _self.app.fireEvent) _self.app.fireEvent("afterDelete");
                _self.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete + ": “" + _self.businessData.document.title + "”", "success");
                _self.options.autoSave = false;
                _self.options.saveOnClose = false;
                _self.fireEvent("postDelete");
                _self.app.close();
                this.close();
            }.bind(this));
            //this.close();
        }, function () {
            this.close();
        });
    },

    /**
     * @summary 编辑文档.
     * @method editDocument
     * @memberof CMSForm
     * @example
     * this.form.getApp().appForm.editDocument();
     */
    editDocument: function () {
        if (this.app.inBrowser) {
            this.modules.each(function (module) {
                MWF.release(module);
            });
            //MWF.release(this);
            this.app.node.destroy();

            this.app.options.readonly = false;

            this.app.loadApplication();
        } else {
            var options = { "documentId": this.businessData.document.id, "readonly": false }; //this.explorer.app.options.application.allowControl};

            if (this.app.options.postPublish)options.postPublish = this.app.options.postPublish;
            if (this.app.options.afterPublish)options.afterPublish = this.app.options.afterPublish;
            if (this.app.options.postDelete)options.postDelete = this.app.options.postDelete;

            if (this.app.options.formEditId) options.formEditId = this.app.options.formEditId;
            this.app.desktop.openApplication(null, "cms.Document", options);
            this.app.close();
        }
    },

    //2019-11-29 移动端 开启编辑模式
    /**
     * @summary 移动端开启编辑模式.
     * @method editDocumentForMobile
     * @memberof CMSForm
     * @example
     * this.form.getApp().appForm.editDocumentForMobile();
     */
    editDocumentForMobile: function () {
        if (this.app.mobile) {
            this.app.options.readonly = false;
            this.app.loadDocument(this.app.options);
        }
    },

    /**
     * @summary 弹出设置热点的界面.
     * @method setPopularDocument
     * @memberof CMSForm
     * @example
     * this.form.getApp().appForm.setPopularDocument();
     */
    setPopularDocument: function () {
        this.app.setPopularDocument();
    },

    printWork: function (app, form) {
        var application = app || this.businessData.work.application;
        var form = form;
        if (!form) {
            form = this.json.id;
            if (this.json.printForm) form = this.json.printForm;
        }
        window.open(o2.filterUrl("../x_desktop/printWork.html?workid=" + this.businessData.work.id + "&app=" + this.businessData.work.application + "&form=" + form));
    },
    openWindow: function (form, app) {
        var form = form;
        if (!form) {
            form = this.json.id;
        }
        if (this.businessData.document) {
            //var application = app;
            //window.open("../x_desktop/printWork.html?workCompletedId="+this.businessData.workCompleted.id+"&app="+application+"&form="+form);
        }
    },

    /**
     * @summary 将新上传的附件在指定的附件组件中展现.
     * @method uploadedAttachment
     * @memberof CMSForm
     * @param {String} site - 附件组件的标识
     * @param {String} id - 新上传的附件id
     * @example
     * this.form.getApp().appForm.uploadedAttachment(site, id);
     */
    uploadedAttachment: function (site, id) {
        this.documentAction.getAttachment(id, this.businessData.document.id, function (json) {
            var att = this.all[site];
            if (att) {
                if (json.data) att.attachmentController.addAttachment(json.data);
                att.attachmentController.checkActions();
                att.fireEvent("upload", [json.data]);
            }
        }.bind(this));
    },
    replacedAttachment: function (site, id) {
        this.documentAction.getAttachment(id, this.businessData.document.id, function (json) {

            var att = this.all[site];
            if (att) {
                var attachmentController = att.attachmentController;
                var attachment = null;
                for (var i = 0; i < attachmentController.attachments.length; i++) {
                    if (attachmentController.attachments[i].data.id === id) {
                        attachment = attachmentController.attachments[i];
                        break;
                    }
                }
                attachment.data = json.data;
                attachment.reload();
                attachmentController.checkActions();
            }
        }.bind(this))
    }



});

MWF.xApplication.cms.Xform.widget = MWF.xApplication.cms.Xform.widget || {};
MWF.xApplication.cms.Xform.widget.Log = new Class({
    Implements: [Options, Events],
    Extends: MWF.widget.Common,
    options: {
        "style": "default",
        "mode" : "table",
        "documentId" : "",
        "textStyle" : ""
    },
    initialize: function (app, node, options) {
        this.setOptions(options);
        this.app = app;
        this.node = node;
        this.path = "../x_component_cms_Xform/widget/$Log/";
        this.cssPath = "../x_component_cms_Xform/widget/$Log/" + this.options.style + "/css.wcss";
        this._loadCss();

        MWF.xDesktop.requireApp("cms.Xform", "lp."+MWF.language, null, false);
        this.lp = MWF.xApplication.cms.Xform.LP;
    },
    load : function(){
        this.items = [];
        this.documents = {};
        this.isItemsLoaded = false;
        this.isItemLoadding = false;
        this.loadItemQueue = 0;
        this.count = 0;
        this.lineHeight = this.options.mode != "text" ? 32 : 25;
        this.countPerPage = 20;

        this.container = new Element("div",{styles:this.css.container}).inject( this.node );
        this.loadTitle();
        this.loadContent();
        this.loadElementList();
        this.loadBottom();
    },
    loadTitle : function(){
        this.titleNode = new Element("div", {"styles": this.css.titleNode, "text": this.lp.readedLogTitle}).inject(this.container);
    },
    loadTotal: function(){
        this.getAction( function(){
            if (this.options.documentId){
                this.restAction.invoke({"name": "getReadCount","async": true, "parameter": {"docId": this.options.documentId },"success": function(json){
                    if( json && json.data ){
                        this.titleCountNode = new Element("div", {
                            styles : this.css.titleCountNode,
                            text : this.lp.readedCountText.replace("{count}" , json.data.count).replace("{person}", this.dataCount )
                        }).inject(this.titleNode);
                    }
                }.bind(this)});
            }
        }.bind(this));
    },
    loadContent : function(){
        //this.contentContainerNode = new Element("div", {"styles": this.css.contentContainerNode }).inject(this.container);
        this.contentScrollNode = new Element("div", {"styles": this.css.contentScrollNode }).inject(this.container);
        this.contentScrollNode.setStyles({
            "width" : this.node.getSize().x-10,
            "margin-right" : "10px"
        });
        this.contentWrapNode = new Element("div", {"styles": this.css.contentWrapNode }).inject(this.contentScrollNode);
        this.setScroll();
        if( this.options.mode == "table" ){
            this.loadItemTitleTable();
        }
    },
    loadBottom: function(){
       var bottomNode = new Element("div",{
            "styles" : this.css.bottomNode
        }).inject( this.container );
        var resizeNode = new Element("div",{
            "styles" : this.css.bottomResizeNode,
            "text" : "◢"
        }).inject(bottomNode);

        var xLimit = this.contentScrollNode.getSize().x;

       this.contentScrollNode.makeResizable({
            "handle": resizeNode,
            "limit": {x:[xLimit, xLimit], y:[50, null]},
            "onDrag": function(){
                var y = this.contentScrollNode.getSize().y;
                if( y > ( this.lineHeight * this.countPerPage - 20 ) ){
                    this.countPerPage = parseInt( y / this.lineHeight ) + 2
                }
                this.contentScrollNode.fireEvent("resize");
            }.bind(this),
            "onComplete": function(){
                this.scrollBar.checkScroll();
                this.loadElementList();
            }.bind(this)
        });
    },
    loadElementList : function( count ){
        if (!this.isItemsLoaded) {
            if (!this.isItemLoadding) {
                this.isItemLoadding = true;
                this._getCurrentPageData(function (json) {
                    var length = this.dataCount = json.count;  //|| json.data.length;
                    if( !this.titleCountNode ){
                        this.loadTotal();
                    }
                    if( this.items.length == 0 )this.setSize();
                    if (length <= this.items.length) {
                        this.isItemsLoaded = true;
                    }
                    if( json.data && typeOf( json.data )=="array" ){
                        json.data.each(function (data ) {
                            var key = data.id;
                            if (!this.documents[key]) {
                                var item = this._createDocument(data, this.items.length);
                                this.items.push(item);
                                this.documents[key] = item;
                            }
                        }.bind(this));
                    }
                    this.isItemLoadding = false;

                    if (this.loadItemQueue > 0) {
                        this.loadItemQueue--;
                        this.loadElementList();
                    }
                }.bind(this), count);
            } else {
                this.loadItemQueue++;
            }
        }
    },
    _getCurrentPageData : function(callback){
        var id = (this.items.length) ? this.items[this.items.length - 1].data.id : "(0)";
        this.getAction( function(){
            if (this.options.documentId){
                this.restAction.invoke({"name": "listReadedLog","async": true, "parameter": { "docId": this.options.documentId, "id": id, "count":this.countPerPage },"success": function(json){
                    if (callback) callback(json);
                }.bind(this)});
            }
        }.bind(this));
    },
    getAction: function(callback){
        if (!this.action){
            MWF.require("MWF.xDesktop.Actions.RestActions", function(){
                this.restAction = new MWF.xDesktop.Actions.RestActions("", "x_cms_assemble_control", "");
                this.restAction.getActions = function(actionCallback){
                    this.actions = {
                        "getReadCount" : {"uri":"/jaxrs/document/{docId}/view/count"},
                        "listReadedLog": {"uri": "/jaxrs/viewrecord/document/{docId}/filter/list/{id}/next/{count}", "method":"GET"}
                    };
                    if (actionCallback) actionCallback();
                };
                if (callback) callback();
            }.bind(this));
        }else{
            if (callback) callback();
        }
    },
    setSize : function(){
        var lineHeight = this.lineHeight;
        var maxCount = this.options.mode == "text" ? 10 : 8;
        if( this.dataCount > maxCount ){
            var height = maxCount*lineHeight - 15;
        }else if( this.dataCount <= 1 ){
            var height = 1*lineHeight;
        }else{
            var height = this.dataCount*lineHeight;
        }
        if( this.options.mode != "text" )height = height + lineHeight;
        this.contentScrollNode.setStyle("height", height+"px");
    },
    setScroll: function(){
        MWF.require("MWF.widget.ScrollBar", function () {
            this.scrollBar = new MWF.widget.ScrollBar(this.contentScrollNode, {
                "indent": false,
                "style": "default",
                "where": "before",
                "distance": 60,
                "friction": 4,
                "axis": {"x": false, "y": true},
                "onScroll": function (y) {
                    var scrollSize = this.contentScrollNode.getScrollSize();
                    var clientSize = this.contentScrollNode.getSize();
                    var scrollHeight = scrollSize.y - clientSize.y;
                    if (y + 30 > scrollHeight ) {
                        if (! this.isItemsLoaded) this.loadElementList();
                    }
                }.bind(this)
            });
        }.bind(this));
    },
    _createDocument: function( data ){
        var itemNode;
        if( this.options.mode == "text" ){
            if( this.options.textStyle ){
                itemNode = this.loadItemNodeText( data );
            }else{
                itemNode = this.loadItemNodeDefault( data );
            }
        }else{
            itemNode = this.loadItemNodeTable( data );
        }
        return {
            node : itemNode,
            data : data
        }
    },
    loadItemTitleTable: function(){

        var xSize = this.contentScrollNode.getSize().x;
        this.table = new Element("table", {
            "styles": this.css.logTable,
            "border": "0",
            "cellSpacing": "0",
            "cellpadding": "3px",
            "width": xSize - 10
        }).inject( this.contentWrapNode );
        this.tbody = new Element("tbody").inject( this.table );

        this.table.setStyles({
            "margin-left" : "8px"
        });
        var tr = new Element("tr").inject( this.tbody );
        tr.setStyles(this.css.logTableTitleTr);

        var td = new Element("td", { styles : this.css.logTableTitle }).inject( tr );
        td.set("text", this.lp.person);
        var td = new Element("td", { styles : this.css.logTableTitle }).inject( tr );
        td.set("text", this.lp.department);
        var td = new Element("td", { styles : this.css.logTableTitle }).inject( tr );
        td.set("text", this.lp.firstDate);
        var td = new Element("td", { styles : this.css.logTableTitle }).inject( tr );
        td.set("text", this.lp.readDate);
        var td = new Element("td", { styles : this.css.logTableTitle }).inject( tr );
        td.set("text", this.lp.readCount);
    },
    loadItemNodeTable: function(data){

        var tr = new Element("tr").inject( this.tbody );
        tr.setStyles(this.css.logTableContentTr);

        var td = new Element("td", { styles : this.css.logTableContent }).inject( tr );
        td.set("text", this.getShortName(data.viewerName) || "");
        td = new Element("td", { styles : this.css.logTableContent }).inject( tr );
        td.set("text", this.getShortName(data.viewerUnitName) || "");
        td = new Element("td", { styles : this.css.logTableContent }).inject( tr );
        td.set("text", data.createTime);
        td = new Element("td", { styles : this.css.logTableContent }).inject( tr );
        td.set("text", data.lastViewTime);
        td = new Element("td", { styles : this.css.logTableContent }).inject( tr );
        td.set("text", data.viewCount);
    },
    loadItemNodeText: function(data, textStyle){
        var itemNode =  new Element("div",{ "styles" : this.css.defaultItemNode  }).inject(this.contentWrapNode);
        var html = textStyle || this.options.textStyle;
        html = html.replace(/\{person\}/g, this.getShortName( data.viewerName));
        html = html.replace(/\{unitName\}/g, this.getShortName( data.viewerUnitName ) || "");
        html = html.replace(/\{topUnitName\}/g, this.getShortName( data.viewerTopUnitName ) || "");
        html = html.replace(/\{firstDate\}/g, data.createTime);
        html = html.replace(/\{date\}/g, data.lastViewTime);
        html = html.replace(/\{count\}/g, data.viewCount);
        itemNode.set("html", html);

        return itemNode;
    },
    loadItemNodeDefault: function( data ){
        //var itemNode =  new Element("div",{ "styles" : this.css.defaultItemNode  }).inject(this.contentWrapNode);
        //var personNode = new Element("div",{ styles : this.css.defaultItemPersonNode ,text : data.viewerName }).inject(itemNode);
        //if(data.viewerOrganization){
        //    var departmentNode = new Element("div",{ styles : this.css.defaultItemDepartmentNode ,text : "（"+data.viewerOrganization+"）" }).inject(itemNode);
        //}
        //
        //new Element("div",{ styles : this.css.defaultItemTextNode , text : this.lp.at }).inject(itemNode);
        //var timeNode = new Element("div",{ styles : this.css.defaultItemTimeNode , text : data.lastViewTime }).inject(itemNode);
        //new Element("div",{ styles : this.css.defaultItemTextNode , text : this.lp.readdDocument }).inject(itemNode);
        //
        //new Element("div",{ styles : this.css.defaultItemTextNode , text : this.lp.historyRead }).inject(itemNode);
        //var countNode = new Element("div",{ styles : this.css.defaultItemCountNode ,text : data.viewCount }).inject(itemNode);
        //new Element("div",{ styles : this.css.defaultItemTextNode , text : this.lp.times }).inject(itemNode);
        return this.loadItemNodeText( data, this.lp.defaultReadedLogText );
    },
    getShortName : function( dn ){
        if( dn && dn.contains("@") ){
            return dn.split("@")[0];
        }else{
            return dn;
        }
    }
});
MWF.xDesktop.requireApp("process.Xform", "Org", null, false);
MWF.xApplication.cms.Xform.Org = MWF.CMSOrg =  new Class({
	Extends: MWF.APPOrg,
	_getOrgOptions: function(){
		this.selectTypeList = typeOf( this.json.selectType ) == "array" ? this.json.selectType : [this.json.selectType];
		if( this.selectTypeList.contains( "identity" ) ) {
			this.identityOptions = new MWF.CMSOrg.IdentityOptions(this.form, this.json);
		}
		if( this.selectTypeList.contains( "unit" ) ) {
			this.unitOptions = new MWF.CMSOrg.UnitOptions(this.form, this.json);
		}
		if( this.selectTypeList.contains( "group" ) ){
			this.groupOptions = new MWF.APPOrg.GroupOptions( this.form, this.json );
		}
	}
});

MWF.CMSOrg.IdentityOptions = new Class({
	Extends: MWF.APPOrg.IdentityOptions,
	_getSelectRange : function(){
		if (this.json.identityRange==="unit"){
			return this.getScriptSelectUnit();
		}
		if (this.json.identityRange==="draftUnit"){
			var dn = this.form.businessData.document.creatorIdentity;
			if (!dn){
				if ( layout.session.user.identityList && layout.session.user.identityList.length){
					var ids = [];
					layout.session.user.identityList.each(function(id){ ids.push(id.id); });
					return this.getNextSelectUnit(ids);
				}else{
					return [];
				}
			}else{
				return this.getNextSelectUnit(dn);
			}
		}
		if (this.json.identityRange==="currentUnit"){
			if ( layout.session.user.identityList && layout.session.user.identityList.length){
				var ids = [];
				layout.session.user.identityList.each(function(id){ ids.push(id.id); });
				return this.getNextSelectUnit(ids);
			}else{
				return [];
			}
		}
		return [];
	}
});

MWF.CMSOrg.UnitOptions = new Class({
	Extends: MWF.APPOrg.UnitOptions,
	_getSelectRange : function(){
		if (this.json.unitRange==="unit"){
			return this.getScriptSelectUnit();
		}
		if (this.json.unitRange==="draftUnit"){
			var dn = this.form.businessData.document.creatorIdentity;
			if (!dn){
				if ( layout.session.user.identityList && layout.session.user.identityList.length){
					var ids = [];
					layout.session.user.identityList.each(function(id){ ids.push(id.id); });
					return this.getNextSelectUnit(ids);
				}else{
					return [];
				}
			}else{
				return this.getNextSelectUnit(dn);
			}
		}
		if (this.json.unitRange==="currentUnit"){
			if ( layout.session.user.identityList && layout.session.user.identityList.length){
				var ids = [];
				layout.session.user.identityList.each(function(id){ ids.push(id.id); });
				return this.getNextSelectUnit(ids);
			}else{
				return [];
			}
		}
		return [];
	}
});
MWF.xDesktop.requireApp("cms.Xform", "Org", null, false);
/** @class Author 作者组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.Org
 * @o2category FormComponents
 * @o2range {CMS}
 * @hideconstructor
 */
MWF.xApplication.cms.Xform.Author = MWF.CMSAuthor =  new Class({
	Extends: MWF.CMSOrg,
	iconStyle: "authorIcon"
});
MWF.xDesktop.requireApp("cms.Xform", "Org", null, false);
/** @class Reader 读者组件。
 * @example
 * //可以在脚本中获取该组件
 * //方法1：
 * var field = this.form.get("fieldId"); //获取组件对象
 * //方法2
 * var field = this.target; //在组件本身的脚本中获取，比如事件脚本、默认值脚本、校验脚本等等
 *
 * var data = field.getData(); //获取值
 * field.setData("字符串值"); //设置值
 * field.hide(); //隐藏字段
 * var id = field.json.id; //获取字段标识
 * var flag = field.isEmpty(); //字段是否为空
 * field.resetData();  //重置字段的值为默认值或置空
 * @extends MWF.xApplication.process.Xform.Org
 * @o2category FormComponents
 * @o2range {CMS}
 * @hideconstructor
 */
MWF.xApplication.cms.Xform.Reader = MWF.CMSReader =  new Class({
	Extends: MWF.CMSOrg,
	iconStyle: "readerIcon"
});
MWF.xDesktop.requireApp("process.Xform", "Textfield", null, false);
MWF.xApplication.cms.Xform.Textfield = MWF.CMSTextfield =  new Class({
	Extends: MWF.APPTextfield
}); 
MWF.xDesktop.requireApp("process.Xform", "Actionbar", null, false);
MWF.xApplication.cms.Xform.Actionbar = MWF.CMSActionbar =  new Class({
    Extends: MWF.APPActionbar,
    reload : function(){
        this._loadUserInterface();
    },
    _loadUserInterface: function(){
        debugger;
        //if (this.form.json.mode == "Mobile"){
        //    this.node.empty();
        //}else if (COMMON.Browser.Platform.isMobile){
        //    this.node.empty();
        //}else{
        this.toolbarNode = this.node.getFirst("div");
        if (!this.toolbarNode)  this.toolbarNode = this.node;
        if (this.toolbarNode) this.toolbarNode.empty();

        //this.node.empty();

        MWF.require("MWF.widget.SimpleToolbar", function(){
            this.toolbarWidget = new MWF.widget.SimpleToolbar(this.toolbarNode, {
                "style": this.json.style,
                "onPostLoad" : function(){
                    this.fireEvent("afterLoad");
                }.bind(this)
            }, this);
            if (this.json.actionStyles) this.toolbarWidget.css = this.json.actionStyles;

            //var json = this.readonly ? this.json.sysTools.readTools : this.json.sysTools.editTools;
            //if( this.json.style == "xform_red_simple" ){
            //    json.each( function( j ){
            //        var names = j.img.split(".");
            //        j.img = names[0] + "_red." + names[1];
            //    });
            //}
            //this.setToolbars(json, this.toolbarNode);
            //this.setCustomToolbars(this.json.tools, this.toolbarNode);
            //
            //this.toolbarWidget.load();
            if( this.json.multiTools ){

                var jsonStr = JSON.stringify(this.json.multiTools);
                jsonStr = o2.bindJson(jsonStr, {"lp": MWF.xApplication.cms.Xform.LP.form});
                this.json.multiTools = JSON.parse(jsonStr);

                this.json.multiTools.each( function (tool) {
                    if( tool.system ){
                        if( !this.json.hideSystemTools ){
                            this.setToolbars( [tool], this.toolbarNode, this.readonly);
                        }
                    }else{
                        this.setCustomToolbars([tool], this.toolbarNode);
                    }
                }.bind(this));
                this.toolbarWidget.load();
            }else{
                if (this.json.hideSystemTools){
                    this.setCustomToolbars(this.json.tools, this.toolbarNode);
                    this.toolbarWidget.load();
                }else{
                    if (this.json.defaultTools){
                        this.setToolbars(this.json.defaultTools, this.toolbarNode, this.readonly);
                        this.setCustomToolbars(this.json.tools, this.toolbarNode);
                        this.toolbarWidget.load();
                    }else{
                        MWF.getJSON("../x_component_cms_Xform/$Form/toolbars.json", function(json){
                            this.setToolbars(json, this.toolbarNode, this.readonly, true);
                            this.setCustomToolbars(this.json.tools, this.toolbarNode);

                            this.toolbarWidget.load();
                        }.bind(this), false);
                    }

                    //MWF.getJSON("../x_component_cms_Xform/$Form/toolbars.json", function(json){
                    //    this.setToolbars(json, this.toolbarNode, this.readonly);
                    //    this.setCustomToolbars(this.json.tools, this.toolbarNode);
                    //
                    //    this.toolbarWidget.load();
                    //}.bind(this), false);
                }
            }
        }.bind(this));
        //}
    },
    setCustomToolbars: function(tools, node){
        var path = "../x_component_cms_FormDesigner/Module/Actionbar/";
        //var style = (this.json.style || "default").indexOf("red") > -1 ? "red" : "blue";
        var style;
        if( this.json.customIconStyle ){
            style = this.json.customIconStyle;
        }else{
            style = (this.json.style || "default").indexOf("red") > -1 ? "red" : "blue";
        }
        var style_over = this.json.customIconOverStyle || "white";

        tools.each(function(tool){
            var flag = true;
            if (this.readonly){
                flag = tool.readShow;
            }else{
                flag = tool.editShow;
            }
            if (flag){
                flag = true;
                if (tool.control){
                    flag = this.form.businessData.control[tool.control]
                }
                if (tool.condition){
                    var hideFlag = this.form.Macro.exec(tool.condition, this);
                    flag = !hideFlag;
                }
                if (flag){
                    var actionNode = new Element("div", {
                        "id": tool.id,
                        "MWFnodetype": tool.type,
                        "MWFButtonImage": path+""+this.form.options.style+"/custom/"+ style + "/" +tool.img,
                        "MWFButtonImageOver": path+""+this.form.options.style+"/custom/" + style_over + "/"+tool.img,
                        //"MWFButtonImage": "../x_component_cms_FormDesigner/Module/Actionbar/"+ (this.options.style||"default") +"/tools/"+ (this.json.style || "default") +"/"+tool.img,
                        //"MWFButtonImageOver": "../x_component_cms_FormDesigner/Module/Actionbar/"+ (this.options.style||"default")+"/tools/"+ (this.json.style || "default") +"/"+tool.img_over,
                        "title": tool.title,
                        "MWFButtonAction": "runCustomAction",
                        "MWFButtonText": tool.text
                    }).inject(node);
                    if( tool.properties ){
                        actionNode.set(tool.properties);
                    }
                    if (tool.actionScript){
                        actionNode.store("script", tool.actionScript);
                    }
                    if (tool.sub){
                        var subNode = node.getLast();
                        this.setCustomToolbars(tool.sub, subNode);
                    }
                }
            }
        }.bind(this));
    },
    setToolbars: function(tools, node, readonly, noCondition){
        tools.each(function(tool){
            var flag = true;
            if (tool.control){
                flag = this.form.businessData.control[tool.control]
            }
            if (!noCondition) if (tool.condition){
                var hideFlag = this.form.Macro.exec(tool.condition, this);
                flag = flag && (!hideFlag);
            }
            //if (tool.id == "action_processWork"){
            //    if (!this.form.businessData.task){
            //        flag = false;
            //    }
            //}
            if (readonly){
                if (!tool.read) flag = false;
            }else{
                if (!tool.edit) flag = false;
            }
            if (this.json.hideSetPopularDocumentTool && tool.id == "action_popular"){
                flag = false;
            }
            if (flag){
                var actionNode = new Element("div", {
                    "id": tool.id,
                    "MWFnodetype": tool.type,
                    "MWFButtonImage": "../x_component_cms_FormDesigner/Module/Actionbar/"+(this.options.style||"default") +"/tools/"+ (this.json.style || "default") +"/"+tool.img,
                    "MWFButtonImageOver": "../x_component_cms_FormDesigner/Module/Actionbar/"+(this.options.style||"default")+"/tools/"+ (this.json.style || "default") +"/"+tool.img_over,
                    "title": tool.title,
                    "MWFButtonAction": tool.action,
                    "MWFButtonText": tool.text
                }).inject(node);
                if (tool.sub){
                    var subNode = node.getLast();
                    this.setToolbars(tool.sub, subNode);
                }
            }
        }.bind(this));
    },
    runCustomAction: function(bt){
        var script = bt.node.retrieve("script");
        this.form.Macro.exec(script, this);
    },
    saveDocument: function(){
        this.form.saveDocument();
    },
    saveDraftDocument: function(){
        this.form.saveDocument();
    },
    closeDocument: function(){
        this.form.closeDocument();
    },
    publishDocument: function(){
        this.form.publishDocument();
    },
    archiveDocument: function(){
        this.form.archiveDocument();
    },
    redraftDocument: function(){
        this.form.redraftDocument();
    },
    deleteDocument: function(){
        this.form.deleteDocument();
    },
    editDocument: function(){
        this.form.editDocument();
    },
    setPopularDocument: function(){
        this.form.setPopularDocument();
    },
    printDocument: function(){
        this.form.printDocument();
    }
}); 
MWF.xDesktop.requireApp("process.Xform", "Attachment", null, false);
//MWF.xDesktop.requireApp("cms.FormDesigner", "widget.AttachmentController", null, false);
MWF.xApplication.cms.Xform.AttachmentController = new Class({
    Extends: MWF.xApplication.process.Xform.AttachmentController,
    "options": {
        "checkTextEnable": false
    },
    openInOfficeControl: function (att, office) {
        if (office) {
            if (!office.openedAttachment || office.openedAttachment.id !== att.id) {
                office.save();
                MWF.Actions.get("x_cms_assemble_control").getAttachmentUrl(att.id, this.module.form.businessData.document.id, function (url) {
                    office.openedAttachment = { "id": att.id, "site": this.module.json.name, "name": att.name };
                    office.officeOCX.BeginOpenFromURL(url, true, this.readonly);
                }.bind(this));
            }
        }
    },
    setAttachmentConfig: function (readInput, editInput, controllerInput) {
        if (this.selectedAttachments.length) {
            var readList = readInput.retrieve("data-value");
            var editList = editInput.retrieve("data-value");
            var controllerList = controllerInput.retrieve("data-value");

            var readUnitList = [];
            var readIdentityList = [];
            var editUnitList = [];
            var editIdentityList = [];
            var controllerUnitList = [];
            var controllerIdentityList = [];

            if (readList) {
                readList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") readUnitList.push(vName);
                    if (flag === "I") readIdentityList.push(vName);
                });
            }
            if (editList) {
                editList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") editUnitList.push(vName);
                    if (flag === "I") editIdentityList.push(vName);
                });
            }
            if (controllerList) {
                controllerList.each(function (v) {
                    var vName = (typeOf(v) === "string") ? v : v.distinguishedName;
                    var len = vName.length;
                    var flag = vName.substring(len - 1, len);
                    if (flag === "U") controllerUnitList.push(vName);
                    if (flag === "I") controllerIdentityList.push(vName);
                });
            }

            this.selectedAttachments.each(function (att) {
                att.data.readUnitList = readUnitList;
                att.data.readIdentityList = readIdentityList;
                att.data.editUnitList = editUnitList;
                att.data.editIdentityList = editIdentityList;
                att.data.controllerUnitList = controllerUnitList;
                att.data.controllerIdentityList = controllerIdentityList;

                o2.Actions.get("x_cms_assemble_control").configAttachment(att.data.id, this.module.form.businessData.document.id, att.data);
            }.bind(this));
        }
    },
    sortByNumber: function( attachments ){
        return attachments.sort(function (a1, a2) {
            if (!a2.data.seqNumber) return 1;
            if (!a1.data.seqNumber) return -1;
            return a1.data.seqNumber - a2.data.seqNumber;
        }.bind(this));
    },
    sortAttachment: function (node) {
        var nodes = node.getChildren();
        nodes.each(function (item, idx) {
            var att = item.retrieve("att", null);
            if (att) {
                att.data.seqNumber = idx;
                o2.Actions.load("x_cms_assemble_control").FileInfoAction.changeSeqNumber(att.data.id, this.module.form.businessData.document.id, idx);
            }
        }.bind(this));
        this.attachments = this.attachments.sort(function (a1, a2) {
            if (!a2.data.seqNumber) return 1;
            if (!a1.data.seqNumber) return -1;
            return a1.data.seqNumber - a2.data.seqNumber;
        }.bind(this));

        this.reloadAttachments();
        this.fireEvent("order");
    }
});
MWF.xApplication.cms.Xform.Attachment = MWF.CMSAttachment = new Class({
    Extends: MWF.APPAttachment,

    _loadUserInterface: function () {
        this.node.empty();
        this.loadAttachmentController();
        this.fireEvent("load");
    },

    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.cms.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": (this.json.resize === "y" || this.json.resize === "true"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": (this.json.isUpload === "y" || this.json.isUpload === "true"),
            "isDelete": (this.json.isDelete === "y" || this.json.isDelete === "true"),
            "isReplace": (this.json.isReplace === "y" || this.json.isReplace === "true"),
            "isDownload": (this.json.isDownload === "y" || this.json.isDownload === "true"),
            "isPreviewAtt": (this.json.isPreviewAtt === "y" || this.json.isPreviewAtt === "true"),
            "isSizeChange": (this.json.isSizeChange === "y" || this.json.isSizeChange === "true"),
            "readonly": (this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "onOrder": function () {
                this.fireEvent("change");
            }.bind(this)
            //"downloadEvent" : this.json.downloadEvent
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json && this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }

        this.fireEvent("queryLoadController", [options]);

        this.attachmentController = new MWF.xApplication.cms.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        this.form.businessData.attachmentList.each(function (att) {
            if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
            //if (att.fileType.toLowerCase()==this.json.id.toLowerCase()) this.attachmentController.addAttachment(att);
        }.bind(this));
        this.setAttachmentBusinessData();
        //}.bind(this));
    },
    loadAttachmentSelecter: function (option, callback) {
        MWF.require("MWF.widget.AttachmentSelector", function () {
            var options = {
                //"style" : "cms",
                "title": MWF.xApplication.cms.Xform.LP.selectAttachment, //"选择附件",
                "listStyle": "icon",
                "selectType": "all",
                "size": "max",
                "attachmentCount": 0,
                "isUpload": true,
                "isDelete": true,
                "isReplace": true,
                "isDownload": true,
                "toBase64": true,
                "base64MaxSize": 800,
                "readonly": false
            };
            options = Object.merge(options, option);
            if (this.readonly) options.readonly = true;
            this.attachmentController = new MWF.widget.AttachmentSelector(this.node, this, options);
            this.attachmentController.load();

            this.postSelect = callback;

            this.form.businessData.attachmentList.each(function (att) {
                this.attachmentController.addAttachment(att);
            }.bind(this));
        }.bind(this));
    },
    selectAttachment: function (e, node, attachments) {
        //if( attachments.length > 0 ){
        //    this.form.documentAction.getAttachmentUrl(attachments[attachments.length-1].data.id, this.form.businessData.document.id, function(url){
        //        if(this.postSelect)this.postSelect( url )
        //    }.bind(this))
        //}
        if (attachments.length > 0) {
            var data = attachments[attachments.length - 1].data;
            this.form.documentAction.getAttachmentUrl(data.id, this.form.businessData.document.id, function (url) {
                if (this.attachmentController.options.toBase64) {
                    this.form.documentAction.getSubjectAttachmentBase64(data.id, this.attachmentController.options.base64MaxSize, function (json) {
                        var base64Code = json.data ? "data:image/png;base64," + json.data.value : null;
                        if (this.postSelect) this.postSelect(url, data, base64Code)
                    }.bind(this))
                } else {
                    if (this.postSelect) this.postSelect(url, data)
                }
            }.bind(this))
        }
    },
    createUploadFileNode: function () {
        var accept = "*";
        if (!this.json.attachmentExtType || (this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType)) {
        } else {
            accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            }.bind(this));
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        debugger;
        this.attachmentController.doUploadAttachment({ "site": this.json.id }, this.form.documentAction.action, "uploadAttachment", { "id": this.form.businessData.document.id }, null, function (o) {
            if (o.id) {
                this.form.documentAction.getAttachment(o.id, this.form.businessData.document.id, function (json) {
                    if (json.data) {
                        if (!json.data.control) json.data.control = {};
                        this.attachmentController.addAttachment(json.data, o.messageId);
                        this.form.businessData.attachmentList.push(json.data);
                    }
                    this.attachmentController.checkActions();

                    this.setAttachmentBusinessData();
                    this.fireEvent("upload", [json.data]);
                    this.fireEvent("change");
                }.bind(this))
            }
            this.attachmentController.checkActions();
        }.bind(this), function (files) {
            if (files.length) {
                if ((files.length + this.attachmentController.attachments.length > this.attachmentController.options.attachmentCount) && this.attachmentController.options.attachmentCount > 0) {
                    var content = MWF.xApplication.cms.Xform.LP.uploadMore;
                    content = content.replace("{n}", this.attachmentController.options.attachmentCount);
                    this.form.notice(content, "error");
                    return false;
                }
            }
            return true;
        }.bind(this), true, accept, size, function (o) { //错误的回调
            if (o.messageId && this.attachmentController.messageItemList) {
                var message = this.attachmentController.messageItemList[o.messageId];
                if( message && message.node )message.node.destroy();
            }
        }.bind(this));

        // this.uploadFileAreaNode = new Element("div");
        // var html = "<input name=\"file\" type=\"file\" multiple/>";
        // this.uploadFileAreaNode.set("html", html);
        //
        // this.fileUploadNode = this.uploadFileAreaNode.getFirst();
        // this.fileUploadNode.addEvent("change", function(){
        //     this.validationMode();
        //     var files = this.fileUploadNode.files;
        //     if (files.length){
        //         if ((files.length+this.attachmentController.attachments.length > this.attachmentController.options.attachmentCount) && this.attachmentController.options.attachmentCount>0){
        //             var content = MWF.xApplication.cms.Xform.LP.uploadMore;
        //             content = content.replace("{n}", this.attachmentController.options.attachmentCount);
        //             this.form.notice(content, "error");
        //         }else{
        //             for (var i = 0; i < files.length; i++) {
        //                 var file = files.item(i);
        //
        //                 var formData = new FormData();
        //                 formData.append('file', file);
        //                 formData.append('site', this.json.id);
        //                 //formData.append('folder', folderId);
        //
        //                 this.form.documentAction.uploadAttachment(this.form.businessData.document.id ,function(o, text){
        //                     if (o.id){
        //                         this.form.documentAction.getAttachment(o.id, this.form.businessData.document.id, function(json){
        //                             if (json.data){
        //                                 this.attachmentController.addAttachment(json.data);
        //                                 this.form.businessData.attachmentList.push(json.data);
        //                             }
        //                             this.attachmentController.checkActions();
        //
        //                             this.fireEvent("upload", [json.data]);
        //                         }.bind(this))
        //                     }
        //                     this.attachmentController.checkActions();
        //                 }.bind(this), null, formData, file);
        //             }
        //         }
        //     }
        // }.bind(this));
    },

    deleteAttachments: function (e, node, attachments) {
        var names = [];
        attachments.each(function (attachment) {
            names.push(attachment.data.name);
        }.bind(this));

        var _self = this;
        this.form.confirm("warn", e, MWF.xApplication.cms.Xform.LP.deleteAttachmentTitle, MWF.xApplication.cms.Xform.LP.deleteAttachment + "( " + names.join(", ") + " )", 300, 120, function () {
            while (attachments.length) {
                var attachment = attachments.shift();
                _self.deleteAttachment(attachment);
            }
            this.close();
        }, function () {
            this.close();
        }, null, null, this.form.json.confirmStyle);
    },
    deleteAttachment: function (attachment) {
        this.fireEvent("delete", [attachment.data]);
        var id = attachment.data.id;
        this.form.documentAction.deleteAttachment(attachment.data.id, function (json) {
            this.attachmentController.removeAttachment(attachment);
            //this.form.businessData.attachmentList.erase( attachment.data )
            this.attachmentController.checkActions();

            for( var i=0; i<this.form.businessData.attachmentList.length; i++ ){
                var attData = this.form.businessData.attachmentList[i];
                if( attData.id === id ){
                    this.form.businessData.attachmentList.erase(attData);
                    break;
                }
            }

            if (this.form.officeList) {
                this.form.officeList.each(function (office) {
                    if (office.openedAttachment) {
                        if (office.openedAttachment.id == id) {
                            office.loadOfficeEdit();
                        }
                    }
                }.bind(this));
            }
            this.setAttachmentBusinessData();
            this.fireEvent("afterDelete", [attachment.data]);
            this.fireEvent("change");
        }.bind(this));
    },

    createReplaceFileNode: function (attachment) {
        var accept = "*";
        if (!this.json.attachmentExtType || this.json.attachmentExtType.indexOf("other") != -1 && !this.json.attachmentExtOtherType) {
        } else {
            accepts = [];
            var otherType = this.json.attachmentExtOtherType;
            this.json.attachmentExtType.each(function (v) {
                switch (v) {
                    case "word":
                        accepts.push(".doc, .docx, .dot, .dotx");
                        break;
                    case "excel":
                        accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");
                        break;
                    case "ppt":
                        accepts.push(".pptx, .ppt, .pot, .potx, .potm");
                        break;
                    case "txt":
                        accepts.push(".txt");
                        break;
                    case "pic":
                        accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");
                        break;
                    case "pdf":
                        accepts.push(".pdf");
                        break;
                    case "zip":
                        accepts.push(".zip, .rar");
                        break;
                    case "audio":
                        accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");
                        break;
                    case "video":
                        accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");
                        break;
                    case "other":
                        if (this.json.attachmentExtOtherType) accepts.push(this.json.attachmentExtOtherType);
                        break;
                }
            });
            accept = accepts.join(", ");
        }
        var size = 0;
        if (this.json.attachmentSize) size = this.json.attachmentSize.toFloat();
        this.attachmentController.doUploadAttachment({ "site": (this.json.site || this.json.id) }, this.form.documentAction.action, "replaceAttachment",
            { "id": attachment.data.id, "documentid": this.form.businessData.document.id }, null, function (o) {
                this.form.documentAction.getAttachment(attachment.data.id, this.form.businessData.document.id, function (json) {
                    if (!json.data.control) json.data.control = {};
                    attachment.data = json.data;
                    attachment.reload();

                    if (o.messageId && this.attachmentController.messageItemList) {
                        var message = this.attachmentController.messageItemList[o.messageId];
                        if( message && message.node )message.node.destroy();
                    }

                    this.attachmentController.checkActions();
                }.bind(this))
            }.bind(this), null, true, accept, size, function (o) { //错误的回调
                if (o.messageId && this.attachmentController.messageItemList) {
                    var message = this.attachmentController.messageItemList[o.messageId];
                    if( message && message.node )message.node.destroy();
                }
            }.bind(this));

        // this.replaceFileAreaNode = new Element("div");
        // var html = "<input name=\"file\" type=\"file\" multiple/>";
        // this.replaceFileAreaNode.set("html", html);
        //
        // this.fileReplaceNode = this.replaceFileAreaNode.getFirst();
        // this.fileReplaceNode.addEvent("change", function(){
        //     var files = this.fileReplaceNode.files;
        //     if (files.length){
        //         for (var i = 0; i < files.length; i++) {
        //             var file = files.item(i);
        //
        //             var formData = new FormData();
        //             formData.append('file', file);
        //             //    formData.append('site', this.json.id);
        //
        //             this.form.documentAction.replaceAttachment(attachment.data.id, this.form.businessData.document.id ,function(o, text){
        //                 this.form.documentAction.getAttachment(attachment.data.id, this.form.businessData.document.id, function(json){
        //                     attachment.data = json.data;
        //                     attachment.reload();
        //                     this.attachmentController.checkActions();
        //                 }.bind(this))
        //             }.bind(this), null, formData, file);
        //         }
        //     }
        // }.bind(this));
    },

    //小程序文件是否支持打开
    checkMiniProgramFile: function(ext) {
        var exts = ["doc", "docx", "xls", "xlsx", "ppt", "pptx", "pdf"];
        for(var i = 0; i < exts.length; i++){
            if(ext === exts[i]){
                return true;
            }
        }
        return false;
    },
    downloadAttachment: function (e, node, attachments) {
        if (this.form.businessData.document) {
            attachments.each(function (att) {
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": this.json.id });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({ 
                        url: '../file/download?attId=' + att.data.id + '&type=cms&documentId=' + this.form.businessData.document.id
                    });
                } else {
                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.documentAction.getAttachmentUrl(att.data.id, this.form.businessData.document.id, function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.documentAction.getAttachmentStream(att.data.id, this.form.businessData.document.id);
                    }
                }
                this.fireEvent("download",[att])
            }.bind(this));
        }
    },
    openAttachment: function (e, node, attachments) {
        if (this.form.businessData.document) {
            attachments.each(function (att) {
                if (window.o2android && window.o2android.downloadAttachment) {
                    window.o2android.downloadAttachment(att.data.id);
                } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.downloadAttachment) {
                    window.webkit.messageHandlers.downloadAttachment.postMessage({ "id": att.data.id, "site": this.json.id });
                } else if (window.wx && window.__wxjs_environment === 'miniprogram' && this.checkMiniProgramFile(att.data.extension)) { //微信小程序
                    wx.miniProgram.navigateTo({ 
                        url: '../file/download?attId=' + att.data.id + '&type=cms&documentId=' + this.form.businessData.document.id
                    });
                } else {
                    if (layout.mobile) {
                        //移动端 企业微信 钉钉 用本地打开 防止弹出自带浏览器 无权限问题
                        this.form.documentAction.getAttachmentUrl(att.data.id, this.form.businessData.document.id, function (url) {
                            var xtoken = Cookie.read(o2.tokenName);
                            window.location = o2.filterUrl(url + "?"+o2.tokenName+"=" + xtoken);
                        });
                    } else {
                        this.form.documentAction.getAttachmentData(att.data.id, this.form.businessData.document.id);
                    }

                }
                this.fireEvent("open",[att])
            }.bind(this));
        }
        //this.downloadAttachment(e, node, attachment);
    },
    getAttachmentUrl: function (attachment, callback) {
        if (this.form.businessData.document) {
            this.form.documentAction.getAttachmentUrl(attachment.data.id, this.form.businessData.document.id, callback);
        }
    },
    getTextData: function(){
        var data = [];
        this.attachmentController.attachments.each(function(att){
            var o = {
                "id": att.data.id,
                "person": att.data.person,
                "creatorUid": att.data.creatorUid,
                "name": att.data.name,
                "seqNumber": att.data.seqNumber,
                "length": att.data.length,
                "extension": att.data.extension,
                "lastUpdateTime": att.data.lastUpdateTime,
                "activityName": att.data.activityName,
                "control" : att.data.control
            }
            data.push(o);
        });
        return data;
    },
    validationConfigItem: function (routeName, data) {
        var flag = (data.status == "all") ? true : (routeName == "publish");
        if (flag) {
            var n = this.getData() || [];
            var v = (data.valueType == "value") ? n : n.length;
            switch (data.operateor) {
                case "isnull":
                    if (!v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v > data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v < data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v == data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v != data.value) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value) != -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value) == -1) {
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
});
MWF.xApplication.cms.Xform.AttachmentDg = MWF.CMSAttachmentDg = new Class({
    Extends: MWF.CMSAttachment,
    loadAttachmentController: function () {
        //MWF.require("MWF.widget.AttachmentController", function() {
        var options = {
            "style": this.json.style || "default",
            "title": MWF.xApplication.process.Xform.LP.attachmentArea,
            "listStyle": this.json.listStyle || "icon",
            "size": this.json.size || "max",
            "resize": (this.json.resize === "y" || this.json.resize === "true"),
            "attachmentCount": this.json.attachmentCount || 0,
            "isUpload": (this.json.isUpload === "y" || this.json.isUpload === "true"),
            "isDelete": (this.json.isDelete === "y" || this.json.isDelete === "true"),
            "isReplace": (this.json.isReplace === "y" || this.json.isReplace === "true"),
            "isDownload": (this.json.isDownload === "y" || this.json.isDownload === "true"),
            "isSizeChange": (this.json.isSizeChange === "y" || this.json.isSizeChange === "true"),
            "readonly": (this.json.readonly === "y" || this.json.readonly === "true" || this.json.isReadonly),
            "availableListStyles": this.json.availableListStyles ? this.json.availableListStyles : ["list", "seq", "icon", "preview"],
            "isDeleteOption": this.json.isDelete,
            "isReplaceOption": this.json.isReplace,
            "toolbarGroupHidden": this.json.toolbarGroupHidden || [],
            "ignoreSite": this.json.ignoreSite,
            "onOrder": function () {
                this.fireEvent("change");
            }.bind(this)
        };
        if (this.readonly) options.readonly = true;
        if (this.form.json.attachmentStyle) {
            options = Object.merge(options, this.form.json.attachmentStyle);
        }

        this.fireEvent("queryLoadController", [options]);

        this.attachmentController = new MWF.xApplication.process.Xform.AttachmentController(this.node, this, options);

        this.fireEvent("loadController");

        this.attachmentController.load();

        this.fireEvent("postLoadController");

        // var d = this._getBusinessData();
        // if (d) d.each(function (att) {
        //     this.attachmentController.addAttachment(att);
        // }.bind(this));
        if(this.json.ignoreSite) {
            ( this._getBusinessData() || [] ).each(function (att) {
                var flag = this.form.businessData.attachmentList.some(function (attData) {
                    return att.id === attData.id;
                }.bind(this));
                if(flag)this.attachmentController.addAttachment(att);
            }.bind(this));
        }else{
            this.form.businessData.attachmentList.each(function (att) {
                if (att.site === (this.json.site || this.json.id)) this.attachmentController.addAttachment(att);
            }.bind(this));
        }
        this.setAttachmentBusinessData();
    },
    setAttachmentBusinessData: function(){
        if (this.attachmentController) {
            if (this.attachmentController.attachments.length) {
                var values = this.attachmentController.attachments.map(function (d) {
                    return {
                        "control": d.data.control,
                        "name": d.data.name,
                        "id": d.data.id,
                        "person": d.data.person,
                        "creatorUid": d.data.creatorUid,
                        "seqNumber": d.data.seqNumber,
                        "length": d.data.length,
                        "extension": d.data.extension,
                        "lastUpdateTime": d.data.lastUpdateTime,
                        "activityName": d.data.activityName
                    };
                });
                this._setBusinessData(values);
            } else {
                this._setBusinessData([]);
            }
        }
    }
});
MWF.xDesktop.requireApp("process.Xform", "Button", null, false);
MWF.xApplication.cms.Xform.Button = MWF.CMSButton =  new Class({
	Extends: MWF.APPButton
}); 
MWF.xDesktop.requireApp("process.Xform", "Calendar", null, false);
MWF.xApplication.cms.Xform.Calendar = MWF.CMSCalendar =  new Class({
	Extends: MWF.APPCalendar
	// clickSelect: function() {
	// 	if (!this.calendar) {
	// 		MWF.require("MWF.widget.Calendar", function () {
	// 			this.calendar = new MWF.widget.Calendar(this.node.getFirst(), {
	// 				"style": "xform",
	// 				"isTime": (this.json.selectType === "datetime" || this.json.selectType === "time"),
	// 				"timeOnly": (this.json.selectType === "time"),
	// 				//"target": this.form.node,
	// 				"target": this.form.app.content,
	// 				"format": this.json.format,
	// 				"onComplate": function () {
	// 					this.validationMode();
	// 					//this.validation();
	// 					if (this.validation()) this._setBusinessData(this.getInputData("change"));
	// 					this.fireEvent("complete");
	// 				}.bind(this),
	// 				"onChange": function () {
	// 					this.fireEvent("change");
	// 				}.bind(this),
	// 				"onClear": function () {
	// 					this.validationMode();
	// 					//this.validation();
	// 					if (this.validation()) this._setBusinessData(this.getInputData("change"));
	// 					this.fireEvent("clear");
	// 					if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
	// 				}.bind(this),
	// 				"onShow": function () {
	// 					if (this.descriptionNode) this.descriptionNode.setStyle("display", "none");
	// 				}.bind(this),
	// 				"onHide": function () {
	// 					if (!this.node.getFirst().get("value")) if (this.descriptionNode)  this.descriptionNode.setStyle("display", "block");
	// 				}.bind(this)
	// 			});
	// 			this.calendar.show();
	// 		}.bind(this));
	// 	} else {
	// 		this.node.getFirst().focus();
	// 	}
	// }
}); 
MWF.xDesktop.requireApp("process.Xform", "Checkbox", null, false);
MWF.xApplication.cms.Xform.Checkbox = MWF.CMSCheckbox =  new Class({
	Extends: MWF.APPCheckbox
}); 
MWF.xDesktop.requireApp("process.Xform", "Datagrid", null, false);
MWF.xApplication.cms.Xform.Datagrid = MWF.CMSDatagrid =  new Class({
    Extends: MWF.APPDatagrid,
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == "publ" || routeName == "publish");
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
});

MWF.xApplication.cms.Xform.Datagrid$Title = MWF.CMSDatagrid$Title =  new Class({
    Extends: MWF.APPDatagrid$Title
});

MWF.xApplication.cms.Xform.Datagrid$Data = MWF.CMSDatagrid$Data =  new Class({
    Extends: MWF.APPDatagrid$Data
});
MWF.xDesktop.requireApp("process.Xform", "Htmleditor", null, false);
MWF.xApplication.cms.Xform.Htmleditor = MWF.CMSHtmleditor =  new Class({
	Extends: MWF.APPHtmleditor,

	_loadUserInterface: function(){
		this.node.empty();
        if (this.readonly){
            // var html = this.parseImage( this._getBusinessData() );
            // this.node.set("html", html);
            this.node.set("html", this._getBusinessData());
            this.node.setStyles({
                "-webkit-user-select": "text",
                "-moz-user-select": "text"
            });
            if( layout.mobile ){
                this.node.getElements("img").each( function( img ){
                    //if( img.height )img.erase("height");
                    img.setStyles({
                        "height": "auto",
                        "max-width" : "100%"
                    });
                }.bind(this))
            }
        }else{
            var config = Object.clone(this.json.editorProperties);
            if (this.json.config){
                if (this.json.config.code){
                    var obj = MWF.CMSMacro.exec(this.json.config.code, this);
                    Object.each(obj, function(v, k){
                        config[k] = v;
                    });
                }
            }

            this.loadCkeditor(config);
        }
	},
    // parseImage : function( html ){
    //     html = ( html || "" ).replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (img, capture) {
    //         if( img.indexOf( "data-id" ) > -1 && img.indexOf("setImageSrc()") > -1 ){
    //             var ids = img.match( /(?<=data-id=").*?(?=")/g );
    //             if( ids && ids.length > 0 ){
    //                 var newSrc = MWF.xDesktop.getImageSrc( ids[0] );
    //                 var newImg = this.replaceAttr( img, "img", "src", newSrc );
    //                 return newImg;
    //             }
    //         }
    //         return img;
    //     }.bind(this));
    //     return html
    // },
    // replaceAttr: function(src_str, tag, attr, val) {
    //     if(src_str.indexOf(attr) > 0) {
    //         //包含attr属性,替换attr
    //         var sub_reg = new RegExp(attr + '=[\'\"]([^"]*)[\'\"]', 'gi');
    //         return src_str.replace(sub_reg, attr +'=' + val);
    //     }else{
    //         //不包含attr属性,添加attr
    //         return src_str.substr(0, tag.length + 1) + ' ' + attr + '=' + val + ' ' + src_str.substr(tag.length + 2, src_str.length);
    //     }
    // },
    loadCkeditor: function(config){
        _self = this;
        // o2.load("../o2_lib/htmleditor/ckeditor4130/ckeditor.js", function(){

        COMMON.AjaxModule.loadDom("ckeditor", function(){
            CKEDITOR.disableAutoInline = true;
            var editorDiv = new Element("div").inject(this.node);
            var htmlData = this._getBusinessData();
            if (htmlData){
                editorDiv.set("html", htmlData);
            }else if (this.json.templateCode){
                editorDiv.set("html", this.json.templateCode);
            }

            var height = this.node.getSize().y;
            var editorConfig = config || {};

            if (this.form.json.mode=="Mobile"){
                if (!editorConfig.toolbar && !editorConfig.toolbarGroups){
                    editorConfig.toolbar = [
                        { name: 'paragraph',   items: [ 'Bold', 'Italic', "-" , 'TextColor', "BGColor", 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', "-", 'Undo', 'Redo' ] },
                        { name: 'basicstyles', items: [ 'Styles', 'FontSize']},
                        { name: 'insert', items : [ 'Image' ] }
                    ];
                }
            }
            // CKEDITOR.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/";
            // CKEDITOR.plugins.basePath = COMMON.contentPath+"/res/framework/htmleditor/ckeditor/plugins/";

            //editorConfig.filebrowserCurrentDocumentImage = function( e, callback ){
            //    _self.selectCurrentDocumentImage( e, callback );
            //};

            //editorConfig.filebrowserFilesImage = function( e, callback ){
            //    _self.selectCloudFilesImage( e, callback );
            //};

            editorConfig.base64Encode = (this.json.base64Encode === "y");
            editorConfig.localImageMaxWidth = 800;
            editorConfig.reference = this.form.businessData.document.id;
            editorConfig.referenceType = "cmsDocument";

            if(!editorConfig.language)editorConfig.language = MWF.language;

            if( editorConfig.skin )editorConfig.skin = "moono-lisa";
            this.editor = CKEDITOR.replace(editorDiv, editorConfig);
            this._loadEvents();

            //this.editor.on("loaded", function(){
            //    this._loadEvents();
            //}.bind(this));

            //this.setData(data)

            this.editor.on("change", function(){
                this._setBusinessData(this.getData());
            }.bind(this));
            //    this._loadEvents();
        }.bind(this));
    },
    getText : function(){
        return this.editor.document.getBody().getText();
    },
    getImages : function(){
        var result = [];
        var imgaes = this.editor.document.find("img");
        if( imgaes ){
            for( var i=0; i< imgaes.$.length; i++ ){
                result.push( imgaes.getItem(i).$ );
            }
        }
        return result;
    },
    getImageIds : function(){
        var result = [];
        var images = this.getImages();
        for( var i=0; i<images.length; i++ ){
            var img = images[i];
            if( img.getAttribute("data-id") ){
                result.push( img.getAttribute("data-id") )
            }
        }
        return result;
    },
    _loadStyles: function(){
        if (this.json.styles) this.node.setStyles(this.json.styles);
        this.node.setStyle("overflow","hidden");
    },
    //selectCurrentDocumentImage : function( e, callback ){
    //    var _self = this;
    //    MWF.xDesktop.requireApp("cms.Xform", "Attachment", function(){
    //        //_self.form.app.content
    //        _self.selector_doc = new MWF.xApplication.cms.Xform.Attachment( document.body , {}, _self.form, {})
    //        _self.selector_doc.loadAttachmentSelecter({
    //            "style" : "cms",
    //            "title": "选择本文档图片",
    //            "listStyle": "preview",
    //            "toBase64" : true,
    //            "selectType" : "images"
    //        }, function(url, data, base64Code){
    //            if(callback)callback(url, base64Code, data);
    //        });
    //
    //    }, true);
    //
    //},
    //selectCloudFilesImage : function( e, callback ){
    //    var _self = this;
    //    MWF.xDesktop.requireApp("File", "FileSelector", function(){
    //        //_self.form.app.content
    //        _self.selector_cloud = new MWF.xApplication.File.FileSelector( document.body ,{
    //            "style" : "default",
    //            "title": "选择云文件图片",
    //            "toBase64" : true,
    //            "listStyle": "preview",
    //            "selectType" : "images",
    //            "onPostSelectAttachment" : function(url, base64Code){
    //                if(callback)callback(url, base64Code);
    //            }
    //        });
    //        _self.selector_cloud.load();
    //    }, true);
    //
    //},
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == "publish");
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
}); 
MWF.xDesktop.requireApp("process.Xform", "ImageClipper", null, false);
MWF.xApplication.cms.Xform.ImageClipper = MWF.CMSImageClipper =  new Class({
	Extends: MWF.APPImageClipper,
    selectImage: function(d, callback){
        var clipperType = this.json.clipperType || "unrestricted";
        var ratio = 1;
        var description = "";
        var maxSize = 500;
        if( clipperType == "unrestricted" ){
            ratio = 0;
        }else if( clipperType == "size" ){
            var width = this.json.imageWidth.toInt();
            var height = this.json.imageHeight.toInt();
            ratio = width / height;
            //maxSize = Math.max( width, height );
            if( !isNaN( width ) && !isNaN( height )  ){
                description = MWF.LP.widget.pictureSize.replace(/{width}/g, width).replace(/{height}/g, height);
            }
        }else if( clipperType == "ratio" ){
            ratio = this.json.imageRatio || 1;
            description = MWF.LP.widget.pictureRatio.replace(/{ratio}/g, ratio);
        }
        MWF.xDesktop.requireApp("process.Xform", "widget.ImageClipper", function(){
            this.imageClipper = new MWF.xApplication.process.Xform.widget.ImageClipper(this.form.app, {
                "style": "default",
                "aspectRatio" : ratio,
                "description" : description,
                "imageUrl" : d ? MWF.xDesktop.getImageSrc( d ) : "",
                "reference" : this.form.businessData.document.id,
                "referenceType": "cmsDocument",
                "resultMaxSize" : maxSize,
                "onChange" : function(){
                    callback( { src : this.imageClipper.imageSrc, id : this.imageClipper.imageId } );
                }.bind(this)
            });
            this.imageClipper.load();
        }.bind(this));
    },
    validationConfigItem: function(routeName, data){
        var flag = (data.status=="all") ? true: (routeName == "publish");
        if (flag){
            var n = this.getData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
	
}); 
MWF.xDesktop.requireApp("process.Xform", "Label", null, false);
MWF.xApplication.cms.Xform.Label = MWF.CMSLabel =  new Class({
	Extends: MWF.APPLabel
});
MWF.xDesktop.requireApp("process.Xform", "Number", null, false);
MWF.xApplication.cms.Xform.Number = MWF.CMSNumber =  new Class({
    Extends: MWF.APPNumber,
    validationConfigItem: function(routeName, data){

        var flag = (data.status=="all") ? true: (routeName == "publish");
        if (flag){
            var n = this.getInputData();
            var v = (data.valueType=="value") ? n : n.length;
            switch (data.operateor){
                case "isnull":
                    if (!v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notnull":
                    if (v){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "gt":
                    if (v>data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "lt":
                    if (v<data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "equal":
                    if (v==data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "neq":
                    if (v!=data.value){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "contain":
                    if (v.toString().indexOf(data.value)!=-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
                case "notcontain":
                    if (v.toString().indexOf(data.value)==-1){
                        this.notValidationMode(data.prompt);
                        return false;
                    }
                    break;
            }
        }
        return true;
    }
});
MWF.xDesktop.requireApp("process.Xform", "Radio", null, false);
MWF.xApplication.cms.Xform.Radio = MWF.CMSRadio =  new Class({
	Extends: MWF.APPRadio
}); 
MWF.xDesktop.requireApp("process.Xform", "Select", null, false);
MWF.xApplication.cms.Xform.Select = MWF.CMSSelect =  new Class({
	Extends: MWF.APPSelect
}); 
MWF.xDesktop.requireApp("process.Xform", "Tab", null, false);
MWF.xApplication.cms.Xform.Tab = MWF.CMSTab =  new Class({
	Extends: MWF.APPTab
});

MWF.xApplication.cms.Xform.tab$Page = MWF.CMSTab$Page = new Class({
	Extends: MWF.APPTab$Page
});
MWF.xApplication.cms.Xform.tab$Content = MWF.CMSTab$Content = new Class({
	Extends: MWF.APPTab$Content
});
MWF.xDesktop.requireApp("process.Xform", "Table", null, false);
MWF.xApplication.cms.Xform.Table = MWF.CMSTable =  new Class({
	Extends: MWF.APPTable
});
MWF.xApplication.cms.Xform.Table$Td = MWF.CMSTable$Td =  new Class({
	Extends: MWF.APPTable$Td
});
MWF.xDesktop.requireApp("process.Xform", "Textarea", null, false);
MWF.xApplication.cms.Xform.Textarea = MWF.CMSTextarea =  new Class({
	Extends: MWF.APPTextarea
}); 