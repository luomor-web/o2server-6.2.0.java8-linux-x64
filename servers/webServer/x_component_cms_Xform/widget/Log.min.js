MWF.xApplication.cms.Xform.widget=MWF.xApplication.cms.Xform.widget||{},MWF.xApplication.cms.Xform.widget.Log=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",mode:"table",documentId:"",textStyle:""},initialize:function(t,e,i){this.setOptions(i),this.app=t,this.node=e,this.path="../x_component_cms_Xform/widget/$Log/",this.cssPath="../x_component_cms_Xform/widget/$Log/"+this.options.style+"/css.wcss",this._loadCss(),MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,!1),this.lp=MWF.xApplication.cms.Xform.LP},load:function(){this.items=[],this.documents={},this.isItemsLoaded=!1,this.isItemLoadding=!1,this.loadItemQueue=0,this.count=0,this.lineHeight="text"!=this.options.mode?32:25,this.countPerPage=20,this.container=new Element("div",{styles:this.css.container}).inject(this.node),this.loadTitle(),this.loadContent(),this.loadElementList(),this.loadBottom()},loadTitle:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.lp.readedLogTitle}).inject(this.container)},loadTotal:function(){this.getAction(function(){this.options.documentId&&this.restAction.invoke({name:"getReadCount",async:!0,parameter:{docId:this.options.documentId},success:function(t){t&&t.data&&(this.titleCountNode=new Element("div",{styles:this.css.titleCountNode,text:this.lp.readedCountText.replace("{count}",t.data.count).replace("{person}",this.dataCount)}).inject(this.titleNode))}.bind(this)})}.bind(this))},loadContent:function(){this.contentScrollNode=new Element("div",{styles:this.css.contentScrollNode}).inject(this.container),this.contentScrollNode.setStyles({width:this.node.getSize().x-10,"margin-right":"10px"}),this.contentWrapNode=new Element("div",{styles:this.css.contentWrapNode}).inject(this.contentScrollNode),this.setScroll(),"table"==this.options.mode&&this.loadItemTitleTable()},loadBottom:function(){var t=new Element("div",{styles:this.css.bottomNode}).inject(this.container),e=new Element("div",{styles:this.css.bottomResizeNode,text:"â—¢"}).inject(t),i=this.contentScrollNode.getSize().x;this.contentScrollNode.makeResizable({handle:e,limit:{x:[i,i],y:[50,null]},onDrag:function(){var t=this.contentScrollNode.getSize().y;t>this.lineHeight*this.countPerPage-20&&(this.countPerPage=parseInt(t/this.lineHeight)+2),this.contentScrollNode.fireEvent("resize")}.bind(this),onComplete:function(){this.scrollBar.checkScroll(),this.loadElementList()}.bind(this)})},loadElementList:function(t){this.isItemsLoaded||(this.isItemLoadding?this.loadItemQueue++:(this.isItemLoadding=!0,this._getCurrentPageData(function(t){var e=this.dataCount=t.count;this.titleCountNode||this.loadTotal(),0==this.items.length&&this.setSize(),e<=this.items.length&&(this.isItemsLoaded=!0),t.data&&"array"==typeOf(t.data)&&t.data.each(function(t){var e=t.id;if(!this.documents[e]){var i=this._createDocument(t,this.items.length);this.items.push(i),this.documents[e]=i}}.bind(this)),this.isItemLoadding=!1,this.loadItemQueue>0&&(this.loadItemQueue--,this.loadElementList())}.bind(this),t)))},_getCurrentPageData:function(t){var e=this.items.length?this.items[this.items.length-1].data.id:"(0)";this.getAction(function(){this.options.documentId&&this.restAction.invoke({name:"listReadedLog",async:!0,parameter:{docId:this.options.documentId,id:e,count:this.countPerPage},success:function(e){t&&t(e)}.bind(this)})}.bind(this))},getAction:function(t){this.action?t&&t():MWF.require("MWF.xDesktop.Actions.RestActions",function(){this.restAction=new MWF.xDesktop.Actions.RestActions("","x_cms_assemble_control",""),this.restAction.getActions=function(t){this.actions={getReadCount:{uri:"/jaxrs/document/{docId}/view/count"},listReadedLog:{uri:"/jaxrs/viewrecord/document/{docId}/filter/list/{id}/next/{count}",method:"GET"}},t&&t()},t&&t()}.bind(this))},setSize:function(){var t=this.lineHeight,e="text"==this.options.mode?10:8;if(this.dataCount>e)var i=e*t-15;else if(this.dataCount<=1)i=1*t;else i=this.dataCount*t;"text"!=this.options.mode&&(i+=t),this.contentScrollNode.setStyle("height",i+"px")},setScroll:function(){MWF.require("MWF.widget.ScrollBar",function(){this.scrollBar=new MWF.widget.ScrollBar(this.contentScrollNode,{indent:!1,style:"default",where:"before",distance:60,friction:4,axis:{x:!1,y:!0},onScroll:function(t){var e=this.contentScrollNode.getScrollSize(),i=this.contentScrollNode.getSize();t+30>e.y-i.y&&(this.isItemsLoaded||this.loadElementList())}.bind(this)})}.bind(this))},_createDocument:function(t){return{node:"text"==this.options.mode?this.options.textStyle?this.loadItemNodeText(t):this.loadItemNodeDefault(t):this.loadItemNodeTable(t),data:t}},loadItemTitleTable:function(){var t=this.contentScrollNode.getSize().x;this.table=new Element("table",{styles:this.css.logTable,border:"0",cellSpacing:"0",cellpadding:"3px",width:t-10}).inject(this.contentWrapNode),this.tbody=new Element("tbody").inject(this.table),this.table.setStyles({"margin-left":"8px"});var e=new Element("tr").inject(this.tbody);e.setStyles(this.css.logTableTitleTr),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.person),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.department),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.firstDate),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.readDate),new Element("td",{styles:this.css.logTableTitle}).inject(e).set("text",this.lp.readCount)},loadItemNodeTable:function(t){var e=new Element("tr").inject(this.tbody);e.setStyles(this.css.logTableContentTr);var i=new Element("td",{styles:this.css.logTableContent}).inject(e);i.set("text",this.getShortName(t.viewerName)||""),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",this.getShortName(t.viewerUnitName)||""),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.createTime),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.lastViewTime),(i=new Element("td",{styles:this.css.logTableContent}).inject(e)).set("text",t.viewCount)},loadItemNodeText:function(t,e){var i=new Element("div",{styles:this.css.defaultItemNode}).inject(this.contentWrapNode),s=e||this.options.textStyle;return s=(s=(s=(s=(s=(s=s.replace(/\{person\}/g,this.getShortName(t.viewerName))).replace(/\{unitName\}/g,this.getShortName(t.viewerUnitName)||"")).replace(/\{topUnitName\}/g,this.getShortName(t.viewerTopUnitName)||"")).replace(/\{firstDate\}/g,t.createTime)).replace(/\{date\}/g,t.lastViewTime)).replace(/\{count\}/g,t.viewCount),i.set("html",s),i},loadItemNodeDefault:function(t){return this.loadItemNodeText(t,this.lp.defaultReadedLogText)},getShortName:function(t){return t&&t.contains("@")?t.split("@")[0]:t}});