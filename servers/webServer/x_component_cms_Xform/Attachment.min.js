MWF.xDesktop.requireApp("process.Xform","Attachment",null,!1),MWF.xApplication.cms.Xform.AttachmentController=new Class({Extends:MWF.xApplication.process.Xform.AttachmentController,options:{checkTextEnable:!1},openInOfficeControl:function(t,e){e&&(e.openedAttachment&&e.openedAttachment.id===t.id||(e.save(),MWF.Actions.get("x_cms_assemble_control").getAttachmentUrl(t.id,this.module.form.businessData.document.id,function(a){e.openedAttachment={id:t.id,site:this.module.json.name,name:t.name},e.officeOCX.BeginOpenFromURL(a,!0,this.readonly)}.bind(this))))},setAttachmentConfig:function(t,e,a){if(this.selectedAttachments.length){var n=t.retrieve("data-value"),i=e.retrieve("data-value"),s=a.retrieve("data-value"),o=[],h=[],r=[],c=[],d=[],l=[];n&&n.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,a=e.length,n=e.substring(a-1,a);"U"===n&&o.push(e),"I"===n&&h.push(e)})),i&&i.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,a=e.length,n=e.substring(a-1,a);"U"===n&&r.push(e),"I"===n&&c.push(e)})),s&&s.each((function(t){var e="string"===typeOf(t)?t:t.distinguishedName,a=e.length,n=e.substring(a-1,a);"U"===n&&d.push(e),"I"===n&&l.push(e)})),this.selectedAttachments.each(function(t){t.data.readUnitList=o,t.data.readIdentityList=h,t.data.editUnitList=r,t.data.editIdentityList=c,t.data.controllerUnitList=d,t.data.controllerIdentityList=l,o2.Actions.get("x_cms_assemble_control").configAttachment(t.data.id,this.module.form.businessData.document.id,t.data)}.bind(this))}},sortByNumber:function(t){return t.sort(function(t,e){return e.data.seqNumber?t.data.seqNumber?t.data.seqNumber-e.data.seqNumber:-1:1}.bind(this))},sortAttachment:function(t){t.getChildren().each(function(t,e){var a=t.retrieve("att",null);a&&(a.data.seqNumber=e,o2.Actions.load("x_cms_assemble_control").FileInfoAction.changeSeqNumber(a.data.id,this.module.form.businessData.document.id,e))}.bind(this)),this.attachments=this.attachments.sort(function(t,e){return e.data.seqNumber?t.data.seqNumber?t.data.seqNumber-e.data.seqNumber:-1:1}.bind(this)),this.reloadAttachments(),this.fireEvent("order")}}),MWF.xApplication.cms.Xform.Attachment=MWF.CMSAttachment=new Class({Extends:MWF.APPAttachment,_loadUserInterface:function(){this.node.empty(),this.loadAttachmentController(),this.fireEvent("load")},loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.cms.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isPreviewAtt:"y"===this.json.isPreviewAtt||"true"===this.json.isPreviewAtt,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json&&this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.cms.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},loadAttachmentSelecter:function(t,e){MWF.require("MWF.widget.AttachmentSelector",function(){var a={title:MWF.xApplication.cms.Xform.LP.selectAttachment,listStyle:"icon",selectType:"all",size:"max",attachmentCount:0,isUpload:!0,isDelete:!0,isReplace:!0,isDownload:!0,toBase64:!0,base64MaxSize:800,readonly:!1};a=Object.merge(a,t),this.readonly&&(a.readonly=!0),this.attachmentController=new MWF.widget.AttachmentSelector(this.node,this,a),this.attachmentController.load(),this.postSelect=e,this.form.businessData.attachmentList.each(function(t){this.attachmentController.addAttachment(t)}.bind(this))}.bind(this))},selectAttachment:function(t,e,a){if(a.length>0){var n=a[a.length-1].data;this.form.documentAction.getAttachmentUrl(n.id,this.form.businessData.document.id,function(t){this.attachmentController.options.toBase64?this.form.documentAction.getSubjectAttachmentBase64(n.id,this.attachmentController.options.base64MaxSize,function(e){var a=e.data?"data:image/png;base64,"+e.data.value:null;this.postSelect&&this.postSelect(t,n,a)}.bind(this)):this.postSelect&&this.postSelect(t,n)}.bind(this))}},createUploadFileNode:function(){var t="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each(function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg, .png");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}}.bind(this)),t=accepts.join(", ")}var e=0;this.json.attachmentSize&&(e=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.id},this.form.documentAction.action,"uploadAttachment",{id:this.form.businessData.document.id},null,function(t){t.id&&this.form.documentAction.getAttachment(t.id,this.form.businessData.document.id,function(e){e.data&&(e.data.control||(e.data.control={}),this.attachmentController.addAttachment(e.data,t.messageId),this.form.businessData.attachmentList.push(e.data)),this.attachmentController.checkActions(),this.setAttachmentBusinessData(),this.fireEvent("upload",[e.data]),this.fireEvent("change")}.bind(this)),this.attachmentController.checkActions()}.bind(this),function(t){if(t.length&&t.length+this.attachmentController.attachments.length>this.attachmentController.options.attachmentCount&&this.attachmentController.options.attachmentCount>0){var e=MWF.xApplication.cms.Xform.LP.uploadMore;return e=e.replace("{n}",this.attachmentController.options.attachmentCount),this.form.notice(e,"error"),!1}return!0}.bind(this),!0,t,e,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},deleteAttachments:function(t,e,a){var n=[];a.each(function(t){n.push(t.data.name)}.bind(this));var i=this;this.form.confirm("warn",t,MWF.xApplication.cms.Xform.LP.deleteAttachmentTitle,MWF.xApplication.cms.Xform.LP.deleteAttachment+"( "+n.join(", ")+" )",300,120,(function(){for(;a.length;){var t=a.shift();i.deleteAttachment(t)}this.close()}),(function(){this.close()}),null,null,this.form.json.confirmStyle)},deleteAttachment:function(t){this.fireEvent("delete",[t.data]);var e=t.data.id;this.form.documentAction.deleteAttachment(t.data.id,function(a){this.attachmentController.removeAttachment(t),this.attachmentController.checkActions();for(var n=0;n<this.form.businessData.attachmentList.length;n++){var i=this.form.businessData.attachmentList[n];if(i.id===e){this.form.businessData.attachmentList.erase(i);break}}this.form.officeList&&this.form.officeList.each(function(t){t.openedAttachment&&t.openedAttachment.id==e&&t.loadOfficeEdit()}.bind(this)),this.setAttachmentBusinessData(),this.fireEvent("afterDelete",[t.data]),this.fireEvent("change")}.bind(this))},createReplaceFileNode:function(t){var e="*";if(!this.json.attachmentExtType||-1!=this.json.attachmentExtType.indexOf("other")&&!this.json.attachmentExtOtherType);else{accepts=[];this.json.attachmentExtOtherType;this.json.attachmentExtType.each((function(t){switch(t){case"word":accepts.push(".doc, .docx, .dot, .dotx");break;case"excel":accepts.push(".xls, .xlsx, .xlsm, .xlt, .xltx");break;case"ppt":accepts.push(".pptx, .ppt, .pot, .potx, .potm");break;case"txt":accepts.push(".txt");break;case"pic":accepts.push(".bmp, .gif, .psd, .jpeg, .jpg");break;case"pdf":accepts.push(".pdf");break;case"zip":accepts.push(".zip, .rar");break;case"audio":accepts.push(".mp3, .wav, .wma, .wmv, .flac, .ape");break;case"video":accepts.push(".avi, .mkv, .mov, .ogg, .mp4, .mpeg");break;case"other":this.json.attachmentExtOtherType&&accepts.push(this.json.attachmentExtOtherType)}})),e=accepts.join(", ")}var a=0;this.json.attachmentSize&&(a=this.json.attachmentSize.toFloat()),this.attachmentController.doUploadAttachment({site:this.json.site||this.json.id},this.form.documentAction.action,"replaceAttachment",{id:t.data.id,documentid:this.form.businessData.document.id},null,function(e){this.form.documentAction.getAttachment(t.data.id,this.form.businessData.document.id,function(a){if(a.data.control||(a.data.control={}),t.data=a.data,t.reload(),e.messageId&&this.attachmentController.messageItemList){var n=this.attachmentController.messageItemList[e.messageId];n&&n.node&&n.node.destroy()}this.attachmentController.checkActions()}.bind(this))}.bind(this),null,!0,e,a,function(t){if(t.messageId&&this.attachmentController.messageItemList){var e=this.attachmentController.messageItemList[t.messageId];e&&e.node&&e.node.destroy()}}.bind(this))},checkMiniProgramFile:function(t){for(var e=["doc","docx","xls","xlsx","ppt","pptx","pdf"],a=0;a<e.length;a++)if(t===e[a])return!0;return!1},downloadAttachment:function(t,e,a){this.form.businessData.document&&a.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=cms&documentId="+this.form.businessData.document.id}):layout.mobile?this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.documentAction.getAttachmentStream(t.data.id,this.form.businessData.document.id),this.fireEvent("download",[t])}.bind(this))},openAttachment:function(t,e,a){this.form.businessData.document&&a.each(function(t){window.o2android&&window.o2android.downloadAttachment?window.o2android.downloadAttachment(t.data.id):window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.downloadAttachment?window.webkit.messageHandlers.downloadAttachment.postMessage({id:t.data.id,site:this.json.id}):window.wx&&"miniprogram"===window.__wxjs_environment&&this.checkMiniProgramFile(t.data.extension)?wx.miniProgram.navigateTo({url:"../file/download?attId="+t.data.id+"&type=cms&documentId="+this.form.businessData.document.id}):layout.mobile?this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,(function(t){var e=Cookie.read(o2.tokenName);window.location=o2.filterUrl(t+"?"+o2.tokenName+"="+e)})):this.form.documentAction.getAttachmentData(t.data.id,this.form.businessData.document.id),this.fireEvent("open",[t])}.bind(this))},getAttachmentUrl:function(t,e){this.form.businessData.document&&this.form.documentAction.getAttachmentUrl(t.data.id,this.form.businessData.document.id,e)},getTextData:function(){var t=[];return this.attachmentController.attachments.each((function(e){var a={id:e.data.id,person:e.data.person,creatorUid:e.data.creatorUid,name:e.data.name,seqNumber:e.data.seqNumber,length:e.data.length,extension:e.data.extension,lastUpdateTime:e.data.lastUpdateTime,activityName:e.data.activityName,control:e.data.control};t.push(a)})),t},validationConfigItem:function(t,e){if("all"==e.status||"publish"==t){var a=this.getData()||[],n="value"==e.valueType?a:a.length;switch(e.operateor){case"isnull":if(!n)return this.notValidationMode(e.prompt),!1;break;case"notnull":if(n)return this.notValidationMode(e.prompt),!1;break;case"gt":if(n>e.value)return this.notValidationMode(e.prompt),!1;break;case"lt":if(n<e.value)return this.notValidationMode(e.prompt),!1;break;case"equal":if(n==e.value)return this.notValidationMode(e.prompt),!1;break;case"neq":if(n!=e.value)return this.notValidationMode(e.prompt),!1;break;case"contain":if(-1!=n.indexOf(e.value))return this.notValidationMode(e.prompt),!1;break;case"notcontain":if(-1==n.indexOf(e.value))return this.notValidationMode(e.prompt),!1}}return!0}}),MWF.xApplication.cms.Xform.AttachmentDg=MWF.CMSAttachmentDg=new Class({Extends:MWF.CMSAttachment,loadAttachmentController:function(){var t={style:this.json.style||"default",title:MWF.xApplication.process.Xform.LP.attachmentArea,listStyle:this.json.listStyle||"icon",size:this.json.size||"max",resize:"y"===this.json.resize||"true"===this.json.resize,attachmentCount:this.json.attachmentCount||0,isUpload:"y"===this.json.isUpload||"true"===this.json.isUpload,isDelete:"y"===this.json.isDelete||"true"===this.json.isDelete,isReplace:"y"===this.json.isReplace||"true"===this.json.isReplace,isDownload:"y"===this.json.isDownload||"true"===this.json.isDownload,isSizeChange:"y"===this.json.isSizeChange||"true"===this.json.isSizeChange,readonly:"y"===this.json.readonly||"true"===this.json.readonly||this.json.isReadonly,availableListStyles:this.json.availableListStyles?this.json.availableListStyles:["list","seq","icon","preview"],isDeleteOption:this.json.isDelete,isReplaceOption:this.json.isReplace,toolbarGroupHidden:this.json.toolbarGroupHidden||[],ignoreSite:this.json.ignoreSite,onOrder:function(){this.fireEvent("change")}.bind(this)};this.readonly&&(t.readonly=!0),this.form.json.attachmentStyle&&(t=Object.merge(t,this.form.json.attachmentStyle)),this.fireEvent("queryLoadController",[t]),this.attachmentController=new MWF.xApplication.process.Xform.AttachmentController(this.node,this,t),this.fireEvent("loadController"),this.attachmentController.load(),this.fireEvent("postLoadController"),this.json.ignoreSite?(this._getBusinessData()||[]).each(function(t){this.form.businessData.attachmentList.some(function(e){return t.id===e.id}.bind(this))&&this.attachmentController.addAttachment(t)}.bind(this)):this.form.businessData.attachmentList.each(function(t){t.site===(this.json.site||this.json.id)&&this.attachmentController.addAttachment(t)}.bind(this)),this.setAttachmentBusinessData()},setAttachmentBusinessData:function(){if(this.attachmentController)if(this.attachmentController.attachments.length){var t=this.attachmentController.attachments.map((function(t){return{control:t.data.control,name:t.data.name,id:t.data.id,person:t.data.person,creatorUid:t.data.creatorUid,seqNumber:t.data.seqNumber,length:t.data.length,extension:t.data.extension,lastUpdateTime:t.data.lastUpdateTime,activityName:t.data.activityName}}));this._setBusinessData(t)}else this._setBusinessData([])}});