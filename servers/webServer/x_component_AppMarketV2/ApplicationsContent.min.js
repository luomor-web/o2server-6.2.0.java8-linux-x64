MWF.xApplication.AppMarketV2.ApplicationsContent=new Class({Implements:[Options,Events],options:{view:"applicationsContent.html"},initialize:function(t,a,n){this.setOptions(n),this.app=t,this.container=a,this.viewPath=this.app.path+this.app.options.style+"/"+this.options.view,this.querydata={},this.currentcategory={name:this.app.lp.all,count:0},this.load()},load:function(){this.container.loadHtml(this.viewPath,{bind:{lp:this.app.lp},module:this},function(){this.loadApplication(function(){this.fireEvent("load")}.bind(this))}.bind(this))},loadApplication:function(t){this.isLoading||(this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){t&&t()}}))},focusAppSearch:function(){this.searchAppNode.addClass("layout_content_taskbar_area_search_box_focus"),this.searchAppNode.addClass("mainColor_border"),this.searchAppIconNode.addClass("icon_search_focus")},blurAppSearch:function(){this.searchAppNode.removeClass("layout_content_taskbar_area_search_box_focus"),this.searchAppNode.removeClass("mainColor_border"),this.searchAppIconNode.removeClass("icon_search_focus")},searchAppInputKeyDown:function(t){this.searchAppInputNode.get("value")?this.searchAppClearNode.addClass("icon_clear"):this.searchAppClearNode.removeClass("icon_clear"),13===t.keyCode&&this.doAppSearch()},clearAppSearch:function(){this.searchAppInputNode.set("value",""),this.searchAppClearNode.removeClass("icon_clear"),this.clearSearchResult()},doAppSearch:function(){var t=this.searchAppInputNode.get("value");t?(this.querydata.name=t,this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){callback&&callback()}})):this.clearSearchResult()},clearSearchResult:function(){this.querydata.name="",this.applicationsContentV?this.applicationsContentV.load():this.applicationsContentV=new MWF.xApplication.AppMarketV2.ApplicationsContent.Applications(this,{onLoad:function(){callback&&callback()}})}}),MWF.xApplication.AppMarketV2.ApplicationsContent.Applications=new Class({Implements:[Options,Events],options:{type:"applications"},initialize:function(t,a){this.setOptions(a),this.content=t,this.app=this.content.app,this.actions=this.app.actions,this.container=this.content.container,this.collectToken="",this.collectUrl="",this.page=1,this.pageSize=100,this.load()},load:function(){this.loadAppCategorys(),this.loadApplications()},loadAppCategorys:function(){this.actions.MarketAction.listCategory(function(t){t.data&&t.data.valueList&&this.showCategorys(t.data.valueList),this.fireEvent("load")}.bind(this))},loadApplications:function(){this.emptyLoadContent(),""!=this.collectToken&&""!=this.collectUrl||this.actions.CollectAction.login(function(t){t.type&&"success"==t.type&&(data=t.data,this.collectUrl=data.collectUrl,this.collectToken=data.collectToken)}.bind(this),null,!1),this.actions.MarketAction.listPaging(this.page,this.pageSize,this.content.querydata,function(t){t.data&&t.data.length&&(this.content.currentcategory.name=""!=this.content.querydata.category&&this.content.querydata.category?this.content.querydata.category:this.app.lp.all,this.content.currentcategory.count=t.count,this.showApplications(t.data)),this.fireEvent("load")}.bind(this)),this.loadBbsInfo(this)},reload:function(){this.content.isLoading||(this.loadAppCategorys(),this.loadApplications())},emptyLoadContent:function(){this.content.appList.empty(),this.content.isLoading=!1},showCategorys:function(t){var a=this.content.appCategory;a.empty(),this.loadCertainCategory(a,this.app.lp.all),t.each(function(t,n){this.loadCertainCategory(a,t)}.bind(this))},loadBbsInfo:function(t){var a=null,n=t.collectUrl+"/o2_collect_assemble/jaxrs/collect/config/key/(0)?time="+(new Date).getMilliseconds();new Request.JSON({url:n,headers:{"x-debugger":!0,Authorization:t.collectToken,"c-token":t.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,n){a=t,this.bbsUrlPath=a.data.bbsUrlPath,this.bbsUrl=a.data.bbsUrl}.bind(this),onFailure:function(t){o2.runCallback(callback,"requestFailure",[t])}.bind(this),onError:function(t,a){o2.runCallback(callback,"error",[t,a])}.bind(this)}).send()},loadCommentsGrade:function(t){var a=null,n=this.bbsUrlPath+"/x_bbs_assemble_control/jaxrs/subject/statgrade/sectionName/"+encodeURI(this.app.lp.title)+"/subjectType/"+encodeURI(t.name)+"?time="+(new Date).getMilliseconds();return new Request.JSON({url:n,headers:{"x-debugger":!0,Authorization:this.collectToken,"c-token":this.collectToken},secure:!1,method:"get",async:!1,withCredentials:!0,contentType:"application/json",crossDomain:!0,onSuccess:function(t,n){a=t}.bind(this)}).send(),a},loadCertainCategory:function(t,a){var n=this,e=new Element("span",{text:a,class:"o2_appmarket_appcategory"}).inject(t);e.store("data",a),n.content.querydata.category&&(""==n.content.querydata.category&&a==n.app.lp.all||n.content.querydata.category==a)&&e.removeClass("o2_appmarket_appcategory").addClass("mainColor_color").addClass("o2_appmarket_appcategory_current"),e.addEvents({mouseover:function(){this.addClass("o2_appmarket_appcategory_tab_over")},mouseout:function(){this.removeClass("o2_appmarket_appcategory_tab_over")},click:function(t){var a=this.retrieve("data");if(this.getParent().getElements(".o2_appmarket_appcategory_current").removeClass("mainColor_color").removeClass("o2_appmarket_appcategory_current").addClass("o2_appmarket_appcategory"),this.removeClass("o2_appmarket_appcategory").addClass("mainColor_color").addClass("o2_appmarket_appcategory_current"),a){a==n.app.lp.all?n.content.querydata.category="":n.content.querydata.category=a;var e=n.content.searchAppInputNode.get("value");null==e&&(e=""),n.content.querydata.name=e,n.loadApplications()}}})},showApplications:function(t){var a=this.content.appList,n=a.clientWidth-40;rowappnum=parseInt(n/240),rowappmargin=240*(n/240-rowappnum)/(rowappnum-1),rowappmargin<10&&(rowappnum-=1,rowappmargin=240*(n/240-rowappnum)/(rowappnum-1)),t.each(function(t,n){this.loadCertainApplication(a,t,n,rowappnum,rowappmargin)}.bind(this))},loadCertainApplication:function(t,a,n,e,i){var o=this.loadCommentsGrade(a),s=new Element("div",{class:"o2_appmarket_application"}).inject(t);(n+1)%e!=0?s.setStyle("margin-right",i+"px"):s.setStyle("margin-right","0px");var p=new Element("div",{class:"o2_appmarket_application_icon"}).inject(s);p.setStyle("background-image","url(data:image/png;base64,"+a.icon+")");var c=new Element("div",{class:"o2_appmarket_application_info"}).inject(s),l=(new Element("div",{text:a.name,class:"o2_appmarket_application_info_name",title:a.name}).inject(c),new Element("div",{class:"o2_appmarket_application_info_recommend"}).inject(c)),r=0,h=0,d=0,u=o.data,m=["0","0","0","0","0"];u.each(function(t){m[parseInt(t.grade)-1]=t.count,r+=parseInt(t.count)}.bind(this)),m.each((function(t,a){d+=parseInt(t)*(a+1)})),r>0&&(h=this.numberFix(d/r,1));for(var _=parseInt(h),g=h-_,f=0;f<_;f++)new Element("img",{src:this.app.iconPath+"blackfiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(l);g>=.5&&(new Element("img",{src:this.app.iconPath+"halffiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(l),_++);for(f=0;f<5-_;f++)new Element("img",{src:this.app.iconPath+"whitefiveangular.png",class:"o2_appmarket_application_info_starpic"}).inject(l);new Element("div",{text:a.category,class:"o2_appmarket_application_info_category"}).inject(c);var y=new Element("div",{class:"o2_appmarket_application_info_bottom"}).inject(c),C=(new Element("div",{text:0==a.price?"Free":a.price+"",class:"o2_appmarket_application_info_bottom_free"}).inject(y),new Element("div",{class:"o2_appmarket_application_info_bottom_button mainColor_bg"}).inject(y)),v=this.app.lp.setup;a.installedVersion&&""!=a.installedVersion&&(v=a.installedVersion==a.version?this.app.lp.setupDone:this.app.lp.update);new Element("div",{text:v,class:"o2_appmarket_application_info_bottom_button_text"}).inject(C);var b=this;p.store("data",a),p.addEvents({mouseover:function(){},mouseout:function(){},click:function(t){var a=this.retrieve("data");a&&b.open(t,a)}}),C.store("data",a),C.addEvents({click:function(t){var a=this.retrieve("data");a&&b.installapp(t,a)}})},installapp:function(t,a){var n=t.target.getPosition(),e={event:{x:n.x+40,y:n.y}},i=""==a.installedVersion?this.app.lp.confirmsetupTitle:this.app.lp.confirmupdateTitle,o=""==a.installedVersion?this.app.lp.confirmsetupContent:this.app.lp.confirmupdateContent,s=this;s.app.confirm("warn",e,i,o,300,120,(function(){s.app.mask(),s.actions.MarketAction.installOrUpdate(a.id,function(t){data=t.data,s.app.notice(a.name+" "+s.app.lp.setupSuccess,"success"),s.app.unmask()}.bind(s),function(t){data=t.data,s.app.unmask()}.bind(s),!0),this.close()}),(function(){this.close()}),null,null,"o2")},open:function(t,a){var n={};n.appid=a.id,n.appname=a.name,layout.openApplication(t,"AppMarketV2.Application",n)},createLoading:function(t,a){this.app.content.mask({destroyOnHide:!0,style:{opacity:.7,"background-color":"#999"},loading:!0})},numberFix:function(t,a){for(var n="",e=0;e<a;e++)n+="0";var i=1+n,o=Math.round(parseFloat(t)*i)/i,s=o.toString().split(".");return 1==s.length?o=o.toString():s.length>1?(s[1].length<a&&(o=o.toString()+"0"),o):void 0},clearLoading:function(){this.app.content.unmask()}});