MWF.xApplication=MWF.xApplication||{},MWF.xApplication.query=MWF.xApplication.query||{},MWF.xApplication.query.TableDesigner=MWF.xApplication.query.TableDesigner||{},MWF.APPDTBD=MWF.xApplication.query.TableDesigner,MWF.xDesktop.requireApp("query.TableDesigner","lp."+MWF.language,null,!1),MWF.xDesktop.requireApp("query.ViewDesigner","ViewBase",null,!1),MWF.xDesktop.requireApp("query.TableDesigner","Property",null,!1),MWF.xApplication.query.TableDesigner.Table=new Class({Extends:MWF.xApplication.query.ViewDesigner.ViewBase,Implements:[Options,Events],options:{style:"default",isView:!1,showTab:!0,propertyPath:"../x_component_query_TableDesigner/$Table/table.html"},initialize:function(t,e,i){this.setOptions(i),this.path="../x_component_query_TableDesigner/$Table/",this.cssPath="../x_component_query_TableDesigner/$Table/"+this.options.style+"/css.wcss",this._loadCss(),this.designer=t,this.data=e,this.data.draftData||(this.data.draftData={}),this.parseData(),this.node=this.designer.designNode,this.areaNode=new Element("div",{styles:{height:"100%",overflow:"auto"}}),this.propertyListNode=this.designer.propertyDomArea,this.designer.application&&(this.data.applicationName=this.designer.application.name),this.designer.application&&(this.data.application=this.designer.application.id),this.isNewTable=!this.data.id,this.items=[],this.view=this,this.queryView=null,this.autoSave(),this.designer.addEvent("queryClose",function(){this.autoSaveTimerID&&window.clearInterval(this.autoSaveTimerID)}.bind(this))},parseData:function(){this.json=this.data},load:function(){this.setAreaNodeSize(),this.designer.addEvent("resize",this.setAreaNodeSize.bind(this)),this.areaNode.inject(this.node),this.designer.viewListAreaNode.getChildren().each(function(t){t.retrieve("table").id==this.data.id&&(this.designer.currentListViewItem&&this.designer.currentListViewItem.setStyles(this.designer.css.listViewItem),t.setStyles(this.designer.css.listViewItem_current),this.designer.currentListViewItem=t,this.lisNode=t)}.bind(this)),this.domListNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.designer.propertyDomArea),this.designer.propertyTitleNode.set("text",this.designer.lp.clumn),this.designer.propertyDomPercent=.5,this.designer.loadPropertyContentResize(),this.createColumnEditTable(),this.loadView(),this.refreshNode.setStyles(this.css.tableRunNode),this.data.buildSuccess||(this.refreshNode.hide(),this.addColumnNode.hide()),this.selected(),this.setEvent(),this.setViewWidth(),this.designer.addEvent("resize",this.setViewWidth.bind(this)),this.checkToolbars()},setEvent:function(){this.areaNode.addEvent("click",this.selected.bind(this)),this.refreshNode.addEvent("click",function(t){this.loadViewData(),t.stopPropagation()}.bind(this)),this.addColumnNode.addEvent("click",function(t){this.addLine(),t.stopPropagation()}.bind(this))},addLine:function(){var t=this.getNewData();this.createNewLineDlg(t)},createNewLineDlg:function(t){var e=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",height:"400px",width:"440px",overflow:"hidden"}}),i={content:e,title:this.designer.lp.addLine,container:this.designer.content,width:500,mask:!1,height:530,buttonList:[{text:this.designer.lp.ok,action:function(){this.saveNewLine(s)}.bind(this)},{text:this.designer.lp.cancel,action:function(){s.close()}.bind(this),styles:{border:"1px solid #999","background-color":"#f3f3f3",color:"#666666",height:"30px","border-radius":"5px","min-width":"80px",margin:"10px 5px"}}],onResize:function(){var t=s.content.getSize(),i=t.x-60,n=t.y-30;e.setStyles({width:i+"px",height:n+"px"})}},s=o2.DL.open(i);return o2.require("o2.widget.JavascriptEditor",function(){s.editor=new o2.widget.JavascriptEditor(e,{option:{mode:"json"}}),s.editor.load(function(){s.editor.editor.setValue(JSON.stringify(t,null,"\t"))}.bind(this))}.bind(this),!1),s},saveNewLine:function(t){var e=t.editor.editor.getValue();try{var i=JSON.parse(e);this.designer.actions.insertRow(this.data.id,i,function(){this.lastSelectJPQL&&this.runJpql(this.lastSelectJPQL),this.designer.notice(this.designer.lp.newLineSuccess,"success"),t.close()}.bind(this))}catch(t){this.designer.notice(this.designer.lp.newLineSuccess,"error")}},getNewData:function(){var t=JSON.parse(this.data.data),e={};return t.fieldList.each(function(t){switch(t.type){case"string":e[t.name]="";break;case"integer":case"long":case"double":e[t.name]=0;break;case"date":var i=(new Date).format("%Y-%m-%d");e[t.name]=i;break;case"time":i=(new Date).format("%H:%M:%S");e[t.name]=i;break;case"dateTime":i=(new Date).format("db");e[t.name]=i;break;case"boolean":e[t.name]=!0;break;case"stringList":case"integerList":case"longList":case"doubleList":e[t.name]=[];break;case"stringLob":e[t.name]="";break;case"stringMap":e[t.name]={}}}.bind(this)),e},checkToolbars:function(){if(this.designer.toolbar){var t=this.designer.toolbar.childrenButton[1],e=this.designer.toolbar.childrenButton[2];t.setDisable(!0),e.setDisable(!0),this.data.isNewTable||t.setDisable(!1),"build"==this.data.status&&e.setDisable(!1)}},createColumnEditTable:function(){this.columnListTable=new Element("table",{styles:this.css.columnListTable}).inject(this.domListNode),this.columnListHeaderTr=this.columnListTable.insertRow(-1).setStyles(this.css.columnListTr),this.columnListHeaderTr.insertCell().setStyles(this.css.columnListHeaderTd).set("text",this.designer.lp.name),this.columnListHeaderTr.insertCell().setStyles(this.css.columnListHeaderTd).set("text",this.designer.lp.description),this.columnListHeaderTr.insertCell().setStyles(this.css.columnListHeaderTd).set("text",this.designer.lp.type),this.columnListEditTr=this.columnListTable.insertRow(-1).setStyles(this.css.columnListEditTr);var t=this.columnListEditTr.insertCell().setStyles(this.css.columnListTd);this.columnListEditNameInput=new Element("input",{styles:this.css.columnListEditInput}).inject(t),t=this.columnListEditTr.insertCell().setStyles(this.css.columnListTd),this.columnListEditDescriptionInput=new Element("input",{styles:this.css.columnListEditInput}).inject(t),t=this.columnListEditTr.insertCell().setStyles(this.css.columnListTd),this.columnListEditTypeSelect=new Element("select",{styles:this.css.columnListEditSelect}).inject(t);this.columnListEditTypeSelect.set("html",'<option value="string">string</option><option value="integer">integer</option><option value="long">long</option><option value="double">double</option><option value="boolean">boolean</option><option value="date">date</option><option value="time">time</option><option value="dateTime">dateTime</option><option value="stringList">stringList</option><option value="integerList">integerList</option><option value="longList">longList</option><option value="doubleList">doubleList</option><option value="booleanList">booleanList</option><option value="stringLob">stringLob</option><option value="stringMap">stringMap</option>'),this.columnListEditTypeSelect.addEvents({change:function(t){this.checkAddColumn()}.bind(this)}),this.columnListEditNameInput.addEvents({keydown:function(t){13==t.code&&this.checkAddColumn()}.bind(this)}),this.columnListEditDescriptionInput.addEvents({keydown:function(t){13==t.code&&this.checkAddColumn()}.bind(this)})},checkColumnName:function(t){return!/^\d+|\.|\#|\s|\@|\&|\*|\(|\)|\=|\+|\!|\^|\$|\%|\;|\"|\{|\}|\[|\]|\||\\|\,|\.|\?|\/|\:|\;|\'|\"|\<|\>/g.test(t)||(this.designer.notice(this.designer.lp.errorName,"error"),!1)},checkAddColumn:function(){var t=this.columnListEditNameInput.get("value"),e=this.columnListEditDescriptionInput.get("value"),i=this.columnListEditTypeSelect.options[this.columnListEditTypeSelect.selectedIndex].value;if(t&&this.checkColumnName(t))if(this.json.draftData.fieldList||(this.json.draftData.fieldList=[]),-1!=this.json.draftData.fieldList.map((function(t){return t.name})).indexOf(t))this.designer.notice(this.designer.lp.duplicateName,"error"),this.columnListEditNameInput.focus();else{var s={name:t,description:e,type:i};this.addColumn(s),this.columnListEditNameInput.set("value",""),this.columnListEditDescriptionInput.set("value",""),this.columnListEditNameInput.focus()}},showProperty:function(){this.property?this.property.show():(this.property=new MWF.xApplication.query.TableDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)}),this.property.load())},addColumn:function(t){var e;if(t)e=t;else{this.json.draftData.fieldList||(this.json.draftData.fieldList=[]);for(var i=this.json.draftData.fieldList.map((function(t){return t.name})),s="column",n=1;-1!=i.indexOf(s);)s="column"+n,n++;e={name:s,type:"string",description:this.designer.lp.newColumn}}this.json.draftData.fieldList.push(e);var o=new MWF.xApplication.query.TableDesigner.Table.Column(e,this);(this.items.push(o),o.selected(),this.viewContentTableNode)&&this.viewContentTableNode.getElements("tr").each(function(t){new Element("td",{styles:this.css.viewContentTdNode}).inject(t)}.bind(this));this.setViewWidth(),this.addColumnNode.scrollIntoView(!0)},loadViewColumns:function(){this.json.draftData.fieldList&&this.json.draftData.fieldList.each(function(t){this.items.push(new MWF.xApplication.query.TableDesigner.Table.Column(t,this))}.bind(this))},saveSilence:function(t){if(!this.data.name)return this.designer.notice(this.designer.lp.inputTableName,"error"),!1;if("build"!==this.data.status){if(!/^[A-Za-z]/.test(this.data.name))return this.designer.notice(this.designer.lp.tableNameNotStartWithLetter,"error"),!1;if(!/^[A-Za-z0-9]+$/.test(this.data.name))return this.designer.notice(this.designer.lp.tableNameNotBeLetterAndNumber,"error"),!1}if(!this.json.draftData.fieldList.length)return this.designer.notice(this.designer.lp.errorFieldList,"error"),!1;this.designer.actions.saveTable(this.data,function(e){this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),this.checkToolbars(),t&&t()}.bind(this))},save:function(t){if(!this.data.name)return this.designer.notice(this.designer.lp.inputTableName,"error"),!1;if("build"!==this.data.status){var e=/^[A-Za-z]/;if(!e.test(this.data.name))return this.designer.notice(this.designer.lp.tableNameNotStartWithLetter,"error"),!1;if(this.data.alias&&!e.test(this.data.alias))return this.designer.notice(this.designer.lp.tableAliasNotStartWithLetter,"error"),!1;var i=/^[A-Za-z0-9]+$/;if(!i.test(this.data.name))return this.designer.notice(this.designer.lp.tableNameNotBeLetterAndNumber,"error"),!1;if(this.data.alias&&!i.test(this.data.alias))return this.designer.notice(this.designer.lp.tableAliasNotBeLetterAndNumber,"error"),!1}if(!this.json.draftData.fieldList.length)return this.designer.notice(this.designer.lp.errorFieldList,"error"),!1;this.designer.actions.saveTable(this.data,function(e){this.designer.notice(this.designer.lp.save_success,"success",this.node,{x:"left",y:"bottom"}),this.data.id=e.data.id,this.lisNode&&this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")"),this.checkToolbars(),t&&t()}.bind(this))},unSelected:function(){return this.currentSelectedModule=null,!0},statusBuild:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.statusBuildTitle,MWF.APPDTBD.LP.statusBuildInfor,420,120,(function(){e.designer.actions.statusBuild(e.data.id,function(t){this.designer.notice(this.designer.lp.statusBuild_success,"success",this.node,{x:"left",y:"bottom"}),this.designer.actions.getTable(t.data.id,function(t){this.data.status=t.data.status,this.checkToolbars()}.bind(this))}.bind(e)),this.close()}),(function(){this.close()}),null)},statusDraft:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.statusDraftTitle,{html:MWF.APPDTBD.LP.statusDraftInfor},450,120,(function(){this.close(),e.designer.confirm("warn",t,MWF.APPDTBD.LP.statusDraftTitle,{html:MWF.APPDTBD.LP.statusDraftInforAgain},480,120,(function(){e.designer.actions.statusDraft(e.data.id,function(t){this.designer.notice(this.designer.lp.statusDraft_success,"success",this.node,{x:"left",y:"bottom"}),this.designer.actions.getTable(t.data.id,function(t){this.data.status=t.data.status,this.checkToolbars()}.bind(this))}.bind(e)),this.close()}),(function(){this.close()}),null)}),(function(){this.close()}),null)},buildAllView:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.buildAllViewTitle,MWF.APPDTBD.LP.buildAllViewInfor,480,120,(function(){e.designer.actions.buildAllTable(function(t){this.designer.notice(this.designer.lp.buildAllView_success,"success",this.node,{x:"left",y:"bottom"})}.bind(e)),this.close()}),(function(){this.close()}),null)},buildAllView:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.buildAllViewTitle,MWF.APPDTBD.LP.buildAllViewInfor,480,120,(function(){e.designer.actions.buildAllTable(function(t){this.designer.notice(this.designer.lp.buildAllView_success,"success",this.node,{x:"left",y:"bottom"})}.bind(e)),this.close()}),(function(){this.close()}),null)},tableClear:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.tableClearTitle,MWF.APPDTBD.LP.tableClearInfo,480,120,(function(){e.designer.actions.deleteAllRow(e.data.id,function(t){this.designer.notice(this.designer.lp.tableClear_success,"success",this.node,{x:"left",y:"bottom"})}.bind(e)),this.close()}),(function(){this.close()}),null)},tableImplode:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.tableImplodeTitle,MWF.APPDTBD.LP.tableImplodeInfo,480,120,(function(){e.implodeLocal(),this.close()}),(function(){this.close()}),null)},tableExcelImplode:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.tableExcelImplodeTitle,MWF.APPDTBD.LP.tableExcelImplodeInfo,480,120,(function(){e.implodeExcelLocal(),this.close()}),(function(){this.close()}),null)},implodeExcelLocal:function(){var t=new MWF.xApplication.query.TableDesigner.Table.ExcelUtils,e=new Element("div");e.set("html",'<input name="file" type="file" accept="*" />'),e.getFirst().addEvent("change",function(){var e=i.files;if(e.length){var s=e.item(0);t.import(s,function(t){console.log(JSON.stringify(t)),this.designer.actions.rowSave(this.data.id,t[0],function(t){this.designer.notice(this.designer.lp.tableImplode_success,"success",this.node,{x:"left",y:"bottom"})}.bind(this))}.bind(this))}}.bind(this));var i=e.getFirst();i.click()},implodeLocal:function(){if(this.uploadFileAreaNode){this.fileUploadNode&&this.fileUploadNode.destroy(),this.uploadFileAreaNode.empty();t='<input name="file" type="file" accept=".json"/>';this.uploadFileAreaNode.set("html",t),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",this.implodeLocalFile.bind(this))}else{this.uploadFileAreaNode=new Element("div");var t='<input name="file" type="file" accept=".json"/>';this.uploadFileAreaNode.set("html",t),this.fileUploadNode=this.uploadFileAreaNode.getFirst(),this.fileUploadNode.addEvent("change",this.implodeLocalFile.bind(this))}this.fileUploadNode.click()},implodeLocalFile:function(){var t=this.fileUploadNode.files;if(t.length){var e=t[0],i=new FileReader;i.readAsText(e);var s=this;i.onload=function(){var t=JSON.parse(this.result);s.designer.actions.rowSave(s.data.id,t,function(t){this.designer.notice(this.designer.lp.tableImplode_success,"success",this.node,{x:"left",y:"bottom"})}.bind(s))}}},tableExplode:function(t){var e=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.tableExplodeTitle,MWF.APPDTBD.LP.tableExplodeInfo,480,120,(function(){var t=e.designer.actions.action.address+e.designer.actions.action.actions.exportRow.uri;t=(t=t.replace("{tableFlag}",e.data.id)).replace("{count}",1e3),window.open(o2.filterUrl(t)),this.close()}),(function(){this.close()}),null)},tableExcelExplode:function(t){var e=new MWF.xApplication.query.TableDesigner.Table.ExcelUtils,i=this;t||(t=this.node),this.designer.confirm("warn",t,MWF.APPDTBD.LP.tableExcelExplodeTitle,MWF.APPDTBD.LP.tableExplodeInfo,480,120,(function(){var t=JSON.parse(i.view.data.data).fieldList,s=[],n=[];t.each((function(t){s.push(t.name),n.push("o."+t.name)}));var o=[s],l={data:"select "+n.join()+" from "+i.data.name+" o",type:"select",firstResult:0,maxResults:1e3};i.designer.actions.executeJpql(i.data.id,l,function(t){t.data.each((function(e){var i=[];"string"===o2.typeOf(t.data[0])?i=[e]:e.each((function(t){t?i.push(t):i.push("")})),o.push(i)})),e.export(o,MWF.APPDTBD.LP.exportExcelFileName+(new Date).format("db"))}.bind(this)),this.close()}),(function(){this.close()}),null)},setContentHeight:function(){var t=this.areaNode.getSize(),e=this.viewTitleNode.getSize(),i=t.y-e.y-2;this.viewContentScrollNode.setStyle("height",i);var s=this.viewContentBodyNode.getSize();i<s.y&&(i=s.y+10),this.viewContentNode.setStyle("height",i),this.contentLeftNode.setStyle("height",i),this.contentRightNode.setStyle("height",i)},createJpqlAreaNode:function(t){this.jpqlAreaNode?t&&t():(this.viewTitleNode.setStyles(this.css.viewTitleNode_run),this.refreshNode.setStyles(this.css.tableRunNode_run),this.addColumnNode.setStyles(this.css.addColumnNode_run),this.jpqlAreaNode=new Element("div",{styles:this.css.jpqlAreaNode}).inject(this.viewTitleContentNode,"top"),this.jpqlEditor=new MWF.xApplication.query.TableDesigner.Table.JPQLRunner(this.jpqlAreaNode,this.refreshNode,this),this.jpqlEditor.load(function(){this.jpqlEditor.setJpql("slect","select o from "+this.data.name+" o",0,50),t&&t()}.bind(this)),this.setContentHeight())},runJpql:function(t){this.designer.actions.executeJpql(this.data.id,t,function(e){this.loadViewMask.hide(),"select"!=t.type?(this.designer.notice(this.designer.lp.jpqlRunSuccess,"success"),this.lastSelectJPQL&&this.runJpql(this.lastSelectJPQL)):(this.lastSelectJPQL=t,this.viewContentBodyNode.empty(),this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode),e.data.length&&(e.data.each(function(t,e){new MWF.xApplication.query.TableDesigner.Table.DataLine(t,this)}.bind(this)),this.setContentColumnWidth(),this.setContentHeight()))}.bind(this),function(t,e,i){if(this.loadViewMask.hide(),0!=t.status){var s=i;if(t){var n=JSON.decode(t.responseText);s=n?n.message.trim()||"request json error":"request json error: "+t.responseText}MWF.xDesktop.notice("error",{x:"right",y:"top"},s)}}.bind(this))},loadViewData:function(){this.data.buildSuccess&&this.data.id&&(o2.require("o2.widget.Mask",null,!1),this.loadViewMask=new o2.widget.Mask,this.loadViewMask.loadNode(this.viewAreaNode),this.createJpqlAreaNode(function(){var t=this.jpqlEditor.getJpql();this.runJpql(t)}.bind(this)))}}),MWF.xApplication.query.TableDesigner.Table.Column=new Class({Extends:MWF.xApplication.query.ViewDesigner.ViewBase.Column,initialize:function(t,e,i){this.propertyPath="../x_component_query_TableDesigner/$Table/column.html",this.view=e,this.json=t,this.next=i,this.css=this.view.css,this.content=this.view.viewTitleTrNode,this.domListNode=this.view.domListNode,this.load()},createDomListItem:function(){var t=this.view.columnListTable.rows.length;this.listNode=this.view.columnListTable.insertRow(t-1).setStyles(this.css.cloumnListNode),this.listNode.insertCell().setStyles(this.css.columnListTd).set("text",this.json.name),this.listNode.insertCell().setStyles(this.css.columnListTd).set("text",this.json.description),this.listNode.insertCell().setStyles(this.css.columnListTd).set("text",this.json.type),this.resetTextNode()},selected:function(){if(this.view.currentSelectedModule){if(this.view.currentSelectedModule==this)return!0;if(!this.view.currentSelectedModule.unSelected())return!0}this.node.setStyles(this.css.viewTitleColumnNode_selected),this.listNode.setStyles(this.css.cloumnListNode_selected),new Fx.Scroll(this.view.areaNode,{wheelStops:!1,duration:100}).toElementEdge(this.node),new Fx.Scroll(this.view.designer.propertyDomArea,{wheelStops:!1,duration:100}).toElement(this.listNode),this.view.currentSelectedModule=this,this.isSelected=!0,this._showActions(),this.showProperty()},unSelected:function(){return!!this.checkColumn()&&(this.resetTextNode(),this.view.currentSelectedModule=null,this.isError?this.node.setStyles(this.css.viewTitleColumnNode_error):this.node.setStyles(this.css.viewTitleColumnNode),this.listNode.setStyles(this.css.cloumnListNode),this.isSelected=!1,this._hideActions(),this.hideProperty(),!0)},checkColumn:function(){var t=this.listNode.getElements("td"),e=t[0].getFirst();t[1].getFirst(),t[2].getFirst();if(e&&"input"==e.tagName.toString().toLowerCase()){var i=t[0].getFirst().get("value"),s=t[1].getFirst().get("value"),n=t[2].getFirst().options[t[2].getFirst().selectedIndex].value;return i&&i!==this.json.name&&this.view.checkColumnName(i)?(this.view.json.draftData.fieldList||(this.view.json.draftData.fieldList=[]),-1!=this.view.json.draftData.fieldList.map((function(t){return t.name})).indexOf(i)?(this.view.designer.notice(this.view.designer.lp.duplicateName,"error"),t[0].getFirst().focus(),!1):(this.json.name=i,this.json.description=s,this.json.type=n,!0)):i==this.json.name?(this.json.name=i,this.json.description=s,this.json.type=n,!0):(this.view.designer.notice(this.view.designer.lp.inputName,"error"),t[0].getFirst().focus(),!1)}return!0},showProperty:function(){var t=this.listNode.getElements("td");t[0].empty(),t[1].empty(),t[2].empty();var e=new Element("input",{styles:this.css.columnListEditModifyInput,value:this.json.name}).inject(t[0]),i=new Element("input",{styles:this.css.columnListEditModifyInput,value:this.json.description}).inject(t[1]),s=new Element("select",{styles:this.css.columnListEditModifySelect}).inject(t[2]),n="<option "+("string"==this.json.type?"selected":"")+' value="string">string</option>';n+="<option "+("integer"==this.json.type?"selected":"")+' value="integer">integer</option>',n+="<option "+("long"==this.json.type?"selected":"")+' value="long">long</option>',n+="<option "+("double"==this.json.type?"selected":"")+' value="double">double</option>',n+="<option "+("boolean"==this.json.type?"selected":"")+' value="boolean">boolean</option>',n+="<option "+("date"==this.json.type?"selected":"")+' value="date">date</option>',n+="<option "+("time"==this.json.type?"selected":"")+' value="time">time</option>',n+="<option "+("dateTime"==this.json.type?"selected":"")+' value="dateTime">dateTime</option>',n+="<option "+("stringList"==this.json.type?"selected":"")+' value="stringList">stringList</option>',n+="<option "+("integerList"==this.json.type?"selected":"")+' value="integerList">integerList</option>',n+="<option "+("longList"==this.json.type?"selected":"")+' value="longList">longList</option>',n+="<option "+("doubleList"==this.json.type?"selected":"")+' value="doubleList">doubleList</option>',n+="<option "+("booleanList"==this.json.type?"selected":"")+' value="booleanList">booleanList</option>',n+="<option "+("stringLob"==this.json.type?"selected":"")+' value="stringLob">stringLob</option>',n+="<option "+("stringMap"==this.json.type?"selected":"")+' value="stringMap">stringMap</option>',s.set("html",n),e.focus(),s.addEvents({change:function(t){this.checkColumn()&&this.resetColumnTextNode()}.bind(this),click:function(t){t.stopPropagation()}}),e.addEvents({keydown:function(t){13==t.code&&this.checkColumn()&&this.resetColumnTextNode()}.bind(this),change:function(t){this.checkColumn()&&this.resetColumnTextNode()}.bind(this),click:function(t){t.stopPropagation()}}),i.addEvents({keydown:function(t){13==t.code&&this.checkColumn()&&this.resetColumnTextNode()}.bind(this),change:function(t){this.checkColumn()&&this.resetColumnTextNode()}.bind(this),click:function(t){t.stopPropagation()}})},hideProperty:function(){var t=this.listNode.getElements("td");t[0].empty().set("text",this.json.name),t[1].empty().set("text",this.json.description),t[2].empty().set("text",this.json.type)},resetColumnTextNode:function(){var t=this.json.description?this.json.name+"("+this.json.description+")":this.json.name;this.textNode.set("text",t)},resetTextNode:function(){var t=this.json.description?this.json.name+"("+this.json.description+")":this.json.name;this.textNode.set("text",t),this.listNode.getFirst().set("text",this.json.name),this.listNode.getFirst().getNext().set("text",this.json.description),this.listNode.getLast().set("text",this.json.type)},delete:function(t){var e=this;t||(t=this.node),this.view.designer.confirm("warn",t,MWF.APPDTBD.LP.deleteColumnTitle,MWF.APPDTBD.LP.deleteColumn,300,120,(function(){e.destroy(),this.close()}),(function(){this.close()}),null)},destroy:function(){this.view.currentSelectedModule==this&&(this.view.currentSelectedModule=null),this.actionArea&&this.actionArea.destroy(),this.listNode&&this.listNode.destroy(),this.property&&this.property.propertyContent.destroy();var t=this.view.items.indexOf(this);this.view.viewContentTableNode&&this.view.viewContentTableNode.getElements("tr").each(function(e){e.deleteCell(t)}.bind(this));this.view.json.draftData.fieldList&&this.view.json.draftData.fieldList.erase(this.json),this.view.items.erase(this),this.areaNode.destroy(),this.view.selected(),this.view.setViewWidth(),MWF.release(this)},addColumn:function(t,e){var i;if(e)i=e;else{this.view.json.draftData.fieldList||(this.view.json.draftData.fieldList=[]);for(var s=this.view.json.draftData.fieldList.map((function(t){return t.name})),n="column",o=1;-1!=s.indexOf(n);)n="column"+o,o++;i={name:n,type:"string",description:this.view.designer.lp.newColumn}}this.view.json.draftData.fieldList.push(i);var l=new MWF.xApplication.query.TableDesigner.Table.Column(i,this.view,this);(this.view.items.push(l),l.selected(),this.view.viewContentTableNode)&&this.view.viewContentTableNode.getElements("tr").each(function(t){new Element("td",{styles:this.css.viewContentTdNode}).inject(t)}.bind(this));this.view.setViewWidth(),this.view.addColumnNode.scrollIntoView(!0)},_createIconAction:function(){this.actionArea||(this.actionArea=new Element("div",{styles:this.css.actionAreaNode}).inject(this.view.areaNode,"after"),this._createAction({name:"add",icon:"add.png",event:"click",action:"addColumn",title:MWF.APPDVD.LP.action.add}),this._createAction({name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPDVD.LP.action.delete}))}}),MWF.xApplication.query.TableDesigner.Table.DataLine=new Class({initialize:function(t,e){this.table=e,this.lineData=t,this.tableData=this.table.data,this.tableContentTableNode=this.table.viewContentTableNode,this.css=this.table.css,this.load()},load:function(){this.tr=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.tableContentTableNode),this.tableData.draftData.fieldList.each(function(t,e){var i=this.lineData[t.name],s=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.tr);if(s.store("field",t),null!=i)switch(o2.typeOf(i)){case"array":s.store("data",i),s.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>[...]</div>");break;case"object":s.store("data",i),s.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>{...}</div>");break;default:s.set("text",i)}else switch(t.type){case"stringList":case"integerList":case"longList":case"doubleList":case"booleanList":s.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>[...]</div>");break;case"stringLob":s.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>...</div>");break;case"stringMap":s.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>{...}</div>");break;default:s.set("text","")}s.getFirst()&&s.getFirst().addEvent("click",function(t){this.getFieldValue(t.target.getParent())}.bind(this))}.bind(this))},createObjectValueDlg:function(t){var e=new Element("div",{styles:{margin:"10px 10px 0px 10px",padding:"5px",overflow:"hidden"}}),i=t.getPosition(this.table.designer.content),s=t.getSize(),n=this.table.designer.content.getSize(),o=i.y,l=i.x+s.x/2-180;o+400+10>n.y&&(o=n.y-400-10),l+360+10>n.x&&(l=n.x-360-10),o<10&&(o=10),l<10&&(l=10);var a=i.y+s.y/2,d=i.x+s.x/2,r={content:e,isTitle:!1,container:this.table.designer.content,width:360,height:400,top:o,left:l,fromTop:a,fromLeft:d,buttonList:[{text:this.table.designer.lp.close,action:function(){h.close()}.bind(this)}]},h=o2.DL.open(r);return h},getFieldValue:function(t){var e=t.retrieve("field");this.loadFieldValue(e.name,function(){var i=this.lineData[e.name],s=this.createObjectValueDlg(t).content.getFirst();switch(e.type){case"stringList":case"integerList":case"longList":case"doubleList":case"booleanList":o2.require("o2.widget.Arraylist",function(){new o2.widget.Arraylist(s,{style:"table",title:e.name,isAdd:!1,isDelete:!1,isModify:!1}).load(i)}.bind(this));break;case"stringLob":td.set("html","<div style='background-color:#dddddd; cursor: pointer;float: left; padding: 3px; font-size: 10px;'>...</div>");break;case"stringMap":o2.require("o2.widget.Maplist",function(){new o2.widget.Maplist(s,{style:"table",title:e.name,isAdd:!1,isDelete:!1,isModify:!1}).load(i)}.bind(this))}}.bind(this))},loadFieldValue:function(t,e){t&&(this.lineData[t]?e&&e():this.table.designer.actions.getRow(this.tableData.id,this.lineData.id,function(t){this.lineData=t.data,e&&e()}.bind(this)))}}),MWF.xApplication.query.TableDesigner.Table.JPQLRunner=new Class({initialize:function(t,e,i){this.table=i,this.node=t,this.runNode=e,this.css=this.table.css,this.lp=this.table.designer.lp},load:function(t){this.optionArea=new Element("div",{styles:this.css.jpqlOptionArea}).inject(this.node),this.contentWhereArea=new Element("div",{styles:this.css.jpqlContentWhereArea}).inject(this.node),this.loadOptions(),this.loadEditor(t)},loadOptions:function(){var t="<table cellpadding='0' cellspacing='0' style='height:30px'><tr>";t+="<td style='padding: 0 5px'>"+this.lp.jpqlType+"</td>",t+="<td style='padding: 0 5px'><select><option value='select'>select</option><option value='update'>update</option><option value='delete'>delete</option></select></td>",t+="<td style='padding: 0 5px'>"+this.lp.jpqlFromResult+"</td>",t+="<td style='padding: 0 5px'><input type='number' value='1'/></td>",t+="<td style='padding: 0 5px'>"+this.lp.jpqlMaxResult+"</td>",t+="<td style='padding: 0 5px'><input type='number' value='50'/></td>",t+="</tr></table>",this.optionArea.set("html",t),this.jpqlTypeSelect=this.optionArea.getElement("select");var e=this.optionArea.getElements("input");this.fromResultInput=e[0],this.maxResultsInput=e[1],this.jpqlTypeSelect.setStyles(this.css.jpqlTypeSelect),this.fromResultInput.setStyles(this.css.jpqlOptionInput),this.maxResultsInput.setStyles(this.css.jpqlOptionInput),this.jpqlTypeSelect.addEvent("change",function(){var t=this.jpqlTypeSelect.options[this.jpqlTypeSelect.selectedIndex].value;this.changeType(t,!0)}.bind(this))},loadEditor:function(t){o2.require("o2.widget.JavascriptEditor",function(){this.editor=new o2.widget.JavascriptEditor(this.contentWhereArea,{title:"JPQL",option:{mode:"sql"}}),this.editor.load(function(){this.editor.addEditorEvent("change",function(){this.checkJpqlType()}.bind(this)),t&&t()}.bind(this))}.bind(this),!1)},checkJpqlType:function(){var t=this.editor.editor.getValue();return/^select/i.test(t)?this.changeType("select"):/^update/i.test(t)?this.changeType("update"):/^delete/i.test(t)?this.changeType("delete"):void 0},changeType:function(t,e){if(t!=this.jpqlTypeSelect.options[this.jpqlTypeSelect.selectedIndex].value||e){for(var i=0;i<this.jpqlTypeSelect.options.length;i++)if(this.jpqlTypeSelect.options[i].value==t){this.jpqlTypeSelect.options[i].set("selected",!0);break}var s;if("select"!=t)(s=this.optionArea.getElements("td"))[2].hide(),s[3].hide(),s[4].hide(),s[5].hide();else(s=this.optionArea.getElements("td"))[2].show(),s[3].show(),s[4].show(),s[5].show()}},setJpql:function(t,e,i,s){if(this.editor&&this.editor.editor&&this.editor.editor.setValue(e),this.jpqlTypeSelect)for(var n=0;n<this.jpqlTypeSelect.options.length;n++)if(this.jpqlTypeSelect.options[n].value==t.toString().toLowerCase()){this.jpqlTypeSelect.options[n].set("selected",!0);break}this.fromResultInput&&this.fromResultInput.set("value",i),this.maxResultsInput&&this.maxResultsInput.set("value",s)},getJpql:function(){var t=this.editor.editor.getValue(),e=this.jpqlTypeSelect.options[this.jpqlTypeSelect.selectedIndex].get("value"),i=this.fromResultInput.get("value"),s=this.maxResultsInput.get("value");return{data:t,type:e,firstResult:i.toInt(),maxResults:s.toInt()}}}),MWF.xApplication.query.TableDesigner.Table.ExcelUtils=new Class({_loadResource:function(t){COMMON.AjaxModule.load("/x_component_Template/framework/xlsx/xlsx.full.js",function(){COMMON.AjaxModule.load("/x_component_Template/framework/xlsx/xlsxUtils.js",function(){t()}.bind(this))}.bind(this))},_openDownloadDialog:function(t,e){if("ie"!==Browser.name){"object"==typeof t&&t instanceof Blob&&(t=URL.createObjectURL(t));var i,s=document.createElement("a");s.href=t,s.download=e||"",window.MouseEvent&&"function"==typeOf(window.MouseEvent)?i=new MouseEvent("click"):(i=document.createEvent("MouseEvents")).initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(i)}else window.navigator.msSaveBlob(t,e)},export:function(t,e){this._loadResource(function(){data=xlsxUtils.format2Sheet(t,0,0,null);var i=xlsxUtils.format2WB(data,"sheet1",void 0),s=i.Sheets[i.SheetNames[0]],n=[];t[0].each(function(t,e){n.push({wpx:100});var i=String.fromCharCode(97+e).toUpperCase();s[i+"1"].s={font:{sz:12,color:{rgb:"#FFFF0000"},bold:!0,italic:!1,underline:!1},alignment:{horizontal:"center",vertical:"center"}}}.bind(this)),s["!cols"]=n,this._openDownloadDialog(xlsxUtils.format2Blob(i),e+".xlsx")}.bind(this))},import:function(t,e,i){this._loadResource((function(){var i,s,n=new FileReader;n.onload=function(t){s=t?t.target.result:n.content;var o=(i=XLSX.read(s,{type:"binary"})).SheetNames[0],l=[];for(var o in i.Sheets)if(i.Sheets.hasOwnProperty(o)){fromTo=i.Sheets[o]["!ref"],console.log(fromTo);var a=XLSX.utils.sheet_to_json(i.Sheets[o]);console.log(JSON.stringify(a)),l.push(a)}e&&e(l)},n.readAsBinaryString(t)}))}});